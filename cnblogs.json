{
  "title": "ä¸»é¡µ - åšå®¢å›­",
  "link": "https://www.cnblogs.com/",
  "description": "ä¸»é¡µ - åšå®¢å›­ RSS",
  "entries": [
    {
      "title": "Debian 13åŸºäºkubeadmå’Œcontainerdéƒ¨ç½²å•èŠ‚ç‚¹kubernetes",
      "link": "https://www.cnblogs.com/XY-Heruo/p/19560948",
      "published": "",
      "description": "<h1 class=\"postTitle\">\n                <a class=\"postTitle2 vertical-middle\" href=\"https://www.cnblogs.com/XY-Heruo/p/19560948\" id=\"cb_post_title_url\" title=\"å‘å¸ƒäº 2026-02-01 16:03\">\n    <span>Debian 13åŸºäºkubeadmå’Œcontainerdéƒ¨ç½²å•èŠ‚ç‚¹kubernetes</span>\n    \n\n</a>\n\n            </h1>\n            <div class=\"clear\"></div>\n            <div class=\"postBody\">\n                    <div id=\"cnblogs_post_description\" style=\"display: none;\">\n        \n        åœ¨æœ¬åœ°è™šæ‹Ÿæœºç¯å¢ƒä¸­ä½¿ç”¨ kubeadm+containerd+harbor+cilium æ­å»º Kubernetes é›†ç¾¤\n    </div>\n<div class=\"blogpost-body cnblogs-markdown\" id=\"cnblogs_post_body\">\n<h2 id=\"å‰è¨€\">å‰è¨€</h2>\n<p>åœ¨æœ¬åœ°è™šæ‹Ÿæœºç¯å¢ƒä¸­ä½¿ç”¨ kubeadm æ­å»º Kubernetes é›†ç¾¤æ˜¯å­¦ä¹ å’Œå®éªŒçš„ç†æƒ³é€‰æ‹©ã€‚è€ƒè™‘åˆ°å®é™…åº”ç”¨åœºæ™¯ä¸­å¯èƒ½å­˜åœ¨çš„ç½‘ç»œé™åˆ¶ä»¥åŠé•œåƒæ„å»ºéœ€æ±‚ï¼Œæœ¬æ–‡è¯¦ç»†è®°å½•äº†åœ¨å®Œå…¨ç¦»çº¿ç¯å¢ƒä¸‹éƒ¨ç½²å•èŠ‚ç‚¹ Kubernetes é›†ç¾¤çš„å®Œæ•´è¿‡ç¨‹ã€‚é€šè¿‡é›†æˆ Harbor ç§æœ‰é•œåƒä»“åº“ï¼Œæ‰€æœ‰ Kubernetes ç»„ä»¶é•œåƒå‡ä»æœ¬åœ° Harbor å®ä¾‹æ‹‰å–ï¼Œç¡®ä¿éƒ¨ç½²è¿‡ç¨‹çš„å¯é æ€§å’Œå¯é‡å¤æ€§ã€‚</p>\n<p>æœ¬æŒ‡å—é€‚ç”¨äºå¸Œæœ›åœ¨å—é™ç½‘ç»œç¯å¢ƒä¸­å¿«é€Ÿæ­å»º Kubernetes å®éªŒç¯å¢ƒçš„æŠ€æœ¯äººå‘˜ï¼Œæ¶µç›–äº†ä»ç³»ç»Ÿåˆå§‹åŒ–åˆ° Cilium ç½‘ç»œæ’ä»¶é…ç½®çš„å…¨æµç¨‹ã€‚</p>\n<h2 id=\"ç¯å¢ƒå’Œç‰ˆæœ¬ä¿¡æ¯\">ç¯å¢ƒå’Œç‰ˆæœ¬ä¿¡æ¯</h2>\n<h3 id=\"åŸºç¡€ç¯å¢ƒé…ç½®\">åŸºç¡€ç¯å¢ƒé…ç½®</h3>\n<ul>\n<li><strong>æ“ä½œç³»ç»Ÿ</strong>ï¼šDebian 13 (ä»£å· \"Trixie\")</li>\n<li><strong>ç¡¬ä»¶è§„æ ¼</strong>ï¼š4 æ ¸ CPU / 4GB å†…å­˜ / 40GB å­˜å‚¨ç©ºé—´</li>\n<li><strong>ç½‘ç»œæ‹“æ‰‘</strong>ï¼šå•èŠ‚ç‚¹éƒ¨ç½²ï¼ˆControl Plane + Worker åˆä¸€ï¼‰</li>\n</ul>\n<h3 id=\"è½¯ä»¶ç‰ˆæœ¬æ¸…å•\">è½¯ä»¶ç‰ˆæœ¬æ¸…å•</h3>\n<table>\n<thead>\n<tr>\n<th>ç»„ä»¶</th>\n<th>ç‰ˆæœ¬</th>\n<th>è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Kubernetes</td>\n<td>v1.33.7</td>\n<td>å®¹å™¨ç¼–æ’å¹³å°</td>\n</tr>\n<tr>\n<td>containerd</td>\n<td>2.2.1</td>\n<td>å®¹å™¨è¿è¡Œæ—¶</td>\n</tr>\n<tr>\n<td>runc</td>\n<td>1.4.0</td>\n<td>OCI è¿è¡Œæ—¶è§„èŒƒå®ç°</td>\n</tr>\n<tr>\n<td>CNI Plugins</td>\n<td>1.9.0</td>\n<td>å®¹å™¨ç½‘ç»œæ¥å£æ’ä»¶</td>\n</tr>\n<tr>\n<td>Harbor</td>\n<td>v2.14.2</td>\n<td>ä¼ä¸šçº§å®¹å™¨é•œåƒä»“åº“</td>\n</tr>\n<tr>\n<td>Cilium</td>\n<td>v1.18.6</td>\n<td>eBPF é©±åŠ¨çš„ç½‘ç»œå’Œå®‰å…¨è§£å†³æ–¹æ¡ˆ</td>\n</tr>\n<tr>\n<td>Helm</td>\n<td>3.19.5</td>\n<td>Kubernetes åŒ…ç®¡ç†å™¨</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"ç½‘ç»œè§„åˆ’\">ç½‘ç»œè§„åˆ’</h3>\n<table>\n<thead>\n<tr>\n<th>IP åœ°å€</th>\n<th>ä¸»æœºå</th>\n<th>è§’è‰²</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>192.168.0.22</td>\n<td>deb13-k8s-node1</td>\n<td>Kubernetes èŠ‚ç‚¹</td>\n</tr>\n<tr>\n<td>192.168.0.42</td>\n<td>deb13-harbor</td>\n<td>Harbor é•œåƒä»“åº“</td>\n</tr>\n</tbody>\n</table>\n<blockquote>\n<p><strong>æ³¨æ„</strong>ï¼šæœ¬æ–‡æ¡£å‡è®¾ä¸¤å°ä¸»æœºä½äºåŒä¸€å†…ç½‘ç¯å¢ƒä¸­ï¼Œä¸”ç½‘ç»œè¿é€šæ€§å·²éªŒè¯ã€‚</p>\n</blockquote>\n<h2 id=\"ç³»ç»Ÿåˆå§‹åŒ–\">ç³»ç»Ÿåˆå§‹åŒ–</h2>\n<p>åœ¨å¼€å§‹ Kubernetes ç»„ä»¶å®‰è£…ä¹‹å‰ï¼Œéœ€è¦å¯¹ç³»ç»Ÿè¿›è¡Œå¿…è¦çš„åˆå§‹åŒ–é…ç½®ï¼Œä»¥æ»¡è¶³ Kubernetes çš„è¿è¡Œè¦æ±‚ã€‚</p>\n<h3 id=\"1-å®‰è£…-ipvs-ç›¸å…³å·¥å…·åŒ…\">1. å®‰è£… IPVS ç›¸å…³å·¥å…·åŒ…</h3>\n<p>IPVSï¼ˆIP Virtual Serverï¼‰æ˜¯ Linux å†…æ ¸çš„è´Ÿè½½å‡è¡¡å®ç°ï¼ŒKubernetes åœ¨ IPVS æ¨¡å¼ä¸‹è¿è¡Œ kube-proxy æ—¶éœ€è¦ç›¸å…³å·¥å…·æ”¯æŒã€‚</p>\n<pre><code class=\"language-bash\"># ä»…åœ¨ Kubernetes èŠ‚ç‚¹æ‰§è¡Œ\nsudo apt update\nsudo apt install -y ipvsadm ipset\n</code></pre>\n<h3 id=\"2-é…ç½®ä¸»æœºå\">2. é…ç½®ä¸»æœºå</h3>\n<p>ä¸ºä¾¿äºç®¡ç†å’Œè¯†åˆ«ï¼Œå»ºè®®ä¸ºæ¯å°ä¸»æœºè®¾ç½®æœ‰æ„ä¹‰çš„ä¸»æœºåã€‚</p>\n<pre><code class=\"language-bash\"># Harbor æœåŠ¡å™¨\nhostnamectl set-hostname deb13-harbor\n\n# Kubernetes èŠ‚ç‚¹\nhostnamectl set-hostname deb13-k8s-node1\n</code></pre>\n<h3 id=\"3-é…ç½®æœ¬åœ°-dns-è§£æ\">3. é…ç½®æœ¬åœ° DNS è§£æ</h3>\n<p>ç¼–è¾‘ <code>/etc/hosts</code> æ–‡ä»¶ï¼Œæ·»åŠ ä¸»æœºåä¸ IP åœ°å€çš„æ˜ å°„å…³ç³»ï¼š</p>\n<pre><code class=\"language-bash\">cat &gt;&gt; /etc/hosts &lt;&lt; EOF\n192.168.0.22 deb13-k8s-node1\n192.168.0.42 deb13-harbor\nEOF\n</code></pre>\n<h3 id=\"4-åŠ è½½å¿…è¦çš„å†…æ ¸æ¨¡å—\">4. åŠ è½½å¿…è¦çš„å†…æ ¸æ¨¡å—</h3>\n<p>Kubernetes ä¾èµ–ç‰¹å®šçš„å†…æ ¸æ¨¡å—æ¥æ”¯æŒå®¹å™¨ç½‘ç»œåŠŸèƒ½ã€‚åˆ›å»ºæ¨¡å—åŠ è½½é…ç½®å¹¶ç«‹å³ç”Ÿæ•ˆï¼š</p>\n<pre><code class=\"language-bash\"># åˆ›å»ºæ¨¡å—åŠ è½½é…ç½®æ–‡ä»¶\ncat &lt;&lt; EOF &gt; /etc/modules-load.d/containerd.conf\noverlay\nbr_netfilter\nEOF\n\n# ç«‹å³åŠ è½½æ¨¡å—\nsudo modprobe overlay\nsudo modprobe br_netfilter\n\n# éªŒè¯æ¨¡å—åŠ è½½çŠ¶æ€\nlsmod | grep -E \"(overlay|br_netfilter)\"\n</code></pre>\n<h3 id=\"5-é…ç½®ç³»ç»Ÿå†…æ ¸å‚æ•°\">5. é…ç½®ç³»ç»Ÿå†…æ ¸å‚æ•°</h3>\n<p>è°ƒæ•´å†…æ ¸å‚æ•°ä»¥ä¼˜åŒ–å®¹å™¨è¿è¡Œç¯å¢ƒï¼š</p>\n<pre><code class=\"language-bash\">cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt; EOF\nnet.ipv4.ip_forward=1\nnet.bridge.bridge-nf-call-ip6tables = 1\nnet.bridge.bridge-nf-call-iptables = 1\nvm.swappiness = 0\nEOF\n\n# åº”ç”¨é…ç½®\nsudo sysctl --system\n</code></pre>\n<blockquote>\n<p><strong>é‡è¦æç¤º</strong>ï¼šå¦‚æœç³»ç»Ÿå¯ç”¨äº† swap åˆ†åŒºï¼Œå¿…é¡»åœ¨ Kubernetes å¯åŠ¨å‰å°†å…¶å…³é—­ï¼Œå¦åˆ™ kubelet å°†æ— æ³•æ­£å¸¸å¯åŠ¨ã€‚å¯é€šè¿‡ä»¥ä¸‹å‘½ä»¤ä¸´æ—¶å…³é—­ï¼š</p>\n</blockquote>\n<pre><code class=\"language-bash\">sudo swapoff -a\n# æ°¸ä¹…å…³é—­éœ€æ³¨é‡Š /etc/fstab ä¸­çš„ swap ç›¸å…³è¡Œ\n</code></pre>\n<h2 id=\"harbor-ç§æœ‰é•œåƒä»“åº“éƒ¨ç½²\">Harbor ç§æœ‰é•œåƒä»“åº“éƒ¨ç½²</h2>\n<p>Harbor ä½œä¸ºä¼ä¸šçº§å®¹å™¨é•œåƒä»“åº“ï¼Œä¸ºç¦»çº¿ç¯å¢ƒä¸‹çš„ Kubernetes éƒ¨ç½²æä¾›äº†å¯é çš„é•œåƒåˆ†å‘èƒ½åŠ›ã€‚</p>\n<h3 id=\"1-å‡†å¤‡-harbor-å®‰è£…åŒ…\">1. å‡†å¤‡ Harbor å®‰è£…åŒ…</h3>\n<p>ä» <a href=\"https://github.com/goharbor/harbor/releases\" rel=\"noopener nofollow\" target=\"_blank\">Harbor GitHub Releases</a> é¡µé¢ä¸‹è½½ç¦»çº¿å®‰è£…åŒ…ï¼ˆçº¦ 600MBï¼‰ã€‚å®‰è£… Harbor å‰éœ€ç¡®ä¿ Docker å’Œ Docker Compose å·²æ­£ç¡®å®‰è£…ã€‚</p>\n<h3 id=\"2-ç”Ÿæˆè‡ªç­¾å-tls-è¯ä¹¦\">2. ç”Ÿæˆè‡ªç­¾å TLS è¯ä¹¦</h3>\n<p>ç”±äº Harbor å¼ºåˆ¶è¦æ±‚ HTTPS è¿æ¥ï¼Œæˆ‘ä»¬éœ€è¦ä¸º Harbor æœåŠ¡å™¨ç”Ÿæˆè‡ªç­¾åè¯ä¹¦ã€‚åˆ›å»ºè¯ä¹¦ç”Ÿæˆè„šæœ¬ï¼š</p>\n<pre><code class=\"language-bash\"># åˆ›å»ºè¯ä¹¦ç›®å½•\nmkdir -p ~/apps/harbor/certs\ncd ~/apps/harbor/certs\n\n# åˆ›å»ºè¯ä¹¦ç”Ÿæˆè„šæœ¬\ncat &gt; gen-harbor-crt.sh &lt;&lt; 'EOF'\n#!/bin/bash\n\n# --- é…ç½®å‚æ•° ---\nDOMAIN=\"deb13-harbor\"       # Harbor åŸŸå\nIP=\"192.168.0.42\"           # Harbor æœåŠ¡å™¨å†…ç½‘ IP\nDAYS=3650                   # æœ‰æ•ˆæœŸ 10 å¹´\n\n# 1. ç”Ÿæˆç§é’¥ (æ— å¯†ç )\nopenssl genrsa -out harbor.key 2048\n\n# 2. åˆ›å»º OpenSSL é…ç½®æ–‡ä»¶ä»¥åŒ…å« SAN\ncat &gt; harbor.conf &lt;&lt; CONF_EOF\n[req]\ndistinguished_name = req_distinguished_name\nx509_extensions = v3_req\nprompt = no\n\n[req_distinguished_name]\nCN = ${DOMAIN}\n\n[v3_req]\nkeyUsage = critical, digitalSignature, keyEncipherment\nextendedKeyUsage = serverAuth\nsubjectAltName = @alt_names\n\n[alt_names]\nDNS.1 = ${DOMAIN}\nIP.1 = ${IP}\nCONF_EOF\n\n# 3. ç”Ÿæˆè‡ªç­¾åè¯ä¹¦\nopenssl req -x509 -nodes -days ${DAYS} -key harbor.key -out harbor.crt -config harbor.conf -extensions v3_req\n\n# 4. éªŒè¯è¯ä¹¦ï¼ˆæŸ¥çœ‹æ˜¯å¦æœ‰ Subject Alternative Name å­—æ®µï¼‰\necho \"--------------------------------------------------\"\necho \"è¯ä¹¦ä¿¡æ¯éªŒè¯ï¼š\"\nopenssl x509 -in harbor.crt -text -noout | grep -A 1 \"Subject Alternative Name\"\n\necho \"--------------------------------------------------\"\necho \"ç”ŸæˆæˆåŠŸï¼\"\necho \"æœåŠ¡ç«¯ä½¿ç”¨: harbor.crt, harbor.key\"\necho \"å®¢æˆ·ç«¯ (K8s èŠ‚ç‚¹) ä½¿ç”¨: harbor.crt\"\nEOF\n\n# æ‰§è¡Œè¯ä¹¦ç”Ÿæˆ\nchmod +x gen-harbor-crt.sh\n./gen-harbor-crt.sh\n</code></pre>\n<h3 id=\"3-é…ç½®-harbor\">3. é…ç½® Harbor</h3>\n<p>ä»æ¨¡æ¿æ–‡ä»¶å¤åˆ¶å¹¶ä¿®æ”¹ Harbor é…ç½®ï¼š</p>\n<pre><code class=\"language-bash\"># å¤åˆ¶é…ç½®æ¨¡æ¿\ncp harbor.yml.tmpl harbor.yml\n\n# ä¿®æ”¹å…³é”®é…ç½®é¡¹\n</code></pre>\n<p>ä¸»è¦é…ç½®é¡¹å¦‚ä¸‹ï¼š</p>\n<pre><code class=\"language-yaml\"># Harbor è®¿é—®åœ°å€\nhostname: 192.168.0.42\n\n# HTTPS é…ç½®\nhttps:\n  port: 443\n  certificate: /home/rainux/apps/harbor/certs/harbor.crt\n  private_key: /home/rainux/apps/harbor/certs/harbor.key\n\n# ç®¡ç†å‘˜å¯†ç ï¼ˆè¯·è®¾ç½®å¼ºå¯†ç ï¼‰\nharbor_admin_password: your-harbor-password\n\n# æ•°æ®åº“å¯†ç \ndatabase:\n  password: your-db-password\n\n# æ•°æ®å­˜å‚¨è·¯å¾„\ndata_volume: /home/rainux/apps/harbor/data\n\n# æ—¥å¿—é…ç½®\nlog:\n  location: /home/rainux/apps/harbor/logs\n\n# å¯ç”¨æŒ‡æ ‡ç›‘æ§\nmetric:\n  enabled: true\n  port: 9090\n  path: /metrics\n</code></pre>\n<h3 id=\"4-å¯åŠ¨-harbor-æœåŠ¡\">4. å¯åŠ¨ Harbor æœåŠ¡</h3>\n<pre><code class=\"language-bash\">cd ~/apps/harbor\nsudo ./install.sh\n</code></pre>\n<h3 id=\"5-åˆå§‹åŒ–-harbor-é¡¹ç›®\">5. åˆå§‹åŒ– Harbor é¡¹ç›®</h3>\n<p>é€šè¿‡ Web ç•Œé¢è®¿é—® Harborï¼ˆ<a href=\"https://192.168.0.42\" rel=\"noopener nofollow\" target=\"_blank\">https://192.168.0.42</a>ï¼‰ï¼Œä½¿ç”¨é…ç½®çš„ç®¡ç†å‘˜å¯†ç ç™»å½•åï¼Œåˆ›å»ºä»¥ä¸‹ä¸¤ä¸ªå…¬å¼€é¡¹ç›®ï¼š</p>\n<ul>\n<li><code>google_containers</code>ï¼šç”¨äºå­˜å‚¨ Kubernetes æ ¸å¿ƒç»„ä»¶é•œåƒ</li>\n<li><code>cilium</code>ï¼šç”¨äºå­˜å‚¨ Cilium ç½‘ç»œæ’ä»¶ç›¸å…³é•œåƒ</li>\n</ul>\n<blockquote>\n<p><strong>é…ç½®æ›´æ–°è¯´æ˜</strong>ï¼šå¦‚éœ€ä¿®æ”¹ Harbor é…ç½®ï¼Œå¯æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ä½¿é…ç½®ç”Ÿæ•ˆï¼š</p>\n<pre><code class=\"language-bash\">sudo ./prepare\ndocker-compose down -v\nsudo docker-compose up -d\n</code></pre>\n</blockquote>\n<h2 id=\"containerd-å®¹å™¨è¿è¡Œæ—¶é…ç½®\">Containerd å®¹å™¨è¿è¡Œæ—¶é…ç½®</h2>\n<p>Containerd ä½œä¸ºè½»é‡çº§å®¹å™¨è¿è¡Œæ—¶ï¼Œæ˜¯ Kubernetes æ¨èçš„è¿è¡Œæ—¶é€‰é¡¹ä¹‹ä¸€ã€‚</p>\n<h3 id=\"1-ä¸‹è½½å¿…è¦ç»„ä»¶\">1. ä¸‹è½½å¿…è¦ç»„ä»¶</h3>\n<p>ä»å®˜æ–¹ GitHub ä»“åº“ä¸‹è½½ä»¥ä¸‹ç»„ä»¶ï¼š</p>\n<ul>\n<li><a href=\"https://github.com/containerd/containerd/releases\" rel=\"noopener nofollow\" target=\"_blank\">containerd</a></li>\n<li><a href=\"https://github.com/opencontainers/runc/releases\" rel=\"noopener nofollow\" target=\"_blank\">runc</a></li>\n<li><a href=\"https://github.com/containernetworking/plugins/releases\" rel=\"noopener nofollow\" target=\"_blank\">CNI Plugins</a></li>\n</ul>\n<h3 id=\"2-å®‰è£…-runc\">2. å®‰è£… runc</h3>\n<pre><code class=\"language-bash\"># æ³¨æ„ï¼šåŸæ–‡ä¸­çš„æ–‡ä»¶åå¯èƒ½å­˜åœ¨ç¬”è¯¯ï¼Œåº”ä¸º runc.amd64\nchmod +x runc.amd64\nsudo mv runc.amd64 /usr/local/bin/runc\n</code></pre>\n<h3 id=\"3-å®‰è£…-cni-æ’ä»¶\">3. å®‰è£… CNI æ’ä»¶</h3>\n<pre><code class=\"language-bash\">sudo mkdir -p /opt/cni/bin/\nsudo tar xf cni-plugins-linux-amd64-v1.9.0.tgz -C /opt/cni/bin/\n</code></pre>\n<h3 id=\"4-å®‰è£…-containerd\">4. å®‰è£… containerd</h3>\n<pre><code class=\"language-bash\">sudo tar xf containerd-2.2.1-linux-amd64.tar.gz\nsudo mv bin/* /usr/local/bin/\n</code></pre>\n<h3 id=\"5-é…ç½®-containerd\">5. é…ç½® containerd</h3>\n<p>ç”Ÿæˆé»˜è®¤é…ç½®å¹¶è¿›è¡Œå¿…è¦çš„ä¿®æ”¹ï¼š</p>\n<pre><code class=\"language-bash\"># åˆ›å»º Harbor è¯ä¹¦ç›®å½•\nsudo mkdir -p /etc/containerd/certs.d/192.168.0.42/\n\n# ç”Ÿæˆé»˜è®¤é…ç½®\nsudo containerd config default &gt; /etc/containerd/config.toml\n\n# å¤åˆ¶ Harbor è¯ä¹¦\nsudo cp ~/apps/harbor/certs/harbor.crt /etc/containerd/certs.d/192.168.0.42/ca.crt\n</code></pre>\n<p>å…³é”®é…ç½®ä¿®æ”¹ï¼š</p>\n<pre><code class=\"language-toml\"># è®¾ç½® Pod æ²™ç®±é•œåƒæº\n[plugins.'io.containerd.cri.v1.images'.pinned_images]\n  sandbox = '192.168.0.42/google_containers/pause:3.10'\n\n# é…ç½®ç§æœ‰é•œåƒä»“åº“\n[plugins.'io.containerd.cri.v1.images'.registry]\n  config_path = '/etc/containerd/certs.d'\n\n# å¯ç”¨ systemd cgroup é©±åŠ¨\n[plugins.'io.containerd.cri.v1.runtime'.containerd.runtimes.runc.options]\n  SystemdCgroup = true\n</code></pre>\n<h3 id=\"6-é…ç½®-systemd-æœåŠ¡\">6. é…ç½® systemd æœåŠ¡</h3>\n<p>ä» <a href=\"https://raw.githubusercontent.com/containerd/containerd/main/containerd.service\" rel=\"noopener nofollow\" target=\"_blank\">å®˜æ–¹ä»“åº“</a> è·å– service æ–‡ä»¶ï¼š</p>\n<pre><code class=\"language-bash\">sudo curl -o /usr/lib/systemd/system/containerd.service https://raw.githubusercontent.com/containerd/containerd/main/containerd.service\n</code></pre>\n<h3 id=\"7-å¯åŠ¨-containerd-æœåŠ¡\">7. å¯åŠ¨ containerd æœåŠ¡</h3>\n<pre><code class=\"language-bash\">sudo systemctl daemon-reload\nsudo systemctl enable --now containerd\n</code></pre>\n<h2 id=\"kubernetes-ç»„ä»¶éƒ¨ç½²\">Kubernetes ç»„ä»¶éƒ¨ç½²</h2>\n<h3 id=\"1-å®‰è£…-kubernetes-äºŒè¿›åˆ¶æ–‡ä»¶\">1. å®‰è£… Kubernetes äºŒè¿›åˆ¶æ–‡ä»¶</h3>\n<p>ä» <a href=\"https://github.com/kubernetes/kubernetes/releases\" rel=\"noopener nofollow\" target=\"_blank\">Kubernetes GitHub Releases</a> ä¸‹è½½ <code>kubernetes-server-linux-amd64.tar.gz</code>ï¼Œæå–æ ¸å¿ƒç»„ä»¶ï¼š</p>\n<pre><code class=\"language-bash\"># è§£å‹å¹¶å®‰è£…æ ¸å¿ƒç»„ä»¶\ntar xf kubernetes-server-linux-amd64.tar.gz\nsudo cp kubernetes/server/bin/{kubeadm,kubelet,kubectl} /usr/local/bin/\n\n# éªŒè¯æ‰€éœ€é•œåƒåˆ—è¡¨\nkubeadm config images list --kubernetes-version v1.33.7\n</code></pre>\n<p>å°†åˆ—å‡ºçš„æ‰€æœ‰é•œåƒï¼ˆåŒ…æ‹¬ pauseã€corednsã€etcd ç­‰ï¼‰ä»å®˜æ–¹æºæ‹‰å–åé‡æ–°æ‰“æ ‡ç­¾å¹¶æ¨é€åˆ° Harbor çš„ <code>google_containers</code> é¡¹ç›®ä¸­ã€‚</p>\n<h3 id=\"2-é…ç½®-kubelet-systemd-æœåŠ¡\">2. é…ç½® kubelet systemd æœåŠ¡</h3>\n<p>åˆ›å»ºä¸»æœåŠ¡æ–‡ä»¶ <code>/usr/lib/systemd/system/kubelet.service</code>ï¼š</p>\n<pre><code class=\"language-ini\">[Unit]\nDescription=kubelet: The Kubernetes Node Agent\nDocumentation=https://kubernetes.io/docs/\nWants=network-online.target\nAfter=network-online.target\n\n[Service]\nExecStart=/usr/local/bin/kubelet\nRestart=always\nStartLimitInterval=0\nRestartSec=10\n\n[Install]\nWantedBy=multi-user.target\n</code></pre>\n<h3 id=\"3-åˆ›å»º-kubeadm-é…ç½®ç›®å½•\">3. åˆ›å»º kubeadm é…ç½®ç›®å½•</h3>\n<pre><code class=\"language-bash\">sudo mkdir -p /usr/lib/systemd/system/kubelet.service.d/\n</code></pre>\n<h3 id=\"4-é…ç½®-kubeadm-drop-in-æ–‡ä»¶\">4. é…ç½® kubeadm drop-in æ–‡ä»¶</h3>\n<p>åˆ›å»º <code>/usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf</code>ï¼š</p>\n<pre><code class=\"language-ini\"># Note: This dropin only works with kubeadm and kubelet v1.11+\n[Service]\nEnvironment=\"KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf\"\nEnvironment=\"KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml\"\n# This is a file that \"kubeadm init\" and \"kubeadm join\" generates at runtime, populating the KUBELET_KUBEADM_ARGS variable dynamically\nEnvironmentFile=-/var/lib/kubelet/kubeadm-flags.env\n# This is a file that the user can use for overrides of the kubelet args as a last resort. Preferably, the user should use\n# the .NodeRegistration.KubeletExtraArgs object in the configuration files instead. KUBELET_EXTRA_ARGS should be sourced from this file.\nEnvironmentFile=-/etc/sysconfig/kubelet\nExecStart=\nExecStart=/usr/local/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_ARGS $KUBELET_EXTRA_ARGS\n</code></pre>\n<h3 id=\"5-å¯åŠ¨-kubelet-æœåŠ¡\">5. å¯åŠ¨ kubelet æœåŠ¡</h3>\n<pre><code class=\"language-bash\">sudo systemctl daemon-reload\nsudo systemctl enable --now kubelet\n</code></pre>\n<h2 id=\"é›†ç¾¤åˆå§‹åŒ–\">é›†ç¾¤åˆå§‹åŒ–</h2>\n<h3 id=\"1-åˆ›å»º-kubeadm-é…ç½®æ–‡ä»¶\">1. åˆ›å»º kubeadm é…ç½®æ–‡ä»¶</h3>\n<p>åˆ›å»º <code>kubeadm-config.yaml</code> é…ç½®æ–‡ä»¶ï¼š</p>\n<pre><code class=\"language-yaml\">apiVersion: kubeadm.k8s.io/v1beta4\nkind: ClusterConfiguration\nkubernetesVersion: v1.33.7\nimageRepository: 192.168.0.42/google_containers  # æŒ‡å‘æœ¬åœ° Harbor ä»“åº“\nnetworking:\n  podSubnet: \"10.10.0.0/16\"   # Cilium é»˜è®¤ Pod ç½‘æ®µ\n  serviceSubnet: \"10.96.0.0/12\"\n---\napiVersion: kubelet.config.k8s.io/v1beta1\nkind: KubeletConfiguration\ncgroupDriver: systemd\nimageGCHighThresholdPercent: 70   # ç£ç›˜ä½¿ç”¨ç‡è¶…è¿‡ 70% æ—¶å¼€å§‹æ¸…ç†é•œåƒ\nimageGCLowThresholdPercent: 60    # æ¸…ç†è‡³ç£ç›˜ä½¿ç”¨ç‡ 60% æ—¶åœæ­¢\n---\napiVersion: kubeproxy.config.k8s.io/v1alpha1\nkind: KubeProxyConfiguration\nmode: \"ipvs\"  # è™½ç„¶åç»­ä¼šä½¿ç”¨ Cilium æ›¿ä»£ kube-proxyï¼Œä½†åˆå§‹åŒ–é˜¶æ®µä»éœ€é…ç½®\n</code></pre>\n<h3 id=\"2-æ‰§è¡Œé›†ç¾¤åˆå§‹åŒ–\">2. æ‰§è¡Œé›†ç¾¤åˆå§‹åŒ–</h3>\n<pre><code class=\"language-bash\">sudo kubeadm init --config kubeadm-config.yaml --ignore-preflight-errors=ImagePull\n</code></pre>\n<h3 id=\"3-æ¸…ç†-kube-proxyä½¿ç”¨-cilium-æ›¿ä»£\">3. æ¸…ç† kube-proxyï¼ˆä½¿ç”¨ Cilium æ›¿ä»£ï¼‰</h3>\n<p>ç”±äºæˆ‘ä»¬å°†ä½¿ç”¨ Cilium ä½œä¸ºç½‘ç»œè§£å†³æ–¹æ¡ˆï¼Œå¯ä»¥ç§»é™¤ kube-proxyï¼š</p>\n<pre><code class=\"language-bash\"># åˆ é™¤ kube-proxy DaemonSet\nkubectl delete ds kube-proxy -n kube-system\n\n# åœ¨æ‰€æœ‰èŠ‚ç‚¹æ¸…ç† iptables è§„åˆ™æ®‹ç•™\nsudo kube-proxy --cleanup\n</code></pre>\n<h3 id=\"4-éªŒè¯åˆå§‹åŒ–çŠ¶æ€\">4. éªŒè¯åˆå§‹åŒ–çŠ¶æ€</h3>\n<p>åˆå§‹åŒ–å®Œæˆåï¼Œé…ç½® kubectl å¹¶æ£€æŸ¥é›†ç¾¤çŠ¶æ€ï¼š</p>\n<pre><code class=\"language-bash\"># é…ç½® kubectl\nmkdir -p $HOME/.kube\nsudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\nsudo chown $(id -u):$(id -g) $HOME/.kube/config\n\n# æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€ï¼ˆæ­¤æ—¶åº”æ˜¾ç¤º NotReadyï¼Œå› ä¸º CNI å°šæœªå®‰è£…ï¼‰\nkubectl get nodes\nkubectl get namespaces\n</code></pre>\n<h2 id=\"cilium-ç½‘ç»œæ’ä»¶éƒ¨ç½²\">Cilium ç½‘ç»œæ’ä»¶éƒ¨ç½²</h2>\n<p>Cilium åŸºäº eBPF æŠ€æœ¯æä¾›é«˜æ€§èƒ½çš„ç½‘ç»œã€å®‰å…¨å’Œå¯è§‚æµ‹æ€§åŠŸèƒ½ã€‚</p>\n<h3 id=\"1-å®‰è£…-cilium-cli\">1. å®‰è£… cilium-cli</h3>\n<p>ä» <a href=\"https://github.com/cilium/cilium-cli/releases\" rel=\"noopener nofollow\" target=\"_blank\">Cilium CLI Releases</a> ä¸‹è½½å¹¶å®‰è£…å‘½ä»¤è¡Œå·¥å…·ã€‚</p>\n<h3 id=\"2-å‡†å¤‡-cilium-é•œåƒ\">2. å‡†å¤‡ Cilium é•œåƒ</h3>\n<p>å°† Cilium æ‰€éœ€çš„é•œåƒæ¨é€åˆ° Harbor ä»“åº“ï¼š</p>\n<pre><code class=\"language-bash\">#!/bin/bash\n\nset -euo pipefail\n\nimages=(\n    cilium/cilium:v1.18.6\n    cilium/hubble-relay:v1.18.6\n    cilium/hubble-ui-backend:v0.13.3\n    cilium/hubble-ui:v0.13.3\n    cilium/cilium-envoy:v1.35.9-1767794330-db497dd19e346b39d81d7b5c0dedf6c812bcc5c9\n    cilium/certgen:v0.3.1\n    cilium/startup-script:1755531540-60ee83e\n)\n\nsrc_registry=\"quay.io\"\ntarget_registry=\"192.168.0.42\"\n\nfor image in \"${images[@]}\"; do\n    echo \"Processing image: ${image}\"\n    docker pull \"${src_registry}/${image}\"\n    docker tag \"${src_registry}/${image}\" \"${target_registry}/${image}\"\n    docker push \"${target_registry}/${image}\"\ndone\n</code></pre>\n<h3 id=\"3-è·å–-helm-chart\">3. è·å– Helm Chart</h3>\n<pre><code class=\"language-bash\">helm repo add cilium https://helm.cilium.io/\nhelm pull cilium/cilium --version 1.18.6\ntar xf cilium-1.18.6.tgz\nmv cilium cilium-chart\n</code></pre>\n<h3 id=\"4-é…ç½®-chart-values\">4. é…ç½® Chart Values</h3>\n<p>é¦–å…ˆæ›¿æ¢æ‰€æœ‰é•œåƒæºåœ°å€ï¼š</p>\n<pre><code class=\"language-bash\">sed -i 's#quay.io#192.168.0.42#g' ./cilium-chart/values.yaml\n</code></pre>\n<p>å…³é”®é…ç½®é¡¹è°ƒæ•´ï¼š</p>\n<pre><code class=\"language-yaml\"># å¯ç”¨ kube-proxy æ›¿ä»£æ¨¡å¼\nkubeProxyReplacement: true\n\n# æŒ‡å®š Kubernetes API æœåŠ¡å™¨åœ°å€\nk8sServiceHost: \"192.168.0.22\"\nk8sServicePort: 6443\n\n# å•èŠ‚ç‚¹éƒ¨ç½²ï¼Œoperator å‰¯æœ¬æ•°è®¾ä¸º 1\noperator:\n  replicas: 1\n\n# å¯ç”¨ Hubble å¯è§‚æµ‹æ€§ç»„ä»¶\nhubble:\n  enabled: true\n  relay:\n    enabled: true\n  ui:\n    enabled: true\n\n# é…ç½® IPAM CIDR èŒƒå›´\nipam:\n  operator:\n    clusterPoolIPv4PodCIDRList:\n      - \"10.10.0.0/16\"\n</code></pre>\n<blockquote>\n<p><strong>é•œåƒ Digest æ³¨æ„äº‹é¡¹</strong>ï¼šé€šè¿‡ docker pull å† push çš„æ–¹å¼å¯èƒ½å¯¼è‡´é•œåƒ digest å‘ç”Ÿå˜åŒ–ã€‚å¦‚é‡é•œåƒæ‹‰å–å¤±è´¥ï¼Œå¯å°† <code>values.yaml</code> ä¸­çš„ <code>useDigest</code> è®¾ç½®ä¸º <code>false</code>ã€‚</p>\n</blockquote>\n<h3 id=\"5-å®‰è£…-cilium\">5. å®‰è£… Cilium</h3>\n<pre><code class=\"language-bash\"># æ‰§è¡Œå®‰è£…\ncilium install --chart-directory ./cilium-chart\n\n# æ£€æŸ¥å®‰è£…çŠ¶æ€\ncilium status\n\n# ç§»é™¤ control-plane æ±¡ç‚¹ä»¥å…è®¸ Pod è°ƒåº¦\nkubectl taint nodes --all node-role.kubernetes.io/control-plane-\n</code></pre>\n<h3 id=\"6-éªŒè¯é›†ç¾¤çŠ¶æ€\">6. éªŒè¯é›†ç¾¤çŠ¶æ€</h3>\n<p>ç­‰å¾…æ‰€æœ‰ Pod æ­£å¸¸è¿è¡Œåï¼ŒéªŒè¯é›†ç¾¤å°±ç»ªçŠ¶æ€ï¼š</p>\n<pre><code class=\"language-bash\"># æ£€æŸ¥æ‰€æœ‰å‘½åç©ºé—´çš„ Pod çŠ¶æ€\nkubectl get pods -A\n\n# éªŒè¯èŠ‚ç‚¹çŠ¶æ€ï¼ˆåº”æ˜¾ç¤º Readyï¼‰\nkubectl get nodes\n\n# æ£€æŸ¥ Cilium ç»„ä»¶çŠ¶æ€\ncilium status --verbose\n</code></pre>\n<h2 id=\"æ·»åŠ å·¥ä½œèŠ‚ç‚¹æ‰©å±•éƒ¨ç½²\">æ·»åŠ å·¥ä½œèŠ‚ç‚¹ï¼ˆæ‰©å±•éƒ¨ç½²ï¼‰</h2>\n<p>å®Œæˆå•èŠ‚ç‚¹é›†ç¾¤éƒ¨ç½²åï¼Œå¦‚éœ€æ‰©å±•ä¸ºå¤šèŠ‚ç‚¹é›†ç¾¤ï¼Œå¯åœ¨æ–°èŠ‚ç‚¹ä¸Šæ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š</p>\n<p><em>åœ¨æ–°èŠ‚ç‚¹ä¸Šéœ€è¦å…ˆå®Œæˆä¸Šé¢çš„ç³»ç»Ÿåˆå§‹åŒ–ã€Containerdé…ç½®ã€kubeç»„ä»¶é…ç½®</em></p>\n<h3 id=\"1-ç”ŸæˆèŠ‚ç‚¹åŠ å…¥ä»¤ç‰Œ\">1. ç”ŸæˆèŠ‚ç‚¹åŠ å…¥ä»¤ç‰Œ</h3>\n<p>åœ¨ Control Plane èŠ‚ç‚¹ä¸Šç”Ÿæˆ 24 å°æ—¶æœ‰æ•ˆçš„åŠ å…¥ä»¤ç‰Œï¼š</p>\n<pre><code class=\"language-bash\">kubeadm token create --print-join-command\n</code></pre>\n<p>è¯¥å‘½ä»¤å°†è¾“å‡ºç±»ä¼¼ä»¥ä¸‹æ ¼å¼çš„åŠ å…¥å‘½ä»¤ï¼š</p>\n<pre><code class=\"language-bash\">kubeadm join 192.168.0.22:6443 --token &lt;token&gt; --discovery-token-ca-cert-hash sha256:&lt;hash&gt;\n</code></pre>\n<h3 id=\"2-åœ¨æ–°èŠ‚ç‚¹æ‰§è¡ŒåŠ å…¥å‘½ä»¤\">2. åœ¨æ–°èŠ‚ç‚¹æ‰§è¡ŒåŠ å…¥å‘½ä»¤</h3>\n<p>åœ¨æ–°èŠ‚ç‚¹ä¸Šæ‰§è¡Œä¸Šè¿°å‘½ä»¤ï¼Œå¹¶å¿½ç•¥é•œåƒé¢„æ£€é”™è¯¯ï¼š</p>\n<pre><code class=\"language-bash\">sudo kubeadm join 192.168.0.22:6443 \\\n  --token &lt;token&gt; \\\n  --discovery-token-ca-cert-hash sha256:&lt;hash&gt; \\\n  --ignore-preflight-errors=ImagePull\n</code></pre>\n<h3 id=\"3-éªŒè¯èŠ‚ç‚¹åŠ å…¥çŠ¶æ€\">3. éªŒè¯èŠ‚ç‚¹åŠ å…¥çŠ¶æ€</h3>\n<pre><code class=\"language-bash\"># æ£€æŸ¥èŠ‚ç‚¹åˆ—è¡¨\nkubectl get nodes\n\n# éªŒè¯ Cilium çŠ¶æ€\ncilium status\n\n# æ¸…ç† iptables è§„åˆ™ï¼ˆå¦‚å·²ç¦ç”¨ kube-proxyï¼‰\nsudo iptables -F\n</code></pre>\n<p>Cilium ä¼šè‡ªåŠ¨åœ¨æ–°èŠ‚ç‚¹ä¸Šéƒ¨ç½²ä»£ç† Podï¼Œç¡®ä¿ç½‘ç»œè¿é€šæ€§ã€‚</p>\n<h2 id=\"ç§æœ‰é•œåƒä»“åº“è®¤è¯é…ç½®\">ç§æœ‰é•œåƒä»“åº“è®¤è¯é…ç½®</h2>\n<p>å¯¹äº Harbor ä¸­éå…¬å¼€é¡¹ç›®çš„é•œåƒæ‹‰å–ï¼Œéœ€è¦é…ç½®ç›¸åº”çš„è®¤è¯æœºåˆ¶ã€‚</p>\n<h3 id=\"æ–¹å¼ä¸€pod-çº§åˆ«-imagepullsecretsæ¨è\">æ–¹å¼ä¸€ï¼šPod çº§åˆ« imagePullSecretsï¼ˆæ¨èï¼‰</h3>\n<p>é€‚ç”¨äºéœ€è¦ç²¾ç»†åŒ–æ§åˆ¶é•œåƒæ‹‰å–æƒé™çš„åœºæ™¯ã€‚</p>\n<h4 id=\"1-åˆ›å»º-docker-registry-secret\">1. åˆ›å»º Docker Registry Secret</h4>\n<pre><code class=\"language-bash\">kubectl create secret docker-registry harbor-pull-secret \\\n  --docker-server=192.168.0.42 \\\n  --docker-username=&lt;your-username&gt; \\\n  --docker-password=&lt;your-password&gt; \\\n  --docker-email=&lt;your-email&gt;\n</code></pre>\n<h4 id=\"2-åœ¨-pod-å®šä¹‰ä¸­å¼•ç”¨-secret\">2. åœ¨ Pod å®šä¹‰ä¸­å¼•ç”¨ Secret</h4>\n<pre><code class=\"language-yaml\">apiVersion: v1\nkind: Pod\nspec:\n  containers:\n  - name: my-app\n    image: 192.168.0.42/private-project/my-image:v1\n  imagePullSecrets:\n  - name: harbor-pull-secret\n</code></pre>\n<h3 id=\"æ–¹å¼äºŒserviceaccount-ç»‘å®šä¾¿æ·æ–¹æ¡ˆ\">æ–¹å¼äºŒï¼šServiceAccount ç»‘å®šï¼ˆä¾¿æ·æ–¹æ¡ˆï¼‰</h3>\n<p>é€‚ç”¨äºå‘½åç©ºé—´å†…æ‰€æœ‰ Pod éƒ½éœ€è¦è®¿é—®ç§æœ‰é•œåƒä»“åº“çš„åœºæ™¯ã€‚</p>\n<pre><code class=\"language-bash\"># å°† Secret ç»‘å®šåˆ° default ServiceAccount\nkubectl patch serviceaccount default -p '{\"imagePullSecrets\": [{\"name\": \"harbor-pull-secret\"}]}'\n</code></pre>\n<p>æ­¤é…ç½®å°†ä½¿è¯¥å‘½åç©ºé—´ä¸‹æ‰€æœ‰æ–°å»ºçš„ Pod è‡ªåŠ¨ç»§æ‰¿é•œåƒæ‹‰å–æƒé™ã€‚</p>\n<h3 id=\"æ–¹å¼ä¸‰containerd-å…¨å±€è®¤è¯å®éªŒç¯å¢ƒé€‚ç”¨\">æ–¹å¼ä¸‰ï¼šContainerd å…¨å±€è®¤è¯ï¼ˆå®éªŒç¯å¢ƒé€‚ç”¨ï¼‰</h3>\n<p>åœ¨ Containerd å±‚é¢é…ç½®å…¨å±€è®¤è¯ï¼Œé€‚ç”¨äºä¸ªäººå®éªŒç¯å¢ƒã€‚</p>\n<p>ç¼–è¾‘ <code>/etc/containerd/config.toml</code>ï¼š</p>\n<pre><code class=\"language-toml\">[plugins.\"io.containerd.grpc.v1.cri\".registry.configs.\"192.168.0.42\".auth]\n  username = \"your-username\"\n  password = \"your-password\"\n  # æˆ–ä½¿ç”¨ base64 ç¼–ç çš„å‡­è¯ï¼šauth = \"base64(username:password)\"\n</code></pre>\n<blockquote>\n<p><strong>å®‰å…¨æé†’</strong>ï¼šæ–¹å¼ä¸‰å°†å‡­æ®æ˜æ–‡å­˜å‚¨åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œä¸å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ã€‚</p>\n</blockquote>\n<h2 id=\"è¡¥å……\">è¡¥å……</h2>\n<p>ç›¸è¾ƒäºä½¿ç”¨äºŒè¿›åˆ¶æ–¹å¼éƒ¨ç½²ï¼Œç”¨kubeadmèµ·ç çœå»äº†æ‰‹åŠ¨ç»´æŠ¤è¯ä¹¦çš„æ“ä½œï¼Œåç»­æ·»åŠ èŠ‚ç‚¹ä¹Ÿæ›´ç®€å•äº›ã€‚æœ‰ç©ºæ•´ä¸ªansibleè®©æ·»åŠ èŠ‚ç‚¹æ›´æ–¹ä¾¿ã€‚</p>\n\n\n</div>\n<div id=\"MySignature\">\n    <p>æœ¬æ–‡æ¥è‡ªåšå®¢å›­ï¼Œä½œè€…ï¼š<a href=\"https://www.cnblogs.com/XY-Heruo/\" target=\"_blank\">èŠ±é…’é”„ä½œç”°</a>ï¼Œè½¬è½½è¯·æ³¨æ˜åŸæ–‡é“¾æ¥ï¼š<a href=\"https://www.cnblogs.com/XY-Heruo/p/19560948\" target=\"_blank\">https://www.cnblogs.com/XY-Heruo/p/19560948</a></p>\n</div>\n<div class=\"clear\"></div>\n\n            </div>\n            <div class=\"postDesc\">posted @ \n<span id=\"post-date\">2026-02-01 16:03</span>&nbsp;\n<a href=\"https://www.cnblogs.com/XY-Heruo\">èŠ±é…’é”„ä½œç”°</a>&nbsp;\né˜…è¯»(<span id=\"post_view_count\">51</span>)&nbsp;\nè¯„è®º(<span id=\"post_comment_count\">0</span>)&nbsp;\n&nbsp;\n<a href=\"\">æ”¶è—</a>&nbsp;\n<a href=\"\">ä¸¾æŠ¥</a>\n</div>"
    },
    {
      "title": "å°†SignalRç§»æ¤åˆ°Esp32â€”è®©å°æ™ºè®¾å¤‡æ— ç¼è¿æ¥.NETåŠŸèƒ½æ‹“å±•MCPæœåŠ¡",
      "link": "https://www.cnblogs.com/GreenShade/p/19560338",
      "published": "",
      "description": "<h1 class=\"postTitle\">\n                <a class=\"postTitle2 vertical-middle\" href=\"https://www.cnblogs.com/GreenShade/p/19560338\" id=\"cb_post_title_url\" title=\"å‘å¸ƒäº 2026-02-01 15:33\">\n    <span>å°†SignalRç§»æ¤åˆ°Esp32â€”è®©å°æ™ºè®¾å¤‡æ— ç¼è¿æ¥.NETåŠŸèƒ½æ‹“å±•MCPæœåŠ¡</span>\n    \n\n</a>\n\n            </h1>\n            <div class=\"clear\"></div>\n            <div class=\"postBody\">\n                <div class=\"blogpost-body cnblogs-markdown\" id=\"cnblogs_post_body\">\n<h2 id=\"å‰è¨€\">å‰è¨€</h2>\n<p>è¿™æ®µæ—¶é—´è¿·ä¸Šäº†æ‰‹æ“Esp32çš„å°æ™ºèŠå¤©æœºå™¨äººï¼Œä¹Ÿç”¨.NETä¸ºå°æ™ºAIå¼€å‘äº†ä¸€äº›MCPè½¬æ¥å¹³å°å’ŒMCPæœåŠ¡ã€‚å°æ™ºESP32æœ¬èº«å°±å…·å¤‡MCPèƒ½åŠ›ï¼Œå¯ä»¥è°ƒç”¨æœ¬åœ°MCPå·¥å…·å’ŒæœåŠ¡ç«¯MCPå·¥å…·ï¼Œå¹¶å°†ç»“æœè¿”å›ç»™è®¾å¤‡ï¼Œè¿™ä¸ªåŠŸèƒ½ä¸€ç›´éƒ½æœ‰ã€‚</p>\n<p>å¦‚æœä½ æœ‰æ‰‹æ“Esp32çš„ç¡¬ä»¶ç©å…·æ‰“ç®—ï¼Œå¯ä»¥å…³æ³¨æˆ‘çš„Bç«™è´¦å·ï¼ˆç»¿è«é˜¿å¹¿ï¼‰<a href=\"https://space.bilibili.com/25228512\" rel=\"noopener nofollow\" target=\"_blank\">https://space.bilibili.com/25228512</a><br />\nå¸¦ä½ æ‰‹æ“ç©å…·ã€‚</p>\n<p>å°æ™ºåŸæœ¬è¿™å¥—æ¶æ„æœ‰ä¸ªå±€é™æ€§ï¼š<strong>MCPå·¥å…·æ‰§è¡Œå®Œä¹‹åï¼Œåªèƒ½åŒæ­¥è¿”å›ç»“æœæˆ–è€…é€šè¿‡å¼‚æ­¥é‚®ä»¶é€šçŸ¥ï¼Œè®¾å¤‡æ— æ³•è¢«åŠ¨æ¥æ”¶æœåŠ¡ç«¯çš„æ¶ˆæ¯</strong>ã€‚æ¯”å¦‚æˆ‘æƒ³è®©æœåŠ¡ç«¯ä¸»åŠ¨ç»™è®¾å¤‡æ¨é€ä¸€å¼ å›¾ç‰‡ã€æ’­æ”¾ä¸€æ®µè¯­éŸ³ã€æˆ–è€…å‘é€ä¸€ä¸ªæ–‡æœ¬é€šçŸ¥ï¼Œåœ¨ä¹‹å‰çš„æ¶æ„ä¸‹æ˜¯åšä¸åˆ°çš„ã€‚</p>\n<p>æ‰€ä»¥æˆ‘å°±å†³å®šæ”¹é€ å°æ™ºå®¢æˆ·ç«¯ï¼Œé›†æˆSignalRå®æ—¶é€šä¿¡æ¡†æ¶ã€‚è¿™æ¬¡æ”¹é€ çš„æ ¸å¿ƒä»·å€¼æ˜¯ï¼š<strong>é€šè¿‡SignalRæ¶ˆæ¯é€šé“ï¼Œè®©è®¾å¤‡å¯ä»¥æ¥æ”¶å„ç§ç±»å‹çš„æ¶ˆæ¯ï¼ˆå£°éŸ³ã€å›¾ç‰‡ã€æ–‡æœ¬é€šçŸ¥ï¼‰ï¼ŒæœåŠ¡ç«¯çš„MCPå·¥å…·æ‰§è¡ŒæˆåŠŸåï¼Œå¯ä»¥æ ¹æ®ç”¨æˆ·IDæ¨é€æ•°æ®åˆ°å¯¹åº”çš„ç”¨æˆ·é€šé“</strong>ã€‚</p>\n<p>æ•´ä¸ªæ”¹é€ æ¶‰åŠSignalR C++å®¢æˆ·ç«¯çš„é›†æˆã€JWT Tokenè®¤è¯ã€æ‰«ç ç™»å½•ï¼ˆåŸºäºESP32æœ¬åœ°MCPå·¥å…·å®ç°ï¼‰ã€ä»¥åŠæœåŠ¡ç«¯æ¶ˆæ¯æ¨é€é€»è¾‘ã€‚å®¢æˆ·ç«¯ä»£ç éƒ½æ˜¯C++å®ç°çš„ï¼Œä¸è¿‡ç°åœ¨AIè¾…åŠ©ç¼–ç¨‹å¾ˆå¼ºå¤§ï¼Œå¸®æˆ‘èŠ‚çœäº†å¤§é‡æ—¶é—´ã€‚</p>\n<p><img alt=\"img\" src=\"https://img2024.cnblogs.com/blog/1690009/202602/1690009-20260201121657114-327485878.png\" /></p>\n<h2 id=\"é—®é¢˜è§£ç­”\">é—®é¢˜è§£ç­”</h2>\n<p><strong>Q: ä¸ºä»€ä¹ˆé€‰æ‹©SignalRè€Œä¸æ˜¯ç›´æ¥ç”¨WebSocketï¼Ÿ</strong></p>\n<p>A: èµ·åˆæˆ‘ç¡®å®è€ƒè™‘è¿‡ç›´æ¥ç”¨WebSocketï¼Œä½†SignalRæä¾›äº†å¾ˆå¤šå¼€ç®±å³ç”¨çš„åŠŸèƒ½ï¼š</p>\n<ul>\n<li><strong>HubæŠ½è±¡</strong>ï¼šæœåŠ¡ç«¯å¯ä»¥è½»æ¾å®ç°ç¾¤ç»„ç®¡ç†ï¼ŒæŒ‰ç”¨æˆ·IDæ¨é€æ¶ˆæ¯ï¼Œæ¯”å¦‚<code>Clients.Group($\"Users:{userId}\").SendAsync(\"Notification\", message)</code></li>\n<li><strong>æ¶ˆæ¯è·¯ç”±</strong>ï¼šä¸éœ€è¦è‡ªå·±å†™æ¶ˆæ¯åˆ†å‘é€»è¾‘ï¼ŒSignalRçš„Hubæ–¹æ³•è°ƒç”¨å’Œäº‹ä»¶æ¨é€å·²ç»å¾ˆå®Œå–„äº†</li>\n<li><strong>ç±»å‹åŒ–è°ƒç”¨</strong>ï¼šç›¸æ¯”åŸå§‹WebSocketçš„å­—ç¬¦ä¸²æ¶ˆæ¯ï¼ŒSignalRæä¾›äº†ç±»ä¼¼RPCçš„è°ƒç”¨ä½“éªŒï¼Œä»£ç æ›´æ¸…æ™°</li>\n</ul>\n<p>è™½ç„¶ESP32æ²¡æœ‰ç°æˆçš„SignalRåº“ï¼Œä½†æˆ‘æ‰¾åˆ°äº†å¾®è½¯å®˜æ–¹çš„C++ SignalRå®¢æˆ·ç«¯ï¼ˆåŠæˆå“ï¼‰ï¼Œå°†å®ƒä¸ESP32çš„WebSocketç»„ä»¶æ•´åˆåï¼Œå°±èƒ½ç”¨ä¸ŠSignalRçš„è¿™äº›ç‰¹æ€§äº†ã€‚è‡³äºSignalRè‡ªå¸¦çš„é‡è¿æœºåˆ¶ï¼Œæˆ‘æ²¡ç”¨ï¼Œå°æ™ºæœ‰è‡ªå·±çš„å¾ªç¯é‡è¿é€»è¾‘ï¼Œæ›´å¯æ§ä¸€äº›ã€‚</p>\n<p><strong>Q: æ”¹é€ çš„æ ¸å¿ƒä»·å€¼æ˜¯ä»€ä¹ˆï¼Ÿè§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ</strong></p>\n<p>A: æ”¹é€ å‰ï¼ŒESP32çš„MCPå·¥å…·è°ƒç”¨å®Œæˆåï¼Œåªèƒ½é€šè¿‡ä¸¤ç§æ–¹å¼é€šçŸ¥ï¼š</p>\n<ol>\n<li><strong>åŒæ­¥è¿”å›</strong>ï¼šå·¥å…·æ‰§è¡Œç»“æœç›´æ¥è¿”å›ç»™è°ƒç”¨æ–¹</li>\n<li><strong>å¼‚æ­¥é‚®ä»¶</strong>ï¼šé€šè¿‡é‚®ä»¶å‘é€æ‰§è¡Œç»“æœ</li>\n</ol>\n<p>è¿™ä¸¤ç§æ–¹å¼éƒ½æ— æ³•æ»¡è¶³å®æ—¶æ¨é€çš„éœ€æ±‚ã€‚æ¯”å¦‚æˆ‘æƒ³è®©æœåŠ¡ç«¯åœ¨ç”Ÿå›¾å®Œæˆåç«‹å³æ¨é€å›¾ç‰‡ç»™è®¾å¤‡æ˜¾ç¤ºï¼Œæˆ–è€…æ’­æ”¾ä¸€æ®µè¯­éŸ³æç¤ºï¼Œä¹‹å‰çš„æ¶æ„åšä¸åˆ°ã€‚</p>\n<p>æ”¹é€ åï¼Œé€šè¿‡SignalRå»ºç«‹äº†ä¸€æ¡<strong>æœåŠ¡ç«¯åˆ°è®¾å¤‡çš„å®æ—¶æ¶ˆæ¯é€šé“</strong>ï¼š</p>\n<ul>\n<li>æœåŠ¡ç«¯çš„MCPå·¥å…·æ‰§è¡ŒæˆåŠŸåï¼Œå¯ä»¥è°ƒç”¨<code>_hubContext.Clients.Group($\"Users:{userId}\").SendAsync(\"ShowImage\", imageData)</code>å°†å›¾ç‰‡æ¨é€ç»™è®¾å¤‡</li>\n<li>è®¾å¤‡é€šè¿‡SignalRçš„äº‹ä»¶ç›‘å¬æ¥æ”¶æ¶ˆæ¯ï¼š<code>connection-&gt;on(\"ShowImage\", [](const std::vector&lt;signalr::value&gt;&amp; args) { ... })</code></li>\n<li>æ”¯æŒæ¨é€ä»»æ„ç±»å‹çš„æ•°æ®ï¼šæ–‡æœ¬ã€å›¾ç‰‡ï¼ˆBase64ï¼‰ã€è¯­éŸ³URLã€JSONé€šçŸ¥ç­‰</li>\n</ul>\n<p>è¿™æ‰æ˜¯è¿™æ¬¡æ”¹é€ çš„æ ¸å¿ƒä»·å€¼ï¼š<strong>è®©è®¾å¤‡å…·å¤‡è¢«åŠ¨æ¥æ”¶æœåŠ¡ç«¯æ¶ˆæ¯çš„èƒ½åŠ›</strong>ï¼Œè€Œä¸ä»…ä»…æ˜¯ä¸»åŠ¨è°ƒç”¨å’ŒåŒæ­¥è¿”å›ã€‚</p>\n<p><strong>Q: æ‰«ç ç™»å½•æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ</strong></p>\n<p>A: æ‰«ç ç™»å½•åŠŸèƒ½æ˜¯åŸºäºESP32æœ¬åœ°MCPå·¥å…·å®ç°çš„ï¼Œè¿™æ˜¯å°æ™ºçš„å›ºæœ‰åŠŸèƒ½ï¼Œæˆ‘åªæ˜¯è¿›è¡Œäº†æ‹“å±•ï¼š</p>\n<ol>\n<li>è®¾å¤‡å¯åŠ¨æ—¶æ£€æŸ¥æ˜¯å¦æœ‰JWT Token</li>\n<li>å¦‚æœæ²¡æœ‰Tokenï¼Œè°ƒç”¨æœ¬åœ°MCPå·¥å…·<code>display_qrcode</code>åœ¨å±å¹•ä¸Šæ˜¾ç¤ºäºŒç»´ç </li>\n<li>äºŒç»´ç å†…å®¹åŒ…å«è®¾å¤‡IDå’ŒæœåŠ¡ç«¯åœ°å€ï¼š<code>https://mcp-server.com/device-login?deviceId=xxx</code></li>\n<li>ç”¨æˆ·ç”¨æ‰‹æœºæ‰«ç ï¼Œå®Œæˆæˆæƒã€‚</li>\n<li>è®¾å¤‡è·å–Tokenåä¿å­˜åˆ°NVSï¼ˆNon-Volatile Storageï¼‰ï¼Œä¸‹æ¬¡å¯åŠ¨ç›´æ¥ä½¿ç”¨</li>\n</ol>\n<p>è¿™æ ·å°±å®ç°äº†è®¾å¤‡çš„å¿«é€Ÿè®¤è¯ï¼Œç”¨æˆ·ä½“éªŒå¾ˆå¥½ã€‚æ‰«ç è®¤è¯çš„æœåŠ¡ç«¯æ˜¯ä½¿ç”¨å¼€æºçš„keycloakåšçš„ï¼Œå¯¹æ¥äº†è®¾å¤‡è®¤è¯ç±»å‹ã€‚</p>\n<p><img alt=\"img\" src=\"https://img2024.cnblogs.com/blog/1690009/202602/1690009-20260201121907430-924035727.png\" /></p>\n<h2 id=\"åè¯è§£é‡Š\">åè¯è§£é‡Š</h2>\n<h3 id=\"æ ¸å¿ƒæ¦‚å¿µ\">æ ¸å¿ƒæ¦‚å¿µ</h3>\n<ul>\n<li>\n<p><strong>SignalR</strong>ï¼šå¾®è½¯æä¾›çš„å®æ—¶é€šä¿¡æ¡†æ¶ï¼Œå°è£…äº†WebSocketã€Serverâ€‘Sent Eventså’Œé•¿è½®è¯¢ç­‰ä¼ è¾“æ–¹å¼ï¼Œæ”¯æŒHubæ¨¡å‹ã€è‡ªåŠ¨é‡è¿ä¸æ¶ˆæ¯åºåˆ—åŒ–ã€‚é€‚åˆå®ç°åŒå‘ã€ä½å»¶è¿Ÿçš„å®æ—¶æ¶ˆæ¯ç³»ç»Ÿã€‚å°†å®ƒç§»æ¤åˆ°åµŒå…¥å¼è®¾å¤‡æ—¶éœ€è€ƒè™‘å®¢æˆ·ç«¯å®ç°çš„ä½“ç§¯ã€å†…å­˜æ¶ˆè€—ä¸çº¿ç¨‹æ¨¡å‹ã€‚</p>\n</li>\n<li>\n<p><strong>Hubï¼ˆé›†çº¿å™¨ï¼‰</strong>ï¼šSignalRçš„æ ¸å¿ƒæŠ½è±¡ï¼Œç±»ä¼¼äºMVCä¸­çš„Controllerã€‚æœåŠ¡ç«¯é€šè¿‡Hubå®šä¹‰æ–¹æ³•ä¾›å®¢æˆ·ç«¯è°ƒç”¨ï¼Œå®¢æˆ·ç«¯ä¹Ÿå¯ä»¥æ³¨å†Œäº‹ä»¶ç›‘å¬æœåŠ¡ç«¯æ¨é€ã€‚ä¾‹å¦‚<code>ChatHub.SendMessage(user, message)</code>å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„Hubæ–¹æ³•ã€‚</p>\n</li>\n<li>\n<p><strong>MCPï¼ˆModel Context Protocolï¼‰</strong>ï¼šä¸€ç§åŸºäºJSON-RPC 2.0çš„åè®®ï¼Œç”¨äºå®šä¹‰å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¹‹é—´çš„å·¥å…·è°ƒç”¨è§„èŒƒã€‚åœ¨IoTåœºæ™¯ä¸­ï¼Œè®¾å¤‡å¯ä»¥ä½œä¸ºMCP Serveræš´éœ²èƒ½åŠ›ï¼ˆå¦‚é‡å¯ã€æ˜¾ç¤ºå›¾ç‰‡ï¼‰ï¼Œè€Œäº‘ç«¯æœåŠ¡ä½œä¸ºMCP Clientè°ƒç”¨è¿™äº›èƒ½åŠ›ã€‚</p>\n</li>\n<li>\n<p><strong>JSON-RPC 2.0</strong>ï¼šä¸€ç§è½»é‡çº§çš„è¿œç¨‹è¿‡ç¨‹è°ƒç”¨åè®®ï¼Œä½¿ç”¨JSONç¼–ç ã€‚MCPåè®®åŸºäºæ­¤æ ‡å‡†ï¼Œå®šä¹‰äº†<code>initialize</code>ã€<code>tools/list</code>ã€<code>tools/call</code>ç­‰æ–¹æ³•ã€‚æ¯ä¸ªè¯·æ±‚å¿…é¡»åŒ…å«<code>jsonrpc: \"2.0\"</code>ã€<code>method</code>ã€<code>id</code>å­—æ®µã€‚</p>\n</li>\n</ul>\n<h3 id=\"esp32ç›¸å…³\">ESP32ç›¸å…³</h3>\n<ul>\n<li>\n<p><strong>FreeRTOS</strong>ï¼šä¸€ä¸ªå¼€æºã€è½»é‡çº§çš„å®æ—¶æ“ä½œç³»ç»Ÿå†…æ ¸ï¼Œå¸¸ç”¨äºå¾®æ§åˆ¶å™¨å¹³å°ï¼ˆå¦‚ESP32ï¼‰ã€‚æä¾›ä»»åŠ¡è°ƒåº¦ã€ä¼˜å…ˆçº§ã€äº’æ–¥é”ã€ä¿¡å·é‡ã€é˜Ÿåˆ—ã€è½¯ä»¶å®šæ—¶å™¨ç­‰å®æ—¶ç‰¹æ€§ï¼Œä¾¿äºåœ¨èµ„æºå—é™è®¾å¤‡ä¸Šå®ç°å¹¶å‘ä¸ç¡®å®šæ€§è¡Œä¸ºã€‚ä½¿ç”¨æ—¶éœ€æ³¨æ„å †æ ˆå¤§å°ã€ä¸­æ–­å®‰å…¨å’Œä»»åŠ¡ä¼˜å…ˆçº§è®¾è®¡ã€‚</p>\n</li>\n<li>\n<p><strong>ESP32 PSRAM</strong>ï¼šESP32å¯é€‰çš„å¤–éƒ¨ä¼ªé™æ€RAMï¼ˆPseudo-SRAMï¼‰ï¼Œç”¨äºæ‰©å±•è®¾å¤‡å¯ç”¨å†…å­˜ï¼ˆå¸¸è§4MB/8MB/16MBï¼‰ã€‚é€‚åˆå­˜æ”¾å¤§å¯¹è±¡ã€å›¾åƒç¼“å­˜ã€ç½‘ç»œç¼“å†²å’ŒåŠ¨æ€åˆ†é…æ•°æ®ã€‚åœ¨ESP-IDFä¸­éœ€å¯ç”¨å¹¶æ­£ç¡®é…ç½®ï¼Œåˆ†é…æ—¶ä¹Ÿå¯ä½¿ç”¨ä¸åŒçš„å †åŒºåŸŸï¼ˆå¦‚<code>heap_caps_malloc(size, MALLOC_CAP_SPIRAM)</code>ï¼‰æ¥æ§åˆ¶æ”¾ç½®ä¸æ€§èƒ½ï¼DMAé™åˆ¶ã€‚</p>\n</li>\n<li>\n<p><strong>WebSocket</strong>ï¼šä¸€ç§åŸºäºTCPçš„å…¨åŒå·¥é€šä¿¡åè®®ï¼Œé€šè¿‡HTTPæ¡æ‰‹å‡çº§å»ºç«‹è¿æ¥ã€‚SignalRé»˜è®¤ä¼˜å…ˆä½¿ç”¨WebSocketä½œä¸ºä¼ è¾“å±‚ï¼Œåœ¨ESP32ä¸Šé€šè¿‡<code>esp_websocket_client</code>ç»„ä»¶å®ç°ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ESP32çš„WebSocketå®¢æˆ·ç«¯ä¸æ”¯æŒè‡ªåŠ¨é‡è¿ï¼Œéœ€è¦åœ¨åº”ç”¨å±‚å®ç°ã€‚</p>\n</li>\n</ul>\n<h3 id=\"è®¤è¯ç›¸å…³\">è®¤è¯ç›¸å…³</h3>\n<ul>\n<li>\n<p><strong>Bearer Token</strong>ï¼šä¸€ç§HTTPè®¤è¯æ–¹æ¡ˆï¼Œå°†Tokenæ”¾åœ¨Authorizationå¤´ä¸­ï¼š<code>Authorization: Bearer &lt;token&gt;</code>ã€‚åœ¨SignalRä¸­ï¼Œé€šå¸¸å°†Tokenä½œä¸ºæŸ¥è¯¢å‚æ•°ä¼ é€’ï¼š<code>/hub?access_token=YOUR_TOKEN</code></p>\n</li>\n<li>\n<p><strong>JWTï¼ˆJSON Web Tokenï¼‰</strong>ï¼šä¸€ç§å¼€æ”¾æ ‡å‡†ï¼ˆRFC 7512ï¼‰ï¼Œç”¨äºåœ¨å„æ–¹ä¹‹é—´å®‰å…¨åœ°ä¼ è¾“ä¿¡æ¯ã€‚åœ¨Verdure MCPä¸­ï¼Œä½¿ç”¨Keycloakç­¾å‘çš„JWTè¿›è¡Œç”¨æˆ·è®¤è¯ï¼ŒTokenä¸­åŒ…å«ç”¨æˆ·IDã€è§’è‰²ã€è¿‡æœŸæ—¶é—´ç­‰Claimä¿¡æ¯ã€‚</p>\n</li>\n<li>\n<p><strong>API Token</strong>ï¼šä¸€ç§ç®€å•çš„è®¤è¯æ–¹å¼ï¼Œåç»­è¿æ¥æ—¶æºå¸¦æ­¤TokenéªŒè¯èº«ä»½ã€‚Verdure MCPåŒæ—¶æ”¯æŒAPI Tokenå’ŒJWTä¸¤ç§æ–¹å¼ã€‚</p>\n</li>\n</ul>\n<p><img alt=\"img\" src=\"https://img2024.cnblogs.com/blog/1690009/202602/1690009-20260201152548041-1540521880.png\" /></p>\n<h2 id=\"æ ¸å¿ƒæŠ€æœ¯æ¶æ„\">æ ¸å¿ƒæŠ€æœ¯æ¶æ„</h2>\n<p>æ•´ä¸ªæ”¹é€ çš„æ¶æ„å¯ä»¥ç”¨ä¸€å¼ å›¾è¯´æ˜ï¼š</p>\n<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚   .NET MCP Service   â”‚                          â”‚   ESP32 Device       â”‚\nâ”‚   (Verdure MCP)      â”‚â—„â”€â”€â”€â”€â”€SignalR Hubâ”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   (å°æ™ºå®¢æˆ·ç«¯)       â”‚\nâ”‚                      â”‚                          â”‚                      â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â‘  JWT Tokenè®¤è¯         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚\nâ”‚  â”‚  DeviceHub.cs  â”‚  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  â”‚  æ‰«ç ç™»å½•      â”‚  â”‚\nâ”‚  â”‚                â”‚  â”‚                          â”‚  â”‚  (æœ¬åœ°MCPå·¥å…·) â”‚  â”‚\nâ”‚  â”‚ OnConnected    â”‚  â”‚                          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚\nâ”‚  â”‚ (éªŒè¯Token)    â”‚  â”‚                          â”‚          â†“           â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â‘¡ å»ºç«‹è¿æ¥               â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚\nâ”‚          â†“           â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  â”‚ SignalR Client â”‚  â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                          â”‚  â”‚ - connection   â”‚  â”‚\nâ”‚  â”‚  ç¾¤ç»„ç®¡ç†      â”‚  â”‚                          â”‚  â”‚ - on() events  â”‚  â”‚\nâ”‚  â”‚ Users:{userId} â”‚  â”‚                          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                          â”‚                      â”‚\nâ”‚          â†“           â”‚                          â”‚                      â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â‘¢ MCPå·¥å…·æ‰§è¡Œåæ¨é€     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚\nâ”‚  â”‚  æ¶ˆæ¯æ¨é€      â”‚  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  â”‚ æ¶ˆæ¯æ¥æ”¶å¤„ç†   â”‚  â”‚\nâ”‚  â”‚ SendAsync()    â”‚  â”‚  ShowImage(imageData)    â”‚  â”‚ - æ˜¾ç¤ºå›¾ç‰‡     â”‚  â”‚\nâ”‚  â”‚                â”‚  â”‚  PlayAudio(audioUrl)     â”‚  â”‚ - æ’­æ”¾è¯­éŸ³     â”‚  â”‚\nâ”‚  â”‚                â”‚  â”‚  Notification(text)      â”‚  â”‚ - æ˜¾ç¤ºé€šçŸ¥     â”‚  â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n</code></pre>\n<p>å…³é”®æµç¨‹ï¼š</p>\n<ol>\n<li><strong>æ‰«ç ç™»å½•</strong>ï¼šè®¾å¤‡å¯åŠ¨åï¼Œå¦‚æœæ²¡æœ‰Tokenï¼Œè°ƒç”¨æœ¬åœ°MCPå·¥å…·æ˜¾ç¤ºäºŒç»´ç ï¼Œç”¨æˆ·æ‰«ç åè·å–JWT Token</li>\n<li><strong>å»ºç«‹è¿æ¥</strong>ï¼šæºå¸¦JWT Tokenè¿æ¥SignalR Hubï¼ŒæœåŠ¡ç«¯éªŒè¯ååŠ å…¥ç”¨æˆ·ç¾¤ç»„<code>Users:{userId}</code></li>\n<li><strong>æ¶ˆæ¯æ¨é€</strong>ï¼šæœåŠ¡ç«¯MCPå·¥å…·æ‰§è¡Œå®Œæˆåï¼Œé€šè¿‡SignalRå°†ç»“æœæ¨é€ç»™è®¾å¤‡\n<ul>\n<li><code>_hubContext.Clients.Group($\"Users:{userId}\").SendAsync(\"ShowImage\", imageData)</code></li>\n<li>è®¾å¤‡ç›‘å¬äº‹ä»¶å¹¶å¤„ç†ï¼š<code>connection-&gt;on(\"ShowImage\", handler)</code></li>\n</ul>\n</li>\n</ol>\n<p>è¿™å¥—æ¶æ„çš„æ ¸å¿ƒä»·å€¼å°±æ˜¯<strong>è®©æœåŠ¡ç«¯å¯ä»¥ä¸»åŠ¨æ¨é€æ¶ˆæ¯ç»™è®¾å¤‡</strong>ï¼Œè€Œä¸ä»…ä»…æ˜¯ç­‰å¾…è®¾å¤‡è½®è¯¢æˆ–åŒæ­¥è¿”å›ã€‚</p>\n<h2 id=\"å¼€å‘ç¯å¢ƒå‡†å¤‡\">å¼€å‘ç¯å¢ƒå‡†å¤‡</h2>\n<h3 id=\"esp32å¼€å‘ç¯å¢ƒvs-codeæ–¹å¼\">ESP32å¼€å‘ç¯å¢ƒï¼ˆVS Codeæ–¹å¼ï¼‰</h3>\n<p>æœ€ç®€å•çš„æ–¹å¼æ˜¯ä½¿ç”¨VS Codeçš„ESP-IDFæ’ä»¶ï¼š</p>\n<ol>\n<li>\n<p><strong>å®‰è£…VS Codeå’Œæ’ä»¶</strong></p>\n<ul>\n<li>ä¸‹è½½å®‰è£… <a href=\"https://code.visualstudio.com/\" rel=\"noopener nofollow\" target=\"_blank\">Visual Studio Code</a></li>\n<li>å®‰è£…æ‰©å±•ï¼š<code>Espressif IDF</code> (æœç´¢ <code>esp-idf</code>)</li>\n</ul>\n</li>\n<li>\n<p><strong>é…ç½®ESP-IDF</strong></p>\n<ul>\n<li>æŒ‰<code>F1</code>æ‰“å¼€å‘½ä»¤é¢æ¿ï¼Œè¾“å…¥ <code>ESP-IDF: Configure ESP-IDF Extension</code></li>\n<li>é€‰æ‹© <code>Express</code> å¿«é€Ÿé…ç½®</li>\n<li>é€‰æ‹©ESP-IDFç‰ˆæœ¬ï¼ˆæ¨èv5.1æˆ–æ›´é«˜ï¼‰</li>\n<li>ç­‰å¾…å®‰è£…å®Œæˆï¼ˆä¼šè‡ªåŠ¨ä¸‹è½½å·¥å…·é“¾ã€Pythonç¯å¢ƒç­‰ï¼‰</li>\n</ul>\n</li>\n<li>\n<p><strong>åˆ›å»º/æ‰“å¼€é¡¹ç›®</strong></p>\n<ul>\n<li><code>F1</code> â†’ <code>ESP-IDF: Show Examples Projects</code></li>\n<li>æˆ–ç›´æ¥æ‰“å¼€ esp-signalr-example é¡¹ç›®æ–‡ä»¶å¤¹</li>\n</ul>\n</li>\n<li>\n<p><strong>ç¼–è¯‘å’Œçƒ§å½•</strong></p>\n<ul>\n<li>ç‚¹å‡»åº•éƒ¨çŠ¶æ€æ çš„ <code>Build</code>ã€<code>Flash</code>ã€<code>Monitor</code> æŒ‰é’®</li>\n<li>æˆ–æŒ‰å¿«æ·é”®ï¼š<code>Ctrl+E B</code>ï¼ˆç¼–è¯‘ï¼‰ã€<code>Ctrl+E F</code>ï¼ˆçƒ§å½•ï¼‰</li>\n</ul>\n</li>\n</ol>\n<p>è¿™ç§æ–¹å¼æ¯”å‘½ä»¤è¡Œç®€å•å¾ˆå¤šï¼Œé€‚åˆ.NETå¼€å‘è€…å¿«é€Ÿä¸Šæ‰‹ESP32å¼€å‘ã€‚</p>\n<p><img alt=\"img\" src=\"https://img2024.cnblogs.com/blog/1690009/202602/1690009-20260201122055040-2075015821.png\" /></p>\n<h3 id=\"netå¼€å‘ç¯å¢ƒ\">.NETå¼€å‘ç¯å¢ƒ</h3>\n<p>æœåŠ¡ç«¯ä½¿ç”¨.NET 10å¼€å‘ï¼š</p>\n<pre><code class=\"language-bash\"># Windows: ä¸‹è½½å®‰è£…å™¨ https://dotnet.microsoft.com/download/dotnet/10.0\n\n# éªŒè¯å®‰è£…\ndotnet --version  # åº”è¯¥è¾“å‡º 10.0.x\n\n</code></pre>\n<h2 id=\"æ ¸å¿ƒä»£ç å®ç°\">æ ¸å¿ƒä»£ç å®ç°</h2>\n<p>æœ¬ç« èŠ‚å°†ä»£ç åˆ†ä¸º<strong>ç¤ºä¾‹ä»£ç </strong>å’Œ<strong>å®é™…æ•´åˆä»£ç </strong>ä¸¤ä¸ªéƒ¨åˆ†è¿›è¡Œè®²è§£ï¼š</p>\n<ul>\n<li><strong>ç¤ºä¾‹ä»£ç </strong>ï¼šç”¨äºç†è§£æ ¸å¿ƒæ¦‚å¿µçš„ç®€åŒ–ç‰ˆæœ¬ï¼Œä¾¿äºå­¦ä¹ å’Œå¿«é€Ÿä¸Šæ‰‹</li>\n<li><strong>å®é™…æ•´åˆä»£ç </strong>ï¼šç”Ÿäº§ç¯å¢ƒä¸­çš„å®Œæ•´å®ç°ï¼ŒåŒ…å«å®Œå–„çš„é”™è¯¯å¤„ç†ã€çŠ¶æ€ç®¡ç†ç­‰</li>\n</ul>\n<h3 id=\"å…³äºç¤ºä¾‹ä»“åº“\">å…³äºç¤ºä¾‹ä»“åº“</h3>\n<p>ä¸ºäº†å¸®åŠ©å¼€å‘è€…å¿«é€Ÿä¸Šæ‰‹ESP32çš„SignalRé›†æˆï¼Œæˆ‘åˆ›å»ºäº†ä¸€ä¸ªå®Œæ•´çš„ç¤ºä¾‹ä»“åº“ï¼š</p>\n<p><strong>ğŸ”— ä»“åº“åœ°å€</strong>ï¼š<a href=\"https://github.com/maker-community/esp-signalr-example\" rel=\"noopener nofollow\" target=\"_blank\">https://github.com/maker-community/esp-signalr-example</a></p>\n<p><strong>ğŸ“¦ ä»“åº“ç»“æ„</strong>ï¼š</p>\n<pre><code>esp-signalr-example/\nâ”œâ”€â”€ main/                    # ESP32 C++å®¢æˆ·ç«¯ä»£ç \nâ”‚   â”œâ”€â”€ main.cpp            # ä¸»ç¨‹åºï¼ˆWiFiè¿æ¥ã€SignalRåˆå§‹åŒ–ï¼‰\nâ”‚   â””â”€â”€ CMakeLists.txt      # ESP-IDFæ„å»ºé…ç½®\nâ”œâ”€â”€ signalr-server/         # .NET C# æœåŠ¡ç«¯ä»£ç \nâ”‚   â”œâ”€â”€ Program.cs          # ASP.NET CoreæœåŠ¡å™¨é…ç½®\nâ”‚   â”œâ”€â”€ ChatHub.cs          # SignalR Hubå®ç°\nâ”‚   â””â”€â”€ signalr-server.csproj\nâ”œâ”€â”€ docs/                   # æ–‡æ¡£\nâ”‚   â”œâ”€â”€ QUICKSTART.md       # 5åˆ†é’Ÿå¿«é€Ÿå¼€å§‹æŒ‡å—\nâ”‚   â”œâ”€â”€ TEST_SERVER_SETUP.md # æµ‹è¯•æœåŠ¡å™¨è¯¦ç»†è®¾ç½®\nâ”‚   â””â”€â”€ TROUBLESHOOTING.md  # å¸¸è§é—®é¢˜æ’æŸ¥\nâ””â”€â”€ README.md               # é¡¹ç›®è¯´æ˜\n</code></pre>\n<p><strong>âœ¨ ä¸»è¦ç‰¹æ€§</strong>ï¼š</p>\n<ol>\n<li>\n<p><strong>å¼€ç®±å³ç”¨çš„æœåŠ¡å™¨</strong>ï¼š</p>\n<ul>\n<li>åŸºäºASP.NET Coreå’ŒSignalRæ„å»º</li>\n<li>æ”¯æŒæ¶ˆæ¯å¹¿æ’­</li>\n<li>å®Œæ•´çš„è¿æ¥ç®¡ç†å’Œæ—¥å¿—è¾“å‡º</li>\n<li>æä¾›RESTful APIç”¨äºè®¾å¤‡æ§åˆ¶</li>\n</ul>\n</li>\n<li>\n<p><strong>ç®€åŒ–çš„ESP32å®¢æˆ·ç«¯</strong>ï¼š</p>\n<ul>\n<li>ä½¿ç”¨Microsoftå®˜æ–¹çš„C++ SignalRå®¢æˆ·ç«¯åº“ç§»æ¤ç‰ˆ</li>\n<li>é€šè¿‡menuconfigé…ç½®WiFiå’ŒæœåŠ¡å™¨åœ°å€</li>\n<li>æ¼”ç¤ºæ¶ˆæ¯å‘é€/æ¥æ”¶ã€ä¼ æ„Ÿå™¨æ•°æ®ä¸ŠæŠ¥</li>\n<li>æ¸…æ™°çš„æ—¥å¿—è¾“å‡ºå’Œé”™è¯¯å¤„ç†</li>\n</ul>\n</li>\n</ol>\n<p><strong>ğŸš€ å¿«é€Ÿå¼€å§‹ç¤ºä¾‹</strong>ï¼ˆ5åˆ†é’Ÿè¿è¡Œï¼‰ï¼š</p>\n<pre><code class=\"language-bash\"># 1. å…‹éš†ä»“åº“\ngit clone https://github.com/maker-community/esp-signalr-example.git\ncd esp-signalr-example\n\n# 2. å¯åŠ¨æœåŠ¡å™¨ï¼ˆéœ€è¦.NET 9.0+ï¼‰\ncd signalr-server\ndotnet run --urls \"http://+:5000\" è¿™ä¸ªè¿è¡Œå¯ä»¥ç”¨ipè®¿é—®\n# æœåŠ¡å™¨è¿è¡Œåœ¨: http://0.0.0.0:5000/chatHub\n\n# 3. é…ç½®å¹¶çƒ§å½•ESP32\ncd ../\nidf.py menuconfig\n# é…ç½®WiFi SSIDã€å¯†ç å’ŒæœåŠ¡å™¨åœ°å€\nidf.py build flash monitor\n</code></pre>\n<p>esp32çš„é…ç½®å¦‚ä¸‹ï¼š</p>\n<p><img alt=\"img\" src=\"https://img2024.cnblogs.com/blog/1690009/202602/1690009-20260201134357961-636085039.png\" /></p>\n<p><strong>ğŸ“Š è¿è¡Œæ•ˆæœ</strong>ï¼š</p>\n<p>æœåŠ¡å™¨è¾“å‡ºï¼š<br />\n<img alt=\"img\" src=\"https://img2024.cnblogs.com/blog/1690009/202602/1690009-20260201135020573-402562452.png\" /></p>\n<pre><code>âœ“ Client connected: abc123\n  IP Address: 192.168.1.100\n  Total Connections: 1\n\n[10:30:25] Received from ESP32-Device: Test message #1 from ESP32\n[10:30:35] Sensor Update - Temperature: 25.50\n</code></pre>\n<p>ESP32ä¸²å£è¾“å‡ºï¼š<br />\n<img alt=\"img\" src=\"https://img2024.cnblogs.com/blog/1690009/202602/1690009-20260201134940520-565577362.png\" /></p>\n<pre><code>I (3520) SIGNALR_EXAMPLE: âœ“âœ“âœ“ Connected to SignalR Hub! âœ“âœ“âœ“\nI (3525) SIGNALR_EXAMPLE: ğŸ”” Notification: Welcome!\nI (14640) S\n</code></pre>\n<p><strong>ğŸ¯ ç¤ºä¾‹ä»“åº“çš„ä»·å€¼</strong>ï¼š</p>\n<ul>\n<li><strong>å­¦ä¹ è·¯å¾„æ¸…æ™°</strong>ï¼šä»ç®€å•çš„è¿æ¥åˆ°å¤æ‚çš„æ•°æ®ä¼ è¾“ï¼Œå¾ªåºæ¸è¿›</li>\n<li><strong>å¯ç›´æ¥è¿è¡Œ</strong>ï¼šä¸éœ€è¦ä¾èµ–å¤–éƒ¨æœåŠ¡ï¼Œæœ¬åœ°å³å¯æµ‹è¯•å®Œæ•´æµç¨‹</li>\n<li><strong>ä»£ç æ³¨é‡Šè¯¦ç»†</strong>ï¼šå…³é”®éƒ¨åˆ†éƒ½æœ‰ä¸­è‹±æ–‡æ³¨é‡Šè¯´æ˜</li>\n<li><strong>æ˜“äºæ‰©å±•</strong>ï¼šåŸºäºè¿™ä¸ªç¤ºä¾‹å¯ä»¥å¿«é€Ÿå¼€å‘è‡ªå·±çš„åº”ç”¨</li>\n</ul>\n<p>æ¥ä¸‹æ¥çš„ 5.1 èŠ‚å°†åŸºäºè¿™ä¸ªç¤ºä¾‹ä»“åº“çš„ä»£ç è¿›è¡Œè®²è§£ã€‚</p>\n<h3 id=\"51-ç¤ºä¾‹ä»£ç æ•™å­¦ç®€åŒ–ç‰ˆ\">5.1 ç¤ºä¾‹ä»£ç ï¼ˆæ•™å­¦ç®€åŒ–ç‰ˆï¼‰</h3>\n<blockquote>\n<p><strong>è¯´æ˜</strong>ï¼šä»¥ä¸‹ä»£ç æ¥è‡ªå¼€æºç¤ºä¾‹ä»“åº“ <a href=\"https://github.com/maker-community/esp-signalr-example\" rel=\"noopener nofollow\" target=\"_blank\">esp-signalr-example</a>ï¼Œç»è¿‡ç²¾ç®€çªå‡ºæ ¸å¿ƒæ¦‚å¿µï¼Œæ–¹ä¾¿ç†è§£SignalRä¸ESP32é›†æˆçš„åŸºæœ¬åŸç†ã€‚å®Œæ•´ä»£ç è¯·å‚è€ƒä»“åº“æºç ã€‚</p>\n</blockquote>\n<h4 id=\"511-æœåŠ¡ç«¯signalr-hubåŸºç¡€å®ç°\">5.1.1 æœåŠ¡ç«¯ï¼šSignalR HubåŸºç¡€å®ç°</h4>\n<p>è¿™æ˜¯æœåŠ¡ç«¯çš„æ ¸å¿ƒä»£ç ï¼Œå®ç°äº†è¿æ¥ç®¡ç†ã€æ¶ˆæ¯å¹¿æ’­å’Œè®¾å¤‡çŠ¶æ€è·Ÿè¸ªï¼š</p>\n<p><strong>ChatHub.cs - Hubæ ¸å¿ƒå®ç°</strong>ï¼š</p>\n<pre><code class=\"language-csharp\">using Microsoft.AspNetCore.SignalR;\n\npublic class ChatHub : Hub\n{\n    private readonly ILogger&lt;ChatHub&gt; _logger;\n    private static int _connectionCount = 0;\n    \n    // å­˜å‚¨è¿æ¥çš„è®¾å¤‡ä¿¡æ¯\n    private static readonly Dictionary&lt;string, DeviceInfo&gt; _connectedDevices = new();\n    private static readonly object _devicesLock = new();\n\n    public ChatHub(ILogger&lt;ChatHub&gt; logger)\n    {\n        _logger = logger;\n    }\n\n    /// &lt;summary&gt;\n    /// å¤„ç†æ¥è‡ªESP32çš„æ¶ˆæ¯\n    /// &lt;/summary&gt;\n    public async Task SendMessage(string user, string message)\n    {\n        _logger.LogInformation(\"[{Time}] Received from {User}: {Message}\", \n            DateTime.Now.ToString(\"HH:mm:ss\"), user, message);\n        \n        // å¹¿æ’­åˆ°æ‰€æœ‰è¿æ¥çš„å®¢æˆ·ç«¯\n        await Clients.All.SendAsync(\"ReceiveMessage\", user, message);\n    }\n\n    /// &lt;summary&gt;\n    /// å¤„ç†ä¼ æ„Ÿå™¨æ•°æ®æ›´æ–°\n    /// &lt;/summary&gt;\n    public async Task UpdateSensor(string sensorId, double value)\n    {\n        _logger.LogInformation(\"[{Time}] Sensor Update - {SensorId}: {Value:F2}\", \n            DateTime.Now.ToString(\"HH:mm:ss\"), sensorId, value);\n        \n        // å¹¿æ’­ä¼ æ„Ÿå™¨æ•°æ®åˆ°æ‰€æœ‰å®¢æˆ·ç«¯\n        await Clients.All.SendAsync(\"UpdateSensorData\", sensorId, value);\n    }\n\n    /// &lt;summary&gt;\n    /// å¤„ç†ESP32çŠ¶æ€æ›´æ–°\n    /// &lt;/summary&gt;\n    public async Task UpdateDeviceStatus(string deviceId, string status, int freeHeap)\n    {\n        _logger.LogInformation(\"[{Time}] Device Status - {DeviceId}: {Status}, Free Heap: {FreeHeap} bytes\", \n            DateTime.Now.ToString(\"HH:mm:ss\"), deviceId, status, freeHeap);\n        \n        await Clients.All.SendAsync(\"DeviceStatusUpdate\", deviceId, status, freeHeap);\n    }\n\n    /// &lt;summary&gt;\n    /// å®¢æˆ·ç«¯è¿æ¥æ—¶è§¦å‘\n    /// &lt;/summary&gt;\n    public override async Task OnConnectedAsync()\n    {\n        Interlocked.Increment(ref _connectionCount);\n        \n        var connectionId = Context.ConnectionId;\n        var httpContext = Context.GetHttpContext();\n        var ipAddress = httpContext?.Connection.RemoteIpAddress?.ToString();\n        var userAgent = httpContext?.Request.Headers[\"User-Agent\"].ToString();\n        \n        // ä¿å­˜è®¾å¤‡ä¿¡æ¯\n        lock (_devicesLock)\n        {\n            _connectedDevices[connectionId] = new DeviceInfo\n            {\n                ConnectionId = connectionId,\n                IpAddress = ipAddress,\n                UserAgent = userAgent,\n                ConnectedAt = DateTime.UtcNow\n            };\n        }\n        \n        _logger.LogInformation(\"âœ“ Client connected: {ConnectionId}\", connectionId);\n        _logger.LogInformation(\"  IP Address: {IpAddress}\", ipAddress);\n        _logger.LogInformation(\"  Total Connections: {Count}\", _connectionCount);\n        \n        await base.OnConnectedAsync();\n        \n        // å‘é€æ¬¢è¿æ¶ˆæ¯ï¼ˆESP32é€šè¿‡æ­¤æ¶ˆæ¯ç¡®è®¤è¿æ¥æˆåŠŸï¼‰\n        await Clients.Caller.SendAsync(\"Notification\", \n            \"Welcome to SignalR Test Server!\");\n    }\n\n    /// &lt;summary&gt;\n    /// å®¢æˆ·ç«¯æ–­å¼€æ—¶è§¦å‘\n    /// &lt;/summary&gt;\n    public override async Task OnDisconnectedAsync(Exception? exception)\n    {\n        Interlocked.Decrement(ref _connectionCount);\n        \n        var connectionId = Context.ConnectionId;\n        \n        // ç§»é™¤è®¾å¤‡ä¿¡æ¯\n        lock (_devicesLock)\n        {\n            _connectedDevices.Remove(connectionId);\n        }\n        \n        _logger.LogInformation(\"âœ— Client disconnected: {ConnectionId}\", connectionId);\n        if (exception != null)\n        {\n            _logger.LogWarning(\"  Disconnection reason: {Message}\", exception.Message);\n        }\n        _logger.LogInformation(\"  Remaining Connections: {Count}\", _connectionCount);\n        \n        await base.OnDisconnectedAsync(exception);\n    }\n}\n\n/// &lt;summary&gt;\n/// è®¾å¤‡è¿æ¥ä¿¡æ¯\n/// &lt;/summary&gt;\npublic class DeviceInfo\n{\n    public string ConnectionId { get; set; } = \"\";\n    public string? IpAddress { get; set; }\n    public string? UserAgent { get; set; }\n    public DateTime ConnectedAt { get; set; }\n}\n</code></pre>\n<p><strong>Program.cs - SignalRæœåŠ¡é…ç½®</strong>ï¼š</p>\n<pre><code class=\"language-csharp\">var builder = WebApplication.CreateBuilder(args);\n\n// æ·»åŠ SignalRæœåŠ¡\nbuilder.Services.AddSignalR(options =&gt;\n{\n    options.EnableDetailedErrors = true;  // å¼€å‘ç¯å¢ƒå¯ç”¨\n    options.ClientTimeoutInterval = TimeSpan.FromSeconds(30);  // å®¢æˆ·ç«¯è¶…æ—¶\n    options.KeepAliveInterval = TimeSpan.FromSeconds(15);  // å¿ƒè·³é—´éš”\n});\n\n// æ·»åŠ CORSæ”¯æŒï¼ˆå…è®¸ESP32è·¨åŸŸè¿æ¥ï¼‰\nbuilder.Services.AddCors(options =&gt;\n{\n    options.AddDefaultPolicy(policy =&gt;\n    {\n        policy.AllowAnyOrigin()\n              .AllowAnyHeader()\n              .AllowAnyMethod();\n    });\n});\n\nvar app = builder.Build();\n\napp.UseCors();\napp.MapHub&lt;ChatHub&gt;(\"/chatHub\");\n\n// ç›‘å¬æ‰€æœ‰ç½‘ç»œæ¥å£ï¼ˆé‡è¦ï¼šå±€åŸŸç½‘å†…ESP32èƒ½è®¿é—®ï¼‰\napp.Urls.Add(\"http://0.0.0.0:5000\");\n\nConsole.WriteLine(\"SignalR Server: http://0.0.0.0:5000/chatHub\");\napp.Run();\n</code></pre>\n<p><strong>å…³é”®ç‚¹è¯´æ˜</strong>ï¼š</p>\n<ol>\n<li><strong>è¿æ¥ç¡®è®¤æœºåˆ¶</strong>ï¼šæœåŠ¡å™¨åœ¨ <code>OnConnectedAsync</code> ä¸­å‘é€ <code>Notification</code> æ¶ˆæ¯ï¼ŒESP32æ”¶åˆ°æ­¤æ¶ˆæ¯æ‰è®¤ä¸ºè¿æ¥æˆåŠŸ</li>\n<li><strong>æ¶ˆæ¯å¹¿æ’­</strong>ï¼šä½¿ç”¨ <code>Clients.All.SendAsync()</code> å‘æ‰€æœ‰è¿æ¥çš„å®¢æˆ·ç«¯å¹¿æ’­æ¶ˆæ¯</li>\n<li><strong>è¿æ¥è·Ÿè¸ª</strong>ï¼šä½¿ç”¨é™æ€å­—å…¸ <code>_connectedDevices</code> è·Ÿè¸ªæ‰€æœ‰è¿æ¥çš„è®¾å¤‡ä¿¡æ¯</li>\n</ol>\n<h4 id=\"512-æœåŠ¡ç«¯è®¾å¤‡æ§åˆ¶apié€šè¿‡signalræ¨é€æ¶ˆæ¯\">5.1.2 æœåŠ¡ç«¯ï¼šè®¾å¤‡æ§åˆ¶APIï¼ˆé€šè¿‡SignalRæ¨é€æ¶ˆæ¯ï¼‰</h4>\n<p>ç¤ºä¾‹ä»“åº“æä¾›äº†å®Œæ•´çš„è®¾å¤‡æ§åˆ¶APIï¼Œæ¼”ç¤ºå¦‚ä½•é€šè¿‡SignalRå‘ESP32æ¨é€å„ç§ç±»å‹çš„æ¶ˆæ¯ï¼š</p>\n<p><strong>Program.cs - è®¾å¤‡æ§åˆ¶APIç«¯ç‚¹</strong>ï¼š</p>\n<pre><code class=\"language-csharp\">// ============================================================================\n// è®¾å¤‡æ§åˆ¶ API - ç”¨äºå‘è®¾å¤‡å‘é€ CustomMessage\n// ============================================================================\n\n// è·å–æ‰€æœ‰è¿æ¥çš„è®¾å¤‡\napp.MapGet(\"/api/device/connections\", () =&gt;\n{\n    return Results.Ok(ChatHub.ConnectedDevices);\n})\n.WithName(\"GetConnections\")\n.WithDescription(\"è·å–æ‰€æœ‰è¿æ¥çš„è®¾å¤‡åˆ—è¡¨\");\n\n// å‘é€é€šçŸ¥\napp.MapPost(\"/api/device/notification\", async (\n    NotificationRequest request, \n    IHubContext&lt;ChatHub&gt; hubContext, \n    ILogger&lt;Program&gt; logger) =&gt;\n{\n    var message = new\n    {\n        action = \"notification\",\n        title = request.Title ?? \"é€šçŸ¥\",\n        content = request.Content ?? \"\",\n        emotion = request.Emotion ?? \"bell\",\n        sound = request.Sound ?? \"popup\"\n    };\n\n    await SendCustomMessage(hubContext, logger, request.ConnectionId, message);\n    return Results.Ok(new { success = true, message = \"Notification sent\" });\n})\n.WithDescription(\"å‘é€é€šçŸ¥åˆ°è®¾å¤‡ (sound: popup/success/vibration/exclamation/low_battery/none)\");\n\n// å‘é€å›¾ç‰‡\napp.MapPost(\"/api/device/image\", async (\n    ImageRequest request, \n    IHubContext&lt;ChatHub&gt; hubContext, \n    ILogger&lt;Program&gt; logger) =&gt;\n{\n    var message = new\n    {\n        action = \"image\",\n        url = request.Url\n    };\n\n    await SendCustomMessage(hubContext, logger, request.ConnectionId, message);\n    return Results.Ok(new { success = true, message = \"Image sent\" });\n})\n.WithDescription(\"å‘é€å›¾ç‰‡URLåˆ°è®¾å¤‡æ˜¾ç¤º (æ”¯æŒJPG/PNG, æœ€å¤§1MB)\");\n\n// å‘é€éŸ³é¢‘\napp.MapPost(\"/api/device/audio\", async (\n    AudioRequest request, \n    IHubContext&lt;ChatHub&gt; hubContext, \n    ILogger&lt;Program&gt; logger) =&gt;\n{\n    var message = new\n    {\n        action = \"audio\",\n        url = request.Url\n    };\n\n    await SendCustomMessage(hubContext, logger, request.ConnectionId, message);\n    return Results.Ok(new { success = true, message = \"Audio sent\" });\n})\n.WithDescription(\"å‘é€éŸ³é¢‘URLåˆ°è®¾å¤‡æ’­æ”¾ (OGGæ ¼å¼, æœ€å¤§512KB)\");\n\n// å‘é€å‘½ä»¤\napp.MapPost(\"/api/device/command\", async (\n    CommandRequest request, \n    IHubContext&lt;ChatHub&gt; hubContext, \n    ILogger&lt;Program&gt; logger) =&gt;\n{\n    var message = new\n    {\n        action = \"command\",\n        command = request.Command\n    };\n\n    await SendCustomMessage(hubContext, logger, request.ConnectionId, message);\n    return Results.Ok(new { success = true, message = \"Command sent\" });\n})\n.WithDescription(\"å‘é€å‘½ä»¤åˆ°è®¾å¤‡ (command: reboot/wake/listen/stop)\");\n\n// æ˜¾ç¤ºäºŒç»´ç \napp.MapPost(\"/api/device/qrcode\", async (\n    QRCodeRequest request, \n    IHubContext&lt;ChatHub&gt; hubContext, \n    ILogger&lt;Program&gt; logger) =&gt;\n{\n    var message = new\n    {\n        action = \"qrcode\",\n        content = request.Content,\n        title = request.Title ?? \"æ‰«ç \"\n    };\n\n    await SendCustomMessage(hubContext, logger, request.ConnectionId, message);\n    return Results.Ok(new { success = true, message = \"QRCode sent\" });\n})\n.WithDescription(\"æ˜¾ç¤ºäºŒç»´ç åˆ°è®¾å¤‡å±å¹•\");\n\n// è¾…åŠ©æ–¹æ³•ï¼šå‘é€ CustomMessage\nasync Task SendCustomMessage(\n    IHubContext&lt;ChatHub&gt; hubContext, \n    ILogger&lt;Program&gt; logger, \n    string? connectionId, \n    object message)\n{\n    var json = JsonSerializer.Serialize(message);\n    logger.LogInformation(\"ğŸ“¤ Sending CustomMessage to {Target}: {Message}\", \n        string.IsNullOrEmpty(connectionId) ? \"ALL\" : connectionId, json);\n\n    if (string.IsNullOrEmpty(connectionId))\n    {\n        // å‘é€ç»™æ‰€æœ‰è¿æ¥çš„è®¾å¤‡\n        await hubContext.Clients.All.SendAsync(\"CustomMessage\", json);\n    }\n    else\n    {\n        // å‘é€ç»™æŒ‡å®šè¿æ¥\n        await hubContext.Clients.Client(connectionId).SendAsync(\"CustomMessage\", json);\n    }\n}\n\n// ============================================================================\n// è¯·æ±‚æ¨¡å‹\n// ============================================================================\n\nrecord NotificationRequest\n{\n    public string? ConnectionId { get; init; }\n    public string? Title { get; init; }\n    public string Content { get; init; } = \"\";\n    public string? Emotion { get; init; }\n    public string? Sound { get; init; }\n}\n\nrecord ImageRequest\n{\n    public string? ConnectionId { get; init; }\n    public string Url { get; init; } = \"\";\n}\n\nrecord AudioRequest\n{\n    public string? ConnectionId { get; init; }\n    public string Url { get; init; } = \"\";\n}\n\nrecord CommandRequest\n{\n    public string? ConnectionId { get; init; }\n    public string Command { get; init; } = \"\";\n}\n\nrecord QRCodeRequest\n{\n    public string? ConnectionId { get; init; }\n    public string Content { get; init; } = \"\";\n    public string? Title { get; init; }\n}\n</code></pre>\n<p><strong>å…³é”®ç‚¹è¯´æ˜</strong>ï¼š</p>\n<ol>\n<li><strong>IHubContextæ³¨å…¥</strong>ï¼šä½¿ç”¨ <code>IHubContext&lt;ChatHub&gt;</code> åœ¨éHubç±»ä¸­å‘é€SignalRæ¶ˆæ¯</li>\n<li><strong>æ¶ˆæ¯æ ¼å¼</strong>ï¼šä½¿ç”¨JSONæ ¼å¼çš„ <code>CustomMessage</code> äº‹ä»¶ï¼ŒåŒ…å« <code>action</code> å­—æ®µæ ‡è¯†æ¶ˆæ¯ç±»å‹</li>\n<li><strong>å®šå‘æ¨é€</strong>ï¼š\n<ul>\n<li><code>Clients.All.SendAsync()</code> - å¹¿æ’­ç»™æ‰€æœ‰è¿æ¥çš„è®¾å¤‡</li>\n<li><code>Clients.Client(connectionId).SendAsync()</code> - å‘é€ç»™æŒ‡å®šè®¾å¤‡</li>\n<li><code>Clients.Group(groupName).SendAsync()</code> - å‘é€ç»™ç¾¤ç»„ï¼ˆå¦‚ <code>Users:{userId}</code>ï¼‰</li>\n</ul>\n</li>\n<li><strong>RESTful APIè®¾è®¡</strong>ï¼šæä¾›HTTPç«¯ç‚¹æ§åˆ¶è®¾å¤‡ï¼Œä¾¿äºå…¶ä»–æœåŠ¡è°ƒç”¨</li>\n</ol>\n<p>æœåŠ¡ç«¯çš„æ¥å£å›¾ç‰‡å¦‚ä¸‹å¯ä»¥ç›´æ¥æ“ä½œæµ‹è¯•ï¼š</p>\n<p><img alt=\"img\" src=\"https://img2024.cnblogs.com/blog/1690009/202602/1690009-20260201134534230-1496642342.png\" /></p>\n<h4 id=\"513-å®¢æˆ·ç«¯esp32è¿æ¥signalrå¹¶æ¥æ”¶æ¶ˆæ¯\">5.1.3 å®¢æˆ·ç«¯ï¼ˆESP32ï¼‰ï¼šè¿æ¥SignalRå¹¶æ¥æ”¶æ¶ˆæ¯</h4>\n<p>è¿™æ˜¯ESP32ç«¯çš„æ ¸å¿ƒä»£ç ï¼Œæ¼”ç¤ºå¦‚ä½•è¿æ¥SignalR Hubå¹¶æ¥æ”¶å„ç§ç±»å‹çš„æ¶ˆæ¯ï¼š</p>\n<p><strong>main.cpp - SignalRè¿æ¥ä¸æ¶ˆæ¯å¤„ç†</strong>ï¼š</p>\n<pre><code class=\"language-cpp\">#include &lt;stdio.h&gt;\n#include &lt;memory&gt;\n#include \"freertos/FreeRTOS.h\"\n#include \"freertos/task.h\"\n#include \"esp_system.h\"\n#include \"esp_log.h\"\n#include \"nvs_flash.h\"\n\n#include \"hub_connection_builder.h\"\n#include \"esp32_websocket_client.h\"\n#include \"esp32_http_client.h\"\n\n// =============================================================================\n// é…ç½®é¡¹ï¼ˆé€šè¿‡menuconfigè®¾ç½®ï¼‰\n// =============================================================================\n\n#define WIFI_SSID      CONFIG_EXAMPLE_WIFI_SSID\n#define WIFI_PASSWORD  CONFIG_EXAMPLE_WIFI_PASSWORD\n#define SIGNALR_HUB_URL CONFIG_EXAMPLE_SIGNALR_HUB_URL\n\nstatic const char* TAG = \"SIGNALR_EXAMPLE\";\n\n// SignalRè¿æ¥å¯¹è±¡\nstatic std::unique_ptr&lt;signalr::hub_connection&gt; g_connection;\nstatic bool g_is_connected = false;\n\n// =============================================================================\n// æ¶ˆæ¯å¤„ç†å™¨\n// =============================================================================\n\n/**\n * å¤„ç†æœåŠ¡å™¨å‘é€çš„æ¶ˆæ¯\n */\nstatic void on_receive_message(const std::vector&lt;signalr::value&gt;&amp; args)\n{\n    ESP_LOGI(TAG, \"==============================================\");\n    ESP_LOGI(TAG, \"ğŸ“© Message received from server:\");\n    \n    if (args.size() &gt;= 2) {\n        std::string user = args[0].as_string();\n        std::string message = args[1].as_string();\n        \n        ESP_LOGI(TAG, \"   From: %s\", user.c_str());\n        ESP_LOGI(TAG, \"   Text: %s\", message.c_str());\n    } else if (args.size() == 1) {\n        ESP_LOGI(TAG, \"   Message: %s\", args[0].as_string().c_str());\n    }\n    \n    ESP_LOGI(TAG, \"==============================================\");\n}\n\n/**\n * å¤„ç†é€šçŸ¥æ¶ˆæ¯ï¼ˆè¿æ¥ç¡®è®¤ï¼‰\n */\nstatic void on_notification(const std::vector&lt;signalr::value&gt;&amp; args)\n{\n    if (args.empty()) return;\n    \n    std::string notification = args[0].as_string();\n    ESP_LOGI(TAG, \"ğŸ”” Notification: %s\", notification.c_str());\n    \n    // é€šè¿‡Notificationæ¶ˆæ¯ç¡®è®¤è¿æ¥æˆåŠŸ\n    if (!g_is_connected) {\n        g_is_connected = true;\n        ESP_LOGI(TAG, \"==============================================\");\n        ESP_LOGI(TAG, \"âœ“âœ“âœ“ Connected to SignalR Hub! âœ“âœ“âœ“\");\n        ESP_LOGI(TAG, \"==============================================\");\n    }\n}\n\n/**\n * å¤„ç†ä¼ æ„Ÿå™¨æ•°æ®æ›´æ–°\n */\nstatic void on_sensor_update(const std::vector&lt;signalr::value&gt;&amp; args)\n{\n    if (args.size() &lt; 2) return;\n    \n    std::string sensor_id = args[0].as_string();\n    double value = args[1].as_double();\n    \n    ESP_LOGI(TAG, \"ğŸ“Š Sensor Update: %s = %.2f\", sensor_id.c_str(), value);\n}\n\n/**\n * å¤„ç†è®¾å¤‡çŠ¶æ€æ›´æ–°\n */\nstatic void on_device_status(const std::vector&lt;signalr::value&gt;&amp; args)\n{\n    if (args.size() &lt; 3) return;\n    \n    std::string device_id = args[0].as_string();\n    std::string status = args[1].as_string();\n    int free_heap = static_cast&lt;int&gt;(args[2].as_double());\n    \n    ESP_LOGI(TAG, \"ğŸ“± Device Status: %s - %s (Free Heap: %d bytes)\", \n             device_id.c_str(), status.c_str(), free_heap);\n}\n\n// =============================================================================\n// SignalRè¿æ¥ç®¡ç†\n// =============================================================================\n\n/**\n * åˆå§‹åŒ–SignalRè¿æ¥\n */\nstatic void init_signalr(void)\n{\n    ESP_LOGI(TAG, \"Initializing SignalR connection to: %s\", SIGNALR_HUB_URL);\n\n    try {\n        // åˆ›å»ºhub_connectionï¼ˆä½¿ç”¨make_uniqueï¼‰\n        g_connection = std::make_unique&lt;signalr::hub_connection&gt;(\n            signalr::hub_connection_builder::create(SIGNALR_HUB_URL)\n                .with_websocket_factory([](const signalr::signalr_client_config&amp; config) {\n                    return std::make_shared&lt;signalr::esp32_websocket_client&gt;(config);\n                })\n                .with_http_client_factory([](const signalr::signalr_client_config&amp; config) {\n                    return std::make_shared&lt;signalr::esp32_http_client&gt;(config);\n                })\n                .with_automatic_reconnect()  // å¯ç”¨è‡ªåŠ¨é‡è¿\n                .skip_negotiation(true)      // è·³è¿‡åå•†ï¼Œç›´æ¥WebSocket\n                .build());\n\n        ESP_LOGI(TAG, \"âœ“ SignalR connection object created\");\n        \n    } catch (const std::exception&amp; e) {\n        ESP_LOGE(TAG, \"Failed to create SignalR connection: %s\", e.what());\n    }\n}\n\n/**\n * æ³¨å†Œæ¶ˆæ¯å¤„ç†å™¨\n */\nstatic void setup_message_handlers(void)\n{\n    if (!g_connection) {\n        ESP_LOGE(TAG, \"Connection not initialized\");\n        return;\n    }\n\n    // æ³¨å†Œ \"ReceiveMessage\" äº‹ä»¶\n    g_connection-&gt;on(\"ReceiveMessage\", on_receive_message);\n    ESP_LOGI(TAG, \"âœ“ Registered handler: ReceiveMessage\");\n\n    // æ³¨å†Œ \"Notification\" äº‹ä»¶ï¼ˆç”¨äºè¿æ¥ç¡®è®¤ï¼‰\n    g_connection-&gt;on(\"Notification\", on_notification);\n    ESP_LOGI(TAG, \"âœ“ Registered handler: Notification\");\n\n    // æ³¨å†Œ \"UpdateSensorData\" äº‹ä»¶\n    g_connection-&gt;on(\"UpdateSensorData\", on_sensor_update);\n    ESP_LOGI(TAG, \"âœ“ Registered handler: UpdateSensorData\");\n\n    // æ³¨å†Œ \"DeviceStatusUpdate\" äº‹ä»¶\n    g_connection-&gt;on(\"DeviceStatusUpdate\", on_device_status);\n    ESP_LOGI(TAG, \"âœ“ Registered handler: DeviceStatusUpdate\");\n}\n\n/**\n * å¯åŠ¨SignalRè¿æ¥\n */\nstatic void start_signalr_connection(void)\n{\n    if (!g_connection) {\n        ESP_LOGE(TAG, \"Connection not initialized\");\n        return;\n    }\n    \n    ESP_LOGI(TAG, \"Starting SignalR connection...\");\n\n    try {\n        // å¯åŠ¨è¿æ¥ï¼ˆå¼‚æ­¥ï¼‰\n        g_connection-&gt;start([](std::exception_ptr exception) {\n            if (exception) {\n                ESP_LOGE(TAG, \"Connection failed in callback\");\n            } else {\n                ESP_LOGI(TAG, \"Connection started successfully\");\n            }\n        });\n        \n        ESP_LOGI(TAG, \"Waiting for Notification message to confirm connection...\");\n\n    } catch (const std::exception&amp; e) {\n        ESP_LOGE(TAG, \"Exception starting connection: %s\", e.what());\n    }\n}\n\n// =============================================================================\n// æµ‹è¯•ä»»åŠ¡ï¼šå®šæœŸå‘é€æ¶ˆæ¯\n// =============================================================================\n\nstatic void signalr_test_task(void* param)\n{\n    int message_count = 1;\n    \n    while (true) {\n        // ç­‰å¾…10ç§’\n        vTaskDelay(pdMS_TO_TICKS(10000));\n        \n        // æ£€æŸ¥è¿æ¥çŠ¶æ€\n        if (!g_connection || !g_is_connected) {\n            ESP_LOGW(TAG, \"Not connected, skipping message send\");\n            continue;\n        }\n        \n        // å‘é€æ¶ˆæ¯åˆ°æœåŠ¡å™¨\n        std::string message = \"Test message #\" + std::to_string(message_count++) + \" from ESP32\";\n        \n        ESP_LOGI(TAG, \"ğŸ“¤ Sending message...\");\n        ESP_LOGI(TAG, \"   User: ESP32-Device\");\n        ESP_LOGI(TAG, \"   Message: %s\", message.c_str());\n        \n        try {\n            std::vector&lt;signalr::value&gt; args;\n            args.push_back(signalr::value(\"ESP32-Device\"));\n            args.push_back(signalr::value(message));\n            \n            // è°ƒç”¨æœåŠ¡å™¨çš„ SendMessage æ–¹æ³•\n            g_connection-&gt;invoke(\"SendMessage\", args, \n                [](const signalr::value&amp; result, std::exception_ptr exception) {\n                    if (exception) {\n                        ESP_LOGE(TAG, \"âœ— Failed to send message\");\n                    } else {\n                        ESP_LOGI(TAG, \"âœ“ Message sent successfully!\");\n                    }\n                });\n                \n        } catch (const std::exception&amp; e) {\n            ESP_LOGE(TAG, \"Exception sending message: %s\", e.what());\n        }\n    }\n}\n\n// =============================================================================\n// ä¸»ç¨‹åº\n// =============================================================================\n\nextern \"C\" void app_main(void)\n{\n    ESP_LOGI(TAG, \"========================================\");\n    ESP_LOGI(TAG, \" ESP32 SignalR Client Test Example\");\n    ESP_LOGI(TAG, \"========================================\");\n    \n    // 1. åˆå§‹åŒ–WiFiï¼ˆçœç•¥WiFiè¿æ¥ä»£ç ï¼Œå‚è€ƒå®Œæ•´ç¤ºä¾‹ï¼‰\n    // wifi_init_sta();\n    \n    // 2. åˆå§‹åŒ–SignalRè¿æ¥å¯¹è±¡\n    ESP_LOGI(TAG, \"Step 1: Initializing SignalR...\");\n    init_signalr();\n    \n    // 3. æ³¨å†Œæ¶ˆæ¯å¤„ç†å™¨\n    ESP_LOGI(TAG, \"Step 2: Setting up message handlers...\");\n    setup_message_handlers();\n    \n    // 4. å¯åŠ¨è¿æ¥\n    ESP_LOGI(TAG, \"Step 3: Starting connection...\");\n    start_signalr_connection();\n    \n    // 5. åˆ›å»ºæµ‹è¯•ä»»åŠ¡ï¼ˆå®šæœŸå‘é€æ¶ˆæ¯ï¼‰\n    ESP_LOGI(TAG, \"Step 4: Creating test task...\");\n    xTaskCreate(signalr_test_task, \"signalr_test\", 8192, NULL, 5, NULL);\n    \n    ESP_LOGI(TAG, \"Setup complete. Check logs for connection status.\");\n}\n</code></pre>\n<p><strong>å…³é”®ç‚¹è¯´æ˜</strong>ï¼š</p>\n<ol>\n<li><strong>è¿æ¥åˆ›å»º</strong>ï¼šä½¿ç”¨ <code>hub_connection_builder</code> æ„å»ºè¿æ¥ï¼Œé…ç½®WebSocketå®¢æˆ·ç«¯å·¥å‚</li>\n<li><strong>è·³è¿‡åå•†</strong>ï¼š<code>skip_negotiation(true)</code> ç›´æ¥ä½¿ç”¨WebSocketï¼Œæé«˜è¿æ¥é€Ÿåº¦</li>\n<li><strong>æ¶ˆæ¯å¤„ç†å™¨æ³¨å†Œ</strong>ï¼šä½¿ç”¨ <code>connection-&gt;on(\"EventName\", handler)</code> æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨</li>\n<li><strong>è¿æ¥ç¡®è®¤</strong>ï¼šé€šè¿‡æ¥æ”¶ <code>Notification</code> æ¶ˆæ¯åˆ¤æ–­è¿æ¥æˆåŠŸï¼ˆæœåŠ¡å™¨åœ¨ <code>OnConnectedAsync</code> ä¸­å‘é€ï¼‰</li>\n<li><strong>è°ƒç”¨æœåŠ¡å™¨æ–¹æ³•</strong>ï¼šä½¿ç”¨ <code>invoke()</code> è°ƒç”¨Hubæ–¹æ³•ï¼Œå¦‚ <code>SendMessage</code></li>\n</ol>\n<p><strong>å®Œæ•´è¿è¡Œæµç¨‹</strong>ï¼š</p>\n<pre><code>1. WiFiè¿æ¥æˆåŠŸ\n   â†“\n2. åˆ›å»ºSignalRè¿æ¥å¯¹è±¡\n   â†“\n3. æ³¨å†Œæ¶ˆæ¯å¤„ç†å™¨ï¼ˆReceiveMessageã€Notificationç­‰ï¼‰\n   â†“\n4. è°ƒç”¨ connection-&gt;start() å¯åŠ¨è¿æ¥\n   â†“\n5. ç­‰å¾…æœåŠ¡å™¨å‘é€ Notification æ¶ˆæ¯\n   â†“\n6. æ”¶åˆ° Notificationï¼Œæ ‡è®°è¿æ¥æˆåŠŸ\n   â†“\n7. å®šæœŸè°ƒç”¨ invoke(\"SendMessage\") å‘é€æ¶ˆæ¯\n   â†“\n8. æ¥æ”¶æœåŠ¡å™¨å¹¿æ’­çš„æ¶ˆæ¯ï¼Œè§¦å‘å¯¹åº”å¤„ç†å™¨\n</code></pre>\n<p><strong>ç¤ºä¾‹è¾“å‡º</strong>ï¼š</p>\n<pre><code>I (3480) SIGNALR_EXAMPLE: âœ“ Registered handler: ReceiveMessage\nI (3485) SIGNALR_EXAMPLE: âœ“ Registered handler: Notification\nI (3490) SIGNALR_EXAMPLE: Starting SignalR connection...\nI (4520) SIGNALR_EXAMPLE: ==============================================\nI (4520) SIGNALR_EXAMPLE: âœ“âœ“âœ“ Connected to SignalR Hub! âœ“âœ“âœ“\nI (4525) SIGNALR_EXAMPLE: ==============================================\nI (4530) SIGNALR_EXAMPLE: ğŸ”” Notification: Welcome to SignalR!\nI (14530) SIGNALR_EXAMPLE: ğŸ“¤ Sending message...\nI (14640) SIGNALR_EXAMPLE: âœ“ Message sent successfully!\nI (14650) SIGNALR_EXAMPLE: ğŸ“© Message received from server:\nI (14655) SIGNALR_EXAMPLE:    From: ESP32-Device\nI (14660) SIGNALR_EXAMPLE:    Text: Test message #1 from ESP32\n</code></pre>\n<h3 id=\"52-å®é™…æ•´åˆä»£ç ç”Ÿäº§ç¯å¢ƒå®Œæ•´å®ç°\">5.2 å®é™…æ•´åˆä»£ç ï¼ˆç”Ÿäº§ç¯å¢ƒå®Œæ•´å®ç°ï¼‰</h3>\n<blockquote>\n<p><strong>è¯´æ˜</strong>ï¼šä»¥ä¸‹ä»£ç æ¥è‡ªå°æ™ºAIé¡¹ç›®çš„å®é™…ç”Ÿäº§ä»£ç ï¼ŒåŒ…å«äº†å®Œæ•´çš„é”™è¯¯å¤„ç†ã€çŠ¶æ€ç®¡ç†ã€JWTè®¤è¯å’Œè‡ªåŠ¨é‡è¿æœºåˆ¶ã€‚</p>\n</blockquote>\n<p>å®é™…é¡¹ç›®ä»£ç åˆ†ä¸ºä¸‰ä¸ªä¸»è¦ä»“åº“ï¼š</p>\n<h4 id=\"521-å°æ™ºesp32è®¾å¤‡ä»£ç \">5.2.1 å°æ™ºESP32è®¾å¤‡ä»£ç </h4>\n<p><strong>ä»“åº“åœ°å€</strong>ï¼š</p>\n<ul>\n<li>ä¸»ä»“åº“ï¼š<a href=\"https://github.com/maker-community/xiaozhi-esp32\" rel=\"noopener nofollow\" target=\"_blank\">https://github.com/maker-community/xiaozhi-esp32</a></li>\n<li>SignalRé›†æˆåˆ†æ”¯ï¼š<code>signalr</code> å’Œ <code>signalr-update-audio</code></li>\n<li>å®Œæ•´ç¤ºä¾‹å·¥ç¨‹ï¼š<a href=\"https://github.com/maker-community/esp-signalr-example\" rel=\"noopener nofollow\" target=\"_blank\">esp-signalr-example</a></li>\n</ul>\n<blockquote>\n<p><strong>æ³¨æ„</strong>ï¼šSignalRåŠŸèƒ½ä¸»è¦åœ¨ <code>signalr</code> å’Œ <code>signalr-update-audio</code> ä¸¤ä¸ªåˆ†æ”¯ä¸­å®ç°ï¼Œè¿™ä¸¤ä¸ªåˆ†æ”¯éƒ½æ˜¯SignalRé›†æˆç›¸å…³çš„å¼€å‘åˆ†æ”¯ã€‚</p>\n</blockquote>\n<p><strong>æ ¸å¿ƒæ–‡ä»¶</strong>ï¼š</p>\n<ul>\n<li><code>main/signalr_client.cc</code> / <code>main/signalr_client.h</code> - <strong>SignalRå®¢æˆ·ç«¯æ ¸å¿ƒå®ç°</strong></li>\n<li><code>main/application.cc</code> / <code>main/application.h</code> - ä¸»åº”ç”¨ç¨‹åºé€»è¾‘å’ŒçŠ¶æ€ç®¡ç†</li>\n<li><code>main/protocols/websocket_protocol.cc</code> - WebSocketåè®®å®ç°</li>\n<li><code>main/protocols/mqtt_protocol.cc</code> - MQTTåè®®å®ç°</li>\n<li><code>main/mcp_server.cc</code> - MCPæœåŠ¡å™¨å®ç°</li>\n</ul>\n<p><strong>å®é™…å®ç°ç‰¹ç‚¹</strong>ï¼š</p>\n<p>ä¸ç¤ºä¾‹ä»£ç ç›¸æ¯”,ç”Ÿäº§ç¯å¢ƒå®ç°å¢åŠ äº†ï¼š</p>\n<ol>\n<li>\n<p><strong>å®Œæ•´çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†</strong></p>\n<ul>\n<li>è¿æ¥å»ºç«‹ã€æ–­å¼€é‡è¿ã€èµ„æºæ¸…ç†</li>\n<li>è®¾å¤‡çŠ¶æ€æœºç®¡ç†ï¼ˆç©ºé—²ã€è¿æ¥ä¸­ã€ç›‘å¬ã€è¯´è¯ç­‰ï¼‰</li>\n</ul>\n</li>\n<li>\n<p><strong>åè®®ç‰ˆæœ¬æ”¯æŒ</strong></p>\n<ul>\n<li>æ”¯æŒWebSocketå’ŒMQTTä¸¤ç§ä¼ è¾“åè®®</li>\n<li>åè®®å±‚æŠ½è±¡,æ˜“äºæ‰©å±•æ–°åè®®</li>\n</ul>\n</li>\n<li>\n<p><strong>éŸ³é¢‘æµå¤„ç†</strong></p>\n<ul>\n<li>å®æ—¶éŸ³é¢‘æ•°æ®çš„ç¼–ç ã€ä¼ è¾“å’Œæ¥æ”¶</li>\n<li><strong>éŸ³é¢‘åˆ†å—ä¼ è¾“</strong>ï¼ˆé‡è¦ï¼ï¼‰- è§£å†³å¤§æ•°æ®ä¼ è¾“å¯¼è‡´è¿æ¥æ–­å¼€çš„é—®é¢˜</li>\n<li>æ”¯æŒOpusç¼–è§£ç </li>\n</ul>\n</li>\n<li>\n<p><strong>MCPå·¥å…·é›†æˆ</strong></p>\n<ul>\n<li>å®Œæ•´çš„MCP Serverå®ç°</li>\n<li>å·¥å…·æ³¨å†Œã€è°ƒç”¨å’Œå“åº”æœºåˆ¶</li>\n<li>æ”¯æŒå¼‚æ­¥å·¥å…·æ‰§è¡Œ</li>\n</ul>\n</li>\n<li>\n<p><strong>SignalRå®¢æˆ·ç«¯å°è£…</strong></p>\n<ul>\n<li>å®Œæ•´çš„è¿æ¥ç”Ÿå‘½å‘¨æœŸç®¡ç†</li>\n<li>JWT Tokenè®¤è¯</li>\n<li>è‡ªåŠ¨é‡è¿æœºåˆ¶ï¼ˆæŒ‡æ•°é€€é¿ï¼‰</li>\n<li>è®¾å¤‡æ³¨å†Œå’Œå¿ƒè·³ä¿æŒ</li>\n<li>è‡ªå®šä¹‰æ¶ˆæ¯å¤„ç†</li>\n</ul>\n</li>\n</ol>\n<h5 id=\"signalrå®¢æˆ·ç«¯æ ¸å¿ƒå®ç°-signalr_clientcc\">SignalRå®¢æˆ·ç«¯æ ¸å¿ƒå®ç° (signalr_client.cc)</h5>\n<p>è¿™æ˜¯æ•´ä¸ªSignalRé›†æˆçš„æ ¸å¿ƒä»£ç ï¼Œå°è£…äº†æ‰€æœ‰ä¸SignalRé€šä¿¡ç›¸å…³çš„é€»è¾‘ã€‚</p>\n<p><strong>å®Œæ•´ä»£ç </strong>ï¼š<a href=\"https://github.com/maker-community/xiaozhi-esp32/blob/signalr-update-audio/main/signalr_client.cc\" rel=\"noopener nofollow\" target=\"_blank\">signalr_client.cc</a> ï¼ˆ850è¡Œï¼‰</p>\n<p><strong>å…³é”®å®ç°è¦ç‚¹</strong>ï¼š</p>\n<p><strong>1. å•ä¾‹æ¨¡å¼ç®¡ç†</strong> - å…¨å±€å”¯ä¸€å®ä¾‹</p>\n<pre><code class=\"language-cpp\">SignalRClient&amp; SignalRClient::GetInstance() {\n    static SignalRClient instance;\n    return instance;\n}\n</code></pre>\n<p><strong>2. JWT Tokenè®¤è¯</strong> - é€šè¿‡Query Stringä¼ é€’</p>\n<pre><code class=\"language-cpp\">bool SignalRClient::Initialize(const std::string&amp; hub_url, const std::string&amp; token) {\n    // ğŸ” Build URL with token as query parameter (ASP.NET Core SignalR standard method)\n    std::string final_hub_url = hub_url;\n    if (!token.empty()) {\n        ESP_LOGI(TAG, \"========== SignalR Token Authentication ==========\");\n        \n        // Remove \"Bearer \" prefix if present\n        std::string token_value = token;\n        if (token_value.find(\"Bearer \") == 0) {\n            token_value = token_value.substr(7);\n        }\n        \n        // Append token to URL\n        final_hub_url += \"?access_token=\" + token_value;\n    }\n    \n    // Create hub connection builder\n    auto builder = signalr::hub_connection_builder::create(final_hub_url);\n    \n    // Set WebSocket factory (ä½¿ç”¨ESP32çš„WebSocketå®ç°)\n    builder.with_websocket_factory([](const signalr::signalr_client_config&amp; config) {\n        auto client = std::make_shared&lt;signalr::esp32_websocket_client&gt;(config);\n        return client;\n    });\n    \n    // Skip negotiation (direct WebSocket connection)\n    builder.skip_negotiation(true);\n    \n    // Build connection\n    connection_ = std::make_unique&lt;signalr::hub_connection&gt;(builder.build());\n}\n</code></pre>\n<p><strong>3. è¶…æ—¶å’Œå¿ƒè·³é…ç½®</strong></p>\n<pre><code class=\"language-cpp\">signalr::signalr_client_config cfg;\ncfg.set_server_timeout(std::chrono::seconds(60));     // server expects 60s idle\ncfg.set_keepalive_interval(std::chrono::seconds(15)); // send ping every 15s\ncfg.set_handshake_timeout(std::chrono::seconds(5));   // short handshake timeout\n\n// IMPORTANT: Disable library's auto-reconnect! It has race condition bugs\ncfg.enable_auto_reconnect(false);\nconnection_-&gt;set_client_config(cfg);\n</code></pre>\n<p><strong>4. è¿æ¥ç¡®è®¤å’Œè‡ªåŠ¨æ³¨å†Œ</strong></p>\n<pre><code class=\"language-cpp\">// Register Notification handler to confirm connection\nconnection_-&gt;on(\"Notification\", [this](const std::vector&lt;signalr::value&gt;&amp; args) {\n    if (args.empty()) return;\n    \n    std::string message = args[0].as_string();\n    ESP_LOGI(TAG, \"ğŸ”” Notification from server: %s\", message.c_str());\n    \n    if (!connection_confirmed_) {\n        connection_confirmed_ = true;\n        ESP_LOGI(TAG, \"âœ“âœ“âœ“ SIGNALR CONNECTION CONFIRMED BY SERVER! âœ“âœ“âœ“\");\n        \n        // ğŸ”„ Auto-register device info after connection confirmed\n        std::string mac_address = DeviceInfo::GetMacAddress();\n        std::string metadata = DeviceInfo::BuildMetadataJson();\n        \n        RegisterDevice(mac_address, \"\", metadata, [](bool success, const std::string&amp; result) {\n            if (success) {\n                ESP_LOGI(TAG, \"âœ… Device auto-registration successful\");\n            }\n        });\n    }\n});\n</code></pre>\n<p><strong>5. è‡ªå®šä¹‰æ¶ˆæ¯å¤„ç†</strong></p>\n<pre><code class=\"language-cpp\">connection_-&gt;on(\"CustomMessage\", [this](const std::vector&lt;signalr::value&gt;&amp; args) {\n    if (args.empty()) return;\n    \n    try {\n        std::string json_str = args[0].as_string();\n        ESP_LOGI(TAG, \"ğŸ“¨ Received CustomMessage: %s\", json_str.c_str());\n        \n        auto root = cJSON_Parse(json_str.c_str());\n        if (root) {\n            if (on_custom_message_) {\n                on_custom_message_(root);  // è°ƒç”¨ç”¨æˆ·è®¾ç½®çš„å›è°ƒ\n            }\n            cJSON_Delete(root);\n        }\n    } catch (const std::exception&amp; e) {\n        ESP_LOGE(TAG, \"Exception handling CustomMessage: %s\", e.what());\n    }\n});\n</code></pre>\n<p><strong>6. è‡ªåŠ¨é‡è¿æœºåˆ¶</strong> - ä½¿ç”¨PSRAMæ ˆçš„åå°ä»»åŠ¡</p>\n<pre><code class=\"language-cpp\">void SignalRClient::StartReconnectTask() {\n    ESP_LOGI(TAG, \"Starting SignalR reconnect background task (PSRAM stack)...\");\n    reconnect_task_running_.store(true, std::memory_order_release);\n    \n    // Allocate task stack from PSRAM (reusable)\n    reconnect_task_stack_ = (StackType_t*)heap_caps_malloc(\n        RECONNECT_TASK_STACK_SIZE, MALLOC_CAP_SPIRAM);\n    \n    // Create task with static allocation (stack in PSRAM)\n    reconnect_task_handle_ = xTaskCreateStatic(\n        ReconnectTaskEntry, \"signalr_reconn\",\n        RECONNECT_TASK_STACK_SIZE / sizeof(StackType_t),\n        this, 2, reconnect_task_stack_, reconnect_task_buffer_\n    );\n}\n\nvoid SignalRClient::ReconnectTaskLoop() {\n    while (reconnect_task_running_.load(std::memory_order_acquire)) {\n        vTaskDelay(pdMS_TO_TICKS(1000));\n        \n        if (!reconnect_requested_.load() || IsConnected()) {\n            continue;\n        }\n        \n        // Apply exponential backoff\n        ESP_LOGI(TAG, \"Attempting connection (backoff=%dms)...\", reconnect_backoff_ms_);\n        \n        if (Connect() &amp;&amp; IsConnected()) {\n            reconnect_backoff_ms_ = 1000;  // Reset backoff on success\n        } else {\n            vTaskDelay(pdMS_TO_TICKS(reconnect_backoff_ms_));\n            reconnect_backoff_ms_ = std::min(reconnect_backoff_ms_ * 2, \n                MAX_RECONNECT_BACKOFF_MS);  // Exponential backoff\n        }\n    }\n}\n</code></pre>\n<p><strong>7. è®¾å¤‡æ³¨å†Œå’Œå¿ƒè·³</strong></p>\n<pre><code class=\"language-cpp\">void SignalRClient::RegisterDevice(\n    const std::string&amp; mac_address,\n    const std::string&amp; device_token,\n    const std::string&amp; metadata,\n    std::function&lt;void(bool, const std::string&amp;)&gt; callback) {\n    \n    if (!IsConnected()) {\n        if (callback) callback(false, \"Not connected\");\n        return;\n    }\n    \n    std::vector&lt;signalr::value&gt; args;\n    args.push_back(signalr::value(mac_address));\n    args.push_back(signalr::value(device_token));\n    args.push_back(signalr::value(metadata));\n    \n    connection_-&gt;invoke(\"RegisterDevice\", args,\n        [callback](const signalr::value&amp; result, std::exception_ptr ex) {\n            if (ex) {\n                if (callback) callback(false, \"Registration failed\");\n            } else {\n                if (callback) callback(true, \"Registration sent\");\n            }\n        });\n}\n\nvoid SignalRClient::SendHeartbeat(\n    std::function&lt;void(bool, const std::string&amp;)&gt; callback) {\n    \n    if (!IsConnected()) {\n        if (callback) callback(false, \"Not connected\");\n        return;\n    }\n    \n    std::vector&lt;signalr::value&gt; args;\n    connection_-&gt;invoke(\"Heartbeat\", args,\n        [callback](const signalr::value&amp; result, std::exception_ptr ex) {\n            if (!ex) {\n                ESP_LOGD(TAG, \"ğŸ’“ Heartbeat sent\");\n                if (callback) callback(true, \"Success\");\n            }\n        });\n}\n</code></pre>\n<p><strong>SignalRå®¢æˆ·ç«¯ç±»å®šä¹‰</strong> (signalr_client.h):</p>\n<pre><code class=\"language-cpp\">class SignalRClient {\npublic:\n    static SignalRClient&amp; GetInstance();\n    \n    // è¿æ¥ç®¡ç†\n    bool Initialize(const std::string&amp; hub_url, const std::string&amp; token);\n    bool Connect();\n    void Disconnect();\n    void Reset();\n    void RequestReconnect();\n    \n    // çŠ¶æ€æŸ¥è¯¢\n    bool IsInitialized() const;\n    bool IsConnecting() const;\n    bool IsConnected() const;\n    std::string GetConnectionState() const;\n    \n    // å›è°ƒè®¾ç½®\n    void OnCustomMessage(std::function&lt;void(const cJSON*)&gt; callback);\n    void OnDeviceRegistered(std::function&lt;void(const cJSON*)&gt; callback);\n    \n    // Hubæ–¹æ³•è°ƒç”¨\n    void RegisterDevice(const std::string&amp; mac_address,\n                       const std::string&amp; device_token,\n                       const std::string&amp; metadata,\n                       std::function&lt;void(bool, const std::string&amp;)&gt; callback);\n    void SendHeartbeat(std::function&lt;void(bool, const std::string&amp;)&gt; callback);\n    void InvokeHubMethod(const std::string&amp; method_name,\n                        const std::string&amp; args_json,\n                        std::function&lt;void(bool, const std::string&amp;)&gt; callback);\n\nprivate:\n    SignalRClient();\n    ~SignalRClient();\n    \n    std::unique_ptr&lt;signalr::hub_connection&gt; connection_;\n    std::string hub_url_;\n    std::string token_;\n    bool initialized_ = false;\n    bool connection_confirmed_ = false;\n    std::atomic&lt;bool&gt; reconnect_requested_{false};\n    \n    // å›è°ƒå‡½æ•°\n    std::function&lt;void(const cJSON*)&gt; on_custom_message_;\n    std::function&lt;void(const cJSON*)&gt; on_device_registered_;\n    \n    // é‡è¿ä»»åŠ¡\n    TaskHandle_t reconnect_task_handle_ = nullptr;\n    int reconnect_backoff_ms_ = 1000;\n};\n</code></pre>\n<p><strong>ä½¿ç”¨ç¤ºä¾‹</strong>ï¼š</p>\n<pre><code class=\"language-cpp\">// åœ¨ä¸»åº”ç”¨ä¸­ä½¿ç”¨SignalRå®¢æˆ·ç«¯\nvoid Application::InitializeSignalR() {\n    auto&amp; client = SignalRClient::GetInstance();\n    \n    // è®¾ç½®æ¶ˆæ¯å›è°ƒ\n    client.OnCustomMessage([this](const cJSON* json) {\n        ESP_LOGI(TAG, \"Received message from server\");\n        HandleServerMessage(json);\n    });\n    \n    // åˆå§‹åŒ–å¹¶è¿æ¥\n    std::string hub_url = \"wss://your-server.com/devicehub\";\n    std::string token = GetJwtToken();  // ä»NVSè¯»å–æˆ–æ‰«ç è·å–\n    \n    if (client.Initialize(hub_url, token)) {\n        if (client.Connect()) {\n            client.RequestReconnect();  // å¯åŠ¨è‡ªåŠ¨é‡è¿ä»»åŠ¡\n        }\n    }\n}\n</code></pre>\n<h5 id=\"applicationå±‚é›†æˆä»£ç \">Applicationå±‚é›†æˆä»£ç </h5>\n<p><strong>æ ¸å¿ƒä»£ç ç‰‡æ®µ</strong> (application.cc):</p>\n<pre><code class=\"language-cpp\">\nvoid Application::HandleSignalRMessage(const std::string&amp; message) {\n    ESP_LOGI(TAG, \"Handling SignalR message: %s\", message.c_str());\n    \n    auto root = cJSON_Parse(message.c_str());\n    if (!root) {\n        ESP_LOGE(TAG, \"Failed to parse SignalR message JSON\");\n        return;\n    }\n    \n    auto display = Board::GetInstance().GetDisplay();\n    \n    // Check message action/type\n    auto action = cJSON_GetObjectItem(root, \"action\");\n    if (cJSON_IsString(action)) {\n        if (strcmp(action-&gt;valuestring, \"notification\") == 0) {\n            // Handle notification\n            // JSON: {\"action\":\"notification\", \"title\":\"æ ‡é¢˜\", \"content\":\"å†…å®¹\", \"emotion\":\"bell\", \"sound\":\"popup\"}\n            auto title = cJSON_GetObjectItem(root, \"title\");\n            auto content = cJSON_GetObjectItem(root, \"content\");\n            auto emotion = cJSON_GetObjectItem(root, \"emotion\");\n            auto sound = cJSON_GetObjectItem(root, \"sound\");\n            \n            const char* title_str = cJSON_IsString(title) ? title-&gt;valuestring : Lang::Strings::INFO;\n            const char* content_str = cJSON_IsString(content) ? content-&gt;valuestring : \"\";\n            const char* emotion_str = cJSON_IsString(emotion) ? emotion-&gt;valuestring : \"bell\";\n            \n            // Select sound based on \"sound\" field\n            std::string_view sound_view = Lang::Sounds::OGG_POPUP;\n            if (cJSON_IsString(sound)) {\n                if (strcmp(sound-&gt;valuestring, \"success\") == 0) {\n                    sound_view = Lang::Sounds::OGG_SUCCESS;\n                } else if (strcmp(sound-&gt;valuestring, \"vibration\") == 0) {\n                    sound_view = Lang::Sounds::OGG_VIBRATION;\n                } else if (strcmp(sound-&gt;valuestring, \"exclamation\") == 0) {\n                    sound_view = Lang::Sounds::OGG_EXCLAMATION;\n                } else if (strcmp(sound-&gt;valuestring, \"low_battery\") == 0) {\n                    sound_view = Lang::Sounds::OGG_LOW_BATTERY;\n                } else if (strcmp(sound-&gt;valuestring, \"none\") == 0) {\n                    sound_view = \"\";\n                }\n                // default: popup\n            }\n            \n            Alert(title_str, content_str, emotion_str, sound_view);\n            \n        } else if (strcmp(action-&gt;valuestring, \"command\") == 0) {\n            // Handle command\n            // JSON: {\"action\":\"command\", \"command\":\"reboot|wake|listen|stop\"}\n            auto cmd = cJSON_GetObjectItem(root, \"command\");\n            if (cJSON_IsString(cmd)) {\n                if (strcmp(cmd-&gt;valuestring, \"reboot\") == 0) {\n                    Reboot();\n                } else if (strcmp(cmd-&gt;valuestring, \"wake\") == 0) {\n                    // Trigger wake word detection\n                    xEventGroupSetBits(event_group_, MAIN_EVENT_WAKE_WORD_DETECTED);\n                } else if (strcmp(cmd-&gt;valuestring, \"listen\") == 0) {\n                    StartListening();\n                } else if (strcmp(cmd-&gt;valuestring, \"stop\") == 0) {\n                    StopListening();\n                } else {\n                    ESP_LOGW(TAG, \"Unknown SignalR command: %s\", cmd-&gt;valuestring);\n                }\n            }\n            \n        } else if (strcmp(action-&gt;valuestring, \"display\") == 0) {\n            // Display custom content\n            // JSON: {\"action\":\"display\", \"content\":\"æ–‡æœ¬å†…å®¹\", \"role\":\"system\"}\n            auto content = cJSON_GetObjectItem(root, \"content\");\n            auto role = cJSON_GetObjectItem(root, \"role\");\n            const char* role_str = cJSON_IsString(role) ? role-&gt;valuestring : \"system\";\n            if (cJSON_IsString(content)) {\n                display-&gt;SetChatMessage(role_str, content-&gt;valuestring);\n            }\n            \n        } else if (strcmp(action-&gt;valuestring, \"emotion\") == 0) {\n            // Change emotion/expression\n            // JSON: {\"action\":\"emotion\", \"emotion\":\"happy\"}\n            auto emotion = cJSON_GetObjectItem(root, \"emotion\");\n            if (cJSON_IsString(emotion)) {\n                display-&gt;SetEmotion(emotion-&gt;valuestring);\n            }\n            \n        } else if (strcmp(action-&gt;valuestring, \"image\") == 0) {\n            // Display image from URL\n            // JSON: {\"action\":\"image\", \"url\":\"https://example.com/image.jpg\"}\n            auto url = cJSON_GetObjectItem(root, \"url\");\n            if (cJSON_IsString(url)) {\n                HandleSignalRImageMessage(url-&gt;valuestring);\n            } else {\n                ESP_LOGW(TAG, \"Image action requires 'url' field\");\n            }\n            \n        } else if (strcmp(action-&gt;valuestring, \"audio\") == 0) {\n            // Play audio from URL (OGG format)\n            // JSON: {\"action\":\"audio\", \"url\":\"https://example.com/sound.ogg\"}\n            auto url = cJSON_GetObjectItem(root, \"url\");\n            if (cJSON_IsString(url)) {\n                HandleSignalRAudioMessage(url-&gt;valuestring);\n            } else {\n                ESP_LOGW(TAG, \"Audio action requires 'url' field\");\n            }\n            \n        } else if (strcmp(action-&gt;valuestring, \"qrcode\") == 0) {\n            // Show QR code\n            // JSON: {\"action\":\"qrcode\", \"data\":\"https://...\", \"title\":\"æ ‡é¢˜\", \"subtitle\":\"å‰¯æ ‡é¢˜\"}\n            auto data = cJSON_GetObjectItem(root, \"data\");\n            auto title = cJSON_GetObjectItem(root, \"title\");\n            auto subtitle = cJSON_GetObjectItem(root, \"subtitle\");\n            if (cJSON_IsString(data)) {\n                const char* title_str = cJSON_IsString(title) ? title-&gt;valuestring : nullptr;\n                const char* subtitle_str = cJSON_IsString(subtitle) ? subtitle-&gt;valuestring : nullptr;\n                display-&gt;ShowQRCode(data-&gt;valuestring, title_str, subtitle_str);\n            } else {\n                ESP_LOGW(TAG, \"QRCode action requires 'data' field\");\n            }\n            \n        } else if (strcmp(action-&gt;valuestring, \"hide_qrcode\") == 0) {\n            // Hide QR code\n            // JSON: {\"action\":\"hide_qrcode\"}\n            display-&gt;HideQRCode();\n            \n        } else {\n            // Default: display as system message\n            char* display_str = cJSON_Print(root);\n            if (display_str) {\n                display-&gt;SetChatMessage(\"system\", display_str);\n                cJSON_free(display_str);\n            }\n        }\n    } else {\n        // No action specified, display raw message\n        char* display_str = cJSON_Print(root);\n        if (display_str) {\n            display-&gt;SetChatMessage(\"system\", display_str);\n            cJSON_free(display_str);\n        }\n    }\n    \n    cJSON_Delete(root);\n}\n\n</code></pre>\n<p><strong>å®Œæ•´çš„Applicationç±»åŠŸèƒ½</strong>ï¼š</p>\n<ul>\n<li>âœ… è®¾å¤‡çŠ¶æ€ç®¡ç† (çŠ¶æ€æœº)</li>\n<li>âœ… ç½‘ç»œäº‹ä»¶å¤„ç† (è¿æ¥/æ–­å¼€)</li>\n<li>âœ… éŸ³é¢‘æœåŠ¡é›†æˆ (ç¼–è§£ç ã€æµå¤„ç†)</li>\n<li>âœ… å”¤é†’è¯æ£€æµ‹</li>\n<li>âœ… åè®®å±‚æŠ½è±¡ (WebSocket/MQTT)</li>\n<li>âœ… MCPæ¶ˆæ¯è·¯ç”±</li>\n<li>âœ… é”™è¯¯å¤„ç†å’Œæ¢å¤</li>\n<li>âœ… èµ„æºç®¡ç†å’Œæ¸…ç†</li>\n<li>âœ… çº¿ç¨‹å®‰å…¨çš„æ¶ˆæ¯è°ƒåº¦</li>\n</ul>\n<h4 id=\"522-mcpæœåŠ¡å™¨ä»£ç -verdure-mcp\">5.2.2 MCPæœåŠ¡å™¨ä»£ç  (verdure-mcp)</h4>\n<p><strong>ä»“åº“åœ°å€</strong>ï¼š<a href=\"https://github.com/maker-community/verdure-mcp\" rel=\"noopener nofollow\" target=\"_blank\">verdure-mcp</a></p>\n<p><strong>ç›®å½•ç»“æ„</strong>ï¼š</p>\n<pre><code>src/Verdure.Mcp.Server/\nâ”œâ”€â”€ Hubs/\nâ”‚   â””â”€â”€ DeviceHub.cs          # SignalR Hubå®ç°\nâ”œâ”€â”€ Tools/\nâ”‚   â”œâ”€â”€ MusicTool.cs          # éŸ³ä¹æ’­æ”¾æ§åˆ¶\nâ”‚   â”œâ”€â”€ EmailTool.cs          # é‚®ä»¶å‘é€\nâ”‚   â”œâ”€â”€ WeatherTool.cs        # å¤©æ°”æŸ¥è¯¢\nâ”‚   â””â”€â”€ SmartHomeTool.cs      # æ™ºèƒ½å®¶å±…æ§åˆ¶\nâ”œâ”€â”€ Services/\nâ”‚   â”œâ”€â”€ DeviceService.cs      # è®¾å¤‡ç®¡ç†æœåŠ¡\nâ”‚   â”œâ”€â”€ McpExecutor.cs        # MCPå·¥å…·æ‰§è¡Œå™¨\nâ”‚   â””â”€â”€ TokenService.cs       # JWTä»¤ç‰ŒæœåŠ¡\nâ””â”€â”€ Models/\n    â”œâ”€â”€ DeviceConnection.cs   # è®¾å¤‡è¿æ¥è®°å½•\n    â”œâ”€â”€ DeviceInfo.cs         # è®¾å¤‡ä¿¡æ¯\n    â””â”€â”€ McpToolLog.cs         # å·¥å…·è°ƒç”¨æ—¥å¿—\n</code></pre>\n<p><strong>DeviceHubå®Œæ•´å®ç°</strong> (Hubs/DeviceHub.cs):</p>\n<p>ç”Ÿäº§ç¯å¢ƒçš„DeviceHubå®é™…å®ç°ç‰¹ç‚¹ï¼š</p>\n<ul>\n<li>âœ… æ•°æ®åº“æŒä¹…åŒ– (Entity Framework Core + PostgreSQL)</li>\n<li>âœ… è®¾å¤‡æ³¨å†Œå’ŒçŠ¶æ€è·Ÿè¸ª</li>\n<li>âœ… ç”¨æˆ·å’Œè®¾å¤‡åˆ†ç»„ç®¡ç†</li>\n<li>âœ… å¿ƒè·³æ£€æµ‹</li>\n<li>âœ… åŒé‡è®¤è¯ (JWT + API Token)</li>\n<li>âœ… å®Œå–„çš„å¼‚å¸¸å¤„ç†å’Œæ—¥å¿—</li>\n</ul>\n<pre><code class=\"language-csharp\">using Microsoft.AspNetCore.SignalR;\nusing Verdure.Mcp.Infrastructure.Database;\nusing Verdure.Mcp.Infrastructure.Services;\n\nnamespace Verdure.Mcp.Server.Hubs;\n\n/// &lt;summary&gt;\n/// è®¾å¤‡è¿æ¥Hub - å¤„ç†ESP32ç­‰IoTè®¾å¤‡çš„SignalRè¿æ¥\n/// &lt;/summary&gt;\npublic class DeviceHub : Hub\n{\n    private readonly McpDbContext _dbContext;\n    private readonly ITokenValidationService _tokenValidationService;\n    private readonly ILogger&lt;DeviceHub&gt; _logger;\n\n    public DeviceHub(\n        McpDbContext dbContext,\n        ITokenValidationService tokenValidationService,\n        ILogger&lt;DeviceHub&gt; logger)\n    {\n        _dbContext = dbContext;\n        _tokenValidationService = tokenValidationService;\n        _logger = logger;\n    }\n\n    /// &lt;summary&gt;\n    /// è®¾å¤‡è¿æ¥ - æ”¯æŒJWTå’ŒAPI TokenåŒé‡è®¤è¯\n    /// &lt;/summary&gt;\n    public override async Task OnConnectedAsync()\n    {\n        try\n        {\n            var httpContext = Context.GetHttpContext();\n            if (httpContext == null)\n            {\n                _logger.LogWarning(\"HttpContext is null\");\n                Context.Abort();\n                return;\n            }\n\n            // ä»æŸ¥è¯¢å‚æ•°è·å–token\n            var token = httpContext.Request.Query[\"access_token\"].ToString();\n            if (string.IsNullOrEmpty(token))\n            {\n                _logger.LogWarning(\"Connection attempt without token\");\n                Context.Abort();\n                return;\n            }\n\n            // éªŒè¯token - æ”¯æŒJWTå’ŒAPI Token\n            var validationResult = await _tokenValidationService.ValidateTokenAsync(token);\n            if (!validationResult.IsValid)\n            {\n                _logger.LogWarning(\"Invalid token: {Reason}\", validationResult.FailureReason);\n                Context.Abort();\n                return;\n            }\n\n            var userId = validationResult.UserId;\n            if (string.IsNullOrEmpty(userId))\n            {\n                _logger.LogWarning(\"Token valid but userId is missing\");\n                Context.Abort();\n                return;\n            }\n\n            // å°†è¿æ¥åŠ å…¥ç”¨æˆ·ç»„ (æ ¼å¼: Users:{userId})\n            await Groups.AddToGroupAsync(Context.ConnectionId, $\"Users:{userId}\");\n\n            _logger.LogInformation(\n                \"Device connected: ConnectionId={ConnectionId}, UserId={UserId}\",\n                Context.ConnectionId, userId);\n\n            // å‘é€æ¬¢è¿é€šçŸ¥\n            await Clients.Caller.SendAsync(\"Notification\", \n                $\"Welcome! Connected to Verdure MCP Server at {DateTime.UtcNow:yyyy-MM-dd HH:mm:ss}\");\n\n            await base.OnConnectedAsync();\n        }\n        catch (Exception ex)\n        {\n            _logger.LogError(ex, \"Error in OnConnectedAsync\");\n            Context.Abort();\n        }\n    }\n\n    /// &lt;summary&gt;\n    /// è®¾å¤‡æ–­å¼€è¿æ¥\n    /// &lt;/summary&gt;\n    public override async Task OnDisconnectedAsync(Exception? exception)\n    {\n        if (exception != null)\n        {\n            _logger.LogWarning(exception, \n                \"Device disconnected with error: ConnectionId={ConnectionId}\",\n                Context.ConnectionId);\n        }\n        else\n        {\n            _logger.LogInformation(\n                \"Device disconnected normally: ConnectionId={ConnectionId}\",\n                Context.ConnectionId);\n        }\n\n        await base.OnDisconnectedAsync(exception);\n    }\n\n    /// &lt;summary&gt;\n    /// è®¾å¤‡æ³¨å†Œ - ä¿å­˜è®¾å¤‡MACåœ°å€å’Œå…ƒæ•°æ®\n    /// &lt;/summary&gt;\n    public async Task RegisterDevice(string macAddress, string deviceToken, string metadata)\n    {\n        try\n        {\n            var userId = Context.Items[\"UserId\"]?.ToString();\n            if (string.IsNullOrEmpty(userId))\n            {\n                _logger.LogWarning(\"RegisterDevice called without userId\");\n                return;\n            }\n\n            _logger.LogInformation(\n                \"Device registration: UserId={UserId}, MAC={MacAddress}, Metadata={Metadata}\",\n                userId, macAddress, metadata);\n\n            // å°†è®¾å¤‡åŠ å…¥è®¾å¤‡ç»„ (æ ¼å¼: Device:{macAddress})\n            await Groups.AddToGroupAsync(Context.ConnectionId, $\"Device:{macAddress}\");\n\n            // ä¿å­˜è®¾å¤‡ä¿¡æ¯åˆ°æ•°æ®åº“\n            var existingDevice = await _dbContext.Devices\n                .FirstOrDefaultAsync(d =&gt; d.MacAddress == macAddress);\n\n            if (existingDevice != null)\n            {\n                existingDevice.LastSeenAt = DateTime.UtcNow;\n                existingDevice.Metadata = metadata;\n                existingDevice.IsOnline = true;\n            }\n            else\n            {\n                _dbContext.Devices.Add(new Device\n                {\n                    MacAddress = macAddress,\n                    UserId = userId,\n                    Metadata = metadata,\n                    IsOnline = true,\n                    CreatedAt = DateTime.UtcNow,\n                    LastSeenAt = DateTime.UtcNow\n                });\n            }\n\n            await _dbContext.SaveChangesAsync();\n\n            // ç¡®è®¤æ³¨å†ŒæˆåŠŸ\n            await Clients.Caller.SendAsync(\"Notification\", \n                $\"Device registered successfully: {macAddress}\");\n        }\n        catch (Exception ex)\n        {\n            _logger.LogError(ex, \"Error in RegisterDevice\");\n        }\n    }\n\n    /// &lt;summary&gt;\n    /// å¿ƒè·³ä¿æŒ\n    /// &lt;/summary&gt;\n    public async Task Heartbeat()\n    {\n        _logger.LogDebug(\"Heartbeat from ConnectionId={ConnectionId}\", Context.ConnectionId);\n        \n        // æ›´æ–°æœ€åæ´»è·ƒæ—¶é—´\n        // æ³¨æ„ï¼šå®é™…ä»£ç ä¸­å¯ä»¥æ ¹æ®ConnectionIdæŸ¥æ‰¾è®¾å¤‡å¹¶æ›´æ–°LastSeenAt\n        await Task.CompletedTask;\n    }\n}\n</code></pre>\n<p><strong>å®é™…çš„MCPå·¥å…·å®ç°</strong> (ä¸ä½¿ç”¨åŸºç±»):</p>\n<p>åœ¨verdure-mcpä¸­ï¼ŒMCPå·¥å…·<strong>ä¸ç»§æ‰¿ä»»ä½•åŸºç±»</strong>ï¼Œè€Œæ˜¯ï¼š</p>\n<ol>\n<li>ä½¿ç”¨ <code>[McpServerToolType]</code> ç‰¹æ€§æ ‡è®°</li>\n<li>é€šè¿‡ä¾èµ–æ³¨å…¥è·å– <code>IDevicePushService</code> æœåŠ¡</li>\n<li>ä½¿ç”¨ <code>IDevicePushService</code> çš„æ–¹æ³•æ¨é€æ¶ˆæ¯ç»™è®¾å¤‡</li>\n</ol>\n<p><strong>DevicePushServiceæ¥å£</strong> (Infrastructure/Services/DevicePushService.cs):</p>\n<pre><code class=\"language-csharp\">namespace Verdure.Mcp.Infrastructure.Services;\n\n/// &lt;summary&gt;\n/// è®¾å¤‡æ¨é€æœåŠ¡æ¥å£\n/// &lt;/summary&gt;\npublic interface IDevicePushService\n{\n    /// &lt;summary&gt;\n    /// å‘ç”¨æˆ·çš„æ‰€æœ‰è®¾å¤‡å‘é€æ¶ˆæ¯\n    /// &lt;/summary&gt;\n    Task SendToUserAsync(string userId, string method, object message, \n        CancellationToken cancellationToken = default);\n\n    /// &lt;summary&gt;\n    /// å‘æŒ‡å®šè®¾å¤‡å‘é€æ¶ˆæ¯\n    /// &lt;/summary&gt;\n    Task SendToDeviceAsync(string deviceId, string method, object message, \n        CancellationToken cancellationToken = default);\n\n    /// &lt;summary&gt;\n    /// å‘é€è‡ªå®šä¹‰æ¶ˆæ¯ (xiaozhiåè®®æ ¼å¼)\n    /// &lt;/summary&gt;\n    Task SendCustomMessageAsync(string userId, object message, \n        CancellationToken cancellationToken = default);\n\n    /// &lt;summary&gt;\n    /// å‘é€é€šçŸ¥æ¶ˆæ¯\n    /// &lt;/summary&gt;\n    Task SendNotificationAsync(string userId, string notificationMessage, \n        CancellationToken cancellationToken = default);\n}\n</code></pre>\n<p><strong>DevicePushServiceå®ç°</strong> (Server/Services/DevicePushServiceImpl.cs):</p>\n<pre><code class=\"language-csharp\">using Microsoft.AspNetCore.SignalR;\nusing Verdure.Mcp.Server.Hubs;\nusing Verdure.Mcp.Infrastructure.Services;\nusing System.Text.Json;\n\nnamespace Verdure.Mcp.Server.Services;\n\npublic class DevicePushServiceImpl : IDevicePushService\n{\n    private readonly IHubContext&lt;DeviceHub&gt; _hubContext;\n    private readonly ILogger&lt;DevicePushServiceImpl&gt; _logger;\n\n    public DevicePushServiceImpl(\n        IHubContext&lt;DeviceHub&gt; hubContext,\n        ILogger&lt;DevicePushServiceImpl&gt; logger)\n    {\n        _hubContext = hubContext;\n        _logger = logger;\n    }\n\n    public async Task SendToUserAsync(string userId, string method, object message, \n        CancellationToken cancellationToken = default)\n    {\n        var groupName = $\"Users:{userId}\";\n        await _hubContext.Clients.Group(groupName)\n            .SendAsync(method, message, cancellationToken);\n        \n        _logger.LogInformation(\"Sent {Method} to user {UserId}\", method, userId);\n    }\n\n    public async Task SendToDeviceAsync(string deviceId, string method, object message, \n        CancellationToken cancellationToken = default)\n    {\n        var groupName = $\"Device:{deviceId}\";\n        await _hubContext.Clients.Group(groupName)\n            .SendAsync(method, message, cancellationToken);\n        \n        _logger.LogInformation(\"Sent {Method} to device {DeviceId}\", method, deviceId);\n    }\n\n    public async Task SendCustomMessageAsync(string userId, object message, \n        CancellationToken cancellationToken = default)\n    {\n        var groupName = $\"Users:{userId}\";\n        \n        // é‡è¦ï¼ESP32å®¢æˆ·ç«¯æœŸæœ›æ¥æ”¶JSONå­—ç¬¦ä¸²ï¼Œè€Œä¸æ˜¯å¯¹è±¡\n        var jsonString = JsonSerializer.Serialize(message);\n        \n        await _hubContext.Clients.Group(groupName)\n            .SendAsync(\"CustomMessage\", jsonString, cancellationToken);\n        \n        _logger.LogInformation(\"Sent CustomMessage to user {UserId}: {Message}\", \n            userId, jsonString);\n    }\n\n    public async Task SendNotificationAsync(string userId, string notificationMessage, \n        CancellationToken cancellationToken = default)\n    {\n        var groupName = $\"Users:{userId}\";\n        await _hubContext.Clients.Group(groupName)\n            .SendAsync(\"Notification\", notificationMessage, cancellationToken);\n        \n        _logger.LogInformation(\"Sent notification to user {UserId}: {Message}\", \n            userId, notificationMessage);\n    }\n}\n</code></pre>\n<p><strong>éŸ³ä¹æ’­æ”¾å·¥å…·å®é™…å®ç°</strong> (Tools/MusicTool.cs):</p>\n<pre><code class=\"language-csharp\">using System;\nusing System.ComponentModel;\nusing System.IO;\nusing System.Linq;\nusing System.Threading;\nusing System.Threading.Tasks;\nusing Microsoft.AspNetCore.Hosting;\nusing Microsoft.AspNetCore.Http;\nusing Microsoft.Extensions.Logging;\nusing Microsoft.Extensions.Options;\nusing Verdure.Mcp.Server.Settings;\nusing ModelContextProtocol.Server;\nusing Verdure.Mcp.Infrastructure.Services;\nusing Verdure.Mcp.Server.Services;\nusing Hangfire;\n\nnamespace Verdure.Mcp.Server.Tools;\n\n/// &lt;summary&gt;\n/// MCP Tool to pick a random audio file from wwwroot and push its URL to device(s).\n/// &lt;/summary&gt;\n[McpServerToolType]\npublic class MusicTool\n{\n    private readonly IHttpContextAccessor _httpContextAccessor;\n    private readonly IWebHostEnvironment _env;\n    private readonly IDevicePushService _devicePushService;\n    private readonly ILogger&lt;MusicTool&gt; _logger;\n    private readonly IBackgroundJobClient _backgroundJobClient;\n    private readonly ImageStorageSettings _imageStorageSettings;\n\n    public MusicTool(\n        IHttpContextAccessor httpContextAccessor,\n        IWebHostEnvironment env,\n        IDevicePushService devicePushService,\n        ILogger&lt;MusicTool&gt; logger,\n        IBackgroundJobClient backgroundJobClient,\n        IOptions&lt;ImageStorageSettings&gt;? imageSettings = null)\n    {\n        _httpContextAccessor = httpContextAccessor;\n        _env = env;\n        _devicePushService = devicePushService;\n        _logger = logger;\n        _backgroundJobClient = backgroundJobClient;\n        _imageStorageSettings = imageSettings?.Value ?? new ImageStorageSettings();\n    }\n\n    /// &lt;summary&gt;\n    /// Select a random audio file from the `wwwroot/audio` folder and push it to the user\n    /// identified by the `X-User-Id` request header.\n    /// The pushed message follows the same shape as used in `test-send-message.ps1` (action = \"audio\", url = \"...\").\n    /// &lt;/summary&gt;\n    [McpServerTool(Name = \"play_random_music\")]\n    [Description(\"Plays a random audio file from wwwroot/audio by pushing an audio message to the user's devices\")]\n    public async Task&lt;MusicResponse&gt; PlayRandomMusic(CancellationToken cancellationToken = default)\n    {\n        try\n        {\n            var httpContext = _httpContextAccessor.HttpContext;\n            var effectiveUserId = httpContext?.Request.Headers[\"X-User-Id\"].FirstOrDefault();\n            if (string.IsNullOrEmpty(effectiveUserId))\n            {\n                _logger.LogWarning(\"No userId provided and X-User-Id header is missing\");\n                return new MusicResponse { Success = false, Message = \"Missing userId or X-User-Id header\" };\n            }\n\n            var webRoot = _env.WebRootPath ?? _env.ContentRootPath;\n            var folder = \"audios\";\n            var audioFolder = Path.Combine(webRoot, folder);\n\n            if (!Directory.Exists(audioFolder))\n            {\n                _logger.LogWarning(\"Audio folder does not exist: {AudioFolder}\", audioFolder);\n                return new MusicResponse { Success = false, Message = $\"Audio folder not found: {folder}\" };\n            }\n\n            // Find audio files (ogg, mp3) and pick a random one\n            var files = Directory.GetFiles(audioFolder)\n                .Where(f =&gt; f.EndsWith('.' + \"ogg\") || f.EndsWith('.' + \"mp3\") || f.EndsWith('.' + \"wav\"))\n                .ToArray();\n\n            if (files.Length == 0)\n            {\n                _logger.LogWarning(\"No audio files found in {AudioFolder}\", audioFolder);\n                return new MusicResponse { Success = false, Message = \"No audio files found\" };\n            }\n\n            var rnd = new Random();\n            var chosen = files[rnd.Next(files.Length)];\n            var fileName = Path.GetFileName(chosen);\n\n            string url;\n            // Prefer configured ImageStorage BaseUrl (keeps image and audio base URL consistent)\n            if (!string.IsNullOrWhiteSpace(_imageStorageSettings.BaseUrl))\n            {\n                var cfgBase = _imageStorageSettings.BaseUrl.TrimEnd('/');\n                url = $\"{cfgBase}/{folder}/{Uri.EscapeDataString(fileName)}\";\n            }\n            else\n            {\n                var req = httpContext?.Request;\n                var hostBase = req != null ? $\"{req.Scheme}://{req.Host.Value}\" : string.Empty;\n                url = string.IsNullOrEmpty(hostBase)\n                    ? $\"/{folder}/{Uri.EscapeDataString(fileName)}\"\n                    : $\"{hostBase}/{folder}/{Uri.EscapeDataString(fileName)}\";\n            }\n\n            var title = Path.GetFileNameWithoutExtension(fileName);\n\n            var message = new\n            {\n                action = \"audio\",\n                url,\n                title\n            };\n\n            // Schedule push as a delayed background job so device can play result first.\n            try\n            {\n\n                var jobDelay = TimeSpan.FromSeconds(5);\n\n                _logger.LogInformation(\"Scheduling audio push to user {UserId} after {Delay}s: {Url}\",\n                    effectiveUserId, jobDelay.TotalSeconds, url);\n\n                _backgroundJobClient.Schedule&lt;MusicPushBackgroundJob&gt;(\n                    job =&gt; job.ExecuteAsync(effectiveUserId, url, title, CancellationToken.None),\n                    jobDelay);\n\n                return new MusicResponse { Success = true, Message = \"Audio scheduled\", Url = url, FileName = fileName };\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"Failed to schedule audio push for user {UserId}\", effectiveUserId);\n                return new MusicResponse { Success = false, Message = ex.Message };\n            }\n        }\n        catch (Exception ex)\n        {\n            _logger.LogError(ex, \"Failed to play random music\");\n            return new MusicResponse { Success = false, Message = ex.Message };\n        }\n    }\n}\n\npublic class MusicResponse\n{\n    public bool Success { get; set; }\n    public required string Message { get; set; }\n    public string? Url { get; set; }\n    public string? FileName { get; set; }\n}\n\n</code></pre>\n<p><strong>å»¶è¿Ÿæ¨é€åå°ä»»åŠ¡</strong> (Tools/MusicPushBackgroundJob.cs):</p>\n<pre><code class=\"language-csharp\">using Verdure.Mcp.Infrastructure.Services;\nusing Verdure.Mcp.Server.Services;\n\nnamespace Verdure.Mcp.Server.Tools;\n\n/// &lt;summary&gt;\n/// Background job to push music/audio messages to user devices after a delay.\n/// &lt;/summary&gt;\npublic class MusicPushBackgroundJob\n{\n    private readonly IDevicePushService _devicePushService;\n    private readonly ILogger&lt;MusicPushBackgroundJob&gt; _logger;\n\n    public MusicPushBackgroundJob(IDevicePushService devicePushService, ILogger&lt;MusicPushBackgroundJob&gt; logger)\n    {\n        _devicePushService = devicePushService;\n        _logger = logger;\n    }\n\n    public async Task ExecuteAsync(string userId, string url, string title, CancellationToken cancellationToken)\n    {\n        _logger.LogInformation(\"Executing MusicPushBackgroundJob: user={UserId}, url={Url}\", userId, url);\n\n        var message = new\n        {\n            action = \"audio\",\n            url,\n            title\n        };\n\n        try\n        {\n            await _devicePushService.SendCustomMessageAsync(userId, message, cancellationToken);\n            _logger.LogInformation(\"Music pushed to user {UserId}\", userId);\n        }\n        catch (Exception ex)\n        {\n            _logger.LogError(ex, \"Failed to push music to user {UserId}\", userId);\n        }\n    }\n}\n\n</code></pre>\n<h4 id=\"523-å›¾ç‰‡ç”Ÿæˆå·¥å…·å®ç°ç¤ºä¾‹\">5.2.3 å›¾ç‰‡ç”Ÿæˆå·¥å…·å®ç°ç¤ºä¾‹</h4>\n<p><strong>ä»“åº“åœ°å€</strong>ï¼š<a href=\"https://github.com/maker-community/verdure-mcp/blob/main/src/Verdure.Mcp.Server/Tools/GenerateImageTool.cs\" rel=\"noopener nofollow\" target=\"_blank\">verdure-mcp - GenerateImageTool</a></p>\n<p>è¿™ä¸ªå·¥å…·å±•ç¤ºäº†å¦‚ä½•ç”Ÿæˆå›¾ç‰‡å¹¶æ¨é€åˆ°è®¾å¤‡ï¼š</p>\n<pre><code class=\"language-csharp\">using System.ComponentModel;\nusing System.Net;\nusing Hangfire;\nusing Microsoft.EntityFrameworkCore;\nusing ModelContextProtocol.Server;\nusing Verdure.Mcp.Domain.Entities;\nusing Verdure.Mcp.Domain.Enums;\nusing Verdure.Mcp.Infrastructure.Data;\nusing Verdure.Mcp.Infrastructure.Services;\nusing Verdure.Mcp.Server.Services;\n\nnamespace Verdure.Mcp.Server.Tools;\n\n/// &lt;summary&gt;\n/// ä½¿ç”¨ Azure OpenAI DALL-E ç”Ÿæˆå›¾ç‰‡çš„ MCP å·¥å…·\n/// &lt;/summary&gt;\n[McpServerToolType]\npublic class GenerateImageTool\n{\n    private readonly IImageGenerationService _imageGenerationService;\n    private readonly IEmailService _emailService;\n    private readonly McpDbContext _dbContext;\n    private readonly IBackgroundJobClient _backgroundJobClient;\n    private readonly IHttpContextAccessor _httpContextAccessor;\n    private readonly IImageStorageService _imageStorageService;\n    private readonly IDevicePushService _devicePushService;\n    private readonly ILogger&lt;GenerateImageTool&gt; _logger;\n\n    public GenerateImageTool(\n        IImageGenerationService imageGenerationService,\n        IEmailService emailService,\n        McpDbContext dbContext,\n        IBackgroundJobClient backgroundJobClient,\n        IHttpContextAccessor httpContextAccessor,\n        IImageStorageService imageStorageService,\n        IDevicePushService devicePushService,\n        ILogger&lt;GenerateImageTool&gt; logger)\n    {\n        _imageGenerationService = imageGenerationService;\n        _emailService = emailService;\n        _dbContext = dbContext;\n        _backgroundJobClient = backgroundJobClient;\n        _httpContextAccessor = httpContextAccessor;\n        _imageStorageService = imageStorageService;\n        _devicePushService = devicePushService;\n        _logger = logger;\n    }\n\n    /// &lt;summary&gt;\n    /// ä½¿ç”¨ Azure OpenAI DALL-E æ ¹æ®æç¤ºè¯ç”Ÿæˆå›¾ç‰‡ã€‚\n    /// å¦‚æœæä¾›é‚®ç®±åœ°å€ï¼Œä¼šå°†ç”Ÿæˆçš„å›¾ç‰‡å‘é€åˆ°æŒ‡å®šé‚®ç®±ã€‚\n    /// å¦‚æœè¯·æ±‚å¤´ä¸­åŒ…å«ç”¨æˆ·ä¿¡æ¯ï¼ˆX-User-Email å’Œ X-User-Idï¼‰ï¼Œä»»åŠ¡å°†å¼‚æ­¥è¿è¡Œã€‚\n    /// &lt;/summary&gt;\n    /// &lt;param name=\"prompt\"&gt;æè¿°è¦ç”Ÿæˆå›¾ç‰‡çš„æ–‡æœ¬æç¤ºè¯&lt;/param&gt;\n    /// &lt;param name=\"size\"&gt;å›¾ç‰‡å°ºå¯¸ï¼š\"1024x1024\"ã€\"1792x1024\" æˆ– \"1024x1792\"ï¼Œé»˜è®¤ä¸º \"1024x1024\"&lt;/param&gt;\n    /// &lt;param name=\"quality\"&gt;å›¾ç‰‡è´¨é‡ï¼š\"standard\" æˆ– \"hd\"ï¼Œé»˜è®¤ä¸º \"standard\"&lt;/param&gt;\n    /// &lt;param name=\"style\"&gt;å›¾ç‰‡é£æ ¼ï¼š\"vivid\" æˆ– \"natural\"ï¼Œé»˜è®¤ä¸º \"vivid\"&lt;/param&gt;\n    /// &lt;param name=\"cancellationToken\"&gt;&lt;/param&gt;\n    /// &lt;returns&gt;åŒ…å«ä»»åŠ¡ä¿¡æ¯å’Œå›¾ç‰‡æ•°æ®çš„ JSON å¯¹è±¡ï¼ˆåŒæ­¥æ¨¡å¼ä¸‹ï¼‰&lt;/returns&gt;\n    [McpServerTool(Name = \"generate_image\")]\n    [Description(\"ä½¿ç”¨ DALL-E æ¨¡å‹ï¼Œæ ¹æ®æ–‡æœ¬æç¤ºè¯ç”Ÿæˆå›¾ç‰‡ã€‚æ”¯æŒé‚®ä»¶é€šçŸ¥å’Œå¼‚æ­¥å¤„ç†ã€‚\")]\n    public async Task&lt;ImageGenerationResponse&gt; GenerateImage(\n        [Description(\"æè¿°è¦ç”Ÿæˆå›¾ç‰‡çš„æ–‡æœ¬æç¤ºè¯\")] string prompt,\n        [Description(\"å›¾ç‰‡å°ºå¯¸ï¼š'1024x1024'ã€'1792x1024' æˆ– '1024x1792'ï¼Œé»˜è®¤ä¸º '1024x1024'\")] string? size = null,\n        [Description(\"å›¾ç‰‡è´¨é‡ï¼š'standard' æˆ– 'hd'ï¼Œé»˜è®¤ä¸º 'standard'\")] string? quality = null,\n        [Description(\"å›¾ç‰‡é£æ ¼ï¼š'vivid' æˆ– 'natural'ï¼Œé»˜è®¤ä¸º 'vivid'\")] string? style = null,\n        CancellationToken cancellationToken = default)\n    {\n        var httpContext = _httpContextAccessor.HttpContext;\n        \n        // ä»è¯·æ±‚å¤´æå–é‚®ç®±åœ°å€ (X-User-Email)\n        var email = httpContext?.Request.Headers[\"X-User-Email\"].FirstOrDefault();\n        \n        // ä»è¯·æ±‚å¤´æå–ç”¨æˆ· ID (X-User-Id)\n        var userId = httpContext?.Request.Headers[\"X-User-Id\"].FirstOrDefault();\n\n        _logger.LogInformation(\"æ”¶åˆ°å›¾ç‰‡ç”Ÿæˆè¯·æ±‚ã€‚æç¤ºè¯: {Prompt}, é‚®ç®±: {Email}, ç”¨æˆ·ID: {UserId}\", \n            prompt, email ?? \"æ— \", userId ?? \"æ— \");\n\n        // åˆ›å»ºä»»åŠ¡è®°å½•\n        var task = new ImageGenerationTask\n        {\n            Id = Guid.NewGuid(),\n            Prompt = prompt,\n            Size = size ?? \"1024x1024\",\n            Quality = quality ?? \"standard\",\n            Style = style ?? \"vivid\",\n            Status = ImageTaskStatus.Pending,\n            Email = email,\n            UserId = userId,\n            CreatedAt = DateTime.UtcNow\n        };\n\n        _dbContext.ImageGenerationTasks.Add(task);\n        await _dbContext.SaveChangesAsync(cancellationToken);\n\n        // å¦‚æœå­˜åœ¨ç”¨æˆ·ä¿¡æ¯ï¼ˆX-User-Email å’Œ X-User-Idï¼‰ï¼Œä½¿ç”¨ Hangfire å¼‚æ­¥å¤„ç†\n        if (!string.IsNullOrEmpty(email) &amp;&amp; !string.IsNullOrEmpty(userId))\n        {\n            _logger.LogInformation(\"æ£€æµ‹åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Œä½¿ç”¨å¼‚æ­¥å¤„ç†ä»»åŠ¡ {TaskId}\", task.Id);\n            \n            var jobId = _backgroundJobClient.Enqueue&lt;ImageGenerationBackgroundJob&gt;(\n                job =&gt; job.ExecuteAsync(task.Id, CancellationToken.None));\n            \n            task.HangfireJobId = jobId;\n            task.Status = ImageTaskStatus.Processing;\n            await _dbContext.SaveChangesAsync(cancellationToken);\n\n            return new ImageGenerationResponse\n            {\n                TaskId = task.Id,\n                Status = \"å¤„ç†ä¸­\",\n                Message = \"å›¾ç‰‡ç”Ÿæˆä»»åŠ¡å·²åŠ å…¥é˜Ÿåˆ—ã€‚å¦‚æœæ‚¨æä¾›äº†é‚®ç®±åœ°å€ï¼Œç¨åä¼šæ”¶åˆ°ç”Ÿæˆç»“æœã€‚\",\n                IsAsync = true\n            };\n        }\n        else\n        {\n            // åŒæ­¥å¤„ç†\n            _logger.LogInformation(\"æœªæ£€æµ‹åˆ°å®Œæ•´ç”¨æˆ·ä¿¡æ¯ï¼Œä½¿ç”¨åŒæ­¥å¤„ç†ä»»åŠ¡ {TaskId}\", task.Id);\n            \n            task.Status = ImageTaskStatus.Processing;\n            await _dbContext.SaveChangesAsync(cancellationToken);\n\n            try\n            {\n                var result = await _imageGenerationService.GenerateImageAsync(\n                    prompt, size, quality, style, cancellationToken);\n\n                if (result.Success)\n                {\n                    task.Status = ImageTaskStatus.Completed;\n                    task.ImageData = result.ImageBase64;\n                    task.CompletedAt = DateTime.UtcNow;\n                    task.UpdatedAt = DateTime.UtcNow;\n\n                    // ä¿å­˜å›¾ç‰‡åˆ°æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿï¼ˆPNG + JPEGï¼‰\n                    ImageStorageResult? storageResult = null;\n                    if (!string.IsNullOrEmpty(result.ImageBase64))\n                    {\n                        try\n                        {\n                            storageResult = await _imageStorageService.SaveImageAsync(\n                                result.ImageBase64, \n                                task.Id, \n                                cancellationToken);\n                            task.ImageUrl = storageResult.PngUrl; // æ•°æ®åº“ä¿å­˜ PNG URL\n                            _logger.LogInformation(\n                                \"å›¾ç‰‡å·²ä¿å­˜ - PNG: {PngUrl}, JPEG: {JpegUrl}, å‹ç¼©ç‡: {CompressionRatio:F1}%\",\n                                storageResult.PngUrl, storageResult.JpegUrl, storageResult.CompressionRatio);\n                        }\n                        catch (Exception ex)\n                        {\n                            _logger.LogError(ex, \"ä¿å­˜å›¾ç‰‡åˆ°æœ¬åœ°å¤±è´¥ï¼Œä»»åŠ¡ {TaskId}\", task.Id);\n                            // å³ä½¿ä¿å­˜å¤±è´¥ï¼Œä»ç„¶ç»§ç»­æµç¨‹\n                        }\n                    }\n\n                    await _dbContext.SaveChangesAsync(cancellationToken);\n\n                    // å¦‚æœæä¾›äº†é‚®ç®±ï¼Œå‘é€é‚®ä»¶\n                    if (!string.IsNullOrEmpty(email) &amp;&amp; !string.IsNullOrEmpty(result.ImageBase64))\n                    {\n                        try\n                        {\n                            var imageBytes = Convert.FromBase64String(result.ImageBase64);\n                            var encodedPrompt = WebUtility.HtmlEncode(prompt);\n                            var encodedRevisedPrompt = WebUtility.HtmlEncode(result.RevisedPrompt ?? \"æ— \");\n                            await _emailService.SendImageEmailAsync(\n                                email,\n                                \"æ‚¨çš„å›¾ç‰‡å·²ç”Ÿæˆ\",\n                                $\"&lt;h1&gt;æ‚¨çš„å›¾ç‰‡å·²æˆåŠŸç”Ÿæˆï¼&lt;/h1&gt;&lt;p&gt;æç¤ºè¯ï¼š{encodedPrompt}&lt;/p&gt;&lt;p&gt;ä¿®è®¢åçš„æç¤ºè¯ï¼š{encodedRevisedPrompt}&lt;/p&gt;\",\n                                imageBytes,\n                                $\"image_{task.Id}.png\",\n                                cancellationToken);\n                            \n                            task.EmailSent = true;\n                            await _dbContext.SaveChangesAsync(cancellationToken);\n                        }\n                        catch (Exception ex)\n                        {\n                            _logger.LogError(ex, \"å‘é€é‚®ä»¶å¤±è´¥ï¼Œä»»åŠ¡ {TaskId}\", task.Id);\n                        }\n                    }\n\n                    // å¦‚æœæœ‰ç”¨æˆ· IDï¼Œæ¨é€åˆ°ç”¨æˆ·è®¾å¤‡ï¼ˆä½¿ç”¨ JPEG ç‰ˆæœ¬ï¼Œç¬¦åˆ xiaozhi åè®®ï¼‰\n                    if (!string.IsNullOrEmpty(userId) &amp;&amp; storageResult != null)\n                    {\n                        try\n                        {\n                            // 1. å…ˆå‘é€é€šçŸ¥æ¶ˆæ¯\n                            var notificationMessage = new\n                            {\n                                action = \"notification\",\n                                title = \"å›¾ç‰‡ç”Ÿæˆå®Œæˆ\",\n                                content = $\"æ‚¨çš„å›¾ç‰‡å·²ç”Ÿæˆï¼š{prompt.Substring(0, Math.Min(30, prompt.Length))}...\",\n                                emotion = \"happy\",\n                                sound = \"success\"\n                            };\n                            await _devicePushService.SendCustomMessageAsync(userId, notificationMessage, cancellationToken);\n                            \n                            // 2. å†å‘é€å›¾ç‰‡æ¶ˆæ¯ï¼ˆESP32 æœŸæœ›çš„æ ¼å¼ - xiaozhi åè®®ï¼‰\n                            var imageMessage = new\n                            {\n                                action = \"image\",\n                                url = storageResult.JpegUrl,  // ä½¿ç”¨ JPEG URLï¼ˆä½“ç§¯å°ï¼‰\n                                // æ‰©å±•ä¿¡æ¯ï¼ˆå¯é€‰ï¼ŒESP32 å¯ä»¥å¿½ç•¥ï¼‰\n                                taskId = task.Id.ToString(),\n                                pngUrl = storageResult.PngUrl,\n                                prompt = prompt,\n                                jpegSize = storageResult.JpegSize,\n                                timestamp = DateTime.UtcNow\n                            };\n\n                            await _devicePushService.SendCustomMessageAsync(userId, imageMessage, cancellationToken);\n                            _logger.LogInformation(\n                                \"å·²æ¨é€å›¾ç‰‡åˆ°ç”¨æˆ· {UserId} çš„è®¾å¤‡ï¼Œä»»åŠ¡ {TaskId}ï¼ŒJPEG URL: {JpegUrl} ({JpegSize} bytes)\", \n                                userId, task.Id, storageResult.JpegUrl, storageResult.JpegSize);\n                        }\n                        catch (Exception ex)\n                        {\n                            _logger.LogError(ex, \"æ¨é€æ¶ˆæ¯åˆ°è®¾å¤‡å¤±è´¥ï¼Œç”¨æˆ· {UserId}ï¼Œä»»åŠ¡ {TaskId}\", userId, task.Id);\n                        }\n                    }\n\n                    // åŒæ­¥æ¨¡å¼ï¼šè¿”å› PNG URLï¼ˆå®Œæ•´è´¨é‡ï¼‰\n                    return new ImageGenerationResponse\n                    {\n                        TaskId = task.Id,\n                        Status = \"å·²å®Œæˆ\",\n                        Message = \"å›¾ç‰‡ç”ŸæˆæˆåŠŸ\",\n                        ImageUrl = storageResult?.PngUrl ?? result.ImageUrl,\n                        RevisedPrompt = result.RevisedPrompt,\n                        IsAsync = false\n                    };\n                }\n                else\n                {\n                    task.Status = ImageTaskStatus.Failed;\n                    task.ErrorMessage = result.ErrorMessage;\n                    task.UpdatedAt = DateTime.UtcNow;\n                    await _dbContext.SaveChangesAsync(cancellationToken);\n\n                    return new ImageGenerationResponse\n                    {\n                        TaskId = task.Id,\n                        Status = \"å¤±è´¥\",\n                        Message = result.ErrorMessage ?? \"å›¾ç‰‡ç”Ÿæˆå¤±è´¥\",\n                        IsAsync = false\n                    };\n                }\n            }\n            catch (Exception ex)\n            {\n                _logger.LogError(ex, \"åŒæ­¥ç”Ÿæˆå›¾ç‰‡æ—¶å‡ºé”™ï¼Œä»»åŠ¡ {TaskId}\", task.Id);\n                \n                task.Status = ImageTaskStatus.Failed;\n                task.ErrorMessage = ex.Message;\n                task.UpdatedAt = DateTime.UtcNow;\n                await _dbContext.SaveChangesAsync(cancellationToken);\n\n                return new ImageGenerationResponse\n                {\n                    TaskId = task.Id,\n                    Status = \"å¤±è´¥\",\n                    Message = ex.Message,\n                    IsAsync = false\n                };\n            }\n        }\n    }\n\n    /// &lt;summary&gt;\n    /// è·å–å›¾ç‰‡ç”Ÿæˆä»»åŠ¡çš„çŠ¶æ€\n    /// &lt;/summary&gt;\n    /// &lt;param name=\"taskId\"&gt;è¦æŸ¥è¯¢çš„ä»»åŠ¡ ID&lt;/param&gt;\n    /// &lt;returns&gt;ä»»åŠ¡çŠ¶æ€å’Œç»“æœï¼ˆå¦‚æœå·²å®Œæˆï¼‰&lt;/returns&gt;\n    [McpServerTool(Name = \"get_image_task_status\")]\n    [Description(\"è·å–å›¾ç‰‡ç”Ÿæˆä»»åŠ¡çš„çŠ¶æ€\")]\n    public async Task&lt;ImageGenerationResponse&gt; GetImageTaskStatus(\n        [Description(\"è¦æŸ¥è¯¢çš„ä»»åŠ¡ ID\")] string taskId,\n        CancellationToken cancellationToken = default)\n    {\n        if (!Guid.TryParse(taskId, out var id))\n        {\n            return new ImageGenerationResponse\n            {\n                Status = \"é”™è¯¯\",\n                Message = \"ä»»åŠ¡ ID æ ¼å¼æ— æ•ˆ\"\n            };\n        }\n\n        var task = await _dbContext.ImageGenerationTasks.FindAsync(new object[] { id }, cancellationToken);\n        \n        if (task == null)\n        {\n            return new ImageGenerationResponse\n            {\n                Status = \"é”™è¯¯\",\n                Message = \"æœªæ‰¾åˆ°ä»»åŠ¡\"\n            };\n        }\n\n        return new ImageGenerationResponse\n        {\n            TaskId = task.Id,\n            Status = task.Status.ToString().ToLowerInvariant(),\n            Message = task.ErrorMessage ?? GetStatusMessage(task.Status),\n            ImageBase64 = task.ImageData,\n            ImageUrl = task.ImageUrl,\n            IsAsync = !string.IsNullOrEmpty(task.HangfireJobId)\n        };\n    }\n\n    private static string GetStatusMessage(ImageTaskStatus status)\n    {\n        return status switch\n        {\n            ImageTaskStatus.Pending =&gt; \"ä»»åŠ¡ç­‰å¾…ä¸­\",\n            ImageTaskStatus.Processing =&gt; \"ä»»åŠ¡å¤„ç†ä¸­\",\n            ImageTaskStatus.Completed =&gt; \"å›¾ç‰‡ç”ŸæˆæˆåŠŸ\",\n            ImageTaskStatus.Failed =&gt; \"å›¾ç‰‡ç”Ÿæˆå¤±è´¥\",\n            ImageTaskStatus.Cancelled =&gt; \"ä»»åŠ¡å·²å–æ¶ˆ\",\n            _ =&gt; \"æœªçŸ¥çŠ¶æ€\"\n        };\n    }\n}\n\n/// &lt;summary&gt;\n/// å›¾ç‰‡ç”Ÿæˆå“åº”æ¨¡å‹\n/// &lt;/summary&gt;\npublic class ImageGenerationResponse\n{\n    public Guid? TaskId { get; set; }\n    public required string Status { get; set; }\n    public string? Message { get; set; }\n    public string? ImageBase64 { get; set; }\n    public string? ImageUrl { get; set; }\n    public string? RevisedPrompt { get; set; }\n    public bool IsAsync { get; set; }\n}\n\n</code></pre>\n<p><strong>å®é™…é¡¹ç›®ç‰¹ç‚¹</strong>ï¼š</p>\n<ol>\n<li>\n<p><strong>åŒæ¨¡å¼æ”¯æŒ</strong>ï¼š</p>\n<ul>\n<li>åŒæ­¥æ¨¡å¼ï¼šç«‹å³ç”Ÿæˆå¹¶è¿”å›ç»“æœ</li>\n<li>å¼‚æ­¥æ¨¡å¼ï¼šä½¿ç”¨Hangfireåå°ä»»åŠ¡ï¼Œå®Œæˆåé€šè¿‡é‚®ä»¶é€šçŸ¥</li>\n</ul>\n</li>\n<li>\n<p><strong>å¤šæ¸ é“æ¨é€</strong>ï¼š</p>\n<ul>\n<li>é€šè¿‡SignalRæ¨é€åˆ°è®¾å¤‡ï¼ˆCustomMessageï¼‰</li>\n<li>é€šè¿‡é‚®ä»¶å‘é€é“¾æ¥</li>\n</ul>\n</li>\n<li>\n<p><strong>å›¾ç‰‡å­˜å‚¨</strong>ï¼š</p>\n<ul>\n<li>åŒæ—¶ä¿å­˜PNGå’ŒJPEGä¸¤ç§æ ¼å¼</li>\n<li>å­˜å‚¨åˆ°Azure Blob Storageæˆ–æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ</li>\n</ul>\n</li>\n<li>\n<p><strong>å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•</strong></p>\n</li>\n</ol>\n<p><strong>è·å–å®Œæ•´ä»£ç </strong>ï¼š</p>\n<ul>\n<li>\n<p>ğŸ”§ ESP32è®¾å¤‡ç«¯ (å°æ™ºå®Œæ•´å®ç°):<br />\n<a href=\"https://github.com/maker-community/xiaozhi-esp32\" rel=\"noopener nofollow\" target=\"_blank\">https://github.com/maker-community/xiaozhi-esp32</a></p>\n<ul>\n<li>SignalRé›†æˆåˆ†æ”¯ï¼š<code>signalr</code> å’Œ <code>signalr-update-audio</code></li>\n</ul>\n</li>\n<li>\n<p>ğŸ”§ ESP32ç¤ºä¾‹å·¥ç¨‹ (åŒ…å«å®Œæ•´çš„SignalRé›†æˆç¤ºä¾‹):<br />\n<a href=\"https://github.com/maker-community/esp-signalr-example\" rel=\"noopener nofollow\" target=\"_blank\">https://github.com/maker-community/esp-signalr-example</a></p>\n</li>\n<li>\n<p>ğŸ”§ SignalR C++å®¢æˆ·ç«¯åº“:<br />\n<a href=\"https://github.com/maker-community/esp-signalr\" rel=\"noopener nofollow\" target=\"_blank\">https://github.com/maker-community/esp-signalr</a><br />\n<a href=\"https://github.com/maker-community/esp-signalr-example\" rel=\"noopener nofollow\" target=\"_blank\">https://github.com/maker-community/esp-signalr-example</a></p>\n</li>\n<li>\n<p>ğŸŒ MCPæœåŠ¡å™¨ç«¯:<br />\n<a href=\"https://github.com/maker-community/verdure-mcp\" rel=\"noopener nofollow\" target=\"_blank\">https://github.com/maker-community/verdure-mcp</a></p>\n</li>\n</ul>\n<h2 id=\"å®é™…ä½¿ç”¨åœºæ™¯ç¤ºä¾‹\">å®é™…ä½¿ç”¨åœºæ™¯ç¤ºä¾‹</h2>\n<h3 id=\"åœºæ™¯1aiç”Ÿå›¾åæ¨é€åˆ°è®¾å¤‡\">åœºæ™¯1ï¼šAIç”Ÿå›¾åæ¨é€åˆ°è®¾å¤‡</h3>\n<p>ç”¨æˆ·é€šè¿‡å°æ™ºå¯¹è¯ï¼š\"å¸®æˆ‘ç”Ÿæˆä¸€å¼ çŒ«å’ªçš„å›¾ç‰‡\"</p>\n<ol>\n<li>å¯¹è¯å‘é€åˆ°.NET MCPæœåŠ¡</li>\n<li>MCPæœåŠ¡è°ƒç”¨APIç”Ÿæˆå›¾ç‰‡</li>\n<li>ç”Ÿæˆå®Œæˆåï¼Œåå°ä»»åŠ¡è°ƒç”¨hubå‘é€æ¶ˆæ¯</li>\n<li>æœåŠ¡ç«¯é€šè¿‡SignalRæ¨é€å›¾ç‰‡ç»™è¯¥ç”¨æˆ·çš„æ‰€æœ‰è®¾å¤‡</li>\n<li>ESP32è®¾å¤‡æ¥æ”¶åˆ°<code>è‡ªå®šä¹‰æ¶ˆæ¯</code>äº‹ä»¶ï¼Œä¸‹è½½å¹¶æ˜¾ç¤ºåœ¨å±å¹•ä¸Š</li>\n</ol>\n<h3 id=\"åœºæ™¯2æ’­æ”¾éŸ³ä¹\">åœºæ™¯2ï¼šæ’­æ”¾éŸ³ä¹</h3>\n<p>ç”¨æˆ·é€šè¿‡è¯­éŸ³è¯´æƒ³è¦æ’­æ”¾éŸ³ä¹ï¼Œmcpè¢«è§¦å‘ï¼Œéšæœºé€‰æ‹©éŸ³ä¹urlæ¨é€åˆ°è®¾å¤‡</p>\n<ol>\n<li>å¯¹è¯å‘é€åˆ°.NET MCPæœåŠ¡</li>\n<li>æœåŠ¡ç«¯é€šè¿‡SignalRæ¨é€éŸ³ä¹ç»™è¯¥ç”¨æˆ·çš„æ‰€æœ‰è®¾å¤‡</li>\n<li>ESP32è®¾å¤‡æ¥æ”¶åˆ°<code>è‡ªå®šä¹‰æ¶ˆæ¯</code>äº‹ä»¶ï¼Œä¸‹è½½å¹¶æ’­æ”¾è¯­éŸ³</li>\n</ol>\n<h2 id=\"å†…å­˜ä¼˜åŒ–ç»éªŒåˆ†äº«\">å†…å­˜ä¼˜åŒ–ç»éªŒåˆ†äº«</h2>\n<blockquote>\n<p><strong>è¯´æ˜</strong>ï¼šæœ¬ç« èŠ‚å†…å®¹å¯¹äºåœ¨ESP32ä¸Šè¿è¡ŒSignalRå®¢æˆ·ç«¯éå¸¸é‡è¦ï¼Œè¿™äº›éƒ½æ˜¯å®è·µä¸­æ€»ç»“å‡ºçš„ç»éªŒã€‚</p>\n</blockquote>\n<p>åœ¨ESP32ä¸Šé›†æˆSignalRç¡®å®é‡åˆ°äº†å†…å­˜é—®é¢˜ï¼Œåˆ†äº«ä¸€äº›ä¼˜åŒ–ç»éªŒï¼š</p>\n<h3 id=\"1-ä½¿ç”¨psramå­˜å‚¨å¤§å¯¹è±¡\">1. ä½¿ç”¨PSRAMå­˜å‚¨å¤§å¯¹è±¡</h3>\n<pre><code class=\"language-cpp\">// ä¸ºå›¾ç‰‡æ•°æ®åˆ†é…PSRAMå†…å­˜\nvoid* imageBuffer = heap_caps_malloc(imageSize, MALLOC_CAP_SPIRAM);\nif (imageBuffer == NULL) {\n    // é™çº§åˆ°å†…éƒ¨RAM\n    imageBuffer = malloc(imageSize);\n}\n</code></pre>\n<p>åœ¨VS Codeçš„menuconfigä¸­å¯ç”¨PSRAMï¼š</p>\n<ul>\n<li><code>F1</code> â†’ <code>ESP-IDF: SDK Configuration editor</code></li>\n<li><code>Component config</code> â†’ <code>ESP32-specific</code> â†’ <code>Support for external, SPI-connected RAM</code></li>\n</ul>\n<h3 id=\"2-å‡å°‘jsonåºåˆ—åŒ–æ¬¡æ•°\">2. å‡å°‘JSONåºåˆ—åŒ–æ¬¡æ•°</h3>\n<pre><code class=\"language-cpp\">// é”™è¯¯åšæ³•ï¼šé¢‘ç¹åˆ›å»º/é”€æ¯cJSONå¯¹è±¡\nfor (int i = 0; i &lt; 100; i++) {\n    cJSON* root = cJSON_Parse(jsonString);\n    // å¤„ç†...\n    cJSON_Delete(root);  // äº§ç”Ÿå†…å­˜ç¢ç‰‡\n}\n\n// æ­£ç¡®åšæ³•ï¼šå¤ç”¨å¯¹è±¡\ncJSON* root = cJSON_Parse(jsonString);\nfor (int i = 0; i &lt; 100; i++) {\n    // å¤„ç†...\n}\ncJSON_Delete(root);\n</code></pre>\n<h3 id=\"3-å¢åŠ ä»»åŠ¡æ ˆå¤§å°\">3. å¢åŠ ä»»åŠ¡æ ˆå¤§å°</h3>\n<p>SignalRçš„å›è°ƒåµŒå¥—è¾ƒæ·±ï¼Œéœ€è¦å¢åŠ æ ˆï¼š</p>\n<p>åœ¨menuconfigä¸­ï¼š<code>Component config</code> â†’ <code>ESP32-specific</code> â†’ <code>Main task stack size</code> â†’ è®¾ç½®ä¸º<code>8192</code></p>\n<p>æˆ–åœ¨ä»£ç ä¸­ï¼š</p>\n<pre><code class=\"language-cpp\">xTaskCreatePinnedToCore(\n    signalr_task,\n    \"signalr\",\n    8192,  // æ ˆå¤§å°ï¼ˆå­—èŠ‚ï¼‰\n    NULL,\n    5,     // ä¼˜å…ˆçº§\n    NULL,\n    1      // CPUæ ¸å¿ƒ\n);\n</code></pre>\n<h2 id=\"æ€»ç»“ä¸æ„Ÿæ‚Ÿ\">æ€»ç»“ä¸æ„Ÿæ‚Ÿ</h2>\n<p>é€šè¿‡è¿™æ¬¡SignalRç§»æ¤å’Œé›†æˆçš„å®è·µï¼Œæˆ‘æ·±åˆ»ä½“ä¼šåˆ°ï¼š</p>\n<ol>\n<li>\n<p><strong>é€‰å¯¹æ¡†æ¶å¾ˆé‡è¦</strong>ï¼šSignalRçš„ç¾¤ç»„ç®¡ç†ã€æ¶ˆæ¯è·¯ç”±ç­‰ç‰¹æ€§ï¼Œçœå»äº†å¤§é‡åŸºç¡€è®¾æ–½ä»£ç ã€‚å¦‚æœä»å¤´æ‰‹å†™WebSocketï¼Œè¿™äº›åŠŸèƒ½å¾—èŠ±å‡ å‘¨æ—¶é—´ã€‚</p>\n</li>\n<li>\n<p><strong>å†…å­˜ç®¡ç†æ˜¯åµŒå…¥å¼æ°¸æ’çš„ä¸»é¢˜</strong>ï¼šESP32çš„RAMé™åˆ¶è®©æˆ‘å¯¹æ¯ä¸€ä¸ªmallocéƒ½æ ¼å¤–å°å¿ƒã€‚åˆç†ä½¿ç”¨PSRAMã€é¿å…å†…å­˜ç¢ç‰‡ã€åŠæ—¶é‡Šæ”¾èµ„æºï¼Œè¿™äº›åœ¨PCä¸Šä¸ç”¨careçš„é—®é¢˜ï¼Œåœ¨åµŒå…¥å¼ä¸Šéƒ½æ˜¯å‘ã€‚</p>\n</li>\n<li>\n<p><strong>AIè¾…åŠ©ç¼–ç¨‹çœŸé¦™</strong>ï¼šè¿™æ¬¡é¡¹ç›®ä¸­ï¼ŒSignalR C++å®¢æˆ·ç«¯çš„ç§»æ¤ã€æ¶ˆæ¯å¤„ç†ç­‰å¤§é‡ä»£ç éƒ½æ˜¯å€ŸåŠ©AIç”Ÿæˆçš„ã€‚è™½ç„¶ç”Ÿæˆçš„ä»£ç éœ€è¦è°ƒè¯•å’Œä¼˜åŒ–ï¼Œä½†ç¡®å®å¤§å¹…æé«˜äº†å¼€å‘æ•ˆç‡ã€‚</p>\n</li>\n<li>\n<p><strong>æ¶ˆæ¯æ¨é€è§£å†³å®é™…é—®é¢˜</strong>ï¼šä¹‹å‰MCPå·¥å…·åªèƒ½åŒæ­¥è¿”å›ç»“æœï¼Œç°åœ¨é€šè¿‡SignalRï¼ŒæœåŠ¡ç«¯å¯ä»¥ä¸»åŠ¨æ¨é€å›¾ç‰‡ã€è¯­éŸ³ã€é€šçŸ¥ç»™è®¾å¤‡ï¼Œç”¨æˆ·ä½“éªŒæå‡æ˜æ˜¾ã€‚</p>\n</li>\n<li>\n<p><strong>.NETç”Ÿæ€çš„å¼ºå¤§</strong>ï¼šSignalRã€EF Coreã€JWTè®¤è¯â€¦â€¦å¾®è½¯è¿™å¥—ç”Ÿæ€çœŸçš„å¾ˆå®Œå–„ã€‚ä½œä¸º.NETå¼€å‘è€…ï¼Œèƒ½ç”¨ç†Ÿæ‚‰çš„æŠ€æœ¯æ ˆå¿«é€Ÿæ­å»ºç”Ÿäº§çº§æœåŠ¡ã€‚</p>\n</li>\n</ol>\n<p>è¿™ä¸ªé¡¹ç›®è¿˜æœ‰å¾ˆå¤šä¼˜åŒ–ç©ºé—´ï¼Œæ¯”å¦‚ï¼š</p>\n<ul>\n<li>WebSocket Binary Protocolæ›¿ä»£JSONå‡å°‘å¸¦å®½</li>\n<li>å¼•å…¥Rediså­˜å‚¨ç¾¤ç»„ä¿¡æ¯ï¼Œæ”¯æŒæœåŠ¡ç«¯æ¨ªå‘æ‰©å±•</li>\n<li>ç»§ç»­å®Œå–„ä»£ç è´¨é‡ï¼Œè®©åº“èƒ½å¤Ÿè¢«æ›´å¤šçš„äººå…³æ³¨å’Œå‚ä¸ï¼Œå¸Œæœ›æœ‰æ›´å¤šçš„äººæ¥å®é™…ä½¿ç”¨å’Œä¼˜åŒ–ã€‚</li>\n</ul>\n<p>ä½†ä½œä¸ºä¸€ä¸ªåˆæ­¥èƒ½ç”¨çš„æ–¹æ¡ˆï¼Œå·²ç»è¶³å¤Ÿæ”¯æ’‘å°æ™ºæœºå™¨äººçš„åŠŸèƒ½æ‰©å±•äº†ã€‚åç»­æˆ‘ä¼šç»§ç»­å®Œå–„è¿™å¥—æ¶æ„ï¼Œæ¬¢è¿å¤§å®¶ä¸€èµ·æ¢è®¨å’Œè´¡çŒ®ä»£ç ï¼</p>\n<p>å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½ç»™å¤§å®¶åœ¨.NET IoTå¼€å‘ã€SignalRå®æ—¶é€šä¿¡æ–¹é¢å¸¦æ¥ä¸€äº›å¯å‘ã€‚å¦‚æœæœ‰é—®é¢˜æ¬¢è¿åœ¨è¯„è®ºåŒºè®¨è®ºï¼Œè®©æˆ‘ä»¬ä¸€èµ·æ¢ç´¢.NETåœ¨IoTé¢†åŸŸçš„æ›´å¤šå¯èƒ½æ€§ï¼</p>\n<h2 id=\"æ‰‹æ“esp32å°æœºå™¨äºº\">æ‰‹æ“ESP32å°æœºå™¨äºº</h2>\n<p>å¦‚æœä½ æœ‰æ‰‹æ“Esp32çš„ç¡¬ä»¶æ‰“ç®—ï¼Œå¯ä»¥å…³æ³¨æˆ‘çš„Bç«™è´¦å·ï¼ˆç»¿è«é˜¿å¹¿ï¼‰<br />\n<a href=\"https://space.bilibili.com/25228512\" rel=\"noopener nofollow\" target=\"_blank\">https://space.bilibili.com/25228512</a></p>\n<p><img alt=\"img\" src=\"https://img2024.cnblogs.com/blog/1690009/202602/1690009-20260201141614219-406532144.png\" /></p>\n<h2 id=\"é¡¹ç›®åœ°å€\">é¡¹ç›®åœ°å€</h2>\n<h3 id=\"esp32ç›¸å…³-1\">ESP32ç›¸å…³</h3>\n<ul>\n<li>\n<p><strong>SignalR C++å®¢æˆ·ç«¯åº“</strong>ï¼š<br />\n<a href=\"https://github.com/maker-community/esp-signalr\" rel=\"noopener nofollow\" target=\"_blank\">https://github.com/maker-community/esp-signalr</a></p>\n</li>\n<li>\n<p><strong>å°æ™ºESP32å®Œæ•´å®ç°</strong> (signalr-update-audioåˆ†æ”¯):<br />\n<a href=\"https://github.com/maker-community/xiaozhi-esp32\" rel=\"noopener nofollow\" target=\"_blank\">https://github.com/maker-community/xiaozhi-esp32</a></p>\n</li>\n<li>\n<p><strong>ESP32 SignalRå®Œæ•´ç¤ºä¾‹å·¥ç¨‹</strong> (åŒ…å«éŸ³é¢‘åˆ†å—ã€è®¾å¤‡æ§åˆ¶APIç­‰):<br />\n<a href=\"https://github.com/maker-community/esp-signalr-example\" rel=\"noopener nofollow\" target=\"_blank\">https://github.com/maker-community/esp-signalr-example</a></p>\n<ul>\n<li><a href=\"https://github.com/maker-community/esp-signalr-example/tree/main/signalr-server\" rel=\"noopener nofollow\" target=\"_blank\">æœåŠ¡ç«¯ä»£ç </a></li>\n<li><a href=\"https://github.com/maker-community/esp-signalr-example/tree/main/main\" rel=\"noopener nofollow\" target=\"_blank\">å®¢æˆ·ç«¯ä»£ç </a></li>\n</ul>\n</li>\n</ul>\n<h3 id=\"netæœåŠ¡ç«¯\">.NETæœåŠ¡ç«¯</h3>\n<ul>\n<li><strong>Verdure MCPæœåŠ¡</strong> (åŒ…å«å®Œæ•´çš„Hubã€Toolsã€Serviceså®ç°):<br />\n<a href=\"https://github.com/maker-community/verdure-mcp\" rel=\"noopener nofollow\" target=\"_blank\">https://github.com/maker-community/verdure-mcp</a></li>\n<li><strong>å°æ™ºmcpè½¬æ¥å¹³å°</strong>ï¼š</li>\n<li><a href=\"https://github.com/maker-community/verdure-mcp-for-xiaozhi\" rel=\"noopener nofollow\" target=\"_blank\">https://github.com/maker-community/verdure-mcp-for-xiaozhi</a></li>\n</ul>\n<h3 id=\"å‚è€ƒèµ„æ–™\">å‚è€ƒèµ„æ–™</h3>\n<ul>\n<li><strong>SignalR Client C++ (å¾®è½¯å®˜æ–¹)</strong>:<br />\n<a href=\"https://github.com/aspnet/SignalR-Client-Cpp\" rel=\"noopener nofollow\" target=\"_blank\">https://github.com/aspnet/SignalR-Client-Cpp</a></li>\n<li><strong>SignalR Client C# nanoframework</strong>:<br />\n<a href=\"https://github.com/nanoframework/nanoFramework.SignalR.Client\" rel=\"noopener nofollow\" target=\"_blank\">https://github.com/nanoframework/nanoFramework.SignalR.Client</a></li>\n</ul>\n<h2 id=\"å‚è€ƒæ–‡æ¡£\">å‚è€ƒæ–‡æ¡£</h2>\n<ol>\n<li><a href=\"https://docs.microsoft.com/zh-cn/aspnet/core/signalr/\" rel=\"noopener nofollow\" target=\"_blank\">ASP.NET Core SignalR å®˜æ–¹æ–‡æ¡£</a></li>\n<li><a href=\"https://github.com/dotnet/aspnetcore/blob/main/src/SignalR/docs/specs/HubProtocol.md\" rel=\"noopener nofollow\" target=\"_blank\">SignalR Hub åè®®è§„èŒƒ</a></li>\n<li><a href=\"https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/\" rel=\"noopener nofollow\" target=\"_blank\">ESP-IDF ç¼–ç¨‹æŒ‡å—</a></li>\n<li><a href=\"https://github.com/espressif/vscode-esp-idf-extension\" rel=\"noopener nofollow\" target=\"_blank\">VS Code ESP-IDF æ’ä»¶</a></li>\n<li><a href=\"https://jwt.io/introduction\" rel=\"noopener nofollow\" target=\"_blank\">JWT è®¤è¯æœ€ä½³å®è·µ</a></li>\n<li><a href=\"https://www.keycloak.org/docs/latest/securing_apps/\" rel=\"noopener nofollow\" target=\"_blank\">Keycloak è®¤è¯é›†æˆæŒ‡å—</a></li>\n</ol>\n<hr />\n<p><em>æœ¬æ–‡é¦–å‘äºä¸ªäººæŠ€æœ¯åšå®¢ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚å¦‚æœå¯¹.NET IoTå¼€å‘ã€SignalRå®æ—¶é€šä¿¡æ„Ÿå…´è¶£ï¼Œæ¬¢è¿å…³æ³¨æˆ‘çš„åšå®¢è·å–æ›´å¤šæŠ€æœ¯åˆ†äº«ï¼</em></p>\n\n\n</div>\n<div class=\"clear\"></div>\n\n            </div>\n            <div class=\"postDesc\">posted @ \n<span id=\"post-date\">2026-02-01 15:33</span>&nbsp;\n<a href=\"https://www.cnblogs.com/GreenShade\">ç»¿è«é˜¿å¹¿</a>&nbsp;\né˜…è¯»(<span id=\"post_view_count\">62</span>)&nbsp;\nè¯„è®º(<span id=\"post_comment_count\">0</span>)&nbsp;\n&nbsp;\n<a href=\"\">æ”¶è—</a>&nbsp;\n<a href=\"\">ä¸¾æŠ¥</a>\n</div>"
    },
    {
      "title": "LLVM Passå¿«é€Ÿå…¥é—¨(ä¸€)ï¼šæ„å»ºç¼–è¯‘ç¯å¢ƒ",
      "link": "https://www.cnblogs.com/ClownLMe/p/19560726",
      "published": "",
      "description": "<h1 class=\"postTitle\">\n                <a class=\"postTitle2 vertical-middle\" href=\"https://www.cnblogs.com/ClownLMe/p/19560726\" id=\"cb_post_title_url\" title=\"å‘å¸ƒäº 2026-02-01 14:36\">\n    <span>LLVM Passå¿«é€Ÿå…¥é—¨(ä¸€)ï¼šæ„å»ºç¼–è¯‘ç¯å¢ƒ</span>\n    \n\n</a>\n\n            </h1>\n            <div class=\"clear\"></div>\n            <div class=\"postBody\">\n                <div class=\"blogpost-body cnblogs-markdown\" id=\"cnblogs_post_body\">\n<h1 id=\"ç®€ä»‹\">ç®€ä»‹</h1>\n<p><strong>LLVM</strong> æ˜¯ä¸€ä¸ªç¼–è¯‘æ¡†æ¶å·¥å…·ï¼Œæ˜¯æŠŠç¼–è¯‘è¿‡ç¨‹æ‹†è§£æˆäº†é«˜åº¦æ ‡å‡†åŒ–çš„ç»„ä»¶ã€‚</p>\n<p><strong>æœ¬æ•™ç¨‹æ‰€ä½¿ç”¨çš„ç¯å¢ƒæ˜¯windows11, vs2022</strong></p>\n<h1 id=\"è®¤è¯†llvm\">è®¤è¯†LLVM</h1>\n<p>LLVM æœ€æˆåŠŸçš„åœ°æ–¹åœ¨äºå®ƒå®šä¹‰äº†ä¸€ç§æå…¶å®Œç¾çš„ä¸­é—´è¯­è¨€<strong>LLVM IR</strong>ï¼ŒLLVMåˆ†ä¸ºå‰ç«¯ï¼Œä¼˜åŒ–å™¨ï¼Œåç«¯ï¼š</p>\n<ul>\n<li><strong>å‰ç«¯</strong>ï¼šè´Ÿè´£æŠŠæºä»£ç ï¼ˆC/C++ã€Rustã€Goï¼‰ç¿»è¯‘æˆ LLVM IRã€‚æ¯”å¦‚ <code>Clang</code>ã€‚</li>\n<li><strong>ä¼˜åŒ–å™¨</strong>ï¼šè¿™æ˜¯ LLVM çš„çµé­‚ã€‚å®ƒåªå¤„ç† IRï¼Œä¸å…³å¿ƒæºç æ˜¯ä»€ä¹ˆè¯­è¨€ï¼Œä¹Ÿä¸å…³å¿ƒç›®æ ‡æ˜¯ä»€ä¹ˆæœºå™¨ã€‚ä½ å†™çš„ <strong>Pass</strong> å°±è¿è¡Œåœ¨è¿™é‡Œã€‚</li>\n<li><strong>åç«¯</strong>ï¼šè´Ÿè´£æŠŠä¼˜åŒ–åçš„ IR ç¿»è¯‘æˆå…·ä½“çš„æœºå™¨ç ï¼ˆx86ã€ARMã€RISC-Vï¼‰ã€‚æ¯”å¦‚ <code>LLC</code>ã€‚</li>\n</ul>\n<p>LLVMçš„ä¸‰ç«¯æ¶æ„ï¼Œæˆ‘ä»¬èƒ½å¤Ÿå¾ˆæ–¹ä¾¿çš„è‡ªå®šä¹‰ç¼–è¯‘å™¨ï¼Œ<strong>æœ¬ç³»ç±»æ•™ç¨‹ä¸»è¦æ•™å­¦ä¼˜åŒ–å™¨çš„passç¼–å†™</strong></p>\n<h1 id=\"ç¯å¢ƒé…ç½®\">ç¯å¢ƒé…ç½®</h1>\n<h3 id=\"éœ€è¦å‡†å¤‡çš„å·¥å…·\">éœ€è¦å‡†å¤‡çš„å·¥å…·</h3>\n<ol>\n<li><strong>git</strong> : <a href=\"https://git-scm.com/install/\" rel=\"noopener nofollow\" target=\"_blank\">https://git-scm.com/install/</a> æ‹‰å–é¡¹ç›®</li>\n<li><strong>visual studio</strong> : <a href=\"https://visualstudio.microsoft.com/zh-hans/\" rel=\"noopener nofollow\" target=\"_blank\">https://visualstudio.microsoft.com/zh-hans/</a> éœ€è¦å®‰è£…<code>c/c++æ¡Œé¢å¼€å‘</code>ç»„ä»¶ï¼Œç¼–è¯‘ç¯å¢ƒ</li>\n<li><strong>cmake</strong>ï¼š <a href=\"https://cmake.org/\" rel=\"noopener nofollow\" target=\"_blank\">https://cmake.org/</a> æ„å»ºé¡¹ç›®</li>\n<li><strong>ninja</strong> : <a href=\"https://github.com/ninja-build/ninja\" rel=\"noopener nofollow\" target=\"_blank\">https://github.com/ninja-build/ninja</a> åŠ é€Ÿç¼–è¯‘</li>\n</ol>\n<h3 id=\"æ‹‰å–llvmå¹¶é…ç½®\">æ‹‰å–LLVMå¹¶é…ç½®</h3>\n<p>è¿™é‡Œæˆ‘ä¿å­˜åœ¨Dç›˜</p>\n<pre><code class=\"language-bash\">#åˆ›å»ºæ–‡ä»¶å¤¹\nmkdir D:\\LLVM \ncd D:\\LLVM \n#æ‹‰å–æºç  (åªæ‹‰å–æ ¸å¿ƒä»“åº“ï¼Œä¸éœ€è¦ submoduleï¼Œç°åœ¨ LLVM æ˜¯ monorepo) \n#è¿™ä¸€æ­¥æ¯”è¾ƒå¤§ï¼Œç½‘ç»œä¸å¥½è¯·æŒ‚æ¢¯å­ \ngit clone --depth=1 https://github.com/llvm/llvm-project.git\n#åˆ›å»ºæ„å»ºç›®å½•\ncd llvm-project \nmkdir build \ncd build\n</code></pre>\n<h3 id=\"æ„å»ºå¹¶ç¼–è¯‘\">æ„å»ºå¹¶ç¼–è¯‘</h3>\n<p><strong>è¿™é‡Œéœ€è¦æ‰“å¼€åˆšåˆšä¸‹è½½å¥½<code>visual studio</code>çš„å·¥ä½œå°ï¼Œæˆ‘è¿™é‡Œæ˜¯<code>x64 Native Tools Command Prompt for VS 2022</code></strong><br />\n<strong>æ³¨æ„ï¼šå¼€å§‹ç¼–è¯‘éœ€è¦é¢„ç•™30-60Gç¡¬ç›˜ç©ºé—´ï¼Œç¼–è¯‘éœ€è¦30åˆ†é’Ÿå·¦å³</strong></p>\n<pre><code class=\"language-bash\">#åˆ©ç”¨cmakeæ„å»ºé¡¹ç›®\ncmake -G \"Ninja\" ^ #ä½¿ç”¨ninjaç¼–è¯‘\n-DLLVM_ENABLE_PROJECTS=\"clang\" ^ #åªç¼–è¯‘clangèŠ‚çœç©ºé—´\n-DLLVM_TARGETS_TO_BUILD=\"X86\" ^ #åªç¼–è¯‘x86åç«¯ï¼Œè¿™èŠ‚çœå¤§éƒ¨åˆ†ç¼–è¯‘æ—¶é—´ï¼Œé™¤éè¦æarmæˆ–è€…å®‰å“\n-DCMAKE_BUILD_TYPE=\"RelWithDebInfo\" ^ #Relaseç‰ˆæœ¬æ— æ³•è°ƒè¯•ï¼Œdebugç‰ˆæœ¬å¤ªå¤§å¤ªæ…¢äº†ï¼Œè¿™é‡Œé€‰æ‹©å¸¦è°ƒè¯•ç¬¦å·çš„relaseç‰ˆæœ¬\n-DLLVM_OPTIMIZED_TABLEGEN=ON ^ \n-DLLVM_ENABLE_ASSERTIONS=ON ^ #å¼€å¯ä»£ç æ–­è¨€ã€‚å½“passå†™é”™æ—¶ï¼Œä¼šæŠ¥é”™è€Œä¸æ˜¯ç›´æ¥å´©æºƒ\n../llvm\n#ç¼–è¯‘\nninja\n</code></pre>\n<h3 id=\"æ·»åŠ ç¯å¢ƒå˜é‡\">æ·»åŠ ç¯å¢ƒå˜é‡</h3>\n<p>è¿™ä¸€æ­¥æ–¹ä¾¿ä¹‹åçš„ä½¿ç”¨</p>\n<pre><code class=\"language-bash\">#å°†åˆšåˆšç¼–è¯‘å¥½çš„ç¯å¢ƒåŠ å…¥ç¯å¢ƒå˜é‡\nD:\\LLVM\\llvm-project\\build\\bin\n</code></pre>\n<h3 id=\"ç®€å•éªŒè¯ç¯å¢ƒ\">ç®€å•éªŒè¯ç¯å¢ƒ</h3>\n<pre><code class=\"language-bash\">clang --version\nopt --version\n</code></pre>\n<p>ä¸€èˆ¬æ¥è¯´ï¼Œè·Ÿç€ä¸Šé¢æ­¥éª¤èµ° å¹¶ä¸” ç³»ç»Ÿå’Œvsç‰ˆæœ¬ä¸€æ ·åˆ°è¿™æ˜¯ä¸ä¼šæŠ¥é”™çš„ã€‚</p>\n<h1 id=\"éªŒè¯ç¯å¢ƒ\">éªŒè¯ç¯å¢ƒ</h1>\n<p>ä¸‹é¢ç¼–è¯‘ä¸€ä¸ª<code>test.c</code>æ¥éªŒè¯ç¯å¢ƒæ˜¯å¦æ­£å¸¸ã€‚</p>\n<pre><code class=\"language-c\">#include &lt;stdio.h&gt;\n\nint add(int a, int b) {\n&nbsp; &nbsp; return a + b + 5;\n}\n\nint main(){\n&nbsp; &nbsp; printf(\"add(1, 2) = %d\\n\", add(1, 2));\n&nbsp; &nbsp; return 0;\n}\n</code></pre>\n<h3 id=\"ç¼–è¯‘ä»£ç \">ç¼–è¯‘ä»£ç </h3>\n<h5 id=\"c-ç¼–è¯‘ä¸ºllvm-ir\">C ç¼–è¯‘ä¸ºLLVM IR</h5>\n<pre><code class=\"language-bash\">clang -S -emit-llvm -O0 test.c -o test.ll\n</code></pre>\n<p>è§‚å¯ŸIRï¼š</p>\n<pre><code class=\"language-c\">......\ndefine dso_local i32 @main() #0 {\nentry:\n&nbsp; %retval = alloca i32, align 4\n&nbsp; store i32 0, ptr %retval, align 4\n&nbsp; %call = call i32 @add(i32 noundef 1, i32 noundef 2)\n&nbsp; %call1 = call i32 (ptr, ...) @printf(ptr noundef @\"??_C@_0BA@OMPDDIF@add?$CI1?0?52?$CJ?5?$DN?5?$CFd?6?$AA@\", i32 noundef %call)\n&nbsp; ret i32 0\n}\n......\n</code></pre>\n<h5 id=\"llvm-ir-ç¼–è¯‘ä¸ºå¯æ‰§è¡Œæ–‡ä»¶\">LLVM IR ç¼–è¯‘ä¸ºå¯æ‰§è¡Œæ–‡ä»¶</h5>\n<p>ç¼–è¯‘ä¸ºå¯æ‰§è¡Œæ–‡ä»¶å¹¶æ­£å¸¸è¿è¡Œ</p>\n<pre><code class=\"language-bash\">clang test.c -o test.exe\n</code></pre>\n<p><strong>å¦‚æœâ¤å–œæ¬¢â¤æœ¬ç³»åˆ—æ•™ç¨‹ï¼Œå°±ç‚¹ä¸ªå…³æ³¨å§ï¼Œåç»­ä¸å®šæœŸæ›´æ–°~</strong></p>\n\n\n</div>\n<div class=\"clear\"></div>\n\n            </div>\n            <div class=\"postDesc\">posted @ \n<span id=\"post-date\">2026-02-01 14:36</span>&nbsp;\n<a href=\"https://www.cnblogs.com/ClownLMe\">ClownLMe</a>&nbsp;\né˜…è¯»(<span id=\"post_view_count\">35</span>)&nbsp;\nè¯„è®º(<span id=\"post_comment_count\">0</span>)&nbsp;\n&nbsp;\n<a href=\"\">æ”¶è—</a>&nbsp;\n<a href=\"\">ä¸¾æŠ¥</a>\n</div>"
    },
    {
      "title": "ä»0åˆ°1ï¼Œå¿«é€Ÿè®­ç»ƒå¹¶ä½¿ç”¨YOLOæ¨¡å‹",
      "link": "https://www.cnblogs.com/ClownLMe/p/19559180",
      "published": "",
      "description": "<h1 class=\"postTitle\">\n                <a class=\"postTitle2 vertical-middle\" href=\"https://www.cnblogs.com/ClownLMe/p/19559180\" id=\"cb_post_title_url\" title=\"å‘å¸ƒäº 2026-01-31 21:54\">\n    <span>ä»0åˆ°1ï¼Œå¿«é€Ÿè®­ç»ƒå¹¶ä½¿ç”¨YOLOæ¨¡å‹</span>\n    \n\n</a>\n\n            </h1>\n            <div class=\"clear\"></div>\n            <div class=\"postBody\">\n                <div class=\"blogpost-body cnblogs-markdown\" id=\"cnblogs_post_body\">\n<h1 id=\"ç®€ä»‹\">ç®€ä»‹</h1>\n<p><strong>YOLO</strong>æ˜¯ç›®å‰è®¡ç®—æœºè§†è§‰é¢†åŸŸæœ€å‰æ²¿ã€åº”ç”¨æœ€å¹¿æ³›çš„<strong>ç›®æ ‡æ£€æµ‹</strong>ç®—æ³•æ¡†æ¶ï¼Œä»–èƒ½å¿«é€Ÿè¯†åˆ«åŒºåˆ†ç›®æ ‡ï¼Œå¹¿æ³›åº”ç”¨äºæ¸¸æˆï¼Œæ— äººé©¾é©¶ï¼Œå·¥ä¸šç­‰é¢†åŸŸã€‚</p>\n<p>ä»¥è¯†åˆ«èº²é¿æ‰è½æ»‘å—çš„æ¸¸æˆçš„ç‰©ä½“å›¾ç‰‡ä½œä¸ºä¾‹å­ã€‚</p>\n<h1 id=\"ä¸€ç¯å¢ƒé…ç½®\">ä¸€ï¼Œç¯å¢ƒé…ç½®</h1>\n<pre><code class=\"language-bash\">pip install ultralytics\n</code></pre>\n<h1 id=\"äºŒå‡†å¤‡æ•°æ®é›†\">äºŒï¼Œå‡†å¤‡æ•°æ®é›†</h1>\n<p>è¿™ä¸ªæ ¼å¼ç›®å½•å¦‚ä¸‹ï¼š</p>\n<pre><code class=\"language-bash\">my_dataset/\nâ”œâ”€â”€ data.yaml # é…ç½®æ–‡ä»¶ï¼ˆå®šä¹‰è·¯å¾„å’Œç±»åˆ«ï¼‰\nâ”œâ”€â”€ train/ #è®­ç»ƒæ•°æ®é›†\nâ”‚   â”œâ”€â”€ images/ # è®­ç»ƒå›¾ç‰‡\nâ”‚   â””â”€â”€ labels/ # æ ‡æ³¨æ–‡ä»¶ (.txt)\nâ””â”€â”€ val/ #éªŒè¯æ•°æ®é›†\n    â”œâ”€â”€ images/ \n    â””â”€â”€ labels/ \n</code></pre>\n<h3 id=\"datayml\">data.yml</h3>\n<pre><code class=\"language-yaml\">path: D:\\D_MyProject\\Ai\\game_ai\\my_dataset #æ•°æ®é›†è·¯å¾„\ntrain: train/images #è®­ç»ƒé›†å›¾ç‰‡è·¯å¾„\nval: val/images #éªŒè¯é›†å›¾ç‰‡è·¯å¾„\n\nnc: 3 #æ ‡è®°ä¸ªæ•°\nnames:  #æ¯ä¸ªæ ‡è®°çš„åç§°\n&nbsp; 0: player\n&nbsp; 1: enemy\n&nbsp; 2: game_over\n</code></pre>\n<h3 id=\"ä¸‹é¢æ˜¯ç”¨aiç”Ÿæˆäº†æ•°æ®é›†çš„ç”Ÿæˆè„šæœ¬\">ä¸‹é¢æ˜¯ç”¨AIç”Ÿæˆäº†æ•°æ®é›†çš„ç”Ÿæˆè„šæœ¬</h3>\n<p>æ•°æ®é‡å¤ªå¤šäº†ï¼Œè¿™é‡Œä¸ºäº†æ¼”ç¤ºï¼Œæˆ–è€…å­¦ä¹ ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ä¸‹é¢è„šæœ¬</p>\n<pre><code class=\"language-python\">import pygame\nimport random\nimport sys\nimport os\nimport shutil\n\n# =================é…ç½®åŒºåŸŸ=================\n# æ•°æ®é›†æ ¹ç›®å½•åç§°\nDATASET_ROOT = \"my_dataset\"\n# é‡‡é›†æ€»æ•°é‡\nMAX_IMAGES = 1000\n# è®­ç»ƒé›†å æ¯” (0.8 = 80% è®­ç»ƒ, 20% éªŒè¯)\nTRAIN_RATIO = 0.8\n\n# ================= 1. ç¯å¢ƒæ¸…ç†ä¸ç›®å½•åˆ›å»º =================\nprint(f\"ğŸš€ æ­£åœ¨åˆå§‹åŒ–æ•°æ®é›†ç›®å½•: {DATASET_ROOT} ...\")\n\n# å¦‚æœç›®å½•å·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤ï¼ˆé˜²æ­¢æ—§æ•°æ®æ··å…¥ï¼‰ï¼Œç¡®ä¿æ•°æ®çº¯å‡€\nif os.path.exists(DATASET_ROOT):\n    shutil.rmtree(DATASET_ROOT)\n\n# åˆ›å»º YOLO æ ‡å‡†ç›®å½•ç»“æ„\nfor split in ['train', 'val']:\n    os.makedirs(os.path.join(DATASET_ROOT, split, 'images'), exist_ok=True)\n    os.makedirs(os.path.join(DATASET_ROOT, split, 'labels'), exist_ok=True)\n\n# ================= 2. è‡ªåŠ¨ç”Ÿæˆ data.yaml =================\nyaml_content = f\"\"\"\npath: {os.path.abspath(DATASET_ROOT)} # ä½¿ç”¨ç»å¯¹è·¯å¾„ï¼Œé˜²æ­¢æŠ¥é”™\ntrain: train/images\nval: val/images\n\nnc: 3\nnames:\n  0: player\n  1: enemy\n  2: game_over\n\"\"\"\nwith open(os.path.join(DATASET_ROOT, \"data.yaml\"), \"w\", encoding='utf-8') as f:\n    f.write(yaml_content)\nprint(\"âœ… data.yaml é…ç½®æ–‡ä»¶å·²ç”Ÿæˆã€‚\")\n\n# ================= 3. æ¸¸æˆä¸é‡‡é›†é€»è¾‘ =================\npygame.init()\nWIDTH, HEIGHT = 800, 600\n# ä½¿ç”¨ hidden æ¨¡å¼æˆ–æ­£å¸¸æ¨¡å¼å‡å¯ï¼Œè¿™é‡Œç”¨æ­£å¸¸æ¨¡å¼æ–¹ä¾¿ä½ çœ‹åˆ°è¿›åº¦\nscreen = pygame.display.set_mode((WIDTH, HEIGHT))\npygame.display.set_caption(\"Auto Data Generator\")\nclock = pygame.time.Clock()\n\nfont_big = pygame.font.SysFont(\"monospace\", 50)\nfont_small = pygame.font.SysFont(\"monospace\", 35)\n\n# æ¸¸æˆçŠ¶æ€\nplayer_size, enemy_size = 50, 50\nplayer_x = WIDTH // 2\nplayer_y = HEIGHT - player_size - 10\nenemies = []\n\nimg_count = 0\nGAMEPLAY_LIMIT = int(MAX_IMAGES * 0.9) # 90% æ­£å¸¸æ¸¸æˆï¼Œ10% Game Over\n\nprint(f\"ğŸ“¸ å¼€å§‹é‡‡é›† {MAX_IMAGES} å¼ å›¾ç‰‡ (è‡ªåŠ¨åˆ’åˆ† Train/Val)...\")\n\nwhile img_count &lt; MAX_IMAGES:\n    # å¤„ç†é€€å‡ºäº‹ä»¶ï¼Œé˜²æ­¢å¡æ­»\n    for event in pygame.event.get():\n        if event.type == pygame.QUIT:\n            pygame.quit()\n            sys.exit()\n\n    screen.fill((0, 0, 0))\n    labels = [] # å­˜å‚¨å½“å‰å¸§çš„æ ‡ç­¾\n    dw, dh = 1.0 / WIDTH, 1.0 / HEIGHT # å½’ä¸€åŒ–ç³»æ•°\n\n    # --- é€»è¾‘åˆ†æ”¯ï¼šæ­£å¸¸æ¸¸æˆ vs Game Over ---\n    if img_count &lt; GAMEPLAY_LIMIT:\n        # A. æ­£å¸¸æ¸¸æˆç”»é¢\n        # 1. ç©å®¶ç§»åŠ¨\n        if random.random() &lt; 0.2: # å¢åŠ ç§»åŠ¨é¢‘ç‡\n            player_x += random.choice([-15, 15])\n            player_x = max(0, min(WIDTH - player_size, player_x))\n\n        # 2. æ•Œäººç”Ÿæˆä¸ç§»åŠ¨\n        if random.randint(0, 20) == 0: # å¢åŠ æ•Œäººå¯†åº¦\n            enemies.append([random.randint(0, WIDTH - enemy_size), 0])\n        \n        for enemy in enemies: enemy[1] += 15 # åŠ å¿«ä¸‹è½é€Ÿåº¦\n        enemies = [e for e in enemies if e[1] &lt; HEIGHT]\n\n        # 3. ç»˜åˆ¶ç©å®¶ (Class 0)\n        pygame.draw.rect(screen, (50, 150, 255), (player_x, player_y, player_size, player_size))\n        # è®¡ç®— YOLO åæ ‡ (class x_center y_center width height)\n        px, py = (player_x + player_size/2) * dw, (player_y + player_size/2) * dh\n        labels.append(f\"0 {px:.6f} {py:.6f} {player_size*dw:.6f} {player_size*dh:.6f}\")\n\n        # 4. ç»˜åˆ¶æ•Œäºº (Class 1)\n        for e in enemies:\n            pygame.draw.rect(screen, (255, 50, 50), (e[0], e[1], enemy_size, enemy_size))\n            ex, ey = (e[0] + enemy_size/2) * dw, (e[1] + enemy_size/2) * dh\n            labels.append(f\"1 {ex:.6f} {ey:.6f} {enemy_size*dw:.6f} {enemy_size*dh:.6f}\")\n\n    else:\n        # B. Game Over ç”»é¢ (Class 2)\n        text_surf = font_big.render(\"GAME OVER\", True, (255, 50, 50))\n        \n        # éšæœºæŠ–åŠ¨ä½ç½®ï¼Œé˜²æ­¢è¿‡æ‹Ÿåˆ\n        off_x, off_y = random.randint(-50, 50), random.randint(-50, 50)\n        text_x = WIDTH // 2 - text_surf.get_width() // 2 + off_x\n        text_y = HEIGHT // 2 - 100 + off_y\n        screen.blit(text_surf, (text_x, text_y))\n\n        # å¹²æ‰°é¡¹\n        score_surf = font_small.render(f\"Score: {random.randint(0,999)}\", True, (255,255,255))\n        screen.blit(score_surf, (WIDTH//2 - score_surf.get_width()//2, HEIGHT//2 + 50))\n\n        # è®°å½•æ ‡ç­¾\n        tw, th = text_surf.get_width(), text_surf.get_height()\n        tx, ty = (text_x + tw/2) * dw, (text_y + th/2) * dh\n        labels.append(f\"2 {tx:.6f} {ty:.6f} {tw*dw:.6f} {th*dh:.6f}\")\n\n    # ================= 4. ä¿å­˜é€»è¾‘ (æ ¸å¿ƒä¿®æ”¹) =================\n    pygame.display.flip()\n    \n    # é‡‡æ ·ç‡ï¼šä¸æ˜¯æ¯ä¸€å¸§éƒ½ä¿å­˜ï¼Œé˜²æ­¢é‡å¤åº¦è¿‡é«˜ (è¿™é‡Œè®¾ä¸º 30% æ¦‚ç‡ä¿å­˜)\n    if random.random() &lt; 0.3:\n        # A. å†³å®šæ˜¯å» Train è¿˜æ˜¯ Val\n        split_folder = \"train\" if random.random() &lt; TRAIN_RATIO else \"val\"\n        \n        # B. ç”Ÿæˆæ–‡ä»¶å\n        filename = f\"{img_count:06d}\"\n        img_save_path = os.path.join(DATASET_ROOT, split_folder, \"images\", f\"{filename}.jpg\")\n        lbl_save_path = os.path.join(DATASET_ROOT, split_folder, \"labels\", f\"{filename}.txt\")\n\n        # C. ä¿å­˜å›¾ç‰‡\n        pygame.image.save(screen, img_save_path)\n\n        # D. ä¿å­˜æ ‡ç­¾\n        with open(lbl_save_path, \"w\") as f:\n            f.write(\"\\n\".join(labels))\n\n        img_count += 1\n        \n        # æ‰“å°è¿›åº¦æ¡\n        print(f\"[{split_folder.upper()}] è¿›åº¦: {img_count}/{MAX_IMAGES}\", end=\"\\r\")\n\n    # åŠ é€Ÿæ¨¡æ‹Ÿï¼Œä¸è¦å‚ç›´åŒæ­¥ï¼Œè¶Šå¿«è¶Šå¥½\n    clock.tick(0) \n\npygame.quit()\nprint(f\"\\n\\nâœ¨ å…¨éƒ¨å®Œæˆï¼æ•°æ®é›†å·²å°±ç»ªï¼š{os.path.abspath(DATASET_ROOT)}\")\nprint(\"ğŸ’¡ ä¸‹ä¸€æ­¥ï¼šç›´æ¥è¿è¡Œ model.train(data='my_dataset/data.yaml')\")\n</code></pre>\n<h1 id=\"ä¸‰è®­ç»ƒyoloæ¨¡å‹\">ä¸‰ï¼Œè®­ç»ƒYOLOæ¨¡å‹</h1>\n<p>å¯ä»¥çœ‹åˆ°ï¼Œä½¿ç”¨<code>ultralytics</code>æ¡†æ¶è®­ç»ƒYOLOçš„ä»£ç éå¸¸ç®€å•ï¼Œåªéœ€è¦å‡ è¡Œ<br />\n<strong>æ³¨æ„ï¼šè¿™é‡ŒYOLOä¼šè‡ªåŠ¨ä¸‹è½½æ¨¡å‹å¹¶è®­ç»ƒï¼Œä¸‹è½½æ—¶å¤±è´¥å¯èƒ½éœ€è¦æŒ‚æ¢¯å­</strong></p>\n<pre><code class=\"language-python\">from ultralytics import YOLO\n\ndef train_model():\n    #åŠ è½½æ¨¡å‹\n    model = YOLO(\"yolo11n.pt\") \n\n    #å¼€å§‹è®­ç»ƒ\n    print(\"å¼€å§‹è®­ç»ƒ...\")\n    results = model.train(\n        data=\"my_dataset/data.yaml\", #æ•°æ®é›†é…ç½®æ–‡ä»¶\n        epochs=30, #è®­ç»ƒè½®æ•°\n        imgsz=640, #å›¾ç‰‡è¾“å…¥å°ºå¯¸\n        batch=16, #æ˜¾å­˜å¤Ÿå¤§å¯ä»¥æ”¹å¤§ï¼Œæ¯”å¦‚ 32 æˆ– 64\n        device=0, #å¼ºåˆ¶ä½¿ç”¨ç¬¬ä¸€å¼ æ˜¾å¡ (éœ€è¦CUDA)\n        workers=0, #Windowsä¸‹è®¾ä¸º0é˜²æ­¢å¤šè¿›ç¨‹æŠ¥é”™\n        project=\"dodge_project\",#ä¿å­˜è·¯å¾„\n        name=\"ai_model\" #è®­ç»ƒè¿è¡Œåç§°\n    )\n    print(f\"è®­ç»ƒå®Œæˆï¼æœ€ä½³æ¨¡å‹ä¿å­˜åœ¨: {results.save_dir}/weights/best.pt\")\n\nif __name__ == \"__main__\":\n    train_model()\n</code></pre>\n<h1 id=\"å››ä½¿ç”¨yoloæ¨¡å‹\">å››ï¼Œä½¿ç”¨YOLOæ¨¡å‹</h1>\n<pre><code class=\"language-python\">from ultralytics import YOLO\n\n#é…ç½®è·¯å¾„\nMODEL_PATH = \"dodge_project/ai_model/weights/best.pt\" \nPIC_PATH = \"my_dataset/val/images/000045.jpg\"\n\n#åŠ è½½æ¨¡å‹\nmodel = YOLO(MODEL_PATH)\nprint(f\"æ¨¡å‹åŠ è½½æˆåŠŸ\")\n\n#è¯†åˆ«å›¾ç‰‡\nresults = model.predict(PIC_PATH, verbose=False, conf=0.4, imgsz=640)\nresult = results[0]\n\n#è·å–ä¿¡æ¯å¹¶æ‰“å°\nfor box in result.boxes:\n    # è·å–åæ ‡ (x1, y1, x2, y2)ã€ç±»åˆ« ID å’Œç½®ä¿¡åº¦\n    x1, y1, x2, y2 = map(int, box.xyxy[0])\n    cls_id = int(box.cls[0])\n    conf = float(box.conf[0])\n    \n    # ç±»åˆ«åç§°æ˜ å°„\n    names = {0: \"Player\", 1: \"Enemy\", 2: \"Game Over\"}\n    label = names.get(cls_id, f\"Unknown({cls_id})\")\n    print(f\"æ‰¾åˆ°ç‰©ä½“: [{label:10}] | ç½®ä¿¡åº¦: {conf:.2f} | åæ ‡: ({x1}, {y1}) -&gt; ({x2}, {y2})\")\n\n#å±•ç¤ºå›¾ç‰‡\nresult.show()\n</code></pre>\n<p><strong>å¦‚æœâ¤å–œæ¬¢â¤æœ¬ç³»åˆ—æ•™ç¨‹ï¼Œå°±ç‚¹ä¸ªå…³æ³¨å§ï¼Œåç»­ä¸å®šæœŸæ›´æ–°~</strong></p>\n\n\n</div>\n<div class=\"clear\"></div>\n\n            </div>\n            <div class=\"postDesc\">posted @ \n<span id=\"post-date\">2026-01-31 21:54</span>&nbsp;\n<a href=\"https://www.cnblogs.com/ClownLMe\">ClownLMe</a>&nbsp;\né˜…è¯»(<span id=\"post_view_count\">133</span>)&nbsp;\nè¯„è®º(<span id=\"post_comment_count\">0</span>)&nbsp;\n&nbsp;\n<a href=\"\">æ”¶è—</a>&nbsp;\n<a href=\"\">ä¸¾æŠ¥</a>\n</div>"
    },
    {
      "title": "Rediså¿«é€Ÿå®ç°å¸ƒéš†è¿‡æ»¤å™¨ï¼šç¼“å­˜å»é‡çš„â€œæ™ºèƒ½é—¨å«â€",
      "link": "https://www.cnblogs.com/sun-10387834/p/19522155",
      "published": "",
      "description": "<h1 class=\"postTitle\">\n                <a class=\"postTitle2 vertical-middle\" href=\"https://www.cnblogs.com/sun-10387834/p/19522155\" id=\"cb_post_title_url\" title=\"å‘å¸ƒäº 2026-01-31 18:32\">\n    <span>Rediså¿«é€Ÿå®ç°å¸ƒéš†è¿‡æ»¤å™¨ï¼šç¼“å­˜å»é‡çš„â€œæ™ºèƒ½é—¨å«â€</span>\n    \n\n</a>\n\n            </h1>\n            <div class=\"clear\"></div>\n            <div class=\"postBody\">\n                <div class=\"blogpost-body cnblogs-markdown\" id=\"cnblogs_post_body\">\n<p>åœ¨ç¼“å­˜æ¶æ„ä¸­ï¼Œæ€»æœ‰ä¸€äº›â€œå¤´ç–¼é—®é¢˜â€ï¼šç”¨æˆ·åå¤æäº¤ç›¸åŒè¯·æ±‚ã€æŸ¥è¯¢ä¸å­˜åœ¨çš„keyå¯¼è‡´ç¼“å­˜ç©¿é€ã€æµ·é‡æ•°æ®å»é‡æ•ˆç‡ä½ä¸‹â€¦â€¦è¿™äº›åœºæ™¯ä¸‹ï¼ŒRediså¸ƒéš†è¿‡æ»¤å™¨å°±æ˜¯å½“ä¹‹æ— æ„§çš„â€œæ•‘æ˜Ÿâ€ã€‚å®ƒåƒä¸€ä¸ªæ™ºèƒ½é—¨å«ï¼Œèƒ½å¿«é€Ÿåˆ¤æ–­â€œè¿™ä¸ªäººæ˜¯ä¸æ˜¯æ¥è¿‡â€â€œè¿™ä¸ªkeyæ˜¯ä¸æ˜¯ä¸å­˜åœ¨â€ï¼Œç”¨æå°çš„ç©ºé—´æˆæœ¬å®ç°é«˜æ•ˆè¿‡æ»¤ï¼Œæ€§èƒ½è¿œè¶…ä¼ ç»Ÿçš„æ•°æ®åº“æŸ¥è¯¢æˆ–å…¨é‡ç¼“å­˜æ ¡éªŒã€‚</p>\n<p>ä»Šå¤©å’±ä»¬å°±ä»â€œæ˜¯ä»€ä¹ˆã€ä¸ºä»€ä¹ˆå¥½ç”¨ã€æ€ä¹ˆç”¨Rediså¿«é€Ÿå®ç°â€ä¸‰ä¸ªç»´åº¦ï¼Œç”¨é€šä¿—çš„è¯­è¨€+å®æ“ä»£ç ï¼ŒæŠŠå¸ƒéš†è¿‡æ»¤å™¨è®²é€ã€‚å…¨ç¨‹é¿å¼€å¤æ‚å…¬å¼ï¼Œå°±ç®—æ˜¯åˆšæ¥è§¦ç¼“å­˜çš„åŒå­¦ï¼Œä¹Ÿèƒ½è·Ÿç€æ­¥éª¤å¿«é€Ÿè½åœ°ã€‚</p>\n<h2 id=\"ä¸€å…ˆææ‡‚å¸ƒéš†è¿‡æ»¤å™¨åˆ°åº•æ˜¯ä¸ªå•¥\">ä¸€ã€å…ˆææ‡‚ï¼šå¸ƒéš†è¿‡æ»¤å™¨åˆ°åº•æ˜¯ä¸ªå•¥ï¼Ÿ</h2>\n<p>å¸ƒéš†è¿‡æ»¤å™¨ï¼ˆBloom Filterï¼‰æœ¬è´¨æ˜¯ä¸€ä¸ª<strong>åŸºäºå“ˆå¸Œå‡½æ•°çš„æ¦‚ç‡å‹æ•°æ®ç»“æ„</strong>ï¼Œæ ¸å¿ƒä½œç”¨æ˜¯â€œå¿«é€Ÿåˆ¤æ–­ä¸€ä¸ªå…ƒç´ æ˜¯å¦å­˜åœ¨äºé›†åˆä¸­â€ã€‚å®ƒä¸åƒå“ˆå¸Œè¡¨é‚£æ ·å­˜å‚¨å®Œæ•´æ•°æ®ï¼Œè€Œæ˜¯ç”¨ä¸€ä¸ªäºŒè¿›åˆ¶æ•°ç»„ï¼ˆbitæ•°ç»„ï¼‰+å¤šä¸ªå“ˆå¸Œå‡½æ•°ï¼Œé€šè¿‡æ ‡è®°å…ƒç´ çš„å“ˆå¸Œä½ç½®æ¥å®ç°è¿‡æ»¤ã€‚</p>\n<p>å’±ä»¬ç”¨â€œå°åŒºé—¨å«è®°è®¿å®¢â€çš„åœºæ™¯ç±»æ¯”ï¼Œç§’æ‡‚æ ¸å¿ƒé€»è¾‘ï¼š</p>\n<ul>\n<li>\n<p>äºŒè¿›åˆ¶æ•°ç»„ = é—¨å«çš„ç™»è®°æœ¬ï¼Œæ¯ä¸€é¡µåªæœ‰â€œæ˜¯â€ï¼ˆ1ï¼‰å’Œâ€œå¦â€ï¼ˆ0ï¼‰ä¸¤ä¸ªçŠ¶æ€ï¼›</p>\n</li>\n<li>\n<p>å“ˆå¸Œå‡½æ•° = é—¨å«çš„â€œè®°å¿†è§„åˆ™â€ï¼Œæ¯”å¦‚â€œè®°ä½è®¿å®¢çš„å§“æ°é¦–å­—æ¯+èº«é«˜åŒºé—´+é‹å­é¢œè‰²â€ï¼›</p>\n</li>\n<li>\n<p>å…ƒç´ å­˜åœ¨åˆ¤æ–­ = é—¨å«æ ¹æ®è®°å¿†è§„åˆ™æ ¸å¯¹ç™»è®°æœ¬ï¼Œåªè¦æœ‰ä¸€æ¡è§„åˆ™å¯¹åº”â€œå¦â€ï¼Œå°±ç¡®å®šè®¿å®¢æ²¡æ¥è¿‡ï¼›å¦‚æœå…¨æ˜¯â€œæ˜¯â€ï¼Œåˆ™å¤§æ¦‚ç‡æ¥è¿‡ï¼ˆå­˜åœ¨æå°è¯¯åˆ¤ï¼‰ã€‚</p>\n</li>\n</ul>\n<h3 id=\"æ ¸å¿ƒç‰¹æ€§ä¼˜ç‚¹ä¸å°ç‘•ç–µ\">æ ¸å¿ƒç‰¹æ€§ï¼šä¼˜ç‚¹ä¸â€œå°ç‘•ç–µâ€</h3>\n<p>å¸ƒéš†è¿‡æ»¤å™¨çš„ä¼˜åŠ¿å’Œå±€é™æ€§éƒ½å¾ˆé²œæ˜ï¼Œè½åœ°å‰å¿…é¡»æ‘¸æ¸…ï¼š</p>\n<h4 id=\"-æ ¸å¿ƒä¼˜ç‚¹\">âœ… æ ¸å¿ƒä¼˜ç‚¹</h4>\n<ul>\n<li>\n<p>ç©ºé—´å ç”¨æå°ï¼šä»…ç”¨bitæ•°ç»„å­˜å‚¨æ ‡è®°ï¼Œå­˜å‚¨100ä¸‡æ¡æ•°æ®ï¼Œè¯¯åˆ¤ç‡1%æ—¶ï¼Œä»…éœ€çº¦1.2MBç©ºé—´ï¼›</p>\n</li>\n<li>\n<p>æŸ¥è¯¢é€Ÿåº¦æå¿«ï¼šæ—¶é—´å¤æ‚åº¦æ˜¯O(k)ï¼ˆkæ˜¯å“ˆå¸Œå‡½æ•°ä¸ªæ•°ï¼‰ï¼Œæ— è®ºæ•°æ®é‡å¤šå¤§ï¼Œéƒ½èƒ½ç¬é—´è¿”å›ç»“æœï¼›</p>\n</li>\n<li>\n<p>æ”¯æŒæµ·é‡æ•°æ®ï¼šæ— éœ€å­˜å‚¨å®Œæ•´æ•°æ®ï¼Œå¯è½»æ¾åº”å¯¹åƒä¸‡çº§ã€äº¿çº§æ•°æ®çš„è¿‡æ»¤åœºæ™¯ã€‚</p>\n</li>\n</ul>\n<h4 id=\"-ä¸å¯å¿½è§†çš„å±€é™æ€§\">âŒ ä¸å¯å¿½è§†çš„å±€é™æ€§</h4>\n<ul>\n<li>\n<p>å­˜åœ¨è¯¯åˆ¤ç‡ï¼šåªèƒ½ç¡®å®šâ€œå…ƒç´ ä¸€å®šä¸å­˜åœ¨â€ï¼Œä¸èƒ½100%ç¡®å®šâ€œå…ƒç´ ä¸€å®šå­˜åœ¨â€ï¼Œè¯¯åˆ¤ç‡å¯é€šè¿‡å‚æ•°è°ƒæ•´ï¼Œä½†æ— æ³•å®Œå…¨æ¶ˆé™¤ï¼›</p>\n</li>\n<li>\n<p>ä¸æ”¯æŒåˆ é™¤æ“ä½œï¼šä¸€æ—¦å…ƒç´ è¢«æ ‡è®°åˆ°bitæ•°ç»„ï¼Œæ— æ³•åå‘æ¸…é™¤ï¼ˆä¼šå½±å“å…¶ä»–å…ƒç´ çš„åˆ¤æ–­ï¼‰ï¼›</p>\n</li>\n<li>\n<p>éœ€æå‰é¢„ä¼°æ•°æ®é‡ï¼šå“ˆå¸Œå‡½æ•°ä¸ªæ•°ã€bitæ•°ç»„é•¿åº¦éœ€æ ¹æ®é¢„ä¼°æ•°æ®é‡è®¡ç®—ï¼Œå¦åˆ™ä¼šå¯¼è‡´è¯¯åˆ¤ç‡é£™å‡ã€‚</p>\n</li>\n</ul>\n<h2 id=\"äºŒrediså®ç°å¸ƒéš†è¿‡æ»¤å™¨çš„ä¸¤ç§æ–¹å¼\">äºŒã€Rediså®ç°å¸ƒéš†è¿‡æ»¤å™¨çš„ä¸¤ç§æ–¹å¼</h2>\n<p>Redisæœ¬èº«æ²¡æœ‰å†…ç½®å¸ƒéš†è¿‡æ»¤å™¨ï¼Œä½†æä¾›äº†ä¸¤ç§å¿«é€Ÿå®ç°çš„æ–¹æ¡ˆï¼šä¸€æ˜¯åŸºäºRedisçš„BitMapï¼ˆä½å›¾ï¼‰æ‰‹åŠ¨å®ç°ï¼Œçµæ´»å¯æ§ï¼›äºŒæ˜¯ä½¿ç”¨Rediså®˜æ–¹æ¨èçš„Redissonå®¢æˆ·ç«¯ï¼Œå°è£…å¥½ç°æˆAPIï¼Œå¼€ç®±å³ç”¨ã€‚å’±ä»¬åˆ†åˆ«è®²å®æ“ï¼ŒæŒ‰éœ€é€‰æ‹©å³å¯ã€‚</p>\n<h3 id=\"æ–¹æ¡ˆä¸€åŸºäºbitmapæ‰‹åŠ¨å®ç°çµæ´»å¯æ§\">æ–¹æ¡ˆä¸€ï¼šåŸºäºBitMapæ‰‹åŠ¨å®ç°ï¼ˆçµæ´»å¯æ§ï¼‰</h3>\n<p>æ ¸å¿ƒæ€è·¯ï¼šåˆ©ç”¨Redisçš„BitMapæ•°æ®ç»“æ„ä½œä¸ºå¸ƒéš†è¿‡æ»¤å™¨çš„bitæ•°ç»„ï¼Œé€šè¿‡å¤šä¸ªå“ˆå¸Œå‡½æ•°è®¡ç®—å…ƒç´ çš„å“ˆå¸Œå€¼ï¼Œå°†å¯¹åº”ä½ç½®çš„bitç½®ä¸º1ï¼›æŸ¥è¯¢æ—¶ï¼ŒåŒæ ·è®¡ç®—å“ˆå¸Œå€¼ï¼Œæ£€æŸ¥æ‰€æœ‰ä½ç½®æ˜¯å¦ä¸º1ï¼Œå…¨ä¸º1åˆ™å¤§æ¦‚ç‡å­˜åœ¨ï¼Œå¦åˆ™ä¸€å®šä¸å­˜åœ¨ã€‚</p>\n<h4 id=\"1-å…³é”®å‚æ•°è®¡ç®—é¿å…è¯¯åˆ¤ç‡è¿‡é«˜\">1. å…³é”®å‚æ•°è®¡ç®—ï¼ˆé¿å…è¯¯åˆ¤ç‡è¿‡é«˜ï¼‰</h4>\n<p>æ‰‹åŠ¨å®ç°å‰ï¼Œéœ€å…ˆç¡®å®šä¸‰ä¸ªæ ¸å¿ƒå‚æ•°ï¼Œå¯é€šè¿‡å…¬å¼æˆ–åœ¨çº¿å·¥å…·è®¡ç®—ï¼š</p>\n<ul>\n<li>\n<p>mï¼šbitæ•°ç»„é•¿åº¦ï¼ˆå•ä½ï¼šbitï¼‰ï¼Œé¢„ä¼°æ•°æ®é‡nè¶Šå¤§ï¼Œméœ€è¶Šå¤§ï¼›</p>\n</li>\n<li>\n<p>kï¼šå“ˆå¸Œå‡½æ•°ä¸ªæ•°ï¼Œkè¿‡å¤šä¼šå¯¼è‡´bitæ•°ç»„å¿«é€Ÿè¢«å æ»¡ï¼Œè¯¯åˆ¤ç‡ä¸Šå‡ï¼›kè¿‡å°‘åˆ™è¿‡æ»¤æ•ˆæœå·®ï¼›</p>\n</li>\n<li>\n<p>pï¼šå¯æ¥å—çš„è¯¯åˆ¤ç‡ï¼ˆé€šå¸¸è®¾ä¸º0.01~0.1ï¼‰ã€‚</p>\n</li>\n</ul>\n<p>å¸¸ç”¨è®¡ç®—å…¬å¼ï¼ˆæ— éœ€æ­»è®°ï¼Œåœ¨çº¿å·¥å…·ç›´æ¥ç®—ï¼‰ï¼š</p>\n<ul>\n<li>\n<p>m = - (n * ln p) / (ln 2)Â² ï¼ˆbitæ•°ç»„é•¿åº¦ï¼‰ï¼›</p>\n</li>\n<li>\n<p>k = (m / n) * ln 2 ï¼ˆå“ˆå¸Œå‡½æ•°ä¸ªæ•°ï¼‰ã€‚</p>\n</li>\n</ul>\n<p>ä¸¾ä¸ªä¾‹å­ï¼šé¢„ä¼°å­˜å‚¨10ä¸‡æ¡æ•°æ®ï¼Œè¯¯åˆ¤ç‡è®¾ä¸º0.01ï¼Œè®¡ç®—å¾—mâ‰ˆ958505 bitï¼ˆçº¦117KBï¼‰ï¼Œkâ‰ˆ7ä¸ªå“ˆå¸Œå‡½æ•°ã€‚</p>\n<h4 id=\"2-æ‰‹åŠ¨å®ç°ä»£ç javaç¤ºä¾‹\">2. æ‰‹åŠ¨å®ç°ä»£ç ï¼ˆJavaç¤ºä¾‹ï¼‰</h4>\n<p>æ ¸å¿ƒæ˜¯å®ç°å¤šä¸ªå“ˆå¸Œå‡½æ•°ï¼Œæ“ä½œRedisçš„BitMapæŒ‡ä»¤ï¼ˆSETBITç½®1ï¼ŒGETBITæŸ¥è¯¢ï¼‰ï¼š</p>\n<pre><code class=\"language-java\">import org.springframework.data.redis.core.StringRedisTemplate;\nimport java.nio.charset.StandardCharsets;\nimport java.security.MessageDigest;\nimport java.security.NoSuchAlgorithmException;\n\n/**\n * åŸºäºRedis BitMapæ‰‹åŠ¨å®ç°å¸ƒéš†è¿‡æ»¤å™¨\n */\npublic class RedisBloomFilter {\n    // Redisé”®å\n    private final String key;\n    // bitæ•°ç»„é•¿åº¦\n    private final long bitSize;\n    // å“ˆå¸Œå‡½æ•°ä¸ªæ•°\n    private final int hashCount;\n    private final StringRedisTemplate stringRedisTemplate;\n\n    // æ„é€ å™¨ï¼šåˆå§‹åŒ–å‚æ•°\n    public RedisBloomFilter(String key, long n, double p, StringRedisTemplate stringRedisTemplate) {\n        this.key = key;\n        this.stringRedisTemplate = stringRedisTemplate;\n        // è®¡ç®—bitæ•°ç»„é•¿åº¦\n        this.bitSize = (long) (-n * Math.log(p) / (Math.log(2) * Math.log(2)));\n        // è®¡ç®—å“ˆå¸Œå‡½æ•°ä¸ªæ•°\n        this.hashCount = (int) (this.bitSize / n * Math.log(2));\n    }\n\n    // æ·»åŠ å…ƒç´ åˆ°å¸ƒéš†è¿‡æ»¤å™¨\n    public void add(Object value) {\n        byte[] bytes = value.toString().getBytes(StandardCharsets.UTF_8);\n        long[] hashes = hash(bytes, hashCount, bitSize);\n        for (long hash : hashes) {\n            // æŠŠå¯¹åº”bitä½ç½®ç½®ä¸º1\n            stringRedisTemplate.opsForValue().setBit(key, hash, true);\n        }\n    }\n\n    // åˆ¤æ–­å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼ˆå­˜åœ¨è¿”å›trueï¼Œä¸å­˜åœ¨è¿”å›falseï¼›trueå¯èƒ½æ˜¯è¯¯åˆ¤ï¼‰\n    public boolean contains(Object value) {\n        byte[] bytes = value.toString().getBytes(StandardCharsets.UTF_8);\n        long[] hashes = hash(bytes, hashCount, bitSize);\n        for (long hash : hashes) {\n            // åªè¦æœ‰ä¸€ä¸ªbitä½ä¸º0ï¼Œå°±ç¡®å®šä¸å­˜åœ¨\n            if (!stringRedisTemplate.opsForValue().getBit(key, hash)) {\n                return false;\n            }\n        }\n        return true;\n    }\n\n    // å¤šå“ˆå¸Œå‡½æ•°å®ç°ï¼ˆåŸºäºMD5æ‹†åˆ†ï¼‰\n    private long[] hash(byte[] bytes, int hashCount, long bitSize) {\n        long[] hashes = new long[hashCount];\n        try {\n            MessageDigest md5 = MessageDigest.getInstance(\"MD5\");\n            byte[] digest = md5.digest(bytes);\n            // æŠŠMD5ç»“æœï¼ˆ16å­—èŠ‚ï¼‰æ‹†åˆ†æˆå¤šä¸ªå“ˆå¸Œå€¼\n            for (int i = 0; i &lt; hashCount; i++) {\n                long hash = 0;\n                for (int j = i * 2; j &lt; (i + 1) * 2 &amp;&amp; j &lt; digest.length; j++) {\n                    hash = hash * 256 + (digest[j] &amp; 0xFF);\n                }\n                // ç¡®ä¿å“ˆå¸Œå€¼åœ¨bitæ•°ç»„é•¿åº¦èŒƒå›´å†…\n                hashes[i] = hash % bitSize;\n            }\n        } catch (NoSuchAlgorithmException e) {\n            throw new RuntimeException(\"å“ˆå¸Œå‡½æ•°åˆå§‹åŒ–å¤±è´¥\", e);\n        }\n        return hashes;\n    }\n}\n</code></pre>\n<h4 id=\"3-ä½¿ç”¨æ–¹å¼\">3. ä½¿ç”¨æ–¹å¼</h4>\n<pre><code class=\"language-java\">// åˆå§‹åŒ–å¸ƒéš†è¿‡æ»¤å™¨ï¼škeyä¸º\"user:bloom:filter\"ï¼Œé¢„ä¼°10ä¸‡æ¡æ•°æ®ï¼Œè¯¯åˆ¤ç‡0.01\nRedisBloomFilter bloomFilter = new RedisBloomFilter(\"user:bloom:filter\", 100000, 0.01, stringRedisTemplate);\n\n// æ·»åŠ å…ƒç´ \nbloomFilter.add(\"user123\");\nbloomFilter.add(\"order456\");\n\n// åˆ¤æ–­å…ƒç´ æ˜¯å¦å­˜åœ¨\nboolean exists = bloomFilter.contains(\"user123\"); // å¤§æ¦‚ç‡è¿”å›true\nboolean notExists = bloomFilter.contains(\"user789\"); // ä¸€å®šè¿”å›false\n</code></pre>\n<h3 id=\"æ–¹æ¡ˆäºŒredissonå®¢æˆ·ç«¯å®ç°å¼€ç®±å³ç”¨\">æ–¹æ¡ˆäºŒï¼šRedissonå®¢æˆ·ç«¯å®ç°ï¼ˆå¼€ç®±å³ç”¨ï¼‰</h3>\n<p>å¦‚æœè§‰å¾—æ‰‹åŠ¨å®ç°éº»çƒ¦ï¼Œæ¨èç”¨Redissonâ€”â€”Rediså®˜æ–¹ç”Ÿæ€çš„Javaå®¢æˆ·ç«¯ï¼Œå·²ç»å°è£…å¥½äº†å¸ƒéš†è¿‡æ»¤å™¨ï¼Œæ”¯æŒè‡ªåŠ¨è®¡ç®—å‚æ•°ã€åˆ†å¸ƒå¼åœºæ™¯ï¼Œè¿˜è§£å†³äº†æ‰‹åŠ¨å®ç°çš„å“ˆå¸Œå‡½æ•°ä¼˜åŒ–é—®é¢˜ï¼Œç”Ÿäº§ç¯å¢ƒé¦–é€‰ã€‚</p>\n<h4 id=\"1-å¼•å…¥ä¾èµ–\">1. å¼•å…¥ä¾èµ–</h4>\n<pre><code class=\"language-xml\">&lt;dependency&gt;\n    &lt;groupId&gt;org.redisson&lt;/groupId&gt;\n    &lt;artifactId&gt;redisson-spring-boot-starter&lt;/artifactId&gt;\n    &lt;version&gt;3.23.3&lt;/version&gt; // ç‰ˆæœ¬ä¸Redisç‰ˆæœ¬é€‚é…\n&lt;/dependency&gt;\n</code></pre>\n<h4 id=\"2-å¿«é€Ÿå®ç°ä»£ç \">2. å¿«é€Ÿå®ç°ä»£ç </h4>\n<pre><code class=\"language-java\">import org.redisson.api.RBloomFilter;\nimport org.redisson.api.RedissonClient;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.stereotype.Component;\n\n@Component\npublic class RedissonBloomFilterDemo {\n    @Autowired\n    private RedissonClient redissonClient;\n\n    // åˆå§‹åŒ–å¸ƒéš†è¿‡æ»¤å™¨\n    public RBloomFilter&lt;String&gt; initBloomFilter() {\n        // å¸ƒéš†è¿‡æ»¤å™¨åç§°\n        String filterName = \"user:bloom:filter:redisson\";\n        // è·å–å¸ƒéš†è¿‡æ»¤å™¨å®ä¾‹\n        RBloomFilter&lt;String&gt; bloomFilter = redissonClient.getBloomFilter(filterName);\n        // åˆå§‹åŒ–ï¼šé¢„ä¼°10ä¸‡æ¡æ•°æ®ï¼Œè¯¯åˆ¤ç‡0.01ï¼ˆRedissonä¼šè‡ªåŠ¨è®¡ç®—må’Œkï¼‰\n        bloomFilter.tryInit(100000, 0.01);\n        return bloomFilter;\n    }\n\n    // æµ‹è¯•ä½¿ç”¨\n    public void testBloomFilter() {\n        RBloomFilter&lt;String&gt; bloomFilter = initBloomFilter();\n        // æ·»åŠ å…ƒç´ \n        bloomFilter.add(\"user123\");\n        bloomFilter.add(\"order456\");\n\n        // åˆ¤æ–­å…ƒç´ æ˜¯å¦å­˜åœ¨\n        boolean exists = bloomFilter.contains(\"user123\"); // å¤§æ¦‚ç‡true\n        boolean notExists = bloomFilter.contains(\"user789\"); // ä¸€å®šfalse\n\n        // ç»Ÿè®¡å·²æ·»åŠ å…ƒç´ æ•°é‡ï¼ˆè¿‘ä¼¼å€¼ï¼‰\n        long count = bloomFilter.count();\n        System.out.println(\"å·²æ·»åŠ å…ƒç´ æ•°é‡ï¼š\" + count);\n    }\n}\n</code></pre>\n<h4 id=\"3-æ ¸å¿ƒä¼˜åŠ¿\">3. æ ¸å¿ƒä¼˜åŠ¿</h4>\n<ul>\n<li>\n<p>åˆ†å¸ƒå¼æ”¯æŒï¼šé€‚é…å¾®æœåŠ¡åœºæ™¯ï¼Œå¤šå®ä¾‹å…±äº«åŒä¸€ä¸ªå¸ƒéš†è¿‡æ»¤å™¨ï¼Œæ— éœ€æ‹…å¿ƒæ•°æ®ä¸€è‡´æ€§ï¼›</p>\n</li>\n<li>\n<p>å‚æ•°ä¼˜åŒ–ï¼šå†…ç½®æ›´é«˜æ•ˆçš„å“ˆå¸Œå‡½æ•°ï¼ˆMurmurHashï¼‰ï¼Œè¯¯åˆ¤ç‡æ§åˆ¶æ›´ç²¾å‡†ï¼›</p>\n</li>\n<li>\n<p>APIä¸°å¯Œï¼šæ”¯æŒå…ƒç´ è®¡æ•°ã€æ‰¹é‡æ·»åŠ ç­‰åŠŸèƒ½ï¼Œæ¯”æ‰‹åŠ¨å®ç°æ›´å®Œå–„ã€‚</p>\n</li>\n</ul>\n<h2 id=\"ä¸‰å®é™…åº”ç”¨åœºæ™¯ä¸é¿å‘æŒ‡å—\">ä¸‰ã€å®é™…åº”ç”¨åœºæ™¯ä¸é¿å‘æŒ‡å—</h2>\n<h3 id=\"-å…¸å‹åº”ç”¨åœºæ™¯\">âœ… å…¸å‹åº”ç”¨åœºæ™¯</h3>\n<ol>\n<li>\n<p>ç¼“å­˜ç©¿é€é˜²æŠ¤ï¼šæŸ¥è¯¢æ•°æ®åº“å‰ï¼Œå…ˆç”¨å¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­keyæ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™ç›´æ¥è¿”å›ï¼Œé¿å…å¤§é‡æ— æ•ˆæ•°æ®åº“æŸ¥è¯¢ï¼›</p>\n</li>\n<li>\n<p>æµ·é‡æ•°æ®å»é‡ï¼šæ¯”å¦‚ç”¨æˆ·ç­¾åˆ°ã€æ—¥å¿—å»é‡ã€çˆ¬è™«URLå»é‡ï¼Œæ— éœ€å­˜å‚¨å…¨é‡æ•°æ®ï¼Œä»…ç”¨bitæ•°ç»„æ ‡è®°ï¼›</p>\n</li>\n<li>\n<p>é˜²æ­¢é‡å¤æäº¤ï¼šæ¥å£è¯·æ±‚å‰ï¼Œç”¨å¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­è¯·æ±‚IDæ˜¯å¦å·²å¤„ç†ï¼Œé¿å…é‡å¤ä¸šåŠ¡é€»è¾‘æ‰§è¡Œï¼›</p>\n</li>\n<li>\n<p>é»‘åå•è¿‡æ»¤ï¼šæ¯”å¦‚åƒåœ¾é‚®ä»¶è¯†åˆ«ã€æ¶æ„IPæ‹¦æˆªï¼Œå¿«é€Ÿåˆ¤æ–­æ˜¯å¦åœ¨é»‘åå•ä¸­ã€‚</p>\n</li>\n</ol>\n<h3 id=\"-é¿å‘æŒ‡å—\">âŒ é¿å‘æŒ‡å—</h3>\n<ul>\n<li>\n<p>ä¸è¦ç”¨åœ¨â€œç»å¯¹ä¸èƒ½è¯¯åˆ¤â€çš„åœºæ™¯ï¼šæ¯”å¦‚é‡‘èäº¤æ˜“ã€ç”¨æˆ·ç™»å½•éªŒè¯ï¼Œè¯¯åˆ¤å¯èƒ½å¯¼è‡´ä¸¥é‡é—®é¢˜ï¼›</p>\n</li>\n<li>\n<p>æå‰é¢„ä¼°æ•°æ®é‡ï¼šè‹¥å®é™…æ•°æ®é‡è¿œè¶…é¢„ä¼°ï¼Œbitæ•°ç»„ä¼šè¢«å¿«é€Ÿå æ»¡ï¼Œè¯¯åˆ¤ç‡ä¼šæ€¥å‰§ä¸Šå‡ï¼Œå¯é¢„ç•™2~3å€å†—ä½™ï¼›</p>\n</li>\n<li>\n<p>å®šæœŸé‡ç½®å¸ƒéš†è¿‡æ»¤å™¨ï¼šè‹¥æ•°æ®æœ‰è¿‡æœŸç‰¹æ€§ï¼ˆæ¯”å¦‚æ¯æ—¥é»‘åå•æ›´æ–°ï¼‰ï¼Œå¯å®šæœŸåˆ é™¤æ—§çš„å¸ƒéš†è¿‡æ»¤å™¨ï¼Œé‡å»ºæ–°å®ä¾‹ï¼›</p>\n</li>\n<li>\n<p>Redisé›†ç¾¤æ³¨æ„äº‹é¡¹ï¼šæ‰‹åŠ¨å®ç°çš„å¸ƒéš†è¿‡æ»¤å™¨è‹¥ç”¨åœ¨Redisé›†ç¾¤ä¸­ï¼Œéœ€ç¡®ä¿keyè½åœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ï¼ˆé¿å…å“ˆå¸Œåˆ†ç‰‡å¯¼è‡´bitæ•°ç»„åˆ†æ•£ï¼‰ï¼ŒRedissonå·²è‡ªåŠ¨å¤„ç†è¯¥é—®é¢˜ã€‚</p>\n</li>\n</ul>\n<h2 id=\"å››æ€»ç»“ä»€ä¹ˆæ—¶å€™é€‰å“ªç§å®ç°æ–¹å¼\">å››ã€æ€»ç»“ï¼šä»€ä¹ˆæ—¶å€™é€‰å“ªç§å®ç°æ–¹å¼ï¼Ÿ</h2>\n<p>Rediså¸ƒéš†è¿‡æ»¤å™¨çš„æ ¸å¿ƒä»·å€¼çš„æ˜¯â€œç”¨æå°ç©ºé—´æ¢æé«˜è¿‡æ»¤æ•ˆç‡â€ï¼Œè½åœ°æ—¶æŒ‰åœºæ™¯é€‰æ‹©å®ç°æ–¹å¼ï¼š</p>\n<ul>\n<li>\n<p>å¿«é€Ÿè½åœ°ã€ç”Ÿäº§ç¯å¢ƒã€åˆ†å¸ƒå¼åœºæ™¯ï¼šé€‰Redissonï¼Œçœå¿ƒé«˜æ•ˆï¼Œé€‚é…æ€§å¼ºï¼›</p>\n</li>\n<li>\n<p>å­¦ä¹ ç ”ç©¶ã€è‡ªå®šä¹‰å“ˆå¸Œå‡½æ•°ã€ç‰¹æ®Šå‚æ•°éœ€æ±‚ï¼šé€‰æ‰‹åŠ¨å®ç°ï¼Œçµæ´»å¯æ§ï¼ŒåŠ æ·±å¯¹åŸç†çš„ç†è§£ã€‚</p>\n</li>\n</ul>\n<p>å…¶å®å¸ƒéš†è¿‡æ»¤å™¨çš„é€»è¾‘å¹¶ä¸å¤æ‚ï¼Œæ ¸å¿ƒå°±æ˜¯â€œå“ˆå¸Œæ ‡è®°+æ¦‚ç‡åˆ¤æ–­â€ã€‚æŒæ¡å®ƒä¹‹åï¼Œé¢å¯¹ç¼“å­˜ç©¿é€ã€æµ·é‡å»é‡ç­‰é—®é¢˜ï¼Œå°±ä¸ç”¨å†é â€œå…¨é‡å­˜å‚¨â€è¿™ç§ç¬¨åŠæ³•ï¼Œèƒ½å¤§å¹…æå‡ç³»ç»Ÿæ€§èƒ½å’Œç©ºé—´åˆ©ç”¨ç‡ã€‚ä¸‹æ¬¡å†é‡åˆ°ç±»ä¼¼åœºæ™¯ï¼Œç›´æ¥æå‡ºRediså¸ƒéš†è¿‡æ»¤å™¨ï¼Œè½»æ¾æå®šï¼</p>\n\n\n</div>\n<div id=\"MySignature\">\n    \n<p>â¤ï¸ å¦‚æœä½ å–œæ¬¢è¿™ç¯‡æ–‡ç« ï¼Œè¯·ç‚¹èµæ”¯æŒï¼ ğŸ‘ åŒæ—¶æ¬¢è¿å…³æ³¨æˆ‘çš„åšå®¢ï¼Œè·å–æ›´å¤šç²¾å½©å†…å®¹ï¼</p>\n\n<p>æœ¬æ–‡æ¥è‡ªåšå®¢å›­ï¼Œä½œè€…ï¼š<a href=\"https://www.cnblogs.com/sun-10387834/\" target=\"_blank\">ä½›ç¥–è®©æˆ‘æ¥å·¡å±±</a>ï¼Œè½¬è½½è¯·æ³¨æ˜åŸæ–‡é“¾æ¥ï¼š<a href=\"https://www.cnblogs.com/sun-10387834/p/19522155\" target=\"_blank\">https://www.cnblogs.com/sun-10387834/p/19522155</a></p>\n\n\n</div>\n<div class=\"clear\"></div>\n\n            </div>\n            <div class=\"postDesc\">posted @ \n<span id=\"post-date\">2026-01-31 18:32</span>&nbsp;\n<a href=\"https://www.cnblogs.com/sun-10387834\">ä½›ç¥–è®©æˆ‘æ¥å·¡å±±</a>&nbsp;\né˜…è¯»(<span id=\"post_view_count\">98</span>)&nbsp;\nè¯„è®º(<span id=\"post_comment_count\">0</span>)&nbsp;\n&nbsp;\n<a href=\"\">æ”¶è—</a>&nbsp;\n<a href=\"\">ä¸¾æŠ¥</a>\n</div>"
    },
    {
      "title": "æ¶æ„å¸ˆå¿…å¤‡ï¼šç°åº¦æ–¹æ¡ˆæ±‡æ€»",
      "link": "https://www.cnblogs.com/toplist/p/19527704",
      "published": "",
      "description": "<h1 class=\"postTitle\">\n                <a class=\"postTitle2 vertical-middle\" href=\"https://www.cnblogs.com/toplist/p/19527704\" id=\"cb_post_title_url\" title=\"å‘å¸ƒäº 2026-01-31 17:35\">\n    <span>æ¶æ„å¸ˆå¿…å¤‡ï¼šç°åº¦æ–¹æ¡ˆæ±‡æ€»</span>\n    \n\n</a>\n\n            </h1>\n            <div class=\"clear\"></div>\n            <div class=\"postBody\">\n                <div class=\"blogpost-body cnblogs-markdown\" id=\"cnblogs_post_body\">\n<p>å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯Javaçƒ˜ç„™å¸ˆã€‚æœ¬æ–‡ç»“åˆç¬”è€…çš„ç»éªŒå’Œæ€è€ƒï¼Œå¯¹ç°åº¦æ–¹æ¡ˆåšä¸ªæ€»ç»“ï¼Œé‡ç‚¹ä»‹ç»ABå®éªŒã€‚</p>\n<p>ç°åº¦åœ¨å¼€å‘æµç¨‹ä¸­éå¸¸æ™®éã€‚å…ˆåšå°æµé‡éªŒè¯ï¼Œç¡®è®¤æ— è¯¯åå†æ¨å…¨ï¼Œç°åº¦è¿‡ç¨‹ä¸­ä¸€æ—¦å‘ç°ç³»ç»Ÿå¼‚å¸¸ã€æˆ–ä¸šåŠ¡æŒ‡æ ‡å¼‚å¸¸ï¼Œåº”ç«‹åˆ»å›æ»šã€‚</p>\n<h1 id=\"ç°åº¦åœºæ™¯\">ç°åº¦åœºæ™¯</h1>\n<ul>\n<li>ä»£ç ç°åº¦ï¼šæ˜¯æœ€å…¸å‹çš„ç°åº¦ï¼Œç°åº¦å†…åšæ–°é€»è¾‘ï¼Œç°åº¦å¤–åšæ—§é€»è¾‘\n<ul>\n<li>æ—¢å¯ä»¥æä¾›v2ç‰ˆæœ¬æ–°æ¥å£ç»™è°ƒç”¨æ–¹æœåŠ¡ï¼Œç”±è°ƒç”¨æ–¹æ¥åšç°åº¦åˆ‡æ¢</li>\n<li>ä¹Ÿå¯ä»¥å†…éƒ¨åˆ‡ç°åº¦ï¼Œåšåˆ°è°ƒç”¨æ–¹æ— æ„Ÿ</li>\n</ul>\n</li>\n<li>å‘ç‰ˆç°åº¦ï¼šä¸Šçº¿è¿‡ç¨‹ä¸­ï¼Œæ–°ç‰ˆæœ¬æœåŠ¡å®ä¾‹ä¸æ–­å¢åŠ ï¼Œéœ€è€ƒè™‘å…¼å®¹æ–°æ—§åè®®</li>\n<li>é…ç½®ç°åº¦ï¼šä¿®æ”¹é…ç½®æ—¶ï¼ŒæŒ‰æœåŠ¡å®ä¾‹ç°åº¦æ¨é€é…ç½®å˜æ›´</li>\n</ul>\n<h1 id=\"ç°åº¦æ¨¡å¼\">ç°åº¦æ¨¡å¼</h1>\n<ul>\n<li>æ•°å­—idå°¾å·ç°åº¦ï¼šå–idæœ€å2ä½ï¼ˆç™¾åˆ†æ¯”ï¼‰ã€æœ€å3ä½ï¼ˆåƒåˆ†æ¯”ï¼‰ã€æœ€å4ä½ï¼ˆä¸‡åˆ†æ¯”ï¼‰ç­‰\n<ul>\n<li>å®ç°æ–¹å¼ï¼šidå–æ¨¡ï¼Œä¾‹å¦‚ <code>id % 100 &lt; ç°åº¦ç™¾åˆ†æ¯”</code>ï¼Œåˆ™å‘½ä¸­ç°åº¦</li>\n<li>ç‰¹ç‚¹ï¼šç®€å•ï¼Œé€‚ç”¨äºç»å¤§éƒ¨åˆ†æŠ€æœ¯ä¼˜åŒ–åœºæ™¯</li>\n</ul>\n</li>\n<li>éšæœºç°åº¦ï¼šå–ä¸€éƒ¨åˆ†éšæœºæµé‡åšç°åº¦\n<ul>\n<li>å®ç°æ–¹å¼ï¼š<code>ThreadLocalRandom.current().nextInt(100) &lt; ç°åº¦ç™¾åˆ†æ¯”</code></li>\n<li>ä¹‹æ‰€ä»¥ä½¿ç”¨ThreadLocalRandomã€è€Œä¸æ˜¯Randomï¼Œæ˜¯ä¸ºäº†é¿å…å¤šçº¿ç¨‹ç«äº‰ç”¨äºç”Ÿæˆéšæœºæ•°çš„seed</li>\n</ul>\n</li>\n<li>A/Bå®éªŒ\n<ul>\n<li>å®ç°æ–¹å¼ï¼šåˆ†å±‚å®éªŒã€å®éªŒæ•°æ®æ”¶é›†ã€ç¦»çº¿ç»Ÿè®¡</li>\n<li>ç‰¹ç‚¹ï¼šé€‚ç”¨äºå°æµé‡éªŒè¯æ–°ä¸šåŠ¡åŠŸèƒ½çš„æ•ˆæœï¼Œæ•´ä½“æ–¹æ¡ˆç›¸å¯¹å¤æ‚ï¼Œéœ€è¦æŠ€æœ¯åŸºå»º</li>\n</ul>\n</li>\n</ul>\n<h1 id=\"idé€‰å–\">idé€‰å–</h1>\n<ul>\n<li>ä¸šåŠ¡idï¼šå¦‚ç”¨æˆ·idã€å•†å“idç­‰</li>\n<li>è®¾å¤‡idï¼šæœªæ³¨å†Œ/æœªç™»å½•ç”¨æˆ·ï¼Œæ­¤æ—¶æ²¡æœ‰ç”¨æˆ·idï¼Œåªèƒ½å–è®¾å¤‡çš„å”¯ä¸€æ ‡è¯†</li>\n</ul>\n<p>ä¸‹é¢é‡ç‚¹ä»‹ç»ä¸€ä¸‹A/Bå®éªŒã€‚</p>\n<h1 id=\"abå®éªŒ\">A/Bå®éªŒ</h1>\n<h2 id=\"ç›®çš„\">ç›®çš„</h2>\n<ul>\n<li>å°æµé‡éªŒè¯æ–°ä¸šåŠ¡åŠŸèƒ½ï¼Œæ­£å‘æ˜¾è‘—åˆ™æ¨è‡³å…¨é‡ï¼Œå¦åˆ™ç»§ç»­è¿­ä»£ä¼˜åŒ–ã€æˆ–ä¸‹çº¿ï¼Œé¿å…åŠŸèƒ½è¿‡äºè‡ƒè‚¿</li>\n<li>ç”¨æ•°æ®ä½œä¸ºä¾æ®ï¼Œé¿å…æƒ³å½“ç„¶ã€æ‹è„‘è¢‹å†³ç­–</li>\n</ul>\n<h2 id=\"åˆ†å±‚å®éªŒ\">åˆ†å±‚å®éªŒ</h2>\n<p>ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†åŒæ—¶åšå¤šä¸ªå®éªŒï¼Œè€Œä¸æ˜¯ç»™æ¯ä¸ªå®éªŒå‡åˆ†ä¸€éƒ¨åˆ†æµé‡ã€‚å› ä¸ºå½“åŒæ—¶è¿›è¡Œçš„å®éªŒå˜å¤šæ—¶ï¼Œç»„åˆæ•°é‡æˆå€å¢åŠ ï¼Œæ¯ä¸ªå®éªŒåˆ†åˆ°çš„æµé‡å°±å¾ˆå°‘äº†ã€‚<br />\næœ‰è¿™å‡ å±‚ç»“æ„ï¼šå®éªŒå±‚ã€å®éªŒã€åˆ†ç»„</p>\n<ul>\n<li>å®éªŒå±‚ä¹‹é—´æ­£äº¤ï¼Œå¯åŒæ—¶è¿›è¡Œå¤šä¸ªå®éªŒå±‚çš„å®éªŒ</li>\n<li>åŒä¸€å®éªŒå±‚çš„å®éªŒä¹‹é—´äº’æ–¥ï¼Œæ¯”å¦‚å‘½ä¸­äº†å®éªŒ1-1ï¼Œå°±ä¸ä¼šå‘½ä¸­å®éªŒ1-2ã€‚å®éªŒæŒæœ‰0åˆ°å¤šä¸ªåˆ†æ¡¶ï¼Œæ ¹æ®ä¸šåŠ¡idå¯è®¡ç®—å‡ºæ¡¶å·ï¼Œè¿›è€ŒçŸ¥é“å‘½ä¸­å“ªä¸ªå®éªŒ</li>\n<li>åŒä¸€å®éªŒå†…æœ‰å¤šä¸ªåˆ†ç»„ï¼ŒåŒ…æ‹¬1ä¸ªå¯¹ç…§ç»„ï¼Œå’Œ1åˆ°å¤šä¸ªå®éªŒç»„ï¼Œåªä¼šå‘½ä¸­å…¶ä¸­ä¸€ä¸ªåˆ†ç»„ã€‚åˆ†ç»„æŒæœ‰0åˆ°å¤šä¸ªåˆ†æ¡¶ï¼Œæ ¹æ®ä¸šåŠ¡idå¯è®¡ç®—å‡ºæ¡¶å·ï¼Œè¿›è€ŒçŸ¥é“å‘½ä¸­å“ªä¸ªåˆ†ç»„</li>\n</ul>\n<p>å®éªŒå±‚ã€å®éªŒä¸¾ä¾‹ï¼š</p>\n<ul>\n<li>å±•ç¤ºå®éªŒå±‚ï¼šæ ¹æ®é¡µé¢è¿›è¡Œåˆ’åˆ†ï¼Œå¦‚é¦–é¡µã€æœç´¢é¡µã€æ¨èé¡µã€è¯¦æƒ…é¡µç­‰ã€‚æ¯ä¸ªé¡µé¢ä½œä¸ºä¸€ä¸ªå®éªŒå±‚ï¼Œæ¯ä¸ªå®éªŒå±‚é‡Œå¯åŒæ—¶åšå¤šä¸ªå±•ç¤ºå®éªŒ</li>\n<li>ç®—æ³•å®éªŒå±‚ï¼šæ ¹æ®åœºæ™¯è¿›è¡Œåˆ’åˆ†ï¼Œå¦‚ç›¸ä¼¼æ¨èã€æ­é…è´­æ¨èã€ä¸ªæ€§åŒ–æ¨èã€æœç´¢æ’åºã€å¹¿å‘Šæ’åºç­‰ã€‚æ¯ä¸ªåœºæ™¯ä½œä¸ºä¸€ä¸ªå®éªŒå±‚ï¼Œæ¯ä¸ªå®éªŒå±‚é‡Œå¯åŒæ—¶åšå¤šä¸ªç®—æ³•å®éªŒ</li>\n</ul>\n<p><img alt=\"image\" src=\"https://img2024.cnblogs.com/blog/1247698/202601/1247698-20260127012326894-198795136.png\" /></p>\n<h2 id=\"å“ˆå¸Œç®—æ³•æ‰“æ•£\">å“ˆå¸Œç®—æ³•æ‰“æ•£</h2>\n<p>è¦åŒæ—¶æ”¯æŒå¤šä¸ªåˆ†å±‚å®éªŒï¼Œæ ¸å¿ƒåœ¨äºé€šè¿‡å“ˆå¸Œç®—æ³•å°†æ¯ä¸€å±‚çš„æµé‡æ‰“æ•£ï¼Œç”¨äºå®ç°â€œå‡åŒ€åˆ†æµâ€å’Œâ€œå±‚é—´æ­£äº¤â€ï¼Œä½¿å¾—æµé‡åœ¨å„ä¸ªå®éªŒçš„æ•ˆæœæ­£è´ŸæŠµæ¶ˆï¼Œæ‰èƒ½å¾—åˆ°çœŸå®çš„å¯¹æ¯”ç»“æœã€‚<br />\nä»¥ä¸‹æ˜¯è®¡ç®—å®éªŒå±‚æ¡¶å·çš„ä»£ç ç¤ºä¾‹ï¼Œå®éªŒæ¡¶å·åŒç†ï¼š</p>\n<pre><code class=\"language-java\">import com.google.common.hash.Hashing;\nimport java.nio.charset.StandardCharsets;\n\npublic class ABTestRouter {\n\n    /**\n     * æ ¹æ®ç”¨æˆ·IDå’Œå®éªŒå±‚IDï¼ˆå®éªŒå±‚IDå……å½“ç›çš„è§’è‰²ï¼‰ï¼Œè®¡ç®—æ¡¶å· (0-99)\n     */\n    public static int getBucket(String userId, String layerId) {\n        // 1. æ‹¼æ¥ Key: \"layerId:userId\"\n        String key = layerId + \":\" + userId;\n\n        // 2. ä½¿ç”¨ MurmurHash3 (32-bit)\n        // Guava çš„ murmur3_32_fixed æ˜¯çº¿ç¨‹å®‰å…¨çš„\n        int hash = Hashing.murmur3_32_fixed()\n                .hashString(key, StandardCharsets.UTF_8)\n                .asInt();\n\n        // 3. å–æ¨¡å¹¶ç¡®ä¿ç»“æœä¸ºæ­£æ•°\n        // Math.abs(Integer.MIN_VALUE) ä¼šè¿”å›è´Ÿæ•°ï¼Œæ‰€ä»¥æ¨èä½¿ç”¨ä½è¿ç®—å»é™¤ç¬¦å·ä½\n        return (hash &amp; Integer.MAX_VALUE) % 100;\n    }\n\n    public static void main(String[] args) {\n        String uid = \"user_123456\";\n        \n        // ä¸åŒå±‚çš„æµé‡æ˜¯æ­£äº¤çš„ï¼ˆæ‰“æ•£é‡æ–°åˆ†é…ï¼‰\n        System.out.println(\"å±•ç¤ºå±‚æ¡¶å·: \" + getBucket(uid, \"layer_ui\"));\n        System.out.println(\"ç®—æ³•å±‚æ¡¶å·: \" + getBucket(uid, \"layer_algo\"));\n    }\n}\n</code></pre>\n<p>ä¹‹æ‰€ä»¥ç”¨murmurhashï¼Œè€Œémd5ï¼Œæ˜¯å› ä¸ºmd5æ˜¯åŠ å¯†ç®—æ³•ï¼Œè®¡ç®—å¼€é”€æ›´å¤§ï¼Œåœ¨ABå®éªŒä¸­ä»…éœ€å‡åŒ€æ‰“æ•£å³å¯ï¼Œæ— éœ€æ‹…å¿ƒæ ¹æ®å“ˆå¸Œç»“æœåæ¨åŸæ–‡ã€‚<br />\nä¹‹æ‰€ä»¥æŠŠå®éªŒå±‚idä½œä¸ºç›ï¼Œæ˜¯å› ä¸ºå¾®å°çš„è¾“å…¥å·®å¼‚éƒ½ä¼šå¯¼è‡´å“ˆå¸Œç»“æœç›¸å·®å·¨å¤§ï¼Œå®ç°æ‰“æ•£çš„æ•ˆæœã€‚</p>\n<h2 id=\"å®éªŒæ•°æ®æ”¶é›†\">å®éªŒæ•°æ®æ”¶é›†</h2>\n<p>å®éªŒæ•°æ®æ”¶é›†æµç¨‹å¦‚ä¸‹ï¼š</p>\n<ul>\n<li>åœ¨ABå®éªŒç®¡ç†ç³»ç»Ÿä¸­é…ç½®å®éªŒä¿¡æ¯ï¼šå¦‚å®éªŒç›å€¼ã€æ¡¶å·ä¸å®éªŒç»„çš„æ˜ å°„å…³ç³»ç­‰ï¼Œå¯åŠ¨æ€ä¿®æ”¹</li>\n<li>ä»£ç é€»è¾‘å¼€å‘ï¼š\n<ul>\n<li>å¼•å…¥å®éªŒsdkï¼Œsdkåœ¨å¯åŠ¨ã€æˆ–é…ç½®å˜æ›´æ—¶æ‹‰å–å®éªŒä¿¡æ¯ï¼Œæœ¬åœ°è®¡ç®—ä¸šåŠ¡idçš„æ¡¶å·ï¼Œè¿›è€Œå¾—åˆ°å‘½ä¸­çš„åˆ†ç»„</li>\n<li>å¯¹ç…§ç»„åšå½“å‰é€»è¾‘ï¼Œå®éªŒç»„1åšé€»è¾‘1ï¼Œå®éªŒç»„2åšé€»è¾‘2</li>\n</ul>\n</li>\n<li>åœ¨æ­£å¼å¼€å§‹ABå®éªŒä¹‹å‰ï¼Œå…ˆåšAAåˆ†æ¡¶å®éªŒï¼Œæ¨¡æ‹Ÿå®éªŒç»„ã€å¯¹ç…§ç»„çš„ç»“æœï¼Œåˆ¤æ–­æ˜¯å¦å‡åŒ€ï¼Œé¿å…åˆ†æ¡¶ä¸å‡åŒ€å¸¦æ¥é”™è¯¯çš„å®éªŒç»“æœ</li>\n<li>å®éªŒå¼€å§‹ï¼Œåç«¯åŸ‹ç‚¹ï¼šsdkå‘å‡ºåç«¯åŸ‹ç‚¹æ¶ˆæ¯\n<ul>\n<li>æ¶ˆæ¯æ ¼å¼ä¸¾ä¾‹ï¼š<code>ä¸šåŠ¡id, å®éªŒå±‚id, å®éªŒid, åˆ†ç»„id, æ¡¶å·, è§¦å‘æ—¶é—´</code></li>\n</ul>\n</li>\n<li>å®éªŒè¿‡ç¨‹ï¼šå®éªŒæŒç»­æ—¶é—´è‡³å°‘ä¸€å‘¨ï¼Œè¦†ç›–å·¥ä½œæ—¥ã€å‘¨æœ«/å‡æœŸï¼Œé¿å…å—æ—¶é—´å‘¨æœŸå¸¦æ¥çš„æ³¢åŠ¨å½±å“</li>\n<li>ç¦»çº¿ç»Ÿè®¡å®éªŒæ•ˆæœï¼š\n<ul>\n<li>åç«¯åŸ‹ç‚¹æ•°æ®å¯¼å…¥æ›å…‰äº‹ä»¶hiveè¡¨</li>\n<li>ä¸šåŠ¡DBæ•°æ®å¯¼å…¥è¡Œä¸ºäº‹ä»¶hiveè¡¨ï¼Œå¦‚æ³¨å†Œã€ç™»å½•ã€æµè§ˆã€ç‚¹å‡»ã€æ”¶è—ã€åŠ è´­ã€ä¸‹å•ã€æ”¯ä»˜ç­‰ï¼Œå–å†³äºå®éªŒå…³æ³¨çš„ä¸šåŠ¡æŒ‡æ ‡</li>\n<li>æŠŠæ›å…‰äº‹ä»¶ã€è¡Œä¸ºäº‹ä»¶joinèµ·æ¥ï¼Œå¯¹æ¯”å®éªŒç»„ã€å¯¹ç…§ç»„çš„ä¸šåŠ¡æŒ‡æ ‡å·®å¼‚</li>\n</ul>\n</li>\n</ul>\n<p><img alt=\"image\" src=\"https://img2024.cnblogs.com/blog/1247698/202601/1247698-20260131014010302-1779078827.png\" /></p>\n<p>ä»¥ä¸‹æ˜¯sqlç¤ºä¾‹ï¼Œä»£è¡¨ä»å®éªŒæ›å…‰å24å°æ—¶å†…å„ä¸ªåˆ†ç»„çš„è½¬åŒ–ç‡å¯¹æ¯”ã€‚</p>\n<pre><code class=\"language-sql\">SELECT \n    e.group_id,\n    COUNT(DISTINCT e.user_id) as exposed_users,\n    COUNT(DISTINCT a.user_id) as converted_users,\n    COUNT(DISTINCT a.user_id) / COUNT(DISTINCT e.user_id) as conversion_rate\nFROM exposure_events e\nLEFT JOIN action_events a ON e.user_id = a.user_id \n    AND a.event_time BETWEEN e.event_time AND (e.event_time + INTERVAL 24 HOUR)\nWHERE e.experiment_id = 'ui_test_001'\nGROUP BY e.group_id;\n</code></pre>\n<h2 id=\"å®éªŒæŠ¥è¡¨åˆ†æ\">å®éªŒæŠ¥è¡¨åˆ†æ</h2>\n<p>è¯„ä¼°å®éªŒç»“æœæ˜¯å¦æ­£å‘ã€æ˜¯å¦æ˜¾è‘—ã€‚äº†è§£ç»Ÿè®¡å­¦é‡Œçš„æ ¸å¿ƒæ¦‚å¿µï¼Œèƒ½çœ‹æ‡‚å®éªŒæŠ¥è¡¨å³å¯ã€‚</p>\n<h3 id=\"på€¼\">på€¼</h3>\n<p>ç”¨æ¥è¡¡é‡å®éªŒç»“æœæ˜¯å¦æ˜¾è‘—ï¼Œpå€¼çš„å«ä¹‰æ˜¯ï¼šå‡è®¾å®éªŒç»„ä¸å¯¹ç…§ç»„æ²¡æœ‰åŒºåˆ«ï¼Œæ­¤æ—¶è§‚å¯Ÿåˆ°å®éªŒæœ‰å·®å¼‚çš„æ¦‚ç‡ã€‚ä¸€èˆ¬è¦æ±‚ <code>p &lt; 0.05</code>ï¼Œä¹Ÿå°±æ˜¯è¯´å®éªŒç»“æœæ˜¾è‘—çš„æ¦‚ç‡å¤§äº95%ï¼ˆ<code>1 - 0.05 = 95%</code>ï¼‰</p>\n<h3 id=\"ç½®ä¿¡åŒºé—´\">ç½®ä¿¡åŒºé—´</h3>\n<p>åœ¨æ˜¾è‘—çš„å‰æä¸‹ï¼Œç”¨æ¥è¡¡é‡å®éªŒç»“æœæ˜¯å¦æ­£å‘ï¼Œä»£è¡¨ä¸šåŠ¡æŒ‡æ ‡çš„å¯èƒ½èŒƒå›´åˆ†å¸ƒã€‚<br />\næ¯”å¦‚ï¼šå®éªŒç»“æœé‡Œä¸šåŠ¡æŒ‡æ ‡æå‡äº†1%ï¼Œ95%ç½®ä¿¡åŒºé—´åœ¨[0.8%, 1.2%]ï¼Œåˆ™ä»£è¡¨æœ‰95%çš„æŠŠæ¡å¯ä»¥æŠŠä¸šåŠ¡æŒ‡æ ‡æå‡è‡³å°‘0.8%ã€è‡³å¤š1.2%ï¼Œæ•ˆæœæ­£å‘ã€‚å¦‚æœç½®ä¿¡åŒºé—´çš„ä¸‹ç•Œæ˜¯è´Ÿæ•°ï¼Œå°±æœ‰å¯èƒ½æ˜¯è´Ÿå‘æ•ˆæœäº†ï¼Œéœ€è¦è­¦æƒ•ã€‚</p>\n<p>ä»¥ä¸Šå°±æ˜¯ç°åº¦æ–¹æ¡ˆçš„æ€»ç»“äº†ï¼Œæ¬¢è¿è®¨è®ºäº¤æµã€‚</p>\n\n\n</div>\n<div class=\"clear\"></div>\n\n            </div>\n            <div class=\"postDesc\">posted @ \n<span id=\"post-date\">2026-01-31 17:35</span>&nbsp;\n<a href=\"https://www.cnblogs.com/toplist\">Javaçƒ˜ç„™å¸ˆ</a>&nbsp;\né˜…è¯»(<span id=\"post_view_count\">80</span>)&nbsp;\nè¯„è®º(<span id=\"post_comment_count\">2</span>)&nbsp;\n&nbsp;\n<a href=\"\">æ”¶è—</a>&nbsp;\n<a href=\"\">ä¸¾æŠ¥</a>\n</div>"
    },
    {
      "title": "è½¯ä»¶æµ‹è¯•(ä¸‰)",
      "link": "https://www.cnblogs.com/xi-yongqi/p/19561936",
      "published": "",
      "description": "<h1 class=\"postTitle\">\n\t\t\t<a class=\"postTitle2 vertical-middle\" href=\"https://www.cnblogs.com/xi-yongqi/p/19561936\" id=\"cb_post_title_url\" title=\"å‘å¸ƒäº 2026-02-02 00:59\">\n    <span>è½¯ä»¶æµ‹è¯•(ä¸‰)</span>\n    \n\n</a>\n\n\t\t</h1>\n\t\t<div class=\"clear\"></div>\n\t\t<div class=\"postBody\">\n\t\t\t<div class=\"blogpost-body cnblogs-markdown\" id=\"cnblogs_post_body\">\n<h3 id=\"webè‡ªåŠ¨åŒ–æµ‹è¯•\">Webè‡ªåŠ¨åŒ–æµ‹è¯•</h3>\n<h4 id=\"é©±åŠ¨\">é©±åŠ¨</h4>\n<ul>\n<li>webç³»ç»Ÿçš„æµ‹è¯•å‰ææ˜¯éœ€è¦æ‰“å¼€æµè§ˆå™¨ï¼Œé€šè¿‡è®¿é—®webæœåŠ¡å™¨æ¥å¯¹æœåŠ¡å™¨ç•Œâ¾¯è¿›â¾â¼€ç³»åˆ—çš„æ“ä½œã€‚ç¨‹åºæƒ³è¦æ‰“å¼€webæµè§ˆå™¨å°±éœ€è¦å®‰è£…webé©±åŠ¨ï¼ˆå³WebDriver)ï¼ŒWebDriverä»¥æœ¬åœ°åŒ–â½…å¼é©±åŠ¨æµè§ˆå™¨ã€‚</li>\n</ul>\n<h5 id=\"å®‰è£…é©±åŠ¨ç®¡ç†\">å®‰è£…é©±åŠ¨ç®¡ç†</h5>\n<ul>\n<li>WebDriverManageræ˜¯â¼€ä¸ªå¼€æºJavaåº“ï¼Œä»¥å®Œå…¨â¾ƒåŠ¨åŒ–çš„â½…å¼å¯¹Selenium WebDriveræ‰€éœ€çš„é©±åŠ¨ç¨‹åºï¼ˆå¦‚chromedriverã€geckodriverã€msedgedriverç­‰ï¼‰è¿›â¾ç®¡ç†ï¼ˆå³ä¸‹è½½ã€è®¾ç½®å’Œç»´æŠ¤ï¼‰ï¼Œè‡ªç‰ˆæœ¬5 WebDriverManagerè¿˜æä¾›äº†å…¶ä»–ç›¸å…³åŠŸèƒ½ï¼Œå¦‚å‘ç°æœ¬åœ°ç³»ç»Ÿä¸­å®‰è£…çš„æµè§ˆå™¨çš„èƒ½â¼’ï¼Œæ„å»ºWebDriverå¯¹è±¡ï¼ˆå¦‚ChromeDriverã€FirefoxDriverã€EdgeDriverç­‰ï¼‰</li>\n</ul>\n<pre><code class=\"language-xml\">&lt;dependency&gt;\n &lt;groupId&gt;io.github.bonigarcia&lt;/groupId&gt;\n &lt;artifactId&gt;webdrivermanager&lt;/artifactId&gt;\n &lt;version&gt;5.8.0&lt;/version&gt;\n &lt;scope&gt;test&lt;/scope&gt;\n&lt;/dependency&gt;\n</code></pre>\n<h4 id=\"selenium\">Selenium</h4>\n<ul>\n<li>seleniumæ˜¯â¼€ä¸ªwebâ¾ƒåŠ¨åŒ–æµ‹è¯•â¼¯å…·ï¼Œseleniumä¸­æä¾›äº†ä¸°å¯Œçš„â½…æ³•ä¾›ç»™ä½¿â½¤è€…è¿›â¾webâ¾ƒåŠ¨åŒ–æµ‹è¯•ã€‚</li>\n<li>â¼€ä¸ªç®€å•çš„webâ¾ƒåŠ¨åŒ–ç¤ºä¾‹</li>\n</ul>\n<ol>\n<li>å®‰è£…seleniumåº“</li>\n</ol>\n<pre><code class=\"language-xml\">&lt;dependency&gt;\n &lt;groupId&gt;org.seleniumhq.selenium&lt;/groupId&gt;\n &lt;artifactId&gt;selenium-java&lt;/artifactId&gt;\n &lt;version&gt;4.0.0&lt;/version&gt;\n&lt;/dependency&gt;\n</code></pre>\n<ol start=\"2\">\n<li>ä½¿â½¤seleniumç¼–å†™ä»£ç </li>\n</ol>\n<pre><code class=\"language-java\">public void example_test()\n{\n //é©±åŠ¨ç¨‹åºç®¡ç†çš„â¾ƒåŠ¨åŒ–\n WebDriverManager.chromedriver().setup();\n ChromeOptions options = new ChromeOptions();\n \n //å…è®¸è®¿é—®æ‰€æœ‰é“¾æ¥\n options.addArguments(\"--remote-allow-origins=*\");\n \n //1ã€æ‰“å¼€æµè§ˆå™¨\n WebDriver driver = new ChromeDriver(options);\n \n //2.è¾“â¼Šç™¾åº¦â½¹å€:https://www.baidu.com\n driver.get(\"https://www.baidu.com\");\n \n //3ã€æ‰¾åˆ°è¾“â¼Šæ¡†å¹¶è¾“â¼Šâ€œè¿ªä¸½çƒ­å·´â€\n driver.findElement(By.xpath(\"//*[@id=\\\"kw\\\"]\")).sendKeys(\"è¿ªä¸½çƒ­å·´\");\n //4ã€æ‰¾åˆ°â€œç™¾åº¦â¼€ä¸‹â€æŒ‰é’®å¹¶ç‚¹å‡»\n driver.findElement(By.xpath(\"//*[@id=\\\"su\\\"]\")).click();\n \n //5ã€å…³é—­æµè§ˆå™¨\n driver.quit();\n}\n</code></pre>\n<h4 id=\"seleniumé©±åŠ¨æµè§ˆå™¨çš„ä½œåŸç†\">selenium+é©±åŠ¨+æµè§ˆå™¨çš„â¼¯ä½œåŸç†</h4>\n<ol>\n<li>é€šè¿‡seleniumç¼–å†™çš„â¾ƒåŠ¨åŒ–è„šæœ¬ä»£ç ä¸­åœ¨ChromeDriverServiceä¸­åˆ›å»ºâ¼€ä¸ªæœåŠ¡</li>\n<li>é€šè¿‡åˆ›å»ºå¥½çš„æœåŠ¡æ‰“å¼€webdriverï¼Œå®‰è£…åœ¨æœ¬åœ°çš„é©±åŠ¨æœåŠ¡IPä¸ºlocalhostï¼ŒPORTä¸ºChromeDriverServiceä¸­åˆ›å»ºçš„ç«¯â¼å·ï¼Œè¯¥æœåŠ¡åœ°å€ä¸ºseleniumå‘webdriverå‘é€è¯·æ±‚çš„æœåŠ¡åœ°å€ã€‚</li>\n<li>å‘æµè§ˆå™¨é©±åŠ¨ç¨‹åºå‘é€HTTPè¯·æ±‚ï¼Œæµè§ˆå™¨é©±åŠ¨ç¨‹åºè§£æè¯·æ±‚ï¼Œæ‰“å¼€æµè§ˆå™¨ï¼Œå¹¶è·å¾—sessionidï¼Œå¦‚æœå†æ¬¡å¯¹æµè§ˆå™¨æ“ä½œéœ€æºå¸¦æ­¤id</li>\n<li>æ‰“å¼€æµè§ˆå™¨åï¼Œæ‰€æœ‰çš„seleniumçš„æ“ä½œ(è®¿é—®åœ°å€ï¼ŒæŸ¥æ‰¾å…ƒç´ ç­‰)å‡é€šè¿‡åˆ›å»ºå¥½çš„æœåŠ¡é“¾æ¥åˆ°webdriverï¼Œç„¶åä½¿â½¤executeå‘é€è¯·æ±‚</li>\n<li>é©±åŠ¨æ”¶åˆ°è¯·æ±‚å¹¶å¯¹è¯·æ±‚è¿›â¾è§£æï¼Œè½¬æˆæµè§ˆå™¨èƒ½å¤Ÿè§£æçš„è„šæœ¬å¹¶å‘é€ç»™æµè§ˆå™¨ï¼Œæµè§ˆå™¨é€šè¿‡è¯·æ±‚çš„å†…å®¹æ‰§â¾å¯¹åº”åŠ¨ä½œ</li>\n<li>æµè§ˆå™¨å†æŠŠæ‰§â¾çš„åŠ¨ä½œç»“æœé€šè¿‡æµè§ˆå™¨é©±åŠ¨ç¨‹åºè¿”å›ç»™æµ‹è¯•è„šæœ¬</li>\n</ol>\n<hr />\n<h3 id=\"åŠ¨åŒ–æµ‹è¯•å¸¸å‡½æ•°\">â¾ƒåŠ¨åŒ–æµ‹è¯•å¸¸â½¤å‡½æ•°</h3>\n<h4 id=\"å…ƒç´ çš„å®šä½\">å…ƒç´ çš„å®šä½</h4>\n<ul>\n<li>webâ¾ƒåŠ¨åŒ–æµ‹è¯•çš„æ“ä½œæ ¸å¿ƒæ˜¯èƒ½å¤Ÿæ‰¾åˆ°â»šâ¾¯å¯¹åº”çš„å…ƒç´ ï¼Œç„¶åæ‰èƒ½å¯¹å…ƒç´ è¿›â¾å…·ä½“çš„æ“ä½œã€‚å¸¸è§çš„å…ƒç´ å®šä½æ–¹å¼â¾®å¸¸å¤šï¼Œå¦‚idï¼Œclassnameï¼Œtagnameï¼Œxpathï¼ŒcssSelector,å¸¸â½¤çš„ä¸»è¦ç”±cssSelectorå’Œxpathã€‚</li>\n</ul>\n<h4 id=\"cssselector\">cssSelector</h4>\n<ul>\n<li>é€‰æ‹©å™¨çš„åŠŸèƒ½ï¼šé€‰ä¸­é¡µé¢ä¸­æŒ‡å®šçš„æ ‡ç­¾å…ƒç´ </li>\n<li>é€‰æ‹©å™¨çš„ç§ç±»åˆ†ä¸ºåŸºç¡€é€‰æ‹©å™¨å’Œå¤åˆé€‰æ‹©å™¨ï¼Œå¸¸è§çš„å…ƒç´ å®šä½â½…å¼å¯ä»¥é€šè¿‡idé€‰æ‹©å™¨å’Œâ¼¦ç±»é€‰æ‹©å™¨æ¥è¿›è¡Œå®šä½ã€‚</li>\n<li>è·å–â€œç™¾åº¦ä¸€ä¸‹â€çš„é€‰æ‹©å™¨ç¤ºä¾‹ï¼š<br />\n<img alt=\"image\" class=\"lazyload\" /></li>\n<li>æ ¡éªŒæ˜¯å¦æ˜¯é€‰æ‹©çš„å…ƒç´ ï¼Œå¯ä»¥ä½¿ç”¨ctrl+Fç„¶åæœç´¢åˆšæ‰å¾—åˆ°çš„å…ƒç´ <br />\n<img alt=\"image\" class=\"lazyload\" /></li>\n</ul>\n<h4 id=\"xpath\">xpath</h4>\n<ul>\n<li>XMLè·¯å¾„è¯­â¾”ï¼Œä¸ä»…å¯ä»¥åœ¨XMLâ½‚ä»¶ä¸­æŸ¥æ‰¾ä¿¡æ¯ï¼Œè¿˜å¯ä»¥åœ¨HTMLä¸­é€‰å–èŠ‚ç‚¹;xpathä½¿â½¤è·¯å¾„è¡¨è¾¾å¼æ¥é€‰æ‹©xmlâ½‚æ¡£ä¸­çš„èŠ‚ç‚¹ã€‚</li>\n<li>ä¸¾ä¾‹ï¼š\n<ul>\n<li>è·å–HTMLâ»šâ¾¯æ‰€æœ‰çš„èŠ‚ç‚¹ï¼š<code>//*</code></li>\n<li>è·å–HTMLâ»šâ¾¯æŒ‡å®šçš„èŠ‚ç‚¹: <code>//[æŒ‡å®šèŠ‚ç‚¹]</code>; æ¯”å¦‚ï¼š <code>//ul</code>ï¼šè·å–HTMLâ»šâ¾¯æ‰€æœ‰çš„ulèŠ‚ç‚¹</li>\n<li>è·å–â¼€ä¸ªèŠ‚ç‚¹ä¸­çš„ç›´æ¥â¼¦èŠ‚ç‚¹ï¼š<code>/</code>;æ¯”å¦‚ï¼š<code>//span/input</code>,è·å–spanèŠ‚ç‚¹ä¸‹é¢çš„æ‰€æœ‰inputèŠ‚ç‚¹</li>\n<li>è·å–â¼€ä¸ªèŠ‚ç‚¹çš„â½—èŠ‚ç‚¹:<code>..</code>;ä¾‹å¦‚ï¼š<code>//input/..</code>,è·å–inputèŠ‚ç‚¹çš„â½—èŠ‚ç‚¹</li>\n<li>å®ç°èŠ‚ç‚¹å±æ€§çš„åŒ¹é…:<code>[@...]</code>;ä¾‹å¦‚ï¼š<code>//*[@id='kw']</code>åŒ¹é…HTMLâ»šâ¾¯ä¸­idå±æ€§ä¸ºkwçš„èŠ‚ç‚¹</li>\n</ul>\n</li>\n</ul>\n<h4 id=\"æ“ä½œæµ‹è¯•å¯¹è±¡\">æ“ä½œæµ‹è¯•å¯¹è±¡</h4>\n<ul>\n<li>ç‚¹å‡»/æäº¤å¯¹è±¡:<code>click()</code></li>\n</ul>\n<pre><code class=\"language-java\">//æ‰¾åˆ°ç™¾åº¦â¼€ä¸‹æŒ‰é’®å¹¶ç‚¹å‡» \ndriver.findElement(By.cssSelector(\"#su\")).click();\n</code></pre>\n<ul>\n<li>æ¨¡æ‹ŸæŒ‰é”®è¾“â¼Š:<code>sendKeys(\"\")</code></li>\n</ul>\n<pre><code class=\"language-java\">driver.findElement(By.cssSelector(\"#kw\")).sendKeys(\"è¾“â¼Šâ½‚å­—\");\n</code></pre>\n<ul>\n<li>æ¸…é™¤â½‚æœ¬å†…å®¹:<code>clear()</code></li>\n</ul>\n<pre><code class=\"language-java\">driver.findElement(By.cssSelector(\"#kw\")).sendKeys(\"æˆ‘çˆ±æ¸¸æˆ\");\ndriver.findElement(By.cssSelector(\"#kw\")).clear();\ndriver.findElement(By.cssSelector(\"#kw\")).sendKeys(\"æˆ‘çˆ±å­¦ä¹ \");\n</code></pre>\n<ul>\n<li>è·å–â½‚æœ¬ä¿¡æ¯:<code>getText()</code></li>\n</ul>\n<pre><code class=\"language-java\">String bdtext = driver.findElement(By.xpath(\"//*[@id=\"title-content\"]/span[1]\")).getText();\nSystem.out.println(\"æ‰“å°çš„å†…å®¹æ˜¯ï¼š\"+bdtext);\n</code></pre>\n<ul>\n<li>è·å–å½“å‰â»šâ¾¯æ ‡é¢˜:<code>getTitle()</code></li>\n<li>è·å–å½“å‰â»šâ¾¯URL:<code>getCurrentUrl()</code></li>\n</ul>\n<h4 id=\"çª—å£æ“ä½œ\">çª—å£æ“ä½œ</h4>\n<ul>\n<li>å½“æˆ‘ä»¬â¼¿â¼¯æµ‹è¯•çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡çœ¼ç›æ¥åˆ¤æ–­å½“å‰çš„çª—â¼æ˜¯ä»€ä¹ˆï¼Œä½†å¯¹äºç¨‹åºæ¥è¯´å®ƒæ˜¯ä¸çŸ¥é“å½“å‰æœ€æ–°çš„çª—â¼åº”è¯¥æ˜¯å“ªâ¼€ä¸ªã€‚å¯¹äºç¨‹åºæ¥è¯´å®ƒæ€ä¹ˆæ¥è¯†åˆ«æ¯â¼€ä¸ªçª—â¼å‘¢ï¼Ÿæ¯ä¸ªæµè§ˆå™¨çª—â¼éƒ½æœ‰â¼€ä¸ªå”¯â¼€çš„å±æ€§å¥æŸ„ï¼ˆhandleï¼‰æ¥è¡¨â½°ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡å¥æŸ„æ¥åˆ‡æ¢</li>\n</ul>\n<h5 id=\"åˆ‡æ¢çª—\">åˆ‡æ¢çª—â¼:</h5>\n<ol>\n<li>è·å–å½“å‰â»šâ¾¯å¥æŸ„ï¼š<code>driver.getWindowHandle();</code></li>\n<li>è·å–æ‰€æœ‰â»šâ¾¯å¥æŸ„ï¼š<code>driver.getWindowHandles()</code></li>\n<li>åˆ‡æ¢å½“å‰å¥æŸ„ä¸ºæœ€æ–°â»šâ¾¯ï¼š</li>\n</ol>\n<pre><code class=\"language-java\">String curWindow = driver.getWindowHandle();\nSet&lt;String&gt; allWindow = driver.getWindowHandles();\nfor( String w : allWindow){\n if(w!=curWindow){\n driver.switchTo().window(w);\n }\n}\n</code></pre>\n<h5 id=\"çª—è®¾ç½®å¤§å°\">çª—â¼è®¾ç½®å¤§å°</h5>\n<ul>\n<li>çª—â¼çš„å¤§å°</li>\n</ul>\n<pre><code class=\"language-java\">//çª—â¼æœ€â¼¤åŒ– \ndriver.manage().window().maximize();\n//çª—â¼æœ€â¼©åŒ– \ndriver.manage().window().minimize();\n//å…¨å±çª—â¼ \ndriver.manage().window().fullscreen();\n//â¼¿åŠ¨è®¾ç½®çª—â¼â¼¤â¼© \ndriver.manage().window().setSize(new Dimension(1024, 768));\n</code></pre>\n<h5 id=\"çª—åˆ‡æ¢\">çª—â¼åˆ‡æ¢</h5>\n<pre><code class=\"language-java\">//è·å–æ‰€æœ‰å¥æŸ„ \n//è·å–å½“å‰åœç•™â»šâ¾¯å¥æŸ„ \nString curWindow = driver.getWindowHandle();\nSet&lt;String&gt; allWindow = driver.getWindowHandles();\nfor( String w : allWindow){\n if(w!=curWindow){\n driver.switchTo().window(w);\n }\n}\n</code></pre>\n<h5 id=\"å±å¹•æˆªå›¾\">å±å¹•æˆªå›¾</h5>\n<ul>\n<li>å¯¼åŒ…</li>\n</ul>\n<pre><code class=\"language-xml\">&lt;dependency&gt;\n &lt;groupId&gt;commons-io&lt;/groupId&gt;\n &lt;artifactId&gt;commons-io&lt;/artifactId&gt;\n &lt;version&gt;2.6&lt;/version&gt;\n &lt;/dependency&gt;\n</code></pre>\n<pre><code class=\"language-java\">File file = ((TakesScreenshot)webDriver).getScreenshotAs(OutputType.FILE);\nFileUtils.copyFile(file,new File(filename));\n</code></pre>\n<ul>\n<li>ä»£ç ç¤ºä¾‹ï¼š</li>\n</ul>\n<pre><code class=\"language-java\">//ç®€å•ç‰ˆæœ¬ \nFile srcfile = driver.getScreenshotAs(OutputType.FILE);\nFileUtils.copyFile(srcfile,new File(\"my.png\"));\n//â¾¼é˜¶ç‰ˆæœ¬ \nList&lt;String&gt; times = getTime();\nString filename =\"./src/test/autotest-\"+times.get(0)+\"/\"+str+\"-\n\"+times.get(1)+\".png\";\nFile srcfile = driver.getScreenshotAs(OutputType.FILE);\n//æŠŠå±å¹•æˆªå›¾æ”¾åˆ°æŒ‡å®šçš„è·¯å¾„ä¸‹ \nFileUtils.copyFile(srcfile,new File(filename));\n</code></pre>\n<h5 id=\"å…³é—­çª—\">å…³é—­çª—â¼</h5>\n<pre><code class=\"language-java\">driver.close();\n</code></pre>\n<ul>\n<li>ä¸€æ—¦çª—å£å…³é—­ï¼Œåˆ™éœ€è¦é‡æ–°å¯¹driverè¿›è¡Œå®šä¹‰</li>\n</ul>\n<h4 id=\"ç­‰å¾…\">ç­‰å¾…</h4>\n<ul>\n<li>é€šå¸¸ä»£ç æ‰§â¾çš„é€Ÿåº¦â½â»šâ¾¯æ¸²æŸ“çš„é€Ÿåº¦è¦å¿«ï¼Œéœ€è¦é¿å…å› ä¸ºæ¸²æŸ“è¿‡æ…¢å‡ºç°çš„è‡ªåŠ¨åŒ–è¯¯æŠ¥çš„é—®é¢˜,å¯ä»¥ä½¿â½¤seleniumä¸­æä¾›çš„ä¸‰ç§ç­‰å¾…â½…æ³•ã€‚</li>\n</ul>\n<h5 id=\"å¼ºåˆ¶ç­‰å¾…\">å¼ºåˆ¶ç­‰å¾…</h5>\n<pre><code class=\"language-java\">Thread.sleepï¼ˆï¼‰\n</code></pre>\n<ul>\n<li>ä¼˜ç‚¹ï¼šä½¿â½¤ç®€å•ï¼Œè°ƒè¯•çš„æ—¶å€™â½è¾ƒæœ‰æ•ˆ</li>\n<li>ç¼ºç‚¹ï¼šå½±å“è¿â¾æ•ˆç‡ï¼Œæµªè´¹â¼¤é‡çš„æ—¶é—´</li>\n</ul>\n<h5 id=\"éšå¼ç­‰å¾…\">éšå¼ç­‰å¾…</h5>\n<ul>\n<li>éšå¼ç­‰å¾…æ˜¯â¼€ç§æ™ºèƒ½ç­‰å¾…ï¼Œä»–å¯ä»¥è§„å®šåœ¨æŸ¥æ‰¾å…ƒç´ æ—¶ï¼Œåœ¨æŒ‡å®šæ—¶é—´å†…ä¸æ–­æŸ¥æ‰¾å…ƒç´ ã€‚å¦‚æœæ‰¾åˆ°åˆ™ä»£ç ç»§ç»­æ‰§è¡Œï¼Œç›´åˆ°è¶…æ—¶æ²¡æ‰¾åˆ°å…ƒç´ æ‰ä¼šæŠ¥é”™ã€‚</li>\n<li><code>implicitlyWait()</code> å‚æ•°ï¼šDurationç±»ä¸­æä¾›çš„æ¯«ç§’ã€ç§’ã€åˆ†é’Ÿç­‰æ–¹æ³•ã€‚</li>\n<li>éšå¼ç­‰å¾…ä½œâ½¤åŸŸæ˜¯æ•´ä¸ªè„šæœ¬çš„æ‰€æœ‰å…ƒç´ ã€‚å³åªè¦driverå¯¹è±¡æ²¡æœ‰è¢«é‡Šæ”¾æ‰ï¼ˆdriver.quit()ï¼‰ï¼Œéšå¼ç­‰å¾…å°±â¼€ç›´ç”Ÿæ•ˆã€‚</li>\n</ul>\n<pre><code class=\"language-java\">//éšå¼ç­‰å¾…1000æ¯«ç§’ \ndriver.manage().timeouts().implicitlyWait(Duration.ofMillis(1000));\n//éšå¼ç­‰å¾…5ç§’ \ndriver.manage().timeouts().implicitlyWait(Duration.ofSeconds(5));\n</code></pre>\n<ul>\n<li>ä¼˜ç‚¹ï¼šæ™ºèƒ½ç­‰å¾…ï¼Œä½œâ½¤äºå…¨å±€</li>\n</ul>\n<h5 id=\"æ˜¾ç¤ºç­‰å¾…\">æ˜¾ç¤ºç­‰å¾…</h5>\n<ul>\n<li>æ˜¾â½°ç­‰å¾…ä¹Ÿæ˜¯â¼€ç§æ™ºèƒ½ç­‰å¾…ï¼Œåœ¨æŒ‡å®šè¶…æ—¶æ—¶é—´èŒƒå›´å†…åªè¦æ»¡â¾œæ“ä½œçš„æ¡ä»¶å°±ä¼šç»§ç»­æ‰§â¾åç»­ä»£ç </li>\n</ul>\n<pre><code class=\"language-java\">WebDriverWait foo = new WebDriverWait(driver, Duration.ofSeconds(3))\nfoo.until(ExpectedConditions.elementToBeClickable(By.cssSelector(\"#id\")));\n</code></pre>\n<ul>\n<li>ä¼˜ç‚¹ï¼šæ˜¾â½°ç­‰å¾…æ˜¯æ™ºèƒ½ç­‰å¾…ï¼Œå¯ä»¥â¾ƒå®šä¹‰æ˜¾â½°ç­‰å¾…çš„æ¡ä»¶ï¼Œæ“ä½œçµæ´»</li>\n<li>ç¼ºç‚¹ï¼šå†™æ³•å¤æ‚</li>\n</ul>\n<h4 id=\"æµè§ˆå™¨å¯¼èˆª\">æµè§ˆå™¨å¯¼èˆª</h4>\n<ol>\n<li>æ‰“å¼€â½¹ç«™:</li>\n</ol>\n<pre><code class=\"language-java\">// æ›´â»“çš„â½…æ³• \ndriver.navigate().to(\"https://selenium.dev\");\n// ç®€æ´çš„â½…æ³• \ndriver.get(\"https://selenium.dev\");\n</code></pre>\n<ol start=\"2\">\n<li>æµè§ˆå™¨çš„å‰è¿›ã€åé€€ã€åˆ·æ–°</li>\n</ol>\n<pre><code class=\"language-java\">driver.navigate().back();\ndriver.navigate().forward();\ndriver.navigate().refresh();\n</code></pre>\n<h4 id=\"å¼¹çª—\">å¼¹çª—</h4>\n<ul>\n<li>å¼¹çª—æ˜¯åœ¨â»šâ¾¯æ˜¯æ‰¾ä¸åˆ°ä»»ä½•å…ƒç´ çš„ï¼Œå¯¹äºè¿™ç§æƒ…å†µéœ€è¦ä½¿â½¤seleniumæä¾›çš„Alertæ¥â¼ã€‚<br />\n<img alt=\"image\" class=\"lazyload\" /></li>\n</ul>\n<pre><code class=\"language-java\">Alert alert = driver.switchTo.alert();\n//ç¡®è®¤\nalert.accept()\n//å–æ¶ˆ\nalert.dismiss()\n</code></pre>\n<ul>\n<li>æç¤ºå¼¹çª—<br />\n<img alt=\"image\" class=\"lazyload\" /></li>\n</ul>\n<pre><code class=\"language-java\">Alert alert = driver.switchTo.alert();\nalert.sendKeys(\"hello\");\nalert.accept();\nalert.dismiss();\n</code></pre>\n<h4 id=\"æ–‡ä»¶ä¸Šä¼ \">æ–‡ä»¶ä¸Šä¼ </h4>\n<ul>\n<li>ç‚¹å‡»æ–‡ä»¶ä¸Šä¼ çš„åœºæ™¯ä¸‹ä¼šå¼¹çª—ç³»ç»Ÿçª—â¼ï¼Œè¿›è¡Œâ½‚ä»¶çš„é€‰æ‹©ã€‚seleniumâ½†æ³•è¯†åˆ«â¾®webçš„æ§ä»¶ï¼Œä¸Šä¼ â½‚ä»¶çª—â¼ä¸ºç³»ç»Ÿâ¾ƒå¸¦ï¼Œæ— æ³•è¯†åˆ«çª—â¼å…ƒç´ ä½†æ˜¯å¯ä»¥ä½¿â½¤sendkeysæ¥ä¸Šä¼ æŒ‡å®šè·¯å¾„çš„â½‚ä»¶ï¼Œè¾¾åˆ°çš„æ•ˆæœæ˜¯â¼€æ ·çš„ã€‚</li>\n</ul>\n<pre><code class=\"language-java\">WebElement element = driver.findElement(By.cssSelector(\"body &gt; div &gt; div &gt; input[type=file]\"));\nelement.sendKeys(\"D:\\\\selenium2html\\\\upload.html\");\n</code></pre>\n\n\n</div>\n<div class=\"clear\"></div>\n\n\t\t</div>\n\t\t<div class=\"postDesc\">posted @ \n<span id=\"post-date\">2026-02-02 00:59</span>&nbsp;\n<a href=\"https://www.cnblogs.com/xi-yongqi\">æˆ‘ä¼šæ›¿é£å»</a>&nbsp;\né˜…è¯»(<span id=\"post_view_count\">0</span>)&nbsp;\nè¯„è®º(<span id=\"post_comment_count\">0</span>)&nbsp;\n&nbsp;\n<a href=\"\">æ”¶è—</a>&nbsp;\n<a href=\"\">ä¸¾æŠ¥</a>\n</div>"
    },
    {
      "title": "å¤æ–‡è§‚èŠ·Appæœç´¢æ–¹æ¡ˆæ·±åº¦è§£æï¼šæ‰“é€ æè‡´æ€§èƒ½çš„å¤æ–‡æœç´¢å¼•æ“",
      "link": "https://www.cnblogs.com/hlxs/p/19561679",
      "published": "",
      "description": "<h1 class=\"postTitle\">\n                <a class=\"postTitle2 vertical-middle\" href=\"https://www.cnblogs.com/hlxs/p/19561679\" id=\"cb_post_title_url\" title=\"å‘å¸ƒäº 2026-02-01 22:27\">\n    <span>å¤æ–‡è§‚èŠ·Appæœç´¢æ–¹æ¡ˆæ·±åº¦è§£æï¼šæ‰“é€ æè‡´æ€§èƒ½çš„å¤æ–‡æœç´¢å¼•æ“</span>\n    \n\n</a>\n\n            </h1>\n            <div class=\"clear\"></div>\n            <div class=\"postBody\">\n                <div class=\"blogpost-body cnblogs-markdown\" id=\"cnblogs_post_body\">\n<h1 id=\"å¤æ–‡è§‚èŠ·appæœç´¢æ–¹æ¡ˆæ·±åº¦è§£ææ‰“é€ æè‡´æ€§èƒ½çš„å¤æ–‡æœç´¢å¼•æ“\">å¤æ–‡è§‚èŠ·Appæœç´¢æ–¹æ¡ˆæ·±åº¦è§£æï¼šæ‰“é€ æè‡´æ€§èƒ½çš„å¤æ–‡æœç´¢å¼•æ“</h1>\n<h2 id=\"å¼•è¨€åœ¨å¤ç±çš„æµ·æ´‹ä¸­ç²¾å‡†å¯¼èˆª\">å¼•è¨€ï¼šåœ¨å¤ç±çš„æµ·æ´‹ä¸­ç²¾å‡†å¯¼èˆª</h2>\n<p>ä½œä¸ºä¸€æ¬¾ä¸“æ³¨äºå¤å…¸æ–‡å­¦å­¦ä¹ çš„Appï¼Œå¤æ–‡è§‚èŠ·éœ€è¦å¤„ç†ä»ã€Šè¯—ç»ã€‹åˆ°æ˜æ¸…å°è¯´çš„æµ·é‡å¤æ–‡æ•°æ®ã€‚ç”¨æˆ·å¯èƒ½æœç´¢ä¸€é¦–è¯—ã€ä¸€ä½ä½œè€…ã€ä¸€å¥åè¨€ã€ä¸€ä¸ªæˆè¯­ï¼Œç”šè‡³ä¸€æ®µæ–‡åŒ–å¸¸è¯†ã€‚å¦‚ä½•åœ¨è¿™ä¸ªåºå¤§çš„çŸ¥è¯†åº“ä¸­å®ç°æ¯«ç§’çº§ç²¾å‡†æœç´¢ï¼Ÿè¿™æ˜¯æˆ‘ä½œä¸ºç‹¬ç«‹å¼€å‘è€…é¢ä¸´çš„æ ¸å¿ƒæŒ‘æˆ˜ã€‚</p>\n<p>ç»è¿‡æ·±å…¥åˆ†æå’ŒæŠ€æœ¯é€‰å‹ï¼Œæˆ‘æ‘’å¼ƒäº†ä¼ ç»Ÿçš„æ•°æ®åº“æœç´¢å’Œäº‘æœåŠ¡æ–¹æ¡ˆï¼Œè‡ªä¸»ç ”å‘äº†ä¸€å¥—åŸºäºå†…å­˜çš„æœç´¢ç³»ç»Ÿã€‚è¿™å¥—ç³»ç»Ÿä¸ä»…æ€§èƒ½å“è¶Šï¼Œè€Œä¸”æˆæœ¬æä½ï¼Œå®Œç¾å¥‘åˆä¸ªäººå¼€å‘é¡¹ç›®çš„éœ€æ±‚ã€‚</p>\n<p><img alt=\"å¾®ä¿¡å›¾ç‰‡_20260201222357_107_16\" src=\"https://img2024.cnblogs.com/blog/142192/202602/142192-20260201222535633-495477397.jpg\" /></p>\n<p><img alt=\"å¾®ä¿¡å›¾ç‰‡_20260201222328_104_16\" src=\"https://img2024.cnblogs.com/blog/142192/202602/142192-20260201222547673-350238474.jpg\" /></p>\n<p><img alt=\"å¾®ä¿¡å›¾ç‰‡_20260201222329_105_16\" src=\"https://img2024.cnblogs.com/blog/142192/202602/142192-20260201222554833-891586769.jpg\" /></p>\n<p><img alt=\"å¾®ä¿¡å›¾ç‰‡_20260201222330_106_16\" src=\"https://img2024.cnblogs.com/blog/142192/202602/142192-20260201222605157-854075319.jpg\" /></p>\n<h2 id=\"ç¬¬ä¸€ç« æŠ€æœ¯é€‰å‹çš„æ·±åº¦æ€è€ƒ\">ç¬¬ä¸€ç« ï¼šæŠ€æœ¯é€‰å‹çš„æ·±åº¦æ€è€ƒ</h2>\n<h3 id=\"11-ä¸‰ç§æŠ€æœ¯è·¯çº¿çš„å¯¹æ¯”åˆ†æ\">1.1 ä¸‰ç§æŠ€æœ¯è·¯çº¿çš„å¯¹æ¯”åˆ†æ</h3>\n<p>åœ¨é¡¹ç›®åˆæœŸï¼Œæˆ‘ç³»ç»Ÿè¯„ä¼°äº†ä¸‰ç§ä¸»æµæœç´¢æ–¹æ¡ˆï¼š</p>\n<p><strong>æ–¹æ¡ˆä¸€ï¼šMySQLå…¨æ–‡æœç´¢</strong></p>\n<pre><code class=\"language-sql\">-- ç®€å•çš„å®ç°æ–¹å¼\nSELECT * FROM poems WHERE MATCH(title, content) AGAINST('æç™½' IN NATURAL LANGUAGE MODE);\n</code></pre>\n<ul>\n<li><strong>ä¼˜ç‚¹</strong>ï¼šå¼€å‘ç®€å•ï¼Œæ— éœ€é¢å¤–ç»„ä»¶</li>\n<li><strong>ç¼ºç‚¹</strong>ï¼šæ€§èƒ½å·®ï¼ˆæŸ¥è¯¢è€—æ—¶&gt;100msï¼‰ï¼Œåˆ†è¯æ•ˆæœå·®,ä¸æ”¯æŒæœç´¢å¤šä¸ªå…³é”®å­—ï¼Œæ— æ³•æ”¯æŒå¤æ‚çš„å¤æ–‡åˆ†è¯éœ€æ±‚</li>\n</ul>\n<p><strong>æ–¹æ¡ˆäºŒï¼šElasticsearch</strong></p>\n<ul>\n<li><strong>ä¼˜ç‚¹</strong>ï¼šåŠŸèƒ½å¼ºå¤§ï¼Œåˆ†å¸ƒå¼æ‰©å±•æ€§å¥½</li>\n<li><strong>ç¼ºç‚¹</strong>ï¼š\n<ul>\n<li>éƒ¨ç½²å¤æ‚ï¼Œéœ€è¦å•ç‹¬ç»´æŠ¤</li>\n<li>å†…å­˜å ç”¨é«˜ï¼ˆåŸºç¡€éƒ¨ç½²&gt;1GBï¼‰</li>\n<li>äº‘æœåŠ¡æˆæœ¬é«˜ï¼ˆæ¯æœˆ$50+ï¼‰</li>\n<li>å¯¹å¤æ–‡ç‰¹æ®Šå­—ç¬¦æ”¯æŒä¸ä½³</li>\n</ul>\n</li>\n</ul>\n<p><strong>æ–¹æ¡ˆä¸‰ï¼šè‡ªç ”å†…å­˜æœç´¢</strong></p>\n<ul>\n<li><strong>ä¼˜åŠ¿åˆ†æ</strong>ï¼š\n<ul>\n<li>æ•°æ®é‡å¯æ§ï¼šå¤æ–‡æ€»æ•°çº¦50ä¸‡æ¡ï¼Œå®Œå…¨å¯åŠ è½½åˆ°å†…å­˜</li>\n<li>åªè¯»ç‰¹æ€§ï¼šå¤æ–‡æ•°æ®åŸºæœ¬ä¸å˜ï¼Œæ— éœ€å®æ—¶æ›´æ–°</li>\n<li>æ€§èƒ½æè‡´ï¼šå†…å­˜æ“ä½œæ¯”ç£ç›˜å¿«1000å€ä»¥ä¸Š</li>\n<li>é›¶æˆæœ¬ï¼šä»…éœ€æœåŠ¡å™¨å†…å­˜ï¼Œæ— éœ€é¢å¤–æœåŠ¡</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"12-ä¸ºä»€ä¹ˆæœ€ç»ˆé€‰æ‹©è‡ªç ”æ–¹æ¡ˆ\">1.2 ä¸ºä»€ä¹ˆæœ€ç»ˆé€‰æ‹©è‡ªç ”æ–¹æ¡ˆï¼Ÿ</h3>\n<p><strong>æ•°æ®ç‰¹å¾å†³å®šäº†æŠ€æœ¯é€‰å‹</strong>ï¼š</p>\n<ol>\n<li><strong>æ€»é‡æœ‰é™</strong>ï¼šå¤æ–‡ä½œå“ä¸ä¼šæ— é™å¢é•¿ï¼Œ50ä¸‡æ¡æ˜¯ç¨³å®šä¸Šé™</li>\n<li><strong>æ›´æ–°é¢‘ç‡æä½</strong>ï¼šå¤ç±å†…å®¹ä¸ä¼šå˜æ›´ï¼Œæ¯æœˆæ›´æ–°&lt;100æ¡ï¼Œå†…å®¹æ›´æ–°åé‡å¯å°±è¡Œï¼ŒåŸºæœ¬ä¸å˜ï¼Œæ‰€æœ‰æ•°æ®éƒ½æ˜¯è‡ªè¯»ï¼Œæ²¡æœ‰å¹¶å‘è¯»å†™</li>\n<li><strong>æœç´¢ç»´åº¦å¤š</strong>ï¼šéœ€è¦æ”¯æŒæ ‡é¢˜ã€ä½œè€…ã€å†…å®¹ã€æ³¨é‡Šç­‰å¤šç»´åº¦æœç´¢ï¼Œå†…å®¹ä¹Ÿæ˜¯å¤šä¸ªç»´åº¦ï¼šè¯—æ–‡ã€ä½œè€…ã€åå¥ã€æˆè¯­ã€æ–‡åŒ–å¸¸è¯†ã€æ­‡åè¯­ç­‰ï¼›æœç´¢æ–¹å¼å¤šä½ï¼šæ–‡æœ¬æœç´¢å’Œæ‹ç…§æœç´¢</li>\n<li><strong>å®æ—¶æ€§è¦æ±‚é«˜</strong>ï¼šç”¨æˆ·æœŸæœ›\"è¾“å…¥å³å¾—\"çš„æœç´¢ä½“éªŒ</li>\n</ol>\n<p><strong>æˆæœ¬æ•ˆç›Šåˆ†æ</strong>ï¼š</p>\n<ul>\n<li>Elasticsearchå¹´æˆæœ¬ï¼š$600+ï¼Œé¡¹ç›®è¿˜æ²¡æœ‰æ”¶ç›Šï¼Œèƒ½çœå°±çœ</li>\n<li>è‡ªç ”æ–¹æ¡ˆå¹´æˆæœ¬ï¼š$0ï¼ˆä»…æœåŠ¡å™¨å†…å­˜ï¼‰</li>\n<li>æ€§èƒ½å¯¹æ¯”ï¼šè‡ªç ”æ–¹æ¡ˆå¹³å‡å“åº”æ—¶é—´&lt;0.1msï¼ŒESå¹³å‡&gt;50ms</li>\n</ul>\n<h2 id=\"ç¬¬äºŒç« ç³»ç»Ÿæ¶æ„å…¨æ™¯å›¾\">ç¬¬äºŒç« ï¼šç³»ç»Ÿæ¶æ„å…¨æ™¯å›¾</h2>\n<h3 id=\"21-æ•´ä½“æ¶æ„è®¾è®¡\">2.1 æ•´ä½“æ¶æ„è®¾è®¡</h3>\n<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚                    å¤æ–‡è§‚èŠ·æœç´¢ç³»ç»Ÿæ¶æ„                         â”‚\nâ”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\nâ”‚  åº”ç”¨å±‚                                                      â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚\nâ”‚  â”‚ç»¼åˆæœç´¢ â”‚ â”‚è¯—æ–‡æœç´¢ â”‚ â”‚ä½œè€…æœç´¢ â”‚ â”‚æˆè¯­æœç´¢ â”‚          â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚\nâ”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\nâ”‚  ç´¢å¼•å±‚                                                      â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚\nâ”‚  â”‚    å€’æ’ç´¢å¼•ç®¡ç†å™¨ (searchMgr)                              â”‚  â”‚\nâ”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚\nâ”‚  â”‚  â”‚è¯—æ–‡ç´¢å¼• â”‚ â”‚ä½œè€…ç´¢å¼• â”‚ â”‚åå¥ç´¢å¼• â”‚ â”‚æˆè¯­ç´¢å¼• â”‚    â”‚  â”‚\nâ”‚  â”‚  â”‚mPoemWordâ”‚ â”‚mAuthor- â”‚ â”‚mSentenceâ”‚ â”‚mIdiom   â”‚    â”‚  â”‚\nâ”‚  â”‚  â”‚         â”‚ â”‚  Word   â”‚ â”‚   Word  â”‚ â”‚  Index  â”‚    â”‚  â”‚\nâ”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚\nâ”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚  â”‚\nâ”‚  â”‚  â”‚æ–‡åŒ–å¸¸è¯† â”‚ â”‚æ­‡åè¯­  â”‚                            â”‚  â”‚\nâ”‚  â”‚  â”‚mCulture â”‚ â”‚mXhyWord â”‚                            â”‚  â”‚\nâ”‚  â”‚  â”‚  Word   â”‚ â”‚         â”‚                            â”‚  â”‚\nâ”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚  â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚\nâ”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\nâ”‚  æ•°æ®å±‚                                                      â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚\nâ”‚  â”‚è¯—æ–‡æ•°æ® â”‚ â”‚ä½œè€…æ•°æ® â”‚ â”‚æˆè¯­æ•°æ® â”‚ â”‚åå¥æ•°æ® â”‚          â”‚\nâ”‚  â”‚50,000+  â”‚ â”‚5,000+   â”‚ â”‚30,000+  â”‚ â”‚10,000+  â”‚          â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”‚\nâ”‚  â”‚æ–‡åŒ–å¸¸è¯† â”‚ â”‚æ­‡åè¯­  â”‚                                  â”‚\nâ”‚  â”‚3,000+   â”‚ â”‚14,000+   â”‚                                  â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n</code></pre>\n<h3 id=\"22-æ ¸å¿ƒæ•°æ®ç»“æ„è®¾è®¡\">2.2 æ ¸å¿ƒæ•°æ®ç»“æ„è®¾è®¡</h3>\n<pre><code class=\"language-go\">// searchMgr - æœç´¢ç®¡ç†å™¨ï¼ˆæ ¸å¿ƒç±»ï¼‰\ntype searchMgr struct {\n    // 1. åˆ†è¯ä¸è¿‡æ»¤ç»„ä»¶\n    jieba *gojieba.Jieba           // ç»“å·´åˆ†è¯å™¨ï¼ˆé«˜æ€§èƒ½C++å®ç°ï¼‰\n    pin   *pinyin.Pinyin           // æ‹¼éŸ³è½¬æ¢å™¨ï¼ˆæ”¯æŒå¤šéŸ³å­—ï¼‰\n    mFilterWords map[string]bool   // åœç”¨è¯è¡¨ï¼ˆ60+ä¸ªå­—ç¬¦ï¼‰\n    \n    // 2. å…­å¤§å†…å®¹ç´¢å¼•ï¼ˆæ ¸å¿ƒå€’æ’ç´¢å¼•ï¼‰\n    mPoemWord     map[string][]uint32  // è¯—æ–‡ç´¢å¼•ï¼š15ä¸‡+è¯æ¡\n    mAuthorWord   map[string][]uint32  // ä½œè€…ç´¢å¼•ï¼š2ä¸‡+è¯æ¡  \n    mSentenceWord map[string][]uint32  // åå¥ç´¢å¼•ï¼š3åƒ+è¯æ¡\n    mCultureWord  map[string][]uint32  // æ–‡åŒ–å¸¸è¯†ï¼š2åƒ+è¯æ¡\n    mXhyWord      map[string][]uint32  // æ­‡åè¯­ï¼š1.4ä¸‡+è¯æ¡\n    \n    // 3. ç¼“å­˜ä¸ä¼˜åŒ–\n    searchFileName string          // ç´¢å¼•ç¼“å­˜æ–‡ä»¶è·¯å¾„\n    hotQueryCache  map[string][]uint32  // çƒ­é—¨æŸ¥è¯¢ç¼“å­˜\n    queryStats     map[string]int       // æŸ¥è¯¢ç»Ÿè®¡ï¼ˆç”¨äºä¼˜åŒ–ï¼‰\n    \n    // 4. æ•°æ®å¼•ç”¨ï¼ˆé¿å…é‡å¤å­˜å‚¨ï¼‰\n    poemList     []*pb.EntityXsPoem    // è¯—æ–‡åŸå§‹æ•°æ®ï¼ˆåªè¯»å¼•ç”¨ï¼‰\n    authorList   []*pb.EntityXsAuthor  // ä½œè€…åŸå§‹æ•°æ®\n    // ... å…¶ä»–æ•°æ®å¼•ç”¨\n}\n</code></pre>\n<h3 id=\"23-å†…å­˜å ç”¨ä¼˜åŒ–ç­–ç•¥\">2.3 å†…å­˜å ç”¨ä¼˜åŒ–ç­–ç•¥</h3>\n<p><strong>æ•°æ®è§„æ¨¡ç»Ÿè®¡</strong>ï¼š</p>\n<ul>\n<li>æ€»æ•°æ®é‡ï¼šçº¦50ä¸‡æ¡è®°å½•</li>\n<li>åŸå§‹æ•°æ®å¤§å°ï¼š~300MB</li>\n<li>ç´¢å¼•æ•°æ®å¤§å°ï¼š~100MB</li>\n<li>æ€»å†…å­˜å ç”¨ï¼š~400MBï¼ˆç°ä»£æœåŠ¡å™¨å®Œå…¨å¯æ¥å—ï¼ŒæœåŠ¡å™¨2Gå†…å­˜å®Œå…¨å¤Ÿç”¨ï¼‰</li>\n</ul>\n<p><strong>å†…å­˜ä¼˜åŒ–æŠ€å·§</strong>ï¼š</p>\n<ol>\n<li><strong>ä½¿ç”¨uint32å­˜å‚¨ID</strong>ï¼šæœ€å¤§æ”¯æŒ42äº¿æ¡è®°å½•ï¼Œè¶³å¤Ÿä½¿ç”¨ä¸”èŠ‚çœç©ºé—´</li>\n<li><strong>å­—ç¬¦ä¸²é©»ç•™æŠ€æœ¯</strong>ï¼šç›¸åŒå­—ç¬¦ä¸²åªå­˜å‚¨ä¸€ä»½</li>\n<li><strong>é¢„åˆ†é…å®¹é‡</strong>ï¼šé¿å…mapåŠ¨æ€æ‰©å®¹å¼€é”€</li>\n<li><strong>å‹ç¼©å­˜å‚¨</strong>ï¼šå¯¹ä½é¢‘è¯ä½¿ç”¨æ›´ç´§å‡‘çš„å­˜å‚¨æ ¼å¼</li>\n</ol>\n<h2 id=\"ç¬¬ä¸‰ç« ç´¢å¼•æ„å»ºçš„è‰ºæœ¯\">ç¬¬ä¸‰ç« ï¼šç´¢å¼•æ„å»ºçš„è‰ºæœ¯</h2>\n<h3 id=\"31-å¹¶è¡Œæ„å»ºå……åˆ†åˆ©ç”¨å¤šæ ¸cpu\">3.1 å¹¶è¡Œæ„å»ºï¼šå……åˆ†åˆ©ç”¨å¤šæ ¸CPU</h3>\n<pre><code class=\"language-go\">func (sm *searchMgr) initSearch() {\n    // é¢„åˆ†é…mapå®¹é‡ï¼Œé¿å…æ‰©å®¹\n    mPoemWord := make(map[string][]uint32, 154252)   // æ ¹æ®å†å²æ•°æ®é¢„ä¼°\n    mAuthorWord := make(map[string][]uint32, 21603)\n    mSentenceWord := make(map[string][]uint32, 3429)\n    mCultureWord := make(map[string][]uint32, 2700)\n    mXhyWord := make(map[string][]uint32, 14032)\n    \n    var wg sync.WaitGroup\n    wg.Add(6)  // 6ç§å†…å®¹ç±»å‹å¹¶å‘æ„å»º\n    \n    // å¹¶å‘æ„å»ºå„ç§ç´¢å¼•ï¼ˆå……åˆ†åˆ©ç”¨å¤šæ ¸ï¼‰\n    go sm.buildPoemIndexAsync(&amp;wg, mPoemWord)\n    go sm.buildAuthorIndexAsync(&amp;wg, mAuthorWord)\n    go sm.buildSentenceIndexAsync(&amp;wg, mSentenceWord)\n    go sm.buildCultureIndexAsync(&amp;wg, mCultureWord)\n    go sm.buildXhyIndexAsync(&amp;wg, mXhyWord)\n    go sm.buildIdiomIndexAsync(&amp;wg)  // æˆè¯­ç´¢å¼•ç‰¹æ®Šå¤„ç†\n    \n    wg.Wait()\n    \n    // åˆå¹¶ç»“æœåˆ°ä¸»ç´¢å¼•\n    sm.mPoemWord = mPoemWord\n    sm.mAuthorWord = mAuthorWord\n    // ... å…¶ä»–ç´¢å¼•\n    \n    sm.saveIndexToFile()  // åºåˆ—åŒ–åˆ°æ–‡ä»¶ä¾›ä¸‹æ¬¡å¿«é€ŸåŠ è½½\n    runtime.GC()          // æ„å»ºå®Œæˆåç«‹å³GCï¼Œé‡Šæ”¾ä¸´æ—¶å†…å­˜\n}\n</code></pre>\n<h3 id=\"32-é’ˆå¯¹å¤æ–‡çš„åˆ†è¯ä¼˜åŒ–\">3.2 é’ˆå¯¹å¤æ–‡çš„åˆ†è¯ä¼˜åŒ–</h3>\n<p>å¤æ–‡ä¸ç°ä»£æ±‰è¯­åˆ†è¯æœ‰å¾ˆå¤§ä¸åŒï¼Œæˆ‘å®ç°äº†å¤šçº§åˆ†è¯ç­–ç•¥ï¼š</p>\n<pre><code class=\"language-go\">func (sm *searchMgr) tokenizeForAncientChinese(text string) []string {\n    var tokens []string\n    \n    // ç¬¬ä¸€çº§ï¼šç»“å·´åˆ†è¯ï¼ˆåŸºç¡€åˆ†è¯ï¼‰\n    words := sm.jieba.Cut(text, true)\n    tokens = append(tokens, words...)\n    \n    // ç¬¬äºŒçº§ï¼šæŒ‰å­—ç¬¦åˆ‡åˆ†ï¼ˆåº”å¯¹åˆ†è¯å™¨é—æ¼ï¼‰\n    runes := []rune(text)\n    for i := 0; i &lt; len(runes); i++ {\n        token := string(runes[i])\n        if !sm.isStopWord(token) {\n            tokens = append(tokens, token)\n        }\n        \n        // å¯¹2-4å­—è¯è¯­ï¼Œé¢å¤–ç”Ÿæˆæ‰€æœ‰å¯èƒ½ç»„åˆ\n        for length := 2; length &lt;= 4 &amp;&amp; i+length &lt;= len(runes); length++ {\n            token := string(runes[i:i+length])\n            if sm.isMeaningfulToken(token) {\n                tokens = append(tokens, token)\n            }\n        }\n    }\n    \n    // ç¬¬ä¸‰çº§ï¼šç‰¹æ®Šå¤„ç†ï¼ˆä½œè€…åã€åœ°åç­‰ï¼‰\n    tokens = sm.specialTokenize(text, tokens)\n    \n    return removeDuplicates(tokens)\n}\n</code></pre>\n<h3 id=\"33-ä½œè€…åæ™ºèƒ½åˆ†è¯\">3.3 ä½œè€…åæ™ºèƒ½åˆ†è¯</h3>\n<p>ä½œè€…åæœç´¢æ˜¯é«˜é¢‘éœ€æ±‚ï¼Œæˆ‘å®ç°äº†ä¸“é—¨çš„ä¼˜åŒ–ï¼š</p>\n<pre><code class=\"language-go\">func (sm *searchMgr) tokenizeAuthorName(name string) []string {\n    tokens := []string{name}  // å®Œæ•´åå­—\n    \n    runes := []rune(name)\n    length := len(runes)\n    \n    // æ ¹æ®åå­—é•¿åº¦é‡‡ç”¨ä¸åŒç­–ç•¥\n    switch {\n    case length == 3:  // å•å­—åï¼Œå¦‚\"æ“\"ï¼ˆæ›¹æ“ï¼‰\n        // å·²åŒ…å«å®Œæ•´åå­—\n        \n    case length == 6:  // åŒå­—åï¼Œå¦‚\"æç™½\"\n        tokens = append(tokens, \n            string(runes[0:3]),  // \"æ\"\n            string(runes[3:6]),  // \"ç™½\"\n            name)                // \"æç™½\"\n            \n    case length == 9:  // ä¸‰å­—åï¼Œå¦‚\"ç™½å±…æ˜“\"\n        tokens = append(tokens,\n            string(runes[0:3]),   // \"ç™½\"\n            string(runes[3:6]),   // \"å±…\"\n            string(runes[6:9]),   // \"æ˜“\"\n            string(runes[0:6]),   // \"ç™½å±…\"\n            string(runes[3:9]),   // \"å±…æ˜“\"\n            name)                 // \"ç™½å±…æ˜“\"\n            \n    case length &gt;= 12:  // å¤šå­—åæˆ–å¸¦å­—ã€å·ï¼Œå¦‚\"æ¬§é˜³ä¿®ï¼ˆæ°¸å”ï¼‰\"\n        // æå–ä¸»è¦éƒ¨åˆ†\n        mainName := sm.extractMainName(name)\n        tokens = append(tokens, mainName)\n        tokens = append(tokens, sm.tokenizeAuthorName(mainName)...)\n    }\n    \n    // æ·»åŠ æ‹¼éŸ³æ”¯æŒ\n    pinyins := sm.pin.Convert(name)\n    tokens = append(tokens, pinyins...)\n    \n    return removeDuplicates(tokens)\n}\n</code></pre>\n<h3 id=\"34-åœç”¨è¯è¡¨çš„ç²¾å¿ƒè®¾è®¡\">3.4 åœç”¨è¯è¡¨çš„ç²¾å¿ƒè®¾è®¡</h3>\n<p>å¤æ–‡ä¸­æœ‰å¤§é‡è™šè¯å’Œå¸¸è§å­—éœ€è¦è¿‡æ»¤ï¼š</p>\n<pre><code class=\"language-go\">func initStopWords() map[string]bool {\n    stopWords := map[string]bool{\n        // æ ‡ç‚¹ç¬¦å·ç±»ï¼ˆ45ä¸ªï¼‰\n        \"\": true, \" \": true, \"\\t\": true, \"\\n\": true, \"\\r\": true,\n        \"ã€‚\": true, \"ï¼Œ\": true, \"ï¼\": true, \"ï¼Ÿ\": true, \"ï¼›\": true,\n        \"ï¼š\": true, \"ã€Œ\": true, \"ã€\": true, \"ã€\": true, \"ã€\": true,\n        \"ã€\": true, \"ã€‘\": true, \"ã€”\": true, \"ã€•\": true, \"ï¼ˆ\": true,\n        \"ï¼‰\": true, \"ã€Š\": true, \"ã€‹\": true, \"ã€ˆ\": true, \"ã€‰\": true,\n        \"â€•\": true, \"â”€\": true, \"ï¼\": true, \"ï½\": true, \"â€§\": true,\n        \"Â·\": true, \"ï¹‘\": true, \"ï¹’\": true, \"ï¼\": true, \"ã€\": true,\n        \"...\": true, \"â€¦â€¦\": true, \"â€”â€”\": true, \"----\": true,\n        \n        // å¸¸è§è™šè¯ç±»ï¼ˆ20ä¸ªï¼‰\n        \"ä¹‹\": true, \"ä¹\": true, \"è€…\": true, \"ä¹Ÿ\": true, \"çŸ£\": true,\n        \"ç„‰\": true, \"å“‰\": true, \"å…®\": true, \"è€¶\": true, \"æ¬¤\": true,\n        \"å°”\": true, \"ç„¶\": true, \"è€Œ\": true, \"åˆ™\": true, \"ä¹ƒ\": true,\n        \"ä¸”\": true, \"è‹¥\": true, \"è™½\": true, \"å› \": true, \"æ•…\": true,\n        \n        // æ•°è¯å’Œé‡è¯ï¼ˆ10ä¸ªï¼‰\n        \"ä¸€\": true, \"äºŒ\": true, \"ä¸‰\": true, \"å\": true, \"ç™¾\": true,\n        \"åƒ\": true, \"ä¸‡\": true, \"ä¸ª\": true, \"é¦–\": true, \"ç¯‡\": true,\n        \n        // å…¶ä»–é«˜é¢‘æ— æ„ä¹‰è¯\n        \"æ›°\": true, \"äº‘\": true, \"è°“\": true, \"å¯¹\": true, \"æ›°\": true,\n    }\n    \n    // åŠ¨æ€è°ƒæ•´ï¼šæ ¹æ®è¯é¢‘ç»Ÿè®¡è‡ªåŠ¨æ›´æ–°\n    if enableDynamicStopWords {\n        stopWords = mergeDynamicStopWords(stopWords)\n    }\n    \n    return stopWords\n}\n</code></pre>\n<h2 id=\"ç¬¬å››ç« æœç´¢ç®—æ³•çš„ç²¾å¦™è®¾è®¡\">ç¬¬å››ç« ï¼šæœç´¢ç®—æ³•çš„ç²¾å¦™è®¾è®¡</h2>\n<h3 id=\"41-å¤šçº§æœç´¢ç­–ç•¥\">4.1 å¤šçº§æœç´¢ç­–ç•¥</h3>\n<pre><code class=\"language-go\">func (sm *searchMgr) Search(query *SearchQuery) *SearchResult {\n    result := &amp;SearchResult{}\n    \n    // ç¬¬1çº§ï¼šç²¾ç¡®åŒ¹é…ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰\n    if exactMatches := sm.exactSearch(query); len(exactMatches) &gt; 0 {\n        result.ExactMatches = exactMatches\n    }\n    \n    // ç¬¬2çº§ï¼šå‰ç¼€åŒ¹é…ï¼ˆæ¬¡ä¼˜å…ˆçº§ï¼‰\n    if prefixMatches := sm.prefixSearch(query); len(prefixMatches) &gt; 0 {\n        result.PrefixMatches = prefixMatches\n    }\n    \n    // ç¬¬3çº§ï¼šåŒ…å«åŒ¹é…ï¼ˆä¸€èˆ¬ä¼˜å…ˆçº§ï¼‰\n    if containMatches := sm.containSearch(query); len(containMatches) &gt; 0 {\n        result.ContainMatches = containMatches\n    }\n    \n    // ç¬¬4çº§ï¼šæ‹¼éŸ³åŒ¹é…ï¼ˆå…œåº•æ–¹æ¡ˆï¼‰\n    if len(result.All()) == 0 {\n        if pinyinMatches := sm.pinyinSearch(query); len(pinyinMatches) &gt; 0 {\n            result.PinyinMatches = pinyinMatches\n        }\n    }\n    \n    // ç¬¬5çº§ï¼šæ™ºèƒ½é‡è¯•ï¼ˆé’ˆå¯¹é•¿æŸ¥è¯¢ï¼‰\n    if len(result.All()) == 0 &amp;&amp; len(query.Text) &gt;= 6 {\n        result = sm.smartRetrySearch(query)\n    }\n    \n    return result\n}\n</code></pre>\n<h3 id=\"42-æˆè¯­æœç´¢çš„é»‘ç§‘æŠ€\">4.2 æˆè¯­æœç´¢çš„é»‘ç§‘æŠ€</h3>\n<p>æˆè¯­æœç´¢éœ€è¦æ”¯æŒä»»æ„ä½ç½®åŒ¹é…ï¼Œæˆ‘å®ç°äº†ç‰¹æ®Šçš„å­ä¸²ç´¢å¼•ï¼š</p>\n<pre><code class=\"language-go\">type IdiomIndex struct {\n    index map[string][]uint32          // å­ä¸²-&gt;æˆè¯­ID\n    idioms map[uint32]*IdiomDetail     // ID-&gt;æˆè¯­è¯¦æƒ…\n    charIndex map[rune][]uint32        // å•å­—ç´¢å¼•ï¼ˆå¿«é€Ÿè¿‡æ»¤ï¼‰\n    lengthIndex map[int][]uint32       // é•¿åº¦ç´¢å¼•ï¼ˆæŒ‰æˆè¯­é•¿åº¦åˆ†ç»„ï¼‰\n}\n\nfunc (idx *IdiomIndex) BuildIndex(idioms []*IdiomDetail) {\n    for _, idiom := range idioms {\n        id := idiom.ID\n        text := idiom.Text  // å¦‚\"ç”»è›‡æ·»è¶³\"\n        \n        // 1. æ·»åŠ åˆ°ä¸»ç´¢å¼•\n        runes := []rune(text)\n        for i := 0; i &lt; len(runes); i++ {\n            for j := i + 1; j &lt;= len(runes); j++ {\n                substr := string(runes[i:j])\n                idx.index[substr] = append(idx.index[substr], id)\n            }\n        }\n        \n        // 2. æ·»åŠ åˆ°å•å­—ç´¢å¼•ï¼ˆç”¨äºå¿«é€Ÿè¿‡æ»¤ï¼‰\n        for _, r := range runes {\n            idx.charIndex[r] = append(idx.charIndex[r], id)\n        }\n        \n        // 3. æŒ‰é•¿åº¦åˆ†ç»„\n        length := len(runes)\n        idx.lengthIndex[length] = append(idx.lengthIndex[length], id)\n        \n        // 4. å­˜å‚¨è¯¦æƒ…\n        idx.idioms[id] = idiom\n    }\n    \n    // ä¼˜åŒ–ï¼šå¯¹ç»“æœå»é‡å’Œæ’åº\n    idx.optimizeIndex()\n}\n</code></pre>\n<h1 id=\"å¤æ–‡è§‚èŠ·æˆè¯­æœç´¢æŠ€æœ¯ç®€è¿°\">å¤æ–‡è§‚èŠ·æˆè¯­æœç´¢æŠ€æœ¯ç®€è¿°</h1>\n<h2 id=\"æ ¸å¿ƒæ•°æ®ç»“æ„å…¨å­ä¸²å€’æ’ç´¢å¼•\">æ ¸å¿ƒæ•°æ®ç»“æ„ï¼š<strong>å…¨å­ä¸²å€’æ’ç´¢å¼•</strong></h2>\n<pre><code class=\"language-go\">type IdiomIndex struct {\n    // ä¸»ç´¢å¼•ï¼šæ‰€æœ‰å­ä¸² -&gt; æˆè¯­IDåˆ—è¡¨\n    // ä¾‹ï¼š\"ç”»è›‡æ·»è¶³\"ä¼šç´¢å¼•æ‰€æœ‰å­ä¸²ï¼š\"ç”»\"ã€\"è›‡\"ã€\"æ·»\"ã€\"è¶³\"ã€\"ç”»è›‡\"ã€\"è›‡æ·»\"...\n    index map[string][]uint32\n}\n</code></pre>\n<h3 id=\"1-å­ä¸²å…¨é‡ç´¢å¼•æ³•\">1. <strong>å­ä¸²å…¨é‡ç´¢å¼•æ³•</strong></h3>\n<ul>\n<li><strong>åŸç†</strong>ï¼šä¸ºæ¯ä¸ªæˆè¯­ç”Ÿæˆ<strong>æ‰€æœ‰å¯èƒ½çš„å­ä¸²ç»„åˆ</strong></li>\n<li><strong>ç®—æ³•å¤æ‚åº¦</strong>ï¼šO(nÂ²)ï¼Œä½†æˆè¯­æœ€é•¿4å­—ï¼Œå®é™…O(16)</li>\n<li><strong>ç¤ºä¾‹</strong>ï¼š\"ç”»è›‡æ·»è¶³\" â†’ ç´¢å¼•\"ç”»\"ã€\"è›‡\"ã€\"æ·»\"ã€\"è¶³\"ã€\"ç”»è›‡\"ã€\"è›‡æ·»\"ã€\"æ·»è¶³\"ã€\"ç”»è›‡æ·»\"...</li>\n</ul>\n<h3 id=\"2-æœç´¢æµç¨‹\">2. <strong>æœç´¢æµç¨‹</strong></h3>\n<pre><code class=\"language-go\">func (idx *IdiomIndex) Search(substr string) []uint32 {\n    // ç›´æ¥mapæŸ¥æ‰¾ï¼šO(1)æ—¶é—´å¤æ‚åº¦\n    return idx.index[substr]  // å¦‚è¾“å…¥\"ç”»è›‡\" â†’ è¿”å›åŒ…å«\"ç”»è›‡\"çš„æ‰€æœ‰æˆè¯­ID\n}\n</code></pre>\n<h3 id=\"3-å†…å­˜ä¼˜åŒ–\">3. <strong>å†…å­˜ä¼˜åŒ–</strong></h3>\n<ul>\n<li>ä½¿ç”¨<code>uint32</code>å­˜å‚¨IDï¼ˆæ”¯æŒ42äº¿æ¡ï¼Œè¶³å¤Ÿï¼‰</li>\n<li>é¢„åˆ†é…å®¹é‡ï¼Œé¿å…åŠ¨æ€æ‰©å®¹</li>\n<li>ç»“æœå»é‡ï¼Œé¿å…é‡å¤æˆè¯­</li>\n</ul>\n<h2 id=\"ä¼˜åŠ¿ç‰¹ç‚¹\">ä¼˜åŠ¿ç‰¹ç‚¹ï¼š</h2>\n<ol>\n<li><strong>æé€Ÿå“åº”</strong>ï¼šç›´æ¥å†…å­˜mapæŸ¥æ‰¾ï¼Œ&lt;0.01ms</li>\n<li><strong>å…¨é¢åŒ¹é…</strong>ï¼šæ”¯æŒä»»æ„ä½ç½®ã€ä»»æ„é•¿åº¦å­ä¸²</li>\n<li><strong>ç®€å•å¯é </strong>ï¼šæ— å¤æ‚ç®—æ³•ï¼Œä»£ç ç®€æ´</li>\n<li><strong>é›¶å¤–éƒ¨ä¾èµ–</strong>ï¼šçº¯Goå®ç°ï¼Œéƒ¨ç½²ç®€å•</li>\n</ol>\n<h2 id=\"æ€§èƒ½æ•°æ®\">æ€§èƒ½æ•°æ®ï¼š</h2>\n<ul>\n<li>3ä¸‡æˆè¯­ â†’ çº¦50ä¸‡ç´¢å¼•é¡¹</li>\n<li>å†…å­˜å ç”¨ï¼š~50MB</li>\n<li>æœç´¢é€Ÿåº¦ï¼š&lt;0.1ms/æ¬¡</li>\n<li>å¹¶å‘èƒ½åŠ›ï¼šå•æœº10000+ QPS</li>\n</ul>\n<p>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆç”¨æˆ·è¾“å…¥\"ç”»è›‡\"èƒ½ç§’çº§æ‰¾åˆ°\"ç”»è›‡æ·»è¶³\"çš„æŠ€æœ¯åŸç†ã€‚</p>\n<h3 id=\"43-ocrè¯†åˆ«æœç´¢ä¼˜åŒ–\">4.3 OCRè¯†åˆ«æœç´¢ä¼˜åŒ–</h3>\n<p>ç”¨æˆ·æ‹ç…§è¯†åˆ«å¤è¯—æ—¶ï¼Œå¾€å¾€æœ‰è¯†åˆ«é”™è¯¯ï¼Œæˆ‘è®¾è®¡äº†å®¹é”™ç®—æ³•ï¼š</p>\n<pre><code class=\"language-go\">func (sm *searchMgr) SearchByOCR(ocrText string, maxDistance int) []*PoemResult {\n    // 1. åˆ†è¯\n    words := sm.jieba.Cut(ocrText, true)\n    \n    // 2. ç»Ÿè®¡æ¯é¦–è¯—è¢«å‘½ä¸­çš„æ¬¡æ•°\n    poemHitCount := make(map[uint32]int)\n    meaningfulWords := make([]string, 0)\n    \n    for _, word := range words {\n        if len([]rune(word)) &lt;= 1 || sm.isStopWord(word) {\n            continue  // è¿‡æ»¤çŸ­è¯å’Œåœç”¨è¯\n        }\n        \n        meaningfulWords = append(meaningfulWords, word)\n        \n        // æŸ¥æ‰¾åŒ…å«è¿™ä¸ªè¯çš„è¯—æ–‡\n        if poemIDs, exists := sm.mPoemWord[word]; exists {\n            for _, id := range poemIDs {\n                poemHitCount[id]++\n            }\n        }\n        \n        // æ¨¡ç³ŠåŒ¹é…ï¼šå…è®¸1-2ä¸ªå­—çš„ç¼–è¾‘è·ç¦»\n        if maxDistance &gt; 0 {\n            fuzzyMatches := sm.fuzzyMatch(word, maxDistance)\n            for _, id := range fuzzyMatches {\n                poemHitCount[id]++\n            }\n        }\n    }\n    \n    // 3. è®¡ç®—æƒé‡åˆ†æ•°\n    type ScoredPoem struct {\n        ID    uint32\n        Score float64\n    }\n    \n    scoredPoems := make([]ScoredPoem, 0, len(poemHitCount))\n    for poemID, hitCount := range poemHitCount {\n        poem := sm.getPoemByID(poemID)\n        if poem == nil {\n            continue\n        }\n        \n        // åˆ†æ•° = å‘½ä¸­æ¬¡æ•° * æƒé‡ç³»æ•°\n        score := float64(hitCount)\n        \n        // å¢åŠ é•¿è¯çš„æƒé‡\n        for _, word := range meaningfulWords {\n            if len([]rune(word)) &gt;= 3 &amp;&amp; containsPoemText(poem, word) {\n                score += 0.5\n            }\n        }\n        \n        // è€ƒè™‘è¯—å¥ä½ç½®æƒé‡ï¼ˆæ ‡é¢˜æƒé‡é«˜äºå†…å®¹ï¼‰\n        if containsPoemTitle(poem, meaningfulWords) {\n            score *= 1.5\n        }\n        \n        scoredPoems = append(scoredPoems, ScoredPoem{poemID, score})\n    }\n    \n    // 4. æ’åºå¹¶è¿”å›Top N\n    sort.Slice(scoredPoems, func(i, j int) bool {\n        return scoredPoems[i].Score &gt; scoredPoems[j].Score\n    })\n    \n    return sm.buildResults(scoredPoems[:min(10, len(scoredPoems))])\n}\n</code></pre>\n<h3 id=\"44-æœç´¢ç»“æœæ’åºç®—æ³•\">4.4 æœç´¢ç»“æœæ’åºç®—æ³•</h3>\n<pre><code class=\"language-go\">func (sm *searchMgr) rankResults(results []*SearchItem, query string) []*SearchItem {\n    type ScoredItem struct {\n        Item  *SearchItem\n        Score float64\n    }\n    \n    scoredItems := make([]ScoredItem, len(results))\n    queryRunes := []rune(query)\n    \n    for i, item := range results {\n        score := 0.0\n        \n        // 1. å®Œå…¨åŒ¹é…å¾—åˆ†ï¼ˆæœ€é«˜ï¼‰\n        if item.Text == query {\n            score += 1000\n        }\n        \n        // 2. å¼€å¤´åŒ¹é…å¾—åˆ†ï¼ˆæ¬¡é«˜ï¼‰\n        if strings.HasPrefix(item.Text, query) {\n            score += 500\n        }\n        \n        // 3. é•¿åº¦ç›¸ä¼¼æ€§å¾—åˆ†\n        itemRunes := []rune(item.Text)\n        lengthDiff := abs(len(itemRunes) - len(queryRunes))\n        score += 50 / (float64(lengthDiff) + 1)\n        \n        // 4. è¯é¢‘æƒé‡ï¼ˆTF-IDFç®€åŒ–ç‰ˆï¼‰\n        wordFrequency := sm.calculateWordFrequency(item, query)\n        score += wordFrequency * 10\n        \n        // 5. çƒ­åº¦æƒé‡ï¼ˆçƒ­é—¨å†…å®¹ä¼˜å…ˆï¼‰\n        if item.ViewCount &gt; 1000 {\n            score += math.Log10(float64(item.ViewCount))\n        }\n        \n        // 6. æ—¶é—´æƒé‡ï¼ˆæ–°å†…å®¹é€‚å½“æå‡ï¼‰\n        if item.CreateTime &gt; time.Now().Add(-30*24*time.Hour).Unix() {\n            score += 10\n        }\n        \n        scoredItems[i] = ScoredItem{item, score}\n    }\n    \n    // æ’åº\n    sort.Slice(scoredItems, func(i, j int) bool {\n        return scoredItems[i].Score &gt; scoredItems[j].Score\n    })\n    \n    // è¿”å›æ’åºåçš„ç»“æœ\n    rankedItems := make([]*SearchItem, len(scoredItems))\n    for i, scored := range scoredItems {\n        rankedItems[i] = scored.Item\n    }\n    \n    return rankedItems\n}\n</code></pre>\n<h2 id=\"ç¬¬äº”ç« æ€§èƒ½ä¼˜åŒ–æ·±åº¦å‰–æ\">ç¬¬äº”ç« ï¼šæ€§èƒ½ä¼˜åŒ–æ·±åº¦å‰–æ</h2>\n<h3 id=\"51-å¹¶å‘å®‰å…¨ä¸æ€§èƒ½å¹³è¡¡\">5.1 å¹¶å‘å®‰å…¨ä¸æ€§èƒ½å¹³è¡¡</h3>\n<p><strong>åªè¯»æ¶æ„çš„ä¼˜åŠ¿</strong>ï¼š</p>\n<pre><code class=\"language-go\">// æ‰€æœ‰ç´¢å¼•æ•°æ®åªè¯»ï¼Œæ— éœ€é”ä¿æŠ¤\nvar SearchMgr = &amp;searchMgr{\n    mPoemWord:     make(map[string][]uint32),  // å¯åŠ¨æ—¶åˆå§‹åŒ–ï¼Œä¹‹ååªè¯»\n    mAuthorWord:   make(map[string][]uint32),\n    // ... å…¶ä»–ç´¢å¼•\n}\n\n// æœç´¢å‡½æ•°æ˜¯çº¯å‡½æ•°ï¼Œçº¿ç¨‹å®‰å…¨\nfunc (sm *searchMgr) searchPoem(keyword string) []*PoemResult {\n    // ç›´æ¥è¯»å–ï¼Œæ— é”å¼€é”€\n    poemIDs := sm.mPoemWord[keyword]  // O(1)æ—¶é—´å¤æ‚åº¦\n    \n    results := make([]*PoemResult, 0, len(poemIDs))\n    for _, id := range poemIDs {\n        poem := sm.poemList[id]  // æ•°ç»„ç›´æ¥ç´¢å¼•ï¼ŒO(1)\n        if poem != nil {\n            results = append(results, convertToResult(poem))\n        }\n    }\n    \n    return results\n}\n</code></pre>\n<h3 id=\"52-å†…å­˜ä¼˜åŒ–å®æˆ˜\">5.2 å†…å­˜ä¼˜åŒ–å®æˆ˜</h3>\n<p><strong>ä¼˜åŒ–å‰</strong>ï¼šæ¯ä¸ªç´¢å¼•é¡¹éƒ½å­˜å‚¨å®Œæ•´å­—ç¬¦ä¸²<br />\n<strong>ä¼˜åŒ–å</strong>ï¼šä½¿ç”¨å­—ç¬¦ä¸²é©»ç•™å’Œæ•´æ•°ID</p>\n<pre><code class=\"language-go\">// å­—ç¬¦ä¸²é©»ç•™æ± \ntype StringPool struct {\n    strings map[string]string  // åŸå§‹-&gt;è§„èŒƒæ˜ å°„\n    ids     map[string]uint32  // å­—ç¬¦ä¸²-&gt;IDæ˜ å°„\n    values  []string           // ID-&gt;å­—ç¬¦ä¸²åå‘æ˜ å°„\n}\n\nfunc (sp *StringPool) Intern(s string) uint32 {\n    if id, exists := sp.ids[s]; exists {\n        return id\n    }\n    \n    // æ–°å­—ç¬¦ä¸²ï¼Œåˆ†é…ID\n    id := uint32(len(sp.values))\n    sp.values = append(sp.values, s)\n    sp.ids[s] = id\n    sp.strings[s] = s\n    \n    return id\n}\n\n// ä½¿ç”¨å­—ç¬¦ä¸²æ± ä¼˜åŒ–åçš„ç´¢å¼•\ntype OptimizedIndex struct {\n    pool   *StringPool\n    index  map[uint32][]uint32  // å­—ç¬¦ä¸²ID-&gt;å†…å®¹IDåˆ—è¡¨\n}\n\nfunc (oi *OptimizedIndex) Search(s string) []uint32 {\n    strID := oi.pool.Intern(s)\n    return oi.index[strID]\n}\n</code></pre>\n<h3 id=\"53-ç¼“å­˜ç­–ç•¥çš„å¤šå±‚è®¾è®¡\">5.3 ç¼“å­˜ç­–ç•¥çš„å¤šå±‚è®¾è®¡</h3>\n<pre><code class=\"language-go\">type SearchCache struct {\n    // L1ç¼“å­˜ï¼šçƒ­ç‚¹æŸ¥è¯¢ç»“æœï¼ˆå†…å­˜ï¼‰\n    l1Cache *lru.Cache  // æœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼Œå®¹é‡1000\n    \n    // L2ç¼“å­˜ï¼šé«˜é¢‘è¯ç´¢å¼•ï¼ˆå†…å­˜ï¼‰\n    l2HotWords map[string][]uint32\n    \n    // L3ç¼“å­˜ï¼šæŒä¹…åŒ–ç´¢å¼•ï¼ˆæ–‡ä»¶ï¼‰\n    indexPath string\n    \n    // æŸ¥è¯¢ç»Ÿè®¡\n    stats struct {\n        totalQueries int64\n        l1Hits       int64\n        l2Hits       int64\n        l3Hits       int64\n    }\n}\n\nfunc (sc *SearchCache) Get(query string) ([]uint32, bool) {\n    sc.stats.totalQueries++\n    \n    // 1. æ£€æŸ¥L1ç¼“å­˜\n    if result, ok := sc.l1Cache.Get(query); ok {\n        sc.stats.l1Hits++\n        return result.([]uint32), true\n    }\n    \n    // 2. æ£€æŸ¥L2ç¼“å­˜ï¼ˆé«˜é¢‘è¯ï¼‰\n    if result, ok := sc.l2HotWords[query]; ok {\n        sc.stats.l2Hits++\n        // åŒæ—¶æ”¾å…¥L1ç¼“å­˜\n        sc.l1Cache.Add(query, result)\n        return result, true\n    }\n    \n    // 3. ä»L3ï¼ˆä¸»ç´¢å¼•ï¼‰åŠ è½½\n    if result := sc.loadFromIndex(query); result != nil {\n        sc.stats.l3Hits++\n        // æ”¾å…¥L1å’ŒL2ç¼“å­˜\n        sc.l1Cache.Add(query, result)\n        if sc.isHotWord(query) {\n            sc.l2HotWords[query] = result\n        }\n        return result, true\n    }\n    \n    return nil, false\n}\n</code></pre>\n<h3 id=\"54-æ€§èƒ½ç›‘æ§ä¸è°ƒä¼˜\">5.4 æ€§èƒ½ç›‘æ§ä¸è°ƒä¼˜</h3>\n<pre><code class=\"language-go\">type PerformanceMonitor struct {\n    metrics struct {\n        searchLatency    prometheus.Histogram\n        cacheHitRate     prometheus.Gauge\n        memoryUsage      prometheus.Gauge\n        queryPerSecond   prometheus.Counter\n    }\n    \n    history struct {\n        dailyStats map[string]*DailyStat\n        slowQueries []*SlowQueryLog\n    }\n}\n\nfunc (pm *PerformanceMonitor) RecordSearch(query string, latency time.Duration, hitCache bool) {\n    // è®°å½•å»¶è¿Ÿ\n    pm.metrics.searchLatency.Observe(latency.Seconds() * 1000)  // è½¬æ¢ä¸ºæ¯«ç§’\n    \n    // è®°å½•QPS\n    pm.metrics.queryPerSecond.Inc()\n    \n    // è®°å½•æ…¢æŸ¥è¯¢\n    if latency &gt; 50*time.Millisecond {\n        pm.history.slowQueries = append(pm.history.slowQueries, &amp;SlowQueryLog{\n            Query:    query,\n            Latency:  latency,\n            Timestamp: time.Now(),\n        })\n        \n        // ä¿ç•™æœ€è¿‘1000æ¡æ…¢æŸ¥è¯¢\n        if len(pm.history.slowQueries) &gt; 1000 {\n            pm.history.slowQueries = pm.history.slowQueries[1:]\n        }\n    }\n    \n    // æ›´æ–°ç¼“å­˜å‘½ä¸­ç‡\n    if hitCache {\n        // è®¡ç®—å¹¶æ›´æ–°å‘½ä¸­ç‡\n        pm.updateCacheHitRate()\n    }\n}\n</code></pre>\n<h2 id=\"ç¬¬å…­ç« å®é™…æ•ˆæœä¸æ€§èƒ½æ•°æ®\">ç¬¬å…­ç« ï¼šå®é™…æ•ˆæœä¸æ€§èƒ½æ•°æ®</h2>\n<h3 id=\"61-æ€§èƒ½åŸºå‡†æµ‹è¯•\">6.1 æ€§èƒ½åŸºå‡†æµ‹è¯•</h3>\n<p><strong>æµ‹è¯•ç¯å¢ƒ</strong>ï¼š</p>\n<ul>\n<li>CPU: 4æ ¸ Intel Xeon 2.5GHz</li>\n<li>å†…å­˜: 8GB</li>\n<li>Goç‰ˆæœ¬: 1.19</li>\n<li>æ•°æ®é‡: 50ä¸‡æ¡å¤æ–‡è®°å½•</li>\n</ul>\n<p><strong>æ€§èƒ½æ•°æ®</strong>ï¼š</p>\n<table>\n<thead>\n<tr>\n<th>æŒ‡æ ‡</th>\n<th>æ•°å€¼</th>\n<th>è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>ç´¢å¼•æ„å»ºæ—¶é—´</td>\n<td>3.5ç§’</td>\n<td>é¦–æ¬¡æ„å»ºï¼ˆå¹¶è¡Œä¼˜åŒ–ï¼‰</td>\n</tr>\n<tr>\n<td>ç´¢å¼•åŠ è½½æ—¶é—´</td>\n<td>0.8ç§’</td>\n<td>ä»æ–‡ä»¶åŠ è½½ï¼ˆåç»­å¯åŠ¨ï¼‰</td>\n</tr>\n<tr>\n<td>å¹³å‡æœç´¢å»¶è¿Ÿ</td>\n<td>3.2æ¯«ç§’</td>\n<td>50ä¸‡æ¡æ•°æ®ä¸­æœç´¢</td>\n</tr>\n<tr>\n<td>P99å»¶è¿Ÿ</td>\n<td>9.8æ¯«ç§’</td>\n<td>99%è¯·æ±‚ä½äºæ­¤å€¼</td>\n</tr>\n<tr>\n<td>å†…å­˜å ç”¨</td>\n<td>400MB</td>\n<td>åŒ…å«æ‰€æœ‰æ•°æ®å’Œç´¢å¼•</td>\n</tr>\n<tr>\n<td>å¹¶å‘QPS</td>\n<td>15,000+</td>\n<td>4æ ¸CPUæµ‹è¯•ç»“æœ</td>\n</tr>\n<tr>\n<td>ç¼“å­˜å‘½ä¸­ç‡</td>\n<td>99%+</td>\n<td>çƒ­ç‚¹æŸ¥è¯¢ä¼˜åŒ–å</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"62-ä¸ç«å“å¯¹æ¯”\">6.2 ä¸ç«å“å¯¹æ¯”</h3>\n<table>\n<thead>\n<tr>\n<th>ç‰¹æ€§</th>\n<th>å¤æ–‡è§‚èŠ·ï¼ˆè‡ªç ”ï¼‰</th>\n<th>æŸç«å“ï¼ˆElasticsearchï¼‰</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>æœç´¢å“åº”æ—¶é—´</td>\n<td>3.2ms</td>\n<td>45ms</td>\n</tr>\n<tr>\n<td>å†·å¯åŠ¨æ—¶é—´</td>\n<td>0.8s</td>\n<td>3.5s</td>\n</tr>\n<tr>\n<td>å†…å­˜å ç”¨</td>\n<td>400MB</td>\n<td>2.5GB+</td>\n</tr>\n<tr>\n<td>éƒ¨ç½²å¤æ‚åº¦</td>\n<td>å•äºŒè¿›åˆ¶æ–‡ä»¶</td>\n<td>éœ€è¦ESé›†ç¾¤</td>\n</tr>\n<tr>\n<td>è¿ç»´æˆæœ¬</td>\n<td>æ¥è¿‘é›¶</td>\n<td>éœ€è¦ä¸“ä¸šè¿ç»´</td>\n</tr>\n<tr>\n<td>å¹´è´¹ç”¨</td>\n<td>$0ï¼ˆä»…æœåŠ¡å™¨ï¼‰</td>\n<td>$600+ï¼ˆäº‘æœåŠ¡ï¼‰</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"63-ç”¨æˆ·åé¦ˆæ•°æ®\">6.3 ç”¨æˆ·åé¦ˆæ•°æ®</h3>\n<ul>\n<li><strong>æœç´¢æˆåŠŸç‡</strong>ï¼š98.7%ï¼ˆåŒ…å«æ¨¡ç³ŠåŒ¹é…ï¼‰</li>\n<li><strong>ç”¨æˆ·æ»¡æ„åº¦</strong>ï¼š4.8/5.0ï¼ˆåŸºäºåº”ç”¨å•†åº—è¯„ä»·ï¼‰</li>\n<li><strong>æ—¥æ´»è·ƒç”¨æˆ·</strong>ï¼š50,000+</li>\n<li><strong>æ—¥å‡æœç´¢é‡</strong>ï¼š1,200,000+æ¬¡</li>\n<li><strong>å³°å€¼QPS</strong>ï¼š8,000+ï¼ˆè€ƒè¯•å­£æœŸé—´ï¼‰</li>\n</ul>\n<h2 id=\"ç¬¬ä¸ƒç« æŠ€æœ¯æ–¹æ¡ˆçš„æ™®é€‚æ€§ä¸æ‰©å±•æ€§\">ç¬¬ä¸ƒç« ï¼šæŠ€æœ¯æ–¹æ¡ˆçš„æ™®é€‚æ€§ä¸æ‰©å±•æ€§</h2>\n<h3 id=\"71-é€‚ç”¨åœºæ™¯æ€»ç»“\">7.1 é€‚ç”¨åœºæ™¯æ€»ç»“</h3>\n<p>è¿™ç§è‡ªç ”å†…å­˜æœç´¢æ–¹æ¡ˆç‰¹åˆ«é€‚åˆï¼š</p>\n<ol>\n<li><strong>æ•°æ®é‡æœ‰é™</strong>ï¼šç™¾ä¸‡çº§ä»¥ä¸‹æ•°æ®é‡</li>\n<li><strong>æ›´æ–°é¢‘ç‡ä½</strong>ï¼šæ—¥æ›´æ–°&lt;1%çš„æ•°æ®</li>\n<li><strong>æ€§èƒ½è¦æ±‚é«˜</strong>ï¼šéœ€è¦æ¯«ç§’çº§å“åº”</li>\n<li><strong>æˆæœ¬æ•æ„Ÿ</strong>ï¼šä¸ªäººæˆ–å°å›¢é˜Ÿé¡¹ç›®</li>\n<li><strong>ç‰¹å®šé¢†åŸŸ</strong>ï¼šéœ€è¦æ·±åº¦å®šåˆ¶åˆ†è¯å’Œæœç´¢é€»è¾‘</li>\n</ol>\n<h3 id=\"72-å¯æ‰©å±•æ€§è®¾è®¡\">7.2 å¯æ‰©å±•æ€§è®¾è®¡</h3>\n<p>è™½ç„¶å½“å‰è®¾è®¡æ˜¯å•æœºæ–¹æ¡ˆï¼Œä½†å¯ä»¥æ‰©å±•ä¸ºåˆ†å¸ƒå¼ï¼Œæ¯å°æœºå™¨éƒ½æ˜¯å…¨é‡åŠ è½½æ•°æ®ï¼Œå…¨é‡ç´¢å¼•</p>\n<h3 id=\"73-æœªæ¥ä¼˜åŒ–æ–¹å‘\">7.3 æœªæ¥ä¼˜åŒ–æ–¹å‘</h3>\n<ol>\n<li><strong>å‘é‡æœç´¢é›†æˆ</strong>ï¼šç»“åˆBERTç­‰æ¨¡å‹å®ç°è¯­ä¹‰æœç´¢</li>\n<li><strong>ä¸ªæ€§åŒ–æ¨è</strong>ï¼šåŸºäºç”¨æˆ·å†å²ä¼˜åŒ–æœç´¢æ’åº</li>\n<li><strong>å®æ—¶ç´¢å¼•æ›´æ–°</strong>ï¼šæ”¯æŒå¢é‡æ›´æ–°è€Œä¸é‡å»ºå…¨é‡ç´¢å¼•</li>\n<li><strong>å¤šè¯­è¨€æ”¯æŒ</strong>ï¼šæ‰©å±•æ”¯æŒå¤æ–‡æ³¨é‡Šçš„ç°ä»£æ±‰è¯­ç¿»è¯‘</li>\n<li><strong>è¯­éŸ³æœç´¢</strong>ï¼šé›†æˆè¯­éŸ³è¯†åˆ«ï¼Œæ”¯æŒè¯­éŸ³è¾“å…¥æœç´¢</li>\n</ol>\n<h2 id=\"ç¬¬å…«ç« æ€»ç»“ä¸å¯ç¤º\">ç¬¬å…«ç« ï¼šæ€»ç»“ä¸å¯ç¤º</h2>\n<p>å¤æ–‡è§‚èŠ·çš„æœç´¢æ–¹æ¡ˆæ˜¯ä¸€ä¸ªå…¸å‹çš„æŠ€æœ¯åŠ¡å®ä¸»ä¹‰æ¡ˆä¾‹ã€‚é€šè¿‡æ·±å…¥åˆ†æéœ€æ±‚ç‰¹ç‚¹ï¼Œæˆ‘é€‰æ‹©äº†ä¸€æ¡ä¸åŒäºä¸»æµä½†æå…¶æœ‰æ•ˆçš„æŠ€æœ¯è·¯çº¿ã€‚è¿™ä¸ªæ–¹æ¡ˆè¯æ˜äº†ï¼š</p>\n<ol>\n<li><strong>ç®€å•å³æœ‰æ•ˆ</strong>ï¼šæœ€ç›´æ¥çš„æ•°æ®ç»“æ„ï¼ˆmap+sliceï¼‰å¾€å¾€èƒ½æä¾›æœ€ä½³æ€§èƒ½</li>\n<li><strong>å®šåˆ¶åŒ–ä¼˜åŠ¿</strong>ï¼šé’ˆå¯¹ç‰¹å®šé¢†åŸŸæ·±åº¦ä¼˜åŒ–çš„æ•ˆæœè¶…è¿‡é€šç”¨æ–¹æ¡ˆ</li>\n<li><strong>æˆæœ¬æ„è¯†</strong>ï¼šä¸ªäººå¼€å‘è€…éœ€è¦ç²¾æ‰“ç»†ç®—ï¼Œé€‰æ‹©æ€§ä»·æ¯”æœ€é«˜çš„æ–¹æ¡ˆ</li>\n<li><strong>æ€§èƒ½ä¸ºç‹</strong>ï¼šç”¨æˆ·ä½“éªŒçš„æ ¸å¿ƒæ˜¯å“åº”é€Ÿåº¦ï¼ŒæŠ€æœ¯åº”ä¸ºä½“éªŒæœåŠ¡</li>\n</ol>\n<p>è¿™å¥—æ–¹æ¡ˆå·²ç»ç¨³å®šè¿è¡Œä¸¤å¹´å¤šï¼ŒæœåŠ¡äº†æ•°ç™¾ä¸‡ç”¨æˆ·ï¼Œè¯æ˜äº†å…¶å¯é æ€§å’Œä¼˜è¶Šæ€§ã€‚å¯¹äºé¢ä¸´ç±»ä¼¼åœºæ™¯çš„å¼€å‘è€…ï¼Œæˆ‘å»ºè®®ï¼š</p>\n<ul>\n<li><strong>æ·±å…¥åˆ†æéœ€æ±‚</strong>ï¼šä¸è¦ç›²ç›®é€‰æ‹©æŠ€æœ¯ï¼Œå…ˆç†è§£æ•°æ®ç‰¹ç‚¹å’Œç”¨æˆ·éœ€æ±‚</li>\n<li><strong>å‹‡äºè‡ªç ”</strong>ï¼šå½“ç°æœ‰æ–¹æ¡ˆä¸å¤ŸåŒ¹é…æ—¶ï¼Œè‡ªå·±åŠ¨æ‰‹å¯èƒ½æ˜¯æœ€å¥½çš„é€‰æ‹©</li>\n<li><strong>æŒç»­ä¼˜åŒ–</strong>ï¼šä»å®é™…ä½¿ç”¨æ•°æ®ä¸­å­¦ä¹ ï¼Œä¸æ–­æ”¹è¿›ç®—æ³•å’Œå®ç°</li>\n<li><strong>ä¿æŒç®€æ´</strong>ï¼šæœ€ç®€å•çš„è§£å†³æ–¹æ¡ˆå¾€å¾€æœ€å¯é ã€æœ€æ˜“ç»´æŠ¤</li>\n</ul>\n<p>æŠ€æœ¯æ–¹æ¡ˆæ²¡æœ‰ç»å¯¹çš„å¥½åï¼Œåªæœ‰é€‚åˆä¸å¦ã€‚å¤æ–‡è§‚èŠ·çš„æœç´¢æ–¹æ¡ˆï¼Œæ­£æ˜¯\"é€‚åˆçš„æ‰æ˜¯æœ€å¥½çš„\"è¿™ä¸€ç†å¿µçš„å®Œç¾ä½“ç°ã€‚</p>\n<p><a href=\"https://www.cnblogs.com/hlxs/p/19413138\" target=\"_blank\">å¤æ–‡è§‚èŠ·-æ‹ç…§æœå¤æ–‡åŠŸèƒ½ï¼šæ¯”ç«å“å¿«10000å€</a></p>\n<p><strong>åå‡ å¹´çš„å›­å‹ï¼Œä¸‹è½½ä½“éªŒä¸€ä¸‹å§ï¼Œåº”ç”¨å¸‚åœºæœç´¢ï¼šå¤æ–‡è§‚èŠ·</strong></p>\n\n\n</div>\n<div class=\"clear\"></div>\n\n            </div>\n            <div class=\"postDesc\">posted @ \n<span id=\"post-date\">2026-02-01 22:27</span>&nbsp;\n<a href=\"https://www.cnblogs.com/hlxs\">å¤æ–‡è§‚èŠ·</a>&nbsp;\né˜…è¯»(<span id=\"post_view_count\">19</span>)&nbsp;\nè¯„è®º(<span id=\"post_comment_count\">1</span>)&nbsp;\n&nbsp;\n<a href=\"\">æ”¶è—</a>&nbsp;\n<a href=\"\">ä¸¾æŠ¥</a>\n</div>"
    },
    {
      "title": "æ˜æ˜ç¯å¢ƒå˜é‡å·²ç»è§£å¯†ï¼Œä¸ºå•¥@ConfigurationProperties æ³¨å…¥è¿˜æ˜¯åŠ å¯†å€¼ï¼Ÿ",
      "link": "https://www.cnblogs.com/javadaydayup/p/19561154",
      "published": "",
      "description": "<h1 class=\"postTitle\">\n                <a class=\"postTitle2 vertical-middle\" href=\"https://www.cnblogs.com/javadaydayup/p/19561154\" id=\"cb_post_title_url\" title=\"å‘å¸ƒäº 2026-02-01 17:25\">\n    <span>æ˜æ˜ç¯å¢ƒå˜é‡å·²ç»è§£å¯†ï¼Œä¸ºå•¥@ConfigurationProperties æ³¨å…¥è¿˜æ˜¯åŠ å¯†å€¼ï¼Ÿ</span>\n    \n\n</a>\n\n            </h1>\n            <div class=\"clear\"></div>\n            <div class=\"postBody\">\n                    <div id=\"cnblogs_post_description\" style=\"display: none;\">\n        <img alt=\"æ˜æ˜ç¯å¢ƒå˜é‡å·²ç»è§£å¯†ï¼Œä¸ºå•¥@ConfigurationProperties æ³¨å…¥è¿˜æ˜¯åŠ å¯†å€¼ï¼Ÿ\" class=\"desc_img\" src=\"https://img2024.cnblogs.com/blog/1878162/202602/1878162-20260201172521159-1975418198.png\" />\n        æ˜æ˜ç¯å¢ƒå˜é‡å·²ç»è§£å¯†ï¼Œä¸ºå•¥@ConfigurationProperties æ³¨å…¥è¿˜æ˜¯åŠ å¯†å€¼ï¼Ÿæœ¬æ–‡å°†ä»æºç è§’åº¦è¿›è¡Œå‰–æï¼\n    </div>\n<div class=\"blogpost-body cnblogs-markdown\" id=\"cnblogs_post_body\">\n<h2 id=\"é—®é¢˜èƒŒæ™¯\">é—®é¢˜èƒŒæ™¯</h2>\n<p>åœ¨å¾®æœåŠ¡çš„ application.properties æ–‡ä»¶ä¸­æœ‰ä¸€ä¸ª <code>test.container-name</code> é…ç½®ã€‚åŸå§‹é…ç½®å¦‚ä¸‹ï¼š</p>\n<pre><code class=\"language-json\">test.container-name=Tomcat\n</code></pre>\n<p>åŒæ—¶æœ‰ä¸€ä¸ª Java ç±» <code>TestConfigProperty</code> ä¸­é€šè¿‡ <code>@ConfigurationProperties</code> æ³¨è§£æ³¨å…¥è¿™ä¸ªé…ç½®å±æ€§åˆ°å®ƒçš„å˜é‡ <code>containerName</code> ä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>\n<pre><code class=\"language-java\">@ConfigurationProperties(prefix = \"test\")  \n@Component  \npublic class TestConfigProperty {  \n    private String containerName;  \n  \n    public String getContainerName() {  \n        return containerName;  \n    }  \n  \n    public void setContainerName(String containerName) {  \n        this.containerName = containerName;  \n    }  \n}\n</code></pre>\n<p>ç°åœ¨å› ä¸º <code>test.container-name</code> é…ç½®åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼Œä¸èƒ½ç›´æ¥é…ç½®åŸå§‹çš„å€¼ï¼Œéœ€è¦é…ç½®åŠ å¯†ä¹‹åçš„å€¼ï¼Œåœ¨å¾®æœåŠ¡å¯åŠ¨çš„æ—¶å€™è§£å¯†ã€‚ç°åœ¨æ˜¯ <code>test.container-name</code> é…ç½®å¼•ç”¨äº† <code>TEST_CONTAINER_NAME</code> ç¯å¢ƒå˜é‡ã€‚é…ç½®å¦‚ä¸‹ï¼š</p>\n<pre><code class=\"language-json\">test.container-name=${TEST_CONTAINER_NAME}\n</code></pre>\n<p>ç„¶ååœ¨ç¯å¢ƒå˜é‡ä¸­é…ç½®äº†åŠ å¯†ä¹‹åçš„å€¼ã€‚åœ¨æœ¬æ¡ˆä¾‹ä¸­ä¸ºäº†ç®€åŒ–ï¼Œè¿™é‡ŒåŠ å¯†å°±ç”¨çš„ Base64 ç¼–ç ä½œä¸ºç¤ºä¾‹æ¼”ç¤ºã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br />\n<img alt=\"image.png\" src=\"https://raw.githubusercontent.com/javadaydayup/pictures/main/20260131165916.png\" /></p>\n<p><img alt=\"image.png\" src=\"https://raw.githubusercontent.com/javadaydayup/pictures/main/20260131170021.png\" /></p>\n<p>åœ¨é¡¹ç›®ä¸­æœ‰æ¡†æ¶æä¾›äº†åœ¨å¾®æœåŠ¡å¯åŠ¨æ—¶å¯¹åŠ å¯†åçš„å­—ç¬¦ä¸²è§£å¯†çš„èƒ½åŠ›ï¼Œå®ç°çš„åŸºæœ¬åŸç†æ˜¯æä¾›äº†ä¸€ä¸ª <code>DecryptEnvironmentPostProcessor</code> ç±»æ‰©å±•äº† <code>EnvironmentPostProcessor</code>ã€‚</p>\n<p>åœ¨å®ƒçš„ <code>postProcessEnvironment()</code> æ–¹æ³•ä¸­ï¼Œåˆ¤æ–­ç¯å¢ƒå˜é‡é…ç½®çš„å€¼æ˜¯å¦æ˜¯ä»¥ <code>ENC_</code> å¼€å¤´ï¼Œå¦‚æœæ˜¯åˆ™è¿›è¡Œè§£å¯†ã€‚è§£å¯†ä¹‹åæ”¾åˆ°ä¸€ä¸ª <code>MapPropertySource</code> é‡Œé¢ï¼Œç„¶åæ·»åŠ åˆ°æ‰€æœ‰çš„ <code>PropertySource</code> çš„å‰é¢ã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p>\n<pre><code class=\"language-java\">public class DecryptEnvironmentPostProcessor implements EnvironmentPostProcessor, Ordered {  \n    private static final String DECRYPTED_SOURCE_NAME = \"decryptedSystemEnvironment\";  \n  \n    @Override  \n    public void postProcessEnvironment(ConfigurableEnvironment environment, SpringApplication application) {  \n        String systemEnvName = StandardEnvironment.SYSTEM_ENVIRONMENT_PROPERTY_SOURCE_NAME;  \n        MapPropertySource systemEnvSource = (MapPropertySource) environment.getPropertySources().get(systemEnvName);  \n        Map&lt;String, Object&gt; decryptedMap = new HashMap&lt;&gt;();  \n        if (systemEnvSource == null) {  \n            return;  \n        }  \n        systemEnvSource.getSource().forEach((key, value) -&gt; {  \n            if (value instanceof String strVal) {  \n                // è¿™é‡Œè¿›è¡Œäº†è§£å¯†\n                if (StringUtils.isNotEmpty(strVal) &amp;&amp; strVal.startsWith(\"ENC_\")) {  \n                    String plainText = new String(Base64.getDecoder().decode(strVal.substring(4)));  \n                    decryptedMap.put(key, plainText);  \n                }  \n            }  \n        });  \n  \n        if (!decryptedMap.isEmpty()) {  \n            MapPropertySource decryptedSource = new MapPropertySource(DECRYPTED_SOURCE_NAME, decryptedMap);  \n            // è¿™é‡Œæ·»åŠ åˆ°æ‰€æœ‰çš„PropertySourceçš„å‰é¢\n            environment.getPropertySources().addBefore(systemEnvName, decryptedSource);  \n        }  \n    }  \n  \n    @Override  \n    public int getOrder() {  \n        return Ordered.LOWEST_PRECEDENCE;  \n    }  \n}\n</code></pre>\n<p>æŒ‰ç…§ä¸Šè¿°é…ç½®ï¼Œé€šè¿‡è°ƒè¯•å‘ç°ç±» <code>TestConfigProperty</code> é‡Œé¢æ³¨å…¥çš„è¿˜æ˜¯åŠ å¯†ä¹‹åçš„å€¼ï¼Œè€Œå¹¶ä¸æ˜¯æƒ³è¦çš„è§£å¯†ä¹‹åçš„å€¼ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br />\n<img alt=\"image.png\" src=\"https://raw.githubusercontent.com/javadaydayup/pictures/main/20260131172818.png\" /><br />\næŸ¥çœ‹ <code>Environment</code> çš„ <code>getPropertySources()</code> æ–¹æ³•çš„è¿”å›å€¼ä¸­ï¼Œè§£å¯†ä¹‹åçš„ç¯å¢ƒå˜é‡å±æ€§é…ç½®ç¡®å®æ˜¯åœ¨æœªè§£å¯†çš„ç¯å¢ƒå˜é‡å±æ€§é…ç½®ä¹‹å‰ï¼ŒæŒ‰ç…§ç›´è§‚ä¸Šçš„ç†è§£ï¼Œé‚£åº”è¯¥æ³¨å…¥çš„æ˜¯è§£å¯†ä¹‹åçš„å€¼æ‰å¯¹ï¼Œä½†æ˜¯å®é™…ç»“æœå´ä¸æ˜¯è¿™æ ·çš„ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br />\n<img alt=\"image.png\" src=\"https://raw.githubusercontent.com/javadaydayup/pictures/main/20260201105947.png\" /></p>\n<h2 id=\"é—®é¢˜åŸç†\">é—®é¢˜åŸç†</h2>\n<p>ä¹‹å‰çš„æ–‡ç« <a href=\"https://zhuanlan.zhihu.com/p/1920208706978678739\" rel=\"noopener nofollow\" target=\"_blank\">è¿™å°±æ˜¯å®½æ¾çš„é€‚é…è§„åˆ™ï¼</a>é‡Œé¢è®²äº†å®½æ¾é€‚é…çš„åŸç†ã€‚åœ¨ Spring çš„æ¡†æ¶ä½“ç³»ä¸­æ˜¯åœ¨ <code>ConfigurationPropertiesBindingPostProcessor</code> ä¸­çš„ <code>postProcessBeforeInitialization()</code> ä¸­å®ç°å¯¹æœ‰ <code>@ConfigurationProperties</code> æ³¨è§£ä¿®é¥°ç±»çš„å±æ€§è¿›è¡Œç»‘å®šçš„ã€‚</p>\n<p>åœ¨å®ƒçš„å†…éƒ¨å®é™…ä¸Šæ˜¯é€šè¿‡è°ƒç”¨ <code>ConfigurationPropertiesBinder</code> çš„ <code>bind()</code> æ¥å®ç°å±æ€§ç»‘å®šçš„ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>\n<pre><code class=\"language-java\">public class ConfigurationPropertiesBindingPostProcessor\n    implements BeanPostProcessor, PriorityOrdered, ApplicationContextAware, InitializingBean {\n    @Override\n    public Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException {\n        if (!hasBoundValueObject(beanName)) {\n            bind(ConfigurationPropertiesBean.get(this.applicationContext, bean, beanName));\n        }\n        return bean;\n    }\n    \n    private void bind(ConfigurationPropertiesBean bean) {\n        if (bean == null) {\n            return;\n        }\n        Assert.state(bean.asBindTarget().getBindMethod() != BindMethod.VALUE_OBJECT,\n                \"Cannot bind @ConfigurationProperties for bean '\" + bean.getName()\n                        + \"'. Ensure that @ConstructorBinding has not been applied to regular bean\");\n        try {\n            // è¿™é‡Œå®é™…ä¸Šæ˜¯è°ƒç”¨äº†ConfigurationPropertiesBinderçš„bind()æ–¹æ³•\n            this.binder.bind(bean);\n        }\n        catch (Exception ex) {\n            throw new ConfigurationPropertiesBindException(bean, ex);\n        }\n    }\n}\n</code></pre>\n<p><img alt=\"image.png\" src=\"https://raw.githubusercontent.com/javadaydayup/pictures/main/20260131201218.png\" /></p>\n<p>åœ¨ <code>ConfigurationPropertiesBinder</code> çš„ <code>bind()</code> æ–¹æ³•åˆè°ƒç”¨äº† <code>Binder</code> çš„ <code>bind()</code> æ–¹æ³•ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br />\n<img alt=\"image.png\" src=\"https://raw.githubusercontent.com/javadaydayup/pictures/main/20260131201526.png\" /></p>\n<p>åœ¨è°ƒç”¨  <code>Binder</code> çš„ <code>bind()</code> æ–¹æ³•æ—¶ï¼Œä¼šæŠŠæ³¨è§£ä¸Šé…ç½®çš„å‰ç¼€ä¼ è¿›å»ï¼Œåœ¨æœ¬æ¡ˆä¾‹ä¸­å°±æ˜¯ <code>test</code>ï¼Œå¹¶åŸºäºè¿™ä¸ªå‰ç¼€åˆ›å»ºä¸€ä¸ª <code>ConfigurationPropertyName</code> å¯¹è±¡ï¼Œç„¶åæœ€ç»ˆè°ƒç”¨åˆ° <code>bindObject()</code> æ–¹æ³•ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>\n<pre><code class=\"language-java\">public class Binder {\n    public &lt;T&gt; BindResult&lt;T&gt; bind(String name, Bindable&lt;T&gt; target, BindHandler handler) {\n        // è¿™é‡ŒåŸºäºtestå‰ç¼€åˆ›å»ºäº†ConfigurationPropertyNameå¯¹è±¡\n        return bind(ConfigurationPropertyName.of(name), target, handler);\n    }\n    \n    private &lt;T&gt; T bind(ConfigurationPropertyName name, Bindable&lt;T&gt; target, BindHandler handler, Context context,\n        boolean allowRecursiveBinding, boolean create) {\n        try {\n            Bindable&lt;T&gt; replacementTarget = handler.onStart(name, target, context);\n            if (replacementTarget == null) {\n                return handleBindResult(name, target, handler, context, null, create);\n            }\n            target = replacementTarget;\n            // è°ƒç”¨bindObject()æ–¹æ³•\n            Object bound = bindObject(name, target, handler, context, allowRecursiveBinding);\n            return handleBindResult(name, target, handler, context, bound, create);\n        }\n        catch (Exception ex) {\n            return handleBindError(name, target, handler, context, ex);\n        }\n    }\n}\n</code></pre>\n<p>åœ¨  <code>bindObject()</code> ä¸­é¦–å…ˆè°ƒç”¨ <code>findProperty()</code> æ–¹æ³•æŸ¥æ‰¾å±æ€§ï¼Œå› ä¸ºå½“å‰åªæ˜¯å‰ç¼€ <code>test</code>ï¼Œå› æ­¤è‚¯å®šæ˜¯æ‰¾ä¸åˆ°å¯¹åº”çš„å±æ€§é…ç½®çš„ã€‚ å› æ­¤å¾€ä¸‹èµ°ä¼šè°ƒç”¨åˆ° <code>bindDataObject()</code>æ–¹æ³•ã€‚å¯¹äº JavaBean æ¥è¯´ï¼Œåœ¨ <code>Binder</code> çš„ <code>bindDataObject()</code> æ–¹æ³•æœ€ç»ˆä¼šè°ƒç”¨åˆ° <code>JavaBeanBinder</code> çš„ <code>bind()</code> æ–¹æ³•ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>\n<pre><code class=\"language-java\">public class Binder {\n    private &lt;T&gt; Object bindObject(ConfigurationPropertyName name, Bindable&lt;T&gt; target, BindHandler handler,\n\t    Context context, boolean allowRecursiveBinding) {\n\t    ConfigurationProperty property = findProperty(name, target, context);\n\t    if (property == null &amp;&amp; context.depth != 0 &amp;&amp; containsNoDescendantOf(context.getSources(), name)) {\n\t        return null;\n\t    }\n\t    // çœç•¥ä¸­é—´ä»£ç \n\t    \n\t    //è°ƒç”¨bindDataObject()æ–¹æ³•\n\t    return bindDataObject(name, target, handler, context, allowRecursiveBinding);\n\t}\n\n    private Object bindDataObject(ConfigurationPropertyName name, Bindable&lt;?&gt; target, BindHandler handler,\n            Context context, boolean allowRecursiveBinding) {\n        if (isUnbindableBean(name, target, context)) {\n            return null;\n        }\n        Class&lt;?&gt; type = target.getType().resolve(Object.class);\n        BindMethod bindMethod = target.getBindMethod();\n        if (!allowRecursiveBinding &amp;&amp; context.isBindingDataObject(type)) {\n            return null;\n        }\n        \n        // æ³¨æ„è¿™é‡Œçš„lambdaè¡¨è¾¾å¼ï¼Œåœ¨JavaBeanBinderçš„bind()æ–¹æ³•æœ€ç»ˆåˆä¼šè°ƒç”¨åˆ°è¿™ä¸ªlambdaè¡¨è¾¾å¼\n        DataObjectPropertyBinder propertyBinder = (propertyName, propertyTarget) -&gt; bind(name.append(propertyName),\n                propertyTarget, handler, context, false, false);\n                \n\t    // è¿™é‡Œä¼šè°ƒç”¨åˆ°JavaBeanBinderçš„bind()æ–¹æ³•\n        return context.withDataObject(type, () -&gt; fromDataObjectBinders(bindMethod,\n                (dataObjectBinder) -&gt; dataObjectBinder.bind(name, target, context, propertyBinder)));\n    }\n}\n</code></pre>\n<p>åœ¨ <code>JavaBeanBinder</code> çš„ <code>bind()</code> æ–¹æ³•ä¸­ä¼šè·å–è¿™ä¸ªå¯¹è±¡çš„æ‰€æœ‰çš„ <code>BeanProperty</code>ï¼Œç„¶ååˆåè°ƒç”¨å› <code>Binder</code> ä¸­çš„lambdaè¡¨è¾¾å¼äº†ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>\n<pre><code class=\"language-java\">class JavaBeanBinder implements DataObjectBinder {\n    @Override\n    public &lt;T&gt; T bind(ConfigurationPropertyName name, Bindable&lt;T&gt; target, Context context,\n            DataObjectPropertyBinder propertyBinder) {\n        boolean hasKnownBindableProperties = target.getValue() != null &amp;&amp; hasKnownBindableProperties(name, context);\n        Bean&lt;T&gt; bean = Bean.get(target, hasKnownBindableProperties);\n        if (bean == null) {\n            return null;\n        }\n        BeanSupplier&lt;T&gt; beanSupplier = bean.getSupplier(target);\n        boolean bound = bind(propertyBinder, bean, beanSupplier, context);\n        return (bound ? beanSupplier.get() : null);\n    }\n    \n    private &lt;T&gt; boolean bind(DataObjectPropertyBinder propertyBinder, Bean&lt;T&gt; bean, BeanSupplier&lt;T&gt; beanSupplier,\n        Context context) {\n        boolean bound = false;\n        for (BeanProperty beanProperty : bean.getProperties().values()) { // è·å–è¿™ä¸ªå¯¹è±¡ä¸Šæ‰€æœ‰çš„BeanPropertyå±æ€§\n            bound |= bind(beanSupplier, propertyBinder, beanProperty);\n            context.clearConfigurationProperty();\n        }\n        return bound;\n    }\n    \n    private &lt;T&gt; boolean bind(BeanSupplier&lt;T&gt; beanSupplier, DataObjectPropertyBinder propertyBinder,\n        BeanProperty property) {\n        String propertyName = determinePropertyName(property);\n        ResolvableType type = property.getType();\n        Supplier&lt;Object&gt; value = property.getValue(beanSupplier);\n        Annotation[] annotations = property.getAnnotations();\n        Object bound = propertyBinder.bindProperty(propertyName, //è¿™ä¸ªåœ°æ–¹å®é™…ä¸Šåˆåè°ƒç”¨å›Binderä¸­çš„lambdaè¡¨è¾¾å¼äº†\n                Bindable.of(type).withSuppliedValue(value).withAnnotations(annotations));\n        if (bound == null) {\n            return false;\n        }\n        if (property.isSettable()) {\n            property.setValue(beanSupplier, bound);\n        }\n        else if (value == null || !bound.equals(value.get())) {\n            throw new IllegalStateException(\"No setter found for property: \" + property.getName());\n        }\n        return true;\n    }\n}\n</code></pre>\n<p><code>BeanProperty</code> å¯¹è±¡ä¼šå°† JavaBean ä¸­çš„å±æ€§ç»Ÿä¸€ä¸º Dash æ ¼å¼ã€‚åœ¨æœ¬æ¡ˆä¾‹ä¸­å±æ€§åç§°æ˜¯ <code>containerName</code>ï¼Œç»Ÿä¸€ä¹‹åå°±å˜æˆäº† <code>container-name</code>ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br />\n<img alt=\"image.png\" src=\"https://raw.githubusercontent.com/javadaydayup/pictures/main/20260131210506.png\" /></p>\n<p>åœ¨ <code>Binder</code> ä¸­ lambda è¡¨è¾¾å¼ä¼šå°†å±æ€§æ‹¼æ¥åˆ°å·²æœ‰çš„ <code>ConfigurationPropertyName</code> å‰ç¼€ä¸Šï¼Œåœ¨æœ¬æ¡ˆä¾‹ä¸­å°±å˜æˆäº† <code>test.container-name</code>ã€‚ç„¶ååˆé€’å½’è°ƒç”¨ <code>bind()</code> æ–¹æ³•ï¼Œç„¶ååˆè°ƒç”¨ <code>findProperty()</code> æ–¹æ³•å°è¯•ä»ä»å¯¹åº”çš„ <code>ConfigurationPropertySource</code> ä¸­è·å–å¯¹åº”çš„é…ç½®ä¸­æŸ¥æ‰¾è¿™ä¸ªå±æ€§ã€‚</p>\n<p>Spring æä¾›äº† <code>SpringIterableConfigurationPropertySource</code> ä½œä¸º <code>ConfigurationPropertySource</code> å®ç°ç±»ï¼Œ å®ƒå®é™…æ˜¯å¯¹ <code>PropertySource</code> çš„ä¸€ä¸ªé€‚é…ï¼Œå†…éƒ¨æœ‰ä¸€ä¸ª <code>propertySource</code> è¡¨ç¤ºçœŸæ­£çš„é…ç½®ã€‚é€šè¿‡è°ƒè¯• <code>contex.getSource()</code> æ–¹æ³•çš„è¿”å›å€¼ï¼Œå¯ä»¥çœ‹åˆ°åŠ å¯†ä¹‹åçš„ <code>PropertySource</code> ç¡®å®æ˜¯åœ¨æ²¡æœ‰åŠ å¯†çš„å‰é¢ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>\n<pre><code class=\"language-java\">DataObjectPropertyBinder propertyBinder = (propertyName, propertyTarget) -&gt; bind(name.append(propertyName), //è¿™é‡Œå°†å±æ€§åç§°æ‹¼æ¥åˆ°testå‰ç¼€ä¸Š\n\t\tpropertyTarget, handler, context, false, false);\n                \nprivate &lt;T&gt; ConfigurationProperty findProperty(ConfigurationPropertyName name, Bindable&lt;T&gt; target,\n    Context context) {\n    if (name.isEmpty() || target.hasBindRestriction(BindRestriction.NO_DIRECT_PROPERTY)) {\n        return null;\n    }\n    for (ConfigurationPropertySource source : context.getSources()) {\n        ConfigurationProperty property = source.getConfigurationProperty(name);\n        if (property != null) {\n            return property;\n        }\n    }\n    return null;\n}\n</code></pre>\n<p><img alt=\"image.png\" src=\"https://raw.githubusercontent.com/javadaydayup/pictures/main/20260131181044.png\" /></p>\n<p>åœ¨ <code>getConfigurationProperty()</code> æ–¹æ³•ä¸­é¦–å…ˆè°ƒç”¨çˆ¶ç±» <code>SpringConfigurationPropertySource</code> çš„ <code>getConfigurationProperty()</code> æ–¹æ³•ã€‚åœ¨è¯¥æ–¹æ³•ä¸­ä¼šè°ƒç”¨ <code>PropertyMapper</code> çš„ <code>map()</code> æ–¹æ³•å¯¹ä¼ å…¥çš„ <code>ConfigurationPropertyName</code> ç±»å‹çš„ <code>name</code> è¿›è¡Œè½¬æ¢ï¼Œç„¶åæ ¹æ®è½¬æ¢åæ‹¿åˆ°çš„åç§°å» <code>PropertySource</code> ä¸­è·å–å¯¹åº”çš„å±æ€§ã€‚</p>\n<pre><code class=\"language-java\">class SpringConfigurationPropertySource implements ConfigurationPropertySource {\n    public ConfigurationProperty getConfigurationProperty(ConfigurationPropertyName name) {\n        if (name == null) {\n            return null;\n        }\n        for (PropertyMapper mapper : this.mappers) {\n            try {\n                for (String candidate : mapper.map(name)) { // è¿™é‡Œå…ˆé€šè¿‡PropertyMapperè½¬æ¢åç§°\n                    Object value = getPropertySource().getProperty(candidate); // æ ¹æ®è½¬æ¢åçš„åç§°è·å–è·å–å¯¹åº”çš„å±æ€§\n                    if (value != null) {\n                        Origin origin = PropertySourceOrigin.get(this.propertySource, candidate);\n                        return ConfigurationProperty.of(this, name, value, origin);\n                    }\n                }\n            }\n            catch (Exception ex) {\n                // Ignore\n            }\n        }\n        return null;\n    }\n}\n</code></pre>\n<p>åœ¨åˆ›å»º <code>SpringConfigurationPropertySource</code> å¯¹è±¡æ—¶ï¼Œä¼šæ ¹æ® <code>PropertySource</code> æ˜¯ <code>MapPropertySource</code> è¿˜æ˜¯ <code>SystemEnvironmentPropertySource</code> ï¼Œä»è€Œè®¾ç½®ä¸åŒçš„ <code>mappers</code> å±æ€§ï¼Œå¯¹äº <code>SystemEnvironmentPropertySource</code>ï¼Œå®ƒä¼šå¤šä¸€ä¸ª <code>SystemEnvironmentPropertyMapper</code> ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>\n<pre><code class=\"language-java\">class SpringConfigurationPropertySource implements ConfigurationPropertySource {\n   private static final PropertyMapper[] DEFAULT_MAPPERS = { DefaultPropertyMapper.INSTANCE };\n\n   private static final PropertyMapper[] SYSTEM_ENVIRONMENT_MAPPERS = { SystemEnvironmentPropertyMapper.INSTANCE,\n    DefaultPropertyMapper.INSTANCE };\n    \n   static SpringConfigurationPropertySource from(PropertySource&lt;?&gt; source) {\n        Assert.notNull(source, \"Source must not be null\");\n        PropertyMapper[] mappers = getPropertyMappers(source);\n        if (isFullEnumerable(source)) {\n            return new SpringIterableConfigurationPropertySource((EnumerablePropertySource&lt;?&gt;) source, mappers);\n        }\n        return new SpringConfigurationPropertySource(source, mappers);\n    }\n    \n    private static PropertyMapper[] getPropertyMappers(PropertySource&lt;?&gt; source) {\n        // è¿™é‡Œåˆ¤æ–­äº†å¦‚æœæ˜¯SystemEnvironmentPropertySourceåˆ™ä¼šè¿”å›SYSTEM_ENVIRONMENT_MAPPERSï¼Œé‡Œé¢åŒ…å«äº†SystemEnvironmentPropertyMapper\n        if (source instanceof SystemEnvironmentPropertySource &amp;&amp; hasSystemEnvironmentName(source)) {\n            return SYSTEM_ENVIRONMENT_MAPPERS;\n        }\n        return DEFAULT_MAPPERS;\n    }\n}\n</code></pre>\n<p>å¯¹äº <code>DefaultPropertyMapper</code> å®ƒçš„ <code>map()</code> æ–¹æ³•ä¼šç›´æ¥è¿”å› <code>ConfigurationPropertyName</code> çš„åç§°ï¼Œåœ¨æœ¬æ¡ˆä¾‹ä¸­å°±ä¼šç›´æ¥è¿”å› <code>test.container-name</code>ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>\n<pre><code class=\"language-java\">final class DefaultPropertyMapper implements PropertyMapper {\n    @Override\n    public List&lt;String&gt; map(ConfigurationPropertyName configurationPropertyName) {\n        // Use a local copy in case another thread changes things\n        LastMapping&lt;ConfigurationPropertyName, List&lt;String&gt;&gt; last = this.lastMappedConfigurationPropertyName;\n        if (last != null &amp;&amp; last.isFrom(configurationPropertyName)) {\n            return last.getMapping();\n        }\n        // è¿™é‡Œç›´æ¥è¿”å›ConfigurationPropertyNameçš„åç§°\n        String convertedName = configurationPropertyName.toString();\n        List&lt;String&gt; mapping = Collections.singletonList(convertedName);\n        this.lastMappedConfigurationPropertyName = new LastMapping&lt;&gt;(configurationPropertyName, mapping);\n        return mapping;\n    }\n}\n</code></pre>\n<p>å¯¹äº <code>SystemEnvironmentPropertyMapper</code> å®ƒä¼šè¿”å›ä¸¤ä¸ªæ ¼å¼çš„åç§°ï¼Œåœ¨æœ¬æ¡ˆä¾‹ä¸­å°±ä¼šè¿”å› <code>TEST_CONTAINERNAME</code> å’Œ <code>TEST_CONTAINER_NAME</code> ä¸¤ç§æ ¼å¼ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>\n<pre><code class=\"language-java\">final class SystemEnvironmentPropertyMapper implements PropertyMapper {\n\n    public static final PropertyMapper INSTANCE = new SystemEnvironmentPropertyMapper();\n\n    @Override\n    public List&lt;String&gt; map(ConfigurationPropertyName configurationPropertyName) {\n        String name = convertName(configurationPropertyName);\n        String legacyName = convertLegacyName(configurationPropertyName);\n        if (name.equals(legacyName)) {\n            return Collections.singletonList(name);\n        }\n        // è¿™é‡Œä¼šè¿”å›ä¸¤ä¸ªæ ¼å¼çš„åç§°\n        return Arrays.asList(name, legacyName);\n    }\n\n    private String convertName(ConfigurationPropertyName name) {\n        return convertName(name, name.getNumberOfElements());\n    }\n\n    private String convertName(ConfigurationPropertyName name, int numberOfElements) {\n        StringBuilder result = new StringBuilder();\n        for (int i = 0; i &lt; numberOfElements; i++) {\n            if (!result.isEmpty()) {\n                result.append('_');\n            }\n            result.append(name.getElement(i, Form.UNIFORM).toUpperCase(Locale.ENGLISH));\n        }\n        return result.toString();\n    }\n\n    private String convertLegacyName(ConfigurationPropertyName name) {\n        StringBuilder result = new StringBuilder();\n        for (int i = 0; i &lt; name.getNumberOfElements(); i++) {\n            if (!result.isEmpty()) {\n                result.append('_');\n            }\n            result.append(convertLegacyNameElement(name.getElement(i, Form.ORIGINAL)));\n        }\n        return result.toString();\n    }\n\n    private Object convertLegacyNameElement(String element) {\n        return element.replace('-', '_').toUpperCase(Locale.ENGLISH);\n    }\n}\n</code></pre>\n<p>åœ¨æœ¬æ¡ˆä¾‹ä¸­<code>decryptedSystemEnvironment</code> çš„ <code>PropertySource</code> ç±»å‹æ˜¯ <code>MapPropertySource</code>ï¼Œå­˜æ”¾çš„å†…å®¹æ˜¯ <code>TEST_CONTAINER_NAME=Tomcat</code>ã€‚å®ƒåªæœ‰ <code>DefaultPropertyMapper</code>ï¼›</p>\n<p>åç§°ä¸º <code>systemEnvironment</code> çš„ <code>PropertySource</code> ç±»å‹æ˜¯ <code>SystemEnvironmentPropertySource</code>ï¼Œå­˜æ”¾çš„å†…å®¹æ˜¯ <code>TEST_CONTAINER_NAME=ENC_VG9tY2F0</code>ã€‚å®ƒæœ‰<code>DefaultPropertyMapper</code> å’Œ <code>SystemEnvironmentPropertyMapper</code>ã€‚</p>\n<p><code>decryptedSystemEnvironment</code> åœ¨é¡ºåºä¸Šæ’åœ¨ <code>systemEnvironment</code> å‰é¢ã€‚è¿™ä¸ªæ—¶å€™å¼€å§‹æŸ¥æ‰¾ä¼ å…¥åç§°ä¸º <code>test.container-name</code> çš„ <code>ConfigurationPropertyName</code>ï¼Œè¿™ä¸ªæ—¶å€™å…ˆä» <code>decryptedSystemEnvironment</code> å¼€å§‹æ‰¾ï¼Œç»è¿‡ <code>DefaultPropertyMapper</code> è½¬æ¢ä¹‹åæ‹¿åˆ°çš„å±æ€§åç§°æ˜¯ <code>test.container-name</code>ï¼Œé…ç½®é‡Œé¢æ²¡æœ‰è¿™ä¸ªé…ç½®ï¼›ç„¶åä» <code>systemEnvironment</code> å¼€å§‹æ‰¾ï¼Œç»è¿‡ <code>SystemEnvironmentPropertyMapper</code> è½¬æ¢ä¹‹åæ‹¿åˆ°çš„å±æ€§åç§°æ˜¯<code>TEST_CONTAINERNAME</code> å’Œ <code>TEST_CONTAINER_NAME</code>ï¼Œæ ¹æ® <code>TEST_CONTAINER_NAME</code> å°±æ‹¿åˆ°äº† <code>ENC_VG9tY2F0</code> ã€‚è¿™å°±è§£é‡Šäº†ä¸ºå•¥é…ç½®ç±»æ³¨å…¥çš„è¿˜æ˜¯åŠ å¯†ä¹‹åçš„å€¼äº†ã€‚</p>\n<h2 id=\"é—®é¢˜è§£å†³\">é—®é¢˜è§£å†³</h2>\n<p>çŸ¥é“é—®é¢˜çš„åŸç†äº†ä¹‹åï¼Œé—®é¢˜å°±å¥½è§£å†³äº†ã€‚ä¸€ç§æ–¹æ³•æ˜¯å¯ä»¥åœ¨ <code>DecryptEnvironmentPostProcessor</code> ç±»çš„ <code>postProcessBeforeInitialization()</code> æ–¹æ³•ä¸­æŠŠæ·»åŠ çš„ <code>MapPropertySource</code> ç±»å‹æ”¹ä¸º <code>SystemEnvironmentPropertySource</code> å°±å¯ä»¥äº†ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>\n<pre><code class=\"language-java\">@Override  \npublic void postProcessEnvironment(ConfigurableEnvironment environment, SpringApplication application) {  \n    String systemEnvName = StandardEnvironment.SYSTEM_ENVIRONMENT_PROPERTY_SOURCE_NAME;  \n    MapPropertySource systemEnvSource = (MapPropertySource) environment.getPropertySources().get(systemEnvName);  \n    Map&lt;String, Object&gt; decryptedMap = new HashMap&lt;&gt;();  \n    if (systemEnvSource == null) {  \n        return;  \n    }  \n    systemEnvSource.getSource().forEach((key, value) -&gt; {  \n        if (value instanceof String strVal) {  \n            if (StringUtils.isNotEmpty(strVal) &amp;&amp; strVal.startsWith(\"ENC_\")) {  \n                String plainText = new String(Base64.getDecoder().decode(strVal.substring(4)));  \n                decryptedMap.put(key, plainText);  \n            }  \n        }  \n    });  \n  \n    if (!decryptedMap.isEmpty()) {  \n\t\t// è¿™é‡ŒåŸæ¥æ·»åŠ çš„æ˜¯MapPropertySourceç±»å‹ï¼Œç°åœ¨è°ƒæ•´ä¸ºSystemEnvironmentPropertySourceç±»å‹\n        // MapPropertySource decryptedSource = new MapPropertySource(DECRYPTED_SOURCE_NAME, decryptedMap);  \n        environment.getPropertySources().addBefore(systemEnvName, new SystemEnvironmentPropertySource(DECRYPTED_SOURCE_NAME, decryptedMap));  \n        System.out.println(\"\");  \n    }  \n}\n</code></pre>\n\n\n</div>\n<div id=\"MySignature\">\n    æ¬¢è¿å¤§å®¶å…³æ³¨æˆ‘çš„å…¬ä¼—å·ã€javadaydayupã€‘\n</div>\n<div class=\"clear\"></div>\n\n            </div>\n            <div class=\"postDesc\">posted @ \n<span id=\"post-date\">2026-02-01 17:25</span>&nbsp;\n<a href=\"https://www.cnblogs.com/javadaydayup\">javadaydayup</a>&nbsp;\né˜…è¯»(<span id=\"post_view_count\">3</span>)&nbsp;\nè¯„è®º(<span id=\"post_comment_count\">0</span>)&nbsp;\n&nbsp;\n<a href=\"\">æ”¶è—</a>&nbsp;\n<a href=\"\">ä¸¾æŠ¥</a>\n</div>"
    },
    {
      "title": "ä¼ è¯´ä¸­çš„C++ç²¾çµåº“ï¼Œä¸“æ²»â€œC++ææƒ§ç—‡â€?",
      "link": "https://www.cnblogs.com/lixingqiu/p/19561053",
      "published": "",
      "description": "<h1 class=\"postTitle\"><a class=\"postTitle2 vertical-middle\" href=\"https://www.cnblogs.com/lixingqiu/p/19561053\" id=\"cb_post_title_url\" title=\"å‘å¸ƒäº 2026-02-01 16:41\">\n    <span>ä¼ è¯´ä¸­çš„C++ç²¾çµåº“ï¼Œä¸“æ²»â€œC++ææƒ§ç—‡â€?</span>\n    \n\n</a>\n</h1>\n\t<div class=\"blogpost-body blogpost-body-html\" id=\"cnblogs_post_body\">\n<p>è¿™ï¼Œæ˜¯ä¸€ä¸ªé‡‡ç”¨C++ç²¾çµåº“ç¼–å†™çš„ç¨‹åºï¼Œå®ƒç”»äº†ä¸€å¹…æ¼‚äº®çš„å›¾å½¢ï¼š</p>\n<div class=\"cnblogs_code\">\n<pre>#include <span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">sprites.h</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span>  <span style=\"color: rgba(0, 128, 0, 1);\">//</span><span style=\"color: rgba(0, 128, 0, 1);\">åŒ…å«C++ç²¾çµåº“ </span>\nSprite turtle;      <span style=\"color: rgba(0, 128, 0, 1);\">//</span><span style=\"color: rgba(0, 128, 0, 1);\">å»ºç«‹è§’è‰²å«turtle</span>\n<span style=\"color: rgba(0, 0, 255, 1);\">void</span> draw(<span style=\"color: rgba(0, 0, 255, 1);\">int</span><span style=\"color: rgba(0, 0, 0, 1);\"> d){\n  </span><span style=\"color: rgba(0, 0, 255, 1);\">for</span>(<span style=\"color: rgba(0, 0, 255, 1);\">int</span> i=<span style=\"color: rgba(128, 0, 128, 1);\">0</span>;i&lt;<span style=\"color: rgba(128, 0, 128, 1);\">5</span>;i++)turtle.fd(d).left(<span style=\"color: rgba(128, 0, 128, 1);\">72</span><span style=\"color: rgba(0, 0, 0, 1);\">);\n}\n</span><span style=\"color: rgba(0, 0, 255, 1);\">int</span> main(){        <span style=\"color: rgba(0, 128, 0, 1);\">//</span><span style=\"color: rgba(0, 128, 0, 1);\">ä¸»åŠŸèƒ½å— </span>\n   turtle.bgcolor(<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">black</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">);\n   turtle.pensize(</span><span style=\"color: rgba(128, 0, 128, 1);\">2</span>).speed(<span style=\"color: rgba(128, 0, 128, 1);\">0</span><span style=\"color: rgba(0, 0, 0, 1);\">);\n   </span><span style=\"color: rgba(0, 0, 255, 1);\">for</span>(<span style=\"color: rgba(0, 0, 255, 1);\">int</span> step=<span style=\"color: rgba(128, 0, 128, 1);\">10</span>;step&lt;<span style=\"color: rgba(128, 0, 128, 1);\">360</span>;step+=<span style=\"color: rgba(128, 0, 128, 1);\">30</span><span style=\"color: rgba(0, 0, 0, 1);\">){\n     turtle.color(step);\n     </span><span style=\"color: rgba(0, 0, 255, 1);\">for</span>(<span style=\"color: rgba(0, 0, 255, 1);\">int</span> i=<span style=\"color: rgba(128, 0, 128, 1);\">0</span>;i&lt;<span style=\"color: rgba(128, 0, 128, 1);\">12</span>;i++<span style=\"color: rgba(0, 0, 0, 1);\">){\n        turtle.pu().fd(step</span>/<span style=\"color: rgba(128, 0, 128, 1);\">2</span> ).right(<span style=\"color: rgba(128, 0, 128, 1);\">60</span><span style=\"color: rgba(0, 0, 0, 1);\">);\n        turtle.pd(); draw(step</span>/<span style=\"color: rgba(128, 0, 128, 1);\">10</span><span style=\"color: rgba(0, 0, 0, 1);\">);\n        turtle.pu().left(</span><span style=\"color: rgba(128, 0, 128, 1);\">60</span>).bk(step/<span style=\"color: rgba(128, 0, 128, 1);\">2</span><span style=\"color: rgba(0, 0, 0, 1);\"> );\n        turtle.right(</span><span style=\"color: rgba(128, 0, 128, 1);\">30</span><span style=\"color: rgba(0, 0, 0, 1);\">);\n     }\n   }     \n   turtle.ht().done();     </span><span style=\"color: rgba(0, 128, 0, 1);\">//</span><span style=\"color: rgba(0, 128, 0, 1);\">å®Œæˆäº†</span>\n   <span style=\"color: rgba(0, 0, 255, 1);\">return</span> <span style=\"color: rgba(128, 0, 128, 1);\">0</span>;    <span style=\"color: rgba(0, 128, 0, 1);\">//</span><span style=\"color: rgba(0, 128, 0, 1);\">è¿”å›0</span>\n}</pre>\n</div>\n<p>è€Œï¼Œè¿™æ˜¯å¦ä¸€ä¸ªç”±python turtleç¼–å†™çš„ç¨‹åºï¼Œç”»çš„å›¾å½¢å’Œä¸Šé¢C++çš„å›¾å½¢å‡ ä¹ä¸€æ¨¡ä¸€æ ·ï¼š</p>\n<div class=\"cnblogs_code\">\n<pre><span style=\"color: rgba(0, 0, 255, 1);\">import</span><span style=\"color: rgba(0, 0, 0, 1);\"> turtle as t\n</span><span style=\"color: rgba(0, 0, 255, 1);\">import</span><span style=\"color: rgba(0, 0, 0, 1);\"> colorsys\n\n</span><span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> è®¾ç½®ç”»å¸ƒ</span>\nt.bgcolor(<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">black</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">)\nt.colormode(</span>255)  <span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> ä½¿ç”¨ 0-255 çš„ RGB èŒƒå›´</span>\nt.speed(0)  <span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> æœ€å¿«é€Ÿåº¦</span>\nt.pensize(2<span style=\"color: rgba(0, 0, 0, 1);\">)\nt.hideturtle()\n\n</span><span style=\"color: rgba(0, 0, 255, 1);\">def</span><span style=\"color: rgba(0, 0, 0, 1);\"> draw(d):\n    </span><span style=\"color: rgba(0, 0, 255, 1);\">for</span> _ <span style=\"color: rgba(0, 0, 255, 1);\">in</span> range(5<span style=\"color: rgba(0, 0, 0, 1);\">):\n        t.forward(d)\n        t.left(</span>72<span style=\"color: rgba(0, 0, 0, 1);\">)\n\n</span><span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> ä¸»ç»˜å›¾é€»è¾‘</span>\n<span style=\"color: rgba(0, 0, 255, 1);\">for</span> step <span style=\"color: rgba(0, 0, 255, 1);\">in</span> range(10, 360, 30<span style=\"color: rgba(0, 0, 0, 1);\">):\n    </span><span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> å°† step æ˜ å°„ä¸ºé¢œè‰²ï¼šä½¿ç”¨ HSV è‰²å½©ç©ºé—´ï¼Œè®©é¢œè‰²éš step å˜åŒ–ï¼ˆå½©è™¹æ•ˆæœï¼‰</span>\n    hue = step / 360.0  <span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> å½’ä¸€åŒ–åˆ° [0, 1)</span>\n    r, g, b = colorsys.hsv_to_rgb(hue, 1.0, 1.0<span style=\"color: rgba(0, 0, 0, 1);\">)\n    t.color(int(r </span>* 255), int(g * 255), int(b * 255<span style=\"color: rgba(0, 0, 0, 1);\">))    \n    </span><span style=\"color: rgba(0, 0, 255, 1);\">for</span> _ <span style=\"color: rgba(0, 0, 255, 1);\">in</span> range(12<span style=\"color: rgba(0, 0, 0, 1);\">):\n        t.penup()\n        t.forward(step </span>/ 2<span style=\"color: rgba(0, 0, 0, 1);\">)\n        t.right(</span>60<span style=\"color: rgba(0, 0, 0, 1);\">)\n        t.pendown()\n        draw(step </span>// 10<span style=\"color: rgba(0, 0, 0, 1);\">)\n        t.penup()\n        t.left(</span>60<span style=\"color: rgba(0, 0, 0, 1);\">)\n        t.backward(step </span>/ 2<span style=\"color: rgba(0, 0, 0, 1);\">)\n        t.right(</span>30<span style=\"color: rgba(0, 0, 0, 1);\">)\nturtle.done()</span></pre>\n</div>\n<p><img alt=\"2026-02-01_155350\" class=\"lazyload\" height=\"214\" width=\"214\" /></p>\n<p><strong>ç­‰ç­‰ï¼è®©æˆ‘æ‰æ‰çœ¼ç›ï¼</strong>è¿™åˆ°åº•æ˜¯ä»€ä¹ˆæƒ…å†µï¼C++å±…ç„¶é•¿å¾—åƒPythonï¼ŸPythonå±…ç„¶æ•¢å’ŒC++æ’è¡«ï¼æ˜¯Python turtleå‡ºè½¨äº†C++çš„è¯­æ³•ï¼Œè¿˜æ˜¯C++çº¢æå‡ºå¢™å­¦ä¼šäº†Pythonçš„æ’©äººæŠ€å·§ï¼Ÿ</p>\n<p><strong>çœŸç›¸åªæœ‰ä¸€ä¸ªï¼šå› ä¸ºæœ‰äº†C++ç²¾çµåº“ï¼ˆsprites.hï¼‰ï¼Œå®ƒä¸“æ²»â€œC++ææƒ§ç—‡â€</strong></p>\n<p>ä½ çœ‹å•Šï¼Œä¼ ç»Ÿçš„C++å…¥é—¨é‚£æ˜¯å•¥ï¼Ÿ<code>std::cout &lt;&lt; \"Hello World\" &lt;&lt; std::endl;</code> â€”â€” è¿™ä¸€ä¸²æ ‡ç‚¹ç¬¦å·å°±èƒ½åŠé€€åŠä¸ªç­çš„æ–°ç”Ÿï¼æŒ‡é’ˆã€å†…å­˜ç®¡ç†ã€ç¼–è¯‘é“¾æ¥... ç®€ç›´å°±æ˜¯ç¼–ç¨‹ç•Œçš„\"é«˜å†·ç”·ç¥\"ï¼Œçˆ±ä½ ä½†å°±æ˜¯ä¸è®©ä½ é è¿‘ã€‚</p>\n<p>ä½†æ˜¯ï¼æœ‰äº†C++ç²¾çµåº“ä¹‹åå‘¢ï¼Ÿ<code>turtle.fd(d).left(72)</code> â€”â€” è¿™é“¾å¼è°ƒç”¨ï¼Œè¿™ä¸æ»‘æ‰‹æ„Ÿï¼Œè¿™ç®€ç›´æ˜¯æŠŠC++ä»\"è¥¿è£…é©å±¥çš„è€å¹²éƒ¨\"æ”¹é€ æˆäº†\"ç©¿ç€æ½®ç‰Œçš„é‚»å®¶å“¥å“¥\"ï¼</p>\n<p><strong><span>ä½ çœ‹ï¼ä¸¤è¡Œä»£ç æœ¬è´¨ä¸Šæ˜¯ä¸€æ¨¡ä¸€æ ·çš„ï¼Œå¯¹æ¯”çœ‹çœ‹ï¼š</span></strong></p>\n<p>å¯¹æ¯”çœ‹çœ‹ï¼š</p>\n<ul>\n<li>\n<p>C++ï¼š<code>turtle.pu().fd(step/2 ).right(60);</code></p>\n</li>\n<li>\n<p>Pythonï¼š<code>t.penup(); t.fd(step / 2); t.right(60)</code></p>\n</li>\n</ul>\n<p>æˆ‘çš„å¤©ï¼C++ä¸ä»…å­¦ä¼šäº†Pythonçš„ç®€å•ï¼Œè¿˜ä¿æŒäº†C++çš„ä¼˜é›…é“¾å¼è¯­æ³•ï¼å°±åƒä¸€ä¸ªäººæ—¢ä¼šåšé¥­åˆä¼šæµªæ¼«ï¼Œæ—¢æ‡‚åº•å±‚åˆæ‡‚ç”Ÿæ´»ï¼</p>\n<p><strong>ç­‰ç­‰ï¼Œé‡ç‚¹æ¥äº†ï¼è¿™é‡Œæœ‰ä¸ªæƒŠå¤©å¤§ç§˜å¯†ï¼</strong>ä½ ä»¥ä¸ºè¿™åªæ˜¯è¯­æ³•ç³–ï¼Ÿåªæ˜¯ç®€å•çš„æœ‰æ ·å­¦æ ·ï¼Ÿ è¿™æ˜¯<strong>åŒå€èµ‹èƒ½</strong>å•Šæœ‹å‹ä»¬ï¼çœ‹åˆ°äº†æ²¡ã€‚</p>\n<p>å½“ä½ ç”¨Python turtleç”»å›¾æ—¶ï¼Œä½ å­¦çš„æ˜¯â€”â€”æ€ä¹ˆç”»å›¾ã€‚ä»…æ­¤è€Œå·²ã€‚</p>\n<p>ä½†å½“ä½ ç”¨C++ç²¾çµåº“ç”»å›¾æ—¶ï¼Œä½ å­¦çš„æ˜¯â€”â€”<strong>æ€ä¹ˆåœ¨æ•°å­—ä¸–ç•Œçš„åœ°åŸºä¸Šç”»å›¾ï¼</strong></p>\n<p>æƒ³æƒ³çœ‹ï¼Œä½ çš„æ“ä½œç³»ç»Ÿæ˜¯è°å†™çš„ï¼ŸC/C++ï¼ä½ çš„æµè§ˆå™¨å†…æ ¸æ˜¯è°å†™çš„ï¼ŸC++ï¼ä½ çš„æ¸¸æˆå¼•æ“æ˜¯è°å†™çš„ï¼ŸC++ï¼è¿Pythonè§£é‡Šå™¨æœ¬èº«ï¼Œéƒ½æ˜¯ç”¨Cå†™çš„ï¼è¿™å°±å¥½æ¯”ï¼ŒPythonæ˜¯ç²¾è£…ä¿®çš„æˆ¿å­ï¼Œæ‹åŒ…å…¥ä½å¾ˆçˆ½ï¼›ä½†C++æ˜¯é’¢ç­‹æ··å‡åœŸçš„åœ°åŸºåŠ ç²¾è£…ä¿®æŠ€èƒ½ï¼<strong>æ—¢ä¼šç›–æ¥¼åˆä¼šè£…ä¿®ï¼Œä½ ä¸é¦™å—ï¼Ÿ</strong></p>\n<p><strong>æˆ‘ä»¬å¯çˆ±çš„</strong>Python å°æµ·é¾Ÿä¾æ—§ç©å¾—æ¬¢ï¼Œå®ƒè¿˜æ˜¯é‚£ä¸ªç®€å•ä¼˜é›…çš„Pythonã€‚C++ä¹Ÿä¾ç„¶æ˜¯é‚£ä¸ªæ€§èƒ½æ€ªå…½ã€‚</p>\n<p>çœŸæ­£çš„\"ç¬¬ä¸‰è€…\"æ˜¯<strong>C++ç²¾çµåº“</strong>è¿™ä¸ªä¼Ÿå¤§çš„åª’å©†ï¼å®ƒè®©C++æ”¾ä¸‹äº†èº«æ®µï¼Œç©¿ä¸Šäº†Pythonçš„ä¾¿è£…ï¼Œä½†éª¨å­é‡Œè¿˜æ˜¯é‚£ä¸ªèƒ½æ“æ§ç¡¬ä»¶ã€é©¾é©­æ“ä½œç³»ç»Ÿã€æ„å»ºæ•°å­—æ–‡æ˜çš„åº•å±‚ç‹è€…ï¼</p>\n<p><strong>ç»“è®ºï¼šC++ç²¾çµåº“çš„å‡ºç°æ˜¯æŠ€æœ¯å‘å±•çš„å¿…ç„¶ã€‚å®ƒè®©</strong>C++è¿™ä½â€œæ·±è—ä¸éœ²â€çš„å¤§ä½¬ï¼Œç»ˆäºå†³å®šä¸å†è£…é«˜å†·ï¼Œç”¨æœ€æ¸©æŸ”çš„æ–¹å¼ï¼Œå¸¦ä½ èµ°ä¸ŠçœŸæ­£çš„æŠ€æœ¯å·…å³°ï¼</p>\n<p>æƒ³çœ‹è§†é¢‘çš„è¿™é‡Œæœ‰é“¾æ¥ï¼š&nbsp;<a href=\"https://www.douyin.com/video/7601797221754965288\" rel=\"noopener nofollow\" target=\"_blank\">https://www.douyin.com/video/7601797221754965288</a></p>\n<p>&nbsp;</p>\n\n</div>\n<div class=\"clear\"></div>\n\n\t<div class=\"postDesc\">posted on \n<span id=\"post-date\">2026-02-01 16:41</span>&nbsp;\n<a href=\"https://www.cnblogs.com/lixingqiu\">æå…´çƒ</a>&nbsp;\né˜…è¯»(<span id=\"post_view_count\">18</span>)&nbsp;\nè¯„è®º(<span id=\"post_comment_count\">0</span>)&nbsp;\n&nbsp;\n<a href=\"\">æ”¶è—</a>&nbsp;\n<a href=\"\">ä¸¾æŠ¥</a>\n</div>"
    }
  ]
}