{
  "title": "主页 - 博客园",
  "link": "https://www.cnblogs.com/",
  "description": "主页 - 博客园 RSS",
  "entries": [
    {
      "title": "在Python+FastAPI项目中使用SqlAlchemy操作数据的几种常见方式",
      "link": "https://www.cnblogs.com/wuhuacong/p/19396612",
      "published": "",
      "description": "<h2>\n            <a class=\"postTitle2 vertical-middle\" href=\"https://www.cnblogs.com/wuhuacong/p/19396612\" id=\"cb_post_title_url\" title=\"发布于 2025-12-25 11:59\">\n    <span>在Python+FastAPI项目中使用SqlAlchemy操作数据的几种常见方式</span>\n    \n\n</a>\n\n        </h2>\n        <div class=\"postbody\">\n                <div id=\"cnblogs_post_description\" style=\"display: none;\">\n        \n        在Python+FastAPI的后端项目中，我们往往很多时候需要对数据进行相关的处理，本篇随笔介绍在Python+FastAPI项目中使用SqlAlchemy操作数据的几种常见方式。\n使用 FastAPI, SQLAlchemy, Pydantic构建后端项目的时候，其中数据库访问采用SQLAlchemy 的异步方式处理。一般我们在操作数据库操作的时候，采用基类继承的方式减少重复代码，提高代码复用性。不过我们在分析SQLAlchemy的时候，我们可以简单的方式来剖析几种常见的数据库操作方式，来介绍SQLAlchemy的具体使用。\n    </div>\n<div class=\"blogpost-body blogpost-body-html\" id=\"cnblogs_post_body\">\n<p>在Python+FastAPI的后端项目中，我们往往很多时候需要对数据进行相关的处理，本篇随笔介绍在Python+FastAPI项目中使用SqlAlchemy操作数据的几种常见方式。</p>\n<p>使用 FastAPI, SQLAlchemy, Pydantic构建后端项目的时候，其中数据库访问采用SQLAlchemy 的异步方式处理。一般我们在操作数据库操作的时候，采用基类继承的方式减少重复代码，提高代码复用性。不过我们在分析SQLAlchemy的时候，我们可以简单的方式来剖析几种常见的数据库操作方式，来介绍SQLAlchemy的具体使用。</p>\n<h3>1、SQLAlchemy介绍</h3>\n<div><strong>SQLAlchemy</strong>&nbsp;是一个功能强大且灵活的 Python SQL 工具包和对象关系映射（ORM）库。它被广泛用于在 Python 项目中处理关系型数据库的场景，既提供了高级的 ORM 功能，又保留了对底层 SQL 语句的强大控制力。<code>SQLAlchemy</code>&nbsp;允许开发者通过 Python 代码与数据库进行交互，而无需直接编写 SQL 语句，同时也支持直接使用原生 SQL 进行复杂查询。下面是<strong>SQLAlchemy</strong>和我们常规数据库对象的对应关系说明。</div>\n<div>Engine &nbsp;　　连接对象&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;驱动引擎</div>\n<div>Session 　　连接池&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;事务 &nbsp;由此开始查询</div>\n<div>Model &nbsp; 　　表&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;类定义</div>\n<div>Column &nbsp;　&nbsp; 列 &nbsp;</div>\n<div>Query &nbsp; 　　若干行 &nbsp; &nbsp; &nbsp; &nbsp; 可以链式添加多个条件</div>\n<div>&nbsp;</div>\n<div>在使用SQLAlchemy时，通常会将其与数据库对象对应起来。</div>\n<div><strong>SQLAlchemy</strong>: 使用&nbsp;<code>Table</code>&nbsp;对象或&nbsp;<code>Declarative Base</code>&nbsp;中的类来表示。</div>\n<div><strong>对应关系</strong>: 数据库中的每一个表对应于SQLAlchemy中的一个类，该类继承自&nbsp;<code>declarative_base()</code>。</div>\n<div>\n<div class=\"cnblogs_code\">\n<pre><span style=\"color: rgba(0, 0, 255, 1);\">from</span> sqlalchemy <span style=\"color: rgba(0, 0, 255, 1);\">import</span><span style=\"color: rgba(0, 0, 0, 1);\"> Column, Integer, String, create_engine\n</span><span style=\"color: rgba(0, 0, 255, 1);\">from</span> sqlalchemy.ext.declarative <span style=\"color: rgba(0, 0, 255, 1);\">import</span><span style=\"color: rgba(0, 0, 0, 1);\"> declarative_base\n\nBase </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> declarative_base()\n\n</span><span style=\"color: rgba(0, 0, 255, 1);\">class</span><span style=\"color: rgba(0, 0, 0, 1);\"> User(Base):\n    </span><span style=\"color: rgba(128, 0, 128, 1);\">__tablename__</span> = <span style=\"color: rgba(128, 0, 0, 1);\">'</span><span style=\"color: rgba(128, 0, 0, 1);\">users</span><span style=\"color: rgba(128, 0, 0, 1);\">'</span>  <span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> 数据库表名</span>\n    id = Column(Integer, primary_key=<span style=\"color: rgba(0, 0, 0, 1);\">True)\n    name </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> Column(String)\n    email </span>= Column(String)</pre>\n</div>\n<p><strong>数据库列 (Database Column)：</strong>使用&nbsp;<code>Column</code>&nbsp;对象来表示。每个数据库表中的列在SQLAlchemy中表示为&nbsp;<code>Column</code>&nbsp;对象，并作为类的属性定义。</p>\n<div>\n<div class=\"cnblogs_code\">\n<pre>id = Column(Integer, primary_key=<span style=\"color: rgba(0, 0, 0, 1);\">True)\nname </span>= Column(String(50))</pre>\n</div>\n<p><strong>数据库行 (Database Row)：</strong>每个数据库表的一个实例（对象）代表数据库表中的一行。在SQLAlchemy中，通过实例化模型类来表示数据库表中的一行。</p>\n<div>\n<div class=\"cnblogs_code\">\n<pre>new_user = User(id=1, name=<span style=\"color: rgba(128, 0, 0, 1);\">'</span><span style=\"color: rgba(128, 0, 0, 1);\">John Doe</span><span style=\"color: rgba(128, 0, 0, 1);\">'</span>, email=<span style=\"color: rgba(128, 0, 0, 1);\">'</span><span style=\"color: rgba(128, 0, 0, 1);\">john@example.com</span><span style=\"color: rgba(128, 0, 0, 1);\">'</span>)</pre>\n</div>\n<p><strong>主键 (Primary Key)</strong>：使用&nbsp;<code>primary_key=True</code>&nbsp;参数定义主键。</p>\n</div>\n</div>\n<div>\n<div class=\"cnblogs_code\">\n<pre>id = Column(Integer, primary_key=True)</pre>\n</div>\n<p><strong>外键 (Foreign Key): </strong>使用&nbsp;<code>ForeignKey</code>&nbsp;对象来表示。</p>\n<div>\n<div class=\"cnblogs_code\">\n<pre><span style=\"color: rgba(0, 0, 255, 1);\">from</span> sqlalchemy <span style=\"color: rgba(0, 0, 255, 1);\">import</span><span style=\"color: rgba(0, 0, 0, 1);\"> ForeignKey\n</span><span style=\"color: rgba(0, 0, 255, 1);\">from</span> sqlalchemy.orm <span style=\"color: rgba(0, 0, 255, 1);\">import</span><span style=\"color: rgba(0, 0, 0, 1);\"> relationship\n\n</span><span style=\"color: rgba(0, 0, 255, 1);\">class</span><span style=\"color: rgba(0, 0, 0, 1);\"> Address(Base):\n    </span><span style=\"color: rgba(128, 0, 128, 1);\">__tablename__</span> = <span style=\"color: rgba(128, 0, 0, 1);\">'</span><span style=\"color: rgba(128, 0, 0, 1);\">addresses</span><span style=\"color: rgba(128, 0, 0, 1);\">'</span><span style=\"color: rgba(0, 0, 0, 1);\">\n    id </span>= Column(Integer, primary_key=<span style=\"color: rgba(0, 0, 0, 1);\">True)\n    user_id </span>= Column(Integer, ForeignKey(<span style=\"color: rgba(128, 0, 0, 1);\">'</span><span style=\"color: rgba(128, 0, 0, 1);\">users.id</span><span style=\"color: rgba(128, 0, 0, 1);\">'</span><span style=\"color: rgba(0, 0, 0, 1);\">))\n    user </span>= relationship(<span style=\"color: rgba(128, 0, 0, 1);\">'</span><span style=\"color: rgba(128, 0, 0, 1);\">User</span><span style=\"color: rgba(128, 0, 0, 1);\">'</span>)</pre>\n</div>\n<p><strong>关系 (Relationships): </strong>使用&nbsp;<code>relationship</code>&nbsp;对象来表示。数据库中表与表之间的关系在SQLAlchemy中通过&nbsp;<code>relationship</code>&nbsp;来定义。</p>\n<div>\n<div class=\"cnblogs_code\">\n<pre>addresses = relationship(<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">Address</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span>, back_populates=<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">user</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span>)</pre>\n</div>\n<p>&nbsp;</p>\n</div>\n</div>\n</div>\n</div>\n<h3>2、常规的单表处理</h3>\n<p>下面我们通过异步处理的方式，介绍如何在单表中操作相关的数据库数据。</p>\n<div class=\"cnblogs_code\">\n<pre>async <span style=\"color: rgba(0, 0, 255, 1);\">def</span> get(self, db: AsyncSession, id: Any) -&gt;<span style=\"color: rgba(0, 0, 0, 1);\"> Any:\n    </span><span style=\"color: rgba(128, 0, 0, 1);\">\"\"\"</span><span style=\"color: rgba(128, 0, 0, 1);\">根据主键获取一个对象</span><span style=\"color: rgba(128, 0, 0, 1);\">\"\"\"</span>\n\n    <span style=\"color: rgba(0, 0, 255, 1);\">if</span><span style=\"color: rgba(0, 0, 0, 1);\"> isinstance(id, str):\n        query </span>= select(self.model).filter(func.lower(self.model.id) ==<span style=\"color: rgba(0, 0, 0, 1);\"> id.lower())\n    </span><span style=\"color: rgba(0, 0, 255, 1);\">else</span><span style=\"color: rgba(0, 0, 0, 1);\">:\n        query </span>= select(self.model).filter(self.model.id ==<span style=\"color: rgba(0, 0, 0, 1);\"> id)\n\n    result </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> await db.execute(query)\n    item </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> result.scalars().first()\n\n    </span><span style=\"color: rgba(0, 0, 255, 1);\">return</span> item</pre>\n</div>\n<p>如果我们需要强制对外键的类型进行匹配（如对于Postgresql的严格要求，数据比较的类型必须一致），那么我们需要在基类或者CRUD类初始化的时候，获得对应的主键类型。</p>\n<div class=\"cnblogs_code\">\n<pre><span style=\"color: rgba(0, 0, 255, 1);\">class</span><span style=\"color: rgba(0, 0, 0, 1);\"> BaseCrud(Generic[ModelType, PrimaryKeyType, PageDtoType, DtoType]):\n    </span><span style=\"color: rgba(128, 0, 0, 1);\">\"\"\"</span><span style=\"color: rgba(128, 0, 0, 1);\">\n    基础CRUD操作类，传入参数说明：\n    * `ModelType`: SQLAlchemy 模型类\n    * `PrimaryKeyType`: 限定主键的类型\n    * `PageDtoType`: 分页查询输入类\n    * `DtoType`: 数据传输对象类，如新增、更新的单个对象DTO\n    </span><span style=\"color: rgba(128, 0, 0, 1);\">\"\"\"</span>\n\n    <span style=\"color: rgba(0, 0, 255, 1);\">def</span> <span style=\"color: rgba(128, 0, 128, 1);\">__init__</span><span style=\"color: rgba(0, 0, 0, 1);\">(self, model: Type[ModelType]):\n        </span><span style=\"color: rgba(128, 0, 0, 1);\">\"\"\"</span><span style=\"color: rgba(128, 0, 0, 1);\">\n        数据库访问操作的基类对象(CRUD).\n        * `model`: A SQLAlchemy model class\n        </span><span style=\"color: rgba(128, 0, 0, 1);\">\"\"\"</span><span style=\"color: rgba(0, 0, 0, 1);\">\n        \n        self.model </span>= model  <span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> 模型类型</span>\n\n        <span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> 运行期获取主键字段类型</span>\n        <strong><span style=\"color: rgba(255, 0, 0, 1);\">pk_column</span> =</strong><span style=\"color: rgba(0, 0, 0, 1);\"><strong> inspect(model).primary_key[0]</strong>\n       <span style=\"color: rgba(255, 0, 0, 1);\"><strong> self._pk_type </strong></span></span><span style=\"color: rgba(255, 0, 0, 1);\"><strong>= pk_column.type.python_type</strong></span>  <span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> int / str</span></pre>\n</div>\n<p>因此对于单表的Get方法，我们修改下，让他匹配主键的类型进行比较，这样过对于严格类型判断的Postgresql也正常匹配了。</p>\n<div class=\"cnblogs_code\">\n<pre>    async <span style=\"color: rgba(0, 0, 255, 1);\">def</span> get(self, db: AsyncSession, id: PrimaryKeyType) -&gt;<span style=\"color: rgba(0, 0, 0, 1);\"> Optional[ModelType]:\n        </span><span style=\"color: rgba(128, 0, 0, 1);\">\"\"\"</span><span style=\"color: rgba(128, 0, 0, 1);\">根据主键获取一个对象</span><span style=\"color: rgba(128, 0, 0, 1);\">\"\"\"</span>\n        \n        <span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\">对id的主键进行类型转换，self._pk_type在构造函数的初始化中获取</span>\n        <span style=\"color: rgba(0, 0, 255, 1);\">try</span><span style=\"color: rgba(0, 0, 0, 1);\">:\n            id </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> self._pk_type(id)\n        </span><span style=\"color: rgba(0, 0, 255, 1);\">except</span><span style=\"color: rgba(0, 0, 0, 1);\"> Exception:\n            </span><span style=\"color: rgba(0, 0, 255, 1);\">raise</span> ValueError(f<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">Invalid primary key type: {id}</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">)\n        \n        </span><span style=\"color: rgba(0, 0, 255, 1);\">if</span><span style=\"color: rgba(0, 0, 0, 1);\"> isinstance(id, str):\n            query </span>= select(self.model).filter(func.lower(self.model.id) ==<span style=\"color: rgba(0, 0, 0, 1);\"> id.lower())\n        </span><span style=\"color: rgba(0, 0, 255, 1);\">else</span><span style=\"color: rgba(0, 0, 0, 1);\">:\n            query </span>= select(self.model).filter(self.model.id ==<span style=\"color: rgba(0, 0, 0, 1);\"> id)\n\n        result </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> await db.execute(query)\n        item </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> result.scalars().first()\n\n        </span><span style=\"color: rgba(0, 0, 255, 1);\">return</span> item</pre>\n</div>\n<p>对于删除的数据，我们也可以类似的处理对比进行了。</p>\n<div class=\"cnblogs_code\">\n<pre><span style=\"color: rgba(0, 0, 255, 1);\">from</span> sqlalchemy.orm <span style=\"color: rgba(0, 0, 255, 1);\">import</span><span style=\"color: rgba(0, 0, 0, 1);\"> Session, Query\n</span><span style=\"color: rgba(0, 0, 255, 1);\">from</span> sqlalchemy.ext.asyncio <span style=\"color: rgba(0, 0, 255, 1);\">import</span><span style=\"color: rgba(0, 0, 0, 1);\"> AsyncSession\n</span><span style=\"color: rgba(0, 0, 255, 1);\">from</span> sqlalchemy <span style=\"color: rgba(0, 0, 255, 1);\">import</span><span style=\"color: rgba(0, 0, 0, 1);\"> delete as sa_delete, update as sa_update\n\nasync </span><span style=\"color: rgba(0, 0, 255, 1);\">def</span> delete_byid(self, db: AsyncSession, id: PrimaryKeyType) -&gt;<span style=\"color: rgba(0, 0, 0, 1);\"> bool:\n    </span><span style=\"color: rgba(128, 0, 0, 1);\">\"\"\"</span><span style=\"color: rgba(128, 0, 0, 1);\">根据主键删除一个对象\n    \n    :param id: 主键值\n    </span><span style=\"color: rgba(128, 0, 0, 1);\">\"\"\"</span>\n    \n    <span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\">对id的主键进行类型转换，self._pk_type在构造函数的初始化中获取</span>\n    <span style=\"color: rgba(0, 0, 255, 1);\">try</span><span style=\"color: rgba(0, 0, 0, 1);\">:\n        id </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> self._pk_type(id)\n    </span><span style=\"color: rgba(0, 0, 255, 1);\">except</span><span style=\"color: rgba(0, 0, 0, 1);\"> Exception:\n        </span><span style=\"color: rgba(0, 0, 255, 1);\">raise</span> ValueError(f<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">Invalid primary key type: {id}</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">)\n    \n    del_query: sa_delete\n    </span><span style=\"color: rgba(0, 0, 255, 1);\">if</span><span style=\"color: rgba(0, 0, 0, 1);\"> isinstance(id, str):\n        del_query </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> sa_delete(self.model).where(\n            func.lower(self.model.id) </span>==<span style=\"color: rgba(0, 0, 0, 1);\"> id.lower()\n        )\n    </span><span style=\"color: rgba(0, 0, 255, 1);\">else</span><span style=\"color: rgba(0, 0, 0, 1);\">:\n        del_query </span>= sa_delete(self.model).where(self.model.id ==<span style=\"color: rgba(0, 0, 0, 1);\"> id)\n\n    result </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> await db.execute(del_query)\n\n    await db.commit()\n    </span><span style=\"color: rgba(0, 0, 255, 1);\">return</span> result.rowcount &gt; 0</pre>\n</div>\n<p>对于提供多条件的查询或者过滤，我们可以使用<strong>where</strong>函数或者<strong>filter</strong>函数，在 SQLAlchemy 中，<code>select(...).where(...)</code>&nbsp;和&nbsp;<code>select(...).filter(...)</code>&nbsp;都用于构造查询条件，如下所示等效。</p>\n<div class=\"cnblogs_code\">\n<pre>query = select(self.model).where(self.model.id ==<span style=\"color: rgba(0, 0, 0, 1);\"> id)\n\nquery </span>= select(self.model).filter(self.model.id == id)</pre>\n</div>\n<p>我们可以通过sqlAlchemy的and_和or_函数来进行组合多个条件。</p>\n<div class=\"cnblogs_code\">\n<pre><span style=\"color: rgba(0, 0, 255, 1);\">from</span> sqlalchemy <span style=\"color: rgba(0, 0, 255, 1);\">import</span><span style=\"color: rgba(0, 0, 0, 1);\"> ( Table,Column,and_,or_,asc,desc,select,func,distinct,text, Integer)\n\n....\n    match expression:\n        case </span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">and</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">:\n            query </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> await db.execute(\n                select(self.model)\n               <span style=\"color: rgba(255, 0, 0, 1);\"><strong> .filter(and_(</strong></span></span><span style=\"color: rgba(255, 0, 0, 1);\"><strong>*</strong></span><span style=\"color: rgba(0, 0, 0, 1);\"><span style=\"color: rgba(255, 0, 0, 1);\"><strong>where_list))</strong></span>\n                .order_by(</span>*<span style=\"color: rgba(0, 0, 0, 1);\">order_by_list)\n            )\n        case </span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">or</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">:\n            query </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> await db.execute(\n                select(self.model).<strong><span style=\"color: rgba(255, 0, 0, 1);\">filter(or_(</span></strong></span><strong><span style=\"color: rgba(255, 0, 0, 1);\">*where_list))</span></strong>.order_by(*<span style=\"color: rgba(0, 0, 0, 1);\">order_by_list)\n            )</span></pre>\n</div>\n<p>Python的SqlAlchemy提供&nbsp;InstrumentedAttribute 对象来操作多个条件，如我们对于一些多条件的处理，可以利用它来传递多个参数。</p>\n<div class=\"cnblogs_code\">\n<pre>    async <span style=\"color: rgba(0, 0, 255, 1);\">def</span><span style=\"color: rgba(0, 0, 0, 1);\"> get_all_by_attributes(\n        self, db: AsyncSession, </span>*attributes: InstrumentedAttribute, sorting: str = <span style=\"color: rgba(128, 0, 0, 1);\">\"\"</span><span style=\"color: rgba(0, 0, 0, 1);\">\n    ) </span>-&gt; List[ModelType] |<span style=\"color: rgba(0, 0, 0, 1);\"> None:\n        </span><span style=\"color: rgba(128, 0, 0, 1);\">\"\"\"</span><span style=\"color: rgba(128, 0, 0, 1);\">根据列名称和值获取相关的对象列表\n\n        :param sorting: 格式：name asc 或 name asc,age desc\n        :param attributes: SQLAlchemy InstrumentedAttribute objects，可以输入多个条件\n        例子：User.id != 1 或者 User.username == \"JohnDoe\"\n        </span><span style=\"color: rgba(128, 0, 0, 1);\">\"\"\"</span><span style=\"color: rgba(0, 0, 0, 1);\">\n\n        order_by_list </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> parse_sort_string(sorting, self.model)\n        query </span>= select(self.model).filter(and_(*attributes)).order_by(*<span style=\"color: rgba(0, 0, 0, 1);\">order_by_list)\n        \n        result </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> await db.execute(query)\n        </span><span style=\"color: rgba(0, 0, 255, 1);\">return</span> result.scalars().all()</pre>\n</div>\n<p>例如，对于 模型&nbsp;Material 对象，我们对它进行多个条件的查询处理，如下所示，红色部分为 *attributes: InstrumentedAttribute 参数。</p>\n<div class=\"cnblogs_code\">\n<pre>items =<span style=\"color: rgba(0, 0, 0, 1);\"> await super().get_all_by_attributes(\n    db,\n<span style=\"color: rgba(255, 0, 0, 1);\"><strong>    Material.id </strong></span></span><span style=\"color: rgba(255, 0, 0, 1);\"><strong>== vercol.id,\n    Material.vercol == vercol.vercol,\n    Material.ischecked == 0,\n    Material.status ==</strong></span><span style=\"color: rgba(0, 0, 0, 1);\"><span style=\"color: rgba(255, 0, 0, 1);\"><strong> 0,</strong></span>\n)</span></pre>\n</div>\n<p>同样我们可以利用它来获取数量，或者判断多条件的记录是否存在。</p>\n<p><img alt=\"image\" height=\"532\" src=\"https://img2024.cnblogs.com/blog/8867/202512/8867-20251225103430193-1873231330.png\" width=\"944\" /></p>\n<p>&nbsp;在数据插入或者更新的操作中，我们可以接受对象类型或者字典类型的参数对象，因此方法如下所示。</p>\n<div class=\"cnblogs_code\">\n<pre>   async <span style=\"color: rgba(0, 0, 255, 1);\">def</span> update(self, db: AsyncSession, obj_in: DtoType | dict[str, Any]) -&gt;<span style=\"color: rgba(0, 0, 0, 1);\"> bool:\n        </span><span style=\"color: rgba(128, 0, 0, 1);\">\"\"\"</span><span style=\"color: rgba(128, 0, 0, 1);\">更新对象\n        \n        :param obj_in: 对象输入数据,可以是 DTO 对象或字典\n        </span><span style=\"color: rgba(128, 0, 0, 1);\">\"\"\"</span>\n        <span style=\"color: rgba(0, 0, 255, 1);\">try</span><span style=\"color: rgba(0, 0, 0, 1);\">:\n            </span><span style=\"color: rgba(0, 0, 255, 1);\">if</span><span style=\"color: rgba(0, 0, 0, 1);\"> isinstance(obj_in, dict):\n                obj_id </span>= obj_in.get(<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">id</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">)\n                </span><span style=\"color: rgba(0, 0, 255, 1);\">if</span> obj_id <span style=\"color: rgba(0, 0, 255, 1);\">is</span><span style=\"color: rgba(0, 0, 0, 1);\"> None:\n                    </span><span style=\"color: rgba(0, 0, 255, 1);\">raise</span> ValueError(<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">id is required for update</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">)\n                update_data </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> obj_in\n            </span><span style=\"color: rgba(0, 0, 255, 1);\">else</span><span style=\"color: rgba(0, 0, 0, 1);\">:\n                obj_id </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> obj_in.id\n                </span><span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> update_data = vars(obj_in)  </span>\n                update_data = obj_in.model_dump(exclude_unset=<span style=\"color: rgba(0, 0, 0, 1);\">True)\n\n            query </span>= select(self.model).filter(self.model.id ==<span style=\"color: rgba(0, 0, 0, 1);\"> obj_id)\n            result </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> await db.execute(query)\n            db_obj </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> result.scalars().first()\n\n            </span><span style=\"color: rgba(0, 0, 255, 1);\">if</span><span style=\"color: rgba(0, 0, 0, 1);\"> db_obj:\n                </span><span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> 更新对象字段</span>\n                <span style=\"color: rgba(0, 0, 255, 1);\">for</span> field, value <span style=\"color: rgba(0, 0, 255, 1);\">in</span><span style=\"color: rgba(0, 0, 0, 1);\"> update_data.items():\n                    </span><span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> 跳过以 \"_\" 开头的私有属性</span>\n                    <span style=\"color: rgba(0, 0, 255, 1);\">if</span> field.startswith(<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">_</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">):\n                        </span><span style=\"color: rgba(0, 0, 255, 1);\">continue</span><span style=\"color: rgba(0, 0, 0, 1);\">\n                    setattr(db_obj, field, value)\n\n                </span><span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> 处理更新前的回调处理</span>\n<span style=\"color: rgba(255, 0, 0, 1);\"><strong>                self.on_before_update(update_data, db_obj)\n                </strong></span><span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> 提交事务</span>\n<span style=\"color: rgba(0, 0, 0, 1);\">                await db.commit()\n                </span><span style=\"color: rgba(0, 0, 255, 1);\">return</span><span style=\"color: rgba(0, 0, 0, 1);\"> True\n            </span><span style=\"color: rgba(0, 0, 255, 1);\">else</span><span style=\"color: rgba(0, 0, 0, 1);\">:\n                </span><span style=\"color: rgba(0, 0, 255, 1);\">return</span><span style=\"color: rgba(0, 0, 0, 1);\"> False\n        </span><span style=\"color: rgba(0, 0, 255, 1);\">except</span><span style=\"color: rgba(0, 0, 0, 1);\"> SQLAlchemyError as e:\n            self.logger.error(f</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">update 操作出现错误: {e}</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">)\n            await db.rollback()  </span><span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> 确保在出错时回滚事务</span>\n            <span style=\"color: rgba(0, 0, 255, 1);\">return</span> False</pre>\n</div>\n<p>我们在插入或者更新数据的时候，一般会默认更新一些字段，如创建人，创建日期、编辑人，编辑日期等信息，我们可以把它单独作为一个可以给子类重写的函数，基类做一些默认的处理。</p>\n<div class=\"cnblogs_code\">\n<pre>    <span style=\"color: rgba(0, 0, 255, 1);\">def</span> on_before_update(self, update_data: dict[str, Any], db_obj: ModelType) -&gt;<span style=\"color: rgba(0, 0, 0, 1);\"> None:\n        </span><span style=\"color: rgba(128, 0, 0, 1);\">\"\"\"</span><span style=\"color: rgba(128, 0, 0, 1);\">更新对象前的回调函数，子类可以重写此方法\n\n        可通过 setattr(db_obj, field, value) 设置字段值\n        </span><span style=\"color: rgba(128, 0, 0, 1);\">\"\"\"</span><span style=\"color: rgba(0, 0, 0, 1);\">\n        \n        setattr(db_obj, </span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">edittime</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">, datetime.now())\n        user :CurrentUserIns  </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> get_current_user()\n        </span><span style=\"color: rgba(0, 0, 255, 1);\">if</span><span style=\"color: rgba(0, 0, 0, 1);\"> user:\n            setattr(db_obj, </span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">editor</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">, user.fullname)\n            setattr(db_obj, </span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">editor_id</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">, user.id)\n\n            setattr(db_obj, </span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">company_id</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">, user.company_id)\n            setattr(db_obj, </span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">companyname</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span>, user.companyname)</pre>\n</div>\n<p>有时候，如果我们需要获取某个字段非重复的列表，用来做为动态下拉列表的数据，那么我们可以通过下面函数封装下。</p>\n<div class=\"cnblogs_code\">\n<pre>    async <span style=\"color: rgba(0, 0, 255, 1);\">def</span> get_field_list(self, db: AsyncSession, field_name: str) -&gt;<span style=\"color: rgba(0, 0, 0, 1);\"> Iterable[str]:\n        </span><span style=\"color: rgba(128, 0, 0, 1);\">\"\"\"</span><span style=\"color: rgba(128, 0, 0, 1);\">获取指定字段值的唯一列表\n\n        :param field_name: 字段名称\n        </span><span style=\"color: rgba(128, 0, 0, 1);\">\"\"\"</span><span style=\"color: rgba(0, 0, 0, 1);\">\n\n        field </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> getattr(self.model, field_name)\n        query </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> select(distinct(field))\n        result </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> await db.execute(query)\n        </span><span style=\"color: rgba(0, 0, 255, 1);\">return</span> result.scalars().all()</pre>\n</div>\n<p>&nbsp;</p>\n<h3>3、多表联合的处理操作&nbsp;</h3>\n<p>多表操作，也是我们经常碰到的处理方式，如对于字典类型和字典项目，他们是两个表，需要联合起来获取数据，那么就需要多表的联合操作。</p>\n<p><img alt=\"image\" height=\"326\" src=\"https://img2024.cnblogs.com/blog/8867/202512/8867-20251225110211988-1085898697.png\" width=\"238\" /></p>\n<p>&nbsp;如下是字典CRUD类中，联合字典类型获取数据的记录处理。</p>\n<div class=\"cnblogs_code\">\n<pre>    async <span style=\"color: rgba(0, 0, 255, 1);\">def</span> get_dict_by_typename(self, db: AsyncSession, dicttype_name: str) -&gt;<span style=\"color: rgba(0, 0, 0, 1);\"> dict:\n        </span><span style=\"color: rgba(128, 0, 0, 1);\">\"\"\"</span><span style=\"color: rgba(128, 0, 0, 1);\">根据字典类型名称获取所有该类型的字典列表集合</span><span style=\"color: rgba(128, 0, 0, 1);\">\"\"\"</span><span style=\"color: rgba(0, 0, 0, 1);\">\n        result </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> await db.execute(\n            select(self.model)\n            <span style=\"color: rgba(255, 0, 0, 1);\"><strong>.join(DictType, DictType.id </strong></span></span><span style=\"color: rgba(255, 0, 0, 1);\"><strong>== self.model.dicttype_id)</strong></span>  <span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> 关联字典类型表</span>\n            <strong><span style=\"color: rgba(255, 0, 0, 1);\">.filter(DictType.name == dicttype_name)</span> </strong> <span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> 过滤字典类型名称</span>\n            .order_by(DictData.seq)  <span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> 排序</span>\n<span style=\"color: rgba(0, 0, 0, 1);\">        )\n        items </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> result.scalars().all()\n\n        dict </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> {}\n        </span><span style=\"color: rgba(0, 0, 255, 1);\">for</span> info <span style=\"color: rgba(0, 0, 255, 1);\">in</span><span style=\"color: rgba(0, 0, 0, 1);\"> items:\n            </span><span style=\"color: rgba(0, 0, 255, 1);\">if</span> info.name <span style=\"color: rgba(0, 0, 255, 1);\">not</span> <span style=\"color: rgba(0, 0, 255, 1);\">in</span><span style=\"color: rgba(0, 0, 0, 1);\"> dict:\n                dict[info.name] </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> info.value\n\n        </span><span style=\"color: rgba(0, 0, 255, 1);\">return</span> dict</pre>\n</div>\n<p>如果我们需要对某个表的递归获取树列表，可以如下处理</p>\n<div class=\"cnblogs_code\">\n<pre>    async <span style=\"color: rgba(0, 0, 255, 1);\">def</span> get_tree(self, db: AsyncSession, pid: str) -&gt;<span style=\"color: rgba(0, 0, 0, 1);\"> list[DictType]:\n        </span><span style=\"color: rgba(128, 0, 0, 1);\">\"\"\"</span><span style=\"color: rgba(128, 0, 0, 1);\">获取字典类型一级列表及其下面的内容</span><span style=\"color: rgba(128, 0, 0, 1);\">\"\"\"</span>\n\n        <span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> 使用三元运算符将 pid 设为 \"-1\"（如果 pid 是 null 或空白）或保持原值</span>\n        pid = <span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">-1</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span> <span style=\"color: rgba(0, 0, 255, 1);\">if</span> <span style=\"color: rgba(0, 0, 255, 1);\">not</span> pid <span style=\"color: rgba(0, 0, 255, 1);\">or</span> pid.strip() == <span style=\"color: rgba(128, 0, 0, 1);\">\"\"</span> <span style=\"color: rgba(0, 0, 255, 1);\">else</span><span style=\"color: rgba(0, 0, 0, 1);\"> pid\n        result </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> await db.execute(\n            select(self.model)\n            .filter(self.model.pid </span>==<span style=\"color: rgba(0, 0, 0, 1);\"> pid)\n            .options(selectinload(DictType.children))\n        )\n        nodes </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> result.scalars().all()\n        </span><span style=\"color: rgba(0, 0, 255, 1);\">return</span> nodes</pre>\n</div>\n<p>我们来假设用户和文章的示例表结构（ORM 模型，如下所示。</p>\n<div class=\"cnblogs_code\">\n<pre><span style=\"color: rgba(0, 0, 255, 1);\">class</span><span style=\"color: rgba(0, 0, 0, 1);\"> User(Base):\n    </span><span style=\"color: rgba(128, 0, 128, 1);\">__tablename__</span> = <span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">users</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">\n    id </span>= Column(Integer, primary_key=True, index=<span style=\"color: rgba(0, 0, 0, 1);\">True)\n    name </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> Column(String)\n    email </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> Column(String)\n<span style=\"color: rgba(255, 0, 0, 1);\">    articles </span></span><span style=\"color: rgba(255, 0, 0, 1);\">= <strong>relationship</strong>(\"Article\", back_populates=\"author\")\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1);\">class</span><span style=\"color: rgba(0, 0, 0, 1);\"> Article(Base):\n    </span><span style=\"color: rgba(128, 0, 128, 1);\">__tablename__</span> = <span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">articles</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">\n    id </span>= Column(Integer, primary_key=True, index=<span style=\"color: rgba(0, 0, 0, 1);\">True)\n    title </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> Column(String)\n    content </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> Column(Text)\n<span style=\"color: rgba(255, 0, 0, 1);\">    user_id </span></span><span style=\"color: rgba(255, 0, 0, 1);\">= Column(Integer, <strong>ForeignKey</strong>(\"users.id\"))\n    author = <strong>relationship</strong>(\"User\", back_populates=\"articles\")</span></pre>\n</div>\n<p>我们可以通过下面函数处理获得相关的记录集合。</p>\n<div class=\"cnblogs_code\">\n<pre>async <span style=\"color: rgba(0, 0, 255, 1);\">def</span><span style=\"color: rgba(0, 0, 0, 1);\"> get_user_articles(db: AsyncSession):\n    stmt </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> (\n        select(User, Article)\n        .<span style=\"color: rgba(255, 0, 0, 1);\"><strong>join</strong></span>(Article, Article.user_id </span>==<span style=\"color: rgba(0, 0, 0, 1);\"> User.id)\n    )\n    result </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> await db.execute(stmt)\n    </span><span style=\"color: rgba(0, 0, 255, 1);\">return</span> result.all()   <span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> [<strong><span style=\"color: rgba(255, 0, 0, 1);\">(User(), Article()), .</span></strong>..]</span></pre>\n</div>\n<p>如果需要可以使用outer_join函数处理</p>\n<div class=\"cnblogs_code\">\n<pre>async <span style=\"color: rgba(0, 0, 255, 1);\">def</span><span style=\"color: rgba(0, 0, 0, 1);\"> get_users_with_articles(db: AsyncSession):\n    stmt </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> (\n        select(User, Article)\n        .<span style=\"color: rgba(255, 0, 0, 1);\"><strong>outerjoin</strong></span>(Article, Article.user_id </span>==<span style=\"color: rgba(0, 0, 0, 1);\"> User.id)\n    )\n    result </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> await db.execute(stmt)\n    </span><span style=\"color: rgba(0, 0, 255, 1);\">return</span> result.all()  <span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> 用户即便没有文章也会出现</span></pre>\n</div>\n<p>&nbsp;</p>\n<p>如果我们需要获取有文章的所有用户，如下所示。</p>\n<div class=\"cnblogs_code\">\n<pre>async <span style=\"color: rgba(0, 0, 255, 1);\">def</span><span style=\"color: rgba(0, 0, 0, 1);\"> get_users_with_articles(db: AsyncSession):\n    stmt </span>= select(User).options(<span style=\"color: rgba(255, 0, 0, 1);\"><strong>selectinload</strong></span>(User.articles))  <span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> 自动 load 关联</span>\n    result =<span style=\"color: rgba(0, 0, 0, 1);\"> await db.execute(stmt)\n    </span><span style=\"color: rgba(0, 0, 255, 1);\">return</span> result.scalars().all()</pre>\n</div>\n<p><code>selectinload</code> 会执行两次 SQL，但效率高，不会产生笛卡尔积，非常适合集合查询。</p>\n<p>多表链式 Join的处理，可以获得两个表的不同信息进行组合。</p>\n<div class=\"cnblogs_code\">\n<pre>async <span style=\"color: rgba(0, 0, 255, 1);\">def</span><span style=\"color: rgba(0, 0, 0, 1);\"> get_articles_with_author(db: AsyncSession):\n    stmt </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> (\n        select(Article.title, User.name.label(</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">author</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">))\n        .join(User, Article.user_id </span>==<span style=\"color: rgba(0, 0, 0, 1);\"> User.id)\n    )\n    rows </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> await db.execute(stmt)\n    </span><span style=\"color: rgba(0, 0, 255, 1);\">return</span> <span style=\"color: rgba(255, 0, 0, 1);\"><strong>rows.mappings().all()</strong></span>  <span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> 以 dict 形式返回 [{'title':..., 'author':...}]</span></pre>\n</div>\n<p>带筛选条件与分页的处理实现，如下所示</p>\n<div class=\"cnblogs_code\">\n<pre>async <span style=\"color: rgba(0, 0, 255, 1);\">def</span> search_articles(db: AsyncSession, keyword: str, page: int = 1, size: int = 10<span style=\"color: rgba(0, 0, 0, 1);\">):\n    stmt </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> (\n        select(Article, User.name.label(</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">author</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">))\n        .join(User)\n        .filter(Article.title.contains(keyword))\n        .offset((page </span>- 1) *<span style=\"color: rgba(0, 0, 0, 1);\"> size)\n        .limit(size)\n    )\n    result </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> await db.execute(stmt)\n    </span><span style=\"color: rgba(0, 0, 255, 1);\">return</span> result.mappings().all()</pre>\n</div>\n<p>&nbsp;</p>\n<p>对于权限管理系统来说，一般有用户、角色，以及用户角色的中间表，一般来说他们的关系如下</p>\n<p><img alt=\"image\" height=\"363\" src=\"https://img2024.cnblogs.com/blog/8867/202512/8867-20251225122040874-818263456.png\" width=\"729\" /></p>\n<p>&nbsp;在界面中一般会提供选择用户的操作关联，如角色中维护用户列表。</p>\n<p><img alt=\"image\" height=\"426\" src=\"https://img2024.cnblogs.com/blog/8867/202512/8867-20251225121122302-651245416.png\" width=\"481\" /></p>\n<p>&nbsp;我们来看看这个在SQLAlchemy最佳实践是如何的操作。</p>\n<div class=\"cnblogs_code\">\n<pre><span style=\"color: rgba(0, 0, 255, 1);\">from</span> sqlalchemy <span style=\"color: rgba(0, 0, 255, 1);\">import</span><span style=\"color: rgba(0, 0, 0, 1);\"> Table, Column, Integer, ForeignKey\n</span><span style=\"color: rgba(0, 0, 255, 1);\">from</span> sqlalchemy.orm <span style=\"color: rgba(0, 0, 255, 1);\">import</span><span style=\"color: rgba(0, 0, 0, 1);\"> relationship, Mapped, mapped_column\n</span><span style=\"color: rgba(0, 0, 255, 1);\">from</span> database <span style=\"color: rgba(0, 0, 255, 1);\">import</span><span style=\"color: rgba(0, 0, 0, 1);\"> Base\n\n</span><span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> --- 中间表写法 ---</span>\nrole_user =<span style=\"color: rgba(0, 0, 0, 1);\"> Table(\n    </span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">role_user</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">,\n    Base.metadata,\n    Column(</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">user_id</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span>, ForeignKey(<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">users.id</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span>), primary_key=<span style=\"color: rgba(0, 0, 0, 1);\">True),\n    Column(</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">role_id</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span>, ForeignKey(<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">roles.id</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span>), primary_key=<span style=\"color: rgba(0, 0, 0, 1);\">True)\n)\n\n</span><span style=\"color: rgba(0, 0, 255, 1);\">class</span><span style=\"color: rgba(0, 0, 0, 1);\"> User(Base):\n    </span><span style=\"color: rgba(128, 0, 128, 1);\">__tablename__</span> = <span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">users</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">\n    id: Mapped[int] </span>= mapped_column(primary_key=<span style=\"color: rgba(0, 0, 0, 1);\">True)\n    username: Mapped[str] </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> mapped_column()\n\n    roles: Mapped[list[</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">Role</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span>]] =<span style=\"color: rgba(0, 0, 0, 1);\"> relationship(\n        secondary</span>=<span style=\"color: rgba(0, 0, 0, 1);\">role_user,\n        back_populates</span>=<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">users</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">,\n        lazy</span>=<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">selectin</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">\n    )\n\n</span><span style=\"color: rgba(0, 0, 255, 1);\">class</span><span style=\"color: rgba(0, 0, 0, 1);\"> Role(Base):\n    </span><span style=\"color: rgba(128, 0, 128, 1);\">__tablename__</span> = <span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">roles</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">\n    id: Mapped[int] </span>= mapped_column(primary_key=<span style=\"color: rgba(0, 0, 0, 1);\">True)\n    name: Mapped[str] </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> mapped_column()\n\n    users: Mapped[list[User]] </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> relationship(\n        secondary</span>=<span style=\"color: rgba(0, 0, 0, 1);\">role_user,\n        back_populates</span>=<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">roles</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">,\n        lazy</span>=<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">selectin</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">\n    )</span></pre>\n</div>\n<p>在 SQLAlchemy 声明多对多关系时，<code>secondary</code> 参数既可以填 <strong>字符串形式的表名</strong>，也可以填 <strong>已经定义好的中间表对象（Table 对象）。</strong></p>\n<p><strong>① econdary=\"role_user\" —— 使用字符串表名</strong></p>\n<div class=\"cnblogs_code\">\n<pre>roles = relationship(<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">Role</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span>, secondary=<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">role_user</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span>, back_populates=<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">users</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span>)</pre>\n</div>\n<p><strong>② secondary=role_user —— 传入中间表对象（推荐方式）</strong></p>\n<div class=\"cnblogs_code\">\n<pre>role_user =<span style=\"color: rgba(0, 0, 0, 1);\"> Table(\n    </span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">role_user</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">,\n    Base.metadata,\n    Column(</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">user_id</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span>, ForeignKey(<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">users.id</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span>), primary_key=<span style=\"color: rgba(0, 0, 0, 1);\">True),\n    Column(</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">role_id</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span>, ForeignKey(<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">roles.id</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span>), primary_key=<span style=\"color: rgba(0, 0, 0, 1);\">True)\n)\n\nroles </span>= relationship(<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">Role</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span>, secondary=role_user, back_populates=<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">users</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span>)</pre>\n</div>\n<p>对于如果获取对应角色的用户记录，我们可以通过下面方式获取（通过连接中间表的方式）</p>\n<div class=\"cnblogs_code\">\n<pre>async <span style=\"color: rgba(0, 0, 255, 1);\">def</span> get_users_by_role(db: AsyncSession, role_id: int) -&gt;<span style=\"color: rgba(0, 0, 0, 1);\"> list[User]:\n    stmt </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> (\n        select(User)\n        .join(role_user, role_user.c.user_id </span>==<span style=\"color: rgba(0, 0, 0, 1);\"> User.id)\n        .where(role_user.c.role_id </span>==<span style=\"color: rgba(0, 0, 0, 1);\"> role_id)\n    )\n    result </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> await db.execute(stmt)\n    </span><span style=\"color: rgba(0, 0, 255, 1);\">return</span> result.scalars().all()</pre>\n</div>\n<p>也可以下面的方式进行处理（使用 relationship any()），效果是一样的。</p>\n<div class=\"cnblogs_code\">\n<pre>select(User).filter(User.roles.any(id=role_id))</pre>\n</div>\n<p>如果需要写入用户、角色的关联关系，我们可以使用下面方法来通过中间表进行判断并写入记录。</p>\n<div class=\"cnblogs_code\">\n<pre><span style=\"color: rgba(0, 0, 255, 1);\">from</span> sqlalchemy <span style=\"color: rgba(0, 0, 255, 1);\">import</span><span style=\"color: rgba(0, 0, 0, 1);\"> select, insert\n\nasync </span><span style=\"color: rgba(0, 0, 255, 1);\">def</span><span style=\"color: rgba(0, 0, 0, 1);\"> add_users_to_role(db: AsyncSession, role_id: int, user_ids: list[int]):\n    </span><span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> 1️⃣ 查询已有关联 user_id</span>\n    stmt = select(role_user.c.user_id).where(role_user.c.role_id ==<span style=\"color: rgba(0, 0, 0, 1);\"> role_id)\n    res </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> await db.execute(stmt)\n    existing_user_ids </span>= {row[0] <span style=\"color: rgba(0, 0, 255, 1);\">for</span> row <span style=\"color: rgba(0, 0, 255, 1);\">in</span><span style=\"color: rgba(0, 0, 0, 1);\"> res.fetchall()}\n\n    </span><span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> 2️⃣ 过滤出新的 user_id</span>\n    new_user_ids = [uid <span style=\"color: rgba(0, 0, 255, 1);\">for</span> uid <span style=\"color: rgba(0, 0, 255, 1);\">in</span> user_ids <span style=\"color: rgba(0, 0, 255, 1);\">if</span> uid <span style=\"color: rgba(0, 0, 255, 1);\">not</span> <span style=\"color: rgba(0, 0, 255, 1);\">in</span><span style=\"color: rgba(0, 0, 0, 1);\"> existing_user_ids]\n    </span><span style=\"color: rgba(0, 0, 255, 1);\">if</span> <span style=\"color: rgba(0, 0, 255, 1);\">not</span><span style=\"color: rgba(0, 0, 0, 1);\"> new_user_ids:\n        </span><span style=\"color: rgba(0, 0, 255, 1);\">return</span> 0  <span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> 没有新增</span>\n\n    <span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> 3️⃣ 批量插入</span>\n    values = [{<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">user_id</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span>: uid, <span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">role_id</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span>: role_id} <span style=\"color: rgba(0, 0, 255, 1);\">for</span> uid <span style=\"color: rgba(0, 0, 255, 1);\">in</span><span style=\"color: rgba(0, 0, 0, 1);\"> new_user_ids]\n    stmt </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> insert(role_user).values(values)\n    await db.execute(stmt)\n    await db.commit()\n\n    </span><span style=\"color: rgba(0, 0, 255, 1);\">return</span> len(new_user_ids)</pre>\n</div>\n<p>如果只是单个记录的插入，可以利用下面的方式处理。</p>\n<div class=\"cnblogs_code\">\n<pre><span style=\"color: rgba(0, 0, 255, 1);\">from</span> sqlalchemy <span style=\"color: rgba(0, 0, 255, 1);\">import</span><span style=\"color: rgba(0, 0, 0, 1);\"> select, insert\n\nasync </span><span style=\"color: rgba(0, 0, 255, 1);\">def</span> add_user_to_role(db: AsyncSession, role_id: int, user_id: int) -&gt;<span style=\"color: rgba(0, 0, 0, 1);\"> bool:\n    </span><span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> 1️⃣ 检查是否已存在关联</span>\n    stmt =<span style=\"color: rgba(0, 0, 0, 1);\"> select(role_user).where(\n        role_user.c.role_id </span>==<span style=\"color: rgba(0, 0, 0, 1);\"> role_id,\n        role_user.c.user_id </span>==<span style=\"color: rgba(0, 0, 0, 1);\"> user_id\n    )\n    res </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> await db.execute(stmt)\n    exists </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> res.first()\n\n    </span><span style=\"color: rgba(0, 0, 255, 1);\">if</span><span style=\"color: rgba(0, 0, 0, 1);\"> exists:\n        </span><span style=\"color: rgba(0, 0, 255, 1);\">return</span> False  <span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> 已存在，不再插入</span>\n\n    <span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> 2️⃣ 插入记录</span>\n    stmt = insert(role_user).values(user_id=user_id, role_id=<span style=\"color: rgba(0, 0, 0, 1);\">role_id)\n    await db.execute(stmt)\n    await db.commit()\n\n    </span><span style=\"color: rgba(0, 0, 255, 1);\">return</span> True</pre>\n</div>\n<p>以上就是对于在Python+FastAPI的后端项目中使用SqlAlchemy操作数据的几种常见方式，包括单表处理，多表关联、中间表的数据维护和定义等内容，是我们在操作常规数据的时候，经常碰到的几种方式。</p>\n<p>希望上文对你有所启发和帮助，感谢阅读。</p>\n</div>\n<div id=\"MySignature\">\n    <div style=\"border-right-color: #cccccc; border-right-width: 1px; border-right-style: solid; padding-right: 5px; border-top-color: #cccccc; border-top-width: 1px; border-top-style: solid; padding-left: 4px; font-size: 13px; padding-bottom: 4px; border-left-color: #cccccc; border-left-width: 1px; border-left-style: solid; width: 98%; padding-top: 4px; border-bottom-color: #cccccc; border-bottom-width: 1px; border-bottom-style: solid; background-color: #eeeeee;\">\n    <img align=\"top\" alt=\"\" src=\"http://www.cnblogs.com/Images/OutliningIndicators/None.gif\" />\n    <span style=\"color: #000000;\"><span class=\"Apple-tab-span\" style=\"white-space: pre;\"></span>\n     专注于代码生成工具、.Net/Python 框架架构及软件开发，以及各种Vue.js的前端技术应用。著有Winform开发框架/混合式开发框架、微信开发框架、Bootstrap开发框架、ABP开发框架、SqlSugar开发框架、Python开发框架等框架产品。\n     <br />&nbsp;&nbsp;转载请注明出处：撰写人：伍华聪&nbsp;&nbsp;<a href=\"http://www.iqidi.com/\" target=\"_blank\">http://www.iqidi.com</a>&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span></div>\n</div>\n<div class=\"clear\"></div>\n\n        </div>\n        <p class=\"postfoot\">\n            posted on \n<span id=\"post-date\">2025-12-25 11:59</span>&nbsp;\n<a href=\"https://www.cnblogs.com/wuhuacong\">伍华聪</a>&nbsp;\n阅读(<span id=\"post_view_count\">21</span>)&nbsp;\n评论(<span id=\"post_comment_count\">0</span>)&nbsp;\n&nbsp;\n<a href=\"\">收藏</a>&nbsp;\n<a href=\"\">举报</a>\n\n        </p>"
    },
    {
      "title": "女友怒骂国内不能用Claude Code，于是我给她做了一个",
      "link": "https://www.cnblogs.com/yupi/p/19397182",
      "published": "",
      "description": "<h1 class=\"postTitle\">\n                <a class=\"postTitle2 vertical-middle\" href=\"https://www.cnblogs.com/yupi/p/19397182\" id=\"cb_post_title_url\" title=\"发布于 2025-12-25 11:28\">\n    <span>女友怒骂国内不能用Claude Code，于是我给她做了一个</span>\n    \n\n</a>\n\n            </h1>\n            <div class=\"clear\"></div>\n            <div class=\"postBody\">\n                    <div id=\"cnblogs_post_description\" style=\"display: none;\">\n        <img alt=\"女友怒骂国内不能用Claude Code，于是我给她做了一个\" class=\"desc_img\" src=\"https://img2024.cnblogs.com/blog/2225420/202512/2225420-20251225112813033-1712384844.png\" />\n        最近女友开始学习 AI 编程了（被我带的），她听说 Claude Code 这个 AI 编程工具很牛掰，结果试了下发现得要国外的 Claude 账号才能登陆。\n    </div>\n<div class=\"blogpost-body blogpost-body-html\" id=\"cnblogs_post_body\">\n<p class=\"md-end-block md-heading\"><span class=\"md-plain\">大家好，我是程序员鱼皮。最近女友开始学习 AI 编程了（被我带的），她听说 Claude Code 这个 AI 编程工具很牛掰，结果试了下发现得要国外的 Claude 账号才能登陆。</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">然后她就骂骂咧咧地跟我吐槽。</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">展现男友力的时候到了，于是我开玩笑地说：别难过了，要不我给你做一个 Claude Code 算了？</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">结果，她当真了！</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">我 ↓</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">没办法，只能试一试了，毕竟谁希望圣诞节这两天让自家人难过呢？</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">正好这两天国产 AI 大模型 GLM-4.7 发布了，我看网上很多博主都在吹什么 “国内最强的编程模型”、“最强的开源模型”、“Claude 的最佳平替”，甚至说是超过了 GPT-5.2 和 Claude Sonnet 4.5。</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">你说国产最强也就算了，超过 Claude 这我能信么？</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">那正好，我就尝试用 GLM-4.7 来做个自己的 AI 编程工具吧，对标 Claude Code 那种的，看看 GLM-4.7 到底几斤几两。</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">接下来，就让我们一起 <span class=\"md-pair-s \"><strong>用 GLM-4.7 + Claude Code</strong><span class=\"md-plain\"> 开发一个 <span class=\"md-pair-s \"><strong>基于 GLM-4.7 的仿 Claude Code</strong><span class=\"md-plain\"> 的 AI 编程工具。</span></span></span></span></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">项目开始前，先起一个响当当的名字，就叫 <span class=\"md-pair-s\"><code>Yupi Code</code><span class=\"md-plain\"> 吧！</span></span></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">接下来，我们将遵循这套《鱼皮 AI Vibe Coding 开发仿 Claude Code 的 Yupi Code》流程，不写一行代码，一步一步把 “Claude Code” 做出来！</span></p>\n<ul class=\"ul-list\">\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">环境准备 =&gt; 安装工具和配置环境，能够 Vibe Coding</span></p>\n</li>\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">技术调研 =&gt; 确认满足生成需求</span></p>\n</li>\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">设计开发 =&gt; 包括方案设计、生成代码、修复 Bug，得到 MVP 最小可行产品</span></p>\n</li>\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">版本控制 =&gt; 防止后续改动出问题</span></p>\n</li>\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">优化能力 =&gt; 支持更多对标 Claude Code 的功能，比如联网搜索、流式输出、深度思考等</span></p>\n</li>\n</ul>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<h2 class=\"md-end-block md-heading\"><span class=\"md-plain\">环境准备</span></h2>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">智谱的 GLM-4.7 兼容多款编码工具，除 Claude Code 外，还支持 Cursor、Cline 等主流编码工具，灵活适配多种开发场景。</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">给 Claude Code 接入 GLM 也很简单，1 分钟搞定。</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">首先打开终端，输入一行命令安装 Claude Code：</span></p>\n<pre class=\"md-fences md-end-block ty-contain-cm modeLoaded\"><span><span class=\"cm-builtin\">npm&nbsp;install&nbsp;<span class=\"cm-attribute\">-g&nbsp;@anthropic-ai/claude-code</span></span></span></pre>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">然后执行 <span class=\"md-pair-s\"><code>claude</code><span class=\"md-plain\"> 命令打开程序，默认是需要登录 Claude 账号的，否则无法使用：</span></span></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">不过没关系，让我们把它背后的 AI 大模型换成国内的 GLM-4.7。首先进入 <span class=\"md-pair-s\"><code>{用户目录}/.claude</code><span class=\"md-plain\"> 目录，创建一个 <span class=\"md-pair-s\"><code>settings.json</code><span class=\"md-plain\"> 配置文件： </span></span></span></span></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">然后修改配置文件中的内容如下，记得替换成你自己的 API Key：</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">API Key 直接到智谱开发平台获取即可：</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">指路：<span class=\"md-link md-pair-s\"><a href=\"https://bigmodel.cn/\" rel=\"noopener nofollow\">https://bigmodel.cn/</a></span></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">接下来就可以愉快地使用了~</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">除了这种方式外，官方文档还提供了更简单的方式，直接使用自动化助手，按照指引就能完成环境配置：</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<h2 class=\"md-end-block md-heading\"><span class=\"md-plain\">技术调研</span></h2>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">如果要完全利用 AI 开发项目，有几个难点：</span></p>\n<ol class=\"ol-list\" start=\"\">\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">项目需要包含完整前后端，需要大模型有较强的 <span class=\"md-pair-s \"><strong>编码能力</strong></span></span></p>\n</li>\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">需要让后端项目对接 AI 大模型，每个大模型的接入和开发方式不同，需要让 AI <span class=\"md-pair-s \"><strong>读取文档</strong><span class=\"md-plain\"> 理解最新的开发方式</span></span></span></p>\n</li>\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">如果想要优化界面效果，还需要 <span class=\"md-pair-s \"><strong>图片理解能力</strong><span class=\"md-plain\">，给 AI 一张图片就能让它还原</span></span></span></p>\n</li>\n</ol>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">在正式开发前，我们要确认 GLM-4.7 和 Claude Code 的配合能够满足这些能力要求。</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">根据智谱官方介绍，Claude Code 中内置了智谱专属的 MCP 工具，不需要开发者自己安装。包括 <span class=\"md-pair-s \"><strong>搜索和网页读取</strong><span class=\"md-plain\"> 能力、能够直接解析截图/设计稿/报错图的 <span class=\"md-pair-s \"><strong>视觉理解能力</strong><span class=\"md-plain\">。</span></span></span></span></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">让我们依次测试一下，首先是网页搜索能力，紧跟时事：</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">测试网页读取能力，让它来读取我们编程导航网站的信息：</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">测试图片理解能力，我给 AI 传了一张 “从夯到拉排行榜的背景图”：</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">AI 的理解还是很准确的，具体文字也读取出来了。</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">OK，几个能力都满足要求，下面让我们进入方案设计和开发阶段。</span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<h2 class=\"md-end-block md-heading\"><span class=\"md-plain\">设计开发</span></h2>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">先创建一个干净的项目目录 <span class=\"md-pair-s\"><code>yupi-code</code><span class=\"md-plain\">，打开终端并进入该目录：</span></span></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">然后输入提示词：</span></p>\n<pre class=\"md-fences md-end-block ty-contain-cm modeLoaded\"><span>帮我开发一个类似 Claude Code 的终端 AI 编程工具，能够使用 GLM-4.7 模型帮用户回答问题和生成代码</span></pre>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">一般来说，整个项目的第一句提示词是最重要的，如果我要开发一个复杂的商业项目，肯定会好好打磨一下这句提示词，少说写个几百字（之前看过我 <span class=\"md-meta-i-c  md-link\"><a href=\"https://mp.weixin.qq.com/s/cd7K9WQiOkP7AJglZ1b1Ng\" rel=\"noopener nofollow\"><span class=\"md-plain\">AI 程序员技术练兵场项目</span></a><span class=\"md-plain\"> 的同学应该知道）。</span></span></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">但测试 AI 模型时，我喜欢反其道而行之，站在大多数用户的角度，故意输入一句简单的提示词，看看 AI 能不能引导我来生成满足需求的项目。</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">果然，AI 判断这是一个复杂的项目，想要进入 <span class=\"md-pair-s \"><strong>计划模式</strong><span class=\"md-plain\"> —— 先明确需求、设计方案再开发。</span></span></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">然后我们需要通过选择来明确需求，并让 AI 生成方案。</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">Claude Code 的交互做的还是不错的，先选择编程语言，建议老老实实选 AI 推荐的第一个：</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">接下来是选择项目要具有的功能。如果是以前，我可能会先让 AI 只开发基础对话功能，跑通流程后再添加其他功能。</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">但现在我对 AI 有了更多的信心，<span class=\"md-pair-s \"><strong>咱就把所有功能全都选上，干就完了！</strong></span></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">其他设置就不多说了：</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">选择完成后，AI 给出了详细的实现计划，一定要仔细阅读：</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">你可以直接执行，或者给 AI 进一步的指导。比如我让 AI 生成的应用去调用智谱 Coding Plan 套餐的 BASE URL，能节约一些成本，并且给 AI 提供了一个官方的 API 文档，便于 AI 生成准确的代码。</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">确认后开始执行，AI 会先调用内置的工具来搜索和解析文档：</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">然后 AI 列出了一个 Todo List，并且一步步生成代码和文档：</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">这期间如果你发现有严重的问题，比如发现 AI 生成的代码已经完全偏离预期了，那么就尽早暂停或者人工输入提示词来引导 AI。如果发现 AI 只是有一小块代码生成的不对，我的建议是先忍着，反正最后 AI 大概率会自己发现问题并修复。</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">过了大概十几分钟后，AI 生成完成，还告诉了我使用方法：</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">可惜我根本懒得看，我直接把 API Key 交给 AI 帮我运行不就好了？</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">Vibe Coding 开发模式下，我多自己做一件事，都是对 AI 的不尊重。</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">输入提示词：</span></p>\n<pre class=\"md-fences md-end-block ty-contain-cm modeLoaded\"><span>我的 API key 是 xxxxxxx，请你帮我运行</span></pre>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">然后，翻车了。。。</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">不慌，直接让 AI 自己检查并修复错误。而且为了使用方便，应该提供一个快速启动脚本，能够让我像运行 Claude Code 一样，一行命令启动 AI 编程工具。</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">提示词：</span></p>\n<pre class=\"md-fences md-end-block ty-contain-cm modeLoaded\"><span>帮我检查并修复项目中的错误，并创建一个可以像 Claude 一样让用户在命令行输入 \"yupicode\" 就能启动程序的快捷脚本</span></pre>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">几分钟后，AI 修复完成，并且提供了一个 <span class=\"md-pair-s\"><code>yupicode</code><span class=\"md-plain\"> 脚本：</span></span></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">我打开一个新的终端，然后运行 <span class=\"md-pair-s\"><code>yupicode</code><span class=\"md-plain\"> 脚本，尝试和 AI 对话：</span></span></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">你别说，效果还不错啊！</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">还像 Claude Code 一样提供了一些命令，比如清空对话历史、查看帮助之类的：</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">看到这里，我感觉项目已经基本可用了。建议给项目上个 Git 来版本控制，防止后面的改动出问题。</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">什么？你不知道 Git 是什么？</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">没关系，直接交给 AI 吧：</span></p>\n<pre class=\"md-fences md-end-block ty-contain-cm modeLoaded\"><span>现在项目已经基本可用了，帮我提交一个 git 版本，防止后续改动出问题</span></pre>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">测试下来，目前的 Yupi Code 还有一些不足之处，比如不支持搜索：</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">接下来就让我们优化项目，增加更多 Claude Code 支持的能力。</span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<h2 class=\"md-end-block md-heading\"><span class=\"md-plain\">优化能力</span></h2>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">1）先来添加网络搜索能力，直接把智谱的官方文档给它丢进去。提示词如下：</span></p>\n<pre class=\"md-fences md-end-block ty-contain-cm modeLoaded\"><span>现在好像不支持网络搜索，请参考<br /><span>https://docs.bigmodel.cn/api-reference/%E5%B7%A5%E5%85%B7-api/%E7%BD%91%E7%BB%9C%E6%90%9C%E7%B4%A2<br /><span>文档，增加网络搜索工具调用能力</span></span></span></pre>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">很快 AI 就添加了新功能，重新打开 yupicode 来验证下，正常生效了：</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">2）下面再优化下 AI 回复的效果，目前是卡一会儿然后直接输出完整回答，需要调整为流式输出的打字机效果。</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">提示词：</span></p>\n<pre class=\"md-fences md-end-block ty-contain-cm modeLoaded\"><span>我希望在等待 AI 回复时，有一个转圈的小图标；并且 AI 的回复可以实时流式输出</span></pre>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">AI 很快就搞定了：</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">3）GLM-4.7 进一步强化了交错式思考能力，引入 <span class=\"md-pair-s \"><strong>保留式思考</strong><span class=\"md-plain\"> 和 <span class=\"md-pair-s \"><strong>轮级思考</strong><span class=\"md-plain\">，让复杂任务执行更稳、更可控。我们也应该让 Yupi Code 输出模型的思考信息、工具调用信息等等，帮助用户了解情况。</span></span></span></span></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">输入提示词：</span></p>\n<pre class=\"md-fences md-end-block ty-contain-cm modeLoaded\"><span>帮我输出模型思考的信息、以及工具调用信息，你可以通过官方文档来了解如何开发</span></pre>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">测试一下优化后的效果，比如 “介绍一下鱼皮的 AI 导航网站”，能很清晰地看到思考过程：</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<h2 class=\"md-end-block md-heading\"><span class=\"md-plain\">大功告成</span></h2>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">到这里，仿照 Claude Code 开发的 Yupi Code 就已经完成了，让我们用它来开发个小网站试试。</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">比如来个动画学算法的 Demo，提示词：</span></p>\n<pre class=\"md-fences md-end-block ty-contain-cm modeLoaded\"><span>帮我开发一个学习冒泡排序算法的动画网站，使用 Q 版动漫的风格和吉伊卡哇感觉的配色</span></pre>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">效果如图，画风还是不错的，但要是之后大模型能自动生成图片插画并添加到网站中，就更好了。</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">再来开发个仿真的电子黑板，提示词：</span></p>\n<pre class=\"md-fences md-end-block ty-contain-cm modeLoaded\"><span>帮我开发一个仿真的电子黑板，用户可以在上面画画并导出为图片</span></pre>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">圣诞节了，鱼皮给大家画颗圣诞树，还附赠一个小礼物，这怎么能不算是程序员的浪漫呢~</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<div class=\"md-hr md-end-block\"><hr /></div>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">OK，这就是我 <span class=\"md-pair-s \"><strong>利用国产的 AI 大模型 GLM-4.7 + Claude Code</strong><span class=\"md-plain\"> 开发出一个 <span class=\"md-pair-s \"><strong>基于 GLM-4.7 的 Yupi Code</strong><span class=\"md-plain\"> 的全过程了。</span></span></span></span></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">我自己体验下来，GLM-4.7 相比于之前的国内大模型，在处理复杂任务的稳定性上有进步，即使遇到问题也会自动修复，让最终生成的代码可运行。</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">而且 GLM-4.7 调用工具的能力也强化了，和 Claude Code 等 AI 编程工具打配合，直接内置了联网搜索、网页读取、解释图片等 AI 编程常用的能力，不需要自己再去找 MCP 来增强了。</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">不得不说，作为一直关注智谱 AI 的忠实开发者，真的很能感受到他们这几个月来在 AI 编程方向的努力，我相信大家也是有目共睹。</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">不过毕竟现在的 Yupi Code 是 AI 一把梭的，还有很多能优化完善的地方。如果后面有时间，大家也感兴趣的话，说不定我会好好打磨打磨这个工具把它开源出来。我的终极目标是，让基于 <span class=\"md-pair-s \"><strong>AI 大模型 GLM-4.7 + Claude Code</strong><span class=\"md-plain\"> 开发的基于 <span class=\"md-pair-s \"><strong>GLM-4.7 的 Yupi Code</strong><span class=\"md-plain\"> 编程工具，能够开发出一个基于 <span class=\"md-pair-s \"><strong>GLM-4.7 的</strong><span class=\"md-plain\"> 编程工具，比如 Yupi Son Code。我认为好的 AI 工具就是要能做到无限套娃，疯狂自举！</span></span></span></span></span></span></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">听懂掌声~</span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<h2 class=\"md-end-block md-heading\"><span class=\"md-plain\">更多编程学习资源</span></h2>\n<ul class=\"ul-list\">\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-meta-i-c  md-link\"><a href=\"https://www.code-nav.cn/course\" rel=\"noopener nofollow\"><span class=\"md-plain\">Java前端程序员必做项目实战教程+毕设网站</span></a></span></p>\n</li>\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-meta-i-c  md-link\"><a href=\"https://www.code-nav.cn/\" rel=\"noopener nofollow\"><span class=\"md-plain\">程序员免费编程学习交流社区（自学必备）</span></a></span></p>\n</li>\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-meta-i-c  md-link\"><a href=\"https://www.code-nav.cn/course/cv\" rel=\"noopener nofollow\"><span class=\"md-plain\">程序员保姆级求职写简历指南（找工作必备）</span></a></span></p>\n</li>\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-meta-i-c  md-link\"><a href=\"https://www.mianshiya.com/\" rel=\"noopener nofollow\"><span class=\"md-plain\">程序员免费面试刷题网站工具（找工作必备）</span></a></span></p>\n</li>\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-meta-i-c  md-link\"><a href=\"https://www.code-nav.cn/post/1640584449888772098\" rel=\"noopener nofollow\"><span class=\"md-plain\">最新Java零基础入门学习路线 + Java教程</span></a></span></p>\n</li>\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-meta-i-c  md-link\"><a href=\"https://www.code-nav.cn/post/1640586673306091521\" rel=\"noopener nofollow\"><span class=\"md-plain\">最新Python零基础入门学习路线 + Python教程</span></a></span></p>\n</li>\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-meta-i-c  md-link\"><a href=\"https://www.code-nav.cn/post/1640586014108303362\" rel=\"noopener nofollow\"><span class=\"md-plain\">最新前端零基础入门学习路线 + 前端教程</span></a></span></p>\n</li>\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-meta-i-c  md-link\"><a href=\"https://www.code-nav.cn/post/1640586867363954689\" rel=\"noopener nofollow\"><span class=\"md-plain\">最新数据结构和算法零基础入门学习路线 + 算法教程</span></a></span></p>\n</li>\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-meta-i-c  md-link\"><a href=\"https://www.code-nav.cn/post/1644279832026075138\" rel=\"noopener nofollow\"><span class=\"md-plain\">最新C++零基础入门学习路线、C++教程</span></a></span></p>\n</li>\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-meta-i-c  md-link\"><a href=\"https://www.code-nav.cn/post/1641797333479903234\" rel=\"noopener nofollow\"><span class=\"md-plain\">最新数据库零基础入门学习路线 + 数据库教程</span></a></span></p>\n</li>\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-meta-i-c  md-link\"><a href=\"https://www.code-nav.cn/post/1640589994284695553\" rel=\"noopener nofollow\"><span class=\"md-plain\">最新Redis零基础入门学习路线 + Redis教程</span></a></span></p>\n</li>\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-meta-i-c  md-link\"><a href=\"https://www.code-nav.cn/post/1641035880439271426\" rel=\"noopener nofollow\"><span class=\"md-plain\">最新计算机基础入门学习路线 + 计算机基础教程</span></a></span></p>\n</li>\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-meta-i-c  md-link\"><a href=\"https://www.code-nav.cn/post/1641366118197153793\" rel=\"noopener nofollow\"><span class=\"md-plain\">最新小程序入门学习路线 + 小程序开发教程</span></a></span></p>\n</li>\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-meta-i-c  md-link\"><a href=\"http://sqlmother.yupi.icu/\" rel=\"noopener nofollow\"><span class=\"md-plain\">最新SQL零基础入门学习路线 + SQL教程</span></a></span></p>\n</li>\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-meta-i-c  md-link\"><a href=\"https://www.code-nav.cn/post/1640586295529324545\" rel=\"noopener nofollow\"><span class=\"md-plain\">最新Linux零基础入门学习路线 + Linux教程</span></a></span></p>\n</li>\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-meta-i-c  md-link\"><a href=\"https://www.code-nav.cn/post/1640588753362108417\" rel=\"noopener nofollow\"><span class=\"md-plain\">最新Git/GitHub零基础入门学习路线 + Git教程</span></a></span></p>\n</li>\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-meta-i-c  md-link\"><a href=\"https://www.code-nav.cn/post/1640587909942099969\" rel=\"noopener nofollow\"><span class=\"md-plain\">最新操作系统零基础入门学习路线 + 操作系统教程</span></a></span></p>\n</li>\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-meta-i-c  md-link\"><a href=\"https://www.code-nav.cn/post/1640588119619551233\" rel=\"noopener nofollow\"><span class=\"md-plain\">最新计算机网络零基础入门学习路线 + 计算机网络教程</span></a></span></p>\n</li>\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-meta-i-c  md-link\"><a href=\"https://www.code-nav.cn/post/1640588392073150465\" rel=\"noopener nofollow\"><span class=\"md-plain\">最新设计模式零基础入门学习路线 + 设计模式教程</span></a></span></p>\n</li>\n<li class=\"md-list-item md-focus-container\">\n<p class=\"md-end-block md-p md-focus\"><span class=\"md-meta-i-c md-link md-expand\"><a href=\"https://www.code-nav.cn/post/1640648711119892481\" rel=\"noopener nofollow\"><span class=\"md-plain\">最新软件工程零基础入门学习路线 + 软件工程教程</span></a></span></p>\n</li>\n</ul>\n</div>\n<div class=\"clear\"></div>\n\n            </div>\n            <div class=\"postDesc\">posted @ \n<span id=\"post-date\">2025-12-25 11:28</span>&nbsp;\n<a href=\"https://www.cnblogs.com/yupi\">程序员鱼皮</a>&nbsp;\n阅读(<span id=\"post_view_count\">98</span>)&nbsp;\n评论(<span id=\"post_comment_count\">1</span>)&nbsp;\n&nbsp;\n<a href=\"\">收藏</a>&nbsp;\n<a href=\"\">举报</a>\n</div>"
    },
    {
      "title": "EvalScope使用过程中的问题汇总",
      "link": "https://www.cnblogs.com/oten/p/19397129",
      "published": "",
      "description": "<h1 class=\"postTitle\">\n                <a class=\"postTitle2 vertical-middle\" href=\"https://www.cnblogs.com/oten/p/19397129\" id=\"cb_post_title_url\" title=\"发布于 2025-12-25 11:23\">\n    <span>EvalScope使用过程中的问题汇总</span>\n    \n\n</a>\n\n            </h1>\n            <div class=\"clear\"></div>\n            <div class=\"postBody\">\n                <div class=\"blogpost-body cnblogs-markdown\" id=\"cnblogs_post_body\">\n<h2 id=\"1-自定义数据集使用时的keyerror问题\">1. 自定义数据集使用时的KeyError问题</h2>\n<h3 id=\"问题描述\">问题描述</h3>\n<p>使用自定义数据集评测时，配置<code>tasks: [\"CustomRetrieval\"]</code>会触发<code>KeyError</code>，报错信息如下：</p>\n<pre><code>KeyError: \"KeyError: 'CustomRetrieval' not found. Did you mean: EcomRetrieval?\"\n</code></pre>\n<h3 id=\"背景说明\">背景说明</h3>\n<ul>\n<li>EvalScope官方文档明确自定义数据集评测任务需指定为<code>CustomRetrieval</code>；</li>\n<li><code>./outputs</code>目录下已存在<code>CustomRetrieval</code>相关数据集；</li>\n<li>个人理解：该报错不影响评测结果生成，仅导致最终评测流程的汇总表格无法输出，整体无核心影响。</li>\n</ul>\n<h3 id=\"相关脚本\">相关脚本</h3>\n<pre><code class=\"language-python\">BASE_TASK_CFG4 = {\n    \"work_dir\": \"./outputs/bge_m3_T2Retrieval_eng\",\n    \"eval_backend\": \"RAGEval\",\n    \"eval_config\": {\n        \"tool\": \"MTEB\",\n        \"model\": [\n            {\n                \"model_name_or_path\": \"/gpu/huangyl3/Embedding_eval/model/bge_m3\",  # 循环时动态赋值\n                \"pooling_mode\": None,\n                \"max_seq_length\": 512,\n                \"prompt\": \"\",\n                \"model_kwargs\": {\"torch_dtype\": \"auto\"},\n                \"encode_kwargs\": {\"batch_size\": 128},\n                \"hub\": \"modelscope\"\n            }\n        ],\n        \"eval\": {\n            \"tasks\": [\"CustomRetrieval\"],\n            \"dataset_path\": \"/gpu/huangyl3/Embedding_eval/datas/T2Retrieval_eng/retrieval_data\",\n            \"verbosity\": 2,\n            \"overwrite_results\": True,\n            \"top_k\": 5\n        },\n    },\n}\n\nif __name__ == \"__main__\":\n    run_task(task_cfg=BASE_TASK_CFG4)\n</code></pre>\n<h2 id=\"2-两阶段测试脚本检索重排\">2. 两阶段测试脚本（检索+重排）</h2>\n<h3 id=\"相关脚本-1\">相关脚本</h3>\n<pre><code class=\"language-python\">from evalscope.run import run_task\ntwo_stage_task_cfg = {\n    \"work_dir\": \"./outputs/bge-reranker-v2-m3_T2Retrieval\",\n    \"eval_backend\": \"RAGEval\",\n    \"eval_config\": {\n        \"tool\": \"MTEB\",\n        \"model\": [\n            {\n                \"model_name_or_path\": \"/gpu/huangyl3/Embedding_eval/model/bge_m3\",\n                \"is_cross_encoder\": False,\n                \"max_seq_length\": 512,\n                \"model_kwargs\": {\"torch_dtype\": \"auto\"},\n                \"encode_kwargs\": {\n                    \"batch_size\": 64,\n                },\n            },\n            {\n                \"model_name_or_path\": \"/gpu/huangyl3/Embedding_eval/model/bge-reranker-v2-m3\",\n                \"is_cross_encoder\": True,\n                \"max_seq_length\": 512,\n                \"prompt\": \"为这个问题生成一个检索用的表示\",\n                \"model_kwargs\": {\"torch_dtype\": \"auto\"},\n                \"encode_kwargs\": {\n                    \"batch_size\": 32,\n                },\n            },\n        ],\n        \"eval\": {\n            \"tasks\": [\"T2Retrieval\"],\n            \"verbosity\": 2,\n            \"overwrite_results\": True,\n            \"top_k\": 5\n        },\n    },\n}\nrun_task(task_cfg=two_stage_task_cfg)\n</code></pre>\n<h2 id=\"3-model_kwargs中torch_dtype报错问题\">3. model_kwargs中torch_dtype报错问题</h2>\n<h3 id=\"问题描述-1\">问题描述</h3>\n<p>评测<code>gte-multilingual-mlm-base</code>、<code>Qwen3-Embedding-0.6B</code>、<code>bge-m3</code>模型（非检索数据集评测任务）时，原配置<code>\"model_kwargs\": {\"torch_dtype\": \"auto\"}</code>会触发报错；<br />\n临时解决方案：将<code>torch_dtype: auto</code>硬改为<code>dtype: float</code>可规避报错，但并非最优方案。</p>\n<h2 id=\"4-批量评测脚本的执行报错问题\">4. 批量评测脚本的执行报错问题</h2>\n<h3 id=\"问题描述-2\">问题描述</h3>\n<p>批量循环评测多个模型时，第一个模型可正常执行，后续模型会触发报错；仅改为枚举式写法可正常批量运行，报错原因暂未明确，需指导。</p>\n<h3 id=\"相关脚本-2\">相关脚本</h3>\n<pre><code class=\"language-python\">import time\nimport datetime\nfrom evalscope.run import run_task\n\n# ===================== 配置核心参数 =====================\n# 定义需要批量评测的模型列表（替换为你要测的模型名）\nMODEL_LIST = [\n    \"iic/gte-multilingual-mlm-base\",  # BGE系列示例\n    \"Qwen/Qwen3-Embedding-0.6B\",  # 多语言嵌入模型示例\n    \"BAAI/bge-m3\"  # GTE-large示例\n]\n\n\n# 基础配置模板（不包含model_name_or_path，循环时动态填充）\nBASE_TASK_CFG = {\n    \"work_dir\": \"/Users/hyl/PyCharmMiscProject/GAi/Embedding_eval/outputs\",\n    \"eval_backend\": \"RAGEval\",\n    \"eval_config\": {\n        \"tool\": \"MTEB\",\n        \"model\": [\n            {\n                \"model_name_or_path\": \"\",  # 循环时动态赋值\n                \"pooling_mode\": None,\n                \"max_seq_length\": 512,\n                \"prompt\": \"\",\n                \"model_kwargs\": {\"torch_dtype\": \"auto\"},\n                \"encode_kwargs\": {\"batch_size\": 128},\n                \"hub\": \"modelscope\"\n            }\n        ],\n        \"eval\": {\n            \"tasks\": [\"T2Retrieval\"],\n            \"verbosity\": 2,\n            \"overwrite_results\": True,\n            \"top_k\": 5,\n            \"hub\": \"modelscope\"\n        },\n    },\n}\n\n# ===================== 核心逻辑：循环评测 + 晚上自动执行 =====================\ndef run_batch_evaluation():\n    # 遍历模型列表，逐个执行评测\n    for idx, model_name in enumerate(MODEL_LIST):\n        try:\n            # 复制基础配置，避免修改原字典\n            task_cfg = BASE_TASK_CFG.copy()\n            # 动态替换模型名\n            task_cfg[\"eval_config\"][\"model\"][0][\"model_name_or_path\"] = model_name\n\n            # 打印当前评测进度\n            current_time = datetime.datetime.now().strftime(\"%Y-%m-%d %H:%M:%S\")\n            print(f\"\\n===== 开始评测第 {idx + 1}/{len(MODEL_LIST)} 个模型 =====\")\n            print(f\"批次时间：{current_time}\")\n            print(f\"模型名：{model_name}\")\n\n            # 记录评测开始时间（精确到毫秒）\n            start_time = datetime.datetime.now()\n            print(f\"评测开始时间：{start_time.strftime('%Y-%m-%d %H:%M:%S.%f')[:-3]}\")  # 保留毫秒\n            print(\"===========================\\n\")\n\n            # 执行评测任务\n            run_task(task_cfg=task_cfg)\n\n            # 记录评测结束时间，计算总耗时\n            end_time = datetime.datetime.now()\n            duration = end_time - start_time\n            # 转换耗时为 时:分:秒 格式（总秒数转时分秒）\n            hours = duration.seconds // 3600\n            minutes = (duration.seconds % 3600) // 60\n            seconds = duration.seconds % 60\n            # 保留毫秒的耗时字符串\n            duration_str = f\"{hours}小时{minutes}分钟{seconds}秒（总耗时：{duration.total_seconds():.2f}秒）\"\n\n            # 打印完成提示 + 时间统计\n            print(f\"\\n===== 模型 {model_name} 评测完成 =====\")\n            print(f\"评测结束时间：{end_time.strftime('%Y-%m-%d %H:%M:%S.%f')[:-3]}\")\n            print(f\"本次评测总耗时：{duration_str}\")\n            print(\"===========================\\n\")\n\n            # 可选：模型间间隔（避免频繁请求，比如休息5分钟）\n            time.sleep(300)\n\n        except Exception as e:\n            # 单个模型评测失败，记录错误并继续下一个\n            end_time = datetime.datetime.now()\n            print(f\"\\n===== 模型 {model_name} 评测失败 =====\")\n            print(f\"失败时间：{end_time.strftime('%Y-%m-%d %H:%M:%S.%f')[:-3]}\")\n            print(f\"错误信息：{str(e)}\")\n            print(\"继续评测下一个模型...\\n\")\n            continue\n\n# ===================== 启动批量评测 =====================\nif __name__ == \"__main__\":\n    run_batch_evaluation()\n</code></pre>\n<h3 id=\"备注\">备注</h3>\n<p>持续更新.......</p>\n\n</div>\n<div class=\"clear\"></div>\n\n            </div>\n            <div class=\"postDesc\">posted @ \n<span id=\"post-date\">2025-12-25 11:23</span>&nbsp;\n<a href=\"https://www.cnblogs.com/oten\">Oten</a>&nbsp;\n阅读(<span id=\"post_view_count\">15</span>)&nbsp;\n评论(<span id=\"post_comment_count\">0</span>)&nbsp;\n&nbsp;\n<a href=\"\">收藏</a>&nbsp;\n<a href=\"\">举报</a>\n</div>"
    },
    {
      "title": "MySQL 数据库日志总结(一)",
      "link": "https://www.cnblogs.com/zhangwencheng/p/19388036",
      "published": "",
      "description": "<h1 class=\"postTitle\">\n                <a class=\"postTitle2 vertical-middle\" href=\"https://www.cnblogs.com/zhangwencheng/p/19388036\" id=\"cb_post_title_url\" title=\"发布于 2025-12-25 10:24\">\n    <span>MySQL 数据库日志总结(一)</span>\n    \n\n</a>\n\n            </h1>\n            <div class=\"clear\"></div>\n            <div class=\"postBody\">\n                <div class=\"blogpost-body cnblogs-markdown\" id=\"cnblogs_post_body\">\n<h3 id=\"数据库服务日志概述介绍\">数据库服务日志概述介绍</h3>\n<p>任何一种数据库中，都会有各种各样的日志，记录这数据库工作的方方面面，以帮助数据库管理员追踪数据库曾经发生过的各种事件；</p>\n<p>主要是针对数据库server层产生的数据信息，主要用于记录和数据库服务运行本身有关的日志、以及SQL语句操作执行相关的日志；</p>\n<h3 id=\"据库服务日志常用分类\">据库服务日志常用分类</h3>\n<p>在MySQL数据库服务中，有4种不同的日志是最常用的日志类型，这些日志记录这数据库在不同方面的踪迹；</p>\n<p>日志信息查看方法：</p>\n<pre><code class=\"language-sql\">mysql&gt; show variables like '%log%';\n+------------------------------------------------+---------------------------------------------+\n| Variable_name                                  | Value                                       |\n+------------------------------------------------+---------------------------------------------+\n| general_log                                    | OFF                                         |\n| general_log_file                               | /data/3306/data/wenC-01.log                 |\n| log_error                                      | ./wenC-01.err                               |\n| log_bin                                        | ON                                          |\n| log_bin_basename                               | /data/3306/data/binlog                      |\n| log_bin_index                                  | /data/3306/data/binlog.index                |\n| slow_query_log                                 | OFF                                         |\n| slow_query_log_file                            | /data/3306/data/wenC-01-slow.log            |\n+------------------------------------------------+---------------------------------------------+\n</code></pre>\n<p>常用日志信息介绍：</p>\n<table>\n<thead>\n<tr>\n<th>序号</th>\n<th>日志名称</th>\n<th>解释说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>01</td>\n<td>general_log</td>\n<td>表示查询日志（通用日志），默认日志状态处于关闭，可以进行在线调整配置<br />作用：记录了客户端从会话连接开始，执行过的所有SQL语句信息；</td>\n</tr>\n<tr>\n<td>02</td>\n<td>log_error</td>\n<td>表示错误日志（运行日志），默认日志状态处于激活<br />作用：记录了数据库服务启动和停止时，以及服务器在运行过程中发生任何严重错误时的相关信息；</td>\n</tr>\n<tr>\n<td>03</td>\n<td>log_bin</td>\n<td>表示二进制日志（binlog日志），默认日志状态处于激活（8.0之后）<br />作用：记录了所有的DDL语句和DML语句，但是不包括数据库查询语句；语句以事件的形式保存，描述了数据的更改过程，此日志对于灾难时的数据恢复起着极其重要的作用。</td>\n</tr>\n<tr>\n<td>04</td>\n<td>slow_query_log</td>\n<td>表示慢查询日志，记录了所有执行时间超过参数long_query_time设置值并且扫描记录数小于min_examined_row_limit的所有SQL语句的日志。</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"数据库服务日志信息配置\">数据库服务日志信息配置</h3>\n<h4 id=\"1分类日志信息配置通用日志general_log\"><strong>1.分类日志信息配置：通用日志（general_log）</strong></h4>\n<ul>\n<li><strong>1_1 日志信息基本配置：</strong></li>\n</ul>\n<pre><code class=\"language-sql\">general_log=OFF          \n-- 默认日志功能处于关闭，建议在需要做调试工作时（功能测试、语句审计）可以打开；\ngeneral_log_file=/data/3306/data/wenC-01.log  \n-- 定义日志文件存储的路径信息，建议日志文件路径与数据存放路径进行分离；\n\n# 修改日志默认状态（激活日志）：\nmysql &gt; set global general_log=1;\n</code></pre>\n<blockquote>\n<p>说明：企业真实环境，由于日志记录量比较大，所以不建议打开此日志记录功能，可以在有需要时打开，支持在线配置调整；</p>\n</blockquote>\n<h4 id=\"2分类日志信息配置错误日志log_error\"><strong>2.分类日志信息配置：错误日志（log_error）</strong></h4>\n<ul>\n<li><strong>2_1 日志信息基本配置</strong></li>\n</ul>\n<pre><code class=\"language-sql\">log_error=./wenC-01.err      \n-- 定义日志文件存储的路径信息，建议日志文件路径与数据存放路径进行分离；\n\n# 修改日志存储路径（永久配置）：\n[root@cheng ~]# vim /etc/my.cnf\nlog_error=/data/3306/log/wenC-01.err\n-- 配置文件编写完毕后，需要重启数据库服务生效\n\n# 模拟故障日志应用\n[root@cheng ~]# ll /data/3306/data/ibdata1 \n-rw-r----- 1 mysql mysql 12582912 Nov 16 17:46 /data/3306/data/ibdata1\n[root@cheng ~]# chmod 000 /data/3306/data/ibdata1\n[root@cheng ~]# /etc/init.d/mysqld restart\nShutting down MySQL............................... SUCCESS! \nStarting MySQL......................................... ERROR! The server quit without updating PID file (/data/3306/data/wenC-01.pid).\n[root@cheng ~]# tail -20 /data/3306/log/wenC-01.err\n2022-11-21T01:20:47.735040Z 1 [ERROR] [MY-012271] [InnoDB] The innodb_system data file 'ibdata1' must be writable\n2022-11-21T01:20:47.744091Z 1 [ERROR] [MY-012278] [InnoDB] The innodb_system data file 'ibdata1' must be writable\n2022-11-21T01:20:47.744808Z 1 [ERROR] [MY-010334] [Server] Failed to initialize DD Storage Engine\n2022-11-21T01:20:47.745739Z 0 [ERROR] [MY-010020] [Server] Data Dictionary initialization failed.\n2022-11-21T01:20:47.746526Z 0 [ERROR] [MY-010119] [Server] Aborting\n-- 根据错误日志的错误提示信息，进行错误信息进行分析，从而排查故障可能出现的原因；\n</code></pre>\n<blockquote>\n<p>说明：企业真实环境，日志处于默认激活记录状态，可以使用错误日志信息做故障诊断，记录错误信息级别为note warning error；</p>\n</blockquote>\n<h4 id=\"3分类日志信息配置二进制日志log_bin\"><strong>3.分类日志信息配置：二进制日志（log_bin）</strong></h4>\n<p>在进行增量恢复数据时，需要先了解什么是binlog日志，此日志文件其实就是用于记录对数据库进行操作更改的语句信息的；</p>\n<p>并且记录更改的语句信息以事件形式进行记录，但是需要注意的是查询相关的语句是不会被记录的，比如：select、show；</p>\n<p>然而作为所有对数据库的改操作事件信息都会被记录，比如：insert、update、create、drop。。。</p>\n<p><strong>查看数据库binlog日志配置参数：</strong></p>\n<p>进入到数据库服务系统环境中，可以使用命令进行查看binlog日志功能是否开启；</p>\n<pre><code class=\"language-sql\"># 未开启binlog日志功能时，查看系统binlog功能配置参数状态\nmysql&gt; show variables like '%log_bin%';\n+-----------------------------------------+-------+\n| Variable_name                           | Value |\n+-----------------------------------------+-------+\n| log_bin                                 | OFF   |\n| sql_log_bin                             | ON    |\n+-----------------------------------------+-------+\n3 rows in set (0.00 sec)\n--- 通过以上输出信息可以看到log_bin为off状态，表示binlog日志功能尚未开启\n\n# 已开启binlog日志功能后，查看系统binlog功能配置参数状态\nmysql&gt; show variables like '%log_bin%';\n+-----------------------------------------+-------+\n| Variable_name                           | Value |\n+-----------------------------------------+-------+\n| log_bin                                 | ON    |\n| sql_log_bin                             | ON    |\n+-----------------------------------------+-------+\n3 rows in set (0.00 sec)\n--- 通过以上输出信息可以看到log_bin为on状态，表示binlog日志功能已经开启\n</code></pre>\n<ul>\n<li><strong>3_1 日志信息基本配置</strong></li>\n</ul>\n<pre><code class=\"language-sql\">server_id=6\n-- 进行主从操作时，需要进行此信息配置；\nlog_bin=ON      \n-- 默认日志功能处于关闭状态\nlog_bin_basename=/data/3306/data/binlog        \n-- 定义日志文件存储的路径信息，建议日志文件路径与数据存放路径进行分离；\n\n# 配置信息简写方式：开启数据库binlog日志记录功能\n[root@cheng ~]# vim /etc/my.cnf\n-- 激活binlog日志记录功能，需要对数据库服务配置文件进行编辑修改\n[mysqld]\nserver_id=6\nlog_bin=/data/3306/binlog/mysql-bin\n-- 进行binlog日志目录路径信息修改时，需要创建指定的目录并设置权限信息，最后需要重新启动数据库服务生效；\n或者\nlog_bin=binlog\n-- 只是设置日志名称信息，日志会自动保存到数据库服务指定的数据目录中；\n\n# 配置文件修改后需要重启数据库服务，加载配置文件改动的信息：\n[root@cheng ~]# /etc/init.d/mysqld restart \n[root@cheng ~]# ll -h /data/3306/data/binlog*\n-rw-rw----. 1 mysql mysql 245 6月  24 02:19 /data/3306/data/binlog.00000N\n-rw-rw----. 1 mysql mysql   16 6月  24 02:19 /data/3306/data/binlog.index\n-- 数据库服务重启后，已经可以在数据库的数据存储目录中，看到binlog日志文件的踪影\n</code></pre>\n<blockquote>\n<p>说明：企业真实环境，日志处于默认激活记录状态，可以使用日志信息进行灾难数据恢复，以及可以用于实现主从复制；</p>\n</blockquote>\n<ul>\n<li><strong>3_2 日志配置信息扩展</strong><br />\n参数官方资料链接：<a href=\"https://dev.mysql.com/doc/refman/8.0/en/replication-options-binary-log.html\" rel=\"noopener nofollow\" target=\"_blank\">https://dev.mysql.com/doc/refman/8.0/en/replication-options-binary-log.html</a></li>\n</ul>\n<pre><code class=\"language-sql\"># 参数一：sync_binlog 表示刷新日志到磁盘策略\nmysql&gt; select @@sync_binlog;\n+---------------------+\n| @@sync_binlog       |\n+---------------------+\n|                   1 |\n+---------------------+\n1 row in set (0.00 sec)\n-- 在进行主从同步过程的双一标准的其中一个1的信息配置，主要是控制缓冲区里的binlog日志信息如何刷写到磁盘中；\n-- 此参数信息是有三种方式进行配置的：\n-- 参数信息配置0：表示由操作系统缓存自己决定，什么时候刷新日志到磁盘中；\n-- 参数信息配置1：表示每次事务提交，立即刷新日志到磁盘中；(此方式配置更安全)\n-- 参数信息配置N：表示每组事务提交，按照组的事务次数定义，确定刷新日志到磁盘中的频次；（可以有效减少IO性能损耗）\n\n# 参数二：binlog_format 定义binlog日志的格式信息\nmysql&gt; select @@binlog_format;\n+------------------------+\n| @@binlog_format        |\n+------------------------+\n| ROW                    |\n+------------------------+\n1 row in set (0.00 sec)\n-- 在进行主从同步数据恢复时，此参数配置可能会影响数据恢复的一致性问题；\n-- 此参数信息是有三种方式进行配置的，确定了主从复制的级别，只针对DML语句的日志才有效；\n-- 参数信息配置 statement（SBR）：语句格式记录binlog；\ncreate database wenC;  -- DDL DCL语句只能使用statement 表示的就是原原本本的语句信息，即做什么就记录什么；\n-- 参数信息配置 row（RBR）：行格式记录binlog（默认模式）\nupdate t1 set a=10 where id&lt;10;    -- 会记录行的变化信息，属于底层的记录信息，可能会有多个变化日志信息记录\n-- 参数信息配置 mixed（MBR）：混合格式记录binlog\n    -- 由数据库服务自行决定，是记录语句信息，还是记录行的变化信息；\n</code></pre>\n<p>SBR（statement-based replication）与RBR（Row-Based Replication）记录的优缺点分析：（面试常见问题）</p>\n<table>\n<thead>\n<tr>\n<th>记录方式</th>\n<th>优点说明</th>\n<th>缺点说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>SBR</td>\n<td>可读性强，日志量相对较少；</td>\n<td>数据信息可能不准确，数据一致性不足</td>\n</tr>\n<tr>\n<td>RBR</td>\n<td>数据信息记录更准确，数据一致性更强</td>\n<td>可读性弱，日志量相对较多，数据记录准确</td>\n</tr>\n<tr>\n<td>举例说明</td>\n<td>update t1 set a=10 where id&lt;10000;  记录一条语句即可</td>\n<td>insert into 随机数函数;</td>\n</tr>\n<tr>\n<td>举例说明</td>\n<td>update t1 set a=10 where id&lt;10000;  记录多条语句修改信息，生成日志</td>\n<td>insert into 随机数函数;</td>\n</tr>\n</tbody>\n</table>\n<ul>\n<li><strong>3_3 日志信息查看方法：</strong></li>\n</ul>\n<p>可以通过查看方式，获取binlog日志里的数据信息，一般在数据库启动时，日志记录功能就开启了；</p>\n<p>可以利用日志中记录信息，将数据库服务的数据信息恢复到指定的时间点，同时也可以支持主从数据复制（在其它机器上回放日志）；</p>\n<p><code>对于binlog日志信息的查看，主要目的是为了日后日志事件信息的截取操作；</code></p>\n<p>查看方式一：确认数据库binlog日志数量</p>\n<pre><code class=\"language-sql\">mysql&gt; show binary logs;\n+------------------+-------------+--------------+\n| Log_name         | File_size   | Encrypted    |\n+------------------+-------------+--------------+\n| binlog.000001    |         156 | No           |\n+------------------+-------------+--------------+\n-- 获取数据库服务运行过程中，使用的binlog日志的情况\n\nmysql&gt; flush logs;\nQuery OK, 0 rows affected (0.12 sec)\n-- 可以执行flush刷新命令，从而生成新的binlog日志文件，类似于实现了日志切割功能；\nmysql&gt; show binary logs;\n+------------------+-------------+--------------+\n| Log_name         | File_size   | Encrypted    |\n+------------------+-------------+--------------+\n| binlog.000001    | 200         | No           |\n| binlog.000002    | 156         | No           |\n+------------------+-------------+--------------+\n2 rows in set (0.00 sec)\n</code></pre>\n<p>查看方式二：确认数据库binlog日志状态</p>\n<pre><code class=\"language-sql\">mysql&gt; create database test_binlog;\nQuery OK, 1 row affected (0.03 sec)\n-- 模拟数据服务有修改操作\nmysql&gt; select * from world.city limit 1;\nQuery OK, 1 row affected (0.03 sec)\n-- 模拟数据服务有修改操作\nmysql&gt; show binary logs;\n+------------------+-------------+--------------+\n| Log_name         | File_size   | Encrypted    |\n+------------------+-------------+--------------+\n| binlog.000001    |  200        | No           |\n| binlog.000002    |  362        | No           |\n+------------------+-------------+--------------+\n2 rows in set (0.00 sec)\n-- 可以看到binlog日志的存储量发生了变化，但是在做查询操作时，binlog日志的存储量并未发生变化\n\nmysql&gt; show master status;\n+------------------+------------+------------------+-----------------------+-------------------------+\n| File             | Position   | Binlog_Do_DB     | Binlog_Ignore_DB      | Executed_Gtid_Set       |\n+------------------+------------+------------------+-----------------------+-------------------------+\n| binlog.000002    |  362       |                  |                       |                         |\n+------------------+------------+------------------+-----------------------+-------------------------+\n1 row in set (0.00 sec)\n-- 查看获取当前使用的binlog日志情况，以及产生的日志量字节大小；\n</code></pre>\n<p>查看方式三：查看数据库binlog日志信息</p>\n<pre><code class=\"language-sql\">mysql&gt; show binlog events in 'binlog.000002';\n-- binlog日志信息是以事件方式进行记录的，所以日志查看过程是查看事件信息\n-- 一般binlog日志的前两行，表示日志格式头信息（日志简单的描述信息）\n-- 一般binlog日志中的query信息，就是对数据库的操作语句，其中包含了创建数据库的语句；\n</code></pre>\n<p>具体binlog事件信息：<br />\n<img alt=\"1669004768083\" src=\"https://img2024.cnblogs.com/blog/1080590/202512/1080590-20251223170443956-396789651.png\" /></p>\n<p>具体binlog事件记录信息分析：</p>\n<table>\n<thead>\n<tr>\n<th>列号</th>\n<th>列信息</th>\n<th>解释说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>01</td>\n<td>Log_name</td>\n<td>表示指定查看的binlog日志文件名称信息</td>\n</tr>\n<tr>\n<td>02</td>\n<td>Pos</td>\n<td>表示binlog日志事件开始的位置点，用于截取二进制日志信息标识</td>\n</tr>\n<tr>\n<td>05</td>\n<td>End_log_pos</td>\n<td>表示binlog日志事件结束的位置点，用于截取二进制日志信息标识</td>\n</tr>\n<tr>\n<td>06</td>\n<td>Info</td>\n<td>表示binlog中具体的事件内容信息</td>\n</tr>\n</tbody>\n</table>\n<p>查看方式四：筛选数据库binlog日志事件</p>\n<pre><code class=\"language-sql\"># 模拟生成binlog日志事件信息\nmysql&gt; source ~/world.sql;\nmysql&gt; drop database world;\nmysql&gt; source ~/world.sql;\n\n# 获取删除数据库的事件信息：\n# 筛选数据库日志方式一：\n[root@cheng data]# mysql -e \"show binlog events in 'binlog.000002'\"|grep \"drop database\"\nbinlog.000002\t722789\tQuery\t1\t722896\tdrop database world /* xid=5363 */\n-- 获取指定事件信息产生的起点位置和终点位置信息；\n\n# 筛选数据库日志方式二：\nmysql&gt; pager less\n-- 在数据库中定义pager功能，数据库连接会话退出即失效；\nmysql&gt; show binlog events in 'binlog.000002';\n-- 此时查看日志事件信息具有了翻页功能\n/drop database\n| binlog.000002 |  722789 | Query          |         1 |      722896 | drop database world /* xid=5363 */\nmysql&gt; pager grep \"drop database\"\nPAGER set to 'grep \"drop database\"'\n-- 表示开启数据库pager的过滤功能\nmysql&gt; show binlog events in 'binlog.000002';\n| binlog.000002 |  722789 | Query          |         1 |      722896 | drop database world /* xid=5363 */ \n-- 再次查看binlog事件信息时，只过滤显示删除数据库的操作事件日志\n</code></pre>\n<blockquote>\n<p>说明：在实际生产环境中，若binlog日志量比较大时，需要快速过滤关键日志事件行，可以使用以上查看日志方法；</p>\n</blockquote>\n<p><strong>获取数据库binlog日志记录信息异常：</strong></p>\n<p>进行数据库服务数据信息更改操作，随后查看binlog日志信息的变化：</p>\n<pre><code class=\"language-sql\"># 进行数据库创建操作\nmysql&gt; create database wenC;\nmysql&gt; show databases;\n\n# 查看获取binlog日志记录信息\n[root@cheng ~]# mysqlbinlog /var/lib/mysql/binlog.000001 \nmysqlbinlog: unknown variable 'default-character-set=utf8mb4'\n-- 由于在数据库在客户端配置文件中添加了default-character-set=utf8mb4字符编码信息，因此造成无法查看binlog\n[root@cheng ~]# cat /etc/my.cnf.d/client.cnf \n[client]\n#default-character-set=utf8mb4\n[client-mariadb]\n#default-character-set=utf8mb4\n-- 可以临时调整先将客户端的字符编码配置信息注释，\n[root@cheng ~]# mysqlbinlog /var/lib/mysql/binlog.000001\n... 省略部分信息 ...\n# at 494\n#220624  2:35:02 server id 1  end_log_pos 579 Query\tthread_id=2\texec_time=0\terror_code=0\nSET TIMESTAMP=1656009302/*!*/;\ncreate database wenC\n/*!*/;\n... 省略部分信息 ...\n-- 在binlog日志文件中，已经记录了之前的创建xiaoQ的更改操作记录信息\n</code></pre>\n<ul>\n<li><strong>3_4 日志信息应用实战</strong></li>\n</ul>\n<p><strong>数据库数据异常恢复（简单情况）</strong></p>\n<p>在实际生成环境中，可以利用binlog日志记录的信息截取，实现数据库异常情况下的数据信息恢复功能；</p>\n<p>数据库异常恢复情况环境准备：</p>\n<pre><code class=\"language-sql\"># 切换新的binlog日志文件做模拟数据恢复\nmysql&gt; flush logs;\nQuery OK, 0 rows affected (0.03 sec)\nmysql&gt; show master status;\n+------------------+------------+------------------+-----------------------+-------------------------+\n| File             | Position   | Binlog_Do_DB     | Binlog_Ignore_DB      | Executed_Gtid_Set       |\n+------------------+------------+------------------+-----------------------+-------------------------+\n| binlog.000003    |  156       |                  |                       |                         |\n+------------------+------------+------------------+-----------------------+-------------------------+\n1 row in set (0.01 sec)\n-- 确认已经刷新生成了新的binlog日志文件；\n\n# 进行基本的数据库SQL语句操作：\nmysql&gt; create database bindb;\nmysql&gt; use bindb;\nmysql&gt; create table t1 (id int);\nmysql&gt; begin;\nmysql&gt; insert into t1 values(1);\n-- 在没有进行事务提交前，操作的事务事件信息，是不会出现在binlog事件日志中的\nmysql&gt; commit;\n-- 对于数据库的binlog日志，只会记录事务已经提交的DML语句信息，没有提交的DML语句是不会进行记录的；\n-- 在日志中变化的DML语句信息是无法识别的，因为记录DML操作的语句默认是以ROW模式记录的；\n</code></pre>\n<p>数据库二进制日志信息查看方法：</p>\n<pre><code class=\"language-sql\">[root@cheng ~]# mysqlbinlog /data/3306/data/binlog.000003\n-- 对于数据库binlog日志信息，是无法直接查看内容信息，需要利用相关命令工具进行查看\n# The proper term is pseudo_replica_mode, but we use this compatibility alias\n# to make the statement usable on server versions 8.0.24 and older.\n/*!50530 SET @@SESSION.PSEUDO_SLAVE_MODE=1*/;\n/*!50003 SET @OLD_COMPLETION_TYPE=@@COMPLETION_TYPE,COMPLETION_TYPE=0*/;\nDELIMITER /*!*/;\n# at 4\n#221121 13:12:59 server id 1  end_log_pos 125 CRC32 0xbb7d1fd1 \tStart: binlog v 4, server v 8.0.26 created 221121 13:12:59\n# Warning: this binlog is either in use or was not closed properly.\nBINLOG '\n2wh7Yw8BAAAAeQAAAH0AAAABAAQAOC4wLjI2AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\nAAAAAAAAAAAAAAAAAAAAAAAAEwANAAgAAAAABAAEAAAAYQAEGggAAAAICAgCAAAACgoKKioAEjQA\nCigB0R99uw==\n'/*!*/;\n# at 125\n#221121 13:12:59 server id 1  end_log_pos 156 CRC32 0x04874c92 \tPrevious-GTIDs\n# [empty]\n-- binlog日志文件156之前的内容是可以忽略的，表示是日志文件的头格式内容信息\n# at 156\n#221121 13:16:19 server id 1  end_log_pos 233 CRC32 0xd73c14e1 \tAnonymous_GTID\tlast_committed=0\tsequence_number=1\trbr_only=no\toriginal_committed_timestamp=1669007779100380\timmediate_commit_timestamp=1669007779100380\ttransaction_length=188\n# original_commit_timestamp=1669007779100380 (2022-11-21 13:16:19.100380 HKT)\n# immediate_commit_timestamp=1669007779100380 (2022-11-21 13:16:19.100380 HKT)\n/*!80001 SET @@session.original_commit_timestamp=1669007779100380*//*!*/;\n/*!80014 SET @@session.original_server_version=80026*//*!*/;\n/*!80014 SET @@session.immediate_server_version=80026*//*!*/;\nSET @@SESSION.GTID_NEXT= 'ANONYMOUS'/*!*/;\n-- binlog日志文件已事件形式进行记录，主要关注两个at内容之间的信息，即表示的是一个事件信息；\n# at 233\n-- binlog日志中一个事件的开始，就表示上一个事件的结束，在binlog中记录的事件日志信息是连续的；\n#221121 13:16:19 server id 1  end_log_pos 344 CRC32 0x624986f5 \tQuery\tthread_id=11\texec_time=0\terror_code=0\tXid = 10728\nSET TIMESTAMP=1669007779/*!*/;\nSET @@session.pseudo_thread_id=11/*!*/;\nSET @@session.foreign_key_checks=1, @@session.sql_auto_is_null=0, @@session.unique_checks=1, @@session.autocommit=1/*!*/;\nSET @@session.sql_mode=1168113696/*!*/;\nSET @@session.auto_increment_increment=1, @@session.auto_increment_offset=1/*!*/;\n/*!\\C utf8mb4 *//*!*/;\nSET @@session.character_set_client=255,@@session.collation_connection=255,@@session.collation_server=255/*!*/;\nSET @@session.lc_time_names=0/*!*/;\nSET @@session.collation_database=DEFAULT/*!*/;\n/*!80011 SET @@session.default_collation_for_utf8mb4=255*//*!*/;\n/*!80016 SET @@session.default_table_encryption=0*//*!*/;\ncreate database bindb\n/*!*/;\n# at 344\n</code></pre>\n<p>binlog日志内容中主要关注的信息：</p>\n<ul>\n<li><strong>通过日志信息查看DDL操作语句信息（记录方式 SBR）</strong></li>\n</ul>\n<p><img alt=\"1669015300339\" src=\"https://img2024.cnblogs.com/blog/1080590/202512/1080590-20251223170554930-296167952.png\" /></p>\n<ul>\n<li><strong>通过日志信息查看DML操作语句信息（记录方式 RBR）</strong></li>\n</ul>\n<p><img alt=\"1669015788023\" src=\"https://img2024.cnblogs.com/blog/1080590/202512/1080590-20251223170614385-150887390.png\" /></p>\n<p>以上ROW模式记录的信息是加密显示，无法直接查看的，可以使用下面命令参数进行获取详细信息：</p>\n<pre><code class=\"language-sql\">[root@cheng ~]# mysqlbinlog --base64-output=decode-rows -vvv /data/3306/data/binlog.000003 \n-- 以上添加的参数信息，表示将DML的ROW格式语句信息，进行格式化处理输出；\n# at 739\n#221121 13:17:45 server id 1  end_log_pos 779 CRC32 0xb468b459 \tWrite_rows: table id 101 flags: STMT_END_F\n### INSERT INTO `bindb`.`t1`\n-- 利用DML语句做的插入语句信息就显示出来了\n### SET\n###   @1=1 /* INT meta=0 nullable=1 is_null=0 */\n-- 以上日志记录的信息，可以用命令实现，如下：\nmysql &gt; insert into t1 set id=1;\n等价于\nmysql &gt; insert into t1 values(1);\n</code></pre>\n<p>数据库模拟异常情况破坏操作：</p>\n<pre><code class=\"language-sql\">mysql&gt; drop database bindb;\n-- 模拟破坏性操作，删除数据库\n</code></pre>\n<p>数据库异常情况数据恢复操作：</p>\n<pre><code class=\"language-sql\"># 需要恢复建库开始，删除之前的所有操作（即所有binlog日志信息），实现日志信息的截取\nmysql&gt; show binlog events in 'binlog.000002';\n-- 查看截取日志信息事件区域范围\n[root@cheng ~]# mysqlbinlog --start-position=233 --stop-position=1162 /data/3306/data/binlog.000003 &gt;/tmp/bin.sql\n-- 依据binlog日志的position号码，即可获取到想要恢复数据信息；\n\n# 根据截取的日志信息，进行数据库服务数据恢复\nmysql&gt; set sql_log_bin=0;\n-- 建议在进行数据日志恢复数据时，将数据恢复时执行的SQL语句信息，不做binlog日志记录；\nmysql&gt; source /tmp/bin.sql\n\n# 查看确认数据信息是否恢复\nmysql&gt; use bindb;\nmysql&gt; show tables;\nmysql&gt; select * from t1;\n</code></pre>\n<blockquote>\n<hr />\n<hr />\n</blockquote>\n<h3 id=\"数据库数据异常恢复\">数据库数据异常恢复</h3>\n<h4 id=\"情况一日志文件被清理过可能建库语句所在日志已经丢失\">情况一：日志文件被清理过，可能建库语句所在日志已经丢失</h4>\n<p>项目背景：一个数据库三年前就创建了，但是日志信息只记录一个月，这个库被误删除了；</p>\n<p>解决方案：</p>\n<p>A计划：最近一次全备+全备之后，误删除之前所有binlog，进行一同恢复；（<code>全备数据+增量数据</code>）</p>\n<p>B计划：利用延时从库，进行数据恢复；</p>\n<h4 id=\"情况二所需日志跨越多个文件如何进行日志信息的截取\">情况二：所需日志跨越多个文件，如何进行日志信息的截取</h4>\n<p>解决方案：</p>\n<p>A计划：只有position号的方式，可以进行分段截取，进行分段恢复数据；</p>\n<p>B计划：根据Datatime时间信息方式，可能会出现准确性不高的情况（因为每一秒可能有多个事件产生）；</p>\n<p>C计划：启用GTID（全局事务ID）方式，无论跨越多少个日志文件，每个事务操作的事件ID信息都是唯一且递增的（5.6+引入）；</p>\n<p>实践操作：</p>\n<p><strong>C计划：基于GTID方式对binlog进行管理（利用GTID实现日志截取）</strong></p>\n<p>数据库异常恢复情况环境准备：</p>\n<pre><code class=\"language-sql\"># 刷新新的binlog日志进行操作\nmysql&gt; flush logs;\n-- 生成新的binlog日志信息\n\n# 确认新的日志编号是否是连续的\nmysql&gt; create database test5;\nmysql&gt; show binlog events in \"binlog.000004\"\n-- 可以看出新的binlog日志文件中，记录的gtid编号信息是延续了上一个binlog日志gtid集合信息，继续连续进行记录；\n\n# 进行基本的数据库SQL语句操作：\nmysql&gt; create database gtdb;\nmysql&gt; use gtdb;\nmysql&gt; create table t1(id int);\nmysql&gt; insert into t1 values(1);\nmysql&gt; commit;\nmysql&gt; insert into t1 values(2);\nmysql&gt; commit;\nmysql&gt; insert into t1 values(3);\nmysql&gt; commit;\n\n# 进行binlog事件信息查看\nmysql&gt; show binlog events in 'binlog.000004';\n-- 可以获取以上的数据操作事件信息，\n</code></pre>\n<p>数据库模拟异常情况破坏操作：</p>\n<pre><code class=\"language-sql\">mysql&gt; drop database gtdb;\n-- 模拟破坏性操作，删除数据库\n</code></pre>\n<p>数据库异常情况数据恢复操作：</p>\n<pre><code class=\"language-sql\"># 根据日志信息查看相关的事件情况（获取GTID编号范围）\nmysql&gt; show binlog events in 'binlog.000004';\n\n# 需要恢复建库开始，删除之前的所有操作（即所有binlog日志信息），实现日志信息的截取\n[root@cheng ~]# mysqlbinlog --include-gtids='7afe4f8c-5e36-11ed-b083-000c29d44f34:3-7' /data/3306/data/binlog.000004 &gt;/tmp/gtid.sql\n-- 依据binlog日志的GTID信息，即可获取到想要恢复数据信息；\n\n# 根据截取的日志信息，进行数据库服务数据恢复\nmysql&gt; set sql_log_bin=0;\n-- 建议在进行数据日志恢复数据时，将数据恢复时执行的SQL语句信息，不做binlog日志记录；恢复后别忘在改为1；\nmysql&gt; source /tmp/gtid.sql\n-- 默认此时报错恢复失败，因为GTID截取的日志恢复数据时，具有幂等性，由于binlog中已经记录了3-7的GTID事件信息\nmysql&gt; show master status;\n+---------------+----------+--------------+------------------+------------------------------------------+\n| File          | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                        |\n+---------------+----------+--------------+------------------+------------------------------------------+\n| binlog.000004 |     1905 |              |                  | 7afe4f8c-5e36-11ed-b083-000c29d44f34:1-8 |\n+---------------+----------+--------------+------------------+------------------------------------------+\n1 row in set (0.00 sec)\n-- 通过查看确认，核实清楚binlog中已经记录了3-7的GTID事件信息\n\n# 利用GTID日志信息恢复报错处理方式一：将系统中日志中的GTID信息清除掉（不建议）\n# 利用GTID日志信息恢复报错处理方式二：删除与幂等性冲突的记录信息\n[root@cheng ~]# mysqlbinlog --skip-gtids --include-gtids='7afe4f8c-5e36-11ed-b083-000c29d44f34:3-7' /data/3306/data/binlog.000004 &gt;/tmp/gtid.sql\n-- 表示跳过gtid的检查过程，即截取的日志中不再含有GTID的配置语句信息，自然解决了幂等性冲突问题；\n-- 开启了GTID之后，依然可以使用pos方式进行日志信息截取与恢复；\n\n# 查看确认数据信息是否恢复\nmysql&gt; use gtdb;\nmysql&gt; show tables;\nmysql&gt; select * from t1;\n-- 查看test1数据库中的t1表的数据信息是否恢复\n\n# 操作扩展：可以实现排除指定gtid信息不做日志记录截取\n[root@cheng ~]# mysqlbinlog --exclude-gtids='7afe4f8c-5e36-11ed-b083-000c29d44f34:4'  --include-gtids='7afe4f8c-5e36-11ed-b083-000c29d44f34:3-7' /data/3306/data/binlog.000004 \n\n# 操作扩展：跨多日志文件信息截取\n[root@cheng ~]# mysqlbinlog --skip-gtids --include-gtids='7afe4f8c-5e36-11ed-b083-000c29d44f34:1-10' /data/3306/data/binlog.000001  /data/3306/data/binlog.000002 /data/3306/data/binlog.000003 &gt;/tmp/gtid.sql\n</code></pre>\n<ul>\n<li><strong>GTID概念介绍：</strong></li>\n</ul>\n<p>GTID（global transation id）称为全局事务（事件）ID，标识binlog日志记录的唯一性；</p>\n<p>GTID信息的表示方式：</p>\n<table>\n<thead>\n<tr>\n<th>表现形式</th>\n<th>关键列</th>\n<th>解释说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>server_uuid:N</td>\n<td>server_uuid</td>\n<td>表示数据库初始化启动之后，自动生成的随机数信息（唯一的）</td>\n</tr>\n<tr>\n<td></td>\n<td>N</td>\n<td>表示第几个相关的事务或事件信息，会不断进行自增</td>\n</tr>\n</tbody>\n</table>\n<p>server_uuid信息查看：</p>\n<pre><code class=\"language-sql\">mysql&gt; select @@server_uuid;\n+---------------------------------------------------+\n| @@server_uuid                                     |\n+---------------------------------------------------+\n| 7afe4f8c-5e36-11ed-b083-000c29d44f34              |\n+---------------------------------------------------+\n1 row in set (0.00 sec)\n-- 表示数据库每次初始化之后自动生成，不建议手工进行修改；\n\n[root@cheng ~]# cat /data/3306/data/auto.cnf \n[auto]\nserver-uuid=7afe4f8c-5e36-11ed-b083-000c29d44f34\n-- 在数据库的数据目录文件中也可以查询到\n</code></pre>\n<ul>\n<li><strong>GTID功能作用：</strong></li>\n</ul>\n<p>利用GTID方式管理binlog，实质上就是对于数据库的每个事务产生事件信息打上唯一标识信息（id号）；</p>\n<p>利用GTID方式管理binlog，主要目的是处理数据库主从问题，解决主从数据库的数据一致性问题；</p>\n<p>简单描述：标识事务的唯一性，保证日志恢复时的一致性，并且具备”幂等性”；</p>\n<ul>\n<li><strong>GTID功能配置：</strong></li>\n</ul>\n<p>GTID功能相关参数介绍：</p>\n<pre><code class=\"language-sql\"># GTID功能参数信息介绍（3个重要的配置参数）\nmysql&gt; select @@gtid_mode;\n+-------------------+\n| @@gtid_mode       |\n+-------------------+\n| OFF               |\n+-------------------+\n1 row in set (0.00 sec)\n-- 设置是否开启显示gtid信息功能（在5.7之后是有个匿名的gtid，是数据库系统自己维护的）\n\nmysql&gt; select @@enforce_gtid_consistency;\n+-------------------------------------+\n| @@enforce_gtid_consistency          |\n+-------------------------------------+\n| OFF                                 |\n+-------------------------------------+\n1 row in set (0.00 sec)\n-- 设置是否开启GTID强制一致性功能\n-- 对某些 SQL 会有限制，例如 CREATE TABLE … SELECT 必须得分成两条语句执行。\n-- OFF：    表示事务允许违反 GTID 一致性。\n-- ON：     表示事务不允许违反 GTID 一致性，有相关 SQL 会直接返回异常。\n-- WARN：表示事务允许违反 GTID 一致性，但会将警告信息记录到 ERROR LOG。\n\nmysql&gt; select @@log_slave_updates;\n+----------------------------+\n| @@log_slave_updates        |\n+----------------------------+\n|      1                     |\n+----------------------------+\n1 row in set, 1 warning (0.01 sec)\n-- 和配置主从有关（在8.0.26开始 推荐配置log_replica_updates替代log_slave_updates参数）\n-- 此参数表示从服务器从主服务器接收的更新信息，是否也会记录在从服务器本地的二进制文件中\n</code></pre>\n<p>GTID功能相关参数激活：</p>\n<pre><code class=\"language-sql\">[root@cheng ~]# vim /etc/my.cnf\n[mysqld]\ngtid_mode=on\nenforce_gtid_consistency=1\nlog_slave_updates=on\n-- 配置文件信息修改完毕后，重启数据库服务使配置生效\n</code></pre>\n<ul>\n<li><strong>GTID信息查看：</strong></li>\n</ul>\n<pre><code class=\"language-sql\">mysql&gt; show master status;\n+------------------+-----------+-------------------+-----------------------+-------------------------+\n| File             | Position  | Binlog_Do_DB      | Binlog_Ignore_DB      | Executed_Gtid_Set       |\n+------------------+-----------+-------------------+-----------------------+-------------------------+\n| binlog.000004    |    156    |                   |                       |                         |\n+------------------+-----------+-------------------+-----------------------+-------------------------+\n1 row in set (0.03 sec)\n-- 在GTID功能被激活后，就会在Executed_Gtid_Set列中显示GTID集合信息；\n\nmysql&gt; create database test3;\nQuery OK, 1 row affected (0.08 sec)\n-- 模拟创建数据库，产生新的事件信息\nmysql&gt; show master status;\n+------------------+----------+--------------+------------------+----------------------------------------+\n| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                      |\n+------------------+----------+--------------+------------------+----------------------------------------+\n| binlog.000004    |      344 |              |                  | 7afe4f8c-5e36-11ed-b083-000c29d44f34:1 |\n+------------------+----------+--------------+------------------+----------------------------------------+\n1 row in set (0.01 sec)\n-- GTID信息随着新的事件产生，随之发生变化\nmysql&gt; create database test4;\nQuery OK, 1 row affected (0.03 sec)\n-- 模拟创建数据库，产生新的事件信息\nmysql&gt; show master status;\n+---------------+----------+--------------+------------------+------------------------------------------+\n| File          | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                        |\n+---------------+----------+--------------+------------------+------------------------------------------+\n| binlog.000004 |      532 |              |                  | 7afe4f8c-5e36-11ed-b083-000c29d44f34:1-2 |\n+---------------+----------+--------------+------------------+------------------------------------------+\n1 row in set (0.00 sec)\n-- GTID信息随着新的事件产生，随之发生变化\n\nmysql&gt; show binlog events in 'binlog.000004';\n+---------------+-----+----------------+-----------+-------------+-------------------------------------------------------------------+\n| Log_name      | Pos | Event_type     | Server_id | End_log_pos | Info                                                              |\n+---------------+-----+----------------+-----------+-------------+-------------------------------------------------------------------+\n| binlog.000004 |   4 | Format_desc    |         1 |         125 | Server ver: 8.0.26, Binlog ver: 4                                 |\n| binlog.000004 | 125 | Previous_gtids |         1 |         156 |                                                                   |\n| binlog.000004 | 156 | Gtid           |         1 |         233 | SET @@SESSION.GTID_NEXT= '7afe4f8c-5e36-11ed-b083-000c29d44f34:1' |\n| binlog.000004 | 233 | Query          |         1 |         344 | create database test3 /* xid=6 */                                 |\n| binlog.000004 | 344 | Gtid           |         1 |         421 | SET @@SESSION.GTID_NEXT= '7afe4f8c-5e36-11ed-b083-000c29d44f34:2' |\n| binlog.000004 | 421 | Query          |         1 |         532 | create database test4 /* xid=8 */                                 |\n+---------------+-----+----------------+-----------+-------------+-------------------------------------------------------------------+\n6 rows in set (0.00 sec)\n-- 在每个数据库操作事件之前，会显示GTID的唯一标识信息\n</code></pre>\n<h4 id=\"情况三如何从日志文件中恢复单库单表或者部分行数据信息\">情况三：如何从日志文件中恢复单库、单表、或者部分行数据信息</h4>\n<p>解决方案：</p>\n<p>A计划：可以利用命令单独截取某个数据库的日志信息；<code>mysqlbinlog -d world  xxx &gt; xxxx</code></p>\n<p>B计划：可以借助第三方工具实现单表或部分数据恢复；<code>binlog2sql（python）</code> 过滤指定表数据或过滤指定表的部分数据；</p>\n<p>实战操作：</p>\n<p><strong>A计划：单库日志信息截取，企业实战过程</strong>：</p>\n<p>数据库异常恢复情况环境准备：</p>\n<pre><code class=\"language-sql\"># 查看获取当前binlog日志状态信息\nmysql &gt; show master status;\n+------------------+-----------+-------------------+-----------------------+-------------------------+\n| File             | Position  | Binlog_Do_DB      | Binlog_Ignore_DB      | Executed_Gtid_Set       |\n+------------------+-----------+-------------------+-----------------------+-------------------------+\n| binlog.000003    |      1269 |                   |                       |                         |\n+------------------+-----------+-------------------+-----------------------+-------------------------+\n\n# 进行基本的数据库SQL语句操作：\nmysql&gt; create database test1;\nmysql&gt; create table t1 (id int);\nmysql&gt; insert into t1 values(1);\nmysql&gt; insert into t1 values(2);\nmysql&gt; commit;\nmysql&gt; select * from t1;\n+------+\n| id     |\n+------+\n|      1 |\n|      2 |\n+------+\n2 rows in set (0.00 sec)\n-- 创建了一个test1数据库，并在数据库中创建了一个表，在表中插入了一些数据信息\nmysql&gt; create database test2;\nmysql&gt; use test2;\nmysql&gt; create table t2 (id int);\nmysql&gt; insert into t2 values(1);\nmysql&gt; insert into t2 values(2);\nmysql&gt; commit;\n-- 创建了一个test2数据库，并在数据库中创建了一个表，在表中插入了一些数据信息\nmysql&gt; use test1;\nmysql&gt; insert into t1 values(3);\nmysql&gt; insert into t1 values(4);\nmysql&gt; use test2;\nmysql&gt; insert into t2 values(3);\nmysql&gt; insert into t2 values(4);\nmysql&gt; commit;\nmysql&gt; select * from test1.t1;\nmysql&gt; select * from test2.t2;\n-- 通过操作不同的数据库，以及不同的数据表，实现binlog日志事件信息的交叉\n</code></pre>\n<p>数据库模拟异常情况破坏操作：</p>\n<pre><code class=\"language-sql\">mysql&gt; drop database test1;\n-- 模拟破坏性操作，删除数据库\n</code></pre>\n<p>数据库异常情况数据恢复操作：</p>\n<pre><code class=\"language-sql\"># 根据日志信息查看相关的事件情况\nmysql&gt; show binlog events in 'binlog.000003';\n\n# 需要恢复建库开始，删除之前的所有操作（即所有binlog日志信息），实现日志信息的截取\n[root@cheng ~]# mysqlbinlog --start-position=1346 --stop-position=4116 -d test1 /data/3306/data/binlog.000003 &gt;/tmp/bin.sql\n-- 依据binlog日志的position号码，即可获取到想要恢复数据信息，并利用-d参数导出指定数据库相关数据；\n\n# 根据截取的日志信息，进行数据库服务数据恢复\nmysql&gt; set sql_log_bin=0;\n-- 建议在进行数据日志恢复数据时，将数据恢复时执行的SQL语句信息，不做binlog日志记录；恢复后别忘在改为1；\nmysql&gt; source /tmp/bin.sql\n\n# 查看确认数据信息是否恢复\nmysql&gt; use test1;\nmysql&gt; show tables;\nmysql&gt; select * from t1;\n-- 查看test1数据库中的t1表的数据信息是否恢复\nmysql&gt; use test2;\nmysql&gt; show tables;\nmysql&gt; select * from t2;\n-- 查看test2数据库中的t2表的数据信息是否破坏\n</code></pre>\n<p><strong>B计划：可以借助第三方工具实现单表或部分数据恢复；</strong></p>\n<p>利用binlog2sql工具可以处理上面的企业需求，此软件是利用python语言开发的，主要用来处理binlog日志信息；</p>\n<p>从软件应用方面来说主要包含两个核心功能：</p>\n<ul>\n<li>可以友好的展示或者管理二进制日志信息（binlog），进而可以过滤出单独表的信息，甚至表中指定行的信息；</li>\n<li>可以快速的实现DML操作语句的闪回功能，即实现通过日志信息翻转方式，进行数据信息的恢复；</li>\n</ul>\n<blockquote>\n<p>说明：binlog2sql工具是模拟了一个从库，进行日志信息分析，需要保证数据库服务启动状态，且不支持离线方式分析日志内容；</p>\n</blockquote>\n<p>数据库异常恢复情况环境准备：</p>\n<pre><code class=\"language-sql\"># 下载第三方日志分析工具\n[root@cheng ~]# cd /opt/\n[root@cheng ~]# git clone https://github.com/danfengcao/binlog2sql.git\n[root@cheng ~]# cd /opt/binlog2sql\n-- 此工具在mariadb中可以通过打补丁方式，进行部署安装；但是在mysql 8.0中暂时还没有集成，需要单独安装\n\n# 部署第三方工具运行环境\n[root@cheng ~]# yum install -y python3\n[root@cheng ~]# pip3 install -r requirments.txt\n[root@cheng ~]# pip3 show pymysql\n[root@cheng ~]# pip3 install --upgrade pymysql    （此步骤可以忽略）\n-- 以上pip3下载软件缓慢，可以优化pip3下载源\n-- 下载源优化方法：https://developer.aliyun.com/mirror/pypi?spm=a2c6h.13651102.0.0.3e221b11H9Q7La\n\n# 在指定数据库中创建多个数据表\nmysql&gt; use test1;\nmysql&gt; create table t11 (id int);\nmysql&gt; insert into t11 values (1),(2);\nmysql&gt; commit;\n</code></pre>\n<p>数据库日志信息工具分析查看：（解析日志事件SQL）</p>\n<pre><code class=\"language-sql\">[root@cheng binlog2sql]# python3 binlog2sql.py -h 10.0.0.101 -P3306 -uroot -p123456 -d test1 -t t1 --start-file='binlog.000003'\nINSERT INTO `test1`.`t1`(`id`) VALUES (1); #start 1460 end 1704 time 2022-11-21 22:16:32 gtid \nINSERT INTO `test1`.`t1`(`id`) VALUES (2); #start 1735 end 1979 time 2022-11-21 22:16:35 gtid \nINSERT INTO `test1`.`t1`(`id`) VALUES (3); #start 2939 end 3183 time 2022-11-21 22:20:53 gtid \nINSERT INTO `test1`.`t1`(`id`) VALUES (4); #start 3214 end 3458 time 2022-11-21 22:22:19 gtid\n[root@cheng binlog2sql-master]# python3 binlog2sql.py -h 10.0.0.101 -P3306 -uroot -p123456 -d test1 -t t11 --start-file='binlog.000003'\nINSERT INTO `test1`.`t11`(`id`) VALUES (1); #start 4704 end 4954 time 2022-11-21 23:47:51 gtid \nINSERT INTO `test1`.`t11`(`id`) VALUES (2); #start 4704 end 4954 time 2022-11-21 23:47:51 gtid \n-- 表的数据信息导出后，可以直接复制命令信息恢复，或者导出sql文件进行导入恢复；\n</code></pre>\n<p>数据库模拟异常情况破坏操作：</p>\n<pre><code class=\"language-sql\"># 在指定数据库的相应数据表中做修改操作\nmysql&gt; use test1;\nmysql&gt; update t1 set id=10 where id=1;\nmysql&gt; commit;\n\n# 在指定数据库的相应数据表中做删除操作\nmysql&gt; use test1;\nmysql&gt; delete from t1 where id=3;\nmysql&gt; commit;\n</code></pre>\n<p>数据库日志信息工具分析查看：（解析日志事件SQL）</p>\n<pre><code class=\"language-sql\">[root@cheng binlog2sql-master]# python3 binlog2sql.py -h 10.0.0.101 -P3306 -uroot -p123456 -d test1 -t t1 --start-file='binlog.000003'\nINSERT INTO `test1`.`t1`(`id`) VALUES (1); #start 1460 end 1704 time 2022-11-21 22:16:32 gtid \nINSERT INTO `test1`.`t1`(`id`) VALUES (2); #start 1735 end 1979 time 2022-11-21 22:16:35 gtid \nINSERT INTO `test1`.`t1`(`id`) VALUES (3); #start 2939 end 3183 time 2022-11-21 22:20:53 gtid \nINSERT INTO `test1`.`t1`(`id`) VALUES (4); #start 3214 end 3458 time 2022-11-21 22:22:19 gtid \nUPDATE `test1`.`t1` SET `id`=10 WHERE `id`=1 LIMIT 1; #start 4985 end 5244 time 2022-11-21 23:52:33 gtid \nDELETE FROM `test1`.`t1` WHERE `id`=3 LIMIT 1; #start 5275 end 5519 time 2022-11-21 23:54:17 gtid \n\n# 只想查看删除操作信息\n[root@cheng binlog2sql-master]# python3 binlog2sql.py -h 10.0.0.101 -P3306 -uroot -p123456 -d test1 -t t1 --sql-type=delete --start-file='binlog.000003'\nDELETE FROM `test1`.`t1` WHERE `id`=3 LIMIT 1; #start 5275 end 5519 time 2022-11-21 23:54:17 gtid\n-- sql-type参数只能过滤DML类型语句信息，一般常见过滤的是 insert update delete\n\n# 只想查看修改操作信息\n[root@cheng binlog2sql-master]# python3 binlog2sql.py -h 10.0.0.101 -P3306 -uroot -p123456 -d test1 -t t1 --sql-type=update --start-file='binlog.000003'\nUPDATE `test1`.`t1` SET `id`=10 WHERE `id`=1 LIMIT 1; #start 4985 end 5244 time 2022-11-21 23:52:33 gtid\n\n# 只想查看插入操作信息\n[root@cheng binlog2sql-master]# python3 binlog2sql.py -h 10.0.0.101 -P3306 -uroot -p123456 -d test1 -t t1 --sql-type=insert --start-file='binlog.000003'\nINSERT INTO `test1`.`t1`(`id`) VALUES (1); #start 1460 end 1704 time 2022-11-21 22:16:32 gtid \nINSERT INTO `test1`.`t1`(`id`) VALUES (2); #start 1735 end 1979 time 2022-11-21 22:16:35 gtid \nINSERT INTO `test1`.`t1`(`id`) VALUES (3); #start 2939 end 3183 time 2022-11-21 22:20:53 gtid \nINSERT INTO `test1`.`t1`(`id`) VALUES (4); #start 3214 end 3458 time 2022-11-21 22:22:19 gtid\n</code></pre>\n<p>数据库日志信息工具回滚操作：（生成指定事件回滚语句-闪回操作）</p>\n<p>假设在某个企业的应用场景中，有3000万行数据，占用200G的存储空间，其中误删除了10行数据信息，请问如何进行恢复数据？</p>\n<pre><code class=\"language-sql\"># 误删除操作语句反转操作\n[root@cheng binlog2sql-master]# python3 binlog2sql.py -h 10.0.0.101 -P3306 -uroot -p123456 -d test1 -t t1 --sql-type=delete --start-file='binlog.000003'\nDELETE FROM `test1`.`t1` WHERE `id`=3 LIMIT 1; #start 5275 end 5519 time 2022-11-21 23:54:17 gtid\n-- 获取删除操作语句信息\n\n[root@cheng binlog2sql-master]# python3 binlog2sql.py -h 10.0.0.101 -P3306 -uroot -p123456 -d test1 -t t1 --sql-type=delete --start-file='binlog.000003' -B\nINSERT INTO `test1`.`t1`(`id`) VALUES (3); #start 5275 end 5519 time 2022-11-21 23:54:17 gtid\n-- 在获取删除操作语句命令后加 -B 参数，正好获得了反转语句的操作信息\n\n# 误修改操作语句反转操作\n[root@cheng binlog2sql-master]# python3 binlog2sql.py -h 10.0.0.101 -P3306 -uroot -p123456 -d test1 -t t1 --sql-type=update --start-file='binlog.000003'\nUPDATE `test1`.`t1` SET `id`=10 WHERE `id`=1 LIMIT 1; #start 4985 end 5244 time 2022-11-21 23:52:33 gtid \n-- 获取修改操作语句信息\n\n[root@cheng binlog2sql-master]# python3 binlog2sql.py -h 10.0.0.101 -P3306 -uroot -p123456 -d test1 -t t1 --sql-type=update --start-file='binlog.000003' -B\nUPDATE `test1`.`t1` SET `id`=1 WHERE `id`=10 LIMIT 1; #start 4985 end 5244 time 2022-11-21 23:52:33 gtid\n-- 在获取修改操作语句命令后加 -B 参数，正好获得了反转语句的操作信息\n\n# 误插入操作语句反转操作\n[root@cheng binlog2sql-master]# python3 binlog2sql.py -h 10.0.0.101 -P3306 -uroot -p123456 -d test1 -t t1 --sql-type=insert --start-file='binlog.000003'\nINSERT INTO `test1`.`t1`(`id`) VALUES (1); #start 1460 end 1704 time 2022-11-21 22:16:32 gtid \nINSERT INTO `test1`.`t1`(`id`) VALUES (2); #start 1735 end 1979 time 2022-11-21 22:16:35 gtid \nINSERT INTO `test1`.`t1`(`id`) VALUES (3); #start 2939 end 3183 time 2022-11-21 22:20:53 gtid \nINSERT INTO `test1`.`t1`(`id`) VALUES (4); #start 3214 end 3458 time 2022-11-21 22:22:19 gtid \n-- 获取插入操作语句信息\n\n[root@cheng binlog2sql-master]# python3 binlog2sql.py -h 10.0.0.101 -P3306 -uroot -p123456 -d test1 -t t1 --sql-type=insert --start-file='binlog.000003' -B\nDELETE FROM `test1`.`t1` WHERE `id`=4 LIMIT 1; #start 3214 end 3458 time 2022-11-21 22:22:19 gtid\nDELETE FROM `test1`.`t1` WHERE `id`=3 LIMIT 1; #start 2939 end 3183 time 2022-11-21 22:20:53 gtid\nDELETE FROM `test1`.`t1` WHERE `id`=2 LIMIT 1; #start 1735 end 1979 time 2022-11-21 22:16:35 gtid\nDELETE FROM `test1`.`t1` WHERE `id`=1 LIMIT 1; #start 1460 end 1704 time 2022-11-21 22:16:32 gtid\n-- 在获取插入操作语句命令后加 -B 参数，正好获得了反转语句的操作信息\n</code></pre>\n\n</div>\n<div id=\"MySignature\">\n    <!-- 版权保护 \n<div style=\"color: red; font-weight: bold; font-size: 15px;\">\n更多最新文章：<a href=\"https://juejin.cn/user/1383642897854980/posts\">【传送门】</a><br>\n</div>\n<br>\n<div style=\"text-align:center;background-color:font-size: 24px; \">\n-->\n<div style=\"color: red; text-align: center; font-weight: bold; font-size: 15px;\">\n**********   如果您认为这篇文章还不错或者有所收获，请点击右下角的【推荐】/【赞助】按钮，因为您的支持是我继续创作分享的最大动力！   **********\n</div>\n<br />\n\n<div style=\"color: #0; font-size: 15px;\">\n            作者：<a href=\"https://www.cnblogs.com/zhangwencheng\">讲文张字</a><br />\n            出处：<a href=\"https://www.cnblogs.com/zhangwencheng\">https://www.cnblogs.com/zhangwencheng</a><br />\n            版权：本文版权归作者和博客园共有，欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出\n             <a href=\"#\" style=\"background: #b6ff00; color: #0; font-size: medium;\">原文链接</a>\n    \n</div>\n</div>\n<div class=\"clear\"></div>\n\n            </div>\n            <div class=\"postDesc\">posted @ \n<span id=\"post-date\">2025-12-25 10:24</span>&nbsp;\n<a href=\"https://www.cnblogs.com/zhangwencheng\">讲文张字</a>&nbsp;\n阅读(<span id=\"post_view_count\">12</span>)&nbsp;\n评论(<span id=\"post_comment_count\">0</span>)&nbsp;\n&nbsp;\n<a href=\"\">收藏</a>&nbsp;\n<a href=\"\">举报</a>\n</div>"
    },
    {
      "title": "【面试题】MySQL 的索引下推是什么？",
      "link": "https://www.cnblogs.com/sun-10387834/p/19371453",
      "published": "",
      "description": "<h1 class=\"postTitle\">\n                <a class=\"postTitle2 vertical-middle\" href=\"https://www.cnblogs.com/sun-10387834/p/19371453\" id=\"cb_post_title_url\" title=\"发布于 2025-12-25 09:09\">\n    <span>【面试题】MySQL 的索引下推是什么？</span>\n    \n\n</a>\n\n            </h1>\n            <div class=\"clear\"></div>\n            <div class=\"postBody\">\n                <div class=\"blogpost-body cnblogs-markdown\" id=\"cnblogs_post_body\">\n<h1 id=\"-秒懂-mysql-索引下推\">🌟 秒懂 MySQL 索引下推</h1>\n<h2 id=\"-一句话概括\">🎯 一句话概括</h2>\n<p><strong>索引下推就是让索引多干点活，少打扰数据行</strong></p>\n<h2 id=\"-通俗版解释\">📖 通俗版解释</h2>\n<p>想象你在一家大公司找员工信息：</p>\n<h3 id=\"没有索引下推传统方式\"><strong>没有索引下推（传统方式）</strong></h3>\n<blockquote>\n<p>你：人事小姐姐，我要找<strong>年龄大于25岁</strong>的所有员工</p>\n<p>人事：好的，这是500个符合年龄要求的员工名单（只给了工号）</p>\n<p>你：我还需要他们是<strong>北京分公司的</strong></p>\n<p>人事：那你自己去查这500个人的详细档案吧</p>\n<p>你：😭 我要翻500份档案，一个个看是不是北京分公司的</p>\n</blockquote>\n<p><strong>问题</strong>：明明可以在人事那里就过滤掉，非要让你查500次档案</p>\n<h3 id=\"有了索引下推优化后\"><strong>有了索引下推（优化后）</strong></h3>\n<blockquote>\n<p>你：人事小姐姐，我要找<strong>年龄大于25岁</strong>且是<strong>北京分公司</strong>的员工</p>\n<p>人事：好的，我直接帮你筛选，这是80个符合要求的员工名单</p>\n<p>你：太好了！我只需要查80份档案</p>\n</blockquote>\n<p><strong>效果</strong>：人事（索引）帮你完成了额外筛选，你少查了420次档案</p>\n<h2 id=\"-实际数据库例子\">🔧 实际数据库例子</h2>\n<pre><code class=\"language-sql\">-- 员工表，索引在 (年龄, 分公司)\nCREATE TABLE 员工表 (\n    工号 INT PRIMARY KEY,\n    姓名 VARCHAR(50),\n    年龄 INT,\n    分公司 VARCHAR(50),\n    工资 DECIMAL(10,2),\n    INDEX idx_年龄_分公司 (年龄, 分公司)\n);\n\n-- 传统查询（没有索引下推）\nSELECT * FROM 员工表 \nWHERE 年龄 &gt; 25 \n  AND 分公司 LIKE '北京%';\n\n-- 执行过程：\n-- 1. 索引找到所有年龄&gt;25的记录（500条）\n-- 2. 拿着500个工号去查详细档案（500次）\n-- 3. 在500条详细记录中筛选\"北京分公司\"\n</code></pre>\n<pre><code class=\"language-sql\">-- 开启索引下推后\n-- 执行过程：\n-- 1. 索引找到所有年龄&gt;25的记录（500条）\n-- 2. 索引自己先筛选\"分公司 LIKE '北京%'\"（剩80条）\n-- 3. 只查80个员工的详细档案\n</code></pre>\n<h2 id=\"-核心好处\">💡 核心好处</h2>\n<h3 id=\"1-减少跑腿次数\"><strong>1. 减少跑腿次数</strong></h3>\n<ul>\n<li>原来：跑500次档案室</li>\n<li>现在：跑80次档案室</li>\n<li><strong>节省84%的跑腿时间</strong></li>\n</ul>\n<h3 id=\"2-人事小姐姐更聪明了\"><strong>2. 人事小姐姐更聪明了</strong></h3>\n<p>以前人事只做最简单的筛选，现在她能做更多：</p>\n<ul>\n<li>✅ 可以判断：<code>分公司 = '北京'</code></li>\n<li>✅ 可以判断：<code>分公司 LIKE '北京%'</code></li>\n<li>✅ 可以判断：<code>年龄 BETWEEN 20 AND 30</code></li>\n<li>❌ 不能判断：<code>工资 &gt; 10000</code>（因为工资信息在档案里）</li>\n</ul>\n<h2 id=\"️-什么情况下能用\">🏷️ 什么情况下能用？</h2>\n<h3 id=\"能用的情况\"><strong>能用的情况</strong></h3>\n<pre><code class=\"language-sql\">-- 情况1：索引里有的信息，人事自己就能判断\n-- 索引：(年龄, 城市)\nSELECT * FROM 用户 \nWHERE 年龄 &gt; 20 \n  AND 城市 LIKE '上海%';  -- ✅ 能用！城市在索引里\n\n-- 情况2：部分条件在索引里\nSELECT * FROM 订单 \nWHERE 用户ID = 1001 \n  AND 状态 = '已支付';  -- ✅ 能用！两个都在索引里\n</code></pre>\n<h3 id=\"不能用的情况\"><strong>不能用的情况</strong></h3>\n<pre><code class=\"language-sql\">-- 情况1：要的信息索引里全有，不需要查档案\n-- 索引：(姓名, 年龄)\nSELECT 姓名, 年龄 FROM 员工;  -- ❌ 不需要！直接看名单就行\n\n-- 情况2：条件不在索引里\n-- 索引：(年龄, 城市)\nSELECT * FROM 用户 \nWHERE 年龄 &gt; 20 \n  AND 工资 &gt; 10000;  -- ❌ 不能用！工资不在索引里\n</code></pre>\n<h2 id=\"-实际效果对比\">🚀 实际效果对比</h2>\n<h3 id=\"测试数据\"><strong>测试数据</strong></h3>\n<ul>\n<li>员工表：100万条记录</li>\n<li>年龄&gt;25：50万人</li>\n<li>北京分公司：5万人</li>\n</ul>\n<h3 id=\"查询速度对比\"><strong>查询速度对比</strong></h3>\n<pre><code>传统方式：\n✓ 索引扫描：找到50万条记录（很快）\n✓ 回表查询：查50万次详细数据（很慢！）\n✓ 内存筛选：在50万条里找北京的（一般慢）\n⏱️ 总耗时：3.2秒\n\n索引下推：\n✓ 索引扫描+筛选：直接找到5万条记录（稍慢一点）\n✓ 回表查询：只查5万次详细数据（快很多！）\n⏱️ 总耗时：0.8秒\n</code></pre>\n<p><strong>提速4倍！</strong></p>\n<h2 id=\"-生活化类比\">🎮 生活化类比</h2>\n<h3 id=\"类比1图书馆找书\"><strong>类比1：图书馆找书</strong></h3>\n<pre><code>传统：图书管理员只按\"作者=鲁迅\"找书，找到100本\n      你一本本翻看是不是\"小说类\"\n      \n下推：告诉管理员\"作者=鲁迅 AND 类别=小说\"\n      直接给你30本小说\n</code></pre>\n<h3 id=\"类比2外卖筛选\"><strong>类比2：外卖筛选</strong></h3>\n<pre><code>传统：美团先按\"距离&lt;3km\"筛选出50家店\n      你再一家家看有没有\"评分&gt;4.5\"\n      \n下推：直接搜索\"距离&lt;3km AND 评分&gt;4.5\"\n      直接显示15家符合的店\n</code></pre>\n<h2 id=\"-简单总结\">📝 简单总结</h2>\n<h3 id=\"三句话记住索引下推\"><strong>三句话记住索引下推</strong></h3>\n<ol>\n<li><strong>让索引多干活</strong>：索引不只是找位置，还能做筛选</li>\n<li><strong>减少回表次数</strong>：筛选好了再查详细数据，少查很多次</li>\n<li><strong>条件要在索引里</strong>：只能筛选索引中包含的条件</li>\n</ol>\n<h3 id=\"开启和查看\"><strong>开启和查看</strong></h3>\n<pre><code class=\"language-sql\">-- 默认就是开启的（MySQL 5.6+）\n-- 查看有没有用上\nEXPLAIN SELECT ...;\n-- 看到\"Using index condition\"就是用了索引下推\n</code></pre>\n<h2 id=\"-什么时候最有效\">🎯 什么时候最有效？</h2>\n<table>\n<thead>\n<tr>\n<th>场景</th>\n<th>效果</th>\n<th>原因</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>大表筛选</td>\n<td>⭐⭐⭐⭐⭐</td>\n<td>减少大量回表</td>\n</tr>\n<tr>\n<td>索引选择性高</td>\n<td>⭐⭐⭐⭐</td>\n<td>过滤掉大部分数据</td>\n</tr>\n<tr>\n<td>查询条件多</td>\n<td>⭐⭐⭐</td>\n<td>提前过滤更有效</td>\n</tr>\n<tr>\n<td>小表查询</td>\n<td>⭐</td>\n<td>本来就没多少数据</td>\n</tr>\n</tbody>\n</table>\n<p><strong>一句话</strong>：数据量越大，筛选条件越多，索引下推效果越明显！</p>\n<h2 id=\"-思考题\">🤔 思考题</h2>\n<p>如果你要查：</p>\n<pre><code>\"年龄&gt;30岁的北京分公司程序员\"\n</code></pre>\n<p>但索引只有 <code>(年龄, 分公司)</code>，没有<code>职位</code>字段。</p>\n<p>问：索引下推能帮你过滤掉什么？什么过滤不了？</p>\n<p><strong>答案</strong>：</p>\n<ul>\n<li>✅ 能过滤：年龄&gt;30 且 分公司=北京</li>\n<li>❌ 不能过滤：职位=程序员（需要查了档案才知道）</li>\n</ul>\n<p>所以还是会先过滤掉非北京分公司的，再查档案看是不是程序员。</p>\n<p>这就是索引下推的核心思想：<strong>能提前过滤的绝不留到后面</strong>！</p>\n\n</div>\n<div id=\"MySignature\">\n    \n<p>❤️ 如果你喜欢这篇文章，请点赞支持！ 👍 同时欢迎关注我的博客，获取更多精彩内容！</p>\n\n<p>本文来自博客园，作者：<a href=\"https://www.cnblogs.com/sun-10387834/\" target=\"_blank\">佛祖让我来巡山</a>，转载请注明原文链接：<a href=\"https://www.cnblogs.com/sun-10387834/p/19371453\" target=\"_blank\">https://www.cnblogs.com/sun-10387834/p/19371453</a></p>\n\n\n</div>\n<div class=\"clear\"></div>\n\n            </div>\n            <div class=\"postDesc\">posted @ \n<span id=\"post-date\">2025-12-25 09:09</span>&nbsp;\n<a href=\"https://www.cnblogs.com/sun-10387834\">佛祖让我来巡山</a>&nbsp;\n阅读(<span id=\"post_view_count\">26</span>)&nbsp;\n评论(<span id=\"post_comment_count\">0</span>)&nbsp;\n&nbsp;\n<a href=\"\">收藏</a>&nbsp;\n<a href=\"\">举报</a>\n</div>"
    },
    {
      "title": "RabbitMQ发布订阅模式多实例消费者防止重复消费实现方式",
      "link": "https://www.cnblogs.com/zhaorong/p/19392986",
      "published": "",
      "description": "<h1 class=\"postTitle\">\n                <a class=\"postTitle2 vertical-middle\" href=\"https://www.cnblogs.com/zhaorong/p/19392986\" id=\"cb_post_title_url\" title=\"发布于 2025-12-25 08:45\">\n    <span>RabbitMQ发布订阅模式多实例消费者防止重复消费实现方式</span>\n    \n\n</a>\n\n            </h1>\n            <div class=\"clear\"></div>\n            <div class=\"postBody\">\n                    <div id=\"cnblogs_post_description\" style=\"display: none;\">\n        <img alt=\"RabbitMQ发布订阅模式多实例消费者防止重复消费实现方式\" class=\"desc_img\" src=\"https://img2024.cnblogs.com/blog/465891/202512/465891-20251224151919540-224874840.png\" />\n        上一篇文章中已经通过一个实际的业务场景结合RabbitMQ的四种交换机类型对RabbitMQ发布订阅模式同一消费者多个实例如何防止重复消费这个问题给出了解决方案。水这篇的目的主要是再给出一个可以直接抄作业的代码。\n    </div>\n<div class=\"blogpost-body cnblogs-markdown\" id=\"cnblogs_post_body\">\n<p>书接上回。</p>\n<p><a href=\"https://zhaorong.me/archives/rabbitmq-topic-multiple-instance\" rel=\"noopener nofollow\" target=\"_blank\">上一篇文章</a>中已经通过一个实际的业务场景结合RabbitMQ的四种交换机类型对RabbitMQ发布订阅模式同一消费者多个实例如何防止重复消费这个问题给出了解决方案。结尾的时候挖了个坑，水这篇的目的就是要把这个坑填上，给大家提供一个可以直接抄作业的代码。</p>\n<p>先把一些参数提前公布出来，后面代码里面再遇到就不逐个解释了</p>\n<ul>\n<li>RabbitMQ主机地址<code>127.0.0.1</code>，如果是部署在其他机器上的，就把IP地址替换成相应的主机IP或者域名。</li>\n<li>如果使用默认端口<code>5672</code>，连接地址可以不用写，映射到其他端口的话在主机地址上面加上。</li>\n<li>采用默认的用户名和密码<code>guest</code>，根据具体情况进行相应替换。</li>\n<li>预定交换机名称<code>demo.event</code>，根据具体情况进行相应替换。</li>\n<li>预定队列名称<code>demo.event.queue</code>，根据具体情况进行相应替换。</li>\n<li>队列<code>demo.event.queue</code>上有两个消费者，另外再生成一个只有一个消费者的随机名称队列。</li>\n</ul>\n<p>要达到的效果</p>\n<blockquote>\n<p>生产者发送一条消息到交换机demo.event，再由交换机分发到绑定给它的队列上，demo.event.queue队列上的消费者<strong>只有一个</strong>能收到，其他随机队列的消费者（只有一个）也能收到消息。</p>\n</blockquote>\n<h3 id=\"一准备rabbitmq环境\">一、准备RabbitMQ环境</h3>\n<p>我是在docker上部署的，到官方网站下载Docker Desktop直接安装就可以了，这里不再赘述。RabbitMQ的环境准备不是本篇的重点，这里只提供最基本的用法，有其他需求可以略过这一章节，去RabbitMQ或者Docker官网按照文档配置即可。</p>\n<h4 id=\"拉取镜像\">拉取镜像</h4>\n<p>我用的是带管理后台的<code>rabbitmq:management</code>。</p>\n<p>打开控制台/终端，输入</p>\n<pre><code class=\"language-bash\">docker pull rabbitmq:management\n</code></pre>\n<h4 id=\"创建volumes\">创建Volumes</h4>\n<pre><code class=\"language-bash\">docker volume create rabbitmq\n</code></pre>\n<h4 id=\"创建容器\">创建容器</h4>\n<pre><code class=\"language-bash\">docker run -d --name rabbitmq -p 4369:4369 -p 5671:5671 -p 5672:5672 -p 15671:15671 -p 15672:15672 -p 25672:25672 -p 15691:15691 -p 15692:15692 -v rabbitmq:/var/lib/rabbitmq rabbitmq:management\n</code></pre>\n<p>执行完以上代码后，容器会自动启动。</p>\n<h3 id=\"二net--rabbitmqclient\">二、.net + RabbitMQ.Client</h3>\n<p>先准备IDE，Visual Studio、VS Code、Rider都可以。</p>\n<p>我这里用的LinqPad，这是一个可以快速执行C#、VB、F#代码块和SQL的工具，使用Microsoft Roslyn进行编译，支持引入NuGet包和三方DLL文件，可以直接运行Asp.Net Core服务。Ver9开始支持macOS，渲染层由之前的WPF改成了AvaloniaUI。有需要的可以使用下面的链接购买</p>\n<p><a href=\"https://www.linqpad.net/Purchase.aspx?affiliate=8ucu28vs\" rel=\"noopener nofollow\" target=\"_blank\">https://www.linqpad.net/Purchase.aspx?affiliate=8ucu28vs</a></p>\n<h4 id=\"1依赖包\">1、依赖包</h4>\n<p>RabbitMQ.Client<br />\nLinqPad通过自带工具添加，正经IDE通过NuGet Manager、CLI工具添加或者在csproj引入</p>\n<pre><code class=\"language-xml\">&lt;PackageReference Include=\"RabbitMQ.Client\" Version=\"7.2.0\" /&gt;\n</code></pre>\n<p>如果项目使用集中版本管理，需要在Directory.Packages.props添加</p>\n<pre><code class=\"language-xml\">&lt;PackageVersion Include=\"RabbitMQ.Client\" Version=\"7.2.0\" /&gt;\n</code></pre>\n<p>然后在具体项目的csproj添加</p>\n<pre><code class=\"language-xml\">&lt;PackageReference Include=\"RabbitMQ.Client\" /&gt;\n</code></pre>\n<p>需要注意的是，7.x以后RabbitMQ.Client做了比较大的调整，原先的方法都改成了异步，<code>EventingBasicConsumer</code>也换成了<code>AsyncEventingBasicConsumer</code>，Consumer的Receive事件变成了ReceivedAsync，支持异步事件处理。</p>\n<h4 id=\"2生产者代码\">2、生产者代码</h4>\n<pre><code class=\"language-csharp\">async Task Main()\n{\n\tvar factory = new ConnectionFactory { Uri = new Uri(\"amqp://guest:guest@127.0.0.1\") };\n\tusing (var connection = await factory.CreateConnectionAsync())\n\t{\n\t\tusing (var channel = await connection.CreateChannelAsync())\n\t\t{\n\t\t\tawait channel.ExchangeDeclareAsync(exchange: \"demo.event\", type: ExchangeType.Fanout, durable: true, autoDelete: true);\n\n\t\t\twhile (true)\n\t\t\t{\n\t\t\t\tvar message = Console.ReadLine();\n\t\t\t\tvar body = Encoding.UTF8.GetBytes(message);\n\t\t\t\tvar properties = new BasicProperties();\n\t\t\t\tawait channel.BasicPublishAsync(exchange: \"demo.event\", routingKey: \"\", mandatory: true, basicProperties: properties, body: body, cancellationToken: default);\n\t\t\t}\n\t\t}\n\t}\n}\n\n// Define other methods, classes and namespaces here\n\n</code></pre>\n<h4 id=\"3消费者代码\">3、消费者代码</h4>\n<pre><code class=\"language-csharp\">async Task Main()\n{\n\tvar factory = new ConnectionFactory { Uri = new Uri(\"amqp://guest:guest@127.0.0.1\") };\n\tawait using (var connection = await factory.CreateConnectionAsync())\n\t{\n\t\tusing (var channel = await connection.CreateChannelAsync())\n\t\t{\n\t\t\tawait channel.ExchangeDeclareAsync(exchange: \"demo.event\", type: ExchangeType.Fanout, durable: true, autoDelete: true);\n\t\t\tvar queueName = await channel.QueueDeclareAsync(\"demo.event.queue\", true, false, true).ContinueWith(task =&gt; task.Result.QueueName); // 客户端制定队列名称。\n\t\t\tawait channel.QueueBindAsync(queue: queueName,\n\t\t\t\t\t\t\t  exchange: \"demo.event\",\n\t\t\t\t\t\t\t  routingKey: \"\");\n\t\t\tConsole.WriteLine(\" [*] Waiting for logs.\");\n\n\t\t\tvar consumer = new AsyncEventingBasicConsumer(channel);\n\t\t\tconsumer.ReceivedAsync += async (model, ea) =&gt;\n\t\t\t{\n\t\t\t\tvar body = ea.Body.ToArray();\n\t\t\t\tvar message = Encoding.UTF8.GetString(body);\n\t\t\t\tConsole.WriteLine(\" [x] {0}\", message);\n\t\t\t};\n\t\t\tawait channel.BasicConsumeAsync(queue: \"\", autoAck: true, consumer: consumer);\n\t\t\tConsole.WriteLine(\" Press [enter] to exit.\");\n\t\t\tConsole.ReadLine();\n\t\t}\n\t}\n}\n\n// Define other methods, classes and namespaces here\n\n</code></pre>\n<h4 id=\"3开始测试\">3、开始测试</h4>\n<p>在LinqPad里面每个标签的代码是完全隔离的，无法引用，所以为了启动多个消费者，我需要把消费者的代码块再复制两份出来。其中一个标签把</p>\n<pre><code class=\"language-csharp\">var queueName = await channel.QueueDeclareAsync(\"demo.event.queue\", true, false, false).ContinueWith(task =&gt; task.Result.QueueName);\n</code></pre>\n<p>改成</p>\n<pre><code class=\"language-csharp\">var queueName = await channel.QueueDeclareAsync().ContinueWith(task =&gt; task.Result.QueueName); // 由RabbitMQ生成队列名称\n</code></pre>\n<p>先运行三个消费者代码开始监听队列消息。再运行生产者代码。</p>\n<p><img alt=\"image-20251224095706977\" src=\"https://qiniu-cdn.zhaorong.pro/images/image-20251224095706977.png\" /></p>\n<p>消费者1、消费者2队列名称都是手动指定的<code>demo.event.queue</code></p>\n<p><img alt=\"image-20251224100057698\" src=\"https://qiniu-cdn.zhaorong.pro/images/image-20251224100057698.png\" /></p>\n<p><img alt=\"image-20251224100156036\" src=\"https://qiniu-cdn.zhaorong.pro/images/image-20251224100156036.png\" /></p>\n<p>消费者3队列名称是服务端生成的<code>amq.gen-vFbhNYiLf4wDdKNdmP2WzQ</code></p>\n<p><img alt=\"image-20251224100224317\" src=\"https://qiniu-cdn.zhaorong.pro/images/image-20251224100224317.png\" /></p>\n<p>在生产者发送一条消息 Hello, World!，我们再看下接收情况</p>\n<p><img alt=\"image-20251224100318229\" src=\"https://qiniu-cdn.zhaorong.pro/images/image-20251224100318229.png\" /></p>\n<p><img alt=\"image-20251224100336766\" src=\"https://qiniu-cdn.zhaorong.pro/images/image-20251224100336766.png\" /></p>\n<p><img alt=\"image-20251224100354209\" src=\"https://qiniu-cdn.zhaorong.pro/images/image-20251224100354209.png\" /></p>\n<p>消费者1、3收到消息，消费者2没有收到，再发一条Second message.</p>\n<p><img alt=\"image-20251224100501768\" src=\"https://qiniu-cdn.zhaorong.pro/images/image-20251224100501768.png\" /></p>\n<p><img alt=\"image-20251224100518730\" src=\"https://qiniu-cdn.zhaorong.pro/images/image-20251224100518730.png\" /></p>\n<p><img alt=\"image-20251224100542351\" src=\"https://qiniu-cdn.zhaorong.pro/images/image-20251224100542351.png\" /></p>\n<p>消费者2、3收到消息，消费者1没有收到。</p>\n<p>结论是：<strong>目标达成。</strong></p>\n<h3 id=\"三java--maven--amqp-client\">三、Java + Maven + amqp-client</h3>\n<h3 id=\"1依赖包-1\">1、依赖包</h3>\n<p>com.rabbitmq:amqp-client，版本号根据实际需要选择</p>\n<p>使用Maven工具安装或者直接在pom.xml里添加</p>\n<pre><code class=\"language-xml\">&lt;dependencies&gt;\n&nbsp;&nbsp;&lt;dependency&gt;\n&nbsp; &nbsp;&nbsp;&lt;groupId&gt;com.rabbitmq&lt;/groupId&gt;\n&nbsp; &nbsp;&nbsp;&lt;artifactId&gt;amqp-client&lt;/artifactId&gt;\n&nbsp; &nbsp;&nbsp;&lt;version&gt;5.25.0&lt;/version&gt;\n&nbsp;&nbsp;&lt;/dependency&gt;\n&lt;/dependencies&gt;\n</code></pre>\n<h4 id=\"2生产者代码-1\">2、生产者代码</h4>\n<pre><code class=\"language-java\">public class Main {\n    public static void main(String[] args) throws Exception {\n        var factory = new ConnectionFactory();\n        factory.setHost(\"127.0.0.1\");\n        factory.setUsername(\"guest\");\n        factory.setPassword(\"guest\");\n        var connection = factory.newConnection();\n        var channel = connection.createChannel();\n        channel.exchangeDeclare(\"demo.event\", \"fanout\", true, true, null);\n\n        while (true) {\n            var message = java.lang.IO.readln();\n            var properties = new AMQP.BasicProperties.Builder().build();\n            channel.basicPublish(\"demo.event\", \"\", true, properties, message.getBytes());\n            System.out.println(\" [x] Sent '\" + message + \"'\");\n        }\n    }\n}\n</code></pre>\n<h4 id=\"3消费者代码-1\">3、消费者代码</h4>\n<pre><code class=\"language-java\">public class Main {\n    public static void main(String[] args) throws Exception {\n        String recipientName = args[0];\n        String queueName = args.length &gt; 1 ? args[1] : \"\";\n\n        var factory = new com.rabbitmq.client.ConnectionFactory();\n        factory.setHost(\"127.0.0.1\");\n        factory.setUsername(\"guest\");\n        factory.setPassword(\"guest\");\n\n        var connection = factory.newConnection();\n        var channel = connection.createChannel();\n        channel.exchangeDeclare(\"demo.event\", \"fanout\", true, true, null);\n        if (queueName == null || queueName.isEmpty()) {\n            queueName = channel.queueDeclare().getQueue();\n        } else {\n            queueName = channel.queueDeclare(queueName, true, false, true, null).getQueue();\n        }\n\n        System.out.println(recipientName + \": \" + queueName);\n\n        channel.queueBind(queueName, \"demo.event\", \"\");\n\n        var consumer = new com.rabbitmq.client.DeliverCallback() {\n            @Override\n            public void handle(String consumerTag, com.rabbitmq.client.Delivery delivery)\n                    throws java.io.IOException {\n                var message = new String(delivery.getBody(), \"UTF-8\");\n                System.out.println(\" [x] Received '\" + message + \"'\");\n            }\n        };\n\n        channel.basicConsume(queueName, true, consumer, consumerTag -&gt; {\n        });\n\n    }\n}\n</code></pre>\n<p>消费者必须包含一个入参，用于指定当前消费者的名称，第二个参数可选，用于指定队列名称，如果不指定则由服务器生成。</p>\n<p>因为只是做个demo帮助理解，图个方便这里面没有做任何的封装处理，都是直来直去的。其中有些参数根据实际应用场景灵活调整，比如是否自动删除队列和交换机，是否需要持久化消息等等。</p>\n<h4 id=\"3测试结果\">3、测试结果</h4>\n<p>操作步骤</p>\n<ol>\n<li>消费者代码导出成jar包recipient.jar。</li>\n<li>通过以下指令启动三个消费者，其中消费者1、2指定队列名称demo.event.queue。</li>\n</ol>\n<pre><code class=\"language-bash\">java -jar recipient.jar 消费者1 demo.event.queue\njava -jar recipient.jar 消费者2 demo.event.queue\njava -jar recipient.jar 消费者3\n</code></pre>\n<ol start=\"3\">\n<li>运行生产者端代码并发送消息。</li>\n</ol>\n<p>具体的截图我就不贴了，结论是和上面.net版本的一样。</p>\n<h3 id=\"四补充\">四、补充</h3>\n<p>因为RabbitMQ是跟开发平台无关的中间件，生产者端和消费者端可以采用任何语言开发，因此上面两种语言的例子可以混合运行，生产者端也可以同时运行多个，效果是一样的，不论哪种语言编写的客户端，只要queue相同RabbitMQ始终都只会锁定一个消费者实例进行投递。</p>\n<p>上一篇简单讲了RabbitMQ的四种主要 Exchange 类型，其中有一个<strong>Topic</strong>类型，它的特点是使用通配符（<code>*</code> 匹配一个词，<code>#</code> 匹配零个或多个词）与消费者的RoutingKey进行模式匹配路由，而我们的demo里面采用的<strong>Fanout</strong>类型的特点是完全忽略RoutingKey。</p>\n<p>咱们思索一个问题，什么场景下可以用<strong>Fanout</strong>、什么场景下该用<strong>Topic</strong>？</p>\n<hr />\n<p><strong>点关注，不迷路。</strong></p>\n<p>如果您喜欢这篇文章，请不要忘记<strong>点赞、关注、投币、转发</strong>，谢谢！如果您有任何高见，欢迎在评论区留言讨论……</p>\n<p><img alt=\"公众号\" src=\"https://qiniu-cdn.zhaorong.pro/images/gongzhonghao.png\" /></p>\n\n</div>\n<div class=\"clear\"></div>\n\n            </div>\n            <div class=\"postDesc\">posted @ \n<span id=\"post-date\">2025-12-25 08:45</span>&nbsp;\n<a href=\"https://www.cnblogs.com/zhaorong\">中华人民共和国程序员</a>&nbsp;\n阅读(<span id=\"post_view_count\">63</span>)&nbsp;\n评论(<span id=\"post_comment_count\">0</span>)&nbsp;\n&nbsp;\n<a href=\"\">收藏</a>&nbsp;\n<a href=\"\">举报</a>\n</div>"
    },
    {
      "title": "所有64位WinForm应用都是Chromium浏览器",
      "link": "https://www.cnblogs.com/sunhui/p/19395609",
      "published": "",
      "description": "<h1 class=\"postTitle\"><a class=\"postTitle2 vertical-middle\" href=\"https://www.cnblogs.com/sunhui/p/19395609\" id=\"cb_post_title_url\" title=\"发布于 2025-12-25 08:04\">\n    <span>所有64位WinForm应用都是Chromium浏览器</span>\n    \n\n</a>\n</h1>\n\t    <div id=\"cnblogs_post_description\" style=\"display: none;\">\n        \n        如果您是桌面应用开发者，或者一个Web应用开发者，您会面对一个全新的视角，那就是64位WinForm应用直接可以成为Chrome一样的浏览器，但拥有更大的Web内容维度。这一个描述，并不需要您重构exe，仅需要您换一个视角，您会不会觉得非常的有趣？\n    </div>\n<div class=\"blogpost-body blogpost-body-html\" id=\"cnblogs_post_body\">\n<p><span style=\"font-size: 2em;\">为什么纠结？</span></p>\n<p>所有64位<strong>WinForm/MFC/WPF</strong>应用都是<strong>Chromium</strong>浏览器，这一个技术完成于“<strong>非典疫情</strong>”期间，因为当时无事可做，只能被困在家里。那个时期Chromium的版本是M81，因为疫情严重，Chrome团队放弃了M82、83，直接发布了M84。</p>\n<p>&nbsp;</p>\n<p>直到2022年，LLM开始火爆，软件应用领域开始“洗牌”了，有很多朋友私下问我，怎么看LLM，实话实说，我当时对LLM一无所知，对其的了解仅仅是停留在看新闻的层次。去年的时候，一个偶然的机会，开始使用DeepSeek、ChatGPT。于是我就将这一个想法分别提交给这两个大神，向看看它们的看法。结果非常的有意思，它们首先都认为：“这太荒谬，人家自己编译的桌面应用，例如一个WinForm应用，你怎么可以说它就是‘<strong>Chromium浏览器</strong>’”？紧接着，它们都会为我出主意，并且给我写了很多“方案”，帮助我如何实现这一个离奇的想法，其中不妨有一部分代码，看上去“很正经”，颇有大师的风范。</p>\n<p>&nbsp;</p>\n<p>在与ChatGPT、DeepSeek长达10个月的不断沟通之中，我的确学会了很多，也看到了很多难以置信的事情。它们对<strong>Chromium Project</strong>这一个尺度的项目（不低于30000000行源代码）的了解深度，其实非常的让人震撼，这的确会让我们看到了今后必然发生的事情，那就是：职业软件开发者今后会面临着什么，这一种感受，绝对不是它们可以为你“写一些代码”，而是它们很有可能会深度的替代你。</p>\n<p>&nbsp;</p>\n<p>“桌面应用即现代浏览器”，是最近一年与DeepSeek、ChatGPT深入沟通的最终设想。虽然看上去非常的离经叛道，但这就是我们即将面对的事情。对很多开发者，特别是WinForm、MFC这方面的开发者，对这一个结论的想法是：</p>\n<p>1、 我的应用，并没有嵌入CEF、WebView2，怎么可能是“浏览器”；</p>\n<p>2、 你并没有我的源代码，你如何让我的应用成为真真正正的浏览器？</p>\n<p>3、 我自己的应用运行的很好，我为什么要让自己的应用成为浏览器？</p>\n<p>当然，还会有很多很多的问题，完全都可以理解。其实，这些问题，是一个很难回答的问题。所以我会换一个视角，那就是，你的应用如果就是浏览器，会为你带来什么价值：</p>\n<p>1、 Chrome、Edge的Web生态，直接就是你应用生态的一部分，这没什么不好；</p>\n<p>2、 当今最好的AI、Web技术，都会在你的应用之中畅行无阻，您会不会拒绝？</p>\n<p>3、 你的应用可以充分的调度各种各样的原生应用组件、Web组件，为你产生无穷无尽的价值，您有可能不需要，但您的客户会需要，您的朋友也一样；</p>\n<p>4、 您的应用不需要修改源代码，您的工作流程一如既往，没有任何改变，不同的是，您可以直接为您编译的exe写Web生态，就如同您面对Chrome一模一样。</p>\n<p>当然，您是否接受，是另外一回事。只不过，当您的应用交付用户的时候，您的客户很可能会愿意接受，因为，他们的很多一眼可见的需求，会直接叠加到您的应用之上，所以，他们会认为这是您为他们提供的“福利”，自然会为您点赞。</p>\n<h1>我的应用已经嵌入了CEF/WebView2</h1>\n<p>这是一个很好的问题！我们没有贬低CEF、WebView2，我们会一直为这两个经典点赞、喝彩。不同的是，这些“天花板”级别的神器，需要您在设计阶段耗费精力，您必须选择一个合适的窗体，并在这一个窗体之中为其开辟一个特权“矩形”，将其隆重的迎接进来，同时您还需要为其做特别的初始化、设计接口……。但问题是：如果您的产品交付了之后，用户希望在另外一个窗口之中显示一个设计环节没有的页面，您会怎么办？打开源代码、加入新的设计、重新编译？</p>\n<p>&nbsp;</p>\n<p>一个有意思的问题是，您嵌入了CEF等，性能代价是一回事，但您获得的并不是“浏览器”，而仅仅是一个“数字展板”（这一个说法来自于‘DeepSeek’）。</p>\n<h1>你的应用原本就是浏览器</h1>\n<p>您可能会奇怪，如果是：我怎么就不知道？难道说，我的应用是一架飞机，而我一直将其看作是只有轮子的汽车，一直在用轮子驱动，让其在“陆地”上行走，而一直没有起飞？</p>\n<p>&nbsp;</p>\n<p>或许，这就是我们写《爱丽丝漫游桌面开发奇境记》的原因。其实，爱丽丝是不相信的，所以她设计了一个“反作弊”的myApp，具体详见“<a href=\"https://www.cnblogs.com/sunhui/p/19391507\">《爱丽丝漫游桌面应用开发奇境记》（1）</a>”。爱丽丝的myApp，仅有一个WinForm窗体Form1，其中仅包含一个panel，一个button，一行代码都没写：</p>\n<p align=\"center\"><img alt=\"\" src=\"https://img2024.cnblogs.com/blog/9494/202512/9494-20251225080336793-383572548.png\" />&nbsp;</p>\n<p>她单纯的想法是在这一个窗体之中，“彻底堵死”显示“Web页面”的所有可能性。结果，她在这一个“一张白纸”性质的应用之中看到了无穷无尽的可能性：</p>\n<p align=\"center\"><img alt=\"\" src=\"https://img2024.cnblogs.com/blog/9494/202512/9494-20251225080336804-1237221424.png\" />&nbsp;</p>\n<p>以及：</p>\n<p align=\"center\">&nbsp;</p>\n<p align=\"center\">&nbsp;<img alt=\"\" src=\"https://img2024.cnblogs.com/blog/9494/202512/9494-20251225080336932-1861319022.png\" /></p>\n<p align=\"center\"><img alt=\"\" height=\"523\" src=\"https://img2024.cnblogs.com/blog/9494/202512/9494-20251225075612393-2073989663.png\" width=\"802\" /></p>\n<p>这意味着，她最简单的窗体，拥有强大的基于Web逻辑组合各种各样“控件、窗体”的能力。不仅如此，她的应用之中，可以让你直接构造形形色色的“超级浏览器窗口”：</p>\n<p align=\"center\"><img alt=\"\" src=\"https://img2024.cnblogs.com/blog/9494/202512/9494-20251225080336804-429645902.png\" />&nbsp;</p>\n<p align=\"center\"><img alt=\"\" src=\"https://img2024.cnblogs.com/blog/9494/202512/9494-20251225080336824-1272716157.png\" /></p>\n<p align=\"center\"><img alt=\"\" src=\"https://img2024.cnblogs.com/blog/9494/202512/9494-20251225080336822-1096573424.png\" /></p>\n<p align=\"center\" style=\"text-align: left;\">那么，你可以直接写任意数量如下所示的“超级页面”：</p>\n<p align=\"center\"><img alt=\"\" src=\"https://img2024.cnblogs.com/blog/9494/202512/9494-20251225080336906-980697868.png\" />&nbsp;</p>\n<p>爱丽丝的实验，给我们带来一个有趣的问题，那就是：我们应该如何面对这些突如其来的“潜能”。</p>\n<p>当我们将这一切提交给DeepSeek、ChatGPT的时候，它们最初认为这些都是“杜撰”的，因为，在它们的训练数据之中，完全没有这些。</p>\n<p>&nbsp;</p>\n<p>后来，通过不断的变更“提示词”，它们意识到，这大概是“荒诞的新鲜事儿”，差不多属于“内容涌现”、动态赋能。与当下的AI发展趋势“不谋而合”。</p>\n<p>&nbsp;</p>\n<p>我们应该怎么面对我们自己编译生成的exe？如果我们仅仅认为，这些exe就应该完美的执行我们“预设的应用逻辑”，这一点完全没有问题，但会不会就此“封印”？当然不是！所以我们会竭尽所能，为我们自己的应用增加各种灵活的“插件机制”，这不仅仅是我们技能的展现，也是体现用户价值的关键。</p>\n<p>&nbsp;</p>\n<p>但现在，新的问题来了，你的应用本身就是应该“<strong>巨大的Web、AI</strong>”的支撑体，您将如何面对？</p>\n<h1>所有64位WinForm应用都是超级浏览器，无需修改源代码、不需要重新编译</h1>\n<p>这是一个“近乎绝对化”的结论，不取决于您如何写代码，仅取决于您如何对待您的编译所得。那么，您的态度会不会变化？这是我们近期会提交的“开源项目”，也是面对日新月异的AI、Web技术，给出的一个策略、应对方式。</p>\n<p>&nbsp;</p>\n<p>如果浏览器市场，仅仅有数量极为有限的玩家，会不会非常的寂寞？如果所有的WinForm、MFC、WPF都可以是足以媲美Chrome、Edge的浏览器，但拥有的Web内容维度更高，会不会很有意思。</p>\n<p>&nbsp;</p>\n<p>浏览器机制，本身不是寡头的特权，而是你编译之后exe的运行形态之一，是你应用的一个可选择的“角色”，就如同你自己拥有很多不同的身份一样。</p>\n<p>&nbsp;</p>\n<p>当你意识到，你的exe，不再刚性十足，而是可以接受额外的“文本”描述意图，这意味着，你可以为你的exe提供“提示词”，它们会为你“作答”，这是一种“双向沟通”的意图体现，这一个能力，不应该是主流浏览器独享的，而是一个“普惠”的机制，你不需要“神奇的”代码，您需要的仅仅是一个“视角微调”，如此，智能涌现，就会近在咫尺。</p>\n<h1>如果您对“桌面即浏览器”感兴趣</h1>\n<p>如果您对64位桌面应用即浏览器感兴趣，可以关注如下超链接：</p>\n<p>1、 <a href=\"https://www.cnblogs.com/sunhui/p/19391507\">问世间，exe是何物？直教AI沉默、Web寡言（1）- 博客园</a></p>\n<p>2、 <a href=\"https://www.cnblogs.com/sunhui/p/19392696\">问世间，exe是何物？直教AI沉默、Web寡言 （2）- 博客园</a></p>\n<p>3、<a href=\"https://www.cnblogs.com/sunhui/p/19395909\">问世间，exe是何物？直教AI沉默、Web寡言（3） -&nbsp; 博客园</a></p>\n<p>以及后续的连载，其中有下载地址以及相关的细节介绍。</p>\n</div>\n<div class=\"clear\"></div>\n\n\t<div class=\"postDesc\">posted on \n<span id=\"post-date\">2025-12-25 08:04</span>&nbsp;\n<a href=\"https://www.cnblogs.com/sunhui\">Exe2WebBrowser</a>&nbsp;\n阅读(<span id=\"post_view_count\">376</span>)&nbsp;\n评论(<span id=\"post_comment_count\">3</span>)&nbsp;\n&nbsp;\n<a href=\"\">收藏</a>&nbsp;\n<a href=\"\">举报</a>\n</div>"
    },
    {
      "title": "掌握 PHP Attributes 从自定义创建到生产实现",
      "link": "https://www.cnblogs.com/catchadmin/p/19395584",
      "published": "",
      "description": "<h1 class=\"postTitle\">\n                <a class=\"postTitle2 vertical-middle\" href=\"https://www.cnblogs.com/catchadmin/p/19395584\" id=\"cb_post_title_url\" title=\"发布于 2025-12-25 07:57\">\n    <span>掌握 PHP Attributes 从自定义创建到生产实现</span>\n    \n\n</a>\n\n            </h1>\n            <div class=\"clear\"></div>\n            <div class=\"postBody\">\n                <div class=\"blogpost-body cnblogs-markdown\" id=\"cnblogs_post_body\">\n<h1 id=\"掌握-php-attributes-从自定义创建到生产实现\">掌握 PHP Attributes 从自定义创建到生产实现</h1>\n<h2 id=\"引言php-元数据编程的现代时代\">引言:PHP 元数据编程的现代时代</h2>\n<p>PHP 8.0 引入了原生 Attributes(以前称为注解),彻底改变了我们编写声明式代码的方式。Attributes 实现了优雅的元数据驱动编程,用结构化、类型安全的声明替代了 docblock 注解。本综合指南将探讨自定义 Attributes、Reflection API 集成、基于 Attribute 的路由以及验证系统。</p>\n<p><a href=\"https://catchadmin.com/post/2025-12/mastering-php-attributes-from-custom-creation-to-production-implementation\" rel=\"noopener nofollow\" target=\"_blank\">原文链接 掌握 PHP Attributes 从自定义创建到生产实现</a></p>\n<h2 id=\"第一部分自定义-attributes构建你自己的元数据层\">第一部分:自定义 Attributes——构建你自己的元数据层</h2>\n<h3 id=\"理解-php-attributes-基础\">理解 PHP Attributes 基础</h3>\n<p>PHP Attributes 是用 <code>#[Attribute]</code> 标记的特殊类,可以附加到类、方法、属性、参数和常量上。与注释不同,它们是 AST(抽象语法树)的一部分,可通过 Reflection 访问。</p>\n<h3 id=\"创建生产级自定义-attribute\">创建生产级自定义 Attribute</h3>\n<p>让我们为企业应用构建一个全面的日志 Attribute 系统:</p>\n<pre><code class=\"language-php\">&lt;?php\n\n#[Attribute(Attribute::TARGET_METHOD | Attribute::TARGET_CLASS | Attribute::IS_REPEATABLE)]\nclass AuditLog\n{\n    public function __construct(\n        public string $operation,\n        public LogLevel $level = LogLevel::INFO,\n        public bool $includeParameters = true,\n        public bool $includeReturnValue = false,\n        public array $sensitiveParameters = []\n    ) {}\n}\n\nenum LogLevel: string\n{\n    case TRACE = 'trace';\n    case DEBUG = 'debug';\n    case INFO = 'info';\n    case WARNING = 'warning';\n    case ERROR = 'error';\n    case CRITICAL = 'critical';\n}\n</code></pre>\n<h3 id=\"进阶用法属性级验证-attribute\">进阶用法:属性级验证 Attribute</h3>\n<p>这是一个用于属性级验证的自定义 Attribute,支持复杂规则:</p>\n<pre><code class=\"language-php\">&lt;?php\n\n#[Attribute(Attribute::TARGET_PROPERTY | Attribute::IS_REPEATABLE)]\nclass BusinessRule\n{\n    public function __construct(\n        public string $ruleName,\n        public string $errorMessage = '',\n        public int $priority = 0\n    ) {\n        if (empty($this-&gt;errorMessage)) {\n            $this-&gt;errorMessage = \"Business rule '{$ruleName}' validation failed\";\n        }\n    }\n}\n\n#[Attribute(Attribute::TARGET_PROPERTY)]\nclass CreditCardValidation extends BusinessRule\n{\n    public function __construct(\n        public array $acceptedCardTypes = ['Visa', 'MasterCard', 'Amex'],\n        public bool $requireCVV = true,\n        string $errorMessage = 'Invalid credit card'\n    ) {\n        parent::__construct('CreditCardValidation', $errorMessage);\n    }\n}\n\n#[Attribute(Attribute::TARGET_PROPERTY)]\nclass EmailValidation\n{\n    public function __construct(\n        public bool $checkDNS = false,\n        public array $allowedDomains = [],\n        public string $errorMessage = 'Invalid email address'\n    ) {}\n}\n</code></pre>\n<h3 id=\"实际应用示例\">实际应用示例</h3>\n<pre><code class=\"language-php\">&lt;?php\n\n#[Attribute(Attribute::TARGET_METHOD)]\nclass Transaction\n{\n    public function __construct(\n        public string $isolationLevel = 'SERIALIZABLE'\n    ) {}\n}\n\n#[Attribute(Attribute::TARGET_METHOD)]\nclass RetryPolicy\n{\n    public function __construct(\n        public int $maxAttempts = 3,\n        public int $delayMilliseconds = 1000,\n        public array $retryOnExceptions = []\n    ) {}\n}\n\nclass PaymentProcessor\n{\n    #[AuditLog(\n        operation: 'ProcessPayment',\n        level: LogLevel::CRITICAL,\n        sensitiveParameters: ['creditCardNumber', 'cvv']\n    )]\n    #[Transaction(isolationLevel: 'SERIALIZABLE')]\n    #[RetryPolicy(maxAttempts: 3, delayMilliseconds: 1000)]\n    public function processPayment(\n        float $amount,\n        string $creditCardNumber,\n        string $cvv\n    ): PaymentResult {\n        // Implementation\n        return new PaymentResult();\n    }\n}\n</code></pre>\n<h2 id=\"第二部分reflection-api在运行时读取和处理-attributes\">第二部分:Reflection API——在运行时读取和处理 Attributes</h2>\n<h3 id=\"基础reflection-与-attribute-发现\">基础:Reflection 与 Attribute 发现</h3>\n<p>PHP 的 Reflection API 提供了强大的工具来在运行时检查和操作 Attributes。这是一个全面的 Attribute 处理器:</p>\n<pre><code class=\"language-php\">&lt;?php\n\nclass AttributeProcessor\n{\n    /**\n     * Get all attributes of a specific type from a class\n     */\n    public static function getClassAttributes(string $className, string $attributeClass): array\n    {\n        $reflection = new ReflectionClass($className);\n        $attributes = $reflection-&gt;getAttributes($attributeClass, ReflectionAttribute::IS_INSTANCEOF);\n        \n        return array_map(fn($attr) =&gt; $attr-&gt;newInstance(), $attributes);\n    }\n    \n    /**\n     * Get attributes from all methods in a class\n     */\n    public static function getMethodAttributes(string $className, string $attributeClass): array\n    {\n        $reflection = new ReflectionClass($className);\n        $result = [];\n        \n        foreach ($reflection-&gt;getMethods() as $method) {\n            $attributes = $method-&gt;getAttributes($attributeClass, ReflectionAttribute::IS_INSTANCEOF);\n            \n            if (!empty($attributes)) {\n                $result[$method-&gt;getName()] = array_map(\n                    fn($attr) =&gt; $attr-&gt;newInstance(),\n                    $attributes\n                );\n            }\n        }\n        \n        return $result;\n    }\n    \n    /**\n     * Get attributes from properties\n     */\n    public static function getPropertyAttributes(string $className, string $attributeClass): array\n    {\n        $reflection = new ReflectionClass($className);\n        $result = [];\n        \n        foreach ($reflection-&gt;getProperties() as $property) {\n            $attributes = $property-&gt;getAttributes($attributeClass, ReflectionAttribute::IS_INSTANCEOF);\n            \n            if (!empty($attributes)) {\n                $result[$property-&gt;getName()] = array_map(\n                    fn($attr) =&gt; $attr-&gt;newInstance(),\n                    $attributes\n                );\n            }\n        }\n        \n        return $result;\n    }\n}\n</code></pre>\n<h3 id=\"构建-attribute-驱动的拦截器\">构建 Attribute 驱动的拦截器</h3>\n<p>这是使用 Reflection 实现审计日志拦截器的实际示例:</p>\n<pre><code class=\"language-php\">&lt;?php\n\nclass AuditLogInterceptor\n{\n    private LoggerInterface $logger;\n    \n    public function __construct(LoggerInterface $logger)\n    {\n        $this-&gt;logger = $logger;\n    }\n    \n    public function intercept(object $target, string $method, array $arguments): mixed\n    {\n        $reflection = new ReflectionMethod($target, $method);\n        $attributes = $reflection-&gt;getAttributes(AuditLog::class);\n        \n        if (empty($attributes)) {\n            return $target-&gt;$method(...$arguments);\n        }\n        \n        foreach ($attributes as $attribute) {\n            $auditLog = $attribute-&gt;newInstance();\n            $this-&gt;logBefore($auditLog, $method, $arguments, $reflection);\n        }\n        \n        $startTime = microtime(true);\n        \n        try {\n            $result = $target-&gt;$method(...$arguments);\n            $executionTime = microtime(true) - $startTime;\n            \n            foreach ($attributes as $attribute) {\n                $auditLog = $attribute-&gt;newInstance();\n                $this-&gt;logAfter($auditLog, $method, $result, $executionTime);\n            }\n            \n            return $result;\n        } catch (Throwable $e) {\n            foreach ($attributes as $attribute) {\n                $auditLog = $attribute-&gt;newInstance();\n                $this-&gt;logError($auditLog, $method, $e);\n            }\n            throw $e;\n        }\n    }\n    \n    private function logBefore(AuditLog $audit, string $method, array $arguments, ReflectionMethod $reflection): void\n    {\n        $logData = [\n            'operation' =&gt; $audit-&gt;operation,\n            'method' =&gt; $method,\n            'timestamp' =&gt; date('Y-m-d H:i:s'),\n        ];\n        \n        if ($audit-&gt;includeParameters) {\n            $params = $reflection-&gt;getParameters();\n            $sanitizedArgs = [];\n            \n            foreach ($params as $index =&gt; $param) {\n                $paramName = $param-&gt;getName();\n                $value = $arguments[$index] ?? null;\n                \n                if (in_array($paramName, $audit-&gt;sensitiveParameters)) {\n                    $sanitizedArgs[$paramName] = '***REDACTED***';\n                } else {\n                    $sanitizedArgs[$paramName] = $value;\n                }\n            }\n            \n            $logData['parameters'] = $sanitizedArgs;\n        }\n        \n        $this-&gt;logger-&gt;log($audit-&gt;level-&gt;value, \"Executing: {$audit-&gt;operation}\", $logData);\n    }\n    \n    private function logAfter(AuditLog $audit, string $method, mixed $result, float $executionTime): void\n    {\n        $logData = [\n            'operation' =&gt; $audit-&gt;operation,\n            'method' =&gt; $method,\n            'execution_time' =&gt; round($executionTime * 1000, 2) . 'ms',\n        ];\n        \n        if ($audit-&gt;includeReturnValue) {\n            $logData['return_value'] = $result;\n        }\n        \n        $this-&gt;logger-&gt;log($audit-&gt;level-&gt;value, \"Completed: {$audit-&gt;operation}\", $logData);\n    }\n    \n    private function logError(AuditLog $audit, string $method, Throwable $e): void\n    {\n        $this-&gt;logger-&gt;log(LogLevel::ERROR-&gt;value, \"Failed: {$audit-&gt;operation}\", [\n            'operation' =&gt; $audit-&gt;operation,\n            'method' =&gt; $method,\n            'error' =&gt; $e-&gt;getMessage(),\n            'trace' =&gt; $e-&gt;getTraceAsString(),\n        ]);\n    }\n}\n</code></pre>\n<h3 id=\"使用-attributes-的动态代理模式\">使用 Attributes 的动态代理模式</h3>\n<pre><code class=\"language-php\">&lt;?php\n\nclass AttributeProxy\n{\n    private object $target;\n    private AuditLogInterceptor $interceptor;\n    \n    public function __construct(object $target, AuditLogInterceptor $interceptor)\n    {\n        $this-&gt;target = $target;\n        $this-&gt;interceptor = $interceptor;\n    }\n    \n    public function __call(string $method, array $arguments): mixed\n    {\n        $reflection = new ReflectionClass($this-&gt;target);\n        \n        if (!$reflection-&gt;hasMethod($method)) {\n            throw new BadMethodCallException(\"Method {$method} does not exist\");\n        }\n        \n        $methodReflection = $reflection-&gt;getMethod($method);\n        $attributes = $methodReflection-&gt;getAttributes(AuditLog::class);\n        \n        if (!empty($attributes)) {\n            return $this-&gt;interceptor-&gt;intercept($this-&gt;target, $method, $arguments);\n        }\n        \n        return $this-&gt;target-&gt;$method(...$arguments);\n    }\n}\n\n// Usage\n$processor = new PaymentProcessor();\n$logger = new Logger();\n$interceptor = new AuditLogInterceptor($logger);\n$proxy = new AttributeProxy($processor, $interceptor);\n\n// This call will be intercepted and logged\n$result = $proxy-&gt;processPayment(100.00, '4111111111111111', '123');\n</code></pre>\n<h2 id=\"第三部分attribute-驱动的路由系统\">第三部分:Attribute 驱动的路由系统</h2>\n<h3 id=\"路由-attributes-定义\">路由 Attributes 定义</h3>\n<pre><code class=\"language-php\">&lt;?php\n\n#[Attribute(Attribute::TARGET_METHOD | Attribute::TARGET_CLASS)]\nclass Route\n{\n    public function __construct(\n        public string $path,\n        public string $method = 'GET',\n        public array $middleware = [],\n        public ?string $name = null\n    ) {}\n}\n\n#[Attribute(Attribute::TARGET_CLASS)]\nclass RoutePrefix\n{\n    public function __construct(\n        public string $prefix,\n        public array $middleware = []\n    ) {}\n}\n\n#[Attribute(Attribute::TARGET_PARAMETER)]\nclass FromBody\n{\n    public function __construct(\n        public ?string $validator = null\n    ) {}\n}\n\n#[Attribute(Attribute::TARGET_PARAMETER)]\nclass FromQuery\n{\n    public function __construct(\n        public ?string $name = null,\n        public mixed $default = null\n    ) {}\n}\n\n#[Attribute(Attribute::TARGET_PARAMETER)]\nclass FromRoute\n{\n    public function __construct(\n        public string $parameter\n    ) {}\n}\n</code></pre>\n<h3 id=\"路由注册器实现\">路由注册器实现</h3>\n<pre><code class=\"language-php\">&lt;?php\n\nclass RouteRegistry\n{\n    private array $routes = [];\n    \n    public function register(string $controllerClass): void\n    {\n        $reflection = new ReflectionClass($controllerClass);\n        \n        // Get class-level prefix and middleware\n        $prefixAttributes = $reflection-&gt;getAttributes(RoutePrefix::class);\n        $prefix = '';\n        $classMiddleware = [];\n        \n        if (!empty($prefixAttributes)) {\n            $routePrefix = $prefixAttributes[0]-&gt;newInstance();\n            $prefix = $routePrefix-&gt;prefix;\n            $classMiddleware = $routePrefix-&gt;middleware;\n        }\n        \n        // Process each method\n        foreach ($reflection-&gt;getMethods(ReflectionMethod::IS_PUBLIC) as $method) {\n            $routeAttributes = $method-&gt;getAttributes(Route::class);\n            \n            foreach ($routeAttributes as $attribute) {\n                $route = $attribute-&gt;newInstance();\n                \n                $fullPath = $prefix . $route-&gt;path;\n                $middleware = array_merge($classMiddleware, $route-&gt;middleware);\n                \n                $this-&gt;routes[] = [\n                    'method' =&gt; strtoupper($route-&gt;method),\n                    'path' =&gt; $fullPath,\n                    'controller' =&gt; $controllerClass,\n                    'action' =&gt; $method-&gt;getName(),\n                    'middleware' =&gt; $middleware,\n                    'name' =&gt; $route-&gt;name,\n                    'parameters' =&gt; $this-&gt;extractParameters($method),\n                ];\n            }\n        }\n    }\n    \n    private function extractParameters(ReflectionMethod $method): array\n    {\n        $parameters = [];\n        \n        foreach ($method-&gt;getParameters() as $param) {\n            $paramInfo = [\n                'name' =&gt; $param-&gt;getName(),\n                'type' =&gt; $param-&gt;getType()?-&gt;getName(),\n                'source' =&gt; 'auto',\n            ];\n            \n            // Check for parameter attributes\n            $fromBodyAttrs = $param-&gt;getAttributes(FromBody::class);\n            $fromQueryAttrs = $param-&gt;getAttributes(FromQuery::class);\n            $fromRouteAttrs = $param-&gt;getAttributes(FromRoute::class);\n            \n            if (!empty($fromBodyAttrs)) {\n                $paramInfo['source'] = 'body';\n                $paramInfo['validator'] = $fromBodyAttrs[0]-&gt;newInstance()-&gt;validator;\n            } elseif (!empty($fromQueryAttrs)) {\n                $fromQuery = $fromQueryAttrs[0]-&gt;newInstance();\n                $paramInfo['source'] = 'query';\n                $paramInfo['queryName'] = $fromQuery-&gt;name ?? $param-&gt;getName();\n                $paramInfo['default'] = $fromQuery-&gt;default;\n            } elseif (!empty($fromRouteAttrs)) {\n                $fromRoute = $fromRouteAttrs[0]-&gt;newInstance();\n                $paramInfo['source'] = 'route';\n                $paramInfo['routeParam'] = $fromRoute-&gt;parameter;\n            }\n            \n            $parameters[] = $paramInfo;\n        }\n        \n        return $parameters;\n    }\n    \n    public function getRoutes(): array\n    {\n        return $this-&gt;routes;\n    }\n    \n    public function match(string $method, string $path): ?array\n    {\n        foreach ($this-&gt;routes as $route) {\n            if ($route['method'] !== strtoupper($method)) {\n                continue;\n            }\n            \n            $pattern = $this-&gt;pathToRegex($route['path']);\n            \n            if (preg_match($pattern, $path, $matches)) {\n                return [\n                    'route' =&gt; $route,\n                    'params' =&gt; array_filter($matches, 'is_string', ARRAY_FILTER_USE_KEY),\n                ];\n            }\n        }\n        \n        return null;\n    }\n    \n    private function pathToRegex(string $path): string\n    {\n        $pattern = preg_replace('/\\{([a-zA-Z0-9_]+)\\}/', '(?P&lt;$1&gt;[^/]+)', $path);\n        return '#^' . $pattern . '$#';\n    }\n}\n</code></pre>\n<h3 id=\"控制器示例\">控制器示例</h3>\n<pre><code class=\"language-php\">&lt;?php\n\n#[RoutePrefix('/api/users', middleware: ['auth', 'api'])]\nclass UserController\n{\n    #[Route('/', method: 'GET', name: 'users.list')]\n    public function index(\n        #[FromQuery('page', default: 1)] int $page,\n        #[FromQuery('limit', default: 20)] int $limit\n    ): array {\n        return [\n            'users' =&gt; [],\n            'page' =&gt; $page,\n            'limit' =&gt; $limit,\n        ];\n    }\n    \n    #[Route('/{id}', method: 'GET', name: 'users.show')]\n    public function show(#[FromRoute('id')] int $id): array\n    {\n        return ['user' =&gt; ['id' =&gt; $id]];\n    }\n    \n    #[Route('/', method: 'POST', name: 'users.create')]\n    public function create(\n        #[FromBody(validator: UserValidator::class)] UserCreateRequest $request\n    ): array {\n        return ['user' =&gt; ['id' =&gt; 1]];\n    }\n    \n    #[Route('/{id}', method: 'PUT', name: 'users.update')]\n    public function update(\n        #[FromRoute('id')] int $id,\n        #[FromBody] UserUpdateRequest $request\n    ): array {\n        return ['user' =&gt; ['id' =&gt; $id]];\n    }\n    \n    #[Route('/{id}', method: 'DELETE', name: 'users.delete')]\n    public function delete(#[FromRoute('id')] int $id): array\n    {\n        return ['success' =&gt; true];\n    }\n}\n</code></pre>\n<h3 id=\"路由调度器\">路由调度器</h3>\n<pre><code class=\"language-php\">&lt;?php\n\nclass Router\n{\n    private RouteRegistry $registry;\n    private Container $container;\n    \n    public function __construct(RouteRegistry $registry, Container $container)\n    {\n        $this-&gt;registry = $registry;\n        $this-&gt;container = $container;\n    }\n    \n    public function dispatch(string $method, string $path): mixed\n    {\n        $match = $this-&gt;registry-&gt;match($method, $path);\n        \n        if ($match === null) {\n            http_response_code(404);\n            return ['error' =&gt; 'Route not found'];\n        }\n        \n        $route = $match['route'];\n        $routeParams = $match['params'];\n        \n        // Run middleware\n        foreach ($route['middleware'] as $middleware) {\n            $this-&gt;runMiddleware($middleware);\n        }\n        \n        // Resolve controller\n        $controller = $this-&gt;container-&gt;resolve($route['controller']);\n        \n        // Prepare method arguments\n        $arguments = $this-&gt;prepareArguments($route['parameters'], $routeParams);\n        \n        // Call controller method\n        return $controller-&gt;{$route['action']}(...$arguments);\n    }\n    \n    private function prepareArguments(array $parameters, array $routeParams): array\n    {\n        $arguments = [];\n        \n        foreach ($parameters as $param) {\n            $value = match($param['source']) {\n                'body' =&gt; $this-&gt;getBodyParameter($param),\n                'query' =&gt; $this-&gt;getQueryParameter($param),\n                'route' =&gt; $routeParams[$param['routeParam']] ?? null,\n                default =&gt; null,\n            };\n            \n            $arguments[] = $value;\n        }\n        \n        return $arguments;\n    }\n    \n    private function getBodyParameter(array $param): mixed\n    {\n        $body = json_decode(file_get_contents('php://input'), true);\n        \n        if ($param['type'] &amp;&amp; class_exists($param['type'])) {\n            $instance = new $param['type']();\n            \n            foreach ($body as $key =&gt; $value) {\n                if (property_exists($instance, $key)) {\n                    $instance-&gt;$key = $value;\n                }\n            }\n            \n            return $instance;\n        }\n        \n        return $body;\n    }\n    \n    private function getQueryParameter(array $param): mixed\n    {\n        $queryName = $param['queryName'] ?? $param['name'];\n        return $_GET[$queryName] ?? $param['default'] ?? null;\n    }\n    \n    private function runMiddleware(string $middleware): void\n    {\n        // Middleware implementation\n    }\n}\n</code></pre>\n<h2 id=\"第四部分attribute-驱动的验证系统\">第四部分:Attribute 驱动的验证系统</h2>\n<h3 id=\"验证-attributes\">验证 Attributes</h3>\n<pre><code class=\"language-php\">&lt;?php\n\n#[Attribute(Attribute::TARGET_PROPERTY)]\nclass Required\n{\n    public function __construct(\n        public string $message = 'This field is required'\n    ) {}\n}\n\n#[Attribute(Attribute::TARGET_PROPERTY)]\nclass Length\n{\n    public function __construct(\n        public ?int $min = null,\n        public ?int $max = null,\n        public string $message = ''\n    ) {\n        if (empty($this-&gt;message)) {\n            if ($this-&gt;min &amp;&amp; $this-&gt;max) {\n                $this-&gt;message = \"Length must be between {$this-&gt;min} and {$this-&gt;max}\";\n            } elseif ($this-&gt;min) {\n                $this-&gt;message = \"Minimum length is {$this-&gt;min}\";\n            } elseif ($this-&gt;max) {\n                $this-&gt;message = \"Maximum length is {$this-&gt;max}\";\n            }\n        }\n    }\n}\n\n#[Attribute(Attribute::TARGET_PROPERTY)]\nclass Email\n{\n    public function __construct(\n        public bool $checkDNS = false,\n        public string $message = 'Invalid email address'\n    ) {}\n}\n\n#[Attribute(Attribute::TARGET_PROPERTY)]\nclass Pattern\n{\n    public function __construct(\n        public string $regex,\n        public string $message = 'Invalid format'\n    ) {}\n}\n\n#[Attribute(Attribute::TARGET_PROPERTY)]\nclass Range\n{\n    public function __construct(\n        public ?float $min = null,\n        public ?float $max = null,\n        public string $message = ''\n    ) {\n        if (empty($this-&gt;message)) {\n            if ($this-&gt;min !== null &amp;&amp; $this-&gt;max !== null) {\n                $this-&gt;message = \"Value must be between {$this-&gt;min} and {$this-&gt;max}\";\n            } elseif ($this-&gt;min !== null) {\n                $this-&gt;message = \"Minimum value is {$this-&gt;min}\";\n            } elseif ($this-&gt;max !== null) {\n                $this-&gt;message = \"Maximum value is {$this-&gt;max}\";\n            }\n        }\n    }\n}\n\n#[Attribute(Attribute::TARGET_PROPERTY)]\nclass InArray\n{\n    public function __construct(\n        public array $allowedValues,\n        public string $message = 'Invalid value'\n    ) {}\n}\n\n#[Attribute(Attribute::TARGET_PROPERTY)]\nclass Url\n{\n    public function __construct(\n        public array $allowedSchemes = ['http', 'https'],\n        public string $message = 'Invalid URL'\n    ) {}\n}\n\n#[Attribute(Attribute::TARGET_PROPERTY)]\nclass Date\n{\n    public function __construct(\n        public string $format = 'Y-m-d',\n        public string $message = 'Invalid date format'\n    ) {}\n}\n\n#[Attribute(Attribute::TARGET_PROPERTY)]\nclass Unique\n{\n    public function __construct(\n        public string $table,\n        public string $column,\n        public ?int $ignoreId = null,\n        public string $message = 'This value already exists'\n    ) {}\n}\n\n#[Attribute(Attribute::TARGET_PROPERTY)]\nclass CreditCard\n{\n    public function __construct(\n        public array $types = ['visa', 'mastercard', 'amex', 'discover'],\n        public string $message = 'Invalid credit card number'\n    ) {}\n}\n\n#[Attribute(Attribute::TARGET_CLASS)]\nclass CompareFields\n{\n    public function __construct(\n        public string $field1,\n        public string $field2,\n        public string $operator = '===',\n        public string $message = 'Fields do not match'\n    ) {}\n}\n</code></pre>\n<h3 id=\"增强验证器实现\">增强验证器实现</h3>\n<pre><code class=\"language-php\">&lt;?php\n\nclass EnhancedValidator\n{\n    private array $errors = [];\n    \n    public function validate(object $object): bool\n    {\n        $this-&gt;errors = [];\n        $reflection = new ReflectionClass($object);\n        \n        // Validate properties\n        foreach ($reflection-&gt;getProperties() as $property) {\n            $this-&gt;validateProperty($object, $property);\n        }\n        \n        // Validate class-level rules\n        $this-&gt;validateClassRules($object, $reflection);\n        \n        return empty($this-&gt;errors);\n    }\n    \n    private function validateProperty(object $object, ReflectionProperty $property): void\n    {\n        $property-&gt;setAccessible(true);\n        $value = $property-&gt;getValue($object);\n        $propertyName = $property-&gt;getName();\n        \n        foreach ($property-&gt;getAttributes() as $attribute) {\n            $validator = $attribute-&gt;newInstance();\n            \n            $isValid = match($attribute-&gt;getName()) {\n                Required::class =&gt; $this-&gt;validateRequired($value, $validator),\n                Length::class =&gt; $this-&gt;validateLength($value, $validator),\n                Email::class =&gt; $this-&gt;validateEmail($value, $validator),\n                Pattern::class =&gt; $this-&gt;validatePattern($value, $validator),\n                Range::class =&gt; $this-&gt;validateRange($value, $validator),\n                InArray::class =&gt; $this-&gt;validateInArray($value, $validator),\n                Url::class =&gt; $this-&gt;validateUrl($value, $validator),\n                Date::class =&gt; $this-&gt;validateDate($value, $validator),\n                CreditCard::class =&gt; $this-&gt;validateCreditCard($value, $validator),\n                default =&gt; true,\n            };\n            \n            if (!$isValid) {\n                $this-&gt;errors[$propertyName][] = $validator-&gt;message;\n            }\n        }\n    }\n    \n    private function validateRequired(mixed $value, Required $rule): bool\n    {\n        if (is_string($value)) {\n            return trim($value) !== '';\n        }\n        return $value !== null &amp;&amp; $value !== '';\n    }\n    \n    private function validateLength(mixed $value, Length $rule): bool\n    {\n        if ($value === null || $value === '') {\n            return true;\n        }\n        \n        $length = mb_strlen((string)$value);\n        \n        if ($rule-&gt;min !== null &amp;&amp; $length &lt; $rule-&gt;min) {\n            return false;\n        }\n        \n        if ($rule-&gt;max !== null &amp;&amp; $length &gt; $rule-&gt;max) {\n            return false;\n        }\n        \n        return true;\n    }\n    \n    private function validateEmail(mixed $value, Email $rule): bool\n    {\n        if ($value === null || $value === '') {\n            return true;\n        }\n        \n        if (!filter_var($value, FILTER_VALIDATE_EMAIL)) {\n            return false;\n        }\n        \n        if ($rule-&gt;checkDNS) {\n            $domain = substr(strrchr($value, \"@\"), 1);\n            return checkdnsrr($domain, 'MX');\n        }\n        \n        return true;\n    }\n    \n    private function validatePattern(mixed $value, Pattern $rule): bool\n    {\n        if ($value === null || $value === '') {\n            return true;\n        }\n        \n        return preg_match($rule-&gt;regex, (string)$value) === 1;\n    }\n    \n    private function validateRange(mixed $value, Range $rule): bool\n    {\n        if ($value === null || $value === '') {\n            return true;\n        }\n        \n        $numValue = (float)$value;\n        \n        if ($rule-&gt;min !== null &amp;&amp; $numValue &lt; $rule-&gt;min) {\n            return false;\n        }\n        \n        if ($rule-&gt;max !== null &amp;&amp; $numValue &gt; $rule-&gt;max) {\n            return false;\n        }\n        \n        return true;\n    }\n    \n    private function validateInArray(mixed $value, InArray $rule): bool\n    {\n        if ($value === null || $value === '') {\n            return true;\n        }\n        \n        return in_array($value, $rule-&gt;allowedValues, true);\n    }\n    \n    private function validateUrl(mixed $value, Url $rule): bool\n    {\n        if ($value === null || $value === '') {\n            return true;\n        }\n        \n        if (!filter_var($value, FILTER_VALIDATE_URL)) {\n            return false;\n        }\n        \n        $scheme = parse_url($value, PHP_URL_SCHEME);\n        return in_array($scheme, $rule-&gt;allowedSchemes);\n    }\n    \n    private function validateDate(mixed $value, Date $rule): bool\n    {\n        if ($value === null || $value === '') {\n            return true;\n        }\n        \n        $date = DateTime::createFromFormat($rule-&gt;format, (string)$value);\n        return $date &amp;&amp; $date-&gt;format($rule-&gt;format) === $value;\n    }\n    \n    private function validateCreditCard(mixed $value, CreditCard $rule): bool\n    {\n        if ($value === null || $value === '') {\n            return true;\n        }\n        \n        // Luhn algorithm\n        $number = preg_replace('/\\D/', '', (string)$value);\n        $sum = 0;\n        $length = strlen($number);\n        \n        for ($i = 0; $i &lt; $length; $i++) {\n            $digit = (int)$number[$length - $i - 1];\n            \n            if ($i % 2 === 1) {\n                $digit *= 2;\n                if ($digit &gt; 9) {\n                    $digit -= 9;\n                }\n            }\n            \n            $sum += $digit;\n        }\n        \n        return $sum % 10 === 0;\n    }\n    \n    private function validateClassRules(object $object, ReflectionClass $reflection): void\n    {\n        $attributes = $reflection-&gt;getAttributes(\n            CompareFields::class,\n            ReflectionAttribute::IS_INSTANCEOF\n        );\n        \n        foreach ($attributes as $attribute) {\n            $rule = $attribute-&gt;newInstance();\n            \n            $prop1 = $reflection-&gt;getProperty($rule-&gt;field1);\n            $prop2 = $reflection-&gt;getProperty($rule-&gt;field2);\n            \n            $prop1-&gt;setAccessible(true);\n            $prop2-&gt;setAccessible(true);\n            \n            $value1 = $prop1-&gt;getValue($object);\n            $value2 = $prop2-&gt;getValue($object);\n            \n            $isValid = match($rule-&gt;operator) {\n                '===' =&gt; $value1 === $value2,\n                '==' =&gt; $value1 == $value2,\n                '!==' =&gt; $value1 !== $value2,\n                '!=' =&gt; $value1 != $value2,\n                '&gt;' =&gt; $value1 &gt; $value2,\n                '&gt;=' =&gt; $value1 &gt;= $value2,\n                '&lt;' =&gt; $value1 &lt; $value2,\n                '&lt;=' =&gt; $value1 &lt;= $value2,\n                default =&gt; false,\n            };\n            \n            if (!$isValid) {\n                $this-&gt;errors['_class'][] = $rule-&gt;message;\n            }\n        }\n    }\n    \n    public function getErrors(): array\n    {\n        return $this-&gt;errors;\n    }\n}\n</code></pre>\n<h3 id=\"实际模型示例\">实际模型示例</h3>\n<pre><code class=\"language-php\">&lt;?php\n\n#[CompareFields('password', 'confirmPassword', message: 'Passwords do not match')]\nclass UserRegistrationRequest\n{\n    #[Required]\n    #[Length(min: 3, max: 50)]\n    #[Pattern(\n        regex: '/^[a-zA-Z0-9_]+$/',\n        message: 'Username can only contain letters, numbers, and underscores'\n    )]\n    public string $username;\n    \n    #[Required]\n    #[Email(checkDNS: true)]\n    #[Unique(table: 'users', column: 'email')]\n    public string $email;\n    \n    #[Required]\n    #[Length(min: 8, max: 100)]\n    #[Pattern(\n        regex: '/^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[@$!%*?&amp;])[A-Za-z\\d@$!%*?&amp;]/',\n        message: 'Password must contain uppercase, lowercase, number, and special character'\n    )]\n    public string $password;\n    \n    #[Required]\n    public string $confirmPassword;\n    \n    #[Required]\n    #[Length(min: 2, max: 100)]\n    public string $firstName;\n    \n    #[Required]\n    #[Length(min: 2, max: 100)]\n    public string $lastName;\n    \n    #[Date(format: 'Y-m-d')]\n    public ?string $birthDate = null;\n    \n    #[Url(allowedSchemes: ['https'])]\n    public ?string $website = null;\n    \n    #[Pattern(regex: '/^\\+?[1-9]\\d{1,14}$/', message: 'Invalid phone number')]\n    public ?string $phone = null;\n    \n    #[InArray(allowedValues: ['male', 'female', 'other', 'prefer_not_to_say'])]\n    public ?string $gender = null;\n    \n    #[Range(min: 18, max: 120)]\n    public ?int $age = null;\n}\n\nclass PaymentRequest\n{\n    #[Required]\n    #[Range(min: 0.01, max: 999999.99)]\n    public float $amount;\n    \n    #[Required]\n    #[InArray(allowedValues: ['USD', 'EUR', 'GBP', 'JPY'])]\n    public string $currency;\n    \n    #[Required]\n    #[CreditCard(types: ['visa', 'mastercard'])]\n    public string $cardNumber;\n    \n    #[Required]\n    #[Pattern(regex: '/^\\d{3,4}$/', message: 'Invalid CVV')]\n    public string $cvv;\n    \n    #[Required]\n    #[Pattern(regex: '/^(0[1-9]|1[0-2])\\/\\d{2}$/', message: 'Invalid expiry date (MM/YY)')]\n    public string $expiryDate;\n    \n    #[Required]\n    #[Length(min: 2, max: 100)]\n    public string $cardholderName;\n    \n    #[Email]\n    public ?string $receiptEmail = null;\n}\n</code></pre>\n<h3 id=\"在控制器中使用验证\">在控制器中使用验证</h3>\n<pre><code class=\"language-php\">&lt;?php\n\nclass RegistrationController\n{\n    private EnhancedValidator $validator;\n    \n    public function __construct()\n    {\n        $this-&gt;validator = new EnhancedValidator();\n    }\n    \n    #[Route('/register', method: 'POST')]\n    public function register(#[FromBody] UserRegistrationRequest $request): array\n    {\n        if (!$this-&gt;validator-&gt;validate($request)) {\n            http_response_code(422);\n            return [\n                'success' =&gt; false,\n                'errors' =&gt; $this-&gt;validator-&gt;getErrors(),\n                'message' =&gt; 'Validation failed'\n            ];\n        }\n        \n        // Process registration\n        $user = $this-&gt;createUser($request);\n        \n        return [\n            'success' =&gt; true,\n            'user' =&gt; $user,\n            'message' =&gt; 'Registration successful'\n        ];\n    }\n    \n    private function createUser(UserRegistrationRequest $request): array\n    {\n        // Implementation\n        return [\n            'id' =&gt; 1,\n            'username' =&gt; $request-&gt;username,\n            'email' =&gt; $request-&gt;email,\n        ];\n    }\n}\n</code></pre>\n<h2 id=\"进阶模式和最佳实践\">进阶模式和最佳实践</h2>\n<h3 id=\"attribute-组合\">Attribute 组合</h3>\n<p>创建可重用的 Attribute 组:</p>\n<pre><code class=\"language-php\">&lt;?php\n\n#[Attribute(Attribute::TARGET_PROPERTY)]\nclass StrongPassword\n{\n    public static function getRules(): array\n    {\n        return [\n            new Required('Password is required'),\n            new Length(min: 8, max: 100),\n            new Pattern(\n                regex: '/^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[@$!%*?&amp;])/',\n                message: 'Password must meet complexity requirements'\n            ),\n        ];\n    }\n}\n\n#[Attribute(Attribute::TARGET_PROPERTY)]\nclass PersonName\n{\n    public static function getRules(): array\n    {\n        return [\n            new Required(),\n            new Length(min: 2, max: 100),\n            new Pattern(\n                regex: '/^[a-zA-Z\\s\\'-]+$/',\n                message: 'Name contains invalid characters'\n            ),\n        ];\n    }\n}\n</code></pre>\n<h3 id=\"缓存-reflection-数据\">缓存 Reflection 数据</h3>\n<p>通过缓存 Attribute 元数据来提升性能:</p>\n<pre><code class=\"language-php\">&lt;?php\n\nclass AttributeCache\n{\n    private static array $cache = [];\n    \n    public static function getAttributes(string $className, string $attributeType): array\n    {\n        $key = \"{$className}::{$attributeType}\";\n        \n        if (!isset(self::$cache[$key])) {\n            self::$cache[$key] = AttributeProcessor::getClassAttributes(\n                $className,\n                $attributeType\n            );\n        }\n        \n        return self::$cache[$key];\n    }\n    \n    public static function getMethodAttributes(\n        string $className,\n        string $method,\n        string $attributeType\n    ): array {\n        $key = \"{$className}::{$method}::{$attributeType}\";\n        \n        if (!isset(self::$cache[$key])) {\n            $reflection = new ReflectionMethod($className, $method);\n            self::$cache[$key] = array_map(\n                fn($attr) =&gt; $attr-&gt;newInstance(),\n                $reflection-&gt;getAttributes($attributeType, ReflectionAttribute::IS_INSTANCEOF)\n            );\n        }\n        \n        return self::$cache[$key];\n    }\n    \n    public static function clear(): void\n    {\n        self::$cache = [];\n    }\n}\n</code></pre>\n<h3 id=\"attribute-驱动的依赖注入\">Attribute 驱动的依赖注入</h3>\n<pre><code class=\"language-php\">&lt;?php\n\n#[Attribute(Attribute::TARGET_PROPERTY)]\nclass Inject\n{\n    public function __construct(\n        public ?string $service = null\n    ) {}\n}\n\nclass Container\n{\n    private array $services = [];\n    \n    public function register(string $name, callable $factory): void\n    {\n        $this-&gt;services[$name] = $factory;\n    }\n    \n    public function resolve(string $className): object\n    {\n        $reflection = new ReflectionClass($className);\n        $instance = $reflection-&gt;newInstanceWithoutConstructor();\n        \n        foreach ($reflection-&gt;getProperties() as $property) {\n            $attributes = $property-&gt;getAttributes(Inject::class);\n            \n            if (!empty($attributes)) {\n                $inject = $attributes[0]-&gt;newInstance();\n                $serviceName = $inject-&gt;service ?? $property-&gt;getType()-&gt;getName();\n                \n                if (isset($this-&gt;services[$serviceName])) {\n                    $service = $this-&gt;services[$serviceName]($this);\n                    $property-&gt;setAccessible(true);\n                    $property-&gt;setValue($instance, $service);\n                }\n            }\n        }\n        \n        return $instance;\n    }\n}\n\n// Usage\nclass OrderService\n{\n    #[Inject]\n    private DatabaseConnection $db;\n    \n    #[Inject(service: 'mailer')]\n    private EmailService $emailService;\n    \n    #[Inject]\n    private LoggerInterface $logger;\n    \n    public function createOrder(array $data): Order\n    {\n        $this-&gt;logger-&gt;info('Creating order');\n        // Implementation\n        return new Order();\n    }\n}\n</code></pre>\n<h2 id=\"性能优化技巧\">性能优化技巧</h2>\n<ol>\n<li><strong>缓存 Reflection 结果</strong>:Reflection 开销较大;缓存 Attribute 元数据</li>\n<li><strong>使用 IS_INSTANCEOF</strong>:搜索 Attributes 时使用继承标志</li>\n<li><strong>延迟加载</strong>:仅在需要时处理 Attributes</li>\n<li><strong>编译路由</strong>:在生产环境中预编译路由表</li>\n<li><strong>避免深度嵌套</strong>:保持 Attribute 处理浅层化</li>\n</ol>\n<h2 id=\"attributes-与替代方案对比\">Attributes 与替代方案对比</h2>\n<table>\n<thead>\n<tr>\n<th>特性</th>\n<th>Attributes</th>\n<th>Docblock 注解</th>\n<th>配置文件</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>类型安全</td>\n<td>✅ 编译时验证</td>\n<td>❌ 字符串解析</td>\n<td>⚠️ 部分支持</td>\n</tr>\n<tr>\n<td>IDE 支持</td>\n<td>✅ 完整支持</td>\n<td>⚠️ 有限支持</td>\n<td>⚠️ 有限支持</td>\n</tr>\n<tr>\n<td>性能</td>\n<td>✅ OPcache 缓存</td>\n<td>⚠️ 需要解析</td>\n<td>✅ 可缓存</td>\n</tr>\n<tr>\n<td>可读性</td>\n<td>✅ 声明式</td>\n<td>⚠️ 注释混杂</td>\n<td>❌ 分离代码</td>\n</tr>\n<tr>\n<td>灵活性</td>\n<td>✅ 高度灵活</td>\n<td>⚠️ 有限</td>\n<td>✅ 灵活</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"结语\">结语</h2>\n<p>PHP Attributes 代表了元数据编程的范式转变。它们提供:</p>\n<ul>\n<li><strong>类型安全</strong>:编译时验证 Attribute 使用</li>\n<li><strong>简洁语法</strong>:声明式、可读的代码</li>\n<li><strong>IDE 支持</strong>:完整的自动补全和重构</li>\n<li><strong>性能</strong>:解析一次,由 opcache 缓存</li>\n<li><strong>灵活性</strong>:适用于类、方法、属性、参数</li>\n</ul>\n<p>通过掌握自定义 Attributes、Reflection API、基于 Attribute 的路由和验证模式,你可以解锁强大的架构模式,使 PHP 应用更易维护、可测试且优雅。</p>\n<p>本文中的示例展示了可用于生产的实现,你可以根据具体需求进行调整。从验证 Attributes 开始,然后逐步采用路由以及日志和缓存等横切关注点。</p>\n<p>记住:Attributes 是元数据——它们描述你的代码,但不能替代良好的设计。使用它们来减少样板代码并增强表达力,而不是作为清晰架构的替代品。</p>\n\n</div>\n<div class=\"clear\"></div>\n\n            </div>\n            <div class=\"postDesc\">posted @ \n<span id=\"post-date\">2025-12-25 07:57</span>&nbsp;\n<a href=\"https://www.cnblogs.com/catchadmin\">JaguarJack</a>&nbsp;\n阅读(<span id=\"post_view_count\">44</span>)&nbsp;\n评论(<span id=\"post_comment_count\">0</span>)&nbsp;\n&nbsp;\n<a href=\"\">收藏</a>&nbsp;\n<a href=\"\">举报</a>\n</div>"
    },
    {
      "title": "电信公网IPV4被收回之后：家庭网络的“绝地求生”折腾记",
      "link": "https://www.cnblogs.com/sueyyyy/p/19394875",
      "published": "",
      "description": "<h1 class=\"postTitle\">\n                <a class=\"postTitle2 vertical-middle\" href=\"https://www.cnblogs.com/sueyyyy/p/19394875\" id=\"cb_post_title_url\" title=\"发布于 2025-12-24 23:04\">\n    <span>电信公网IPV4被收回之后：家庭网络的“绝地求生”折腾记</span>\n    \n\n</a>\n\n            </h1>\n            <div class=\"clear\"></div>\n            <div class=\"postBody\">\n                <div class=\"blogpost-body cnblogs-markdown\" id=\"cnblogs_post_body\">\n<blockquote>\n<p>好久好久没写过博客了，最近心血来潮登上来看看，不过既然来都来了就顺便写一篇博客再走吧，想来想去没啥好素材，遂把最近家里网络的折腾记录分享一下。</p>\n</blockquote>\n<p>作为一名苦逼码农，我一直信奉行规：<strong>“代码能跑就不要动，架构能用就别重构”</strong>。<br />\n这几年我家的电信网络一直稳如老狗：手握稀缺的 <strong>公网 IPv4</strong>，在小米路由器上开个端口转发，配合DDNS+防火墙策略，在外访问家里的 Nas和 Mac mini，那叫一个丝般顺滑且安全。那时候觉得这已经一步到位，不用再折腾了。<br />\n然而，今年4月，天塌了。</p>\n<h2 id=\"第一章失去-ipv4-的那个四月\">第一章：失去 IPv4 的那个四月</h2>\n<p>坑爹的江苏电信在没有任何预警和通知的情况下，单方面收回了我的公网 IPv4。我看着 WAN 口那个 <code>100.73</code> 开头的内网地址，陷入了沉思。<br />\n<img alt=\"image\" height=\"365\" src=\"https://img2024.cnblogs.com/blog/2482940/202512/2482940-20251224222436013-1105168401.png\" width=\"1095\" /><br />\n作为一个不信邪的人，我开始了漫长的维权之路。打客服、找片区经理、甚至硬着头皮去工信部、通管局、12345投诉。结果大家懂的，得到的回复出奇一致：“资源枯竭，合同为明确表示有该服务，无法办理”。<br />\n没办法，生活还得继续。胳膊拧不过大腿，我只能被迫妥协，转向了 <strong>IPv6</strong>。</p>\n<h2 id=\"第二章在互联网上裸奔的日子\">第二章：在互联网上“裸奔”的日子</h2>\n<p>好在ipv6没有限制，直接开启路由器的IPV6就能使用。我重新捡起 <code>ddns-go</code>，配合域名做解析。<br />\n但这玩意儿有个巨大的坑——<strong>小米路由器的 IPv6 防火墙设计简直是“反人类”</strong>。它就像一个只有开关键的灯泡：要么全开（外网彻底进不来），要么全关（家里大门敞开）。为了能用，我被迫选择了<strong>关闭防火墙</strong>。<br />\n始终担心哪天会被攻击，因为我的 NAS、内网服务完全是在互联网上<strong>“裸奔”</strong>。这就好比我出门上班，家里大门不仅没锁，甚至连门都卸了，谁路过都能往里瞅一眼。<br />\n而且这方案极其难用：公司和星巴克的 WiFi 大多还是纯 IPv4 环境，导致我在外面想连回家，还得先把手机 WiFi 断了切成 5G。<strong>那一刻，我感觉自己像个拿着智能手机的原始人。</strong></p>\n<h2 id=\"第三章cloudflare-tunnel-救我狗命\">第三章：Cloudflare Tunnel 救我狗命</h2>\n<p>这种“裸奔”且“便秘”的日子，我忍到了前几天，终于决定对架构进行重构。首先登场的是 <strong>Cloudflare Tunnel</strong>，给内网穿条裤子。</p>\n<h3 id=\"-简要步骤\">👨‍💻 简要步骤</h3>\n<p>其实这玩意儿配置起来意外地简单，核心就三步：</p>\n<ol>\n<li><strong>搞个域名：</strong> 斥巨资（47块钱一年）在spaceship又买了个域名，托管到 Cloudflare。</li>\n<li><strong>内网部署守护进程：</strong> 在家里的 Mac Mini（或者 NAS）上装个 <code>cloudflared</code> 服务。这玩意儿就像个“地道挖掘机”，主动向 Cloudflare 的服务器打洞。</li>\n<li><strong>云端配置：</strong> 登录 Cloudflare Zero Trust 后台，动动鼠标，把 <code>nas.mydomain.com</code> 指向内网的 <code>http://192.168.31.199:5000</code>。</li>\n</ol>\n<h3 id=\"-效果立竿见影\">🚀 效果立竿见影</h3>\n<ul>\n<li><strong>不用关防火墙了！</strong> 我赶紧把小米那个“人工智障”防火墙重新打开，心里踏实多了。</li>\n<li><strong>兼容性无敌：</strong> 它就像个翻译官，我在外面就算用只有 IPv4 的破烂 WiFi，也能通过域名顺畅访问家里的服务。(不得不说CF真实大善人呀，免费功能都贼多贼好用！)<br />\n<img alt=\"image\" height=\"600\" src=\"https://img2024.cnblogs.com/blog/2482940/202512/2482940-20251224223703831-1192856318.png\" width=\"1477\" /></li>\n</ul>\n<h2 id=\"第四章拉满带宽tailscale--游戏\">第四章：拉满带宽（Tailscale &amp; 游戏）</h2>\n<p>CF Tunnel 虽然稳，但毕竟要绕道别人的服务器，传大文件有点温吞水。始终达不到原来公网IPV6的速度，而且，最近心里长草想搞 <strong>远程游戏串流</strong>。于是我又盯上了 <strong>Tailscale</strong>。</p>\n<h3 id=\"-简要步骤-1\">👨‍💻 简要步骤</h3>\n<p>Tailscale 主打一个“无感”，但要玩得好，得用点魔法：</p>\n<ol>\n<li><strong>全员安装：</strong> Mac Mini、手机、iPad 全部装上 Tailscale 客户端并登录。</li>\n<li><strong>开启子网路由 (Subnet Router)：</strong> 这是关键。我在 Mac Mini 的终端敲了一行命令 <code>advertise-routes=192.168.31.0/24</code>。这相当于告诉 Tailscale：“去往我家内网的路，我熟，大家把包发给我就行。”</li>\n<li><strong>客户端设置：</strong> 在手机 App 里，有个藏得很深的开关叫 <strong>\"Use Subnets\"</strong>，必须把它打开，否则手机还是会傻傻地走本地网络。</li>\n</ol>\n<p>这一试不要紧，直接打开了新世界的大门。我惊讶地发现：<strong>Tailscale 居然能穿透小米的防火墙！</strong>即使我开着防火墙，只要两头都有 IPv6，它俩竟然能私下里<strong>“打洞”</strong>成功，建立 P2P 直连。<br />\n<img alt=\"image\" height=\"629\" src=\"https://img2024.cnblogs.com/blog/2482940/202512/2482940-20251224224255559-841000158.png\" width=\"1443\" /></p>\n<h3 id=\"-游戏串流配置-moonlight\">🎮 游戏串流配置 (Moonlight)</h3>\n<ul>\n<li><strong>服务端：</strong> PC 安装 <strong>Sunshine</strong>（替代老黄的 GameStream），设置好用户名密码。</li>\n<li><strong>客户端：</strong> 手机装 <strong>Moonlight</strong>，搜到 PC 后输个 PIN 码配对。</li>\n<li><strong>调优：</strong> 考虑到家里上行带宽只有 50M，我把码率锁死在 <strong>60Mbps</strong>，并强制开启 <strong>HEVC (H.265)</strong> 编码。</li>\n</ul>\n<p>实测延迟 40ms。在外直接串流回家，对比Windows自带的远程工具流畅度简直好到飞起。</p>\n<h2 id=\"第五章最后的强迫症消灭-19216831x\">第五章：最后的强迫症（消灭 192.168.31.x）</h2>\n<p>所有的技术问题都解决了，最后一个抽象大坑竟然是——<strong>IP 冲突</strong>。</p>\n<p>因为小米路由默认网段是 <code>192.168.31.x</code>，外面很多公共 WiFi 也是这个网段。经常出现“我在外面连回家，系统以为我在访问本地”的路由错乱，导致TailScale无法正常联通。</p>\n<p>一不做二不休，既然折腾了，就折腾到底。我把全家网段迁移到了冷门的 <strong><code>192.168.81.x</code></strong>。</p>\n<blockquote>\n<p><strong>⚠️ 高危操作警告：</strong><br />\n在改路由器 IP 之前，<strong>记得一定要先把 NAS 和服务器的静态 IP 解绑改成 DHCP！OpenWrt、Docker等配置了固定ip的服务也要记得修改</strong> 。不然就是断网惨案，得扛着电脑、网线去弱电箱里救火。</p>\n</blockquote>\n<hr />\n<h2 id=\"现在的状态\">现在的状态</h2>\n<p>经过这几天的疯狂折腾，现在的架构是：</p>\n<ul>\n<li><strong>安全：</strong> 小米防火墙全开，不再裸奔。</li>\n<li><strong>入口：</strong>\n<ul>\n<li><strong>日常访问 (Web)：</strong> 走 Cloudflare Tunnel，全网通吃。</li>\n<li><strong>高性能访问 (游戏/传输)：</strong> 走 Tailscale IPv6 直连，速度拉满。</li>\n</ul>\n</li>\n<li><strong>心情：</strong> 极度舒适。</li>\n</ul>\n<p>虽然失去了公网 IPv4 很难受，但逼着自己搞出了这一套更现代、更安全的方案，也算是<strong>因祸得福</strong>吧。折腾无止境，生命不息，挖坑不止！</p>\n<blockquote>\n<p>大家如果对此感兴趣或有疑问的话，欢迎评论留言，有空我单独做一些更详细的折腾教程。</p>\n</blockquote>\n\n</div>\n<div id=\"MySignature\">\n    <p><br />\n本博客文章均已测试验证，欢迎评论、交流、点赞。<br />\n部分文章来源于网络，如有侵权请联系删除。<br />\n转载请注明原文链接：<a href=\"https://www.cnblogs.com/sueyyyy/p/19394875\" target=\"_blank\">https://www.cnblogs.com/sueyyyy/p/19394875</a></p>\n</div>\n<div class=\"clear\"></div>\n\n            </div>\n            <div class=\"postDesc\">posted @ \n<span id=\"post-date\">2025-12-24 23:04</span>&nbsp;\n<a href=\"https://www.cnblogs.com/sueyyyy\">少说点话</a>&nbsp;\n阅读(<span id=\"post_view_count\">365</span>)&nbsp;\n评论(<span id=\"post_comment_count\">7</span>)&nbsp;\n&nbsp;\n<a href=\"\">收藏</a>&nbsp;\n<a href=\"\">举报</a>\n</div>"
    },
    {
      "title": "自适应滤波算法的FPGA实现思路",
      "link": "https://www.cnblogs.com/y0011/p/19394755/bugao123",
      "published": "",
      "description": "<h1 class=\"postTitle\">\n                <a class=\"postTitle2 vertical-middle\" href=\"https://www.cnblogs.com/y0011/p/19394755/bugao123\" id=\"cb_post_title_url\" title=\"发布于 2025-12-24 22:50\">\n    <span>自适应滤波算法的FPGA实现思路</span>\n    \n\n</a>\n\n            </h1>\n            <div class=\"clear\"></div>\n            <div class=\"postBody\">\n                <div class=\"blogpost-body blogpost-body-html\" id=\"cnblogs_post_body\">\n<h1><span>1、原理简介</span></h1>\n<span>　<span style=\"font-size: 16px;\">　参考相关论文，自适应滤波器主要由FIR滤波器本体、参数自适应计算两部分组成。参数自适应计算部分是用来迭代计算滤波器系数的，它的输入是期望估计误差f、原始数据采样保存的向量U，输出是可变的FIR滤波器系数。FIR滤波器就是传统的有限冲击响应滤波器，可以是低通、高通等类型。所谓滤波器系数可变，指的是自适应算法根据动态变化的期望估计误差f和输入向量U，不停地进行迭代和更新FIR滤波器系数。有了自适应算法，FIR滤波器对动态误差的响应会更快，理论上噪声抑制效果也更好。</span></span>\n<p><img alt=\"image\" class=\"lazyload\" style=\"display: block; margin-left: auto; margin-right: auto;\" /></p>\n<p style=\"text-align: center;\">图1 自适应滤波器架构</p>\n<p>　<span>　自适应算法有很多种，其中LMS最小均方差自适应滤波算法计算量比较小，所以我选择它用在自己的项目里。</span></p>\n<p><span>　　LMS自适应算法公式：</span></p>\n<p>　　<img alt=\"image\" class=\"lazyload\" height=\"34\" width=\"310\" /></p>\n<p><span>　　公式里的</span><img alt=\"image\" class=\"lazyload\" height=\"19\" width=\"28\" /><span>就是需要不断迭代的滤波器系数，M维向量；c和r都是常数；UT表示U的转置也是M维的向量；其他符号在图里面已经比较清楚。</span><span>这是一种可变更新步长的算法，因为U<sup>T</sup>U是变化的。</span></p>\n<p><span>　　如果用固定步长算法，那么公式就是：</span></p>\n<p>　　<img alt=\"image\" class=\"lazyload\" height=\"19\" width=\"247\" /></p>\n<p><span>　　这里面的h就是步长，相当于是一个固定的系数。</span></p>\n<p><span>　　可变步长算法的好处是收敛快，滤波器延时更小。</span></p>\n<h1><span style=\"font-size: 18px;\">2、实现流程</span></h1>\n<p><span>　　明白了原理，下面再设计滤波器的verilog实现方案。</span></p>\n<p><span>　　分析前面第1个公式，有加法、乘法、除法，还有M维的向量。做过FPGA算法的开发者应该有体会，向量和矩阵计算在verilog里面不太好实现，一般会把它转化成单个元素的计算，不然会占用太多资源，换种说法就是要把并行计算架构转成流水线形式的计算架构。这里面还需要关注的是参数向量B(n)和输入向量U(n)：如何表示这两个动态变化的向量，还有就是如何计算</span><img alt=\"image\" class=\"lazyload\" height=\"19\" width=\"30\" />。</p>\n<p><span>　　我选择用FIFO表示前面提到的几个M维向量，需要计算时就读FIFO中的数据，计算完成之后更新FIFO。至于</span><img alt=\"image\" class=\"lazyload\" height=\"19\" width=\"30\" />&nbsp;<span>，手动推导后可以看出它其实就是向量各元素的平方和，因此也可以用FIFO通过不断缓存</span><img alt=\"image\" class=\"lazyload\" height=\"21\" width=\"39\" /><span>以及动态累加的方式实现。</span></p>\n<p><span>　　基于FIFO的自适应算法架构如下图所示。</span></p>\n<p>　　</p>\n<p><img alt=\"image\" class=\"lazyload\" style=\"display: block; margin-left: auto; margin-right: auto;\" /></p>\n<p>&nbsp;</p>\n<p><span>　　图片画的不太简洁，用文字描述一下在FPGA中实现的过程。</span></p>\n<p><span>　　第一步：系统复位后先对<strong>FIFOA1</strong>和<strong>FIFOB1</strong>初始化，也就是先缓存得到一组向量B和向量U。</span></p>\n<p><span>　　第二步：初始化结束后，等待输入数据（滤波前）u和滤波后数据u1更新，然后FIFOCtrlB模块读FIFOA1的数据并参与计算流水线，动态累加模块读FIFOC以及新输入数据完成累加值更新并参与计算流水线，FIFOCTRLU模块读FIFOB1数据参与计算流水线。</span></p>\n<p><span>　　第三步：计算流水线完成乘法、加法全部计算过程，得到一个新的参数B(n+1)，FIFOCtrlB把这个新参数写入FIFOA2，以供下一轮计算使用，同时FIFOCTRLU模块把上一步参与计算流水线的数据写入FIFOB2，也是为了下一轮次计算使用。直到FIFOA1中的参数读完了也就是计算完了，与此同时FIFOB1也被读空了，相应的FIFOA2、FIFOB2也都写完成了，这一轮计算结束。</span></p>\n<p><span>　　下一轮计算时，FIFOA1和FIFOA2互换读写次序，FIFOB1、FIFOB2互换读写次序。循环往复。</span></p>\n<p><span>　　由于和都是常数，因此代入常数后就省掉了除法器，用乘法代替。</span></p>\n<p><span>　　自适应算法是滤波器最核心最难的部分，把这部分的输出直接接入FIR滤波器，就可以实现了自适应FIR滤波。至于FIR滤波器，用IP核就可以，不需要自行设计。当然也可以自己用逻辑和加法器、乘法器搭建FIR滤波器，这样可控性更好，不然还要去理解FIR的IP核的接口和参数的含义，也挺费事的。</span></p>\n<p><span>　　目前已经按照这个流程写好了verilog逻辑，后面会仿真测试，与MATLAB计算的结果比较一下，验证设计是否正确。</span></p>\n</div>\n<div id=\"MySignature\">\n    <p>本文来自博客园，作者：<a href=\"https://www.cnblogs.com/y0011/\" target=\"_blank\">不高工程师</a>，转载请注明原文链接：<a href=\"https://www.cnblogs.com/y0011/p/19394755/bugao123\" target=\"_blank\">https://www.cnblogs.com/y0011/p/19394755/bugao123</a></p>\n</div>\n<div class=\"clear\"></div>\n\n            </div>\n            <div class=\"postDesc\">posted @ \n<span id=\"post-date\">2025-12-24 22:50</span>&nbsp;\n<a href=\"https://www.cnblogs.com/y0011\">不高工程师</a>&nbsp;\n阅读(<span id=\"post_view_count\">40</span>)&nbsp;\n评论(<span id=\"post_comment_count\">0</span>)&nbsp;\n&nbsp;\n<a href=\"\">收藏</a>&nbsp;\n<a href=\"\">举报</a>\n</div>"
    }
  ]
}