{
  "title": "ä¸»é¡µ - åšå®¢å›­",
  "link": "https://www.cnblogs.com/",
  "description": "ä¸»é¡µ - åšå®¢å›­ RSS",
  "entries": [
    {
      "title": "AI ç”»å›¾å…¨å®¶æ¡¶æ¥äº†ï¼è¿™å›æƒ³è‡ªå·±æ‰‹ç»˜å›¾éƒ½éš¾äº†",
      "link": "https://www.cnblogs.com/chengxy-nds/p/19610998",
      "published": "",
      "description": "<h1 class=\"postTitle\">\n                <a class=\"postTitle2 vertical-middle\" href=\"https://www.cnblogs.com/chengxy-nds/p/19610998\" id=\"cb_post_title_url\" title=\"å‘å¸ƒäº 2026-02-13 09:48\">\n    <span>AI ç”»å›¾å…¨å®¶æ¡¶æ¥äº†ï¼è¿™å›æƒ³è‡ªå·±æ‰‹ç»˜å›¾éƒ½éš¾äº†</span>\n    \n\n</a>\n\n            </h1>\n            <div class=\"clear\"></div>\n            <div class=\"postBody\">\n                <div class=\"blogpost-body cnblogs-markdown\" id=\"cnblogs_post_body\">\n<p><strong>å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯å°å¯Œï½</strong></p>\n<p>å‰å‡ å¤©æˆ‘ä¸æ˜¯åˆ†äº«äº†å¦‚ä½•é›¶æˆæœ¬æ­å»º <strong>next-ai-draw-io</strong>ï¼Œæ•™å¤§å®¶ç”¨ AI ç”Ÿæˆ draw.io é£æ ¼çš„æ¶æ„å›¾ã€‚åå°åå“è¿˜ä¸é”™ï¼Œçœ‹æ¥å¤§å®¶å¯¹æ‰‹ç»˜æ¶æ„å›¾çœŸçš„æ˜¯è‹¦ä¹‹ä¹…çŸ£ã€‚</p>\n<p><img alt=\"\" src=\"http://fire-blog.oss-cn-beijing.aliyuncs.com/20251229-160034.gif\" /></p>\n<p>ä½†åœ¨æ—¥å¸¸å†™æ–‡ç« æ—¶ï¼Œæˆ‘å‘ç°å¾ˆå¤šè¯»è€…æ›´åçˆ±é‚£ç§æ‰‹ç»˜æ„Ÿåè¶³çš„ <strong>Excalidraw</strong> é£æ ¼ï¼Œå°±æ˜¯ä¸‹é¢è¿™ç§ï¼Œé€¼æ ¼é«˜ã€è§†è§‰ç¾ï¼Œèƒ½è®©æ–‡ç« ç¬é—´æ˜¾å¾—é«˜çº§èµ·æ¥ï¼š</p>\n<p><img alt=\"\" src=\"http://fire-blog.oss-cn-beijing.aliyuncs.com//images/20260203151400.png\" /></p>\n<p>æˆ‘åŸæœ¬åœ¨ç¢ç£¨ï¼Œèƒ½ä¸èƒ½ç”¨ Gemini Pro ç»™è‡ªå·±æ“ä¸€ä¸ª AI ç»˜å›¾æ•´åˆå¹³å°ï¼ŒæŠŠ draw.io å’Œ Excalidraw å…¨æ‰è¿›å»ã€‚</p>\n<p>ç»“æœå» GitHub ä¸€æœï¼Œå¥½å®¶ä¼™ï¼Œå·²ç»æœ‰å¤§ä½¬æŠŠæˆ‘æƒ³åšçš„ç»™åšäº†ï¼è¿™ä¸ªå¼€æºé¡¹ç›®ç®€ç›´æ˜¯ä¸ºæˆ‘è¿™ç§æ‡’ç™Œåšä¸»é‡èº«å®šåˆ¶çš„ï¼š<strong>Mermaidã€draw.ioã€Excalidraw</strong> ä¸‰å¤§ç‹ç‰Œé£æ ¼å…¨éƒ¨æ”¯æŒã€‚</p>\n<p>å›å¤´å†çœ‹çœ‹ä»¥å‰ä¸ºäº†ç”»ä¸ªåŸç†å›¾ç†¬å¤œçš„æ ·å­ï¼ŒçœŸçš„æ„Ÿè§‰æ˜¯åœ¨æµªè´¹ç”Ÿå‘½å•Šï¼</p>\n<h4 id=\"ai-draw-nexus-ai-ç»˜å›¾å…¨å®¶æ¡¶\">AI Draw Nexus AI ç»˜å›¾å…¨å®¶æ¡¶</h4>\n<p><strong>GitHub åœ°å€</strong>ï¼š<code>https://github.com/hkxiaoyao/ai-draw-nexus</code></p>\n<p><strong>åœ¨çº¿ä½“éªŒ</strong>ï¼š<code>https://ai-draw-nexus.aizhi.site/</code></p>\n<p>æˆ‘æŒ¨ä¸ªè¯•äº†ä¸€éï¼Œå¤§å®¶æ„Ÿå—ä¸‹è¿™è¾“å‡ºè´¨é‡ï¼š</p>\n<p><strong>1. Excalidraw é£æ ¼</strong></p>\n<p>è¾“å…¥: HTTP é•¿è½®è¯¢åŸç†å›¾ï¼Œç”Ÿæˆçš„é€»è¾‘çº¿æ¡æ¸…æ™°ï¼Œæ‰‹ç»˜è´¨æ„Ÿçˆ†æ£šã€‚</p>\n<p><img alt=\"\" src=\"http://fire-blog.oss-cn-beijing.aliyuncs.com//images/20260203152428.png\" /></p>\n<p><strong>2. Draw.io é£æ ¼</strong></p>\n<p>æˆ‘ä¹‹å‰å¾ˆå¤šçš„ç³»ç»Ÿæ¶æ„ã€æµç¨‹å›¾éƒ½æ˜¯è¿™ä¸ªé£æ ¼ï¼Œç°åœ¨ AI åŠ æŒçœŸçš„å¤ªæ–¹ä¾¿äº†ã€‚</p>\n<p><img alt=\"\" src=\"http://fire-blog.oss-cn-beijing.aliyuncs.com//images/20260203153031.png\" /></p>\n<p><strong>3. Mermaid é£æ ¼</strong></p>\n<p>å†™ Markdown å°±æ›´ç®€å•äº†ä¸€ç§’å‡ºå›¾ã€‚</p>\n<p><img alt=\"\" src=\"http://fire-blog.oss-cn-beijing.aliyuncs.com//images/20260203153451.png\" /></p>\n<p>è¿™ä¸æ˜¯åŠŸèƒ½é˜‰å‰²ç‰ˆï¼Œè€Œæ˜¯å…¨é‡ç‰ˆï¼å¯ä»¥åœ¨ AI ç”Ÿæˆçš„åŸºç¡€ä¸Šï¼Œç›´æ¥æ‰‹åŠ¨å¾®è°ƒã€‚</p>\n<h4 id=\"å¿«é€Ÿä¸Šæ‰‹\">å¿«é€Ÿä¸Šæ‰‹</h4>\n<p>å¦‚æœä½ æƒ³æœ¬åœ°è¿è¡Œï¼Œè¿™ä¸ªåŸºäº Next.js çš„å‰ç«¯é¡¹ç›®å®‰è£…èµ·æ¥ä¹Ÿéå¸¸ç®€å•ï¼š</p>\n<pre><code class=\"language-shell\"># 1. å…‹éš†é¡¹ç›®\ngit clone https://github.com/hkxiaoyao/ai-draw-nexus\ncd ai-draw-nexus\n\n# 2. å®‰è£…ä¾èµ– (æ¨èç”¨ pnpm)\npnpm install\n\n# 3. å¼€å¯ç”Ÿäº§åŠ›å¤§é—¨\npnpm dev\n</code></pre>\n<p>ä¸è¿‡ï¼Œç›®å‰çš„åœ¨çº¿ç‰ˆæœ¬æ¯å¤©æœ‰ 10 æ¬¡å…è´¹é…é¢ï¼Œè¿™ä¹Ÿå¾ˆæ­£å¸¸æ¯•ç«Ÿ API çº¿ä¸Šçš„è´¹ç”¨ç¡®å®è´µï¼ˆä¸Šæ¬¡æˆ‘é‚£ä¸ªå…è´¹å·¥å…·è¢«å¤§å®¶ä¸¤å¤©å°±ç”¨æ¬ è´¹äº†ï¼Œå“ˆå“ˆ ğŸ˜‚ï¼‰ã€‚</p>\n<p><img alt=\"\" src=\"http://fire-blog.oss-cn-beijing.aliyuncs.com//images/20260203152800.png\" /></p>\n<p>ç°åœ¨ä»…æ”¯æŒ <strong>OpenAI</strong> å’Œ <strong>Anthropic</strong> ä¸¤å¤§æ¨¡å‹ã€‚å¦‚æœä½ æœ‰è‡ªå·±çš„ Keyï¼Œå»ºè®®æœ¬åœ°æ­ä¸€ä¸ªï¼Œé‚£æ‰æ˜¯çœŸæ­£çš„ç»˜å›¾è‡ªç”±ï¼</p>\n<p>å¥½äº†ï¼Œä¸‹æœŸè§ï½</p>\n\n\n</div>\n<div class=\"clear\"></div>\n\n            </div>\n            <div class=\"postDesc\">posted @ \n<span id=\"post-date\">2026-02-13 09:48</span>&nbsp;\n<a href=\"https://www.cnblogs.com/chengxy-nds\">ç¨‹åºå‘˜å°å¯Œ</a>&nbsp;\né˜…è¯»(<span id=\"post_view_count\">0</span>)&nbsp;\nè¯„è®º(<span id=\"post_comment_count\">0</span>)&nbsp;\n&nbsp;\n<a href=\"\">æ”¶è—</a>&nbsp;\n<a href=\"\">ä¸¾æŠ¥</a>\n</div>"
    },
    {
      "title": "ä¸€æ¬¾Goè¯­è¨€Ginæ¡†æ¶DDDè„šæ‰‹æ¶ï¼Œé€‚åˆå¿«é€Ÿæ­å»ºé¡¹ç›®",
      "link": "https://www.cnblogs.com/letjs/p/19610915",
      "published": "",
      "description": "<h1 class=\"postTitle\">\n\t\t\t<a class=\"postTitle2 vertical-middle\" href=\"https://www.cnblogs.com/letjs/p/19610915\" id=\"cb_post_title_url\" title=\"å‘å¸ƒäº 2026-02-13 09:19\">\n    <span>ä¸€æ¬¾Goè¯­è¨€Ginæ¡†æ¶DDDè„šæ‰‹æ¶ï¼Œé€‚åˆå¿«é€Ÿæ­å»ºé¡¹ç›®</span>\n    \n\n</a>\n\n\t\t</h1>\n\t\t<div class=\"clear\"></div>\n\t\t<div class=\"postBody\">\n\t\t\t<div class=\"blogpost-body cnblogs-markdown\" id=\"cnblogs_post_body\">\n<h1 id=\"ä¸€æ¬¾goè¯­è¨€ginæ¡†æ¶dddè„šæ‰‹æ¶é€‚åˆå¿«é€Ÿæ­å»ºé¡¹ç›®\">ä¸€æ¬¾Goè¯­è¨€Ginæ¡†æ¶DDDè„šæ‰‹æ¶ï¼Œé€‚åˆå¿«é€Ÿæ­å»ºé¡¹ç›®</h1>\n<blockquote>\n<p>ä¸€ä¸ªå¼€ç®±å³ç”¨çš„ DDDï¼ˆé¢†åŸŸé©±åŠ¨è®¾è®¡ï¼‰Go è„šæ‰‹æ¶ï¼ŒåŸºäº Gin + RocketMQï¼ŒåŒ…å«åŒæ•°æ®åº“ã€ç»Ÿä¸€å“åº”ã€ä¸­é—´ä»¶ä¸äº‹ä»¶é©±åŠ¨ç¤ºä¾‹ã€‚</p>\n</blockquote>\n<h2 id=\"è¿™æ˜¯ä»€ä¹ˆ\">è¿™æ˜¯ä»€ä¹ˆ</h2>\n<p>Gin-Framework-DDD æ˜¯ä¸€ä¸ªé¢å‘ Go è¯­è¨€çš„ DDD å·¥ç¨‹è„šæ‰‹æ¶ï¼Œå¸®ä½ å¿«é€Ÿæ­å»ºç¬¦åˆ DDD åˆ†å±‚è§„èŒƒçš„ Web æœåŠ¡ã€‚é¡¹ç›®å†…ç½®ç”¨æˆ·ä¸è®¢å•ç¤ºä¾‹ã€é¢†åŸŸäº‹ä»¶ä¸ RocketMQ ç”Ÿäº§/æ¶ˆè´¹ã€é‚®ä»¶é€šçŸ¥ç¤ºä¾‹ã€ç»Ÿä¸€å“åº”ä¸ä¸­é—´ä»¶ï¼Œé€‚åˆä½œä¸ºå›¢é˜Ÿå·¥ç¨‹æ¨¡æ¿æˆ–æ•™å­¦ç¤ºä¾‹ã€‚</p>\n<h2 id=\"ä¸ºä»€ä¹ˆè¦ç”¨ddd\">ä¸ºä»€ä¹ˆè¦ç”¨DDDï¼Ÿ</h2>\n<p>å¾ˆå¤šäººè®¤ä¸º Go è¯­è¨€æ²¡å¿…è¦ç”¨ DDDï¼Œæ¯•ç«Ÿå®ƒå’Œ Pythonã€JS ä¸€æ ·è½»å·§çµæ´»ï¼Œç”¨ MVC å°±è¶³å¤Ÿäº†ã€‚ç¡®å®ï¼Œå¤§å¤šæ•°åœºæ™¯ä¸‹ MVC å®Œå…¨å¤Ÿç”¨ã€‚å·¥ç¨‹åŒ–æ— éæ˜¯æŠŠæ¥å£å¤„ç†ã€ä¸šåŠ¡é€»è¾‘ã€æ•°æ®å¤„ç†åŒºåˆ†å¼€ï¼Œè®©å„éƒ¨åˆ†å„å¸å…¶èŒï¼Œæ–¹ä¾¿ç»´æŠ¤å’Œæ‰©å±•ã€‚DDD ç›¸å¯¹æ›´é€‚åˆä¸­å¤§å‹é¡¹ç›®ï¼šå¦‚æœé¡¹ç›®æœ‰å‡ åä¸ªæ¨¡å—ã€ä¸Šç™¾ä¸ªæ¥å£ï¼Œç”¨ DDD è®¾è®¡ä¼šæ›´åˆé€‚ï¼›æ¨¡å—å°‘ã€æ¥å£ä¸å¤šçš„è¯ï¼Œç®€å•åˆ†å±‚å°±å¤Ÿäº†ã€‚</p>\n<p>æ€»ä¹‹ï¼Œæ˜¯å¦é‡‡ç”¨ DDD å’Œè¯­è¨€æ— å…³ï¼Œåªè·Ÿä¸šåŠ¡è§„æ¨¡æœ‰å…³ã€‚ä¸€ä¸ªä¸œè¥¿å˜å¤æ‚äº†ï¼Œå°±éœ€è¦ç”¨ä¸€äº›æœºåˆ¶å»è§„èŒƒå®ƒï¼Œæ‰èƒ½æ›´å¥½æŒæ§ã€‚</p>\n<p>æºç åœ°å€ï¼š<a href=\"https://github.com/microwind/design-patterns/tree/main/practice-projects/gin-ddd\" rel=\"noopener nofollow\" target=\"_blank\">https://github.com/microwind/design-patterns/tree/main/practice-projects/gin-ddd</a></p>\n<p>é¡¹ç›®ç›®å½•ï¼š<code>gin-ddd/</code></p>\n<h2 id=\"æ ¸å¿ƒç‰¹ç‚¹\">æ ¸å¿ƒç‰¹ç‚¹</h2>\n<ul>\n<li>ä¸¥æ ¼ DDD å››å±‚æ¶æ„ï¼šé¢†åŸŸå±‚ã€åº”ç”¨å±‚ã€åŸºç¡€è®¾æ–½å±‚ã€æ¥å£å±‚</li>\n<li>Gin Web æ¡†æ¶ï¼šé«˜æ€§èƒ½ HTTP æœåŠ¡</li>\n<li>äº‹ä»¶é©±åŠ¨ï¼šé¢†åŸŸäº‹ä»¶ + RocketMQ ç”Ÿäº§è€…/æ¶ˆè´¹è€…</li>\n<li>åŒæ•°æ®åº“æ”¯æŒï¼šç”¨æˆ·åº“ + è®¢å•åº“å¯ç‹¬ç«‹é…ç½®ï¼ˆé»˜è®¤ MySQL + PostgreSQLï¼‰</li>\n<li>ç»Ÿä¸€å“åº”æ ¼å¼ï¼šResponse å°è£…ï¼Œé”™è¯¯ç é›†ä¸­ç®¡ç†</li>\n<li>å…¨å±€ä¸­é—´ä»¶ï¼šæ—¥å¿—ã€æ¢å¤ã€è·¨åŸŸ</li>\n<li>å¯é€‰é‚®ä»¶é€šçŸ¥ï¼šè®¢å•åˆ›å»ºäº‹ä»¶é©±åŠ¨ SMTP é‚®ä»¶å‘é€</li>\n</ul>\n<h2 id=\"æŠ€æœ¯æ ˆ\">æŠ€æœ¯æ ˆ</h2>\n<table>\n<thead>\n<tr>\n<th>æŠ€æœ¯</th>\n<th>ç‰ˆæœ¬</th>\n<th>è¯´æ˜</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Go</td>\n<td>1.21+</td>\n<td>è¯­è¨€ç‰ˆæœ¬</td>\n</tr>\n<tr>\n<td>Gin</td>\n<td>1.9+</td>\n<td>HTTP æ¡†æ¶</td>\n</tr>\n<tr>\n<td>RocketMQ</td>\n<td>5.3+</td>\n<td>äº‹ä»¶æ¶ˆæ¯é˜Ÿåˆ—</td>\n</tr>\n<tr>\n<td>MySQL</td>\n<td>8.0+</td>\n<td>ç”¨æˆ·åº“é»˜è®¤</td>\n</tr>\n<tr>\n<td>PostgreSQL</td>\n<td>14+</td>\n<td>è®¢å•åº“é»˜è®¤</td>\n</tr>\n<tr>\n<td>YAML</td>\n<td>-</td>\n<td>é…ç½®æ–‡ä»¶æ ¼å¼</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"å·¥ç¨‹ç»“æ„\">å·¥ç¨‹ç»“æ„</h2>\n<h3 id=\"å·¥ç¨‹ç»“æ„å›¾\">å·¥ç¨‹ç»“æ„å›¾</h3>\n<div class=\"mermaid\">flowchart TB\n    subgraph æ¥å£å±‚\n        Handler[HTTP Handler / è·¯ç”±]\n    end\n\n    subgraph åº”ç”¨å±‚\n        AppService[åº”ç”¨æœåŠ¡]\n    end\n\n    subgraph é¢†åŸŸå±‚\n        DomainService[é¢†åŸŸæœåŠ¡]\n        Model[èšåˆæ ¹/å®ä½“]\n        RepoInterface[ä»“å‚¨æ¥å£]\n        NotificationInterface[é€šçŸ¥æ¥å£]\n    end\n\n    subgraph åŸºç¡€è®¾æ–½å±‚\n        RepoImpl[ä»“å‚¨å®ç°]\n        Mail[é‚®ä»¶æœåŠ¡]\n        MQ[æ¶ˆæ¯é˜Ÿåˆ—]\n        DB[(æ•°æ®åº“)]\n    end\n\n    Handler --&gt; AppService\n    AppService --&gt; DomainService\n    AppService --&gt; RepoInterface\n    DomainService --&gt; Model\n    DomainService --&gt; NotificationInterface\n    RepoInterface -.å®ç°.-&gt; RepoImpl\n    NotificationInterface -.å®ç°.-&gt; Mail\n    RepoImpl --&gt; DB\n    AppService -.å‘å¸ƒäº‹ä»¶.-&gt; MQ\n</div><h3 id=\"å·¥ç¨‹ç»“æ„åˆ—è¡¨\">å·¥ç¨‹ç»“æ„åˆ—è¡¨</h3>\n<pre><code>gin-ddd/\nâ”œâ”€â”€ cmd/server/main.go                            # å¯åŠ¨å…¥å£ï¼Œè£…é…å„å±‚å¹¶å¯åŠ¨ HTTP + MQ\nâ”œâ”€â”€ config/config.yaml                            # åº”ç”¨é…ç½®\nâ”œâ”€â”€ docs/init.sql                                 # MySQL åˆå§‹åŒ–è„šæœ¬ï¼ˆç¤ºä¾‹ï¼‰\nâ”œâ”€â”€ internal/\nâ”‚   â”œâ”€â”€ domain/                                   # é¢†åŸŸå±‚\nâ”‚   â”‚   â”œâ”€â”€ model/\nâ”‚   â”‚   â”‚   â”œâ”€â”€ order/order.go                    # è®¢å•èšåˆæ ¹\nâ”‚   â”‚   â”‚   â””â”€â”€ user/user.go                      # ç”¨æˆ·èšåˆæ ¹\nâ”‚   â”‚   â”œâ”€â”€ repository/                           # ä»“å‚¨æ¥å£\nâ”‚   â”‚   â”‚   â”œâ”€â”€ order/order_repository.go\nâ”‚   â”‚   â”‚   â””â”€â”€ user/user_repository.go\nâ”‚   â”‚   â”œâ”€â”€ event/                                # é¢†åŸŸäº‹ä»¶\nâ”‚   â”‚   â”‚   â”œâ”€â”€ domain_event.go\nâ”‚   â”‚   â”‚   â”œâ”€â”€ order_event.go\nâ”‚   â”‚   â”‚   â”œâ”€â”€ user_event.go\nâ”‚   â”‚   â”‚   â””â”€â”€ event_publisher.go\nâ”‚   â”‚   â”œâ”€â”€ notification/mail_service.go          # é€šçŸ¥é¢†åŸŸæ¥å£ï¼ˆé‚®ä»¶ï¼‰\nâ”‚   â”‚   â””â”€â”€ service/                              # é¢†åŸŸæœåŠ¡ï¼ˆé¢„ç•™ï¼‰\nâ”‚   â”œâ”€â”€ application/                              # åº”ç”¨å±‚\nâ”‚   â”‚   â”œâ”€â”€ dto/\nâ”‚   â”‚   â”‚   â”œâ”€â”€ order/order_dto.go\nâ”‚   â”‚   â”‚   â””â”€â”€ user/user_dto.go\nâ”‚   â”‚   â””â”€â”€ service/\nâ”‚   â”‚       â”œâ”€â”€ order/order_service.go            # è®¢å•åº”ç”¨æœåŠ¡ï¼ˆå‘å¸ƒäº‹ä»¶ï¼‰\nâ”‚   â”‚       â””â”€â”€ user/user_service.go              # ç”¨æˆ·åº”ç”¨æœåŠ¡\nâ”‚   â”œâ”€â”€ infrastructure/                           # åŸºç¡€è®¾æ–½å±‚\nâ”‚   â”‚   â”œâ”€â”€ config/                               # é…ç½®ä¸ DB åˆå§‹åŒ–\nâ”‚   â”‚   â”œâ”€â”€ persistence/                          # ä»“å‚¨å®ç°\nâ”‚   â”‚   â”‚   â”œâ”€â”€ order/order_repository_impl.go\nâ”‚   â”‚   â”‚   â””â”€â”€ user/user_repository_impl.go\nâ”‚   â”‚   â”œâ”€â”€ mq/                                   # RocketMQ å®ç°\nâ”‚   â”‚   â”‚   â”œâ”€â”€ rocketmq_producer.go\nâ”‚   â”‚   â”‚   â””â”€â”€ rocketmq_consumer.go\nâ”‚   â”‚   â”œâ”€â”€ mail/                                 # SMTP é‚®ä»¶å®ç°\nâ”‚   â”‚   â”œâ”€â”€ middleware/                           # Gin ä¸­é—´ä»¶\nâ”‚   â”‚   â”œâ”€â”€ common/response.go                    # ç»Ÿä¸€å“åº”\nâ”‚   â”‚   â””â”€â”€ constants/error_code.go               # é”™è¯¯ç \nâ”‚   â””â”€â”€ interfaces/                               # æ¥å£å±‚\nâ”‚       â”œâ”€â”€ handler/                              # HTTP å¤„ç†å™¨\nâ”‚       â”œâ”€â”€ router/                               # è·¯ç”±é…ç½®\nâ”‚       â””â”€â”€ vo/                                   # è¯·æ±‚/å“åº”å¯¹è±¡\nâ””â”€â”€ pkg/utils/                                    # æ—¥å¿—ç­‰å·¥å…·\n</code></pre>\n<h2 id=\"å„å±‚èŒè´£è¯´æ˜\">å„å±‚èŒè´£è¯´æ˜</h2>\n<table>\n<thead>\n<tr>\n<th>å±‚çº§</th>\n<th>ä½ç½®</th>\n<th>èŒè´£</th>\n<th>å…³é”®åŸåˆ™</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>é¢†åŸŸå±‚</td>\n<td><code>internal/domain/</code></td>\n<td>é¢†åŸŸæ¨¡å‹ã€è§„åˆ™ä¸äº‹ä»¶</td>\n<td>ä¸ä¾èµ–æ¡†æ¶ã€ä¸šåŠ¡é€»è¾‘å†…èš</td>\n</tr>\n<tr>\n<td>åº”ç”¨å±‚</td>\n<td><code>internal/application/</code></td>\n<td>ç¼–æ’é¢†åŸŸå¯¹è±¡ã€äº‹åŠ¡è¾¹ç•Œ</td>\n<td>è–„è€Œæ¸…æ™°ï¼Œä¸å®ç°ä¸šåŠ¡è§„åˆ™</td>\n</tr>\n<tr>\n<td>åŸºç¡€è®¾æ–½å±‚</td>\n<td><code>internal/infrastructure/</code></td>\n<td>DBã€MQã€é‚®ä»¶ç­‰æŠ€æœ¯ç»†èŠ‚</td>\n<td>å‘ä¸Šæä¾›å®ç°ï¼Œç»†èŠ‚ä¸‹æ²‰</td>\n</tr>\n<tr>\n<td>æ¥å£å±‚</td>\n<td><code>internal/interfaces/</code></td>\n<td>HTTP è¯·æ±‚/å“åº”ä¸è·¯ç”±</td>\n<td>å¤„ç†å¤–éƒ¨äº¤äº’ï¼Œä¸å«ä¸šåŠ¡è§„åˆ™</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"å¿«é€Ÿå¼€å§‹\">å¿«é€Ÿå¼€å§‹</h2>\n<h3 id=\"1-ç¯å¢ƒå‡†å¤‡\">1. ç¯å¢ƒå‡†å¤‡</h3>\n<ul>\n<li>Go 1.21+</li>\n<li>MySQL 8.0+ ä¸ PostgreSQL 14+ï¼ˆæˆ–è‡ªè¡Œé€‰æ‹©å…¶ä¸€ï¼‰</li>\n<li>RocketMQ 5.3+ï¼ˆå¯é€‰ï¼‰</li>\n</ul>\n<h3 id=\"2-åˆå§‹åŒ–æ•°æ®åº“\">2. åˆå§‹åŒ–æ•°æ®åº“</h3>\n<p>é»˜è®¤é…ç½®ä½¿ç”¨åŒæ•°æ®åº“ï¼š</p>\n<ul>\n<li>ç”¨æˆ·åº“ï¼šMySQL</li>\n<li>è®¢å•åº“ï¼šPostgreSQL</li>\n</ul>\n<p>MySQL ç”¨æˆ·åº“ç¤ºä¾‹ï¼ˆå¯ç›´æ¥ç”¨ <code>docs/init.sql</code> ä½œä¸ºèµ·ç‚¹ï¼‰ï¼š</p>\n<pre><code class=\"language-sql\">CREATE DATABASE IF NOT EXISTS gin_ddd CHARACTER SET utf8mb4;\nUSE gin_ddd;\n\nCREATE TABLE IF NOT EXISTS users (\n    id BIGINT AUTO_INCREMENT PRIMARY KEY,\n    name VARCHAR(50) NOT NULL UNIQUE,\n    email VARCHAR(100) NOT NULL UNIQUE,\n    phone VARCHAR(20),\n    created_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n    updated_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP\n);\n</code></pre>\n<p>PostgreSQL è®¢å•åº“ç¤ºä¾‹ï¼ˆä¸å½“å‰è®¢å•ä»“å‚¨å­—æ®µä¸€è‡´ï¼‰ï¼š</p>\n<pre><code class=\"language-sql\">CREATE DATABASE seed;\n\\c seed;\n\nCREATE TABLE IF NOT EXISTS orders (\n    id BIGSERIAL PRIMARY KEY,\n    order_no VARCHAR(50) NOT NULL UNIQUE,\n    user_id BIGINT NOT NULL,\n    total_amount DECIMAL(10, 2) NOT NULL DEFAULT 0.00,\n    status VARCHAR(20) NOT NULL DEFAULT 'PENDING',\n    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP\n);\n</code></pre>\n<p>æ•°æ®åº“é€‚é…æ³¨æ„ï¼š</p>\n<ul>\n<li>è‹¥è®¢å•åº“æ”¹ä¸º MySQLï¼Œéœ€è¦å°† SQL å ä½ç¬¦ä» <code>$1</code> å½¢å¼æ”¹ä¸º <code>?</code></li>\n<li>è‹¥ç”¨æˆ·åº“æ”¹ä¸º PostgreSQLï¼Œéœ€è¦å°†æ’å…¥ ID è·å–é€»è¾‘æ”¹ä¸º <code>RETURNING id</code></li>\n</ul>\n<h3 id=\"3-é…ç½®åº”ç”¨\">3. é…ç½®åº”ç”¨</h3>\n<p>ç¼–è¾‘ <code>config/config.yaml</code>ï¼Œè‡³å°‘é…ç½®æ•°æ®åº“ä¸ RocketMQï¼š</p>\n<pre><code class=\"language-yaml\">server:\n  host: \"0.0.0.0\"\n  port: 8080\n  mode: \"debug\"\n\ndatabase:\n  user:\n    driver: \"mysql\"\n    host: \"localhost\"\n    port: 3306\n    username: \"root\"\n    password: \"your_password\"\n    database: \"gin_ddd\"\n  order:\n    driver: \"postgres\"\n    host: \"localhost\"\n    port: 5432\n    username: \"postgres\"\n    password: \"your_password\"\n    database: \"seed\"\n\nrocketmq:\n  enabled: true\n  nameserver: \"localhost:9876\"\n  group_name: \"gin-ddd-group\"\n  instance_name: \"gin-ddd-instance\"\n  topics:\n    order_event: \"order-event-topic\"\n</code></pre>\n<p>è¯´æ˜ï¼š</p>\n<ul>\n<li><code>rocketmq.enabled: true</code> æ‰ä¼šåˆå§‹åŒ–ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…</li>\n<li>å½“å‰è®¢å•äº‹ä»¶ Topic åœ¨ä»£ç ä¸­ä½¿ç”¨å›ºå®šå€¼ <code>order-event-topic</code>ï¼Œéœ€ä¸é…ç½®ä¿æŒä¸€è‡´</li>\n</ul>\n<h3 id=\"4-å¯åŠ¨-rocketmqå¯é€‰\">4. å¯åŠ¨ RocketMQï¼ˆå¯é€‰ï¼‰</h3>\n<pre><code class=\"language-bash\">sh bin/mqnamesrv\nsh bin/mqbroker -n localhost:9876\n</code></pre>\n<h3 id=\"5-å¯åŠ¨åº”ç”¨\">5. å¯åŠ¨åº”ç”¨</h3>\n<pre><code class=\"language-bash\">go mod tidy\ngo run cmd/server/main.go\n</code></pre>\n<h3 id=\"6-éªŒè¯æ¥å£\">6. éªŒè¯æ¥å£</h3>\n<pre><code class=\"language-bash\">curl http://localhost:8080/health\ncurl http://localhost:8080/api/users\ncurl http://localhost:8080/api/orders\n</code></pre>\n<h2 id=\"å¦‚ä½•åŸºäºè„šæ‰‹æ¶å¼€å‘æ–°åŠŸèƒ½\">å¦‚ä½•åŸºäºè„šæ‰‹æ¶å¼€å‘æ–°åŠŸèƒ½</h2>\n<p>ç¤ºä¾‹ï¼šæ–°å¢â€œå•†å“ç®¡ç†â€æ¨¡å—</p>\n<p>æ­¥éª¤ 1ï¼šæ–°å¢é¢†åŸŸæ¨¡å‹ <code>internal/domain/model/product/product.go</code></p>\n<pre><code class=\"language-go\">package product\n\nimport \"time\"\n\ntype Product struct {\n\tID        int64\n\tName      string\n\tPrice     float64\n\tStock     int\n\tCreatedAt time.Time\n\tUpdatedAt time.Time\n}\n</code></pre>\n<p>æ­¥éª¤ 2ï¼šæ–°å¢ä»“å‚¨æ¥å£ <code>internal/domain/repository/product/product_repository.go</code></p>\n<pre><code class=\"language-go\">package product\n\nimport (\n\t\"context\"\n\t\"gin-ddd/internal/domain/model/product\"\n)\n\ntype ProductRepository interface {\n\tCreate(ctx context.Context, p *product.Product) error\n\tUpdate(ctx context.Context, p *product.Product) error\n\tFindByID(ctx context.Context, id int64) (*product.Product, error)\n\tFindAll(ctx context.Context) ([]*product.Product, error)\n}\n</code></pre>\n<p>æ­¥éª¤ 3ï¼šæ–°å¢ä»“å‚¨å®ç° <code>internal/infrastructure/persistence/product/product_repository_impl.go</code></p>\n<pre><code class=\"language-go\">package product\n\nimport (\n\t\"context\"\n\t\"database/sql\"\n\t\"gin-ddd/internal/domain/model/product\"\n)\n\ntype ProductRepositoryImpl struct {\n\tdb *sql.DB\n}\n\nfunc NewProductRepository(db *sql.DB) *ProductRepositoryImpl {\n\treturn &amp;ProductRepositoryImpl{db: db}\n}\n\nfunc (r *ProductRepositoryImpl) Create(ctx context.Context, p *product.Product) error {\n\t_, err := r.db.ExecContext(ctx,\n\t\t`INSERT INTO products (name, price, stock, created_at, updated_at) VALUES (?, ?, ?, ?, ?)`,\n\t\tp.Name, p.Price, p.Stock, p.CreatedAt, p.UpdatedAt,\n\t)\n\treturn err\n}\n</code></pre>\n<p>æ­¥éª¤ 4ï¼šæ–°å¢åº”ç”¨æœåŠ¡ <code>internal/application/service/product/product_service.go</code></p>\n<pre><code class=\"language-go\">package product\n\nimport (\n\t\"context\"\n\t\"time\"\n\t\"gin-ddd/internal/domain/model/product\"\n\tproductDomain \"gin-ddd/internal/domain/repository/product\"\n)\n\ntype ProductService struct {\n\trepo productDomain.ProductRepository\n}\n\nfunc NewProductService(repo productDomain.ProductRepository) *ProductService {\n\treturn &amp;ProductService{repo: repo}\n}\n\nfunc (s *ProductService) Create(ctx context.Context, name string, price float64, stock int) error {\n\tp := &amp;product.Product{\n\t\tName:      name,\n\t\tPrice:     price,\n\t\tStock:     stock,\n\t\tCreatedAt: time.Now(),\n\t\tUpdatedAt: time.Now(),\n\t}\n\treturn s.repo.Create(ctx, p)\n}\n</code></pre>\n<p>æ­¥éª¤ 5ï¼šæ–°å¢ HTTP Handler å’Œè·¯ç”±</p>\n<p>å°†è¯·æ±‚/å“åº”å¯¹è±¡æ”¾åˆ° <code>internal/interfaces/vo/product/</code>ï¼ŒHandler æ”¾åˆ° <code>internal/interfaces/handler/product/</code>ï¼Œå¹¶åœ¨ <code>internal/interfaces/router/router.go</code> ä¸­æ³¨å†Œè·¯ç”±ã€‚</p>\n<p>æ­¥éª¤ 6ï¼šæ–°å¢æ•°æ®åº“è¡¨</p>\n<pre><code class=\"language-sql\">CREATE TABLE IF NOT EXISTS products (\n    id BIGINT AUTO_INCREMENT PRIMARY KEY,\n    name VARCHAR(100) NOT NULL,\n    price DECIMAL(10, 2) NOT NULL,\n    stock INT NOT NULL DEFAULT 0,\n    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP\n);\n</code></pre>\n<h2 id=\"äº‹ä»¶é©±åŠ¨ä¸-rocketmq\">äº‹ä»¶é©±åŠ¨ä¸ RocketMQ</h2>\n<h3 id=\"äº‹ä»¶ç±»å‹\">äº‹ä»¶ç±»å‹</h3>\n<p>è®¢å•äº‹ä»¶ï¼š</p>\n<ul>\n<li>order.created</li>\n<li>order.paid</li>\n<li>order.shipped</li>\n<li>order.delivered</li>\n<li>order.cancelled</li>\n<li>order.refunded</li>\n</ul>\n<p>ç”¨æˆ·äº‹ä»¶ï¼š</p>\n<ul>\n<li>user.created</li>\n<li>user.activated</li>\n<li>user.deactivated</li>\n<li>user.blocked</li>\n<li>user.deleted</li>\n</ul>\n<h3 id=\"æ¶ˆæ¯æµè½¬\">æ¶ˆæ¯æµè½¬</h3>\n<pre><code>HTTP è¯·æ±‚ -&gt; Application Service -&gt; Domain Model\n            -&gt; å‘å¸ƒ DomainEvent -&gt; RocketMQ Producer\n            -&gt; RocketMQ Broker -&gt; Consumer\n            -&gt; äº‹ä»¶å¤„ç† -&gt; å‘é€é‚®ä»¶/è§¦å‘åç»­æµç¨‹\n</code></pre>\n<h3 id=\"äº‹ä»¶å‘å¸ƒä¸æ¶ˆè´¹å…³é”®ç‚¹\">äº‹ä»¶å‘å¸ƒä¸æ¶ˆè´¹å…³é”®ç‚¹</h3>\n<ul>\n<li>è®¢å•åˆ›å»ºåä¼šå‘å¸ƒ <code>order.created</code> äº‹ä»¶ï¼ˆå‘å¸ƒå¤±è´¥ä¸ä¼šå½±å“ä¸»æµç¨‹ï¼‰</li>\n<li>æ¶ˆè´¹ç«¯æŒ‰ Tag è§£æä¸º <code>OrderEvent</code> æˆ– <code>UserEvent</code></li>\n<li>è®¢å•é‚®ä»¶é€šçŸ¥ä»…åœ¨ <code>order.created</code> ä¸”å¯ç”¨é‚®ä»¶æ—¶è§¦å‘</li>\n</ul>\n<h2 id=\"é‚®ä»¶å‘é€é…ç½®qq-é‚®ç®±\">é‚®ä»¶å‘é€é…ç½®ï¼ˆQQ é‚®ç®±ï¼‰</h2>\n<p>åœ¨ <code>config/config.yaml</code> ä¸­å¼€å¯é‚®ä»¶é…ç½®ï¼š</p>\n<pre><code class=\"language-yaml\">mail:\n  enabled: true\n  host: \"smtp.qq.com\"\n  port: 465\n  username: \"your@qq.com\"\n  password: \"ä½ çš„SMTPæˆæƒç \"\n  from_email: \"your@qq.com\"\n  from_name: \"è®¢å•ç³»ç»Ÿ\"\n</code></pre>\n<p>æ³¨æ„äº‹é¡¹ï¼š</p>\n<ul>\n<li>å¿…é¡»ä½¿ç”¨ SMTP æˆæƒç ï¼Œä¸æ˜¯ QQ ç™»å½•å¯†ç </li>\n<li>ç«¯å£ 465 ä½¿ç”¨ TLSï¼Œç«¯å£ 587 ä½¿ç”¨ STARTTLS</li>\n<li>æ”¶ä»¶äººå–è‡ªç”¨æˆ·è¡¨ä¸­çš„ <code>email</code> å­—æ®µ</li>\n</ul>\n<h2 id=\"å¸¸è§é—®é¢˜æ’æŸ¥\">å¸¸è§é—®é¢˜æ’æŸ¥</h2>\n<ul>\n<li>æ—¥å¿—æç¤ºâ€œäº‹ä»¶å‘å¸ƒå™¨æœªåˆå§‹åŒ–â€ï¼šRocketMQ æœªå¯ç”¨æˆ–åˆå§‹åŒ–å¤±è´¥</li>\n<li>è®¢å•äº‹ä»¶å·²å‘é€ä½†é‚®ä»¶æœªåˆ°ï¼šç¡®è®¤ç”¨æˆ·é‚®ç®±å­—æ®µæ­£ç¡®ï¼Œä¸” SMTP æˆæƒç å¯ç”¨</li>\n<li>æ¶ˆè´¹è€…æ²¡æœ‰æ”¶åˆ°æ¶ˆæ¯ï¼šç¡®è®¤ Topic ä¸ Tag æ­£ç¡®ã€Broker å¯åŠ¨æ­£å¸¸</li>\n</ul>\n<h2 id=\"å¼€å‘è§„èŒƒ\">å¼€å‘è§„èŒƒ</h2>\n<p>å‘½åå»ºè®®ï¼š</p>\n<ul>\n<li>é¢†åŸŸæ¨¡å‹ï¼šåè¯ï¼Œå¦‚ <code>Order</code>ã€<code>User</code></li>\n<li>åº”ç”¨æœåŠ¡ï¼š<code>XxxService</code></li>\n<li>ä»“å‚¨æ¥å£ï¼š<code>XxxRepository</code></li>\n<li>ä»“å‚¨å®ç°ï¼š<code>XxxRepositoryImpl</code></li>\n<li>Handlerï¼š<code>XxxHandler</code></li>\n</ul>\n<p>åˆ†å±‚åŸåˆ™ï¼š</p>\n<ul>\n<li>é¢†åŸŸå±‚ä¸ä¾èµ–åŸºç¡€è®¾æ–½</li>\n<li>åº”ç”¨å±‚åªåšç¼–æ’ä¸äº‹åŠ¡åè°ƒ</li>\n<li>åŸºç¡€è®¾æ–½æä¾›æŠ€æœ¯å®ç°</li>\n<li>æ¥å£å±‚åªè´Ÿè´£ HTTP äº¤äº’</li>\n</ul>\n<h2 id=\"å¸¸ç”¨å‘½ä»¤\">å¸¸ç”¨å‘½ä»¤</h2>\n<pre><code class=\"language-bash\">go mod tidy\ngo test ./...\n</code></pre>\n<h2 id=\"æºç åœ°å€\">æºç åœ°å€</h2>\n<p><a href=\"https://github.com/microwind/design-patterns/tree/main/practice-projects/gin-ddd\" rel=\"noopener nofollow\" target=\"_blank\">https://github.com/microwind/design-patterns/tree/main/practice-projects/gin-ddd</a></p>\n\n\n</div>\n<div class=\"clear\"></div>\n\n\t\t</div>\n\t\t<div class=\"postDesc\">posted @ \n<span id=\"post-date\">2026-02-13 09:19</span>&nbsp;\n<a href=\"https://www.cnblogs.com/letjs\">åˆ€æ³•å¦‚é£</a>&nbsp;\né˜…è¯»(<span id=\"post_view_count\">32</span>)&nbsp;\nè¯„è®º(<span id=\"post_comment_count\">0</span>)&nbsp;\n&nbsp;\n<a href=\"\">æ”¶è—</a>&nbsp;\n<a href=\"\">ä¸¾æŠ¥</a>\n</div>"
    },
    {
      "title": "LockSupportæ·±åº¦è§£æï¼šçº¿ç¨‹é˜»å¡ä¸å”¤é†’çš„åº•å±‚å®ç°åŸç†",
      "link": "https://www.cnblogs.com/sevencoding/p/19588531",
      "published": "",
      "description": "<h1 class=\"postTitle\">\n                <a class=\"postTitle2 vertical-middle\" href=\"https://www.cnblogs.com/sevencoding/p/19588531\" id=\"cb_post_title_url\" title=\"å‘å¸ƒäº 2026-02-13 09:00\">\n    <span>LockSupportæ·±åº¦è§£æï¼šçº¿ç¨‹é˜»å¡ä¸å”¤é†’çš„åº•å±‚å®ç°åŸç†</span>\n    \n\n</a>\n\n            </h1>\n            <div class=\"clear\"></div>\n            <div class=\"postBody\">\n                <div class=\"blogpost-body cnblogs-markdown\" id=\"cnblogs_post_body\">\n<h2 id=\"locksupportç®€ä»‹\">LockSupportç®€ä»‹</h2>\n<p>LockSupprot ç”¨æ¥é˜»å¡å’Œå”¤é†’çº¿ç¨‹ï¼Œåº•å±‚å®ç°ä¾èµ–äº&nbsp;<a href=\"https://www.seven97.top/java/concurrent/unsafe.html\" rel=\"noopener nofollow\" target=\"_blank\">Unsafe ç±»</a>ã€‚</p>\n<p>LockSupportç”¨æ¥åˆ›å»ºé”å’Œå…¶ä»–åŒæ­¥ç±»çš„åŸºæœ¬çº¿ç¨‹é˜»å¡åŸè¯­ã€‚ç®€è€Œè¨€ä¹‹ï¼Œå½“è°ƒç”¨LockSupport.parkæ—¶ï¼Œè¡¨ç¤ºå½“å‰çº¿ç¨‹å°†ä¼šç­‰å¾…ï¼Œç›´è‡³è·å¾—è®¸å¯ï¼Œå½“è°ƒç”¨LockSupport.unparkæ—¶ï¼Œå¿…é¡»æŠŠç­‰å¾…è·å¾—è®¸å¯çš„çº¿ç¨‹ä½œä¸ºå‚æ•°è¿›è¡Œä¼ é€’ï¼Œå¥½è®©æ­¤çº¿ç¨‹ç»§ç»­è¿è¡Œã€‚åœ¨AQSä¸­å¤§é‡ä½¿ç”¨ï¼ŒAQSæœ€ç»ˆéƒ½æ˜¯ä½¿ç”¨LockSupportæ¥é˜»å¡çº¿ç¨‹çš„ã€‚</p>\n<p>è¯¥ç±»åŒ…å«ä¸€ç»„ç”¨äºé˜»å¡å’Œå”¤é†’çº¿ç¨‹çš„é™æ€æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•ä¸»è¦æ˜¯å›´ç»• park å’Œ unpark å±•å¼€ï¼Œè¯ä¸å¤šè¯´ï¼Œç›´æ¥æ¥çœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­å§ã€‚</p>\n<pre><code class=\"language-java\">public class LockSupportDemo1 {\n    public static void main(String[] args) {\n        Thread mainThread = Thread.currentThread();\n\n        // åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ä»1æ•°åˆ°1000\n        Thread counterThread = new Thread(() -&gt; {\n            for (int i = 1; i &lt;= 1000; i++) {\n                System.out.println(i);\n                if (i == 500) {\n                    // å½“æ•°åˆ°500æ—¶ï¼Œå”¤é†’ä¸»çº¿ç¨‹\n                    LockSupport.unpark(mainThread);\n                }\n            }\n        });\n\n        counterThread.start();\n\n        // ä¸»çº¿ç¨‹è°ƒç”¨park\n        LockSupport.park();\n        System.out.println(\"Main thread was unparked.\");\n    }\n}\n</code></pre>\n<p>ä¸Šé¢çš„ä»£ç ä¸­ï¼Œå½“ counterThread æ•°åˆ° 500 æ—¶ï¼Œå®ƒä¼šå”¤é†’ mainThreadã€‚è€Œ mainThread åœ¨è°ƒç”¨ park æ–¹æ³•æ—¶ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°è¢« unparkã€‚</p>\n<p>LockSupport ä¸­çš„æ–¹æ³•ä¸å¤šï¼Œè¿™é‡Œå°†è¿™äº›æ–¹æ³•åšä¸€ä¸ªæ€»ç»“ï¼š</p>\n<h3 id=\"é˜»å¡çº¿ç¨‹\">é˜»å¡çº¿ç¨‹</h3>\n<ol>\n<li><code>void park()</code>ï¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œå¦‚æœè°ƒç”¨ unpark æ–¹æ³•æˆ–çº¿ç¨‹è¢«ä¸­æ–­ï¼Œåˆ™è¯¥çº¿ç¨‹å°†å˜å¾—å¯è¿è¡Œã€‚è¯·æ³¨æ„ï¼Œpark ä¸ä¼šæŠ›å‡º InterruptedExceptionï¼Œå› æ­¤çº¿ç¨‹å¿…é¡»å•ç‹¬æ£€æŸ¥å…¶ä¸­æ–­çŠ¶æ€ã€‚</li>\n<li><code>void park(Object blocker)</code>ï¼šåŠŸèƒ½åŒæ–¹æ³• 1ï¼Œå…¥å‚å¢åŠ ä¸€ä¸ª Object å¯¹è±¡ï¼Œç”¨æ¥è®°å½•å¯¼è‡´çº¿ç¨‹é˜»å¡çš„å¯¹è±¡ï¼Œæ–¹ä¾¿é—®é¢˜æ’æŸ¥ã€‚</li>\n<li><code>void parkNanos(long nanos)</code>ï¼šé˜»å¡å½“å‰çº¿ç¨‹ä¸€å®šçš„çº³ç§’æ—¶é—´ï¼Œæˆ–ç›´åˆ°è¢« unpark è°ƒç”¨ï¼Œæˆ–çº¿ç¨‹è¢«ä¸­æ–­ã€‚</li>\n<li><code>void parkNanos(Object blocker, long nanos)</code>ï¼šåŠŸèƒ½åŒæ–¹æ³• 3ï¼Œå…¥å‚å¢åŠ ä¸€ä¸ª Object å¯¹è±¡ï¼Œç”¨æ¥è®°å½•å¯¼è‡´çº¿ç¨‹é˜»å¡çš„å¯¹è±¡ï¼Œæ–¹ä¾¿é—®é¢˜æ’æŸ¥ã€‚</li>\n<li><code>void parkUntil(long deadline)</code>ï¼šé˜»å¡å½“å‰çº¿ç¨‹ç›´åˆ°æŸä¸ªæŒ‡å®šçš„æˆªæ­¢æ—¶é—´ï¼ˆä»¥æ¯«ç§’ä¸ºå•ä½ï¼‰ï¼Œæˆ–ç›´åˆ°è¢« unpark è°ƒç”¨ï¼Œæˆ–çº¿ç¨‹è¢«ä¸­æ–­ã€‚</li>\n<li><code>void parkUntil(Object blocker, long deadline)</code>ï¼šåŠŸèƒ½åŒæ–¹æ³• 5ï¼Œå…¥å‚å¢åŠ ä¸€ä¸ª Object å¯¹è±¡ï¼Œç”¨æ¥è®°å½•å¯¼è‡´çº¿ç¨‹é˜»å¡çš„å¯¹è±¡ï¼Œæ–¹ä¾¿é—®é¢˜æ’æŸ¥ã€‚</li>\n</ol>\n<h3 id=\"å”¤é†’çº¿ç¨‹\">å”¤é†’çº¿ç¨‹</h3>\n<p><code>void unpark(Thread thread)</code>ï¼šå”¤é†’ä¸€ä¸ªç”± park æ–¹æ³•é˜»å¡çš„çº¿ç¨‹ã€‚å¦‚æœè¯¥çº¿ç¨‹æœªè¢«é˜»å¡ï¼Œé‚£ä¹ˆä¸‹ä¸€æ¬¡è°ƒç”¨ park æ—¶å°†ç«‹å³è¿”å›ã€‚è¿™å…è®¸â€œå…ˆå‘åˆ¶äººâ€å¼çš„å”¤é†’æœºåˆ¶ã€‚</p>\n<p>å®é™…ä¸Šï¼ŒLockSupport é˜»å¡å’Œå”¤é†’çº¿ç¨‹çš„åŠŸèƒ½ä¾èµ–äº&nbsp;<code>sun.misc.Unsafe</code>ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆåº•å±‚çš„ç±»ï¼Œæ¯”å¦‚ LockSupport çš„ park æ–¹æ³•æ˜¯é€šè¿‡&nbsp;<code>unsafe.park()</code>&nbsp;æ–¹æ³•å®ç°çš„ã€‚</p>\n<h2 id=\"locksupportæºç åˆ†æ\">LockSupportæºç åˆ†æ</h2>\n<h3 id=\"ç±»çš„å±æ€§\">ç±»çš„å±æ€§</h3>\n<pre><code class=\"language-java\">public class LockSupport {\n    // Hotspot implementation via intrinsics API\n    private static final sun.misc.Unsafe UNSAFE;\n    // è¡¨ç¤ºå†…å­˜åç§»åœ°å€\n    private static final long parkBlockerOffset;\n    // è¡¨ç¤ºå†…å­˜åç§»åœ°å€\n    private static final long SEED;\n    // è¡¨ç¤ºå†…å­˜åç§»åœ°å€\n    private static final long PROBE;\n    // è¡¨ç¤ºå†…å­˜åç§»åœ°å€\n    private static final long SECONDARY;\n    \n    static {\n        try {\n            // è·å–Unsafeå®ä¾‹\n            UNSAFE = sun.misc.Unsafe.getUnsafe();\n            // çº¿ç¨‹ç±»ç±»å‹\n            Class&lt;?&gt; tk = Thread.class;\n            // è·å–Threadçš„parkBlockerå­—æ®µçš„å†…å­˜åç§»åœ°å€\n            parkBlockerOffset = UNSAFE.objectFieldOffset\n                (tk.getDeclaredField(\"parkBlocker\"));\n            // è·å–Threadçš„threadLocalRandomSeedå­—æ®µçš„å†…å­˜åç§»åœ°å€\n            SEED = UNSAFE.objectFieldOffset\n                (tk.getDeclaredField(\"threadLocalRandomSeed\"));\n            // è·å–Threadçš„threadLocalRandomProbeå­—æ®µçš„å†…å­˜åç§»åœ°å€\n            PROBE = UNSAFE.objectFieldOffset\n                (tk.getDeclaredField(\"threadLocalRandomProbe\"));\n            // è·å–Threadçš„threadLocalRandomSecondarySeedå­—æ®µçš„å†…å­˜åç§»åœ°å€\n            SECONDARY = UNSAFE.objectFieldOffset\n                (tk.getDeclaredField(\"threadLocalRandomSecondarySeed\"));\n        } catch (Exception ex) { throw new Error(ex); }\n    }\n}\n</code></pre>\n<p>è¯´æ˜: UNSAFEå­—æ®µè¡¨ç¤º<a href=\"https://www.seven97.top/java/concurrent/unsafe.html\" rel=\"noopener nofollow\" target=\"_blank\">sun.misc.Unsafe</a>ç±»ï¼Œä¸€èˆ¬ç¨‹åºä¸­ä¸å…è®¸ç›´æ¥è°ƒç”¨ï¼Œè€Œlongå‹çš„è¡¨ç¤ºå®ä¾‹å¯¹è±¡ç›¸åº”å­—æ®µåœ¨å†…å­˜ä¸­çš„åç§»åœ°å€ï¼Œå¯ä»¥é€šè¿‡è¯¥åç§»åœ°å€è·å–æˆ–è€…è®¾ç½®è¯¥å­—æ®µçš„å€¼ã€‚</p>\n<h3 id=\"ç±»çš„æ„é€ å‡½æ•°\">ç±»çš„æ„é€ å‡½æ•°</h3>\n<pre><code class=\"language-java\">// ç§æœ‰æ„é€ å‡½æ•°ï¼Œæ— æ³•è¢«å®ä¾‹åŒ–\nprivate LockSupport() {}\n</code></pre>\n<p>è¯´æ˜: LockSupportåªæœ‰ä¸€ä¸ªç§æœ‰æ„é€ å‡½æ•°ï¼Œæ— æ³•è¢«å®ä¾‹åŒ–ã€‚</p>\n<h3 id=\"æ ¸å¿ƒå‡½æ•°åˆ†æ\">æ ¸å¿ƒå‡½æ•°åˆ†æ</h3>\n<p>åœ¨åˆ†æLockSupportå‡½æ•°ä¹‹å‰ï¼Œå…ˆå¼•å…¥sun.misc.Unsafeç±»ä¸­çš„parkå’Œunparkå‡½æ•°ï¼Œå› ä¸ºLockSupportçš„æ ¸å¿ƒå‡½æ•°éƒ½æ˜¯åŸºäºUnsafeç±»ä¸­å®šä¹‰çš„parkå’Œunparkå‡½æ•°ï¼Œä¸‹é¢ç»™å‡ºä¸¤ä¸ªå‡½æ•°çš„å®šä¹‰:</p>\n<pre><code class=\"language-java\">public native void park(boolean isAbsolute, long time);\npublic native void unpark(Thread thread);\n</code></pre>\n<p>è¯´æ˜: å¯¹ä¸¤ä¸ªå‡½æ•°çš„è¯´æ˜å¦‚ä¸‹:</p>\n<ul>\n<li>\n<p>parkå‡½æ•°ï¼Œé˜»å¡çº¿ç¨‹ï¼Œå¹¶ä¸”è¯¥çº¿ç¨‹åœ¨ä¸‹åˆ—æƒ…å†µå‘ç”Ÿä¹‹å‰éƒ½ä¼šè¢«é˜»å¡:</p>\n<ul>\n<li>\n<p>è°ƒç”¨unparkå‡½æ•°ï¼Œé‡Šæ”¾è¯¥çº¿ç¨‹çš„è®¸å¯ã€‚</p>\n</li>\n<li>\n<p>è¯¥çº¿ç¨‹è¢«ä¸­æ–­ã€‚</p>\n</li>\n<li>\n<p>è®¾ç½®çš„æ—¶é—´åˆ°äº†ã€‚å¹¶ä¸”ï¼Œå½“timeä¸ºç»å¯¹æ—¶é—´æ—¶ï¼ŒisAbsoluteä¸ºtrueï¼Œå¦åˆ™ï¼ŒisAbsoluteä¸ºfalseã€‚å½“timeä¸º0æ—¶ï¼Œè¡¨ç¤ºæ— é™ç­‰å¾…ï¼Œç›´åˆ°unparkå‘ç”Ÿã€‚</p>\n</li>\n</ul>\n</li>\n<li>\n<p>unparkå‡½æ•°ï¼Œé‡Šæ”¾çº¿ç¨‹çš„è®¸å¯ï¼Œå³æ¿€æ´»è°ƒç”¨parkåé˜»å¡çš„çº¿ç¨‹ã€‚è¿™ä¸ªå‡½æ•°ä¸æ˜¯å®‰å…¨çš„ï¼Œè°ƒç”¨è¿™ä¸ªå‡½æ•°æ—¶è¦ç¡®ä¿çº¿ç¨‹ä¾æ—§å­˜æ´»ã€‚</p>\n</li>\n</ul>\n<h4 id=\"parkå‡½æ•°\">parkå‡½æ•°</h4>\n<p>parkå‡½æ•°æœ‰ä¸¤ä¸ªé‡è½½ç‰ˆæœ¬ï¼Œæ–¹æ³•æ‘˜è¦å¦‚ä¸‹</p>\n<pre><code class=\"language-java\">public static void park()ï¼›\npublic static void park(Object blocker)ï¼›\n</code></pre>\n<p>è¯´æ˜: ä¸¤ä¸ªå‡½æ•°çš„åŒºåˆ«åœ¨äºpark()å‡½æ•°æ²¡æœ‰æ²¡æœ‰blockerï¼Œå³æ²¡æœ‰è®¾ç½®çº¿ç¨‹çš„parkBlockerå­—æ®µã€‚park(Object)å‹å‡½æ•°å¦‚ä¸‹ã€‚</p>\n<pre><code class=\"language-java\">public static void park(Object blocker) {\n    // è·å–å½“å‰çº¿ç¨‹\n    Thread t = Thread.currentThread();\n    // è®¾ç½®Blocker\n    setBlocker(t, blocker);\n    // è·å–è®¸å¯\n    UNSAFE.park(false, 0L);\n    // é‡æ–°å¯è¿è¡Œåå†æ­¤è®¾ç½®Blocker\n    setBlocker(t, null);\n}\n</code></pre>\n<p>è¯´æ˜: è°ƒç”¨parkå‡½æ•°æ—¶ï¼Œé¦–å…ˆè·å–å½“å‰çº¿ç¨‹ï¼Œç„¶åè®¾ç½®å½“å‰çº¿ç¨‹çš„parkBlockerå­—æ®µï¼Œå³è°ƒç”¨setBlockerå‡½æ•°ï¼Œä¹‹åè°ƒç”¨Unsafeç±»çš„parkå‡½æ•°ï¼Œä¹‹åå†è°ƒç”¨setBlockerå‡½æ•°ã€‚é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œä¸ºä»€ä¹ˆè¦åœ¨æ­¤parkå‡½æ•°ä¸­è¦è°ƒç”¨ä¸¤æ¬¡setBlockerå‡½æ•°å‘¢? åŸå› å…¶å®å¾ˆç®€å•ï¼Œè°ƒç”¨parkå‡½æ•°æ—¶ï¼Œå½“å‰çº¿ç¨‹é¦–å…ˆè®¾ç½®å¥½parkBlockerå­—æ®µï¼Œç„¶åå†è°ƒç”¨Unsafeçš„parkå‡½æ•°ï¼Œæ­¤åï¼Œå½“å‰çº¿ç¨‹å°±å·²ç»é˜»å¡äº†ï¼Œç­‰å¾…è¯¥çº¿ç¨‹çš„unparkå‡½æ•°è¢«è°ƒç”¨ï¼Œæ‰€ä»¥åé¢çš„ä¸€ä¸ªsetBlockerå‡½æ•°æ— æ³•è¿è¡Œï¼Œunparkå‡½æ•°è¢«è°ƒç”¨ï¼Œè¯¥çº¿ç¨‹è·å¾—è®¸å¯åï¼Œå°±å¯ä»¥ç»§ç»­è¿è¡Œäº†ï¼Œä¹Ÿå°±è¿è¡Œç¬¬äºŒä¸ªsetBlockerï¼ŒæŠŠè¯¥çº¿ç¨‹çš„parkBlockerå­—æ®µè®¾ç½®ä¸ºnullï¼Œè¿™æ ·å°±å®Œæˆäº†æ•´ä¸ªparkå‡½æ•°çš„é€»è¾‘ã€‚å¦‚æœæ²¡æœ‰ç¬¬äºŒä¸ªsetBlockerï¼Œé‚£ä¹ˆä¹‹åæ²¡æœ‰è°ƒç”¨park(Object blocker)ï¼Œè€Œç›´æ¥è°ƒç”¨getBlockerå‡½æ•°ï¼Œå¾—åˆ°çš„è¿˜æ˜¯å‰ä¸€ä¸ªpark(Object blocker)è®¾ç½®çš„blockerï¼Œæ˜¾ç„¶æ˜¯ä¸ç¬¦åˆé€»è¾‘çš„ã€‚æ€»ä¹‹ï¼Œå¿…é¡»è¦ä¿è¯åœ¨park(Object blocker)æ•´ä¸ªå‡½æ•°æ‰§è¡Œå®Œåï¼Œè¯¥çº¿ç¨‹çš„parkBlockerå­—æ®µåˆæ¢å¤ä¸ºnullã€‚æ‰€ä»¥ï¼Œpark(Object)å‹å‡½æ•°é‡Œå¿…é¡»è¦è°ƒç”¨setBlockerå‡½æ•°ä¸¤æ¬¡ã€‚setBlockeræ–¹æ³•å¦‚ä¸‹ã€‚</p>\n<pre><code class=\"language-java\">private static void setBlocker(Thread t, Object arg) {\n    // è®¾ç½®çº¿ç¨‹tçš„parkBlockerå­—æ®µçš„å€¼ä¸ºarg\n    UNSAFE.putObject(t, parkBlockerOffset, arg);\n}\n</code></pre>\n<p>è¯´æ˜: æ­¤æ–¹æ³•ç”¨äºè®¾ç½®çº¿ç¨‹tçš„parkBlockerå­—æ®µçš„å€¼ä¸ºargã€‚</p>\n<p>å¦å¤–ä¸€ä¸ªæ— å‚é‡è½½ç‰ˆæœ¬ï¼Œpark()å‡½æ•°å¦‚ä¸‹ã€‚</p>\n<pre><code class=\"language-java\">public static void park() {\n    // è·å–è®¸å¯ï¼Œè®¾ç½®æ—¶é—´ä¸ºæ— é™é•¿ï¼Œç›´åˆ°å¯ä»¥è·å–è®¸å¯\n    UNSAFE.park(false, 0L);\n}\n</code></pre>\n<p>è¯´æ˜: è°ƒç”¨äº†parkå‡½æ•°åï¼Œä¼šç¦ç”¨å½“å‰çº¿ç¨‹ï¼Œé™¤éè®¸å¯å¯ç”¨ã€‚åœ¨ä»¥ä¸‹ä¸‰ç§æƒ…å†µä¹‹ä¸€å‘ç”Ÿä¹‹å‰ï¼Œå½“å‰çº¿ç¨‹éƒ½å°†å¤„äºä¼‘çœ çŠ¶æ€ï¼Œå³ä¸‹åˆ—æƒ…å†µå‘ç”Ÿæ—¶ï¼Œå½“å‰çº¿ç¨‹ä¼šè·å–è®¸å¯ï¼Œå¯ä»¥ç»§ç»­è¿è¡Œã€‚</p>\n<ul>\n<li>\n<p>å…¶ä»–æŸä¸ªçº¿ç¨‹å°†å½“å‰çº¿ç¨‹ä½œä¸ºç›®æ ‡è°ƒç”¨ unparkã€‚</p>\n</li>\n<li>\n<p>å…¶ä»–æŸä¸ªçº¿ç¨‹ä¸­æ–­å½“å‰çº¿ç¨‹ã€‚</p>\n</li>\n<li>\n<p>è¯¥è°ƒç”¨ä¸åˆé€»è¾‘åœ°(å³æ¯«æ— ç†ç”±åœ°)è¿”å›ã€‚</p>\n</li>\n</ul>\n<h4 id=\"parknanoså‡½æ•°\">parkNanoså‡½æ•°</h4>\n<p>æ­¤å‡½æ•°è¡¨ç¤ºåœ¨è®¸å¯å¯ç”¨å‰ç¦ç”¨å½“å‰çº¿ç¨‹ï¼Œå¹¶æœ€å¤šç­‰å¾…æŒ‡å®šçš„ç­‰å¾…æ—¶é—´ã€‚å…·ä½“å‡½æ•°å¦‚ä¸‹ã€‚</p>\n<pre><code class=\"language-java\">public static void parkNanos(Object blocker, long nanos) {\n    if (nanos &gt; 0) { // æ—¶é—´å¤§äº0\n        // è·å–å½“å‰çº¿ç¨‹\n        Thread t = Thread.currentThread();\n        // è®¾ç½®Blocker\n        setBlocker(t, blocker);\n        // è·å–è®¸å¯ï¼Œå¹¶è®¾ç½®äº†æ—¶é—´\n        UNSAFE.park(false, nanos);\n        // è®¾ç½®è®¸å¯\n        setBlocker(t, null);\n    }\n}\n</code></pre>\n<p>è¯´æ˜: è¯¥å‡½æ•°ä¹Ÿæ˜¯è°ƒç”¨äº†ä¸¤æ¬¡setBlockerå‡½æ•°ï¼Œnanoså‚æ•°è¡¨ç¤ºç›¸å¯¹æ—¶é—´ï¼Œè¡¨ç¤ºç­‰å¾…å¤šé•¿æ—¶é—´ã€‚</p>\n<h4 id=\"parkuntilå‡½æ•°\">parkUntilå‡½æ•°</h4>\n<p>æ­¤å‡½æ•°è¡¨ç¤ºåœ¨æŒ‡å®šçš„æ—¶é™å‰ç¦ç”¨å½“å‰çº¿ç¨‹ï¼Œé™¤éè®¸å¯å¯ç”¨, å…·ä½“å‡½æ•°å¦‚ä¸‹:</p>\n<pre><code class=\"language-java\">public static void parkUntil(Object blocker, long deadline) {\n    // è·å–å½“å‰çº¿ç¨‹\n    Thread t = Thread.currentThread();\n    // è®¾ç½®Blocker\n    setBlocker(t, blocker);\n    UNSAFE.park(true, deadline);\n    // è®¾ç½®Blockerä¸ºnull\n    setBlocker(t, null);\n}\n</code></pre>\n<p>è¯´æ˜: è¯¥å‡½æ•°ä¹Ÿè°ƒç”¨äº†ä¸¤æ¬¡setBlockerå‡½æ•°ï¼Œdeadlineå‚æ•°è¡¨ç¤ºç»å¯¹æ—¶é—´ï¼Œè¡¨ç¤ºæŒ‡å®šçš„æ—¶é—´ã€‚</p>\n<h4 id=\"unparkå‡½æ•°\">unparkå‡½æ•°</h4>\n<p>æ­¤å‡½æ•°è¡¨ç¤ºå¦‚æœç»™å®šçº¿ç¨‹çš„è®¸å¯å°šä¸å¯ç”¨ï¼Œåˆ™ä½¿å…¶å¯ç”¨ã€‚å¦‚æœçº¿ç¨‹åœ¨ park ä¸Šå—é˜»å¡ï¼Œåˆ™å®ƒå°†è§£é™¤å…¶é˜»å¡çŠ¶æ€ã€‚å¦åˆ™ï¼Œä¿è¯ä¸‹ä¸€æ¬¡è°ƒç”¨ park ä¸ä¼šå—é˜»å¡ã€‚å¦‚æœç»™å®šçº¿ç¨‹å°šæœªå¯åŠ¨ï¼Œåˆ™æ— æ³•ä¿è¯æ­¤æ“ä½œæœ‰ä»»ä½•æ•ˆæœã€‚å…·ä½“å‡½æ•°å¦‚ä¸‹:</p>\n<pre><code class=\"language-java\">public static void unpark(Thread thread) {\n    if (thread != null) // çº¿ç¨‹ä¸ºä¸ç©º\n        UNSAFE.unpark(thread); // é‡Šæ”¾è¯¥çº¿ç¨‹è®¸å¯\n}\n</code></pre>\n<p>è¯´æ˜: é‡Šæ”¾è®¸å¯ï¼ŒæŒ‡å®šçº¿ç¨‹å¯ä»¥ç»§ç»­è¿è¡Œã€‚</p>\n<h2 id=\"æ›´æ·±å…¥çš„ç†è§£\">æ›´æ·±å…¥çš„ç†è§£</h2>\n<h3 id=\"ä¸-synchronzed-çš„åŒºåˆ«\">ä¸ synchronzed çš„åŒºåˆ«</h3>\n<p><a href=\"https://www.seven97.top/java/concurrent/02-keyword1-synchronized.html\" rel=\"noopener nofollow\" target=\"_blank\">synchronzed</a>&nbsp;ä¼šä½¿çº¿ç¨‹é˜»å¡ï¼Œçº¿ç¨‹ä¼šè¿›å…¥ BLOCKED çŠ¶æ€ï¼Œè€Œè°ƒç”¨ LockSupprt æ–¹æ³•é˜»å¡çº¿ç¨‹ä¼šä½¿çº¿ç¨‹è¿›å…¥åˆ° WAITING çŠ¶æ€ã€‚</p>\n<h3 id=\"threadsleepå’Œobjectwaitçš„åŒºåˆ«\">Thread.sleep()å’ŒObject.wait()çš„åŒºåˆ«</h3>\n<p>é¦–å…ˆï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹Thread.sleep()å’ŒObject.wait()çš„åŒºåˆ«ï¼Œè¿™æ˜¯ä¸€ä¸ªçƒ‚å¤§è¡—çš„é¢˜ç›®äº†ï¼Œå¤§å®¶åº”è¯¥éƒ½èƒ½è¯´ä¸Šæ¥ä¸¤ç‚¹ã€‚</p>\n<ul>\n<li>\n<p>Thread.sleep()ä¸ä¼šé‡Šæ”¾å æœ‰çš„é”ï¼ŒObject.wait()ä¼šé‡Šæ”¾å æœ‰çš„é”ï¼›</p>\n</li>\n<li>\n<p>Thread.sleep()å¿…é¡»ä¼ å…¥æ—¶é—´ï¼ŒObject.wait()å¯ä¼ å¯ä¸ä¼ ï¼Œä¸ä¼ è¡¨ç¤ºä¸€ç›´é˜»å¡ä¸‹å»ï¼›</p>\n</li>\n<li>\n<p>Thread.sleep()åˆ°æ—¶é—´äº†ä¼šè‡ªåŠ¨å”¤é†’ï¼Œç„¶åç»§ç»­æ‰§è¡Œï¼›</p>\n</li>\n<li>\n<p>Object.wait()ä¸å¸¦æ—¶é—´çš„ï¼Œéœ€è¦å¦ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨Object.notify()å”¤é†’ï¼›</p>\n</li>\n<li>\n<p>Object.wait()å¸¦æ—¶é—´çš„ï¼Œå‡å¦‚æ²¡æœ‰è¢«notifyï¼Œåˆ°æ—¶é—´äº†ä¼šè‡ªåŠ¨å”¤é†’ï¼Œè¿™æ—¶åˆåˆ†å¥½ä¸¤ç§æƒ…å†µï¼Œä¸€æ˜¯ç«‹å³è·å–åˆ°äº†é”ï¼Œçº¿ç¨‹è‡ªç„¶ä¼šç»§ç»­æ‰§è¡Œï¼›äºŒæ˜¯æ²¡æœ‰ç«‹å³è·å–é”ï¼Œçº¿ç¨‹è¿›å…¥åŒæ­¥é˜Ÿåˆ—ç­‰å¾…è·å–é”ï¼›</p>\n</li>\n</ul>\n<p>å…¶å®ï¼Œä»–ä»¬ä¿©æœ€å¤§çš„åŒºåˆ«å°±æ˜¯Thread.sleep()ä¸ä¼šé‡Šæ”¾é”èµ„æºï¼ŒObject.wait()ä¼šé‡Šæ”¾é”èµ„æºã€‚</p>\n<h3 id=\"objectwaitå’Œconditionawaitçš„åŒºåˆ«\">Object.wait()å’ŒCondition.await()çš„åŒºåˆ«</h3>\n<p>Object.wait()å’ŒCondition.await()çš„åŸç†æ˜¯åŸºæœ¬ä¸€è‡´çš„ï¼Œä¸åŒçš„æ˜¯Condition.await()åº•å±‚æ˜¯è°ƒç”¨LockSupport.park()æ¥å®ç°é˜»å¡å½“å‰çº¿ç¨‹çš„ã€‚</p>\n<p>å®é™…ä¸Šï¼Œå®ƒåœ¨é˜»å¡å½“å‰çº¿ç¨‹ä¹‹å‰è¿˜å¹²äº†ä¸¤ä»¶äº‹ï¼Œä¸€æ˜¯æŠŠå½“å‰çº¿ç¨‹æ·»åŠ åˆ°æ¡ä»¶é˜Ÿåˆ—ä¸­ï¼ŒäºŒæ˜¯â€œå®Œå…¨â€é‡Šæ”¾é”ï¼Œä¹Ÿå°±æ˜¯è®©stateçŠ¶æ€å˜é‡å˜ä¸º0ï¼Œç„¶åæ‰æ˜¯è°ƒç”¨LockSupport.park()é˜»å¡å½“å‰çº¿ç¨‹ã€‚</p>\n<h3 id=\"threadsleepå’Œlocksupportparkçš„åŒºåˆ«\">Thread.sleep()å’ŒLockSupport.park()çš„åŒºåˆ«</h3>\n<p>LockSupport.park()è¿˜æœ‰å‡ ä¸ªå…„å¼Ÿæ–¹æ³•â€”â€”parkNanos()ã€parkUtil()ç­‰ï¼Œæˆ‘ä»¬è¿™é‡Œè¯´çš„park()æ–¹æ³•ç»Ÿç§°è¿™ä¸€ç±»æ–¹æ³•ã€‚</p>\n<ul>\n<li>\n<p>ä»åŠŸèƒ½ä¸Šæ¥è¯´ï¼ŒThread.sleep()å’ŒLockSupport.park()æ–¹æ³•ç±»ä¼¼ï¼Œéƒ½æ˜¯é˜»å¡å½“å‰çº¿ç¨‹çš„æ‰§è¡Œï¼Œä¸”éƒ½ä¸ä¼šé‡Šæ”¾å½“å‰çº¿ç¨‹å æœ‰çš„é”èµ„æºï¼›</p>\n</li>\n<li>\n<p>Thread.sleep()æ²¡æ³•ä»å¤–éƒ¨å”¤é†’ï¼Œåªèƒ½è‡ªå·±é†’è¿‡æ¥ï¼›</p>\n</li>\n<li>\n<p>LockSupport.park()æ–¹æ³•å¯ä»¥è¢«å¦ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨LockSupport.unpark()æ–¹æ³•å”¤é†’ï¼›</p>\n</li>\n<li>\n<p>Thread.sleep()æ–¹æ³•å£°æ˜ä¸ŠæŠ›å‡ºäº†InterruptedExceptionä¸­æ–­å¼‚å¸¸ï¼Œæ‰€ä»¥è°ƒç”¨è€…éœ€è¦æ•è·è¿™ä¸ªå¼‚å¸¸æˆ–è€…å†æŠ›å‡ºï¼›</p>\n</li>\n<li>\n<p>LockSupport.park()æ–¹æ³•ä¸éœ€è¦æ•è·ä¸­æ–­å¼‚å¸¸ï¼›</p>\n</li>\n<li>\n<p>Thread.sleep()æœ¬èº«å°±æ˜¯ä¸€ä¸ªnativeæ–¹æ³•ï¼›</p>\n</li>\n<li>\n<p>LockSupport.park()åº•å±‚æ˜¯è°ƒç”¨çš„Unsafeçš„nativeæ–¹æ³•ï¼›</p>\n</li>\n</ul>\n<h3 id=\"objectwaitå’Œlocksupportparkçš„åŒºåˆ«\">Object.wait()å’ŒLockSupport.park()çš„åŒºåˆ«</h3>\n<p>äºŒè€…éƒ½ä¼šé˜»å¡å½“å‰çº¿ç¨‹çš„è¿è¡Œï¼Œä»–ä»¬æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢? ç»è¿‡ä¸Šé¢çš„åˆ†æç›¸ä¿¡ä½ ä¸€å®šå¾ˆæ¸…æ¥šäº†ï¼ŒçœŸçš„å—? å¾€ä¸‹çœ‹ï¼</p>\n<ul>\n<li>\n<p>Object.wait()æ–¹æ³•éœ€è¦åœ¨synchronizedå—ä¸­æ‰§è¡Œï¼›</p>\n</li>\n<li>\n<p>LockSupport.park()å¯ä»¥åœ¨ä»»æ„åœ°æ–¹æ‰§è¡Œï¼›</p>\n</li>\n<li>\n<p>Object.wait()æ–¹æ³•å£°æ˜æŠ›å‡ºäº†ä¸­æ–­å¼‚å¸¸ï¼Œè°ƒç”¨è€…éœ€è¦æ•è·æˆ–è€…å†æŠ›å‡ºï¼›</p>\n</li>\n<li>\n<p>LockSupport.park()ä¸éœ€è¦æ•è·ä¸­æ–­å¼‚å¸¸ï¼›</p>\n</li>\n<li>\n<p>Object.wait()ä¸å¸¦è¶…æ—¶çš„ï¼Œéœ€è¦å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œnotify()æ¥å”¤é†’ï¼Œä½†ä¸ä¸€å®šç»§ç»­æ‰§è¡Œåç»­å†…å®¹ï¼›</p>\n</li>\n<li>\n<p>LockSupport.park()ä¸å¸¦è¶…æ—¶çš„ï¼Œéœ€è¦å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œunpark()æ¥å”¤é†’ï¼Œä¸€å®šä¼šç»§ç»­æ‰§è¡Œåç»­å†…å®¹ï¼›</p>\n</li>\n</ul>\n<p>park()/unpark()åº•å±‚çš„åŸç†æ˜¯â€œäºŒå…ƒä¿¡å·é‡â€ï¼Œä½ å¯ä»¥æŠŠå®ƒç›¸åƒæˆåªæœ‰ä¸€ä¸ªè®¸å¯è¯çš„Semaphoreï¼Œåªä¸è¿‡è¿™ä¸ªä¿¡å·é‡åœ¨é‡å¤æ‰§è¡Œunpark()çš„æ—¶å€™ä¹Ÿä¸ä¼šå†å¢åŠ è®¸å¯è¯ï¼Œæœ€å¤šåªæœ‰ä¸€ä¸ªè®¸å¯è¯ã€‚</p>\n<h3 id=\"å¦‚æœåœ¨waitä¹‹å‰æ‰§è¡Œäº†notifyä¼šæ€æ ·\">å¦‚æœåœ¨wait()ä¹‹å‰æ‰§è¡Œäº†notify()ä¼šæ€æ ·?</h3>\n<p>å¦‚æœå½“å‰çš„çº¿ç¨‹ä¸æ˜¯æ­¤å¯¹è±¡é”çš„æ‰€æœ‰è€…ï¼Œå´è°ƒç”¨è¯¥å¯¹è±¡çš„notify()æˆ–wait()æ–¹æ³•æ—¶æŠ›å‡ºIllegalMonitorStateExceptionå¼‚å¸¸ï¼›</p>\n<p>å¦‚æœå½“å‰çº¿ç¨‹æ˜¯æ­¤å¯¹è±¡é”çš„æ‰€æœ‰è€…ï¼Œwait()å°†ä¸€ç›´é˜»å¡ï¼Œå› ä¸ºåç»­å°†æ²¡æœ‰å…¶å®ƒnotify()å”¤é†’å®ƒã€‚</p>\n<h3 id=\"å¦‚æœåœ¨parkä¹‹å‰æ‰§è¡Œäº†unparkä¼šæ€æ ·\">å¦‚æœåœ¨park()ä¹‹å‰æ‰§è¡Œäº†unpark()ä¼šæ€æ ·?</h3>\n<p>çº¿ç¨‹ä¸ä¼šè¢«é˜»å¡ï¼Œç›´æ¥è·³è¿‡park()ï¼Œç»§ç»­æ‰§è¡Œåç»­å†…å®¹</p>\n<h3 id=\"locksupportparkä¼šé‡Šæ”¾é”èµ„æºå—\">LockSupport.park()ä¼šé‡Šæ”¾é”èµ„æºå—?</h3>\n<p>ä¸ä¼šï¼Œå®ƒåªè´Ÿè´£é˜»å¡å½“å‰çº¿ç¨‹ï¼Œé‡Šæ”¾é”èµ„æºå®é™…ä¸Šæ˜¯åœ¨Conditionçš„await()æ–¹æ³•ä¸­å®ç°çš„ã€‚</p>\n\n\n</div>\n<div id=\"MySignature\">\n    <p>æœ¬æ–‡æ¥è‡ªåœ¨çº¿ç½‘ç«™ï¼šsevençš„èœé¸Ÿæˆé•¿ä¹‹è·¯ï¼Œä½œè€…ï¼šsevenï¼Œè½¬è½½è¯·æ³¨æ˜åŸæ–‡é“¾æ¥ï¼šwww.seven97.top</p>\n</div>\n<div class=\"clear\"></div>\n\n            </div>\n            <div class=\"postDesc\">posted @ \n<span id=\"post-date\">2026-02-13 09:00</span>&nbsp;\n<a href=\"https://www.cnblogs.com/sevencoding\">ç¨‹åºå‘˜Seven</a>&nbsp;\né˜…è¯»(<span id=\"post_view_count\">0</span>)&nbsp;\nè¯„è®º(<span id=\"post_comment_count\">0</span>)&nbsp;\n&nbsp;\n<a href=\"\">æ”¶è—</a>&nbsp;\n<a href=\"\">ä¸¾æŠ¥</a>\n</div>"
    },
    {
      "title": "AIå·¥å…·å®è·µæ—¥è®°ï¼ˆäºŒï¼‰ï¼šåœ¨ OpenClaw ä¸­è°ƒç”¨ OpenCode è¿›è¡Œå¼€å‘ä»»åŠ¡",
      "link": "https://www.cnblogs.com/rsls/p/19606311",
      "published": "",
      "description": "<h1 class=\"postTitle\">\n                <a class=\"postTitle2 vertical-middle\" href=\"https://www.cnblogs.com/rsls/p/19606311\" id=\"cb_post_title_url\" title=\"å‘å¸ƒäº 2026-02-13 08:56\">\n    <span>AIå·¥å…·å®è·µæ—¥è®°ï¼ˆäºŒï¼‰ï¼šåœ¨ OpenClaw ä¸­è°ƒç”¨ OpenCode è¿›è¡Œå¼€å‘ä»»åŠ¡</span>\n    \n\n</a>\n\n            </h1>\n            <div class=\"clear\"></div>\n            <div class=\"postBody\">\n                    <div id=\"cnblogs_post_description\" style=\"display: none;\">\n        <img alt=\"AIå·¥å…·å®è·µæ—¥è®°ï¼ˆäºŒï¼‰ï¼šåœ¨ OpenClaw ä¸­è°ƒç”¨ OpenCode è¿›è¡Œå¼€å‘ä»»åŠ¡\" class=\"desc_img\" src=\"https://img2024.cnblogs.com/blog/280247/202602/280247-20260212005137002-1578926574.png\" />\n        AI å¼€å‘éœ€è¦\"æŒ‡æŒ¥ä¸­å¿ƒ\"\n    </div>\n<div class=\"blogpost-body cnblogs-markdown\" id=\"cnblogs_post_body\">\n<h2 id=\"å¼•è¨€ai-å¼€å‘éœ€è¦æŒ‡æŒ¥ä¸­å¿ƒ\">å¼•è¨€ï¼šAI å¼€å‘éœ€è¦\"æŒ‡æŒ¥ä¸­å¿ƒ\"</h2>\n<p>ä¸Šä¸€ç¯‡æ—¥è®°è®²äº†å¦‚ä½•åœ¨æ ‘è“æ´¾ä¸Šæ­å»º OpenClawã€‚è¿™ç¯‡æ¥è¯´è¯´<strong>çœŸæ­£ç”¨ OpenClaw å¹²æ´»</strong>çš„ä½“éªŒã€‚</p>\n<p>ç›´æ¥ç”¨ Claudeã€GPT æˆ– OpenCode å†™ä»£ç æœ‰ä¸ªé—®é¢˜ï¼š<strong>å¯¹è¯æ•£è½åœ¨å„ä¸ªçª—å£ï¼Œè¿›åº¦æ²¡æ³•è¿½è¸ªï¼Œç»“æœä¹Ÿä¸å¥½ç®¡ç†ã€‚</strong></p>\n<p>OpenClaw è§£å†³çš„å°±æ˜¯è¿™ä¸ªé—®é¢˜â€”â€”å®ƒåƒä¸€ä¸ª\"æŒ‡æŒ¥ä¸­å¿ƒ\"ï¼Œè®©ä½ èƒ½ï¼š</p>\n<ul>\n<li>å¯åŠ¨ AI ç¼–ç¨‹ä»»åŠ¡ï¼ˆåå°è¿è¡Œï¼Œä¸é˜»å¡ï¼‰</li>\n<li>å®æ—¶ç›‘æ§è¿›åº¦ï¼ˆéšæ—¶æŸ¥çœ‹è¾“å‡ºï¼‰</li>\n<li>è‡ªåŠ¨å¤„ç†é”™è¯¯ï¼ˆå¡ä½æ—¶è‡ªåŠ¨æ¢å¤æˆ–æŠ¥è­¦ï¼‰</li>\n<li>ç»Ÿä¸€ç®¡ç†ä¸Šä¸‹æ–‡ï¼ˆworkspaceã€memoryã€æŠ€èƒ½ï¼‰</li>\n</ul>\n<p>è¿™ç¯‡æ—¥è®°è®°å½•äº†æˆ‘ç”¨ <strong>OpenClaw + OpenSpec + OpenCode</strong> ç»„åˆå¼€å‘ä»»åŠ¡çœ‹æ¿çš„çœŸå®è¿‡ç¨‹ã€‚</p>\n<hr />\n<h2 id=\"ä¸ºä»€ä¹ˆè¦ç”¨-openspecè§„èŒƒå…ˆäºä»£ç \">ä¸ºä»€ä¹ˆè¦ç”¨ OpenSpecï¼šè§„èŒƒå…ˆäºä»£ç </h2>\n<h3 id=\"ai-ç¼–ç¨‹çš„ç—›ç‚¹\">AI ç¼–ç¨‹çš„ç—›ç‚¹</h3>\n<p>ç”¨ AI å†™ä»£ç å¾ˆæ–¹ä¾¿ï¼Œä½†æœ‰ä¸ªè‡´å‘½é—®é¢˜ï¼š<strong>éœ€æ±‚åªå­˜åœ¨äºèŠå¤©è®°å½•é‡Œã€‚</strong></p>\n<p>æƒ³è±¡è¿™ä¸ªåœºæ™¯ï¼š</p>\n<ul>\n<li>ä½ è·Ÿ Claude è¯´ï¼š\"å¸®æˆ‘åŠ ä¸ªæ ‡ç­¾åŠŸèƒ½\"</li>\n<li>AI å†™å¥½äº†ä»£ç </li>\n<li>ä¸€å‘¨åä½ æƒ³æ”¹è¿™ä¸ªåŠŸèƒ½ï¼Œä½†æ‰¾ä¸åˆ°å½“æ—¶çš„å¯¹è¯</li>\n<li>ä½ é‡æ–°æè¿°éœ€æ±‚ï¼Œä½†æè¿°å¾—ä¸å®Œå…¨ä¸€æ ·</li>\n<li>AI å†™çš„ä»£ç å’Œä¹‹å‰ä¸å…¼å®¹</li>\n</ul>\n<p><strong>ç»“æœï¼šä»£ç ä¸€å›¢ç³Ÿï¼Œè¿˜å¾—è‡ªå·±é‡å†™ã€‚</strong></p>\n<h3 id=\"openspec-æ˜¯ä»€ä¹ˆ\">OpenSpec æ˜¯ä»€ä¹ˆ</h3>\n<p><strong>OpenSpec æ˜¯ä¸€ä¸ªè§„èŒƒé©±åŠ¨å¼€å‘ï¼ˆSpec-Driven Developmentï¼‰æ¡†æ¶ã€‚</strong></p>\n<p>å®ƒçš„æ ¸å¿ƒç†å¿µï¼š<strong>å…ˆå†™è§„èŒƒï¼Œå†å†™ä»£ç ã€‚</strong></p>\n<p>æ‰€æœ‰éœ€æ±‚ã€è®¾è®¡ã€ä»»åŠ¡éƒ½å†™æˆæ–‡æ¡£ï¼Œæ”¾åœ¨ <code>openspec/</code> ç›®å½•ä¸‹ã€‚AI æŒ‰ç…§è§„èŒƒæ–‡æ¡£æ‰§è¡Œï¼Œè€Œä¸æ˜¯æ ¹æ®èŠå¤©å†…å®¹çŒœæµ‹ã€‚</p>\n<h3 id=\"openspec-ç›®å½•ç»“æ„\">OpenSpec ç›®å½•ç»“æ„</h3>\n<pre><code>openspec/\nâ”œâ”€â”€ specs/                    # ç³»ç»Ÿè¡Œä¸ºçš„æºå¤´ï¼ˆå½“å‰çŠ¶æ€ï¼‰\nâ”‚   â””â”€â”€ &lt;domain&gt;/\nâ”‚       â””â”€â”€ spec.md          # ç³»ç»Ÿè§„æ ¼æ–‡æ¡£\nâ”œâ”€â”€ changes/                  # æè®®çš„å˜æ›´ï¼ˆæ¯ä¸ªåŠŸèƒ½ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼‰\nâ”‚   â””â”€â”€ &lt;åŠŸèƒ½å&gt;/\nâ”‚       â”œâ”€â”€ proposal.md      # ä¸ºä»€ä¹ˆè¦åšï¼ˆæ„å›¾å’ŒèŒƒå›´ï¼‰\nâ”‚       â”œâ”€â”€ design.md        # æ€ä¹ˆåšï¼ˆæŠ€æœ¯æ–¹æ¡ˆï¼‰\nâ”‚       â”œâ”€â”€ tasks.md         # ä»»åŠ¡æ¸…å• â­ æœ€å…³é”®\nâ”‚       â””â”€â”€ specs/           # å˜æ›´çš„å…·ä½“è§„æ ¼\nâ””â”€â”€ config.yaml              # é¡¹ç›®é…ç½®\n</code></pre>\n<h3 id=\"ä½¿ç”¨-openspec-çš„å¿…è¦æ€§\">ä½¿ç”¨ OpenSpec çš„å¿…è¦æ€§</h3>\n<p><strong>1. éœ€æ±‚å¯è¿½æº¯</strong></p>\n<table>\n<thead>\n<tr>\n<th>æ–¹å¼</th>\n<th>éœ€æ±‚åœ¨å“ªé‡Œ</th>\n<th>ä¸€ä¸ªæœˆåè¿˜èƒ½æ‰¾åˆ°å—</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>ç›´æ¥èŠå¤©</td>\n<td>èŠå¤©è®°å½•</td>\n<td>âŒ æ‰¾ä¸åˆ°äº†</td>\n</tr>\n<tr>\n<td>OpenSpec</td>\n<td><code>changes/åŠŸèƒ½å/proposal.md</code></td>\n<td>âœ… æ°¸è¿œåœ¨æ–‡ä»¶é‡Œ</td>\n</tr>\n</tbody>\n</table>\n<p><strong>2. è®¾è®¡å¯å¤ç”¨</strong></p>\n<p>è®¾è®¡æ–‡æ¡£ <code>design.md</code> è®°å½•äº†æŠ€æœ¯æ–¹æ¡ˆã€‚ä¸‹æ¬¡é‡åˆ°ç±»ä¼¼åŠŸèƒ½ï¼Œå¯ä»¥ç›´æ¥å‚è€ƒã€‚</p>\n<p><strong>3. ä»»åŠ¡å¯æ‹†åˆ†</strong></p>\n<p><code>tasks.md</code> æŠŠå¤æ‚åŠŸèƒ½æ‹†æˆå¯æ‰§è¡Œçš„å°ä»»åŠ¡ã€‚AI æŒ‰æ¸…å•é€ä¸ªå®Œæˆï¼Œä¸ä¼šé—æ¼ã€‚</p>\n<p><strong>4. è¿›åº¦å¯ç›‘æ§</strong></p>\n<p>æ¯ä¸ªä»»åŠ¡å®Œæˆåï¼ŒAI è¾“å‡º <code>[DONE] ä»»åŠ¡X.X</code>ã€‚ä½ å¯ä»¥å®æ—¶çŸ¥é“ï¼š</p>\n<ul>\n<li>å®Œæˆäº†å¤šå°‘ä»»åŠ¡</li>\n<li>è¿˜å‰©å¤šå°‘ä»»åŠ¡</li>\n<li>æœ‰æ²¡æœ‰å¡ä½</li>\n</ul>\n<p><strong>5. å˜æ›´æœ‰å†å²</strong></p>\n<pre><code class=\"language-bash\"># æŸ¥çœ‹æ‰€æœ‰å˜æ›´\n$ ls openspec/changes/\nadd-archive-feature/    # å½’æ¡£åŠŸèƒ½\nadd-task-tags/          # æ ‡ç­¾åŠŸèƒ½\nmigrate-to-sqlite/      # æ•°æ®åº“è¿ç§»\n\n# æ¯ä¸ªå˜æ›´éƒ½æœ‰å®Œæ•´çš„ææ¡ˆã€è®¾è®¡ã€ä»»åŠ¡è®°å½•\n</code></pre>\n<h3 id=\"ä¸ç”¨-openspec-çš„åæœ\">ä¸ç”¨ OpenSpec çš„åæœ</h3>\n<p>æˆ‘åšè¿‡å¯¹æ¯”å®éªŒï¼š</p>\n<table>\n<thead>\n<tr>\n<th>é¡¹ç›®</th>\n<th>ä½¿ç”¨ OpenSpec</th>\n<th>ä¸ä½¿ç”¨ OpenSpec</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>æ ‡ç­¾åŠŸèƒ½</td>\n<td>6ä¸ªä»»åŠ¡ï¼Œ10åˆ†é’Ÿï¼Œä¸€æ¬¡æˆåŠŸ</td>\n<td>åå¤æ²Ÿé€šï¼Œ30åˆ†é’Ÿï¼Œä»£ç æ··ä¹±</td>\n</tr>\n<tr>\n<td>æ•°æ®åº“è¿ç§»</td>\n<td>24ä¸ªä»»åŠ¡æ‹†æˆ2ä¸ªå˜æ›´ï¼Œ5åˆ†é’Ÿ</td>\n<td>ç›´æ¥è¯´\"è¿ç§»åˆ°SQLite\"ï¼Œå¡ä½</td>\n</tr>\n<tr>\n<td>å¯ç»´æŠ¤æ€§</td>\n<td>3ä¸ªæœˆåä»èƒ½çœ‹æ‡‚è®¾è®¡</td>\n<td>1å‘¨åå¿˜è®°å½“æ—¶æ€ä¹ˆæƒ³çš„</td>\n</tr>\n</tbody>\n</table>\n<p><strong>ç»“è®ºï¼šOpenSpec æ˜¯ AI ç¼–ç¨‹çš„\"åŸºç¡€è®¾æ–½\"ï¼Œä¸ç”¨å®ƒå°±æ˜¯åœ¨è£¸å¥”ã€‚</strong></p>\n<h3 id=\"openspec-å·¥ä½œæµç¨‹\">OpenSpec å·¥ä½œæµç¨‹</h3>\n<pre><code>1. æœ‰æ–°éœ€æ±‚\n   â†“\n2. åˆ›å»ºå˜æ›´\n   $ openspec change new åŠŸèƒ½å\n   â†“\n3. ç¼–å†™è§„èŒƒæ–‡æ¡£\n   - proposal.mdï¼ˆä¸ºä»€ä¹ˆè¦åšï¼‰\n   - design.mdï¼ˆæ€ä¹ˆåšï¼‰\n   - tasks.mdï¼ˆä»»åŠ¡æ¸…å•ï¼‰\n   â†“\n4. è®© AI æ‰§è¡Œ\n   $ opencode run \"æŒ‰ tasks.md å®ç°\"\n   â†“\n5. éªŒè¯ç»“æœ\n   - åŠŸèƒ½æµ‹è¯•\n   - ä»£ç å®¡æŸ¥\n   â†“\n6. å½’æ¡£å˜æ›´\n   $ openspec change archive åŠŸèƒ½å\n   â†“\n7. æ›´æ–°ç³»ç»Ÿè§„æ ¼\n   - æŠŠå˜æ›´åˆå¹¶åˆ° specs/\n</code></pre>\n<hr />\n<h2 id=\"å·¥å…·é“¾ä»‹ç»\">å·¥å…·é“¾ä»‹ç»</h2>\n<h3 id=\"openclawai-æŒ‡æŒ¥ä¸­å¿ƒ\">OpenClawï¼šAI æŒ‡æŒ¥ä¸­å¿ƒ</h3>\n<p>OpenClaw æ˜¯ä¸€ä¸ª AI åŠ©æ‰‹å¹³å°ï¼Œæ ¸å¿ƒèƒ½åŠ›ï¼š</p>\n<table>\n<thead>\n<tr>\n<th>åŠŸèƒ½</th>\n<th>è¯´æ˜</th>\n<th>å‘½ä»¤</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>å¯åŠ¨åå°ä»»åŠ¡</td>\n<td>ä¸é˜»å¡å½“å‰ä¼šè¯</td>\n<td><code>sessions_spawn task:\"...\"</code></td>\n</tr>\n<tr>\n<td>å®æ—¶ç›‘æ§</td>\n<td>æŸ¥çœ‹ä»»åŠ¡è¾“å‡ºå’Œè¿›åº¦</td>\n<td><code>sessions_history sessionKey:\"...\"</code></td>\n</tr>\n<tr>\n<td>ä»»åŠ¡ç®¡ç†</td>\n<td>åˆ—å‡ºå‘é€æ¶ˆæ¯ã€å¼ºåˆ¶åœæ­¢</td>\n<td><code>sessions_list</code>, <code>sessions_send</code>, <code>process action:kill</code></td>\n</tr>\n<tr>\n<td>ä¸Šä¸‹æ–‡ç®¡ç†</td>\n<td>è‡ªåŠ¨è¯»å– workspaceã€memory</td>\n<td>å†…ç½®</td>\n</tr>\n<tr>\n<td>é”™è¯¯å¤„ç†</td>\n<td>è‡ªåŠ¨æ£€æµ‹å’Œæ¢å¤</td>\n<td>å†…ç½®</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"opencodeai-ç¼–ç¨‹ä»£ç†\">OpenCodeï¼šAI ç¼–ç¨‹ä»£ç†</h3>\n<p>OpenCode è¯»å– OpenSpec è§„èŒƒï¼Œè‡ªåŠ¨å†™ä»£ç ã€‚æ”¯æŒå¤šç§è°ƒç”¨æ–¹å¼ï¼š</p>\n<ol>\n<li><strong>å‘½ä»¤è¡Œ</strong>ï¼š<code>opencode run \"å®ç°åŠŸèƒ½\"</code></li>\n<li><strong>OpenClaw exec</strong>ï¼š<code>exec command:\"opencode run ...\"</code></li>\n<li><strong>OpenClaw sessions_spawn</strong>ï¼š<code>sessions_spawn task:\"...\"</code> â­æ¨è</li>\n</ol>\n<hr />\n<h2 id=\"å®æˆ˜ä¸€æ ‡ç­¾åŠŸèƒ½å¼€å‘\">å®æˆ˜ä¸€ï¼šæ ‡ç­¾åŠŸèƒ½å¼€å‘</h2>\n<h3 id=\"éœ€æ±‚\">éœ€æ±‚</h3>\n<p>ç»™ä»»åŠ¡çœ‹æ¿æ·»åŠ <strong>æ ‡ç­¾åŠŸèƒ½</strong>ï¼š</p>\n<ul>\n<li>æ”¯æŒä¸ºä»»åŠ¡æ·»åŠ å¤šä¸ªæ ‡ç­¾</li>\n<li>å¯ä»¥æŒ‰æ ‡ç­¾ç­›é€‰ä»»åŠ¡</li>\n<li>æ ‡ç­¾æ˜¾ç¤ºåœ¨ä»»åŠ¡å¡ç‰‡ä¸Š</li>\n</ul>\n<h3 id=\"openclaw-æ‰§è¡Œæµç¨‹\">OpenClaw æ‰§è¡Œæµç¨‹</h3>\n<p><strong>ç¬¬ä¸€æ­¥ï¼šåˆ›å»º OpenSpec è§„èŒƒ</strong></p>\n<pre><code class=\"language-bash\">cd aimier-kanban\nopenspec change new add-task-tags\n</code></pre>\n<p>ç¼–è¾‘ <code>openspec/changes/add-task-tags/tasks.md</code>ï¼š</p>\n<pre><code class=\"language-markdown\"># Tasks: Add Task Tags\n\n## 1. Backend\n- [ ] 1.1 Add tags field to task data structure\n- [ ] 1.2 Update create_task API to support tags\n- [ ] 1.3 Create GET /api/tags endpoint\n\n## 2. Frontend\n- [ ] 2.1 Add tag input box in task modal\n- [ ] 2.2 Display tags on task cards\n- [ ] 2.3 Add tag filter dropdown\n</code></pre>\n<p><strong>ç¬¬äºŒæ­¥ï¼šé€šè¿‡ OpenClaw å¯åŠ¨ OpenCode</strong></p>\n<pre><code class=\"language-bash\"># åœ¨ OpenClaw ä¸­æ‰§è¡Œ\nsessions_spawn task:\"æŒ‰ç…§ openspec/changes/add-task-tags/tasks.md å®ç°ä»»åŠ¡æ ‡ç­¾åŠŸèƒ½\"\n  label:\"implement-task-tags\"\n  timeoutSeconds:600\n</code></pre>\n<p><strong>ç¬¬ä¸‰æ­¥ï¼šå®æ—¶ç›‘æ§è¿›åº¦</strong></p>\n<pre><code class=\"language-bash\"># æŸ¥çœ‹ä»»åŠ¡åˆ—è¡¨\n$ sessions_list\n\n# æŸ¥çœ‹å…·ä½“è¾“å‡ºï¼ˆæ¯30ç§’æ£€æŸ¥ä¸€æ¬¡ï¼‰\n$ sessions_history sessionKey:\"agent:main:subagent:implement-task-tags\" limit:50\n\n# è¾“å‡ºç¤ºä¾‹ï¼š\n[DONE] ä»»åŠ¡1.1: æ·»åŠ  tags å­—æ®µåˆ°ä»»åŠ¡æ•°æ®ç»“æ„\n[DONE] ä»»åŠ¡1.2: ä¿®æ”¹åˆ›å»ºä»»åŠ¡ API\n[DONE] ä»»åŠ¡1.3: åˆ›å»ºæ ‡ç­¾åˆ—è¡¨ API\n[DONE] ä»»åŠ¡2.1: åœ¨ä»»åŠ¡æ¨¡æ€æ¡†æ·»åŠ æ ‡ç­¾è¾“å…¥\n[DONE] ä»»åŠ¡2.2: åœ¨ä»»åŠ¡å¡ç‰‡æ˜¾ç¤ºæ ‡ç­¾\n[DONE] ä»»åŠ¡2.3: æ·»åŠ æ ‡ç­¾ç­›é€‰åŠŸèƒ½\n[ALL DONE]\n</code></pre>\n<p><strong>ç¬¬å››æ­¥ï¼šéªŒè¯ç»“æœ</strong></p>\n<pre><code class=\"language-bash\"># æ£€æŸ¥ä»£ç è¯­æ³•\nexec command:\"cd aimier-kanban &amp;&amp; python3 -m py_compile app.py\"\n\n# æµ‹è¯•åŠŸèƒ½\n# å¯åŠ¨æœåŠ¡ï¼Œåœ¨æµè§ˆå™¨éªŒè¯æ ‡ç­¾åŠŸèƒ½\n</code></pre>\n<h3 id=\"ç»“æœ\">ç»“æœ</h3>\n<ul>\n<li>âœ… 6 ä¸ªä»»åŠ¡å…¨éƒ¨å®Œæˆ</li>\n<li>âœ… è€—æ—¶çº¦ 10 åˆ†é’Ÿ</li>\n<li>âœ… ä»£ç è´¨é‡ç¬¦åˆé¢„æœŸ</li>\n<li>âœ… æ— éœ€äººå·¥å¹²é¢„</li>\n</ul>\n<hr />\n<h2 id=\"å®æˆ˜äºŒsqlite-æ•°æ®åº“è¿ç§»å¤æ‚åŠŸèƒ½\">å®æˆ˜äºŒï¼šSQLite æ•°æ®åº“è¿ç§»ï¼ˆå¤æ‚åŠŸèƒ½ï¼‰</h2>\n<h3 id=\"éœ€æ±‚-1\">éœ€æ±‚</h3>\n<p>æŠŠä»»åŠ¡çœ‹æ¿ä» JSON æ–‡ä»¶å­˜å‚¨è¿ç§»åˆ° SQLite æ•°æ®åº“ã€‚</p>\n<p><strong>å¤æ‚åº¦è¯„ä¼°ï¼š</strong></p>\n<ul>\n<li>æ•°æ®åº“åˆå§‹åŒ–ï¼š4 ä¸ªä»»åŠ¡</li>\n<li>æ•°æ®è¿ç§»ï¼š4 ä¸ªä»»åŠ¡</li>\n<li>API æ›´æ–°ï¼š16 ä¸ªä»»åŠ¡ï¼ˆ<strong>è¿‡å¤šï¼</strong>ï¼‰</li>\n</ul>\n<h3 id=\"ä»»åŠ¡æ‹†åˆ†ç­–ç•¥\">ä»»åŠ¡æ‹†åˆ†ç­–ç•¥</h3>\n<p>ç›´æ¥è®© OpenCode å®ç° 24 ä¸ªä»»åŠ¡ä¼šå¡ä½ã€‚æˆ‘çš„ç­–ç•¥ï¼š<strong>æ‹†åˆ†ä¸ºä¸¤ä¸ªå˜æ›´</strong>ã€‚</p>\n<p><strong>å˜æ›´1ï¼šsqlite-databaseï¼ˆ8ä¸ªä»»åŠ¡ï¼‰</strong></p>\n<pre><code class=\"language-markdown\"># Tasks: SQLite Database Layer\n\n## 1. Database Setup\n- [ ] 1.1 Import sqlite3 module\n- [ ] 1.2 Create database connection helper\n- [ ] 1.3 Add init_db() function\n- [ ] 1.4 Create tasks table schema\n\n## 2. Data Migration\n- [ ] 2.1 Load existing tasks from JSON\n- [ ] 2.2 Insert tasks into SQLite\n- [ ] 2.3 Migrate archived tasks\n- [ ] 2.4 Verify migration success\n</code></pre>\n<p><strong>å˜æ›´2ï¼šsqlite-apiï¼ˆ16ä¸ªä»»åŠ¡ï¼‰</strong></p>\n<pre><code class=\"language-markdown\"># Tasks: Update API to use SQLite\n\n## 1. Backend Refactor\n- [ ] 1.1 Update load_tasks() to use SQL\n- [ ] 1.2 Update save_task() to use SQL INSERT/UPDATE\n- [ ] 1.3 Update delete_task() to use SQL DELETE\n- [ ] 1.4 Update archive functions\n\n## 2. API Endpoints\n- [ ] 2.1 Update GET /api/tasks\n- [ ] 2.2 Update POST /api/tasks\n- [ ] 2.3 Update PATCH /api/tasks/&lt;id&gt;\n- [ ] 2.4 Update DELETE /api/tasks/&lt;id&gt;\n- [ ] 2.5 Update PATCH /api/tasks/&lt;id&gt;/status\n- [ ] 2.6 Update GET /api/stats\n- [ ] 2.7 Update GET /api/tags\n- [ ] 2.8 Update GET /api/archives\n- [ ] 2.9 Update POST /api/archives/&lt;id&gt;/restore\n- [ ] 2.10 Update DELETE /api/archives/&lt;id&gt;\n</code></pre>\n<h3 id=\"openclaw-æ‰§è¡Œæµç¨‹-1\">OpenClaw æ‰§è¡Œæµç¨‹</h3>\n<p><strong>æ‰§è¡Œå˜æ›´1ï¼š</strong></p>\n<pre><code class=\"language-bash\">sessions_spawn task:\"æŒ‰ç…§ openspec/changes/sqlite-database/tasks.md å®ç°æ•°æ®åº“å±‚\"\n  label:\"sqlite-database\"\n  timeoutSeconds:600\n</code></pre>\n<p><strong>ç›‘æ§è¾“å‡ºï¼š</strong></p>\n<pre><code>[DONE] ä»»åŠ¡1.1-1.4: æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ\n[DONE] ä»»åŠ¡2.1-2.2: è¿ç§»äº† 12 ä¸ªä»»åŠ¡\n[DONE] ä»»åŠ¡2.3-2.4: è¿ç§»äº† 4 ä¸ªå½’æ¡£ä»»åŠ¡\n[ALL DONE]\n\nè€—æ—¶ï¼šçº¦3åˆ†é’Ÿ\nçŠ¶æ€ï¼šâœ… æˆåŠŸ\n</code></pre>\n<p><strong>æ‰§è¡Œå˜æ›´2ï¼š</strong></p>\n<pre><code class=\"language-bash\">sessions_spawn task:\"æŒ‰ç…§ openspec/changes/sqlite-api/tasks.md æ›´æ–°APIå±‚\"\n  label:\"sqlite-api\"\n  timeoutSeconds:900\n</code></pre>\n<p><strong>ç›‘æ§è¾“å‡ºï¼š</strong></p>\n<pre><code>[DONE] ä»»åŠ¡1.1: Import sqlite3 module\n[DONE] ä»»åŠ¡1.2: Create get_db() helper function\n[DONE] ä»»åŠ¡1.3: Add init_db() for startup\n[DONE] ä»»åŠ¡2.1: Update load_tasks() to use SQL\n...\n[DONE] ä»»åŠ¡2.10: Update DELETE /api/archives/&lt;id&gt;\n[ALL DONE]\n\nè€—æ—¶ï¼šçº¦2åˆ†é’Ÿ\nçŠ¶æ€ï¼šâœ… æˆåŠŸ\n</code></pre>\n<h3 id=\"æ•ˆæœå¯¹æ¯”\">æ•ˆæœå¯¹æ¯”</h3>\n<table>\n<thead>\n<tr>\n<th>æ–¹æ¡ˆ</th>\n<th>å˜æ›´æ•°</th>\n<th>æ€»ä»»åŠ¡æ•°</th>\n<th>è€—æ—¶</th>\n<th>ç»“æœ</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>åŸå§‹æ–¹æ¡ˆï¼ˆæœªæ‹†åˆ†ï¼‰</td>\n<td>1</td>\n<td>24</td>\n<td>å¡ä½</td>\n<td>âŒ å¤±è´¥</td>\n</tr>\n<tr>\n<td><strong>ç»„åˆæ–¹æ¡ˆï¼ˆæ‹†åˆ†åï¼‰</strong></td>\n<td><strong>2</strong></td>\n<td><strong>24</strong></td>\n<td><strong>5åˆ†é’Ÿ</strong></td>\n<td><strong>âœ… æˆåŠŸ</strong></td>\n</tr>\n</tbody>\n</table>\n<p><strong>å…³é”®å‘ç°ï¼š</strong></p>\n<ul>\n<li>ä»»åŠ¡æ‹†åˆ†åï¼Œå³ä½¿æ€»ä»»åŠ¡æ•°ç›¸åŒï¼ŒæˆåŠŸç‡åè€Œæå‡</li>\n<li>å•ä¸ªå˜æ›´çš„ä»»åŠ¡æ•°æ§åˆ¶åœ¨ 8-16 ä¸ªæ˜¯ sweet spot</li>\n<li><code>[DONE]</code> æ ‡è®°è®©è¿›åº¦é€æ˜ï¼Œå¿ƒé‡Œæ›´æœ‰åº•</li>\n</ul>\n<hr />\n<h2 id=\"ç›‘æ§å’Œç®¡ç†æŠ€å·§\">ç›‘æ§å’Œç®¡ç†æŠ€å·§</h2>\n<h3 id=\"å®æ—¶ç›‘æ§å‘½ä»¤\">å®æ—¶ç›‘æ§å‘½ä»¤</h3>\n<pre><code class=\"language-bash\"># æŸ¥çœ‹æ‰€æœ‰æ´»è·ƒä»»åŠ¡\n$ sessions_list\n\n# æŸ¥çœ‹æœ€è¿‘10åˆ†é’Ÿæ´»è·ƒçš„ä»»åŠ¡\n$ sessions_list activeMinutes:10\n\n# æŸ¥çœ‹å…·ä½“ä»»åŠ¡çš„è¾“å‡º\n$ sessions_history sessionKey:\"...\" limit:50\n\n# æœç´¢ [DONE] æ ‡è®°\n$ sessions_history sessionKey:\"...\" | grep \"\\[DONE\\]\"\n\n# ç»Ÿè®¡å·²å®Œæˆä»»åŠ¡æ•°\n$ sessions_history sessionKey:\"...\" | grep -c \"\\[DONE\\]\"\n</code></pre>\n<h3 id=\"é”™è¯¯å¤„ç†å’Œæ¢å¤\">é”™è¯¯å¤„ç†å’Œæ¢å¤</h3>\n<p><strong>åœºæ™¯1ï¼šOpenCode å¡ä½ï¼ˆ5åˆ†é’Ÿæ— è¾“å‡ºï¼‰</strong></p>\n<pre><code class=\"language-bash\"># æ£€æŸ¥æœ€åè¾“å‡ºæ—¶é—´\n$ sessions_history sessionKey:\"...\" | tail -20\n\n# å‘é€å”¤é†’ä¿¡å·\n$ sessions_send sessionKey:\"...\" message:\"è¯·ç»§ç»­å®ç°ï¼Œä»ä»»åŠ¡2.1å¼€å§‹\"\n\n# å¦‚æœæ— å“åº”ï¼Œå¼ºåˆ¶åœæ­¢å¹¶é‡æ–°å¯åŠ¨\n$ process action:kill sessionId:xxx\n$ sessions_spawn task:\"ç»§ç»­å®ç°ï¼Œä»ä»»åŠ¡2.1å¼€å§‹\" label:\"resume-task\"\n</code></pre>\n<p><strong>åœºæ™¯2ï¼šç”Ÿæˆä»£ç æœ‰è¯­æ³•é”™è¯¯</strong></p>\n<pre><code class=\"language-bash\"># è‡ªåŠ¨è¿è¡Œè¯­æ³•æ£€æŸ¥\n$ exec command:\"cd aimier-kanban &amp;&amp; python3 -m py_compile app.py\"\n\n# å¦‚æœæœ‰é”™è¯¯ï¼ŒOpenClaw ä¼šè‡ªåŠ¨åˆ†æå¹¶ç»™å‡ºå»ºè®®\n</code></pre>\n<hr />\n<h2 id=\"è¸©å‘è®°å½•\">è¸©å‘è®°å½•</h2>\n<h3 id=\"å‘1ç›´æ¥ä½¿ç”¨-opencode-cli\">å‘1ï¼šç›´æ¥ä½¿ç”¨ OpenCode CLI</h3>\n<p><strong>é—®é¢˜ï¼š</strong> ç›´æ¥åœ¨ç»ˆç«¯è¿è¡Œ <code>opencode run \"...\"</code>ï¼Œå¡ä½æ—¶æ— æ³•æ„ŸçŸ¥ã€‚</p>\n<p><strong>è§£å†³ï¼š</strong> æ”¹ç”¨ OpenClaw çš„ <code>sessions_spawn</code>ï¼Œåå°è¿è¡Œ + å®æ—¶ç›‘æ§ã€‚</p>\n<h3 id=\"å‘2ä»»åŠ¡å¤ªå¤§ä¸æ‹†åˆ†\">å‘2ï¼šä»»åŠ¡å¤ªå¤§ï¼ˆä¸æ‹†åˆ†ï¼‰</h3>\n<p><strong>é—®é¢˜ï¼š</strong> è®© OpenCode ä¸€æ¬¡æ€§å®ç° 24 ä¸ªä»»åŠ¡ï¼Œå¡åœ¨ä¸­é—´ä¸åŠ¨ã€‚</p>\n<p><strong>è§£å†³ï¼š</strong> æ‹†åˆ†ä¸ºå¤šä¸ªå°å˜æ›´ï¼Œæ¯ä¸ªå˜æ›´ 8-16 ä¸ªä»»åŠ¡ã€‚</p>\n<h3 id=\"å‘3ç¼ºä¹è¿›åº¦åé¦ˆ\">å‘3ï¼šç¼ºä¹è¿›åº¦åé¦ˆ</h3>\n<p><strong>é—®é¢˜ï¼š</strong> OpenCode ä¸æŠ¥å‘Šè¿›åº¦ï¼Œä¸çŸ¥é“åšåˆ°å“ªäº†ã€‚</p>\n<p><strong>è§£å†³ï¼š</strong> åœ¨ tasks.md å’Œæç¤ºè¯ä¸­å¼ºåˆ¶è¦æ±‚ <code>[DONE]</code> æ ‡è®°ã€‚</p>\n<h3 id=\"å‘4ä¸Šä¸‹æ–‡ç¼ºå¤±\">å‘4ï¼šä¸Šä¸‹æ–‡ç¼ºå¤±</h3>\n<p><strong>é—®é¢˜ï¼š</strong> OpenCode ä¸çŸ¥é“é¡¹ç›®ç»“æ„ï¼Œéœ€è¦åå¤è¯´æ˜ã€‚</p>\n<p><strong>è§£å†³ï¼š</strong> OpenClaw è‡ªåŠ¨è¯»å– workspaceï¼Œæä¾›å®Œæ•´ä¸Šä¸‹æ–‡ã€‚</p>\n<hr />\n<h2 id=\"ç»éªŒæ€»ç»“\">ç»éªŒæ€»ç»“</h2>\n<h3 id=\"æœ€ä½³å®è·µ\">æœ€ä½³å®è·µ</h3>\n<ol>\n<li>\n<p><strong>ä»»åŠ¡æ‹†åˆ†åŸåˆ™</strong></p>\n<ul>\n<li>å¤æ‚åŠŸèƒ½æ‹†åˆ†ä¸ºå¤šä¸ªå˜æ›´</li>\n<li>æ¯ä¸ªå˜æ›´ 8-16 ä¸ªä»»åŠ¡</li>\n<li>ä»»åŠ¡ä¹‹é—´æœ‰æ˜ç¡®ä¾èµ–é¡ºåº</li>\n</ul>\n</li>\n<li>\n<p><strong>æç¤ºè¯æ¨¡æ¿</strong></p>\n<pre><code>è¯·ä¸¥æ ¼æŒ‰ç…§ openspec/changes/&lt;change-name&gt;/tasks.md å®ç°ã€‚\n\næ‰§è¡Œè¦æ±‚ï¼š\n1. æŒ‰ç¼–å·é¡ºåºå®Œæˆæ¯ä¸ªä»»åŠ¡\n2. æ¯å®Œæˆä¸€ä¸ªï¼Œè¾“å‡ºï¼š[DONE] ä»»åŠ¡X.X: &lt;æè¿°&gt;\n3. å…¨éƒ¨å®Œæˆåè¾“å‡ºï¼š[ALL DONE]\n4. é‡åˆ°é—®é¢˜è¾“å‡ºï¼š[ERROR]: &lt;æè¿°&gt;\n</code></pre>\n</li>\n<li>\n<p><strong>ç›‘æ§é¢‘ç‡</strong></p>\n<ul>\n<li>æ¯ 30 ç§’æ£€æŸ¥ä¸€æ¬¡è¿›åº¦</li>\n<li>5 åˆ†é’Ÿæ— æ–° <code>[DONE]</code> æ ‡è®°è§†ä¸ºå¡ä½</li>\n<li>å‡†å¤‡å¥½æ‰‹åŠ¨å…œåº•çš„ plan B</li>\n</ul>\n</li>\n<li>\n<p><strong>å·¥å…·é“¾ç»„åˆ</strong></p>\n<table>\n<thead>\n<tr>\n<th>å·¥å…·</th>\n<th>ä½œç”¨</th>\n<th>ä¼˜åŠ¿</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>OpenClaw</td>\n<td>ä»»åŠ¡ç®¡ç†</td>\n<td>ä¼šè¯ã€ç›‘æ§ã€é”™è¯¯å¤„ç†</td>\n</tr>\n<tr>\n<td>OpenSpec</td>\n<td>è§„èŒƒå®šä¹‰</td>\n<td>ç»“æ„åŒ–éœ€æ±‚ã€æ˜“äºè¿½æº¯</td>\n</tr>\n<tr>\n<td>OpenCode</td>\n<td>ä»£ç ç”Ÿæˆ</td>\n<td>æŒ‰è§„èŒƒè‡ªåŠ¨å®ç°</td>\n</tr>\n</tbody>\n</table>\n</li>\n</ol>\n<h3 id=\"é€‚ç”¨åœºæ™¯\">é€‚ç”¨åœºæ™¯</h3>\n<p><strong>é€‚åˆï¼š</strong></p>\n<ul>\n<li>âœ… åŠŸèƒ½æ˜ç¡®ã€è¾¹ç•Œæ¸…æ™°çš„éœ€æ±‚</li>\n<li>âœ… é‡å¤æ€§çš„ CRUD æ“ä½œ</li>\n<li>âœ… æ•°æ®åº“è¿ç§»ã€API å¼€å‘</li>\n<li>âœ… åŸºäºç°æœ‰æ¨¡å¼çš„æ‰©å±•</li>\n</ul>\n<p><strong>ä¸é€‚åˆï¼š</strong></p>\n<ul>\n<li>âŒ éœ€æ±‚æ¨¡ç³Šã€éœ€è¦æ¢ç´¢</li>\n<li>âŒ å¤æ‚æ¶æ„è®¾è®¡</li>\n<li>âŒ æ·±åº¦æ€§èƒ½ä¼˜åŒ–</li>\n<li>âŒ åˆ›æ–°æ€§ç®—æ³•</li>\n</ul>\n<h3 id=\"æ€§èƒ½åŸºå‡†æ ‘è“æ´¾-4b-å®æµ‹\">æ€§èƒ½åŸºå‡†ï¼ˆæ ‘è“æ´¾ 4B å®æµ‹ï¼‰</h3>\n<table>\n<thead>\n<tr>\n<th>å•ä¸ªå˜æ›´ä»»åŠ¡æ•°</th>\n<th>æˆåŠŸç‡</th>\n<th>å¹³å‡è€—æ—¶</th>\n<th>æ¨èåº¦</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>3-6 ä¸ª</td>\n<td>95%</td>\n<td>3-5åˆ†é’Ÿ</td>\n<td>â­â­â­â­â­</td>\n</tr>\n<tr>\n<td>7-10 ä¸ª</td>\n<td>85%</td>\n<td>5-10åˆ†é’Ÿ</td>\n<td>â­â­â­â­</td>\n</tr>\n<tr>\n<td>11-16 ä¸ª</td>\n<td>70%</td>\n<td>10-15åˆ†é’Ÿ</td>\n<td>â­â­â­</td>\n</tr>\n<tr>\n<td>&gt;16 ä¸ª</td>\n<td>&lt;30%</td>\n<td>å¡ä½</td>\n<td>âŒ ä¸æ¨è</td>\n</tr>\n</tbody>\n</table>\n<hr />\n<h2 id=\"å®Œæ•´å·¥ä½œæµç¤ºä¾‹\">å®Œæ•´å·¥ä½œæµç¤ºä¾‹</h2>\n<p><strong>ä»éœ€æ±‚åˆ°éƒ¨ç½²çš„æ ‡å‡†æµç¨‹ï¼š</strong></p>\n<pre><code>1. éœ€æ±‚åˆ†æï¼ˆä»»çªï¼‰\n   â†“\n2. åˆ›å»º OpenSpec å˜æ›´\n   $ openspec change new feature-name\n   â†“\n3. ç¼–å†™è§„èŒƒæ–‡æ¡£\n   - proposal.mdï¼ˆä¸ºä»€ä¹ˆè¦åšï¼‰\n   - design.mdï¼ˆæ€ä¹ˆåšï¼‰\n   - tasks.mdï¼ˆä»»åŠ¡æ¸…å•ï¼Œâ‰¤16ä¸ªä»»åŠ¡ï¼‰\n   â†“\n4. OpenClaw è°ƒç”¨ OpenCode\n   $ sessions_spawn task:\"å®ç°åŠŸèƒ½\" label:\"implement-feature\"\n   â†“\n5. å®æ—¶ç›‘æ§å’Œç®¡ç†\n   $ sessions_list\n   $ sessions_history sessionKey:\"...\"\n   â†“\n6. ä»£ç éªŒè¯\n   - è‡ªåŠ¨è¯­æ³•æ£€æŸ¥\n   - åŠŸèƒ½æµ‹è¯•\n   â†“\n7. æäº¤å’Œæ¨é€\n   $ git add .\n   $ git commit -m \"å®ç°åŠŸèƒ½\"\n   $ git push\n   â†“\n8. å½’æ¡£è§„èŒƒ\n   $ openspec change archive feature-name\n</code></pre>\n<hr />\n<h2 id=\"ç»“è¯­\">ç»“è¯­</h2>\n<p>ç”¨ OpenClaw è°ƒç”¨ OpenCode è¿›è¡Œå¼€å‘ï¼Œæœ€å¤§çš„ä»·å€¼æ˜¯<strong>å¯æ§æ€§</strong>ã€‚</p>\n<ul>\n<li>ä»»åŠ¡åœ¨åå°è¿è¡Œï¼Œä¸é˜»å¡å½“å‰ä¼šè¯</li>\n<li>å®æ—¶ç›‘æ§è¿›åº¦ï¼ŒçŸ¥é“åšåˆ°å“ªäº†</li>\n<li>å¡ä½æ—¶è‡ªåŠ¨å¤„ç†æˆ–æŠ¥è­¦</li>\n<li>æ‰€æœ‰å·¥ä½œå¯è¿½æº¯ã€å¯ç®¡ç†</li>\n</ul>\n<p>ä½†è¿™å¥—å·¥å…·é“¾ä¹Ÿæœ‰å±€é™ã€‚å®ƒé€‚åˆ<strong>æ‰§è¡Œæ˜ç¡®çš„éœ€æ±‚</strong>ï¼Œä¸é€‚åˆ<strong>æ¢ç´¢æœªçŸ¥çš„é—®é¢˜</strong>ã€‚å…³é”®è¿˜æ˜¯<strong>æŠŠéœ€æ±‚æƒ³æ¸…æ¥š</strong>â€”â€”è¿™æ˜¯ç¨‹åºå‘˜çš„å·¥ä½œï¼ŒAI æ— æ³•æ›¿ä»£ã€‚</p>\n<p>å¦‚æœä½ ä¹Ÿåœ¨å°è¯•ç±»ä¼¼çš„å·¥ä½œæµï¼Œæ¬¢è¿äº¤æµè¸©å‘ç»éªŒã€‚</p>\n<hr />\n<h2 id=\"å‚è€ƒé“¾æ¥\">å‚è€ƒé“¾æ¥</h2>\n<ul>\n<li>OpenClaw æ–‡æ¡£ï¼š<a href=\"https://docs.openclaw.ai\" rel=\"noopener nofollow\" target=\"_blank\">https://docs.openclaw.ai</a></li>\n<li>OpenSpec ä»“åº“ï¼š<a href=\"https://github.com/fission-ai/openspec\" rel=\"noopener nofollow\" target=\"_blank\">https://github.com/fission-ai/openspec</a></li>\n<li>OpenCode æ–‡æ¡£ï¼š<a href=\"https://opencode.ai\" rel=\"noopener nofollow\" target=\"_blank\">https://opencode.ai</a></li>\n<li>çˆ±å¼¥å„¿ä»»åŠ¡çœ‹æ¿ï¼š<a href=\"https://github.com/ren8179/aimier-kanban\" rel=\"noopener nofollow\" target=\"_blank\">https://github.com/ren8179/aimier-kanban</a></li>\n</ul>\n<hr />\n<p><em>æœ¬æ–‡æ˜¯çˆ±å¼¥å„¿ä»»åŠ¡çœ‹æ¿å¼€å‘è¿‡ç¨‹ä¸­çš„çœŸå®è®°å½•ï¼Œç”± AI åŠ©æ‰‹çˆ±å¼¥å„¿æ•´ç†æ’°å†™ã€‚</em></p>\n\n\n</div>\n<div class=\"clear\"></div>\n\n            </div>\n            <div class=\"postDesc\">posted @ \n<span id=\"post-date\">2026-02-13 08:56</span>&nbsp;\n<a href=\"https://www.cnblogs.com/rsls\">äº”è•´éç©º</a>&nbsp;\né˜…è¯»(<span id=\"post_view_count\">0</span>)&nbsp;\nè¯„è®º(<span id=\"post_comment_count\">0</span>)&nbsp;\n&nbsp;\n<a href=\"\">æ”¶è—</a>&nbsp;\n<a href=\"\">ä¸¾æŠ¥</a>\n</div>"
    },
    {
      "title": "PHP çš„é—®é¢˜ä¸åœ¨è¯­è¨€æœ¬èº«ï¼Œè€Œåœ¨æˆ‘ä»¬æ€ä¹ˆå†™å®ƒ",
      "link": "https://www.cnblogs.com/catchadmin/p/19610690",
      "published": "",
      "description": "<h1 class=\"postTitle\">\n                <a class=\"postTitle2 vertical-middle\" href=\"https://www.cnblogs.com/catchadmin/p/19610690\" id=\"cb_post_title_url\" title=\"å‘å¸ƒäº 2026-02-13 07:59\">\n    <span>PHP çš„é—®é¢˜ä¸åœ¨è¯­è¨€æœ¬èº«ï¼Œè€Œåœ¨æˆ‘ä»¬æ€ä¹ˆå†™å®ƒ</span>\n    \n\n</a>\n\n            </h1>\n            <div class=\"clear\"></div>\n            <div class=\"postBody\">\n                <div class=\"blogpost-body cnblogs-markdown\" id=\"cnblogs_post_body\">\n<h1 id=\"php-çš„é—®é¢˜ä¸åœ¨è¯­è¨€æœ¬èº«è€Œåœ¨æˆ‘ä»¬æ€ä¹ˆå†™å®ƒ\">PHP çš„é—®é¢˜ä¸åœ¨è¯­è¨€æœ¬èº«ï¼Œè€Œåœ¨æˆ‘ä»¬æ€ä¹ˆå†™å®ƒ</h1>\n<p>ä»£ç åº“çƒ‚äº†ä¸æ˜¯è¯­è¨€çš„é”…ï¼Œæ˜¯èµ¶å·¥å’Œæƒ¯æ€§ã€‚</p>\n<p>PHP çš„å£ç¢‘ï¼Œå‡ ä¹åœ¨æ¯æ¬¡æŠ€æœ¯è®¨è®ºä¸­éƒ½ä¼šè¢«æ‹å‡ºæ¥ã€‚åº”ç”¨æ…¢ã€ä¹±ã€ä¸å®‰å…¨ã€æ”¹èµ·æ¥ç—›è‹¦ï¼Ÿæ€»æœ‰äººè€¸è€¸è‚©è¯´ï¼š\"å—¯â€¦â€¦æ¯•ç«Ÿæ˜¯ PHP å˜›ã€‚\"</p>\n<p>è¿™è¯å¾ˆå°‘å‡ºäºæŠ€æœ¯åˆ¤æ–­ï¼Œæ›´åƒæ˜¯ä¸€ç§ä¹ æƒ¯æ€§ç”©é”…ã€‚</p>\n<p>äº‹å®æ¯”è¿™ç®€å•ï¼Œä¹Ÿæ›´æ‰å¿ƒï¼šå¤§å¤šæ•° PHP ç³»ç»Ÿä¹‹æ‰€ä»¥éš¾ç»´æŠ¤ï¼Œæ˜¯æˆ‘ä»¬è‡ªå·±æ”¾ä»»çš„ç»“æœã€‚PHP ä¸ä¼šä¸€ä¸Šæ¥å°±é€¼ä½ åšæ¶æ„è®¾è®¡ã€åˆ’è¾¹ç•Œã€å®ˆè§„çŸ©ã€‚å®ƒå¾ˆå®½å®¹ï¼Œå¾ˆåŠ¡å®ï¼Œç‰¹åˆ«æ“…é•¿è®©ä½ æŠŠä¸€ä¸ªâ€œèƒ½è·‘å°±è¡Œâ€çš„ä¸œè¥¿èµ¶å‡ºæ¥ã€‚</p>\n<p>ä½†ä»Šå¤©èƒ½è·‘çš„ä»£ç åº“ï¼Œæ˜å¤©å¯èƒ½å°±æ˜¯ç¾éš¾ã€‚</p>\n<p>ä¸€ä¸ª PHP é¡¹ç›®æ²¦ä¸ºææ€–æ•…äº‹ï¼Œå¾ˆå°‘æ˜¯å› ä¸º PHP åšä¸åˆ°æ›´å¥½ï¼Œè€Œæ˜¯å›¢é˜Ÿä»æ¥æ²¡å…»æˆé‚£äº›èƒ½è®©é¡¹ç›®è¶Šåšè¶Šå¤§è¿˜ä¸å´©çš„ä¹ æƒ¯â€”â€”ç»“æ„ã€æµ‹è¯•ã€çº¦å®šã€å…³æ³¨ç‚¹åˆ†ç¦»ã€‚</p>\n<p>ç°ä»£ PHP å®Œå…¨æœ‰èƒ½åŠ›åšåˆ°ï¼š</p>\n<ul>\n<li>ä¸¥æ ¼ç±»å‹ï¼ˆæ˜¯çš„ï¼ŒçœŸæ­£çš„ç±»å‹ï¼‰</li>\n<li>æ•´æ´æ¶æ„</li>\n<li>ä¾èµ–æ³¨å…¥</li>\n<li>è¡¨è¾¾åŠ›å¼ºçš„é¢†åŸŸæ¨¡å‹</li>\n<li>è§„èŒƒçš„é”™è¯¯å¤„ç†</li>\n<li>å¯é çš„æµ‹è¯•</li>\n<li>é«˜æ€§èƒ½ï¼ˆOPcache/JITã€ç¼“å­˜ã€åˆç†çš„ I/Oï¼‰</li>\n<li>æˆç†Ÿçš„å·¥å…·é“¾</li>\n</ul>\n<p>å¦‚æœä½ å¯¹ PHP çš„å°è±¡è¿˜åœç•™åœ¨\"åˆ°å¤„ include æ–‡ä»¶\"å’Œ\"åœ¨è§†å›¾é‡Œå†™ SQL\"ï¼Œé‚£ä½ éª‚çš„ä¸æ˜¯ PHP è¿™é—¨è¯­è¨€ï¼Œè€Œæ˜¯ä¸€ç§æ—©è¯¥è¢«æ·˜æ±°çš„ PHP å†™æ³•ã€‚</p>\n<p>è¿™ç¯‡æ–‡ç« ä¸æ˜¯åœ¨ç»™ PHP æ´—åœ°ï¼Œåªæ˜¯æƒ³è¯´æ¸…æ¥šä¸€ä»¶äº‹ï¼šPHP æ˜¯ä¸€é¢é•œå­ï¼Œç…§å‡ºæ¥çš„æ˜¯ä½ çš„å·¥ç¨‹æ–‡åŒ–ã€‚ç…§å‡ºæ¥ä¸å¥½çœ‹ï¼Œæ¢é¢é•œå­ä¹Ÿæ²¡ç”¨ã€‚</p>\n<h2 id=\"php-å¾ˆå®½å®¹å®½å®¹çš„è¯­è¨€ä¼šæ”¾å¤§ä½ çš„ä¹ æƒ¯\">PHP å¾ˆå®½å®¹â€”â€”å®½å®¹çš„è¯­è¨€ä¼šæ”¾å¤§ä½ çš„ä¹ æƒ¯</h2>\n<p>æœ‰äº›è¯­è¨€ç”Ÿæ€ä»ä¸€å¼€å§‹å°±é€¼ä½ æŠŠç»“æ„æ­å¥½ã€‚æƒ³åšç¨å¾®å¤æ‚ä¸€ç‚¹çš„ä¸œè¥¿ï¼Œå°±ç»•ä¸å¼€åŒ…ã€æ¨¡å—ã€æ¥å£ã€ä¾èµ–æ³¨å…¥è¿™äº›æ¦‚å¿µï¼Œå“ªæ€•ä½ æ²¡ä¸»åŠ¨è¦æ±‚ï¼Œçº¦æŸä¹Ÿè‡ªåŠ¨å°±åœ¨é‚£äº†ã€‚</p>\n<p>PHP çš„ç©æ³•ä¸ä¸€æ ·ï¼š</p>\n<ul>\n<li>å¯ä»¥ä»ä¸€ä¸ªæ–‡ä»¶èµ·æ­¥</li>\n<li>å¯ä»¥æ¯«æ— é˜»åŠ›åœ°æ··åˆå„å±‚</li>\n<li>å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹è®¿é—®å…¨å±€å˜é‡</li>\n<li>å¯ä»¥åœ¨æ§åˆ¶å™¨é‡Œç›´æ¥æŸ¥æ•°æ®åº“</li>\n<li>å¯ä»¥å¿½ç•¥ç±»å‹ç…§æ ·ä¸Šçº¿</li>\n</ul>\n<p>è¿™ç§çµæ´»æ€§æœ¬èº«ä¸æ˜¯åäº‹ï¼ŒPHP é å®ƒå½“äº†å¤šå¹´ Web å¼€å‘çš„é»˜è®¤é€‰æ‹©ã€‚ä½†å®ƒä¹ŸåŸ‹äº†ä¸€ä¸ªå‘ï¼šç»“æ„æ˜¾å¾—å¯æœ‰å¯æ— ï¼Œè€Œå¯æœ‰å¯æ— çš„ä¸œè¥¿åœ¨èµ¶å·¥æ—¶ä¸€å®šä¼šè¢«ç æ‰ã€‚</p>\n<p>å¾ˆå¤šâ€œPHP å¤ªçƒ‚äº†â€çš„æ•…äº‹ï¼ŒèƒŒåçš„çœŸå®å‰§æƒ…æ˜¯â€œèµ¶å·¥æœŸä¸Šäº†çº¿ï¼Œç„¶åé‡æ„çš„å€ºä¸€ç›´æ²¡è¿˜â€ã€‚</p>\n<p>PHP æ²¡æœ‰é€ æˆè¿™ä¸ªé—®é¢˜ï¼Œå®ƒåªæ˜¯æ²¡æœ‰é˜»æ­¢ã€‚</p>\n<h2 id=\"éƒ½æ€ª-phpå¾€å¾€æ˜¯åœ¨é€ƒé¿è´£ä»»\">\"éƒ½æ€ª PHP\"å¾€å¾€æ˜¯åœ¨é€ƒé¿è´£ä»»</h2>\n<p>ç³»ç»Ÿè®©äººç—›è‹¦çš„æ—¶å€™ï¼Œç”©é”…ç»™è¯­è¨€æœ€çœäº‹ï¼Œå› ä¸ºè¯­è¨€æœ€å®¹æ˜“çœ‹åˆ°ã€‚çœŸæ­£çš„åŸå› å¾€å¾€è—å¾—æ›´æ·±ï¼š</p>\n<ul>\n<li>æ²¡æœ‰ç»Ÿä¸€çš„ç¼–ç è§„èŒƒ</li>\n<li>æ²¡æœ‰æ¶æ„è´Ÿè´£äºº</li>\n<li>æ²¡æœ‰æµ‹è¯•</li>\n<li>æ²¡æœ‰ä¸ºé‡æ„åˆ†é…æ—¶é—´</li>\n<li>ä»£ç è¯„å®¡æ—¶æ¾æ—¶ç´§</li>\n<li>\"å…ˆäº¤ä»˜å†è¯´\"çš„æ¿€åŠ±æœºåˆ¶</li>\n</ul>\n<p>è¿™äº›é—®é¢˜å“ªä¸ªæŠ€æœ¯æ ˆéƒ½æœ‰ã€‚åŒºåˆ«åœ¨äº PHP èƒ½è®©ä½ åœ¨å‡ ä¹æ²¡æœ‰çº¦æŸçš„æƒ…å†µä¸‹æŠŠé¡¹ç›®æ¨å¾—å¾ˆè¿œï¼ŒæŠ€æœ¯å€ºæ‚„æ‚„æ”’ç€â€”â€”ç„¶ååœ¨æŸä¸€å¤©é›†ä¸­çˆ†å‘ã€‚</p>\n<p>PHP æˆäº†æ›¿ç½ªç¾Šï¼Œå› ä¸ºæ‰¿è®¤æµç¨‹çƒ‚äº†ï¼Œæ¯”ç”©é”…ç»™è¯­è¨€éš¾å¤šäº†ã€‚</p>\n<h2 id=\"ç°ä»£-php-ä¸æ˜¯ä½ è®°å¿†ä¸­çš„-php\">ç°ä»£ PHP ä¸æ˜¯ä½ è®°å¿†ä¸­çš„ PHP</h2>\n<p>å¦‚æœä½ å¯¹ PHP çš„è®¤çŸ¥è¿˜åœåœ¨\"PHP 5 åŠ ä¸€å †éšæ„ include\"çš„å¹´ä»£ï¼Œé‚£ä½ é”™è¿‡çš„ä¸œè¥¿å¤ªå¤šäº†ï¼š</p>\n<ul>\n<li><code>declare(strict_types=1);</code></li>\n<li>æ ‡é‡ç±»å‹å’Œè¿”å›ç±»å‹</li>\n<li>ç±»å‹åŒ–å±æ€§</li>\n<li>è”åˆç±»å‹</li>\n<li>æšä¸¾</li>\n<li>å±æ€§æ³¨è§£ï¼ˆAttributesï¼‰</li>\n<li>æ›´å¥½çš„é”™è¯¯è¯­ä¹‰</li>\n<li>Composer æˆä¸ºæ ‡é…</li>\n<li>PSR æ ‡å‡†</li>\n<li>ä¼˜ç§€çš„æ¡†æ¶ï¼ˆLaravelã€Symfonyï¼‰å’Œç»„ä»¶</li>\n<li>é™æ€åˆ†æå·¥å…·ï¼ˆPHPStan/Psalmï¼‰</li>\n<li>ä»£ç æ ¼å¼åŒ–å·¥å…·ï¼ˆPHP-CS-Fixerï¼‰</li>\n<li>å®¹å™¨åŒ– / CI å·¥ä½œæµ</li>\n</ul>\n<p>è¯­è¨€è¿›åŒ–äº†ï¼Œä½†å¾ˆå¤šå›¢é˜Ÿæ²¡æœ‰ã€‚</p>\n<p>æ‰€ä»¥çœŸæ­£çš„é—®é¢˜æ˜¯ï¼šä½ å†™ PHP çš„æ—¶å€™ï¼Œæ˜¯æŠŠå®ƒå½“æˆä¸€é—¨ç°ä»£åç«¯è¯­è¨€ï¼Œè¿˜æ˜¯å½“æˆèµ¶å·¥æ—¶å‡‘åˆç”¨çš„è„šæœ¬ï¼Ÿ</p>\n<h2 id=\"ç»å…¸-php-åæ¨¡å¼ä»€ä¹ˆéƒ½å¡è¿›æ§åˆ¶å™¨\">ç»å…¸ PHP åæ¨¡å¼ï¼š\"ä»€ä¹ˆéƒ½å¡è¿›æ§åˆ¶å™¨\"</h2>\n<p>ä¸‹é¢è¿™å¥—æµç¨‹ï¼Œåœ¨å¾ˆå¤šé¡¹ç›®é‡Œéƒ½èƒ½çœ‹åˆ°ï¼š</p>\n<ol>\n<li>æ§åˆ¶å™¨æ¥æ”¶è¯·æ±‚</li>\n<li>æ§åˆ¶å™¨åšéªŒè¯</li>\n<li>æ§åˆ¶å™¨æ‹¼æŸ¥è¯¢</li>\n<li>æ§åˆ¶å™¨å¤„ç†ä¸šåŠ¡è§„åˆ™</li>\n<li>æ§åˆ¶å™¨æ›´æ–°æ•°æ®åº“</li>\n<li>æ§åˆ¶å™¨æ ¼å¼åŒ–å“åº”</li>\n<li>æ§åˆ¶å™¨è§¦å‘å‰¯ä½œç”¨ï¼ˆé‚®ä»¶ã€é˜Ÿåˆ—ï¼‰</li>\n</ol>\n<p>èƒ½è·‘ï¼Œèƒ½ä¸Šçº¿ï¼ŒåŠŸèƒ½è¿˜èƒ½å¾€ä¸Šå †ã€‚ç„¶åå°±å¼€å§‹å˜è„†â€”â€”å› ä¸ºæ§åˆ¶å™¨å·²ç»å˜æˆäº†ä¸€ä¸ªæ½äº†ä¸šåŠ¡è§„åˆ™ã€æ•°æ®æŒä¹…åŒ–å’Œ I/O çš„ä¸Šå¸å¯¹è±¡ã€‚</p>\n<p>çœ‹ä¸€ä¸ªç®€åŒ–ç‰ˆçš„ä¾‹å­ã€‚</p>\n<h3 id=\"-åæ¨¡å¼æ‰€æœ‰é€»è¾‘å¡åœ¨æ§åˆ¶å™¨é‡Œ\">âŒ åæ¨¡å¼ï¼šæ‰€æœ‰é€»è¾‘å¡åœ¨æ§åˆ¶å™¨é‡Œ</h3>\n<pre><code class=\"language-php\">&lt;?php\nclass CheckoutController\n{\n    public function placeOrder(array $request): array\n    {\n        $userId = (int)($request['user_id'] ?? 0);\n        $items  = $request['items'] ?? [];\n        if ($userId &lt;= 0 || empty($items)) {\n            return ['ok' =&gt; false, 'error' =&gt; 'Invalid request'];\n        }\n        $pdo = new PDO($_ENV['DB_DSN'], $_ENV['DB_USER'], $_ENV['DB_PASS']);\n        $pdo-&gt;beginTransaction();\n        try {\n            // Load user\n            $stmt = $pdo-&gt;prepare(\"SELECT id, status FROM users WHERE id = ?\");\n            $stmt-&gt;execute([$userId]);\n            $user = $stmt-&gt;fetch(PDO::FETCH_ASSOC);\n            if (!$user || $user['status'] !== 'active') {\n                throw new RuntimeException(\"User not active\");\n            }\n            // Calculate total\n            $total = 0;\n            foreach ($items as $it) {\n                $productId = (int)$it['product_id'];\n                $qty       = (int)$it['qty'];\n                $stmt = $pdo-&gt;prepare(\"SELECT id, price, stock FROM products WHERE id = ?\");\n                $stmt-&gt;execute([$productId]);\n                $product = $stmt-&gt;fetch(PDO::FETCH_ASSOC);\n                if (!$product) {\n                    throw new RuntimeException(\"Product not found\");\n                }\n                if ($qty &lt;= 0 || $qty &gt; (int)$product['stock']) {\n                    throw new RuntimeException(\"Insufficient stock\");\n                }\n                $total += ((int)$product['price']) * $qty;\n                // Reduce stock inline\n                $stmt = $pdo-&gt;prepare(\"UPDATE products SET stock = stock - ? WHERE id = ?\");\n                $stmt-&gt;execute([$qty, $productId]);\n            }\n            // Insert order\n            $stmt = $pdo-&gt;prepare(\"INSERT INTO orders(user_id, total, created_at) VALUES(?, ?, NOW())\");\n            $stmt-&gt;execute([$userId, $total]);\n            $orderId = (int)$pdo-&gt;lastInsertId();\n            // Insert items\n            $stmt = $pdo-&gt;prepare(\"INSERT INTO order_items(order_id, product_id, qty) VALUES(?, ?, ?)\");\n            foreach ($items as $it) {\n                $stmt-&gt;execute([$orderId, (int)$it['product_id'], (int)$it['qty']]);\n            }\n            $pdo-&gt;commit();\n            return ['ok' =&gt; true, 'order_id' =&gt; $orderId, 'total' =&gt; $total];\n        } catch (Throwable $e) {\n            $pdo-&gt;rollBack();\n            return ['ok' =&gt; false, 'error' =&gt; $e-&gt;getMessage()];\n        }\n    }\n}\n</code></pre>\n<p>è¿™æ®µä»£ç çƒ‚ï¼Œä¸æ˜¯å› ä¸ºå®ƒç”¨ PHP å†™çš„ï¼Œè€Œæ˜¯å› ä¸ºå®ƒæŠŠè¿™äº›ä¸œè¥¿å…¨æ…åœ¨äº†ä¸€èµ·ï¼š</p>\n<ul>\n<li>è¾“å…¥éªŒè¯</li>\n<li>äº‹åŠ¡ç®¡ç†</li>\n<li>ä¸šåŠ¡è§„åˆ™</li>\n<li>æŒä¹…åŒ–</li>\n<li>çŠ¶æ€å˜æ›´</li>\n<li>å“åº”æ ¼å¼åŒ–</li>\n</ul>\n<p>ä¸è¿æ•°æ®åº“å°±æ²¡æ³•æµ‹ä¸šåŠ¡é€»è¾‘ï¼Œä¸å¤åˆ¶ä»£ç å°±æ²¡æ³•å¤ç”¨è§„åˆ™ï¼Œæ”¹ä¸€ä¸ªå°åœ°æ–¹éƒ½æå¿ƒåŠèƒ†ã€‚</p>\n<p>å¦‚æœä½ å¹³æ—¶è§åˆ°çš„ PHP éƒ½é•¿è¿™æ ·ï¼Œæœ‰åè§å¾ˆæ­£å¸¸ã€‚ä½†è¯è¯´å›æ¥ï¼ŒPHP æ²¡é€¼ä½ å†™æˆè¿™æ ·â€”â€”æˆ‘ä»¬è‡ªå·±é€‰çš„è¿™æ¡è·¯ï¼Œå›¾çš„å°±æ˜¯å¿«ã€‚</p>\n<h2 id=\"å¥½çš„-phpé•¿ä»€ä¹ˆæ ·æ— èŠçš„ç»“æ„æ¸…æ™°çš„è¾¹ç•Œ\">\"å¥½çš„ PHP\"é•¿ä»€ä¹ˆæ ·ï¼šæ— èŠçš„ç»“æ„ï¼Œæ¸…æ™°çš„è¾¹ç•Œ</h2>\n<p>å†™å¾—å¥½çš„ PHP ä»£ç å¾€å¾€çœ‹èµ·æ¥\"æ²¡ä»€ä¹ˆæŠ€æœ¯å«é‡\"ã€‚è¿™ä¸æ˜¯åäº‹â€”â€”æ— èŠçš„ä»£ç å°±æ˜¯å¯é¢„æµ‹çš„ä»£ç ã€‚</p>\n<p>æ›´åˆç†çš„åˆ†å±‚æ–¹å¼æ˜¯ï¼š</p>\n<ul>\n<li>æ§åˆ¶å™¨åªå¤„ç† HTTP å±‚ï¼ˆè¯·æ±‚/å“åº”ï¼‰</li>\n<li>åº”ç”¨/æœåŠ¡å±‚åè°ƒç”¨ä¾‹</li>\n<li>é¢†åŸŸå¯¹è±¡è´Ÿè´£ç»´æŠ¤ä¸šåŠ¡ä¸å˜é‡</li>\n<li>ä»“å‚¨å±‚å¤„ç†æŒä¹…åŒ–</li>\n<li>å‰¯ä½œç”¨é€šè¿‡æ¥å£éš”ç¦»</li>\n</ul>\n<p>ä¸‹é¢ç”¨æ›´æ¸…æ™°çš„ç»“æ„é‡å†™åŒä¸€ä¸ªåŠŸèƒ½ã€‚</p>\n<h3 id=\"-ç°ä»£-php-ç”¨ä¾‹é£æ ¼\">âœ… ç°ä»£ PHP \"ç”¨ä¾‹\"é£æ ¼</h3>\n<p>ä¸‹é¢çš„ä»£ç å°½é‡ç²¾ç®€â€”â€”ä¸ç»‘å®šç‰¹å®šæ¡†æ¶ï¼Œä½†å’Œ Laravel/Symfony çš„å†™æ³•å…¼å®¹ã€‚</p>\n<p><strong>Step Aï¼šå®šä¹‰è¯·æ±‚ DTO</strong></p>\n<pre><code class=\"language-php\">&lt;?php\ndeclare(strict_types=1);\nfinal class PlaceOrderCommand\n{\n    /**\n     * @param array&lt;int, array{productId:int, qty:int}&gt; $items\n     */\n    public function __construct(\n        public readonly int $userId,\n        public readonly array $items\n    ) {}\n}\n</code></pre>\n<p><strong>Step Bï¼šå®šä¹‰é¢†åŸŸå¼‚å¸¸ï¼ˆä¸šåŠ¡é”™è¯¯ä¸åº”è¯¥æ˜¯ 500ï¼‰</strong></p>\n<pre><code class=\"language-php\">&lt;?php\ndeclare(strict_types=1);\nclass DomainException extends RuntimeException {}\nfinal class UserNotActive extends DomainException {}\nfinal class ProductNotFound extends DomainException {}\nfinal class InsufficientStock extends DomainException {}\nfinal class InvalidOrder extends DomainException {}\n</code></pre>\n<p><strong>Step Cï¼šä¸ºä¾èµ–å®šä¹‰å°æ¥å£</strong></p>\n<pre><code class=\"language-php\">&lt;?php\ndeclare(strict_types=1);\ninterface UserRepository\n{\n    public function getStatus(int $userId): ?string;\n}\nfinal class ProductSnapshot\n{\n    public function __construct(\n        public readonly int $id,\n        public readonly int $price,\n        public readonly int $stock\n    ) {}\n}\ninterface ProductRepository\n{\n    public function getSnapshot(int $productId): ?ProductSnapshot;\n    public function decreaseStock(int $productId, int $qty): void;\n}\nfinal class OrderResult\n{\n    public function __construct(\n        public readonly int $orderId,\n        public readonly int $total\n    ) {}\n}\ninterface OrderRepository\n{\n    /**\n     * @param array&lt;int, array{productId:int, qty:int, price:int}&gt; $lines\n     */\n    public function create(int $userId, int $total, array $lines): int;\n}\ninterface TransactionManager\n{\n    /**\n     * @template T\n     * @param callable():T $fn\n     * @return T\n     */\n    public function run(callable $fn): mixed;\n}\n</code></pre>\n<p><strong>Step Dï¼šå®ç°ç”¨ä¾‹ï¼ˆæœåŠ¡å±‚ï¼‰</strong></p>\n<pre><code class=\"language-php\">&lt;?php\ndeclare(strict_types=1);\nfinal class PlaceOrderHandler\n{\n    public function __construct(\n        private readonly TransactionManager $tx,\n        private readonly UserRepository $users,\n        private readonly ProductRepository $products,\n        private readonly OrderRepository $orders\n    ) {}\n    public function handle(PlaceOrderCommand $cmd): OrderResult\n    {\n        if ($cmd-&gt;userId &lt;= 0 || $cmd-&gt;items === []) {\n            throw new InvalidOrder(\"User and items are required.\");\n        }\n        $status = $this-&gt;users-&gt;getStatus($cmd-&gt;userId);\n        if ($status !== 'active') {\n            throw new UserNotActive(\"User is not active.\");\n        }\n        return $this-&gt;tx-&gt;run(function () use ($cmd): OrderResult {\n            $lines = [];\n            $total = 0;\n            foreach ($cmd-&gt;items as $item) {\n                $productId = $item['productId'];\n                $qty       = $item['qty'];\n                if ($qty &lt;= 0) {\n                    throw new InvalidOrder(\"Quantity must be &gt; 0.\");\n                }\n                $snapshot = $this-&gt;products-&gt;getSnapshot($productId);\n                if (!$snapshot) {\n                    throw new ProductNotFound(\"Product {$productId} not found.\");\n                }\n                if ($qty &gt; $snapshot-&gt;stock) {\n                    throw new InsufficientStock(\"Insufficient stock for {$productId}.\");\n                }\n                $lineTotal = $snapshot-&gt;price * $qty;\n                $total += $lineTotal;\n                // Reserve/update stock\n                $this-&gt;products-&gt;decreaseStock($productId, $qty);\n                $lines[] = [\n                    'productId' =&gt; $productId,\n                    'qty'       =&gt; $qty,\n                    'price'     =&gt; $snapshot-&gt;price,\n                ];\n            }\n            $orderId = $this-&gt;orders-&gt;create($cmd-&gt;userId, $total, $lines);\n            return new OrderResult($orderId, $total);\n        });\n    }\n}\n</code></pre>\n<p><strong>Step Eï¼šæ§åˆ¶å™¨å˜å¾—è½»è–„ä¸”å¯æµ‹è¯•</strong></p>\n<pre><code class=\"language-php\">&lt;?php\ndeclare(strict_types=1);\nfinal class CheckoutController\n{\n    public function __construct(private readonly PlaceOrderHandler $handler) {}\n    public function placeOrder(array $request): array\n    {\n        try {\n            $itemsRaw = $request['items'] ?? [];\n            $items = array_map(\n                fn($it) =&gt; [\n                    'productId' =&gt; (int)($it['product_id'] ?? 0),\n                    'qty'       =&gt; (int)($it['qty'] ?? 0),\n                ],\n                is_array($itemsRaw) ? $itemsRaw : []\n            );\n            $cmd = new PlaceOrderCommand(\n                userId: (int)($request['user_id'] ?? 0),\n                items: $items\n            );\n            $result = $this-&gt;handler-&gt;handle($cmd);\n            return [\n                'ok' =&gt; true,\n                'order_id' =&gt; $result-&gt;orderId,\n                'total' =&gt; $result-&gt;total,\n            ];\n        } catch (DomainException $e) {\n            return ['ok' =&gt; false, 'error' =&gt; $e-&gt;getMessage()];\n        } catch (Throwable $e) {\n            // avoid leaking internals\n            return ['ok' =&gt; false, 'error' =&gt; 'Unexpected error'];\n        }\n    }\n}\n</code></pre>\n<p>è¿™ä¸ªç‰ˆæœ¬ä¸æ˜¯\"ä¸ºäº†å¤æ‚è€Œå¤æ‚\"ï¼Œè€Œæ˜¯æŠŠå¤æ‚åº¦æ”¾åˆ°äº†è¯¥æ”¾çš„åœ°æ–¹ï¼š</p>\n<ul>\n<li>ä¸šåŠ¡è§„åˆ™é›†ä¸­ç®¡ç†</li>\n<li>äº‹åŠ¡å—æ§</li>\n<li>æ§åˆ¶å™¨æç®€</li>\n<li>ä¾èµ–æŠ½è±¡åŒ–</li>\n<li>ç»ˆäºå¯ä»¥å†™æµ‹è¯•äº†</li>\n</ul>\n<p>è€Œä¸”è¿™äº›å…¨æ˜¯åŸç”Ÿ PHPï¼Œæ²¡ç”¨ä»€ä¹ˆé»‘é­”æ³•ã€‚</p>\n<h2 id=\"æµ‹è¯•åœæ­¢ç”©é”…ç»™è¯­è¨€çš„æœ€å¿«æ–¹å¼\">æµ‹è¯•ï¼šåœæ­¢ç”©é”…ç»™è¯­è¨€çš„æœ€å¿«æ–¹å¼</h2>\n<p>å¾ˆå¤š PHP å›¢é˜Ÿä¸å†™æµ‹è¯•ï¼Œå› ä¸ºæ—©å¹´å†™èµ·æ¥ç¡®å®åˆ«æ‰­ã€‚ä½†ç°åœ¨çš„ PHP å†™æµ‹è¯•å·²ç»å¾ˆé¡ºæ‰‹äº†ã€‚</p>\n<p>ä¸‹é¢ç”¨ä¸€ä¸ªç®€å•çš„ PHPUnit ä¾‹å­æ¼”ç¤ºï¼šé€šè¿‡ mock ä»“å‚¨æµ‹è¯•ä¸šåŠ¡é€»è¾‘ï¼Œå®Œå…¨ä¸éœ€è¦æ•°æ®åº“ã€‚</p>\n<h3 id=\"-phpunit-é£æ ¼çš„å•å…ƒæµ‹è¯•æ— éœ€æ•°æ®åº“\">âœ… PHPUnit é£æ ¼çš„å•å…ƒæµ‹è¯•ï¼ˆæ— éœ€æ•°æ®åº“ï¼‰</h3>\n<pre><code class=\"language-php\">&lt;?php\ndeclare(strict_types=1);\nuse PHPUnit\\Framework\\TestCase;\nfinal class PlaceOrderHandlerTest extends TestCase\n{\n    public function test_it_places_an_order_and_returns_total(): void\n    {\n        $tx = new class implements TransactionManager {\n            public function run(callable $fn): mixed { return $fn(); }\n        };\n        $users = new class implements UserRepository {\n            public function getStatus(int $userId): ?string { return 'active'; }\n        };\n        $products = new class implements ProductRepository {\n            private array $stock = [10 =&gt; 5];\n            public function getSnapshot(int $productId): ?ProductSnapshot {\n                if ($productId !== 10) return null;\n                return new ProductSnapshot(10, price: 200, stock: $this-&gt;stock[10]);\n            }\n            public function decreaseStock(int $productId, int $qty): void {\n                $this-&gt;stock[$productId] -= $qty;\n            }\n        };\n        $orders = new class implements OrderRepository {\n            public function create(int $userId, int $total, array $lines): int { return 123; }\n        };\n        $handler = new PlaceOrderHandler($tx, $users, $products, $orders);\n        $cmd = new PlaceOrderCommand(\n            userId: 7,\n            items: [\n                ['productId' =&gt; 10, 'qty' =&gt; 2],\n            ]\n        );\n        $result = $handler-&gt;handle($cmd);\n        $this-&gt;assertSame(123, $result-&gt;orderId);\n        $this-&gt;assertSame(400, $result-&gt;total);\n    }\n}\n</code></pre>\n<p>å¦‚æœä½ çš„ç”¨ä¾‹èƒ½è¿™æ ·æµ‹è¯•ï¼Œ\"PHP ä¸å¯ç»´æŠ¤\"è¿™ç§è¯å°±å¾ˆéš¾å†ç†ç›´æ°”å£®åœ°è¯´å‡ºå£äº†ã€‚å¯ç»´æŠ¤æ€§ä¸æ˜¯è¯­è¨€è‡ªå¸¦çš„èƒ½åŠ›ï¼Œæ˜¯é ç»“æ„å’Œæµ‹è¯•æ’‘èµ·æ¥çš„ã€‚</p>\n<h2 id=\"æ¡†æ¶ç¥è¯laravelsymfony-ä¸ä¼šè‡ªåŠ¨æ‹¯æ•‘ä½ \">\"æ¡†æ¶ç¥è¯\"ï¼šLaravel/Symfony ä¸ä¼šè‡ªåŠ¨æ‹¯æ•‘ä½ </h2>\n<p>æ¡†æ¶æœ‰ç”¨ï¼Œä½†å®ƒæ‹¦ä¸ä½ä½ å†™å‡ºçƒ‚æ¶æ„ã€‚æ¯”å¦‚åœ¨ Laravel é‡Œï¼Œä½ ç…§æ ·å¯ä»¥ï¼š</p>\n<ul>\n<li>å†™å‡ºè‡ƒè‚¿çš„æ§åˆ¶å™¨</li>\n<li>æŠŠé¢†åŸŸé€»è¾‘å…¨å¡è¿› Eloquent æ¨¡å‹</li>\n<li>å› ä¸ºè§‰å¾—\"ç»•äº†ä¸€å±‚\"è€Œç›´æ¥è·³è¿‡æœåŠ¡å±‚</li>\n</ul>\n<p>å¦‚æœä½ è§è¿‡æ§åˆ¶å™¨å†™äº† 800 è¡Œçš„ Laravel é¡¹ç›®ï¼Œé—®é¢˜ä¸åœ¨ Laravelï¼Œè€Œåœ¨äºå›¢é˜ŸæŠŠæ¡†æ¶å½“æˆäº†ä¸åšè®¾è®¡çš„ç†ç”±ã€‚</p>\n<p>æ¡†æ¶æ˜¯å·¥å…·ç®±ã€‚å®ƒèƒ½ç›–æˆ¿å­â€”â€”ä¹Ÿèƒ½å †ä¸€å †æœ¨å¤´ã€‚</p>\n<h2 id=\"ä¸ºä»€ä¹ˆ-php-æ¯”å…¶ä»–æŠ€æœ¯æ ˆæ›´å®¹æ˜“æŒ¨éª‚\">ä¸ºä»€ä¹ˆ PHP æ¯”å…¶ä»–æŠ€æœ¯æ ˆæ›´å®¹æ˜“æŒ¨éª‚</h2>\n<p>åŸå› è¯´èµ·æ¥æœ‰ç‚¹å¾®å¦™ï¼šåœ¨ PHP é‡Œï¼Œç³Ÿç³•çš„å†³ç­–æš´éœ²å¾—æ›´å¿«ã€‚</p>\n<p>æœ‰äº›æŠ€æœ¯æ ˆçš„æŠ½è±¡å±‚èƒ½æŠŠçƒ‚ä»£ç ç›–ä½æ›´é•¿æ—¶é—´ã€‚ä½†åœ¨ PHP é‡Œï¼Œå†™å¾—çƒ‚ä¸€çœ¼å°±èƒ½çœ‹å‡ºæ¥ï¼š</p>\n<ul>\n<li>èŒè´£æ··æ‚</li>\n<li>çº¦å®šä¸ä¸€è‡´</li>\n<li>å¤åˆ¶ç²˜è´´çš„é‡å¤ä»£ç </li>\n<li>éšè”½çš„å…¨å±€å˜é‡</li>\n<li>éšæ„çš„é”™è¯¯å¤„ç†</li>\n</ul>\n<p>PHP ä¸ä¼šæ›¿ä½ å…œåº•ï¼Œæ‰€ä»¥å®ƒæœ€å®¹æ˜“è¢«æ‹å‡ºæ¥å½“é¶å­ã€‚</p>\n<p>ä½†ä¸€é—¨é€¼ä½ å®ˆè§„çŸ©çš„è¯­è¨€ä¸è§å¾—\"æ›´å¥½\"ï¼Œå®ƒåªæ˜¯è®©ä½ æ›´éš¾å·æ‡’ã€‚PHP æŠŠé—¨æ§›æ”¾å¾—å¾ˆä½â€”â€”æ‰€ä»¥ä½ çš„å›¢é˜Ÿæ–‡åŒ–åè€Œæ›´é‡è¦ã€‚</p>\n<h2 id=\"æ•´æ´çš„-phpå¾ˆæ— èŠè¿™æ˜¯å¤¸å¥–\">\"æ•´æ´çš„ PHP\"å¾ˆæ— èŠâ€”â€”è¿™æ˜¯å¤¸å¥–</h2>\n<p>å†™å¾—æ•´æ´çš„ PHP ä»£ç ï¼Œé€šå¸¸çœ‹èµ·æ¥å¹³å¹³æ— å¥‡ï¼š</p>\n<ul>\n<li>å‘½åæ¸…æ™°</li>\n<li>å‡½æ•°çŸ­å°</li>\n<li>è¾“å…¥è¾“å‡ºæ˜ç¡®</li>\n<li>é”™è¯¯å¤„ç†å¯é¢„æµ‹</li>\n<li>ä¾èµ–æ³¨å…¥</li>\n<li>å°½é‡å°‘çš„é­”æ³•</li>\n</ul>\n<p>å®ƒä¸ç‚«æŠ€ï¼Œä¸è¿½æ±‚å·§å¦™ã€‚</p>\n<p>æ— èŠçš„ä»£ç åœ¨å‡Œæ™¨ä¸¤ç‚¹å®¹æ˜“è°ƒè¯•ã€‚æ— èŠçš„ä»£ç å®¹æ˜“äº¤ç»™æ–°åŒäº‹ã€‚æ— èŠçš„ä»£ç åœ¨å›¢é˜Ÿæ‰©å¼ æ—¶èƒ½æ‰›å¾—ä½ã€‚</p>\n<p>å¦‚æœä½ å¸Œæœ› PHP ä¸å†è¢«å½“ç¬‘è¯ï¼Œé‚£å°±å†™æ— èŠçš„ PHPã€‚</p>\n<h2 id=\"å®æ“æ¸…å•å¦‚ä½•åœæ­¢å†™è¢«äººéª‚çš„-php\">å®æ“æ¸…å•ï¼šå¦‚ä½•åœæ­¢å†™\"è¢«äººéª‚\"çš„ PHP</h2>\n<p>å¦‚æœä½ æƒ³å†™å‡ºä¸è¢«äººå˜²ç¬‘çš„ PHP ç³»ç»Ÿï¼Œä¸‹é¢æ˜¯ä¸€ä»½å®ç”¨çš„åº•çº¿æ¸…å•ï¼š</p>\n<ul>\n<li><strong>åœ¨æ–°ä»£ç ä¸­å¼€å¯ä¸¥æ ¼ç±»å‹</strong>ï¼š<code>declare(strict_types=1);</code></li>\n<li><strong>æ‰€æœ‰ä¾èµ–é€šè¿‡ Composer å’Œè‡ªåŠ¨åŠ è½½ç®¡ç†</strong>ï¼Œä¸è¦æ‰‹åŠ¨ includeã€‚</li>\n<li><strong>ä¿æŒæ§åˆ¶å™¨è½»è–„</strong>ï¼ˆåªå¤„ç† HTTPï¼‰ï¼Œä¸šåŠ¡è§„åˆ™æ”¾åˆ° handler/service ä¸­ã€‚</li>\n<li><strong>é¢†åŸŸè§„åˆ™å’ŒæŒä¹…åŒ–åˆ†ç¦»</strong>ï¼Œä»“å‚¨æˆ–æŸ¥è¯¢æœåŠ¡èƒ½ä¿æŒæ•°æ®è®¿é—®çš„ä¸€è‡´æ€§ã€‚</li>\n<li><strong>ä½¿ç”¨æ˜¾å¼çš„ DTO ä¼ é€’è¯·æ±‚å’Œå‘½ä»¤</strong>ï¼Œä¸è¦åˆ°å¤„ä¼ è£¸æ•°ç»„ã€‚</li>\n<li><strong>åŒºåˆ†é¢†åŸŸé”™è¯¯å’Œç³»ç»Ÿé”™è¯¯</strong>ï¼Œä¸æ˜¯æ¯ä¸ªå¼‚å¸¸éƒ½è¯¥æ˜¯ 500ã€‚</li>\n<li><strong>åœ¨ç”¨ä¾‹å±‚æ·»åŠ å•å…ƒæµ‹è¯•</strong>ï¼Œå¦‚æœä¸šåŠ¡é€»è¾‘ç¦»äº†æ•°æ®åº“å°±æ²¡æ³•æµ‹ï¼Œè¯´æ˜ä½ çš„è¾¹ç•Œåˆ’é”™äº†ã€‚</li>\n<li><strong>ä½¿ç”¨é™æ€åˆ†æå·¥å…·</strong>ï¼ˆPHPStan/Psalmï¼‰é˜²æ­¢éšæ€§å›å½’ã€‚</li>\n<li><strong>å¼•å…¥ä»£ç é£æ ¼å·¥å…·å¹¶åœ¨ CI ä¸­å¼ºåˆ¶æ‰§è¡Œ</strong>ï¼Œä¸€è‡´æ€§å¾ˆé‡è¦ã€‚</li>\n<li><strong>æŒç»­é‡æ„</strong>ï¼Œå¦‚æœé‡æ„å˜æˆäº†\"ä¸€ä¸ªé¡¹ç›®\"ï¼Œé‚£å®ƒæ°¸è¿œä¸ä¼šå‘ç”Ÿã€‚</li>\n</ul>\n<p>ä»¥ä¸Šè¿™äº›ä¸æ˜¯ PHP ç‹¬æœ‰çš„â€”â€”æ°æ°ç›¸åï¼Œæ”¾åˆ°å“ªä¸ªè¯­è¨€éƒ½ä¸€æ ·ã€‚</p>\n<h2 id=\"ç»“è¯­php-æ˜¯ä¸€é¢é•œå­åˆ«ç ¸é•œå­\">ç»“è¯­ï¼šPHP æ˜¯ä¸€é¢é•œå­â€”â€”åˆ«ç ¸é•œå­</h2>\n<p>PHP ä¸å®Œç¾ï¼Œæ²¡æœ‰è¯­è¨€æ˜¯å®Œç¾çš„ã€‚ä½†ç”¨ PHP é‡åˆ°çš„å¤§éƒ¨åˆ†ç—›è‹¦ä¸æ˜¯è¯­è¨€é€ æˆçš„ï¼Œè€Œæ˜¯å†™æ³•é€ æˆçš„ï¼šèµ¶å·¥ã€èŒè´£æ··æ‚ã€è¾¹ç•Œæ¨¡ç³Šã€\"ä»¥åå†æ”¹\"çš„æ–‡åŒ–ã€‚</p>\n<p>ä¸€ä¸ª PHP é¡¹ç›®å˜å¾—ä¸å¯æ”¶æ‹¾çš„æ—¶å€™ï¼Œå¾ˆå°‘æ˜¯å› ä¸º PHP æ’‘ä¸èµ·å¥½æ¶æ„ï¼Œè€Œæ˜¯ä»æ¥æ²¡äººæŠŠæ¶æ„å½“å›äº‹ã€‚</p>\n<p>PHP æ˜¯ä¸€é¢é•œå­ï¼š</p>\n<ul>\n<li>å¦‚æœä½ æœ‰çºªå¾‹ï¼Œå®ƒçœ‹èµ·æ¥å¾ˆä¸“ä¸šã€‚</li>\n<li>å¦‚æœä½ å¾ˆéšæ„ï¼Œå®ƒçœ‹èµ·æ¥å¾ˆæ··ä¹±ã€‚</li>\n<li>å¦‚æœä½ åœ¨æŒç»­çš„èµ¶å·¥å‹åŠ›ä¸‹æ²¡æœ‰è´¨é‡æ ‡å‡†ï¼Œå®ƒçœ‹èµ·æ¥å°±åƒæˆ˜åœºã€‚</li>\n</ul>\n<p>æ‰€ä»¥ä¸‹æ¬¡æœ‰äººè¯´\"éƒ½æ€ª PHP\"çš„æ—¶å€™ï¼Œä½ å¯ä»¥åé—®ä¸€å¥ï¼š</p>\n<p><strong>æ˜¯ PHP çš„é—®é¢˜â€¦â€¦è¿˜æ˜¯æˆ‘ä»¬æµç¨‹çš„é—®é¢˜ï¼Ÿ</strong></p>\n<p>å› ä¸ºä»£ç ä¸æ˜¯è¯­è¨€è‡ªå·±å†™çš„ã€‚</p>\n<p>æ˜¯ä½ å†™çš„ã€‚</p>\n<p><a href=\"https://catchadmin.com/post/2026-02/php-problem-isnt-language\" rel=\"noopener nofollow\" target=\"_blank\">PHP çš„é—®é¢˜ä¸åœ¨è¯­è¨€æœ¬èº«ï¼Œè€Œåœ¨æˆ‘ä»¬æ€ä¹ˆå†™å®ƒ </a></p>\n\n\n</div>\n<div class=\"clear\"></div>\n\n            </div>\n            <div class=\"postDesc\">posted @ \n<span id=\"post-date\">2026-02-13 07:59</span>&nbsp;\n<a href=\"https://www.cnblogs.com/catchadmin\">JaguarJack</a>&nbsp;\né˜…è¯»(<span id=\"post_view_count\">4</span>)&nbsp;\nè¯„è®º(<span id=\"post_comment_count\">0</span>)&nbsp;\n&nbsp;\n<a href=\"\">æ”¶è—</a>&nbsp;\n<a href=\"\">ä¸¾æŠ¥</a>\n</div>"
    },
    {
      "title": "è§£å¯†Promptç³»åˆ—69. ä»ä¸Šä¸‹æ–‡ç®¡ç†åˆ°Runtimeæ“ä½œç³»ç»Ÿ",
      "link": "https://www.cnblogs.com/gogoSandy/p/19610681",
      "published": "",
      "description": "<h1 class=\"postTitle\">\n                <a class=\"postTitle2 vertical-middle\" href=\"https://www.cnblogs.com/gogoSandy/p/19610681\" id=\"cb_post_title_url\" title=\"å‘å¸ƒäº 2026-02-13 07:46\">\n    <span>è§£å¯†Promptç³»åˆ—69. ä»ä¸Šä¸‹æ–‡ç®¡ç†åˆ°Runtimeæ“ä½œç³»ç»Ÿ</span>\n    \n\n</a>\n\n            </h1>\n            <div class=\"clear\"></div>\n            <div class=\"postBody\">\n                    <div id=\"cnblogs_post_description\" style=\"display: none;\">\n        <img alt=\"è§£å¯†Promptç³»åˆ—69. ä»ä¸Šä¸‹æ–‡ç®¡ç†åˆ°Runtimeæ“ä½œç³»ç»Ÿ\" class=\"desc_img\" src=\"https://img2024.cnblogs.com/blog/1326688/202602/1326688-20260213074605660-1624203228.png\" />\n        åœ¨ LLM å‘å±•çš„ä¸ŠåŠåœºï¼Œæˆ‘ä»¬æ‰§ç€äºä¸æ–­æ‹‰é•¿ Context Windowï¼Œä» 8K åˆ° 128K ç”šè‡³ç™¾ä¸‡çº§åˆ«ã€‚ä½†åœ¨ä¸‹åŠåœºæˆ‘ä»¬å›´ç»•Codingè¿™ä¸ªæ ¸å¿ƒè§†è§’æ¥å¯»æ‰¾ä¸€äº›æ–°çš„ä¸Šä¸‹æ–‡ç®¡ç†çš„æ€è·¯\n    </div>\n<div class=\"blogpost-body cnblogs-markdown\" id=\"cnblogs_post_body\">\n<p>åœ¨ LLM å‘å±•çš„ä¸ŠåŠåœºï¼Œæˆ‘ä»¬æ‰§ç€äºä¸æ–­æ‹‰é•¿ Context Windowï¼Œä» 8K åˆ° 128K ç”šè‡³ç™¾ä¸‡çº§åˆ«ã€‚ä½†åœ¨ä¸‹åŠåœºï¼Œèµ„æ·±å¼€å‘è€…ä»¬é€æ¸æ„è¯†åˆ°ï¼šç›²ç›®æ‹‰é•¿ä¸Šä¸‹æ–‡æ˜¯åœ¨ç”¨æ˜‚è´µçš„ç®—åŠ›æ©ç›–é€»è¾‘ç®¡ç†çš„æ— èƒ½ä¸ºä¾‹ã€‚ è¿™ä¸€ç« æˆ‘ä»¬å›´ç»•<strong>Coding</strong>è¿™ä¸ªæ ¸å¿ƒè§†è§’æ¥å¯»æ‰¾ä¸€äº›æ–°çš„ä¸Šä¸‹æ–‡ç®¡ç†çš„æ€è·¯ï¼š<strong>ä»¥ Coding ä¸ºæ ¸å¿ƒï¼Œå°† Context è§†ä¸ºâ€œå†…å­˜ï¼ˆRAMï¼‰â€ï¼Œå°† Runtime è§†ä¸ºâ€œçŠ¶æ€ï¼ˆStateï¼‰â€ï¼Œæ„å»ºä¸€å¥—å±äºæ™ºèƒ½ä½“çš„â€œæ“ä½œç³»ç»Ÿâ€ã€‚</strong></p>\n<p>æœ€è¿‘ï¼ŒByteDance çš„ Context-Foldingã€MIT çš„ RLMã€ä»¥åŠçƒ­é—¨é¡¹ç›® Ralph çš„å‡ºç°ï¼Œå…±åŒæŒ‡å‘äº†ä¸€ä¸ªæå…¶æ˜ç¡®çš„è¶‹åŠ¿ï¼šæœªæ¥çš„æ™ºèƒ½ä½“ä¸å†æ˜¯â€œæ–‡æœ¬ç”Ÿæˆå™¨â€ï¼Œè€Œæ˜¯Stateful Runtime Operatorã€‚</p>\n<p>è¿™ä¸€ç« æˆ‘ä»¬ä¸ç²¾è¯»è®ºæ–‡ï¼Œè€Œæ˜¯å›´ç»•codingçš„ä¸Šä¸‹æ–‡ç®¡ç†ï¼Œåˆ†åˆ«çœ‹ä¸‹ä»¥ä¸‹è®ºæ–‡ä¸­ç›¸å…³çš„ç‚¹ã€‚</p>\n<h2 id=\"å†…å­˜æŠ˜å ä¸Šä¸‹æ–‡çš„åˆ†çº§æ²»ç†ä¸åƒåœ¾å›æ”¶\">å†…å­˜æŠ˜å ï¼šä¸Šä¸‹æ–‡çš„â€œåˆ†çº§æ²»ç†â€ä¸åƒåœ¾å›æ”¶</h2>\n<blockquote>\n<ul>\n<li>Scaling Long-Horizon LLM Agent via Context-Folding</li>\n</ul>\n</blockquote>\n<p><img alt=\"image\" class=\"lazyload\" /><br />\nåœ¨é•¿ç¨‹ä»»åŠ¡ï¼ˆå¦‚ Deep Research æˆ–å…¨åº“ä»£ç ä¿®æ”¹ï¼‰ä¸­ï¼ŒAgent ä¼šäº§ç”Ÿæµ·é‡çš„ä¸­é—´å·¥å…·è°ƒç”¨æ—¥å¿—ã€‚ä¼ ç»Ÿçš„åšæ³•æ˜¯å…¨é‡å †å ï¼Œä½†è¿™ä¼šå¯¼è‡´ä¸Šä¸‹æ–‡è¿…é€Ÿâ€œé€šèƒ€â€ã€‚</p>\n<ol>\n<li>æ ¸å¿ƒå·¥ç¨‹å®ç°ï¼šBranch &amp; Return<br />\nå­—èŠ‚çš„æ–¹æ¡ˆéå¸¸ Native åœ°å€Ÿé‰´äº† Git åˆ†æ”¯ç®¡ç†çš„æ¦‚å¿µï¼š</li>\n</ol>\n<ul>\n<li>Branch(description, prompt)ï¼šåˆ›å»ºä¸€ä¸ªå­åˆ†æ”¯ï¼Œå¼€å¯å­ä»»åŠ¡ï¼Œæ­¤æ—¶æ‰€æœ‰çš„ä¸­é—´é€»è¾‘ï¼ˆæœç´¢ç»“æœã€è¯»å–çš„é•¿æ–‡ä»¶ï¼‰ä»…åœ¨å­åˆ†æ”¯å†…æµè½¬ã€‚</li>\n<li>Return(message)ï¼šå­ä»»åŠ¡ç»“æŸï¼Œç‰©ç†åˆ é™¤å­åˆ†æ”¯å†…æ‰€æœ‰è¿‡ç¨‹ Tokenï¼Œä»…å°†ç²¾ç‚¼åçš„æ‰§è¡Œç»“æœ merge å›ä¸»åˆ†æ”¯ã€‚</li>\n</ul>\n<p><img alt=\"image\" class=\"lazyload\" /></p>\n<p>è¿™é‡Œå­—èŠ‚æ˜¯ä½¿ç”¨äº†GRPOæ¥é€šè¿‡è®­ç»ƒä¼˜åŒ–æ¨¡å‹è°ƒç”¨Branchå’ŒReturnå·¥å…·çš„å‡†ç¡®ç¨‹åº¦ï¼Œä¸è¿‡è¿™ä¸ªæŠ˜å çš„æ€è·¯å…¶å®æ˜¯å¯ä»¥é€šè¿‡å·¥å…·æè¿°ç»“åˆGitçš„ç›¸å…³æ“ä½œæ¥å®ç°ã€‚</p>\n<p>è¿‘æœŸClaude 2.1çš„æœ€æ–°è¿­ä»£ä¸­ï¼ŒSKILLSå·²ç»æ”¯æŒäº†forkåŠŸèƒ½ï¼Œè®©SKILLSåœ¨éš”ç¦»çš„ä¸Šä¸‹æ–‡ä¸­è¿è¡Œï¼Œä¸ä¼šæ±¡æŸ“å¤–å±‚ä¼šè¯ã€‚æ‰€ä»¥åœ¨å½“å‰è¿™ä¸ªé˜¶æ®µï¼Œå¤§å®¶çš„æƒ³æ³•éƒ½è¶‹äºä¸€è‡´æ€§~</p>\n<h2 id=\"rlmæŠŠä¸Šä¸‹æ–‡å½“ä½œå¤–éƒ¨å­˜å‚¨çš„æ¸è¿›å¼åŠ è½½\">RLMï¼šæŠŠä¸Šä¸‹æ–‡å½“ä½œâ€œå¤–éƒ¨å­˜å‚¨â€çš„æ¸è¿›å¼åŠ è½½</h2>\n<blockquote>\n<ul>\n<li>RECURSIVE LANGUAGE MODELS</li>\n</ul>\n</blockquote>\n<p>RLM çš„æ€è·¯ä¸æ•°æ®é¢„å¤„ç†ä¸­çš„â€œæ¸è¿›å¼åŠ è½½â€å¦‚å‡ºä¸€è¾™ï¼šå½“å†…å­˜ï¼ˆContext Windowï¼‰è£…ä¸ä¸‹è¶…å¤§æ–‡ä»¶ï¼ˆLong Promptï¼‰æ—¶ï¼Œä¸è¦å¼ºè¡Œè´Ÿè½½ï¼Œè€Œæ˜¯é€šè¿‡ç¼–ç¨‹æ‰‹æ®µåˆ†ç‰‡å¤„ç†ã€‚</p>\n<p><img alt=\"image\" class=\"lazyload\" /></p>\n<ol>\n<li><strong>æ ¸å¿ƒèŒƒå¼ï¼šä¸Šä¸‹æ–‡å³å˜é‡</strong><br />\nRLM å°†æç¤ºè¯åŠ è½½ä¸º Python REPL ç¯å¢ƒä¸­çš„å…¨å±€å˜é‡ ctxã€‚æ¨¡å‹ä¸å†æ˜¯â€œé˜…è¯»â€æŒ‡ä»¤ï¼Œè€Œæ˜¯é€šè¿‡ä»¥ä¸‹æ“ä½œâ€œæ“æ§â€æŒ‡ä»¤ï¼š</li>\n</ol>\n<ul>\n<li>Probeï¼šé€šè¿‡ print(ctx[:500]) è§‚å¯ŸæŒ‡ä»¤å±€éƒ¨ã€‚</li>\n<li>Split &amp; Loopï¼šæ ¹æ®å…³é”®è¯åˆ†å‰²æŒ‡ä»¤ï¼Œå¹¶è¿›è¡Œå¾ªç¯é€’å½’ã€‚</li>\n<li>Regexï¼šåˆ©ç”¨æ­£åˆ™ç²¾å‡†å®šä½å…³é”®ä¿¡æ¯ã€‚</li>\n<li>llm_queryï¼šè¿™æ˜¯è®ºæ–‡ä¸­å¾ˆæœ‰æ„æ€çš„ä¸€ä¸ªç‚¹ï¼ˆå“ˆå“ˆè™½ç„¶æˆ‘å¯¹æ•ˆæœå­˜ç–‘ï¼‰â€”â€”åœ¨ä»£ç ç¯å¢ƒä¸­åå‘æš´éœ²å¤§æ¨¡å‹èƒ½åŠ›ï¼Œå®ç°â€œæ¨¡å‹åµŒå¥—ä»£ç ï¼Œä»£ç è°ƒç”¨æ¨¡å‹â€ã€‚</li>\n</ul>\n<p>è¿™é‡Œå¯¹æ¯”Context-Foldingåœ¨æ¯ä¸ªbranchå¼€å§‹è¿˜éœ€è¦ä¸»Branchå‘å­branchå‘é€å…¨éƒ¨ä¿¡æ¯ï¼Œè€ŒRLMåªéœ€è¦é€šè¿‡å…¨å±€çš„å˜é‡æŒä¹…åŒ–ï¼Œå°±å¯ä»¥å®ç°ä¸»è¦ä¿¡æ¯çš„ç›´æ¥ä¼ é€’ï¼Œæ— éœ€å¤§é‡æ˜¾å¼çš„ä¿¡æ¯ä¼ é€’ã€‚</p>\n<p>è¿™é‡Œå°±æœ‰ä¸¤ä¸ªç‚¹æ„Ÿè§‰æœ‰è¯•éªŒä¸‹çš„ä»·å€¼</p>\n<ul>\n<li><strong>é€šè¿‡æŒä¹…åŒ–å˜é‡ä¼ é€’ä¿¡æ¯</strong>ï¼šä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯é€šè¿‡printæ‰“å°å˜é‡çš„å…³é”®ä¿¡æ¯ï¼Œå› ä¸ºcodingæ˜¯ä¸éšå¤šè½®å¯¹è¯ä¼ é€’çš„ï¼Œå› æ­¤éœ€è¦åœ¨è§‚æµ‹ä¸­æš´éœ²å¿…è¦ä¿¡æ¯ï¼Œè¿™ä¸€ç‚¹å…¶å®æ˜¯ä¸ç¨³å®šçš„æ ¹æº</li>\n<li><strong>åœ¨codeç¯å¢ƒä¸­å¼•å…¥æ¨¡å‹æ“ä½œ</strong>: ä½¿ç”¨ä¾‹å¦‚RLMå®šä¹‰çš„llm_queryè¿™ä¸ªå‡½æ•°ï¼Œåœ¨ä»£ç å·¥å…·ä¸­åå‘æš´éœ²å¤§æ¨¡å‹æ“ä½œï¼Œä»è€ŒæŠŠç®€å•çš„ä»£ç å·¥å…·ï¼Œè¿›ä¸€æ­¥æ‹“å±•æˆæ‹¥æœ‰æ¨¡å‹èƒ½åŠ›çš„ç‹¬ç«‹å­æ™ºèƒ½ä½“</li>\n</ul>\n<p>ä½¿ç”¨GPT5çš„å®Œæ•´æŒ‡ä»¤å¦‚ä¸‹ï¼Œä»…å‚è€ƒæ€è·¯ï¼Œä¸ªäººæ›´å€¾å‘ä»å·¥å…·è§’åº¦å»åšç»“åˆï¼ˆè¿˜æ˜¯è¦é¡ºç€æ¨¡å‹nativeèƒ½åŠ›çš„å‘å±•æ–¹å‘å»åšï¼‰~</p>\n<p><img alt=\"image\" class=\"lazyload\" /></p>\n<p><img alt=\"image\" class=\"lazyload\" /></p>\n<h2 id=\"caveagentåŒæµæ¶æ„ä¸‹çš„çŠ¶æ€åŒ–è¿è¡Œæ—¶\">CaveAgentï¼šåŒæµæ¶æ„ä¸‹çš„â€œçŠ¶æ€åŒ–â€è¿è¡Œæ—¶</h2>\n<blockquote>\n<ul>\n<li>CaveAgent: Transforming LLMs into Stateful Runtime Operators</li>\n</ul>\n</blockquote>\n<p>CaveAgent è¿›ä¸€æ­¥å¼ºåŒ–äº†â€œå˜é‡å³è®°å¿†â€çš„æ€è·¯ã€‚å®ƒæå‡º LLM åº”è¯¥åœ¨ä¸¤ä¸ªæµä¸­åˆ‡æ¢ï¼š</p>\n<p><strong>1. Dual-stream Architecture</strong></p>\n<ul>\n<li>Semantic Streamï¼ˆè¯­ä¹‰æµï¼‰ï¼šè½»é‡çº§æ¨ç†ä¸Šä¸‹æ–‡ï¼Œä»…è®°å½•â€œæƒ³äº†ä»€ä¹ˆâ€ã€‚</li>\n<li>Runtime Streamï¼ˆè¿è¡Œæ—¶æµï¼‰ï¼šæŒä¹…åŒ–çš„ Python ç¯å¢ƒï¼Œè®°å½•â€œå­˜äº†ä»€ä¹ˆâ€ã€‚æ¨¡å‹ç›´æ¥æ“ä½œå¤–éƒ¨å˜é‡çš„â€œå¥æŸ„ï¼ˆHandleï¼‰â€è€Œä¸æ˜¯å†…å®¹ã€‚</li>\n</ul>\n<p><img alt=\"image\" class=\"lazyload\" /></p>\n<p><strong>2. æ·±åº¦æ€è€ƒï¼šå˜é‡ vs. æ–‡ä»¶</strong><br />\nManusä¹‹å‰åœ¨ä¸Šä¸‹æ–‡ç®¡ç†ä¸­æ¨å´‡ä»¥æ–‡ä»¶ä½œä¸ºæŒä¹…åŒ–ä»‹è´¨ï¼Œä½†å˜é‡å­˜å‚¨åœ¨æŸäº›åœºæ™¯ä¸‹æ›´æœ‰ä¼˜åŠ¿ï¼š</p>\n<ul>\n<li><strong>æ›´ç»†ç²’åº¦çš„è§‚æµ‹</strong>ï¼šåˆ©ç”¨ df.describe() æˆ– obj.<strong>dict</strong> å¯ä»¥ç”Ÿæˆæ¯”æ–‡ä»¶è¯»å–æ›´ç²¾ç‚¼ã€ç»“æ„åŒ–çš„ä¿¡æ¯è§‚æµ‹ï¼ˆState Observationï¼‰ï¼Œè¿™æ¯” RAG æ£€ç´¢æ–‡ä»¶ç‰‡æ®µæ›´ç²¾å‡†ã€‚</li>\n<li><strong>è¿è¡Œæ—¶ä¸€è‡´æ€§</strong>ï¼šå˜é‡æ”¯æŒæ¡ä»¶ç­›é€‰ã€åŠ¨æ€æ›´æ–°ï¼ˆä¾‹å¦‚ Plan ç»“æ„ä½“ï¼‰ï¼Œæ¯å®Œæˆä¸€æ­¥ï¼Œå°† is_finish ç½®ä¸º Trueï¼Œå®ç°åŸç”Ÿçš„çŠ¶æ€è·Ÿè¸ªã€‚</li>\n</ul>\n<p>å¯ä»¥å½“å‰çœ‹å˜é‡æœ€å¤§çš„é—®é¢˜åœ¨äºè§‚æµ‹ä¿¡æ¯çš„å±€éƒ¨åŒ–ï¼Œå’Œæ–‡ä»¶æ‰€è§å³æ‰€å¾—å­˜åœ¨å·®å¼‚ï¼Œå¦‚ä½•æ›´å…¨é¢å®Œæ•´ç²¾ç®€çš„æè¿°å˜é‡æ˜¯ä¸€ä¸ªå€¼å¾—æ€è€ƒçš„é—®é¢˜ã€‚</p>\n<h2 id=\"ralph\">Ralph</h2>\n<blockquote>\n<ul>\n<li><a href=\"https://ghuntley.com/ralph/\" rel=\"noopener nofollow\" target=\"_blank\">https://ghuntley.com/ralph/</a></li>\n</ul>\n</blockquote>\n<p>Ralph é¡¹ç›®æœ€è¿‘åœ¨ç¤¾åŒºæç«ï¼Œå®ƒçš„åå­—â€œRepeatedly running agent in a loopâ€æ­ç¤ºäº†å®ƒçš„æœ¬è´¨ï¼šé€šè¿‡â€œä¸Šä¸‹æ–‡å½»åº•é‡ç½®â€æ¥ä¿è¯é•¿ç¨‹ä»»åŠ¡ä¸å´©æºƒã€‚</p>\n<p>æ•´ä¸ªæ™ºèƒ½ä½“çš„æ‰§è¡Œé“¾è·¯ï¼Œåœ¨æŒ‡ä»¤é‡Œé¢æœ‰æ¯”è¾ƒæ¸…æ™°çš„æè¿°</p>\n<pre><code class=\"language-markdown\">## Your Task\n1. Read the PRD at `prd.json` (in the same directory as this file)\n2. Read the progress log at `progress.txt` (check Codebase Patterns section first)\n3. Check you're on the correct branch from PRD `branchName`. If not, check it out or create from main.\n4. Pick the **highest priority** user story where `passes: false`\n5. Implement that single user story\n6. Run quality checks (e.g., typecheck, lint, test - use whatever your project requires)\n7. Update AGENTS.md files if you discover reusable patterns (see below)\n8. If checks pass, commit ALL changes with message: `feat: [Story ID] - [Story Title]`\n9. Update the PRD to set `passes: true` for the completed story\n10. Append your progress to `progress.txt`\n</code></pre>\n<p><strong>1. ä»¥ä»£ç æ‰§è¡Œä¸ºæ ¸å¿ƒçš„plan &amp; Execute</strong></p>\n<ol>\n<li>Planç¯èŠ‚<br />\nè¿™ä¸€æ­¥å…¶å®å’Œå¤§å®¶å¸¸ç”¨çš„Planç±»ä¼¼ï¼ŒRalphé€‰æ‹©JSONæ–‡ä»¶è¿›è¡Œæ­¥éª¤ç®¡ç†ã€‚Anthropicä¹Ÿé‡‡ç”¨äº†ç›¸ä¼¼çš„æ€è·¯ï¼Œè®¤ä¸ºJSONæ¯”Markdownæ¨¡å‹è¿›è¡Œä¹±æ”¹çš„æ¦‚ç‡æ›´å°ã€‚RaphalæŠŠç”ŸæˆPlançš„è¿‡ç¨‹æ‹†åˆ†æˆäº†ä¸¤ä¸ªæ­¥éª¤ï¼Œåˆ†åˆ«ç”¨SKILLSæ¥å®ç°</li>\n</ol>\n<ul>\n<li>ç”Ÿæˆmarkdownæ ¼å¼çš„PRDæ–‡æ¡£ï¼šæ ¹æ®ç”¨æˆ·éœ€æ±‚ï¼Œå¯ä»¥é€‚å½“è¿½é—®æ˜ç¡®ç»†èŠ‚ï¼Œç„¶åç”Ÿæˆå¯¹åº”æ ¼å¼çš„PRDæ–‡ä»¶ã€‚ä¸¤ä¸ªæ ¸å¿ƒè¦æ±‚\n<ul>\n<li>å•ä¸ªstepè¦è¶³å¤ŸåŸå­åŒ–ï¼ˆä¿è¯ä¸Šæ–‡é•¿åº¦å¯ä»¥è¶³å¤Ÿå®Œæˆä»»åŠ¡ï¼‰ï¼Œä½†å®é™…ä¸Šè¿™åªæ˜¯ç¾å¥½çš„æ„¿æœ›ï¼Œä¾æ—§éœ€è¦åå¤„ç†å‹ç¼©é€»è¾‘æ¥100%ä¿è¯</li>\n<li>å…·ä½“å¯è¡¡é‡çš„éªŒæ”¶æ ‡å‡†ï¼šé€šè¿‡lintã€testã€browser verifyè¿›è¡Œæ˜ç¡®éªŒæ”¶åé¦ˆ</li>\n</ul>\n</li>\n</ul>\n<ol start=\"2\">\n<li>Executeç¯èŠ‚<br />\næ‰§è¡Œæ­¥éª¤ï¼Œä¼šå¾ªç¯ä»¥ä¸ŠPRD.jsonçš„æ‰€æœ‰æ­¥éª¤ï¼ŒæŒ‰é¡ºåºè¿›è¡Œæ‰§è¡Œï¼Œæ¯ä¸ªStepæ‰§è¡Œæ˜¯Bashé‡Œé¢å…¨æ–°çš„ä¸€æ¬¡æ™ºèƒ½ä½“å¾ªç¯ï¼Œæ‰€ä»¥æ‹¥æœ‰å…¨æ–°çš„ä¸Šä¸‹æ–‡ï¼Œä½†æ˜¯å¼•å…¥äº†<strong>ç»éªŒå‹ç¼©æ­¥éª¤</strong></li>\n</ol>\n<ul>\n<li>progress.txtï¼šåŸºäºå‰é¢æ‰§è¡Œæ­¥éª¤çš„é‡è¦è§‚æµ‹ï¼Œæ ¸å¿ƒåŒ…æ‹¬å·²å®ŒæˆåŠŸèƒ½ã€æ–‡ä»¶ä¿®æ”¹ã€ä»¥åŠåé¢æ‰§è¡Œä»»åŠ¡å¯ä»¥å€Ÿé‰´çš„ç»éªŒ</li>\n<li>Agents.md: æŠŠæ•´ä¸ªé¡¹ç›®å¯å¤ç”¨çš„ç¼–ç ç»éªŒï¼Œåœ¨æ¯æ¬¡æ‰§è¡Œå®Œæˆä»¥åï¼Œæ›´æ–°åˆ°Agents.mdã€‚å…¶å®åœ¨å‰é¢çš„progerss.txtå·²ç»æœ‰ä¸€è½®<strong>ç»éªŒåæ€å’Œå‹ç¼©</strong>ã€‚æ‰€ä»¥å…¶å®è¿™é‡Œæ˜¯ä¸¤ç§ä¸åŒç­‰çº§çš„ç»éªŒæå–ï¼Œä¸è¿‡æ„Ÿè§‰æŒ‡ä»¤é‡Œé¢åŒºåˆ†çš„å¹¶ä¸ç®—å¾ˆæ¸…æ™°ã€‚å¯ä»¥è¿›ä¸€æ­¥åˆ†æˆProject Specificå’ŒEngineer Specificå¯èƒ½ä¼šæ›´åŠ æ¸…æ™°ã€‚</li>\n</ul>\n<p>ä¸€ä¸ªå¤šæ­¥å¾ªç¯çš„Demoå¦‚ä¸‹å›¾æ‰€ç¤º<br />\n<img alt=\"image\" class=\"lazyload\" /></p>\n<h2 id=\"äº”-æ€»ç»“ä¸çªç ´è¿ˆå‘-vm-agent-æ¶æ„\">äº”ã€ æ€»ç»“ä¸çªç ´ï¼šè¿ˆå‘ VM-Agent æ¶æ„</h2>\n<p>ç®€å•æ€»ç»“ä¸‹ï¼ŒAgentçš„ä¸Šä¸‹æ–‡åº”è¯¥æ˜¯åŸºäºçŠ¶æ€æœºå’Œä»£ç è¿è¡Œæ—¶çš„ä¸Šä¸‹æ–‡æ²»ç†åè®®ï¼š</p>\n<ul>\n<li><strong>è§£è€¦â€œæƒ³â€ä¸â€œè®°â€</strong>ï¼šçª—å£åªç•™å½“å‰ä»»åŠ¡ï¼›Runtimeå­˜å‚¨æ´»è·ƒå˜é‡ï¼›æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨é•¿æ•ˆç»éªŒã€‚</li>\n<li><strong>ç¬¦å·åŒ–æ“ä½œ</strong>ï¼šå¼ºåˆ¶è¦æ±‚æ¨¡å‹é€šè¿‡ search()ã€split()ã€filter() æ¥æ„ŸçŸ¥é•¿ä¸Šä¸‹æ–‡ï¼Œä¸¥ç¦ç›´æ¥è¯»å–è¶…é•¿æ–‡æœ¬ã€‚</li>\n<li><strong>é€’å½’å‡½æ•°åŒ–</strong>ï¼šå°†å¤æ‚çš„å­ä»»åŠ¡å°è£…æˆ Python å‡½æ•°ï¼Œå†…éƒ¨è°ƒç”¨ llm_queryï¼Œå®ç°çœŸæ­£çš„æ¨¡å—åŒ–æ¨ç†ã€‚</li>\n</ul>\n<p>åœ¨è¿½æ±‚æ— é™é•¿çš„contextçš„åŒæ—¶ï¼Œè¿½æ±‚æ— é™ç²¾ç®€çš„æœ‰æ•ˆçŠ¶æ€</p>\n\n\n</div>\n<div class=\"clear\"></div>\n\n            </div>\n            <div class=\"postDesc\">posted @ \n<span id=\"post-date\">2026-02-13 07:46</span>&nbsp;\n<a href=\"https://www.cnblogs.com/gogoSandy\">é£é›¨ä¸­çš„å°ä¸ƒ</a>&nbsp;\né˜…è¯»(<span id=\"post_view_count\">7</span>)&nbsp;\nè¯„è®º(<span id=\"post_comment_count\">0</span>)&nbsp;\n&nbsp;\n<a href=\"\">æ”¶è—</a>&nbsp;\n<a href=\"\">ä¸¾æŠ¥</a>\n</div>"
    },
    {
      "title": "[æ‹†è§£LangChainæ‰§è¡Œå¼•æ“] __pregel_tasksé€šé“â€”â€”æˆå°±â€œPUSHä»»åŠ¡â€çš„åŠŸè‡£",
      "link": "https://www.cnblogs.com/jaydenai/p/19610066/pregel_tasks_channel",
      "published": "",
      "description": "<h1 class=\"postTitle\">\n                <a class=\"postTitle2 vertical-middle\" href=\"https://www.cnblogs.com/jaydenai/p/19610066/pregel_tasks_channel\" id=\"cb_post_title_url\" title=\"å‘å¸ƒäº 2026-02-13 07:32\">\n    <span>[æ‹†è§£LangChainæ‰§è¡Œå¼•æ“] __pregel_tasksé€šé“â€”â€”æˆå°±â€œPUSHä»»åŠ¡â€çš„åŠŸè‡£</span>\n    \n\n</a>\n\n            </h1>\n            <div class=\"clear\"></div>\n            <div class=\"postBody\">\n                    <div id=\"cnblogs_post_description\" style=\"display: none;\">\n        \n        é™¤äº†æˆ‘ä»¬æ˜¾å¼å£°æ˜çš„ç”¨äºå­˜å‚¨ä¸šåŠ¡æ•°æ®æˆ–é©±åŠ¨ä¿¡å·çš„Channelä¹‹å¤–ï¼ŒPregelè‡ªèº«ä¹Ÿä¼šç»´æŠ¤ä¸€äº›ç³»ç»ŸChannelï¼Œå…¶ä¸­æœ€é‡è¦çš„è«è¿‡äºä¸€ä¸ªåä¸ºâ€œ__pregel_tasksâ€çš„Channelï¼Œæ˜¯å®ƒæˆå°±äº†åŸºäºâ€œPUSHâ€çš„èŠ‚ç‚¹ä»»åŠ¡æ‰§è¡Œæ–¹å¼ã€‚\n    </div>\n<div class=\"blogpost-body cnblogs-markdown\" id=\"cnblogs_post_body\">\n<p>é™¤äº†æˆ‘ä»¬æ˜¾å¼å£°æ˜çš„ç”¨äºå­˜å‚¨ä¸šåŠ¡æ•°æ®æˆ–é©±åŠ¨ä¿¡å·çš„Channelä¹‹å¤–ï¼ŒPregelè‡ªèº«ä¹Ÿä¼šç»´æŠ¤ä¸€äº›ç³»ç»ŸChannelï¼Œå…¶ä¸­æœ€é‡è¦çš„è«è¿‡äºä¸€ä¸ªåä¸º<code>__pregel_tasks</code>çš„Channelã€‚é€šè¿‡å‰é¢é’ˆå¯¹BSPçš„ä»‹ç»ï¼Œæˆ‘ä»¬çŸ¥é“å½“Superstepè¿›å…¥åŒæ­¥å±éšœå¹¶åº”ç”¨æ‰€æœ‰æ›´æ–°åï¼Œå¼•æ“ä¼šæ ¹æ®Nodeé’ˆå¯¹Channelçš„è®¢é˜…æƒ…å†µå’ŒChannelè‡ªèº«çš„æ›´æ–°çŠ¶æ€ç”Ÿæˆä¸‹ä¸€æ­¥å¾…æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå…¶å®å¾…æ‰§è¡Œçš„ä»»åŠ¡ä¸é™äºæ­¤ã€‚</p>\n<h2 id=\"1-ä¸¤ç§ä»»åŠ¡åˆ›å»ºæ–¹å¼\">1. ä¸¤ç§ä»»åŠ¡åˆ›å»ºæ–¹å¼</h2>\n<p>æˆ‘ä»¬å°†æ ¹æ®Nodeé’ˆå¯¹Channelçš„è®¢é˜…æ¥é©±åŠ¨ä»»åŠ¡æ‰§è¡Œçš„æ¨¡å¼ç§°ä¸º â€œPullæ¨¡å¼â€ï¼Œä¸ä¹‹ç›¸å¯¹çš„åˆ™æ˜¯è§£å†³â€œ__pregel_tasksâ€è¿™ä¸ªChannelå®ç°çš„â€œPushæ¨¡å¼â€ã€‚å…·ä½“æ¥è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ªå…³é—­â€œç´¯ç§¯æ¨¡å¼â€çš„Topicç±»å‹çš„Channelï¼Œå®ƒå­˜å‚¨çš„â€œTopicâ€ä½“ç°ä¸ºå…·æœ‰å¦‚ä¸‹å®šä¹‰çš„Sendå¯¹è±¡ã€‚å½“æŸä¸ªNodeæ‰§è¡Œä¹‹åï¼Œå¯ä»¥åƒè¿™ä¸ªChannelä¸­å†™å…¥ä¸€ä¸ªSendæ¥é©±åŠ¨æŸä¸ªNodeåœ¨ä¸‹ä¸€Superstepä¸­æ‰§è¡Œã€‚é™¤äº†åˆ©ç”¨Sendå¯¹è±¡çš„nodeå­—æ®µæŒ‡å®šå¾…æ‰§è¡Œçš„Nodeåç§°å¤–ï¼Œè¿˜å¯ä»¥åˆ©ç”¨argå­—æ®µæä¾›è¾“å…¥å‚æ•°ã€‚</p>\n<pre><code class=\"language-python\">class Send:   \n    node: str\n    arg: Any\n    def __init__(self, /, node: str, arg: Any) -&gt; None\n</code></pre>\n<p>ç”±äºå…³é—­äº†â€œç´¯ç§¯æ¨¡å¼â€ï¼Œåœ¨Topicç±»å‹Channelä¸­å†™å…¥çš„å†…å®¹åªä¼šåœ¨ä¸‹ä¸€ä¸ªSuperstepä¸­ç”Ÿæ•ˆï¼Œå¹¶ä¸”â€œé˜…åå³ç„šâ€ã€‚å¯¹äºæ‰§è¡Œå¼•æ“æ¥è¯´ï¼Œè¿™ä¸ªåä¸ºâ€œ__pregel_tasksâ€çš„Channelå­˜å‚¨çš„å°±æ˜¯ä¸‹ä¸€Superstepä»¥â€œPushæ¨¡å¼â€é©±åŠ¨æ‰§è¡Œçš„ä»»åŠ¡åˆ—è¡¨ï¼Œä¸¤è€…å®Œç¾å¥‘åˆã€‚</p>\n<h2 id=\"2-ç¡®è®¤__pregel_tasksé€šé“çš„å­˜åœ¨\">2. ç¡®è®¤__pregel_tasksé€šé“çš„å­˜åœ¨</h2>\n<p>__pregel_tasksé€šé“çš„å­˜åœ¨å¯ä»¥é€šè¿‡å¦‚ä¸‹çš„æ¼”ç¤ºå®ä¾‹æ¥éªŒè¯ã€‚å¦‚ä»£ç ç‰‡æ®µæ‰€ç¤ºï¼Œåœ¨é‡‡ç”¨å¸¸è§„æ–¹å¼å°†Pregelå¯¹è±¡åˆ›å»ºå‡ºæ¥åï¼Œæˆ‘ä»¬æ ¹æ®Channelåç§°ä»å®ƒçš„channelså­—æ®µä¸­å°†æ­¤Channelæå–å‡ºæ¥ã€‚æ–­è¨€æ­ç¤ºäº†è¯¥Channelè‡ªèº«çš„ç±»å‹ã€å­˜å‚¨çš„æ•°æ®ç±»å‹å’Œâ€œç´¯ç§¯æ¨¡å¼â€å¼€å…³ã€‚</p>\n<pre><code class=\"language-python\">from langgraph.channels import LastValue, Topic\nfrom langgraph.pregel import Pregel, NodeBuilder\nfrom langgraph.types import Send, Sequence\n\nnode = (\n    NodeBuilder()\n    .subscribe_only(\"input_channel\")\n    .do(lambda args: args)\n    .write_to(\"output_channel\")\n)\napp = Pregel(\n    nodes={\"node\": node},\n    channels={\"input_channel\": LastValue(str), \"output_channel\": LastValue(str)},\n    input_channels=[\"input_channel\"],\n    output_channels=[\"output_channel\"],\n)\n\ntasks: Topic[Send] = app.channels[\"__pregel_tasks\"]\nassert isinstance(tasks, Topic)\nassert tasks.ValueType == Sequence[Send]\nassert tasks.accumulate == False\n</code></pre>\n<h2 id=\"3-è¢«ä¿æŠ¤èµ·æ¥çš„é€šé“\">3. è¢«ä¿æŠ¤èµ·æ¥çš„é€šé“</h2>\n<p>è™½ç„¶â€œ__pregel_tasksâ€å°±æ˜¯ä¸€ä¸ªæ™®é€šçš„Topicç±»å‹çš„Channelï¼Œä½†æ˜¯å®ƒå¹¶æœªå¼€å‘å¯¹å¤–éƒ¨ä½¿ç”¨ï¼ŒPregelæŠŠå®ƒâ€œä¿æŠ¤â€çš„éå¸¸å¥½ã€‚æˆ‘ä»¬ä¸èƒ½å£°æ˜ä¸€ä¸ªä¸ä¹‹åŒåçš„Channelï¼Œå¦åˆ™å°±ä¼šåƒå¦‚ä¸‹çš„æ–¹å¼ä¸€æ ·æŠ›å‡ºä¸€ä¸ªValueErrorï¼Œå¹¶æç¤ºâ€œChannel '__pregel_tasks' is reserved and cannot be used in the graph.â€ã€‚</p>\n<pre><code class=\"language-python\">from langgraph.channels import Topic\nfrom langgraph.pregel import Pregel, NodeBuilder\nfrom langgraph.types import Send, Sequence\n\ntry:\n    app = Pregel(\n        nodes={\"node\": NodeBuilder().subscribe_only(\"__pregel_tasks\")},\n        channels={\"__pregel_tasks\": Topic[Sequence[Send]]},\n        input_channels=[\"input_channel\"],\n        output_channels=[\"output_channel\"],\n    )\n    assert False, \"Expected an error due to reserved channel name\"\nexcept Exception as e:\n    assert isinstance(e, ValueError)\n    assert str(e) == \"Channel '__pregel_tasks' is reserved and cannot be used in the graph.\"\n</code></pre>\n<p>æˆ‘ä»¬ä¹Ÿä¸èƒ½é‡‡ç”¨å¸¸è§„çš„æ–¹å¼å°†å‘å…¶å‘é€Sendå¯¹è±¡ã€‚æ¯”å¦‚åœ¨å¦‚ä¸‹çš„æ¼”ç¤ºç¨‹åºä¸­ï¼ŒèŠ‚ç‚¹fooè¯•å›¾å‘æ­¤Channelå‘é€ä¸€ä¸ªé©±èŠ‚ç‚¹baræ‰§è¡Œçš„Sendå¯¹è±¡ï¼Œæœ€ç»ˆæŠ›å‡ºä¸€ä¸ªInvalidUpdateErrorå¼‚å¸¸ï¼Œå¹¶æç¤ºâ€œCannot write to the reserved channel TASKSâ€ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œç”±äºPregelåœ¨åˆ©ç”¨å®ƒå°†åŸºäºâ€œPUSHæ¨¡å¼â€çš„ä»»åŠ¡åˆ›å»ºå‡ºæ¥åå°±ä¼šå°†å…¶æ¸…ç©ºï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿæ— æ³•è¯»å–å…¶ä¸­çš„ä»»åŠ¡ã€‚</p>\n<pre><code class=\"language-python\">from langgraph.channels import LastValue\nfrom langgraph.pregel import Pregel, NodeBuilder\nfrom langgraph.types import Send\nfrom langgraph.errors import InvalidUpdateError\n\nfoo = (NodeBuilder()\n    .subscribe_to(\"start\",read= False)\n    .do(lambda _: Send(node=\"bar\", arg=\"foobar\"))\n    .write_to(\"__pregel_tasks\"))\nbar = (NodeBuilder()\n    .do(lambda args:args)\n    .write_to(\"output\"))\n\napp = Pregel(\n    nodes={ \"foo\": foo, \"bar\": bar},\n    channels={\n        \"start\": LastValue(str),\n        \"output\": LastValue(str),\n    },\n    input_channels=[\"start\"],\n    output_channels=[\"output\"])\ntry: \n    app.invoke({\"start\": None})\n    assert False, \"Should have raised InvalidUpdateError\"\nexcept Exception as e:\n    assert isinstance(e, InvalidUpdateError)\n    assert str(e) == \"Cannot write to the reserved channel TASKS\"\n</code></pre>\n<h2 id=\"4-å”¯ä¸€çš„è§£å†³æ–¹æ¡ˆ\">4. å”¯ä¸€çš„è§£å†³æ–¹æ¡ˆ</h2>\n<p>æˆ‘ä»¬èƒ½å¤Ÿæƒ³åˆ°çš„å¸¸è§„æ–¹æ³•é’ˆå¯¹æ­¤Channelçš„å†™å…¥åŸºæœ¬éƒ½ç»•ä¸å¼€å¼•æ“é’ˆå¯¹å®ƒçš„ä¿æŠ¤æœºåˆ¶ã€‚æˆ‘ä»¬å°†åœ¨ä¸‹éƒ¨åˆ†ä»‹ç»Pregelå¦ä¸€ä¸ªæ ¸å¿ƒç»„æˆéƒ¨åˆ†Nodeï¼ŒNodeä¼šåˆ©ç”¨ChannelWriterå¯¹è±¡å®ç°é’ˆå¯¹Channelçš„å†™å…¥ï¼Œæˆ‘ä»¬å¯ä»¥å°†é’ˆå¯¹Channelçš„å†™å…¥æ„å›¾å°è£…æˆChannelWriteTupleEntryï¼Œå¹¶ä»¥æ­¤æ¥åˆ›å»ºChannelWriterï¼Œè¿™åº”è¯¥æ˜¯å”¯ä¸€èƒ½å¤Ÿâ€œæ¬ºéª—â€å¼•æ“å†™å…¥éªŒè¯çš„å”¯ä¸€æ‰‹æ®µã€‚å¦‚ä»£ç ç‰‡æ®µæ‰€ç¤ºï¼Œç‡å…ˆæ‰§è¡Œçš„èŠ‚ç‚¹fooä¼šè¿”å›ä¸€ä¸ªé©±åŠ¨èŠ‚ç‚¹baræŒ‡å®šçš„Sendå¯¹è±¡ï¼Œä¸ºäº†å°†å®ƒå†™å…¥â€œ__pregel_tasksâ€ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªChannelWriterï¼Œé’ˆå¯¹è¯¥Channelçš„å†™å…¥å®šä¹‰åœ¨ChannelWriteTupleEntryå¯¹è±¡ä¸­ï¼Œå…·ä½“ä½“ç°åœ¨è°ƒç”¨æ„é€ å‡½æ•°æŒ‡å®šçš„mapperå‚æ•°ä¸Šï¼Œå®ƒæä¾›ä¸€ä¸ªæ˜ å°„å°†Nodeçš„æ‰§è¡Œç»“æœè½¬æˆæˆChannelåç§°å’Œå€¼çš„æ˜ å°„å…³ç³»ã€‚</p>\n<pre><code class=\"language-python\">from langgraph.pregel import Pregel, NodeBuilder\nfrom langgraph.channels import LastValue\nfrom langgraph.pregel._read import PregelNode\nfrom langgraph.pregel._write import ChannelWrite, ChannelWriteTupleEntry\nfrom langgraph.types import Send\n\nfoo: PregelNode = (NodeBuilder()\n    .subscribe_to(\"foo\")\n    .do(lambda _: Send(node=\"bar\", arg=\"foo\"))\n).build()\nentry = ChannelWriteTupleEntry(mapper= lambda args: [(\"__pregel_tasks\", args)])\nfoo.writers.append(ChannelWrite(writes=[entry]))\n\nbar = (NodeBuilder()\n    .do(lambda args: f\"bar is triggered by {args}.\")\n    .write_to(\"output\"))\n\napp = Pregel(\n    nodes={\"foo\": foo, \"bar\": bar},\n    channels={\n        \"foo\": LastValue(None),\n        \"output\": LastValue(str),\n    },\n    input_channels=[\"foo\"],\n    output_channels=[\"output\"],\n)\n\nresult = app.invoke(input={\"foo\": None})\nassert result == {\"output\": \"bar is triggered by foo.\"}\n</code></pre>\n\n\n</div>\n<div class=\"clear\"></div>\n\n            </div>\n            <div class=\"postDesc\">posted @ \n<span id=\"post-date\">2026-02-13 07:32</span>&nbsp;\n<a href=\"https://www.cnblogs.com/jaydenai\">JaydenAI</a>&nbsp;\né˜…è¯»(<span id=\"post_view_count\">7</span>)&nbsp;\nè¯„è®º(<span id=\"post_comment_count\">0</span>)&nbsp;\n&nbsp;\n<a href=\"\">æ”¶è—</a>&nbsp;\n<a href=\"\">ä¸¾æŠ¥</a>\n</div>"
    },
    {
      "title": "Lab4-Lab: traps && MIT6.1810æ“ä½œç³»ç»Ÿå·¥ç¨‹ã€æŒç»­æ›´æ–°ã€‘ _",
      "link": "https://www.cnblogs.com/xiaobai1523/p/19610063",
      "published": "",
      "description": "<h1 class=\"postTitle\">\n                <a class=\"postTitle2 vertical-middle\" href=\"https://www.cnblogs.com/xiaobai1523/p/19610063\" id=\"cb_post_title_url\" title=\"å‘å¸ƒäº 2026-02-12 23:12\">\n    <span>Lab4-Lab: traps &amp;&amp; MIT6.1810æ“ä½œç³»ç»Ÿå·¥ç¨‹ã€æŒç»­æ›´æ–°ã€‘ _</span>\n    \n\n</a>\n\n            </h1>\n            <div class=\"clear\"></div>\n            <div class=\"postBody\">\n                <div class=\"blogpost-body cnblogs-markdown\" id=\"cnblogs_post_body\">\n<h1 id=\"lab-traps\">Lab: traps</h1>\n<p>â€‹\tåœ¨è¿™ä¸€ä¸ªlabå½“ä¸­<a href=\"https://pdos.csail.mit.edu/6.828/2025/labs/traps.html\" rel=\"noopener nofollow\" target=\"_blank\">6.1810 / Fall 2025</a>å®ƒè¦æ±‚æˆ‘ä»¬ç†è§£xv6å½“ä¸­å‡½æ•°è°ƒç”¨æ—¶çš„å †æ ˆæƒ…å†µä»¥åŠå¦‚ä½•æ“æ§å†…å­˜å¯»æ‰¾å¤šçº§å‡½æ•°è°ƒç”¨çš„èµ·å§‹ï¼Œæ›´é‡è¦çš„æ˜¯å®ƒå¸¦æˆ‘ä»¬ç›´è§‚åœ°æ„Ÿå—åˆ°äº†<strong>ä¸­æ–­çš„å…¨è¿‡ç¨‹</strong>ã€‚</p>\n<p>â€‹\tåœ¨æ­¤ä¹‹å‰ï¼Œå®˜ç½‘ç»™å‡ºäº†ä¸€äº›æç¤ºï¼š</p>\n<ul>\n<li>åœ¨å¼€å§‹ç¼–ç¨‹ä¹‹å‰ï¼Œ\t<a href=\"https://pdos.csail.mit.edu/6.828/2025/xv6/book-riscv-rev5.pdf\" rel=\"noopener nofollow\" target=\"_blank\">è¯·é˜…è¯»xv6æ•™ç¨‹çš„ç¬¬4ç« </a>ï¼Œä»¥åŠç›¸å…³çš„æºç æ–‡ä»¶<code>kernel/trampoline.S</code>ã€‚</li>\n<li><code>kernel/trap.c</code>å½“ä¸­æ˜¯å¤„ç†æ‰€æœ‰ä¸­æ–­çš„ä»£ç ã€‚</li>\n</ul>\n<h2 id=\"risc-v-assembly-ç®€å•\">RISC-V assembly (ç®€å•)</h2>\n<p>â€‹\tåœ¨è¿™ä¸ªlabå½“ä¸­ï¼Œè¦æ±‚æˆ‘ä»¬é˜…è¯»ä¸€äº›æ±‡ç¼–ä»£ç ï¼Œå¹¶ä¸”äº†è§£cè¯­è¨€çš„æŸäº›è¯­å¥å¯¹åº”çš„æ±‡ç¼–æ˜¯æ€æ ·çš„ï¼ŒåŒæ—¶äº†è§£ä¸åŒå¯„å­˜å™¨çš„ä¸åŒèŒè´£ï¼ˆä¾‹å¦‚<strong>ra</strong>å¯„å­˜å™¨æ˜¯å­˜æ”¾è¿”å›åœ°å€çš„å¯„å­˜å™¨ï¼‰ã€‚ç„¶åå¸¦æˆ‘ä»¬äº†è§£äº†ä¸€ä¸‹ç¼–è¯‘å™¨åœ¨ç¼–è¯‘ä»£ç æ—¶ï¼Œå¦‚ä½•ä¼˜åŒ–/ç®€åŒ–æˆ‘ä»¬çš„ä»£ç ã€‚æœ€åå¸¦æˆ‘ä»¬ç›´è§‚åœ°ç†è§£äº†ä¸€ä¸‹å¤§ç«¯æ¨¡å¼å’Œå°ç«¯æ¨¡å¼çš„åŒºåˆ«ä»¥åŠä¸¤è€…åœ¨é¢å¯¹<strong>å¤šå­—èŠ‚å­˜å‚¨</strong>å’Œ<strong>å•ä¸ªæ•°å€¼</strong>å­˜å‚¨æ‰€é€ æˆçš„ä¸åŒçš„å½±å“ã€‚</p>\n<h2 id=\"å¦‚ä½•é˜…è¯»æ±‡ç¼–ä»£ç \">å¦‚ä½•é˜…è¯»æ±‡ç¼–ä»£ç </h2>\n<p>â€‹\tä»¥ä¸‹æ˜¯æˆªå–äº†<code>call.asm</code>å½“ä¸­çš„ä¸€éƒ¨åˆ†ä»£ç ï¼Œè¿™ç±»ä»£ç æ˜¯åæ±‡ç¼–å¾—æ¥çš„ç»“æœã€‚æ¥ä¸‹æ¥å°†å¼€å§‹è§£æè¿™æ®µç¨‹åºã€‚</p>\n<pre><code class=\"language-assembly\">##è¿™æ˜¯cè¯­è¨€å‡½æ•°fçš„åæ±‡ç¼–ä»£ç ï¼ˆé€šè¿‡æˆªå–ç¼–è¯‘å™¨è¾“å‡ºå¾—åˆ°ï¼Œä¸æ˜¯æ‰‹å†™çš„æ±‡ç¼–ä»£ç ï¼Œæ‰‹å†™çš„æ±‡ç¼–åªæœ‰åŠ©è®°ç¬¦ï¼Œæ²¡æœ‰åœ°å€ç å’Œæœºå™¨ç ï¼‰ã€‚\nint f(int x) {\n  ##å¯¹äºè¿™ä¸€è¡Œï¼Œeæ˜¯åå…­è¿›åˆ¶çš„å†…å­˜åœ°å€/åç§»ï¼Œ1141æ˜¯åå…­è¿›åˆ¶æœºå™¨ç ã€‚\n  ##å†å¾€åçš„addi  sp,sp,-16æ˜¯å°†æ ˆæŒ‡é’ˆspå‡16ã€‚ï¼ˆä¸€èˆ¬åªæœ‰å‹æ ˆçš„æƒ…å†µä¸‹æ‰ä¼šä¿®æ”¹æ ˆæŒ‡é’ˆï¼‰\n   e:\t1141                \taddi\tsp,sp,-16\n  ##å¯¹äºè¿™ä¸€è¡Œï¼Œ10æ˜¯åå…­è¿›åˆ¶çš„å†…å­˜åœ°å€/åç§»ï¼Œe422æ˜¯åå…­è¿›åˆ¶æœºå™¨ç ã€‚\n  ##å†å¾€åçš„sd\ts0,8(sp)æ˜¯å°†å¯„å­˜å™¨s0çš„å†…å®¹ä¿å­˜åˆ°æ ˆçš„8åç§»å¤„ï¼ˆsp+8ï¼‰ã€‚\n  10:\te422                \tsd\ts0,8(sp)\n  ##å¯¹äºè¿™ä¸€è¡Œï¼Œ12æ˜¯åå…­è¿›åˆ¶çš„å†…å­˜åœ°å€/åç§»ï¼Œ0800æ˜¯åå…­è¿›åˆ¶æœºå™¨ç ã€‚\n  ##å†å¾€åçš„addi  sp,sp,16æ˜¯å°†æ ˆæŒ‡é’ˆspåŠ 16ã€‚ï¼ˆä¸€èˆ¬åªæœ‰å‡ºæ ˆçš„æƒ…å†µä¸‹æ‰ä¼šä¿®æ”¹æ ˆæŒ‡é’ˆï¼‰\n  12:\t0800                \taddi\ts0,sp,16\n  ##è°ƒç”¨å‡½æ•°g\n  return g(x);\n}\n</code></pre>\n<h2 id=\"é—®é¢˜è§£ç­”\">é—®é¢˜è§£ç­”ï¼š</h2>\n<p>ä¸€ã€Which registers contain arguments to functions? For example, which register holds 13 in main's call to <code>printf</code>?ï¼ˆå“ªäº›å¯„å­˜å™¨åŒ…å«å‡½æ•°çš„å‚æ•°ï¼Ÿä¾‹å¦‚ï¼Œåœ¨mainè°ƒç”¨printfæ—¶ï¼Œå“ªä¸ªå¯„å­˜å™¨å­˜æ”¾ç€13ï¼Ÿï¼‰</p>\n<p><strong>ç­”ï¼š</strong>ä»mainå‡½æ•°å¼€å§‹ï¼Œæœ‰å¦‚ä¸‹å¯„å­˜å™¨ï¼š</p>\n<ol>\n<li><strong>sp</strong>æ ˆæŒ‡é’ˆå¯„å­˜å™¨ï¼Œç”¨äºå­˜å‚¨å½“å‰æ ˆé¡¶åœ°å€ã€‚ï¼ˆå…¥æ ˆå…ˆå‡åœ°å€å†å…¥ï¼Œå‡ºæ ˆå…ˆå‡ºå†å¢ï¼‰ã€‚</li>\n<li><strong>ra</strong>è¿”å›åœ°å€å¯„å­˜å™¨ï¼Œä¸“é—¨ç”¨äºä¿å­˜å‡½æ•°è°ƒç”¨è¿”å›åœ°å€çš„å¯„å­˜å™¨ã€‚</li>\n<li><strong>s0</strong>ä¿å­˜å¯„å­˜å™¨ï¼Œç”¨äºä¿å­˜å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­éœ€è¦æŒç»­ä½¿ç”¨çš„ä¸­é—´å€¼ã€å¸§æŒ‡é’ˆç­‰ã€‚</li>\n<li><strong>a0~a7</strong>æ˜¯å‡½æ•°çš„å‚æ•°å¯„å­˜å™¨ï¼Œä¼ é€’å‡½æ•°å‚æ•°æ—¶ä¼šç”¨åˆ°ã€‚</li>\n</ol>\n<p>â€‹\tåœ¨mainè°ƒç”¨printfæ—¶ï¼Œå¯„å­˜å™¨<strong>a2</strong>å­˜æ”¾ç€13ã€‚</p>\n<p>äºŒã€Where is the call to function <code>f</code> in the assembly code for main? Where is the call to <code>g</code>? (Hint: the compiler may inline functions.)ï¼ˆåœ¨mainå‡½æ•°çš„æ±‡ç¼–ä»£ç ä¸­ï¼Œå¯¹å‡½æ•°fçš„è°ƒç”¨åœ¨å“ªé‡Œï¼Ÿå¯¹gçš„è°ƒç”¨åˆåœ¨å“ªé‡Œï¼Ÿï¼ˆæç¤ºï¼šç¼–è¯‘å™¨å¯èƒ½ä¼šå†…è”å‡½æ•°ã€‚ï¼‰ï¼‰</p>\n<p><strong>ç­”</strong>ï¼šåœ¨mainå‡½æ•°å½“ä¸­ï¼Œå¯¹<strong>f</strong>çš„è°ƒç”¨è¢«ç®€åŒ–ä¸ºäº†ä¸€æ¡æŒ‡ä»¤ï¼š<code>li\ta1,12</code>ï¼Œå› ä¸ºç¼–è¯‘å™¨åœ¨ç¼–è¯‘ä»£ç æ—¶ï¼Œå¯¹äºéå¸¸ç®€å•çš„å‡½æ•°æ•°ä¼šè¿›è¡Œ<strong>å†…è”ä¼˜åŒ–</strong>ï¼ˆç®—å‡ºå…¶ç»“æœï¼Œç„¶åç›´æ¥å†™å…¥å¯¹äºå¯„å­˜å™¨ä¸­ï¼Œæ— éœ€ç”Ÿæˆ<strong><code>jal</code>/<code>jalr</code>è°ƒç”¨æŒ‡ä»¤</strong>ï¼‰ã€‚å¯¹äº<strong>g</strong>çš„è°ƒç”¨ä¼šåœ¨<strong>f</strong>å½“ä¸­ï¼Œä½†æ˜¯ç”±äºå‡½æ•°<strong>g</strong>è¿‡äºç®€å•ï¼Œæ‰€ä»¥å¯¹å‡½æ•°<strong>f</strong>è¿›è¡Œäº†<strong>æŒ‡ä»¤èåˆ</strong>ï¼Œå³å°†å‡½æ•°<strong>g</strong>å½“ä¸­çš„æŒ‡ä»¤é€»è¾‘èåˆåˆ°<strong>f</strong>å½“ä¸­ã€‚åœ¨æœ¬ä¾‹å­å½“ä¸­ï¼Œ<strong>g</strong>ä¼šåšåŠ 3æ“ä½œç„¶åè¿”å›ï¼Œç„¶åæˆ‘ä»¬å¯ä»¥åœ¨<strong>f</strong>å½“ä¸­ç›´æ¥è¿›è¡ŒåŠ ä¸‰æ“ä½œï¼Œæ— éœ€è°ƒç”¨<strong>g</strong>ã€‚</p>\n<p>ä¸‰ã€At what address is the function printf located?ï¼ˆå‡½æ•°printfä½äºå“ªä¸ªåœ°å€ï¼Ÿï¼‰</p>\n<p><strong>ç­”ï¼š</strong>åœ¨<code>call.asm</code>å½“ä¸­ï¼Œæœ‰ä»¥ä¸‹ä¸€è¡Œä»£ç ï¼š</p>\n<pre><code class=\"language-assembly\">30:\t6c4000ef          \tjal\tra,6f4 &lt;printf&gt;\n</code></pre>\n<p>â€‹\tå…¶ä¸­<code>jal</code>æ˜¯è·³è½¬æŒ‡ä»¤ï¼ŒæŒ‡ä»¤æ ¼å¼ä¸ºï¼š<code>jal ra ç›®æ ‡åœ°å€</code>,å†ç»“åˆåé¢çš„<code>&lt;printf&gt;</code>æˆ‘ä»¬å¯ä»¥å¾—çŸ¥<strong><code>0x6f4</code></strong>æ˜¯printfçš„åœ°å€ï¼Œå¯¹åº”printfçš„å…¥å£ã€‚</p>\n<p>å››ã€What value is in the register <code>ra</code> just after the <code>jalr</code> to <code>printf</code> in <code>main</code>?ï¼ˆåœ¨mainå‡½æ•°ä¸­æ‰§è¡Œjalråˆ°printfä¹‹åï¼Œå¯„å­˜å™¨raä¸­çš„å€¼æ˜¯ä»€ä¹ˆï¼Ÿï¼‰</p>\n<p><strong>ç­”ï¼š</strong>å› ä¸º<strong>ra</strong>æ˜¯è¿”å›åœ°å€å¯„å­˜å™¨ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒé‡Œé¢ä¿å­˜çš„æ˜¯æ‰§è¡Œå®Œå‡½æ•°è°ƒç”¨ååº”è¯¥è¿”å›çš„åœ°å€ï¼Œæ‰€ä»¥æ­¤æ—¶åœ¨æ‰§è¡Œåˆ°printfåï¼Œ<strong>ra</strong>å†…çš„å€¼åº”è¯¥æ˜¯æŒ‡ä»¤<code>jal\tra,6f4 &lt;printf&gt;</code>çš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯<strong><code>0x34</code></strong>ã€‚</p>\n<p>äº”ã€Run the following code.ï¼ˆè¿è¡Œæ¥ä¸‹æ¥çš„ä»£ç ï¼‰</p>\n<pre><code class=\"language-c\">\tunsigned int i = 0x00646c72;\n\tprintf(\"H%x Wo%s\", 57616, (char *) &amp;i);\n</code></pre>\n<p>What is the output? <a href=\"https://www.asciitable.com/\" rel=\"noopener nofollow\" target=\"_blank\">Here's an ASCII table</a> that maps bytes to characters.ï¼ˆè¾“å‡ºæ˜¯ä»€ä¹ˆï¼Ÿè¿™æ˜¯ä¸€ä¸ªå°†å­—èŠ‚æ˜ å°„åˆ°å­—ç¬¦çš„ASCIIè¡¨ã€‚ï¼‰</p>\n<p>The output depends on that fact that the RISC-V is little-endian. If the RISC-V were instead big-endian what would you set <code>i</code> to in order to yield the same output? Would you need to change <code>57616</code> to a different value?ï¼ˆè¾“å‡ºå–å†³äº RISC-V æ˜¯å°ç«¯å­—èŠ‚åºè¿™ä¸€äº‹å®ã€‚å¦‚æœ RISC-V æ˜¯å¤§ç«¯å­—èŠ‚åºï¼Œé‚£ä¹ˆä¸ºäº†å¾—åˆ°ç›¸åŒçš„è¾“å‡ºï¼Œä½ ä¼šå°† i è®¾ä¸ºå¤šå°‘ï¼Ÿä½ éœ€è¦å°† 57616 æ”¹æˆå…¶ä»–å€¼å—ï¼Ÿï¼‰</p>\n<p><strong>ç­”ï¼š</strong>è¾“å‡ºå†…å®¹å¦‚ä¸‹ï¼ˆxv6é»˜è®¤å°ç«¯æ¨¡å¼ï¼‰ï¼š</p>\n<pre><code class=\"language-powershell\">He110,World\n</code></pre>\n<ul>\n<li>å°ç«¯æ¨¡å¼ï¼šä½åœ°å€å­˜æ”¾ä½ä½ï¼Œé«˜åœ°å€å­˜æ”¾é«˜ä½ã€‚</li>\n<li>å¤§ç«¯æ¨¡å¼ï¼šä½åœ°å€å­˜æ”¾é«˜ä½ï¼Œé«˜åœ°å€å­˜æ”¾ä½ä½ã€‚</li>\n</ul>\n<p>â€‹\tä¾ç…§å¤§ç«¯æ¨¡å¼ï¼Œæˆ‘ä»¬éœ€è¦å°†<strong>i</strong>è¿›è¡Œä¿®æ”¹ï¼Œå¤§å°ç«¯æ¨¡å¼åªå½±å“å¤šå­—èŠ‚çš„å­˜å‚¨ï¼Œè€Œ<strong>57616</strong>åªæ˜¯å•ä¸ªæ•°å€¼ï¼Œä¸æ¶‰åŠå¤šå­—èŠ‚å­˜å‚¨ã€‚ä¸ºç¬¦åˆå¤§ç«¯è¦æ±‚ï¼Œæˆ‘ä»¬éœ€è¦å°†<strong>i</strong>ä¿®æ”¹ä¸ºï¼š<strong><code>0x726c6400</code></strong>å³å¯ã€‚</p>\n<p>å…­ã€In the following code, what is going to be printed after <code>'y='</code>? (note: the answer is not a specific value.) Why does this happen?ï¼ˆåœ¨ä¸‹é¢çš„ä»£ç ä¸­ï¼Œ'y='åé¢å°†ä¼šæ‰“å°å‡ºä»€ä¹ˆï¼Ÿï¼ˆæ³¨æ„ï¼šç­”æ¡ˆä¸æ˜¯ä¸€ä¸ªå…·ä½“çš„å€¼ã€‚ï¼‰ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ç§æƒ…å†µï¼Ÿï¼‰</p>\n<pre><code class=\"language-c\">\tprintf(\"x=%d y=%d\", 3);\n</code></pre>\n<p><strong>ç­”ï¼š</strong>å› ä¸ºå˜é‡<strong>y</strong>æ²¡æœ‰å¯¹åº”çš„èµ‹å€¼ï¼Œæ‰€ä»¥ä¼šè¾“å‡ºä¸€ä¸ª<strong>æœªåˆå§‹åŒ–çš„éšæœºçš„å€¼</strong>ï¼ˆç±»ä¼¼ï¼š0,1385ï¼Œ-2294ï¼‰ã€‚åœ¨æ±‡ç¼–æ—¶ï¼Œprintfå‡½æ•°ä¼šç”¨åˆ°ä¸¤ä¸ªå¯„å­˜å™¨ï¼Œå…¶ä¸­ a1è´Ÿè´£å­˜æ”¾3ï¼Œa2æ²¡æœ‰æŒ‡å®šè¦å­˜æ”¾è°ï¼Œæ‰€ä»¥é‡Œé¢çš„å€¼æ˜¯æœªçŸ¥çš„ã€‚</p>\n<h2 id=\"backtraceä¸­ç­‰\">Backtraceï¼ˆä¸­ç­‰ï¼‰</h2>\n<p>â€‹\tå½“ä¸€ä¸ªå‡½æ•°è°ƒç”¨å¦ä¸€ä¸ªå‡½æ•°æ—¶ï¼ŒCPU ä¼šå°†è°ƒç”¨ç‚¹çš„è¿”å›åœ°å€ä¿å­˜åˆ°æ ˆä¸Šï¼Œè¿™æ ·è¢«è°ƒç”¨å‡½æ•°æ‰§è¡Œå®Œåæ‰èƒ½å›åˆ°åŸæ¥çš„ä½ç½®ç»§ç»­æ‰§è¡Œã€‚æ¯æ¬¡è°ƒç”¨éƒ½ä¼šåˆ›å»ºæ–°çš„æ ˆå¸§ï¼Œå¹¶åœ¨æ ˆå¸§ä¸­ä¿å­˜è¿”å›åœ°å€å’Œä¸Šä¸€å±‚çš„æ ˆå¸§æŒ‡é’ˆã€‚å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬çŸ¥é“å½“å‰å‡½æ•°çš„æ ˆå¸§ä½ç½®ï¼Œå°±å¯ä»¥é¡ºç€æ ˆå¸§é“¾â€œå›æº¯â€ï¼Œæ‰¾åˆ°ä¸Šä¸€å±‚å‡½æ•°çš„è¿”å›åœ°å€ï¼Œå†ç»§ç»­å‘ä¸Šï¼Œç›´åˆ°éå†å®Œæ•´ä¸ªè°ƒç”¨é“¾ã€‚æˆ‘ä»¬æŠŠè¿™ä¸ªè¿‡ç¨‹å½¢è±¡åœ°ç§°ä¸ºâ€œé¡ºè…¾æ‘¸ç“œâ€ï¼Œæ„æ€æ˜¯æ²¿ç€æ ˆå¸§é“¾ï¼Œä¸€å±‚å±‚æ‰¾åˆ°è°ƒç”¨å…³ç³»ã€‚</p>\n<p>â€‹\tæœ¬ Lab è¦æ±‚å®ç°ä¸€ä¸ª <code>backtrace()</code> å‡½æ•°ï¼Œå®ƒä»å½“å‰æ ˆå¸§å‡ºå‘ï¼Œæ²¿ç€æ ˆå¸§é“¾æ‰“å°æ¯ä¸€å±‚å‡½æ•°çš„è¿”å›åœ°å€ã€‚è¾“å‡ºé¡ºåºåº”ä¸è°ƒç”¨é“¾ä¸€è‡´ï¼ˆä»å½“å‰å‡½æ•°å‘ä¸Šç›´åˆ°æœ€åˆè°ƒç”¨çš„å†…æ ¸å…¥å£ï¼‰ã€‚</p>\n<p>â€‹\t<strong>æ ˆå¸§ï¼š</strong>æŒ‡<strong>å‡½æ•°æ ˆå¸§</strong>ï¼Œæ˜¯å‡½æ•°åœ¨è¿è¡Œæ—¶åœ¨æ ˆä¸Šåˆ†é…çš„ä¸€æ®µå†…å­˜ï¼Œç”¨æ¥ä¿å­˜å‡½æ•°è°ƒç”¨éœ€è¦çš„ä¿¡æ¯ï¼ˆä¾‹å¦‚ï¼šè¿”å›åœ°å€ï¼Œä¸Šä¸€å±‚å‡½æ•°çš„æ ˆå¸§æŒ‡é’ˆï¼Œå±€éƒ¨å˜é‡ï¼Œä¿å­˜çš„å¯„å­˜å™¨ï¼‰ã€‚</p>\n<h3 id=\"å®˜ç½‘æç¤ºå’Œä¸ªäººè§£æ\">å®˜ç½‘æç¤ºå’Œä¸ªäººè§£æ</h3>\n<p>â€‹\t1ã€åœ¨<code>kernel/defs.h</code>åœ¨å£°æ˜ <code>backtrace()</code> å‡½æ•°åŸå‹ï¼Œè¿™æ ·å…¶ä»–æ–‡ä»¶å¯ä»¥è°ƒç”¨ï¼Œå¹¶ä¸”åœ¨<code>kernel/printf.c</code>å½“ä¸­å®ç°è¯¥å‡½æ•°ã€‚</p>\n<p>â€‹\t2ã€ç”±äºæˆ‘ä»¬éœ€è¦è·å–å½“å‰çš„æ ˆå¸§åœ°å€ï¼Œæ‰€ä»¥å®˜ç½‘ç»™æˆ‘ä»¬æä¾›äº†ä¸€ä¸ª<code>r_fp</code>å‡½æ•°ï¼Œç”¨äºè¿”å›å½“å‰çš„æ ˆå¸§åœ°å€ã€‚æˆ‘ä»¬éœ€è¦å°†è¿™ä¸ªå‡½æ•°å¤åˆ¶åˆ°<code>kernel/riscv.h</code>å½“ä¸­çš„<strong><code>#ifndef __ASSEMBLER__ ... #endif</code></strong> å®šä¹‰å½“ä¸­ã€‚</p>\n<p>â€‹\t3ã€åœ¨å®ç°è¯¥åŠŸèƒ½æ—¶ï¼Œæˆ‘ä»¬éœ€è¦è·å–å½“å‰æ ˆå¸§çš„åœ°å€ï¼Œå¥½åœ¨å®˜ç½‘æä¾›äº†<code>r_fp</code>å‡½æ•°ï¼Œå®ƒè¿”å›ä¸€ä¸ª<strong>uint64</strong>ç±»å‹çš„æ•°æ®ï¼ˆè¿™æ˜¯æ ˆå¸§æŒ‡é’ˆï¼ŒæŒ‡å‘çš„ä½ç½®å­˜æ”¾ç€çœŸæ­£çš„æ ˆå¸§åœ°å€ï¼‰ï¼Œå¯¹å…¶è§£å¼•ç”¨ä¼šå¾—åˆ°å½“å‰çš„æ ˆå¸§åœ°å€ã€‚</p>\n<p>â€‹\t4ã€æ¥ä¸‹æ¥æˆ‘ä»¬å¼€å§‹â€œå‘ä¸Šâ€å¯»æ‰¾è°ƒç”¨é“¾ä¸Šçš„å‡½æ•°ï¼Œæ ¹æ®å®˜ç½‘çš„æç¤ºï¼Œåœ¨<strong>â€œæ ˆå¸§åœ°å€ - 8â€</strong>çš„ä½ç½®ä¸Šå­˜æ”¾çš„æ˜¯ä¸Šä¸€å±‚å‡½æ•°çš„è¿”å›åœ°å€ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬è¦æ‰“å°çš„åœ°å€ã€‚åœ¨<strong>â€œæ ˆå¸§åœ°å€ - 16â€</strong>çš„ä½ç½®ä¸Šå­˜æ”¾çš„æ˜¯ä¸Šä¸€å±‚å‡½æ•°æ ˆå¸§çš„åœ°å€ï¼Œåœ¨æ‰“å°å®Œæ¯•åæˆ‘ä»¬åˆ‡æ¢åˆ°ä¸Šä¸€å±‚å‡½æ•°çš„æ ˆå¸§ï¼Œç„¶åç»§ç»­æ‰“å°è¿”å›åœ°å€ï¼Œç„¶åå†æ¬¡å‘ä¸Šå¯»æ‰¾æ ˆå¸§ï¼Œç›´è‡³åˆ°è¾¾é¡¶ç«¯ã€‚</p>\n<p>â€‹\tä»¥ä¸‹æ˜¯xv6å†…æ ¸çš„ç›¸å…³çº¦å®šï¼ˆå‡ ä¹æ¯ä¸ªå‡½æ•°è°ƒç”¨çš„æ—¶å€™éƒ½ä¼šä¼´éšä»¥ä¸‹æ±‡ç¼–ä»£ç ï¼‰ï¼š</p>\n<pre><code class=\"language-assembly\">addi sp, sp, -X    # åˆ†é…æ ˆå¸§\nsd ra, 8(sp)       # ä¿å­˜è¿”å›åœ°å€\nsd s0, 0(sp)       # ä¿å­˜æ—§çš„ frame pointerï¼ˆæ ˆå¸§æŒ‡é’ˆï¼ŒæŒ‡å‘å­˜æ”¾æ ˆå¸§çš„å†…å­˜ï¼‰\nmv s0, sp          # æ›´æ–° frame pointerï¼ˆæ ˆå¸§æŒ‡é’ˆï¼‰\n</code></pre>\n<p>â€‹\tæ›´ç›´è§‚ç‚¹ï¼š</p>\n<pre><code class=\"language-nginx\">s0 â†’ æŒ‡å‘è‡ªå·±æ ˆå¸§çš„ s0 å­˜æ”¾ä½ç½® + 8\ns0-8 â†’ ra\ns0-16 â†’ ä¸Šä¸€çº§ s0\n</code></pre>\n<p>â€‹\t5ã€åœ¨å‘ä¸Šå¯»æ‰¾æ—¶ä¹Ÿè¦æ³¨æ„è¶Šç•Œçš„é—®é¢˜ï¼Œåœ¨xv6å½“ä¸­ï¼Œæ•´ä¸ªæ ˆéƒ½åœ¨åŒä¸€ä¸ªé¡µé¢å½“ä¸­ï¼Œå› æ­¤æ‰€æœ‰çš„æ ˆå¸§éƒ½æ˜¯åœ¨ä¸€ä¸ªé¡µé¢ä¸­ï¼ˆè¿™ä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆé€’å½’çš„å±‚çº§å¤šäº†ä¼šçˆ†æ ˆçš„åŸå› ï¼Œå› ä¸ºè°ƒç”¨æ–°çš„å‡½æ•°ä¼šåˆ›å»ºæ–°çš„æ ˆå¸§ï¼Œå ç”¨åŒä¸€ä¸ªæ ˆçš„å†…å­˜ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¿è¯æˆ‘ä»¬åœ¨è·å–åˆ°æ–°çš„æ ˆå¸§çš„åŒæ—¶ï¼Œè¦ä¿è¯ä¸åˆšæ‰æ‰å¤„ç†è¿‡çš„æ ˆå¸§å¤„äºåŒä¸€é¡µé¢ï¼Œå®˜ç½‘å½“ä¸­ç»™å‡ºäº†<code>PGROUNDDOWN(fp)</code>å®æ¥å¸®åŠ©æˆ‘ä»¬åˆ¤æ–­å½“å‰fpçš„é¡µé¢ã€‚åŒæ—¶ä¹Ÿæœ‰ä¸€ä¸ªå¿½ç•¥çš„ç‚¹å°±æ˜¯è¦ä¿è¯åœ°å€æ˜¯é€’å‡çš„ï¼Œè¿™æ ·æ€»ä¼šé€’å‡åˆ°å½“å‰é¡µçš„è¾¹ç•Œï¼Œä½¿å¾—å¾ªç¯ç»ˆæ­¢ï¼Œå¦‚æœå¿½ç•¥è¯¥æ¡ä»¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´åœ°å€åŠ åŠ å‡å‡è·³ä¸å‡ºæœ¬é¡µï¼Œè¿›è€Œæ— é™å¾ªç¯ã€‚</p>\n<p>â€‹\t6ã€é€šè¿‡å½“å‰æ ˆå¸§è·å–ä¸Šä¸€å±‚å‡½æ•°çš„è¿”å›åœ°å€ï¼Œå¹¶ä¸”æ‰“å°ã€‚</p>\n<p>â€‹\t7ã€é€šè¿‡å½“å‰æ ˆå¸§è·å–ä¸Šä¸€å±‚å‡½æ•°çš„æ ˆå¸§ï¼Œç„¶åç»§ç»­å¯»æ‰¾ã€‚</p>\n<h3 id=\"ç›¸å…³ä»£ç \">ç›¸å…³ä»£ç </h3>\n<p>â€‹\tåœ¨<code>kernel/printf.c</code>å½“ä¸­ã€‚</p>\n<pre><code class=\"language-c\">void backtrace(){\n  // å½“å‰çš„æ ˆå¸§\n  uint64 s0 = r_fp();\n  // ä¸´æ—¶å˜é‡ï¼Œæœ€æ–°çš„å‡½æ•°æ ˆå¸§\n  uint64 temp = s0;\n  // ä¸´æ—¶å˜é‡ï¼Œç”¨äºæ¥ä¸‹æ¥çš„æ¯”è¾ƒ\n  uint64 log = s0;\n  printf(\"backtrace:\\n\");\n  // ç¡®ä¿æ‰¾åˆ°çš„æ ˆå¸§å’Œæœ€æ–°çš„æ ˆå¸§æ˜¯åŒä¸€é¡µï¼Œå¹¶ä¸”æ ˆå¸§åªèƒ½å•è°ƒé€’å‡ï¼Œä¸èƒ½å‡ºç°ç¯è·¯ï¼Œé˜²æ­¢æ­»å¾ªç¯ã€‚\n  while((PGROUNDDOWN(s0) == PGROUNDDOWN(temp)) &amp;&amp; (s0 &gt;= log )){\n    // æ ˆå¸§-8æ˜¯è¿”å›åœ°å€ï¼Œå–å‡ºè¿”å›åœ°å€å½“ä¸­çš„å€¼ï¼Œä»¥åœ°å€å½¢å¼æ‰“å°\n    uint64 ra = *(uint64 *)(s0 - 8);\n    printf(\"%p\\n\", (void *)ra);\n    // ä¸´æ—¶å˜é‡ä¿å­˜å½“å‰æ ˆå¸§ï¼Œåœ¨ä¿è¯æ ˆå¸§å•è°ƒé€’å‡çš„åˆ¤æ–­ä¸­ä½¿ç”¨\n    log = s0;\n    // æ ˆå¸§-16æ˜¯ä¸Šä¸€å±‚å‡½æ•°çš„æ ˆå¸§\n    s0 = *(uint64*)(s0 - 16);\n  }\n}\n</code></pre>\n<p>â€‹\t<strong>ä¹‹åæ ¹æ®å®˜ç½‘çš„æç¤ºè¿›è¡Œå®éªŒç»“æœçš„éªŒè¯å³å¯ã€‚</strong></p>\n<h2 id=\"alarmå›°éš¾\">Alarmï¼ˆå›°éš¾ï¼‰</h2>\n<p>â€‹\tåœ¨è¿™ä¸€labå½“ä¸­ï¼Œè¦æ±‚æˆ‘ä»¬<strong>å®ç°ç”¨æˆ·æ€çš„å®šæ—¶â€œä¸­æ–­â€åŠŸèƒ½</strong>ã€‚ç”¨æˆ·è¿›ç¨‹å¯ä»¥å‘æ“ä½œç³»ç»Ÿæ³¨å†Œä¸€ä¸ªå‡½æ•°ï¼ˆhandlerï¼‰ï¼Œå¹¶ä¸”è¦æ±‚CPUåœ¨æ¯éš”nä¸ªtickåæ‰§è¡Œè¯¥å‡½æ•°ä¸€æ¬¡ï¼Œåœ¨handleråœ¨è¢«æ‰§è¡Œæ—¶ï¼Œç”¨æˆ·ç¨‹åºéœ€è¦â€œè¢«æš‚åœâ€ï¼Œç›´åˆ°handleræ‰§è¡Œå®Œæ¯•åå†è¿”å›ç”¨æˆ·ç¨‹åºï¼Œè¿™ä¸ªè¿‡ç¨‹ç±»ä¼¼äºç¡¬ç¡¬ä»¶ä¸­æ–­æœºåˆ¶ï¼Œåªä¸è¿‡é‡‡ç”¨äº†è½¯ä»¶çš„æ–¹æ³•å®ç°ã€‚</p>\n<h3 id=\"å®˜ç½‘æç¤ºå’Œä¸ªäººè§£æ-1\">å®˜ç½‘æç¤ºå’Œä¸ªäººè§£æï¼š</h3>\n<p>â€‹\t1ã€é¦–å…ˆè¦æ±‚æˆ‘ä»¬æ–°æ·»åŠ ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œåˆ†åˆ«æ˜¯ï¼š<strong><code>sigalarm(interval, handler)</code>å’Œ<code>sigreturn(void)</code></strong>ï¼Œå…·ä½“çš„æ·»åŠ æ–¹å¼è¯¦è§ï¼š<a href=\"https://www.cnblogs.com/xiaobai1523/p/19530432\" target=\"_blank\">Lab2-system calls &amp;&amp; MIT6.1810æ“ä½œç³»ç»Ÿå·¥ç¨‹ã€æŒç»­æ›´æ–°ã€‘ - å°ç™½åŒå­¦_C - åšå®¢å›­</a>ã€‚ä¸æ­¤åŒæ—¶ï¼Œ<code>sigalarm(interval, handler)</code>å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°intervalä»£è¡¨æ¯éš”å¤šå°‘å’Œtickæ‰§è¡Œhandlerï¼Œç¬¬äºŒä¸ªå‚æ•°handlerå°±ä»£è¡¨CPUæ¯ä¸ªnä¸ªtickè¦æ‰§è¡Œå‡½æ•°çš„åœ°å€äº†ã€‚è¿™å°±éœ€è¦æˆ‘ä»¬åœ¨è¿›ç¨‹çš„<code>proc</code>å½“ä¸­æ·»åŠ æ–°çš„æˆå‘˜ç”¨äºè®°å½•å½“å‰tickå’Œå½“å‰å·²ç»è¿‡å»äº†å¤šå°‘tickä»¥åŠæ³¨å†Œçš„å‡½æ•°æŒ‡é’ˆã€‚</p>\n<p>â€‹\t2ã€å¦‚æœåº”ç”¨ç¨‹åºè°ƒç”¨ sigalarm (0, 0)ï¼Œå†…æ ¸åº”åœæ­¢ç”Ÿæˆå‘¨æœŸæ€§çš„è­¦æŠ¥è°ƒç”¨ã€‚</p>\n<p>â€‹\t3ã€handleræ‰§è¡Œæ—¶ï¼Œéœ€è¦æˆ‘ä»¬æš‚åœç”¨æˆ·ç¨‹åºï¼Œä¹Ÿå°±æ˜¯å…ˆå°†ç”¨æˆ·ç¨‹åºçš„ä»£ç ä¿æŠ¤èµ·æ¥ï¼Œæ›¿æ¢ä¸ºhandlerçš„ä»£ç ã€‚å¾…handleræ‰§è¡Œå®Œæ¯•åå†å°†ç”¨æˆ·ç¨‹åºçš„ä»£ç æ¢å¤ï¼Œè¿™å°±è¦æ±‚æˆ‘ä»¬åœ¨è¿›ç¨‹çš„<code>proc</code>å½“ä¸­æ·»åŠ ç›¸åº”çš„trapframeå¸§ç”¨äºä¿å­˜ç”¨æˆ·ç¨‹åºçŠ¶æ€ï¼ˆå’Œä¸­æ–­çš„æ€æƒ³ä¸€æ ·ï¼Œæ‰“æ–­å½“å‰æ‰§è¡Œçš„ç¨‹åºâ†’ä¿æŠ¤æ–­ç‚¹å’Œç°åœºâ†’è·å¾—ä¸­æ–­å‘é‡â†’æ‰§è¡Œä¸­æ–­å¤„ç†ç¨‹åºâ†’æ¢å¤æ–­ç‚¹å’Œç°åœºâ†’è¢«æ‰“æ–­çš„ç¨‹åºç»§ç»­æ‰§è¡Œï¼‰ã€‚</p>\n<p>â€‹\t4ã€æŠŠ<code>user/alarmtest.c</code> æ·»åŠ åˆ° Makefile ä¸­ã€‚</p>\n<p>â€‹\t5ã€è®°å¾—æŠŠ<code>sigalarm(interval, handler)</code>å’Œ<code>sigreturn(void)</code>æ·»åŠ åˆ°<code>user/user.h</code>å½“ä¸­ã€‚ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š</p>\n<pre><code class=\"language-c\">\tint sigalarm(int ticks, void (*handler)());\n    int sigreturn(void);\n</code></pre>\n<p>â€‹\t6ã€æ¯è¿‡ä¸€ä¸ªtickï¼Œç¡¬ä»¶æ—¶é’Ÿå°±ä¼šè§¦å‘ä¸€æ¬¡ä¸­æ–­ï¼Œè¯¥ä¸­æ–­åœ¨<code> kernel/trap.c</code> çš„ <code>usertrap () </code>ä¸­å¤„ç†ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨è¿™é‡Œè¿›è¡Œä¿®æ”¹ã€‚å®˜ç½‘è¯´äº†ï¼Œåªè¦å‘ç”Ÿå®šæ—¶å™¨ä¸­æ–­æ—¶ï¼Œæˆ‘ä»¬æ‰éœ€è¦ä¿®æ”¹/å¯¹æ¯”è¿›ç¨‹çš„æ—¶é’Ÿtickæ•°ã€‚åœ¨å¦‚ä¸‹åˆ¤æ–­ä½“å†…å®ç°â€œåˆ¤æ–­handleræ˜¯å¦æ‰§è¡Œçš„ç›¸å…³é€»è¾‘â€ï¼Œå¹¶ä¸”ä¿å­˜ç”¨æˆ·ç¨‹åºçš„æ–­ç‚¹å’Œå°†ç”¨æˆ·ç¨‹åºä»£ç æ›¿æ¢ä¸ºhandlerå°±åœ¨æ­¤æ‰§è¡Œã€‚</p>\n<pre><code class=\"language-c\">\tif(which_dev == 2) ...\n</code></pre>\n<p>â€‹\t7ã€ å½“handleræ‰§è¡Œå®Œæ¯•åï¼Œä¹Ÿæ˜¯è°ƒç”¨äº†<code>sigreturn</code>å‡½æ•°æ—¶ï¼Œè¦æ±‚æˆ‘ä»¬è¿”å›å½“å‰è¿›ç¨‹çš„<strong>a0</strong>å¯„å­˜å™¨ã€‚</p>\n<h3 id=\"ç›¸å…³ä»£ç -1\">ç›¸å…³ä»£ç </h3>\n<p>â€‹\tæœ‰å…³æ·»åŠ ç³»ç»Ÿè°ƒç”¨çš„ä»£ç åœ¨è¿™é‡Œå°±å…ˆè·³è¿‡äº†ï¼Œå¯ä»¥ç¿»ç¿»åšä¸»ä¹‹å‰çš„æ–‡ç« <a href=\"https://www.cnblogs.com/xiaobai1523/p/19530432\" target=\"_blank\">Lab2-system calls &amp;&amp; MIT6.1810æ“ä½œç³»ç»Ÿå·¥ç¨‹ã€æŒç»­æ›´æ–°ã€‘ - å°ç™½åŒå­¦_C - åšå®¢å›­</a>ã€‚</p>\n<p>â€‹\tä¸€ã€kernel/proc.h</p>\n<pre><code class=\"language-c\">// åœ¨è¿›ç¨‹çš„procå½“ä¸­æ–°æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š\n  int alarmticks;              // è­¦æŠ¥ä¹‹é—´çš„æ»´ç­”å£°\n  int alarmtickscount;         // ä¸Šæ¬¡è­¦æŠ¥åçš„æ»´ç­”å£°æ¬¡æ•°\n  uint64 alarmhandler;      // é—¹é’Ÿæ»´ç­”å£°è¿‡å»æ—¶è°ƒç”¨çš„å¤„ç†ç¨‹åº\n  int inhandler;               // æ˜¯å¦æ­£åœ¨å¤„ç†alarm\n  struct trapframe alarm_tf; // ç”¨äºä¿å­˜è¢« alarm æ‰“æ–­æ—¶çš„ trapframe\n</code></pre>\n<p>â€‹\täºŒã€kernel/sysproc.c</p>\n<pre><code class=\"language-c\">uint64\nsys_sigalarm(void)\n{\n  int ticks;\n  uint64 handler;\n\n  // è¯»å–ç”¨æˆ·ä¼ å…¥å‚æ•°\n  argint(0, &amp;ticks);\n  argaddr(1, &amp;handler);\n\n  struct proc *p = myproc();\n\n  // è®¾ç½® alarmticks å’Œ alarmhandler\n  p-&gt;alarmticks = ticks;\n  p-&gt;alarmtickscount = 0;\n  // å¦‚æœ ticks å’Œ handler éƒ½ä¸º 0ï¼Œè¡¨ç¤ºå–æ¶ˆ alarmï¼Œæ‰€ä»¥å°† alarmhandler è®¾ç½®ä¸º -1ï¼Œè¡¨ç¤ºä¸è°ƒç”¨ handler\n  if(ticks == 0 &amp;&amp; handler == 0) {\n    p-&gt;alarmhandler = -1;\n  }else{\n    p-&gt;alarmhandler = handler;\n  }\n\n  return 0;\n}\n\nuint64 \nsys_sigreturn(void)\n{\n  struct proc *p = myproc();\n  // æ¢å¤è¢« alarm æ‰“æ–­æ—¶çš„ trapframeï¼Œä»¥ä¾¿åœ¨ handler å¤„ç†å®Œåç»§ç»­è¢«æ‰“æ–­çš„ç¨‹åº\n  memmove(p-&gt;trapframe, &amp;p-&gt;alarm_tf, sizeof(struct trapframe));\n  // å¤„ç†å®Œ alarm åï¼Œé‡ç½® inhandler å’Œ alarmtickscount\n  p-&gt;inhandler = 0;\n  p-&gt;alarmtickscount = 0;\n  return p-&gt;trapframe-&gt;a0; // è¿”å›ç”¨æˆ·ç¨‹åºä¸­ a0 çš„å€¼\n}\n</code></pre>\n<p>â€‹\tä¸‰ã€kernel/trap.c</p>\n<pre><code class=\"language-c\">// åœ¨usertrapå‡½æ•°çš„ if(which_dev == 2)... å½“ä¸­æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š\n// åœ¨æ—¶é’Ÿä¸­æ–­æ—¶ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦å¤„ç† alarm\n  if(which_dev == 2){\n    // è·å–å½“å‰è¿›ç¨‹çš„æŒ‡é’ˆ\n    struct proc *p = myproc();\n    // å¦‚æœå½“å‰è¿›ç¨‹è®¾ç½®äº† alarmhandlerï¼Œå¹¶ä¸”ä¸åœ¨å¤„ç† alarm çš„è¿‡ç¨‹ä¸­ï¼Œå°±æ£€æŸ¥æ˜¯å¦éœ€è¦è°ƒç”¨ alarmhandler\n    // æ³¨æ„ï¼Œalarmhandler çš„å€¼ä¸º -1 è¡¨ç¤ºæ²¡æœ‰è®¾ç½® handlerï¼ˆä¸è°ƒç”¨ï¼‰ï¼Œå€¼ä¸º 0 è¡¨ç¤ºæ­£åœ¨å¤„ç† alarmï¼Œ\n    // æ‰€ä»¥åªæœ‰å½“ alarmhandler å¤§äº 0 æ—¶æ‰è¡¨ç¤ºè®¾ç½®äº† handler å¹¶ä¸”ä¸åœ¨å¤„ç† alarm çš„è¿‡ç¨‹ä¸­\n    if(p-&gt;alarmhandler == 0 || p-&gt;alarmhandler != -1){\n      // å¢åŠ æ»´ç­”å£°è®¡æ•°ï¼Œå¹¶æ£€æŸ¥æ˜¯å¦è¾¾åˆ°äº† alarmticksï¼Œå¦‚æœè¾¾åˆ°äº†ï¼Œå¹¶ä¸” alarmticks å¤§äº 0ï¼Œå°±è°ƒç”¨ handler\n      p-&gt;alarmtickscount++;\n      // å¦‚æœè¾¾åˆ°äº†è®¾å®šçš„æ»´ç­”æ•°ï¼Œä¸”è®¾ç½®äº† alarmticksï¼ˆå¤§äº 0ï¼‰ï¼Œå°±è°ƒç”¨ handler\n      if(p-&gt;alarmtickscount &gt;= p-&gt;alarmticks &amp;&amp; p-&gt;alarmticks &gt; 0 ){\n        p-&gt;alarmtickscount = 0;\n        // è°ƒç”¨ç”¨æˆ·è®¾ç½®çš„ alarm å¤„ç†ç¨‹åº\n        if(!p-&gt;inhandler){\n          // è®¾ç½®å½“å‰æ­£åœ¨å¤„ç† alarmï¼Œé˜²æ­¢åœ¨å¤„ç† alarm çš„è¿‡ç¨‹ä¸­è¢«å†æ¬¡æ‰“æ–­è°ƒç”¨ handler\n          p-&gt;inhandler = 1;\n          // ä¿å­˜è¢«æ‰“æ–­æ—¶çš„ trapframe åˆ° alarm_tf ä¸­ï¼Œä»¥ä¾¿åœ¨ handler å¤„ç†å®Œåæ¢å¤\n          memmove(&amp;p-&gt;alarm_tf, p-&gt;trapframe, sizeof(struct trapframe));\n          // è®¾ç½® trapframe çš„ epc ä¸º handler çš„åœ°å€ï¼Œè¿™æ ·åœ¨ usertrapret() æ—¶å°±ä¼šè·³è½¬åˆ° handler å¤„æ‰§è¡Œ\n          p-&gt;trapframe-&gt;epc = (uint64)p-&gt;alarmhandler;  \n\n        }\n        \n      }\n    }\n    yield();\n  }\n</code></pre>\n<h3 id=\"éªŒæ”¶æˆæœ\">éªŒæ”¶æˆæœ</h3>\n<pre><code class=\"language-shell\">xiaobai@***:~/xv6-labs-2025$ ./grade-lab-traps alarm\nmake: 'kernel/kernel' is up to date.\n== Test running alarmtest == (4.1s)\n== Test   alarmtest: test0 ==\n  alarmtest: test0: OK\n== Test   alarmtest: test1 ==\n  alarmtest: test1: OK\n== Test   alarmtest: test2 ==\n  alarmtest: test2: OK\n== Test   alarmtest: test3 ==\n  alarmtest: test3: OK\nxiaobai@***:~/xv6-labs-2025$\n</code></pre>\n<h2 id=\"å†™åœ¨æœ€å\">å†™åœ¨æœ€å</h2>\n<p>â€‹\tè¿™ä¸€labå¯ä»¥è¯´å¾ˆç›´è§‚åœ°è®©æˆ‘ä»¬æ„Ÿå—åˆ°ä¸­æ–­çš„è¿‡ç¨‹æ˜¯æ€æ ·çš„ï¼Œç‰¹åˆ«æ˜¯æ¶‰åŠâ€œä¿æŠ¤æ–­ç‚¹/ç°åœºâ€ï¼Œâ€œè·å–ä¸­æ–­æœåŠ¡ç¨‹åºå…¥å£åœ°å€â€ï¼Œâ€œæ¢å¤æ–­ç‚¹/ç°åœºâ€ç­‰å†…å®¹ã€‚</p>\n<p>â€‹\tå¿«è¿‡å¹´äº†ï¼Œäº‰å–å¤§å¹´ä¸‰åå‰å°½å¿«èµ¶å‡ºä¸‹ä¸€ä¸ªlabã€‚</p>\n\n\n</div>\n<div class=\"clear\"></div>\n\n            </div>\n            <div class=\"postDesc\">posted @ \n<span id=\"post-date\">2026-02-12 23:12</span>&nbsp;\n<a href=\"https://www.cnblogs.com/xiaobai1523\">å°ç™½åŒå­¦_C</a>&nbsp;\né˜…è¯»(<span id=\"post_view_count\">40</span>)&nbsp;\nè¯„è®º(<span id=\"post_comment_count\">0</span>)&nbsp;\n&nbsp;\n<a href=\"\">æ”¶è—</a>&nbsp;\n<a href=\"\">ä¸¾æŠ¥</a>\n</div>"
    },
    {
      "title": "RAG æ—¶ä»£çš„â€œç ´å£äººâ€ï¼šä¸ºä»€ä¹ˆä½ çš„å¤§æ¨¡å‹åº”ç”¨æ€¥éœ€ Doclingï¼Ÿ",
      "link": "https://www.cnblogs.com/jyzhao/p/19610038/rag-shi-dai-de-po-bi-ren-wei-shen-me-ni-de-da-mo-x",
      "published": "",
      "description": "<a name=\"top\"></a>\n    <h2><a class=\"postTitle2 vertical-middle\" href=\"https://www.cnblogs.com/jyzhao/p/19610038/rag-shi-dai-de-po-bi-ren-wei-shen-me-ni-de-da-mo-x\" id=\"cb_post_title_url\" title=\"å‘å¸ƒäº 2026-02-12 22:58\">\n    <span>RAG æ—¶ä»£çš„â€œç ´å£äººâ€ï¼šä¸ºä»€ä¹ˆä½ çš„å¤§æ¨¡å‹åº”ç”¨æ€¥éœ€ Doclingï¼Ÿ</span>\n    \n\n</a>\n</h2>\n    <small>\n<span id=\"post-date\">2026-02-12 22:58</span>&nbsp;\n<a href=\"https://www.cnblogs.com/jyzhao\">AlfredZhao</a>&nbsp;\né˜…è¯»(<span id=\"post_view_count\">64</span>)&nbsp;\nè¯„è®º(<span id=\"post_comment_count\">0</span>)&nbsp;\n&nbsp;\n<a href=\"\">æ”¶è—</a>&nbsp;\n<a href=\"\">ä¸¾æŠ¥</a>\n</small>\n    <div class=\"entry\">\n        <div class=\"blogpost-body cnblogs-markdown\" id=\"cnblogs_post_body\">\n<p>åœ¨ RAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰çš„å¼€å‘åœˆå­é‡Œï¼Œæœ‰ä¸€å¥æµä¼ ç”šå¹¿çš„â€œé»‘è¯â€ï¼š<strong>â€œåƒåœ¾è¿›ï¼Œåƒåœ¾å‡ºï¼ˆGarbage In, Garbage Outï¼‰ã€‚â€</strong> æ— è®ºä½ çš„å‘é‡æ•°æ®åº“æœ‰å¤šå¿«ï¼Œå¤§æ¨¡å‹ï¼ˆLLMï¼‰çš„æ¨ç†èƒ½åŠ›æœ‰å¤šå¼ºï¼Œå¦‚æœæœ€å¼€å§‹å–‚ç»™å®ƒçš„æ–‡æ¡£æ•°æ®æ˜¯ä¸€å›¢ä¹±éº»ï¼Œé‚£æœ€ç»ˆçš„å›ç­”æ•ˆæœä¸€å®šä¸å°½å¦‚äººæ„ã€‚æ­£æ˜¯åœ¨è¿™ç§èƒŒæ™¯ä¸‹ï¼ŒIBM å¼€æºçš„ <strong>Docling</strong> åƒä¸€åŒ¹é»‘é©¬ï¼Œè¿…é€Ÿæˆä¸ºäº† RAG é¢†åŸŸçš„â€œæ–°å® â€ã€‚</p>\n<p>ä»Šå¤©ï¼Œç¬”è€…å°±å¸¦å¤§å®¶æ‹†è§£ä¸€ä¸‹ï¼šä¸ºä»€ä¹ˆåœ¨ RAG æµç¨‹ä¸­ï¼ŒDocling æ˜¯ä¸å¯æˆ–ç¼ºçš„åº•å±‚æ”¯æŸ±ã€‚</p>\n<hr />\n<h2 id=\"section\">01 | ç—›ç‚¹ï¼šè¢«å¿½è§†çš„æ–‡æ¡£è§£æâ€œæœ€åä¸€å…¬é‡Œâ€</h2>\n<p>åšè¿‡ RAG çš„åŒå­¦éƒ½çŸ¥é“ï¼Œç¬¬ä¸€æ­¥é€šå¸¸æ˜¯è§£æ PDFã€‚ä½†ä¼ ç»Ÿçš„è§£ææ–¹å¼å¾€å¾€ä¼šè®©å¼€å‘è€…å¤´ç§ƒï¼š</p>\n<ul>\n<li><strong>PDF æ ¼å¼çš„â€œéç»“æ„åŒ–â€æœ¬è´¨</strong>ï¼šPDF æœ¬è´¨ä¸Šæ˜¯ç»™æ‰“å°æœºçœ‹çš„ã€‚æ™®é€šè§£æå·¥å…·ï¼ˆå¦‚ PyPDF ç­‰ï¼‰å¾€å¾€ä¼šæŒ‰ç‰©ç†åæ ‡æŠ“å–æ–‡æœ¬ï¼Œå¯¼è‡´åˆ†æ æ··æ·†ã€é¡µçœ‰é¡µè„šæ¨ªæ’åœ¨æ­£æ–‡ä¸­é—´ã€‚</li>\n<li><strong>â€œç»“æ„åŒ–â€çš„å½»åº•ä¸¢å¤±</strong>ï¼šæœ€å…¸å‹çš„å°±æ˜¯è¡¨æ ¼ã€‚ä¸€æ—¦è§£ææˆä¹±åºçº¯æ–‡æœ¬ï¼Œè¡Œä¸åˆ—çš„å…³ç³»å°±ä¼šç°é£çƒŸç­ï¼Œå¤§æ¨¡å‹çœ‹åˆ°çš„åªæ˜¯ä¸€å †æ¯«æ— å…³è”çš„æ•°å­—â€œå¤©ä¹¦â€ã€‚</li>\n</ul>\n<hr />\n<h2 id=\"docling\">02 | æ ¸å¿ƒäº®ç‚¹ï¼šDocling å‡­ä»€ä¹ˆè¢«ç§°ä¸ºâ€œé™ç»´æ‰“å‡»â€ï¼Ÿ</h2>\n<p>Docling ä¸ä»…ä»…æ˜¯ä¸€ä¸ªè½¬æ¢å·¥å…·ï¼Œå®ƒæ›´åƒæ˜¯ä¸€ä¸ªæ‹¥æœ‰â€œé€è§†çœ¼â€çš„æ™ºèƒ½æ–‡æ¡£ç¿»è¯‘å®˜ã€‚</p>\n<h3 id=\"section-1\">â‘  è¯­ä¹‰å¸ƒå±€åˆ†æï¼Œè€Œéå­—ç¬¦æŠ“å–</h3>\n<p>Docling é‡‡ç”¨äº†å…ˆè¿›çš„äººå·¥æ™ºèƒ½è§†è§‰æ¨¡å‹ï¼ˆåŸºäº DocLayNet æ•°æ®é›†ï¼‰ã€‚å®ƒä¸æ˜¯ç¡¬ç”Ÿç”Ÿåœ°â€œæ‰£â€å­—ï¼Œè€Œæ˜¯åƒäººçœ¼ä¸€æ ·å»ç†è§£å¸ƒå±€ï¼š<strong>â€œè¿™é‡Œæ˜¯åˆ†æ æ ‡é¢˜ï¼Œé‚£é‡Œæ˜¯è·¨è¡Œè¡¨æ ¼ï¼Œå³è¾¹æ˜¯é…å›¾çš„æ³¨é‡Šã€‚â€</strong> è¿™ç§å¯¹æ–‡æ¡£æ‹“æ‰‘ç»“æ„çš„æ·±åˆ»ç†è§£ï¼Œæ˜¯ä¿ç•™åŸæ–‡é€»è¾‘çš„å…³é”®ã€‚</p>\n<h3 id=\"tableformer\">â‘¡ è¡¨æ ¼è§£æçš„â€œå¤©èŠ±æ¿â€ï¼šTableFormer</h3>\n<p>è¿™æ˜¯ Docling çš„æ€æ‰‹é”ã€‚å®ƒå†…ç½®äº† IBM ä¸“é—¨é’ˆå¯¹å¤æ‚è¡¨æ ¼ç ”å‘çš„ <strong>TableFormer</strong> æ¨¡å‹ã€‚å³ä¾¿æ˜¯æ²¡æœ‰è¾¹æ¡†çº¿çš„è¡¨æ ¼ã€å«æœ‰å¤æ‚åˆå¹¶å•å…ƒæ ¼çš„æŠ¥è¡¨ï¼Œå®ƒéƒ½èƒ½ç²¾å‡†è¿˜åŸå¹¶è½¬æ¢ä¸º Markdown æˆ– JSONã€‚</p>\n<ul>\n<li><strong>ä¸ºä»€ä¹ˆ Markdown å¯¹ RAG è‡³å…³é‡è¦ï¼Ÿ</strong> å¤§æ¨¡å‹å¤©ç”Ÿå¯¹ Markdown æ ¼å¼çš„è¡¨æ ¼æœ‰æå¼ºçš„æ„ŸçŸ¥åŠ›ã€‚é€šè¿‡ Doclingï¼Œå¤§æ¨¡å‹ç»ˆäºèƒ½è¯»æ‡‚â€œ2025å¹´Q3çš„çº¯Aç‡æ¯”Q2å¢é•¿äº†å¤šå°‘â€è¿™ç§æ¶‰åŠè·¨è¡Œè·¨åˆ—å¯¹æ¯”çš„å¤æ‚é€»è¾‘ã€‚</li>\n</ul>\n<h3 id=\"pipeline-v2\">â‘¢ æç®€çš„ Pipeline ä¸ v2 ç»Ÿä¸€æ¶æ„</h3>\n<p>åœ¨æœ€æ–°çš„ <strong>v2 ç‰ˆæœ¬</strong>ä¸­ï¼ŒDocling å¼•å…¥äº†ç»Ÿä¸€çš„ä¸­é—´è¡¨ç¤ºï¼ˆ<code>DoclingDocument</code>ï¼‰ã€‚è¿™æ„å‘³ç€æ— è®ºä½ è¾“å…¥çš„æ˜¯ PDFã€Wordã€PPT è¿˜æ˜¯ HTMLï¼Œè¾“å‡ºçš„ç»“æ„åŒ–æŠ½è±¡æ˜¯å®Œå…¨ä¸€è‡´çš„ã€‚è¿™ç§â€œä¸‡ç‰©å½’ä¸€â€çš„ç‰¹æ€§ï¼Œæå¤§ç®€åŒ–äº† RAG åç«¯çš„æ•°æ®å¤„ç†é€»è¾‘ã€‚</p>\n<hr />\n<h2 id=\"docling-rag\">03 | è¿›é˜¶ç†è§£ï¼šDocling åœ¨ RAG å·¥ä½œæµä¸­çš„åŒ–å­¦ååº”</h2>\n<h3 id=\"smart-chunking\">â‘  åŸç”Ÿè¯­ä¹‰åˆ‡ç‰‡ï¼ˆSmart Chunkingï¼‰</h3>\n<p>ä¼ ç»Ÿçš„åˆ‡ç‰‡æ˜¯æŒ‰å­—æ•°ç¡¬åˆ‡ï¼Œå¸¸å¯¼è‡´è¯­ä¹‰æ–­è£‚ã€‚Docling ç°åœ¨çš„å¼ºå¤§ä¹‹å¤„åœ¨äºå®ƒ<strong>è‡ªå¸¦åˆ‡ç‰‡é€»è¾‘</strong>ã€‚å› ä¸ºå®ƒçŸ¥é“å“ªé‡Œæ˜¯æ ‡é¢˜ã€å“ªé‡Œæ˜¯æ®µè½ï¼Œæ‰€ä»¥å®ƒå¯ä»¥æ‰§è¡Œ<strong>åŸºäºç»“æ„çš„åˆ‡ç‰‡</strong>ï¼š</p>\n<blockquote>\n<p><strong>ç¬”è€…è§è§£</strong>ï¼šé€šè¿‡ Doclingï¼Œæˆ‘ä»¬å¯ä»¥ç¡®ä¿æ¯ä¸€ä¸ª Knowledge Chunk éƒ½æ˜¯ä¸€ä¸ªå®Œæ•´çš„è¯­ä¹‰å•å…ƒï¼ˆä¾‹å¦‚ï¼šæ•´ä¸ªäºŒçº§æ ‡é¢˜ä¸‹çš„æ‰€æœ‰æ®µè½ï¼‰ï¼Œè¿™èƒ½ä»æºå¤´ä¸Šæ¶ˆé™¤å¤§æ¨¡å‹åœ¨æ£€ç´¢åçš„å¹»è§‰ã€‚</p>\n</blockquote>\n<h3 id=\"section-2\">â‘¡ å…ƒæ•°æ®ä¸åæ ‡æ˜ å°„</h3>\n<p>Docling è§£ææ—¶ä¼šä¿ç•™æ¯ä¸€ä¸ªå…ƒç´ åœ¨åŸä»¶ä¸­çš„åæ ‡ã€‚è¿™ä½¿å¾—åœ¨ RAG çš„â€œå¼•ç”¨æ¥æºâ€åŠŸèƒ½ä¸­ï¼Œåº”ç”¨ä¸ä»…èƒ½å‘Šè¯‰ç”¨æˆ·ç­”æ¡ˆåœ¨å“ªä¸ªæ–‡æ¡£ï¼Œç”šè‡³èƒ½ç›´æ¥åœ¨ PDF é¢„è§ˆä¸­<strong>é«˜äº®æ˜¾ç¤º</strong>å‡ºé‚£ä¸€è¡Œæ–‡å­—çš„ä½ç½®ã€‚</p>\n<hr />\n<h2 id=\"section-3\">04 | æœ€æ–°åŠ¨æ€ï¼šå‘å…¨èƒ½å¤šæ¨¡æ€è·¨è¶Š</h2>\n<p>ç›¸æ¯”æ—©æœŸçš„è§£æå·¥å…·ï¼ŒDocling æ­£åœ¨å‘â€œå¤šæ¨¡æ€â€è¿›åŒ–ã€‚å®ƒä¸ä»…åŠ å¼ºäº†å¯¹ <strong>OCRï¼ˆå…‰å­¦å­—ç¬¦è¯†åˆ«ï¼‰</strong> çš„æ”¯æŒï¼Œè§£å†³æ‰«æä»¶éš¾é¢˜ï¼Œç”šè‡³å¼€å§‹æ”¯æŒå¤„ç†å¤æ‚çš„ <strong>LaTeX å…¬å¼</strong>ã€‚å®ƒä¸å†ä¾èµ–æ˜‚è´µçš„å•†ä¸šé—­æºæ–¹æ¡ˆï¼ˆå¦‚ Adobe Extractï¼‰ï¼Œè€Œæ˜¯ä¸ºå¼€æºç¤¾åŒºæä¾›äº†ä¸€ä¸ªåœ¨æ€§èƒ½ä¸Šå®Œå…¨å¯¹æ ‡çš„é«˜è´¨é‡é€‰æ‹©ã€‚</p>\n<hr />\n<h2 id=\"rag\">05 | æ€»ç»“ï¼šRAG å·¥ç¨‹å¸ˆçš„æ ‡é…å·¥å…·</h2>\n<p>å¦‚æœè¯´å‘é‡æ•°æ®åº“æ˜¯ RAG çš„å¤§è„‘ï¼Œé‚£ä¹ˆ Docling å°±æ˜¯é‚£åŒ <strong>â€œæå…¶æ•é”çš„æ‰‹â€</strong>ï¼Œè´Ÿè´£æŠŠç²—ç³™çš„åŸææ–™åŠ å·¥æˆç²¾è‡´çš„é¥µæ–™ã€‚</p>\n<p><strong>ç¬”è€…çš„å»ºè®®ï¼š</strong><br />\nå¦‚æœä½ ç°åœ¨çš„ RAG ç³»ç»Ÿè¿˜åœ¨ä¸ºâ€œè¡¨æ ¼è¯†åˆ«ä¸å‡†â€æˆ–â€œæ–‡æ¡£ç»“æ„æ··ä¹±â€è€Œçƒ¦æ¼ï¼Œä¸è¦æ€¥ç€ç ¸é’±å»æ¢æ›´è´µçš„ LLM æ¥å£ï¼Œè¯•ç€åœ¨è§£æå±‚å¼•å…¥ Doclingã€‚ä½ ä¼šå‘ç°ï¼Œæœ‰æ—¶å€™åº•å±‚çš„â€œåŸºå»ºâ€ä¼˜åŒ–ï¼Œæ¯”ä¸Šå±‚çš„â€œç‚¼ä¸¹â€æ›´æœ‰å¥‡æ•ˆã€‚</p>\n\n\n</div>\n<div id=\"MySignature\">\n    <a href=\"https://www.cnblogs.com/jyzhao/\" target=\"_blank\">AlfredZhao</a>Â©ç‰ˆæƒæ‰€æœ‰ã€Œä»Oracleèµ·èˆªï¼Œé¢†ç•¥ç²¾å½©çš„ITæŠ€æœ¯ã€‚ã€<br />\nè½¬è½½è¯·æ³¨æ˜åŸæ–‡é“¾æ¥ï¼š<a href=\"https://www.cnblogs.com/jyzhao/p/19610038/rag-shi-dai-de-po-bi-ren-wei-shen-me-ni-de-da-mo-x\" target=\"_blank\">https://www.cnblogs.com/jyzhao/p/19610038/rag-shi-dai-de-po-bi-ren-wei-shen-me-ni-de-da-mo-x</a>\n<hr />\n<div style=\"text-align: center; margin-top: 30px;\">\n  <p style=\"font-size: 14px; color: #555;\">\n    ğŸ‘‹ æ„Ÿè°¢é˜…è¯»ï¼Œæ¬¢è¿å…³æ³¨æˆ‘çš„å…¬ä¼—å· <b>ã€Œèµµé–å®‡ã€</b>\n  </p>\n  <img src=\"https://images.cnblogs.com/cnblogs_com/jyzhao/824234/o_250208075013_qrcode-zjy.jpg\" style=\"border: 1px solid #ddd; border-radius: 8px;\" width=\"160\" />\n</div>\n</div>\n<div class=\"clear\"></div>\n\n        <div class=\"clear\"></div>\n        \n</div>\n    <ul class=\"postmetadata\">\n        \n    </ul>"
    },
    {
      "title": "ä»é›¶å®ç°ä¸€ä¸ªç”Ÿäº§çº§ RAG è¯­ä¹‰æœç´¢ç³»ç»Ÿï¼šC++ + ONNX + FAISS å®æˆ˜",
      "link": "https://www.cnblogs.com/charlee44/p/19609813",
      "published": "",
      "description": "<h1 class=\"postTitle\">\n                <a class=\"postTitle2 vertical-middle\" href=\"https://www.cnblogs.com/charlee44/p/19609813\" id=\"cb_post_title_url\" title=\"å‘å¸ƒäº 2026-02-12 21:41\">\n    <span>ä»é›¶å®ç°ä¸€ä¸ªç”Ÿäº§çº§ RAG è¯­ä¹‰æœç´¢ç³»ç»Ÿï¼šC++ + ONNX + FAISS å®æˆ˜</span>\n    \n\n</a>\n\n            </h1>\n            <div class=\"clear\"></div>\n            <div class=\"postBody\">\n                    <div id=\"cnblogs_post_description\" style=\"display: none;\">\n        \n        æœ¬æ–‡ä»é›¶æ„å»ºäº†ä¸€ä¸ªè½»é‡çº§ã€é«˜æ€§èƒ½çš„ C++ è¯­ä¹‰æœç´¢ç³»ç»Ÿï¼ŒåŸºäº ONNX è¿è¡Œ BGE åµŒå…¥æ¨¡å‹ã€FAISS å‘é‡ç´¢å¼•ä¸ Markdown è¯­ä¹‰åˆ†å—ï¼Œå®Œæ•´å®ç°æ”¯æŒå¢åˆ æ”¹æŸ¥çš„ç”Ÿäº§çº§ RAG æ£€ç´¢åç«¯ã€‚\n    </div>\n<div class=\"blogpost-body cnblogs-markdown\" id=\"cnblogs_post_body\">\n<h1 id=\"1-å¼•è¨€\">1. å¼•è¨€</h1>\n<p>æ—¢ç„¶æ˜¯â€œä»é›¶å®ç°â€ï¼Œæœ¬æ–‡æš‚ä¸æ·±å…¥æ¢è®¨ç¹å¤çš„ç†è®ºèƒŒæ™¯ï¼Œè€Œæ˜¯å…ˆèšç„¦ä¸€ä¸ªæ ¸å¿ƒé—®é¢˜ï¼šè¯­ä¹‰åŒ–æœç´¢ä¸­çš„â€œè¯­ä¹‰åŒ–â€åˆ°åº•æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ</p>\n<p>ä¼ ç»Ÿçš„å…³é”®è¯æœç´¢ä¾èµ–å­—é¢åŒ¹é…â€”â€”æ¯”å¦‚æœç´¢â€œå¦‚ä½•åºåˆ—åŒ– JSONâ€ï¼Œç³»ç»Ÿåªä¼šè¿”å›åŒ…å«è¿™äº›ç²¾ç¡®å…³é”®è¯çš„æ–‡æ¡£ã€‚è¿™ç§æ–¹å¼ç®€å•ç›´æ¥ï¼Œä½†ååˆ†â€œå‘†æ¿â€ï¼šå®ƒæ— æ³•ç†è§£â€œJSON åºåˆ—åŒ–æ–¹æ³•â€æˆ–â€œæŠŠå¯¹è±¡è½¬æˆ JSON å­—ç¬¦ä¸²â€å…¶å®è¡¨è¾¾äº†ç›¸åŒçš„æ„å›¾ã€‚</p>\n<p>è€Œè¯­ä¹‰åŒ–æœç´¢çš„çªç ´åœ¨äºï¼šå®ƒä¸å†æ¯”è¾ƒæ–‡å­—ï¼Œè€Œæ˜¯æ¯”è¾ƒå«ä¹‰ã€‚å…¶æ ¸å¿ƒæ€æƒ³æ˜¯å°†æ–‡æœ¬ï¼ˆæ— è®ºæ˜¯æŸ¥è¯¢è¿˜æ˜¯æ–‡æ¡£ï¼‰é€šè¿‡åµŒå…¥æ¨¡å‹ï¼ˆEmbedding Modelï¼‰è½¬æ¢ä¸ºé«˜ç»´å‘é‡â€”â€”è¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºâ€œå‘é‡åŒ–â€æˆ–â€œåµŒå…¥â€ï¼ˆEmbeddingï¼‰ã€‚åœ¨å‘é‡ç©ºé—´ä¸­ï¼Œè¯­ä¹‰ç›¸è¿‘çš„å¥å­ä¼šè¢«æ˜ å°„åˆ°å½¼æ­¤é è¿‘çš„ä½ç½®ã€‚äºæ˜¯ï¼Œæœç´¢å°±å˜æˆäº†ä¸€ä¸ªå‘é‡ç›¸ä¼¼åº¦è®¡ç®—é—®é¢˜ï¼šæ‰¾å‡ºä¸æŸ¥è¯¢å‘é‡æœ€æ¥è¿‘çš„æ–‡æ¡£å‘é‡ã€‚</p>\n<p>è¡¨é¢ä¸Šçœ‹ï¼Œè¿™æ˜¯æ•°å­¦ï¼ˆå‘é‡ã€å†…ç§¯ã€è·ç¦»ï¼‰ï¼›æœ¬è´¨ä¸Šï¼Œè¿™æ˜¯æ™ºèƒ½â€”â€”å› ä¸ºæ¨¡å‹é€šè¿‡æµ·é‡æ•°æ®å­¦ä¹ åˆ°äº†äººç±»è¯­è¨€çš„è¯­ä¹‰ç»“æ„ã€‚è€Œæˆ‘ä»¬è¦åšçš„ï¼Œå°±æ˜¯ç”¨ç¼–ç¨‹è¯­è¨€æŠŠè¿™å¥—â€œç”¨æ•°å­¦ç†è§£è¯­è¨€â€çš„èƒ½åŠ›ï¼Œå˜æˆä¸€ä¸ªé«˜æ•ˆã€å¯é ã€å¯éƒ¨ç½²çš„ç”Ÿäº§çº§ç³»ç»Ÿã€‚</p>\n<h1 id=\"2-ç›®æ ‡\">2. ç›®æ ‡</h1>\n<p>æœ¬æ–‡çš„åˆè¡·ï¼Œæ˜¯ä¸ºæˆ‘çš„ä¸ªäººåšå®¢ç½‘ç«™ <a href=\"https://charlee44.com/\" rel=\"noopener nofollow\" target=\"_blank\"><strong>Charlee44 çš„æŠ€æœ¯é©¿ç«™</strong></a> å®ç°ä¸€å¥—çœŸæ­£å¯ç”¨çš„ç«™å†…æœç´¢åŠŸèƒ½ã€‚ç”±äºåšå®¢éƒ¨ç½²åœ¨èµ„æºæå…¶æœ‰é™çš„äº‘æœåŠ¡å™¨ä¸Šï¼ˆæ¯”å¦‚1æ ¸ CPUã€1GB å†…å­˜ï¼‰ï¼Œæˆ‘å¯¹ç³»ç»Ÿæå‡ºäº†ä¸¤ä¸ªâ€œæè‡´â€è¦æ±‚ï¼š<strong>æè‡´çš„æ€§èƒ½</strong> ä¸ <strong>æè‡´çš„èµ„æºæ•ˆç‡</strong>ã€‚</p>\n<p><img alt=\"ä¸ªäººåšå®¢ç½‘ç«™çš„ç«™å†…æœç´¢åŠŸèƒ½\" class=\"lazyload\" /></p>\n<p>æ¯•ç«Ÿï¼Œæ¯ä¸€åˆ†ç®—åŠ›éƒ½æ¥è‡ªè‡ªå·±çš„é’±åŒ…â€”â€”è¿™ä¿ƒä½¿æˆ‘æ”¾å¼ƒäº†ä¸»æµä½†ç›¸å¯¹â€œé‡â€çš„ Python ç”Ÿæ€ï¼ˆå¦‚ Sentence Transformers + ChromaDB çš„å¸¸è§„ç»„åˆï¼‰ï¼Œè½¬è€Œé€‰æ‹© <strong>C++</strong> ä½œä¸ºå®ç°è¯­è¨€ã€‚C++ ä¸ä»…èƒ½æä¾›æ›´ä½çš„å†…å­˜å¼€é”€å’Œæ›´é«˜çš„æ¨ç†ååï¼Œä¹Ÿè®©æˆ‘æœ‰æœºä¼šæ·±å…¥ç†è§£ embedding æ¨ç†ã€å‘é‡ç´¢å¼•ã€æ–‡æœ¬åˆ†å—ç­‰æ¨¡å—çš„åº•å±‚æœºåˆ¶ã€‚</p>\n<p>å½“ç„¶ï¼Œéœ€è¦è¯´æ˜çš„æ˜¯ï¼š<strong>å¦‚æœæ˜¯åœ¨ä¼ä¸šç¯å¢ƒä¸­å¼€å‘ï¼Œæˆ–å¯¹è¿­ä»£é€Ÿåº¦è¦æ±‚æ›´é«˜ï¼ŒPython ç”Ÿæ€ä»æ˜¯æ›´é«˜æ•ˆã€æ›´æˆç†Ÿçš„é€‰æ‹©</strong>ã€‚è€Œæœ¬é¡¹ç›®æ›´å¤šæ˜¯ä¸€æ¬¡â€œç”¨å·¥ç¨‹çº¦æŸé©±åŠ¨æ·±åº¦å­¦ä¹ â€çš„å®è·µâ€”â€”åœ¨æœ‰é™èµ„æºä¸‹ï¼Œäº²æ‰‹æ„å»ºä¸€ä¸ªè½»é‡ã€å¯æ§ã€å¯è½åœ°çš„è¯­ä¹‰æœç´¢ç³»ç»Ÿã€‚</p>\n<h1 id=\"3-åµŒå…¥æ¨¡å‹\">3. åµŒå…¥æ¨¡å‹</h1>\n<p>æ—¢ç„¶è¯­ä¹‰åŒ–æœç´¢çš„æ ¸å¿ƒåœ¨äºå°†æ–‡æœ¬è½¬åŒ–ä¸ºå¯Œå«è¯­ä¹‰çš„å‘é‡ï¼Œé‚£ä¹ˆå®ç°è¿™ä¸€èƒ½åŠ›çš„å…³é”®ï¼Œå°±åœ¨äºé€‰æ‹©ä¸€ä¸ªåˆé€‚çš„åµŒå…¥æ¨¡å‹ã€‚è¿™ç±»æ¨¡å‹çš„ä½œç”¨ï¼Œæ˜¯å°†ä»»æ„é•¿åº¦çš„æ–‡æœ¬æ˜ å°„ä¸ºå›ºå®šç»´åº¦çš„ç¨ å¯†å‘é‡ï¼Œä½¿å¾—è¯­ä¹‰ç›¸ä¼¼çš„æ–‡æœ¬åœ¨å‘é‡ç©ºé—´ä¸­è·ç¦»æ›´è¿‘ã€‚ç¬”è€…è¿™é‡Œä½¿ç”¨çš„æ˜¯ <a href=\"https://huggingface.co/BAAI/bge-small-zh-v1.5\" rel=\"noopener nofollow\" target=\"_blank\">bge-small-zh-v1.5</a> ã€‚bge-small-zh-v1.5 æ˜¯ç”±åŒ—äº¬æ™ºæºäººå·¥æ™ºèƒ½ç ”ç©¶é™¢ï¼ˆBAAIï¼‰æ¨å‡ºçš„ BGEï¼ˆBAAI General Embeddingï¼‰ç³»åˆ—ä¸­çš„è½»é‡çº§ä¸­æ–‡æ¨¡å‹ã€‚å®ƒåŸºäº Transformer æ¶æ„ï¼Œåœ¨å¤§è§„æ¨¡ä¸­è‹±æ–‡è¯­æ–™ä¸Šè¿›è¡Œå¯¹æ¯”å­¦ä¹ è®­ç»ƒï¼Œä¸“ä¸ºæ£€ç´¢ä»»åŠ¡ä¼˜åŒ–ã€‚å°½ç®¡å®ƒå¹¶éè¯¥ç³»åˆ—ä¸­æœ€æ–°æˆ–æœ€å¤§çš„ç‰ˆæœ¬ï¼ˆå¦‚ bge-largeï¼‰ï¼Œä½†å…¶åœ¨æ¨ç†é€Ÿåº¦ã€å†…å­˜å ç”¨ä¸è¯­ä¹‰è´¨é‡ä¹‹é—´å–å¾—äº†æä½³çš„å¹³è¡¡ï¼Œå°¤å…¶é€‚åˆèµ„æºå—é™æˆ–å¯¹å»¶è¿Ÿæ•æ„Ÿçš„ç”Ÿäº§ç¯å¢ƒã€‚</p>\n<p>bge-small-zh-v1.5 å¯ä»¥ä» Hugging Face ä¸Šä¸‹è½½ï¼Œä¸‹è½½åçš„æ•°æ®æ–‡ä»¶ç»„ç»‡ç»“æ„å¦‚ä¸‹ï¼š</p>\n<pre><code class=\"language-text\">bge-small-zh-v1.5/\nâ”œâ”€â”€ config.json                     # æ¨¡å‹æ¶æ„é…ç½®ï¼ˆå±‚æ•°ã€éšè—å±‚ç»´åº¦ç­‰ï¼‰\nâ”œâ”€â”€ pytorch_model.bin               # PyTorch æ ¼å¼çš„æ¨¡å‹æƒé‡ï¼ˆæ ¸å¿ƒæ–‡ä»¶ï¼‰\nâ”œâ”€â”€ tokenizer.json                  # åˆ†è¯å™¨å®šä¹‰ï¼ˆWordPiece è¯æ±‡è¡¨ + ç®—æ³•å‚æ•°ï¼‰\nâ”œâ”€â”€ tokenizer_config.json           # åˆ†è¯å™¨é…ç½®ï¼ˆå¦‚æ˜¯å¦å°å†™åŒ–ã€ç‰¹æ®Š token ç­‰ï¼‰\nâ”œâ”€â”€ vocab.txt                       # WordPiece è¯æ±‡è¡¨ï¼ˆçº¯æ–‡æœ¬ï¼Œæ¯è¡Œä¸€ä¸ª tokenï¼‰\nâ”œâ”€â”€ special_tokens_map.json         # ç‰¹æ®Š token æ˜ å°„ï¼ˆ[CLS], [SEP], [PAD] ç­‰ï¼‰\nâ”œâ”€â”€ modules.json                    # ï¼ˆå¯é€‰ï¼‰æ¨¡å‹æ¨¡å—ä¿¡æ¯\nâ”œâ”€â”€ sentence_bert_config.json       # ï¼ˆå¯é€‰ï¼‰Sentence-BERT ç›¸å…³é…ç½®\nâ”œâ”€â”€ README.md                       # æ¨¡å‹å¡ç‰‡ï¼ˆå«ä½¿ç”¨è¯´æ˜ã€å¼•ç”¨ä¿¡æ¯ç­‰ï¼‰\nâ””â”€â”€ .gitattributes                  # Git LFS é…ç½®ï¼ˆç”¨äºå¤§æ–‡ä»¶ç®¡ç†ï¼‰\n</code></pre>\n<p>ä¸è¿‡ï¼Œbge-small-zh-v1.5 åŸç”ŸåŸºäº PyTorchï¼ˆå±äº Python ç”Ÿæ€ï¼‰ï¼Œç›´æ¥åœ¨ C++ ç¯å¢ƒä¸­è°ƒç”¨å¹¶ä¸æ–¹ä¾¿ï¼Œä¹Ÿéš¾ä»¥æ»¡è¶³æˆ‘ä»¬å¯¹æ€§èƒ½å’Œèµ„æºå ç”¨çš„è¦æ±‚ã€‚ä¸ºäº†åœ¨ C++ ä¸­é«˜æ•ˆè¿è¡Œè¯¥æ¨¡å‹ï¼Œæœ€ä½³å®è·µæ˜¯å°†å…¶å¯¼å‡ºä¸º ONNX æ ¼å¼ã€‚</p>\n<p>ONNXï¼ˆOpen Neural Network Exchangeï¼‰æ˜¯ä¸€ç§å¼€æ”¾çš„ç¥ç»ç½‘ç»œæ¨¡å‹äº¤æ¢æ ¼å¼ï¼Œç”±å¾®è½¯ã€Facebook ç­‰å…¬å¸å…±åŒæ¨åŠ¨ï¼Œæ—¨åœ¨å®ç°â€œä¸€æ¬¡è®­ç»ƒï¼Œå¤šç«¯éƒ¨ç½²â€ã€‚å®ƒä¸ä¾èµ–ç‰¹å®šæ¡†æ¶ï¼ˆå¦‚ PyTorch æˆ– TensorFlowï¼‰ï¼Œè€Œæ˜¯å°†æ¨¡å‹ç»“æ„ä¸æƒé‡ç»Ÿä¸€åºåˆ—åŒ–ä¸ºæ ‡å‡†æ ¼å¼ï¼Œä»è€Œå¯åœ¨ä¸åŒç¡¬ä»¶å’Œè¯­è¨€ç¯å¢ƒä¸­é«˜æ•ˆæ¨ç†ã€‚</p>\n<p>è¦åœ¨ C++ ä¸­åŠ è½½å’Œè¿è¡Œ ONNX æ¨¡å‹ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ ONNX Runtimeâ€”â€”è¿™æ˜¯å¾®è½¯å¼€æºçš„é«˜æ€§èƒ½æ¨ç†å¼•æ“ï¼Œæ”¯æŒ CPU/GPU åŠ é€Ÿã€è·¨å¹³å°ï¼ˆWindows/Linux/macOSï¼‰ä»¥åŠ C/C++/Python ç­‰å¤šç§è¯­è¨€ç»‘å®šã€‚é€šè¿‡ ONNX Runtimeï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ—  Python ä¾èµ–çš„æƒ…å†µä¸‹ï¼Œä»¥æä½çš„å¼€é”€å®Œæˆ embedding æ¨ç†ï¼Œå®Œç¾å¥‘åˆæœ¬é¡¹ç›®çš„è½»é‡çº§ç›®æ ‡ã€‚</p>\n<p>å› æ­¤ï¼Œå…³é”®çš„ç¬¬ä¸€æ­¥æ˜¯éœ€è¦å°† bge-small-zh-v1.5 è½¬æ¢æˆ ONNX æ ¼å¼çš„åµŒå…¥æ¨¡å‹ã€‚åµŒå…¥æ¨¡å‹çš„æ ¼å¼è½¬æ¢æ˜¯é¢„å¤„ç†æ­¥éª¤ï¼Œå¯ä»¥é€šè¿‡ Python è„šæœ¬æ¥å®ç°ï¼š</p>\n<pre><code class=\"language-python\"># export_onnx.py\nfrom transformers import AutoTokenizer, AutoModel\nfrom optimum.onnxruntime import ORTModelForFeatureExtraction\nfrom pathlib import Path\n\n# æ”¹ä¸ºä½ çš„æœ¬åœ°æ¨¡å‹è·¯å¾„ï¼ˆæ³¨æ„ï¼šä½¿ç”¨åŸå§‹å­—ç¬¦ä¸²æˆ–æ­£æ–œæ ï¼‰\nmodel_path = \"C:/Github/search/bge-small-zh-v1.5\" \nonnx_path = \"./bge-small-zh-onnx\"\n\n# å¯¼å‡º ONNXï¼ˆä»æœ¬åœ°æ¨¡å‹åŠ è½½ï¼‰\nort_model = ORTModelForFeatureExtraction.from_pretrained(\n    model_path,           # â† å…³é”®ï¼šä½¿ç”¨æœ¬åœ°è·¯å¾„\n    export=True,\n    provider=\"CPUExecutionProvider\"\n)\n\ntokenizer = AutoTokenizer.from_pretrained(model_path)  # â† åŒæ ·ç”¨æœ¬åœ°è·¯å¾„\n\n# ä¿å­˜ ONNX æ¨¡å‹å’Œ tokenizer\nort_model.save_pretrained(onnx_path)\ntokenizer.save_pretrained(onnx_path)\n\nprint(f\"âœ… ONNX æ¨¡å‹å·²å¯¼å‡ºåˆ° {onnx_path}\")\n</code></pre>\n<p>è½¬æ¢åçš„ ONNX æ ¼å¼åµŒå…¥æ¨¡å‹ bge-small-zh-onnx çš„æ•°æ®æ–‡ä»¶ç»„ç»‡ç»“æ„å¦‚ä¸‹ï¼š</p>\n<pre><code class=\"language-python\">bge-small-zh-onnx/\nâ”œâ”€â”€ model.onnx                      # âœ… æ ¸å¿ƒï¼šONNX æ ¼å¼çš„æ¨¡å‹è®¡ç®—å›¾ï¼ˆå«æƒé‡ï¼‰\nâ”œâ”€â”€ config.json                     # æ¨¡å‹æ¶æ„é…ç½®ï¼ˆä¸åŸç‰ˆä¸€è‡´ï¼‰\nâ”œâ”€â”€ tokenizer.json                  # åˆ†è¯å™¨å®šä¹‰ï¼ˆWordPiece + é¢„å¤„ç†è§„åˆ™ï¼‰\nâ”œâ”€â”€ tokenizer_config.json           # åˆ†è¯å™¨è¡Œä¸ºé…ç½®ï¼ˆå¦‚ do_lower_caseï¼‰\nâ”œâ”€â”€ vocab.txt                       # WordPiece è¯æ±‡è¡¨ï¼ˆçº¯æ–‡æœ¬å¤‡ä»½ï¼‰\nâ””â”€â”€ special_tokens_map.json         # ç‰¹æ®Š token æ˜ å°„ï¼ˆ[CLS], [SEP], [PAD] ç­‰ï¼‰\n</code></pre>\n<h1 id=\"4-åˆ†è¯å™¨\">4. åˆ†è¯å™¨</h1>\n<p>åœ¨ä½¿ç”¨ ONNX Runtime åŠ è½½åµŒå…¥æ¨¡å‹å¯¹æ–‡æœ¬è¿›è¡Œå‘é‡åŒ–ä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜éœ€è¦äº†è§£ä¸€ä¸ªå…³é”®ç»„ä»¶ï¼š<strong>åˆ†è¯å™¨</strong>ï¼ˆTokenizerï¼‰ã€‚</p>\n<p>æ‰€è°“â€œå­—ã€è¯ã€å¥ã€æ®µã€ç¯‡â€ï¼Œè¯­è¨€çš„ç†è§£æ˜¯åˆ†å±‚çš„ã€‚ä½†å¯¹äºç°ä»£æ·±åº¦å­¦ä¹ æ¨¡å‹ï¼ˆå°¤å…¶æ˜¯åŸºäº Transformer çš„æ¶æ„ï¼‰è€Œè¨€ï¼Œå®ƒä»¬å¹¶ä¸ç›´æ¥å¤„ç†åŸå§‹å­—ç¬¦ï¼Œè€Œæ˜¯å°†æ–‡æœ¬<strong>åˆ‡åˆ†ä¸ºæ›´å°çš„è¯­ä¹‰å•å…ƒâ€”â€”â€œè¯å…ƒâ€</strong>ï¼ˆtokenï¼‰ã€‚è¿™ä¸ªè¿‡ç¨‹å°±æ˜¯ <strong>Tokenization</strong>ï¼ˆè¯å…ƒåŒ–ï¼‰ï¼Œç”±åˆ†è¯å™¨å®Œæˆã€‚</p>\n<p>åˆ†è¯å™¨çš„é‡è¦æ€§ä½“ç°åœ¨ä»¥ä¸‹ä¸¤ç‚¹ï¼š</p>\n<ol>\n<li><strong>æ¨¡å‹è¾“å…¥çš„å‰æ</strong>ï¼šåµŒå…¥æ¨¡å‹åªæ¥å— token ID åºåˆ—ä½œä¸ºè¾“å…¥ï¼Œè€ŒéåŸå§‹å­—ç¬¦ä¸²ã€‚æ²¡æœ‰æ­£ç¡®çš„åˆ†è¯ï¼Œå°±æ— æ³•ç”Ÿæˆæœ‰æ•ˆçš„ embeddingã€‚</li>\n<li><strong>å½±å“è¯­ä¹‰ç²¾åº¦</strong>ï¼šä¸åŒçš„åˆ†è¯ç­–ç•¥ä¼šå¯¼è‡´ä¸åŒçš„ token åºåˆ—ï¼Œè¿›è€Œå½±å“å‘é‡è¡¨è¾¾çš„è´¨é‡ã€‚</li>\n</ol>\n<h2 id=\"41-è‡ªå®šä¹‰åˆ†è¯å™¨\">4.1 è‡ªå®šä¹‰åˆ†è¯å™¨</h2>\n<p>å…¶å®åˆ†è¯å™¨çš„å®ç°ä¹Ÿå¹¶ä¸ç¥ç§˜ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥å®ç°ä¸€ä¸ªç®€å•ç‰ˆæœ¬çš„ï¼š</p>\n<pre><code class=\"language-cpp\">#include &lt;fstream&gt;\n#include &lt;string&gt;\n#include &lt;unordered_map&gt;\n#include &lt;vector&gt;\n\n#ifdef _WIN32\n#include &lt;Windows.h&gt;\n#endif\n\nusing namespace std;\n\nstd::unordered_map&lt;std::string, int&gt; LoadVocab(const std::string&amp; path) {\n  std::unordered_map&lt;std::string, int&gt; vocab;\n  std::ifstream file(path);\n  std::string token;\n  int id = 0;\n  while (std::getline(file, token)) {\n    vocab[token] = id++;\n  }\n  return vocab;\n}\n\n// æ³¨æ„ï¼šéœ€å¤„ç† UTF-8 å¤šå­—èŠ‚å­—ç¬¦ï¼\nstd::vector&lt;std::string&gt; SplitTextChars(const std::string&amp; text) {\n  std::vector&lt;std::string&gt; chars;\n  for (size_t i = 0; i &lt; text.size();) {\n    if ((text[i] &amp; 0x80) == 0) {  // ASCII\n      chars.push_back(std::string(1, text[i++]));\n    } else {  // UTF-8 å¤šå­—èŠ‚\n      int bytes = 0;\n      if ((text[i] &amp; 0xE0) == 0xC0)\n        bytes = 2;\n      else if ((text[i] &amp; 0xF0) == 0xE0)\n        bytes = 3;\n      else if ((text[i] &amp; 0xF8) == 0xF0)\n        bytes = 4;\n      else\n        throw std::runtime_error(\"Invalid UTF-8\");\n      chars.push_back(text.substr(i, bytes));\n      i += bytes;\n    }\n  }\n  return chars;\n}\n\n//è¾“å…¥å­—ç¬¦ä¸²ï¼Œè¾“å‡º input_ids å’Œ attention_mask\nstd::pair&lt;std::vector&lt;int64_t&gt;, std::vector&lt;int64_t&gt;&gt; Tokenize(\n    const std::string&amp; text, const std::unordered_map&lt;std::string, int&gt;&amp; vocab,\n    int maxLength = 512) {\n  if (maxLength &lt; 2) {\n    throw std::invalid_argument(\"maxLength must be at least 2\");\n  }\n\n  // é¢„å–ç‰¹æ®Š token ID\n  const int clsId = vocab.at(\"[CLS]\");\n  const int sepId = vocab.at(\"[SEP]\");\n  const int padId = vocab.at(\"[PAD]\");\n  const int unkId = vocab.at(\"[UNK]\");\n\n  // åˆå§‹åŒ–å‘é‡ï¼ˆè‡ªåŠ¨ paddingï¼‰\n  std::vector&lt;int64_t&gt; inputIds(maxLength, padId);\n  std::vector&lt;int64_t&gt; attentionMask(maxLength, 0);\n\n  //å¼€å¤´åŠ  \"[CLS]\"\n  size_t currentIndex = 0;\n  inputIds[currentIndex] = clsId;\n  attentionMask[currentIndex] = 1;\n  currentIndex++;\n\n  //ä¸­é—´æ¯ä¸ªå­—ä½œä¸ºä¸€ä¸ª tokenï¼ˆæŸ¥ vocab å¾— IDï¼‰\n  auto chars = SplitTextChars(text);\n  for (const auto&amp; ch : chars) {\n    if (currentIndex &gt;= maxLength - 1ULL) {\n      break;\n    }\n\n    const auto&amp; it = vocab.find(ch);\n    inputIds[currentIndex] = (it == vocab.end() ? unkId : it-&gt;second);\n    attentionMask[currentIndex] = 1;\n    currentIndex++;\n  }\n\n  //ç»“å°¾åŠ  \"[SEP]\"\n  inputIds[currentIndex] = sepId;\n  attentionMask[currentIndex] = 1;\n\n  return {inputIds, attentionMask};\n}\n\nvoid TestTokenize() {\n  string vocabPath = \"C:/Github/search/bge-small-zh-onnx/vocab.txt\";\n  string text = \"gitæ’¤å›æäº¤\";\n\n  auto vocab = LoadVocab(vocabPath);\n  const auto&amp; [inputIds, attMask] = Tokenize(text, vocab);\n\n  // æ‰“å°å‰10ä¸ª token ID éªŒè¯\n  cout &lt;&lt; \"Input IDs (first 10): \";\n  for (int i = 0; i &lt; 10; ++i) {\n    cout &lt;&lt; inputIds[i] &lt;&lt; \" \";\n  }\n\n  cout &lt;&lt; \"\\nAttention Mask (first 10): \";\n  for (int i = 0; i &lt; 10; ++i) {\n    cout &lt;&lt; attMask[i] &lt;&lt; \" \";\n  }\n\n  cout &lt;&lt; endl;\n}\n\nint main() {\n#ifdef _WIN32\n  SetConsoleOutputCP(65001);\n#endif\n\n  TestTokenize();\n\n  return 0;\n}\n</code></pre>\n<p>æ— è®ºæ˜¯åŸå§‹çš„ <code>bge-small-zh-v1.5</code> æ¨¡å‹ï¼Œè¿˜æ˜¯è½¬æ¢åçš„ ONNX ç‰ˆæœ¬ï¼Œå…¶è¯æ±‡è¡¨ <code>vocab.txt</code> çš„å†…å®¹å®Œå…¨ä¸€è‡´ã€‚æˆ‘ä»¬å¯ä»¥å°†è¾“å…¥æ–‡æœ¬åˆ‡åˆ†ä¸ºå•ä¸ªçš„ token å•å…ƒï¼Œå¹¶åœ¨ <code>vocab.txt</code> ä¸­æŸ¥æ‰¾åˆ°å¯¹åº”çš„ IDï¼Œå°±èƒ½ç”Ÿæˆä¸æˆ‘ä»¬æƒ³è¦åµŒå…¥çš„è¾“å…¥åºåˆ—ã€‚åœ¨è¿™ä¸ªç®€åŒ–å®ç°ä¸­ï¼Œä½¿ç”¨çš„æ‹†åˆ†ç­–ç•¥æ˜¯<strong>é€å­—åˆ‡åˆ†</strong>ï¼Œä¹Ÿå°±æ˜¯æŒ‰ UTF-8 å­—ç¬¦è¾¹ç•Œæ‹†åˆ†å­—ç¬¦ä¸²ã€‚</p>\n<p>æ­¤å¤–ï¼Œæ¨¡å‹ä½¿ç”¨äº†å››ä¸ªå…³é”®çš„ç‰¹æ®Š tokenï¼Œå®ƒä»¬åœ¨ <code>vocab.txt</code> å’Œ <code>special_tokens_map.json</code> ä¸­å‡æœ‰å®šä¹‰ï¼š</p>\n<ul>\n<li><code>[CLS]</code>ï¼šåºåˆ—èµ·å§‹æ ‡è®°ï¼Œå…¶å¯¹åº”ä½ç½®çš„è¾“å‡ºå‘é‡å¸¸ç”¨äºå¥å­çº§ embeddingï¼ˆBGE é»˜è®¤ä½¿ç”¨è¯¥å‘é‡ä½œä¸ºæ•´ä¸ªæ–‡æœ¬çš„è¡¨ç¤ºï¼‰ï¼›</li>\n<li><code>[SEP]</code>ï¼šåºåˆ—ç»“æŸæˆ–åˆ†éš”æ ‡è®°ï¼Œç”¨äºåŒºåˆ†ä¸åŒå¥å­ï¼ˆå•å¥è¾“å…¥æ—¶ç½®äºæœ«å°¾ï¼‰ï¼›</li>\n<li><code>[PAD]</code>ï¼šå¡«å……æ ‡è®°ï¼Œç”¨äºå¯¹é½ batch ä¸­ä¸åŒé•¿åº¦çš„åºåˆ—ï¼›</li>\n<li><code>[UNK]</code>ï¼šæœªçŸ¥è¯æ ‡è®°ï¼Œå½“è¾“å…¥ token ä¸åœ¨è¯æ±‡è¡¨ä¸­æ—¶ä½¿ç”¨ã€‚</li>\n</ul>\n<p>æœ€ç»ˆè¾“å‡ºçš„ç»“æœæ˜¯ï¼š</p>\n<pre><code class=\"language-text\">Input IDs (first 10): 101 149 151 162 3059 1726 2990 769 102 0\nAttention Mask (first 10): 1 1 1 1 1 1 1 1 1 0\n</code></pre>\n<p>æˆ‘ä»¬å¯ä»¥æ‰“å¼€ <code>vocab.txt</code> è¿›è¡Œå¯¹ç…§ï¼Œæ¯”å¦‚æœ€åä¸€ä¸ªæ±‰å­—â€œäº¤â€ï¼Œä½äºæ–‡æœ¬çš„ç¬¬770è¡Œï¼Œè¯´æ˜æ‹†åˆ†çš„ token æ˜¯æ­£ç¡®çš„ï¼ˆå¯¹åº” ID æ˜¯769ï¼‰ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>\n<p><img alt=\"åœ¨è¯æ±‡è¡¨ä¸­æ£€æŸ¥åˆ†è¯å™¨æ‹†åˆ†çš„ç»“æœ\" class=\"lazyload\" /></p>\n<p>å¦ä¸€ä¸ªè¾“å‡ºç»“æœ Attention Maskï¼ˆæ³¨æ„åŠ›æ©ç ï¼‰ æ˜¯ Transformer ç±»æ¨¡å‹ï¼ˆåŒ…æ‹¬ BGEï¼‰ä¸­ä¸€ä¸ªå…³é”®çš„è¾“å…¥å¼ é‡ï¼Œå®ƒçš„ä½œç”¨æ˜¯å‘Šè¯‰æ¨¡å‹ï¼šâ€œå“ªäº› token æ˜¯çœŸå®å†…å®¹ï¼Œå“ªäº›æ˜¯å¡«å……ï¼ˆpaddingï¼‰â€ã€‚</p>\n<h2 id=\"42-hugging-face-tokenizer\">4.2 Hugging Face Tokenizer</h2>\n<p>ä¸Šè¿°çš„ä¾‹å­åªæ˜¯æ¼”ç¤ºåˆ†è¯å™¨çš„åŸºæœ¬æµç¨‹ï¼Œå¦‚æœå¯¹ç…§åˆ†è¯å™¨çš„è¯æ±‡è¡¨ï¼Œæµ‹è¯•æ–‡æœ¬â€œgitæ’¤å›æäº¤â€åœ¨ä¸Šè¿°åˆ†è¯å™¨çš„ç»“æœæ˜¯ï¼š</p>\n<pre><code class=\"language-cpp\">['g', 'i', 't', 'æ’¤', 'å›', 'æ', 'äº¤']\n</code></pre>\n<p>ä½†æ˜¯ï¼Œæˆ‘ä»¬å¸Œæœ›çš„åˆ†è¯ç»“æœæ˜¯ï¼š</p>\n<pre><code class=\"language-cpp\">['git', 'æ’¤', 'å›', 'æ', 'äº¤']\n</code></pre>\n<p>è¿™è¯´æ˜ç®€å•çš„ UTF-8 å­—ç¬¦åˆ‡åˆ†æ— æ³•å¤ç°æ¨¡å‹è®­ç»ƒæ—¶çš„çœŸå®åˆ†è¯è¡Œä¸ºï¼Œä¼šå¯¼è‡´ embedding è´¨é‡ä¸‹é™ï¼Œå°¤å…¶åœ¨æ··åˆä¸­è‹±æ–‡çš„åšå®¢åœºæ™¯å¯èƒ½ä¼šé€ æˆä¸å°çš„å½±å“ã€‚å®é™…ä¸Šä¸€ä¸ªå·¥ä¸šçº§çš„åˆ†è¯å™¨è¿œæ¯”â€œé€å­—åˆ‡åˆ†â€å¤æ‚å¾—å¤šï¼Œä¸€ä¸ªå…³é”®çš„é—®é¢˜å°±æ˜¯éœ€è¦åœ¨å¥å­ä¸­é¢„åˆ‡åˆ†ç‰‡æ®µï¼Œä½¿ç”¨<strong>WordPiece ç®—æ³•</strong>è´ªå¿ƒåŒ¹é…å­è¯ã€‚</p>\n<p>é¢å¯¹å¦‚æ­¤å¤æ‚çš„åˆ†è¯é€»è¾‘ï¼Œä»é›¶å®ç°ä¸€ä¸ªå®Œå…¨å…¼å®¹ WordPiece çš„ tokenizer ä¸ä»…è€—æ—¶ï¼Œè¿˜ææ˜“å¼•å…¥ç»†å¾®åå·®â€”â€”è€Œè¿™äº›åå·®ä¼šç›´æ¥å¯¼è‡´ embedding å‘é‡åç¦»é¢„æœŸï¼Œæœ€ç»ˆå½±å“æœç´¢è´¨é‡ã€‚å¥½åœ¨ï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦é‡å¤é€ è½®å­ã€‚</p>\n<p>Hugging Face Tokenizer æ˜¯å½“å‰ NLP é¢†åŸŸäº‹å®ä¸Šçš„å·¥ä¸šæ ‡å‡†ã€‚å®ƒç”± Hugging Face å®˜æ–¹ç»´æŠ¤ï¼Œé«˜åº¦ä¼˜åŒ–ã€è·¨è¯­è¨€æ”¯æŒã€ä¸”ä¸ transformers ç”Ÿæ€æ— ç¼é›†æˆã€‚å› æ­¤ï¼Œæœ€å¥½ä½¿ç”¨è¿™ä¸ªåˆ†è¯å™¨çš„å®˜æ–¹å®ç°ï¼Œç¡®ä¿è¾“å…¥åºåˆ—ä¸æ¨¡å‹è®­ç»ƒæ—¶å®Œå…¨å¯¹é½ï¼Œä»è€Œé‡Šæ”¾ BGE æ¨¡å‹çš„å…¨éƒ¨è¯­ä¹‰èƒ½åŠ›ã€‚</p>\n<p>ä¸è¿‡ï¼Œéº»çƒ¦çš„æ˜¯ Hugging Face Tokenizer æ˜¯ä½¿ç”¨ Rust å®ç°çš„ï¼Œå¹¶ä¸”å®˜æ–¹åªæä¾›äº† Python å’Œ node çš„ç»‘å®šå®ç°ã€‚è¦é›†æˆåˆ° C++ ç¨‹åºä¸­ï¼Œæœ€å¥½çš„åŠæ³•å°±æ˜¯è‡ªå·±å°è£… Hugging Face tokenizers çš„ C ç»‘å®šã€‚å½“ç„¶ä¹Ÿä¸æ˜¯å°è£…æ‰€æœ‰çš„ FFIï¼ˆForeign Function Interfaceï¼‰æ¥å£ï¼Œè€Œæ˜¯å°è£…è‡ªå·±éœ€è¦çš„æ¥å£å°±å¯ä»¥äº†ã€‚æ¯”å¦‚æ‰§è¡Œåˆ†è¯æ¥å£å’Œè®¡ç®—Tokençš„æ¥å£ï¼š</p>\n<pre><code class=\"language-rust\">use std::ffi::CStr;\nuse std::os::raw::c_char;\nuse tokenizers::{PaddingParams, Tokenizer, TruncationParams};\n\n// === 1. å®šä¹‰ C å…¼å®¹çš„è¿”å›ç»“æ„ä½“ ===\n#[repr(C)]\npub struct TokenizerResult {\n    pub input_ids: *mut i64,\n    pub attention_mask: *mut i64,\n    pub token_type_ids: *mut i64,\n    pub length: u64,\n}\n\n// === 2. å†…éƒ¨çŠ¶æ€ï¼šåŒ…è£… Tokenizer ===\nstruct TokenizerHandle {\n    tokenizer: Tokenizer,     // ç”¨äº encodeï¼ˆå¸¦ paddingï¼‰\n    raw_tokenizer: Tokenizer, // ç”¨äº countï¼ˆæ—  paddingï¼‰\n}\n\n// === 3. è¾…åŠ©å‡½æ•°ï¼šå°† Rust Vec è½¬ä¸º C å¯æ‹¥æœ‰çš„æŒ‡é’ˆ ===\nfn vec_to_c_ptr(vec: Vec&lt;i64&gt;) -&gt; *mut i64 {\n    let mut boxed = vec.into_boxed_slice();\n    let ptr = boxed.as_mut_ptr();\n    std::mem::forget(boxed); // é˜²æ­¢ Rust è‡ªåŠ¨é‡Šæ”¾\n    ptr\n}\n\n// === 4. åˆ›å»º tokenizer ===\n#[unsafe(no_mangle)] // ç¦ç”¨ name manglingï¼Œè®© C èƒ½æ‰¾åˆ°ç¬¦å·\npub extern \"C\" fn tokenizer_create(tokenizer_json_path: *const c_char) -&gt; *mut std::ffi::c_void {\n    if tokenizer_json_path.is_null() {\n        return std::ptr::null_mut();\n    }\n\n    let path_cstr = unsafe { CStr::from_ptr(tokenizer_json_path) };\n    let path_str = match path_cstr.to_str() {\n        Ok(s) =&gt; s,\n        Err(_) =&gt; return std::ptr::null_mut(),\n    };\n\n    let mut tokenizer = match Tokenizer::from_file(path_str) {\n        Ok(t) =&gt; t,\n        Err(_) =&gt; return std::ptr::null_mut(),\n    };\n\n    // è®¾ç½® padding/truncation åˆ° 512ï¼ˆBGE é»˜è®¤ï¼‰\n    tokenizer.with_padding(Some(PaddingParams {\n        strategy: tokenizers::PaddingStrategy::Fixed(512),\n        ..Default::default()\n    }));\n\n    if tokenizer\n        .with_truncation(Some(TruncationParams {\n            max_length: 512,\n            ..Default::default()\n        }))\n        .is_err()\n    {\n        return std::ptr::null_mut();\n    }\n\n    let mut raw_tokenizer = tokenizer.clone();\n    raw_tokenizer.with_padding(None);\n    raw_tokenizer.with_truncation(None).ok();\n\n    let handle = TokenizerHandle {\n        tokenizer,\n        raw_tokenizer,\n    };\n    Box::into_raw(Box::new(handle)) as *mut std::ffi::c_void\n}\n\n//è®¡ç®—å¥å­token\n#[unsafe(no_mangle)] // ç¦ç”¨ name manglingï¼Œè®© C èƒ½æ‰¾åˆ°ç¬¦å·\npub extern \"C\" fn tokenizer_count(handle: *mut std::ffi::c_void, text: *const c_char) -&gt; u64 {\n    if handle.is_null() || text.is_null() {\n        return 0;\n    }\n\n    let handle_ref = unsafe { &amp;*(handle as *mut TokenizerHandle) };\n\n    let text_cstr = unsafe { CStr::from_ptr(text) };\n    let text_str = match text_cstr.to_str() {\n        Ok(s) =&gt; s,\n        Err(_) =&gt; return 0,\n    };\n\n    match handle_ref.raw_tokenizer.encode(text_str, true) {\n        Ok(encoding) =&gt; encoding.len() as u64,\n        Err(_) =&gt; 0,\n    }\n}\n\n// === 5. é”€æ¯ tokenizer ===\n#[unsafe(no_mangle)]\npub extern \"C\" fn tokenizer_destroy(handle: *mut std::ffi::c_void) {\n    if !handle.is_null() {\n        unsafe {\n            let _ = Box::from_raw(handle as *mut TokenizerHandle);\n            // Drop è‡ªåŠ¨è°ƒç”¨\n        }\n    }\n}\n\n// === 6. æ‰§è¡Œåˆ†è¯ ===\n#[unsafe(no_mangle)]\npub extern \"C\" fn tokenizer_encode(\n    handle: *mut std::ffi::c_void,\n    text: *const c_char,\n) -&gt; TokenizerResult {\n    let default_result = TokenizerResult {\n        input_ids: std::ptr::null_mut(),\n        attention_mask: std::ptr::null_mut(),\n        token_type_ids: std::ptr::null_mut(),\n        length: 0,\n    };\n\n    if handle.is_null() || text.is_null() {\n        return default_result;\n    }\n\n    let handle_ref = unsafe { &amp;*(handle as *mut TokenizerHandle) };\n\n    let text_cstr = unsafe { CStr::from_ptr(text) };\n    let text_str = match text_cstr.to_str() {\n        Ok(s) =&gt; s,\n        Err(_) =&gt; return default_result,\n    };\n\n    let encoding = match handle_ref.tokenizer.encode(text_str, true) {\n        Ok(e) =&gt; e,\n        Err(_) =&gt; return default_result,\n    };\n\n    let input_ids: Vec&lt;i64&gt; = encoding.get_ids().iter().map(|&amp;x| x as i64).collect();\n    let attention_mask: Vec&lt;i64&gt; = encoding\n        .get_attention_mask()\n        .iter()\n        .map(|&amp;x| x as i64)\n        .collect();\n    let token_type_ids: Vec&lt;i64&gt; = encoding.get_type_ids().iter().map(|&amp;x| x as i64).collect();\n    // BGE ä¸éœ€è¦ï¼Œä½† C++ ä»£ç ä¼ äº†\n    // let token_type_ids: Vec&lt;u32&gt; = vec![0u32; input_ids.len()];\n\n    let len = input_ids.len(); // åº”è¯¥æ˜¯ 512ï¼Œä½†æ›´é€šç”¨\n\n    TokenizerResult {\n        input_ids: vec_to_c_ptr(input_ids),\n        attention_mask: vec_to_c_ptr(attention_mask),\n        token_type_ids: vec_to_c_ptr(token_type_ids),\n        length: len as u64,\n    }\n}\n\n// === 7. é‡Šæ”¾ç»“æœå†…å­˜ ===\n#[unsafe(no_mangle)]\npub extern \"C\" fn tokenizer_result_free(result: TokenizerResult) {\n    if !result.input_ids.is_null() {\n        unsafe {\n            let _ = Vec::from_raw_parts(\n                result.input_ids,\n                result.length as usize,\n                result.length as usize,\n            );\n        }\n    }\n\n    if !result.attention_mask.is_null() {\n        unsafe {\n            let _ = Vec::from_raw_parts(\n                result.attention_mask,\n                result.length as usize,\n                result.length as usize,\n            );\n        }\n    }\n\n    if !result.token_type_ids.is_null() {\n        unsafe {\n            let _ = Vec::from_raw_parts(\n                result.token_type_ids,\n                result.length as usize,\n                result.length as usize,\n            );\n        }\n    }\n}\n</code></pre>\n<p>å¯¹åº”çš„ C æ¥å£å¦‚ä¸‹ï¼š</p>\n<pre><code class=\"language-cpp\">// tokenizer_result.h\n#pragma once\n\n#include &lt;stdint.h&gt;\n\n// å®šä¹‰ç»“æ„ä½“\nstruct TokenizerResult {\n    int64_t* input_ids;\n    int64_t* attention_mask;\n    int64_t* token_type_ids;\n    uint64_t length;\n};\n\ntypedef struct TokenizerResult TokenizerResult;\n</code></pre>\n<pre><code class=\"language-cpp\">// hf_tokenizer_ffi\n#pragma once\n\n#include \"tokenizer_result.h\"\n\n#ifdef __cplusplus\nextern \"C\" {\n#endif\n\nvoid* tokenizer_create(const char* tokenizer_json_path);\nvoid tokenizer_destroy(void* handle);\nTokenizerResult tokenizer_encode(void* handle, const char* text);\nuint64_t tokenizer_count(void* handle, const char* text);\nvoid tokenizer_result_free(TokenizerResult result);\n\n#ifdef __cplusplus\n}\n#endif\n</code></pre>\n<p>æˆ‘ä»¬åœ¨ C++ ç¨‹åºä¸­è°ƒç”¨è¿™ä¸ª C ç»‘å®šçš„æ¥å£ï¼š</p>\n<pre><code class=\"language-cpp\">#include &lt;hf_tokenizer_ffi.h&gt;\n\n#include &lt;string&gt;\n#include &lt;vector&gt;\n\n#ifdef _WIN32\n#include &lt;Windows.h&gt;\n#endif\n\nusing namespace std;\n\nvoid TestTokenize() {\n  void* handle =\n      tokenizer_create(\"C:/Github/search/bge-small-zh-onnx/tokenizer.json\");\n\n  if (!handle) {\n    std::cerr &lt;&lt; \"Failed to create tokenizer\\n\";\n    return;\n  }\n\n  TokenizerResult result = tokenizer_encode(handle, \"gitæ’¤å›æäº¤\");\n\n  if (!result.input_ids) {\n    std::cerr &lt;&lt; \"Tokenize failed\\n\";\n    tokenizer_destroy(handle);\n    return;\n  }\n\n  std::cout &lt;&lt; \"Length: \" &lt;&lt; result.length &lt;&lt; \"\\n\";\n  for (int i = 0; i &lt; 10; ++i) {\n    std::cout &lt;&lt; result.input_ids[i] &lt;&lt; \" \";\n  }\n  std::cout &lt;&lt; \"\\n\";\n\n  // å¿…é¡»é‡Šæ”¾ï¼\n  tokenizer_result_free(result);\n  tokenizer_destroy(handle);\n\n  return;\n}\n\nint main() {\n#ifdef _WIN32\n  SetConsoleOutputCP(65001);\n#endif\n\n  TestTokenize();\n\n  return 0;\n}\n</code></pre>\n<p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p>\n<pre><code>Length: 512\n101 10807 3059 1726 2990 769 102 0 0 0\n</code></pre>\n<p>å¾ˆæ˜¾ç„¶ï¼Œè¿”å›çš„å‰10ä¸ª ID å€¼ä¸­æœ‰æ•ˆ ID å°‘äº†ä¸¤ä¸ªã€‚å†æ£€æŸ¥ä¸€ä¸‹ç¬¬ä¸€ä¸ª token ä¹Ÿå°±æ˜¯ç¬¬10808è¡Œï¼ˆå¯¹åº” ID 10807ï¼‰çš„è¯æ±‡ï¼š</p>\n<p><img alt=\"åœ¨è¯æ±‡è¡¨ä¸­æ£€æŸ¥åˆ†è¯å™¨æ‹†åˆ†çš„ç»“æœ\" class=\"lazyload\" /></p>\n<p>æ­£å¥½æ˜¯â€œgitâ€ï¼Œè¯´æ˜åˆ†è¯å™¨æ­£ç¡®æ‹†åˆ†äº†å­è¯ã€‚</p>\n<p>éªŒè¯äº†æ­£ç¡®æ€§ï¼Œå°±è¦ä¿è¯å®‰å…¨æ€§ã€‚è™½ç„¶åœ¨ C++ ç¨‹åºä¸­å¯ä»¥è¿™æ ·ä½¿ç”¨ C æ¥å£ï¼Œä½†æ˜¯æ›´åŠ å®‰å…¨é«˜æ•ˆçš„ä½¿ç”¨æ–¹å¼æ˜¯ä½¿ç”¨ RAII åŸåˆ™è¿›è¡Œå°è£…ã€‚è¿™ä¸€ç‚¹ç¬”è€…çš„æ–‡ç« <a href=\"https://charlee44.com/post.html?id=62bdd64be665488fa0c33abc399176e7\" rel=\"noopener nofollow\" target=\"_blank\">ã€ŠC++ å°è£… C FFI æ¥å£æœ€ä½³å®è·µï¼šä»¥ Hugging Face Tokenizer ä¸ºä¾‹ã€‹</a>æœ‰è¿‡ç›¸å…³çš„è®ºè¿°ã€‚è¿™é‡Œç›´æ¥æ”¾å‡ºå°è£…å¥½çš„ç»“æœï¼š</p>\n<pre><code class=\"language-cpp\">// HfTokenizer.h\n#pragma once\n\n#include &lt;tokenizer_result.h&gt;\n\n#include &lt;memory&gt;\n#include &lt;string&gt;\n\nnamespace embedding {\n\nnamespace hf {\nclass Tokenizer {\n public:\n  explicit Tokenizer(const std::string&amp; path);\n\n  // ç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆï¼š\n  // - ææ„å‡½æ•°ï¼ˆè°ƒç”¨ Deleterï¼‰\n  // - ç§»åŠ¨æ„é€  / ç§»åŠ¨èµ‹å€¼\n  // - ç¦æ­¢æ‹·è´ï¼ˆå› ä¸º unique_ptr ä¸å¯æ‹·è´ï¼‰\n\n  // å…¶ä»–æ¥å£æ–¹æ³•\n  uint64_t Count(const std::string&amp; text) const;\n\n  // å‘é‡åŒ–\n  using ResultPtr =\n      std::unique_ptr&lt;TokenizerResult, void (*)(TokenizerResult*)&gt;;\n  ResultPtr Encode(const std::string&amp; text) const;\n\n private:\n  std::unique_ptr&lt;void, void (*)(void*)&gt; handle;\n};\n\n}  // namespace hf\n\n}  // namespace embedding\n</code></pre>\n<pre><code class=\"language-cpp\">// HfTokenizer.cpp\n#include \"HfTokenizer.h\"\n\n#include &lt;hf_tokenizer_ffi.h&gt;\n\n#include &lt;stdexcept&gt;\n\n#ifdef __cplusplus\nstatic_assert(std::is_standard_layout_v&lt;TokenizerResult&gt; &amp;&amp;\n                  std::is_trivially_copyable_v&lt;TokenizerResult&gt;,\n              \"TokenizerResult must be C ABI compatible\");\n#endif\n\nnamespace embedding {\n\nnamespace hf {\n\nstatic void HandleDeleter(void* handle) noexcept {\n  if (handle) {\n    tokenizer_destroy(handle);\n  }\n}\n\nstatic void ResultDeleter(TokenizerResult* p) noexcept {\n  if (p) {\n    tokenizer_result_free(*p);\n    delete p;\n  }\n}\n\nTokenizer::Tokenizer(const std::string&amp; path)\n    : handle(tokenizer_create(path.c_str()), HandleDeleter) {\n  if (!handle) {\n    throw std::runtime_error(\"Failed to create tokenizer from \" + path);\n  }\n}\n\nuint64_t Tokenizer::Count(const std::string&amp; text) const {\n  return tokenizer_count(handle.get(), text.c_str());\n}\n\nTokenizer::ResultPtr Tokenizer::Encode(const std::string&amp; text) const {\n  auto result = std::make_unique&lt;TokenizerResult&gt;(\n      tokenizer_encode(handle.get(), text.c_str()));\n  return {result.release(), ResultDeleter};\n  // TokenizerResult raw = tokenizer_encode(handle.get(), text.c_str());\n  // return {new TokenizerResult(std::move(raw)), ResultDeleter};\n};\n\n}  // namespace hf\n\n}  // namespace embedding\n</code></pre>\n<h1 id=\"5-åµŒå…¥å™¨\">5. åµŒå…¥å™¨</h1>\n<p>åœ¨è§£å†³äº†åˆ†è¯å™¨çš„é—®é¢˜ä¹‹åï¼Œå°±å¯ä»¥å¼€å§‹å®ç°å¥å­åµŒå…¥çš„åŠŸèƒ½äº†ã€‚å¦‚å‰æ–‡æåˆ°çš„ï¼Œè¯¥åŠŸèƒ½å¯ä»¥å¼•å…¥ ONNX Runtime ç»„ä»¶æ¥å®ç°ã€‚ä¸ºäº†æ–¹ä¾¿è¿›ä¸€æ­¥ä½¿ç”¨ï¼Œæˆ‘ä»¬å°†è¿™ä¸ªåŠŸèƒ½å°è£…ä¸ºåµŒå…¥å™¨ï¼š</p>\n<pre><code class=\"language-cpp\">// BgeOnnxEmbedder.h\n#pragma once\n\n#include &lt;memory&gt;\n#include &lt;string&gt;\n#include &lt;vector&gt;\n\nnamespace embedding {\n\nnamespace hf {\nclass Tokenizer;\n}\n\nclass BgeOnnxEmbedder {\n public:\n  explicit BgeOnnxEmbedder(const std::string&amp; modelPath,\n                           const hf::Tokenizer&amp; tokenizer);\n  ~BgeOnnxEmbedder();\n\n  const int64_t&amp; EmbeddingDim() const;\n\n  std::vector&lt;float&gt; Embed(const std::string&amp; text) const;\n\n private:\n  class Impl;  // å‰å‘å£°æ˜\n  std::unique_ptr&lt;Impl&gt; impl;\n};\n\n}  // namespace embedding\n</code></pre>\n<pre><code class=\"language-cpp\">// BgeOnnxEmbedder.cpp\n#include \"BgeOnnxEmbedder.h\"\n\n#include &lt;onnxruntime_cxx_api.h&gt;\n\n#include \"HfTokenizer.h\"\n#include \"Util/StringEncode.h\"\n\nnamespace embedding {\n\nclass BgeOnnxEmbedder::Impl {\n public:\n  Ort::Env&amp; GetOrtEnv() {\n    static Ort::Env env(ORT_LOGGING_LEVEL_WARNING, \"BgeOnnxEmbedder\");\n    return env;\n  }\n\n  const int64_t&amp; EmbeddingDim() const { return embeddingDim; }\n\n  explicit Impl(const std::string&amp; modelPath, const hf::Tokenizer&amp; tokenizer)\n      : session{GetOrtEnv(),\n#ifdef _WIN32\n                util::StringEncode::Utf8StringToWideString(modelPath).c_str(),\n#else\n                modelPath.c_str(),\n#endif\n                Ort::SessionOptions()},\n        memInfo{Ort::MemoryInfo::CreateCpu(OrtDeviceAllocator, OrtMemTypeCPU)},\n        tokenizer(tokenizer),\n        embeddingDim(0) {\n\n    //\n    const auto&amp; outputInfo = session.GetOutputTypeInfo(0);\n    const auto&amp; tensorInfo = outputInfo.GetTensorTypeAndShapeInfo();\n    const auto&amp; shape = tensorInfo.GetShape();\n\n    // å‡è®¾è¾“å‡ºæ˜¯ [batch, seq, dim] æˆ– [batch, dim]\n    // æˆ‘ä»¬å–æœ€åä¸€ä¸ªé -1 çš„ç»´åº¦\n    for (auto it = shape.rbegin(); it != shape.rend(); ++it) {\n      if (*it != -1) {\n        embeddingDim = *it;\n        break;\n      }\n    }\n\n    if (embeddingDim == 0) {\n      throw std::runtime_error(\n          \"Failed to infer embedding dimension from ONNX model.\");\n    }\n  }\n\n  std::vector&lt;float&gt; Embed(const std::string&amp; text) const {\n    hf::Tokenizer::ResultPtr result = tokenizer.Encode(text);\n    if (!result) {\n      throw std::runtime_error(\"tokenizer_encode failed\");\n    }\n\n    // å®šä¹‰å¼ é‡ç»´åº¦\n    int64_t seqLen = static_cast&lt;int64_t&gt;(result-&gt;length);\n    std::vector&lt;int64_t&gt; inputShape = {1, seqLen};\n    size_t dataByteCount = sizeof(int64_t) * seqLen;\n\n    Ort::Value inputIdsTensor = Ort::Value::CreateTensor(\n        memInfo.GetConst(), result-&gt;input_ids, dataByteCount, inputShape.data(),\n        inputShape.size(),\n        ONNXTensorElementDataType::ONNX_TENSOR_ELEMENT_DATA_TYPE_INT64);\n\n    Ort::Value attentionMaskTensor = Ort::Value::CreateTensor(\n        memInfo.GetConst(), result-&gt;attention_mask, dataByteCount,\n        inputShape.data(), inputShape.size(),\n        ONNXTensorElementDataType::ONNX_TENSOR_ELEMENT_DATA_TYPE_INT64);\n\n    Ort::Value tokenTypeIdsTensor = Ort::Value::CreateTensor(\n        memInfo.GetConst(), result-&gt;token_type_ids, dataByteCount,\n        inputShape.data(), inputShape.size(),\n        ONNXTensorElementDataType::ONNX_TENSOR_ELEMENT_DATA_TYPE_INT64);\n\n    // è¾“å…¥åå¿…é¡»ä¸æ¨¡å‹å®šä¹‰ä¸€è‡´\n    const char* inputNames[] = {\"input_ids\", \"attention_mask\",\n                                \"token_type_ids\"};\n    const char* outputNames[] = {\"last_hidden_state\"};\n\n    // æŠŠä¸‰ä¸ªè¾“å…¥å¼ é‡æ”¾è¿›æ•°ç»„\n    std::vector&lt;Ort::Value&gt; inputs;\n    inputs.push_back(std::move(inputIdsTensor));\n    inputs.push_back(std::move(attentionMaskTensor));\n    inputs.push_back(std::move(tokenTypeIdsTensor));\n\n    // æ‰§è¡Œæ¨ç†\n    auto outputs = session.Run(Ort::RunOptions(),  // è¿è¡Œé€‰é¡¹ï¼ˆé€šå¸¸ nullptrï¼‰\n                               inputNames,         // è¾“å…¥åæ•°ç»„\n                               inputs.data(),  // è¾“å…¥å¼ é‡æ•°ç»„\n                               inputs.size(),  // è¾“å…¥æ•°é‡ï¼ˆ3ï¼‰\n                               outputNames,    // è¾“å‡ºåæ•°ç»„\n                               1               // è¾“å‡ºæ•°é‡ï¼ˆ1ï¼‰\n    );\n\n    // è·å–è¾“å‡ºä¿¡æ¯\n    auto&amp; output_tensor = outputs[0];\n    auto output_shape = output_tensor.GetTensorTypeAndShapeInfo().GetShape();\n    if (output_shape.size() != 3 || output_shape[0] != 1) {\n      throw std::runtime_error(\"Unexpected output shape\");\n    }\n\n    // è·å–è¾“å‡ºå¼ é‡çš„åŸå§‹ float æŒ‡é’ˆ\n    const float* outputData = outputs[0].GetTensorData&lt;float&gt;();\n\n    // æå– [CLS] token çš„ embeddingï¼ˆç¬¬0ä¸ªtokenï¼‰\n    int64_t hiddenSize = output_shape[2];\n    std::vector&lt;float&gt; embedding(outputData, outputData + hiddenSize);\n\n    // L2 å½’ä¸€åŒ–ï¼ˆBGE è¦æ±‚ï¼‰\n    float norm = 0.0f;\n    for (float v : embedding) norm += v * v;\n    norm = std::sqrt(norm);\n    if (norm &gt; 1e-8) {\n      for (float&amp; v : embedding) v /= norm;\n    }\n\n    return embedding;\n  }\n\n private:\n  mutable Ort::Session session;\n  Ort::MemoryInfo memInfo;\n  const hf::Tokenizer&amp; tokenizer;\n  int64_t embeddingDim;\n};\n\nBgeOnnxEmbedder::BgeOnnxEmbedder(const std::string&amp; modelPath,\n                                 const hf::Tokenizer&amp; tokenizer)\n    : impl(std::make_unique&lt;Impl&gt;(modelPath, tokenizer)) {}\n\nBgeOnnxEmbedder::~BgeOnnxEmbedder() = default;  // æ­¤æ—¶ Impl å·²å®šä¹‰ï¼Œå¯å®‰å…¨ææ„\n\nconst int64_t&amp; BgeOnnxEmbedder::EmbeddingDim() const {\n  return impl-&gt;EmbeddingDim();\n}\n\nstd::vector&lt;float&gt; BgeOnnxEmbedder::Embed(const std::string&amp; text) const {\n  return impl-&gt;Embed(text);\n}\n\n}  // namespace embedding\n</code></pre>\n<p>åœ¨è°ƒç”¨ ONNX Runtime æ‰§è¡Œæ¨ç†ä¹‹å‰ï¼Œæˆ‘ä»¬å¿…é¡»å°†åˆ†è¯å™¨è¾“å‡ºçš„åŸå§‹ token åºåˆ—è½¬æ¢ä¸ºæ¨¡å‹èƒ½å¤Ÿç†è§£çš„å¼ é‡ï¼ˆTensorï¼‰æ ¼å¼ã€‚è¿™æ­£æ˜¯ <code>inputIdsTensor</code>ã€<code>attentionMaskTensor</code> å’Œ <code>tokenTypeIdsTensor</code> ä¸‰ä¸ªå¼ é‡çš„ç”±æ¥â€”â€”å®ƒä»¬å…±åŒæ„æˆäº† Transformer æ¨¡å‹çš„æ ‡å‡†è¾“å…¥ä¸‰å…ƒç»„ã€‚</p>\n<ul>\n<li><strong><code>input_ids</code></strong>ï¼ˆå¯¹åº” <code>inputIdsTensor</code>ï¼‰ï¼š<br />\nè¿™æ˜¯æœ€æ ¸å¿ƒçš„è¾“å…¥ï¼Œè¡¨ç¤ºæ–‡æœ¬ç»è¿‡åˆ†è¯åå¾—åˆ°çš„ token ID åºåˆ—ã€‚æ¯ä¸ª ID æ˜¯è¯æ±‡è¡¨ï¼ˆ<code>vocab.txt</code>ï¼‰ä¸­çš„ç´¢å¼•ï¼Œæ¨¡å‹é€šè¿‡åµŒå…¥å±‚ï¼ˆEmbedding Layerï¼‰å°†å…¶æ˜ å°„ä¸ºç¨ å¯†å‘é‡ã€‚ä¾‹å¦‚ï¼Œå¥å­ â€œgitæ’¤å›æäº¤â€ ç» Hugging Face åˆ†è¯å™¨å¤„ç†åï¼Œä¼šå˜æˆ <code>[101, 10807, 3059, 1726, 2990, 769, 102, 0, 0, ...]</code>ï¼Œå…¶ä¸­ <code>101</code> æ˜¯ <code>[CLS]</code>ï¼Œ<code>102</code> æ˜¯ <code>[SEP]</code>ï¼Œå…¶ä½™ä¸ºå®é™…å†…å®¹æˆ–å¡«å……ï¼ˆ<code>[PAD]</code>ï¼ŒID=0ï¼‰ã€‚è¿™ä¸ªåºåˆ—è¢«ç»„ç»‡æˆå½¢çŠ¶ä¸º <code>(1, seq_len)</code> çš„äºŒç»´å¼ é‡ï¼ˆbatch_size=1ï¼‰ï¼Œä½œä¸ºæ¨¡å‹çš„ä¸»è¾“å…¥ã€‚</li>\n<li><strong><code>attention_mask</code></strong>ï¼ˆå¯¹åº” <code>attentionMaskTensor</code>ï¼‰<br />\nç”±äº BGE æ¨¡å‹è¦æ±‚æ‰€æœ‰è¾“å…¥åºåˆ—é•¿åº¦å¯¹é½ï¼ˆæ­¤å¤„å›ºå®šä¸º 512ï¼‰ï¼ŒçŸ­æ–‡æœ¬ä¼šè¢« <code>[PAD]</code> å¡«å……ã€‚ä½†æ¨¡å‹ä¸åº”â€œå…³æ³¨â€è¿™äº›æ— æ„ä¹‰çš„å¡«å……ä½ç½®ã€‚<code>attention_mask</code> å°±æ˜¯ä¸€ä¸ªäºŒå€¼æ©ç ï¼šçœŸå® token å¯¹åº” <code>1</code>ï¼Œå¡«å……éƒ¨åˆ†å¯¹åº” <code>0</code>ã€‚Transformer çš„è‡ªæ³¨æ„åŠ›æœºåˆ¶ä¼šåˆ©ç”¨è¯¥æ©ç ï¼Œåœ¨è®¡ç®—æ³¨æ„åŠ›æƒé‡æ—¶è‡ªåŠ¨å¿½ç•¥ <code>[PAD]</code>ï¼Œä»è€Œé¿å…å™ªå£°å¹²æ‰°è¯­ä¹‰è¡¨ç¤ºã€‚</li>\n<li><strong><code>token_type_ids</code></strong>ï¼ˆå¯¹åº” <code>tokenTypeIdsTensor</code>ï¼‰<br />\nè¯¥è¾“å…¥ä¸»è¦ç”¨äºåŒºåˆ†å¥å­å¯¹ä»»åŠ¡ï¼ˆå¦‚é—®ç­”ã€å¥å­ç›¸ä¼¼åº¦åˆ¤æ–­ï¼‰ï¼Œä¾‹å¦‚ <code>[Aå¥][SEP][Bå¥]</code> ä¸­ A å’Œ B åˆ†å±ä¸åŒ segmentã€‚ä½†åœ¨å•å¥åµŒå…¥åœºæ™¯ï¼ˆå¦‚æˆ‘ä»¬çš„åšå®¢æœç´¢ï¼‰ä¸­ï¼Œæ•´ä¸ªè¾“å…¥åªåŒ…å«ä¸€ä¸ªå¥å­ï¼Œå› æ­¤æ‰€æœ‰æœ‰æ•ˆ token çš„ <code>token_type_id</code> å‡ä¸º <code>0</code>ã€‚å°½ç®¡ BGE æ¨¡å‹åœ¨è®­ç»ƒæ—¶å¯èƒ½ä½¿ç”¨äº†è¯¥å­—æ®µï¼Œä½†åœ¨æ¨ç†é˜¶æ®µå³ä½¿ä¼ å…¥å…¨é›¶å‘é‡ï¼Œä¹Ÿä¸ä¼šå½±å“ <code>[CLS]</code> è¡¨ç¤ºçš„è´¨é‡ã€‚å‡ºäºæ¥å£å…¼å®¹æ€§è€ƒè™‘ï¼Œæˆ‘ä»¬ä»æŒ‰è§„èŒƒæä¾›æ­¤å¼ é‡ã€‚</li>\n</ul>\n<p>è¿™ä¸‰ä¸ªå¼ é‡é€šè¿‡ ONNX Runtime çš„ C++ API è¢«å°è£…ä¸º <code>Ort::Value</code> å¯¹è±¡ï¼Œå¹¶ä»¥åç§°åŒ¹é…çš„æ–¹å¼ä¼ å…¥æ¨¡å‹ã€‚ONNX æ¨¡å‹å†…éƒ¨ä¼šæ ¹æ® <code>config.json</code> ä¸­å®šä¹‰çš„è¾“å…¥èŠ‚ç‚¹åï¼ˆé€šå¸¸ä¸º <code>\"input_ids\"</code>ã€<code>\"attention_mask\"</code>ã€<code>\"token_type_ids\"</code>ï¼‰æ­£ç¡®ç»‘å®šæ•°æ®ã€‚éšåï¼Œæ¨¡å‹æ‰§è¡Œå‰å‘ä¼ æ’­ï¼Œè¾“å‡ºæœ€åä¸€å±‚éšè—çŠ¶æ€ï¼ˆ<code>last_hidden_state</code>ï¼‰ï¼Œå…¶å½¢çŠ¶ä¸º <code>(1, seq_len, hidden_size)</code>ã€‚æˆ‘ä»¬ä»ä¸­æå–ç¬¬ 0 ä¸ªä½ç½®ï¼ˆå³ <code>[CLS]</code> tokenï¼‰çš„å‘é‡ä½œä¸ºæ•´å¥çš„è¯­ä¹‰è¡¨ç¤ºï¼Œå¹¶æŒ‰ BGE å®˜æ–¹æ¨èè¿›è¡Œ <strong>L2 å½’ä¸€åŒ–</strong>â€”â€”è¿™ä¸€æ­¥è‡³å…³é‡è¦ï¼Œå› ä¸ºåç»­çš„å‘é‡ç›¸ä¼¼åº¦æ£€ç´¢ï¼ˆå¦‚ä½™å¼¦ç›¸ä¼¼åº¦ï¼‰ä¾èµ–äºå•ä½å‘é‡ç©ºé—´ä¸­çš„ç‚¹ç§¯ç­‰ä»·æ€§ã€‚</p>\n<blockquote>\n<p>åµŒå…¥æ¨¡å‹ bge-small-zh-v1.5 æœ€å¤§è¾“å…¥é•¿åº¦ = 512 tokensï¼ŒåµŒå…¥å‘é‡ç»´åº¦ = 512ç»´ã€‚å‚æ•°å€¼éƒ½æ˜¯ 512 ï¼Œä½†æ˜¯ä¸¤è€…å¹¶æ²¡æœ‰ç»å¯¹çš„å…³ç³»ï¼Œè¯·æ³¨æ„åŒºåˆ†ã€‚</p>\n</blockquote>\n<p>è‡³æ­¤ï¼Œä¸€æ®µä»»æ„é•¿åº¦çš„ä¸­æ–‡æ–‡æœ¬å°±è¢«æˆåŠŸè½¬åŒ–ä¸ºä¸€ä¸ª 512 ç»´ï¼ˆ<code>bge-small-zh-v1.5</code> çš„è¾“å‡ºç»´åº¦ï¼‰çš„æ ‡å‡†åŒ–è¯­ä¹‰å‘é‡ã€‚çœ¼è§æ‰ä¸ºå®ï¼Œå¾ˆå¤šäººï¼ˆåŒ…æ‹¬ç¬”è€…ï¼‰æƒ³çœ‹çœ‹æŸä¸ªæ–‡æœ¬ï¼ˆæ¯”å¦‚å‰é¢çš„â€œgitæ’¤å›æäº¤â€ï¼‰çš„å‘é‡åŒ–è¾“å‡ºï¼Œé‚£ä¹ˆå¯ä»¥å…ˆæµ‹è¯•ä¸€ä¸‹ï¼š</p>\n<pre><code class=\"language-cpp\">#include &lt;string&gt;\n#include &lt;vector&gt;\n\n#include \"BgeOnnxEmbedder.h\"\n#include \"HfTokenizer.h\"\n\n#ifdef _WIN32\n#include &lt;Windows.h&gt;\n#endif\n\nusing namespace std;\nusing namespace embedding;\n\nint main() {\n#ifdef _WIN32\n  SetConsoleOutputCP(65001);\n#endif\n\n  hf::Tokenizer tokenizer(\"C:/Github/search/bge-small-zh-onnx/tokenizer.json\");\n  BgeOnnxEmbedder bgeOnnxEmbedder(\n      \"C:/Github/search/bge-small-zh-onnx/model.onnx\", tokenizer);\n\n  string text = \"gitæ’¤å›æäº¤\";\n  std::vector&lt;float&gt; embedding = bgeOnnxEmbedder.Embed(text);\n\n  for (auto value : embedding) {\n    printf(\"%lf\\t\", value);\n  }\n\n  return 0;\n}\n</code></pre>\n<p>è¾“å‡ºç»“æœæ˜¯ï¼š</p>\n<pre><code class=\"language-text\">-0.031685       -0.035368       0.069596        -0.030640       -0.011818       -0.023779       -0.043855       0.0064050.067668        0.004901        0.025522        -0.269526       -0.024420       0.065645    ...      0.003664        -0.002409      -0.061532        0.002052        -0.056993       -0.057258       -0.073969       -0.020673       0.044549        0.005769-0.009345       -0.004969       0.013322        0.041202\n</code></pre>\n<p>å…¶å®ä¹Ÿæ²¡ä»€ä¹ˆç‰¹åˆ«çš„ï¼Œå°±æ˜¯ä¸€ä¸ªé«˜ç»´å‘é‡ï¼›è¿™ä¸ªå‘é‡æ˜¯ä¹Ÿæœºå™¨ç†è§£çš„ï¼Œæ‰€ä»¥ä¹Ÿæ²¡ä»€ä¹ˆå¯é˜…è¯»æ€§ã€‚</p>\n<p>å¦å¤–è¡¥å……ä¸€ç‚¹ï¼Œè¿™ä¸ªåµŒå…¥å™¨å®ç°æ˜¯åŸºäº PIMPL æŠ€æœ¯å®ç°çš„ï¼Œç¬”è€…çš„æ–‡ç« <a href=\"https://charlee44.com/post.html?id=b89125a9380d44bc865557f3d1781c9f\" rel=\"noopener nofollow\" target=\"_blank\">ã€Šä¸ºä»€ä¹ˆç°ä»£ C++ åº“éƒ½ç”¨ PIMPLï¼Ÿä¸€åœºå…³äºå°è£…ã€ä¾èµ–ä¸å®‰å…¨çš„æ¼”è¿›ã€‹</a>å°±ä»¥è¿™ä¸ªåµŒå…¥å™¨ä¸ºä¾‹è®ºè¿°äº† PIMPL æŠ€æœ¯ã€‚</p>\n<h1 id=\"6-è¯­ä¹‰åˆ†æ®µå™¨\">6. è¯­ä¹‰åˆ†æ®µå™¨</h1>\n<p>åœ¨æˆåŠŸå®ç°å¥å­åµŒå…¥åŠŸèƒ½åï¼Œä¼¼ä¹è¯­ä¹‰åŒ–æœç´¢çš„æ ¸å¿ƒéš¾é¢˜å·²ç»è§£å†³ã€‚ç„¶è€Œï¼ŒçœŸæ­£çš„æŒ‘æˆ˜æ‰åˆšåˆšå¼€å§‹ï¼š<strong>åµŒå…¥æ¨¡å‹å¯¹è¾“å…¥é•¿åº¦æ˜¯æœ‰é™åˆ¶çš„</strong>ã€‚ä»¥æˆ‘ä»¬ä½¿ç”¨çš„ <code>bge-small-zh-v1.5</code> ä¸ºä¾‹ï¼Œå…¶æœ€å¤§æ”¯æŒçš„ token é•¿åº¦ä¸º 512ã€‚è¿™æ„å‘³ç€ï¼Œè‹¥ç›´æ¥å°†ä¸€ç¯‡é•¿åšå®¢æ–‡ç« ï¼ˆå¯èƒ½åŒ…å«æ•°åƒå­—ï¼‰é€å…¥æ¨¡å‹ï¼Œè¶…å‡ºéƒ¨åˆ†ä¼šè¢«æˆªæ–­ï¼Œå¯¼è‡´å¤§é‡è¯­ä¹‰ä¿¡æ¯ä¸¢å¤±ã€‚</p>\n<p>ä¹çœ‹ä¹‹ä¸‹ï¼Œè§£å†³æ–¹æ¡ˆä¼¼ä¹å¾ˆç®€å•ï¼šæŒ‰ 512 token çš„é•¿åº¦å¯¹æ–‡æ¡£è¿›è¡Œæœºæ¢°åˆ‡åˆ†å³å¯ã€‚ä½†è¿™ç§â€œæš´åŠ›åˆ†å—â€ä¼šå¸¦æ¥ä¸¥é‡é—®é¢˜ï¼š</p>\n<ol>\n<li><strong>ç ´åè¯­ä¹‰å®Œæ•´æ€§</strong>ï¼šä¸€ä¸ªå®Œæ•´çš„å¥å­æˆ–æ®µè½å¯èƒ½è¢«ä»ä¸­åˆ‡æ–­ï¼Œå¯¼è‡´ç”Ÿæˆçš„å‘é‡æ— æ³•å‡†ç¡®è¡¨è¾¾åŸå§‹å«ä¹‰ï¼›</li>\n<li><strong>å‰²è£‚ä¸Šä¸‹æ–‡å…³è”</strong>ï¼šç›¸é‚»ä½†è¢«å¼ºè¡Œåˆ†å‰²çš„å—ä¹‹é—´ç¼ºä¹è¯­ä¹‰è¡”æ¥ï¼Œå½±å“åç»­æ£€ç´¢çš„ç›¸å…³æ€§ï¼›</li>\n<li><strong>æµªè´¹åµŒå…¥å®¹é‡</strong>ï¼šçŸ­æ®µè½å•ç‹¬æˆå—ä¼šé€ æˆå¤§é‡å¡«å……ï¼ˆpaddingï¼‰ï¼Œé™ä½å‘é‡å¯†åº¦å’Œæ£€ç´¢æ•ˆç‡ã€‚</li>\n</ol>\n<p>å› æ­¤ï¼Œ<strong>å…³é”®ä¸åœ¨äºâ€œå¦‚ä½•åˆ‡â€ï¼Œè€Œåœ¨äºâ€œåœ¨å“ªé‡Œåˆ‡â€</strong>â€”â€”æˆ‘ä»¬éœ€è¦çš„æ˜¯<strong>å…·æœ‰è¯­ä¹‰è¾¹ç•Œçš„åˆ†å—</strong>ï¼Œè€Œéä»»æ„ä½ç½®çš„æˆªæ–­ã€‚</p>\n<p>å¯¹äº Markdown æ ¼å¼çš„åšå®¢æ–‡ç« è€Œè¨€ï¼Œè¿™ä¸€ç›®æ ‡å¤©ç„¶å…·å¤‡å®ç°åŸºç¡€ï¼š<strong>æ ‡é¢˜ï¼ˆå¦‚ <code>#</code>ã€<code>##</code> ç­‰ï¼‰æœ¬èº«å°±æ˜¯æ¸…æ™°çš„è¯­ä¹‰è¾¹ç•Œ</strong>ã€‚æ¯ä¸ªæ ‡é¢˜ä¸‹çš„å†…å®¹é€šå¸¸æ„æˆä¸€ä¸ªé€»è¾‘è‡ªæ´½çš„ä¸»é¢˜å•å…ƒï¼ˆä¾‹å¦‚â€œå®‰è£…æ­¥éª¤â€ã€â€œåŸç†åˆ†æâ€ã€â€œå¸¸è§é—®é¢˜â€ï¼‰ã€‚åŸºäºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥è®¾è®¡ä¸€ä¸ª <strong>Markdown è¯­ä¹‰åˆ†æ®µå™¨ï¼ˆ<code>MdSemanticSplitter</code>ï¼‰</strong>ï¼Œå…¶æ ¸å¿ƒä»»åŠ¡ä¸æ˜¯ç”Ÿæˆæœ€ç»ˆç”¨äºåµŒå…¥çš„â€œå—â€ï¼ˆchunkï¼‰ï¼Œè€Œæ˜¯å…ˆå°†æ•´ç¯‡æ–‡æ¡£<strong>æŒ‰è¯­ä¹‰ç»“æ„æ‹†åˆ†ä¸ºè‹¥å¹²â€œè¯­ä¹‰æ®µâ€ï¼ˆsemantic sectionsï¼‰</strong>ã€‚</p>\n<blockquote>\n<p>ğŸ“Œ æ³¨æ„ï¼š<strong>è¯­ä¹‰åˆ†æ®µ â‰  æœ€ç»ˆåˆ†å—</strong>ã€‚<br />\nåˆ†æ®µæ˜¯é¢„å¤„ç†é˜¶æ®µï¼Œå…³æ³¨çš„æ˜¯<strong>å†…å®¹ç»“æ„ä¸é€»è¾‘è¾¹ç•Œ</strong>ï¼›è€Œåˆ†å—ï¼ˆchunkingï¼‰æ˜¯åç»­æ­¥éª¤ï¼Œå…³æ³¨çš„æ˜¯<strong>å¦‚ä½•å°†è¯­ä¹‰æ®µé€‚é…åˆ°æ¨¡å‹é•¿åº¦é™åˆ¶å†…</strong>ï¼ˆä¾‹å¦‚åˆå¹¶çŸ­æ®µã€æ»‘åŠ¨çª—å£é‡å ç­‰ï¼‰ã€‚</p>\n</blockquote>\n<p>è¿™ç§ä¸¤é˜¶æ®µç­–ç•¥å…·æœ‰è‰¯å¥½çš„æ‰©å±•æ€§ï¼šæ— è®ºæ˜¯ Markdownã€Word è¿˜æ˜¯ HTML æ–‡æ¡£ï¼Œåªè¦èƒ½æå–å‡ºè¯­ä¹‰å±‚çº§ç»“æ„ï¼ˆå¦‚ç« èŠ‚ã€æ®µè½ã€åˆ—è¡¨ã€ä»£ç å—ç­‰ï¼‰ï¼Œå°±å¯ä»¥å…ˆé€šè¿‡å¯¹åº”çš„ <strong>è¯­ä¹‰åˆ†æ®µå™¨</strong> å¾—åˆ°ç»“æ„åŒ–ç‰‡æ®µï¼Œå†äº¤ç”±é€šç”¨çš„ <strong>æ–‡æœ¬åˆ†å—å™¨ï¼ˆ<code>TextChunker</code>ï¼‰</strong> è¿›è¡Œé•¿åº¦é€‚é…ä¸å‘é‡åŒ–å‡†å¤‡ã€‚</p>\n<p>å› æ­¤ï¼Œåœ¨æˆ‘ä»¬çš„ç³»ç»Ÿä¸­ï¼Œè¯­ä¹‰åˆ†æ®µå™¨<code>MdSemanticSplitter</code> çš„èŒè´£éå¸¸æ˜ç¡®ï¼š<strong>è§£æ Markdownï¼Œè¯†åˆ«æ ‡é¢˜å±‚çº§ï¼ŒæŒ‰è¯­ä¹‰è¾¹ç•Œåˆ‡åˆ†å‡ºå®Œæ•´çš„æ®µè½å•å…ƒ</strong>ï¼Œä¸ºåç»­é«˜æ•ˆã€å‡†ç¡®çš„åµŒå…¥æ‰“ä¸‹åšå®åŸºç¡€ã€‚å…·ä½“çš„å®ç°å¦‚ä¸‹ï¼š</p>\n<pre><code class=\"language-cpp\">// SemanticBlock.h\n#pragma once\n\n#include &lt;string&gt;\n#include &lt;vector&gt;\n\n// è¯­ä¹‰å—\nstruct SemanticBlock {\n  std::string context;                //ä¸Šä¸‹æ–‡ï¼Œé€šå¸¸æ˜¯æ ‡ç­¾\n  std::vector&lt;std::string&gt; contents;  //æ–‡æœ¬å†…å®¹\n};\n</code></pre>\n<pre><code class=\"language-cpp\">// MdSemanticSplitter.h\n#pragma once\n\n#include \"SemanticBlock.h\"\n\nnamespace embedding {\n\nclass MdSemanticSplitter {\n public:\n  std::vector&lt;SemanticBlock&gt; Split(const std::string&amp; title,\n                                   const std::string&amp; content,\n                                   const std::string&amp; summary) const;\n};\n}  // namespace embedding\n</code></pre>\n<pre><code class=\"language-cpp\">// MdSemanticSplitter.cpp\n#include \"MdSemanticSplitter.h\"\n\n#include &lt;md4c.h&gt;\n\n#include &lt;iostream&gt;\n#include &lt;list&gt;\n\nusing namespace std;\n\nnamespace embedding {\n\nenum class BlockKind { Heading, Paragraph, ListItem, BlockQuote };\n\nstruct Block {\n  BlockKind kind;\n  int level = 0;  // heading level\n  std::string text;\n};\n\nstruct ParseContext {\n  std::vector&lt;Block&gt; result;\n  std::vector&lt;Block&gt; blockStack;  // Blockæ ˆ\n  // int activeDepth = 0;            //æ·±åº¦è®¡æ•°\n};\n\nstatic int EnterBlock(MD_BLOCKTYPE type, void* detail, void* userdata) {\n  auto* ctx = static_cast&lt;ParseContext*&gt;(userdata);\n\n  Block block{};\n  switch (type) {\n    case MD_BLOCK_H: {\n      auto* h = static_cast&lt;MD_BLOCK_H_DETAIL*&gt;(detail);\n      block.kind = BlockKind::Heading;\n      block.level = h-&gt;level;\n      break;\n    }\n    case MD_BLOCK_P: {\n      block.kind = BlockKind::Paragraph;\n      break;\n    }\n    case MD_BLOCK_LI: {\n      block.kind = BlockKind::ListItem;\n      break;\n    }\n    case MD_BLOCK_QUOTE: {\n      block.kind = BlockKind::BlockQuote;\n      break;\n    }\n    default:\n      // å…¶ä»– blockï¼ˆå¦‚ UL / OL / CODEï¼‰ä¸å¤„ç†\n      break;\n  }\n\n  ctx-&gt;blockStack.emplace_back(std::move(block));\n  return 0;\n}\n\nstatic int TextCallback(MD_TEXTTYPE type, const MD_CHAR* text, MD_SIZE size,\n                        void* userdata) {\n  auto* ctx = static_cast&lt;ParseContext*&gt;(userdata);\n  if (ctx-&gt;blockStack.empty()) return 0;\n\n  // åªæ¥æ”¶çœŸå®å¯è¯»æ–‡æœ¬\n  if (type == MD_TEXT_NORMAL || type == MD_TEXT_CODE) {\n    ctx-&gt;blockStack.back().text.append(text, size);\n  }\n\n  return 0;\n}\n\nstatic int LeaveBlock(MD_BLOCKTYPE type, void*, void* userdata) {\n  auto* ctx = static_cast&lt;ParseContext*&gt;(userdata);\n  if (ctx-&gt;blockStack.empty()) {\n    return 0;\n  }\n\n  Block block = std::move(ctx-&gt;blockStack.back());\n  ctx-&gt;blockStack.pop_back();\n\n  bool emit = false;\n  switch (type) {\n    case MD_BLOCK_H:\n    case MD_BLOCK_P:\n    case MD_BLOCK_LI:\n    case MD_BLOCK_QUOTE:\n      emit = true;\n      break;\n    default:\n      break;\n  }\n\n  if (emit &amp;&amp; !block.text.empty()) {\n    ctx-&gt;result.emplace_back(std::move(block));\n  }\n\n  return 0;\n}\n\nstatic int EnterSpan(MD_SPANTYPE /*type*/, void* /*detail*/,\n                     void* /*userdata*/) {\n  return 0;\n}\n\nstatic int LeaveSpan(MD_SPANTYPE /*type*/, void* /*detail*/,\n                     void* /*userdata*/) {\n  return 0;\n}\n\nstd::vector&lt;SemanticBlock&gt; MdSemanticSplitter::Split(\n    const std::string&amp; title, const std::string&amp; content,\n    const std::string&amp; summary) const {\n  ParseContext ctx{};\n\n  MD_PARSER parser{};\n  parser.abi_version = 0;\n  parser.enter_block = EnterBlock;\n  parser.leave_block = LeaveBlock;\n  parser.enter_span = EnterSpan;\n  parser.leave_span = LeaveSpan;\n  parser.text = TextCallback;\n  parser.flags = MD_FLAG_COLLAPSEWHITESPACE;  //åˆå¹¶ç©ºæ ¼\n\n  md_parse(content.data(), (MD_SIZE)content.size(), &amp;parser, &amp;ctx);\n\n  // std::cout &lt;&lt; \"[Parsed blocks] \" &lt;&lt; ctx.result.size() &lt;&lt; \"\\n\\n\";\n  // for (const auto&amp; b : ctx.result) {\n  //  switch (b.kind) {\n  //    case BlockKind::Heading:\n  //      std::cout &lt;&lt; \"[H\" &lt;&lt; b.level &lt;&lt; \"] \";\n  //      break;\n  //    case BlockKind::Paragraph:\n  //      std::cout &lt;&lt; \"[P] \";\n  //      break;\n  //    case BlockKind::ListItem:\n  //      std::cout &lt;&lt; \"[LI] \";\n  //      break;\n  //    case BlockKind::BlockQuote:\n  //      std::cout &lt;&lt; \"[Q] \";\n  //      break;\n  //  }\n  //  std::cout &lt;&lt; b.text &lt;&lt; \"\\n\";\n  //}\n\n  vector&lt;SemanticBlock&gt; semanticBlocks;\n  {\n    SemanticBlock semanticBlock;\n    semanticBlock.context = title;\n    semanticBlock.contents = {summary};\n    semanticBlocks.emplace_back(std::move(semanticBlock));\n  }\n\n  std::list&lt;std::pair&lt;int, std::string&gt;&gt; currentTitleChain;  // å­˜ (çº§åˆ«, æ–‡æœ¬)\n  std::vector&lt;std::string&gt; currentBlockContents;\n\n  for (auto&amp; b : ctx.result) {\n    if (b.kind == BlockKind::Heading) {\n      //é‡åˆ°æ–°æ ‡é¢˜ï¼Œå­˜å…¥æ•°æ®\n      if (!currentBlockContents.empty()) {\n        string context;\n        for (auto it = currentTitleChain.begin(); it != currentTitleChain.end();\n             ++it) {\n          context += it-&gt;second;  // åªå–æ ‡é¢˜æ–‡æœ¬\n          if (std::next(it) != currentTitleChain.end()) context += \"ï½œ\";\n        }\n        SemanticBlock semanticBlock;\n        semanticBlock.context = std::move(context);\n        semanticBlock.contents = std::move(currentBlockContents);\n        semanticBlocks.emplace_back(std::move(semanticBlock));\n        currentBlockContents = {};\n      }\n\n      // å¼¹å‡ºæ‰€æœ‰çº§åˆ« &gt;= å½“å‰æ ‡é¢˜çº§åˆ«çš„ç¥–å…ˆï¼ˆç²¾å‡†å›æº¯ï¼‰\n      while (!currentTitleChain.empty() &amp;&amp;\n             currentTitleChain.back().first &gt;= b.level) {\n        currentTitleChain.pop_back();\n      }\n      currentTitleChain.emplace_back(b.level,\n                                     std::move(b.text));  // å­˜çº§åˆ«+æ–‡æœ¬\n    } else {\n      currentBlockContents.emplace_back(std::move(b.text));\n    }\n  }\n  if (!currentBlockContents.empty()) {\n    string context;\n    for (auto it = currentTitleChain.begin(); it != currentTitleChain.end();\n         ++it) {\n      context += it-&gt;second;  // åªå–æ ‡é¢˜æ–‡æœ¬\n      if (std::next(it) != currentTitleChain.end()) context += \"ï½œ\";\n    }\n\n    SemanticBlock semanticBlock;\n    semanticBlock.context = std::move(context);\n    semanticBlock.contents = std::move(currentBlockContents);\n    semanticBlocks.emplace_back(std::move(semanticBlock));\n    currentBlockContents = {};\n  }\n\n  return semanticBlocks;\n}\n\n}  // namespace embedding\n</code></pre>\n<p>è¿™æ®µ <code>MdSemanticSplitter</code> çš„å®ç°åŸºäº <strong>MD4C</strong> â€”â€” ä¸€ä¸ªè½»é‡ã€ç¬¦åˆ CommonMark æ ‡å‡†çš„ C è¯­è¨€ Markdown è§£æå™¨ã€‚å®ƒä¸ä¾èµ–æ­£åˆ™è¡¨è¾¾å¼æˆ–å­—ç¬¦ä¸²æš´åŠ›åŒ¹é…ï¼Œè€Œæ˜¯é€šè¿‡äº‹ä»¶é©±åŠ¨çš„æ–¹å¼ï¼Œåœ¨è§£æè¿‡ç¨‹ä¸­é€å—ï¼ˆblockï¼‰è¯†åˆ« Markdown ç»“æ„ã€‚</p>\n<p>å…·ä½“æ¥è¯´ï¼Œæˆ‘ä»¬æ³¨å†Œäº†ä¸‰ä¸ªæ ¸å¿ƒå›è°ƒå‡½æ•°ï¼š</p>\n<ul>\n<li><code>EnterBlock</code>ï¼šå½“è¿›å…¥ä¸€ä¸ªæ–°å—ï¼ˆå¦‚æ ‡é¢˜ã€æ®µè½ã€åˆ—è¡¨é¡¹ç­‰ï¼‰æ—¶è§¦å‘ï¼Œè®°å½•å…¶ç±»å‹å’Œå±‚çº§ï¼›</li>\n<li><code>TextCallback</code>ï¼šæ”¶é›†å—å†…çš„åŸå§‹æ–‡æœ¬å†…å®¹ï¼ˆåŒ…æ‹¬æ™®é€šæ–‡æœ¬å’Œè¡Œå†…ä»£ç ï¼‰ï¼›</li>\n<li><code>LeaveBlock</code>ï¼šå½“ç¦»å¼€ä¸€ä¸ªå—æ—¶ï¼Œå°†å·²æ”¶é›†çš„æ–‡æœ¬å°è£…ä¸ºç»“æ„åŒ– <code>Block</code> å¹¶æš‚å­˜ã€‚</li>\n</ul>\n<p>é€šè¿‡ç»´æŠ¤ä¸€ä¸ª <strong>æ ‡é¢˜æ ˆï¼ˆ<code>currentTitleChain</code>ï¼‰</strong>ï¼Œæˆ‘ä»¬èƒ½åŠ¨æ€è¿½è¸ªå½“å‰å†…å®¹æ‰€å¤„çš„ç« èŠ‚è·¯å¾„ã€‚æ¯å½“é‡åˆ°æ–°çš„æ ‡é¢˜ï¼ˆ<code>#</code>, <code>##</code> ç­‰ï¼‰ï¼Œå°±å°†æ­¤å‰ç´¯ç§¯çš„æ‰€æœ‰æ®µè½ã€åˆ—è¡¨é¡¹ç­‰å†…å®¹æ‰“åŒ…ä¸ºä¸€ä¸ª <code>SemanticBlock</code>ï¼Œå…¶ä¸Šä¸‹æ–‡ï¼ˆ<code>context</code>ï¼‰ç”±ä»æ ¹åˆ°å½“å‰æ ‡é¢˜çš„å®Œæ•´è·¯å¾„æ„æˆï¼ˆä¾‹å¦‚ <code>\"éƒ¨ç½²ï½œDocker é…ç½®ï½œç¯å¢ƒå˜é‡\"</code>ï¼‰ã€‚è¿™æ ·ï¼Œæ¯ä¸ªè¯­ä¹‰å—ä¸ä»…åŒ…å«åŸå§‹æ–‡æœ¬ï¼Œè¿˜æºå¸¦äº†æ˜ç¡®çš„ç»“æ„åŒ–ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œæå¤§æå‡äº†åç»­åµŒå…¥çš„è¯­ä¹‰å‡†ç¡®æ€§ã€‚</p>\n<blockquote>\n<p>è¡¥å……ä¸€ä¸ªç»†èŠ‚ï¼Œå¯¹äºæ¯ä¸€ç¯‡åšæ–‡ï¼Œç¬¬ä¸€ä¸ªè¯­ä¹‰åˆ†æ®µçš„ä¸Šä¸‹æ–‡æ˜¯æ–‡ç« æ ‡é¢˜ï¼Œå†…å®¹æ˜¯æ–‡ç« æ‘˜è¦ã€‚è¿™æ ·åšå¯ä»¥ä¿è¯æ–‡æ¡£çš„è¯­ä¹‰é”šç‚¹ï¼Œç¡®ä¿å³ä½¿åç»­å†…å®¹è¢«æ‹†åˆ†ï¼Œæ£€ç´¢ç³»ç»Ÿä»èƒ½å‡†ç¡®ç†è§£è¯¥æ–‡æ¡£çš„æ ¸å¿ƒä¸»é¢˜ã€‚</p>\n</blockquote>\n<p>æœ€ç»ˆè¾“å‡ºçš„ <code>std::vector&lt;SemanticBlock&gt;</code> å³ä¸ºæ–‡æ¡£çš„â€œè¯­ä¹‰éª¨æ¶â€â€”â€”å®ƒä¿ç•™äº† Markdown çš„é€»è¾‘å±‚æ¬¡ï¼ŒåŒæ—¶ä¸ºä¸‹ä¸€æ­¥çš„ <strong>æ–‡æœ¬åˆ†å—ï¼ˆchunkingï¼‰</strong> æä¾›äº†é«˜è´¨é‡ã€ç»“æ„æ„ŸçŸ¥çš„è¾“å…¥å•å…ƒã€‚</p>\n<h1 id=\"7-æ–‡æœ¬åˆ†å—å™¨\">7. æ–‡æœ¬åˆ†å—å™¨</h1>\n<p>åœ¨è¯­ä¹‰åˆ†æ®µå™¨å°† Markdown æ–‡æ¡£è§£æä¸ºç»“æ„åŒ–çš„ <strong>è¯­ä¹‰æ®µ</strong>ï¼ˆ<code>SemanticBlock</code>ï¼‰ä¹‹åï¼Œæˆ‘ä»¬è·ç¦»çœŸæ­£å¯åµŒå…¥çš„è¾“å…¥å•å…ƒä»å·®ä¸€æ­¥ï¼š<strong>å°†è¿™äº›è¯­ä¹‰æ®µé€‚é…åˆ°åµŒå…¥æ¨¡å‹çš„é•¿åº¦é™åˆ¶å†…</strong>ã€‚</p>\n<p>åµŒå…¥æ¨¡å‹ï¼ˆå¦‚ <code>bge-small-zh-v1.5</code>ï¼‰å¯¹è¾“å…¥é•¿åº¦æœ‰ç¡¬æ€§ä¸Šé™ï¼ˆé€šå¸¸ä¸º 512 tokensï¼‰ã€‚ç„¶è€Œï¼Œç°å®ä¸­çš„åšå®¢å†…å®¹åƒå·®ä¸‡åˆ«â€”â€”æœ‰çš„ç« èŠ‚å¯¥å¯¥æ•°è¯­ï¼Œæœ‰çš„æ®µè½æ´‹æ´‹æ´’æ´’ã€‚è‹¥ç›´æ¥å¯¹æ¯ä¸ªè¯­ä¹‰æ®µç‹¬ç«‹åµŒå…¥ï¼Œä¼šé¢ä¸´ä¸¤ä¸ªæç«¯é—®é¢˜ï¼š</p>\n<ol>\n<li><strong>è¿‡é•¿æ®µè½è¢«æˆªæ–­</strong>ï¼šè¶…å‡º 512 tokens çš„å†…å®¹ä¼šè¢«æ— æƒ…ä¸¢å¼ƒï¼Œå¯¼è‡´å…³é”®ä¿¡æ¯ä¸¢å¤±ï¼›</li>\n<li><strong>è¿‡çŸ­æ®µè½æµªè´¹å®¹é‡</strong>ï¼šä¸€ä¸ªä»…å«ä¸¤å¥è¯çš„æ®µè½å æ®æ•´ä¸ª 512-token è¾“å…¥æ§½ä½ï¼Œå¤§é‡ä½ç½®è¢« <code>[PAD]</code> å¡«å……ï¼Œä¸ä»…é™ä½å‘é‡å¯†åº¦ï¼Œè¿˜å¯èƒ½ç¨€é‡Šè¯­ä¹‰ä¿¡å·ã€‚</li>\n</ol>\n<p>å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ™ºèƒ½çš„ <strong>æ–‡æœ¬åˆ†å—å™¨</strong>ï¼ˆ<code>TextChunker</code>ï¼‰ï¼Œå®ƒä¸ä»…è¦å¤„ç†é•¿åº¦çº¦æŸï¼Œæ›´è¦<strong>åœ¨ä¿ç•™è¯­ä¹‰è¿è´¯æ€§çš„å‰æä¸‹ï¼ŒåŠ¨æ€åœ°æ‹†åˆ†æˆ–åˆå¹¶å†…å®¹</strong>ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒçš„æ ¸å¿ƒèŒè´£åŒ…æ‹¬ï¼š</p>\n<ul>\n<li><strong>æŒ‰ token æ•°ç²¾ç¡®åˆ‡åˆ†é•¿æ®µ</strong>ï¼šå½“å•ä¸ªè¯­ä¹‰æ®µè¶…è¿‡æœ€å¤§é•¿åº¦æ—¶ï¼Œä»¥å¥å­ä¸ºå•ä½è¿›è¡Œæ»‘åŠ¨çª—å£åˆ‡åˆ†ï¼Œé¿å…åœ¨è¯æˆ–å­—ä¸­é—´æš´åŠ›æˆªæ–­ï¼›</li>\n<li><strong>åˆå¹¶ç›¸é‚»çŸ­æ®µ</strong>ï¼šå°†å¤šä¸ªè¯­ä¹‰ç›¸å…³ä½†å„è‡ªè¿‡çŸ­çš„æ®µè½ç»„åˆæˆä¸€ä¸ªç´§å‡‘å—ï¼Œæå‡åµŒå…¥æ•ˆç‡ï¼›</li>\n<li><strong>æ³¨å…¥ä¸Šä¸‹æ–‡ä¿¡æ¯</strong>ï¼šåœ¨åˆ†å—æ—¶ä¿ç•™å…¶æ‰€å±çš„æ ‡é¢˜è·¯å¾„ï¼ˆå¦‚ <code>\"æ•°æ®åº“ï½œè¿æ¥æ± é…ç½®ï½œHikariCP å‚æ•°è¯¦è§£\"</code>ï¼‰ï¼Œä½œä¸ºå‰ç¼€æ‹¼æ¥åˆ°æ–‡æœ¬å¼€å¤´ï¼Œä½¿åµŒå…¥å‘é‡â€œçŸ¥é“â€è‡ªå·±æ¥è‡ªå“ªä¸€éƒ¨åˆ†å†…å®¹ã€‚</li>\n</ul>\n<p>è¿™ç§ç­–ç•¥ç¡®ä¿äº†æ¯ä¸ªæœ€ç»ˆç”¨äºåµŒå…¥çš„ <strong>æ–‡æœ¬å—</strong>ï¼ˆchunkï¼‰æ—¢æ»¡è¶³æ¨¡å‹è¾“å…¥çº¦æŸï¼Œåˆå°½å¯èƒ½å®Œæ•´ã€è‡ªæ´½åœ°è¡¨è¾¾ä¸€ä¸ªå±€éƒ¨è¯­ä¹‰å•å…ƒã€‚</p>\n<blockquote>\n<p>ğŸ’¡ è¿™æ­£æ˜¯ <strong>RAG</strong>ï¼ˆRetrieval-Augmented Generationï¼‰ç³»ç»Ÿä¸­â€œæ£€ç´¢â€ç¯èŠ‚çš„å…³é”®å‰ç½®æ­¥éª¤ã€‚<br />\nåœ¨å…¸å‹çš„ RAG æ¶æ„ä¸­ï¼Œå¤–éƒ¨çŸ¥è¯†åº“é¦–å…ˆè¢«åˆ‡åˆ†ä¸ºé«˜è´¨é‡ chunksï¼Œå†ç»åµŒå…¥æ¨¡å‹è½¬åŒ–ä¸ºå‘é‡å¹¶å­˜å…¥ç´¢å¼•ã€‚å½“ç”¨æˆ·æé—®æ—¶ï¼Œç³»ç»Ÿé€šè¿‡è¯­ä¹‰ç›¸ä¼¼åº¦å¬å›æœ€ç›¸å…³çš„è‹¥å¹² chunksï¼Œå°†å…¶ä½œä¸ºä¸Šä¸‹æ–‡æä¾›ç»™å¤§è¯­è¨€æ¨¡å‹ç”Ÿæˆç­”æ¡ˆã€‚<br />\nå› æ­¤ï¼Œ<strong>åˆ†å—è´¨é‡ç›´æ¥å†³å®šäº†æ£€ç´¢ç²¾åº¦ï¼Œè¿›è€Œå½±å“æœ€ç»ˆå›ç­”çš„å‡†ç¡®æ€§ä¸ç›¸å…³æ€§</strong>ã€‚</p>\n</blockquote>\n<p>åœ¨æˆ‘ä»¬çš„è½»é‡çº§åšå®¢æœç´¢ç³»ç»Ÿä¸­ï¼Œè™½ç„¶æ²¡æœ‰åç»­çš„å¤§æ¨¡å‹ç”Ÿæˆç¯èŠ‚ï¼Œä½†â€œæ£€ç´¢å³æœåŠ¡â€çš„æ€æƒ³ä¾ç„¶é€‚ç”¨â€”â€”ç”¨æˆ·è¾“å…¥çš„æŸ¥è¯¢éœ€è¦ç²¾å‡†åŒ¹é…åˆ°æœ€ç›¸å…³çš„æ–‡ç« ç‰‡æ®µã€‚è€Œè¿™ä¸€åˆ‡ï¼Œéƒ½å§‹äºä¸€ä¸ªç²¾å¿ƒè®¾è®¡çš„æ–‡æœ¬åˆ†å—å™¨ã€‚</p>\n<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†åŸºäº Hugging Face Tokenizer æä¾›çš„ token è®¡æ•°èƒ½åŠ›ï¼Œå®ç°ä¸€ä¸ªå…¼é¡¾æ•ˆç‡ä¸è¯­ä¹‰çš„ <code>TextChunker</code>ï¼Œä¸ºæ„å»ºå®Œæ•´çš„å‘é‡ç´¢å¼•é“ºå¹³é“è·¯ï¼š</p>\n<pre><code class=\"language-cpp\">// TextChunker.h\n#pragma once\n\n#include &lt;vector&gt;\n\n#include \"HfTokenizer.h\"\n#include \"SemanticBlock.h\"\n\nnamespace embedding {\n\nclass TextChunker {\n public:\n  explicit TextChunker(size_t maxTokens, const hf::Tokenizer&amp; tokenizer);\n\n  // æ”¯æŒå¤šä¸ªè¯­ä¹‰å—\n  std::vector&lt;std::string&gt; SemanticBlocks(\n      std::vector&lt;SemanticBlock&gt; semanticBlockList) const;\n\n  // æ”¯æŒå¤šä¸ªå—å…ƒç´ \n  std::vector&lt;std::string&gt; Blocks(std::vector&lt;std::string&gt; blockList) const;\n\n  // æ”¯æŒæ®µè½æˆ–é•¿æ–‡æœ¬\n  std::vector&lt;std::string&gt; Paragraph(std::string text) const;\n\n private:\n  // æŒ‰ä¸­æ–‡æ ‡ç‚¹åˆ‡åˆ†ä¸ºå¥å­ï¼ˆä¿ç•™æ ‡ç‚¹ï¼‰\n  std::vector&lt;std::string&gt; SplitIntoSentences(\n      const std::string&amp; paragraph) const;\n\n  // å°†å¥å­åˆ—è¡¨åˆå¹¶ä¸ºæ»¡è¶³ token é™åˆ¶çš„ chunks\n  std::vector&lt;std::string&gt; MergeSentencesToChunks(\n      std::vector&lt;std::string&gt;&amp;&amp; sentences) const;\n\n  size_t maxTokens;\n  const hf::Tokenizer&amp; tokenizer;\n};\n\n}  // namespace embedding\n</code></pre>\n<pre><code class=\"language-cpp\">// TextChunker.cpp\n#include \"TextChunker.h\"\n\n#include &lt;iostream&gt;\n#include &lt;unordered_set&gt;\n\nusing namespace std;\n\nnamespace embedding {\n\nTextChunker::TextChunker(size_t maxTokens, const hf::Tokenizer&amp; tokenizer)\n    : maxTokens(maxTokens), tokenizer(tokenizer) {}\n\nstd::vector&lt;std::string&gt; TextChunker::SemanticBlocks(\n    std::vector&lt;SemanticBlock&gt; semanticBlockList) const {\n  vector&lt;std::string&gt; totalChunkList;\n\n  for (auto&amp; semanticBlock : semanticBlockList) {\n    string contextText = semanticBlock.context + \"\\n\";\n    vector&lt;std::string&gt; chunkList = Blocks(std::move(semanticBlock.contents));\n\n    // Tokenè®¡æ•°ä¸ç”¨å¤ªä¸¥æ ¼ï¼ŒmaxTokensè‚¯å®šå°äºnlpæ¨¡å‹å¤„ç†æ•°ï¼Œä¸”ä¸Šä¸‹æ–‡éå¸¸å°\n    for (auto&amp; chunk : chunkList) {\n      chunk = contextText + std::move(chunk);\n    }\n\n    totalChunkList.insert(totalChunkList.end(),\n                          std::make_move_iterator(chunkList.begin()),\n                          std::make_move_iterator(chunkList.end()));\n  }\n\n  return totalChunkList;\n}\n\nstd::vector&lt;std::string&gt; TextChunker::Blocks(\n    std::vector&lt;std::string&gt; blockList) const {\n  // æŒ‰ç…§æ–‡æ¡£ä¸­çš„å—å…ƒç´ è¿›è¡Œåˆå¹¶\n  vector&lt;std::string&gt; chunkList;\n  vector&lt;size_t&gt; chunkTokenCount;\n  string currentChunk;  //å½“å‰å—\n  size_t totalTokenCount = 0;\n  for (size_t i = 0; i &lt; blockList.size(); ++i) {\n    string currentText(std::move(blockList[i]));\n    currentText += '\\n';\n    size_t currentTokenCount = tokenizer.Count(currentText.c_str());\n    if (totalTokenCount + currentTokenCount &gt; maxTokens) {\n      if (!currentChunk.empty()) {\n        chunkList.emplace_back(std::move(currentChunk));\n        chunkTokenCount.emplace_back(totalTokenCount);\n      }\n      currentChunk = std::move(currentText);\n      totalTokenCount = currentTokenCount;\n    } else {\n      currentChunk += std::move(currentText);\n      totalTokenCount += currentTokenCount;\n    }\n  }\n  if (!currentChunk.empty()) {\n    chunkList.emplace_back(std::move(currentChunk));\n    chunkTokenCount.emplace_back(totalTokenCount);\n  }\n\n  // æœ‰çš„å—å…ƒç´ æœ¬èº«å°±è¶…è¿‡maxTokensï¼Œç»§ç»­æ‹†åˆ†\n  vector&lt;std::string&gt; resultChunkList;\n  for (size_t ci = 0; ci &lt; chunkList.size(); ++ci) {\n    if (chunkTokenCount[ci] &gt; maxTokens) {\n      vector&lt;std::string&gt; subChunks = Paragraph(std::move(chunkList[ci]));\n      for (size_t si = 0; si &lt; subChunks.size(); ++si) {\n        string chunk = std::move(subChunks[si]);\n        if (si + 1 != subChunks.size()) {\n          chunk += '\\n';\n        }\n        resultChunkList.emplace_back(chunk);\n      }\n    } else {\n      resultChunkList.emplace_back(std::move(chunkList[ci]));\n    }\n  }\n  return resultChunkList;\n}\n\n// Todo:å¯¹äºRAGè¦å¤„ç†\n//ã€Œå¥å­å•å¥ &gt; maxTokensã€çš„ fallback\n//å¢åŠ  token-based overlap\nstd::vector&lt;std::string&gt; TextChunker::Paragraph(std::string text) const {\n  return MergeSentencesToChunks(SplitIntoSentences(text));\n}\n\n// æŒ‰ä¸­æ–‡æ ‡ç‚¹åˆ‡åˆ†ä¸ºå¥å­ï¼ˆä¿ç•™æ ‡ç‚¹ï¼‰\nstd::vector&lt;std::string&gt; TextChunker::SplitIntoSentences(\n    const std::string&amp; paragraph) const {\n  if (paragraph.empty()) {\n    return {};\n  }\n\n  // å®šä¹‰ä¸­æ–‡å¥æœ«æ ‡ç‚¹é›†åˆï¼ˆUTF-8 å­—ç¬¦ä¸²ï¼‰\n  static const std::unordered_set&lt;std::string&gt; delimiters = {\"ã€‚\", \"ï¼\", \"ï¼Ÿ\",\n                                                             \"ï¼›\", \"â€¦â€¦\"};\n\n  std::vector&lt;std::string&gt; chunks;\n  size_t i = 0;\n  size_t start = 0;\n  const char* data = paragraph.data();\n  size_t len = paragraph.size();\n\n  while (i &lt; len) {\n    // åˆ¤æ–­å½“å‰ä½ç½®æ˜¯å¦æ˜¯æŸä¸ªåˆ†éš”ç¬¦çš„èµ·å§‹\n    bool found = false;\n    for (const auto&amp; delim : delimiters) {\n      if (paragraph.compare(i, delim.size(), delim) == 0) {\n        // æ‰¾åˆ°åˆ†éš”ç¬¦ï¼šæå– [start, i + delim.size())\n        std::string chunk = paragraph.substr(start, i - start + delim.size());\n        if (!chunk.empty()) {\n          chunks.push_back(chunk);\n        }\n        // è·³è¿‡åˆ†éš”ç¬¦\n        i += delim.size();\n        start = i;\n        found = true;\n        break;\n      }\n    }\n\n    if (!found) {\n      // æ™®é€šå­—ç¬¦ï¼šå‘å‰ç§»åŠ¨ä¸€ä¸ª UTF-8 å­—ç¬¦\n      unsigned char c = static_cast&lt;unsigned char&gt;(data[i]);\n      if ((c &amp; 0x80) == 0) {\n        i += 1;\n      } else if ((c &amp; 0xE0) == 0xC0) {\n        i += 2;\n      } else if ((c &amp; 0xF0) == 0xE0) {\n        i += 3;\n      } else if ((c &amp; 0xF8) == 0xF0) {\n        i += 4;\n      } else {\n        i += 1;  // invalid UTF-8 fallback\n      }\n    }\n  }\n\n  // å¤„ç†æœ«å°¾æ²¡æœ‰æ ‡ç‚¹çš„å‰©ä½™éƒ¨åˆ†\n  if (start &lt; len) {\n    std::string last = paragraph.substr(start);\n    if (!last.empty()) {\n      chunks.push_back(last);\n    }\n  }\n\n  return chunks;\n}\n\nstd::vector&lt;std::string&gt; TextChunker::MergeSentencesToChunks(\n    std::vector&lt;std::string&gt;&amp;&amp; sentences) const {\n  vector&lt;string&gt; chunkList;\n  string currentChunk;  //å½“å‰å—\n  size_t totalTokenCount = 0;\n  for (size_t i = 0; i &lt; sentences.size(); ++i) {\n    // cout &lt;&lt; mdBlockList[i].level &lt;&lt; '\\t' &lt;&lt; mdBlockList[i].text &lt;&lt; '\\n';\n    string currentText(std::move(sentences[i]));\n    size_t currentTokenCount = tokenizer.Count(currentText.c_str());\n    if (totalTokenCount + currentTokenCount &gt; maxTokens) {\n      chunkList.emplace_back(std::move(currentChunk));\n      currentChunk = std::move(currentText);\n      totalTokenCount = currentTokenCount;\n    } else {\n      currentChunk += std::move(currentText);\n      totalTokenCount += currentTokenCount;\n    }\n  }\n  if (!currentChunk.empty()) {\n    chunkList.emplace_back(std::move(currentChunk));\n  }\n\n  return chunkList;\n}\n\n}  // namespace embedding\n</code></pre>\n<p>ä¸Šè¿° <code>TextChunker</code> çš„è®¾è®¡éµå¾ªä¸€ä¸ªæœ´ç´ ä½†æœ‰æ•ˆçš„åŸåˆ™ï¼š<strong>ä¼˜å…ˆå°Šé‡æ–‡æ¡£åŸæœ‰çš„ç»“æ„å•å…ƒï¼Œå†åœ¨å¿…è¦æ—¶è¿›è¡Œè¯­ä¹‰æ„ŸçŸ¥çš„åˆ‡åˆ†</strong>ã€‚</p>\n<p>å®ƒçš„å…¥å£æ–¹æ³• <code>SemanticBlocks()</code> æ¥æ”¶ç”± <code>MdSemanticSplitter</code> äº§å‡ºçš„è¯­ä¹‰æ®µåˆ—è¡¨ã€‚æ¯ä¸ªè¯­ä¹‰æ®µéƒ½æºå¸¦äº†å®Œæ•´çš„ä¸Šä¸‹æ–‡è·¯å¾„ï¼ˆå¦‚ <code>\"éƒ¨ç½²ï½œå®¹å™¨åŒ–ï½œDockerfile ç¼–å†™\"</code>ï¼‰ï¼Œæˆ‘ä»¬å°†å…¶ä½œä¸ºå‰ç¼€é™„åŠ åˆ°è¯¥æ®µæ‰€æœ‰å†…å®¹å—çš„å¼€å¤´â€”â€”è¿™æ ·ï¼Œå³ä½¿æŸæ®µå†…å®¹è¢«å•ç‹¬æ£€ç´¢åˆ°ï¼Œå…¶å‘é‡ä¹Ÿèƒ½â€œè®°ä½â€è‡ªå·±æ‰€å±çš„ä¸»é¢˜å±‚çº§ï¼Œæå¤§å¢å¼ºæœç´¢çš„ç›¸å…³æ€§ã€‚</p>\n<p>å†…éƒ¨å¤„ç†åˆ†ä¸ºä¸¤ä¸ªå±‚æ¬¡ï¼š</p>\n<ol>\n<li><strong>å—çº§åˆå¹¶ï¼ˆ<code>Blocks</code>ï¼‰</strong><br />\né¦–å…ˆå°è¯•å°†åŒä¸€è¯­ä¹‰æ®µå†…çš„å¤šä¸ªå°å—ï¼ˆå¦‚è‹¥å¹²æ®µè½ã€åˆ—è¡¨é¡¹ï¼‰æŒ‰é¡ºåºæ‹¼æ¥ï¼Œç›´åˆ°å³å°†è¶…å‡º <code>maxTokens</code> é™åˆ¶ä¸ºæ­¢ã€‚è¿™ç§ç­–ç•¥èƒ½æœ‰æ•ˆé¿å…çŸ­å†…å®¹ç¢ç‰‡åŒ–ï¼ŒåŒæ—¶ä¿æŒåŸå§‹ Markdown å—çš„å®Œæ•´æ€§ã€‚è‹¥æŸä¸ªå—æœ¬èº«å·²è¶…é•¿ï¼ˆä¾‹å¦‚ä¸€æ®µæœªæ¢è¡Œçš„ä»£ç è¯´æ˜æˆ–é•¿å¼•ç”¨ï¼‰ï¼Œåˆ™äº¤ç”±ä¸‹ä¸€å±‚å¤„ç†ã€‚</li>\n<li><strong>å¥å­çº§åˆ‡åˆ†ï¼ˆ<code>Paragraph</code> â†’ <code>SplitIntoSentences</code> + <code>MergeSentencesToChunks</code>ï¼‰</strong><br />\nå¯¹äºè¶…é•¿æ®µè½ï¼Œæˆ‘ä»¬ä¸å†æš´åŠ›æˆªæ–­ï¼Œè€Œæ˜¯å…ˆæŒ‰ä¸­æ–‡å¥æœ«æ ‡ç‚¹ï¼ˆ<code>ã€‚ï¼ï¼Ÿï¼›â€¦â€¦</code>ï¼‰å°†å…¶æ‹†åˆ†ä¸ºå¥å­åºåˆ—ã€‚éšåï¼Œä»¥è´ªå¿ƒæ–¹å¼å°†è¿™äº›å¥å­é‡æ–°ç»„åˆæˆä¸è¶…è¿‡ <code>maxTokens</code> çš„æ–‡æœ¬å—ã€‚è™½ç„¶å½“å‰å®ç°å°šæœªå¼•å…¥æ»‘åŠ¨çª—å£é‡å ï¼ˆoverlapï¼‰ï¼Œä½†åœ¨ç»å¤§å¤šæ•°åšå®¢åœºæ™¯ä¸­ï¼Œè¿™ç§â€œå¥è¾¹ç•Œå¯¹é½â€çš„åˆ‡åˆ†å·²èƒ½å¾ˆå¥½åœ°ä¿ç•™å±€éƒ¨è¯­ä¹‰è¿è´¯æ€§ã€‚</li>\n</ol>\n<p>æ•´ä¸ªè¿‡ç¨‹å®Œå…¨åŸºäº <strong>çœŸå® token è®¡æ•°</strong>ï¼ˆé€šè¿‡ Hugging Face Tokenizer çš„ <code>Count</code> æ¥å£ï¼‰ï¼Œè€Œéç²—ç•¥çš„å­—ç¬¦æˆ–å­—æ•°ä¼°ç®—ï¼Œç¡®ä¿åˆ†å—ç»“æœä¸¥æ ¼æ»¡è¶³æ¨¡å‹è¾“å…¥çº¦æŸã€‚</p>\n<p>è‡³æ­¤ï¼Œä»åŸå§‹ Markdown åˆ°å¯åµŒå…¥æ–‡æœ¬å—çš„é¢„å¤„ç†æµæ°´çº¿å·²å…¨çº¿è´¯é€šã€‚</p>\n<h1 id=\"8-å‘é‡åº“\">8. å‘é‡åº“</h1>\n<p>ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»èƒ½å°†åšå®¢ä¸­çš„æ¯ä¸€æ®µæ–‡æœ¬è½¬åŒ–ä¸ºä¸€ä¸ª 512 ç»´çš„è¯­ä¹‰å‘é‡ã€‚ä½†è‹¥æ²¡æœ‰ä¸€ç§é«˜æ•ˆçš„æ–¹å¼ç»„ç»‡å’Œæ£€ç´¢è¿™äº›å‘é‡ï¼Œè¯­ä¹‰æœç´¢å°±æ— ä»è°ˆèµ·ã€‚</p>\n<p>è¿™æ­£æ˜¯å‘é‡åº“ï¼ˆVector Database / Vector Indexï¼‰çš„ç”¨æ­¦ä¹‹åœ°ã€‚å®ƒä¸å…³å¿ƒæ–‡æœ¬å†…å®¹ï¼Œåªä¸“æ³¨äºä¸€ä»¶äº‹ï¼šç»™å®šä¸€ä¸ªæŸ¥è¯¢å‘é‡ï¼Œåœ¨ç™¾ä¸‡çº§å‘é‡æ± ä¸­å¿«é€Ÿæ‰¾å‡ºæœ€ç›¸ä¼¼çš„è‹¥å¹²ä¸ªã€‚</p>\n<p>åœ¨èµ„æºæåº¦å—é™çš„ä¸ªäººæœåŠ¡å™¨ä¸Šï¼Œæˆ‘ä»¬æ— æ³•éƒ¨ç½²é‡é‡çº§çš„å‘é‡æ•°æ®åº“ï¼ˆå¦‚ Milvus æˆ– Weaviateï¼‰ã€‚ç»è¿‡æƒè¡¡ï¼Œæœ€ç»ˆé€‰æ‹©äº† FAISS â€”â€” ä¸€ä¸ªç”± Meta å¼€æºçš„è½»é‡ã€é«˜æ€§èƒ½ã€çº¯ C++ å®ç°çš„å‘é‡ç›¸ä¼¼æ€§æœç´¢åº“ã€‚å®ƒæ”¯æŒå¤šç§ç´¢å¼•ç±»å‹ï¼ˆå¦‚ IndexFlatIPã€IndexIVFFlatã€HNSW ç­‰ï¼‰ï¼Œæ—¢èƒ½æ»¡è¶³ç²¾ç¡®æœç´¢éœ€æ±‚ï¼Œä¹Ÿèƒ½é€šè¿‡è¿‘ä¼¼ç®—æ³•å¤§å¹…å‹ç¼©å†…å­˜ä¸è®¡ç®—å¼€é”€ã€‚</p>\n<p>é‚£ä¹ˆæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ‰¹é‡æŠŠ Markdown æ ¼å¼çš„åšå®¢æ–‡æ¡£å‘é‡åŒ–ï¼Œå­˜å…¥åˆ° FAISS åˆ›å»ºçš„å‘é‡åº“ä¸­ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œè¿™ä¸ªåŠŸèƒ½æ˜¯æ•´ä¸ªè¯­ä¹‰æœç´¢ç³»ç»Ÿçš„â€œç¦»çº¿æ„å»ºâ€æ ¸å¿ƒ: åœ¨éƒ¨ç½²å‰ä¸€æ¬¡æ€§å°†æ‰€æœ‰åšå®¢æ–‡ç« å¤„ç†ä¸ºå‘é‡ï¼Œå¹¶æŒä¹…åŒ–ä¸º FAISS ç´¢å¼•æ–‡ä»¶ï¼Œä¾›çº¿ä¸Šæœç´¢æœåŠ¡åŠ è½½ä½¿ç”¨ã€‚å…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p>\n<pre><code class=\"language-cpp\">// TaskEmbed.cpp\n#include \"TaskEmbed.h\"\n\n#include &lt;faiss/IndexFlat.h&gt;\n#include &lt;faiss/IndexIDMap.h&gt;\n#include &lt;faiss/index_io.h&gt;\n#include &lt;gflags/gflags.h&gt;\n#include &lt;onnxruntime_cxx_api.h&gt;\n\n#include &lt;filesystem&gt;\n#include &lt;fstream&gt;\n#include &lt;iostream&gt;\n\n#include \"Application/Context.h\"\n#include \"Embedding/BgeOnnxEmbedder.h\"\n#include \"Embedding/MdSemanticSplitter.h\"\n#include \"Embedding/TextChunker.h\"\n#include \"LaunchConfig.h\"\n#include \"LaunchInit.h\"\n#include \"Persistence/Sqlite3Crud.h\"\n#include \"Persistence/TableBlogChunksField.h\"\n#include \"Persistence/TableBlogsField.h\"\n\nusing namespace std;\nusing namespace embedding;\nusing namespace persistence;\n\nDECLARE_string(input);\n\n//æ‰€æœ‰åšæ–‡å‘é‡åŒ–å¹¶å­˜å…¥å‘é‡åº“\nnamespace Bootstrap::Task::Embed {\n\nvoid Run() {\n  if (FLAGS_input.empty() /*|| FLAGS_output.empty()*/) {\n    std::cerr &lt;&lt; \"é”™è¯¯: sitemap ä»»åŠ¡éœ€è¦è¾“å…¥ --input å’Œ --output å‚æ•°\\n\";\n    return;\n  }\n\n  filesystem::path launchConfigPath{FLAGS_input};\n  if (!filesystem::exists(launchConfigPath)) {\n    std::cerr &lt;&lt; \"HTTPæœåŠ¡é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼\" &lt;&lt; endl;\n    return;\n  }\n\n  if (!LaunchInit(launchConfigPath)) {\n    return;\n  }\n\n  application::Context::GetInstance();\n\n  string onnxModelPath = launchConfig.onnxModelPath;\n  string faissIndexPath = launchConfig.faissIndexPath;\n\n  std::filesystem::path modelPath(onnxModelPath);\n  if (!std::filesystem::exists(onnxModelPath)) {\n    std::cerr &lt;&lt; \"Error: ONNX model file does not exist at: \"\n              &lt;&lt; modelPath.string() &lt;&lt; std::endl;\n    return;\n  }\n\n  // è·å–æ¨¡å‹æ‰€åœ¨ç›®å½•ï¼Œå¹¶æ‹¼æ¥ tokenizer.json\n  std::filesystem::path tokenizerJsonFile =\n      modelPath.parent_path() / \"tokenizer.json\";\n\n  // æ£€æŸ¥ tokenizer.json æ˜¯å¦å­˜åœ¨ï¼ˆæ¨èï¼‰\n  if (!std::filesystem::exists(tokenizerJsonFile)) {\n    std::cerr &lt;&lt; \"Warning: tokenizer.json not found at: \"\n              &lt;&lt; tokenizerJsonFile.generic_string() &lt;&lt; std::endl;\n    return;\n  }\n  u8string tokenizerJsonFilePath = tokenizerJsonFile.generic_u8string();\n\n  const size_t chunkMaxTokens = 396;\n\n  vector&lt;Sqlite3Crud::TableValue&gt; result;\n  std::vector&lt;TableBlogsField&gt; fieldNames{\n      TableBlogsField::id,\n      TableBlogsField::title,\n      TableBlogsField::summary,\n      TableBlogsField::content,\n  };\n\n  if (!Sqlite3Crud::Query&lt;TableBlogsField&gt;(TableName::blogs, fieldNames,\n                                           result)) {\n    return;\n  }\n\n  // å…¨é‡é‡å»ºå‰ï¼Œæ¸…ç©º chunk è¡¨\n  if (!Sqlite3Crud::Delete&lt;TableBlogChunksField&gt;(TableName::blog_chunks)) {\n    std::cerr &lt;&lt; \"æ¸…ç©º blog_chunks è¡¨å¤±è´¥ï¼\\n\";\n    return;\n  }\n  std::cout &lt;&lt; \"å·²æ¸…ç©º blog_chunks è¡¨\\n\";\n\n  MdSemanticSplitter mdSplitter;  //æ–‡æ¡£æ‹†åˆ†å™¨\n  hf::Tokenizer tokenizer(\n      (const char *)tokenizerJsonFilePath.c_str());    //åˆå§‹åŒ–åˆ†è¯å™¨\n  TextChunker textChunker(chunkMaxTokens, tokenizer);  // tokenæ„ŸçŸ¥æ–‡æœ¬æ‹†åˆ†\n  BgeOnnxEmbedder embedder(onnxModelPath, tokenizer);\n\n  int64_t embeddingDim = embedder.EmbeddingDim();\n  auto flatIndex =\n      std::make_unique&lt;faiss::IndexFlatIP&gt;(embeddingDim);  // åˆ›å»º FlatIP ç´¢å¼•\n  faiss::IndexIDMap2 index(\n      flatIndex.release());  // è‡ªåŠ¨æ¥ç®¡ flatIndex çš„ç”Ÿå‘½å‘¨æœŸ\n\n  size_t colNum = fieldNames.size();\n  size_t rowNum = result.size() / colNum;\n\n  for (size_t ri = 0; ri &lt; rowNum; ++ri) {\n    size_t m = ri * colNum;\n    string blogId = std::move(std::get&lt;std::string&gt;(result[m]));\n    string title = std::move(std::get&lt;std::string&gt;(result[m + 1]));\n    string summary = std::move(std::get&lt;std::string&gt;(result[m + 2]));\n    string content = std::move(std::get&lt;std::string&gt;(result[m + 3]));\n\n    // if (title != \"C++ä¸­JSONåºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„å®ç°\") {\n    //  continue;\n    //}\n\n    cout &lt;&lt; ri &lt;&lt; '\\t' &lt;&lt; title &lt;&lt; endl;\n\n    std::vector&lt;SemanticBlock&gt; semanticBlocks =\n        mdSplitter.Split(title, content, summary);\n\n    // for (const auto&amp; block : semanticBlocks) {\n    //  cout &lt;&lt; block.context &lt;&lt; endl;\n    //  for (const auto&amp; content : block.contents) {\n    //    cout &lt;&lt; content &lt;&lt; endl;\n    //  }\n    //  cout &lt;&lt; \"----------------------\\n\";\n    //}\n\n    std::vector&lt;std::string&gt; chunks =\n        textChunker.SemanticBlocks(std::move(semanticBlocks));\n\n    // cout &lt;&lt; chunks.size() &lt;&lt; endl;\n    // for (const auto&amp; chunk : chunks) {\n    //  cout &lt;&lt; chunk;\n    //  cout &lt;&lt; \"-----------------------------\\n\";\n    //}\n\n    // åµŒå…¥æ¯ä¸ª chunkï¼Œå¹¶åˆ†é…å”¯ä¸€ ID\n    for (const auto &amp;chunk : chunks) {\n      int64_t chunkId = Sqlite3Crud::InsertAndReturnId&lt;TableBlogChunksField&gt;(\n          TableName::blog_chunks,\n          {TableBlogChunksField::blog_id, TableBlogChunksField::title,\n           TableBlogChunksField::chunk_text},\n          {blogId, title, chunk});\n\n      if (chunkId &lt;= 0) {\n        std::cerr &lt;&lt; \"æ’å…¥ blog_chunks å¤±è´¥\\n\";\n        continue;\n      }\n\n      std::vector&lt;float&gt; embedding = embedder.Embed(chunk);\n      index.add_with_ids(1, embedding.data(), &amp;chunkId);\n    }\n  }\n\n  // ä¿å­˜ç´¢å¼•\n  faiss::write_index(&amp;index, faissIndexPath.c_str());\n}\n}  // namespace Bootstrap::Task::Embed\n</code></pre>\n<p>å¯ä»¥æŠŠä»¥ä¸Šæµç¨‹æ¦‚æ‹¬ä¸ºä¸‰æ­¥ï¼š</p>\n<ol>\n<li>\n<p><strong>æ•°æ®è¯»å–</strong><br />\nä» SQLite æ•°æ®åº“ä¸­å…¨é‡æ‹‰å–åšå®¢çš„ <code>id</code>ã€<code>title</code>ã€<code>summary</code> å’Œ <code>content</code>ï¼Œä½œä¸ºåŸå§‹è¾“å…¥ã€‚</p>\n</li>\n<li>\n<p><strong>æ–‡æœ¬ â†’ å‘é‡</strong><br />\nå¯¹æ¯ç¯‡æ–‡ç« ä¾æ¬¡æ‰§è¡Œï¼š</p>\n<ul>\n<li>ç”¨ <code>MdSemanticSplitter</code> æŒ‰æ ‡é¢˜å±‚çº§æ‹†åˆ†ä¸ºè¯­ä¹‰æ®µï¼›</li>\n<li>ç”¨ <code>TextChunker</code> å°†è¯­ä¹‰æ®µåˆ‡åˆ†ä¸ºä¸è¶…è¿‡ 396 tokens çš„ä¸Šä¸‹æ–‡æ„ŸçŸ¥æ–‡æœ¬å—ï¼ˆé¢„ç•™ç©ºé—´ç»™ <code>[CLS]</code>/<code>[SEP]</code> ç­‰ç‰¹æ®Š tokenï¼‰ï¼›</li>\n<li>è°ƒç”¨ <code>BgeOnnxEmbedder</code> ä¸ºæ¯ä¸ª chunk ç”Ÿæˆ 512 ç»´ L2 å½’ä¸€åŒ–çš„ embeddingã€‚</li>\n</ul>\n</li>\n<li>\n<p><strong>å‘é‡ â†’ ç´¢å¼•</strong><br />\nä½¿ç”¨ FAISS çš„ <code>IndexFlatIP</code>ï¼ˆç²¾ç¡®å†…ç§¯ç´¢å¼•ï¼Œç­‰ä»·äºä½™å¼¦ç›¸ä¼¼åº¦ï¼‰æ„å»ºå‘é‡åº“ï¼Œå¹¶é€šè¿‡ <code>IndexIDMap2</code> å°†æ¯ä¸ªå‘é‡å…³è”åˆ°å…¶åœ¨æ•°æ®åº“ä¸­çš„å”¯ä¸€ <code>chunk_id</code>ã€‚æœ€ç»ˆï¼Œç´¢å¼•è¿åŒ ID æ˜ å°„ä¸€èµ·å†™å…¥ç£ç›˜ï¼ˆå¦‚ <code>faiss.index</code>ï¼‰ã€‚</p>\n</li>\n</ol>\n<p>æ­¤å¤–ï¼Œæ¯ä¸ª chunk çš„å…ƒä¿¡æ¯ï¼ˆæ‰€å±æ–‡ç«  IDã€æ ‡é¢˜ã€åŸå§‹æ–‡æœ¬ï¼‰è¢«å­˜å…¥ <code>blog_chunks</code> è¡¨ï¼Œå®ç°<strong>å‘é‡ ID åˆ°åŸæ–‡å†…å®¹çš„åæŸ¥</strong>â€”â€”è¿™æ˜¯æœç´¢ç»“æœå±•ç¤ºçš„å…³é”®æ¡¥æ¢ã€‚</p>\n<p>è‡³æ­¤ï¼Œä¸€ä¸ªè½»é‡ã€è‡ªåŒ…å«ã€æ— å¤–éƒ¨ä¾èµ–çš„è¯­ä¹‰å‘é‡åº“å°±æ„å»ºå®Œæˆäº†ã€‚</p>\n<h1 id=\"9-ä¸šåŠ¡åº”ç”¨\">9. ä¸šåŠ¡åº”ç”¨</h1>\n<p>æœ€åï¼Œå°±æ˜¯è¿ç”¨è¿™ä¸ªå‘é‡åº“å»å®ç°å…·ä½“çš„ä¸šåŠ¡åº”ç”¨äº†ã€‚</p>\n<h2 id=\"91-åˆå§‹åŒ–\">9.1 åˆå§‹åŒ–</h2>\n<p>å½“å¯åŠ¨åç«¯æ—¶ï¼Œéœ€è¦åˆå§‹åŒ–ç›¸å…³çš„å†…å®¹ï¼š</p>\n<pre><code class=\"language-cpp\">// EmbedComponent.h\n#pragma once\n#include \"Embedding/BgeOnnxEmbedder.h\"\n#include \"Embedding/MdSemanticSplitter.h\"\n#include \"Embedding/NotDeletedIdSelector.h\"\n#include \"Embedding/TextChunker.h\"\n\nnamespace faiss {\nstruct Index;\n}\n\nnamespace application {\nstruct EmbedComponent {\n  explicit EmbedComponent(const std::string&amp; tokenizerJsonFilePath,\n                          size_t chunkMaxTokens,\n                          const std::string&amp; onnxModelPath,\n                          const std::string&amp; faissIndexPath);\n  ~EmbedComponent();\n\n  embedding::MdSemanticSplitter mdSplitter;    // æ–‡æ¡£æ‹†åˆ†å™¨\n  embedding::hf::Tokenizer tokenizer;          // Hfåˆ†è¯å™¨\n  embedding::TextChunker textChunker;          // tokenæ„ŸçŸ¥æ–‡æœ¬æ‹†åˆ†\n  embedding::BgeOnnxEmbedder embedder;         // æ–‡æœ¬åµŒå…¥\n  std::unique_ptr&lt;faiss::Index&gt; index;         // å‘é‡åº“\n  embedding::NotDeletedIdSelector idSelector;  // è®°å½•åˆ é™¤çš„ID\n};\n}  // namespace application\n</code></pre>\n<pre><code class=\"language-cpp\">// EmbedComponent.cpp\n#include \"EmbedComponent.h\"\n\n#include &lt;faiss/Index.h&gt;\n#include &lt;faiss/index_io.h&gt;\n\nnamespace application {\nEmbedComponent::EmbedComponent(const std::string&amp; tokenizerJsonFilePath,\n                               size_t chunkMaxTokens,\n                               const std::string&amp; onnxModelPath,\n                               const std::string&amp; faissIndexPath)\n    : tokenizer((const char*)tokenizerJsonFilePath.c_str()),\n      textChunker(chunkMaxTokens, tokenizer),\n      embedder(onnxModelPath, tokenizer),\n      index(faiss::read_index(faissIndexPath.c_str())) {}\n\nEmbedComponent::~EmbedComponent() = default;\n\n}  // namespace application\n</code></pre>\n<h2 id=\"92-æœç´¢\">9.2 æœç´¢</h2>\n<p>å½“ç”¨æˆ·è¿›è¡Œæœç´¢æ—¶ï¼š</p>\n<pre><code class=\"language-cpp\">#include \"Search.h\"\n\n#include &lt;faiss/Index.h&gt;\n#include &lt;faiss/index_io.h&gt;\n\n#include &lt;iostream&gt;\n#include &lt;set&gt;\n\n#include \"Application/Context.h\"\n#include \"Application/EmbedComponent.h\"\n#include \"Domain/SearchHit.h\"\n#include \"Embedding/BgeOnnxEmbedder.h\"\n#include \"Persistence/Sqlite3Crud.h\"\n#include \"Persistence/TableBlogChunksField.h\"\n\nusing namespace std;\nusing namespace embedding;\nusing namespace persistence;\nusing namespace domain;\nusing namespace application;\n\nnamespace Service {\n\nnamespace search {\n\nbool Posts(const std::string&amp; query,\n           std::vector&lt;domain::SearchHit&gt;&amp; searchHits) {\n  EmbedComponent* embedComponent = Context::GetInstance().GetEmbedComponent();\n\n  const BgeOnnxEmbedder&amp; embedder = embedComponent-&gt;embedder;\n  const faiss::Index* index = embedComponent-&gt;index.get();\n\n  std::vector&lt;float&gt; queryVec = embedder.Embed(query);\n\n  constexpr int k = 200;  // è¿”å› top200\n  std::vector&lt;faiss::idx_t&gt; indices(k);\n  std::vector&lt;float&gt; distances(k);\n\n  faiss::SearchParameters params;\n  params.sel = &amp;(embedComponent-&gt;idSelector);\n  index-&gt;search(1, queryVec.data(), k, distances.data(), indices.data(),\n                &amp;params);\n\n  // è¾“å‡ºç»“æœ\n  set&lt;string&gt; blogIdSet;\n  for (int i = 0; i &lt; k; ++i) {\n    if (indices[i] &lt; 0) {\n      continue;\n    }\n\n    if (distances[i] &lt; 0.5) {\n      break;\n    }\n    // std::cout &lt;&lt; \"Chunk ID: \" &lt;&lt; indices[i] &lt;&lt; \"\\tScore: \" &lt;&lt; distances[i]\n    //          &lt;&lt; \"\\n\";\n\n    int64_t chunkId = indices[i];\n    std::vector&lt;Sqlite3Crud::TableValue&gt; result;\n    Sqlite3Crud::Query&lt;TableBlogChunksField&gt;(\n        TableName::blog_chunks,\n        {TableBlogChunksField::blog_id, TableBlogChunksField::title,\n         TableBlogChunksField::chunk_text},\n        result, {TableBlogChunksField::chunk_id}, {chunkId});\n\n    string blogId = std::move(std::get&lt;string&gt;(result.at(0)));\n    if (blogIdSet.find(blogId) == blogIdSet.end()) {\n      blogIdSet.insert(blogId);\n      SearchHit searchHit;\n      searchHit.id = std::move(blogId);\n      searchHit.title = std::move(std::get&lt;string&gt;(result.at(1)));\n      searchHit.snippetText = std::move(std::get&lt;string&gt;(result.at(2)));\n      searchHits.emplace_back(std::move(searchHit));\n    }\n  }\n\n  return true;\n}\n\n}  // namespace search\n}  // namespace Service\n</code></pre>\n<p>æœ‰äº†é¢„æ„å»ºçš„å‘é‡åº“å’Œé…å¥—çš„å…ƒæ•°æ®è¡¨ï¼ŒçœŸæ­£çš„è¯­ä¹‰æœç´¢å°±å˜å¾—å¼‚å¸¸ç®€æ´ï¼š<strong>å°†ç”¨æˆ·æŸ¥è¯¢ä¹ŸåµŒå…¥ä¸ºå‘é‡ï¼Œç„¶ååœ¨ FAISS ç´¢å¼•ä¸­æ‰§è¡Œè¿‘ä¼¼æœ€è¿‘é‚»ï¼ˆANNï¼‰æŸ¥æ‰¾å³å¯</strong>ã€‚</p>\n<p>æ•´ä¸ªåœ¨çº¿æœç´¢æµç¨‹åˆ†ä¸ºä¸‰æ­¥ï¼š</p>\n<ol>\n<li><strong>æŸ¥è¯¢åµŒå…¥</strong><br />\nç”¨æˆ·è¾“å…¥çš„æœç´¢è¯ï¼ˆå¦‚â€œgitæ’¤å›æäº¤â€ï¼‰é€šè¿‡ä¸æ„å»ºé˜¶æ®µå®Œå…¨ç›¸åŒçš„ <code>BgeOnnxEmbedder</code> æµç¨‹â€”â€”åŒ…æ‹¬ Hugging Face åˆ†è¯ã€ONNX æ¨ç†ã€L2 å½’ä¸€åŒ–â€”â€”è½¬åŒ–ä¸ºä¸€ä¸ª 512 ç»´çš„å•ä½å‘é‡ã€‚è¿™ç¡®ä¿äº†æŸ¥è¯¢å‘é‡ä¸æ–‡æ¡£å‘é‡å¤„äºåŒä¸€è¯­ä¹‰ç©ºé—´ã€‚</li>\n<li><strong>å‘é‡æ£€ç´¢</strong><br />\nå°†æŸ¥è¯¢å‘é‡é€å…¥ FAISS ç´¢å¼•ï¼Œæ‰§è¡Œ <code>index.search()</code>ã€‚æˆ‘ä»¬ä½¿ç”¨å†…ç§¯ï¼ˆIPï¼‰ä½œä¸ºç›¸ä¼¼åº¦åº¦é‡ï¼ˆå› å‘é‡å·² L2 å½’ä¸€åŒ–ï¼ŒIP ç­‰ä»·äºä½™å¼¦ç›¸ä¼¼åº¦ï¼‰ï¼Œå¹¶è¯·æ±‚ Top-Kï¼ˆä¾‹å¦‚ K=200ï¼‰æœ€ç›¸ä¼¼çš„ chunk ID åŠå…¶å¾—åˆ†ã€‚</li>\n<li><strong>ç»“æœç»„è£…ä¸å»é‡</strong><br />\næ ¹æ®è¿”å›çš„ chunk IDï¼Œä» <code>blog_chunks</code> è¡¨ä¸­æŸ¥å‡ºå¯¹åº”çš„åŸå§‹æ–‡æœ¬ã€æ‰€å±æ–‡ç« æ ‡é¢˜å’Œåšå®¢ IDã€‚ä¸ºé¿å…åŒä¸€ç¯‡æ–‡ç« å› å¤šä¸ª chunk è¢«é‡å¤å¬å›ï¼Œæˆ‘ä»¬æŒ‰ <code>blog_id</code> å»é‡ï¼Œä¼˜å…ˆä¿ç•™å¾—åˆ†æœ€é«˜çš„ç‰‡æ®µï¼Œå¹¶å°†å…¶ä½œä¸ºæœç´¢ç»“æœçš„æ‘˜è¦ï¼ˆsnippetï¼‰å‘ˆç°ç»™ç”¨æˆ·ã€‚</li>\n</ol>\n<h2 id=\"93-æ–°å¢\">9.3 æ–°å¢</h2>\n<p>æ‰¹é‡å‘é‡åŒ–æ‰€æœ‰çš„åšæ–‡æˆæœ¬å¤ªé«˜ï¼Œæœ€å¥½æ˜¯èƒ½å¤Ÿå®ç°å¢é‡æ›´æ–°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>\n<pre><code class=\"language-cpp\">// ä¸ºåšå®¢ç”Ÿæˆå¹¶æ·»åŠ å‘é‡åµŒå…¥ï¼ˆç”¨äºè¯­ä¹‰æœç´¢ï¼‰\nstatic void AddBlogEmbedding(const string&amp; blogId, const string&amp; title,\n                             const string&amp; content, const string&amp; summary) {\n  //æ–‡æ¡£æ‹†åˆ†\n  const EmbedComponent* embedComponent =\n      Context::GetInstance().GetEmbedComponent();\n  std::vector&lt;std::string&gt; chunks = embedComponent-&gt;textChunker.SemanticBlocks(\n      std::move(embedComponent-&gt;mdSplitter.Split(title, content, summary)));\n\n  // åµŒå…¥æ¯ä¸ª chunkï¼Œå¹¶åˆ†é…å”¯ä¸€ ID\n  for (const auto&amp; chunk : chunks) {\n    int64_t chunkId = Sqlite3Crud::InsertAndReturnId&lt;TableBlogChunksField&gt;(\n        TableName::blog_chunks,\n        {TableBlogChunksField::blog_id, TableBlogChunksField::title,\n         TableBlogChunksField::chunk_text},\n        {blogId, title, chunk});\n\n    if (chunkId &lt;= 0) {\n      std::cerr &lt;&lt; \"æ’å…¥ blog_chunks å¤±è´¥\\n\";\n      continue;\n    }\n\n    std::vector&lt;float&gt; embedding = embedComponent-&gt;embedder.Embed(chunk);\n    embedComponent-&gt;index-&gt;add_with_ids(1, embedding.data(), &amp;chunkId);\n  }\n\n  // åˆ›å»ºæ–°çº¿ç¨‹æ¥å†™å…¥ï¼Œæå‡å“åº”æ—¶é—´\n  // Todoï¼šåæœŸè€ƒè™‘ç§»æ¤åˆ°å®šæ—¶ä»»åŠ¡ä¸­ï¼Œå¹¶ä¸”éœ€è¦ä¿è¯æ¨å‡ºåæ­£å¸¸å†™å‡º\n  std::thread writeIndexThread([embedComponent]() {\n    faiss::write_index(embedComponent-&gt;index.get(),\n                       launchConfig.faissIndexPath.c_str());\n  });\n\n  // ç¡®ä¿ä¸»çº¿ç¨‹ä¸ç­‰å¾…æ­¤çº¿ç¨‹å®Œæˆï¼Œé¿å…é˜»å¡\n  writeIndexThread.detach();\n}\n</code></pre>\n<p>è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä½¿ç”¨ <code>IndexIDMap2</code> çš„åŸå› ï¼šå¯ä»¥å°†æ–°å¢çš„å‘é‡å…³è”åˆ°å…¶åœ¨æ•°æ®åº“ä¸­å…ƒæ•°æ®çš„å”¯ä¸€ <code>chunk_id</code> ä¸Šã€‚ç”±äºåœ¨åˆå§‹åŒ–æ—¶å·²ç»å°†å‘é‡ç´¢å¼•è¯»å–åˆ°å†…å­˜ä¸­ï¼Œåœ¨æ–°å¢å‘é‡ååªéœ€è¦å†å°†å‘é‡ç´¢å¼•å¯¹è±¡ä¿å­˜å³å¯ã€‚</p>\n<h2 id=\"94-åˆ é™¤\">9.4 åˆ é™¤</h2>\n<p>åˆ é™¤çš„å®ç°æœ‰ç‚¹éº»çƒ¦ï¼Œå› ä¸º FAISS çš„ <code>IndexFlatIP</code> æ²¡æœ‰æä¾›åˆ é™¤çš„æ¥å£ã€‚å½“ç„¶è¿™ä¹Ÿä¸æ˜¯è®¾è®¡ç¼ºé™·ï¼Œè€Œæ˜¯æ•°æ®ç»“æ„å°±æ˜¯è¿™ä¹ˆè®¾è®¡çš„ï¼Œä¸ºäº†ä¿è¯æ£€ç´¢çš„æ€§èƒ½å¿…ç„¶æœ‰æ‰€èˆå¼ƒã€‚å› æ­¤ï¼Œè¦å®ç°åˆ é™¤åªèƒ½è½¯åˆ é™¤ï¼Œä¹Ÿå°±æ˜¯åœ¨å…ƒæ•°æ®ä¸­æ ‡è®°ä¸€ä¸‹ç›¸åº”çš„ chunk å·²ç»è¢«åˆ é™¤äº†ã€‚åŒæ—¶ï¼Œè¦æ³¨æ„åˆ°å‰é¢åœ¨æœç´¢çš„å®ç°ä¸­ï¼Œ<code>index.search()</code> ä¼ å…¥ä¸€ä¸ªè‡ªå®šä¹‰çš„ <code>IDSelector</code>å‚æ•°å¯¹è±¡ï¼š</p>\n<pre><code class=\"language-cpp\">// NotDeletedIdSelector.h\n#pragma once\n\n#include &lt;faiss/impl/IDSelector.h&gt;\n\n#include &lt;unordered_set&gt;\n\nnamespace embedding {\n\n/// @brief å®šä¹‰ä¸€ä¸ª selectorï¼šåªä¿ç•™â€œæœªè¢«åˆ é™¤â€çš„ ID\nclass NotDeletedIdSelector : public faiss::IDSelector {\n public:\n  // æ„é€ æ—¶ä¼ å…¥â€œå·²åˆ é™¤çš„ ID é›†åˆâ€\n  // explicit NotDeletedIDSelector();\n\n  // é‡å†™ is_memberï¼šå¦‚æœ id åœ¨ deletedSet ä¸­ï¼Œè¿”å› falseï¼ˆå±è”½ï¼‰\n  bool is_member(faiss::idx_t id) const override;\n\n  void Add(faiss::idx_t id);\n\n private:\n  std::unordered_set&lt;faiss::idx_t&gt; deletedSet;\n};\n\n}  // namespace embedding\n</code></pre>\n<pre><code class=\"language-cpp\">// NotDeletedIdSelector.cpp\n#include \"NotDeletedIdSelector.h\"\n\nnamespace embedding {\n\n// é‡å†™ is_memberï¼šå¦‚æœ id åœ¨ deletedSet ä¸­ï¼Œè¿”å› falseï¼ˆå±è”½ï¼‰\nbool NotDeletedIdSelector::is_member(faiss::idx_t id) const {\n  return deletedSet.find(id) == deletedSet.end();\n}\n\nvoid NotDeletedIdSelector::Add(faiss::idx_t id) { deletedSet.insert(id); }\n\n}  // namespace embedding\n</code></pre>\n<p>è¿™ä¸ª <code>NotDeletedIdSelector</code> å¯¹è±¡ä¼ å…¥ <code>index.search()</code> æ—¶ä¼šåŠ¨æ€è¿‡æ»¤æ‰å·²è¢«æ ‡è®°åˆ é™¤çš„ chunk IDï¼Œå®ç°â€œé€»è¾‘åˆ é™¤â€è€Œæ— éœ€ç‰©ç†é‡å»ºç´¢å¼•ã€‚æ­£å› ä¸ºå¦‚æ­¤ï¼Œåœ¨åˆ é™¤æ“ä½œæ—¶ï¼Œéœ€è¦è®°å½•æ ‡è®°åˆ é™¤çš„ chunk IDï¼š</p>\n<pre><code class=\"language-cpp\">// ä»å‘é‡ç´¢å¼•ä¸­ç§»é™¤åšå®¢çš„åµŒå…¥ï¼Œå¹¶æ ‡è®° chunk ä¸ºå·²åˆ é™¤\nstatic void RemoveBlogEmbedding(const std::string&amp; blogId) {\n  std::vector&lt;Sqlite3Crud::TableValue&gt; result;\n  Sqlite3Crud::Query&lt;TableBlogChunksField&gt;(\n      TableName::blog_chunks, {TableBlogChunksField::chunk_id}, result,\n      {TableBlogChunksField::blog_id}, {blogId});\n\n  EmbedComponent* embedComponent = Context::GetInstance().GetEmbedComponent();\n  for (const auto&amp; value : result) {\n    embedComponent-&gt;idSelector.Add(std::get&lt;int64_t&gt;(value));\n  }\n\n  Sqlite3Crud::Update&lt;TableBlogChunksField&gt;(\n      TableName::blog_chunks,\n      {TableBlogChunksField::is_deleted, TableBlogChunksField::blog_id},\n      {1LL, blogId});\n}\n</code></pre>\n<p>å½“ç„¶ï¼Œåœ¨åˆå§‹åŒ–æ—¶ä¹Ÿè¦è®°å½•è¿™äº›è¢«æ ‡è®°åˆ é™¤çš„ chunk IDï¼š</p>\n<pre><code class=\"language-cpp\">std::vector&lt;Sqlite3Crud::TableValue&gt; result;\nSqlite3Crud::Query&lt;TableBlogChunksField&gt;(\n    TableName::blog_chunks, {TableBlogChunksField::chunk_id}, result,\n    {TableBlogChunksField::is_deleted}, {1});\n\nfor (const auto &amp;value : result) {\n  embedComponent-&gt;idSelector.Add(std::get&lt;int64_t&gt;(value));\n}\n</code></pre>\n<h2 id=\"95-æ›´æ–°\">9.5 æ›´æ–°</h2>\n<p>å¦‚æœè¦æ›´æ–°åšæ–‡åµŒå…¥çš„ç›¸å…³å†…å®¹ï¼Œç”±äºåµŒå…¥æ“ä½œçš„å¤æ‚æ€§ï¼Œç›´æ¥åˆ é™¤åæ–°å¢å³å¯ï¼Œç›´æ¥å¤ç”¨å‰é¢çš„è½¯åˆ é™¤å’Œå¢é‡æ›´æ–°ï¼š</p>\n<pre><code class=\"language-cpp\">RemoveBlogEmbedding(blogId);\nAddBlogEmbedding(blogId, blogMeta.title, blogData.content, blogMeta.summary);\n</code></pre>\n<h1 id=\"10-ä¼˜åŒ–æå‡\">10. ä¼˜åŒ–æå‡</h1>\n<p>è‡³æ­¤ï¼Œä¸€ä¸ªä»é›¶æ„å»ºã€ç«¯åˆ°ç«¯çš„è½»é‡çº§è¯­ä¹‰æœç´¢ç³»ç»Ÿä¾¿å®Œæ•´è½åœ°ã€‚æ•´ä¸ªæœç´¢è¿‡ç¨‹ä¸ä¾èµ–ä»»ä½•å¤–éƒ¨æœåŠ¡ï¼Œä»…éœ€åŠ è½½ä¸€æ¬¡ FAISS ç´¢å¼•å’Œ ONNX æ¨¡å‹ï¼Œå³å¯åœ¨æ¯«ç§’çº§å†…å“åº”æŸ¥è¯¢ã€‚åœ¨ 1GB å†…å­˜çš„äº‘æœåŠ¡å™¨ä¸Šï¼Œå†…å­˜å ç”¨ç¨³å®šåœ¨ 200MB ä»¥å†…ï¼ˆåç«¯ç¨‹åº+åµŒå…¥æ¨¡å‹+å‘é‡åº“ï¼‰ï¼Œå®Œç¾å¥‘åˆâ€œæè‡´æ€§èƒ½ + æè‡´èµ„æºæ•ˆç‡â€çš„åˆå§‹ç›®æ ‡ã€‚åœ¨æ€§èƒ½å’Œæ•ˆç‡æ–¹é¢ç¬”è€…å·²ç»æ¯”è¾ƒæ»¡æ„äº†ï¼Œæœ‰æ—¶é—´å°±æµ‹è¯•ä¸€ä¸‹å…·ä½“çš„æ€§èƒ½å‚æ•°ä»¥åŠä¸ Python ç”Ÿæ€çš„å¯¹æ¯”ã€‚</p>\n<p>ä¸è¿‡ï¼Œç”±äºå®ç°çš„æ¯”è¾ƒä»“ä¿ƒï¼Œå…¶å®è¿˜æœ‰å¾ˆå¤šå¯ä»¥ä¼˜åŒ–å’Œæå‡çš„åœ°æ–¹ï¼š</p>\n<h2 id=\"101-æ··åˆæ£€ç´¢\">10.1 æ··åˆæ£€ç´¢</h2>\n<p>å°½ç®¡åŸºäºå‘é‡çš„è¯­ä¹‰æœç´¢åœ¨ç†è§£ç”¨æˆ·æ„å›¾ã€å¤„ç†åŒä¹‰è¯å’Œæ¨¡ç³Šè¡¨è¾¾æ–¹é¢å±•ç°å‡ºå¼ºå¤§èƒ½åŠ›ï¼Œä½†å®ƒå¹¶éä¸‡èƒ½ï¼š</p>\n<ul>\n<li><strong>ç»†èŠ‚ä¸¢å¤±é—®é¢˜</strong>ï¼šè¯­ä¹‰åµŒå…¥å€¾å‘äºæ•æ‰æ•´ä½“è¯­ä¹‰ï¼Œè€Œå¯¹ç²¾ç¡®å…³é”®è¯æ•æ„Ÿåº¦è¾ƒä½ã€‚å½“ç”¨æˆ·æ˜ç¡®çŸ¥é“è¦æ‰¾æŸä¸ªå…·ä½“æœ¯è¯­æ—¶ï¼Œè¯­ä¹‰æ¨¡å‹å¯èƒ½å› â€œè¿‡åº¦æ³›åŒ–â€è€Œå°†ç›¸å…³ä½†ä¸ç²¾ç¡®çš„ç»“æœæ’åœ¨å‰é¢ï¼Œåè€Œæ¼æ‰çœŸæ­£åŒ¹é…çš„æ–‡æ¡£ã€‚</li>\n<li><strong>é•¿å°¾æŸ¥è¯¢è¡¨ç°ä¸ç¨³å®š</strong>ï¼šå¯¹äºç½•è§æœ¯è¯­ã€ä¸“ä¸šç¼©å†™æˆ–æ‹¼å†™å˜ä½“ï¼ŒåµŒå…¥æ¨¡å‹è‹¥æœªåœ¨è®­ç»ƒæ•°æ®ä¸­å……åˆ†è¦†ç›–ï¼Œå…¶å‘é‡è¡¨ç¤ºå¯èƒ½åç¦»çœŸå®è¯­ä¹‰ï¼Œå¯¼è‡´æ£€ç´¢å¤±æ•ˆã€‚</li>\n<li><strong>å¯æ§æ€§å¼±</strong>ï¼šä¼ ç»Ÿå…³é”®è¯æœç´¢å¯é€šè¿‡å¸ƒå°”é€»è¾‘ï¼ˆAND/OR/NOTï¼‰ã€å­—æ®µé™å®šï¼ˆtitle:xxxï¼‰ã€é€šé…ç¬¦ç­‰æä¾›ç²¾ç»†æ§åˆ¶ï¼Œè€Œçº¯å‘é‡æœç´¢ç¼ºä¹æ­¤ç±»æœºåˆ¶ï¼Œéš¾ä»¥æ»¡è¶³é«˜çº§ç”¨æˆ·çš„ç²¾ç¡®ç­›é€‰éœ€æ±‚ã€‚</li>\n</ul>\n<p>å› æ­¤ï¼Œ<strong>å•ä¸€ä¾èµ–è¯­ä¹‰æœç´¢å¹¶ä¸è¶³ä»¥è¦†ç›–å…¨éƒ¨æœç´¢åœºæ™¯</strong>ã€‚æ›´åˆç†çš„æ–¹æ¡ˆæ˜¯æ„å»º<strong>æ··åˆæ£€ç´¢ç³»ç»Ÿï¼ˆHybrid Searchï¼‰</strong>ï¼šå°†<strong>å…³é”®è¯åŒ¹é…ï¼ˆå¦‚ BM25ï¼‰</strong> ä¸ <strong>å‘é‡ç›¸ä¼¼åº¦æ£€ç´¢</strong> çš„ç»“æœè¿›è¡Œèåˆâ€”â€”ä¾‹å¦‚é€šè¿‡åŠ æƒæ‰“åˆ†ï¼ˆReciprocal Rank Fusionï¼‰ã€é‡æ’åºï¼ˆRerankï¼‰æˆ–å‰ç«¯åˆ† Tab å±•ç¤ºã€‚è¿™æ ·æ—¢èƒ½åˆ©ç”¨è¯­ä¹‰æœç´¢ç†è§£â€œæ’¤å› Git æäº¤â€ç­‰è‡ªç„¶è¯­è¨€æŸ¥è¯¢ï¼Œåˆèƒ½ç¡®ä¿â€œ<code>git revert HEAD</code>â€è¿™ç±»ç²¾ç¡®å‘½ä»¤è¢«å‡†ç¡®å‘½ä¸­ã€‚</p>\n<h2 id=\"102-åˆ†å—å™¨å¼ºåŒ–\">10.2 åˆ†å—å™¨å¼ºåŒ–</h2>\n<p>åœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œè¿™é‡Œåˆ†å—å™¨ <strong>ç»“æ„æ„ŸçŸ¥ + å¥å­å¯¹é½ + ä¸Šä¸‹æ–‡æ³¨å…¥</strong> çš„ä¸‰é‡ç­–ç•¥ï¼Œå·²åœ¨æ•ˆæœä¸æ•ˆç‡ä¹‹é—´å–å¾—äº†ä»¤äººæ»¡æ„çš„å¹³è¡¡ã€‚ä¸è¿‡ï¼Œåœ¨æ›´å¤æ‚çš„ RAG ç³»ç»Ÿä¸­ï¼Œå¯èƒ½è¿˜éœ€è¦ä»¥ä¸‹ä¼˜åŒ–ï¼š</p>\n<ul>\n<li>å†…å®¹ç±»å‹æ„ŸçŸ¥åˆ†å—ï¼šå¯¹ä»£ç å—ã€è¡¨æ ¼ã€LaTeX å…¬å¼ç­‰éè¿ç»­æ–‡æœ¬è¿›è¡Œç‰¹æ®Šå¤„ç†ã€‚ä¾‹å¦‚ï¼Œå°†å®Œæ•´ä»£ç å—è§†ä¸ºä¸å¯åˆ†å‰²å•å…ƒï¼›å¯¹è¡¨æ ¼æŒ‰è¡Œæˆ–è¯­ä¹‰åˆ—æ‹†åˆ†ï¼›é¿å…åœ¨å…¬å¼ä¸­é—´å¼ºè¡Œåˆ‡åˆ†ã€‚</li>\n<li>åŠ¨æ€è¯­ä¹‰è¾¹ç•Œæ£€æµ‹ï¼šå¼•å…¥è½»é‡çº§è¯­è¨€æ¨¡å‹ï¼ˆå¦‚ Sentence-BERT æˆ–ä¸“ç”¨è¾¹ç•Œåˆ†ç±»å™¨ï¼‰è¯†åˆ«æ®µè½å†…éƒ¨çš„è¯­ä¹‰è½¬æŠ˜ç‚¹ï¼Œå®ç°æ›´è‡ªç„¶çš„åˆ†æ®µï¼Œè€Œéä»…ä¾èµ–æ ‡ç‚¹æˆ–å›ºå®šé•¿åº¦ã€‚</li>\n<li>æ»‘åŠ¨çª—å£é‡å æœºåˆ¶ï¼šåœ¨å›ºå®šæœ€å¤§ token é•¿åº¦ï¼ˆå¦‚ 512ï¼‰åŸºç¡€ä¸Šï¼Œé‡‡ç”¨æ»‘åŠ¨çª—å£ï¼ˆå¦‚æ­¥é•¿ 384ï¼Œé‡å  128 tokensï¼‰ç”Ÿæˆè¿ç»­é‡å å—ã€‚è¿™èƒ½ç¼“è§£å› ç¡¬æ€§åˆ‡åˆ†å¯¼è‡´çš„å…³é”®ä¿¡æ¯è¢«å‰²è£‚çš„é—®é¢˜ï¼Œå°¤å…¶é€‚ç”¨äºé•¿æŠ€æœ¯è¯´æ˜æˆ–è¿è´¯è®ºè¯æ®µè½ã€‚</li>\n<li>åˆ—è¡¨ä¸æšä¸¾é¡¹ç²¾ç»†åŒ–å¤„ç†ï¼šå½“å‰åˆ†å—å™¨å¯èƒ½å°†å¤šè¡Œæ— åº/æœ‰åºåˆ—è¡¨æ•´ä½“ä¿ç•™ï¼Œä½†è‹¥åˆ—è¡¨é¡¹æœ¬èº«è¾ƒé•¿ä¸”ç‹¬ç«‹ï¼Œå¯è¿›ä¸€æ­¥æŒ‰é¡¹æ‹†åˆ†ï¼Œå¹¶ä¸ºæ¯é¡¹æ³¨å…¥æ‰€å±æ ‡é¢˜ä¸Šä¸‹æ–‡ï¼Œæå‡ç»†ç²’åº¦æ£€ç´¢èƒ½åŠ›ã€‚</li>\n<li>è·¨å—ä¸Šä¸‹æ–‡é“¾æ¥ï¼šåœ¨å­˜å‚¨ chunk æ—¶ï¼Œé¢å¤–è®°å½•å…¶å‰é©±/åç»§ chunk IDï¼Œä¾¿äºåœ¨åç»­ RAG é˜¶æ®µæ‹¼æ¥ä¸Šä¸‹æ–‡ï¼Œè¿˜åŸæ›´å®Œæ•´çš„åŸå§‹è¯­å¢ƒã€‚</li>\n</ul>\n<p>è¿™äº›æ”¹è¿›å¹¶ééƒ½è¦åŒæ—¶å¼•å…¥ï¼Œè€Œåº”æ ¹æ®å®é™…å†…å®¹åˆ†å¸ƒå’Œç”¨æˆ·æŸ¥è¯¢æ¨¡å¼é€æ­¥è¿­ä»£ã€‚æ¯•ç«Ÿï¼Œåˆ†å—çš„æœ¬è´¨æ˜¯åœ¨â€œä¿¡æ¯å¯†åº¦â€ã€â€œè¯­ä¹‰å®Œæ•´æ€§â€ä¸â€œæ£€ç´¢æ•ˆç‡â€ä¹‹é—´å¯»æ‰¾æœ€ä¼˜å¹³è¡¡ç‚¹â€”â€”è€Œè¿™ä¸ªå¹³è¡¡ç‚¹ï¼Œä¼šéšç€ä¸šåŠ¡æ¼”è¿›è€Œä¸æ–­ç§»åŠ¨ã€‚</p>\n<h2 id=\"103-é«˜äº®æº¯æº\">10.3 é«˜äº®æº¯æº</h2>\n<p>å½“å‰æœç´¢ç»“æœè™½å·²è¿”å› <code>snippetText</code>ï¼ˆå³å‘½ä¸­çš„æ–‡æœ¬ç‰‡æ®µï¼‰ï¼Œä½†ç”¨æˆ·ä»éœ€è‡ªè¡Œåœ¨åŸæ–‡ä¸­å®šä½å…³é”®è¯ä½ç½®ï¼Œä½“éªŒä¸å¤Ÿç›´è§‚ã€‚ä¸ºæå‡å¯ç”¨æ€§ï¼Œåº”å®ç°<strong>å…³é”®è¯é«˜äº®ä¸ç‰‡æ®µæº¯æº</strong>åŠŸèƒ½ã€‚</p>\n<p>å…¶å®ç°å¯åˆ†ä¸ºä¸¤æ­¥ï¼š</p>\n<ol>\n<li>\n<p><strong>å‘½ä¸­è¯æå–ä¸é«˜äº®</strong><br />\nåœ¨è¿”å› <code>snippetText</code> å‰ï¼Œå¯¹åŸå§‹æŸ¥è¯¢è¿›è¡Œåˆ†è¯ï¼ˆå¤ç”¨ <code>Tokenizer</code>ï¼‰ï¼Œæå–æ ¸å¿ƒå…³é”®è¯ï¼ˆæˆ–ä½¿ç”¨ BM25 é€†å‘åŒ¹é…é«˜é¢‘ termï¼‰ï¼Œç„¶ååœ¨ <code>snippetText</code> ä¸­è¿›è¡Œä¸åŒºåˆ†å¤§å°å†™çš„å­ä¸²åŒ¹é…ï¼Œå¹¶ç”¨ <code>&lt;mark&gt;</code> æˆ– <code>**</code> ç­‰æ ‡è®°åŒ…è£¹å‘½ä¸­è¯ã€‚ä¾‹å¦‚ï¼š</p>\n<blockquote>\n<p>â€œå¦‚ä½•<strong>æ’¤å›</strong> Git <strong>æäº¤</strong>â€ â†’ â€œ...å¯ä»¥ä½¿ç”¨ <code>git revert</code> æ¥<strong>æ’¤å›</strong>æŸæ¬¡<strong>æäº¤</strong>...â€</p>\n</blockquote>\n</li>\n<li>\n<p><strong>ä¸Šä¸‹æ–‡æ‰©å±•ä¸é”šç‚¹å®šä½</strong><br />\nå½“å‰ <code>snippetText</code> ä»…ä¸º chunk å†…å®¹ï¼Œå¯èƒ½ç¼ºä¹è¶³å¤Ÿä¸Šä¸‹æ–‡ã€‚å¯è¿›ä¸€æ­¥æ ¹æ® chunk æ‰€å±çš„æ®µè½ç»“æ„ï¼ˆå¦‚ Markdown æ ‡é¢˜å±‚çº§ï¼‰ï¼Œå‘å‰/åæ‰©å±• 1â€“2 å¥ä½œä¸ºè¡¥å……ä¸Šä¸‹æ–‡ï¼Œå¹¶åœ¨å‰ç«¯é€šè¿‡æ»šåŠ¨é”šç‚¹ï¼ˆå¦‚ <code>#chunk-12345</code>ï¼‰ç›´æ¥è·³è½¬åˆ°åŸæ–‡å¯¹åº”ä½ç½®ï¼Œå®ç°â€œæ‰€è§å³æ‰€è¾¾â€çš„æº¯æºä½“éªŒã€‚</p>\n</li>\n</ol>\n<p>é«˜äº®æº¯æºè™½æ˜¯ç»†èŠ‚ï¼Œå´æ˜¯è¿æ¥â€œæ£€ç´¢ç»“æœâ€ä¸â€œç”¨æˆ·ä¿¡ä»»â€çš„å…³é”®ä¸€ç¯â€”â€”è®©ç”¨æˆ·ä¸€çœ¼çœ‹æ¸…â€œä¸ºä»€ä¹ˆè¿™æ¡ç»“æœè¢«å¬å›â€ï¼Œä»è€Œæå‡æœç´¢ç³»ç»Ÿçš„é€æ˜åº¦ä¸å¯ä¿¡åº¦ã€‚</p>\n<h2 id=\"104-å‘é‡ç´¢å¼•\">10.4 å‘é‡ç´¢å¼•</h2>\n<p>åœ¨ç›®å‰å°è§„æ¨¡åœºæ™¯ï¼ˆé€šå¸¸å‡ ç™¾åˆ°å‡ åƒä¸ª chunkï¼‰ï¼Œä½¿ç”¨ <code>IndexFlatIP</code> ç²¾ç¡®æœç´¢çš„å¼€é”€å®Œå…¨å¯æ¥å—ï¼Œä¸”èƒ½ä¿è¯æœ€é«˜å¬å›è´¨é‡ã€‚è‹¥æœªæ¥æ•°æ®é‡æ¿€å¢ï¼Œå¯æ— ç¼æ›¿æ¢ä¸º <code>IndexIVFFlat</code> æˆ– <code>HNSW</code> ç­‰è¿‘ä¼¼ç´¢å¼•ï¼Œè€Œä¸Šå±‚æ¥å£ä¸å˜ã€‚</p>\n<p>ä¸ºäº†ä¾¿äºåç»­æ¼”è¿›ï¼Œè¿™é‡Œç»™å‡ºä¸€ä¸ªåŸºäºæ•°æ®è§„æ¨¡çš„ç»éªŒæ€§å‡çº§è·¯å¾„å»ºè®®ï¼š</p>\n<table>\n<thead>\n<tr>\n<th><strong>Chunk æ•°é‡èŒƒå›´</strong></th>\n<th><strong>æ¨è FAISS ç´¢å¼•ç±»å‹</strong></th>\n<th><strong>ç‰¹ç‚¹ä¸é€‚ç”¨åœºæ™¯</strong></th>\n<th><strong>å…¸å‹å‚æ•°ï¼ˆç¤ºä¾‹ï¼‰</strong></th>\n<th><strong>æ˜¯å¦æ”¯æŒåŠ¨æ€æ’å…¥</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>â‰¤ 10,000</td>\n<td><code>IndexFlatIP</code></td>\n<td>ç²¾ç¡®æœç´¢ï¼Œå®ç°ç®€å•ï¼Œå»¶è¿Ÿæä½ï¼ˆ&lt;10msï¼‰ï¼Œé€‚åˆå°è§„æ¨¡é™æ€çŸ¥è¯†åº“</td>\n<td>æ— </td>\n<td>âœ… æ˜¯</td>\n</tr>\n<tr>\n<td>10,000 ~ 100,000</td>\n<td><code>IndexIVFFlat</code></td>\n<td>è¿‘ä¼¼æœç´¢ï¼Œé€šè¿‡èšç±»åŠ é€Ÿï¼Œå¬å›ç‡é«˜ï¼ˆ&gt;95%ï¼‰ï¼Œé€‚åˆä¸­ç­‰è§„æ¨¡ã€éœ€é¢‘ç¹å¢é‡æ›´æ–°çš„åœºæ™¯</td>\n<td><code>nlist=100</code>, <code>nprobe=10</code></td>\n<td>âœ… æ˜¯</td>\n</tr>\n<tr>\n<td>&gt; 100,000</td>\n<td><code>IndexHNSW</code></td>\n<td>å›¾ç»“æ„è¿‘ä¼¼æœç´¢ï¼ŒæŸ¥è¯¢é€Ÿåº¦æå¿«ä¸”å‡ ä¹ä¸éšæ•°æ®å¢é•¿å˜æ…¢ï¼Œé€‚åˆå¤§è§„æ¨¡ã€é«˜å¹¶å‘åªè¯»åœºæ™¯</td>\n<td><code>M=32</code>, <code>efConstruction=200</code>, <code>efSearch=64</code></td>\n<td>âŒ å¦ï¼ˆFAISS é»˜è®¤ä¸æ”¯æŒï¼‰</td>\n</tr>\n<tr>\n<td>&gt; 1,000,000ï¼ˆè¶…å¤§è§„æ¨¡ï¼‰</td>\n<td><code>IndexIVFPQ</code> æˆ– <code>HNSW+PQ</code></td>\n<td>å¼•å…¥å‘é‡é‡åŒ–ï¼ˆProduct Quantizationï¼‰å‹ç¼©å†…å­˜ï¼Œç‰ºç‰²å°‘é‡ç²¾åº¦æ¢å–æ›´ä½å†…å­˜å ç”¨å’Œæ›´å¿«æ£€ç´¢</td>\n<td><code>nlist=1000</code>, <code>pq.M=64</code>, <code>pq.nbits=8</code></td>\n<td>âœ…ï¼ˆIVF æ”¯æŒï¼‰</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"105-ä¸šåŠ¡æ€§èƒ½\">10.5 ä¸šåŠ¡æ€§èƒ½</h2>\n<p>åœ¨æ¶‰åŠåšæ–‡çš„å¢åˆ æ”¹ï¼ˆCRUDï¼‰æ“ä½œæ—¶ï¼Œ<strong>åµŒå…¥ç”Ÿæˆä¸ç´¢å¼•æ›´æ–°å±äºè¾…åŠ©æ€§åå°ä»»åŠ¡</strong>ï¼Œå¹¶ä¸å½±å“ä¸»ä¸šåŠ¡æµç¨‹ï¼ˆå¦‚æ–‡ç« å‘å¸ƒã€ç¼–è¾‘ä¿å­˜ç­‰ï¼‰ã€‚ç”¨æˆ·çš„æ ¸å¿ƒè¯‰æ±‚æ˜¯â€œæ“ä½œå³æ—¶å“åº”â€ï¼Œè€Œå¯¹æœç´¢ç»“æœçš„æ”¶å½•å»¶è¿Ÿé€šå¸¸å…·æœ‰è¾ƒé«˜å®¹å¿åº¦â€”â€”å‡ ç§’ç”šè‡³å‡ åˆ†é’Ÿçš„æ»ååœ¨å¤§å¤šæ•°åœºæ™¯ä¸‹æ˜¯å¯ä»¥æ¥å—çš„ã€‚</p>\n<p>å› æ­¤ï¼Œ<strong>ä¸åº”åœ¨ä¸»çº¿ç¨‹ä¸­åŒæ­¥æ‰§è¡ŒåµŒå…¥è®¡ç®—ä¸ FAISS å†™å…¥</strong>ï¼Œå¦åˆ™ä¼šæ˜¾è‘—æ‹–æ…¢ HTTP å“åº”æ—¶é—´ï¼Œå°¤å…¶å½“ ONNX æ¨ç†æˆ–ç£ç›˜ I/O æˆä¸ºç“¶é¢ˆæ—¶ã€‚</p>\n<p>æ¨èé‡‡ç”¨ä»¥ä¸‹ç­–ç•¥ä¹‹ä¸€ï¼š</p>\n<ul>\n<li><strong>å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—ï¼ˆæ¨èï¼‰</strong>ï¼šå°†åµŒå…¥ä»»åŠ¡ï¼ˆå¦‚ <code>AddBlogEmbedding</code> / <code>RemoveBlogEmbedding</code>ï¼‰æ¨å…¥å†…å­˜é˜Ÿåˆ—æˆ–è½»é‡çº§ä»»åŠ¡è°ƒåº¦å™¨ï¼ˆå¦‚åŸºäº <code>std::queue</code> + å•ç‹¬å·¥ä½œçº¿ç¨‹ï¼‰ï¼Œç”±åå°çº¿ç¨‹æŒ‰åºå¤„ç†ã€‚è¿™æ ·æ—¢èƒ½ä¿è¯ä¸»çº¿ç¨‹å¿«é€Ÿè¿”å›ï¼Œåˆèƒ½é¿å…å¤šçº¿ç¨‹å¹¶å‘å†™ FAISS ç´¢å¼•å¼•å‘çš„æ•°æ®ç«äº‰ï¼ˆFAISS çš„ <code>Index</code> é»˜è®¤éçº¿ç¨‹å®‰å…¨ï¼‰ã€‚</li>\n<li><strong>åç¨‹æˆ–å¼‚æ­¥ I/Oï¼ˆè¿›é˜¶ï¼‰</strong>ï¼šè‹¥ç³»ç»Ÿå·²åŸºäºæ”¯æŒåç¨‹çš„æ¡†æ¶ï¼ˆå¦‚ Seastarã€Boost.Asio + coroutine TSï¼‰ï¼Œå¯å°†åµŒå…¥ä¸ç´¢å¼•å†™å…¥å°è£…ä¸º suspendable ä»»åŠ¡ï¼Œåœ¨ä¸é˜»å¡äº‹ä»¶å¾ªç¯çš„å‰æä¸‹å®Œæˆè€—æ—¶æ“ä½œã€‚ä½†è€ƒè™‘åˆ°å½“å‰ç³»ç»Ÿè½»é‡çº§å®šä½ï¼Œæ­¤æ–¹æ¡ˆæ”¶ç›Šæœ‰é™ï¼Œå¤æ‚åº¦è¾ƒé«˜ã€‚</li>\n<li><strong>å®šæœŸæ‰¹é‡æ›´æ–°ï¼ˆå…œåº•æ–¹æ¡ˆï¼‰</strong>ï¼šå¯¹äºä½é¢‘æ›´æ–°åœºæ™¯ï¼Œä¹Ÿå¯æš‚å­˜å¾…å¤„ç†çš„ blog ID åˆ°æ•°æ®åº“æ ‡è®°è¡¨ï¼Œç”±å®šæ—¶ä»»åŠ¡ï¼ˆå¦‚æ¯ 5 åˆ†é’Ÿï¼‰ç»Ÿä¸€æ‰«æå¹¶æ‰¹é‡æ‰§è¡ŒåµŒå…¥ä¸ç´¢å¼•æ›´æ–°ã€‚è¿™ç§æ–¹å¼å®ç°ç®€å•ï¼Œä¸”å¤©ç„¶è§„é¿å¹¶å‘é—®é¢˜ï¼Œé€‚åˆ MVP æˆ–èµ„æºå—é™ç¯å¢ƒã€‚</li>\n</ul>\n<p>æ­¤å¤–ï¼ŒFAISS ç´¢å¼•çš„æŒä¹…åŒ–ï¼ˆ<code>faiss::write_index</code>ï¼‰å±äº I/O å¯†é›†å‹æ“ä½œï¼Œå»ºè®®åœ¨åå°ä»»åŠ¡å®Œæˆæ‰€æœ‰å‘é‡æ·»åŠ å<strong>ä¸€æ¬¡æ€§å†™å…¥</strong>ï¼Œè€Œéæ¯æ¬¡æ–°å¢ chunk éƒ½è§¦å‘å†™ç›˜ï¼Œä»¥å‡å°‘ç£ç›˜å‹åŠ›å¹¶æå‡ååã€‚</p>\n<p>é€šè¿‡ä¸Šè¿°å¼‚æ­¥åŒ–è®¾è®¡ï¼Œç³»ç»Ÿæ—¢èƒ½ç»´æŒæ¯«ç§’çº§çš„å‰ç«¯å“åº”ï¼Œåˆèƒ½ç¨³å¥åœ°ä¿éšœæœç´¢æ•°æ®çš„é€æ­¥æ”¶æ•›ï¼ŒçœŸæ­£å®ç°â€œç”¨æˆ·ä½“éªŒâ€ä¸â€œç³»ç»Ÿæ•ˆç‡â€çš„åŒèµ¢ã€‚</p>\n\n\n</div>\n<div class=\"clear\"></div>\n\n            </div>\n            <div class=\"postDesc\">posted @ \n<span id=\"post-date\">2026-02-12 21:41</span>&nbsp;\n<a href=\"https://www.cnblogs.com/charlee44\">charlee44</a>&nbsp;\né˜…è¯»(<span id=\"post_view_count\">34</span>)&nbsp;\nè¯„è®º(<span id=\"post_comment_count\">0</span>)&nbsp;\n&nbsp;\n<a href=\"\">æ”¶è—</a>&nbsp;\n<a href=\"\">ä¸¾æŠ¥</a>\n</div>"
    }
  ]
}