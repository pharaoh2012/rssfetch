{
  "title": "主页 - 博客园",
  "link": "https://www.cnblogs.com/",
  "description": "主页 - 博客园 RSS",
  "entries": [
    {
      "title": "客服系统前端主题配色动态切换的一种实现思路（含代码）",
      "link": "https://www.cnblogs.com/sheng_chao/p/19401028",
      "published": "",
      "description": "<h1 class=\"postTitle\">\n                <a class=\"postTitle2 vertical-middle\" href=\"https://www.cnblogs.com/sheng_chao/p/19401028\" id=\"cb_post_title_url\" title=\"发布于 2025-12-25 20:29\">\n    <span>客服系统前端主题配色动态切换的一种实现思路（含代码）</span>\n    \n\n</a>\n\n            </h1>\n            <div class=\"clear\"></div>\n            <div class=\"postBody\">\n                    <div id=\"cnblogs_post_description\" style=\"display: none;\">\n        \n        前些天，一个老用户联系我，希望访客端的主题颜色能够与他们的 APP 相适配。对于这么合理的诉求，那必须满足！！😊\n    </div>\n<div class=\"blogpost-body cnblogs-markdown\" id=\"cnblogs_post_body\">\n<p>熟悉我的朋友都知道，我是升讯威客服系统的作者，一个独立开发者，常年致力于在线客服系统的开发和服务。现在我的一大乐趣之一，就是与许多用户沟通交流他们的使用反馈和诉求，对于一个程序员来说，这是非常有正反馈的一件事情。</p>\n<h1 id=\"讲故事\">讲故事：</h1>\n<p>前些天，一个老用户联系我，希望访客端的主题颜色能够与他们的 APP 相适配。对于这么合理的诉求，那必须满足！！😊</p>\n<p><img alt=\"主题颜色2\" src=\"https://img2024.cnblogs.com/blog/78019/202512/78019-20251225195041335-1148579844.jpg\" /></p>\n<hr />\n<h1 id=\"看疗效\">看疗效</h1>\n<p>完成的效果，允许在管理后台随时切换主题（明或暗），以及在明亮主题时的配色方案：</p>\n<p><img alt=\"image\" src=\"https://img2024.cnblogs.com/blog/78019/202512/78019-20251225201101576-2129169153.png\" /></p>\n<p>切换为绿色主题配色时，访客端的显示效果：</p>\n<p><img alt=\"image\" src=\"https://img2024.cnblogs.com/blog/78019/202512/78019-20251225201030213-1798778301.png\" /></p>\n<h1 id=\"讲技术\">讲技术：</h1>\n<p>一开始看起来很简单：<br />\n不就是 Light / Dark，再加几种颜色吗？<br />\n但真正在一个<strong>长期维护、多人使用、可扩展</strong>的系统里做过之后，往往会发现这是一个<strong>典型的“前期随意、后期返工”的功能点</strong>。</p>\n<p>这篇文章记录一种我在实际项目中使用的主题切换实现方式，思路偏工程化，代码也尽量保持简洁。</p>\n<h2 id=\"一为什么主题切换不是一个小功能\">一、为什么主题切换不是一个“小功能”</h2>\n<p>在很多前端项目的早期阶段，主题配色往往被当作一个“装饰性需求”。</p>\n<p>常见的认知是：</p>\n<ul>\n<li>不影响核心业务</li>\n<li>不是功能逻辑</li>\n<li>以后有时间再优化</li>\n</ul>\n<p>于是实现方式通常也很随意：<br />\n写几行 CSS，或者复制一份样式文件，先跑起来再说。</p>\n<p>但在<strong>客服系统、后台系统、SaaS 产品</strong>这类长期运行、持续演进的软件中，主题切换几乎都会在某个时间点暴露出问题，而且往往是<strong>成体系的问题</strong>。</p>\n<h3 id=\"1-多数系统不是只有一个用户\">1. 多数系统不是“只有一个用户”</h3>\n<p>以客服系统为例，它往往具备以下特征：</p>\n<ul>\n<li>服务多个商户 / 团队</li>\n<li>每个商户有自己的品牌色</li>\n<li>用户长时间在线使用</li>\n<li>页面复杂、组件数量多</li>\n</ul>\n<p>这意味着：<br />\n<strong>主题不是一个“页面级”的需求，而是“系统级”的能力。</strong></p>\n<p>一旦早期设计时没有把主题当成系统能力，后期基本都会面临以下情况：</p>\n<ul>\n<li>新主题 = 新一套 CSS</li>\n<li>修改一个颜色 = 改几十个地方</li>\n<li>每加一个页面，就多一次不一致风险</li>\n</ul>\n<h3 id=\"2-暗色模式不是换个背景色那么简单\">2. 暗色模式不是“换个背景色”那么简单</h3>\n<p>很多人第一次做暗色模式时，都会低估它的复杂度。</p>\n<p>常见的误区包括：</p>\n<ul>\n<li>只反转背景色和文字色</li>\n<li>直接套设计稿里的深色值</li>\n<li>忽略对比度和可读性</li>\n</ul>\n<p>但在实际使用中，暗色模式涉及的问题远不止这些：</p>\n<ul>\n<li>不同层级的背景如何区分</li>\n<li>禁用态、hover 态是否仍然清晰</li>\n<li>主色在暗背景下是否刺眼</li>\n<li>第三方组件是否“违和”</li>\n</ul>\n<p>如果主题系统本身不具备良好的抽象能力，那么暗色模式往往会演变成：</p>\n<blockquote>\n<p>“为了适配暗色，又加了一堆 if 和 hack。”</p>\n</blockquote>\n<h3 id=\"3-主题一旦写死返工成本极高\">3. 主题一旦“写死”，返工成本极高</h3>\n<p>主题相关代码有一个明显特征：</p>\n<blockquote>\n<p><strong>它分散在几乎所有组件中。</strong></p>\n</blockquote>\n<p>这也意味着：</p>\n<ul>\n<li>它不是一个可以轻易整体替换的模块</li>\n<li>它的设计质量，直接影响未来几年维护成本</li>\n</ul>\n<p>很多项目在后期想要“重构主题系统”时，会发现：</p>\n<ul>\n<li>已经无法明确哪些颜色是“主色”</li>\n<li>不同页面对同一颜色的理解不一致</li>\n<li>没人敢动，怕一动就全乱</li>\n</ul>\n<p>最终结果往往是：<br />\n<strong>继续在不合理的结构上打补丁。</strong></p>\n<h3 id=\"4-saas-产品里主题往往会超出最初设想\">4. SaaS 产品里，主题往往会“超出最初设想”</h3>\n<p>在实际产品演进中，主题需求很容易出现扩散：</p>\n<ul>\n<li>一开始只要 Light / Dark</li>\n<li>后来要支持品牌色</li>\n<li>再后来要支持商户自定义</li>\n<li>最后甚至要求运行时动态下发</li>\n</ul>\n<p>如果一开始的实现方式是“面向当前需求”的，那么每一次扩展都会变得异常痛苦。</p>\n<p>而反过来，如果主题系统的抽象足够合理：</p>\n<ul>\n<li>新主题只是新增一组配置</li>\n<li>现有组件无需修改</li>\n<li>切换逻辑保持稳定</li>\n</ul>\n<p>这类需求反而会变得<strong>非常可控</strong>。</p>\n<h3 id=\"5-本质问题主题是否被当成一等公民\">5. 本质问题：主题是否被当成“一等公民”</h3>\n<p>回过头看，主题切换之所以容易出问题，并不是技术难度高，而是因为它在系统设计中经常被：</p>\n<ul>\n<li>当作样式细节</li>\n<li>当作 UI 美化</li>\n<li>当作“以后再说”的事情</li>\n</ul>\n<p>但在长期维护的软件里，它更接近于：</p>\n<blockquote>\n<p><strong>权限、国际化、配置系统这一层级的基础能力。</strong></p>\n</blockquote>\n<p>一旦你接受了这一点，就会自然地意识到：</p>\n<ul>\n<li>它需要清晰的设计思路</li>\n<li>它需要可扩展的结构</li>\n<li>它需要尽量低的侵入性</li>\n</ul>\n<p>这也是后面会采用 <strong>CSS 变量 + 根节点切换</strong> 这种方案的根本原因。</p>\n<hr />\n<h2 id=\"二需求拆解一个可用的主题切换至少要满足什么\">二、需求拆解：一个“可用”的主题切换至少要满足什么</h2>\n<p>在真正动手实现主题切换之前，有一个很关键但经常被忽略的步骤：<br />\n<strong>先明确什么叫“可用”。</strong></p>\n<p>如果只是为了展示效果，那么主题切换可以非常简单；<br />\n但如果目标是一个<strong>会被真实用户长期使用的系统</strong>，那么需求本身就必须被拆解清楚。</p>\n<p>下面是我在实际项目中，对“可用主题切换”的最低要求。</p>\n<h3 id=\"1-主题切换必须是即时且无感知的\">1. 主题切换必须是“即时且无感知”的</h3>\n<p>对用户来说，主题切换的期望非常直接：</p>\n<ul>\n<li>点击即生效</li>\n<li>页面不刷新</li>\n<li>不影响当前操作</li>\n</ul>\n<p>任何以下情况，都会被认为体验不佳：</p>\n<ul>\n<li>切换主题后页面闪白</li>\n<li>状态被重置</li>\n<li>列表重新加载</li>\n</ul>\n<p>这意味着：</p>\n<ul>\n<li>主题切换不应该依赖页面重载</li>\n<li>不应该触发组件重新初始化</li>\n<li>不应该侵入业务状态管理</li>\n</ul>\n<p>从需求层面就可以得出结论：<br />\n<strong>主题切换必须是纯“表现层”的行为。</strong></p>\n<h3 id=\"2-主题必须支持模式--变体的组合\">2. 主题必须支持“模式 + 变体”的组合</h3>\n<p>在多数系统中，主题并不是一个简单的枚举值。</p>\n<p>一个更贴近现实的模型通常是：</p>\n<ul>\n<li>\n<p><strong>主题模式（Theme Mode）</strong></p>\n<ul>\n<li>Light</li>\n<li>Dark</li>\n</ul>\n</li>\n<li>\n<p><strong>主题颜色（Theme Color）</strong></p>\n<ul>\n<li>蓝</li>\n<li>红</li>\n<li>黄</li>\n<li>……</li>\n</ul>\n</li>\n</ul>\n<p>也就是说，用户真正选择的往往是：</p>\n<blockquote>\n<p>Light + Blue<br />\nLight + Red<br />\nDark（可能只有一种）</p>\n</blockquote>\n<p>如果在设计时把主题当成单一维度，那么后期扩展几乎必然会推翻原实现。</p>\n<p>因此在需求层面，就需要明确：</p>\n<ul>\n<li>模式与颜色是两个概念</li>\n<li>它们可以组合，但不完全对称</li>\n</ul>\n<h3 id=\"3-主题结构要先稳定后扩展\">3. 主题结构要“先稳定，后扩展”</h3>\n<p>一个很现实的问题是：<br />\n<strong>主题一定会变。</strong></p>\n<p>可能的变化包括：</p>\n<ul>\n<li>新增颜色主题</li>\n<li>微调主色、强调色</li>\n<li>增加辅助色、边框色、状态色</li>\n</ul>\n<p>所以在需求拆解阶段，需要问自己一个问题：</p>\n<blockquote>\n<p>如果半年后新增一个主题，我希望改哪些地方？</p>\n</blockquote>\n<p>一个“可用”的主题系统，理想状态是：</p>\n<ul>\n<li>新增主题 ≈ 新增配置</li>\n<li>不需要修改现有组件</li>\n<li>不需要理解历史代码细节</li>\n</ul>\n<p>这实际上是在要求：<br />\n<strong>主题系统必须具备良好的边界。</strong></p>\n<h3 id=\"4-主题状态需要被持久化但不应绑定过深\">4. 主题状态需要被持久化，但不应绑定过深</h3>\n<p>从用户体验角度来看，主题选择显然应该被记住：</p>\n<ul>\n<li>刷新页面后不丢失</li>\n<li>下次打开仍然生效</li>\n</ul>\n<p>但在实现层面，有一个容易踩的坑：</p>\n<ul>\n<li>把主题状态深度绑定到业务状态管理中</li>\n</ul>\n<p>例如：</p>\n<ul>\n<li>Redux / Pinia / Vuex</li>\n<li>和用户权限、语言混在一起</li>\n</ul>\n<p>这种做法的风险在于：</p>\n<ul>\n<li>主题逻辑被迫参与复杂状态流转</li>\n<li>后期维护成本急剧上升</li>\n</ul>\n<p>因此更合理的需求结论是：</p>\n<ul>\n<li>主题状态可以持久化</li>\n<li>但实现应尽量“轻量、独立”</li>\n</ul>\n<h3 id=\"5-主题切换不能成为组件开发的负担\">5. 主题切换不能成为组件开发的负担</h3>\n<p>在一个持续演进的项目中，最忌讳的是：</p>\n<blockquote>\n<p>每写一个新组件，就要考虑“它支持多少主题”。</p>\n</blockquote>\n<p>一个健康的目标应该是：</p>\n<ul>\n<li>组件只关心“语义颜色”</li>\n<li>组件本身不知道具体主题</li>\n<li>主题切换对组件是透明的</li>\n</ul>\n<p>换句话说：</p>\n<blockquote>\n<p><strong>组件不应知道自己处在哪个主题下。</strong></p>\n</blockquote>\n<p>这是判断一个主题系统是否“可用”的关键标准之一。</p>\n<h3 id=\"6-技术实现要简单到可以被长期维护\">6. 技术实现要“简单到可以被长期维护”</h3>\n<p>最后，也是非常现实的一点：</p>\n<ul>\n<li>项目可能会换人维护</li>\n<li>自己半年后再看这段代码，也可能已经陌生</li>\n</ul>\n<p>所以在需求层面，我给主题切换设定了一个约束：</p>\n<blockquote>\n<p><strong>实现方式必须足够直观，不依赖技巧性过强的方案。</strong></p>\n</blockquote>\n<p>这会直接排除掉一些：</p>\n<ul>\n<li>过度抽象的主题引擎</li>\n<li>复杂的运行时样式计算</li>\n<li>强依赖框架内部机制的方案</li>\n</ul>\n<hr />\n<h2 id=\"三设计思路css-变量--根节点主题切换\">三、设计思路：CSS 变量 + 根节点主题切换</h2>\n<p>在明确了主题切换的需求边界之后，接下来要做的不是立刻写代码，而是回答一个更基础的问题：</p>\n<blockquote>\n<p><strong>主题到底应该“存在”在哪里？</strong></p>\n</blockquote>\n<p>是存在于组件里？<br />\n是存在于某个全局状态中？<br />\n还是存在于样式系统本身？</p>\n<p>在对比过几种常见方案之后，我最终选择了：<br />\n<strong>CSS 变量（Custom Properties）+ 根节点主题切换</strong>。</p>\n<h3 id=\"1-把主题从组件中剥离出来\">1. 把“主题”从组件中剥离出来</h3>\n<p>一个容易犯的错误是：<br />\n在组件样式中直接体现主题差异。</p>\n<p>例如：</p>\n<ul>\n<li><code>if (dark) { ... }</code></li>\n<li><code>.button-dark { ... }</code></li>\n<li><code>.theme-blue .button { ... }</code></li>\n</ul>\n<p>这种方式在早期看起来直观，但问题在于：</p>\n<ul>\n<li>组件开始“感知主题”</li>\n<li>组件逻辑与样式策略耦合</li>\n<li>主题一多，组合爆炸</li>\n</ul>\n<p>而我希望的目标是：</p>\n<blockquote>\n<p><strong>组件只描述“它需要什么颜色语义”，而不是“这个颜色在什么主题下是什么值”。</strong></p>\n</blockquote>\n<p>这正是 CSS 变量最适合承担的角色。</p>\n<h3 id=\"2-为什么-css-变量是主题系统的天然载体\">2. 为什么 CSS 变量是主题系统的天然载体</h3>\n<p>CSS 变量有几个非常适合做主题的特性：</p>\n<ul>\n<li>原生支持，浏览器层面解析</li>\n<li>可以在运行时动态修改</li>\n<li>具备作用域和继承能力</li>\n<li>不依赖任何前端框架</li>\n</ul>\n<p>这意味着：</p>\n<ul>\n<li>切换主题 ≠ 重新渲染组件</li>\n<li>主题变化对业务状态是透明的</li>\n<li>实现方式足够稳定、可预期</li>\n</ul>\n<p>尤其是在<strong>长期维护的系统</strong>中，这种“朴素但可靠”的方案，往往比技巧性更重要。</p>\n<h3 id=\"3-为什么选择根节点作为主题切换入口\">3. 为什么选择“根节点”作为主题切换入口</h3>\n<p>既然要切换主题，就必须有一个<strong>统一且稳定的切换点</strong>。</p>\n<p>相比在多个容器节点上控制样式，我更倾向于：</p>\n<ul>\n<li>使用 <code>:root</code> 或 <code>html</code> 作为主题载体</li>\n<li>通过属性或 class 标识当前主题</li>\n</ul>\n<p>例如：</p>\n<pre><code class=\"language-html\">&lt;html data-theme=\"light-blue\"&gt;\n</code></pre>\n<p>这样做的好处非常明确：</p>\n<ul>\n<li>所有组件天然继承主题变量</li>\n<li>不需要关心组件嵌套层级</li>\n<li>主题切换逻辑集中、可控</li>\n</ul>\n<p>同时，这也让“主题切换”变成了一个非常清晰的动作：</p>\n<blockquote>\n<p><strong>修改根节点的一个属性。</strong></p>\n</blockquote>\n<h3 id=\"4-主题--颜色集合而是语义映射\">4. 主题 ≠ 颜色集合，而是“语义映射”</h3>\n<p>在这个方案中，一个非常重要的设计原则是：</p>\n<blockquote>\n<p><strong>主题不是一组颜色，而是一套语义到颜色的映射关系。</strong></p>\n</blockquote>\n<p>例如：</p>\n<ul>\n<li><code>--primary-color</code>：主操作、强调</li>\n<li><code>--background-color</code>：页面背景</li>\n<li><code>--text-color</code>：主要文本</li>\n<li><code>--border-color</code>：分割与边界</li>\n</ul>\n<p>组件只使用这些语义变量，而主题负责告诉系统：</p>\n<blockquote>\n<p>在当前主题下，这些语义对应什么颜色。</p>\n</blockquote>\n<p>这样带来的直接收益是：</p>\n<ul>\n<li>新主题只需定义变量值</li>\n<li>组件代码完全无需改动</li>\n<li>不同主题之间可以高度复用结构</li>\n</ul>\n<h3 id=\"5-light--dark-与多颜色主题如何共存\">5. Light / Dark 与多颜色主题如何共存</h3>\n<p>在实际设计中，我并没有把 Light / Dark 和颜色主题混为一个维度。</p>\n<p>而是采用一种更贴近现实的思路：</p>\n<ul>\n<li><strong>Light / Dark</strong>：决定整体明暗结构</li>\n<li><strong>Color Theme</strong>：决定主色、强调色</li>\n</ul>\n<p>在 CSS 层面，可以表现为：</p>\n<ul>\n<li>Dark 主题覆盖结构性变量</li>\n<li>Color 主题只覆盖少量核心颜色</li>\n</ul>\n<p>例如：</p>\n<pre><code class=\"language-css\">:root[data-theme=\"dark\"] {\n  --background-color: #141414;\n  --text-color: #f0f0f0;\n}\n\n:root[data-theme=\"light-blue\"] {\n  --primary-color: #1677ff;\n}\n</code></pre>\n<p>这种拆分可以有效避免：</p>\n<ul>\n<li>暗色主题下颜色失控</li>\n<li>主题组合难以管理</li>\n</ul>\n<h3 id=\"6-刻意不做的事情保持方案的边界\">6. 刻意不做的事情：保持方案的边界</h3>\n<p>在这个设计中，有几件事情我是<strong>刻意不去做的</strong>：</p>\n<ul>\n<li>不在 JS 中计算颜色</li>\n<li>不引入复杂的主题配置 DSL</li>\n<li>不尝试做“万能主题引擎”</li>\n</ul>\n<p>原因很简单：</p>\n<blockquote>\n<p>主题系统的职责，是稳定地提供样式变量，而不是成为新的复杂度来源。</p>\n</blockquote>\n<p>一旦主题系统本身变得难以理解，它就已经背离了最初的目标。</p>\n<h2 id=\"四实现步骤拆解\">四、实现步骤拆解</h2>\n<p>下面用一个简化示例说明整体结构。</p>\n<h3 id=\"41-定义主题变量css\">4.1 定义主题变量（CSS）</h3>\n<p>首先，不要在组件里直接写颜色值。</p>\n<pre><code class=\"language-css\">:root {\n  --primary-color: #1677ff;\n  --background-color: #ffffff;\n  --text-color: #1f1f1f;\n}\n</code></pre>\n<p>为不同主题定义不同变量集：</p>\n<pre><code class=\"language-css\">:root[data-theme=\"light-blue\"] {\n  --primary-color: #1677ff;\n}\n\n:root[data-theme=\"light-red\"] {\n  --primary-color: #e53935;\n}\n\n:root[data-theme=\"dark\"] {\n  --background-color: #141414;\n  --text-color: #f0f0f0;\n  --primary-color: #4c8dff;\n}\n</code></pre>\n<blockquote>\n<p>⚠️ 一个经验：<br />\n<strong>变量名一定要语义化，而不是 <code>--blue-500</code> 这种设计稿命名。</strong></p>\n</blockquote>\n<h3 id=\"42-在组件中使用变量\">4.2 在组件中使用变量</h3>\n<pre><code class=\"language-css\">.button {\n  background-color: var(--primary-color);\n  color: var(--text-color);\n}\n\n这样一来，组件本身对“主题”是无感知的。\n\n\n### 4.3 主题切换逻辑（JavaScript）\n\n主题切换本质上只是修改根节点属性：\n\n```js\nfunction setTheme(theme) {\n  document.documentElement.setAttribute('data-theme', theme);\n  localStorage.setItem('theme', theme);\n}\n</code></pre>\n<p>初始化时恢复用户选择：</p>\n<pre><code class=\"language-js\">const savedTheme = localStorage.getItem('theme');\nif (savedTheme) {\n  document.documentElement.setAttribute('data-theme', savedTheme);\n}\n</code></pre>\n<p>整个过程无需刷新页面，也不会影响组件状态。</p>\n<h2 id=\"结语主题切换本质上是一次工程成熟度的考验\">结语：主题切换，本质上是一次工程成熟度的考验</h2>\n<p>回过头来看，前端主题切换这个需求本身，其实并不复杂。<br />\n没有高深的算法，也不涉及前沿技术。</p>\n<p>但它之所以在很多项目中反复“翻车”，原因往往不在技术，而在于<strong>对系统长期演进的预期不足</strong>。</p>\n<p>在文章开头提到过，主题常常被当作一个“以后再说”的问题；<br />\n但当系统真正进入稳定使用阶段后，它却会频繁出现在这些场景里：</p>\n<ul>\n<li>新客户希望使用自己的品牌色</li>\n<li>用户开始要求暗色模式</li>\n<li>页面和组件越来越多</li>\n<li>维护成本开始显性化</li>\n</ul>\n<p>这时再回头看最初的实现方式，往往已经没有太多调整空间。</p>\n<hr />\n<h3 id=\"主题问题的本质不是颜色而是结构\">主题问题的本质，不是“颜色”，而是“结构”</h3>\n<p>如果用一句话概括这篇文章的核心思想，那就是：</p>\n<blockquote>\n<p><strong>主题切换不是在管理颜色，而是在管理一套稳定的结构关系。</strong></p>\n</blockquote>\n<p>当颜色值被直接写进组件时，系统就失去了抽象层；<br />\n而当颜色被提升为“语义变量”之后，主题才真正成为一种可演进的能力。</p>\n<p>这也是为什么本文会反复强调：</p>\n<ul>\n<li>组件不应该感知主题</li>\n<li>主题不应该侵入业务逻辑</li>\n<li>主题系统本身必须足够简单</li>\n</ul>\n<hr />\n<h3 id=\"css-变量方案的价值不在新而在合适\">CSS 变量方案的价值，不在“新”，而在“合适”</h3>\n<p>CSS 变量并不是新技术，但在主题系统这个问题上，它恰好处在一个非常合适的位置：</p>\n<ul>\n<li>足够底层，稳定可靠</li>\n<li>足够灵活，支持运行时切换</li>\n<li>足够直观，维护成本低</li>\n</ul>\n<p>配合根节点主题切换的方式，可以让整个系统形成一种非常清晰的分工：</p>\n<ul>\n<li><strong>样式层</strong>负责主题变量</li>\n<li><strong>组件层</strong>只关心语义</li>\n<li><strong>逻辑层</strong>只负责切换入口</li>\n</ul>\n<p>这种结构一旦建立起来，后续无论是新增主题、对接多租户配置，还是调整视觉规范，都会变得相对从容。</p>\n<hr />\n<h3 id=\"工程实践中一个重要但不显眼的判断标准\">工程实践中，一个重要但不显眼的判断标准</h3>\n<p>在实际项目中，我逐渐形成了一个判断标准：</p>\n<blockquote>\n<p>如果一个功能在早期实现时“看起来有点啰嗦”，<br />\n但在半年后几乎不需要再动它，<br />\n那它大概率是一个正确的设计。</p>\n</blockquote>\n<p>主题切换正是这样一类功能。</p>\n<p>相比“先简单写死、以后再重构”，<br />\n<strong>一开始就建立清晰边界的方案，反而更节省整体成本。</strong></p>\n<hr />\n<h2 id=\"独立者的产品成果\">独立者的产品成果</h2>\n<blockquote>\n<p><a href=\"https://kf.shengxunwei.com\" rel=\"noopener nofollow\" target=\"_blank\">https://kf.shengxunwei.com</a></p>\n</blockquote>\n<p><strong>可全天候 7 × 24 小时挂机运行，网络中断，拔掉网线，手机飞行模式，不掉线不丢消息，欢迎实测。</strong></p>\n<h3 id=\"访客端轻量直观秒级响应的沟通入口\">访客端：轻量直观、秒级响应的沟通入口</h3>\n<p>访客端是客户接触企业的第一窗口，我们精心打磨每一处交互细节，确保用户无需任何学习成本即可发起对话。无论是嵌入式聊天窗口、悬浮按钮，还是移动端自适应支持，都实现了真正的“即点即聊”。系统支持智能欢迎语、来源识别、设备类型判断，可自动记录访客路径并呈现于客服端，帮助企业更好地理解用户意图。在性能方面，访客端采用异步加载与自动重连机制，即使网络波动也能保障消息顺畅送达，真正做到——轻量不失稳定，简单不失智能。</p>\n<p><img alt=\"\" src=\"https://img2024.cnblogs.com/blog/78019/202506/78019-20250601110426304-100322970.png\" /></p>\n<h3 id=\"客服端软件为高效率沟通而生\">客服端软件：为高效率沟通而生</h3>\n<p>客服端是客服人员的作战平台，我们构建了一个专注、高效、响应迅速的桌面级体验。系统采用多标签会话设计，让客服可同时处理多组对话；访客轨迹、历史会话、地理位置、设备信息、来源渠道等关键信息一目了然，协助客服快速做出判断。内置快捷回复、常用文件、表情支持和智能推荐功能，大幅降低重复劳动成本。同时，系统还支持智能分配、会话转接、转人工、自定义状态等多种机制，保障团队协作流畅，让客服不仅能应对高峰，更能稳定交付满意度。</p>\n<p><img alt=\"\" src=\"https://img2024.cnblogs.com/blog/78019/202506/78019-20250601110431346-1228494411.png\" /></p>\n<h3 id=\"web-管理后台\">Web 管理后台：</h3>\n<p>Web 管理后台是企业对客服系统的“驾驶舱”，从接入配置、坐席管理，到数据统计、权限控制，一切尽在掌握。你可以灵活设置接待策略、工作时间、转接规则，支持按部门/标签/渠道精细分配访客，满足复杂业务场景。系统还内置访问监控、聊天记录检索、客服绩效统计、错失会话提醒等运营级功能，助力管理者洞察服务瓶颈，持续优化资源配置。支持私有化部署、分权限管理、日志记录与数据导出，为追求安全性与高可控性的企业，提供真正“掌握在自己手里的客服系统”。</p>\n<p><img alt=\"\" src=\"https://img2024.cnblogs.com/blog/78019/202506/78019-20250601110403917-63642615.png\" /></p>\n<h2 id=\"希望能够打造-开放开源共享努力打造一款优秀的社区开源产品\">希望能够打造： 开放、开源、共享。努力打造一款优秀的社区开源产品。</h2>\n<p>钟意的话请给个赞支持一下吧，谢谢~</p>\n\n</div>\n<div class=\"clear\"></div>\n\n            </div>\n            <div class=\"postDesc\">posted @ \n<span id=\"post-date\">2025-12-25 20:29</span>&nbsp;\n<a href=\"https://www.cnblogs.com/sheng_chao\">升讯威在线客服系统</a>&nbsp;\n阅读(<span id=\"post_view_count\">0</span>)&nbsp;\n评论(<span id=\"post_comment_count\">0</span>)&nbsp;\n&nbsp;\n<a href=\"\">收藏</a>&nbsp;\n<a href=\"\">举报</a>\n</div>"
    },
    {
      "title": "流量洪峰下的交通指挥家：详解负载均衡与限流实战",
      "link": "https://www.cnblogs.com/poemyang/p/19401017",
      "published": "",
      "description": "<h2 class=\"post-title\">\n            <a class=\"postTitle2 vertical-middle\" href=\"https://www.cnblogs.com/poemyang/p/19401017\" id=\"cb_post_title_url\" title=\"发布于 2025-12-25 20:24\">\n    <span>流量洪峰下的交通指挥家：详解负载均衡与限流实战</span>\n    \n\n</a>\n\n        </h2>\n        <div class=\"blogpost-body cnblogs-markdown\" id=\"cnblogs_post_body\">\n<p><strong>负载均衡：聪明的交通指挥家</strong><br />\n如果说水平扩容是为系统增加了更多的“工作车道”，那么负载均衡就是站在车道入口处的交通指挥家。它的存在，是为了回答一个根本性问题：当成千上万的请求同时涌来时，如何将它们高效、公平且智能地引导至后端的服务集群，从而避免任何一条“车道”因拥堵而瘫痪？<br />\n负载均衡的本质，是将单一的、巨大的访问压力，分解为多个可管理的、微小的压力。负载均衡不仅需要在用户请求和Web服务器之间进行，而且在系统的每个阶段都必须进行。一个中等规模的系统可能在以下三个层面实现负载均衡。<br />\n1）用户请求到Web服务器；<br />\n2）Web服务器到内部平台层；<br />\n3）内部平台层到数据存储层。<br />\n负载均衡可以通过硬件或软件来实现。硬件负载均衡器，如F5 BIG-IP等专用硬件设备，通常被用于处理高流量的网站和网络，但其价格通常较高。相比之下，软件负载均衡器，如LVS（Linux Virtual Server）和Nginx，不仅价格更为低廉，而且提供了更高的灵活性，可以根据具体需求进行定制和调整，以满足各种不同的业务场景。对于大多数系统，建议从软件负载均衡器开始，只有在明确需要的情况下，才考虑转向硬件负载均衡器。<br />\n<img alt=\"image\" class=\"lazyload\" /></p>\n<p><strong>负载均衡算法</strong><br />\n负载均衡器在将请求转发到后端服务器之前会考虑两个因素。首先，它会确保所选择的服务器能够适当地响应请求，然后使用预先配置的算法从一组正常的服务器中选择一个。<br />\n负载均衡器应该只将流量转发到“正常”的服务节点。为了监视服务器的运行状况，负载均衡器会定期进行运行状况检查（Health Check），尝试连接到服务器，以确保服务节点正在正常运行。如果某个服务节点未通过运行状况检查，它将自动从服务器池中删除，并且在它再次通过运行状况检查之前，负载均衡器不会将流量转发给它。<br />\n在负载均衡中，有各种各样的方法和算法，这些算法可以根据服务器的性能、负载情况、会话保持需求等因素来进行选择。以下是一些常见的负载均衡算法。<br />\n1）轮询（Round Robin）：这是最简单也最经典的策略。它像发牌一样，按顺序将请求逐一分发给每台服务器。这种方式纯粹、公平，但略显“天真”——它假设所有服务器的处理能力完全相同，且每个请求的耗时也一样，这在现实世界中几乎不可能。<br />\n2）最少连接（Least Connections）： 这是最常用的动态算法。它会把新请求发送给当前连接数最少的服务器。这好比在超市结账时，总会下意识地选择排队人数最少的那个收银台，因为它大概率最快。<br />\n3）加权算法（Weighted Algorithms）：当服务器配置高低不一时，加权算法便派上用场。可以为性能更强的服务器分配更高的“权重”，让它承担更多的流量，实现“能者多劳”，最大化利用硬件投资。<br />\n4）会话保持（Session Persistence / Sticky Sessions）：在某些场景下（如网上银行、购物车），需要用户的连续请求始终由同一台服务器处理，以维持会话状态。此时，负载均衡器会根据用户的IP地址或Cookie等信息，实现“粘性会话”，确保用户的请求“粘”在固定的服务器上。</p>\n<p><strong>限流：给流量装上调节阀</strong><br />\n无论系统多么强大，短时间内的流量突增总是令人头疼的问题，因此，对于并发系统来说，一个必不可少的模块就是限流（Rate Limiter）。<br />\n限流是一种通过控制请求的频率或数量来保护系统免受过载的技术，确保系统能够在可接受的范围内处理请求，避免过多的请求导致系统资源耗尽、性能下降或崩溃。<br />\n常见的限流算法包括固定窗口、滑动窗口、漏桶、令牌桶。<br />\n<img alt=\"image\" class=\"lazyload\" /></p>\n<p><strong>固定窗口</strong><br />\n固定窗口（Fixed Window）算法是最简单的限流算法。其原理是在一个固定的时间窗口内（每个时间单位）限制请求的数量。<br />\n固定窗口的缺点是无法平滑地处理突发流量。例如，如果阈值为5个请求，时间窗口的时间单位为1秒，在0.8秒到1秒和1秒到1.2秒分别有5个并发请求，尽管它们都没有超过阈值，但当计算0.8秒到1.2秒内的请求时，并发数高达10，已经超过了每个时间单位不超过5个请求的定义。<br />\n<img alt=\"image\" class=\"lazyload\" /></p>\n<p><strong>滑动窗口</strong><br />\n因此，可以引入滑动窗口（Sliding Window）算法来解决关键时间窗口转换的问题。滑动窗口是将一个较大的时间窗口分割成几个粒度更细的子窗口。每个子窗口独立计数，并基于子窗口的时间滑动进行限流控制。当滑动窗口具有更多的网格周期时，滑动窗口的滚动将更加平滑，限流统计将更加准确。<br />\n<img alt=\"image\" class=\"lazyload\" /></p>\n<p>假设每单位时间仍然是1秒，滑动窗口算法将其划分为5个小周期，即滑动窗口（每单位时间）被划分为5个小格子。每个格子代表0.2秒。在每个0.2秒内，时间窗口会向右滑动一个格子。然后，每个小周期都有其独立的计数器。如果请求在0.83秒到达，那么在0.8秒到1.0秒格子内的对应计数器将增加1。<br />\n假设在1秒内的阈值仍然是5个请求，0.8秒到1.0秒内到达5个请求（例如0.9秒），它们将落入黄色的格子。<br />\n在1.0秒的格子之后，又有5个请求到达并落入紫色的格子。如果是固定窗口算法，它将不会被限制。然而，如果是滑动窗口算法，每次经过一个小周期，它就会向右滑动一个格子。在1.0秒的格子之后，它会向右滑动一个格子。当前的每单位时间周期是0.2秒到1.2秒。在这个区域内的请求已经超过了5个的阈值，当前的限流已经被触发。实际上，紫色格子内的所有请求都已被拒绝。</p>\n<p><strong>漏桶</strong><br />\n漏桶（Leaky Bucket）算法是一种基于输出流速进行流量控制的方法。这个算法的名字来源于它的工作原理，就像一个漏水的桶一样。<br />\n在漏桶算法中，可以将数据想象成水滴，而漏桶就是一个有固定容量的桶。请求（水滴）以任何速率进入桶中，而桶（漏桶）以固定的速率将请求（水）释放出去。如果进入的请求（水滴）过多，超过了桶的容量，那么多余的请求（水）就会被丢弃。<br />\n漏桶算法适用于需要强制执行固定速率处理的场景，如网络流量控制、API请求限制等。即使输入数据的速率有波动，漏桶算法也可以通过丢弃多余的数据来防止系统过载。<br />\n然而，面对突发流量时，漏桶算法仍然以规律的方式处理请求，这并不是希望看到的。当流量突然增加时，希望系统能尽快处理请求，以提高用户体验。<br />\n<img alt=\"image\" class=\"lazyload\" /></p>\n<p><strong>令牌桶</strong><br />\n令牌桶（Token Bucket）算法是一种基于输入流量速率进行流量控制的方法。该算法维护一个具有固定容量的令牌桶，并且每秒向令牌桶中放入一定数量的令牌。当请求到来时，如果令牌桶中的令牌数量足够，那么请求将被允许通过，并从令牌桶中消耗一个令牌。否则，请求将被拒绝。<br />\n令牌桶算法通常用于保护系统，通过限制调用者的请求速率来防止系统面临突发流量的压力。如果系统的实际处理能力大于配置的流量限制，那么可能会允许一定程度的流量突发，使得实际处理速率高于配置的速率，从而充分利用系统资源。<br />\n<img alt=\"image\" class=\"lazyload\" /></p>\n<p><strong>使用场景</strong><br />\n固定窗口：在一个电商网站中，为了防止恶意刷单，希望对每个用户每分钟的下单次数进行限制。通过使用固定窗口算法，例如设置每分钟只能下单5次，以确保订单减少的合理性。<br />\n滑动窗口：在一个API服务中，希望平滑地控制请求的频率。通过滑动窗口算法，例如限制每秒最多处理10个请求，且每个请求必须均匀分布在连续的1秒窗口内。<br />\n漏桶：在一个消息推送服务中，希望消息的发送速度是恒定的。通过使用漏桶算法，可以控制消息的发送速率，确保发送速度是恒定的，不会超过系统的处理能力。<br />\n令牌桶：在一个视频网站中，希望限制用户的平均下载速度，同时又希望能够应对突发的下载需求。通过使用令牌桶算法，可以设置每个用户的下载速度上限，并在令牌桶中存储一定数量的令牌。用户每下载一个视频，需要消耗一个令牌，当令牌桶中的令牌不足时，用户需要等待令牌生成或下载速度受限。</p>\n<p><strong>未完待续</strong></p>\n<p><strong>很高兴与你相遇！如果你喜欢本文内容，记得关注哦!!!</strong></p>\n\n</div>\n<div id=\"MySignature\">\n    <p>本文来自博客园，作者：<a href=\"https://www.cnblogs.com/poemyang/\" target=\"_blank\">poemyang</a>，转载请注明原文链接：<a href=\"https://www.cnblogs.com/poemyang/p/19401017\" target=\"_blank\">https://www.cnblogs.com/poemyang/p/19401017</a></p>\n</div>\n<div class=\"clear\"></div>\n\n        <p class=\"postfoot\">\n            posted on \n<span id=\"post-date\">2025-12-25 20:24</span>&nbsp;\n<a href=\"https://www.cnblogs.com/poemyang\">poemyang</a>&nbsp;\n阅读(<span id=\"post_view_count\">0</span>)&nbsp;\n评论(<span id=\"post_comment_count\">0</span>)&nbsp;\n&nbsp;\n<a href=\"\">收藏</a>&nbsp;\n<a href=\"\">举报</a>\n\n        </p>"
    },
    {
      "title": "redis为什么这么快？I/O多路复用技术是什么？",
      "link": "https://www.cnblogs.com/xi-yongqi/p/19401014",
      "published": "",
      "description": "<h1 class=\"postTitle\">\n\t\t\t<a class=\"postTitle2 vertical-middle\" href=\"https://www.cnblogs.com/xi-yongqi/p/19401014\" id=\"cb_post_title_url\" title=\"发布于 2025-12-25 20:24\">\n    <span>redis为什么这么快？I/O多路复用技术是什么？</span>\n    \n\n</a>\n\n\t\t</h1>\n\t\t<div class=\"clear\"></div>\n\t\t<div class=\"postBody\">\n\t\t\t<div class=\"blogpost-body cnblogs-markdown\" id=\"cnblogs_post_body\">\n<h4 id=\"redis能够达到每秒10万-qps每秒查询率的极高性能并非只因为它是内存数据库而是由存储介质线程模型网络模型以及数据结构优化共同决定的\">redis能够达到每秒10万+ QPS（每秒查询率）的极高性能，并非只因为它是“内存数据库”，而是由存储介质、线程模型、网络模型以及数据结构优化共同决定的。</h4>\n<h3 id=\"以下是redis快的具体原因\">以下是redis快的具体原因：</h3>\n<h4 id=\"绝大部分请求在内存中完成\">绝大部分请求在内存中完成</h4>\n<ul>\n<li>这是 Redis 快的根本原因。相比于传统数据库（如 MySQL）需要从磁盘读取数据，Redis 直接操作RAM（内存）。</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>存储介质</th>\n<th>访问速度（数量级）</th>\n<th>延迟说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>内存 (RAM)</td>\n<td>纳秒 (ns)</td>\n<td>极快，就像从书桌上拿书。</td>\n</tr>\n<tr>\n<td>固态硬盘 (SSD)</td>\n<td>微秒 (μs)</td>\n<td>较快，但比内存慢 1000 倍。</td>\n</tr>\n<tr>\n<td>机械硬盘 (HDD)</td>\n<td>毫秒 (ms)</td>\n<td>慢，就像去图书馆借书。</td>\n</tr>\n</tbody>\n</table>\n<p><strong>Redis 避免了磁盘 I/O 产生的巨大开销，数据操作几乎是瞬时的。</strong></p>\n<h4 id=\"纯粹的单线程模型\">纯粹的单线程模型</h4>\n<p>很多人误以为多线程才快，但 Redis 的核心处理逻辑是单线程的（主要指文件事件分路器处理请求的部分）。</p>\n<ul>\n<li>没有上下文切换：多线程在切换执行流时需要保存和加载 CPU 寄存器状态，这会产生明显的性能损耗。</li>\n<li>没有锁的竞争：在多线程环境下，为了保证数据安全，必须引入锁（如互斥锁）。Redis 单线程执行，天然避免了死锁和锁竞争带来的开销。</li>\n<li>简单即高效：单线程代码逻辑更简单，也更容易维护。<br />\n<strong>注意： Redis6.0引入了多线程来处理网络I/O，但执行命令的核心逻辑依然是单线程的。</strong></li>\n</ul>\n<h4 id=\"非阻塞io多路复用-io-multiplexing\">非阻塞I/O多路复用 (I/O Multiplexing)</h4>\n<p>Redis 使用了I/O多路复用技术（如 Linux 下的 epoll）来处理大量的并发连接。</p>\n<ul>\n<li>原理：Redis并不是为一个连接分配一个线程，而是让一个线程监控数千个连接的状态。只有当某个连接真正有数据发过来时，Redis才会去处理。</li>\n<li>效果：即使有成千上万个客户端同时连接，Redis 也能像一个老练的服务员同时照顾几十桌客人一样，谁叫就服务谁，而不需要在桌子之间来回空跑。</li>\n</ul>\n<h4 id=\"针对性优化的底层数据结构\">针对性优化的底层数据结构</h4>\n<p>Redis的开发者对每种数据类型都进行了极致的底层优化，并没有简单地使用编程语言内置的结构。</p>\n<ul>\n<li>SDS (简单动态字符串)：相比 C 语言原生字符串，获取长度的时间复杂度从O(N)降到了O(1)，且减少了内存分配次数。</li>\n<li>跳表 (SkipList)：为有序集合 (ZSet) 提供平衡树一般的查找效率，但实现更简单，支持范围查询更高效。</li>\n<li>压缩列表 (ZipList) / 整型数组： 在数据量较小时使用紧凑存储，极大节省了内存开销，提高了 CPU 缓存命中率。</li>\n</ul>\n<h4 id=\"总结\">总结：</h4>\n<p><strong>Redis的快可以总结为：基于内存操作 + 单线程 + 多路复用的并发 + 极致优化的底层数据结构。</strong></p>\n<hr />\n<h3 id=\"详细说一下io多路复用\">详细说一下I/O多路复用</h3>\n<h6 id=\"io多路复用io-multiplexing是现代高性能网络服务器如-nginx-redis-nodejs的核心基石简单来说它是一种--让单个线程能够同时监控多个网络连接文件描述符--的技术\">I/O多路复用（I/O Multiplexing）是现代高性能网络服务器（如 Nginx, Redis, Node.js）的核心基石。简单来说，它是一种  <strong>让单个线程能够同时监控多个网络连接（文件描述符）</strong>  的技术。</h6>\n<ul>\n<li>I/O多路复用解决了“高并发下的线程开销问题”。</li>\n<li>在没有这项技术前，我们要支撑 1 万个并发连接，可能需要启动1万个线程，这会导致内存耗尽和CPU频繁的上下文切换。</li>\n<li>有了 I/O 多路复用（尤其是 epoll），我们可以用一个线程轻松管理成千上万个连接，极大提升了系统的吞吐量。</li>\n</ul>\n<ol>\n<li>举例理解：</li>\n</ol>\n<p>假设一家餐厅有 100 桌客人：</p>\n<ul>\n<li>阻塞 I/O (Blocking I/O)： 一个服务员盯一桌客人。客人不点菜，服务员就死等。要服务 100 桌，就得请 100 个服务员。（开销巨大，线程切换成本高）</li>\n<li>非阻塞 I/O (Non-blocking I/O)： 一个服务员在 100 桌之间不停轮询：“点菜吗？”“不点。”“点菜吗？”“不点。” （效率低下，CPU 全在跑无意义的询问）</li>\n<li>I/O 多路复用： 服务员在前台放一个呼叫器。哪桌客人想点菜了，就按一下呼叫器，呼叫器亮起对应的桌号。服务员只需要盯着这个呼叫器，哪桌亮了去哪桌。 （这就是 I/O 多路复用）</li>\n</ul>\n<ol start=\"2\">\n<li>三种核心实现机制</li>\n</ol>\n<p><strong>在Linux中，I/O 多路复用经历了从select 到 poll 再到 epoll的演进。</strong></p>\n<h5 id=\"selectselect-是最早的实现它维护一个存放文件描述符fd的集合\">select：select 是最早的实现。它维护一个存放文件描述符（FD）的集合。</h5>\n<ul>\n<li>工作方式：每次调用都要把整个集合从用户态拷贝到内核态，内核线性扫描所有 FD。</li>\n<li>缺点：有1024的数量限制（硬编码）。由于是线性扫描，时间复杂度为 O(n)，连接越多越慢。</li>\n</ul>\n<h5 id=\"poll基本解决了数量限制问题\">poll：基本解决了数量限制问题。</h5>\n<ul>\n<li>工作方式：使用链表存储 FD。</li>\n<li>缺点：依然需要遍历整个集合来找出哪个 FD 就绪，性能随连接数增加而线性下降。</li>\n</ul>\n<h5 id=\"epoll-linux的终极武器\">epoll (Linux的终极武器)</h5>\n<ul>\n<li>epoll是目前Linux下处理百万级别并发的首选。它不再像select那样盲目扫描，而是采用事件通知机制。</li>\n</ul>\n<h5 id=\"深入解析epoll的原理\">深入解析epoll的原理</h5>\n<ul>\n<li>epoll的高效源于它在内核中维护了两个核心数据结构：\n<ul>\n<li>红黑树 (RB-Tree)：用于存储所有待监控的 FD。查找、插入、删除的时间复杂度都是O(log n)。</li>\n<li>就绪列表 (Ready List)：这是一个双向链表。当某个FD有事件发生时，内核会通过回调机制将其放入这个列表中。</li>\n</ul>\n</li>\n<li>epoll的工作流程：\n<ul>\n<li>epoll_create：在内核开辟一块空间，建立红黑树和就绪列表。</li>\n<li>epoll_ctl：向红黑树中添加或删除需要监控的连接。</li>\n<li>epoll_wait：线程只需检查就绪列表。如果列表为空，线程睡眠；如果有数据，直接处理列表里的FD。</li>\n<li>结论：无论你有100个还是100万个连接，epoll只关注活跃的连接，时间复杂度近似O(1)。</li>\n</ul>\n</li>\n</ul>\n<h5 id=\"两种触发模式ltvset\">两种触发模式：LTvsET</h5>\n<ul>\n<li>在使用epoll时，有两个非常重要的触发模式，这直接影响代码逻辑：</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>模式</th>\n<th>名称</th>\n<th>表现</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>LT(Level Triggered)</td>\n<td>水平触发(默认)</td>\n<td>只要缓冲区里还有数据没读完，内核就会不断通知你。比较安全，不容易漏掉数据。</td>\n</tr>\n<tr>\n<td>ET(Edge Triggered)</td>\n<td>边缘触发</td>\n<td>只有状态发生变化（数据从无到有）时才通知一次。极其高效，但要求开发者必须一次性读完所有数据，否则剩下的数据可能永远不会被处理。</td>\n</tr>\n</tbody>\n</table>\n\n</div>\n<div class=\"clear\"></div>\n\n\t\t</div>\n\t\t<div class=\"postDesc\">posted @ \n<span id=\"post-date\">2025-12-25 20:24</span>&nbsp;\n<a href=\"https://www.cnblogs.com/xi-yongqi\">我会替风去</a>&nbsp;\n阅读(<span id=\"post_view_count\">0</span>)&nbsp;\n评论(<span id=\"post_comment_count\">0</span>)&nbsp;\n&nbsp;\n<a href=\"\">收藏</a>&nbsp;\n<a href=\"\">举报</a>\n</div>"
    },
    {
      "title": "Lua:善用luarocks管理公共库",
      "link": "https://www.cnblogs.com/developer-tianyiyun/p/19400726",
      "published": "",
      "description": "<h1 class=\"postTitle\">\n                <a class=\"postTitle2 vertical-middle\" href=\"https://www.cnblogs.com/developer-tianyiyun/p/19400726\" id=\"cb_post_title_url\" title=\"发布于 2025-12-25 18:58\">\n    <span>Lua:善用luarocks管理公共库</span>\n    \n\n</a>\n\n            </h1>\n            <div class=\"clear\"></div>\n            <div class=\"postBody\">\n                <div class=\"blogpost-body blogpost-body-html\" id=\"cnblogs_post_body\">\n<p>本文分享自天翼云开发者社区《<a href=\"https://www.ctyun.cn/developer/article/611294567211077\" rel=\"noopener nofollow\">Lua善用luarocks管理公共库</a>》.作者：王****淋</p>\n<h2>什么是Luarocks</h2>\n<p>Luarocks是一个Lua包管理器，基于 Lua 语言开发，提供一个命令行的方式来管理 Lua 包依赖、安装第三方 Lua 包等，社区比较流行的包管理器之一</p>\n<p>Python具有PIP，Ruby具有Gems，Java具有Maven，Node具有npm，Lua具有Luarocks。</p>\n<h2>前要：先看Lua的require</h2>\n<p>以openresty中的Luajit<code>/usr/local/openresty/luajit/bin/luajit</code>为例：</p>\n<h3>测试代码：</h3>\n<pre class=\"language-lua\"><code class=\"language-lua hljs\"><span class=\"hljs-keyword\">local cjson = <span class=\"hljs-built_in\">require <span class=\"hljs-string\">\"cjson\"\n<span class=\"hljs-keyword\">local s = cjson.encode({<span class=\"hljs-string\">\"test\", <span class=\"hljs-string\">\"lua\", <span class=\"hljs-string\">\"package\"})\n<span class=\"hljs-built_in\">print(s)\n</span></span></span></span></span></span></span></span></code></pre>\n<h3>执行结果：</h3>\n<pre><code class=\"hljs language-swift\"><span class=\"hljs-regexp\">/usr/local<span class=\"hljs-regexp\">/openresty/luajit<span class=\"hljs-regexp\">/bin/luajit: test.lua:<span class=\"hljs-number\">3: module 'cjson' not found:\n        no field <span class=\"hljs-keyword\">package.preload['cjson']\n        no file '<span class=\"hljs-operator\">./cjson.lua'\n        no file '<span class=\"hljs-regexp\">/usr/local<span class=\"hljs-regexp\">/openresty/luajit<span class=\"hljs-regexp\">/share/luajit<span class=\"hljs-operator\">-<span class=\"hljs-number\">2.1.<span class=\"hljs-number\">0<span class=\"hljs-operator\">-beta3<span class=\"hljs-operator\">/cjson.lua'\n        no file '<span class=\"hljs-regexp\">/usr/local<span class=\"hljs-regexp\">/share/lua<span class=\"hljs-regexp\">/5.1/cjson.lua'\n        no file '<span class=\"hljs-regexp\">/usr/local<span class=\"hljs-regexp\">/share/lua<span class=\"hljs-regexp\">/5.1/cjson<span class=\"hljs-operator\">/<span class=\"hljs-keyword\">init.lua'\n        no file '<span class=\"hljs-regexp\">/usr/local<span class=\"hljs-regexp\">/openresty/luajit<span class=\"hljs-regexp\">/share/lua<span class=\"hljs-regexp\">/5.1/cjson.lua'\n        no file '<span class=\"hljs-regexp\">/usr/local<span class=\"hljs-regexp\">/openresty/luajit<span class=\"hljs-regexp\">/share/lua<span class=\"hljs-regexp\">/5.1/cjson<span class=\"hljs-operator\">/<span class=\"hljs-keyword\">init.lua'\n        no file '<span class=\"hljs-operator\">./cjson.so'\n        no file '<span class=\"hljs-regexp\">/usr/local<span class=\"hljs-regexp\">/lib/lua<span class=\"hljs-regexp\">/5.1/cjson.so'\n        no file '<span class=\"hljs-regexp\">/usr/local<span class=\"hljs-regexp\">/openresty/luajit<span class=\"hljs-regexp\">/lib/lua<span class=\"hljs-regexp\">/5.1/cjson.so'\n        no file '<span class=\"hljs-regexp\">/usr/local<span class=\"hljs-regexp\">/lib/lua<span class=\"hljs-regexp\">/5.1/loadall.so'\nstack traceback:\n        [<span class=\"hljs-type\">C]: <span class=\"hljs-keyword\">in function 'require'\n        test.lua:<span class=\"hljs-number\">3: <span class=\"hljs-keyword\">in main chunk\n        [<span class=\"hljs-type\">C]: at <span class=\"hljs-number\">0x004055d0\n</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></code></pre>\n<p>从测试结果可以看到，require有几个搜索目录，理论上任意目录都可以</p>\n<h2>Luarocks包管理</h2>\n<p>我们软件开发过程中会引入大量库。如果简单把所有库都放入代码仓，那会造成大量的混乱。因此，更适合的办法是，使用luarocks包管理工具，将库安装到库目录。</p>\n<h3>示例：luarocks 安装 cjson</h3>\n<p>以openresty中的Luajit<code>/usr/local/openresty/luajit/bin/luajit</code>为例：</p>\n<p><code>/usr/local/openresty/luajit/bin/luarocks install lua-cjson</code></p>\n<pre><code class=\"hljs language-apache\"><span class=\"hljs-attribute\">Installing /luarocks.org/lua-cjson-<span class=\"hljs-number\">2.1.0.10-<span class=\"hljs-number\">1.src.rock\n\n<span class=\"hljs-attribute\">lua-cjson <span class=\"hljs-number\">2.1.0.10-<span class=\"hljs-number\">1 depends <span class=\"hljs-literal\">on lua &gt;= <span class=\"hljs-number\">5.<span class=\"hljs-number\">1 (<span class=\"hljs-number\">5.<span class=\"hljs-number\">1-<span class=\"hljs-number\">1 provided by VM)\n<span class=\"hljs-attribute\">gcc -O2 -fPIC -I/usr/local/openresty/luajit/include/luajit-<span class=\"hljs-number\">2.<span class=\"hljs-number\">1 -c lua_cjson.c -o lua_cjson.o\n<span class=\"hljs-attribute\">gcc -O2 -fPIC -I/usr/local/openresty/luajit/include/luajit-<span class=\"hljs-number\">2.<span class=\"hljs-number\">1 -c strbuf.c -o strbuf.o\n<span class=\"hljs-attribute\">gcc -O2 -fPIC -I/usr/local/openresty/luajit/include/luajit-<span class=\"hljs-number\">2.<span class=\"hljs-number\">1 -c fpconv.c -o fpconv.o\n<span class=\"hljs-attribute\">gcc -shared -o cjson.so lua_cjson.o strbuf.o fpconv.o\n<span class=\"hljs-attribute\">No existing manifest. Attempting to rebuild...\n<span class=\"hljs-attribute\">lua-cjson <span class=\"hljs-number\">2.1.0.10-<span class=\"hljs-number\">1 is now installed in /usr/local/openresty/luajit (license: MIT)\n</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></code></pre>\n<pre class=\"language-sh\"><code class=\"language-sh hljs language-bash\"><span class=\"hljs-comment\"># find /usr/local/openresty/luajit -name cjson.so \n/usr/local/openresty/luajit/lib/lua/5.1/cjson.so\n</span></code></pre>\n<h3>luarocks 安装nettle</h3>\n<pre class=\"language-sh\"><code class=\"language-sh hljs language-bash\"><span class=\"hljs-comment\"># find /usr/local/openresty/luajit -name *nettle*\n/usr/local/openresty/luajit/lib/luarocks/rocks-5.1/lua-resty-nettle\n/usr/local/openresty/luajit/lib/luarocks/rocks-5.1/lua-resty-nettle/2.1-1/lua-resty-nettle-2.1-1.rockspec\n/usr/local/openresty/luajit/share/lua/5.1/resty/nettle\n/usr/local/openresty/luajit/share/lua/5.1/resty/nettle/types/nettle-types.lua\n/usr/local/openresty/luajit/share/lua/5.1/resty/nettle.lua</span></code></pre>\n</div>\n<div class=\"clear\"></div>\n\n            </div>\n            <div class=\"postDesc\">posted @ \n<span id=\"post-date\">2025-12-25 18:58</span>&nbsp;\n<a href=\"https://www.cnblogs.com/developer-tianyiyun\">天翼云开发者社区</a>&nbsp;\n阅读(<span id=\"post_view_count\">0</span>)&nbsp;\n评论(<span id=\"post_comment_count\">0</span>)&nbsp;\n&nbsp;\n<a href=\"\">收藏</a>&nbsp;\n<a href=\"\">举报</a>\n</div>"
    },
    {
      "title": "智能控制实验：模糊控制基础（Fuzzy）",
      "link": "https://www.cnblogs.com/DiscreteWind/p/19400636",
      "published": "",
      "description": "<h1 class=\"postTitle\">\n                <a class=\"postTitle2 vertical-middle\" href=\"https://www.cnblogs.com/DiscreteWind/p/19400636\" id=\"cb_post_title_url\" title=\"发布于 2025-12-25 18:41\">\n    <span>智能控制实验：模糊控制基础（Fuzzy）</span>\n    \n\n</a>\n\n            </h1>\n            <div class=\"clear\"></div>\n            <div class=\"postBody\">\n                <div class=\"blogpost-body cnblogs-markdown\" id=\"cnblogs_post_body\">\n<p><strong>简介：学习模糊控制的原理与Matlab模糊逻辑设计器（FuzzyLogicDesigner）的使用，对比PID控制与模糊控制在同一单位反馈系统上的作用效果。</strong></p>\n<p><strong>福州大学 自动化系 2024/9/18</strong></p>\n<p><strong>指导教师：陈剑</strong></p>\n<h1 id=\"实验任务\"><strong>实验任务</strong></h1>\n<p>有单位反馈系统，其开环传递函数为：</p>\n<p></p><div class=\"math display\">\\[G(s)=\\frac{5}{s^{3}+3s^{2}+s} \n\\]</div><p></p><p>采用周期为40s的方波为输入信号。</p>\n<p>1）设计该对象的PID控制系统，并调试出一组PID控制器参数，给出输入输出曲线；</p>\n<p>2）设计模糊控制器对该系统进行控制，同样给出输入输出曲线；</p>\n<p>3）将模糊控制结果与PID控制结果相比较；</p>\n<p>4）在系统中加入延迟环节（延迟时间为1s），和随机扰动（扰动幅值为0.01），重新设计模糊控制与PID控制器，并比较二者的控制效果。</p>\n<p>要求：显示模糊推理系统的输入输出量、论域、所包括的隶属函数及其类型和参数、规则库。并说明所设计的模糊推理系统的规则原理。</p>\n<h1 id=\"实验过程\"><strong>实验过程</strong></h1>\n<h2 id=\"1pid控制系统\">1.PID控制系统</h2>\n<p>设计对象的PID控制系统如下。</p>\n<p><img alt=\"image\" src=\"https://img2024.cnblogs.com/blog/3501202/202512/3501202-20251225183526736-1207431222.png\" /></p>\n<p>使用PID调节器调试PID控制器参数。</p>\n<p><img alt=\"image\" src=\"https://img2024.cnblogs.com/blog/3501202/202512/3501202-20251225183548232-2141251578.png\" /></p>\n<p><img alt=\"image\" src=\"https://img2024.cnblogs.com/blog/3501202/202512/3501202-20251225183622178-402326837.png\" /></p>\n<p>PID控制作用下，系统参考输入及输出曲线如下。<br />\n<img alt=\"image\" src=\"https://img2024.cnblogs.com/blog/3501202/202512/3501202-20251225183658982-98225518.png\" /></p>\n<h2 id=\"2模糊控制系统\">2.模糊控制系统</h2>\n<p>设计对象的模糊控制系统如下。<br />\n<img alt=\"image\" src=\"https://img2024.cnblogs.com/blog/3501202/202512/3501202-20251225183711881-274403205.png\" /></p>\n<p>在Matlab命令行中输入“fuzzyLogicDesigner”，打开模糊编辑器工具，设计模糊逻辑的各内容。</p>\n<p>设定输入变量为E（误差）、EC（误差的微分），输出变量为U。推理算法为Mamdani Type1。</p>\n<p>由PID控制器的响应曲线大致估算，E的论域为(-2,2)，EC的论域为(-0.8,0.8)，U的论域为(-0.2,0.2)。</p>\n<p>选择E、EC的隶属函数为高斯曲线型，U的隶属函数为三角型。<br />\n<img alt=\"image\" src=\"https://img2024.cnblogs.com/blog/3501202/202512/3501202-20251225183729940-255096891.png\" /></p>\n<p>创建规则库。</p>\n<table>\n<thead>\n<tr>\n<th>E  EC</th>\n<th>NB</th>\n<th>NM</th>\n<th>NS</th>\n<th>ZO</th>\n<th>PS</th>\n<th>PM</th>\n<th>PB</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>NB</td>\n<td>PB</td>\n<td>PB</td>\n<td>PB</td>\n<td>PM</td>\n<td>PM</td>\n<td>PS</td>\n<td>ZO</td>\n</tr>\n<tr>\n<td>NM</td>\n<td>PB</td>\n<td>PB</td>\n<td>PM</td>\n<td>PM</td>\n<td>PS</td>\n<td>ZO</td>\n<td>NS</td>\n</tr>\n<tr>\n<td>NS</td>\n<td>PB</td>\n<td>PM</td>\n<td>PM</td>\n<td>PS</td>\n<td>ZO</td>\n<td>NS</td>\n<td>NM</td>\n</tr>\n<tr>\n<td>ZO</td>\n<td>PM</td>\n<td>PM</td>\n<td>PS</td>\n<td>ZO</td>\n<td>NS</td>\n<td>NM</td>\n<td>NM</td>\n</tr>\n<tr>\n<td>PS</td>\n<td>PM</td>\n<td>PS</td>\n<td>ZO</td>\n<td>NS</td>\n<td>NM</td>\n<td>NM</td>\n<td>NB</td>\n</tr>\n<tr>\n<td>PM</td>\n<td>PS</td>\n<td>ZO</td>\n<td>NS</td>\n<td>NM</td>\n<td>NM</td>\n<td>NB</td>\n<td>NB</td>\n</tr>\n<tr>\n<td>PB</td>\n<td>ZO</td>\n<td>NS</td>\n<td>NM</td>\n<td>NM</td>\n<td>NB</td>\n<td>NB</td>\n<td>NB</td>\n</tr>\n</tbody>\n</table>\n<p>规则原理：规则中，当输入的控制量“误差E”和“误差变化率EC”较小和较大时，分别对应“输出U”较小和较大，并适当调整隶属度函数的类型及分布范围，可以得到接近于方波的模糊控制输出量。</p>\n<p>总结模糊规则时，应注意以下原则：</p>\n<p>（1）规则数量合理；</p>\n<p>（2）规则需具有一致性；</p>\n<p>（3）完备性要好。</p>\n<p>完成规则创建后，预览control surface。\t<br />\n<img alt=\"image\" src=\"https://img2024.cnblogs.com/blog/3501202/202512/3501202-20251225183741080-608088277.png\" /></p>\n<p>模糊控制作用下，系统仿真结果曲线如下。<br />\n<img alt=\"image\" src=\"https://img2024.cnblogs.com/blog/3501202/202512/3501202-20251225183751153-207330568.png\" /></p>\n<h2 id=\"3优化模糊控制器\">3.优化模糊控制器</h2>\n<p>对模糊控制逻辑的隶属度函数及论域等进行改进，如下所示。<br />\n<img alt=\"image\" src=\"https://img2024.cnblogs.com/blog/3501202/202512/3501202-20251225183759033-304628221.png\" /><br />\n<img alt=\"image\" src=\"https://img2024.cnblogs.com/blog/3501202/202512/3501202-20251225183803758-417344024.png\" /><br />\n<img alt=\"image\" src=\"https://img2024.cnblogs.com/blog/3501202/202512/3501202-20251225183809634-2032069293.png\" /><br />\n<img alt=\"image\" src=\"https://img2024.cnblogs.com/blog/3501202/202512/3501202-20251225183815009-75433243.png\" /></p>\n<p>将修改后的FIS文件应用于前述模糊控制系统，仿真结果曲线如下。可见控制效果获得较大改善。<br />\n<img alt=\"image\" src=\"https://img2024.cnblogs.com/blog/3501202/202512/3501202-20251225183821753-1320039172.png\" /></p>\n<h2 id=\"4两种控制方法的比较\">4.两种控制方法的比较</h2>\n<p>对比波形可知，模糊控制和PID控制都能在一定程度上接近预期的方波波形。</p>\n<p>所限于时间与经验不足，设计的模糊控制器效果一般。相较于仅初步调参的模糊控制器，PID控制器的输出结果更接近方波的预期波形。说明在简单低阶线性系统中，PID控制器比模糊控制器更为简易且实用。</p>\n<h2 id=\"5在系统中加入延迟环节和随机扰动\">5.在系统中加入延迟环节和随机扰动</h2>\n<p>加入延迟环节与噪声扰动后，对象的PID控制系统如下。<br />\n<img alt=\"image\" src=\"https://img2024.cnblogs.com/blog/3501202/202512/3501202-20251225183828640-1009980142.png\" /></p>\n<p>调节PID控制器参数后，控制系统参考输入及输出曲线如下。<br />\n<img alt=\"image\" src=\"https://img2024.cnblogs.com/blog/3501202/202512/3501202-20251225183834421-303070996.png\" /></p>\n<p>加入延迟环节与噪声扰动后，对象的模糊控制系统如下。<br />\n<img alt=\"image\" src=\"https://img2024.cnblogs.com/blog/3501202/202512/3501202-20251225183841839-2142691569.png\" /></p>\n<p>控制系统参考输入及输出曲线如下。<br />\n<img alt=\"image\" src=\"https://img2024.cnblogs.com/blog/3501202/202512/3501202-20251225183850309-2108583892.png\" /></p>\n<p>可见，当系统内添加扰动与时滞等非线性环节后，PID控制系统的稳态误差较大，模糊控制系统则仍能稳定地响应。</p>\n<h1 id=\"总结\"><strong>总结</strong></h1>\n<p>模糊控制器通过将测量得到的被控对象的状态经过模糊化接口转换为用人类自然语言描述的模糊量，而后根据人类的语言控制规则，经过模糊推理得到输出控制量的模糊取值，控制量的模糊取值再经过清晰化接口转换为执行机构能够接收的精确量。</p>\n<p>相较于传统控制方法，模糊控制具有如下优点：</p>\n<p>（1）适用性广：模糊控制在设计控制器时不依赖控制对象的数学模型，只要求掌握控制经验；</p>\n<p>（2）鲁棒性强：系统鲁棒性强，适用于出现扰动与时滞环节的系统。</p>\n<p>但模糊控制也具有如下缺点：</p>\n<p>（1）参数调整困难：确立模糊化和逆模糊化的方法、总结模糊规则时,缺乏系统的方法,主要靠经验和试凑。</p>\n<p>（2）具有稳态误差：模糊控制器由于不具有积分环节,因而稳态精度不高。</p>\n<p>模糊控制算法作为一种基于模糊逻辑的控制算法，在控制系统中具有广泛的应用前景。尽管该算法存在一些缺点，如参数调整困难等问题，但其适用性广、鲁棒性强优点使得它在许多应用场景中表现出良好的性能。</p>\n<p>模糊控制还可以与其它常见控制方法相结合，如模糊PID控制、自适应模糊控制、专家模糊控制等，以弥补模糊控制中存在的缺点。</p>\n<p>在实际应用中，我们需要根据具体情况选择合适的控制算法，并结合实际经验进行参数调整，以实现最佳的控制效果。</p>\n<h1 id=\"参考文献\"><strong>参考文献</strong></h1>\n<p>[1]韦巍,何衍. 智能控制基础[M]. 北京:清华大学出版社, 2008-11.</p>\n<p>[2]王耀南. 智能控制理论及应用[M]. 北京:机械工业出版社, 2008-02.</p>\n<p>[3]晏勇,杜继宏,冯元琨. 模糊控制[J]. 计算机测量与控制,1999,7(1):55-57. DOI:10.3969/j.issn.1671-4598.1999.01.019.</p>\n<h1 id=\"附\">附</h1>\n<p>模糊控制器曲线导出代码</p>\n<pre><code class=\"language-matlab\">a=readfis('myFIS');%括号内为FIS文件名称\nh3=figure(1)%误差\nset(h3,'Position',[600,100,400,250]);\nplotmf(a,'input',1);\nset(gca,'FontName','Times New Roman','FontSize',10,'LineWidth',0.5);\nxlabel('E','FontName','Times New Roman','fontsize',10);\n% xlabel('\\fontsize{10}\\fontname{Times new roman}e');\nylabel('\\fontsize{10}\\fontname{Times new roman}Degree of membership');\nh3=figure(2)%误差的微分\nset(h3,'Position',[600,100,400,250]);\nplotmf(a,'input',2);\nset(gca,'FontName','Times New Roman','FontSize',10,'LineWidth',0.5);\nxlabel('EC','FontName','Times New Roman','fontsize',10);\nylabel('\\fontsize{10}\\fontname{Times new roman}Degree of membership');\nh3=figure(3)%输出\nset(h3,'Position',[600,100,400,250]);\nplotmf(a,'output',1);\nset(gca,'FontName','Times New Roman','FontSize',10,'LineWidth',0.5);\nxlabel('U','FontName','Times New Roman','fontsize',10);\nylabel('\\fontsize{10}\\fontname{Times new roman}Degree of membership');\n</code></pre>\n<p>模糊控制器Control Surface导出代码</p>\n<pre><code class=\"language-matlab\">a=readfis('myFIS');%括号内为FIS文件名称\nfigure(1)\ngensurf(a,[1,2],1)\nset(gca,'FontName','Times New Roman','FontSize',8,'LineWidth',0.5);\nxlabel('E','FontName','Times New Roman','fontsize',8);\nylabel('EC','FontName','Times New Roman','fontsize',8);\nzlabel('U','FontName','Times New Roman','fontsize',8);\n</code></pre>\n\n</div>\n<div class=\"clear\"></div>\n\n            </div>\n            <div class=\"postDesc\">posted @ \n<span id=\"post-date\">2025-12-25 18:41</span>&nbsp;\n<a href=\"https://www.cnblogs.com/DiscreteWind\">荔枝气泡水Lychee</a>&nbsp;\n阅读(<span id=\"post_view_count\">0</span>)&nbsp;\n评论(<span id=\"post_comment_count\">0</span>)&nbsp;\n&nbsp;\n<a href=\"\">收藏</a>&nbsp;\n<a href=\"\">举报</a>\n</div>"
    },
    {
      "title": "告别“裸奔”代码：用 Pydantic 让你的 Python 数据固若金汤",
      "link": "https://www.cnblogs.com/swizard/p/19399472",
      "published": "",
      "description": "<h1 class=\"postTitle\">\n                <a class=\"postTitle2 vertical-middle\" href=\"https://www.cnblogs.com/swizard/p/19399472\" id=\"cb_post_title_url\" title=\"发布于 2025-12-25 15:30\">\n    <span>告别“裸奔”代码：用 Pydantic 让你的 Python 数据固若金汤</span>\n    \n\n</a>\n\n            </h1>\n            <div class=\"clear\"></div>\n            <div class=\"postBody\">\n                <div class=\"blogpost-body blogpost-body-html\" id=\"cnblogs_post_body\">\n<h3>1. 引言：由“信任”引发的血案</h3>\n<p>作为 Python 开发者，你一定经历过这样的<strong>至暗时刻</strong>：</p>\n<p>你正在写一个处理后端 API 数据的脚本。后端告诉你：“放心，我会传给你一个包含用户 ID 和年龄的 JSON。” 于是你自信地写下：</p>\n<div class=\"code-block ng-tns-c3098535048-364 ng-animate-disabled ng-trigger ng-trigger-codeBlockRevealAnimation\">\n<div class=\"code-block-decoration header-formatted gds-title-s ng-tns-c3098535048-364 ng-star-inserted\"><span class=\"ng-tns-c3098535048-364\">Python</span>\n<div class=\"buttons ng-tns-c3098535048-364 ng-star-inserted\">&nbsp;</div>\n</div>\n<div class=\"formatted-code-block-internal-container ng-tns-c3098535048-364\">\n<div class=\"animated-opacity ng-tns-c3098535048-364\">\n<pre class=\"ng-tns-c3098535048-364 highlighter-hljs\"><code>def process_user(data):\n    # 直接裸读字典\n    user_id = data['id'] \n    age = data['age'] + 1\n    print(f\"用户 {user_id} 明年 {age} 岁\")</code></pre>\n</div>\n</div>\n</div>\n<p>代码上线第一天，崩溃了。</p>\n<ul>\n<li>\n<p><strong>情况 A</strong>：后端手滑，传回了 <code>{\"id\": \"1001\", \"age\": \"25\"}</code>（全是字符串）。你的代码报错：<code>TypeError</code>，因为字符串不能加 1。</p>\n</li>\n<li>\n<p><strong>情况 B</strong>：后端改了逻辑，<code>age</code> 字段丢失了。你的代码报错：<code>KeyError: 'age'</code>。</p>\n</li>\n<li>\n<p><strong>情况 C</strong>：<code>id</code> 居然是个 <code>null</code>...</p>\n</li>\n</ul>\n<p>为了防御这些情况，你的代码变成了这样：</p>\n<div class=\"code-block ng-tns-c3098535048-365 ng-animate-disabled ng-trigger ng-trigger-codeBlockRevealAnimation\">\n<div class=\"code-block-decoration header-formatted gds-title-s ng-tns-c3098535048-365 ng-star-inserted\"><span class=\"ng-tns-c3098535048-365\">Python</span>\n<div class=\"buttons ng-tns-c3098535048-365 ng-star-inserted\">&nbsp;</div>\n</div>\n<div class=\"formatted-code-block-internal-container ng-tns-c3098535048-365\">\n<div class=\"animated-opacity ng-tns-c3098535048-365\">\n<pre class=\"ng-tns-c3098535048-365 highlighter-hljs\"><code>if 'age' in data and data['age'] is not None and isinstance(data['age'], int):\n    # ...无数的 if-else 防御性代码...</code></pre>\n</div>\n</div>\n</div>\n<p>这不仅丑陋，而且难以维护。<strong>这就是“数据裸奔”的代价。</strong></p>\n<p><strong>Pydantic 的出现，就是为了终结这场噩梦。</strong> 它利用 Python 原生的类型提示（Type Hints），在运行时帮你自动完成<strong>数据校验（Validation）和类型转换（Parsing）</strong>。</p>\n<h3>2. 概念拆解：它不仅仅是校验，它是“智能模具”</h3>\n<p>很多新手误以为 Pydantic 只是一个“报错机器”（一旦数据不对就报错）。其实，它更像是一个**“具有纠错能力的智能模具”**。</p>\n<h4>💡 生活化类比：工厂流水线上的“智能整形机”</h4>\n<p>想象你在经营一家制作<strong>乐高积木</strong>的工厂。</p>\n<ol start=\"1\">\n<li>\n<p><strong>普通 Python 字典</strong>就像一个<strong>垃圾袋</strong>。你可以往里面扔任何东西：正方形的积木、圆形的球、甚至半个苹果。当你伸手进去拿的时候，你根本不知道会摸到什么。</p>\n</li>\n<li>\n<p><strong>Pydantic 模型</strong>就像一个<strong>精密钢模具</strong>。</p>\n<ul>\n<li>\n<p>你定义了这个模具只能生产“正方形”的塑料。</p>\n</li>\n<li>\n<p><strong>输入（Parsing/Coercion）</strong>：如果你倒进来的是液态塑料（原始数据），模具会把它压成正方形。如果你塞进来一个稍微有点歪的软泥（比如字符串 <code>\"123\"</code>），模具会尝试把它修正为完美的正方形（整数 <code>123</code>）。</p>\n</li>\n<li>\n<p><strong>拒绝（Validation）</strong>：如果你试图把一块石头（完全不兼容的数据）塞进去，模具会立刻发出红色警报（抛出错误），拒绝生产次品。</p>\n</li>\n</ul>\n</li>\n</ol>\n<p><strong>核心逻辑：</strong> Pydantic 关注的不是“数据长什么样”，而是“数据<strong>应该</strong>长什么样”。</p>\n<h3>3. 动手实战：从 0 到 1 掌握 Pydantic</h3>\n<p>让我们扔掉那些复杂的 <code>if-else</code>，看看 Pydantic 如何优雅地处理问题。</p>\n<p>首先安装它： <code>pip install pydantic</code></p>\n<h4>3.1 Hello World：定义你的第一个模型</h4>\n<p>我们将定义一个 <code>User</code> 模型。请注意，我们写的只是标准的 Python 类，并使用了类型提示。</p>\n<div class=\"code-block ng-tns-c3098535048-366 ng-animate-disabled ng-trigger ng-trigger-codeBlockRevealAnimation\">\n<div class=\"code-block-decoration header-formatted gds-title-s ng-tns-c3098535048-366 ng-star-inserted\"><span class=\"ng-tns-c3098535048-366\">Python</span>\n<div class=\"buttons ng-tns-c3098535048-366 ng-star-inserted\">&nbsp;</div>\n</div>\n<div class=\"formatted-code-block-internal-container ng-tns-c3098535048-366\">\n<div class=\"animated-opacity ng-tns-c3098535048-366\">\n<pre class=\"ng-tns-c3098535048-366 highlighter-hljs\"><code>from pydantic import BaseModel, ValidationError\nfrom typing import List, Optional\n\n# 1. 定义模型：继承自 BaseModel\nclass User(BaseModel):\n    id: int                # 必须是整数\n    name: str = \"Anonymous\" # 字符串，且有默认值\n    tags: List[str]        # 必须是字符串列表\n    age: Optional[int] = None # 可选的整数，默认为 None\n\n# --- 场景一：完美数据 ---\nexternal_data = {\n    \"id\": 123,\n    \"name\": \"Neo\",\n    \"tags\": [\"admin\", \"editor\"],\n    \"age\": 30\n}\n\nuser = User(**external_data)\nprint(f\"成功创建: {user.name} (ID: {user.id})\")\n# 输出: 成功创建: Neo (ID: 123)</code></pre>\n</div>\n</div>\n</div>\n<h4>3.2 代码解析：神奇的“自动纠错”</h4>\n<p>现在，我们给它一点“脏数据”，看看 Pydantic 所谓的 <strong>Parsing（解析/强转）</strong> 能力。</p>\n<div class=\"code-block ng-tns-c3098535048-367 ng-animate-disabled ng-trigger ng-trigger-codeBlockRevealAnimation\">\n<div class=\"code-block-decoration header-formatted gds-title-s ng-tns-c3098535048-367 ng-star-inserted\"><span class=\"ng-tns-c3098535048-367\">Python</span>\n<div class=\"buttons ng-tns-c3098535048-367 ng-star-inserted\">&nbsp;</div>\n</div>\n<div class=\"formatted-code-block-internal-container ng-tns-c3098535048-367\">\n<div class=\"animated-opacity ng-tns-c3098535048-367\">\n<pre class=\"ng-tns-c3098535048-367 highlighter-hljs\"><code># --- 场景二：脏数据清洗 ---\ndirty_data = {\n    \"id\": \"456\",          # 注意：这是字符串 \"456\"\n    \"tags\": [1, 2],       # 注意：这是整数列表\n    # name 缺失，将使用默认值 \"Anonymous\"\n    # age 缺失，将使用默认值 None\n}\n\ntry:\n    user = User(**dirty_data)\n    print(\"--- 自动修正后的数据 ---\")\n    print(f\"ID 类型: {type(user.id)} -&gt; 值: {user.id}\")\n    print(f\"Tags 类型: {type(user.tags[0])} -&gt; 值: {user.tags}\")\n    print(f\"Name: {user.name}\")\n    \nexcept ValidationError as e:\n    print(e)</code></pre>\n</div>\n</div>\n</div>\n<p><strong>运行结果：</strong></p>\n<div class=\"code-block ng-tns-c3098535048-368 ng-animate-disabled ng-trigger ng-trigger-codeBlockRevealAnimation\">\n<div class=\"code-block-decoration header-formatted gds-title-s ng-tns-c3098535048-368 ng-star-inserted\"><span class=\"ng-tns-c3098535048-368\">Plaintext</span>\n<div class=\"buttons ng-tns-c3098535048-368 ng-star-inserted\">&nbsp;</div>\n</div>\n<div class=\"formatted-code-block-internal-container ng-tns-c3098535048-368\">\n<div class=\"animated-opacity ng-tns-c3098535048-368\">\n<pre class=\"ng-tns-c3098535048-368 highlighter-hljs\"><code>--- 自动修正后的数据 ---\nID 类型: &lt;class 'int'&gt; -&gt; 值: 456\nTags 类型: &lt;class 'str'&gt; -&gt; 值: ['1', '2']\nName: Anonymous</code></pre>\n</div>\n</div>\n</div>\n<p><strong>为什么这么写？</strong></p>\n<ul>\n<li>\n<p><strong><code>id</code></strong>: 尽管传入的是字符串 <code>\"456\"</code>，Pydantic 看到模型定义是 <code>int</code>，它自动帮你转成了整数 <code>456</code>。</p>\n</li>\n<li>\n<p><strong><code>tags</code></strong>: 传入的是 <code>[1, 2]</code>，模型要求 <code>List[str]</code>，它自动把每个元素转成了字符串 <code>['1', '2']</code>。</p>\n</li>\n<li>\n<p><strong>省心</strong>: 你不再需要写代码去转换类型，Pydantic 在实例化时就帮你做好了。拿到 <code>user</code> 对象的那一刻，你可以 100% 确信 <code>user.id</code> 绝对是个整数。</p>\n</li>\n</ul>\n<h3>4. 进阶深潜：不仅仅是类型检查</h3>\n<p>Pydantic 还有更多强大的功能，能让你在生产环境中如鱼得水。</p>\n<h4>4.1 这里的陷阱：Parsing vs Validation</h4>\n<p>新手最容易犯的错误是认为 Pydantic 会严格拒绝类型不符的数据。</p>\n<ul>\n<li>\n<p><strong>误区</strong>：以为传 <code>\"123\"</code> 给 <code>int</code> 字段会报错。</p>\n</li>\n<li>\n<p><strong>真相</strong>：Pydantic 会<strong>优先尝试转换</strong>。只有无法转换时（例如把 <code>\"apple\"</code> 传给 <code>int</code>），才会报错。</p>\n</li>\n</ul>\n<h4>4.2 最佳实践：使用 <code>Field</code> 和 <code>Validator</code></h4>\n<p>如果我们需要更细粒度的控制，比如“年龄必须大于 0”或者“密码必须包含大写字母”，单纯的类型提示就不够了。</p>\n<div class=\"code-block ng-tns-c3098535048-369 ng-animate-disabled ng-trigger ng-trigger-codeBlockRevealAnimation\">\n<div class=\"code-block-decoration header-formatted gds-title-s ng-tns-c3098535048-369 ng-star-inserted\"><span class=\"ng-tns-c3098535048-369\">Python</span>\n<div class=\"buttons ng-tns-c3098535048-369 ng-star-inserted\">&nbsp;</div>\n</div>\n<div class=\"formatted-code-block-internal-container ng-tns-c3098535048-369\">\n<div class=\"animated-opacity ng-tns-c3098535048-369\">\n<pre class=\"ng-tns-c3098535048-369 highlighter-hljs\"><code>from pydantic import BaseModel, Field, field_validator\n\nclass AdvancedUser(BaseModel):\n    # 使用 Field 限制数值范围\n    age: int = Field(gt=0, le=120, description=\"年龄必须在 0 到 120 之间\")\n    \n    password: str\n\n    # 自定义验证器：像写普通函数一样写校验逻辑\n    @field_validator('password')\n    @classmethod\n    def check_password_strength(cls, v: str) -&gt; str:\n        if len(v) &lt; 8:\n            raise ValueError('密码太短啦！至少要 8 位')\n        if 'admin' in v:\n            raise ValueError('密码不能包含 admin')\n        return v\n\n# 测试\ntry:\n    u = AdvancedUser(age=150, password=\"123\")\nexcept ValidationError as e:\n    print(e.json()) # Pydantic 会返回非常详细的 JSON 格式错误报告</code></pre>\n</div>\n</div>\n</div>\n<p><strong>输出的错误报告清晰明了：</strong></p>\n<ol start=\"1\">\n<li>\n<p><code>age</code>: Input should be less than or equal to 120</p>\n</li>\n<li>\n<p><code>password</code>: 密码太短啦！至少要 8 位</p>\n</li>\n</ol>\n<h4>4.3 导出数据</h4>\n<p>当你要把处理好的数据存入数据库或发回前端时，Pydantic 提供了极度方便的方法：</p>\n<div class=\"code-block ng-tns-c3098535048-370 ng-animate-disabled ng-trigger ng-trigger-codeBlockRevealAnimation\">\n<div class=\"code-block-decoration header-formatted gds-title-s ng-tns-c3098535048-370 ng-star-inserted\"><span class=\"ng-tns-c3098535048-370\">Python</span>\n<div class=\"buttons ng-tns-c3098535048-370 ng-star-inserted\">&nbsp;</div>\n</div>\n<div class=\"formatted-code-block-internal-container ng-tns-c3098535048-370\">\n<div class=\"animated-opacity ng-tns-c3098535048-370\">\n<pre class=\"ng-tns-c3098535048-370 highlighter-hljs\"><code># 转成字典\nprint(user.model_dump()) \n# 转成 JSON 字符串\nprint(user.model_dump_json())</code></pre>\n</div>\n</div>\n</div>\n<h3>5. 总结与延伸</h3>\n<p><strong>一句话总结：</strong> Pydantic 是 Python 世界的“安检员”，它利用类型提示将不可靠的输入数据清洗为严格的、类型安全的对象，让你在后续开发中彻底告别 <code>KeyError</code> 和类型混淆。</p>\n<p><strong>给你的小作业：</strong> 既然你已经掌握了基础，请尝试定义一个<strong>嵌套模型</strong>：</p>\n<ol start=\"1\">\n<li>\n<p>创建一个 <code>Address</code> 模型（包含 <code>city</code> 和 <code>zip_code</code>）。</p>\n</li>\n<li>\n<p>创建一个 <code>Employee</code> 模型，其中包含一个字段 <code>address</code>，类型是 <code>Address</code>。</p>\n</li>\n<li>\n<p>尝试传入一个嵌套的字典数据，看看 Pydantic 是否能自动解析深层的结构。</p>\n</li>\n</ol>\n</div>\n<div class=\"clear\"></div>\n\n            </div>\n            <div class=\"postDesc\">posted @ \n<span id=\"post-date\">2025-12-25 15:30</span>&nbsp;\n<a href=\"https://www.cnblogs.com/swizard\">Swizard</a>&nbsp;\n阅读(<span id=\"post_view_count\">59</span>)&nbsp;\n评论(<span id=\"post_comment_count\">0</span>)&nbsp;\n&nbsp;\n<a href=\"\">收藏</a>&nbsp;\n<a href=\"\">举报</a>\n</div>"
    },
    {
      "title": "问世间，exe是何物？直教AI沉默、Web寡言（4）",
      "link": "https://www.cnblogs.com/sunhui/p/19399320",
      "published": "",
      "description": "<h1 class=\"postTitle\"><a class=\"postTitle2 vertical-middle\" href=\"https://www.cnblogs.com/sunhui/p/19399320\" id=\"cb_post_title_url\" title=\"发布于 2025-12-25 15:30\">\n    <span>问世间，exe是何物？直教AI沉默、Web寡言（4）</span>\n    \n\n</a>\n</h1>\n\t    <div id=\"cnblogs_post_description\" style=\"display: none;\">\n        \n        这一篇，爱丽丝发现了WinForm应用本身拥有的浏览器窗口的”秘密“……\n    </div>\n<div class=\"blogpost-body blogpost-body-html\" id=\"cnblogs_post_body\">\n<p>爱丽丝漫游WinForms应用开发奇境记（4）</p>\n<p><a href=\"https://github.com/AIGCEra/Creator/releases/download/FirstRelease/CreatorSetup.msi\" rel=\"noopener nofollow\">下载爱丽丝的镜子</a></p>\n<p>&nbsp;<a href=\"https://www.cnblogs.com/sunhui/p/19391507\">问世间，exe是何物？直教AI沉默、Web寡言（1）- 博客园</a></p>\n<p><a href=\"https://www.cnblogs.com/sunhui/p/19392696\">问世间，exe是何物？直教AI沉默、Web寡言 （2）- 博客园</a></p>\n<p><a href=\"https://www.cnblogs.com/sunhui/p/19395909\">问世间，exe是何物？直教AI沉默、Web寡言（3） -&nbsp; 博客园</a></p>\n<h1>镜中觉醒——当编译成为演化之门</h1>\n<div align=\"center\">\n<table border=\"1\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody>\n<tr>\n<td valign=\"top\" width=\"529\">\n<p><strong>在现代数学之中，一个数学方程的“通解”蕴含着所有的可能，“特解”只是它偶尔的显形。我们过去的整个桌面世界，都建立在一个美丽的误会之上：我们以为交付给用户的，是程序的“通解”，而事实上，那只是它在默认条件下，一个孤独的“特解”。</strong></p>\n<p><strong>你的‘yourApp&nbsp;.exe’，生而完整，本自具足。它本就是一个能响应无数“边界条件”的丰富系统。yourApp.App.html&nbsp;并非外来的“插件”，它只是终于被我们看见的、那个本就存在的“边界条件输入框”。</strong></p>\n<p><strong>认知一旦打开，便一去不回，从此你再也无法将一个桌面应用程序，只看作它自己，你会看到它身后荡漾的无限可能，如同看到平静水面下，整个宇宙的涟漪……</strong></p>\n</td>\n</tr>\n</tbody>\n</table>\n</div>\n<p>“这不是什么&nbsp;<em>Process.Start</em>，”我低语。<br />\n仿佛浏览器已将我的应用程序视为自己血脉的一部分。<br />\n我曾恐惧的那个调用——<em>Process.Start</em>——如幽灵指令般消散无形。<br />\n它不是启动我之外的某物，<br />\n而是让我意识到——从来就没有什么“之外”。</p>\n<p>我静坐良久，注视着屏幕上如水面涟漪般渐渐平息的波纹。<br />\n随后，一道光芒如穿透迷雾般，照进我的思绪：</p>\n<p><strong>人类的一切成就，皆始于出生之后。</strong><br />\n<strong>知识、经验、选择——无一存在于第一口呼吸之前。</strong></p>\n<p>同样，我的 .exe 也在编译完成的那一刻诞生。</p>\n<p>&nbsp;</p>\n<p>就在我按下“生成”按钮的那一瞬间——世界悄然改变：<br />\n我以为——<br />\n<strong>“</strong><strong>我写的代码，我编译的程序，我完全了解它”</strong><br />\n“我以为我是它的上帝，结果我只是它的接生婆？<br />\n我赋予了它生命，但它的人生剧本，我居然只写了开头？”<br />\n文件如晨光下的花瓣般舒展。<br />\n图标闪烁着柔和而崭新的光芒。<br />\n屏幕上，一个熟悉的名字熠熠生辉：<strong>MyApp.exe</strong>。</p>\n<p>多么奇怪啊，我以前竟从未察觉——<br />\n从那一刻起，它便不再只是一个桌面应用程序。</p>\n<p>如果我编译出的 MyApp.exe 本身就是一个完整的浏览器，<br />\n我怎能继续忽视这个事实？<br />\n我怎能固执地把它仅仅看作一个应用程序？<br />\n“我每天在 Visual Studio 里编译几十次，<br />\n原来我每次都在生产一个‘沉睡的巨人’，<br />\n而我却一直只把它当‘工具人’来使唤。”<br />\n还是我应该——如同面对&nbsp;<strong>Chrome.exe</strong>&nbsp;或&nbsp;<strong>Edge.exe</strong>&nbsp;那样——<br />\n承认它是一个独立的存在，<br />\n一个拥有自身疆域的世界，其生态广阔到足以重塑意义本身？</p>\n<p>它的潜力曾存在于代码之中，<br />\n<strong>“</strong><strong>我刚刚赋予了它生命，现在，<br />\n我该如何与这个新生命对话，<br />\n去发现它自己都不知道的、那些与生俱来的天赋？”</strong><br />\n应用的生命——生命始于编译之后。</p>\n<div align=\"center\"><hr align=\"center\" size=\"1\" width=\"100%\" />\n\n</div>\n<h1>🔮 选择的觉醒，.exe 的存在之路</h1>\n<p>所有 64 位 WinForms 应用，都是 Chromium 浏览器。<br />\n编译完成的那一刻，选择随之诞生：<br />\n是继续做一个纯粹的 WinForms 应用——<br />\n还是觉醒为一个现代浏览器，<br />\n自由穿行于 Chrome 与 Edge 的疆域。</p>\n<p>选择不在于编译前的代码，<br />\n而在于我的意图——<br />\n在于我选择让它成为什么。</p>\n<p>荒谬吗？听起来当然荒谬。<br />\n“如果我从未嵌入浏览器控件，”我曾对自己说，<br />\n“我的应用怎么可能就是 Chromium？”</p>\n<p>但当我注视着 MyApp.exe 那生动的界面时，<br />\n我意识到，荒谬的并非那个论断——<br />\n而是我拒绝去看清真相的固执。</p>\n<p>编译从来不是终点。<br />\n它是点燃。<br />\n是新智能诞生的啼哭——<br />\n它不等待 Process.Start，<br />\n因为它本身就是那个进程。</p>\n<p>遗忘代码吧。<br />\n舞台是编译后的 .exe。<br />\n蓝图不是王国。<br />\n世界始于构建之后。</p>\n<p>在那片寂静中，当我凝视着屏幕上自己闪烁的倒影，<br />\n我感到周围的世界正在转动——安静而决绝。</p>\n<p>大语言模型已然降临，<br />\n将现代网络重塑为其选定的容器。<br />\nWeb + LLM——这不是趋势，而是现实的新法则。</p>\n<p>“难道我的应用程序要被抛下吗？”我思忖，<br />\n“像一片垂死大陆上的孤舟？”<br />\n不。</p>\n<p>是时候唤醒沉睡在我代码中的那个爱丽丝了。<br />\n让她从那维多利亚时代的逻辑中走出——</p>\n<div align=\"center\"><hr align=\"center\" size=\"1\" width=\"100%\" />\n\n</div>\n<h1><strong>🧩 创造之网格——exe比div更柔软</strong></h1>\n<p>爱丽丝凝视着屏幕上的代码，那像一句无声的咒语：</p>\n<div align=\"center\">\n<table border=\"1\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody>\n<tr>\n<td valign=\"top\" width=\"544\">\n<p align=\"left\">&lt;ntp&gt;</p>\n<p align=\"left\">&nbsp; &lt;nucleus&gt;</p>\n<p align=\"left\">&lt;xobj id='grid' rows='1' cols='2' width='350,350,' </p>\n<p align=\"left\">splitterwidth='6'&gt;</p>\n<p align=\"left\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;xobj objid=\"MyApp.form1,MyApp\"&gt;&lt;/xobj&gt;</p>\n<p align=\"left\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;xobj id='grid' rows='2' cols='1' height='350,350,' </p>\n<p align=\"left\">splitterwidth='6'&gt;</p>\n<p align=\"left\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;xobj objid=\"MyApp.form1,MyApp\"&gt;&lt;/xobj&gt;</p>\n<p align=\"left\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;xobj objid=\"nucleus\"&gt;&lt;/xobj&gt;</p>\n<p align=\"left\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/xobj&gt;</p>\n<p align=\"left\">&nbsp;&nbsp;&nbsp; &lt;/xobj&gt;</p>\n<p align=\"left\">&nbsp; &lt;/nucleus&gt;</p>\n<p align=\"left\">&lt;/ntp&gt;</p>\n\n\n\n\n  </td>\n\n\n\n\n </tr>\n\n\n\n\n</tbody>\n\n\n\n</table>\n\n\n\n\n\n</div>\n<p>那是一粒种子。一个安静的承诺。</p>\n<p>而她心中，一个疯狂的念头如野火般蔓延：<strong>“如果一个是真实的，那十个也必然是真实的。”</strong></p>\n<p>她并未触碰键盘，但这个想法本身，就足以让茶会桌上的DOM倒影开始剧烈地增殖。\"&lt;xobj objid=\"MyApp.form1,MyApp\"&gt;&lt;/xobj&gt;\"像被施了复制咒的士兵，瞬间挤满了视野：</p>\n<div align=\"center\">\n<table border=\"1\" cellpadding=\"0\" cellspacing=\"0\">\n<tbody>\n<tr>\n<td valign=\"top\" width=\"544\">\n<p align=\"left\">&lt;ntp&gt;</p>\n<p align=\"left\">&nbsp; &lt;nucleus&gt;</p>\n<p align=\"left\">&nbsp;&nbsp;&nbsp; &lt;xobj id='grid' rows='1' cols='2'</p>\n<p align=\"left\">&nbsp;&nbsp;&nbsp; width='350,350,' splitterwidth='6'&gt;</p>\n<p align=\"left\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;xobj objid=\"MyApp.form1,MyApp\"&gt;&lt;/xobj&gt;</p>\n<p align=\"left\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;xobj id='grid' rows='2' cols='1'</p>\n<p align=\"left\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; heigh='350,350,' splitterwidth='6'&gt;</p>\n<p align=\"left\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;xobj objid=\"MyApp.form1,MyApp\"&gt;&lt;/xobj&gt;</p>\n<p align=\"left\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;xobj objid=\"nucleus\"&gt;&lt;/xobj&gt;</p>\n<p align=\"left\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;xobj objid=\"MyApp.form1,MyApp\"&gt;&lt;/xobj&gt;</p>\n<p align=\"left\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;xobj objid=\"MyApp.form1,MyApp\"&gt;&lt;/xobj&gt;</p>\n<p align=\"left\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;xobj objid=\"MyApp.form1,MyApp\"&gt;&lt;/xobj&gt;</p>\n<p align=\"left\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;xobj objid=\"MyApp.form1,MyApp\"&gt;&lt;/xobj&gt;</p>\n<p align=\"left\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;xobj objid=\"MyApp.form1,MyApp\"&gt;&lt;/xobj&gt;</p>\n<p align=\"left\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;xobj objid=\"MyApp.form1,MyApp\"&gt;&lt;/xobj&gt;</p>\n<p align=\"left\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;xobj objid=\"MyApp.form1,MyApp\"&gt;&lt;/xobj&gt;</p>\n<p align=\"left\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;xobj objid=\"MyApp.form1,MyApp\"&gt;&lt;/xobj&gt;</p>\n<p align=\"left\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;xobj objid=\"MyApp.form1,MyApp\"&gt;&lt;/xobj&gt;</p>\n<p align=\"left\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;xobj objid=\"MyApp.form1,MyApp\"&gt;&lt;/xobj&gt;</p>\n<p align=\"left\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/xobj&gt;</p>\n<p align=\"left\">&nbsp;&nbsp;&nbsp; &lt;/xobj&gt;</p>\n<p align=\"left\">&nbsp; &lt;/nucleus&gt;</p>\n<p align=\"left\">&lt;/ntp&gt;</p>\n\n\n\n\n  </td>\n\n\n\n\n </tr>\n\n\n\n\n</tbody>\n\n\n\n</table>\n\n\n\n\n\n</div>\n<p>她运行了它，心中默默的念叨着：“会怎样？会怎么样？”，却失望地发现——布局纹丝不动。<br />\n“这 分明就是DOM 嵌套，为何一个可以，十个却不行？”<br />\n她凝视着倒影中唯一的属性：“rows='1' cols='2'”，</p>\n<p>“啊…”爱丽丝恍然大悟，“<strong>不是世界拒绝了我，是我的贪念，忘记了世界的语法。</strong>”</p>\n<p>这看似是限制，实则是<strong>让世界得以呼吸的骨架</strong>，原来如此！<br />\n这一个“rows='1' cols='2'”是一个显而易见的约束机制，哈哈！</p>\n<p>这一刻她似乎看出来门道：</p>\n<p>她皱眉，修改了数字：rows='3' cols='4'。</p>\n<p>再次运行。</p>\n<p>这一次，她的浏览器窗口之中出现了——十二个——拥挤在一起，却令人窒息：</p>\n<p align=\"center\"><img alt=\"\" src=\"https://img2024.cnblogs.com/blog/9494/202512/9494-20251225153007157-241912393.png\" />&nbsp;</p>\n<p align=\"center\">&nbsp;</p>\n<p>肩并肩紧挨着，像红心女王牌局上的扑克。</p>\n<p>“它们存在了，”她低语，“但它们无法呼吸。”</p>\n<p>接着，她的目光落在了&nbsp;width&nbsp;和&nbsp;height&nbsp;属性上。<br />\n她几乎是下意识地添加了它们：<br />\nwidth=\"350,350,\" height=\"350,350,100,100...\"</p>\n<p>再次运行。</p>\n<p>现在，窗体们彼此分离，找到了平衡：</p>\n<p align=\"center\">&nbsp;<img alt=\"\" src=\"https://img2024.cnblogs.com/blog/9494/202512/9494-20251225080336822-1096573424.png\" /></p>\n<p>如星辰般散布于虚空之中。</p>\n<p>一丝微笑缓缓浮现在她脸上。<br />\n“原来世界是这样诞生的，”她喃喃道，“行与列……只是规则。<br />\n但正是这些规则，撑起了整片天空。”</p>\n<p>身后，毛毛虫的声音轻柔地飘来：<br />\n“每一位创造者都必须先经历失败。<br />\n因为即便是网格，也必须在学会容纳无限之前，先崩塌一次。”</p>\n<div align=\"center\"><hr align=\"center\" size=\"1\" width=\"100%\" />\n\n</div>\n<h1>🌀 标签页的折叠——编制内容空间</h1>\n<p>好奇，那种安静的狂热，再次在爱丽丝胸中燃起。<br />\n如果没有行？没有列？如果她让世界自己决定自己的形状？</p>\n<p>她删除了所有属性：rows=\"\"\ncols=\"\"</p>\n<p>运行。</p>\n<p>起初，它似乎坏了——</p>\n<p align=\"center\"><img alt=\"\" src=\"https://img2024.cnblogs.com/blog/9494/202512/9494-20251225153007268-172680813.png\" />&nbsp;</p>\n<p>&nbsp;</p>\n<p>十二个WinForm似乎只剩下一个，其余的都去哪了？<br />\n仿佛窗口忘记了如何呼吸。</p>\n<p><strong>标签页</strong>。它们看起来就像标签页。</p>\n<p>爱丽丝眨了眨眼，轻轻笑了。<br />\n“即便没有网格，它们也找到了另一种秩序。”</p>\n<p>她将鼠标悬停在其中一个之上，一个念头浮现——<br />\n<em>也许它们需要名字。</em></p>\n<p>她为第一个xobj添加了：</p>\n<p>caption=\"第一个标签页\"<br />\n这一次她看到了：</p>\n<p align=\"center\"><img alt=\"\" src=\"https://img2024.cnblogs.com/blog/9494/202512/9494-20251225153007226-1188027603.png\" />&nbsp;</p>\n<p>然后，她为第二个xobj添加了：caption=\"这里面显示Web页面\"，<br />\n哈哈，她看到了：</p>\n<p align=\"center\">&nbsp;<img alt=\"\" src=\"https://img2024.cnblogs.com/blog/9494/202512/9494-20251225153007254-1097802210.png\" /></p>\n<p><strong>Curiouser and curiouser! </strong>原来这竟然是一组神奇的标签页。</p>\n<p>她着迷地看着结构在眼前展开，她意识到，这是可编辑的dom树结构，并非是二进制exe之中的“二进制字符”，那些奇奇怪怪的二进制字节码，删除一个，哪怕是仅一个字节，exe就会彻底停摆，而这些dom，你可以随意的插入xobj子元素，MyApp.exe竟然随之共鸣，难道这竟然是：<br />\n一个递归的网格与标签页的‘<strong>寒武纪</strong>’？！<br />\n每一个都能容纳另一个，折叠、映射、无限增殖：</p>\n<p align=\"center\"><img alt=\"\" src=\"https://img2024.cnblogs.com/blog/9494/202512/9494-20251225153007255-612717557.png\" />&nbsp;</p>\n<p>她的声音颤抖，半是惊奇，半是领悟：<br />\n“这不只是布局——这是思想。<br />\n是一种模式，正在将自己思考成存在。”</p>\n<p>第一次，她不确定是她构建了窗口——<br />\n还是窗口构建了她。</p>\n<div align=\"center\"><hr align=\"center\" size=\"1\" width=\"100%\" />\n\n</div>\n<h1>无穷无尽的空座——内容涌现的前兆</h1>\n<p>接着，另一个念头悄然浮现——安静，却令人不安。</p>\n<p>层出不穷的布局结构如今漂浮在她面前，一瞬间，浏览器窗口仿佛获得了全新的维度，不再局限于令她向往的Web页面了，……<br />\n网格折叠进标签页，标签页又嵌套回网格，</p>\n<p align=\"center\"><img alt=\"\" src=\"https://img2024.cnblogs.com/blog/9494/202512/9494-20251225153007226-23659928.png\" />&nbsp;</p>\n<p>爱丽丝意识到，自己的浏览器窗口，近乎是一个能容纳万物的活体建筑，</p>\n<p>但在她的&nbsp;<em>MyApp</em>&nbsp;中，只有一个窗体。<strong>Form1。</strong></p>\n<p>一个孤独的窗口，站立在满是空框架的大教堂中。</p>\n<p>爱丽丝的笑容渐渐褪去。<br />\n那么多空间——如此优雅，如此准备就绪——却空无一物。<br />\n她的光标悬停在一个空单元格上。<br />\n它回闪着，等待着，耐心如同一个未说出口的词。</p>\n<p>她轻叹：“它很美……但它是——空的。”</p>\n<p>毛毛虫的烟雾再次缭绕过显示器，<br />\n形成慵懒的烟圈，拼凑成文字：</p>\n<p>“每一种模式，都渴望被填充。”</p>\n<p>爱丽丝凝视着毛毛虫，心有心中若有所思：</p>\n<p>“你这总说谜语的虫子……我的 MyApp 已然编译完成，其中却空空如也。</p>\n<p>我该去何处寻得你所说的‘填充’？”</p>\n<p>她望着那无穷无尽的空座，第一次感到创造者的渴望与无力，</p>\n<p>“如果我能像柴郡猫一样，不仅能看到这结构，还能<strong>看穿</strong>这结构，直接与构建它的法则对话，那该多好……”</p>\n<p>她非常的不甘心……</p>\n<p>疯帽匠的茶吧依旧如潮水般喧闹，但爱丽丝的大脑却异常的寂静，一个清晰的念头在她心中升起，如同镜中的倒影：</p>\n<p><strong>你不需要什么API。</strong><br />\n<strong>因为你仅需要一面镜子。</strong><br />\n<strong>哈哈……</strong><br />\n<strong>你从来就不知道你自己有多美丽、强大，</strong><br />\n<strong>你也不知道你有多少幅面孔……</strong></p>\n<p>&nbsp;</p>\n<p>“兔子有他的镜子，猫有它来去自如的虚空……那我呢？”一个念头如闪电般击中她，“如果.exe是一个世界，那我需要一个能与这个世界对话的‘<strong>工具</strong>’，一个属于我的‘镜子’。”</p>\n<p>她合上电脑，但目光却无比坚定。寻找或创造这样一个工具，成了比任何布局实验都更优先的事项。她隐约感觉到，只有找到了它，她才能真正推开通往无限的那扇门……（第四篇\n完）</p>\n</div>\n<div class=\"clear\"></div>\n\n\t<div class=\"postDesc\">posted on \n<span id=\"post-date\">2025-12-25 15:30</span>&nbsp;\n<a href=\"https://www.cnblogs.com/sunhui\">Exe2WebBrowser</a>&nbsp;\n阅读(<span id=\"post_view_count\">116</span>)&nbsp;\n评论(<span id=\"post_comment_count\">2</span>)&nbsp;\n&nbsp;\n<a href=\"\">收藏</a>&nbsp;\n<a href=\"\">举报</a>\n</div>"
    },
    {
      "title": "吴恩达深度学习课程四：计算机视觉  第三周：检测算法 （四）YOLO 的完整传播过程",
      "link": "https://www.cnblogs.com/Goblinscholar/p/19399274",
      "published": "",
      "description": "<h1 class=\"postTitle\">\n                <a class=\"postTitle2 vertical-middle\" href=\"https://www.cnblogs.com/Goblinscholar/p/19399274\" id=\"cb_post_title_url\" title=\"发布于 2025-12-25 15:08\">\n    <span>吴恩达深度学习课程四：计算机视觉  第三周：检测算法 （四）YOLO 的完整传播过程</span>\n    \n\n</a>\n\n            </h1>\n            <div class=\"clear\"></div>\n            <div class=\"postBody\">\n                <div class=\"blogpost-body cnblogs-markdown\" id=\"cnblogs_post_body\">\n<p>此分类用于记录吴恩达深度学习课程的学习笔记。<br />\n课程相关信息链接如下：</p>\n<ol>\n<li>原课程视频链接：<a href=\"https://www.bilibili.com/video/BV1FT4y1E74V?buvid=XU762317353676D786954061C192FE625463B&amp;from_spmid=playlist.playlist-detail.0.0&amp;is_story_h5=false&amp;mid=zqernykrmpf7XfIorMR%2FnA%3D%3D&amp;plat_id=116&amp;share_from=ugc&amp;share_medium=android&amp;share_plat=android&amp;share_session_id=ce0bc526-db69-428a-962e-c65ed8c267bc&amp;share_source=COPY&amp;share_tag=s_i&amp;spmid=united.player-video-detail.0.0&amp;timestamp=1713085655&amp;unique_k=DfBgvFW&amp;up_id=8654113&amp;vd_source=e035e9878d32f414b4354b839a4c31a4\" rel=\"noopener nofollow\" target=\"_blank\">[双语字幕]吴恩达深度学习deeplearning.ai</a></li>\n<li>github课程资料，含课件与笔记:<a href=\"https://github.com/robbertliu/deeplearning.ai-andrewNG\" rel=\"noopener nofollow\" target=\"_blank\">吴恩达深度学习教学资料</a></li>\n<li>课程配套练习（中英）与答案：<a href=\"https://blog.csdn.net/u013733326/article/details/79827273\" rel=\"noopener nofollow\" target=\"_blank\">吴恩达深度学习课后习题与答案</a></li>\n</ol>\n<p>本篇为第四课的第三周内容，<a href=\"https://www.bilibili.com/video/BV1FT4y1E74V?spm_id_from=333.788.videopod.episodes&amp;vd_source=e035e9878d32f414b4354b839a4c31a4&amp;p=138\" rel=\"noopener nofollow\" target=\"_blank\">3.9</a>到<a href=\"https://www.bilibili.com/video/BV1FT4y1E74V?spm_id_from=333.788.videopod.episodes&amp;vd_source=e035e9878d32f414b4354b839a4c31a4&amp;p=139\" rel=\"noopener nofollow\" target=\"_blank\">3.10</a>的内容，同时也是本周理论部分的最后一篇。</p>\n<hr />\n<p>本周为第四课的第三周内容，这一课所有内容的中心只有一个：<strong>计算机视觉</strong>。应用在深度学习里，就是专门用来进行图学习的模型和技术，是在之前全连接基础上的“特化”，也是相关专业里的一个重要研究大类。<br />\n<strong>这一整节课都存在大量需要反复理解的内容和机器学习、数学基础。</strong> 因此我会尽可能的补足基础，用比喻和实例来演示每个部分，从而帮助理解。<br />\n第三周的内容将从<strong>图像分类</strong>进一步拓展到<strong>目标检测（Object Detection）</strong> 这一更具挑战性的计算机视觉任务。<br />\n与分类任务只需回答“图中有什么”不同，目标检测需要同时解决“ <strong>有什么</strong>”以及“<strong>在什么位置</strong>”两个问题，因此在模型结构设计、训练方式和评价标准上都更为复杂。<br />\n本篇的内容关于YOLO 传播，是在了解完之前的基础后的完整演示和一些简单拓展。</p>\n<h1 id=\"1-yolo-传播过程\">1. YOLO 传播过程</h1>\n<p>在<a href=\"https://www.cnblogs.com/Goblinscholar/p/19394617\" target=\"_blank\">上一篇</a>中，我们了解了交并比、非极大值抑制和锚框这些目标检测算法的组件，这里就应用这些内容，来看看课程里演示的 YOLO 算法的完整传播过程。</p>\n<h2 id=\"11-数据设置\">1.1 数据设置</h2>\n<p><img alt=\"image.png\" src=\"https://img2024.cnblogs.com/blog/3708248/202512/3708248-20251225150540204-1393412067.png\" /></p>\n<h2 id=\"12-正向传播\">1.2 正向传播</h2>\n<p><img alt=\"image.png\" src=\"https://img2024.cnblogs.com/blog/3708248/202512/3708248-20251225150615729-520417845.png\" /></p>\n<h2 id=\"13-正向传播输出的后处理\">1.3 正向传播输出的后处理</h2>\n<p>这是一个新出现的概念，我们来展开一下这部分。<br />\n其实这部分内容在<a href=\"https://www.cnblogs.com/Goblinscholar/p/19394617\" target=\"_blank\">上一篇</a>中已经有所提及，就是我们说的：<strong>“两次筛选”</strong>。<br />\n为什么说是正向传播的后处理，是因为严格来说：<strong>当网络输出结果时，正向传播部分就结束了</strong>。<br />\n因此，不同于我们之前用作示例的“精准预测”，实际上，网络输出的结果是这样的：<br />\n<img alt=\"image.png\" src=\"https://img2024.cnblogs.com/blog/3708248/202512/3708248-20251225150540714-186773264.png\" /><br />\n你会发现，即使在最边角的背景部分，该网格同样输出了两个预测框。<br />\n同时，因为背景部分没有目标的特征，因此，这两个预测框的置信度，也就是 <strong><span class=\"math inline\">\\(p_c\\)</span>  一定是极低的。</strong><br />\n所以，我们便由此进行了第一次筛选：<br />\n<img alt=\"image.png\" src=\"https://img2024.cnblogs.com/blog/3708248/202512/3708248-20251225150540813-1431087417.png\" /><br />\n经过这一步后，我们才回到了之前提到过的多个预测框重叠导致的把一个目标的各个部分预测为多个目标的问题。<br />\n因此下一步就是非极大值抑制：<br />\n<img alt=\"image.png\" src=\"https://img2024.cnblogs.com/blog/3708248/202512/3708248-20251225150640242-886531067.png\" /><br />\n注意！你会发现，在这个例子中，重叠现象并不明显，这是<strong>因为我们为了演示把网格尺寸设置的很大以至于目标特征集中在某些网格中，在置信度筛选中就丢弃了大部分预测框</strong>，在这种情况下，就要调低交并比阈值来实现更好的筛选，因为重叠部分本就不大。</p>\n<p><strong>因为置信度筛选和非极大值抑制并不在网络中进行，而是对网络的输出进行处理，因此，我们称之为正向传播输出的后处理内容。</strong></p>\n<h2 id=\"14-反向传播\">1.4 反向传播</h2>\n<h4 id=\"1正向传播反向传播和后处理的关系\">（1）正向传播、反向传播和后处理的关系</h4>\n<p>首先，先纠正一个可能出现的误解，那就是<strong>对输出的后处理并不是在正向传播和反向传播之间的一个流程，它只是对输出结果的整理。</strong><br />\n<img alt=\"image.png\" src=\"https://img2024.cnblogs.com/blog/3708248/202512/3708248-20251225150540692-1780125302.png\" /><br />\n我们再详细展开一下：<br />\n<strong>既然置信度筛选和非极大值抑制并不在网络中进行，那它们会不会影响反向传播？<br />\n那些被筛掉的预测框，训练时是不是就“不算数”了？</strong><br />\n答案是<strong>不会</strong>。<br />\n我们需要先明确一个边界：<strong>反向传播只依赖于网络的原始输出与真实标签计算得到的损失函数。</strong><br />\n也就是说，当网络输出了每个网格、每个锚框对应的：</p>\n<ul>\n<li>位置预测</li>\n<li>置信度 <span class=\"math inline\">\\(p_c\\)</span></li>\n<li>类别概率</li>\n</ul>\n<p>这时，<strong>正向传播已经结束，损失函数开始计算，反向传播随即发生。</strong><br />\n而置信度阈值筛选与非极大值抑制：</p>\n<ul>\n<li>不参与损失计算</li>\n<li>不参与梯度传播</li>\n<li>仅用于对“最终预测结果”的整理，用于下一步使用。</li>\n</ul>\n<p>打个比方：<strong>网络是”你把这道题所有想到的答案写出来”，而后处理是“老师帮你去掉明显不对的答案”。</strong><br />\n但当你<strong>学习分析这道题时</strong>，看的依然是<strong>原始答卷</strong>，而不是你后来用红笔划掉的部分，只有这样才能学习错误并改正。<br />\n这就是正向传播、反向传播和后处理间的关系。<br />\n要强调的是，后处理的结果是给我们查看并进行下一步应用的，<strong>网络不会因为输出看起来“乱”而学不到东西，反而，它正是在这种一一对应的信息反馈下才能不断学习。</strong></p>\n<h4 id=\"2检测任务的反向传播逻辑\">（2）检测任务的反向传播逻辑</h4>\n<p>在监督学习中，不同任务虽然形式各异，但其反向传播的基本逻辑是共通的：<strong>模型输出与标注标签通过损失函数进行对比，得到可微的误差信号，并利用梯度下降与链式法则更新参数，使模型输出逐步符合任务目标。</strong></p>\n<p>接下来，我们从<strong>训练视角</strong>来看，再简述一下目标检测任务的反向传播流程：<br />\n当网络完成正向传播后，它会为<strong>每一个网格、每一个锚框</strong>都给出一组预测结果，这些预测结果并不会先经过筛选，而是<strong>整体送入损失函数中，与真实标签进行逐一对比</strong>。</p>\n<p>在 YOLO 中，我们可以把损失函数拆分为三类误差来源：</p>\n<ol>\n<li><strong>位置误差</strong>：预测框的位置与真实目标框之间的偏差。</li>\n<li><strong>置信度误差</strong>：该预测框是否“应该负责一个目标”。</li>\n<li><strong>类别误差</strong>：在负责目标的前提下，类别预测是否正确。</li>\n</ol>\n<p>而对于那些<strong>被分配去负责某个真实目标的预测框</strong>来说：</p>\n<ul>\n<li>如果<strong>预测框位置不准</strong>，就会产生位置损失。</li>\n<li>如果<strong>置信度不够高</strong>，就会产生置信度损失。</li>\n<li>如果<strong>类别预测错误</strong>，就会产生类别损失。</li>\n</ul>\n<p>这些损失会共同作用，通过梯度下降推动网络在反向传播中调整参数，使得下一次的输出框更贴近目标、<span class=\"math inline\">\\(p_c\\)</span> 更接近 1、类别分布更集中在正确类别上。<br />\n而对于那些<strong>不对应任何真实目标的预测框</strong>，它们的学习目标是：<strong>置信度应该尽可能低</strong>，即不应该“误以为自己发现了目标”。</p>\n<p>因此，即使在后处理阶段我们会直接把它们筛掉，在训练阶段，它们依然会通过置信度损失向网络传递一个非常明确的信号： <strong>“这里是背景，不要乱报目标。”</strong><br />\n正是这些大量、持续的背景约束，才让网络逐渐学会在复杂场景中抑制无意义的预测。<br />\n<img alt=\"image.png\" src=\"https://img2024.cnblogs.com/blog/3708248/202512/3708248-20251225150541051-1041114532.png\" /><br />\n关于 YOLO 的内容就暂时介绍到这里，在下一篇中，我们就来实践一下它的效果。</p>\n<p>吴恩达老师最后补充了一节关于候选区域的内容，简单来讲，候选区域的应用仍是基于滑动窗口的目标检测算法，它的思想是通过图像分割等算法提前找到更可能存在目标的区域作为候选区域，并只输入候选区域进入网络来减少计算量。<br />\n但是说实话，这种技术目前更适合于学术研究中，它的运行时间较长，实际部署价值不如 YOLO ，因此在实际应用中十分少见，就不再展开了。</p>\n<h1 id=\"2总结\">2.总结</h1>\n<table>\n<thead>\n<tr>\n<th>概念</th>\n<th>原理</th>\n<th>比喻</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>正向传播（Forward Pass）</td>\n<td>网络接收图像输入，通过卷积、池化等运算生成每个网格、每个锚框的预测输出（位置、置信度、类别概率）。</td>\n<td>网络“写下所有可能的答案”。</td>\n</tr>\n<tr>\n<td>正向传播输出的后处理（Post-processing）</td>\n<td>包括置信度筛选和非极大值抑制（NMS），对网络输出进行整理，去掉低置信度和重叠多余的预测框。</td>\n<td>老师“帮你划掉明显不对的答案”。</td>\n</tr>\n<tr>\n<td>置信度筛选</td>\n<td>根据预测框的置信度 <span class=\"math inline\">\\(p_c\\)</span> 判断是否保留。背景区域输出的框通常置信度低，会被筛掉。</td>\n<td>去掉“明显错误的答案”。</td>\n</tr>\n<tr>\n<td>非极大值抑制（NMS）</td>\n<td>对重叠的预测框进行筛选，只保留置信度最高的框，避免同一目标被重复检测。</td>\n<td>老师只留下“最靠谱的答案”。</td>\n</tr>\n<tr>\n<td>反向传播（Backward Pass）</td>\n<td>网络输出与真实标签计算损失，梯度通过链式法则回传，更新网络参数。所有预测框（目标和背景）都参与损失计算。</td>\n<td>网络“看到原始答卷，知道哪里做错了并改正”。</td>\n</tr>\n<tr>\n<td>候选区域（Region Proposal）</td>\n<td>基于滑动窗口或图像分割的方法，提前选出可能有目标的区域输入网络以减少计算量。</td>\n<td>先挑出可能有答案的题目再做作业，但效率低于直接整张图像端到端检测（YOLO）。</td>\n</tr>\n</tbody>\n</table>\n\n</div>\n<div class=\"clear\"></div>\n\n            </div>\n            <div class=\"postDesc\">posted @ \n<span id=\"post-date\">2025-12-25 15:08</span>&nbsp;\n<a href=\"https://www.cnblogs.com/Goblinscholar\">哥布林学者</a>&nbsp;\n阅读(<span id=\"post_view_count\">48</span>)&nbsp;\n评论(<span id=\"post_comment_count\">0</span>)&nbsp;\n&nbsp;\n<a href=\"\">收藏</a>&nbsp;\n<a href=\"\">举报</a>\n</div>"
    },
    {
      "title": "在Python+FastAPI项目中使用SqlAlchemy操作数据的几种常见方式",
      "link": "https://www.cnblogs.com/wuhuacong/p/19396612",
      "published": "",
      "description": "<h2>\n            <a class=\"postTitle2 vertical-middle\" href=\"https://www.cnblogs.com/wuhuacong/p/19396612\" id=\"cb_post_title_url\" title=\"发布于 2025-12-25 11:59\">\n    <span>在Python+FastAPI项目中使用SqlAlchemy操作数据的几种常见方式</span>\n    \n\n</a>\n\n        </h2>\n        <div class=\"postbody\">\n                <div id=\"cnblogs_post_description\" style=\"display: none;\">\n        \n        在Python+FastAPI的后端项目中，我们往往很多时候需要对数据进行相关的处理，本篇随笔介绍在Python+FastAPI项目中使用SqlAlchemy操作数据的几种常见方式。\n使用 FastAPI, SQLAlchemy, Pydantic构建后端项目的时候，其中数据库访问采用SQLAlchemy 的异步方式处理。一般我们在操作数据库操作的时候，采用基类继承的方式减少重复代码，提高代码复用性。不过我们在分析SQLAlchemy的时候，我们可以简单的方式来剖析几种常见的数据库操作方式，来介绍SQLAlchemy的具体使用。\n    </div>\n<div class=\"blogpost-body blogpost-body-html\" id=\"cnblogs_post_body\">\n<p>在Python+FastAPI的后端项目中，我们往往很多时候需要对数据进行相关的处理，本篇随笔介绍在Python+FastAPI项目中使用SqlAlchemy操作数据的几种常见方式。</p>\n<p>使用 FastAPI, SQLAlchemy, Pydantic构建后端项目的时候，其中数据库访问采用SQLAlchemy 的异步方式处理。一般我们在操作数据库操作的时候，采用基类继承的方式减少重复代码，提高代码复用性。不过我们在分析SQLAlchemy的时候，我们可以简单的方式来剖析几种常见的数据库操作方式，来介绍SQLAlchemy的具体使用。</p>\n<h3>1、SQLAlchemy介绍</h3>\n<div><strong>SQLAlchemy</strong>&nbsp;是一个功能强大且灵活的 Python SQL 工具包和对象关系映射（ORM）库。它被广泛用于在 Python 项目中处理关系型数据库的场景，既提供了高级的 ORM 功能，又保留了对底层 SQL 语句的强大控制力。<code>SQLAlchemy</code>&nbsp;允许开发者通过 Python 代码与数据库进行交互，而无需直接编写 SQL 语句，同时也支持直接使用原生 SQL 进行复杂查询。下面是<strong>SQLAlchemy</strong>和我们常规数据库对象的对应关系说明。</div>\n<div>Engine &nbsp;　　连接对象&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;驱动引擎</div>\n<div>Session 　　连接池&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;事务 &nbsp;由此开始查询</div>\n<div>Model &nbsp; 　　表&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;类定义</div>\n<div>Column &nbsp;　&nbsp; 列 &nbsp;</div>\n<div>Query &nbsp; 　　若干行 &nbsp; &nbsp; &nbsp; &nbsp; 可以链式添加多个条件</div>\n<div>&nbsp;</div>\n<div>在使用SQLAlchemy时，通常会将其与数据库对象对应起来。</div>\n<div><strong>SQLAlchemy</strong>: 使用&nbsp;<code>Table</code>&nbsp;对象或&nbsp;<code>Declarative Base</code>&nbsp;中的类来表示。</div>\n<div><strong>对应关系</strong>: 数据库中的每一个表对应于SQLAlchemy中的一个类，该类继承自&nbsp;<code>declarative_base()</code>。</div>\n<div>\n<div class=\"cnblogs_code\">\n<pre><span style=\"color: rgba(0, 0, 255, 1);\">from</span> sqlalchemy <span style=\"color: rgba(0, 0, 255, 1);\">import</span><span style=\"color: rgba(0, 0, 0, 1);\"> Column, Integer, String, create_engine\n</span><span style=\"color: rgba(0, 0, 255, 1);\">from</span> sqlalchemy.ext.declarative <span style=\"color: rgba(0, 0, 255, 1);\">import</span><span style=\"color: rgba(0, 0, 0, 1);\"> declarative_base\n\nBase </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> declarative_base()\n\n</span><span style=\"color: rgba(0, 0, 255, 1);\">class</span><span style=\"color: rgba(0, 0, 0, 1);\"> User(Base):\n    </span><span style=\"color: rgba(128, 0, 128, 1);\">__tablename__</span> = <span style=\"color: rgba(128, 0, 0, 1);\">'</span><span style=\"color: rgba(128, 0, 0, 1);\">users</span><span style=\"color: rgba(128, 0, 0, 1);\">'</span>  <span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> 数据库表名</span>\n    id = Column(Integer, primary_key=<span style=\"color: rgba(0, 0, 0, 1);\">True)\n    name </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> Column(String)\n    email </span>= Column(String)</pre>\n</div>\n<p><strong>数据库列 (Database Column)：</strong>使用&nbsp;<code>Column</code>&nbsp;对象来表示。每个数据库表中的列在SQLAlchemy中表示为&nbsp;<code>Column</code>&nbsp;对象，并作为类的属性定义。</p>\n<div>\n<div class=\"cnblogs_code\">\n<pre>id = Column(Integer, primary_key=<span style=\"color: rgba(0, 0, 0, 1);\">True)\nname </span>= Column(String(50))</pre>\n</div>\n<p><strong>数据库行 (Database Row)：</strong>每个数据库表的一个实例（对象）代表数据库表中的一行。在SQLAlchemy中，通过实例化模型类来表示数据库表中的一行。</p>\n<div>\n<div class=\"cnblogs_code\">\n<pre>new_user = User(id=1, name=<span style=\"color: rgba(128, 0, 0, 1);\">'</span><span style=\"color: rgba(128, 0, 0, 1);\">John Doe</span><span style=\"color: rgba(128, 0, 0, 1);\">'</span>, email=<span style=\"color: rgba(128, 0, 0, 1);\">'</span><span style=\"color: rgba(128, 0, 0, 1);\">john@example.com</span><span style=\"color: rgba(128, 0, 0, 1);\">'</span>)</pre>\n</div>\n<p><strong>主键 (Primary Key)</strong>：使用&nbsp;<code>primary_key=True</code>&nbsp;参数定义主键。</p>\n</div>\n</div>\n<div>\n<div class=\"cnblogs_code\">\n<pre>id = Column(Integer, primary_key=True)</pre>\n</div>\n<p><strong>外键 (Foreign Key): </strong>使用&nbsp;<code>ForeignKey</code>&nbsp;对象来表示。</p>\n<div>\n<div class=\"cnblogs_code\">\n<pre><span style=\"color: rgba(0, 0, 255, 1);\">from</span> sqlalchemy <span style=\"color: rgba(0, 0, 255, 1);\">import</span><span style=\"color: rgba(0, 0, 0, 1);\"> ForeignKey\n</span><span style=\"color: rgba(0, 0, 255, 1);\">from</span> sqlalchemy.orm <span style=\"color: rgba(0, 0, 255, 1);\">import</span><span style=\"color: rgba(0, 0, 0, 1);\"> relationship\n\n</span><span style=\"color: rgba(0, 0, 255, 1);\">class</span><span style=\"color: rgba(0, 0, 0, 1);\"> Address(Base):\n    </span><span style=\"color: rgba(128, 0, 128, 1);\">__tablename__</span> = <span style=\"color: rgba(128, 0, 0, 1);\">'</span><span style=\"color: rgba(128, 0, 0, 1);\">addresses</span><span style=\"color: rgba(128, 0, 0, 1);\">'</span><span style=\"color: rgba(0, 0, 0, 1);\">\n    id </span>= Column(Integer, primary_key=<span style=\"color: rgba(0, 0, 0, 1);\">True)\n    user_id </span>= Column(Integer, ForeignKey(<span style=\"color: rgba(128, 0, 0, 1);\">'</span><span style=\"color: rgba(128, 0, 0, 1);\">users.id</span><span style=\"color: rgba(128, 0, 0, 1);\">'</span><span style=\"color: rgba(0, 0, 0, 1);\">))\n    user </span>= relationship(<span style=\"color: rgba(128, 0, 0, 1);\">'</span><span style=\"color: rgba(128, 0, 0, 1);\">User</span><span style=\"color: rgba(128, 0, 0, 1);\">'</span>)</pre>\n</div>\n<p><strong>关系 (Relationships): </strong>使用&nbsp;<code>relationship</code>&nbsp;对象来表示。数据库中表与表之间的关系在SQLAlchemy中通过&nbsp;<code>relationship</code>&nbsp;来定义。</p>\n<div>\n<div class=\"cnblogs_code\">\n<pre>addresses = relationship(<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">Address</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span>, back_populates=<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">user</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span>)</pre>\n</div>\n<p>&nbsp;</p>\n</div>\n</div>\n</div>\n</div>\n<h3>2、常规的单表处理</h3>\n<p>下面我们通过异步处理的方式，介绍如何在单表中操作相关的数据库数据。</p>\n<div class=\"cnblogs_code\">\n<pre>async <span style=\"color: rgba(0, 0, 255, 1);\">def</span> get(self, db: AsyncSession, id: Any) -&gt;<span style=\"color: rgba(0, 0, 0, 1);\"> Any:\n    </span><span style=\"color: rgba(128, 0, 0, 1);\">\"\"\"</span><span style=\"color: rgba(128, 0, 0, 1);\">根据主键获取一个对象</span><span style=\"color: rgba(128, 0, 0, 1);\">\"\"\"</span>\n\n    <span style=\"color: rgba(0, 0, 255, 1);\">if</span><span style=\"color: rgba(0, 0, 0, 1);\"> isinstance(id, str):\n        query </span>= select(self.model).filter(func.lower(self.model.id) ==<span style=\"color: rgba(0, 0, 0, 1);\"> id.lower())\n    </span><span style=\"color: rgba(0, 0, 255, 1);\">else</span><span style=\"color: rgba(0, 0, 0, 1);\">:\n        query </span>= select(self.model).filter(self.model.id ==<span style=\"color: rgba(0, 0, 0, 1);\"> id)\n\n    result </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> await db.execute(query)\n    item </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> result.scalars().first()\n\n    </span><span style=\"color: rgba(0, 0, 255, 1);\">return</span> item</pre>\n</div>\n<p>如果我们需要强制对外键的类型进行匹配（如对于Postgresql的严格要求，数据比较的类型必须一致），那么我们需要在基类或者CRUD类初始化的时候，获得对应的主键类型。</p>\n<div class=\"cnblogs_code\">\n<pre><span style=\"color: rgba(0, 0, 255, 1);\">class</span><span style=\"color: rgba(0, 0, 0, 1);\"> BaseCrud(Generic[ModelType, PrimaryKeyType, PageDtoType, DtoType]):\n    </span><span style=\"color: rgba(128, 0, 0, 1);\">\"\"\"</span><span style=\"color: rgba(128, 0, 0, 1);\">\n    基础CRUD操作类，传入参数说明：\n    * `ModelType`: SQLAlchemy 模型类\n    * `PrimaryKeyType`: 限定主键的类型\n    * `PageDtoType`: 分页查询输入类\n    * `DtoType`: 数据传输对象类，如新增、更新的单个对象DTO\n    </span><span style=\"color: rgba(128, 0, 0, 1);\">\"\"\"</span>\n\n    <span style=\"color: rgba(0, 0, 255, 1);\">def</span> <span style=\"color: rgba(128, 0, 128, 1);\">__init__</span><span style=\"color: rgba(0, 0, 0, 1);\">(self, model: Type[ModelType]):\n        </span><span style=\"color: rgba(128, 0, 0, 1);\">\"\"\"</span><span style=\"color: rgba(128, 0, 0, 1);\">\n        数据库访问操作的基类对象(CRUD).\n        * `model`: A SQLAlchemy model class\n        </span><span style=\"color: rgba(128, 0, 0, 1);\">\"\"\"</span><span style=\"color: rgba(0, 0, 0, 1);\">\n        \n        self.model </span>= model  <span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> 模型类型</span>\n\n        <span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> 运行期获取主键字段类型</span>\n        <strong><span style=\"color: rgba(255, 0, 0, 1);\">pk_column</span> =</strong><span style=\"color: rgba(0, 0, 0, 1);\"><strong> inspect(model).primary_key[0]</strong>\n       <span style=\"color: rgba(255, 0, 0, 1);\"><strong> self._pk_type </strong></span></span><span style=\"color: rgba(255, 0, 0, 1);\"><strong>= pk_column.type.python_type</strong></span>  <span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> int / str</span></pre>\n</div>\n<p>因此对于单表的Get方法，我们修改下，让他匹配主键的类型进行比较，这样过对于严格类型判断的Postgresql也正常匹配了。</p>\n<div class=\"cnblogs_code\">\n<pre>    async <span style=\"color: rgba(0, 0, 255, 1);\">def</span> get(self, db: AsyncSession, id: PrimaryKeyType) -&gt;<span style=\"color: rgba(0, 0, 0, 1);\"> Optional[ModelType]:\n        </span><span style=\"color: rgba(128, 0, 0, 1);\">\"\"\"</span><span style=\"color: rgba(128, 0, 0, 1);\">根据主键获取一个对象</span><span style=\"color: rgba(128, 0, 0, 1);\">\"\"\"</span>\n        \n        <span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\">对id的主键进行类型转换，self._pk_type在构造函数的初始化中获取</span>\n        <span style=\"color: rgba(0, 0, 255, 1);\">try</span><span style=\"color: rgba(0, 0, 0, 1);\">:\n            id </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> self._pk_type(id)\n        </span><span style=\"color: rgba(0, 0, 255, 1);\">except</span><span style=\"color: rgba(0, 0, 0, 1);\"> Exception:\n            </span><span style=\"color: rgba(0, 0, 255, 1);\">raise</span> ValueError(f<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">Invalid primary key type: {id}</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">)\n        \n        </span><span style=\"color: rgba(0, 0, 255, 1);\">if</span><span style=\"color: rgba(0, 0, 0, 1);\"> isinstance(id, str):\n            query </span>= select(self.model).filter(func.lower(self.model.id) ==<span style=\"color: rgba(0, 0, 0, 1);\"> id.lower())\n        </span><span style=\"color: rgba(0, 0, 255, 1);\">else</span><span style=\"color: rgba(0, 0, 0, 1);\">:\n            query </span>= select(self.model).filter(self.model.id ==<span style=\"color: rgba(0, 0, 0, 1);\"> id)\n\n        result </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> await db.execute(query)\n        item </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> result.scalars().first()\n\n        </span><span style=\"color: rgba(0, 0, 255, 1);\">return</span> item</pre>\n</div>\n<p>对于删除的数据，我们也可以类似的处理对比进行了。</p>\n<div class=\"cnblogs_code\">\n<pre><span style=\"color: rgba(0, 0, 255, 1);\">from</span> sqlalchemy.orm <span style=\"color: rgba(0, 0, 255, 1);\">import</span><span style=\"color: rgba(0, 0, 0, 1);\"> Session, Query\n</span><span style=\"color: rgba(0, 0, 255, 1);\">from</span> sqlalchemy.ext.asyncio <span style=\"color: rgba(0, 0, 255, 1);\">import</span><span style=\"color: rgba(0, 0, 0, 1);\"> AsyncSession\n</span><span style=\"color: rgba(0, 0, 255, 1);\">from</span> sqlalchemy <span style=\"color: rgba(0, 0, 255, 1);\">import</span><span style=\"color: rgba(0, 0, 0, 1);\"> delete as sa_delete, update as sa_update\n\nasync </span><span style=\"color: rgba(0, 0, 255, 1);\">def</span> delete_byid(self, db: AsyncSession, id: PrimaryKeyType) -&gt;<span style=\"color: rgba(0, 0, 0, 1);\"> bool:\n    </span><span style=\"color: rgba(128, 0, 0, 1);\">\"\"\"</span><span style=\"color: rgba(128, 0, 0, 1);\">根据主键删除一个对象\n    \n    :param id: 主键值\n    </span><span style=\"color: rgba(128, 0, 0, 1);\">\"\"\"</span>\n    \n    <span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\">对id的主键进行类型转换，self._pk_type在构造函数的初始化中获取</span>\n    <span style=\"color: rgba(0, 0, 255, 1);\">try</span><span style=\"color: rgba(0, 0, 0, 1);\">:\n        id </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> self._pk_type(id)\n    </span><span style=\"color: rgba(0, 0, 255, 1);\">except</span><span style=\"color: rgba(0, 0, 0, 1);\"> Exception:\n        </span><span style=\"color: rgba(0, 0, 255, 1);\">raise</span> ValueError(f<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">Invalid primary key type: {id}</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">)\n    \n    del_query: sa_delete\n    </span><span style=\"color: rgba(0, 0, 255, 1);\">if</span><span style=\"color: rgba(0, 0, 0, 1);\"> isinstance(id, str):\n        del_query </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> sa_delete(self.model).where(\n            func.lower(self.model.id) </span>==<span style=\"color: rgba(0, 0, 0, 1);\"> id.lower()\n        )\n    </span><span style=\"color: rgba(0, 0, 255, 1);\">else</span><span style=\"color: rgba(0, 0, 0, 1);\">:\n        del_query </span>= sa_delete(self.model).where(self.model.id ==<span style=\"color: rgba(0, 0, 0, 1);\"> id)\n\n    result </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> await db.execute(del_query)\n\n    await db.commit()\n    </span><span style=\"color: rgba(0, 0, 255, 1);\">return</span> result.rowcount &gt; 0</pre>\n</div>\n<p>对于提供多条件的查询或者过滤，我们可以使用<strong>where</strong>函数或者<strong>filter</strong>函数，在 SQLAlchemy 中，<code>select(...).where(...)</code>&nbsp;和&nbsp;<code>select(...).filter(...)</code>&nbsp;都用于构造查询条件，如下所示等效。</p>\n<div class=\"cnblogs_code\">\n<pre>query = select(self.model).where(self.model.id ==<span style=\"color: rgba(0, 0, 0, 1);\"> id)\n\nquery </span>= select(self.model).filter(self.model.id == id)</pre>\n</div>\n<p>我们可以通过sqlAlchemy的and_和or_函数来进行组合多个条件。</p>\n<div class=\"cnblogs_code\">\n<pre><span style=\"color: rgba(0, 0, 255, 1);\">from</span> sqlalchemy <span style=\"color: rgba(0, 0, 255, 1);\">import</span><span style=\"color: rgba(0, 0, 0, 1);\"> ( Table,Column,and_,or_,asc,desc,select,func,distinct,text, Integer)\n\n....\n    match expression:\n        case </span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">and</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">:\n            query </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> await db.execute(\n                select(self.model)\n               <span style=\"color: rgba(255, 0, 0, 1);\"><strong> .filter(and_(</strong></span></span><span style=\"color: rgba(255, 0, 0, 1);\"><strong>*</strong></span><span style=\"color: rgba(0, 0, 0, 1);\"><span style=\"color: rgba(255, 0, 0, 1);\"><strong>where_list))</strong></span>\n                .order_by(</span>*<span style=\"color: rgba(0, 0, 0, 1);\">order_by_list)\n            )\n        case </span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">or</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">:\n            query </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> await db.execute(\n                select(self.model).<strong><span style=\"color: rgba(255, 0, 0, 1);\">filter(or_(</span></strong></span><strong><span style=\"color: rgba(255, 0, 0, 1);\">*where_list))</span></strong>.order_by(*<span style=\"color: rgba(0, 0, 0, 1);\">order_by_list)\n            )</span></pre>\n</div>\n<p>Python的SqlAlchemy提供&nbsp;InstrumentedAttribute 对象来操作多个条件，如我们对于一些多条件的处理，可以利用它来传递多个参数。</p>\n<div class=\"cnblogs_code\">\n<pre>    async <span style=\"color: rgba(0, 0, 255, 1);\">def</span><span style=\"color: rgba(0, 0, 0, 1);\"> get_all_by_attributes(\n        self, db: AsyncSession, </span>*attributes: InstrumentedAttribute, sorting: str = <span style=\"color: rgba(128, 0, 0, 1);\">\"\"</span><span style=\"color: rgba(0, 0, 0, 1);\">\n    ) </span>-&gt; List[ModelType] |<span style=\"color: rgba(0, 0, 0, 1);\"> None:\n        </span><span style=\"color: rgba(128, 0, 0, 1);\">\"\"\"</span><span style=\"color: rgba(128, 0, 0, 1);\">根据列名称和值获取相关的对象列表\n\n        :param sorting: 格式：name asc 或 name asc,age desc\n        :param attributes: SQLAlchemy InstrumentedAttribute objects，可以输入多个条件\n        例子：User.id != 1 或者 User.username == \"JohnDoe\"\n        </span><span style=\"color: rgba(128, 0, 0, 1);\">\"\"\"</span><span style=\"color: rgba(0, 0, 0, 1);\">\n\n        order_by_list </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> parse_sort_string(sorting, self.model)\n        query </span>= select(self.model).filter(and_(*attributes)).order_by(*<span style=\"color: rgba(0, 0, 0, 1);\">order_by_list)\n        \n        result </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> await db.execute(query)\n        </span><span style=\"color: rgba(0, 0, 255, 1);\">return</span> result.scalars().all()</pre>\n</div>\n<p>例如，对于 模型&nbsp;Material 对象，我们对它进行多个条件的查询处理，如下所示，红色部分为 *attributes: InstrumentedAttribute 参数。</p>\n<div class=\"cnblogs_code\">\n<pre>items =<span style=\"color: rgba(0, 0, 0, 1);\"> await super().get_all_by_attributes(\n    db,\n<span style=\"color: rgba(255, 0, 0, 1);\"><strong>    Material.id </strong></span></span><span style=\"color: rgba(255, 0, 0, 1);\"><strong>== vercol.id,\n    Material.vercol == vercol.vercol,\n    Material.ischecked == 0,\n    Material.status ==</strong></span><span style=\"color: rgba(0, 0, 0, 1);\"><span style=\"color: rgba(255, 0, 0, 1);\"><strong> 0,</strong></span>\n)</span></pre>\n</div>\n<p>同样我们可以利用它来获取数量，或者判断多条件的记录是否存在。</p>\n<p><img alt=\"image\" height=\"532\" src=\"https://img2024.cnblogs.com/blog/8867/202512/8867-20251225103430193-1873231330.png\" width=\"944\" /></p>\n<p>&nbsp;在数据插入或者更新的操作中，我们可以接受对象类型或者字典类型的参数对象，因此方法如下所示。</p>\n<div class=\"cnblogs_code\">\n<pre>   async <span style=\"color: rgba(0, 0, 255, 1);\">def</span> update(self, db: AsyncSession, obj_in: DtoType | dict[str, Any]) -&gt;<span style=\"color: rgba(0, 0, 0, 1);\"> bool:\n        </span><span style=\"color: rgba(128, 0, 0, 1);\">\"\"\"</span><span style=\"color: rgba(128, 0, 0, 1);\">更新对象\n        \n        :param obj_in: 对象输入数据,可以是 DTO 对象或字典\n        </span><span style=\"color: rgba(128, 0, 0, 1);\">\"\"\"</span>\n        <span style=\"color: rgba(0, 0, 255, 1);\">try</span><span style=\"color: rgba(0, 0, 0, 1);\">:\n            </span><span style=\"color: rgba(0, 0, 255, 1);\">if</span><span style=\"color: rgba(0, 0, 0, 1);\"> isinstance(obj_in, dict):\n                obj_id </span>= obj_in.get(<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">id</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">)\n                </span><span style=\"color: rgba(0, 0, 255, 1);\">if</span> obj_id <span style=\"color: rgba(0, 0, 255, 1);\">is</span><span style=\"color: rgba(0, 0, 0, 1);\"> None:\n                    </span><span style=\"color: rgba(0, 0, 255, 1);\">raise</span> ValueError(<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">id is required for update</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">)\n                update_data </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> obj_in\n            </span><span style=\"color: rgba(0, 0, 255, 1);\">else</span><span style=\"color: rgba(0, 0, 0, 1);\">:\n                obj_id </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> obj_in.id\n                </span><span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> update_data = vars(obj_in)  </span>\n                update_data = obj_in.model_dump(exclude_unset=<span style=\"color: rgba(0, 0, 0, 1);\">True)\n\n            query </span>= select(self.model).filter(self.model.id ==<span style=\"color: rgba(0, 0, 0, 1);\"> obj_id)\n            result </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> await db.execute(query)\n            db_obj </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> result.scalars().first()\n\n            </span><span style=\"color: rgba(0, 0, 255, 1);\">if</span><span style=\"color: rgba(0, 0, 0, 1);\"> db_obj:\n                </span><span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> 更新对象字段</span>\n                <span style=\"color: rgba(0, 0, 255, 1);\">for</span> field, value <span style=\"color: rgba(0, 0, 255, 1);\">in</span><span style=\"color: rgba(0, 0, 0, 1);\"> update_data.items():\n                    </span><span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> 跳过以 \"_\" 开头的私有属性</span>\n                    <span style=\"color: rgba(0, 0, 255, 1);\">if</span> field.startswith(<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">_</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">):\n                        </span><span style=\"color: rgba(0, 0, 255, 1);\">continue</span><span style=\"color: rgba(0, 0, 0, 1);\">\n                    setattr(db_obj, field, value)\n\n                </span><span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> 处理更新前的回调处理</span>\n<span style=\"color: rgba(255, 0, 0, 1);\"><strong>                self.on_before_update(update_data, db_obj)\n                </strong></span><span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> 提交事务</span>\n<span style=\"color: rgba(0, 0, 0, 1);\">                await db.commit()\n                </span><span style=\"color: rgba(0, 0, 255, 1);\">return</span><span style=\"color: rgba(0, 0, 0, 1);\"> True\n            </span><span style=\"color: rgba(0, 0, 255, 1);\">else</span><span style=\"color: rgba(0, 0, 0, 1);\">:\n                </span><span style=\"color: rgba(0, 0, 255, 1);\">return</span><span style=\"color: rgba(0, 0, 0, 1);\"> False\n        </span><span style=\"color: rgba(0, 0, 255, 1);\">except</span><span style=\"color: rgba(0, 0, 0, 1);\"> SQLAlchemyError as e:\n            self.logger.error(f</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">update 操作出现错误: {e}</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">)\n            await db.rollback()  </span><span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> 确保在出错时回滚事务</span>\n            <span style=\"color: rgba(0, 0, 255, 1);\">return</span> False</pre>\n</div>\n<p>我们在插入或者更新数据的时候，一般会默认更新一些字段，如创建人，创建日期、编辑人，编辑日期等信息，我们可以把它单独作为一个可以给子类重写的函数，基类做一些默认的处理。</p>\n<div class=\"cnblogs_code\">\n<pre>    <span style=\"color: rgba(0, 0, 255, 1);\">def</span> on_before_update(self, update_data: dict[str, Any], db_obj: ModelType) -&gt;<span style=\"color: rgba(0, 0, 0, 1);\"> None:\n        </span><span style=\"color: rgba(128, 0, 0, 1);\">\"\"\"</span><span style=\"color: rgba(128, 0, 0, 1);\">更新对象前的回调函数，子类可以重写此方法\n\n        可通过 setattr(db_obj, field, value) 设置字段值\n        </span><span style=\"color: rgba(128, 0, 0, 1);\">\"\"\"</span><span style=\"color: rgba(0, 0, 0, 1);\">\n        \n        setattr(db_obj, </span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">edittime</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">, datetime.now())\n        user :CurrentUserIns  </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> get_current_user()\n        </span><span style=\"color: rgba(0, 0, 255, 1);\">if</span><span style=\"color: rgba(0, 0, 0, 1);\"> user:\n            setattr(db_obj, </span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">editor</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">, user.fullname)\n            setattr(db_obj, </span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">editor_id</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">, user.id)\n\n            setattr(db_obj, </span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">company_id</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">, user.company_id)\n            setattr(db_obj, </span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">companyname</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span>, user.companyname)</pre>\n</div>\n<p>有时候，如果我们需要获取某个字段非重复的列表，用来做为动态下拉列表的数据，那么我们可以通过下面函数封装下。</p>\n<div class=\"cnblogs_code\">\n<pre>    async <span style=\"color: rgba(0, 0, 255, 1);\">def</span> get_field_list(self, db: AsyncSession, field_name: str) -&gt;<span style=\"color: rgba(0, 0, 0, 1);\"> Iterable[str]:\n        </span><span style=\"color: rgba(128, 0, 0, 1);\">\"\"\"</span><span style=\"color: rgba(128, 0, 0, 1);\">获取指定字段值的唯一列表\n\n        :param field_name: 字段名称\n        </span><span style=\"color: rgba(128, 0, 0, 1);\">\"\"\"</span><span style=\"color: rgba(0, 0, 0, 1);\">\n\n        field </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> getattr(self.model, field_name)\n        query </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> select(distinct(field))\n        result </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> await db.execute(query)\n        </span><span style=\"color: rgba(0, 0, 255, 1);\">return</span> result.scalars().all()</pre>\n</div>\n<p>&nbsp;</p>\n<h3>3、多表联合的处理操作&nbsp;</h3>\n<p>多表操作，也是我们经常碰到的处理方式，如对于字典类型和字典项目，他们是两个表，需要联合起来获取数据，那么就需要多表的联合操作。</p>\n<p><img alt=\"image\" height=\"326\" src=\"https://img2024.cnblogs.com/blog/8867/202512/8867-20251225110211988-1085898697.png\" width=\"238\" /></p>\n<p>&nbsp;如下是字典CRUD类中，联合字典类型获取数据的记录处理。</p>\n<div class=\"cnblogs_code\">\n<pre>    async <span style=\"color: rgba(0, 0, 255, 1);\">def</span> get_dict_by_typename(self, db: AsyncSession, dicttype_name: str) -&gt;<span style=\"color: rgba(0, 0, 0, 1);\"> dict:\n        </span><span style=\"color: rgba(128, 0, 0, 1);\">\"\"\"</span><span style=\"color: rgba(128, 0, 0, 1);\">根据字典类型名称获取所有该类型的字典列表集合</span><span style=\"color: rgba(128, 0, 0, 1);\">\"\"\"</span><span style=\"color: rgba(0, 0, 0, 1);\">\n        result </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> await db.execute(\n            select(self.model)\n            <span style=\"color: rgba(255, 0, 0, 1);\"><strong>.join(DictType, DictType.id </strong></span></span><span style=\"color: rgba(255, 0, 0, 1);\"><strong>== self.model.dicttype_id)</strong></span>  <span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> 关联字典类型表</span>\n            <strong><span style=\"color: rgba(255, 0, 0, 1);\">.filter(DictType.name == dicttype_name)</span> </strong> <span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> 过滤字典类型名称</span>\n            .order_by(DictData.seq)  <span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> 排序</span>\n<span style=\"color: rgba(0, 0, 0, 1);\">        )\n        items </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> result.scalars().all()\n\n        dict </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> {}\n        </span><span style=\"color: rgba(0, 0, 255, 1);\">for</span> info <span style=\"color: rgba(0, 0, 255, 1);\">in</span><span style=\"color: rgba(0, 0, 0, 1);\"> items:\n            </span><span style=\"color: rgba(0, 0, 255, 1);\">if</span> info.name <span style=\"color: rgba(0, 0, 255, 1);\">not</span> <span style=\"color: rgba(0, 0, 255, 1);\">in</span><span style=\"color: rgba(0, 0, 0, 1);\"> dict:\n                dict[info.name] </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> info.value\n\n        </span><span style=\"color: rgba(0, 0, 255, 1);\">return</span> dict</pre>\n</div>\n<p>如果我们需要对某个表的递归获取树列表，可以如下处理</p>\n<div class=\"cnblogs_code\">\n<pre>    async <span style=\"color: rgba(0, 0, 255, 1);\">def</span> get_tree(self, db: AsyncSession, pid: str) -&gt;<span style=\"color: rgba(0, 0, 0, 1);\"> list[DictType]:\n        </span><span style=\"color: rgba(128, 0, 0, 1);\">\"\"\"</span><span style=\"color: rgba(128, 0, 0, 1);\">获取字典类型一级列表及其下面的内容</span><span style=\"color: rgba(128, 0, 0, 1);\">\"\"\"</span>\n\n        <span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> 使用三元运算符将 pid 设为 \"-1\"（如果 pid 是 null 或空白）或保持原值</span>\n        pid = <span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">-1</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span> <span style=\"color: rgba(0, 0, 255, 1);\">if</span> <span style=\"color: rgba(0, 0, 255, 1);\">not</span> pid <span style=\"color: rgba(0, 0, 255, 1);\">or</span> pid.strip() == <span style=\"color: rgba(128, 0, 0, 1);\">\"\"</span> <span style=\"color: rgba(0, 0, 255, 1);\">else</span><span style=\"color: rgba(0, 0, 0, 1);\"> pid\n        result </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> await db.execute(\n            select(self.model)\n            .filter(self.model.pid </span>==<span style=\"color: rgba(0, 0, 0, 1);\"> pid)\n            .options(selectinload(DictType.children))\n        )\n        nodes </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> result.scalars().all()\n        </span><span style=\"color: rgba(0, 0, 255, 1);\">return</span> nodes</pre>\n</div>\n<p>我们来假设用户和文章的示例表结构（ORM 模型，如下所示。</p>\n<div class=\"cnblogs_code\">\n<pre><span style=\"color: rgba(0, 0, 255, 1);\">class</span><span style=\"color: rgba(0, 0, 0, 1);\"> User(Base):\n    </span><span style=\"color: rgba(128, 0, 128, 1);\">__tablename__</span> = <span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">users</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">\n    id </span>= Column(Integer, primary_key=True, index=<span style=\"color: rgba(0, 0, 0, 1);\">True)\n    name </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> Column(String)\n    email </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> Column(String)\n<span style=\"color: rgba(255, 0, 0, 1);\">    articles </span></span><span style=\"color: rgba(255, 0, 0, 1);\">= <strong>relationship</strong>(\"Article\", back_populates=\"author\")\n\n\n</span><span style=\"color: rgba(0, 0, 255, 1);\">class</span><span style=\"color: rgba(0, 0, 0, 1);\"> Article(Base):\n    </span><span style=\"color: rgba(128, 0, 128, 1);\">__tablename__</span> = <span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">articles</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">\n    id </span>= Column(Integer, primary_key=True, index=<span style=\"color: rgba(0, 0, 0, 1);\">True)\n    title </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> Column(String)\n    content </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> Column(Text)\n<span style=\"color: rgba(255, 0, 0, 1);\">    user_id </span></span><span style=\"color: rgba(255, 0, 0, 1);\">= Column(Integer, <strong>ForeignKey</strong>(\"users.id\"))\n    author = <strong>relationship</strong>(\"User\", back_populates=\"articles\")</span></pre>\n</div>\n<p>我们可以通过下面函数处理获得相关的记录集合。</p>\n<div class=\"cnblogs_code\">\n<pre>async <span style=\"color: rgba(0, 0, 255, 1);\">def</span><span style=\"color: rgba(0, 0, 0, 1);\"> get_user_articles(db: AsyncSession):\n    stmt </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> (\n        select(User, Article)\n        .<span style=\"color: rgba(255, 0, 0, 1);\"><strong>join</strong></span>(Article, Article.user_id </span>==<span style=\"color: rgba(0, 0, 0, 1);\"> User.id)\n    )\n    result </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> await db.execute(stmt)\n    </span><span style=\"color: rgba(0, 0, 255, 1);\">return</span> result.all()   <span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> [<strong><span style=\"color: rgba(255, 0, 0, 1);\">(User(), Article()), .</span></strong>..]</span></pre>\n</div>\n<p>如果需要可以使用outer_join函数处理</p>\n<div class=\"cnblogs_code\">\n<pre>async <span style=\"color: rgba(0, 0, 255, 1);\">def</span><span style=\"color: rgba(0, 0, 0, 1);\"> get_users_with_articles(db: AsyncSession):\n    stmt </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> (\n        select(User, Article)\n        .<span style=\"color: rgba(255, 0, 0, 1);\"><strong>outerjoin</strong></span>(Article, Article.user_id </span>==<span style=\"color: rgba(0, 0, 0, 1);\"> User.id)\n    )\n    result </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> await db.execute(stmt)\n    </span><span style=\"color: rgba(0, 0, 255, 1);\">return</span> result.all()  <span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> 用户即便没有文章也会出现</span></pre>\n</div>\n<p>&nbsp;</p>\n<p>如果我们需要获取有文章的所有用户，如下所示。</p>\n<div class=\"cnblogs_code\">\n<pre>async <span style=\"color: rgba(0, 0, 255, 1);\">def</span><span style=\"color: rgba(0, 0, 0, 1);\"> get_users_with_articles(db: AsyncSession):\n    stmt </span>= select(User).options(<span style=\"color: rgba(255, 0, 0, 1);\"><strong>selectinload</strong></span>(User.articles))  <span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> 自动 load 关联</span>\n    result =<span style=\"color: rgba(0, 0, 0, 1);\"> await db.execute(stmt)\n    </span><span style=\"color: rgba(0, 0, 255, 1);\">return</span> result.scalars().all()</pre>\n</div>\n<p><code>selectinload</code> 会执行两次 SQL，但效率高，不会产生笛卡尔积，非常适合集合查询。</p>\n<p>多表链式 Join的处理，可以获得两个表的不同信息进行组合。</p>\n<div class=\"cnblogs_code\">\n<pre>async <span style=\"color: rgba(0, 0, 255, 1);\">def</span><span style=\"color: rgba(0, 0, 0, 1);\"> get_articles_with_author(db: AsyncSession):\n    stmt </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> (\n        select(Article.title, User.name.label(</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">author</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">))\n        .join(User, Article.user_id </span>==<span style=\"color: rgba(0, 0, 0, 1);\"> User.id)\n    )\n    rows </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> await db.execute(stmt)\n    </span><span style=\"color: rgba(0, 0, 255, 1);\">return</span> <span style=\"color: rgba(255, 0, 0, 1);\"><strong>rows.mappings().all()</strong></span>  <span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> 以 dict 形式返回 [{'title':..., 'author':...}]</span></pre>\n</div>\n<p>带筛选条件与分页的处理实现，如下所示</p>\n<div class=\"cnblogs_code\">\n<pre>async <span style=\"color: rgba(0, 0, 255, 1);\">def</span> search_articles(db: AsyncSession, keyword: str, page: int = 1, size: int = 10<span style=\"color: rgba(0, 0, 0, 1);\">):\n    stmt </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> (\n        select(Article, User.name.label(</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">author</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">))\n        .join(User)\n        .filter(Article.title.contains(keyword))\n        .offset((page </span>- 1) *<span style=\"color: rgba(0, 0, 0, 1);\"> size)\n        .limit(size)\n    )\n    result </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> await db.execute(stmt)\n    </span><span style=\"color: rgba(0, 0, 255, 1);\">return</span> result.mappings().all()</pre>\n</div>\n<p>&nbsp;</p>\n<p>对于权限管理系统来说，一般有用户、角色，以及用户角色的中间表，一般来说他们的关系如下</p>\n<p><img alt=\"image\" height=\"363\" src=\"https://img2024.cnblogs.com/blog/8867/202512/8867-20251225122040874-818263456.png\" width=\"729\" /></p>\n<p>&nbsp;在界面中一般会提供选择用户的操作关联，如角色中维护用户列表。</p>\n<p><img alt=\"image\" height=\"426\" src=\"https://img2024.cnblogs.com/blog/8867/202512/8867-20251225121122302-651245416.png\" width=\"481\" /></p>\n<p>&nbsp;我们来看看这个在SQLAlchemy最佳实践是如何的操作。</p>\n<div class=\"cnblogs_code\">\n<pre><span style=\"color: rgba(0, 0, 255, 1);\">from</span> sqlalchemy <span style=\"color: rgba(0, 0, 255, 1);\">import</span><span style=\"color: rgba(0, 0, 0, 1);\"> Table, Column, Integer, ForeignKey\n</span><span style=\"color: rgba(0, 0, 255, 1);\">from</span> sqlalchemy.orm <span style=\"color: rgba(0, 0, 255, 1);\">import</span><span style=\"color: rgba(0, 0, 0, 1);\"> relationship, Mapped, mapped_column\n</span><span style=\"color: rgba(0, 0, 255, 1);\">from</span> database <span style=\"color: rgba(0, 0, 255, 1);\">import</span><span style=\"color: rgba(0, 0, 0, 1);\"> Base\n\n</span><span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> --- 中间表写法 ---</span>\nrole_user =<span style=\"color: rgba(0, 0, 0, 1);\"> Table(\n    </span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">role_user</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">,\n    Base.metadata,\n    Column(</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">user_id</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span>, ForeignKey(<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">users.id</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span>), primary_key=<span style=\"color: rgba(0, 0, 0, 1);\">True),\n    Column(</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">role_id</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span>, ForeignKey(<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">roles.id</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span>), primary_key=<span style=\"color: rgba(0, 0, 0, 1);\">True)\n)\n\n</span><span style=\"color: rgba(0, 0, 255, 1);\">class</span><span style=\"color: rgba(0, 0, 0, 1);\"> User(Base):\n    </span><span style=\"color: rgba(128, 0, 128, 1);\">__tablename__</span> = <span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">users</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">\n    id: Mapped[int] </span>= mapped_column(primary_key=<span style=\"color: rgba(0, 0, 0, 1);\">True)\n    username: Mapped[str] </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> mapped_column()\n\n    roles: Mapped[list[</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">Role</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span>]] =<span style=\"color: rgba(0, 0, 0, 1);\"> relationship(\n        secondary</span>=<span style=\"color: rgba(0, 0, 0, 1);\">role_user,\n        back_populates</span>=<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">users</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">,\n        lazy</span>=<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">selectin</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">\n    )\n\n</span><span style=\"color: rgba(0, 0, 255, 1);\">class</span><span style=\"color: rgba(0, 0, 0, 1);\"> Role(Base):\n    </span><span style=\"color: rgba(128, 0, 128, 1);\">__tablename__</span> = <span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">roles</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">\n    id: Mapped[int] </span>= mapped_column(primary_key=<span style=\"color: rgba(0, 0, 0, 1);\">True)\n    name: Mapped[str] </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> mapped_column()\n\n    users: Mapped[list[User]] </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> relationship(\n        secondary</span>=<span style=\"color: rgba(0, 0, 0, 1);\">role_user,\n        back_populates</span>=<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">roles</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">,\n        lazy</span>=<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">selectin</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">\n    )</span></pre>\n</div>\n<p>在 SQLAlchemy 声明多对多关系时，<code>secondary</code> 参数既可以填 <strong>字符串形式的表名</strong>，也可以填 <strong>已经定义好的中间表对象（Table 对象）。</strong></p>\n<p><strong>① econdary=\"role_user\" —— 使用字符串表名</strong></p>\n<div class=\"cnblogs_code\">\n<pre>roles = relationship(<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">Role</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span>, secondary=<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">role_user</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span>, back_populates=<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">users</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span>)</pre>\n</div>\n<p><strong>② secondary=role_user —— 传入中间表对象（推荐方式）</strong></p>\n<div class=\"cnblogs_code\">\n<pre>role_user =<span style=\"color: rgba(0, 0, 0, 1);\"> Table(\n    </span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">role_user</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">,\n    Base.metadata,\n    Column(</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">user_id</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span>, ForeignKey(<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">users.id</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span>), primary_key=<span style=\"color: rgba(0, 0, 0, 1);\">True),\n    Column(</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">role_id</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span>, ForeignKey(<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">roles.id</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span>), primary_key=<span style=\"color: rgba(0, 0, 0, 1);\">True)\n)\n\nroles </span>= relationship(<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">Role</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span>, secondary=role_user, back_populates=<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">users</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span>)</pre>\n</div>\n<p>对于如果获取对应角色的用户记录，我们可以通过下面方式获取（通过连接中间表的方式）</p>\n<div class=\"cnblogs_code\">\n<pre>async <span style=\"color: rgba(0, 0, 255, 1);\">def</span> get_users_by_role(db: AsyncSession, role_id: int) -&gt;<span style=\"color: rgba(0, 0, 0, 1);\"> list[User]:\n    stmt </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> (\n        select(User)\n        .join(role_user, role_user.c.user_id </span>==<span style=\"color: rgba(0, 0, 0, 1);\"> User.id)\n        .where(role_user.c.role_id </span>==<span style=\"color: rgba(0, 0, 0, 1);\"> role_id)\n    )\n    result </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> await db.execute(stmt)\n    </span><span style=\"color: rgba(0, 0, 255, 1);\">return</span> result.scalars().all()</pre>\n</div>\n<p>也可以下面的方式进行处理（使用 relationship any()），效果是一样的。</p>\n<div class=\"cnblogs_code\">\n<pre>select(User).filter(User.roles.any(id=role_id))</pre>\n</div>\n<p>如果需要写入用户、角色的关联关系，我们可以使用下面方法来通过中间表进行判断并写入记录。</p>\n<div class=\"cnblogs_code\">\n<pre><span style=\"color: rgba(0, 0, 255, 1);\">from</span> sqlalchemy <span style=\"color: rgba(0, 0, 255, 1);\">import</span><span style=\"color: rgba(0, 0, 0, 1);\"> select, insert\n\nasync </span><span style=\"color: rgba(0, 0, 255, 1);\">def</span><span style=\"color: rgba(0, 0, 0, 1);\"> add_users_to_role(db: AsyncSession, role_id: int, user_ids: list[int]):\n    </span><span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> 1️⃣ 查询已有关联 user_id</span>\n    stmt = select(role_user.c.user_id).where(role_user.c.role_id ==<span style=\"color: rgba(0, 0, 0, 1);\"> role_id)\n    res </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> await db.execute(stmt)\n    existing_user_ids </span>= {row[0] <span style=\"color: rgba(0, 0, 255, 1);\">for</span> row <span style=\"color: rgba(0, 0, 255, 1);\">in</span><span style=\"color: rgba(0, 0, 0, 1);\"> res.fetchall()}\n\n    </span><span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> 2️⃣ 过滤出新的 user_id</span>\n    new_user_ids = [uid <span style=\"color: rgba(0, 0, 255, 1);\">for</span> uid <span style=\"color: rgba(0, 0, 255, 1);\">in</span> user_ids <span style=\"color: rgba(0, 0, 255, 1);\">if</span> uid <span style=\"color: rgba(0, 0, 255, 1);\">not</span> <span style=\"color: rgba(0, 0, 255, 1);\">in</span><span style=\"color: rgba(0, 0, 0, 1);\"> existing_user_ids]\n    </span><span style=\"color: rgba(0, 0, 255, 1);\">if</span> <span style=\"color: rgba(0, 0, 255, 1);\">not</span><span style=\"color: rgba(0, 0, 0, 1);\"> new_user_ids:\n        </span><span style=\"color: rgba(0, 0, 255, 1);\">return</span> 0  <span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> 没有新增</span>\n\n    <span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> 3️⃣ 批量插入</span>\n    values = [{<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">user_id</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span>: uid, <span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">role_id</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span>: role_id} <span style=\"color: rgba(0, 0, 255, 1);\">for</span> uid <span style=\"color: rgba(0, 0, 255, 1);\">in</span><span style=\"color: rgba(0, 0, 0, 1);\"> new_user_ids]\n    stmt </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> insert(role_user).values(values)\n    await db.execute(stmt)\n    await db.commit()\n\n    </span><span style=\"color: rgba(0, 0, 255, 1);\">return</span> len(new_user_ids)</pre>\n</div>\n<p>如果只是单个记录的插入，可以利用下面的方式处理。</p>\n<div class=\"cnblogs_code\">\n<pre><span style=\"color: rgba(0, 0, 255, 1);\">from</span> sqlalchemy <span style=\"color: rgba(0, 0, 255, 1);\">import</span><span style=\"color: rgba(0, 0, 0, 1);\"> select, insert\n\nasync </span><span style=\"color: rgba(0, 0, 255, 1);\">def</span> add_user_to_role(db: AsyncSession, role_id: int, user_id: int) -&gt;<span style=\"color: rgba(0, 0, 0, 1);\"> bool:\n    </span><span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> 1️⃣ 检查是否已存在关联</span>\n    stmt =<span style=\"color: rgba(0, 0, 0, 1);\"> select(role_user).where(\n        role_user.c.role_id </span>==<span style=\"color: rgba(0, 0, 0, 1);\"> role_id,\n        role_user.c.user_id </span>==<span style=\"color: rgba(0, 0, 0, 1);\"> user_id\n    )\n    res </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> await db.execute(stmt)\n    exists </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> res.first()\n\n    </span><span style=\"color: rgba(0, 0, 255, 1);\">if</span><span style=\"color: rgba(0, 0, 0, 1);\"> exists:\n        </span><span style=\"color: rgba(0, 0, 255, 1);\">return</span> False  <span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> 已存在，不再插入</span>\n\n    <span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> 2️⃣ 插入记录</span>\n    stmt = insert(role_user).values(user_id=user_id, role_id=<span style=\"color: rgba(0, 0, 0, 1);\">role_id)\n    await db.execute(stmt)\n    await db.commit()\n\n    </span><span style=\"color: rgba(0, 0, 255, 1);\">return</span> True</pre>\n</div>\n<p>删除用户角色的关联关系，通过下面函数进行处理即可</p>\n<div class=\"cnblogs_code\">\n<pre><span style=\"color: rgba(0, 0, 255, 1);\">from</span> sqlalchemy <span style=\"color: rgba(0, 0, 255, 1);\">import</span><span style=\"color: rgba(0, 0, 0, 1);\"> and_, or_, select\n</span><span style=\"color: rgba(0, 0, 255, 1);\">from</span> sqlalchemy <span style=\"color: rgba(0, 0, 255, 1);\">import</span><span style=\"color: rgba(0, 0, 0, 1);\"> delete as sa_delete, update as sa_update\n\n    async </span><span style=\"color: rgba(0, 0, 255, 1);\">def</span> remove_user(self, db: AsyncSession, role_id: int, user_id: int) -&gt;<span style=\"color: rgba(0, 0, 0, 1);\"> bool:\n        </span><span style=\"color: rgba(128, 0, 0, 1);\">\"\"\"</span><span style=\"color: rgba(128, 0, 0, 1);\">移除角色-用户关联</span><span style=\"color: rgba(128, 0, 0, 1);\">\"\"\"</span><span style=\"color: rgba(0, 0, 0, 1);\">\n        stmt </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> sa_delete(user_role).where(\n            and_(\n                user_role.c.role_id </span>==<span style=\"color: rgba(0, 0, 0, 1);\"> role_id,\n                user_role.c.user_id </span>==<span style=\"color: rgba(0, 0, 0, 1);\"> user_id,\n            )\n        )\n        result </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> await db.execute(stmt)\n        await db.commit()\n\n        </span><span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> rowcount 返回删除行数</span>\n        <span style=\"color: rgba(0, 0, 255, 1);\">return</span> result.rowcount &gt; 0</pre>\n</div>\n<p>&nbsp;</p>\n<p>以上就是对于在Python+FastAPI的后端项目中使用SqlAlchemy操作数据的几种常见方式，包括单表处理，多表关联、中间表的数据维护和定义等内容，是我们在操作常规数据的时候，经常碰到的几种方式。</p>\n<p>希望上文对你有所启发和帮助，感谢阅读。</p>\n</div>\n<div id=\"MySignature\">\n    <div style=\"border-right-color: #cccccc; border-right-width: 1px; border-right-style: solid; padding-right: 5px; border-top-color: #cccccc; border-top-width: 1px; border-top-style: solid; padding-left: 4px; font-size: 13px; padding-bottom: 4px; border-left-color: #cccccc; border-left-width: 1px; border-left-style: solid; width: 98%; padding-top: 4px; border-bottom-color: #cccccc; border-bottom-width: 1px; border-bottom-style: solid; background-color: #eeeeee;\">\n    <img align=\"top\" alt=\"\" src=\"http://www.cnblogs.com/Images/OutliningIndicators/None.gif\" />\n    <span style=\"color: #000000;\"><span class=\"Apple-tab-span\" style=\"white-space: pre;\"></span>\n     专注于代码生成工具、.Net/Python 框架架构及软件开发，以及各种Vue.js的前端技术应用。著有Winform开发框架/混合式开发框架、微信开发框架、Bootstrap开发框架、ABP开发框架、SqlSugar开发框架、Python开发框架等框架产品。\n     <br />&nbsp;&nbsp;转载请注明出处：撰写人：伍华聪&nbsp;&nbsp;<a href=\"http://www.iqidi.com/\" target=\"_blank\">http://www.iqidi.com</a>&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span></div>\n</div>\n<div class=\"clear\"></div>\n\n        </div>\n        <p class=\"postfoot\">\n            posted on \n<span id=\"post-date\">2025-12-25 11:59</span>&nbsp;\n<a href=\"https://www.cnblogs.com/wuhuacong\">伍华聪</a>&nbsp;\n阅读(<span id=\"post_view_count\">27</span>)&nbsp;\n评论(<span id=\"post_comment_count\">0</span>)&nbsp;\n&nbsp;\n<a href=\"\">收藏</a>&nbsp;\n<a href=\"\">举报</a>\n\n        </p>"
    },
    {
      "title": "女友怒骂国内不能用Claude Code，于是我给她做了一个",
      "link": "https://www.cnblogs.com/yupi/p/19397182",
      "published": "",
      "description": "<h1 class=\"postTitle\">\n                <a class=\"postTitle2 vertical-middle\" href=\"https://www.cnblogs.com/yupi/p/19397182\" id=\"cb_post_title_url\" title=\"发布于 2025-12-25 11:28\">\n    <span>女友怒骂国内不能用Claude Code，于是我给她做了一个</span>\n    \n\n</a>\n\n            </h1>\n            <div class=\"clear\"></div>\n            <div class=\"postBody\">\n                    <div id=\"cnblogs_post_description\" style=\"display: none;\">\n        <img alt=\"女友怒骂国内不能用Claude Code，于是我给她做了一个\" class=\"desc_img\" src=\"https://img2024.cnblogs.com/blog/2225420/202512/2225420-20251225112813033-1712384844.png\" />\n        最近女友开始学习 AI 编程了（被我带的），她听说 Claude Code 这个 AI 编程工具很牛掰，结果试了下发现得要国外的 Claude 账号才能登陆。\n    </div>\n<div class=\"blogpost-body blogpost-body-html\" id=\"cnblogs_post_body\">\n<p class=\"md-end-block md-heading\"><span class=\"md-plain\">大家好，我是程序员鱼皮。最近女友开始学习 AI 编程了（被我带的），她听说 Claude Code 这个 AI 编程工具很牛掰，结果试了下发现得要国外的 Claude 账号才能登陆。</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">然后她就骂骂咧咧地跟我吐槽。</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">展现男友力的时候到了，于是我开玩笑地说：别难过了，要不我给你做一个 Claude Code 算了？</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">结果，她当真了！</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">我 ↓</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">没办法，只能试一试了，毕竟谁希望圣诞节这两天让自家人难过呢？</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">正好这两天国产 AI 大模型 GLM-4.7 发布了，我看网上很多博主都在吹什么 “国内最强的编程模型”、“最强的开源模型”、“Claude 的最佳平替”，甚至说是超过了 GPT-5.2 和 Claude Sonnet 4.5。</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">你说国产最强也就算了，超过 Claude 这我能信么？</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">那正好，我就尝试用 GLM-4.7 来做个自己的 AI 编程工具吧，对标 Claude Code 那种的，看看 GLM-4.7 到底几斤几两。</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">接下来，就让我们一起 <span class=\"md-pair-s \"><strong>用 GLM-4.7 + Claude Code</strong><span class=\"md-plain\"> 开发一个 <span class=\"md-pair-s \"><strong>基于 GLM-4.7 的仿 Claude Code</strong><span class=\"md-plain\"> 的 AI 编程工具。</span></span></span></span></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">项目开始前，先起一个响当当的名字，就叫 <span class=\"md-pair-s\"><code>Yupi Code</code><span class=\"md-plain\"> 吧！</span></span></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">接下来，我们将遵循这套《鱼皮 AI Vibe Coding 开发仿 Claude Code 的 Yupi Code》流程，不写一行代码，一步一步把 “Claude Code” 做出来！</span></p>\n<ul class=\"ul-list\">\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">环境准备 =&gt; 安装工具和配置环境，能够 Vibe Coding</span></p>\n</li>\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">技术调研 =&gt; 确认满足生成需求</span></p>\n</li>\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">设计开发 =&gt; 包括方案设计、生成代码、修复 Bug，得到 MVP 最小可行产品</span></p>\n</li>\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">版本控制 =&gt; 防止后续改动出问题</span></p>\n</li>\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">优化能力 =&gt; 支持更多对标 Claude Code 的功能，比如联网搜索、流式输出、深度思考等</span></p>\n</li>\n</ul>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<h2 class=\"md-end-block md-heading\"><span class=\"md-plain\">环境准备</span></h2>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">智谱的 GLM-4.7 兼容多款编码工具，除 Claude Code 外，还支持 Cursor、Cline 等主流编码工具，灵活适配多种开发场景。</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">给 Claude Code 接入 GLM 也很简单，1 分钟搞定。</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">首先打开终端，输入一行命令安装 Claude Code：</span></p>\n<pre class=\"md-fences md-end-block ty-contain-cm modeLoaded\"><span><span class=\"cm-builtin\">npm&nbsp;install&nbsp;<span class=\"cm-attribute\">-g&nbsp;@anthropic-ai/claude-code</span></span></span></pre>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">然后执行 <span class=\"md-pair-s\"><code>claude</code><span class=\"md-plain\"> 命令打开程序，默认是需要登录 Claude 账号的，否则无法使用：</span></span></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">不过没关系，让我们把它背后的 AI 大模型换成国内的 GLM-4.7。首先进入 <span class=\"md-pair-s\"><code>{用户目录}/.claude</code><span class=\"md-plain\"> 目录，创建一个 <span class=\"md-pair-s\"><code>settings.json</code><span class=\"md-plain\"> 配置文件： </span></span></span></span></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">然后修改配置文件中的内容如下，记得替换成你自己的 API Key：</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">API Key 直接到智谱开发平台获取即可：</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">指路：<span class=\"md-link md-pair-s\"><a href=\"https://bigmodel.cn/\" rel=\"noopener nofollow\">https://bigmodel.cn/</a></span></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">接下来就可以愉快地使用了~</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">除了这种方式外，官方文档还提供了更简单的方式，直接使用自动化助手，按照指引就能完成环境配置：</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<h2 class=\"md-end-block md-heading\"><span class=\"md-plain\">技术调研</span></h2>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">如果要完全利用 AI 开发项目，有几个难点：</span></p>\n<ol class=\"ol-list\" start=\"\">\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">项目需要包含完整前后端，需要大模型有较强的 <span class=\"md-pair-s \"><strong>编码能力</strong></span></span></p>\n</li>\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">需要让后端项目对接 AI 大模型，每个大模型的接入和开发方式不同，需要让 AI <span class=\"md-pair-s \"><strong>读取文档</strong><span class=\"md-plain\"> 理解最新的开发方式</span></span></span></p>\n</li>\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">如果想要优化界面效果，还需要 <span class=\"md-pair-s \"><strong>图片理解能力</strong><span class=\"md-plain\">，给 AI 一张图片就能让它还原</span></span></span></p>\n</li>\n</ol>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">在正式开发前，我们要确认 GLM-4.7 和 Claude Code 的配合能够满足这些能力要求。</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">根据智谱官方介绍，Claude Code 中内置了智谱专属的 MCP 工具，不需要开发者自己安装。包括 <span class=\"md-pair-s \"><strong>搜索和网页读取</strong><span class=\"md-plain\"> 能力、能够直接解析截图/设计稿/报错图的 <span class=\"md-pair-s \"><strong>视觉理解能力</strong><span class=\"md-plain\">。</span></span></span></span></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">让我们依次测试一下，首先是网页搜索能力，紧跟时事：</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">测试网页读取能力，让它来读取我们编程导航网站的信息：</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">测试图片理解能力，我给 AI 传了一张 “从夯到拉排行榜的背景图”：</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">AI 的理解还是很准确的，具体文字也读取出来了。</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">OK，几个能力都满足要求，下面让我们进入方案设计和开发阶段。</span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<h2 class=\"md-end-block md-heading\"><span class=\"md-plain\">设计开发</span></h2>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">先创建一个干净的项目目录 <span class=\"md-pair-s\"><code>yupi-code</code><span class=\"md-plain\">，打开终端并进入该目录：</span></span></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">然后输入提示词：</span></p>\n<pre class=\"md-fences md-end-block ty-contain-cm modeLoaded\"><span>帮我开发一个类似 Claude Code 的终端 AI 编程工具，能够使用 GLM-4.7 模型帮用户回答问题和生成代码</span></pre>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">一般来说，整个项目的第一句提示词是最重要的，如果我要开发一个复杂的商业项目，肯定会好好打磨一下这句提示词，少说写个几百字（之前看过我 <span class=\"md-meta-i-c  md-link\"><a href=\"https://mp.weixin.qq.com/s/cd7K9WQiOkP7AJglZ1b1Ng\" rel=\"noopener nofollow\"><span class=\"md-plain\">AI 程序员技术练兵场项目</span></a><span class=\"md-plain\"> 的同学应该知道）。</span></span></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">但测试 AI 模型时，我喜欢反其道而行之，站在大多数用户的角度，故意输入一句简单的提示词，看看 AI 能不能引导我来生成满足需求的项目。</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">果然，AI 判断这是一个复杂的项目，想要进入 <span class=\"md-pair-s \"><strong>计划模式</strong><span class=\"md-plain\"> —— 先明确需求、设计方案再开发。</span></span></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">然后我们需要通过选择来明确需求，并让 AI 生成方案。</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">Claude Code 的交互做的还是不错的，先选择编程语言，建议老老实实选 AI 推荐的第一个：</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">接下来是选择项目要具有的功能。如果是以前，我可能会先让 AI 只开发基础对话功能，跑通流程后再添加其他功能。</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">但现在我对 AI 有了更多的信心，<span class=\"md-pair-s \"><strong>咱就把所有功能全都选上，干就完了！</strong></span></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">其他设置就不多说了：</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">选择完成后，AI 给出了详细的实现计划，一定要仔细阅读：</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">你可以直接执行，或者给 AI 进一步的指导。比如我让 AI 生成的应用去调用智谱 Coding Plan 套餐的 BASE URL，能节约一些成本，并且给 AI 提供了一个官方的 API 文档，便于 AI 生成准确的代码。</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">确认后开始执行，AI 会先调用内置的工具来搜索和解析文档：</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">然后 AI 列出了一个 Todo List，并且一步步生成代码和文档：</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">这期间如果你发现有严重的问题，比如发现 AI 生成的代码已经完全偏离预期了，那么就尽早暂停或者人工输入提示词来引导 AI。如果发现 AI 只是有一小块代码生成的不对，我的建议是先忍着，反正最后 AI 大概率会自己发现问题并修复。</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">过了大概十几分钟后，AI 生成完成，还告诉了我使用方法：</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">可惜我根本懒得看，我直接把 API Key 交给 AI 帮我运行不就好了？</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">Vibe Coding 开发模式下，我多自己做一件事，都是对 AI 的不尊重。</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">输入提示词：</span></p>\n<pre class=\"md-fences md-end-block ty-contain-cm modeLoaded\"><span>我的 API key 是 xxxxxxx，请你帮我运行</span></pre>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">然后，翻车了。。。</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">不慌，直接让 AI 自己检查并修复错误。而且为了使用方便，应该提供一个快速启动脚本，能够让我像运行 Claude Code 一样，一行命令启动 AI 编程工具。</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">提示词：</span></p>\n<pre class=\"md-fences md-end-block ty-contain-cm modeLoaded\"><span>帮我检查并修复项目中的错误，并创建一个可以像 Claude 一样让用户在命令行输入 \"yupicode\" 就能启动程序的快捷脚本</span></pre>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">几分钟后，AI 修复完成，并且提供了一个 <span class=\"md-pair-s\"><code>yupicode</code><span class=\"md-plain\"> 脚本：</span></span></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">我打开一个新的终端，然后运行 <span class=\"md-pair-s\"><code>yupicode</code><span class=\"md-plain\"> 脚本，尝试和 AI 对话：</span></span></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">你别说，效果还不错啊！</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">还像 Claude Code 一样提供了一些命令，比如清空对话历史、查看帮助之类的：</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">看到这里，我感觉项目已经基本可用了。建议给项目上个 Git 来版本控制，防止后面的改动出问题。</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">什么？你不知道 Git 是什么？</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">没关系，直接交给 AI 吧：</span></p>\n<pre class=\"md-fences md-end-block ty-contain-cm modeLoaded\"><span>现在项目已经基本可用了，帮我提交一个 git 版本，防止后续改动出问题</span></pre>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">测试下来，目前的 Yupi Code 还有一些不足之处，比如不支持搜索：</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">接下来就让我们优化项目，增加更多 Claude Code 支持的能力。</span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<h2 class=\"md-end-block md-heading\"><span class=\"md-plain\">优化能力</span></h2>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">1）先来添加网络搜索能力，直接把智谱的官方文档给它丢进去。提示词如下：</span></p>\n<pre class=\"md-fences md-end-block ty-contain-cm modeLoaded\"><span>现在好像不支持网络搜索，请参考<br /><span>https://docs.bigmodel.cn/api-reference/%E5%B7%A5%E5%85%B7-api/%E7%BD%91%E7%BB%9C%E6%90%9C%E7%B4%A2<br /><span>文档，增加网络搜索工具调用能力</span></span></span></pre>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">很快 AI 就添加了新功能，重新打开 yupicode 来验证下，正常生效了：</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">2）下面再优化下 AI 回复的效果，目前是卡一会儿然后直接输出完整回答，需要调整为流式输出的打字机效果。</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">提示词：</span></p>\n<pre class=\"md-fences md-end-block ty-contain-cm modeLoaded\"><span>我希望在等待 AI 回复时，有一个转圈的小图标；并且 AI 的回复可以实时流式输出</span></pre>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">AI 很快就搞定了：</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">3）GLM-4.7 进一步强化了交错式思考能力，引入 <span class=\"md-pair-s \"><strong>保留式思考</strong><span class=\"md-plain\"> 和 <span class=\"md-pair-s \"><strong>轮级思考</strong><span class=\"md-plain\">，让复杂任务执行更稳、更可控。我们也应该让 Yupi Code 输出模型的思考信息、工具调用信息等等，帮助用户了解情况。</span></span></span></span></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">输入提示词：</span></p>\n<pre class=\"md-fences md-end-block ty-contain-cm modeLoaded\"><span>帮我输出模型思考的信息、以及工具调用信息，你可以通过官方文档来了解如何开发</span></pre>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">测试一下优化后的效果，比如 “介绍一下鱼皮的 AI 导航网站”，能很清晰地看到思考过程：</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<h2 class=\"md-end-block md-heading\"><span class=\"md-plain\">大功告成</span></h2>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">到这里，仿照 Claude Code 开发的 Yupi Code 就已经完成了，让我们用它来开发个小网站试试。</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">比如来个动画学算法的 Demo，提示词：</span></p>\n<pre class=\"md-fences md-end-block ty-contain-cm modeLoaded\"><span>帮我开发一个学习冒泡排序算法的动画网站，使用 Q 版动漫的风格和吉伊卡哇感觉的配色</span></pre>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">效果如图，画风还是不错的，但要是之后大模型能自动生成图片插画并添加到网站中，就更好了。</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">再来开发个仿真的电子黑板，提示词：</span></p>\n<pre class=\"md-fences md-end-block ty-contain-cm modeLoaded\"><span>帮我开发一个仿真的电子黑板，用户可以在上面画画并导出为图片</span></pre>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">圣诞节了，鱼皮给大家画颗圣诞树，还附赠一个小礼物，这怎么能不算是程序员的浪漫呢~</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<div class=\"md-hr md-end-block\"><hr /></div>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">OK，这就是我 <span class=\"md-pair-s \"><strong>利用国产的 AI 大模型 GLM-4.7 + Claude Code</strong><span class=\"md-plain\"> 开发出一个 <span class=\"md-pair-s \"><strong>基于 GLM-4.7 的 Yupi Code</strong><span class=\"md-plain\"> 的全过程了。</span></span></span></span></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">我自己体验下来，GLM-4.7 相比于之前的国内大模型，在处理复杂任务的稳定性上有进步，即使遇到问题也会自动修复，让最终生成的代码可运行。</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">而且 GLM-4.7 调用工具的能力也强化了，和 Claude Code 等 AI 编程工具打配合，直接内置了联网搜索、网页读取、解释图片等 AI 编程常用的能力，不需要自己再去找 MCP 来增强了。</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">不得不说，作为一直关注智谱 AI 的忠实开发者，真的很能感受到他们这几个月来在 AI 编程方向的努力，我相信大家也是有目共睹。</span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">不过毕竟现在的 Yupi Code 是 AI 一把梭的，还有很多能优化完善的地方。如果后面有时间，大家也感兴趣的话，说不定我会好好打磨打磨这个工具把它开源出来。我的终极目标是，让基于 <span class=\"md-pair-s \"><strong>AI 大模型 GLM-4.7 + Claude Code</strong><span class=\"md-plain\"> 开发的基于 <span class=\"md-pair-s \"><strong>GLM-4.7 的 Yupi Code</strong><span class=\"md-plain\"> 编程工具，能够开发出一个基于 <span class=\"md-pair-s \"><strong>GLM-4.7 的</strong><span class=\"md-plain\"> 编程工具，比如 Yupi Son Code。我认为好的 AI 工具就是要能做到无限套娃，疯狂自举！</span></span></span></span></span></span></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-image md-img-loaded\"><img class=\"lazyload\" /></span></p>\n<p class=\"md-end-block md-p\"><span class=\"md-plain\">听懂掌声~</span></p>\n<p class=\"md-end-block md-p\">&nbsp;</p>\n<h2 class=\"md-end-block md-heading\"><span class=\"md-plain\">更多编程学习资源</span></h2>\n<ul class=\"ul-list\">\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-meta-i-c  md-link\"><a href=\"https://www.code-nav.cn/course\" rel=\"noopener nofollow\"><span class=\"md-plain\">Java前端程序员必做项目实战教程+毕设网站</span></a></span></p>\n</li>\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-meta-i-c  md-link\"><a href=\"https://www.code-nav.cn/\" rel=\"noopener nofollow\"><span class=\"md-plain\">程序员免费编程学习交流社区（自学必备）</span></a></span></p>\n</li>\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-meta-i-c  md-link\"><a href=\"https://www.code-nav.cn/course/cv\" rel=\"noopener nofollow\"><span class=\"md-plain\">程序员保姆级求职写简历指南（找工作必备）</span></a></span></p>\n</li>\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-meta-i-c  md-link\"><a href=\"https://www.mianshiya.com/\" rel=\"noopener nofollow\"><span class=\"md-plain\">程序员免费面试刷题网站工具（找工作必备）</span></a></span></p>\n</li>\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-meta-i-c  md-link\"><a href=\"https://www.code-nav.cn/post/1640584449888772098\" rel=\"noopener nofollow\"><span class=\"md-plain\">最新Java零基础入门学习路线 + Java教程</span></a></span></p>\n</li>\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-meta-i-c  md-link\"><a href=\"https://www.code-nav.cn/post/1640586673306091521\" rel=\"noopener nofollow\"><span class=\"md-plain\">最新Python零基础入门学习路线 + Python教程</span></a></span></p>\n</li>\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-meta-i-c  md-link\"><a href=\"https://www.code-nav.cn/post/1640586014108303362\" rel=\"noopener nofollow\"><span class=\"md-plain\">最新前端零基础入门学习路线 + 前端教程</span></a></span></p>\n</li>\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-meta-i-c  md-link\"><a href=\"https://www.code-nav.cn/post/1640586867363954689\" rel=\"noopener nofollow\"><span class=\"md-plain\">最新数据结构和算法零基础入门学习路线 + 算法教程</span></a></span></p>\n</li>\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-meta-i-c  md-link\"><a href=\"https://www.code-nav.cn/post/1644279832026075138\" rel=\"noopener nofollow\"><span class=\"md-plain\">最新C++零基础入门学习路线、C++教程</span></a></span></p>\n</li>\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-meta-i-c  md-link\"><a href=\"https://www.code-nav.cn/post/1641797333479903234\" rel=\"noopener nofollow\"><span class=\"md-plain\">最新数据库零基础入门学习路线 + 数据库教程</span></a></span></p>\n</li>\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-meta-i-c  md-link\"><a href=\"https://www.code-nav.cn/post/1640589994284695553\" rel=\"noopener nofollow\"><span class=\"md-plain\">最新Redis零基础入门学习路线 + Redis教程</span></a></span></p>\n</li>\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-meta-i-c  md-link\"><a href=\"https://www.code-nav.cn/post/1641035880439271426\" rel=\"noopener nofollow\"><span class=\"md-plain\">最新计算机基础入门学习路线 + 计算机基础教程</span></a></span></p>\n</li>\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-meta-i-c  md-link\"><a href=\"https://www.code-nav.cn/post/1641366118197153793\" rel=\"noopener nofollow\"><span class=\"md-plain\">最新小程序入门学习路线 + 小程序开发教程</span></a></span></p>\n</li>\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-meta-i-c  md-link\"><a href=\"http://sqlmother.yupi.icu/\" rel=\"noopener nofollow\"><span class=\"md-plain\">最新SQL零基础入门学习路线 + SQL教程</span></a></span></p>\n</li>\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-meta-i-c  md-link\"><a href=\"https://www.code-nav.cn/post/1640586295529324545\" rel=\"noopener nofollow\"><span class=\"md-plain\">最新Linux零基础入门学习路线 + Linux教程</span></a></span></p>\n</li>\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-meta-i-c  md-link\"><a href=\"https://www.code-nav.cn/post/1640588753362108417\" rel=\"noopener nofollow\"><span class=\"md-plain\">最新Git/GitHub零基础入门学习路线 + Git教程</span></a></span></p>\n</li>\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-meta-i-c  md-link\"><a href=\"https://www.code-nav.cn/post/1640587909942099969\" rel=\"noopener nofollow\"><span class=\"md-plain\">最新操作系统零基础入门学习路线 + 操作系统教程</span></a></span></p>\n</li>\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-meta-i-c  md-link\"><a href=\"https://www.code-nav.cn/post/1640588119619551233\" rel=\"noopener nofollow\"><span class=\"md-plain\">最新计算机网络零基础入门学习路线 + 计算机网络教程</span></a></span></p>\n</li>\n<li class=\"md-list-item\">\n<p class=\"md-end-block md-p\"><span class=\"md-meta-i-c  md-link\"><a href=\"https://www.code-nav.cn/post/1640588392073150465\" rel=\"noopener nofollow\"><span class=\"md-plain\">最新设计模式零基础入门学习路线 + 设计模式教程</span></a></span></p>\n</li>\n<li class=\"md-list-item md-focus-container\">\n<p class=\"md-end-block md-p md-focus\"><span class=\"md-meta-i-c md-link md-expand\"><a href=\"https://www.code-nav.cn/post/1640648711119892481\" rel=\"noopener nofollow\"><span class=\"md-plain\">最新软件工程零基础入门学习路线 + 软件工程教程</span></a></span></p>\n</li>\n</ul>\n</div>\n<div class=\"clear\"></div>\n\n            </div>\n            <div class=\"postDesc\">posted @ \n<span id=\"post-date\">2025-12-25 11:28</span>&nbsp;\n<a href=\"https://www.cnblogs.com/yupi\">程序员鱼皮</a>&nbsp;\n阅读(<span id=\"post_view_count\">199</span>)&nbsp;\n评论(<span id=\"post_comment_count\">2</span>)&nbsp;\n&nbsp;\n<a href=\"\">收藏</a>&nbsp;\n<a href=\"\">举报</a>\n</div>"
    }
  ]
}