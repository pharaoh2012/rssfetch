<?xml version="1.0" encoding="UTF-8" ?>
    <rss version="2.0">
    <channel>
        <title><![CDATA[ ä¸»é¡µ - åå®¢å­ ]]></title>
        <link><![CDATA[ https://www.cnblogs.com/ ]]></link>
        <lastBuildDate>2026-02-12T01:47:20.465Z</lastBuildDate>
        <description><![CDATA[
        ä¸»é¡µ - åå®¢å­ RSS
    ]]></description>
        <language>zh-cn</language>
        <item>
    <title><![CDATA[ ä»é¶å¼å§:C#åæä»¶AOTæåååç«¯åç¦»é¡¹ç® ]]></title>
    <link>https://www.cnblogs.com/luojin765/p/19607043</link>
    <guid>7b787664a14dc22448d1b50755323614</guid>
    <description>
    <![CDATA[ 
    <h2 class="postTitle"><a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/luojin765/p/19607043" title="åå¸äº 2026-02-12 09:42">
    <span role="heading" aria-level="2">ä»é¶å¼å§:C#åæä»¶AOTæåååç«¯åç¦»é¡¹ç®</span>
    

</a>
</h2>
    <div class="postText"><div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h1 id="ä¸åè¨">ä¸ãåè¨</h1>
<p>å¨ .NET çæéï¼å®æ¹æ©å°±ç»åºè¿âååç«¯ä¸ææ¢­âçæ¹æ¡ââBlazor ServerãBlazor WebAssemblyãASP.NET Core å¯å®¿ IIS ç­ãä½å®ä»¬è¦ä¹å¼ºä¾èµåç«¯ç¬ç«é¨ç½²ï¼è¦ä¹è¿è¡æ¶æå®¶å¸¦å£ï¼æºç è£¸é²ãå¯å¨éåº¦ãè·¨åéç½®é½æ¯çç¹ã<br>
åè§ GoãRust ç¤¾åºï¼ä¸ä¸ª app æä»¶å°±è½è·å® HTTP æå¡ + éæç«ç¹ï¼æ·è´å³ç¨ï¼ç¼è¯å®è¿æºç å½±å­é½çä¸å°ã<br>
å¶å® C# ä¹è½åå°ãä»å¤©è¿ç¯ï¼å°±æâåæä»¶ãAOTãååç«¯å¨æè¿ exeâçå®æ´æµç¨æç»ä½ çã</p>
<p><img alt="frontBackAot" loading="lazy" data-src="https://img2024.cnblogs.com/blog/3529796/202602/3529796-20260212094222610-1789616460.gif" class="lazyload"></p>
<h1 id="äºé¡¹ç®åå¤3-åéæå®">äºãé¡¹ç®åå¤ï¼3 åéæå®ï¼</h1>
<p>é¡¹ç®ä»ç¶æ¯ååç«¯åç¦»æ¶æï¼åç«¯å¯ä»¥ç¨VueãReactä»»ææ¡æ¶å®ç°ï¼ç¶åå¨.Netä¸­æåå¨ä¸èµ·ï¼åç«¯ä»£ç åªæ¯åµå¥ï¼ã<br>
æ´ä½æµç¨éå¸¸ç®åï¼ä»é¶å¼å§åå»ºï¼ä»¥NET10ä¸ºä¾ï¼</p>
<ul>
<li><code>dotnet new webapi -n AotDocsify -aot</code>åå»ºä¸ä¸ª <code>ASP.NET Core Web API(native AOT)</code> é¡¹ç®ã</li>
<li>é¡¹ç®æ ¹ç®å½å»º<code>wwwroot</code>æä»¶å¤¹</li>
<li>æåç«¯ç¼è¯äº§ç©ï¼æä»»ä½åç«¯ distï¼æ´åæè¿ wwwrootï¼æ¬ä¾ä¸­ç¨docsifyé¡¹ç®ï¼çº¯åç«¯markdownææ¡£åºï¼ï¼å°ånginxä¸­htmlä¸çæä»¶å¤å¶è¿æ¥ï¼</li>
</ul>
<h1 id="ä¸æéææä»¶åµè¿-exe">ä¸ãæéææä»¶âåµâè¿ exe</h1>
<p>æå¼<code>.csproj</code>æä»¶ï¼æå¨å¢å ä¸è¡éç½®ï¼å°<code>wwwroot</code>æä»¶å¤¹ä¸æææä»¶å¨é¨è®¾ä¸ºåµå¥çèµæºã<br>
ç¼è¯å¨ä¼ææææä»¶åè¿ PE èµæºæ®µï¼AOT åä¾æ§å¯è§ï¼é¶åå°ãé¶å¨æçæï¼æ¾å¿ç¨ã</p>
<pre><code class="language-xml">	&lt;ItemGroup&gt;
		&lt;EmbeddedResource Include="wwwroot\**\*" /&gt;
	&lt;/ItemGroup&gt;
</code></pre>
<h1 id="åè®©-webapplication-è®¤è¯è¿äºååµæä»¶">åãè®© WebApplication è®¤è¯è¿äºâååµâæä»¶</h1>
<p>ååç«¯ä»£ç ä¸åï¼æ°å¢éææä»¶ï¼éè¿<code>EmbeddedFileProvider</code>å°åµå¥çèµæºéç½®ä¸ºéææä»¶ã<br>
å¦æå¨EmbeddedResourceä¸éæ°æ´æ¹æä»¶é»è¾åçè¯ï¼è¿éå°±éè¦å¡«åå®æ´çé»è®¤å½åç©ºé´ï¼ç¨åºéåï¼ï¼å³"AotDocsify.wwwroot"ãè¿æ ·ç¨åºå°±è½éè¿è¾å¥è·¯å¾ï¼è¿åç¸åºåµå¥æä»¶ã</p>
<pre><code class="language-csharp">  app.UseStaticFiles(new StaticFileOptions
  {
      FileProvider = new EmbeddedFileProvider(Assembly.GetExecutingAssembly(), "AotDocsify.wwwroot"),
      
      RequestPath = ""
  });
</code></pre>
<p>åéç¹ï¼<code>Assembly.GetExecutingAssembly().GetManifestResourceStream</code> å¨ NativeAOT éå¹¶ä¸æ¯âçæ­£çåå°âï¼å®åªæ¯å¯¹ ç¼è¯æå°±å·²ç¥ä¸è¢«åµå¥å° PE çåæ°æ®è¡¨ åçä¸æ¬¡ å¸¸éçº§æ¥æ¾ï¼åªè¦ä½ å¨ .csproj éæ index.html æ è®°æ EmbeddedResourceï¼NativeAOT ç¼è¯å¨å°±ä¼æè¯¥èµæºè¿åå®çåå­ä¸èµ·åè¿æç»æ åï¼å¹¶çæä¸æ®µ æ åå°ãæ å¨æä»£ç çæçå­æ ¹ä»£ç ãå æ­¤è¿è¡æ¶æ¢ä¸ä¼è§¦å âåå°è¢«è£åªâ çå¼å¸¸ï¼ä¹ä¸ä¼åºç° âæ¾ä¸å°èµæºâ çéè¯¯ãå æ­¤æ¬ä»£ç å¯ç´æ¥ç¼è¯ã</p>
<h1 id="äºé¡µé¢è·¯ç±éç½®">äºãé¡µé¢è·¯ç±éç½®</h1>
<p>æ ¹è·¯å¾ / å SPA ç 404 ååºé½è¦æå¨æ¥ï¼å½è¾å¥æå¡å¨æ ¹å°åæ¶ï¼æ¯å¦<code>localhost:5000</code>ï¼æå¡å¨è¿æ¯ä¼è¿å404ãè¿æ¯å ä¸ºæä»¬è¿æªå¯¹æå¡å¨æ ¹ç®å½è·¯ç±è¿è¡éç½®ãä¼ ç»æ¹æ³éç½®ä»éå¯¹äºç©çæä»¶è·¯å¾ï¼å æ­¤æä»¬éè¦é¢å¤æå¨æ¥åå»ºä¸ä¸ªæ ¹ç®å½çè·¯ç±ãå·ä½ä»£ç å¦ä¸ï¼</p>
<pre><code class="language-csharp"> using var stream = Assembly.GetExecutingAssembly()
                           .GetManifestResourceStream("AotDocsify.wwwroot.index.html");
 if (stream is null) throw new Exception("æ¾ä¸å°åµå¥ç index.html");

 string indexHtml;
 using (var reader = new StreamReader(stream))
     indexHtml = reader.ReadToEnd();

 app.MapGet("/", () =&gt; Results.Content(indexHtml, "text/html"));

 app.MapFallback(() =&gt; Results.Content(indexHtml, "text/html"));

</code></pre>
<p>éè¿ä»¥ä¸ä»£ç æå°ï¼æä»¬å°±è½çå°åµå¥æè½½çæä»¶åè·¯å¾ï¼</p>
<pre><code class="language-csharp"> var names = Assembly.GetExecutingAssembly().GetManifestResourceNames();
 Console.WriteLine("=== åµå¥èµæºåè¡¨ ===");
 foreach (var n in names) Console.WriteLine(n);

// === åµå¥èµæºåè¡¨ ===
// AotDocsify.wwwroot..nojekyll
// AotDocsify.wwwroot.about.contributing.md
// AotDocsify.wwwroot.about.project.md
// AotDocsify.wwwroot.advanced.i18n.md
// AotDocsify.wwwroot.advanced.plugins.md
// AotDocsify.wwwroot.advanced.theme.md
// AotDocsify.wwwroot.examples.code-highlight.md
// AotDocsify.wwwroot.examples.markdown.md
// AotDocsify.wwwroot.examples.math.md
// AotDocsify.wwwroot.features.cover.md
// AotDocsify.wwwroot.features.multipage.md
// AotDocsify.wwwroot.features.navbar.md
// AotDocsify.wwwroot.features.sidebar.md
// AotDocsify.wwwroot.guide.basic-usage.md
// AotDocsify.wwwroot.guide.installation.md
// AotDocsify.wwwroot.guide.quickstart.md
// AotDocsify.wwwroot.README.md
// AotDocsify.wwwroot._sidebar.md
// AotDocsify.wwwroot.index.html
</code></pre>
<p>åå¸å®åï¼å é¤é¤exeå¤çæææä»¶ï¼åæ¬<code>wwwroot</code>ç®å½ãå ä¸ºæ­¤æ¶ææåç«¯æä»¶åå·²åµå¥æåï¼æ¬ä¾aotçæçæç»exeå¤§å°çº¦10mbï¼è¿è¡åï¼åç«¯åç«¯åå¯æ­£å¸¸å·¥ä½ï¼ä¸åç«¯ææèµæºå¯ä¾åç«¯è°ç¨ï¼ä¸å­å¨è·¨åé®é¢ãæå¼<code>http://localhost:5000</code>åºé¡µé¢ï¼æå¼<code>http://localhost:5000/todos</code>åºæ¥å£è¿åå¼ã</p>
<h1 id="å­æå">å­ãæå</h1>
<p>æ¬æä¸»è¦ä»ç»äºç¨æå°çä»£ç éæâåç«¯ dist + åç«¯ APIâ åæäºä¸ä¸ª AOT å¯æ§è¡æä»¶ï¼é¨ç½²åªå©âå¤å¶ â è¿è¡âä¸¤æ­¥ã<br>
å¦æä½ å¨éè¯»è¿ç¨ä¸­æä»»ä½çé®ï¼æèå¨å®éæä½ä¸­éå°äºå°é¾ï¼æ¬¢è¿éæ¶ä¸æä»¬äº¤æµãæä»¬éå¸¸æå¾å¬å°ä½ çåé¦åå»ºè®®ï¼ä»¥ä¾¿æä»¬è½å¤è¿ä¸æ­¥å®ååå®¹ï¼å¸®å©æ´å¤å¼åèãè¯·ç»§ç»­å³æ³¨æä»¬çå¬ä¼å·âè¤ç«åèâï¼æä»¬å°æç»­åäº«æ´å¤æè¶£ä¸å®ç¨çææ¯åå®¹ï¼ä¸å¤§å®¶ä¸èµ·å­¦ä¹ äº¤æµï¼å±åè¿æ­¥ã</p>
<p><img alt="QR" loading="lazy" data-src="https://img2024.cnblogs.com/blog/3529796/202509/3529796-20250915150401305-1035823235.jpg" class="lazyload"></p>


</div>
<div class="clear"></div>
</div>
    <p class="postfoot">posted on 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-02-12 09:43">2026-02-12 09:42</span>&nbsp;
<a href="https://www.cnblogs.com/luojin765">LdotJdot</a>&nbsp;
éè¯»(<span id="post_view_count">0</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19607043);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19607043', targetLink: 'https://www.cnblogs.com/luojin765/p/19607043', title: 'ä»é¶å¼å§:C#åæä»¶AOTæåååç«¯åç¦»é¡¹ç®' })">ä¸¾æ¥</a>
</p>
 ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ è¡¨æ ¼è®¾è®¡ï¼ç»æä¸ç¾æå¹¶é ]]></title>
    <link>https://www.cnblogs.com/wang_yb/p/19606960</link>
    <guid>93a793c30425598c177eb0a008f58fca</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/wang_yb/p/19606960" title="åå¸äº 2026-02-12 09:18">
    <span role="heading" aria-level="2">è¡¨æ ¼è®¾è®¡ï¼ç»æä¸ç¾æå¹¶é</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<p>æå°æ°æ®å¯è§åï¼å¤§å®¶èæµ·éå¾å¾æµ®ç°çæ¯ç«é·çå¨æå¾è¡¨æå¤æçä»ªè¡¨æ¿ã</p>
<p>ä½å¶å®ï¼å¨åä¸æ¥ååå­¦æ¯ç ç©¶ä¸­ï¼<strong>è¡¨æ ¼</strong>ï¼<code>Table</code>ï¼ ææ¯é£ä¸ªæé»é»æ é»å´æä¸å¯æç¼ºçè±éã</p>
<p>å¾å¤æ¶åï¼ä¸å¼ è®¾è®¡ç³ç³çè¡¨æ ¼å°±åä¸å µå¯ä¸éé£çç å¢ï¼è®©äººæèççï¼èä¸å¼ ä¼ç§çè¡¨æ ¼ï¼åºè¯¥åæ¯ä¸ä¸ªç²¾å¿æ´ççéåæï¼ä¸ç¼å°±è½çå°ææä»·å¼çå®è´ã</p>
<p>ä»å¤©ï¼æ¬æå°æ»ç»ä¸ä¸è¡¨æ ¼çç»æç¾å­¦ä¸è®¾è®¡æºæ§ã</p>
<h1 id="1-è¡¨æ ¼çç»æ">1. è¡¨æ ¼çç»æ</h1>
<p>å¦ææè¡¨æ ¼æ¯ä½ä¸åº§å»ºç­ï¼é£ä¹å®çæ¯ä¸ªç»æé¨ä»¶é½æ¿æçç¹å®åè½ã</p>
<p>ä¸é¢æ¯ä¸ä¸ªå®æ´çè¡¨æ ¼ç¤ºä¾ï¼å±ç¤ºäºæææ åç»æç»ä»¶ï¼</p>

<p><img src="https://cdn.nlark.com/yuque/0/2026/png/2235414/1769823999740-9f83f02d-038b-4c25-b6aa-fe3443ad5a32.png" alt="" loading="lazy"></p>
<p>è¡¨æ ¼ç»æå¾è§£ï¼</p>
<ol>
<li><strong>æ é¢ä¸å¯æ é¢</strong>ï¼è¡¨æ ¼ç"åå­"å"ç®ä»"ï¼åè¯è¯»èè¿æ¯ä»ä¹</li>
<li><strong>è¡¨å¤´</strong>ï¼åæ é¢ï¼ç¸å½äºæ°æ®åç"å§åæ ç­¾"</li>
<li><strong>è·¨åæ é¢</strong>ï¼æ¨ªè·¨å¤åçæ é¢ï¼ç¨äºåç»</li>
<li><strong>ååæ ¼</strong>ï¼æ°æ®çåºæ¬åä½ï¼è¡åäº¤åç¹</li>
<li><strong>ç½æ ¼çº¿</strong>ï¼åéååæ ¼ççº¿ï¼åç°å­æ ¼ççº¿</li>
<li><strong>è¾¹æ¡</strong>ï¼æ´ä¸ªè¡¨æ ¼çè¾¹ççº¿ï¼æ¬ä¾ä½¿ç¨é´å½±æ¿ä»£ç²è¾¹æ¡ï¼</li>
<li><strong>è¾¹çº¿</strong>ï¼åé¨åä¹é´çåéçº¿ï¼å¦é¡µèä¸æ¹çèçº¿</li>
<li><strong>é¡µè</strong>ï¼è¡¨æ ¼ç"æ»ç»éè¯"</li>
<li><strong>æ¥æºåæ³¨é</strong>ï¼æ°æ®ç"èº«ä»½è¯"å"ä½¿ç¨è¯´æ"</li>
</ol>
<h1 id="2-è¡¨æ ¼çè®¾è®¡åå">2. è¡¨æ ¼çè®¾è®¡åå</h1>
<p>è®¾è®¡è¡¨æ ¼çæé«å¢çæ¯âéå½¢âãå¥½çè®¾è®¡åºè¯¥è®©è¯»èå¿½ç¥è¡¨æ ¼æ¬èº«ï¼èç´æ¥çå°æ°æ®ã</p>
<p>ä»¥ä¸æ¯åæ¡é»éæ³åï¼æ¯æ¡é½åå¤äº<strong>âåé¢ææâ</strong>å<strong>âæ­£é¢ç¤ºèâ</strong>ã</p>
<h2 id="21-å°è¡¨å¤´å­æ®µä¸æ­£æåºåå¼">2.1. å°è¡¨å¤´å­æ®µä¸æ­£æåºåå¼</h2>
<p>è¡¨å¤´æ¯è·¯çï¼æ­£ææ¯é£æ¯ãå¦æè·¯çåé£æ¯æ··å¨ä¸èµ·ï¼æ¸¸å®¢å°±è¿·è·¯äºã</p>
<p>ä½¿ç¨å ç²ãèæ¯è²æçº¿æ¡æ¥åºåã</p>

<p><img src="https://cdn.nlark.com/yuque/0/2026/png/2235414/1769825066577-3377e8e0-dec0-49da-bdea-09ab005df3f1.png" alt="" loading="lazy"></p>
<h2 id="22-ä½¿ç¨æ·¡èç»çåéçº¿">2.2. ä½¿ç¨æ·¡èç»çåéçº¿</h2>
<p>ä¸è¦ææ°æ®å³è¿âçç±âéï¼ç²é»çç½æ ¼çº¿ä¼æ¢å¤ºè§çº¿ã</p>
<p>ç°ä»£è®¾è®¡å¾åäºåªä¿çæ¨ªååå²çº¿ï¼çè³å®å¨ç¨çç½ä»£æ¿çº¿æ¡ã</p>

<p><img src="https://cdn.nlark.com/yuque/0/2026/png/2235414/1769825086423-d4485a90-70e2-4ad0-b2cc-d973eb40c970.png" alt="" loading="lazy"></p>
<h2 id="23-æ°æ®åè¡¨å¤´å­æ®µå³å¯¹é½">2.3. æ°æ®åè¡¨å¤´å­æ®µå³å¯¹é½</h2>
<p>è¿æ¯æ°ææå¸¸ç¯çéè¯¯ã</p>
<p>æ°å­ä¸å®è¦<strong>å³å¯¹é½</strong>ï¼å ä¸ºæä»¬æ¯è¾æ°å¼å¤§å°æ¶ï¼æ¯æ ¹æ®âä½âæ¥æ¯çï¼ä¸ªä½å¯¹ä¸ªä½ï¼åä½å¯¹åä½ï¼ã</p>

<p><img src="https://cdn.nlark.com/yuque/0/2026/png/2235414/1769825100185-1bd84382-8621-4c76-b2f0-6fbe7225c80a.png" alt="" loading="lazy"></p>
<h2 id="24-ææ¬åæ é¢å·¦å¯¹é½">2.4. ææ¬åæ é¢å·¦å¯¹é½</h2>
<p>å¯¹äºéæ°å­çææ¬ï¼å¦åå­ãå°åºãç±»å«ï¼ï¼å·¦å¯¹é½ç¬¦åæä»¬çéè¯»ä¹ æ¯ï¼ä»å·¦å°å³ï¼ã</p>
<p>å±ä¸­å¯¹é½ææ¬ä¼è®©è¯»èçç¼çå¨é¯é½¿ç¶çè¾¹ç¼è·³æ¥è·³å»ï¼éå¸¸ç´¯ã</p>

<p><img src="https://cdn.nlark.com/yuque/0/2026/png/2235414/1769825113141-761532f1-d04a-4f78-bc7d-1af78f069010.png" alt="" loading="lazy"></p>
<h2 id="25-éæ©éå½çç²¾åº¦çº§å«">2.5. éæ©éå½çç²¾åº¦çº§å«</h2>
<p>æ°æ®ä¸æ¯è¶ç²¾ç¡®è¶å¥½ï¼ç»é«ç®¡çæ¥è¡¨ï¼$1,234,567.89 è¿ä¸å¦ $1.23M æ¥å¾ç´è§ã</p>
<p>å¤ä½çå°æ°ç¹æ¯âæ°æ®åªé³âã</p>

<p><img src="https://cdn.nlark.com/yuque/0/2026/png/2235414/1769825131209-bb733176-7f58-4fe8-b788-7694816b7041.png" alt="" loading="lazy"></p>
<h2 id="26-å©ç¨çç½å¼å¯¼è§çº¿">2.6. å©ç¨çç½å¼å¯¼è§çº¿</h2>
<p>æ¥æ¤çè¡¨æ ¼è®©äººçªæ¯ãç»è¡ä¸è¡ãåä¸åä¹é´çåºâå¼å¸ç©ºé´âï¼Paddingï¼ã</p>
<p>çç½æ¬èº«å°±æ¯æå¥½çåå²çº¿ã</p>

<p><img src="https://cdn.nlark.com/yuque/0/2026/png/2235414/1769825150546-db07e24d-f074-4b43-b817-8afe5b4d68d9.png" alt="" loading="lazy"></p>
<h2 id="27-å é¤éå¤çåä½">2.7. å é¤éå¤çåä½</h2>
<p>ä¸è¦è®©è¯»èçç¼çä¸éééå¤è¯»åæ ·çä¿¡æ¯ãæåä½ï¼$ãkgã%ï¼æå°è¡¨å¤´éå»ã</p>

<p><img src="https://cdn.nlark.com/yuque/0/2026/png/2235414/1769825172096-1787cad2-2267-4716-8cb7-39af8792724c.png" alt="" loading="lazy"></p>
<h2 id="28-çªåºæ¾ç¤ºå¼å¸¸å¼">2.8. çªåºæ¾ç¤ºå¼å¸¸å¼</h2>
<p>è¡¨æ ¼ä¸ä»è¦éåæ°æ®ï¼è¿è¦ååºè­¦æ¥ã</p>
<p>å¦ææä¸ªæ°æ®éè¦å³æ³¨ï¼å¦äºæãæªè¾¾æ ï¼ï¼è¯·ç¨çº¢è²æå ç²æ åºæ¥ï¼ä¸è¦è®©è¯»èèªå·±å»âæ¾è¬âã</p>

<p><img src="https://cdn.nlark.com/yuque/0/2026/png/2235414/1769825187223-10cecb69-3d7e-4cd4-9ce5-d9d1a8b140cc.png" alt="" loading="lazy"></p>
<h2 id="29-å°ç¸ä¼¼æ°æ®åç»å¹¶å¢å ç©ºç½">2.9. å°ç¸ä¼¼æ°æ®åç»å¹¶å¢å ç©ºç½</h2>
<p>å¦æå¤è¡å±äºåä¸ä¸ªç±»å«ï¼ä¸è¦éå¤åç±»å«åï¼ä¹ä¸è¦çç©ºè®©äººçã</p>
<p>æ´å¥½çåæ³æ¯åç»æ¾ç¤ºï¼æèåªæ¾ç¤ºä¸æ¬¡ç±»å«åã</p>

<p><img src="https://cdn.nlark.com/yuque/0/2026/png/2235414/1769825199656-612b3e57-3bf3-446b-878e-b0eb2083e918.png" alt="" loading="lazy"></p>
<h2 id="210-éå½æ·»å å¯è§ååç´ ">2.10. éå½æ·»å å¯è§ååç´ </h2>
<p>è¡¨æ ¼åå¾è¡¨ä¸æ¯æ­»å¯¹å¤´ã</p>
<p>å¨è¡¨æ ¼éåµå¥æ°æ®æ¡ï¼Data Barsï¼ãè¿·ä½ å¾ï¼Sparklinesï¼ æ ç­åè²åï¼è½è®©è¡¨æ ¼ç¬é´åæâå¯è§åä»ªè¡¨æ¿âã</p>

<p><img src="https://cdn.nlark.com/yuque/0/2026/png/2235414/1769825210326-7c50dc8f-2808-4b0b-90d9-f0481023f76a.png" alt="" loading="lazy"></p>
<h1 id="3-æ»ç»">3. æ»ç»</h1>
<p><strong>è¡¨æ ¼</strong>ä¸ä»ä»æ¯å­æ¾æ°å­çå®¹å¨ï¼å®æ¯æ²éçæ¡¥æ¢ã</p>
<p>å¥½çè¡¨æ ¼è®¾è®¡å°±åä¼ç§çåå¸å¯¼è§å¾ï¼æ¸æ°çæ è¯ï¼è¡¨å¤´ï¼ãåççååºï¼åç»ï¼ãç´è§çè·¯å¾ï¼å¯¹é½æ¹å¼ï¼ãéåº¦çè£é¥°ï¼å¯è§ååç´ ï¼ï¼ä»¥åæéè¦çââä»¥ç¨æ·ï¼è¯»èï¼ä¸ºä¸­å¿ã</p>
<p>è¡¨æ ¼ä¸ä»æ¯æ°æ®çå®¹å¨ï¼æ´æ¯æ²éçå·¥å·ã</p>
<p>æ¯ä¸ªè®¾è®¡å³ç­é½åºæå¡äºä¸ä¸ªç®æ ï¼è®©è¯»èæ´å¿«ãæ´åç¡®å°çè§£æ°æ®èåçæäºã</p>
<p>å¨æ°æ®å¯è§åçå¤§è±å­ä¸­ï¼è¡¨æ ¼å¯è½æ¯ææ´å®æ åçé£ä¸æµï¼ä½å®çå®ç¨æ§åç²¾ç¡®æ§æ°¸è¿æ æ³è¢«æ¿ä»£ã</p>
<p>ææ¡è¡¨æ ¼çè®¾è®¡èºæ¯ï¼ä½ å°±è½å¨æåºç¡çåªä»ä¸ï¼åé åºæä¼éçæ°æ®è¡¨è¾¾ã</p>


</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-02-12 09:19">2026-02-12 09:18</span>&nbsp;
<a href="https://www.cnblogs.com/wang_yb">wang_yb</a>&nbsp;
éè¯»(<span id="post_view_count">0</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19606960);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19606960', targetLink: 'https://www.cnblogs.com/wang_yb/p/19606960', title: 'è¡¨æ ¼è®¾è®¡ï¼ç»æä¸ç¾æå¹¶é' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ AIå·¥å·å®è·µæ¥è®°ï¼ä¸ï¼ï¼å¨æ èæ´¾ä¸æ­å»ºOpenClawï¼ä¸ä¸ªåç«¯å¼åèççå®è¸©åè®°å½ ]]></title>
    <link>https://www.cnblogs.com/rsls/p/19606304</link>
    <guid>cf9e0545f3b34443a63511631318db4f</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/rsls/p/19606304" title="åå¸äº 2026-02-12 08:53">
    <span role="heading" aria-level="2">AIå·¥å·å®è·µæ¥è®°ï¼ä¸ï¼ï¼å¨æ èæ´¾ä¸æ­å»ºOpenClawï¼ä¸ä¸ªåç«¯å¼åèççå®è¸©åè®°å½</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                    <div id="cnblogs_post_description" style="display: none">
        <img src="https://img2024.cnblogs.com/blog/280247/202602/280247-20260212004610584-747709995.png" alt="AIå·¥å·å®è·µæ¥è®°ï¼ä¸ï¼ï¼å¨æ èæ´¾ä¸æ­å»ºOpenClawï¼ä¸ä¸ªåç«¯å¼åèççå®è¸©åè®°å½" class="desc_img">
        çå®è®°å½æå¨æ èæ´¾ä¸æ¢ç´¢OpenClawçè¿ç¨ââä¸ç¾åãä¸ç«æï¼åªæçå®çè¸©ååæåã
    </div>
<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<blockquote>
<p>çå®è®°å½æå¨æ èæ´¾ä¸æ¢ç´¢OpenClawçè¿ç¨ââä¸ç¾åãä¸ç«æï¼åªæçå®çè¸©ååæåã</p>
</blockquote>
<hr>
<h2 id="å¼è¨">å¼è¨</h2>
<p>ä½ä¸ºä¸ååç«¯å¼åèï¼æçææ¯æ ä»C#å¼å§ï¼éæ¸å­¦ä¼äºVUEï¼åæäºå¨æ å¼åãåæ¥ä¹å­¦ä¹ äºPythonï¼ä¹ç¨Javaå¼åä¼ä¸çº§åºç¨ãä½æ¯æè¿è¿å å¹´ï¼éçAIçåå±ï¼ä»ChatGPTå°Kimiï¼ä»å¨VsCodeä¸­å¯¹è¯ï¼å°å¨Cursorä¸­ç¼ç¨ï¼ä»å­¦ä¼ä½¿ç¨Claude Codeå¼å§ï¼æå·²ç»åæäºAIå¨æ å¼åèãæè¿OpenClawä¹å¾ç«ï¼èæä¹å¾ç¾¡æé¢éä¾ ä¸­çè´¾ç»´æ¯ï¼äºæ¯æå¼å§æ¢ç´¢ä¸ä¸ªä¸åçæ¹åï¼<strong>æAIå©æé¨ç½²å¨èªå·±çæ èæ´¾ä¸ã</strong></p>
<p>ä¸ºä»ä¹æ¯æ èæ´¾ï¼</p>
<ol>
<li><strong>æ°æ®éç§</strong>ï¼AIå©æè¿è¡å¨èªå·±çè®¾å¤ä¸ï¼æ°æ®ä¸åºæ¬å°</li>
<li><strong>ç¡¬ä»¶éæ</strong>ï¼æ èæ´¾æ¯æGPIOãæåå¤´ãèçç­ç¡¬ä»¶</li>
<li><strong>7x24å°æ¶è¿è¡</strong>ï¼ä½åèï¼å¯ä»¥ä¸ç´å¾å½</li>
<li><strong>å¤æ¸ ééæ</strong>ï¼ç´æ¥å¨ééãDiscordç­éè®¯å·¥å·ä¸­ä½¿ç¨</li>
<li><strong>èªå¨åè½åå¼º</strong>ï¼åç½®Cronè°åº¦å¨ï¼åç§å®æ¶ä»»å¡</li>
</ol>
<p>å¬èµ·æ¥å¾å®ç¾ï¼å¯¹å§ï¼</p>
<p>ä½å®éå¨æ èæ´¾ä¸å®è£åéç½®OpenClawçè¿ç¨ä¸­ï¼æè¸©äºä¸å°åãä¸é¢ï¼ææ³è®°å½çå®çæ¢ç´¢è¿ç¨ã</p>
<hr>
<h2 id="ä¸ºä»ä¹éæ©å¨æ èæ´¾ä¸é¨ç½²openclaw">ä¸ºä»ä¹éæ©å¨æ èæ´¾ä¸é¨ç½²OpenClawï¼</h2>
<h3 id="æçæ èæ´¾éç½®">æçæ èæ´¾éç½®</h3>
<ul>
<li><strong>åå·</strong>ï¼æ èæ´¾4Bï¼4GBåå­ï¼</li>
<li><strong>ç³»ç»</strong>ï¼Linux 6.12.62+rpt-rpi-v8ï¼ARM64æ¶æï¼</li>
<li><strong>Pythonçæ¬</strong>ï¼3.8+</li>
<li><strong>Node.jsçæ¬</strong>ï¼v24.13.0</li>
</ul>
<h3 id="éæ©openclawçåå ">éæ©OpenClawçåå </h3>
<ol>
<li><strong>æ¬å°åé¨ç½²</strong>ï¼å®å¨å¨æ èæ´¾ä¸è¿è¡ï¼æ°æ®æ´å®å¨</li>
<li><strong>ç¡¬ä»¶åå¥½</strong>ï¼æ¯ææåå¤´ãèçç­ç¡¬ä»¶è®¾å¤</li>
<li><strong>å¤æ¸ ééæ</strong>ï¼æ¯æééãDiscordç­ï¼ç´æ¥å¨èå¤©ä¸­ä½¿ç¨</li>
<li><strong>æè½æ©å±</strong>ï¼å¯ä»¥èªå·±åPython/Shellèæ¬æ©å±åè½</li>
<li><strong>å®æ¶ä»»å¡</strong>ï¼åç½®Cronè°åº¦å¨ï¼èªå¨åæ´æ¹ä¾¿</li>
</ol>
<hr>
<h2 id="å¨æ èæ´¾ä¸å®è£openclawä»ä¸é®å®è£å°æ¢æ¢æ¸ç´¢">å¨æ èæ´¾ä¸å®è£OpenClawï¼ä»"ä¸é®å®è£"å°"æ¢æ¢æ¸ç´¢"</h2>
<h3 id="ç¬¬ä¸æ­¥ç¯å¢åå¤">ç¬¬ä¸æ­¥ï¼ç¯å¢åå¤</h3>
<p>æ èæ´¾çç³»ç»ç¯å¢åæ®éçx86æå¡å¨ä¸å¤ªä¸æ ·ï¼è¿ç¹å¨å®è£æ¶ç»äºæä¸å°æåã</p>
<p><strong>å1ï¼Pythonçæ¬ä¸å¼å®¹</strong></p>
<p>æ èæ´¾é»è®¤å®è£çæ¯Python 3.7ï¼ä½OpenClawéè¦Python 3.8+ã</p>
<pre><code class="language-bash"># æ£æ¥Pythonçæ¬
python3 --version
# Python 3.7.3

# å®è£Python 3.8+
sudo apt update
sudo apt install python3.8 python3.8-venv python3-pip
</code></pre>
<p><strong>å2ï¼ARM64æ¶æçNode.jså®è£</strong></p>
<p>OpenClawéè¦Node.jsï¼ä½æ èæ´¾æ¯ARM64æ¶æï¼æ®éçx86çæ¬ä¸è½ç¨ã</p>
<p>è§£å³ï¼</p>
<pre><code class="language-bash"># ä¸è½½ARM64çæ¬çNode.js
wget https://nodejs.org/dist/v24.13.0/node-v24.13.0-linux-arm64.tar.xz

# è§£å
tar -xf node-v24.13.0-linux-arm64.tar.xz

# ç§»å¨å°ç³»ç»ç®å½
sudo mv node-v24.13.0-linux-arm64 /usr/local/node

# éç½®ç¯å¢åé
echo 'export PATH=/usr/local/node/bin:$PATH' &gt;&gt; ~/.bashrc
source ~/.bashrc

# éªè¯å®è£
node --version
# v24.13.0
</code></pre>
<h3 id="ç¬¬äºæ­¥å®è£openclaw-cli">ç¬¬äºæ­¥ï¼å®è£OpenClaw CLI</h3>
<p>å®æ¹ææ¡£è¯´ä¸è¡å½ä»¤å°±è½å®è£ï¼</p>
<pre><code class="language-bash">npm install -g @openclaw/cli
</code></pre>
<p>ä½å¨æ èæ´¾ä¸ï¼éå°äºå ä¸ªé®é¢ã</p>
<p><strong>å3ï¼npmæéé®é¢</strong></p>
<p>ç¬¬ä¸æ¬¡å®è£æ¶æ¥éï¼<code>EACCES: permission denied</code></p>
<p>è§£å³ï¼</p>
<pre><code class="language-bash"># éç½®npmå¨å±ç®å½
mkdir ~/.npm-global
npm config set prefix '~/.npm-global'
echo 'export PATH=~/.npm-global/bin:$PATH' &gt;&gt; ~/.bashrc
source ~/.bashrc
npm install -g @openclaw/cli
</code></pre>
<p><strong>å4ï¼npmå®è£éåº¦æ¢</strong></p>
<p>æ èæ´¾çæ§è½æéï¼npmå®è£éåº¦å¾æ¢ï¼çè³ä¼è¶æ¶ã</p>
<p>è§£å³ï¼</p>
<pre><code class="language-bash"># ä½¿ç¨å½åéå
npm config set registry https://registry.npmmirror.com
</code></pre>
<h3 id="ç¬¬ä¸æ­¥åå§åéç½®">ç¬¬ä¸æ­¥ï¼åå§åéç½®</h3>
<pre><code class="language-bash">openclaw init
</code></pre>
<p>è¿æ­¥æ¯è¾é¡ºå©ï¼ä½æä¸ªå°ç»èï¼</p>
<p><strong>å5ï¼æ¶åºéç½®éè¯¯</strong></p>
<p>ä¸å¼å§ææ²¡æ³¨ææ¶åºè®¾ç½®ï¼ç»æå®æ¶ä»»å¡æ»æ¯æ¯æé¢æçæ¶é´æ8å°æ¶ï¼UTC vs åäº¬æ¶é´ï¼ã</p>
<p>è§£å³ï¼</p>
<pre><code class="language-bash"># æ£æ¥ç³»ç»æ¶åº
timedatectl status
# æ¾ç¤ºï¼Time zone: UTC

# è®¾ç½®æ¶åºä¸ºAsia/Shanghai
sudo timedatectl set-timezone Asia/Shanghai
# éªè¯
timedatectl status
# æ¾ç¤ºï¼Time zone: Asia/Shanghai (CST, +0800)
</code></pre>
<h3 id="ç¬¬åæ­¥å®è£dingtalkæä»¶">ç¬¬åæ­¥ï¼å®è£DingTalkæä»¶</h3>
<p>ææ³ç¨ééä½ä¸ºä¸»è¦éè®¯å·¥å·ï¼æä»¥å®è£äºDingTalkæä»¶ï¼</p>
<pre><code class="language-bash">openclaw plugins install dingtalk
</code></pre>
<p><strong>å6ï¼æä»¶éç½®å¤æ</strong></p>
<p>å®è£åéè¦éç½®AppKeyãAppSecretãä¼ä¸IDç­ä¿¡æ¯ãæå¨ééå¼åèåå°æè¾äºå¾ä¹æææ¸æ¥è¿äºåæ°ä»åªéè·åã</p>
<p>è§£å³ï¼</p>
<ol>
<li>ç»å½ééå¼æ¾å¹³å°ï¼<a href="https://open.dingtalk.com/" target="_blank" rel="noopener nofollow">https://open.dingtalk.com/</a></li>
<li>åå»ºåºç¨ï¼æºå¨äººåºç¨ï¼</li>
<li>è·åAppKeyãAppSecret</li>
<li>éç½®ä¼ä¸ID</li>
<li>å¨ <code>~/.openclaw/openclaw.json</code>ä¸­å¡«å¥è¿äºä¿¡æ¯</li>
</ol>
<p>éç½®æä»¶ç¤ºä¾ï¼</p>
<pre><code class="language-json">{
  "channels": {
    "dingtalk": {
      "enabled": true,
      "clientId": "ä½ çAppKey",
      "clientSecret": "ä½ çAppSecret",
      "robotCode": "ä½ çæºå¨äººç¼ç ",
      "corpId": "ä½ çä¼ä¸ID",
      "dmPolicy": "open",
      "groupPolicy": "open",
      "messageType": "card"
    }
  }
}
</code></pre>
<h3 id="ç¬¬äºæ­¥å¯å¨gatewayæå¡">ç¬¬äºæ­¥ï¼å¯å¨Gatewayæå¡</h3>
<pre><code class="language-bash">openclaw gateway start
</code></pre>
<p><strong>å7ï¼ç«¯å£å²çª</strong></p>
<p>ç¬¬ä¸æ¬¡å¯å¨æ¶æ¥éï¼<code>Error: listen EADDRINUSE: address already in use :::18789</code></p>
<p>æ£æ¥åç°æ¯å¶ä»æå¡å ç¨äºç«¯å£ã</p>
<p>è§£å³ï¼</p>
<pre><code class="language-bash"># æ£æ¥ç«¯å£å ç¨
lsof -i :18789

# åæ­¢å ç¨ç«¯å£çè¿ç¨
sudo kill &lt;è¿ç¨ID&gt;

# æèä¿®æ¹éç½®æä»¶ä¸­çç«¯å£
</code></pre>
<p><strong>å8ï¼æ èæ´¾æ§è½éå¶</strong></p>
<p>å¯å¨Gatewayåï¼æ èæ´¾çåå­å ç¨å¾é«ï¼ç³»ç»åå¾å¡é¡¿ã</p>
<p>è§£å³ï¼</p>
<pre><code class="language-bash"># å¨~/.openclaw/openclaw.jsonä¸­è°æ´å¹¶ååæ°
"agents": {
  "defaults": {
    "maxConcurrent": 2,  // éä½å¹¶åæ°
    "subagents": {
      "maxConcurrent": 4  // éä½å­ä»»å¡å¹¶åæ°
    }
  }
}
</code></pre>
<hr>
<h2 id="å¨æ èæ´¾ä¸çå®ç¨åºæ¯">å¨æ èæ´¾ä¸çå®ç¨åºæ¯</h2>
<h3 id="åºæ¯1èçttsè¯­é³æ­æ¾">åºæ¯1ï¼èçTTSè¯­é³æ­æ¾</h3>
<p>ææ³è®©OpenClawéè¿èçé³ç®±æ­æ¾è¯­é³ãè¿å¨æ èæ´¾ä¸å®ç°èµ·æ¥å¾æææã</p>
<p><strong>å9ï¼èçé³ç®±éå¯¹</strong></p>
<p>æ èæ´¾çèçéç½®åæ®éçµèä¸å¤ªä¸æ ·ã</p>
<pre><code class="language-bash"># å®è£èçå·¥å·
sudo apt install bluez bluez-tools pulseaudio pulseaudio-module-bluetooth

# å¯å¨èçæå¡
sudo systemctl start bluetooth

# éç½®èç
sudo bluetoothctl
# è¿å¥äº¤äºæ¨¡å¼
[bluetooth]# power on
[bluetooth]# agent on
[bluetooth]# scan on
# æ¾å°è®¾å¤å
[bluetooth]# pair &lt;è®¾å¤MACå°å&gt;
[bluetooth]# connect &lt;è®¾å¤MACå°å&gt;
[bluetooth]# trust &lt;è®¾å¤MACå°å&gt;
[bluetooth]# exit
</code></pre>
<p>é®é¢ï¼éå¯¹æåäºï¼ä½é³é¢è¾åºä¸å°èçé³ç®±ã</p>
<p>è§£å³ï¼</p>
<pre><code class="language-bash"># æ£æ¥é³é¢è¾åºè®¾å¤
pactl list sinks short

# è®¾ç½®é»è®¤è¾åºä¸ºèçè®¾å¤
pactl set-default-sink &lt;èçè®¾å¤åç§°&gt;

# æµè¯é³é¢æ­æ¾
paplay /usr/share/sounds/alsa/Front_Center.wav
</code></pre>
<p>ç°å¨ï¼æå¯ä»¥å¯¹OpenClawè¯´ï¼</p>
<pre><code>è¯·æ­æ¾è¯­é³ï¼"ç°å¨æ¯ä¸åä¸ç¹ï¼è®°å¾ä¼æ¯ä¸ä¸"
</code></pre>
<p>å®å°±ä¼éè¿èçé³ç®±æ­æ¾åºæ¥ã</p>
<p><strong>æ èæ´¾ä¸çç¹å«ä¹å¤ï¼</strong></p>
<ul>
<li>èçéç½®éè¦æå¨æä½ï¼ä¸åPCé£æ ·å¾å½¢çé¢æ¹ä¾¿</li>
<li>èå²é³é¢ï¼PulseAudioï¼çéç½®éè¦çæ</li>
<li>ä½ä¸æ¦éç½®å¥½ï¼å¯ä»¥7x24å°æ¶å¾å½ï¼éæ¶æ­æ¥</li>
</ul>
<h3 id="åºæ¯2æåå¤´æç§åæ§å¶">åºæ¯2ï¼æåå¤´æç§åæ§å¶</h3>
<p>ææ³è®©OpenClawå¸®ææç§å¹¶åéå°ééãæ èæ´¾ä¸æ¥USBæåå¤´å¾æ¹ä¾¿ã</p>
<p><strong>å10ï¼æåå¤´è¢«å ç¨</strong></p>
<p>æ èæ´¾ä¸æä¸ªçæ§æå¡ <code>motion</code>ï¼å®å ç¨äºæåå¤´è®¾å¤ <code>/dev/video0</code>ã</p>
<p>ç¬¬ä¸æ¬¡æç§æ¶æ¥éï¼<code>Could not open video device /dev/video0</code></p>
<p>è§£å³ï¼</p>
<pre><code class="language-bash"># åæ­¢motionæå¡
sudo pkill motion
sudo systemctl stop motion

# æ£æ¥æåå¤´
ls /dev/video*
# /dev/video0 /dev/video1

# æç§
ffmpeg -f v4l2 -video_size 640x480 -i /dev/video0 -frames:v 1 /tmp/photo.jpg -y

# æç§åéå¯motionï¼å¦æéè¦ï¼
sudo systemctl start motion
</code></pre>
<p><strong>å11ï¼æåå¤´åè¾¨çéå¶</strong></p>
<p>æ èæ´¾æ¯æçæåå¤´æ ¼å¼ååè¾¨çæéã</p>
<pre><code class="language-bash"># æ¥çæåå¤´æ¯æçæ ¼å¼
v4l2-ctl --list-formats

# æ¥çæ¯æçåè¾¨ç
v4l2-ctl --list-formats-ext

# æçicspring cameraæé«åªæ¯æ640x480ï¼YUYVæ ¼å¼
</code></pre>
<p>ææå½ä»¤éè¦æå®æ­£ç¡®çæ ¼å¼ï¼</p>
<pre><code class="language-bash">ffmpeg -f v4l2 -video_size 640x480 -i /dev/video0 -pix_fmt yuyv422 -frames:v 1 /tmp/photo.jpg -y
</code></pre>
<p>ç°å¨ï¼æå¯ä»¥å¯¹OpenClawè¯´ï¼</p>
<pre><code>è¯·æä¸å¼ ç§çï¼å¹¶åéå°éé
</code></pre>
<p>å ç§åï¼æå°±è½å¨ééèå¤©ä¸­çå°ååæçç§çã</p>
<p><strong>æ èæ´¾ä¸çç¹å«ä¹å¤ï¼</strong></p>
<ul>
<li>USBæåå¤´ç­æææ¹ä¾¿</li>
<li>å¯ä»¥åçæ§æå¡motionéåä½¿ç¨</li>
<li>æ èæ´¾ä½ç§¯å°ï¼å¯ä»¥æ¾å¨ä»»ä½éè¦çæ§çå°æ¹</li>
</ul>
<h3 id="åºæ¯3é®ä»¶åéåè½">åºæ¯3ï¼é®ä»¶åéåè½</h3>
<p>ææ³è®©OpenClawå¸®æåé®ä»¶ãäºæ¯å¼åäºä¸ä¸ªemail-senderæè½ã</p>
<p><strong>å12ï¼SMTPéç½®é·é±</strong></p>
<p>éç½®126é®ç®±çSMTPæå¡æ¶ï¼æä¸å¼å§ç¨çæ¯é®ç®±å¯ç ï¼ç»æä¸ç´æ¥è®¤è¯éè¯¯ã</p>
<p>æ¥äºåå¤©ææ¡£æåç°ï¼126é®ç®±éè¦ç¨"å®¢æ·ç«¯ææç "ï¼èä¸æ¯é®ç®±å¯ç ã</p>
<p>è§£å³ï¼</p>
<ol>
<li>ç»å½126é®ç®±ç½é¡µç</li>
<li>è¿å¥è®¾ç½® â POP3/SMTP/IMAP</li>
<li>å¼å¯SMTPæå¡</li>
<li>è·åææç </li>
<li>å¨éç½®æä»¶ä¸­ä½¿ç¨ææç </li>
</ol>
<p>éç½®æä»¶ï¼<code>/home/pi/.openclaw/workspace/config/email.conf</code>ï¼ï¼</p>
<pre><code class="language-ini">[SMTP]
host = smtp.126.com
port = 465
username = ren8179@126.com
password = QHyjTYHm8w3QVpi6  # å®¢æ·ç«¯ææç ï¼ä¸æ¯é®ç®±å¯ç 
</code></pre>
<p>Pythonåéèæ¬ï¼</p>
<pre><code class="language-python">import smtplib
from email.mime.text import MIMEText
import configparser

def send_email(to, subject, content):
    config = configparser.ConfigParser()
    config.read('/home/pi/.openclaw/workspace/config/email.conf')

    smtp_host = config['SMTP']['host']
    smtp_port = config['SMTP']['port']
    username = config['SMTP']['username']
    password = config['SMTP']['password']

    msg = MIMEText(content)
    msg['From'] = username
    msg['To'] = to
    msg['Subject'] = subject

    with smtplib.SMTP_SSL(smtp_host, smtp_port) as server:
        server.login(username, password)
        server.send_message(msg)
</code></pre>
<p>ç°å¨ï¼æå¯ä»¥å¯¹OpenClawè¯´ï¼</p>
<pre><code>è¯·åéé®ä»¶å°ren8179@126.comï¼ä¸»é¢æ¯"æµè¯"ï¼åå®¹æ¯"OpenClawé®ä»¶åéåè½æµè¯"
</code></pre>
<p>å ç§åï¼é®ä»¶å°±åéæåäºã</p>
<p><strong>æ èæ´¾ä¸çç¹å«ä¹å¤ï¼</strong></p>
<ul>
<li>24å°æ¶å¨çº¿ï¼éæ¶å¯ä»¥åéé®ä»¶</li>
<li>å¯ä»¥éåå®æ¶ä»»å¡ï¼èªå¨åéæ¥æ¥ãå¨æ¥</li>
<li>é®ä»¶åå®¹å¯ä»¥åºäºä¼ æå¨æ°æ®ï¼æ¸©åº¦ãæ¹¿åº¦ç­ï¼</li>
</ul>
<h3 id="åºæ¯4å®æ¶ä»»å¡åèªå¨å">åºæ¯4ï¼å®æ¶ä»»å¡åèªå¨å</h3>
<p>è¿æ¯OpenClawæå¼ºå¤§çåè½ä¹ä¸ãåç½®çCronè°åº¦å¨è®©æå¯ä»¥è®¾ç½®åç§èªå¨åä»»å¡ã</p>
<p><strong>å13ï¼Cronè¡¨è¾¾å¼çè§£éè¯¯</strong></p>
<p>ä¸å¼å§æä¸å¤ªçè§£Cronè¡¨è¾¾å¼çæ ¼å¼ï¼å¯¼è´ä»»å¡æ§è¡æ¶é´åé¢æä¸ç¬¦ã</p>
<p>æ¯å¦ï¼ææ³è®¾ç½®"æ¯å¤©æ©ä¸8ç¹æ§è¡"ï¼æåæäºï¼</p>
<pre><code class="language-json">"expr": "0 8 * * *"
</code></pre>
<p>ç»æåç°æ¯å¨UTCæ¶é´8ç¹æ§è¡ï¼ä¸æ¯åäº¬æ¶é´8ç¹ã</p>
<p>è§£å³ï¼<br>
å¨éç½®æä»¶ä¸­æç¡®æå®æ¶åºï¼</p>
<pre><code class="language-json">{
  "schedule": {
    "kind": "cron",
    "expr": "0 8 * * *",
    "tz": "Asia/Shanghai"  // æç¡®æå®æ¶åº
  }
}
</code></pre>
<p>ç°å¨ï¼æå¯ä»¥è®¾ç½®åç§èªå¨åä»»å¡ï¼</p>
<ul>
<li>æ¯å¤©8ç¹ï¼åéæ©é´ç®æ¥å°éé</li>
<li>æ¯å°æ¶æ´ç¹ï¼æ­æ¥æ¶é´</li>
<li>æ¯å¤©åæ¨2ç¹ï¼æ§è¡æ°æ®å¤ä»½</li>
<li>å·¥ä½æ¥ä¸å9ç¹ï¼åéå·¥ä½æé</li>
</ul>
<p><strong>æ©é´ç®æ¥ç¤ºä¾ï¼</strong></p>
<pre><code class="language-json">{
  "id": "morning-report",
  "name": "æ©é´ç®æ¥",
  "schedule": {
    "kind": "cron",
    "expr": "0 8 * * *",
    "tz": "Asia/Shanghai"
  },
  "payload": {
    "kind": "agentTurn",
    "message": "è¯·çæä»å¤©çæ©é´ç®æ¥ï¼åæ¬ï¼\n1. æ¨å¤å®æçå·¥ä½\n2. ç³»ç»ç¶æ\n3. ä»æ¥å»ºè®®\n\nåéå°éé"
  }
}
</code></pre>
<p><strong>æ èæ´¾ä¸çç¹å«ä¹å¤ï¼</strong></p>
<ul>
<li>ä½åèï¼24å°æ¶è¿è¡ä¹ä¸å¿ç¼çµè´¹</li>
<li>ç³»ç»ç¨³å®ï¼é¿æ¶é´è¿è¡ä¸éå¯</li>
<li>å¯ä»¥ååç§ç¡¬ä»¶å®æ¶å¨éå</li>
</ul>
<hr>
<h2 id="æ èæ´¾æ§è½ä¼åç»éª">æ èæ´¾æ§è½ä¼åç»éª</h2>
<h3 id="ææ1åå­å ç¨é«">ææ1ï¼åå­å ç¨é«</h3>
<p>OpenClawè¿è¡å¨æ èæ´¾ä¸ï¼åå­å ç¨æ¯ä¸ªé®é¢ã</p>
<p><strong>è§£å³æ¹æ¡ï¼</strong></p>
<ol>
<li>
<p><strong>éä½å¹¶åæ°</strong>ï¼</p>
<pre><code class="language-json">"agents": {
  "defaults": {
    "maxConcurrent": 2,
    "subagents": {
      "maxConcurrent": 4
    }
  }
}
</code></pre>
</li>
<li>
<p><strong>å¯ç¨ä¼è¯åç¼©</strong>ï¼</p>
<pre><code class="language-json">"agents": {
  "defaults": {
    "compaction": {
      "mode": "safeguard",
      "maxTokens": 200000
    }
  }
}
</code></pre>
</li>
<li>
<p><strong>å®ææ¸çæ§ä¼è¯</strong>ï¼</p>
<pre><code class="language-bash">openclaw sessions cleanup --older-than 1d
</code></pre>
</li>
</ol>
<h3 id="ææ2ç£çç©ºé´ä¸è¶³">ææ2ï¼ç£çç©ºé´ä¸è¶³</h3>
<p>OpenClawä¼è¯æ¥å¿ä¼å ç¨å¤§éç£çç©ºé´ã</p>
<p><strong>è§£å³æ¹æ¡ï¼</strong></p>
<pre><code class="language-bash"># è®¾ç½®æ¥å¿è½®è½¬
sudo vim /etc/logrotate.d/openclaw

/home/pi/.openclaw/agents/main/sessions/*.jsonl {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
}
</code></pre>
<h3 id="ææ3æ èæ´¾æ£ç­">ææ3ï¼æ èæ´¾æ£ç­</h3>
<p>OpenClawæç»­è¿è¡ä¼è®©æ èæ´¾åç­ï¼å½±åæ§è½ã</p>
<p><strong>è§£å³æ¹æ¡ï¼</strong></p>
<pre><code class="language-bash"># å®è£æ£ç­çæ§
sudo apt install lm-sensors

# æ¥çæ¸©åº¦
sensors

# å®è£æ£ç­é£æ
# æ èæ´¾4Bå¼ºçå»ºè®®å®è£ä¸»å¨æ£ç­

# éç½®CPUé¢çè°è
echo 'performance' | sudo tee /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor
</code></pre>
<hr>
<h2 id="æ·±å¥ä½éªä¸»å¨å¼aiå©æçåé">æ·±å¥ä½éªï¼ä¸»å¨å¼AIå©æçåé</h2>
<p>OpenClawæè®©ææåçï¼æ¯å®ç"ä¸»å¨æ§"ã</p>
<h3 id="ä¼ ç»çaiå©æ">ä¼ ç»çAIå©æ</h3>
<p>ä¼ ç»çAIå©æï¼æ¯"è¢«å¨å¼"çï¼</p>
<ul>
<li>ä½ é®ä»ä¹ï¼å®ç­ä»ä¹</li>
<li>ä½ ä¸é®ï¼å®ä»ä¹é½ä¸ä¼å</li>
<li>åä¸ä¸ªéæ¶å¾å½çä»äºº</li>
</ul>
<h3 id="openclawçä¸»å¨æ§">OpenClawçä¸»å¨æ§</h3>
<p>OpenClawçè®¾è®¡çå¿µæ¯"ä¸»å¨å¼AIå©æ"ï¼</p>
<ul>
<li>å®ä¼ä¸»å¨æ£æ¥ç³»ç»ç¶æ</li>
<li>å®ä¼ä¸»å¨åéæ©é´ç®æ¥</li>
<li>å®ä¼ä¸»å¨æ§è¡å®æ¶ä»»å¡</li>
<li>åä¸ä¸ªç§¯æçéå</li>
</ul>
<h3 id="å®éæ¡ä¾æ©é´ç®æ¥">å®éæ¡ä¾ï¼æ©é´ç®æ¥</h3>
<p>æè®¾ç½®äºä¸ä¸ªæ¯æ¥æ©é´ç®æ¥ï¼æ¯å¤©æ©ä¸8ç¹èªå¨åéå°ééãåå®¹åæ¬ï¼</p>
<ul>
<li>ð åå®¹åä½è¿å±</li>
<li>ð å·¥å·ä¼åååæ°</li>
<li>ð å­¦ä¹ è¿åº¦</li>
<li>ð è¡ä¸å¨æ</li>
<li>ð¡ ä»æ¥å»ºè®®</li>
</ul>
<p>æ¯å¤©æ©ä¸éæ¥ï¼æå¼ééï¼å°±è½çå°AIå©æå·²ç»å¸®ææ´çå¥½äºææéè¦ä¿¡æ¯ãè¿ç§æè§ï¼ççåæä¸ä¸ª"ç§äººå©ç"å¨é»é»ä¸ºæå·¥ä½ã</p>
<p><strong>æ èæ´¾ä¸çä¼å¿ï¼</strong></p>
<ul>
<li>7x24å°æ¶å¨çº¿ï¼ä»ä¸éè¿ä»»ä½ä»»å¡</li>
<li>ä½åèï¼ä¸ä¸ªæçµè´¹ä¸å°10å</li>
<li>ä½ç§¯å°ï¼å¯ä»¥æ¾å¨ä»»ä½å°æ¹</li>
</ul>
<hr>
<h2 id="æçæèæ èæ´¾aiå©æçå¯è½æ§">æçæèï¼æ èæ´¾+AIå©æçå¯è½æ§</h2>
<h3 id="ä»¥åçæ³æ³aiå¨äºç«¯">ä»¥åçæ³æ³ï¼AIå¨äºç«¯</h3>
<p>ä»¥åæè§å¾AIå¿é¡»å¨äºç«¯è¿è¡ï¼å ä¸ºï¼</p>
<ul>
<li>äºç«¯ç®åå¼º</li>
<li>äºç«¯æ¨¡åå¤§</li>
<li>äºç«¯æ´æ°å¿«</li>
</ul>
<h3 id="ç°å¨çæ³æ³aiä¹å¯ä»¥å¨è¾¹ç¼">ç°å¨çæ³æ³ï¼AIä¹å¯ä»¥å¨è¾¹ç¼</h3>
<p>å¨æ èæ´¾ä¸è¿è¡OpenClawåï¼æçæ³æ³æ¹åäºï¼</p>
<p><strong>AIä¸æ¯åªè½å¨äºç«¯ï¼ä¹å¯ä»¥å¨è¾¹ç¼è®¾å¤ä¸è¿è¡ã</strong></p>
<p>ä¼å¿ï¼</p>
<ol>
<li><strong>æ°æ®éç§</strong>ï¼æææ°æ®å¨æ¬å°ï¼æ´å®å¨</li>
<li><strong>ç½ç»ç¬ç«</strong>ï¼ä¸ä¾èµç½ç»ï¼ç¦»çº¿ä¹è½ç¨ï¼é¨ååè½ï¼</li>
<li><strong>ç¡¬ä»¶éæ</strong>ï¼å¯ä»¥ç´æ¥æ§å¶æåå¤´ãèçãGPIOç­</li>
<li><strong>7x24å°æ¶</strong>ï¼ä½åèï¼å¯ä»¥ä¸ç´å¾å½</li>
<li><strong>ææ¬å¯æ§</strong>ï¼ä¸æ¬¡æ§è´­ä¹°ï¼æ²¡æè®¢éè´¹ç¨</li>
</ol>
<h3 id="åºç¨åºæ¯">åºç¨åºæ¯</h3>
<p>åºäºæ èæ´¾+OpenClawï¼å¯ä»¥åå¾å¤äºæï¼</p>
<ol>
<li><strong>æºè½å®¶å±æ§å¶ä¸­å¿</strong>ï¼æ§å¶ç¯åãæ¸©åº¦ãå®é²</li>
<li><strong>å®¶åº­çæ§</strong>ï¼æåå¤´æç§ãå¼å¸¸æ£æµ</li>
<li><strong>è¯­é³å©æ</strong>ï¼éè¿èçé³ç®±æ­æ¥ä¿¡æ¯</li>
<li><strong>èªå¨åä»»å¡</strong>ï¼å®æ¶åéé®ä»¶ãæéãå¤ä»½</li>
<li><strong>è¿ç¨çæ§</strong>ï¼éè¿éééæ¶æ¥çç¶æ</li>
<li><strong>å­¦ä¹ è®°å½</strong>ï¼è®°å½å­¦ä¹ è¿åº¦ãçææ¥æ¥å¨æ¥</li>
</ol>
<hr>
<h2 id="åå¨æå">åå¨æå</h2>
<p>è¿ç¯æç« ï¼è®°å½äºæå¨æ èæ´¾ä¸å®è£åéç½®OpenClawççå®è¿ç¨ã</p>
<p><strong>çå®ä½éªæ»ç»ï¼</strong></p>
<ol>
<li><strong>å®è£ä¸è½»æ¾</strong>ï¼è¸©äºä¸å°åï¼ä½é½è§£å³äº</li>
<li><strong>å­¦ä¹ æ²çº¿é¡</strong>ï¼éè¦æ¶é´çæï¼ä½å¼å¾</li>
<li><strong>åè½å¾å¼ºå¤§</strong>ï¼è¶åºäºæçé¢æ</li>
<li><strong>ä¸»å¨æ§å¾å¼º</strong>ï¼åä¸ä¸ªçæ­£ç"éå"</li>
<li><strong>æ§è½éè¦ä¼å</strong>ï¼æ èæ´¾æ§è½æéï¼éè¦è°æ´éç½®</li>
<li><strong>ç¡¬ä»¶éæå¾æè¶£</strong>ï¼æåå¤´ãèçç­ï¼æ¢ç´¢ç©ºé´å¾å¤§</li>
</ol>
<p><strong>ç»æ³å°è¯çæåçå»ºè®®ï¼</strong></p>
<p>å¦æä½ ä¹æ³å¨æ èæ´¾ä¸ç©AIå©æï¼æçå»ºè®®æ¯ï¼</p>
<ol>
<li><strong>éæ©åéçè®¾å¤</strong>ï¼æ èæ´¾4Bï¼4GBæ8GBåå­ï¼</li>
<li><strong>èå¿å®è£</strong>ï¼ä¼éå°åç§é®é¢ï¼æ¢æ¢è§£å³</li>
<li><strong>å³æ³¨æ§è½</strong>ï¼æ³¨æåå­ãCPUãç£çä½¿ç¨æåµ</li>
<li><strong>åæ¥ç¡¬ä»¶ä¼å¿</strong>ï¼æåå¤´ãèçãGPIOé½è¯è¯</li>
<li><strong>è®°å½ç»éª</strong>ï¼æè¸©åç»éªè®°å½ä¸æ¥ï¼æ¢å¸®å©èªå·±ï¼ä¹è½å¸®å©å«äºº</li>
</ol>
<p><strong>ä¸ä¸æ­¥è®¡åï¼</strong></p>
<ol>
<li>ç»§ç»­æ¢ç´¢OpenClawçé«çº§åè½</li>
<li>å¼åæ´å¤èªå®ä¹æè½</li>
<li>å°è¯æ èæ´¾+AIçåç§ç»ååºæ¯</li>
<li>è®°å½å®æ´çæºè½å®¶å±é¡¹ç®</li>
<li>åäº«æ´å¤æ èæ´¾+AIçå®è·µç»éª</li>
</ol>
<hr>
<h2 id="åèé¾æ¥">åèé¾æ¥</h2>
<ul>
<li>OpenClaw ææ¡£ï¼<a href="https://docs.openclaw.ai" target="_blank" rel="noopener nofollow">https://docs.openclaw.ai</a></li>
<li>ééå¼æ¾å¹³å°ï¼<a href="https://open.dingtalk.com/" target="_blank" rel="noopener nofollow">https://open.dingtalk.com/</a></li>
<li>æ èæ´¾å®æ¹ææ¡£ï¼<a href="https://www.raspberrypi.org/documentation/" target="_blank" rel="noopener nofollow">https://www.raspberrypi.org/documentation/</a></li>
<li>ç±å¼¥å¿ä»»å¡çæ¿ï¼<a href="https://github.com/ren8179/aimier-kanban" target="_blank" rel="noopener nofollow">https://github.com/ren8179/aimier-kanban</a></li>
</ul>
<hr>
<p><em>æ¬ææ¯çå®çæ¢ç´¢è®°å½ï¼æ²¡æç¾åï¼æ²¡æææ¯ç«æãåªæ¯ä¸ä¸ªåç«¯å¼åèå¨æ èæ´¾ä¸æ¢ç´¢AIå©æçè¸©åç»åã</em></p>
<hr>
<p><strong>åå¸æ¥æï¼</strong> 2026-02-07<br>
<strong>ä½èï¼</strong> ä»»çª<br>
<strong>æ ç­¾ï¼</strong> #AIå·¥å· #OpenClaw #æ èæ´¾ #åç«¯å¼å #å®è·µç»éª #æ¬å°åé¨ç½² #æºè½å®¶å±</p>


</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-02-12 08:53">2026-02-12 08:53</span>&nbsp;
<a href="https://www.cnblogs.com/rsls">äºè´éç©º</a>&nbsp;
éè¯»(<span id="post_view_count">45</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19606304);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19606304', targetLink: 'https://www.cnblogs.com/rsls/p/19606304', title: 'AIå·¥å·å®è·µæ¥è®°ï¼ä¸ï¼ï¼å¨æ èæ´¾ä¸æ­å»ºOpenClawï¼ä¸ä¸ªåç«¯å¼åèççå®è¸©åè®°å½' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ æè£äºä¸ªæä»¶ï¼è®©ä¸¤ä¸ª OpenClaw å¼å§ 24/7 æäºæäº ]]></title>
    <link>https://www.cnblogs.com/xueweihan/p/19605642</link>
    <guid>46fb0f703314f924bde260278483d7d8</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/xueweihan/p/19605642" title="åå¸äº 2026-02-12 08:27">
    <span role="heading" aria-level="2">æè£äºä¸ªæä»¶ï¼è®©ä¸¤ä¸ª OpenClaw å¼å§ 24/7 æäºæäº</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<p><img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/759200/202602/759200-20260211180010755-652204303.png" class="lazyload"></p>
<p>æè¿çç«çå¼æºé¡¹ç® OpenClaw æ¯ä¸ä¸ªæ¬¾è½å¤è¿è¡å¨èªå·±è®¾å¤ä¸çä¸ªäºº AI å©æãä½ åªéåéä»»å¡ï¼å®å°±ä¼ 7x24 å¹²æ´»ââèä¸æ¯ç®åçæå­åå¤ã</p>
<p><img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/759200/202602/759200-20260211180457822-876623531.png" class="lazyload"></p>
<p>ç®åï¼ç½ä¸å·²ç»æå¾å¤è¯¦ç»ç OpenClaw å®è£æç¨ï¼è¿éå°±ä¸åéå¤äºãæå¹³æ¶ç¨ OpenClaw å¹²æ´»ï¼æ¯å¦ï¼åæç­ååæ§è¡è½å°è¿ä¸¤ä¸ªè§è²æ¯éè¦åå¼çââåèéè¦å¤©é©¬è¡ç©ºï¼åèéè¦ä¸¥è°¨ç»è´ãè¿ä¸ªæ¶åï¼ä¸åç AI éè¦æä¸åçå®ä½æè½å¹²å¥½æ´»ã</p>
<p>æå°±æ³ï¼è½ä¸è½è®©ä¸¤ä¸ª OpenClaw åå¹²åçæ´»ï¼ä½åè½æ ç¼è¡æ¥&nbsp;24/7 æäºæï¼</p>
<p>æè¿å¨ x ä¸ä¹çå°äº @huangserva å¤§ä½¬çæ¹æ¡ï¼ç»äºææ´å¤ççµæï¼å¦æè·éäºï¼ä»¥åãä¸äººå¬å¸ãçæªæ¥ä¸å°±æ¯æå¸¦çèªå·±ç OpenClaw AãBãC ä¸èµ· 24/7 é«ææäºå¿ï¼ï¼</p>
<p><img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/759200/202602/759200-20260211180507546-49003112.png" class="lazyload"></p>
<p>è¿æ¶åæåçå°äº MemOS ååç OpenClaw æä»¶ï¼ç¨ä¸æ¥æè§è¿çè¡ã</p>
<p><img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/759200/202602/759200-20260211180516470-681455514.png" class="lazyload"></p>
<blockquote>
<p>GitHub å°åï¼<a href="https://github.com/MemTensor/MemOS" target="_blank" rel="noopener nofollow">github.com/MemTensor/MemOS</a></p>
</blockquote>
<p>ä¸é¢å°±æ¯æçå®éæä½è®°å½ï¼æä¹é¨ç½²çãæä¹éç½®çä»¥åæåè·éäºçææï¼å¤ OpenClaw åä½ï¼ã</p>
<h2 id="ä¸ä¸ºä»ä¹éè¦ä¸¤ä¸ª-openclaw-åä½">ä¸ãä¸ºä»ä¹éè¦ä¸¤ä¸ª OpenClaw åä½ï¼</h2>
<p>ä¸å¼å§æä¹è§å¾ï¼ä¸ä¸ª OpenClaw ä¸å°±å¤äºåï¼ä¸ºä»ä¹è¦æä¸¤ä¸ªï¼</p>
<p>ç¨äºä¸éµå­åç°ï¼æäºåºæ¯ç¡®å®éè¦åå·¥ï¼å¶æ¬¡æ¯åå·¥å¯ä»¥æ´é«æçäº§åºã</p>
<p>æ¯å¦ï¼ç­åæ´»å¨æ¶ï¼<strong>åæé¶æ®µéè¦åæ£æç»´ãå¤©é©¬è¡ç©ºãæ§è¡é¶æ®µéè¦è½å°ç»èãé£é©ææ§</strong>ãè®©åä¸ä¸ª Agent æ¢åæ£åä¸¥è°¨ï¼å¾å®¹æç²¾ç¥åè£ã</p>
<p>å¶æ¬¡ï¼ä¸ä¸ª OpenClaw è£äºè®¾è®¡å·¥å·ãææ¡æ¨¡æ¿ï¼ä¸é¨å¹²åæãå¦ä¸ä¸ªè¿æ¥äºé¡¹ç®ç®¡çç³»ç»ãé¢ç®å·¥å·ï¼ä¸é¨å¹²è½å°ãåå¸å¶èï¼æçæ´é«ã</p>
<p>æçéæ±å°±æ¯ç¬¬ä¸ç§ï¼ç­åä¸åºææ¯æ²é¾ãåæé¶æ®µè®© OpenClaw A äº§åºæ´»å¨ä¸»æµç¨åæåææ¡ï¼æ§è¡é¶æ®µè®© OpenClaw B æ¥åäº§åºç©ææ¸åãé£é©é¢æ¡ï¼æåå double-check ä¸éã</p>
<p>è¿éçå³é®æ¯ï¼<strong>B ä¸éè¦ææå¨åè¯å® A åäºä»ä¹ï¼å®åºè¯¥èªå·±ä»è®°å¿éè¯»å° A çäº§åº</strong>ï¼ç¶åæ ç¼æ¥å 24/7 æäºæã</p>
<p>ç¶å MemOS ç OpenClaw æä»¶å¸®å©ææ´å¥½çå¹²äºè¿ä¸ªèæ´»ã</p>
<h2 id="äºé¨ç½²ä¸¤ä¸ª-openclaw--memos-æä»¶">äºãé¨ç½²ä¸¤ä¸ª OpenClaw + MemOS æä»¶</h2>
<p>æ´ä¸ªé¨ç½²è¿ç¨ä¸å¤æï¼ä½æå ä¸ªç»èè¦æ³¨æã</p>
<h3 id="21-è·å-memos-api-key">2.1 è·å MemOS API Key</h3>
<p>é¦åå» MemOS å®æ¹æ³¨åå¹¶è·å API Key æ ¼å¼æ¯ mpg-... å¼å¤´çå­ç¬¦ä¸²ã</p>
<p><img alt="" width="1363" height="308" loading="lazy" data-src="https://img2024.cnblogs.com/blog/759200/202602/759200-20260211181954179-718641202.png" class="lazyload"></p>
<p>è¿ä¸ª Key æ¯ä¸¤ä¸ª OpenClaw å±äº«è®°å¿çå­è¯ãæäºå®ï¼ä¸¤ä¸ªç¬ç«ç OpenClaw å®ä¾å°±è½è®¿é®åä¸ä¸ªè®°å¿æ± ã</p>
<h3 id="22-é¨ç½²ä¸¤ä¸ª-openclaw-å®ä¾">2.2 é¨ç½²ä¸¤ä¸ª OpenClaw å®ä¾</h3>
<p>ææ¯å¨åä¸å°æºå¨ä¸è·ä¸¤ä¸ªå®ä¾ï¼ç¨ä¸åç«¯å£åºåãä½ ä¹å¯ä»¥åå«é¨ç½²å¨ä¸¤å°æå¡å¨ä¸ï¼ææä¸æ ·ã</p>
<p><strong>OpenClaw Aï¼åæç­å</strong></p>
<pre><code class="language-bash"># åå»ºéç½®ç®å½å¹¶åå¥ API Key
mkdir -p ~/.openclaw &amp;&amp; echo "MEMOS_API_KEY=mpg-your_key_here" &gt; ~/.openclaw/.env

# å®è£ OpenClawï¼å¦æè¿æ²¡è£ï¼
npm install -g openclaw@latest

# åå§åéç½®
openclaw onboard
</code></pre>
<p>ææç¤ºéç½®å®åï¼OpenClaw A ä¼è·å¨é»è®¤ç«¯å£ï¼éå¸¸æ¯ 3000ï¼ã</p>
<p><strong>OpenClaw Bï¼æ§è¡è½å°</strong></p>
<p>è¿éæä¸ªåï¼åä¸å°æºå¨è·ä¸¤ä¸ªå®ä¾ï¼éè¦æå®ä¸åçå·¥ä½ç®å½åç«¯å£ã</p>
<pre><code class="language-bash"># åå»º OpenClaw B çç¬ç«å·¥ä½ç®å½
mkdir -p ~/.openclaw-exec

# å¤å¶éç½®ï¼ç¨åä¸ä¸ª API Keyï¼
cp ~/.openclaw/.env ~/.openclaw-exec/.env

# ç¨ç¬ç«éç½®å¯å¨ç¬¬äºä¸ªå®ä¾
OPENCLAW_HOME=~/.openclaw-exec openclaw onboard --port 3001
</code></pre>
<p>è¿æ ·ä¸¤ä¸ª OpenClaw å°±è·èµ·æ¥äºï¼ä¸ä¸ªå¨ 3000 ç«¯å£ä¸ä¸ªå¨ 3001 ç«¯å£ã</p>
<h3 id="23-å®è£-memos-æä»¶">2.3 å®è£ MemOS æä»¶</h3>
<p>ä¸¤ä¸ªå®ä¾é½è¦è£ MemOS æä»¶ãåå«è¿å¥åèªçç»ç«¯æ§è¡ï¼</p>
<p><strong>OpenClaw A</strong></p>
<pre><code>openclaw plugins install github:MemTensor/MemOS-Cloud-OpenClaw-Plugin
openclaw gateway restart
</code></pre>
<p><strong>OpenClaw B</strong></p>
<pre><code>OPENCLAW_HOME=~/.openclaw-exec openclaw plugins install github:MemTensor/MemOS-Cloud-OpenClaw-Plugin
OPENCLAW_HOME=~/.openclaw-exec openclaw gateway restart
</code></pre>
<p>è£å®åï¼æ£æ¥æä»¶æ¯å¦å¯ç¨ï¼</p>
<pre><code># OpenClaw A
cat ~/.openclaw/openclaw.json | grep memos-cloud-openclaw-plugin

# OpenClaw B
cat ~/.openclaw-exec/openclaw.json | grep memos-cloud-openclaw-plugin
</code></pre>
<p>çå° <code>"enabled": true</code> å°±è¯´ææä»¶å·²æ¿æ´»ã</p>
<h3 id="24-å±äº«-user_idå³é®">2.4 å±äº« user_idï¼å³é®ï¼</h3>
<p><code>user_id</code> æ¯å®ç°è®©å¤ä¸ª OpenClaw è®°å¿å±äº«çå³é®ã</p>
<p>MemOS ç¨ <code>user_id</code> æ¥åºåä¸åçè®°å¿ç©ºé´ãåä¸ä¸ª <code>user_id</code> ä¸çææå¯¹è¯åäº§åºï¼é½å­å¨åä¸ä¸ªè®°å¿æ± éã</p>
<p>é»è®¤éç½®ä¸ <code>MEMOS_USER_ID=openclaw-user</code>ï¼ä¸¤ä¸ª OpenClaw å®ä¾ç¨çæ¯åä¸ä¸ª <code>.env</code> æä»¶ï¼æèä½ æå¨å¤å¶äºä¸ä»½ç¸åçï¼ï¼æä»¥å®ä»¬ç <code>user_id</code> æ¯ä¸æ ·çââè¿å°±å®ç°äºè®°å¿å±äº«ã</p>
<p>å¦æä½ æ³æ¹æèªå®ä¹ç <code>user_id</code>ï¼å¯ä»¥å¨ <code>.env</code> æä»¶éå ä¸è¡å°±æå®ï¼</p>
<pre><code>MEMOS_USER_ID=my-custom-user-id
</code></pre>
<p>ä¸¤ä¸ªé¾è¾ï¼OpenClawï¼é½ç¨è¿ä¸ªéç½®ï¼å°±è½è½»æ¾å±äº«è®°å¿ï¼</p>
<h2 id="ä¸æµè¯ä¸¤ä¸ª-openclaw-åä½ç­åææ¯æ²é¾">ä¸ãæµè¯ä¸¤ä¸ª OpenClaw åä½ç­åææ¯æ²é¾</h2>
<p>é¨ç½²å¥½åï¼å¼å§æµè¯åä½æµç¨ã</p>
<h3 id="31-ä»»å¡åå·¥">3.1 ä»»å¡åå·¥</h3>
<p>æç»ä¸¤ä¸ª OpenClaw å®äºæç¡®çåå·¥åè§è²ï¼</p>
<p><strong>OpenClaw A è´è´£åæç­å</strong></p>
<p><img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/759200/202602/759200-20260211181443496-1591447717.png" class="lazyload"></p>
<p><img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/759200/202602/759200-20260211181449495-490492006.png" class="lazyload"></p>
<p><strong>OpenClaw B åè´è´£æ§è¡è½å°</strong></p>
<ul>
<li>åºäº A çæ¹æ¡ï¼äº§åºç©ææ¸å</li>
<li>å¶å®é£é©é¢æ¡</li>
<li>æåå double-check æ´ä½æ¹æ¡</li>
</ul>
<p>è¿ä¹æä½çç®çæ¯ï¼<strong>B ä¸éè¦æåè¯å® A åäºä»ä¹ï¼èªå·±å°±è½ä» MemOS è®°å¿éè¯»å° A çäº§åºï¼å¹¶å¼å§æ ç¼æ¥åå¹²æ´»</strong>ã</p>
<h3 id="32-ç¬¬ä¸æ­¥openclaw-a-äº§åºåææ¹æ¡">3.2 ç¬¬ä¸æ­¥ï¼OpenClaw A äº§åºåææ¹æ¡</h3>
<p>ææå¼ OpenClaw A ççé¢ï¼ç´æ¥é®ï¼</p>
<p><img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/759200/202602/759200-20260211181459508-805417399.png" class="lazyload"></p>
<p>OpenClaw A å¼å§å·¥ä½ãå åéåï¼å®å¼å§äº§åºäºï¼</p>
<p><img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/759200/202602/759200-20260211181515289-1331715736.gif" class="lazyload"></p>
<p>å¹¶ä¸å¿«éç»æè¿åäºç»æï¼</p>
<p><img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/759200/202602/759200-20260211181526565-205007444.png" class="lazyload"></p>
<p>è¿äºåå®¹èªå¨åå¥äº MemOSãææ²¡åä»»ä½æå¨ä¿å­ï¼æä»¶å·²ç»æ A çäº§åºå­è¿äºè®°å¿æ± ã</p>
<h3 id="33-ç¬¬äºæ­¥openclaw-b-æ ç¼æ¥å">3.3 ç¬¬äºæ­¥ï¼OpenClaw B æ ç¼æ¥å</h3>
<p>åä½çå³é®ç¹æ¥å¦ï¼æåæ¢å° OpenClaw B ççé¢ï¼<a href="http://localhost:3001" target="_blank" rel="noopener nofollow">http://localhost:3001</a>ï¼ï¼ä¸åè¯å®ä»»ä½èæ¯ä¿¡æ¯ï¼ç´æ¥é®ï¼</p>
<p><img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/759200/202602/759200-20260211181535188-621464583.png" class="lazyload"></p>
<p>OpenClaw B å¼å§å·¥ä½ï¼å¯ä»¥ææ¾çå°å®å¨âæèâââå®åè°ç¨äº MemOS çè®°å¿æ£ç´¢ï¼ç¶ååºäº A çäº§åºå¼å§æ¥åãå åéåï¼B ä¹å¼å§äº§åºäºï¼</p>
<p><img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/759200/202602/759200-20260211181812309-1096031343.gif" class="lazyload"></p>
<p>B è¿åçç»æï¼</p>
<p><img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/759200/202602/759200-20260211181559751-883019014.png" class="lazyload"></p>
<p><img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/759200/202602/759200-20260211181608565-715400049.png" class="lazyload"></p>
<p>ä»è¿åçç»æå¯ä»¥çåºï¼</p>
<ul>
<li>B æ²¡æé®æä»ä¹æ´»å¨</li>
<li>B ç´æ¥åºäº A çæ¹æ¡åäºåç»­çè¡¥ååå»¶å±</li>
<li>B çç©ææ¸åå A çè®®ç¨å®å¨å¯¹å¾ä¸ï½</li>
</ul>
<p>è¿è¯´æ MemOS çè®°å¿æ£ç´¢åæ³¨å¥æºå¶æ¯ææçï¼B ç¡®å®è¯»å°äº A çäº§åºï¼å¹¶ä¸çè§£äºå®æ´ä¸ä¸æã</p>
<h3 id="34-ç¬¬ä¸æ­¥openclaw-b-å-double-check">3.4 ç¬¬ä¸æ­¥ï¼OpenClaw B å Double-Check</h3>
<p>ä¸ºäºéªè¯ B çè´¨éææ§è½åï¼æåé®äºä¸å¥ï¼</p>
<p><img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/759200/202602/759200-20260211181722033-1477017019.png" class="lazyload"></p>
<p>B å¾å¿«ç»åºäºåé¦ï¼</p>
<p><img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/759200/202602/759200-20260211181736272-1748223910.gif" class="lazyload"></p>
<p><img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/759200/202602/759200-20260211181735960-20569556.png" class="lazyload"></p>
<p>è¿ä¸éï¼å¯ä»¥äº¤ä»äºï¼</p>
<h2 id="åææ¯åçmemos-å¦ä½å®ç°è·¨é¾è¾å±äº«">åãææ¯åçï¼MemOS å¦ä½å®ç°è·¨é¾è¾å±äº«ï¼</h2>
<p>æ´ä½ä¸¤ä¸ª OpenClaw çåä½è¿ç¨å¾é¡ºçï¼å®è£éç½®ç®åï¼èä¸èåçææ¯åçä¹ä¸é¾çè§£ãæ ¸å¿å°±æ¯ä¸é¢ä¸ç¹ï¼</p>
<ol>
<li>è®°å¿éç¦»æºå¶</li>
<li>å¬åæºå¶</li>
<li>ååæºå¶</li>
</ol>
<p><strong>è®°å¿éç¦»æºå¶</strong></p>
<p>MemOS éè¿ <code>user_id</code> åºåä¸åçè®°å¿ç©ºé´ãå¯ä»¥ç®åçè§£ä¸ºï¼</p>
<pre><code>user_id="openclaw-user"ï¼é»è®¤éç½®ï¼
  ââ OpenClaw A çå¯¹è¯è®°å½åè¾åº
  ââ OpenClaw B çå¯¹è¯è®°å½åè¾åº
  ââ ææå±äº«çä¸ä¸æ
</code></pre>
<p>ä¸¤ä¸ª OpenClaw ç¨åä¸ä¸ª <code>user_id</code>ï¼å°±è½è®¿é®åä¸ä¸ªå±äº«è®°å¿æ± ã</p>
<p><strong>å¬åæºå¶</strong></p>
<p>OpenClaw B å¯å¨åï¼MemOS å°±ä¼å¼å§é»é»å·¥ä½ãå®ä¼åæç¨æ·çé®é¢æå¾ï¼ç¶åå»å±äº«è®°å¿æ± éæ¾ãç­å®æ OpenClaw A ä¹åäº§åºçé£ä»½æ¹æ¡æåºæ¥åï¼ä¼ååä¸ªç²¾ç®ï¼ç¶åå°è¿äºè®°å¿ç´æ¥âåâç» B å½ä½èæ¯ç¥è¯ï¼ä¸ä¸æï¼ãè¿æ ·ä¸æ¥ï¼<strong>B å°±ä¸åæ¯æ¯æ¬¡é½å¤±å¿çç¶æï¼èæ¯åºäº A çå·¥ä½ææç»§ç»­å¹²</strong>ã</p>
<p>è¿ä¸ªè¿ç¨å®ç°äºå®å¨èªå¨ï¼ä¸åéè¦äººå·¥å¹²é¢æå¤å¶ç²è´´ã</p>
<p><strong>ååæºå¶</strong></p>
<p>OpenClaw A å B çäº§åºé½ä¼èªå¨åå MemOSï¼åæ¶ï¼æ ¹æ® MemOS å®æ¹ææ¡£è¯´æï¼<strong>ä¸éè¦æå¨ä¿å­ãä¸éè¦æå®å­å¨æ ¼å¼èªå¨åç±»åç´¢å¼ä¸æ¯æåç»­æ£ç´¢</strong>ã</p>
<p>è¿å°±æ¯ä¸ºä»ä¹ B è½è¯»å° A çäº§åºââå ä¸º A çæ¯æ¬¡å¯¹è¯é½èªå¨å­è¿äº MemOS çè®°å¿æ± ã</p>
<h2 id="äºæå">äºãæå</h2>
<p>å¨è·éäºä¸¤ä¸ª OpenClaw èªå¨åä½åï¼æå¼å§æèè¿å¥æ¹æ¡éåä»ä¹åºæ¯ãæä»ä¹å±éã</p>
<p>ä» OpenClaw çç«åï¼å¯ä»¥çå°ä¸ä¸ªè¶å¿ï¼å°±æ¯æªæ¥æ´å¤çåºæ¯ä¼åæäºå¤ä¸ªæºè½ä½/AI ååï¼å¦ä½ç®¡çè®©å®ä»¬æ´å¥½å°é«æåä½æä¸ºäºè¿ä¸ªé¶æ®µå¤§å®¶æ¢è®¨æå¤çé®é¢ã</p>
<p>æçå°çå¾å¤åºæ¯é½å·²ç»å¼å§æ¶ç°äºå¯¹åºçéæ±ï¼</p>
<ol>
<li><strong>å¤ä¸ª ð¦ åä½</strong>ï¼åæ + æ§è¡ãåç«¯ + åç«¯ãææ¯ + è¿è¥ï¼éè¦åå·¥ä½åè¦ä¿¡æ¯åæ­¥çåºæ¯ã</li>
<li><strong>å¼æ­¥å·¥ä½æµ</strong>ï¼A ä»å¤©äº§åºæ¹æ¡ï¼B æå¤©æ¥åæ§è¡ãä¸éè¦åæ¶å¨çº¿ï¼è®°å¿ä¼æä¹åä¿å­ã</li>
<li><strong>å¤äººé¡¹ç®</strong>ï¼æç OpenClaw è´è´£ä¸é¨åï¼åäºç OpenClaw è´è´£å¦ä¸é¨åï¼éè¿åä¸ä¸ª <code>user_id</code> å±äº«ä¸ä¸æã</li>
</ol>
<p>ç»åè¿äºåºæ¯ï¼åçåºäº MemOS çæ¹æ¡ï¼è¿æ¯æä¸äºæ¹è¿ç©ºé´ï¼</p>
<ol>
<li>åä¸ä¸ªè´¦å·ï¼user_idï¼ï¼ç®åä¸æ¯ææ´çµæ´»çæéæ§å¶ï¼æ¯å¦ A å¯ä»¥è¯» B çè¾åºï¼ä½ B ä¸è½ä¿®æ¹ A çè®°å¿ã</li>
<li>è®°å¿æ£ç´¢ç²¾åº¦ï¼B è½å¦åç¡®è¯»å° A çäº§åºï¼åå³äº MemOS çæ£ç´¢ç®æ³ãææµè¯ä¸æ¥åç¡®çè¿ä¸éï¼ä½å¤æåºæ¯å¯è½éè¦è°æ´æ£ç´¢åæ°ã</li>
<li>å¤ç¨æ¨¡æ¿ï¼æ¯æå°å¥½ç¨çæ¡ä¾æåæå¯å¤ç¨çæ¨¡æ¿æ Skillsï¼æ°é¡¹ç®èªå¨ç»§æ¿æä½³å®è·µã</li>
</ol>
<p>åäºè¿ä¹å¤ï¼ä¹ä¸ç¥é MemOS å®æ¹è½ä¸è½çå°ææåºçæ¹è¿ç¹ðã</p>
<p>ä½æ»ä½æ¥è¯´è¿å¥åºäº MemOS çæ¹æ¡è¿æ¯å¼å¾ä¸è¯ï¼é¨ç½²ç®åå ä¸ªå½ä»¤å°±è½è·èµ·æ¥ï¼è®©å¤ä¸ª OpenClaw ç¸äºåä½ 24/7 æäºå¿ã</p>
<p>è½è¯´è¿ææåç©ºé´ä½ä¹ç®æ¯ä¸å¥å¿«éæç®ç OpenClaw åä½æ¹æ¡ï¼æè§å¾è¿æºæææçã</p>
<ul>
<li>MemOS å®ç½ï¼<a href="https://memos.openmem.net/" target="_blank" rel="noopener nofollow">memos.openmem.net</a></li>
<li>GitHubï¼<a href="https://github.com/MemTensor/MemOS" target="_blank" rel="noopener nofollow">github.com/MemTensor/MemOS</a></li>
<li>MemOS æä»¶ï¼<a href="https://github.com/MemTensor/MemOS-Cloud-OpenClaw-Plugin" target="_blank" rel="noopener nofollow">github.com/MemTensor/MemOS-Cloud-OpenClaw-Plugin</a></li>
<li>OpenClaw ææ¡£ï¼<a href="https://docs.openclaw.ai/" target="_blank" rel="noopener nofollow">docs.openclaw.ai</a></li>
</ul>
<p>æåï¼å¼å¯æ¥èåææ¨¡å¼ï¼è®© OpenClaw å¸®ä½ å¹²æ´»å§ï¼</p>


</div>
<div id="MySignature" role="contentinfo">
    <div>    
    <p style="border-top: #e0e0e0 1px dashed; border-right: #e0e0e0 1px dashed; border-bottom: #e0e0e0 1px dashed; border-left: #e0e0e0 1px dashed; padding-top: 5px; padding-right: 10px; padding-bottom: 10px; padding-left: 150px; background: url(https://images.cnblogs.com/cnblogs_com/xueweihan/859919/o_200924043112qrcode_for_gh_4fb030b35bb4_258.jpg) #e5f1f4 no-repeat 1% 50%; background-size:130px 130px;font-family: å¾®è½¯éé»; font-size: 13px" id="PSignature">
    <br>
    ä½èï¼<a href="https://github.com/521xueweihan" target="_blank">åå¾®å¯</a>

    <br>
    <strong>æ«æå·¦ä¾§çäºç»´ç å¯ä»¥èç³»å°æ</strong>
    <br>

    <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh"><img alt="ç¥è¯å±äº«è®¸å¯åè®®" style="border-width: 0" src="https://licensebuttons.net/l/by-nc-nd/4.0/88x31.png"></a><br>æ¬ä½åéç¨<a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh">ç½²å-éåä¸æ§ä½¿ç¨-ç¦æ­¢æ¼ç» 4.0 å½é </a>è¿è¡è®¸å¯ã
    </p>
</div>
</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.004861111111111111" data-date-updated="2026-02-12 08:34">2026-02-12 08:27</span>&nbsp;
<a href="https://www.cnblogs.com/xueweihan">åå¾®å¯</a>&nbsp;
éè¯»(<span id="post_view_count">115</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19605642);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19605642', targetLink: 'https://www.cnblogs.com/xueweihan/p/19605642', title: 'æè£äºä¸ªæä»¶ï¼è®©ä¸¤ä¸ª OpenClaw å¼å§ 24/7 æäºæäº' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ ç§ææ´»å¨æ¶ç³»ç»å¨å¹²ä»ä¹ PHP é«å¹¶ååºæ¯ä¼åæå ]]></title>
    <link>https://www.cnblogs.com/catchadmin/p/19606652</link>
    <guid>001b8213fbb2fb9b8bcc952e54b74442</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/catchadmin/p/19606652" title="åå¸äº 2026-02-12 07:44">
    <span role="heading" aria-level="2">ç§ææ´»å¨æ¶ç³»ç»å¨å¹²ä»ä¹ PHP é«å¹¶ååºæ¯ä¼åæå</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h1 id="ç§ææ´»å¨æ¶ç³»ç»å¨å¹²ä»ä¹-php-é«å¹¶ååºæ¯ä¼åæå">ç§ææ´»å¨æ¶ç³»ç»å¨å¹²ä»ä¹ PHP é«å¹¶ååºæ¯ä¼åæå</h1>
<p>ç§ææ´»å¨æ¯çµåå¹³å°çå³é®æå½¹ï¼å¾å¾ä¼å¸¦æ¥æµéåè®¢åçå§çé£åãç§ææé´ï¼æ¯ä¸æ¯«ç§é½å¾å³é®ï¼åç«¯éè¦åæ¶æä½æµ·éè¯·æ±ãå¯¹ PHP åºç¨æ¥è¯´ï¼è¿å°¤å¶ææææ§ï¼ä½åªè¦ä¼åå°ä½ï¼å³ä½¿æµéæ´ªå³°æ¥äºï¼ç¨æ·ä½éªä¹è½ç¨³ä½ã</p>
<p>è¿ç¯æç« ä¼æè§£ PHP åç«¯å¨ç§ææé´éè¦ååªäºäºæï¼ä»æ°æ®åºæ¥è¯¢ä¼åï¼å°ç¼å­ç®¡çï¼åå°åºç¨æ©å®¹ã</p>
<h2 id="ç¨è´è½½åè¡¡åºå¯¹é«å¹¶å">ç¨è´è½½åè¡¡åºå¯¹é«å¹¶å</h2>
<p>ç§ææé´ï¼PHP åºç¨éè¦å¨ææ©å®¹æ¥æ¿æ¥æ¿å¢çæµéãè´è½½åè¡¡æ¯æè¯·æ±åæ£å°å¤å°æå¡å¨çæ ¸å¿ææ®µã</p>
<h3 id="è´è½½åè¡¡--èªå¨æ©å®¹">è´è½½åè¡¡ + èªå¨æ©å®¹</h3>
<p>æµéæ´æ¶¨æ¶ï¼PHP åºç¨åºè¯¥é¨ç½²å¨è´è½½åè¡¡å¨ï¼æ¯å¦ AWS ELB æ NGINXï¼åé¢ï¼ç±è´è½½åè¡¡å¨æè¯·æ±ååååå°å¤å°åºç¨æå¡å¨ã</p>
<p>å·¥ä½åçï¼</p>
<ul>
<li><strong>PHP-FPM å·¥ä½è¿ç¨</strong>ï¼æ¯å° PHP æå¡å¨éè¿ PHP-FPMï¼FastCGI è¿ç¨ç®¡çå¨ï¼å¤çè¯·æ±ãè´è½½åè¡¡å¨ç¡®ä¿è¯·æ±è¢«åæ£å°å¤å°æå¡å¨ï¼é¿ååå°æå¡å¨è¢«æå®ã</li>
<li><strong>èªå¨æ©å®¹</strong>ï¼æµéä¸æ¥åï¼AWS EC2 Auto Scaling æ Google Cloud Compute Engine ç­äºæå¡ä¼èªå¨æèµ·æ´å¤ PHP å®ä¾æ¥æ¿æ¥è´è½½ã</li>
</ul>
<p><strong>éç½®èªå¨æ©å®¹</strong>ï¼å½ CPU ä½¿ç¨çæè¯·æ±éè¶è¿éå¼æ¶è§¦åæ©å®¹ã</p>
<pre><code class="language-bash">aws autoscaling create-auto-scaling-group \
  --auto-scaling-group-name php-flash-sale-group \
  --min-size 2 --max-size 50 --desired-capacity 10 \
  --vpc-zone-identifier subnet-xyz
</code></pre>
<p><strong>è´è½½åè¡¡å¨éç½®</strong>ï¼ç¡®ä¿è¯·æ±è¢«é«æå°ååå°ææ PHP æå¡å¨ã</p>
<pre><code class="language-nginx">upstream php_backend {
    server php-server-1;
    server php-server-2;
    server php-server-3;
}
server {
    location / {
        proxy_pass http://php_backend;
    }
}
</code></pre>
<p>éè¿è´è½½åè¡¡å èªå¨æ©å®¹ï¼PHP åç«¯å¯ä»¥å¹³æ»å°åºå¯¹ç§ææé´çæµéæ´ªå³°ã</p>
<h2 id="ç¼å­ç­ç¥åè½»æ°æ®åºåå">ç¼å­ç­ç¥ï¼åè½»æ°æ®åºåå</h2>
<p>ç§ææé´æå¤§çææä¹ä¸ï¼å°±æ¯é²æ­¢æ°æ®åºå ä¸ºå¤§éè¯»åæä½åæç¶é¢ãæææçææ®µæ¯ç¨ç¼å­æ¥åææ°æ®åºæ¥è¯¢ï¼åæ¶æåååºéåº¦ã</p>
<h3 id="ç¼å­éæåå®¹åæ°æ®åºæ¥è¯¢">ç¼å­éæåå®¹åæ°æ®åºæ¥è¯¢</h3>
<p><strong>CDN ç¼å­éæèµæº</strong></p>
<p>å¾çãCSSãJavaScript è¿ç±»éæèµæºåºè¯¥éè¿ CDNï¼æ¯å¦ Cloudflare æ AWS CloudFrontï¼å¨è¾¹ç¼èç¹ç¼å­ï¼ä¿è¯ç¨æ·è½å¿«éå è½½ãå¨ PHP ä¸­è®¾ç½®åéçç¼å­æ§å¶å¤´ï¼</p>
<pre><code class="language-php">header("Cache-Control: public, max-age=3600");  // Cache static assets for 1 hour
</code></pre>
<p><strong>åå­ç¼å­ç­ç¹æ°æ®</strong></p>
<p>ç¨ Redis æ Memcached ç¼å­é¢ç¹æ¥è¯¢çæ°æ®ï¼æ¯å¦åååºå­åä»·æ ¼ï¼åå°æ°æ®åºååã</p>
<p>ç§ææé´ï¼æåååºå­ç¶æå­å° Redis éï¼æ¯æ¬¡æ¥åºå­å°±ä¸ç¨ææ°æ®åºäºï¼</p>
<pre><code class="language-php">$redis = new Redis();
$redis-&gt;connect('localhost', 6379);
// Check if product availability is cached
$productId = 123;
$productAvailability = $redis-&gt;get("product:{$productId}:availability");
if (!$productAvailability) {
    // Cache miss, fetch from database
    $productAvailability = fetchProductAvailabilityFromDb($productId);
    $redis-&gt;set("product:{$productId}:availability", $productAvailability, 3600);  // Cache for 1 hour
}
</code></pre>
<p>è¿æ ·å¯ä»¥å¤§å¹åå°ç§ææé´çæ°æ®åºæ¥è¯¢æ¬¡æ°ï¼ç¨æ·çååºéåº¦ä¹æ´å¿«ã</p>
<h2 id="ä¼åæ°æ®åºæ§è½">ä¼åæ°æ®åºæ§è½</h2>
<p>æ°æ®åºæ§è½å¾å¾æ¯ç§æåºæ¯çç¶é¢æå¨ï¼ç¹å«æ¯å¤§éè¯·æ±åæ¶è¯»åæ°æ®åºçæ¶åãä¼åæ¥è¯¢ãç¡®ä¿ PHP åºç¨é«æå¤çæ°æ®åºæä½è³å³éè¦ã</p>
<h3 id="ååºåè¡¨">ååºåè¡¨</h3>
<p>ååºåè¡¨æ¯ææ°æ®åºæåææ´å°ãæ´æç®¡ççé¨åï¼æ¯ä¸ªé¨ååªå¤çä¸é¨åæ°æ®ï¼ä»èææ¥è¯¢åæ£å°å¤ä¸ªæ°æ®åºå®ä¾ä¸ã</p>
<p>æ¯å¦å¯ä»¥æç¨æ·å°åºååºï¼åç¾ç¨æ·åæ¬§æ´²ç¨æ·åç¨ä¸å¥æ°æ®åºï¼ï¼ä»¥æ­¤åè¡¡è´è½½ã</p>
<h3 id="è¿æ¥æ± ">è¿æ¥æ± </h3>
<p>æ¯æ¬¡è¯·æ±é½å¼å³æ°æ®åºè¿æ¥ä¼å¸¦æ¥å¾å¤§çå¼éãéè¿è¿æ¥æ± å¤ç¨æ°æ®åºè¿æ¥ï¼å¯ä»¥æ¾èéä½è¿é¨åæ¶èãå¨ PHP ä¸­ï¼å¯ä»¥éç½®æä¹è¿æ¥ï¼</p>
<pre><code class="language-php">$mysqli = new mysqli("p:localhost", "username", "password", "database");
</code></pre>
<h3 id="è¯»ååç¦»">è¯»ååç¦»</h3>
<p>å¦æç¨äºæ°æ®åºä¸»ä»å¤å¶ï¼æ¯å¦ MySQL Replicationï¼ï¼å¯ä»¥éç½® PHP åºç¨æè¯»æ¥è¯¢åå°ä»åºï¼åæ¥è¯¢åå°ä¸»åºï¼</p>
<pre><code class="language-php">$readDb = new mysqli('read-replica-host', 'username', 'password', 'database');
$writeDb = new mysqli('primary-db-host', 'username', 'password', 'database');
</code></pre>
<h3 id="æ¥è¯¢ä¼å">æ¥è¯¢ä¼å</h3>
<p>ç§ææé´è¦ç¡®ä¿æ°æ®åºæ¥è¯¢ç»è¿ä¼åï¼å¯¹é«é¢æ¥è¯¢å­æ®µï¼æ¯å¦åå IDãåç±»ç­ï¼å»ºå¥½ç´¢å¼ãå¨ PHP ä¸­ä½¿ç¨é¢å¤çè¯­å¥å¯ä»¥æåæ¥è¯¢æ§è¡æçï¼</p>
<pre><code class="language-php">$stmt = $mysqli-&gt;prepare("SELECT * FROM products WHERE id = ?");
$stmt-&gt;bind_param("i", $productId);
$stmt-&gt;execute();
$result = $stmt-&gt;get_result();
$product = $result-&gt;fetch_assoc();
</code></pre>
<p>éè¿ååºåè¡¨ãè¿æ¥æ± ãè¯»ååç¦»åæ¥è¯¢ä¼åï¼å¯ä»¥é²æ­¢æ°æ®åºæä¸ºç¶é¢ï¼ä¿è¯ PHP åºç¨å¨ç§æè¿ç§é«å¹¶ååºæ¯ä¸ä¾ç¶è·å¾å¨ã</p>
<h2 id="ä¼è¯ç®¡çåç¨æ·è®¤è¯">ä¼è¯ç®¡çåç¨æ·è®¤è¯</h2>
<p>ç§ææé´ï¼ç¨æ·è½ä¸è½é¡ºå©å è´­ãç»è´¦ãç»å½ï¼ç´æ¥å³å®äºè½¬åçãä¼è¯ç®¡çå¿é¡»éå¯¹é«å¹¶ååä¼åã</p>
<h3 id="ç¨-redis-åä¼è¯æä¹å">ç¨ Redis åä¼è¯æä¹å</h3>
<p>ç¨ Redis å­å¨ä¼è¯æ°æ®ï¼è¿æ ·å³ä½¿è¯·æ±è¢«è´è½½åè¡¡å¨ååå°ä¸åç PHP æå¡å¨ä¸ï¼ä¼è¯ä¹ä¸ä¼ä¸¢å¤±ï¼</p>
<pre><code class="language-php">// Store session data in Redis
session_set_save_handler(new RedisSessionHandler($redis), true);
session_start();
</code></pre>
<h3 id="ç¨-jwt-åæ ç¶æè®¤è¯">ç¨ JWT åæ ç¶æè®¤è¯</h3>
<p>ç¨æ·ç»å½åè®¤è¯ç¯èï¼å¯ä»¥ç¨ JWTï¼JSON Web Tokenï¼æ¥åè½»ä¼è¯å­å¨çååï¼å®ç°æ ç¶æè®¤è¯ï¼</p>
<pre><code class="language-php">// Example of generating JWT token
$payload = ['user_id' =&gt; $userId, 'exp' =&gt; time() + 3600];  // Expires in 1 hour
$jwt = JWT::encode($payload, $secretKey);
</code></pre>
<p>æä¼è¯æ°æ®äº¤ç» Redisï¼è®¤è¯ç¯èç¨ JWTï¼å°±è½ä¿è¯ç§ææé´çç»å½åä¼è¯ç®¡çåå¿«åç¨³ã</p>
<h2 id="å®æ¶åºå­ç®¡ç">å®æ¶åºå­ç®¡ç</h2>
<p>ç§ææé´ï¼åºå­å¿é¡»éçååå®åºå®æ¶æ´æ°ãPHP éè¦ç¡®ä¿åºå­æ°æ®å¨å¤å°æå¡å¨ä¹é´ä¿æåæ­¥ï¼ä¸æ¦æäººä¸åï¼åºå­ç«å»æ£åã</p>
<h3 id="äºä»¶é©±å¨æ¶æå¤çåºå­æ´æ°">äºä»¶é©±å¨æ¶æå¤çåºå­æ´æ°</h3>
<p>éè¿ Apache Kafka æ RabbitMQ å®ç°äºä»¶é©±å¨æ¶æï¼å®æ¶å¤çåºå­åæ´ï¼</p>
<pre><code class="language-php">// Kafka Producer: Send product purchase events
$producer-&gt;produce('product-purchased-topic', 0, json_encode(['product_id' =&gt; 123, 'quantity' =&gt; 1]));
</code></pre>
<p>åºå­æå¡è®¢éè¿äºäºä»¶ï¼å®æ¶æ´æ°æ°æ®åºä¸­çåååºå­ãç¨æ·ä¸ååï¼è´­ä¹°äºä»¶åéå° Kafkaï¼åºå­æå¡æ¶å°äºä»¶åç«å³æ£ååºå­ï¼å¶ä»ç¨æ·å°±ä¸ä¼åä¹°å°å·²ç»åå®çååã</p>
<h2 id="æ»ç»">æ»ç»</h2>
<p>ç§ææé´ä¿è¯ PHP åºç¨çæ§è½ï¼éè¦å¤ç®¡é½ä¸ï¼è´è½½åè¡¡ãç¼å­ãæ°æ®åºä¼åãå®æ¶åºå­ç®¡çï¼ç¼ºä¸ä¸å¯ãéè¿èªå¨æ©å®¹ãRedis åå­ç¼å­ãé«æçæ°æ®åºæ¥è¯¢åäºä»¶é©±å¨æ¶æï¼PHP åºç¨å®å¨æè½åæä½æµéæ´ªå³°ï¼ç»ç¨æ·æä¾æµççä½éªã</p>
<p>æè¿äºææ®µç¨å¥½ï¼ä½ ççµåå¹³å°å°±è½é¡¶ä½ç§æçååï¼ä¸å®æºãä¸å¡é¡¿ï¼æè½¬åçæå°æé«ã</p>
<p><a href="https://catchadmin.com/post/2026-02/php-problem-isnt-language" target="_blank" rel="noopener nofollow">ç§ææ´»å¨æ¶ç³»ç»å¨å¹²ä»ä¹ PHP é«å¹¶ååºæ¯ä¼åæå</a></p>


</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-02-12 07:44">2026-02-12 07:44</span>&nbsp;
<a href="https://www.cnblogs.com/catchadmin">JaguarJack</a>&nbsp;
éè¯»(<span id="post_view_count">22</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19606652);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19606652', targetLink: 'https://www.cnblogs.com/catchadmin/p/19606652', title: 'ç§ææ´»å¨æ¶ç³»ç»å¨å¹²ä»ä¹ PHP é«å¹¶ååºæ¯ä¼åæå' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ [æè§£LangChainæ§è¡å¼æ] Channelââé©±å¨Nodeæ§è¡çåå ]]></title>
    <link>https://www.cnblogs.com/jaydenai/p/19605973/channel-of-pregel</link>
    <guid>24f8e8f78380c8b592a5ef96c9242a0a</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/jaydenai/p/19605973/channel-of-pregel" title="åå¸äº 2026-02-12 06:28">
    <span role="heading" aria-level="2">[æè§£LangChainæ§è¡å¼æ] Channelââé©±å¨Nodeæ§è¡çåå</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                    <div id="cnblogs_post_description" style="display: none">
        
        Pregelç±NodeåChannelè¿ä¸¤ä¸ªæ ¸å¿é¨ä»¶ç»æï¼Channelä¸ä»ç»´æ¤äºæ´ä¸ªå¾çç¶æï¼è¿æ¯é©±å¨Nodeæ§è¡ç âååâ ã
    </div>
<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<p>Pregelç±NodeåChannelè¿ä¸¤ä¸ªæ ¸å¿é¨ä»¶ç»æï¼Channelä¸ä»ç»´æ¤äºæ´ä¸ªå¾çç¶æï¼è¿æ¯é©±å¨Nodeæ§è¡ç âååâ ãå¨åé¢æ¼ç¤ºçä¸ç³»åå®ä¾ä¸­ï¼æä»¬å·²ç»ä½¿ç¨äºä¸ç§Channelç±»åï¼åæ¬é¢ç¹ä½¿ç¨çLastValueï¼è½å¤å°æææ·»å çå¼ä¿çä¸æ¥çBinaryOperatorAggregateï¼ä»¥åå¸®å©æä»¬è½»æ¾è§£å³å¤Nodeä¾èµé®é¢çNamedBarrierValueãä¸ºä»ä¹Channelæè¿ä¹å¤ç±»åï¼æä»¬åºè¯¥å¨ä½ç§åºæ¯ä¸­ä½¿ç¨ä½ç§ç±»åçChannelï¼è¦åç­è¿ä¸ªé®é¢ï¼å°±æ æ³åé¿ï¼BSPï¼Bulk Synchronous Parallelï¼è¿ä¸ä¸ªç®æ³æ¨¡å¼ï¼æ¯«ä¸å¤¸å¼ å°è¯´ï¼æ´ä¸ªPregelå°±æ¯å´ç»BSPè¿è¡è®¾è®¡çã</p>
<h2 id="1-bsp">1. BSP</h2>
<p>æä»¬ç¥éä¸ä¸ªAgentå©ç¨ä½ä¸ºå³ç­èçLLMåä¸ç³»åä½ä¸ºæ§è¡èçToolåå©å®ææå®çä»»å¡ãLLMï¼è¿éä¸»è¦æåºäºææ¬çæçGPTï¼ç±äºå¶éTokenççææºå¶ï¼å ä¸åç§å·¥å·å¯è½æ¶åå°å¤§æ°æ®çå¤çãIOè¯»åãè·¨ç½ç»çäº¤äºç­èæ¶æä½ï¼æä»¥è¦ç¡®ä¿Agentè½å¤æä¾å¯æ¥åçæ§è½ä¿éï¼å¹¶è¡è®¡ç®æ¯å¯ä¸çè§£å³æ¹æ¡ãèèå°å¯¹å¹¶è¡è®¡ç®ç âé¢éâ ï¼é£ä¹Pregelä¸ºä»ä¹éæ©Actoræ¨¡åæ¥å®ç°ä¹å°±å¾å®¹æçè§£äºï¼å ä¸ºé«å¹¶åæ­£å¼Actoræ¨¡åææé¿çé¢åãBSPä¸­çBPï¼Bulk Parallelï¼å¯ä»¥çè§£ä¸ºPregelå¤ä¸ªNodeå¨åä¸æ¶æ®µçå¹¶è¡æ§è¡ï¼é£ä¹Sï¼Synchronousï¼æä½ä½çè§£å¢ï¼</p>
<p>å¨å¾å¤å¸åçActoræ¨¡åéï¼Actorå¤§å¤æ¯æç¶æçï¼ä½æ¯ä½ä¸ºPregelçActorï¼å¶Nodeå¯¹è±¡æ¯å®å¨æ ç¶æçãå¼å§æ§è¡ä¹åï¼ä»ä»æ³¨åçChannelè¯»åæ°æ®ï¼æ§è¡ç»æä»¥æç»è¾åºå°ç¸åºçChannelãæä»¬ç¥éé«å¹¶åãä½å»¶æ¶åæ°æ®ä¸è´æ§æ¯ä¸ä¸ªæ°¸è¿ä¸å¯è½åæ¶å¼é¡¾çææ ï¼å¦æè¦å¼é¡¾å¶ä¸­ä¸¤ä¸ªï¼å°±ä¸å¾ä¸çºç²ç¬¬ä¸ä¸ªãå¤§é¨åç³»ç»çæ¶æä¸è®¾è®¡é½æ¯å¨å¯¹ä¸èä½ä¸ä¸ªå¹³è¡¡ï¼Pregeläº¦æ¯å¦æ­¤ã</p>
<p>ç±äºå¤ä¸ªå¹¶è¡æ§è¡çNodeä¼æ¶åéå¯¹åä¸ä»½æ°æ®ï¼Channelï¼çè¯»åï¼å¦æè¦ä¿è¯æ°æ®çå®æ´æ§ï¼å°±ä¸å¾ä¸æ½å ç¸åºçåæ­¥æºå¶ï¼æ¯å¦åç§ä¸åç±»åçéãä¸è®ºå¤è½»éçº§çéï¼å®ä»¬é½æ¯é«å¹¶åæå¼ºçææï¼é£ä¹è½å¦å®ç°æ éçè§£å³æ¹æ¡å¢ï¼BSPå°±æ¯ç­æ¡ï¼èè¿å¶ä¸­åæ¶åä¸ä¸ªåä¸ºSuperstepï¼Super Stepï¼ç±äºè¿ä¸ä¸ªæ¦å¿µä¼é¢ç¹æåï¼åç»­åå®¹ç´æ¥å°Superstepè§ä¸ºä¸ä¸ªä¸æåè¯æ¥æä»£è¿ä¸ä¸ªæ¦å¿µï¼çæ¦å¿µï¼æä»¬å¯ä»¥å°å¶è§ä¸ºæ´ä¸ªå¾ææ¡ä¸ç´ååæ¨è¿çä¸ä¸ªåæ­¥ï¼æ¯Pregelæ§è¡å¼æçä¸ä¸ªèå²ï¼æ¯ææNodeæ§è¡çâèæâï¼æ¯ä¸ªSuperstepå·æä¸ä¸ªèªå¢çåºå·ã</p>
<p>å¨æ¯ä¸ªSuperstepç»æä¹åï¼æ¯ä¸ªChannelçç¶æè¢«åºå®ä¸æ¥ï¼å¼ææ ¹æ®Nodeéå¯¹Channelçè®¢éåChannelå¨å½åSuperstepåçæ´æ°æåµç¡®å®å¨ä¸ä¸Superstepéè¦æ§è¡çNodeï¼å¹¶ä¸ºå®ä»¬åå»ºåå»ºç¸åºçä»»å¡ãè¿äºä»»å¡å¨æ°çSuperstepå¼å§æ¯å¹¶åæ§è¡ï¼èä¸å®ä»¬åªè½è®¿é®åä¸è¶æ­¥åºåä¸æ¥çå¼ãè¿ä¸ç­ç¥ç¡®ä¿è¾å¥çä¸è´æ§ï¼ä¿è¯ææå¹¶åæ§è¡çNodeæè§çç¶æé½æ¯ä¸æ ·çï¼å¦ä¸æ¹é¢Channelå¨Superstepåä¿æåªè¯»ç¶æå°±å®å¨ä¸ç¨èèå¹¶åèè¯»çé®é¢äºã</p>
<p>å¹¶åæ§è¡çNodeä¸åè®¸å¯¹ä»»ä½Channelå®æ½åå¥ï¼å®åªè½å°åå¥è¯æ±æäº¤ç»æ§è¡å¼æï¼åèæç§æäº¤çé¡ºåºå­å¨ä¸æ¥ãè®©ææä»»å¡æåæ§è¡åï¼Superstepè¿å¥ä¸ä¸ªåæ­¥å±éï¼æ§è¡å¼æå°å¯¹æ¶éå°çChannelåå¥è¯·æ±æç§é¡ºåºç»ä¸åºç¨ï¼ä½¿ææChannelæç»è½åç¡®å°ä½ç°Superstepç»æåçç¶æãç¶ååç¡®å®ä¸ä¸Superstepçä»»å¡ï¼å¦æ­¤åå¤ï¼å¨èå¤å§ã</p>
<p>ç¬¬ä¸ä¸ªSuperstepçåºå·æ¯ä»-1å¼å§è®¡æ°çï¼è¿ä¸ªæè°çâåä¸è¶æ­¥âå¼å§äºéå¯¹Pregelåç°çå¸¸è§è°ç¨ï¼å¼æå©ç¨è¿ä¸Superstepå°åå§è¾å¥åå¥å¯¹åºçChannelï¼å¹¶è®¡ç®éè¦å¨Superstep 0ä¸­æ§è¡çä»»å¡ï¼æä»¥Nodeçé¦æ¬¡æ§è¡æ¯å¨Superstep 0ä¸­æ§è¡çã</p>
<p>ç±äºAgentå¯ä»¥æ¶åä¸ä¸ªéè¦é¿æ¶é´æ§è¡çå¤çæµç¨ï¼èä¸è¿ä¸ªè¿ç¨è¿å¯è½åºç°ä¸­æ­ï¼æ­¤ä¸­æ­å¯è½æ¯ç±äºç³»ç»æéï¼ä¹å¯è½æ¯éè¦è®¤ä¸ºä»å¥å¯¼è´ï¼æä»¥Agentçç¶æä¸å¯è½å¸¸é©»åå®¹ãèä¸Agentè¿æä¾äº âæ¶é´æè¡â çåè½ï¼è¿ä¸ä¸ªåè½ä½¿æä»¬ä»è¿å»çæä¸ªæ¶é´ç¹å¼å¯ä¸ä¸ªæ°çåæ¯æ¥æ§è¡æµç¨ï¼è¿ç¸å½äºå¼å¯ä¸ä¸ª âå¹³è¡ä¸çâ ãææçè¿ä¸åé½ç¦»ä¸å¼éå¯¹ç¶æçæä¹åï¼è¿æ¯æ´ä¸ªPregelæå¤æçé¨åã</p>
<p>æä»¬å°å¨åç»­åå®¹è¯¦ç»ä»ç»Pregeléå¯¹ç¶ææä¹åçè®¾è®¡ä¸å®ç°ï¼è¿éæä»¬åä¸ä¸ªæ¦æ¬æ§ä»ç»ãå½Superstepè¿å¥åæ­¥å±éä¹åï¼æä¹ååçå¨ âè§£æå¾æ§è¡ä»»å¡â ä¹åï¼æ­¤æ¶å¼æä¼éå¯¹å½åChannelçç¶æåå»ºä¸ä»½åä¸ºCheckpointå¿«ç§å¹¶å©ç¨æ³¨åçCheckpointerè®°å½ä¸æ¥ã</p>
<p>æ¯ä¸ªè¢«è®°å½çCheckpointä¸ä»å·æä¸ä¸ªå¯ä¸æ è¯ï¼è¿ç»è®°äºå½åçSuperstepåºå·ï¼è¿æä¸ä¸ªè½å¤ç²¾ç¡®æè¿°å½åAgentå¯¹åºçå¾å¨æ´ä¸ªæ§è¡å¾ä¸­çä½ç½®ï¼å¤Agentåºç¨ä¸­ï¼ä¸ä¸ªAgentå¯ä½ä¸º âå­Agentâ è¢«è°ç¨ï¼å¯¹åºçå¾å°±æ¯æ´å¼ æ§è¡å¾ç âå­å¾â ï¼åè°ç¨é¡ºåºç âå½åç©ºé´â ãå®æ´çæ è¯ä½ç³»çå¯ä¸å·¦å³å°±æ¯ï¼å¨Agentä»æä¸ªç¹æ¢å¤æ§è¡çæ¶åï¼ç¸åºçCheckpointerè½å¤åç¡®å°æåå¯¹åºçCheckpointæ¥ âæ¢å¤ç°åºâ ãä¸å¾åºæ¬åæ äºPregeléå¯¹åä¸Superstepçæ§è¡æµç¨ã</p>
<p><img alt="image" loading="lazy" data-src="https://img2024.cnblogs.com/blog/3765958/202602/3765958-20260211205807856-904401689.png" class="lazyload"></p>
<p>ä½æ¯å¾å¤ææ¡£ä¸­ä½ çå°ä»ä»¬å°Superstepååä¸ºâè®¡åâãâæ§è¡âãâæ´æ°âåâæä¹åâï¼çèµ·æ¥åçï¼ä½æ¯åçæ­£çæ§è¡æµç¨æ¯æåºå¥çãè®¡åé¶æ®µå¾å°å¶å®ä¸æ¯å½åSuperstepå¾æ§è¡çä»»å¡ï¼èæ¯ä¸ä¸Superstepå¾æ§è¡çä»»å¡ï¼å ä¸ºè¿æè¿æ ·éç¨è§£éä¸ºä»ä¹éå¯¹Superstep -1çCheckpointä¼åå«ä»»å¡åè¡¨ï¼è¿äºä»»å¡åææ¯å¨Superstep 0ä¸­æä¼è¢«æ§è¡ãå®éä¸Checkpointä¸­çä»»å¡åè¡¨åæ çé½æ¯ä¸ä¸Superstepå¾æ§è¡çæä½ï¼æä»¥å¯ç¬æåä¸ä¸ªCheckpointæä¸ä¼å­å¨ä»»å¡åè¡¨ãè¡¨ç¤ºç¶æå¿«ç§çStateSnapshotå°è¿åä»»å¡åç§°åè¡¨çå­æ®µå½åä¸ºnextï¼ææ³ä¹åºè¯¥æ¯å¤äºè¿ä¸ªåå ã</p>
<h2 id="2-basechannel">2. BaseChannel</h2>
<p>ææçChannelç±»åé½æ´¾çäºå¦ä¸è¿ä¸ªåä¸ºBaseChannelçæ½è±¡ç±»ï¼å®çæ³åç±»ååæ°ValueåUpdateåå«è¡¨ç¤ºå­å¨ç±»åãæ´æ°æ¶æä¾çå¼ç±»åï¼æä»¬å¯ä»¥å©ç¨å±æ§ValueTypeåUpdateTypeè·ååä¸¤ç§ç±»åãæ½è±¡æ¹æ³getåupdateæä¾éå¯¹è¿ä¸¤ä¸ªç±»åçè¯»å,updateæ¹æ³è¿åçå¸å°å¼è¡¨ç¤ºæ¯å¦å·æå®è´¨æ§çæ´æ°ï¼å¼æç±æ­¤å¤æ­Channelçå¼æ¯å¦åçæ¹åãå¦ä¸ä¸ªæ³åç±»ååæ°Checkpointä¸æä¹åæå³ï¼å¼æå¨æ¢å¤æ§è¡æ¶ä¼ä»æä¹åçå¿«ç§ä¸­æåå¯¹åºçæ°æ®å¹¶å°å¶è½¬æ¢ææ­¤å¯¹è±¡ï¼æç»è°ç¨from_checkpointæ¹æ³æ¢å¤Channelçç¶æï¼å¨è¿è¡æä¹åæ¶ï¼å¼æä¼è°ç¨checkpointæ¹æ³å°èªèº«çç¶æè½¬æ¢æè¯¥ç±»åï¼å¹¶æäº¤ç»Checkpointerå®æ½æä¹åã</p>
<pre><code class="language-python">Value = TypeVar("Value")
Update = TypeVar("Update")
Checkpoint = TypeVar("Checkpoint")

class BaseChannel(Generic[Value, Update, Checkpoint], ABC):
    __slots__ = ("key", "typ")
    def __init__(self, typ: Any, key: str = "") -&gt; None

    @property
    @abstractmethod
    def ValueType(self) -&gt; Any
    @property
    @abstractmethod
def UpdateType(self) -&gt; Any
    
    @abstractmethod
def get(self) -&gt; Value
    @abstractmethod
def update(self, values: Sequence[Update]) -&gt; bool

    @abstractmethod
def from_checkpoint(self, checkpoint: Checkpoint | Any) -&gt; Self
def checkpoint(self) -&gt; Checkpoint | Any

    def copy(self) -&gt; Self    
    def consume(self) -&gt; bool
    def finish(self) -&gt; bool	
    def is_available(self) -&gt; bool 
</code></pre>
<p>é¤æ­¤ä¹å¤ï¼BaseChannelè¿å®ä¹äºå¶ä»å ä¸ªæ¹æ³ï¼å¶ä¸­copyæ¹æ³ä¼æ ¹æ®èªèº«ç¶æåå»ºä¸ä¸ªæ°Channelå¯¹è±¡ï¼é»è®¤å®ç°ä¼åè°ç¨checkpointæ¹æ³ï¼ç¶åå°è¿åå¼ä½ä¸ºåæ°è°ç¨from_checkpointæ¹æ³ï¼åèè°ç¨çç»æå°±æ¯copyæ¹æ³çè¿åå¼ï¼æä»¥è¿æ¯ä¸ä¸ªæ·±æ·è´ãå¨ææä»»å¡æ§è¡å®æåï¼è§¦åå®ä»¬çææChannelçconsumeæ¹æ³ä¼è¢«æ§è¡ï¼Channelå¯ä»¥å©ç¨è¿ä¸ªæºä¼åä¸äºæ¸é¤å·¥ä½ä»¥é²æ­¢ç¸åçæ°æ®è¢«éå¤æ¶è´¹ãconsumeæ¹æ³çè¿åå¼æ¨å¨åè¯ å¼æè¯¥ééçåé¨æ°æ®æ¯å¦å·²ç»åçäºå®è´¨æ§æ¹åï¼è¢«æ¶è´¹æèæ¸ç©ºï¼ãå¦æè¿åTrueï¼æå³çChannelçç¶æå·²è¢«æ´æ°ï¼å¶çæ¬ä¼è¢«æåã</p>
<p>Channelçå¼å¹¶éå¨æ¯ä¸ªæ¶é´ç¹é½æ¯å¯ç¨çï¼æ¯å¦å¯¹äºæäºChannelï¼å¨Superstep Nä¸­åå¥çå¼åªè½å¨Superstep N+1ä¸­å¯ç¨ï¼Channelçå¯ç¨æ§ç±is_availableæ¹æ³å³å®ãfinishæ¯ä¸ä¸ªâé©å­ï¼Hookï¼âæ¹æ³ï¼å¼æä¼å¨æ¯ä¸ªSuperstepå®ææ¶è°ç¨æ­¤æ¹æ³ï¼å¯¹åºçChannelå¯ç¨å©ç¨æ­¤æ¹æ³åä¸äºç±»ä¼¼äºâå¯ç¨æ§æ§å¶âçæä½ãæçä¸ä½çæ¯ï¼åªæå¨å½åSuperstepä¸­è¢«æ´æ°çä¸è¢«Nodeè®¢éçChannelï¼å®ä»¬çfinishæ¹æ³æä¼è¢«è°ç¨ã</p>
<h2 id="3-channel">3. Channel</h2>
<p>Pregelæä¾äºè¥å¹²é¢å®ä¹çChannelç±»åï¼å®ä»¬çè¯»åè¡ä¸ºä»¥åå¯ç¨æ§ä¸é½æå·®å¼ï¼æä»¬éè¦æ ¹æ®æ°æ®æèç¶æçç¹æ§éæ©éåçChannelç±»åã</p>
<h2 id="31lastvalue">3.1	LastValue</h2>
<p>LastValueåªå­å¨åå¼ï¼å¹¶ä¸éç¨åæ¥å±ä¸çç­ç¥ï¼å­å¨æåä¸ä¸ªæäº¤æ´æ°çå¼ãä»å¦ä¸æä¾çå·ä½å®ç°å¯ç¨çåºï¼LastValueçå¼ç±»åãæ´æ°ç±»ååCheckpointç±»åä¸èåä¸ï¼æä»¥åªéè¿å­æ®µvalueç»´æ¤å¯ä¸çå¼ãgetãcheckpointåupdateæ¹æ³å®ç°äºéå¯¹è¯¥å­æ®µçè¯»åï¼å¦ææ²¡æå¯¹valueå­æ®µæ¾å¼èµå¼ï¼is_availableæ¹æ³ä¼è¿åFalseï¼getæ¹æ³ä¹ä¼æåºå¼å¸¸ãcopyåfrom_checkpointæ¹æ³è¿åçé½æ¯ä¸ä¸ªæ°çLastValueå¯¹è±¡ï¼æä¾çå¼ä¼ä¸ºå¶valueå­æ®µèµå¼ã</p>
<pre><code class="language-python">class LastValue(Generic[Value], BaseChannel[Value, Value, Value]):
    __slots__ = ("value",)
    value: Value | Any

    def __init__(self, typ: Any, key: str = "") -&gt; None:
        super().__init__(typ, key)
        self.value = MISSING

    def __eq__(self, value: object) -&gt; bool:
        return isinstance(value, LastValue)

    @property
    def ValueType(self) -&gt; type[Value]:
        return self.typ

    @property
    def UpdateType(self) -&gt; type[Value]:
        return self.typ

    def copy(self) -&gt; Self:
        empty = self.__class__(self.typ, self.key)
        empty.value = self.value
        return empty

    def from_checkpoint(self, checkpoint: Value) -&gt; Self:
        empty = self.__class__(self.typ, self.key)
        if checkpoint is not MISSING:
            empty.value = checkpoint
        return empty

    def update(self, values: Sequence[Value]) -&gt; bool:
        if len(values) == 0:
            return False
        if len(values) != 1:
            msg = create_error_message(
                message=f"At key '{self.key}': Can receive only one value per step. Use an Annotated key to handle multiple values.",
                error_code=ErrorCode.INVALID_CONCURRENT_GRAPH_UPDATE,
            )
            raise InvalidUpdateError(msg)

        self.value = values[-1]
        return True

    def get(self) -&gt; Value:
        if self.value is MISSING:
            raise EmptyChannelError()
        return self.value

    def is_available(self) -&gt; bool:
        return self.value is not MISSING

    def checkpoint(self) -&gt; Value:
        return self.value

MISSING = object()
</code></pre>
<p>æä»¬è¯´LastValueè¿ä¸ªä½¿ç¨é¢çæé«çChanneléå¯¹å¤ä¸ªæ´æ°éç¨âåæ¥å±ä¸âçç­ç¥ï¼åªå­å¨æåä¸æ¬¡æ´æ°çæä¾çå¼ï¼ä½è¿éæè°çå¤æ¬¡æ´æ°åªå¾æ¶è·¨è¶ä¸åSuperstepéå¯¹Channelå¾å¤æ¬¡åå¥ï¼å ä¸ºå®æ ¹æ¬ä¸æ¯æå¨åä¸ªSuperstepéå¯¹å®å¾å¤æ¬¡æ´æ°ï¼updateæ¹æ³å¾å®ç°å·²ç»ä½ç°äºè¿ä¸ç¹ãå¨å¦ä¸è¿ä¸ªæ¼ç¤ºç¨åºä¸­ï¼æä»¬è®©ä¸ä¸ªå¹¶è¡æ§è¡å¾Nodeå¨åä¸Superstepåæ´æ°å½åä¸ºâoutputâçè¿ä¸ªLastValueç±»åçChannelï¼ç»å®çæ­è¨è¯å®äºupdateæ¹æ³ä¸­æåºInvalidUpdateErrorå¼å¸¸çé»è¾ã</p>
<pre><code class="language-python">from langgraph.channels import LastValue
from langgraph.pregel import Pregel, NodeBuilder
from langgraph.errors import InvalidUpdateError

def build(node_name:str)-&gt;NodeBuilder:
    return (NodeBuilder()
            .subscribe_to("start")
            .do(lambda _:node_name)
            .write_to("output"))

app = Pregel(
    nodes={name: build(name) for name in ["foo", "bar", "baz"]},
    channels={
        "start": LastValue(None),
        "output": LastValue(str),
    },
    input_channels=["start"],
    output_channels=["output"],
)

try:
    app.invoke(input={"start": None})
    assert False, "Expected InvalidUpdateError"
except Exception as e:
    assert isinstance(e, InvalidUpdateError)
</code></pre>
<h3 id="32anyvalue">3.2	AnyValue</h3>
<p>AnyValueç±»åçChannelåæ ·æ¯ç¨äºå­å¨åå¼ï¼æä»¥å®çå®ç°äºLastValueå¨å¾å¤å°æ¹é½ç±»ä¼¼ãä¸¤èä¹é´æå¤§çä¸åå¨äºï¼AnyValueæ¯æåä¸ä¸ªSuperstepçå¤æ¬¡æ´æ°ï¼ä½æ¯å°ææçæ´æ°è§ä¸ºç­æï¼æä»¥å®çupdateæ¹æ³ä¼ä½¿ç¨æåä¸ä¸ªæ´æ°æä¾çå¼ã</p>
<pre><code class="language-python">class AnyValue(Generic[Value], BaseChannel[Value, Value, Value]):
    __slots__ = ("typ", "value")

    value: Value | Any
    def __init__(self, typ: Any, key: str = "") -&gt; None:
        super().__init__(typ, key)
        self.value = MISSING
    def update(self, values: Sequence[Value]) -&gt; bool:
        if len(values) == 0:
            if self.value is MISSING:
                return False
            else:
                self.value = MISSING
                return True

        self.value = values[-1]
        return True
</code></pre>
<p>è½ç¶AnyValueéå¯¹åä¸Superstepåçå¤æ¬¡æ´æ°ä¼éæ©æåä¸æ¬¡æ´æ°ï¼ä½æ¯è¿ä¸ªæ´æ°çé¡ºåºæ¯æ æ³éè¿ç¨åºæ§å¶çï¼æä»¬ä¹ä¸è½å¯¹æ´æ°é¡ºåºä½ä»»ä½åè®¾ãå¦ä¸çæ¼ç¤ºç¨åºå¾æ¸æ°å°è¯´æäºè¿ä¸ç¹ï¼æä»¬æç§ä¸ä¸ä¸ªä¾å­ç¸ä¼¼çæ¹å¼å¹¶è¡æ§è¡âfooâ ã âbarâ å âbazâ ä¸ä¸ªNodeï¼å®ä»¬å¨å®ææ§è¡åä¼æ´æ° âoutputâ è¿ä¸ªAnyValueç±»åçChannelãç±äºæä»¬ä¸ºâbarâ å âbazâ çå¤çå½æ°åäº1ç§çä¼ç ï¼æç§âå¸¸çâæ¨æ­ï¼âfooâæä¾çæ´æ°åºè¯¥åè¢«æ¶éååºç¨ï¼ä½äºå®å´æªå¿å¦æ­¤ã</p>
<pre><code class="language-python">from langgraph.channels import LastValue,AnyValue
from langgraph.pregel import Pregel, NodeBuilder
import time
from typing import Any
from functools import partial

changes: list[Any] = []
class ExtendedAnyValue(AnyValue):
    def update(self, values: list[Any]) -&gt; bool:
        global changes
        changes = values
        return super().update(values)
    
def handle(node_name:str, args:dict[str,Any])-&gt;str:
    if node_name != "foo":
        time.sleep(1)  # Simulate some processing delay
    return node_name

def build(node_name:str)-&gt;NodeBuilder:
    return (NodeBuilder()
            .subscribe_to("start")
            .do(partial(handle, node_name))
            .write_to("output"))

app = Pregel(
    nodes={name: build(name) for name in ["foo","bar", "baz"]},
    channels={
        "start": LastValue(None),
        "output": ExtendedAnyValue(str),
    },
    input_channels=["start"],
    output_channels=["output"], 
)

result =  app.invoke(input={"start": None})
print("collected changes:", changes)
print("channel value:", result["output"])
</code></pre>
<p>æä»¬éè¿ç»§æ¿AnyValueå®ä¹äºä¸ä¸ªExtendedAnyValueç±»åï¼éåçupdateæ¹æ³å¨è°ç¨åºç±»ååæ¹æ³åï¼æä»¬å°valuesåæ°èµå¼ç»å¨å±åéchangesãâoutputâ ç°å¨çç¨ç°å¨è¿ä¸ªç±»åãå¨å®ææ­£å¸¸è°ç¨åï¼æä»¬å°changesåéæ¿è½½çæ´æ°æ¬¡åºåChannelæç»çå¼æå°åºæ¥ãä»å¦ä¸çè¾åºç»æå¯ä»¥çåºï¼æ¬åºè¯¥æåå®æç âfooâ èç¹æä¾çæ´æ°åèæ¾å¨æåï¼ä½æ¯Channelæåçå¼ç¡®å®æ¯æåçæåä¸ä¸ªã</p>
<pre><code>collected changes: ['bar', 'baz', 'foo']
channel value: foo
</code></pre>
<h3 id="33lastvalueafterfinish">3.3	LastValueAfterFinish</h3>
<p>LastValueAfterFinishç±»åçChannelå¼¥è¡¥äºLastValueå¨åä¸Superstepä¸­ä¸è½å¤æ¬¡æ´æ°çä¸è¶³ï¼å®çupdateæ¹æ³éç¨äºä¸AnyValueç±»ä¼¼çé»è¾ï¼æ»æ¯ä¼æåæåæäº¤çæ´æ°ãä¸è¿æä»¬å¨åé¢å·²ç»è¯´è¿ï¼æä»¬ä¸åºè¯¥å¯¹æ´æ°é¡ºåºä½ä»»ä½åè®¾ï¼æä»¥å®æ¯éæ©ç¬¬ä¸ä¸ªè¿æ¯æåä¸ä¸ªå¶å®é½æ²¡æä»ä¹ä¸åã</p>
<pre><code class="language-python">class LastValueAfterFinish(
    Generic[Value], BaseChannel[Value, Value, tuple[Value, bool]]):
    value: Value | Any
    finished: bool	
    def __init__(self, typ: Any, key: str = "") -&gt; None:
        super().__init__(typ, key)
        self.value = MISSING
        self.finished = False   

    def update(self, values: Sequence[Value | Any]) -&gt; bool:
        if len(values) == 0:
            return False

        self.finished = False
        self.value = values[-1]
        return True

    def consume(self) -&gt; bool:
        if self.finished:
            self.finished = False
            self.value = MISSING
            return True
        return False

    def finish(self) -&gt; bool:
        if not self.finished and self.value is not MISSING:
            self.finished = True
            return True
        else:
            return False

    def get(self) -&gt; Value:
        if self.value is MISSING or not self.finished:
            raise EmptyChannelError()
        return self.value

    def is_available(self) -&gt; bool:
        return self.value is not MISSING and self.finished
</code></pre>
<p>LastValueAfterFinishæä¸ºå¸åçç¹æ§æ¯éå¯¹å®çæ´æ°åªæå¨Superstepå®æä¹åæä¼çæï¼æä»¥å¨Superstep Nä¸­çæ´æ°åªè½ç­å°Superstep N+1æè½è¢«è¯»åãæä»¬å¯ä»¥ä»LastValueAfterFinishçå®ä¹çåºå®å©ç¨finishedå­æ®µå¤æ­Superstepæ¯å¦å®æï¼è¿ä¸ªå­æ®µä¼å¨updateåfinishæ¹æ³ä¸­åå«è¢«è®¾ç½®æFalseåTrueãis_availableæ¹æ³å¨ååºå¯ç¨æ§å¤æ­çæ¶åä¼åæ¶è¯ä¼°å¼æ¯å¦å­å¨åè¿ä¸ªfinishedå­æ®µçå¼ã</p>
<p>èµäºäºLastValueAfterFinish âè·¨æ­¥å»¶è¿â çå¯è§æ§ï¼æä»¬å¯ä»¥ä»å¦ä¸è¿ä¸ªæ¼ç¤ºç¨åºçåºå®åLastValueçä¸åä¹å¤ãå¦ä»£ç çæ®µæç¤ºï¼Pregelå¯ä¸çNodeè®¢éäºâfooâåâbarâè¿ä¸¤ä¸ªChannelï¼å¶ç±»ååå«ä¸ºLastValueåLastValueAfterFinishãå¨Superstep -1æä¾çä¸¤ä¸ªè¾å¥fooåbarï¼åèå¨Superstep -1å¯è§ï¼æä»¥ä¼å¨Superstep 0è§¦åèç¹æ§è¡ï¼æ­¤æ¶åèæ¯ä¸å¯ç¨çç¶æãç­å°Superstep 0ç»æï¼finishæ¹æ³è¢«è°ç¨ä¹åï¼baråå¾å¯ç¨ï¼å¶æ´æ°è§¦åèç¹ä¸Superstep 1ä¸­åæ¬¡æ§è¡ã</p>
<pre><code class="language-python">from langgraph.channels import LastValue,LastValueAfterFinish
from langgraph.pregel import Pregel, NodeBuilder
from langchain_core.runnables import RunnableConfig
from typing import Any

inputs:list = []
def handle(args:dict[str,Any], config: RunnableConfig)-&gt;None:
    step = config.get("metadata", {}).get("langgraph_step")
    inputs.append((step, args.get("foo"), args.get("bar")))

node = (NodeBuilder()
    .subscribe_to("foo","bar", read=True)
    .do(handle))

app =  Pregel(
    nodes={"body": node},
    channels={
        "foo": LastValue(str), 
        "bar": LastValueAfterFinish(str),  
    },
    input_channels=["foo", "bar"],
    output_channels=[],
)
app.invoke(input={"foo": "123", "bar": "456",})
assert len(inputs) == 2
assert inputs[0] == (0, "123", None)
assert inputs[1] == (1, "123", "456")
</code></pre>
<p>å¦ä¸è¿ç§Nodeæ ¹æ®æ æ³è¢«è§¦åæ§è¡çé®é¢ï¼ä¹æ­£æ¯æºäºLastValueAfterFinishè¿ç§âè·¨æ­¥å»¶è¿â çå¯è§æ§é æçãç±äºä½ä¸ºè¾å¥Channelçç±»åä¸ºLastValueAfterFinishï¼æä»¥å¨Superstep -1ä¸­å¤äºä¸å¯ç¨çç¶æï¼æä»¥å¼æä»»å¡ä¸ä¸æ­¥æ²¡æéè¦æ§è¡çèç¹ï¼æ´ä¸ªæµç¨å°±ç´æ¥ç»æäºã</p>
<pre><code class="language-python">from langgraph.channels import LastValue,LastValueAfterFinish
from langgraph.pregel import Pregel, NodeBuilder

node = (NodeBuilder()
        .subscribe_only("input")
        .do(lambda args:args)
        .write_to("output"))
app =  Pregel(
    nodes={"body": node},
    channels={
       "input": LastValueAfterFinish(str), 
       "output": LastValue(str),
    },
    input_channels=["input"],
    output_channels=["output"],
)
result = app.invoke(input={"input": "foobar"})
assert result == None
</code></pre>
<p>ä»ç»åºçå®ä¹æä»¬è¿åç°ï¼LastValueAfterFinishè¿éåäºconsumeï¼å¹¶å°finishedå­æ®µéç½®ä¸ºFalseï¼å¹¶å°å¼æ¹é¤ãè¿ä¸ªå®ç°èµäºäºLastValueAfterFinish âéåå³çâ çç¹æ§ã</p>
<h3 id="34ephemeralvalue">3.4	EphemeralValue</h3>
<p>EphemeralValueæ¯ä¸ç§ä¸é¨ç¨äºç­å¯¿å½æ°æ®ä¼ éçChannelç±»åï¼å ä¸ºå®çæ ¸å¿ç¹æ§å°±æ¯ âæ´æ°æ°æ®é»æ­¥ææâ ãEphemeralValueå¨é»è®¤æåµä¸ä¹åLastValueä¸æ ·ä¸æ¯æéè¿Superstepä¸­çå¤ä¸ªæ´æ°ï¼ä½æ¯æä»¬å¯ç¨å¨æé å½æ°ä¸­å°guardåæ°è®¾ç½®ä¸ºFalseæ¥å³é­è¿ä¸ªéå¶ãå¦æåè®¸åä¸ªSuperstepåçå¤æ¬¡æ´æ°ï¼å®ä¹åªä¼éæ©æåä¸æ¬¡æ´æ°æä¾çå¼ã</p>
<pre><code class="language-python">class EphemeralValue(Generic[Value], BaseChannel[Value, Value, Value]):
    __slots__ = ("value", "guard")
    value: Value | Any
    guard: bool

    def __init__(self, typ: Any, guard: bool = True) -&gt; None:
        super().__init__(typ)
        self.guard = guard
        self.value = MISSING    

    def update(self, values: Sequence[Value]) -&gt; bool:
        if len(values) == 0:
            if self.value is not MISSING:
                self.value = MISSING
                return True
            else:
                return False
        if len(values) != 1 and self.guard:
            raise InvalidUpdateError(
                f"At key '{self.key}': EphemeralValue(guard=True) can receive only one value per step. Use guard=False if you want to store any one of multiple values."
            )

        self.value = values[-1]
        return True
</code></pre>
<p>EphemeralValueæè°ç âé»æ­¥ææâ çæ´æ°æææ§ç­ç¥å®ç°å¨å®çupdateæ¹æ³ä¸­ãå¦ä¸é¢çä»£ç çæ®µæç¤ºï¼å¦æå½åSuperstepåæ æ´æ°ï¼updateæ¹æ³çvaluesåæ°ä¸ºç©ºï¼æ­¤æ¶å®ä¼å°ä¹åè®¾ç½®çå¼æ¸ç©ºãå¦ä¸çæ¼ç¤ºç¨åºååä½ç°äºè¿ä¸ç¹ï¼å¨Super step -1è¾å¥å° âbarâ è¿ä¸ªEphemeralValueç±»åçChannelï¼å®çå¼åªè½Superstep 0ä¸­æ§è¡çNodeï¼ ânode1â ï¼è¯»åï¼å¨Superstepä¸­çNodeï¼ ânode2â ï¼è¯è¯å¾è¯»åæ¶å·²è¢«æ¸ç©ºã</p>
<pre><code class="language-python">from langgraph.channels import LastValue,EphemeralValue
from langgraph.pregel import Pregel, NodeBuilder
from langchain_core.runnables import RunnableConfig
from typing import Any

inputs:list = []
def handle(args:dict[str,Any], config: RunnableConfig)-&gt;None:
    step = config.get("metadata", {}).get("langgraph_step")
    inputs.append((step, args.get("foo"), args.get("bar")))

node1 = (NodeBuilder()
    .subscribe_to("node1", read=False)
    .read_from("foo", "bar")
    .do(handle)
    .write_to(node2= None))

node2 = (NodeBuilder()
    .subscribe_to("node2", read=False)
    .read_from("foo", "bar")
    .do(handle))

app =  Pregel(
    nodes={"node1": node1, "node2": node2},
    channels={
        "foo": LastValue(str), 
        "bar": EphemeralValue(str),  
        "node1": LastValue(None),
        "node2": LastValue(None),
    },
    input_channels=["node1","foo", "bar"],
    output_channels=[],
)

app.invoke(input={"node1": None,"foo": "123", "bar": "456",})
assert len(inputs) == 2
assert inputs[0] == (0, "123", "456")
assert inputs[1] == (1, "123", None)
</code></pre>
<h3 id="35untrackedvalue">3.5	UntrackedValue</h3>
<p>UntrackedValueæ¯ä¸ç§ç¹æ®çChannelç±»åï¼å¶æ ¸å¿ç¹æ§å¨äºå®ç âéæä¹æ§â å âä¸å¯è¿½è¸ªæ§â ãåå¥UntrackedValueçå¼å¸¸é©»åå­ï¼å¹¶ä¼åä¸æä¹åãè¿ä¸ç¹æ§ä½ç°å¨çcheckpointåfrom_checkpointæ¹æ³ä¸ï¼åèä¸ºæä¹åæä¾ä¸ä¸ªç©ºå¼ï¼åèç´æ¥æ¾å¼ä»æä¹åå­å¨å è½½çå¼ãä¸EphemeralValueä¸æ ·ï¼UntrackedValueä¹éè¿æé å½æ°çguardåæ°å³å®æ¯å¦åè®¸åä¸Superstepçå¤æ¬¡åå¥ã</p>
<pre><code class="language-python">class UntrackedValue(Generic[Value], BaseChannel[Value, Value, Value]):
    def checkpoint(self) -&gt; Value | Any:
        return MISSING
    def from_checkpoint(self, checkpoint: Value) -&gt; Self:
        empty = self.__class__(self.typ, self.guard)
        empty.key = self.key
        return empty
    def update(self, values: Sequence[Value]) -&gt; bool:
        if len(values) == 0:
            return False
        if len(values) != 1 and self.guard:
            raise InvalidUpdateError(
                f"At key '{self.key}': UntrackedValue(guard=True) can receive only one value per step. Use guard=False if you want to store any one of multiple values."
            )

        self.value = values[-1]
        return True
</code></pre>
<p>å¨å¤æçæºè½ä½å·¥ä½æµä¸­ï¼å¹¶éæææ°æ®é½éåæéè¦æä¹åãä½¿ç¨UntrackedValueçä¸»è¦åå åæ¬ï¼</p>
<ul>
<li>
<p>å®å¨æ§ä¸éç§ï¼æäºææä¿¡æ¯ï¼å¦ä¸´æ¶è®¿é®ä»¤çãAPI Keys æç¨æ·ç§å¯å­è¯ï¼ä¸åºåå¥ç£çææä¹åæ°æ®åºçå¿«ç§ä¸­ã</p>
</li>
<li>
<p>æ§è½ä¼åï¼å¦ææäºæ°æ®éæå¤§ï¼å¦å¤§åå¾å Bufferãå¤§åæä»¶æµæå¤æçå¯¹è±¡å®ä¾ï¼ï¼ä¸è¿äºæ°æ®å¨ç³»ç»å´©æºåå¯ä»¥éæ°çææä¸åéè¦ï¼æé¤å®ä»¬å¯ä»¥æ¾èåå° Checkpoint çä½ç§¯ï¼æåå­å¨æ§è½ã</p>
</li>
<li>
<p>å¯¹è±¡éåºååå¼å®¹ï¼æäº Python å¯¹è±¡ï¼å¦æå¼çæä»¶å¥æãæ°æ®åºè¿æ¥ãæ­£å¨è¿è¡ççº¿ç¨æç¹å®çç¬¬ä¸æ¹åºå¯¹è±¡ï¼æ¯æ æ³è¢«åºååçãå°å®ä»¬æ¾å¥UntrackedValueChannelå¯ä»¥é¿åå¾å¨ä¿å­ç¶ææ¶æ¥éã</p>
</li>
</ul>
<p>UntrackedValueChannelä¸åä¸æä¹åçç¹æ§å¯ç¨éè¿å¦ä¸è¿ä¸ªç¨åºæ¥éªè¯ãå¦ä»£ç çæ®µæç¤ºï¼æä»¬åå«å®ä¹äºä¸ä¸ªç»è¾å¥Channelï¼fooåbarï¼åè¾åºChannelï¼bazåquxï¼ï¼æ¯ç»ä¸­ä¸ä¸ªæ¯å¸¸è§çLastValueï¼å¦ä¸ä¸ªåæ¯UntrackedValueChannelãæä»¬ä¸ºPregelå¯¹è±¡æå®äºCheckpointer, å¹¶å¨è°ç¨æ¶å©ç¨RunnableConfigæå®äºThread IDï¼é£ä¹è°ç¨çåå²å°ä¼è¢«æä¹åä¸æ¥ã</p>
<pre><code class="language-python">from langgraph.channels import LastValue,UntrackedValue
from langgraph.pregel import Pregel, NodeBuilder
from langchain_core.runnables import RunnableConfig
from langgraph.checkpoint.memory import InMemorySaver

node = (NodeBuilder()
    .subscribe_to("foo","bar")
    .do(lambda args:args)
    .write_to(baz=lambda r: r["foo"], qux=lambda r: r["bar"]))
app =  Pregel(
    nodes={"body": node},
    channels={
        "foo": LastValue(str), 
        "bar": UntrackedValue(str), 
        "baz": LastValue(str), 
        "qux": UntrackedValue(str),
    },
    input_channels=["foo", "bar"],
    output_channels=["baz", "qux"],
    checkpointer= InMemorySaver()
)
config:RunnableConfig = {"configurable":{"thread_id":"123"}}
app.invoke(input={"start": None,"foo": "123", "bar": "456",}, config=config)
for state in app.get_state_history(config=config):
print(f"step {state.metadata['step']}: {state.values}")
</code></pre>
<p>æä»¬è°ç¨Pregelçget_state_historyæ¹æ³æåæä¹åçåå²ï¼å¹¶è¾åºæ¯ä¸ªCheckpointä¸­å­å¨çChannelå¼ãä»å¦ä¸çè¾åºç»æå¯ç¨çåºï¼è¢«æä¹åçCheckpointä¸ä¼ä¿çç±»åä¸ºUntrackedValueChannelçChannelç¶æï¼ä¸è®ºå®æ¯è¾å¥è¿æ¯è¾åºã</p>
<pre><code>step 0: {'foo': '123', 'baz': '123'}
step -1: {'foo': '123'}
</code></pre>
<h3 id="36binaryoperatoraggregate">3.6	BinaryOperatorAggregate</h3>
<p>BinaryOperatorAggregateæ¯åè½æå¼ºå¤§çChannelç±»åãé¦åï¼å®æ¯æåä¸Superstepä¸­éå¯¹å®çå¤æ¬¡åå¥ï¼å¶æ¬¡ï¼æä»¬å¯ç¨å©ç¨å®æ¥å­å¨ä¸åç±»åçæ°æ®ï¼å¯ä»¥æ¯åå¼ï¼ä¹å¯ä»¥æ¯åè¡¨ãéåè¡æ»åå­å¸ï¼å ä¸ºæç»å­å¨çå¼æ¯ç±æä»¬æä¾çä¸ä¸ªäºåæä½ç¬¦å³å®çãè¿ä¸ªæä½ç¬¦ä½ç°ä¸ºä¸ä¸ªCallable[[Value, Value], Value] å¯¹è±¡ï¼ä¸¤ä¸ªè¾å¥åæ°åå«è¡¨ç¤ºç°æçå¼åæ°åå¥çå¼ï¼è¿ä¸ªå¯æ§è¡å¯¹è±¡çè¿åå¼æç»åå¥Channelçå¼ã</p>
<pre><code class="language-python">class BinaryOperatorAggregate(Generic[Value], BaseChannel[Value, Value, Value]):
    __slots__ = ("value", "operator")

    def __init__(self, typ: type[Value], operator: Callable[[Value, Value], Value]):
        super().__init__(typ)
        self.operator = operator
        â¦
    def update(self, values: Sequence[Value]) -&gt; bool:
        if not values:
            return False
        if self.value is MISSING:
            self.value = values[0]
            values = values[1:]
        seen_overwrite: bool = False
        for value in values:
            is_overwrite, overwrite_value = _get_overwrite(value)
            if is_overwrite:
                if seen_overwrite:
                    msg = create_error_message(
                        message="Can receive only one Overwrite value per super-step.",
                        error_code=ErrorCode.INVALID_CONCURRENT_GRAPH_UPDATE,
                    )
                    raise InvalidUpdateError(msg)
                self.value = overwrite_value
                seen_overwrite = True
                continue
            if not seen_overwrite:
                self.value = self.operator(self.value, value)
        return True
</code></pre>
<p>BinaryOperatorAggregateçæ ¸å¿å¨é¨ä½ç°updateæ¹æ³ä¸ãå¨æ­£å¸¸æåµä¸ï¼å®ä¼éåæ¯ä¸ªå¾åå¥çå¼ï¼å¹¶å°valueå­æ®µè¡¨ç¤ºçå½åå¼åå¾åå¥çå¼ä½ä¸ºåæ°è°ç¨äºåæä½ï¼æåå°è¿åç»æèµå¼ç»valueå­æ®µãæä»¬å·²ç»å¨åé¢çæ¼ç¤ºå®ä¾ä¸­å¤æ¬¡ä½¿ç¨è¿è¿ä¸ªç±»åï¼æ¯å¦æä»¬éè¿å¦ä¸çæ¹å¼å°ææåå¥çå¼å¨é¨ä¿å­ä¸æ¥ã</p>
<pre><code class="language-python">from langgraph.channels import LastValue,BinaryOperatorAggregate
from langgraph.pregel import Pregel, NodeBuilder
import operator

def build_node(node_name:str)-&gt;NodeBuilder:
    return (NodeBuilder()
        .subscribe_to("start", read=False)
        .do(lambda _: [node_name])
        .write_to("result"))

app = Pregel(
    nodes={name: build_node(name) for name in ["foo", "bar", "baz"]},
    channels={
        "start": LastValue(None),
        "result": BinaryOperatorAggregate(list, operator.add),
    },
    input_channels=["start"],
    output_channels=["result"],
)

result = app.invoke(input={"start": None})
assert all(x in result["result"] for x in ["foo", "bar", "baz"])
</code></pre>
<p>å¯¹äºä¸é¢è¿ä¸ªä¾å­ï¼ç±äºæä»¬Channelå­å¨çæ°æ®ç±»åæ¯åè¡¨ï¼èoperator.addè¦æ±ä¸¤ä¸ªè¾å¥åæ°åä¸ºåè¡¨ï¼æä»¥æä»¬ä¸å¾ä¸è®©Nodeå°åå¼å°è£æåè¡¨ãè½ç¶BinaryOperatorAggregateä»¥âæ³åâ çå½¢å¼å®ä¹ï¼ä½ä¸ºæä½çå¯æ§è¡å¯¹è±¡ä¹å®ä¹Callable[[Value, Value], Value]ç±»åï¼è²ä¼¼è¦æ±å­å¨ç±»ååå¾æ´æ°æ°æ®ç±»åä¸è´ï¼ä½æä»¬ç¥éæ³åå¨è¿è¡æ¶æ¯æ²¡æçº¦æåçï¼æä»¥æä»¬å¯ä»¥æ ¹æ®å·ä½çéæ±èªç±åæ¥ãæ¯å¦å¦ä¸è¿ä¸ªä¾å­ç¨äºæé BinaryOperatorAggregateæ¯æä»¬èªå®ä¹çappendå½æ°ï¼å®åæ¯æåè¡¨ï¼ä¹æ¯æåå¼ã</p>
<pre><code class="language-python">from langgraph.channels import LastValue,BinaryOperatorAggregate
from langgraph.pregel import Pregel, NodeBuilder
from typing import Any

def build_node(node_name:str)-&gt;NodeBuilder:
    return (NodeBuilder()
        .subscribe_to("start", read=False)
        .do(lambda _: node_name)
        .write_to("result"))

def append(a:list,b:Any)-&gt;list:
    if isinstance(b,list):
        return a + b
    else:
        a.append(b)
        return a

app = Pregel(
    nodes={name: build_node(name) for name in ["foo", "bar", "baz"]},
    channels={
        "start": LastValue(None),
        "result": BinaryOperatorAggregate(list, append),
    },
    input_channels=["start"],
    output_channels=["result"],
)

result = app.invoke(input={"start": None})
assert all(x in result["result"] for x in ["foo", "bar", "baz"])
</code></pre>
<p>æä»¬ä»BinaryOperatorAggregateçupdateæ¹æ³çå®ä¹è¿åç°äºå®æ§è¡âè¦çï¼overrideï¼âçåè½ãæç§ä»£ç åæ çé»è¾ï¼å¦ææä¾çæ¯ä¸ä¸ªOverwriteå¯¹è±¡ï¼æå®çäºåæä½å°è¢«å¿½ç¥ï¼updateæ¹æ³ä¼ç´æ¥ä½¿ç¨è¯¥å¯¹è±¡çvalueå­æ®µè¦çç°æçå¼ã</p>
<pre><code class="language-python">@dataclass(slots=True)
class Overwrite:
    value: Any
</code></pre>
<p>æ¯å¦ä¸é¢çæ¼ç¤ºç¨åºä¸­ï¼çåæ§è¡çèç¹fooå°èªå·±çåç§°æ·»å å°åä¸ºâoutputâçè¿ä¸ªBinaryOperatorAggregateééä¸­ï¼ä½æ¯èç¹baræ§è¡ä¹åä¼å°æç»çå¼ä»¥è¦ççæ¹å¼æ¹åæ["bar"]ã</p>
<pre><code class="language-python">from langgraph.channels import LastValue,BinaryOperatorAggregate
from langgraph.pregel import Pregel, NodeBuilder
from langgraph.types import Overwrite

foo = (NodeBuilder()
    .subscribe_to("foo", read=False)
    .write_to(output = ["foo"], bar=None))
bar = (NodeBuilder()
    .subscribe_to("bar", read=False)
    .do(lambda _: Overwrite(value=["bar"]))
    .write_to("output"))

app = Pregel(
    nodes={"foo": foo, "bar": bar},
    channels={
        "foo": LastValue(None),
        "bar": LastValue(None),
        "output": BinaryOperatorAggregate(list, lambda a,b: a + b),
    },
    input_channels=["foo"],
    output_channels=["output"],
)

result = app.invoke(input={"foo": None}, interrupt_after= "foo")
assert result == {"output": ["foo"]}

result = app.invoke(input={"foo": None})
assert result == {"output": ["bar"]}
</code></pre>
<p>è¿ç§è¦çæ§è´¨çåè¿å¯ä»¥æç§å¦ä¸çæ¹åå¥ä¸ä¸ªç¹æ®çå­å¸æ¥å®ç°ãè¿ä¸ªå­å¸åªåå«ä¸ä¸ªKeyä¸º â<strong>overwrite</strong>â çé®å¼å¯¹ï¼å®çå¼å°ç¨äºè¦çç°æçå¼ãå¼å¾ä¸æçæ¯ï¼å¨ä¸ä¸ªSuperstepä¸­ï¼è¿æ ·çè¦çæä½åªè½è¿è¡ä¸æ¬¡ãå¦æå¤æ¬¡æä¾è¿æ ·çå­å¸åOverwriteå¯¹è±¡ï¼updateæ¹æ³ä¼æåºä¸ä¸ªInvalidUpdateErrorå¼å¸¸ã</p>
<pre><code class="language-python">from langgraph.channels import LastValue,BinaryOperatorAggregate
from langgraph.pregel import Pregel, NodeBuilder

foo = (NodeBuilder()
    .subscribe_to("foo", read=False)
    .write_to(output = ["foo"], bar=None))
bar = (NodeBuilder()
    .subscribe_to("bar", read=False)
    .do(lambda _: {"__overwrite__": ["bar"]})
    .write_to("output"))

app = Pregel(
    nodes={"foo": foo, "bar": bar},
    channels={
        "foo": LastValue(None),
        "bar": LastValue(None),
        "output": BinaryOperatorAggregate(list, lambda a,b: a + b),
    },
    input_channels=["foo"],
    output_channels=["output"],
)

result = app.invoke(input={"foo": None}, interrupt_after= "foo")
assert result == {"output": ["foo"]}

result = app.invoke(input={"foo": None})
assert result == {"output": ["bar"]}
</code></pre>
<h3 id="37namedbarriervalue">3.7	NamedBarrierValue</h3>
<p>æä»¬å¨åé¢çæ¼ç¤ºå®ä¾ä¸­å©ç¨NamedBarrierValueè¿ä¸ªç¹æ®çChannelè§£å³äºâå¤Nodeä¾èµâçé®é¢ï¼æä»¬ä»ä¸­ä¹è½å¤§è´ç¥éå®çå·¥ä½åçï¼å®åé¨ç»´æ¤ä¸¤ä¸ªéåï¼ä¸ä¸ªæ¯åå§åæå®çåç§°éåï¼å¦ä¸ä¸ªåå¥å¡«åçéåï¼ç­ä¸¤ä¸ªéåä¸è´çæ¶åè¯¥Channelæåå¾å¯ç¨ãè¿ä¸¤ä¸ªéåå¯¹åºNamedBarrierValueå¦ä¸æç¤ºçnamesåseenéåãå½updateå¨åºç¨æ´æ°çæ¶åï¼å¦ææä¾çåç§°æ²¡æå¨nameséåä¸­ï¼ä¼ç´æ¥æåºInvalidUpdateErrorå¼å¸¸ãå¦æå·²ç»å¨seenéåä¸­ï¼å®ä¼ç´æ¥å¿½ç¥å¹¶è¿åFalseï¼å¦åæä¼å°å¶æ·»å å°seenéåä¸­ï¼å¹¶è¿åTrueã</p>
<pre><code class="language-python">class NamedBarrierValue(Generic[Value], BaseChannel[Value, Value, set[Value]]):

    names: set[Value]
    seen: set[Value]

    def __init__(self, typ: type[Value], names: set[Value]) -&gt; None:
        super().__init__(typ)
        self.names = names
        self.seen: set[str] = set()

    def checkpoint(self) -&gt; set[Value]:
        return self.seen

    def from_checkpoint(self, checkpoint: set[Value]) -&gt; Self:
        empty = self.__class__(self.typ, self.names)
        empty.key = self.key
        if checkpoint is not MISSING:
            empty.seen = checkpoint
        return empty

    def update(self, values: Sequence[Value]) -&gt; bool:
        updated = False
        for value in values:
            if value in self.names:
                if value not in self.seen:
                    self.seen.add(value)
                    updated = True
            else:
                raise InvalidUpdateError(
                    f"At key '{self.key}': Value {value} not in {self.names}"
                )
        return updated

    def get(self) -&gt; Value:
        if self.seen != self.names:
            raise EmptyChannelError()
        return None

    def is_available(self) -&gt; bool:
        return self.seen == self.names

    def consume(self) -&gt; bool:
        if self.seen == self.names:
            self.seen = set()
            return True
        return False
</code></pre>
<p>ä¸ºäºä¿çå¡«åçåç§°ï¼ç¨äºæä¹åçcheckpointæ¹æ³ä¼ç´æ¥æä¾seenéåï¼èå¯¹åºçfrom_checkpointæ¹æ³åå°Checkpointæä¾çåå®¹èµå¼ç»seenéåãç±äºNamedBarrierValueçç®çä»ä»æ¯å¨ç­å°å¸æçåç§°è¢«å¡«æ»¡æ¯å¯¹å¤ååºä¿¡å·ï¼è¯¥æ¡ä»¶ä½ç°å¨is_availableæ¹æ³ä¸ãå¦ææ­¤æ¡ä»¶ä¸æ»¡è¶³ï¼å®çgetæ¹æ³ä¼ç´æ¥æåºEmptyChannelErrorå¼å¸¸ãå¨æ¡ä»¶æ»¡è¶³åï¼getæ¹æ³è¿åçå¼ä¹ä¸éè¦ï¼æä»¥å®ç´æ¥è¿åNoneãåLastValueAfterFinishä¸æ ·ï¼NamedBarrierValueåæ ·å¨éåçconsumeæ¹æ³ä¸­æ¸ç©ºäºseenéåï¼è¾¾å°äº âéåå³çâ çææã</p>
<h3 id="38namedbarriervalueafterfinish">3.8	NamedBarrierValueAfterFinish</h3>
<p>NamedBarrierValueAfterFinishå¨NamedBarrierValueåºç¡ä¸æ·»å äºåºäº âAfterFinishâ çå¯ç¨æ§éå¶ãå³ä½¿namesåseenéåå¯¼è´ä¸è´ç¶æï¼å¶çæçæ¶æºä¼å»¶åè´ä¸ä¸ä¸ªSuperstepãNamedBarrierValueAfterFinishä¼å¨åé¨ç»´æ¤ä¸ä¸ªfinishedç¶æï¼å½seenè¢«å¡«åæ»¡æ¶éå¯¹finishæ¹æ³çè°ç¨ä¼å°æ­¤ç¶æè®¾ç½®ä¸ºTrueãå¨è¾¾å°å¯ç¨æ¡ä»¶åéå¯¹consumeæ¹æ³çè°ç¨ä¼å°æ­¤ç¶æè®¾ç½®ä¸ºFalseãå®ç°çé»è¾åºæ¬ä¸ä¸åLastValueAfterFinishä¸è´ã</p>
<h3 id="39topic">3.9	Topic</h3>
<p>Topicç±»åçChannelå°±ç¸å½äºä¸ä¸ªæ¶æ¯éåï¼å®ä¼ä¿çæææä¾çæ°æ®ãå¨é»è®¤æåµä¸ï¼å¨å®æåºäºSuperstepçæ´æ°åºç¨ä¹åï¼è¿ä¸ªå¯¹è±¡ä¼è¢«æ¸ç©ºãå¦æå¨åå§åçæ¶åå©ç¨accumulateåæ°å¼å¯äº âç´¯ç§¯â æ¨¡å¼ï¼æ°æ®å¨è·¨è¶Superstepæ¶ä¼è¢«ä¿çãè¿ä¸ªé»è¾ä½ç°å¨å¦ä¸æç¤ºçupdateæ¹æ³ä¸ã</p>
<pre><code class="language-python">class Topic(
    Generic[Value],
    BaseChannel[Sequence[Value], Value | list[Value], list[Value]]):

    __slots__ = ("values", "accumulate")
    def __init__(self, typ: type[Value], accumulate: bool = False) -&gt; None:
        super().__init__(typ)
        self.accumulate = accumulate
        self.values = list[Value]()

    def update(self, values: Sequence[Value | list[Value]]) -&gt; bool:
        updated = False
        if not self.accumulate:
            updated = bool(self.values)
            self.values = list[Value]()
        if flat_values := tuple(_flatten(values)):
            updated = True
            self.values.extend(flat_values)
        return updated
</code></pre>
<p>å¦ä¸çä»£ç ä½ç°äºæ¯å¦å¼å¯âç´¯ç§¯æåºâä¹é´çå·®å¼ãå¦ä»£ç çæ®µæç¤ºï¼æä»¬ç±åä¸ªNodeï¼node1ãnode2ãnode3ånode4ï¼æå»ºäºä¸ä¸ªPregelãåä¸ªNodeåä¸¤ä¸ªSuperstepå®æï¼å¶ä¸­node1ånode2åæ§è¡ï¼node3ånode4åæ§è¡ï¼å·ä½å®ç°åå©äºä¸ä¸ªNamedBarrierValueç±»åçChannelï¼triggerï¼ãè¿åä¸ªNodeé½ä¼å°èªå·±çåç§°åå¥fooåbarä¸¤ä¸ªTopicç±»åçééï¼å¶ä¸­barå¼å¯äºç´¯ç§¯æ¨¡å¼ãææä»æåçè°ç¨ç»æå¯ç¨çåºï¼ééfooåªä¿çäºæåSuperstepåå¥çåå®¹ï¼èéébaråææ´ä¸ªæ§è¡æµç¨åå¥çæ°æ®é½ä¿çäºä¸æ¥ã</p>
<pre><code class="language-python">from langgraph.channels import LastValue,NamedBarrierValue, Topic
from langgraph.pregel import Pregel, NodeBuilder

node1 = (NodeBuilder()
    .subscribe_to("start", read=False)
    .write_to(trigger="node1", foo="node1", bar="node1"))
node2 = (NodeBuilder()
    .subscribe_to("start", read=False)
    .write_to(trigger="node2", foo="node2", bar="node2"))

node3 = (NodeBuilder()
    .subscribe_to("trigger", read=False)
    .write_to(foo="node3", bar="node3"))
node4 = (NodeBuilder()
    .subscribe_to("trigger", read=False)
    .write_to(foo="node4", bar="node4"))

app = Pregel(
    nodes={"node1": node1, "node2": node2, "node3": node3, "node4": node4},
    channels={
        "start": LastValue(None),
        "trigger": NamedBarrierValue(list,names={"node1", "node2"}),
        "foo": Topic(list),
        "bar": Topic(list, accumulate=True),
    },
    input_channels=["start"],
    output_channels=["foo", "bar"],
)   

result = app.invoke(input={"start": None})
assert set(result["foo"]) == {"node3", "node4"}
assert set(result["bar"]) == {"node1", "node2", "node3", "node4"}
</code></pre>


</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-02-12 06:28">2026-02-12 06:28</span>&nbsp;
<a href="https://www.cnblogs.com/jaydenai">JaydenAI</a>&nbsp;
éè¯»(<span id="post_view_count">17</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19605973);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19605973', targetLink: 'https://www.cnblogs.com/jaydenai/p/19605973/channel-of-pregel', title: '[æè§£LangChainæ§è¡å¼æ] Channelââé©±å¨Nodeæ§è¡çåå' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ å¦ä½ç¨SSHè®¿é®è¿ç¨æå¡å¨ä¸çåç½æå¡ï¼å¦ï¼MySQLãRedisãKafkaï¼ï¼ ]]></title>
    <link>https://www.cnblogs.com/hackyle/p/19606177</link>
    <guid>6209bdc8686ad8d04f332bf4dba7b904</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/hackyle/p/19606177" title="åå¸äº 2026-02-11 23:13">
    <span role="heading" aria-level="2">å¦ä½ç¨SSHè®¿é®è¿ç¨æå¡å¨ä¸çåç½æå¡ï¼å¦ï¼MySQLãRedisãKafkaï¼ï¼</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body blogpost-body-html">
<p><strong>ä½ æ¯å¦æéå°ä»¥ä¸çéæ±åºæ¯ï¼</strong></p>
<ul>
<li>åºæ¯1ï¼ä½ é¨ç½²å¨ä¸ªäººçäºæå¡å¨ä¸çæå¡ï¼åºç°äºé®é¢ï¼æ³å¨æ¬å°çNavicat / DBeaveræ¥ä¸ä¸çº¿ä¸MySQLï¼å´åç°è¿é½è¿ä¸ä¸ã</li>
<li>åºæ¯2ï¼çº¿ä¸ Redis åºé®é¢äºï¼ä½ ææ¥æ¶åç°æ ä»ä¸æã
<ul>
<li>å¦æææå°æ¥å¿ï¼ä½ è¿å¯ä»¥ç»åä»£ç é»è¾åæ¥å¿æ¥åæ</li>
<li>ä½æ¯å¯¹äºæäºä¸å¡åºæ¯ä¸çç¼å­ç©¿éï¼Key è¢«è¯¯å ï¼ææ¥èµ·æ¥å°±æ¯è¾å°é¾äº</li>
</ul>
</li>
<li>åºæ¯3ï¼Kafka ææ¶æ¯ç§¯åï¼ä½æè¿ Topic é½çä¸å°
<ul>
<li>ææ¶æ¯ç§¯åï¼ä½ æ³ï¼ç topic åè¡¨ï¼ç consumer group ç¶æï¼å°è¯æå¨æ¶è´¹ä¸æ¡æ¶æ¯ãä½æ¯ï¼Kafka ç«¯å£ 9092 / 9093 ä¸å¼æ¾å¬ç½ï¼æ¬å° Kafka å·¥å·æ ¹æ¬è¿ä¸ä¸ã</li>
<li>Kafka æ¬èº«å°±å¤æï¼ä¸åºé®é¢ï¼ä½ è¿âè§å¯çªå£âé½æ²¡æï¼å®å¨ä¾èµè¿ç»´ãæ¥å¿åå¹³å°ï¼ææ¥é®é¢çå¤æåº¦é£åã</li>
</ul>
</li>
</ul>
<p><strong>ä»¥ä¸é®é¢çåå æ¯ä»ä¹ï¼</strong></p>
<ul>
<li>MySQLãRedisãKafkaéç½®äºåªææ¬å°127.0.0.1å¯ä»¥è®¿é®ï¼ä¸è½éè¿å¶ä»IPè®¿é®</li>
<li>é²ç«å¢æ²¡æå¯¹æå¡ç«¯å£å¼æ¾</li>
<li>äºæå¡å¨çå®å¨ç­ç¥ä¹æ²¡æå¯¹ç«¯å£æå¼</li>
</ul>
<p><strong>èæåªæ³ä¸´æ¶åå ä»¶äºï¼</strong></p>
<ul>
<li>åªæ³ä¸´æ¶æ¥çæ°æ®ãéªè¯é®é¢</li>
<li>ä¸æ³æ¹é²ç«å¢ãå®å¨ç­ç¥ç»</li>
<li>ä¸æ³æ¹ä»£ç ãä¸æ³æéæ±ãä¸æ³èµ°å®¡æ¹</li>
</ul>
<p>æè¦ä¸´æ¶è®¿é®åç½æå¡ï¼ä½æ¯ç½ç»ä¸éï¼ä¸è½éä¾¿æ¹ç½ç»ï¼ææ²¡æä»ä¹ææ¯æ¹æ³è§£å³è¿ä¸ªé®é¢ï¼ç­æ¡æ¯è¯å®ç ââ <strong>SSHæ¬å°ç«¯å£è½¬å</strong>ã</p>
<p><strong>æ³¨æï¼è¿æä¸ªå¾éè¦çåææ¡ä»¶ï¼ä½ è½éè¿SSHè¿æ¥å°è¿ç¨æå¡å¨ã</strong></p>
<h1><strong><u>å®ç°æè·¯</u></strong></h1>
<p><strong>ä¸å¥è¯æ¦æ¬åçï¼</strong>å©ç¨ SSH å¨æ¬å°åè¿ç¨æå¡å¨ä¹é´å»ºç«ä¸æ¡å å¯ééï¼æè¿ç¨åç½ç«¯å£âè½¬åâå°æ¬å°ç«¯å£ã</p>
<p><img alt="image" height="263" width="550" style="display: block; margin-left: auto; margin-right: auto" data-src="https://img2024.cnblogs.com/blog/3067233/202602/3067233-20260211215118833-328938205.png" class="lazyload"></p>
<p>å¯¹æ¬å°å·¥å·æ¥è¯´ï¼å®ä»¥ä¸ºèªå·±è¿çæ¯ localhost</p>
<p>å®éä¸æµééè¿ SSHï¼</p>
<ol>
<li>åå°è¿ç¨æå¡å¨</li>
<li>åç±è¿ç¨æå¡å¨è®¿é®åç½æå¡</li>
<li>ä½ ä¸éè¦æ¹ç½ç»ãä¸éè¦å¼ç«¯å£ãä¸éè¦æ´é²æå¡ã</li>
</ol>
<p><strong>è¯­æ³ï¼ssh -L [æ¬å°ç«¯å£]:[ç®æ ä¸»æº]:[ç®æ ç«¯å£] [SSHæå¡å¨ç¨æ·å]@[SSHæå¡å¨å°å]</strong></p>
<p><strong>å¯¹äºå¼åäººåæ¥è¯´ï¼å¸¸ç¨çä¸¤ç±»åºç¨åºæ¯ï¼</strong></p>
<ul>
<li>è¿ç¨æå¡å¨ä¸çæäºæå¡æ æ³ä»å¬ç½è®¿é®</li>
</ul>
<ol>
<li>çº¿ä¸ç¯å¢éï¼æ°æ®åºãä¸­é´ä»¶ï¼MySQL / Redis / Kafkaï¼å ä¹ä»ä¸æ´é²å¬ç½ç«¯å£ï¼åªè½å¨åç½è®¿é®ã</li>
<li>é²ç«å¢æ¯å³é­ç¶æï¼æ´é²å¬ç½è®¿é®éè¦æ¹å¨é²ç«å¢ï¼æåºéï¼</li>
<li>äºæå¡å¨çå®å¨ç­ç¥é»æ­¢è®¿é®ï¼éè¦æå¨éç½®æµå¥ãæµåºçå®å¨ç­ç¥ç«¯å£</li>
</ol>
<ul>
<li>å¬å¸åç½æå¡å¨ä¸çæå¡æ æ³ä»æ¬æºè®¿é®</li>
</ul>
<ol>
<li>æå¡åç½é¨ç½²ï¼ä¸å¯¹å¼åäººåå¼æ¾</li>
<li>æéç®¡æ§ä¸¥æ ¼</li>
<li>æ³è°è¯é®é¢ï¼ä½å®å¨ç­ç¥æ¯é®é¢è¿å¤æï¼æå¾å»éç½®</li>
<li>åç½æå¡å¨ä¸ä¸åè®¸éä¾¿å®è£å¶ä»ç¬¬ä¸æ¹è½¯ä»¶</li>
<li>æ³¨æï¼æ­¤æ¹å¼å¯è½è®©ä½ è¿è§ï¼è°¨æä½¿ç¨</li>
</ol>
<p><strong>è¿ç§æ¹å¼éååªäºåºæ¯ï¼</strong></p>
<ul>
<li>éå¸¸éå
<ul>
<li>ä¸´æ¶ææ¥çº¿ä¸é®é¢</li>
<li>æ¥çç¼å­æ°æ®</li>
<li>ä¸æ³æ¹ä»£ç </li>
<li>ä¸æ³è£å®¢æ·ç«¯</li>
<li>æéåéç¯å¢</li>
</ul>
</li>
<li>ä¸éå
<ul>
<li>é¿æè¿ç»´éé</li>
<li>é«å¹¶åè®¿é®</li>
</ul>
</li>
</ul>
<h1><strong><u>æ§è¡æ­¥éª¤</u></strong></h1>
<p>å¨äºè§£äºåºæ¬åçåå®ç°æè·¯åï¼å¼å§æ¢³çæ§è¡æ­¥éª¤ï¼è·çæä¸æ­¥ä¸æ­¥æ¥å®ç°å§ã</p>
<p><strong>æ§è¡æ­¥éª¤</strong></p>
<ul>
<li>ç¬¬ä¸æ­¥ï¼è½æ­£å¸¸ SSH ç»å½å°ä¸å°æå¡å¨ï¼ä¸åè®¸ç«¯å£è½¬å</li>
<li>ç¬¬äºæ­¥ï¼æç¡®ä½ è¦è¿æ¥çç®æ ï¼å¼å¯æ¬å°ç«¯å£è½¬å</li>
<li>ç¬¬ä¸æ­¥ï¼éªè¯ SSH é§éæ¯å¦çæ</li>
<li>ç¬¬åæ­¥ï¼è¿ç¨è®¿é®ç®æ æå¡</li>
</ul>
<p>åè®¾æè¦è¿æ¥è¿ç¨æå¡å¨ï¼8.145.45.70ï¼çRedisæå¡ï¼ä»ä»¬å¨è¿ç¨æå¡å¨ä¸åå«ä½¿ç¨6379ç«¯å£ã</p>
<p>å¨æ¬å°éæ©ä¸ä¸ªæ²¡è¢«å ç¨ãä½ èªå·±è®°å¾ä½çç«¯å£ï¼æ¯å¦ï¼16379ãä¸è¦æ±åè¿ç«¯ç«¯å£ä¸è´ï¼åªæ¯ä¸ºäºå¥½è®°ã</p>
<p><strong>å¦ä½æ£æ¥SSHæå¡å¨æ¯å¦åè®¸ç«¯å£è½¬åï¼æ£æ¥sshd_configä¸­ä»¥ä¸éç½®é¡¹çå¼</strong></p>
<ul>
<li>AllowTcpForwarding no &nbsp;#åºè¯¥æ¹ä¸ºyes</li>
<li>AllowAgentForwarding no &nbsp;#åºè¯¥æ¹ä¸ºyes</li>
<li>PermitTunnel no &nbsp;#åºè¯¥æ¹ä¸ºyes</li>
</ul>
<h2><strong><u>å¼å¯æ¬å°ç«¯å£è½¬å</u></strong></h2>
<p>å¨æ¬å°åå»º SSH é§é</p>
<ul>
<li>è¿ä¸æä½çç®æ æ¯ï¼è®©æ¬å°æä¸ªç«¯å£ï¼æåè¿ç¨åç½æå¡ç«¯å£</li>
<li>æµéæµåï¼localhost:æ¬å°ç«¯å£ --&gt; SSH é§é --&gt; è¿ç¨åç½IP:æå¡ç«¯å£</li>
</ul>
<p><strong>å¨ç»ç«¯æ§è¡å½ä»¤ï¼</strong>ssh -L 16379:127.0.0.1:6379 root@8.145.45.70</p>
<p><img alt="image" height="225" width="637" style="display: block; margin-left: auto; margin-right: auto" data-src="https://img2024.cnblogs.com/blog/3067233/202602/3067233-20260211223744883-1369635982.png" class="lazyload"></p>
<p><strong>éªè¯æ¬å°ç«¯å£æ¯å¦çæï¼netstat -ano | findstr 16379</strong></p>
<p><img alt="image" height="111" width="612" style="display: block; margin-left: auto; margin-right: auto" data-src="https://img2024.cnblogs.com/blog/3067233/202602/3067233-20260211223911662-2126026790.png" class="lazyload"></p>
<p>éªè¯æ¹å¼æç®åï¼æ£æ¥æ¬å°ç«¯å£æ¯å¦å¤äºçå¬ç¶æãå¦ä¸å¾ï¼æ¬å°ç16379å·²ç»å¤äºLISTENINGç¶æã</p>
<p>æ§è¡å®æåï¼SSH è¿æ¥ä¼ä¿æï¼æ¬å°ç«¯å£å¼å§çå¬ï¼ææè®¿é®é½ä¼è¢«è½¬åãæ­¤æ¶ä½ âçèµ·æ¥ä»ä¹é½æ²¡åâï¼ä½ééå·²ç»æéäºã</p>
<p>&nbsp;</p>
<p>å¨ä¸é¢çå¼å¯æ¬å°ç«¯å£è½¬åçå¾çä¸­ï¼ä½ å¯è½åç°äºè¿ä¸ªSSHé¾æ¥è¿å¥äºäº¤äºå¼çShell Terminalï¼è¦æ¯æä¸æ³è¿å¥è¿ç§äº¤äºå¼çç»ç«¯ï¼åºè¯¥æä¹åå¢ï¼</p>
<p><strong>ä¸æå¼äº¤äºå¼å¯¹è¯ï¼</strong>ssh -N -L 16379:127.0.0.1:6379 root@8.145.45.70</p>
<ul>
<li>-Nï¼ä¸æ§è¡è¿ç¨å½ä»¤ï¼åªåç«¯å£è½¬åï¼</li>
<li>æ´å®å¨ãæ´æ¸æ°</li>
</ul>
<p><strong>æ¾å°åå°è¿è¡ï¼</strong>ssh -f -N -L 16379:127.0.0.1:6379 user@server_ip</p>
<ul>
<li>-fï¼æ¾å°åå°</li>
<li>ç¨å®è®°å¾ææè¿ç¨ï¼tasklist + taskkill / ps + kill</li>
</ul>
<h2><strong><u>è¿ç¨è®¿é®</u></strong></h2>
<p>æ¥ä¸æ¥æ¯æâåç´è§ä½æç½âçä¸æ­¥ï¼</p>
<ul>
<li>ä¸åä½¿ç¨åç½ IPï¼ä¹ä¸åä½¿ç¨è¿ç¨æå¡å¨ IPï¼èç»ä¸ä½¿ç¨ï¼ 127.0.0.1 æ localhost</li>
<li>ç«¯å£ä½¿ç¨ä½ ååå¨æ¬å°ç»å®çç«¯å£</li>
</ul>
<p>&nbsp;</p>
<p>æ¬å°ä½¿ç¨å·²å®è£ç&nbsp;redis-cli&nbsp;å·¥å·è¿æ¥Redisï¼redis-cli -h 127.0.0.1 -p 16379</p>
<p><img alt="image" height="120" width="996" style="display: block; margin-left: auto; margin-right: auto" data-src="https://img2024.cnblogs.com/blog/3067233/202602/3067233-20260211224212748-461304407.png" class="lazyload"></p>
<p>ä½¿ç¨ GUI å®¢æ·ç«¯ï¼Another Redis Desktop Managerï¼è¿æ¥è¿ç¨Redis</p>
<p><img alt="image" height="285" width="879" style="display: block; margin-left: auto; margin-right: auto" data-src="https://img2024.cnblogs.com/blog/3067233/202602/3067233-20260211224250941-2082874978.png" class="lazyload"></p>
<h2><strong><u>QA</u></strong></h2>
<p><strong>æ¥éï¼prohibited</strong></p>
<p>channel X: open failed: administratively prohibited</p>
<p>channel 3: open failed: administratively prohibited: open failed</p>
<p>åå ï¼ç®¡çåç¦æ­¢äºä½ ä½¿ç¨ç«¯å£è½¬å</p>
<p>è§£å³ï¼sshd_config ä¸­ç¦ç¨äºç«¯å£è½¬å</p>
<ul>
<li>AllowTcpForwarding no &nbsp;#åºè¯¥æ¹ä¸ºyes</li>
<li>AllowAgentForwarding no &nbsp;#åºè¯¥æ¹ä¸ºyes</li>
<li>PermitTunnel no &nbsp;#åºè¯¥æ¹ä¸ºyes</li>
</ul>
<p>&nbsp;</p>
<p><strong>æ¥éï¼Connection timed out</strong></p>
<p>åå ï¼è¿æ¥è¶æ¶ï¼ç½ç»é®é¢</p>
<p>è§£å³ï¼æ£æ¥ç½ç»æ¯å¦è¿éãé²ç«å¢æ¯å¦å¼æ¾</p>
<p>&nbsp;</p>
<p><strong>ææMySQLãredisãkafkaé½è¦è¿è¡æ¬å°ç«¯å£è½¬åï¼å¯ä»¥åªæä¸ä¸ªç«¯å£åï¼</strong></p>
<p>ä¸è¡ã</p>
<p>SSH æ¬å°ç«¯å£è½¬åæ¯ï¼ä¸ä¸ªæ¬å°ç«¯å£ ä¸ ä¸ä¸ªè¿ç¨å°å:ç«¯å£ æ¯ä¸å¯¹ä¸æ å°ã</p>
<p>ä¸æ¡å½ä»¤åæ¶å¼å¯è½¬åï¼ssh user@server \</p>
<p>&nbsp;&nbsp;-L 13306:127.0.0.1:3306 \</p>
<p>&nbsp;&nbsp;-L 16379:127.0.0.1:6379 \</p>
<p>&nbsp;&nbsp;-L 19092:127.0.0.1:9092</p>
<p>&nbsp;</p>
<p><strong>è¿ä¸ä¸ Redisï¼ä½ SSH æ²¡æ¥éï¼</strong></p>
<ul>
<li>æ£æ¥Redis æ¯å¦çå¬ 127.0.0.1</li>
<li>æ¯å¦å¯ç¨äºå¯ç </li>
<li>æ¯å¦éå¶ protected-mode</li>
</ul>
<p>&nbsp;</p>
<p><strong>å¨ä½¿ç¨è¿ç¨ä¸­ï¼æ¯å¦</strong><strong>SSH è¿æ¥å¿é¡»ä¿æ</strong><strong>ï¼</strong></p>
<ul>
<li>æ¯ç</li>
<li>SSH æ­å¼ = é§éå¤±æï¼æ¬å°å·¥å·ä¼ç«å³è¿ä¸ä¸</li>
<li>å»ºè®®åç¬å¼ä¸ä¸ªç»ç«¯ï¼ä¸é¨ç¨äºç»´æ¤ SSH é§é</li>
<li>æ ¹æ®åºæ¯èèæ¯-Nã-fåæ°</li>
</ul>
<p>&nbsp;</p>
<p><strong>ä¸ºä»ä¹æäºå¬å¸çå®å¨å¢éä¼å³é­SSHçç«¯å£è½¬åï¼</strong></p>
<ul>
<li>SSH ç«¯å£è½¬å = éå½¢é§é</li>
<li>å¯ç»è¿é²ç«å¢ / ç½å³ / å®¡è®¡</li>
<li>æ¬å°æµéè¿äºåç½ï¼é¾ä»¥è¿½è¸ª</li>
<li>å®¹æè¢«å½æåç½ä»£çæ»¥ç¨</li>
<li>åºæ¯éç½®ï¼
<ul>
<li>AllowTcpForwarding no</li>
<li>AllowAgentForwarding no</li>
<li>PermitTunnel no</li>
<li>X11Forwarding no #æ¯å¦åè®¸æâè¿ç¨æå¡å¨ä¸çå¾å½¢çé¢ç¨åºâï¼è½¬åå°ä½ æ¬å°å±å¹ä¸æ¾ç¤ºã</li>
</ul>
</li>
</ul>
<p><strong>é¢å¤æéï¼</strong></p>
<ul>
<li>SSHé§éç¨å®å³å³ï¼æ¬å°ç«¯å£ç«å³éæ¾ï¼ä¸çä»»ä½åé¨</li>
<li>å¦¥åä¿ç®¡SSHè¿æ¥å¯ç ãç§é¥</li>
</ul>
<h1><strong><u>å¤çº§è·³æ¿</u></strong></h1>
<p>ä¼ä¸æå¡å¨éå¸¸æä»¥ä¸ç¹ç¹ï¼</p>
<ul>
<li>åç½ç¯å¢ï¼ä¸ç´æ¥æ´é²å¬ç½</li>
<li>å®å¨è¦æ±é«ï¼å¿é¡»å¯¹è®¿é®è¿è¡å®¡è®¡</li>
<li>å¤äººè¿ç»´æå¼åå¢éå±ç¨æå¡å¨</li>
<li>ä¸åè®¸ç´æ¥æ´é²ç®¡çç«¯å£</li>
</ul>
<p>é®é¢ï¼å¦æä½ ç´æ¥ SSH ç»å½åç½æå¡å¨ï¼å°±ä¼å¯¼è´</p>
<ul>
<li>æ²¡ææ¥å¿è®°å½</li>
<li>é¾ä»¥å®¡è®¡æä½</li>
<li>å¯è½å¯¼è´å®å¨é£é©</li>
</ul>
<p>è§£å³æ¹æ¡å°±æ¯ï¼å¨å¬ç½é¨ç½²ä¸å°æå¤å°è·³æ¿æº (Bastion / JumpServer)ï¼éè¿ SSH é´æ¥è®¿é®ç®æ æå¡å¨ãæ¥ä¸æ¥ï¼æä»¬ä¸èµ·æ¢ç´¢å¦ä½å¨ä¸å°åå¤å°è·³æ¿æºä¸å®ç°ç«¯å£è½¬åã</p>
<h2><strong><u>ä¸çº§è·³æ¿</u></strong></h2>
<p>éè¿è·³æ¿æºï¼Jump Host / Bastion Hostï¼ï¼å©ç¨ SSH ä½ä¸ºä¸­è½¬ï¼è®¿é®åç½éçç®æ æå¡å¨ã</p>
<p><strong>ä¸çº§è·³æ¿çç½ç»ç»æï¼</strong></p>
<p><strong><img alt="image" height="227" width="517" style="display: block; margin-left: auto; margin-right: auto" data-src="https://img2024.cnblogs.com/blog/3067233/202602/3067233-20260211225042832-192074460.png" class="lazyload"></strong></p>
<p><strong>å®ç°æ¹å¼ä¸ï¼æå¨ä¸¤æ¬¡SSHéæ­¥è·³è½¬</strong></p>
<ul>
<li>ç¬¬ä¸æ­¥ï¼åç»å½è·³æ¿æºï¼ssh jump_user@jump_host</li>
<li>ç¬¬äºæ­¥ï¼å¨è·³æ¿æºä¸ï¼å SSH å°ç®æ æå¡å¨ï¼ssh target_user@target_host</li>
</ul>
<p><strong>å®ç°æ¹å¼äºï¼</strong><strong>-J</strong><strong>è¯­æ³å®ç°</strong></p>
<p>è¯­æ³ï¼ssh -J jump_user@jump_host target_user@target_host</p>
<p>ä¾å¦ï¼ssh -NT -L 3306:127.0.0.1:3306 -J jump_user@jump_host target_user@target_host</p>
<ul>
<li>-L 3306:127.0.0.1:3306 &nbsp;æ¬å° 3306 â ç®æ 3306</li>
<li>-J jump_user@jump_host &nbsp;åè·³å°è·³æ¿æº</li>
<li>target_user@target_host åè¿å°ç®æ æº</li>
<li>-N &nbsp;ä¸æ§è¡è¿ç¨å½ä»¤</li>
<li>-T &nbsp;ä¸åé TTY</li>
<li>ä»æ¯æOpenSSHï¼7.3+ï¼</li>
</ul>
<p><strong>å®ç°æ¹å¼ä¸ï¼</strong><strong>-o</strong><strong>è¯­æ³å®ç°</strong></p>
<p>è¯­æ³ï¼ssh -o ProxyCommand="ssh jump_user@jump_host -W %h:%p" target_user@target_host</p>
<p>ä¾å¦ï¼ssh -NT -L 3306:127.0.0.1:3306 -o ProxyCommand="ssh jump_user@jump_host -W %h:%p" target_user@target_host</p>
<ul>
<li>å¦æ SSH çæ¬ &lt; 7.3ï¼æ²¡æ -Jï¼</li>
<li><strong>æ³¨ææ¯å°åço</strong></li>
</ul>
<h2><strong><u>äºçº§è·³æ¿</u></strong></h2>
<p><strong>äºçº§è·³æ¿çç½ç»ç»æï¼</strong></p>
<p><strong><img alt="image" height="214" width="533" style="display: block; margin-left: auto; margin-right: auto" data-src="https://img2024.cnblogs.com/blog/3067233/202602/3067233-20260211225336322-880147829.png" class="lazyload"></strong></p>
<p><strong>å®ç°æ¹å¼ä¸ï¼</strong><strong>-J</strong><strong>è¯­æ³å®ç°</strong></p>
<p>ssh -J user1@jump1,user2@jump2 user3@target</p>
<p>ä¾å­ï¼ssh -NT -L 3306:127.0.0.1:3306&nbsp;-J user1@jump1,user2@jump2 user3@target</p>
<ul>
<li>è·³æ¿æºä¹é´è¿ç»­åï¼éå·åå²</li>
<li>æ³¨æï¼è·³æ¿æºååé¡ºåºéå¸¸éè¦ï¼æç½ç»è¿å¥æ¹ååã</li>
<li>-L 3306:127.0.0.1:3306 &nbsp;æ¬å° 3306 â ç®æ 3306</li>
<li>-N &nbsp;ä¸æ§è¡è¿ç¨å½ä»¤</li>
<li>-T &nbsp;ä¸åé TTY</li>
<li>ä»æ¯æOpenSSHï¼7.3+ï¼</li>
</ul>
<p><strong>å®ç°æ¹å¼äºï¼</strong><strong>-o</strong><strong>è¯­æ³å®ç°</strong></p>
<p>è¯­æ³ï¼ssh -o ProxyCommand="ssh user1@jump1 \</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-o ProxyCommand='ssh user2@jump2 \</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-o ProxyCommand=\"ssh user3@jump3 -W %h:%p\" -W %h:%p' \</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-W %h:%p" \</p>
<p>&nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp;user4@target</p>
<ul>
<li>æ³¨æå¼å·ï¼æå¤å±æ¯åå¼å·ï¼åå±æ¯åå¼å·ï¼åºåå¼å·çè¾¹ç</li>
<li>å½ä»¤å¤ªå¤æäºï¼ç»´æ¤èµ·æ¥å¾é¾</li>
<li>ä¸æ¨èä½¿ç¨</li>
</ul>
<p>&nbsp;</p>
<p><strong>ä¸çº§è·³æ¿ï¼</strong></p>
<p>è¯­æ³ï¼ssh -J jump1,jump2,jump3 target</p>
<p><strong>æ³¨æç¹ï¼-Jåé¢è·è·³æ¿æºï¼æ³¨æé¡ºåº</strong></p>
<h1><strong><u>æå¡é¨ç½²å¨Dockerä¸</u></strong></h1>
<p><strong>å¦æä½ çåç½æå¡é¨ç½²å¨Dockerä¸ï¼å¦ä½å®ç°SSHçæ¬å°è½¬åå¢ï¼</strong></p>
<p>ä¸¤ç§æåµ</p>
<ul>
<li>å®¹å¨çç«¯å£æ å°å°äºå®¿ä¸»æº</li>
<li>å®¹å¨çç«¯å£æ²¡ææ å°å°äºå®¿ä¸»æº</li>
</ul>
<h2><strong><u>æ å°å°äºå®¿ä¸»æº</u></strong></h2>
<p><strong>Redis</strong><strong>å®¹å¨çç«¯å£æ å°å°äºå®¿ä¸»æº</strong></p>
<ul>
<li>å¨å¯å¨å®¹å¨æ¶æå®äºç«¯å£æ å°ï¼docker run -d --name redis-server-16379 -p 16379:6379 redis:7</li>
<li>SSHæ¬å°ç«¯å£è½¬åç´æ¥åèä¸æä¸­çæ§è¡æ­¥éª¤ãå ä¸ºç¸å½äºå®¿ä¸»æºç16379å·ç«¯å£ä¸å·¥ä½äºRedisæå¡ï¼å¯¹äºæä»¬æ¥è¯´ï¼è·Redisç´æ¥è¿è¡äºå®¿ä¸»æºä¸æ²¡æåºå«ã</li>
</ul>
<p><strong>æ§è¡æ­¥éª¤</strong></p>
<ul>
<li>ç¯å¢åå¤
<ul>
<li>è¿å¥è¿ç¨æå¡å¨ï¼å¯å¨ä¸ä¸ªRedis Dockerï¼docker run -d --name redis-server-16379 -p 16379:6379 redis:7</li>
<li>è¿å¥å®¹å¨:docker exec -it redis-server-16379 /bin/bash</li>
<li>å¾å®¹å¨ä¸­çRediså¡å¥ä¸ä¸ªé®å¼å¯¹ï¼set name hackyle</li>
</ul>
</li>
</ul>
<p><strong><img alt="image" height="369" width="713" style="display: block; margin-left: auto; margin-right: auto" data-src="https://img2024.cnblogs.com/blog/3067233/202602/3067233-20260211230123602-556526716.png" class="lazyload"></strong></p>
<p><strong><img alt="image" height="199" width="881" style="display: block; margin-left: auto; margin-right: auto" data-src="https://img2024.cnblogs.com/blog/3067233/202602/3067233-20260211230201238-1099260311.png" class="lazyload"></strong></p>
<ul>
<li>å¨æ¬å°æºå¨ä¸å¼å¯æ¬å°ç«¯å£è½¬åï¼ssh -NT -L 16379:127.0.0.1:16379 <a href="mailto:root@8.145.45.70" rel="noopener nofollow"><u>root@8.145.45.70</u></a></li>
</ul>
<p><strong><img alt="image" height="176" width="569" style="display: block; margin-left: auto; margin-right: auto" data-src="https://img2024.cnblogs.com/blog/3067233/202602/3067233-20260211230330785-1307889599.png" class="lazyload"></strong></p>
<ul>
<li><strong>éªè¯ï¼å¨æ¬å°æºå¨ä¸è¿æ¥16379ç«¯å£ï¼è®¿é®å°è¿ç¨Dockerä¸­çRedis</strong></li>
</ul>
<p><strong><img alt="image" height="246" width="671" style="display: block; margin-left: auto; margin-right: auto" data-src="https://img2024.cnblogs.com/blog/3067233/202602/3067233-20260211230458069-231244983.png" class="lazyload"></strong></p>
<h2><strong><u>æªæ å°å°å®¿ä¸»æº</u></strong></h2>
<p><strong>MySQLå®¹å¨çç«¯å£æ²¡ææ å°å°äºå®¿ä¸»æº</strong></p>
<ul>
<li>åæ¥çå®¹å¨ IPï¼docker inspect mysql | grep IPAddress</li>
<li>åSSH æ¬å°ç«¯å£è½¬åï¼ç´æ¥æåå®¹å¨ IPï¼ssh -L 3306:172.17.0.3:6379user@remote-host</li>
</ul>
<p>&nbsp;</p>
<p><strong>æ§è¡æ­¥éª¤</strong></p>
<p>1.ç¯å¢åå¤</p>
<ul>
<li>è¿å¥è¿ç¨æå¡å¨ï¼å¯å¨ä¸ä¸ªRedis Dockerï¼docker run -d --name redis-server-26379 redis:7</li>
<li>æ¥çå®¹å¨IPï¼docker inspect redis-server-26379 | grep IPAddress</li>
<li>è¿å¥å®¹å¨:docker exec -it redis-server-16379 /bin/bash</li>
<li>å¾å®¹å¨ä¸­çRediså¡å¥ä¸ä¸ªé®å¼å¯¹ï¼set name hackyleshawe</li>
</ul>
<p><strong><img alt="image" height="315" width="908" style="display: block; margin-left: auto; margin-right: auto" data-src="https://img2024.cnblogs.com/blog/3067233/202602/3067233-20260211230636360-296586627.png" class="lazyload"></strong></p>
<p>2. å¨æ¬å°æºå¨ä¸å¼å¯æ¬å°ç«¯å£è½¬åï¼ssh -NT -L 26379:172.17.0.3:6379 <a href="mailto:root@8.145.45.70" rel="noopener nofollow"><u>root@8.145.45.70</u></a></p>
<ul>
<li>æ¬å°ç«¯å£ä½¿ç¨26379ï¼è½¬åçç®æ æ¯dockerçIP</li>
<li>docker redisè¿è¡çç«¯å£æ¶6379ï¼æä»¥â-L 26379:172.17.0.3:6379â</li>
</ul>
<p><strong><img alt="image" height="200" width="820" style="display: block; margin-left: auto; margin-right: auto" data-src="https://img2024.cnblogs.com/blog/3067233/202602/3067233-20260211230841057-1595647213.png" class="lazyload"></strong></p>
<p><strong>3.éªè¯ï¼å¨æ¬å°æºå¨ä¸è¿æ¥26379ç«¯å£ï¼è®¿é®å°è¿ç¨Dockerä¸­çRedis</strong></p>
<p><strong><img alt="image" height="329" width="826" style="display: block; margin-left: auto; margin-right: auto" data-src="https://img2024.cnblogs.com/blog/3067233/202602/3067233-20260211230947517-774638042.png" class="lazyload"></strong></p>
<h1><strong><u>ç»å°¾</u></strong></h1>
<p>æ¬æä¸»è¦éè¿°äºç¨SSHè®¿é®è¿ç¨æå¡å¨ä¸çåç½æå¡ï¼å¦ï¼Redisï¼çåçåæä½æ­¥éª¤ï¼åæ¶å¯¹é¨ç½²å¨Dockerä¸­çæå¡å¦ä½è®¿é®ä¹åäºè§£éè¯´æã</p>
<p>å¨æç« æåï¼å°è¯å¯¹èªå·±æé®ä¸ä¸é®é¢ï¼æ¥æ£éªä½ æ¯å¦çæ­£äºè§£å°äºæ¬æçæ ¸å¿åå®¹ï¼</p>
<ul>
<li>ä»ä¹æ¯SSHçæ¬å°ç«¯å£è½¬å(Local Port Forwardingï¼ï¼</li>
<li>ä»è½åä»ä¹ï¼è½å¸®ä½ è§£å³ä»ä¹é®é¢ï¼</li>
<li>æä¹ä½¿ç¨ï¼è¯­æ³æ¯ä»ä¹ï¼</li>
<li>åç½æå¡é¨ç½²å¨Dockeråå®¿ä¸»æºï¼ä½¿ç¨ç«¯å£è½¬åè®¿é®æ¶æä»ä¹åºå«ï¼</li>
</ul>
<p>æ¬æç»æã</p>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-02-11 23:13">2026-02-11 23:13</span>&nbsp;
<a href="https://www.cnblogs.com/hackyle">ALGOé¿ç</a>&nbsp;
éè¯»(<span id="post_view_count">63</span>)&nbsp;
è¯è®º(<span id="post_comment_count">1</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19606177);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19606177', targetLink: 'https://www.cnblogs.com/hackyle/p/19606177', title: 'å¦ä½ç¨SSHè®¿é®è¿ç¨æå¡å¨ä¸çåç½æå¡ï¼å¦ï¼MySQLãRedisãKafkaï¼ï¼' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ ä»é¶å¼å§å®ç°ä¸ä¸ªç®æjsonè§£æå¨ ]]></title>
    <link>https://www.cnblogs.com/xiaoxiongcanguan/p/19605794</link>
    <guid>1c2b2fb8de37c6f0d9bb583e9f32f4a0</guid>
    <description>
    <![CDATA[ 
	<h1 class="postTitle"><a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/xiaoxiongcanguan/p/19605794" title="åå¸äº 2026-02-11 20:23">
    <span role="heading" aria-level="2">ä»é¶å¼å§å®ç°ä¸ä¸ªç®æjsonè§£æå¨</span>
    

</a>
</h1>
	<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h1 id="ä»é¶å¼å§å®ç°ä¸ä¸ªç®æjsonè§£æå¨">ä»é¶å¼å§å®ç°ä¸ä¸ªç®æjsonè§£æå¨</h1>
<h2 id="1-mysimplejsonparser-ä»ç»ä¸æ´ä½è®¾è®¡">1. MySimpleJsonParser ä»ç»ä¸æ´ä½è®¾è®¡</h2>
<p>æè¿å¨å­¦ä¹ ç¼è¯åçç¸å³çç¥è¯ãä¸ºäºå æ·±å¯¹è¯æ³åæãè¯­æ³åæé¶æ®µä¸­è¯¸å¦<strong>æéèªå¨æºãèªé¡¶åä¸è¯­æ³åæãAST</strong> ç­æ¦å¿µççè§£ï¼æéæ©å®ç°ä¸ä¸ªjsonè§£æå¨ä½ä¸ºç»ææºä¼ã</p>
<h5 id="_"></h5>
<p>ç¸æ¯ç´æ¥å®ç°ä¸é¨å®æ´çç¼ç¨è¯­è¨ï¼å°jsonè§£æä½ä¸ºç»æå¯¹è±¡æå ä¸ªææ¾ä¼å¿ï¼</p>
<ol>
<li><strong>å ä¹é¶é¢å¤å­¦ä¹ ææ¬</strong>ï¼jsonä½ä¸ºä¸ç§è½»éçº§çæ°æ®äº¤æ¢æ ¼å¼æ¯æ¥å¸¸å¼åä¸­ä½¿ç¨æé¢ç¹çæ°æ®æ ¼å¼ä¹ä¸ã</li>
<li><strong>ææ³è¶³å¤ç®å</strong>ï¼å¯¹äºç¼è¯åçå¥é¨èæ¥è¯´ï¼è¥éæ©çè¯­è¨å¤ªå¤æï¼å¾å®¹æå¨è¯æ³/è¯­æ³è§åä¸è¢«åéï¼èjsonçè¯æ³åè¯­æ³æ¯è¾è§æ´ï¼è¯­æ³åææ¶éå¸¸åªéæ ¹æ®ä¸ä¸ä¸ªtokenå³å¯å³å®ASTçæé æ¹åã</li>
<li><strong>æ éè¿è¡æ¶</strong>ï¼jsonä¸æ¯ç¼ç¨è¯­è¨ï¼å¶å®å¨ä¸éè¦åç«¯çè¿è¡æ¶ãåªè¦è½æjsonææ¬è½¬æ¢ææ­£ç¡®çASTå°±å·²ç»ç®å®æä»»å¡ï¼å¨æ­¤åºç¡ä¸å®ç°ä¸ä¸ªåºäºASTçPretty JSONè¾åºï¼å°±è½äº§çä¸å®çæå°±æã</li>
</ol>
<h5 id="_-1"></h5>
<p>å¨æ¬ç¯åå®¢ä¸­ï¼æä»¬å°åºäº<strong>javaè¯­è¨</strong>ï¼ä¸ä¾èµä»»ä½ç¬¬ä¸æ¹åºï¼ä»é¶å¼å§å®ç°ä¸ä¸ªç®åçjsonè§£æå¨ï¼<strong>MySimpleJsonParser</strong>ãå¶åæ¬ä»¥ä¸å ä¸ªä¸»è¦æ¨¡åï¼</p>
<ol>
<li><strong><code>StaticJsonLexer</code></strong>ï¼ä¸æ¬¡æ§è§£æåºå¨é¨tokençéæjsonè¯æ³åæå¨</li>
<li><strong><code>StreamJsonLexer</code></strong>ï¼æéæ°æ§è§£ætokençæµå¼jsonè¯æ³åæå¨</li>
<li><strong><code>RecursiveJsonParser</code></strong>ï¼åºäºéå½çjsonè¯­æ³è§£æå¨</li>
<li><strong><code>StackBaseJsonParser</code></strong>ï¼åºäºæ¾å¼å æ çjsonè¯­æ³è§£æå¨ï¼ééå½ï¼</li>
<li><strong><code>ASTç»æ</code></strong>ï¼JsonElementåå¶å­ç±»ï¼å¹¶åºäºASTçæPretty JSONå­ç¬¦ä¸²çå·¥å·æ¹æ³</li>
</ol>
<h2 id="2-ä»ææ³å°è¯æ³åæå¨æå-json-lexer">2. ä»ææ³å°è¯æ³åæå¨ï¼æå json lexer</h2>
<p>è¯æ³åæé¶æ®µçä»»å¡æ¯ï¼å°åå§çå­ç¬¦æµï¼æç§jsonçè¯æ³è§åï¼è½¬æ¢ä¸ºtokenæµãä¹åçè¯­æ³åæä¼å¨tokenæµçåºç¡ä¸æææ³è§åæå»ºASTã</p>
<h3 id="21-jsonææ³ä¸åºæ¬ç»æ">2.1 jsonææ³ä¸åºæ¬ç»æ</h3>
<p>æ ¹æ®<a href="https://www.json.org/json-en.html" target="_blank" rel="noopener nofollow"><strong>jsonå®æ¹ææ¡£</strong></a>ï¼jsonä¸­ä¸»è¦åå«ä»¥ä¸å ç±»ç»æï¼</p>
<ol>
<li><strong>string</strong>ï¼ç±åå¼å·åä½çUnicodeå­ç¬¦ä¸²ï¼å¯åå«è½¬ä¹å­ç¬¦ãä¸ä¸ªå­ç¬¦ï¼characterï¼ä¹å¯ä»¥æ¯ä¸ä¸ªåç¬çå­ç¬¦ä¸²ï¼character stringï¼ã</li>
<li><strong>number</strong>ï¼ä»¥<code>0</code>æ<code>-</code>å¼å¤´ï¼å¯ä»¥æ¯æ´æ°ãå°æ°ããè´æ°æèæ¯åå«ä¸ä¸ªE/eç¬¦å·çææ°ã</li>
<li><strong>object</strong>ï¼ä»¥â<code>{</code>â å¼å¤´ï¼ä»¥â<code>}</code>âç»å°¾ã</li>
<li><strong>array</strong>ï¼ä»¥â<code>[</code>â å¼å¤´ï¼ä»¥â<code>]</code>âç»å°¾ã</li>
<li><strong>value</strong>ï¼å¯ä»¥æ¯stringãnumberã<code>true</code>(å³é®å­)ã<code>false</code>(å³é®å­)ã<code>null</code>(å³é®å­)ãobjectæèarrayã</li>
<li><strong>whitespace</strong>ï¼ç±ä»»æä¸ªspaceç©ºæ ¼ãlinefeedæ¢è¡ç¬¦ãcarriage returnåè½¦ç¬¦ä»¥åtabå¶è¡¨ç¬¦ç»æï¼æ¬èº«æ æä¹ï¼ä»èµ·å°åå²çä½ç¨ã</li>
</ol>
<h5 id="_-2"></h5>
<ul>
<li>ä»ç»åæåï¼åç°stringç»æãnumberç»æåwhitespaceç»æä»¥å<code>{</code>ã<code>}</code>ã<code>[</code>ã<code>]</code> è¿ç±»ç¬¦å·é½æ¯åºæ¬ç»æï¼æ¯èªèº«æ æ³ååµå¥å¶å®ç»æçåºæ¬ååï¼å æ­¤å¶é½æ¯æç»ASTä¸­çå¶å­èç¹ï¼èobjectãarrayåvalueé½æ¯å¯ä»¥äºç¸åµå¥çå¤åç»æï¼å¶é½æ¯ASTä¸­çéå¶å­èç¹ã</li>
<li>å¯¹äºè¿äºå¯åµå¥çéASTå¶å­èç¹ï¼å¿é¡»å¨è¯­æ³åæä¸­æè½å®æè§£æï¼èstringç»æãnumberç»æãfalseãtrueãnullå³é®å­ä»¥åâ{âãâ]âç­ç¹æ®ç¬¦å·ï¼åéåå¨è¯æ³åæä¸­å®æè§£æã<br>
å ä¸ºjsonè¯­æ³ä¸­ï¼æ è®ºåå§çjsonå­ç¬¦ä¸²ä¸­ä¸ä¸ªnumberå­é¢éæå¤å¤æ(æ¯å¦-2.03214e+6605218)ï¼å¨è¯­æ³åæä¸­é½åªéè¦å½åä¸ä¸ªå®æ´çnumberç±»åçtokenæ¥å¤çå³å¯ã</li>
<li>è¯æ³åæä¸æ³¨äºå±é¨ï¼å°åå§çå­ç¬¦æµæç§è¯æ³è§åæ­£ç¡®çè½¬æ¢ä¸ºtokenæµï¼èè¯­æ³åæåä¸æ³¨äºå°tokenæµæç§è¯­æ³è§åè½¬æ¢ä¸ºæ­£ç¡®çASTæ ç»æã<br>
éè¿å°æ´ä¸ªåææµç¨ï¼ææºçåè§£ä¸ºè¯æ³åæåè¯­æ³åæç­ç­ä¸åæ­¥éª¤ï¼æ¯ä¸ªæ­¥éª¤é½ä¾èµäºåä¸ä¸ªæ­¥éª¤çäº§åºçåå±è®¾è®¡ï¼è½å¤å¾å¥½çæ§å¶è§£æå¨æ´ä½çå¤æåº¦ï¼æ¹ä¾¿è°è¯çåæ¶æ§è½ä¸ä¹æå¾å¤§çæåã<br>
å æ­¤ï¼é¤äºå°æ°éå¸¸ç®åçè¯­è¨å¤ï¼å ä¹ææçç¼è¯å¨é½ä¼éç¨åå±çæ¶ææ¥å®ç°æ´ä½çåè½ã</li>
</ul>
<h3 id="22-tokenç±»åå®ä¹">2.2 tokenç±»åå®ä¹</h3>
<p>ä»ææ³è§åº¦ï¼jsonä¸­åè®¸çtokenç±»åå¤§è´å¯åä¸ºä¸ç±»ï¼</p>
<ol>
<li>ç¹æ®ç¬¦å·ï¼è¯¸å¦â<code>{</code>âãâ<code>}</code>âãâ<code>[</code>âãâ<code>]</code>âãâ<code>,</code>â,â<code>:</code>â,â<code>"</code>âç­ç¬ç«çå­ç¬¦æ¯jsonä¸­çç¹æ®ç¬¦å·</li>
<li>å³é®å­ï¼å®æ´ä¸ç¬ç«ç<code>true</code>ã<code>false</code>ã<code>null</code>è¢«è§ä¸ºå³é®å­</li>
<li>å­é¢éï¼numberãstringè¿ä¸¤ç§å¤æå­ç¬¦æµå­é¢é</li>
</ol>
<h5 id="_-3"></h5>
<p>å æ­¤æä»¬å¯ä»¥åå®ä¹åºjsonçtokenç±»åæä¸¾ãå¶ä¸­EOFç±»åæ¯é¢å¤çï¼ç¨äºå¨å®ææ´ä¸ªå­ç¬¦æµçè¯æ³åæåï¼è¿½å å°tokenæµçæåï¼æ å¿çtokenæµçç»æã</p>
<pre><code class="language-java">public enum JsonTokenTypeEnum {
    LEFT_BRACE("{"),
    RIGHT_BRACE("}"),

    LEFT_BRACKET("["),
    RIGHT_BRACKET("]"),

    COMMA(","),
    COLON(":"),

    TRUE("true"),
    FALSE("false"),
    NULL("null"),

    STRING("string"),
    NUMBER("number"),

    EOF("EOF"),
    ;
    private final String key;

    JsonTokenTypeEnum(String key) {
        this.key = key;
    }

    public String getKey() {
        return key;
    }
}
</code></pre>
<h3 id="23-è¯æ³åæå¨æ´ä½æ¡æ¶ä¸ç¹æ®å­ç¬¦çè¯æ³åæ">2.3 è¯æ³åæå¨æ´ä½æ¡æ¶ä¸ç¹æ®å­ç¬¦çè¯æ³åæ</h3>
<p>ç°å¨æä»¬å·²ç»ç¥éè¯¸å¦â{âãâ]âç­ç¬ç«å­ç¬¦æ¯jsonä¸­çç¹æ®ç¬¦å·ï¼ä½æ¯å½æä»¬å¨å­ç¬¦æµä¸­éå°äºä¸ä¸ªâ{âå­ç¬¦æ¶ï¼å¹¶ä¸è½æ èçå°å¶ä½ä¸ºä¸ä¸ªLEFT_BRACEç±»åçtokenæ¥å¤çãå ä¸ºå¦æå¶æ¯è¢«åå¼å·åè£¹çï¼ä½ä¸ºstringç±»åtokenåå®¹çä¸é¨åï¼é£ä¹å°±å¹¶ä¸è½å°å¶ç´æ¥å½åç¬ç«çtokenæ¥å¯¹å¾ã<br>
æä»¥ï¼è¯æ³åæä¸­ä¸è¬ä½¿ç¨æéç¶æèªå¨æºæ¥è§£å³æ­¤ç±»âåä¸å­ç¬¦å¨ä¸åä¸ä¸æå«ä¹ä¸åâçé®é¢ï¼å¨å¤æ­å¦ä½å¤çå­ç¬¦æµæ¶å¹¶ä¸ä»ä»åå³äºä¸ä¸ä¸ªå­ç¬¦æ¯ä»ä¹ï¼èè¿è¦ç»åå½åèªå¨æºçç¶ææ¥å³å®è¡ä¸ºã<br>
ä»¥ä¸è¿°å¯¹â{âå­ç¬¦çå¤çä¸ºä¾ï¼å¦ææ¯å¨åå§åç¶æä¸(å·²ç»å®æäºä¸ä¸ªå®æ´tokençè§£æ,åå¤å¼å§è§£æä¸ä¸ä¸ªæ°token)ï¼ç¢°å°â{âå­ç¬¦æ¶å¯ä»¥ç¡®å®çå°å¶è½¬åä¸ºLEFT_BRACEç±»åçtokenï¼ä½æ¯å½èªå¨æºå¤äºstringç±»åtokençè§£æç¶ææ¶ï¼åéè¦å°å¶ä½ä¸ºstringç±»åtokenåå®¹çä¸é¨åã</p>
<h5 id="jsonè¯æ³åæèªå¨æºæ»è§å¾">jsonè¯æ³åæèªå¨æºæ»è§å¾</h5>
<p>åºäºå®æ¹ææ¡£ä¸­çjsonææ³è§åï¼æä»¬å¯ä»¥è®¾è®¡åºä¸ä¸ªå¦ä¸å¾æç¤ºçjsonæéç¶æèªå¨æºæ¥å®ç°æä»¬çè¯æ³åæã<br>
<img src="https://img2024.cnblogs.com/blog/1506329/202602/1506329-20260211195126490-433213565.png" alt="lexer_total" loading="lazy"></p>
<h5 id="_-4"></h5>
<ul>
<li>å¨jsonè§£æä¸å¼å§ï¼èªå¨æºä½äºç¶æ0ï¼éåä¾¿ä¼åºäºå­ç¬¦æµçä¸ä¸ä¸ªå­ç¬¦çç±»åè¿è¡ç¶æè½¬æ¢ï¼å¨è¯»åå°è¯¸å¦â{âãâ[âãâ,âç­ç¬ç«ç¬¦å·æ¶ï¼ä¾¿ä¼ç´æ¥æ¥æ¶è¯¥å­ç¬¦ï¼æ¨è¿å­ç¬¦æµï¼åæ¶çæå¯¹åºç±»åçtokenã</li>
<li>å¨å®æ´çè§£æåºä¸ä¸ªå®æ´tokenåï¼èªå¨æºä¾¿ä¼éæ°åå°ç¶æ0ï¼åå¤å°è¯è§£æä¸ä¸ä¸ªæ°çtokenãç¶æ0åªè½åæ³çæ¥æ¶æéç§ç±»çå­ç¬¦ï¼å¯¹äºä¸ç¬¦åjsonææ³çå­ç¬¦å°è®¤ä¸ºå½åå­ç¬¦æµä¸æ¯åæ³çjsonå­ç¬¦ä¸²èç´æ¥æ¥éï¼éåºè§£æã</li>
<li>å¯¹äºæ´å¤æçstringç±»åãnumberç±»åtokençè§£æï¼æä»¬æ¾å¨åé¢çå°èåå±å¼ï¼æ»è§å¾ä¸­ææ¶çç¥ã</li>
</ul>
<h5 id="éæçè¯æ³åæå¨å®ç°">éæçè¯æ³åæå¨å®ç°</h5>
<pre><code class="language-java">public class StaticJsonLexer extends AbstractJsonLexer{

    public StaticJsonLexer(String jsonString) {
        super(jsonString);
    }

    /**
     * ä¸æ¬¡å®æ´çæ«æï¼éæµå¼çå¤ç
     * */
    public List&lt;JsonToken&gt; doLex(){
        char[] chars = super.jsonStringArray;

        // ç¸å½äºæ¯ç¶æ0
        while(doLexContext.currentIndex &lt; chars.length){
            char ch = chars[doLexContext.currentIndex];

            switch(ch){
                case '{':
                    doLexContext.tokenCollector.add(new JsonToken(JsonTokenTypeEnum.LEFT_BRACE));
                    doLexContext.currentIndex++;
                    break;
                case '}':
                    doLexContext.tokenCollector.add(new JsonToken(JsonTokenTypeEnum.RIGHT_BRACE));
                    doLexContext.currentIndex++;
                    break;
                case '[':
                    doLexContext.tokenCollector.add(new JsonToken(JsonTokenTypeEnum.LEFT_BRACKET));
                    doLexContext.currentIndex++;
                    break;
                case ']':
                    doLexContext.tokenCollector.add(new JsonToken(JsonTokenTypeEnum.RIGHT_BRACKET));
                    doLexContext.currentIndex++;
                    break;
                case ',':
                    doLexContext.tokenCollector.add(new JsonToken(JsonTokenTypeEnum.COMMA));
                    doLexContext.currentIndex++;
                    break;
                case ':':
                    doLexContext.tokenCollector.add(new JsonToken(JsonTokenTypeEnum.COLON));
                    doLexContext.currentIndex++;
                    break;
                case '"':
                    doLexContext.tokenCollector.add(parseString(chars, doLexContext));
                    break;
                case 't':
                    // å°è¯è§£ætrueå³é®å­
                    doLexContext.tokenCollector.add(parseTrueKeyword(chars, doLexContext));
                    break;
                case 'f':
                    // å°è¯è§£æfalseå³é®å­
                    doLexContext.tokenCollector.add(parseFalseKeyword(chars, doLexContext));
                    break;
                case 'n':
                    // å°è¯è§£ænullå³é®å­
                    doLexContext.tokenCollector.add(parseNullKeyword(chars, doLexContext));
                    break;
                default:
                    // å¶å®case
                    if(ch == '-' || CommonStringUtil.is0_9(ch)){
                        // numberè§£æ
                        JsonToken numberToken = parseNumber(chars, doLexContext);
                        doLexContext.tokenCollector.add(numberToken);
                        break;
                    }else if(CommonStringUtil.isWhitespace(ch)){
                        // whiteSpace ç´æ¥è·³è¿
                        doLexContext.currentIndex++;
                        break;
                    }else{
                        throw new MuJsonParserException("unexpected character: " + ch + " at index " + doLexContext.currentIndex);
                    }
            }
        }

        // æåå ä¸EOF
        doLexContext.tokenCollector.add(new JsonToken(JsonTokenTypeEnum.EOF));
        return doLexContext.tokenCollector;
    }
}
</code></pre>
<p>æ½è±¡ç¶ç±»<code>AbstractJsonLexer</code>å°è£äºstring/number/keywordç­å·ä½ç±»åçå¬å±è§£æé»è¾ï¼</p>
<pre><code class="language-java">public abstract class AbstractJsonLexer {

    protected final char[] jsonStringArray;

    protected final DoLexContext doLexContext;

    public AbstractJsonLexer(String jsonString) {
        this.jsonStringArray = jsonString.toCharArray();
        this.doLexContext = new DoLexContext();
    }

    protected JsonToken parseNumber(char[] chars, DoLexContext doLexContext){
        // numberç±»åçåå®¹
        String numberStr = new NumberLexStatemachine().tryParse(chars,doLexContext);

        return new JsonToken(JsonTokenTypeEnum.NUMBER, numberStr);
    }

    protected JsonToken parseString(char[] chars, DoLexContext doLexContext){
        // stringç±»åçåå®¹
        String stringStr = new StringLexStatemachine().tryParse(chars,doLexContext);

        return new JsonToken(JsonTokenTypeEnum.STRING, stringStr);
    }

    protected JsonToken parseTrueKeyword(char[] chars, DoLexContext doLexContext){
        // trueå³é®å­
        String stringStr = new KeywordTrueLexStatementMachine().tryParse(chars,doLexContext);

        return new JsonToken(JsonTokenTypeEnum.TRUE, stringStr);
    }

    protected JsonToken parseFalseKeyword(char[] chars, DoLexContext doLexContext){
        // falseå³é®å­
        String stringStr = new KeywordFalseLexStatementMachine().tryParse(chars,doLexContext);

        return new JsonToken(JsonTokenTypeEnum.FALSE, stringStr);
    }

    protected JsonToken parseNullKeyword(char[] chars, DoLexContext doLexContext){
        // nullå³é®å­
        String stringStr = new KeywordNullLexStatementMachine().tryParse(chars,doLexContext);

        return new JsonToken(JsonTokenTypeEnum.NULL, stringStr);
    }
}
</code></pre>
<h5 id="_-5"></h5>
<ul>
<li>ä¸ºäºæ¯æåç»­æµå¼çè¯æ³åæå¨ï¼éæçè¯æ³åæå¨StaticJsonLexerç»§æ¿èªAbstractJsonLexerç±»ï¼æé æ¹æ³ä¸­æ¥æ¶ä¸ä¸ªå­ç¬¦ä¸²ï¼å¹¶éè¿æ¹æ³doLexè¿è¡è§£æï¼è¿åä¸æ¬¡æ§å®æ´è§£æå­ç¬¦ä¸²åçtokenåè¡¨ã</li>
<li>doLexæ¹æ³ä¸­æ¯ä¸ä¸ªwhileå¾ªç¯ï¼æ¯ä¸æ¬¡å¾ªç¯å¼å§é½ç¸å½äºæ¯èªå¨æºä½äºç¶æ0ï¼å¨è§£ææ¶ä¼éè¿èªå¢currentIndexä¸æ­å°æ¨è¿å­ç¬¦æµï¼æåè§£æåºå®æ´çtokenåä¾¿ä¼å°æ°çtokenä¿å­å°ä¸ä¸æä¸­çtokenCollectorä¸­ãåªæå¨è§£ææ¥éæèæåå®æäºæ´ä¸ªå­ç¬¦ä¸²çè§£æåæä¼éåºå¾ªç¯ã</li>
<li>å¨æ­£å¸¸éåºwhileå¾ªç¯åï¼doLexæ¹æ³è¿ååtokenéåçå°¾é¨ä¼è¿½å ä¸ä¸ªç¹æ®çEOFç±»åçtokenï¼ç¨äºåç¥ä¸ä¸é¶æ®µçparserå·²ç»è§£æå°äºtokenæµçæ«å°¾ï¼è¯¥ç»æè§£æäºã</li>
</ul>
<h3 id="24-numberç±»åçè¯æ³åæ">2.4 numberç±»åçè¯æ³åæ</h3>
<p>numberçè¯æ³è§åç¸å¯¹å¤æï¼å ä¸ºnumberç±»åä½ä¸ºjsonä¸­è¡¨ç¤ºæ°å­çç»ä»¶ï¼å¶å¯ä»¥æ¯æ´æ°ï¼ä¹å¯ä»¥æ¯å°æ°ãè´æ°ï¼åæ¶è¿å¯ä»¥æ¯å¸¦ç¬¦å·e/Eçææ°å½¢å¼ã</p>
<h5 id="json-numberç±»åtokençè¯æ³è§å">json numberç±»åtokençè¯æ³è§å</h5>
<pre><code>number
    integer fraction exponent

integer
    digit
    onenine digits
    '-' digit
    '-' onenine digits

digits
    digit
    digit digits

digit
    '0'
    onenine

onenine
    '1' . '9'

fraction
    ""
    '.' digits

exponent
    ""
    'E' sign digits
    'e' sign digits

sign
    ""
    '+'
    '-'
</code></pre>
<p><img src="https://img2024.cnblogs.com/blog/1506329/202602/1506329-20260211195806369-790385529.png" alt="json_number_lex_rule" loading="lazy"></p>
<h5 id="_-6"></h5>
<p>åºäºä¸è¿°è¯æ³è§åï¼æä»¬å¯ä»¥æé åºå¦ä¸å¾æç¤ºçç¨äºè§£ænumberç±»åtokençç¶æèªå¨æºã</p>
<h5 id="numberç±»åè§£æçç¶æèªå¨æºç¤ºæå¾">numberç±»åè§£æçç¶æèªå¨æºç¤ºæå¾</h5>
<p><img src="https://img2024.cnblogs.com/blog/1506329/202602/1506329-20260211201818452-99218238.png" alt="json_number_lex_state_machine" loading="lazy"></p>
<h5 id="_-7"></h5>
<p>è®¾è®¡å¥½ä¸è¿°çç¶æèªå¨æºåï¼å°±å¯ä»¥æç§å¾ä¸­çç¶æè½¬ç§»å³ç³»æåä¸ä¸ªç®åçç¶ææºæ¥è§£ænumberç±»åçtokenäºã</p>
<h5 id="numberç±»åè§£æç¶ææºå®ç°æºç ">numberç±»åè§£æç¶ææºå®ç°æºç </h5>
<pre><code class="language-java">public class NumberLexStatemachine extends LexStatementMachine{

    private static final Map&lt;Integer,Boolean&gt; staticFinalStateMap;
    private static final LexStateHandler[] lexStateHandlers;

    static{
        staticFinalStateMap = new HashMap&lt;&gt;();
        staticFinalStateMap.put(-1,true);
        staticFinalStateMap.put(1,true);
        staticFinalStateMap.put(2,false);
        staticFinalStateMap.put(3,true);
        staticFinalStateMap.put(4,true);
        staticFinalStateMap.put(5,false);
        staticFinalStateMap.put(6,true);
        staticFinalStateMap.put(7,false);
        staticFinalStateMap.put(8,false);
        staticFinalStateMap.put(9,true);

        lexStateHandlers = new LexStateHandler[]{
            new State0Handler(), new State1Handler(), new State2Handler(), new State3Handler(), new State4Handler(),
            new State5Handler(),new State6Handler(),new State7Handler(),new State8Handler(),new State9Handler()
        };
    }

    public NumberLexStatemachine() {
        this.stateHandlers = lexStateHandlers;
        this.isFinalStateMap = staticFinalStateMap;
    }

    private static abstract class NumberLexStateHandler implements LexStateHandler {

        @Override
        public int processInState(char[] chars, DoLexContext doLexContext, LexStatementMachine lexStatementMachine, StringBuilder oneTokenAcceptResult) {
            char currentChar = chars[doLexContext.currentIndex];

            // whitespaceç¬¦å·ä»¥ånumberååæ³çç»ç»ç¬¦
            if(CommonStringUtil.isWhitespace(currentChar)
                || currentChar == ']' || currentChar == '}' || currentChar == ',' || currentChar == ':'){
                if(lexStatementMachine.currentStateIsFinal()){
                    // ç»ænumberçè§£æ
                    return -1;
                }else{
                    // éå°äºåéç¬¦ï¼ä½æ¯å½ånumberè§£æçç¶æä¸æ¯ç»æï¼æ æ³è½¬æ¢ä¸ºä¸ä¸ªåæ³çnumberç±»åçtokenï¼æå¼å¸¸
                    throw new MuJsonParserException("unexpected char " + currentChar + " " + doLexContext.currentIndex);
                }
            }

            return doProcessInState(currentChar,doLexContext, oneTokenAcceptResult);
        }

        abstract int doProcessInState(char currentChar, DoLexContext doLexContext, StringBuilder oneTokenAcceptResult);
    }

    private static class State0Handler extends NumberLexStateHandler {
        @Override
        int doProcessInState(char currentChar, DoLexContext doLexContext, StringBuilder oneTokenAcceptResult) {
            if(currentChar == '0'){
                // accept
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                // è¿å¥ç¶æ1
                return 1;
            }

            if(currentChar == '-'){
                // accept
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                // è¿å¥ç¶æ2
                return 2;
            }

            if(CommonStringUtil.is1_9(currentChar)){
                // accept
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                // è¿å¥ç¶æ3
                return 3;
            }

            throw new MuJsonParserException("unexpected char " + currentChar + " " + doLexContext.currentIndex);
        }
    }

    private static class State1Handler extends NumberLexStateHandler {
        @Override
        int doProcessInState(char currentChar, DoLexContext doLexContext, StringBuilder oneTokenAcceptResult) {
            if(currentChar == '.'){
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                return 5;
            }

            if(currentChar == 'e' || currentChar == 'E'){
                accept(currentChar,doLexContext, oneTokenAcceptResult);
                return 7;
            }

            throw new MuJsonParserException("unexpected char '" + currentChar + "', index=" + doLexContext.currentIndex);
        }
    }

    private static class State2Handler extends NumberLexStateHandler {
        @Override
        int doProcessInState(char currentChar, DoLexContext doLexContext, StringBuilder oneTokenAcceptResult) {
            if(currentChar == '0'){
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                return 1;
            }

            if(CommonStringUtil.is1_9(currentChar)){
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                return 3;
            }

            throw new MuJsonParserException("unexpected char " + currentChar + " " + doLexContext.currentIndex);
        }
    }

    private static class State3Handler extends NumberLexStateHandler {
        @Override
        int doProcessInState(char currentChar, DoLexContext doLexContext, StringBuilder oneTokenAcceptResult) {
            if(currentChar == '.'){
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                return 5;
            }

            if(currentChar == 'e' || currentChar == 'E'){
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                return 7;
            }

            if(CommonStringUtil.is0_9(currentChar)){
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                return 4;
            }

            throw new MuJsonParserException("unexpected char " + currentChar + " " + doLexContext.currentIndex);
        }
    }

    private static class State4Handler extends NumberLexStateHandler {
        @Override
        int doProcessInState(char currentChar, DoLexContext doLexContext,StringBuilder oneTokenAcceptResult) {
            if(currentChar == '.'){
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                return 5;
            }

            if(currentChar == 'e' || currentChar == 'E'){
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                return 7;
            }

            if(CommonStringUtil.is0_9(currentChar)){
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                return 4;
            }

            throw new MuJsonParserException("unexpected char " + currentChar + " " + doLexContext.currentIndex);
        }
    }

    private static class State5Handler extends NumberLexStateHandler {
        @Override
        int doProcessInState(char currentChar, DoLexContext doLexContext, StringBuilder oneTokenAcceptResult) {
            if(CommonStringUtil.is0_9(currentChar)){
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                return 6;
            }

            throw new MuJsonParserException("unexpected char " + currentChar + " " + doLexContext.currentIndex);
        }
    }

    private static class State6Handler extends NumberLexStateHandler {
        @Override
        int doProcessInState(char currentChar, DoLexContext doLexContext,StringBuilder oneTokenAcceptResult) {
            if(CommonStringUtil.is0_9(currentChar)){
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                return 6;
            }

            if(currentChar == 'e' || currentChar == 'E'){
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                return 7;
            }

            throw new MuJsonParserException("unexpected char " + currentChar + " " + doLexContext.currentIndex);
        }
    }

    private static class State7Handler extends NumberLexStateHandler {
        @Override
        int doProcessInState(char currentChar, DoLexContext doLexContext,StringBuilder oneTokenAcceptResult) {
            if(CommonStringUtil.is0_9(currentChar)){
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                return 9;
            }

            if(currentChar == '-' || currentChar == '+'){
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                return 8;
            }

            throw new MuJsonParserException("unexpected char " + currentChar + " " + doLexContext.currentIndex);
        }
    }

    private static class State8Handler extends NumberLexStateHandler {
        @Override
        int doProcessInState(char currentChar, DoLexContext doLexContext, StringBuilder oneTokenAcceptResult) {
            if(CommonStringUtil.is0_9(currentChar)){
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                return 9;
            }

            throw new MuJsonParserException("unexpected char " + currentChar + " " + doLexContext.currentIndex);
        }
    }

    private static class State9Handler extends NumberLexStateHandler {
        @Override
        int doProcessInState(char currentChar, DoLexContext doLexContext, StringBuilder oneTokenAcceptResult) {
            if(CommonStringUtil.is0_9(currentChar)){
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                return 9;
            }

            throw new MuJsonParserException("unexpected char " + currentChar + " " + doLexContext.currentIndex);
        }
    }
}

</code></pre>
<pre><code class="language-java">public abstract class LexStatementMachine {

    protected int currentState = 0;
    protected StringBuilder oneTokenAcceptResult = new StringBuilder();

    protected LexStateHandler[] stateHandlers;
    protected Map&lt;Integer,Boolean&gt; isFinalStateMap;

    public String tryParse(char[] chars, DoLexContext doLexContext){
        doParse(chars,doLexContext);

        boolean isFinalState = isFinalStateMap.get(currentState);
        if(isFinalState){
            return oneTokenAcceptResult.toString();
        }else{
            throw new MuJsonParserException(String.format("currentState is not finalState! acceptResult=%s, acceptResult=%s",currentState, oneTokenAcceptResult));
        }
    }

    public boolean currentStateIsFinal(){
        return isFinalStateMap.get(currentState);
    }

    protected static void accept(char currentChar, DoLexContext doLexContext, StringBuilder oneTokenAcceptResult){
        oneTokenAcceptResult.append(currentChar);
        doLexContext.currentIndex++;
    }

    private void doParse(char[] chars, DoLexContext doLexContext){
        // ä¸è¿æ¥æ¯ç¶æ0
        while(doLexContext.currentIndex &lt; chars.length){
            if(currentState == -1){
                // éå°äºåæ³çåéç¬¦å·ï¼éåºtokenè§£æ
                return;
            }

            if(currentState &gt;= stateHandlers.length){
                // æbug
                throw new MuJsonParserException(String.format("unknown state! currentState=%s",currentState));
            }
            LexStateHandler targetStateHandler = stateHandlers[currentState];
            
            currentState = targetStateHandler.processInState(chars,doLexContext,this,oneTokenAcceptResult);
        }
    }
}
</code></pre>
<h5 id="_-8"></h5>
<ul>
<li>NumberLexStatemachineç»§æ¿èªç¶ç±»LexStatementMachineãå¨LexStatementMachineä¸­ä¸doLexæ¹æ³ç±»ä¼¼ï¼ä¹æ¯ä¸ä¸ªwhileå¾ªç¯æ¥åå¤çå¤çæ¯ä¸æ¬¡çç¶æè·³è½¬ã</li>
<li>å­ç±»NumberLexStatemachineå®ä¹äºä¸ç³»åçLexStateHandlerç¶æå¤çå¨ï¼æ¯ä¸ä¸ªç¶æå¤çå¨é½å¯¹åºç¶ææºç¤ºæå¾ä¸­çä¸ä¸ªç¶æã</li>
<li>æ¯ä¸ä¸ªLexStateHandlerä¸­çåè½é½æ¯è¾ç±»ä¼¼ï¼å³å³å®å¨å½åç¶æä¸èªå·±è½å¤æ¥æ¶çå­ç¬¦ç±»åï¼ä»¥åæ§å¶å¨åæ³æ¥æ¶å­ç¬¦æµå½åå­ç¬¦ååºè¯¥è·³è½¬çä¸ä¸ä¸ªç¶ææ¯ä»ä¹ã<br>
å¨åæ³æ¥æ¶å­ç¬¦æ¶ï¼ä¼ä¿®æ¹ä¸ä¸æä¸­çå½åå­ç¬¦æéä»¥æ¨è¿å­ç¬¦æµï¼åæ¶å°æ¥åå°çå½ååæ³å­ç¬¦è¿½å å°oneTokenAcceptResultä¸­ã</li>
<li>å¦æéå°äºåæ³çç»æåéç¬¦ï¼æ¯å¦whitespaceæèâ}âãâ]âä¹ç±»çå­ç¬¦ï¼ä¸å½åç¶ææ¯å±äºnumberè§£æçç»æï¼åNumberLexStateHandlerä¼è¿å-1ï¼ç»æ­¢å½åtokençè§£æã(æ¯å¦{"number":-123.0}ç»ææ¶çç¶ææ¯6ï¼6æ¯ç»æï¼æä»¥å¶æ¯åæ³çjsonä¸²)<br>
å¦æç¶æå¤çå¨ä¸­éå°å½åç¶æä¸ä¸åæ³çå­ç¬¦ï¼æèå¨éåºè§£ææ¶å½åç¶æä¸å±äºnumberè§£æçç»æï¼è¯´æå½åå­ç¬¦ä¸²ä¸æ¯åæ³çjsonä¸²ï¼åä¼ç´æ¥æåºå¼å¸¸ï¼éåºè¯æ³è§£æã(æ¯å¦{"number":-123.}ç»ææ¶çç¶ææ¯5,5ä¸æ¯ç»æï¼æä»¥å¶æ¯ä¸åæ³çjsonä¸²)</li>
<li>NumberLexStatemachineç¶ææºæ­£å¸¸éåºå½ånumberç±»åtokenåï¼è¿åæ¶éå°çææå­ç¬¦oneTokenAcceptResultï¼ä½ä¸ºnumberç±»åçå­é¢éè¿åã</li>
</ul>
<h3 id="25-stringç±»åçè¯æ³åæ">2.5 stringç±»åçè¯æ³åæ</h3>
<p>stringç±»åçè¯æ³è§åç¸æ¯ä¹ä¸æ¯è¾ç®åï¼è¦æ±ä»¥åå¼å·å¼å¤´ï¼å¹¶ä»¥åå¼å·ç»å°¾å³å¯ï¼ä½éè¦é¢å¤å¤çè½¬ä¹å­ç¬¦ç¸å³çé»è¾ã</p>
<h5 id="json-stringç±»åtokençè¯æ³è§å">json stringç±»åtokençè¯æ³è§å</h5>
<pre><code>string
    '"' characters '"'

characters
    ""
    character characters

character
    '0020' . '10FFFF' - '"' - '\'
    '\' escape

escape
    '"'
    '\'
    '/'
    'b'
    'f'
    'n'
    'r'
    't'
    'u' hex hex hex hex

hex
    digit
    'A' . 'F'
    'a' . 'f'
</code></pre>
<p><img src="https://img2024.cnblogs.com/blog/1506329/202602/1506329-20260211195844242-1192651121.png" alt="json_string_lex_rule" loading="lazy"></p>
<h5 id="_-9"></h5>
<p>åºäºä¸è¿°è¯æ³è§åï¼æä»¬æé åºå¦ä¸å¾æç¤ºçç¨äºè§£æstringç±»åtokençç¶æèªå¨æºã</p>
<h5 id="stringç±»åè§£æçç¶æèªå¨æºç¤ºæå¾">stringç±»åè§£æçç¶æèªå¨æºç¤ºæå¾</h5>
<p><img src="https://img2024.cnblogs.com/blog/1506329/202602/1506329-20260211195854133-180088812.png" alt="json_string_lex_state_machine" loading="lazy"></p>
<h5 id="stringç±»åè§£æç¶ææºå®ç°æºç ">stringç±»åè§£æç¶ææºå®ç°æºç </h5>
<pre><code class="language-java">public class StringLexStatemachine extends LexStatementMachine{

    private static final Map&lt;Integer,Boolean&gt; staticFinalStateMap;
    private static final LexStateHandler[] lexStateHandlers;

    static{
        staticFinalStateMap = new HashMap&lt;&gt;();
        staticFinalStateMap.put(-1,true);
        staticFinalStateMap.put(1,false);
        staticFinalStateMap.put(2,true);
        staticFinalStateMap.put(3,false);
        staticFinalStateMap.put(4,false);
        staticFinalStateMap.put(5,false);
        staticFinalStateMap.put(6,false);
        staticFinalStateMap.put(7,false);

        lexStateHandlers = new LexStateHandler[]{
            new State0Handler(),new State1Handler(),new State2Handler(),new State3Handler(),new State4Handler(),
            new State5Handler(),new State6Handler(),new State7Handler()};
    }

    public StringLexStatemachine() {
        this.stateHandlers = lexStateHandlers;
        this.isFinalStateMap = staticFinalStateMap;
    }

    private static abstract class StringLexStateHandler implements LexStateHandler {

        @Override
        public int processInState(char[] chars, DoLexContext doLexContext, LexStatementMachine lexStatementMachine, StringBuilder oneTokenAcceptResult) {
            char currentChar = chars[doLexContext.currentIndex];

            return doProcessInState(currentChar,doLexContext,oneTokenAcceptResult);
        }

        abstract int doProcessInState(char currentChar, DoLexContext doLexContext, StringBuilder oneTokenAcceptResult);
    }

    private static class State0Handler extends StringLexStateHandler {
        @Override
        int doProcessInState(char currentChar, DoLexContext doLexContext, StringBuilder oneTokenAcceptResult) {
            if(currentChar == '"'){
                // accept
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                // è¿å¥ç¶æ1
                return 1;
            }

            throw new MuJsonParserException("unexpected char " + currentChar + " " + doLexContext.currentIndex);
        }
    }

    private static class State1Handler extends StringLexStateHandler {
        @Override
        int doProcessInState(char currentChar, DoLexContext doLexContext, StringBuilder oneTokenAcceptResult) {
            if(currentChar == '"'){
                // accept
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                // è¿å¥ç¶æ2
                return 2;
            }

            if(currentChar == '\\'){
                // accept
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                // è¿å¥ç¶æ3
                return 3;
            }

            // æ§å¶å­ç¬¦æ¯ä¸åæ³çï¼ä¸è½åºç°å¨stringä¸­
            if (currentChar &lt; 0x20) {
                throw new MuJsonParserException("unexpected control char " + currentChar + " in string, " + doLexContext.currentIndex);
            }

            // é¤äº["]å[\]ä¸¤ä¸ªå­ç¬¦ï¼å«çé½å½åå­ç¬¦ä¸²çä¸é¨åæ¥æ¶
            // accept
            accept(currentChar,doLexContext,oneTokenAcceptResult);
            return 1;
        }
    }

    private static class State2Handler extends StringLexStateHandler {
        @Override
        int doProcessInState(char currentChar, DoLexContext doLexContext, StringBuilder oneTokenAcceptResult) {
            // ç»æï¼å®æä¸ä¸ªstringçè§£æï¼ç´æ¥éåº
            return -1;
        }
    }

    private static class State3Handler extends StringLexStateHandler {
        @Override
        int doProcessInState(char currentChar, DoLexContext doLexContext, StringBuilder oneTokenAcceptResult) {
            // åæ³çè½¬ä¹å­ç¬¦
            if(currentChar == '"' || currentChar == '\\' || currentChar == '/' ||
                currentChar == 'b' || currentChar == 'f' || currentChar == 'n' ||
                currentChar == 'r' || currentChar == 't'){
                // æ¥æ¶ï¼åå°ç¶æ1
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                return 1;
            }

            if(currentChar == 'u'){
                // ç¹æ®case è¦æ±åé¢è¿ç»­4ä¸ªhexå­ç¬¦ '\\u hex hex hex hex'
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                return 4;
            }

            throw new MuJsonParserException("unexpected char " + currentChar + " " + doLexContext.currentIndex);
        }
    }

    private static class State4Handler extends StringLexStateHandler {
        @Override
        int doProcessInState(char currentChar, DoLexContext doLexContext, StringBuilder oneTokenAcceptResult) {
            if(CommonStringUtil.isHex(currentChar)){
                // æ¥æ¶ï¼è¿å¥ç¶æ5
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                return 5;
            }

            throw new MuJsonParserException("unexpected char " + currentChar + " " + doLexContext.currentIndex);
        }
    }

    private static class State5Handler extends StringLexStateHandler {
        @Override
        int doProcessInState(char currentChar, DoLexContext doLexContext, StringBuilder oneTokenAcceptResult) {
            if(CommonStringUtil.isHex(currentChar)){
                // æ¥æ¶ï¼è¿å¥ç¶æ6
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                return 6;
            }

            throw new MuJsonParserException("unexpected char " + currentChar + " " + doLexContext.currentIndex);
        }
    }

    private static class State6Handler extends StringLexStateHandler {
        @Override
        int doProcessInState(char currentChar, DoLexContext doLexContext, StringBuilder oneTokenAcceptResult) {
            if(CommonStringUtil.isHex(currentChar)){
                // æ¥æ¶ï¼è¿å¥ç¶æ7
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                return 7;
            }

            throw new MuJsonParserException("unexpected char " + currentChar + " " + doLexContext.currentIndex);
        }
    }

    private static class State7Handler extends StringLexStateHandler {
        @Override
        int doProcessInState(char currentChar, DoLexContext doLexContext, StringBuilder oneTokenAcceptResult) {
            if(CommonStringUtil.isHex(currentChar)){
                // è¿ç»­æ¥æ¶äº4ä¸ªhexå­ç¬¦ï¼åå°ç¶æ1
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                return 1;
            }

            throw new MuJsonParserException("unexpected char " + currentChar + " " + doLexContext.currentIndex);
        }
    }
}
</code></pre>
<h5 id="_-10"></h5>
<ul>
<li>stringç±»åtokenè§£æçç¶ææºä¸numberç±»åçå·¥ä½æ¨¡å¼ç±»ä¼¼ï¼åæ ·ç»§æ¿èªLexStatementMachineï¼å¹¶ä¸å®ä¹äºä¸ç³»åçå¯¹åºç¶ææºç¤ºæå¾ä¸­åä¸ªç¶æçLexStateHandlerã</li>
</ul>
<h3 id="26-å³é®å­çè¯æ³åæ">2.6 å³é®å­çè¯æ³åæ</h3>
<p>æåï¼jsonçè¯æ³åæä¸­è¿æå³é®å­ç±»åçtokenè§£æéè¦å®ç°ãæå¹¸jsonçææ³éå¸¸ç®åï¼åªætrueãfalseånullä¸ä¸ªå³é®å­ï¼ä¸è¿ä¸ä¸ªå³é®å­çf(1)é½ä¸ç¸åï¼ä¹ä¸å¶å®ç±»åçtokençf(1)ä¸ç¸åã<br>
å æ­¤ï¼å¨è¯æ³è§£ææ¶ï¼æä»¬å¯ä»¥å¾ç®åçæ ¹æ®ç¬¬ä¸ä¸ªå­ç¬¦æ¥å³å®è¦è§£æçå³é®å­ç±»åï¼å¨ç¶æ0æ¶ï¼å¦æç¢°å°å­ç¬¦tå°±å°è¯è§£ætrueç±»åçtokenï¼ç¢°å°å­ç¬¦få°±å°è¯è§£æfalseç±»åçtokenï¼ç¢°å°å­ç¬¦nå°±å°è¯è§£ænullç±»åçtokenã<br>
å æ­¤æä»¬å¯ä»¥å¾ç®åçå¾å°å¦ä¸å¾æç¤ºçä¸ä¸ªå³é®å­çç¶æèªå¨æºã</p>
<h5 id="å³é®å­ç±»åè§£æçç¶æèªå¨æºç¤ºæå¾">å³é®å­ç±»åè§£æçç¶æèªå¨æºç¤ºæå¾</h5>
<p><img src="https://img2024.cnblogs.com/blog/1506329/202602/1506329-20260211195910810-282453956.png" alt="json_keyword_lex_state_machine" loading="lazy"></p>
<h5 id="keywordç±»åè§£æç¶ææºå®ç°æºç ">keywordç±»åè§£æç¶ææºå®ç°æºç </h5>
<pre><code class="language-java">public abstract class KeywordLexStatementMachine extends LexStatementMachine{

    protected final String keyword;

    public KeywordLexStatementMachine(String keyword) {
        this.keyword = keyword;
    }

    protected static Map&lt;Integer,Boolean&gt; buildIsFinalStateMap(String keyword){
        Map&lt;Integer,Boolean&gt; isFinalStateMap = new HashMap&lt;&gt;(keyword.length() + 1);
        isFinalStateMap.put(-1,true);

        for(int i=0; i&lt;keyword.length(); i++) {
            isFinalStateMap.put(i,false);
        }

        // æåä¸ä¸ªå­ç¬¦å°±æ¯åççç»æ
        isFinalStateMap.put(keyword.length(),true);

        return isFinalStateMap;
    }

    protected static LexStateHandler[] buildLexStateHandlers(String keyword){
        LexStateHandler[] lexStateHandlers = new LexStateHandler[keyword.length() + 1];

        for(int i=0; i&lt;keyword.length(); i++) {
            char c = keyword.charAt(i);

            lexStateHandlers[i] = new KeywordLexStateHandler(c,i+1);
        }

        // æåä¸ä¸ªç¶æï¼ç´æ¥è¿å
        lexStateHandlers[keyword.length()] = new KeywordLexStateHandler(' ',-1);

        return lexStateHandlers;
    }

    private static class KeywordLexStateHandler implements LexStateHandler {

        private final char targetCh;
        private final int nextState;

        public KeywordLexStateHandler(char targetCh, int nextState) {
            this.targetCh = targetCh;
            this.nextState = nextState;
        }

        @Override
        public int processInState(char[] chars, DoLexContext doLexContext, LexStatementMachine lexStatementMachine, StringBuilder oneTokenAcceptResult) {
            char currentChar = chars[doLexContext.currentIndex];

            return doProcessInState(currentChar,doLexContext,oneTokenAcceptResult);
        }

        private int doProcessInState(char currentChar, DoLexContext doLexContext, StringBuilder oneTokenAcceptResult){
            if(nextState == -1){
                // -1æ¯ç¹æ®çç´æ¥è¿å
                return nextState;
            }

            if(currentChar == targetCh) {
                // æ¥æ¶ï¼è¿å¥ä¸ä¸ä¸ªç¶æ
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                return nextState;
            }

            throw new MuJsonParserException("unexpected char " + currentChar + " " + doLexContext.currentIndex);
        }
    }
}
</code></pre>
<pre><code class="language-java">/**
 * è§£æå³é®å­trueçç¶æèªå¨æº
 * */
public class KeywordTrueLexStatementMachine extends KeywordLexStatementMachine{

    private static final String KEYWORD = JsonTokenTypeEnum.TRUE.getKey();
    private static final Map&lt;Integer,Boolean&gt; staticIsFinalStateMap;
    private static final LexStateHandler[] lexStateHandlers;

    static {
        staticIsFinalStateMap = buildIsFinalStateMap(KEYWORD);
        lexStateHandlers = buildLexStateHandlers(KEYWORD);
    }

    public KeywordTrueLexStatementMachine() {
        super(KEYWORD);

        super.isFinalStateMap = staticIsFinalStateMap;
        super.stateHandlers = lexStateHandlers;
    }
}
</code></pre>
<h5 id="_-11"></h5>
<ul>
<li>ç±äºå³é®å­çè§£æé½æ¯æç®åçååç¶æè½¬ç§»ï¼æä»¥åç¬æ½è±¡åºäºKeywordLexStatementMachineç±»ï¼å¶æ ¹æ®æé æ¹æ³ä¸­ä¼ å¥çå³é®å­å­é¢éï¼èªå¨çæå¯¹åºæ°éçLexStateHandleréååIsFinalStateMapã</li>
<li>falseånullå³é®å­çè¯æ³è§£æä¸trueåºæ¬ä¸è´ï¼è¿éçç¥æ</li>
</ul>
<h5 id="27-jsontokenreader">2.7 jsonTokenReader</h5>
<p>è³æ­¤ï¼æä»¬å°±å·²ç»å®ç°äºåºæ¬çjsonè¯æ³åæè½åï¼è½å¤å°jsonå­ç¬¦ä¸²ä¸æ¬¡æ§çè§£æætokenåè¡¨ä¾ä¸ä¸é¶æ®µçè¯­æ³åæä½¿ç¨ã<br>
ä½å¨è¯­æ³è§£æé¶æ®µï¼parseræ´å¸ææ¥æ¶çæ¯è½å¤èªå·±è®°å¿å½åæå¤çtokençtokenæµï¼èä¸æ¯ä¸ä¸ªå­¤é¶é¶çList<jsontoken>ï¼æä»¥è¿éç®åçä»¥è¿­ä»£å¨çæ¹å¼åè£ä¸ä¸æ¹ä¾¿ä½¿ç¨ã</jsontoken></p>
<pre><code class="language-java">public interface JsonTokenReader {

    boolean hasNextToken();

    JsonToken nextToken();

    JsonToken peek();

    int currentIndex();
}
</code></pre>
<p>éæè¯æ³åæå¨çå®ç°ï¼</p>
<pre><code class="language-java">public class StaticJsonTokenReader implements JsonTokenReader {

    private int currentIndex;

    private final List&lt;JsonToken&gt; tokens;

    public StaticJsonTokenReader(String jsonString) {
        this.currentIndex = 0;

        StaticJsonLexer staticJsonLexer = new StaticJsonLexer(jsonString);
        this.tokens = staticJsonLexer.doLex();
    }

    @Override
    public boolean hasNextToken() {
        return tokens.get(currentIndex).getType() != JsonTokenTypeEnum.EOF;
    }

    @Override
    public JsonToken nextToken() {
        JsonToken jsonToken = tokens.get(currentIndex);
        currentIndex++;
        return jsonToken;
    }

    @Override
    public JsonToken peek() {
        return tokens.get(currentIndex);
    }

    @Override
    public int currentIndex() {
        return this.currentIndex;
    }
}
</code></pre>
<p>ç®ådemoï¼</p>
<pre><code class="language-java">    public static void main(String[] args) {
        String json = "{\"k1\":{\"abc\":123},\"k2\":true}";

        StaticJsonLexer staticJsonLexer = new StaticJsonLexer(json);
        List&lt;JsonToken&gt; jsonTokenList = staticJsonLexer.doLex();
        System.out.println("json=" + json);
        jsonTokenList.forEach(System.out::println);
    }
</code></pre>
<p><img src="https://img2024.cnblogs.com/blog/1506329/202602/1506329-20260211195926464-23510035.png" alt="static_json_lexer_demo_result" loading="lazy"></p>
<h2 id="3-æå-json-è¯­æ³åæå¨ä»-token-å°-ast">3. æå json è¯­æ³åæå¨ï¼ä» token å° AST</h2>
<p>è¯­æ³åæé¶æ®µï¼æ¥æ¶è¯æ³åæé¶æ®µè¾åºçtokenæµï¼éè¦æç§è¯­æ³è§åè§£æåºæ­£ç¡®çASTæ½è±¡è¯­æ³æ ã<br>
å¨jsonçASTä¸­å¶å®æ¬è´¨ä¸åªæä¸ç§ç±»åçåç´ ï¼</p>
<ul>
<li><code>JsonObject</code>ï¼å¯¹è±¡</li>
<li><code>JsonArray</code>ï¼æ°ç»</li>
<li><code>JsonPrimitiveStr</code>ï¼primitiveåºç¡ç±»åï¼string/number/true/false/nullï¼å°è£ä¸ºå­ç¬¦ä¸²å­é¢é</li>
</ul>
<h5 id="_-12"></h5>
<p>primitiveåºç¡ç±»åæ¯æ æ³è¿è¡éå½åµå¥çç±»åï¼æ¯ASTä¸­çå¶èç¹ï¼èobjectåarrayåæ¯å¯ä»¥äºç¸åµå¥ç(å¯¹è±¡çä¸ä¸ªå±æ§å¯ä»¥æ¯æ°ç»æèå¦ä¸ä¸ªå¯¹è±¡ï¼æ°ç»ä¸­çåç´ ä¹å¯ä»¥æ¯å¯¹è±¡æèå¦ä¸ä¸ªæ°ç»)ï¼å¶å±äºASTä¸­çéå¶å­ç»ç¹ã</p>
<h3 id="31-json-astèç¹ç»æå®ä¹">3.1 json ASTèç¹ç»æå®ä¹</h3>
<pre><code class="language-java">public abstract class JsonElement {
}
</code></pre>
<pre><code class="language-java">/**
 * json ASTçobjectç±»åèç¹
 * */
public class JsonObject extends JsonElement{

    private final Map&lt;String,JsonElement&gt; objMap = new LinkedHashMap&lt;&gt;();

    public void putKV(String key, JsonElement value) {
        objMap.put(key, value);
    }

    public Map&lt;String, JsonElement&gt; getObjMap() {
        return objMap;
    }
}
</code></pre>
<pre><code class="language-java">/**
 * json ASTçarrayç±»åèç¹
 * */
public class JsonArray extends JsonElement{

    private List&lt;JsonElement&gt; array = new ArrayList&lt;&gt;();

    public void addElement(JsonElement element) {
        array.add(element);
    }

    public List&lt;JsonElement&gt; getArray() {
        return array;
    }
}
</code></pre>
<pre><code class="language-java">/**
 * json ASTçprimitiveç±»åèç¹
 * */
public class JsonPrimitiveStr extends JsonElement{

    /**
     * åºç¡ç±»åçå­ç¬¦ä¸²å­é¢é
     * */
    private final String primitiveValueStr;

    public JsonPrimitiveStr(String primitiveValueStr) {
        this.primitiveValueStr = primitiveValueStr;
    }

    public String getPrimitiveValueStr() {
        return primitiveValueStr;
    }
}
</code></pre>
<h5 id="_-13"></h5>
<ul>
<li>jsonElementæ¯ææASTèç¹çå±åæ½è±¡ç¶ç±»</li>
<li>jsonçobjectç»ææ å°ä¸ºjavaä¸­æ¯ä¸ä¸ªæåºçk/v Mapç»æ</li>
<li>jsonçarrayç»ææ å°ä¸ºjavaä¸­æ¯ä¸ä¸ªListç»æ</li>
<li>jsonçprimitiveç»ææ å°ä¸ºjavaä¸­çä¸ä¸ªç®åå­ç¬¦ä¸²å­é¢é</li>
</ul>
<h3 id="32-jsonæ ¹èç¹è¯­æ³è§£æ">3.2 jsonæ ¹èç¹è¯­æ³è§£æ</h3>
<pre><code>json
    element
    
element
    ws value ws

value
    object
    array
    string
    number
    "true"
    "false"
    "null"

object
    '{' ws '}'
    '{' members '}'    

array
    '[' ws ']'
    '[' elements ']'
</code></pre>
<h5 id="_-14"></h5>
<p>ä¸è¿°ææ³ä¸­ï¼jsonæ¯ASTçæ ¹èç¹ï¼å¶æç»å¯ä»¥æ¯objectãarrayæè5ç§åºæ¬ç±»åçä¸ç§ã<br>
objectç±»åçf(1)æä¸ä»æ'{'ï¼èarrayç±»åçf(1)æä¸ä»æ'['ï¼å æ­¤æä»¬å¯ä»¥æé åºä¸ä¸ªç®åçæ ¹èç¹è§£æçç¶ææºæ¥å®ç°è¯­æ³åæã</p>
<ul>
<li>è¥tokenæµä¸­çç¬¬ä¸ä¸ª token æ¯ <code>{</code> â è§£æä¸º <code>JsonObject</code>ã</li>
<li>è¥tokenæµä¸­çç¬¬ä¸ä¸ª token æ¯ <code>[</code> â è§£æä¸º <code>JsonArray</code>ã</li>
<li>è¥tokenæµä¸­çç¬¬ä¸ä¸ª token æ¯åºç¡ç±»å â è§£æä¸º <code>JsonPrimitiveStr</code>ã</li>
<li>å¦åé½æ¯éæ³jsonã</li>
</ul>
<h5 id="jsonæ ¹èç¹è¯­æ³è§£æç¶æèªå¨æº">jsonæ ¹èç¹è¯­æ³è§£æç¶æèªå¨æº</h5>
<p><img src="https://img2024.cnblogs.com/blog/1506329/202602/1506329-20260211195937409-994915878.png" alt="json_parser_root" loading="lazy"></p>
<h5 id="jsonæ ¹èç¹è§£æç¶æèªå¨æºå®ç°">jsonæ ¹èç¹è§£æç¶æèªå¨æºå®ç°</h5>
<pre><code class="language-java">/**
 * åºäºéå½å®ç°çjsonè§£æå¨
 * */
public class RecursiveJsonParser extends JsonParser {

    public RecursiveJsonParser(JsonTokenReader tokenReader) {
        super(tokenReader);
    }

    @Override
    public JsonElement doParse() {
        JsonToken token = jsonTokenReader.peek();

        if (token.getType() == JsonTokenTypeEnum.LEFT_BRACE) {
            JsonObjectParseStatementMachine jsonObjectParseStatementMachine = new JsonObjectParseStatementMachine(jsonTokenReader);

            return jsonObjectParseStatementMachine.parseJsonElement();
        }

        if (token.getType() == JsonTokenTypeEnum.LEFT_BRACKET) {
            JsonArrayParseStatementMachine jsonArrayParseStatementMachine = new JsonArrayParseStatementMachine(jsonTokenReader);

            return jsonArrayParseStatementMachine.parseJsonElement();
        }

        // åºç¡ç±»åçvalue
        if (token.getType().isPrimitiveValue()) {
            return new JsonPrimitiveStr(token.getContent());
        }

        // ç¬¬ä¸ä¸ªtokenï¼ä¸å±äºjsonè§åçf(1)éå
        throw new MuJsonParserException("unexpected start json token! token=" + jsonTokenReader.currentIndex());
    }
}
</code></pre>
<pre><code class="language-java">public enum JsonTokenTypeEnum {
    // çç¥äºæ å³é»è¾

    /**
     * åºç¡ç±»åçvalueï¼stringãnumberãtrueãfalseãnullï¼
     * */
    public boolean isPrimitiveValue(){
        return this == STRING || this == NUMBER || this == NULL ||this == TRUE || this == FALSE;
    }
}
</code></pre>
<h3 id="33-json-objectå¯¹è±¡ç»æè§£æ">3.3 json objectå¯¹è±¡ç»æè§£æ</h3>
<p>ç°å¨æä»¬æ¥ç ç©¶json objectå¯¹è±¡çè¯­æ³è§£æãobjectç»ææ¯ä»¥â{âå¼å¤´ï¼â}âç»å°¾çç»æï¼åé¨å¯ä»¥æ0å°Nä¸ªkvé®å¼å¯¹ï¼å¶ä¸­keyå¿é¡»æ¯stringç±»åï¼èvalueåå¯ä»¥æ¯åµå¥çç»æï¼keyåvalueä¹é´ä»¥åå·åéï¼kvå¯¹ä¹é´ä»¥éå·åå²ã<br>
å æ­¤ï¼ä½¿ç¨éå½çæ¹å¼æ¥å®ç°objectå¯¹è±¡çè¯­æ³è§£ææ¯å¾å®¹æçè§£åå®ç°ç(å°½ç®¡éå½çå®ç°æçä¸å¤é«)ã</p>
<h5 id="json-objectå¯¹è±¡ç»æè¯­æ³">json objectå¯¹è±¡ç»æè¯­æ³</h5>
<pre><code>object
    '{' ws '}'
    '{' members '}'

members
    member
    member ',' members

member
    ws string ws ':' element

element
    ws value ws    

value
    object
    array
    string
    number
    "true"
    "false"
    "null"
</code></pre>
<p><img src="https://img2024.cnblogs.com/blog/1506329/202602/1506329-20260211195946762-1722527366.png" alt="json_object_parser" loading="lazy"></p>
<h5 id="objectç»æè§£æç¶æèªå¨æºç¤ºæå¾">objectç»æè§£æç¶æèªå¨æºç¤ºæå¾</h5>
<p><img src="https://img2024.cnblogs.com/blog/1506329/202602/1506329-20260211195955922-1227811677.png" alt="json_object_state_machine" loading="lazy"></p>
<h5 id="objectç»æè§£æç¶æèªå¨æºéå½å®ç°éå½çæ¬">objectç»æè§£æç¶æèªå¨æºéå½å®ç°ï¼éå½çæ¬ï¼</h5>
<p>è¯­æ³åæä¸è¯æ³åæç±»ä¼¼ï¼ä¹æ¯ä½¿ç¨ç¶æèªå¨æºæ¥å®ç°çãå®ç°çå¤§è´æ¹å¼ä¹æ¯éè¿æ½è±¡åºä¸ä¸ªç¶ç±»(AbstractJsonParseStatementMachine),å¨ç¶ç±»ä¸­éè¿æç»­ä¸æ­çä»tokenæµä¸­è¯»åtokenæ¥æ¨è¿ç¶æãå¨å­ç±»ä¸­å®ä¹ç¸åºçç¶æå¤çå¨æ¥å®ç°æ¯ä¸ªç¶æçå¤ç</p>
<pre><code class="language-java">/**
 * åºäºéå½å®ç°ç objectç±»åè¯­æ³è§£æç¶æèªå¨æº
 * */
public class JsonObjectParseStatementMachine extends AbstractJsonParseStatementMachine&lt;JsonObject&gt;{

    public JsonObjectParseStatementMachine(JsonTokenReader jsonTokenReader) {
        this.jsonTokenReader = jsonTokenReader;
        this.targetJsonElement = new JsonObject();
        this.recursiveDoParserContext = new RecursiveDoParserContext&lt;&gt;(this.targetJsonElement);
        stateHandlers = new ParserStateHandler[]{
            new ParserState0Handler(),new ParserState1Handler(),new ParserState2Handler(),new ParserState3Handler(),
            new ParserState4Handler(),new ParserState5Handler(),new ParserState6Handler()
        };
    }

    private static class ParserState0Handler implements ParserStateHandler&lt;JsonObject&gt;{

        @Override
        public int processInState(JsonTokenReader jsonTokenReader, RecursiveDoParserContext&lt;JsonObject&gt; recursiveDoParserContext) {
            JsonToken token = jsonTokenReader.peek();

            if(token.getType() != JsonTokenTypeEnum.LEFT_BRACE){
                throw new MuJsonParserException("unexpected token! index=" + jsonTokenReader.currentIndex());
            }

            accept(jsonTokenReader);
            return 1;
        }
    }

    private static class ParserState1Handler implements ParserStateHandler&lt;JsonObject&gt;{

        @Override
        public int processInState(JsonTokenReader jsonTokenReader, RecursiveDoParserContext&lt;JsonObject&gt; recursiveDoParserContext) {
            JsonToken token = jsonTokenReader.peek();

            if(token.getType() == JsonTokenTypeEnum.RIGHT_BRACE){
                accept(jsonTokenReader);
                return 2;
            }

            if(token.getType() == JsonTokenTypeEnum.STRING){
                // ækeyååå¥æ ä¸­ï¼ç¶åç­æé kvå¯¹æ¶å¼¹åº
                recursiveDoParserContext.getTokenStack().push(token);
                accept(jsonTokenReader);
                return 3;
            }

            throw new MuJsonParserException("unexpected token! index=" + jsonTokenReader.currentIndex());
        }
    }

    private static class ParserState2Handler implements ParserStateHandler&lt;JsonObject&gt;{

        @Override
        public int processInState(JsonTokenReader jsonTokenReader, RecursiveDoParserContext&lt;JsonObject&gt; recursiveDoParserContext) {
            // ç»æï¼ç´æ¥è¿å
            return -1;
        }
    }

    private static class ParserState3Handler implements ParserStateHandler&lt;JsonObject&gt;{

        @Override
        public int processInState(JsonTokenReader jsonTokenReader, RecursiveDoParserContext&lt;JsonObject&gt; recursiveDoParserContext) {
            JsonToken token = jsonTokenReader.peek();

            if(token.getType() == JsonTokenTypeEnum.COLON){
                accept(jsonTokenReader);
                return 4;
            }

            throw new MuJsonParserException("unexpected token! index=" + jsonTokenReader.currentIndex());
        }
    }

    private static class ParserState4Handler implements ParserStateHandler&lt;JsonObject&gt;{

        @Override
        public int processInState(JsonTokenReader jsonTokenReader, RecursiveDoParserContext&lt;JsonObject&gt; recursiveDoParserContext) {
            JsonToken token = jsonTokenReader.peek();

            JsonToken keyToken = recursiveDoParserContext.getTokenStack().pop();
            Assert.assertTrue(keyToken != null &amp;&amp; keyToken.getType() == JsonTokenTypeEnum.STRING,"parse object keyToken not match!");

            // åµå¥çjsonObjectç»æ
            if(token.getType() == JsonTokenTypeEnum.LEFT_BRACE){
                JsonObjectParseStatementMachine jsonObjectParseStatementMachine = new JsonObjectParseStatementMachine(jsonTokenReader);

                JsonObject subJsonObject = jsonObjectParseStatementMachine.parseJsonElement();

                // æé å¥½äºä¸ä¸ªkvå¯¹ï¼key : objï¼
                recursiveDoParserContext.getTargetJsonElement().putKV(keyToken.getContent(), subJsonObject);

                return 5;
            }

            // åµå¥çjsonArrayç»æ
            if(token.getType() == JsonTokenTypeEnum.LEFT_BRACKET){
                // jsonArrayç¶ææº
                JsonArrayParseStatementMachine jsonArrayParseStatementMachine = new JsonArrayParseStatementMachine(jsonTokenReader);

                JsonArray jsonArray = jsonArrayParseStatementMachine.parseJsonElement();
                // æé å¥½äºä¸ä¸ªkvå¯¹ (key ï¼array)
                recursiveDoParserContext.getTargetJsonElement().putKV(keyToken.getContent(), jsonArray);

                return 5;
            }

            // åºç¡ç±»åçvalue
            if(token.getType().isPrimitiveValue()){
                accept(jsonTokenReader);
                recursiveDoParserContext.getTargetJsonElement().putKV(keyToken.getContent(), new JsonPrimitiveStr(token.getContent()));

                return 5;
            }

            throw new MuJsonParserException("unexpected token! index=" + jsonTokenReader.currentIndex());
        }
    }

    private static class ParserState5Handler implements ParserStateHandler&lt;JsonObject&gt;{

        @Override
        public int processInState(JsonTokenReader jsonTokenReader, RecursiveDoParserContext&lt;JsonObject&gt; recursiveDoParserContext) {
            JsonToken token = jsonTokenReader.peek();

            if(token.getType() == JsonTokenTypeEnum.RIGHT_BRACE){
                accept(jsonTokenReader);
                return 2;
            }

            if(token.getType() == JsonTokenTypeEnum.COMMA){
                accept(jsonTokenReader);
                return 6;
            }

            throw new MuJsonParserException("unexpected token! index=" + jsonTokenReader.currentIndex());
        }
    }

    private static class ParserState6Handler implements ParserStateHandler&lt;JsonObject&gt;{

        @Override
        public int processInState(JsonTokenReader jsonTokenReader, RecursiveDoParserContext&lt;JsonObject&gt; recursiveDoParserContext) {
            JsonToken token = jsonTokenReader.peek();

            if(token.getType() == JsonTokenTypeEnum.STRING){
                // ækeyååå¥æ ä¸­ï¼ç¶åç­æé kvå¯¹æ¶å¼¹åº
                recursiveDoParserContext.getTokenStack().push(token);
                accept(jsonTokenReader);
                return 3;
            }

            throw new MuJsonParserException("unexpected token! index=" + jsonTokenReader.currentIndex());
        }
    }
}
</code></pre>
<pre><code class="language-java">public class AbstractJsonParseStatementMachine&lt;T extends JsonElement&gt; {

    protected JsonTokenReader jsonTokenReader;

    protected RecursiveDoParserContext&lt;T&gt; recursiveDoParserContext;

    protected int currentState = 0;

    protected T targetJsonElement;

    protected ParserStateHandler[] stateHandlers;

    public T parseJsonElement(){
        while(jsonTokenReader.hasNextToken()){
            if(currentState == -1){
                // éå°äºåæ³çåéç¬¦å·ï¼éåºtokenè§£æ
                return targetJsonElement;
            }

            if(currentState &gt;= stateHandlers.length){
                // æbug
                throw new MuJsonParserException(String.format("unknown state! currentState=%s",currentState));
            }
            ParserStateHandler targetStateHandler = stateHandlers[currentState];
            
            currentState = targetStateHandler.processInState(jsonTokenReader, recursiveDoParserContext);
        }

        return targetJsonElement;
    }

    protected static void accept(JsonTokenReader jsonTokenReader){
        jsonTokenReader.nextToken();
    }
}
</code></pre>
<pre><code class="language-java">public class RecursiveDoParserContext&lt;T extends JsonElement&gt;  {

    private Stack&lt;JsonToken&gt; tokenStack = new Stack&lt;&gt;();

    private T targetJsonElement;

    public RecursiveDoParserContext(T targetJsonElement) {
        this.targetJsonElement = targetJsonElement;
    }

    public Stack&lt;JsonToken&gt; getTokenStack() {
        return tokenStack;
    }

    public T getTargetJsonElement() {
        return targetJsonElement;
    }
}
</code></pre>
<h5 id="_-15"></h5>
<ul>
<li>å¨è§£ækvå¯¹æ¶ï¼éè¦åå°stringç±»åçkeyææ¶ç¼å­èµ·æ¥ï¼ç­å¾åç»­çvalueç±»åç»æ(objectãarrayæèprimitive)ä¹å®æè§£æåï¼åä¸å¹¶çæ¾å¥ASTä¸­(getTargetJsonElement().putKV)ã</li>
<li>è§£ækvå¯¹çvalueæ¶ï¼å½åçå®ç°æ¯åºäºéå½å®ç°çãå³å½æ ¹æ®å½åtokençç±»ååå»ºä¸ä¸ªæ°çå¯¹åºç±»åçç¶ææºï¼å»éå½çè§£ææ´æ·±ä¸å±çASTç»æã<br>
éå½å®ç°çå¥½å¤æ¯æè·¯ç®åææï¼ä¸ç¨è¿å¤çèèä¸åç±»åç»æä¹é´ç¶æçäºç¸è½¬ç§»ï¼éè¿éå½è§£æå­ASTçæ¹å¼å¤©ç¶çå±è½æäºå¤§éçå¤æåº¦ã<br>
ä½ç¼ºç¹ä¹åæ ·ææ¾ï¼å¨è§£æå±æ¬¡éå¸¸æ·±çjsonå­ç¬¦ä¸²æ¶ï¼éå½çå±æ¬¡è¿æ·±å¯è½ä¼å¯¼è´å½åçº¿ç¨æ æº¢åºï¼è§£æå¤±è´¥ã</li>
</ul>
<h3 id="34-json-arrayæ°ç»ç»æè§£æ">3.4 json arrayæ°ç»ç»æè§£æ</h3>
<p>arrayç»ææ¯ä»¥â[âå¼å¤´ï¼â]âç»å°¾çç»æï¼åé¨å¯ä»¥æ0å°Nä¸ªvalueç±»åçåç´ ,ä»¥éå·ååå²ï¼valueåæ ·æ¯å¯ä»¥æ¯åµå¥çç»æãä¸ä¸é¢objectç»æçè§£æå®ç°æ¹å¼ä¸æ ·ï¼åæ ·æ¯åºäºéå½å®ç°çã</p>
<h5 id="json-arrayæ°ç»ç»æè¯­æ³">json arrayæ°ç»ç»æè¯­æ³</h5>
<pre><code>array
    '[' ws ']'
    '[' elements ']'

elements
    element
    element ',' elements

element
    ws value ws

value
    object
    array
    string
    number
    "true"
    "false"
    "null"
</code></pre>
<p><img src="https://img2024.cnblogs.com/blog/1506329/202602/1506329-20260211200007327-1872691214.png" alt="json_array_parser" loading="lazy"></p>
<h5 id="arrayç»æè§£æç¶æèªå¨æºç¤ºæå¾">arrayç»æè§£æç¶æèªå¨æºç¤ºæå¾</h5>
<p><img src="https://img2024.cnblogs.com/blog/1506329/202602/1506329-20260211200016319-1527985884.png" alt="json_array_state_machine" loading="lazy"></p>
<h5 id="arrayç»æè§£æç¶æèªå¨æºéå½å®ç°éå½çæ¬">arrayç»æè§£æç¶æèªå¨æºéå½å®ç°ï¼éå½çæ¬ï¼</h5>
<pre><code class="language-java">/**
 * åºäºéå½å®ç°ç arrayç±»åè¯­æ³è§£æç¶æèªå¨æº
 * */
public class JsonArrayParseStatementMachine extends AbstractJsonParseStatementMachine&lt;JsonArray&gt; {

    public JsonArrayParseStatementMachine(JsonTokenReader jsonTokenReader) {
        this.jsonTokenReader = jsonTokenReader;
        this.targetJsonElement = new JsonArray();
        this.recursiveDoParserContext = new RecursiveDoParserContext&lt;&gt;(this.targetJsonElement);
        stateHandlers = new ParserStateHandler[]{
            new ParserState0Handler(),new ParserState1Handler(),new ParserState2Handler(),
            new ParserState3Handler(), new ParserState4Handler()
        };
    }

    private static class ParserState0Handler implements ParserStateHandler&lt;JsonArray&gt;{

        @Override
        public int processInState(JsonTokenReader jsonTokenReader, RecursiveDoParserContext&lt;JsonArray&gt; recursiveDoParserContext) {
            JsonToken token = jsonTokenReader.peek();

            if(token.getType() != JsonTokenTypeEnum.LEFT_BRACKET){
                throw new MuJsonParserException("unexpected token! index=" + jsonTokenReader.currentIndex());
            }

            accept(jsonTokenReader);
            return 1;
        }
    }

    private static class ParserState1Handler implements ParserStateHandler&lt;JsonArray&gt;{

        @Override
        public int processInState(JsonTokenReader jsonTokenReader, RecursiveDoParserContext&lt;JsonArray&gt; recursiveDoParserContext) {
            JsonToken token = jsonTokenReader.peek();

            if(token.getType() == JsonTokenTypeEnum.RIGHT_BRACKET){
                accept(jsonTokenReader);
                return 2;
            }

            // åµå¥çjsonObjectç»æ
            if(token.getType() == JsonTokenTypeEnum.LEFT_BRACE){
                JsonObjectParseStatementMachine jsonObjectParseStatementMachine = new JsonObjectParseStatementMachine(jsonTokenReader);

                JsonObject subJsonObject = jsonObjectParseStatementMachine.parseJsonElement();

                // addä¸ä¸ªobj
                recursiveDoParserContext.getTargetJsonElement().addElement(subJsonObject);

                return 3;
            }

            // åµå¥çjsonArrayç»æ
            if(token.getType() == JsonTokenTypeEnum.LEFT_BRACKET){
                // jsonArrayç¶ææº
                JsonArrayParseStatementMachine jsonArrayParseStatementMachine = new JsonArrayParseStatementMachine(jsonTokenReader);

                JsonArray jsonArray = jsonArrayParseStatementMachine.parseJsonElement();

                // addä¸ä¸ªarray
                recursiveDoParserContext.getTargetJsonElement().addElement(jsonArray);

                return 3;
            }

            // åºç¡ç±»åçvalue
            if(token.getType().isPrimitiveValue()){
                accept(jsonTokenReader);
                recursiveDoParserContext.getTargetJsonElement().addElement(new JsonPrimitiveStr(token.getContent()));

                return 3;
            }

            throw new MuJsonParserException("unexpected token! index=" + jsonTokenReader.currentIndex());
        }
    }

    private static class ParserState2Handler implements ParserStateHandler&lt;JsonArray&gt;{

        @Override
        public int processInState(JsonTokenReader jsonTokenReader, RecursiveDoParserContext&lt;JsonArray&gt; recursiveDoParserContext) {
            // ç»æï¼ç´æ¥è¿å
            return -1;
        }
    }

    private static class ParserState3Handler implements ParserStateHandler&lt;JsonArray&gt;{

        @Override
        public int processInState(JsonTokenReader jsonTokenReader, RecursiveDoParserContext&lt;JsonArray&gt; recursiveDoParserContext) {
            JsonToken token = jsonTokenReader.peek();

            if(token.getType() == JsonTokenTypeEnum.RIGHT_BRACKET){
                accept(jsonTokenReader);
                return 2;
            }

            if(token.getType() == JsonTokenTypeEnum.COMMA){
                accept(jsonTokenReader);
                return 4;
            }

            throw new MuJsonParserException("unexpected token! index=" + jsonTokenReader.currentIndex());
        }
    }

    private static class ParserState4Handler implements ParserStateHandler&lt;JsonArray&gt;{

        @Override
        public int processInState(JsonTokenReader jsonTokenReader, RecursiveDoParserContext&lt;JsonArray&gt; recursiveDoParserContext) {
            JsonToken token = jsonTokenReader.peek();

            // åµå¥çjsonObjectç»æ
            if(token.getType() == JsonTokenTypeEnum.LEFT_BRACE){
                JsonObjectParseStatementMachine jsonObjectParseStatementMachine = new JsonObjectParseStatementMachine(jsonTokenReader);

                JsonObject subJsonObject = jsonObjectParseStatementMachine.parseJsonElement();

                // addä¸ä¸ªobj
                recursiveDoParserContext.getTargetJsonElement().addElement(subJsonObject);

                return 3;
            }

            // åµå¥çjsonArrayç»æ
            if(token.getType() == JsonTokenTypeEnum.LEFT_BRACKET){
                // jsonArrayç¶ææº
                JsonArrayParseStatementMachine jsonArrayParseStatementMachine = new JsonArrayParseStatementMachine(jsonTokenReader);

                JsonArray jsonArray = jsonArrayParseStatementMachine.parseJsonElement();

                // addä¸ä¸ªarray
                recursiveDoParserContext.getTargetJsonElement().addElement(jsonArray);

                return 3;
            }

            // åºç¡ç±»åçvalue
            if(token.getType().isPrimitiveValue()){
                accept(jsonTokenReader);
                recursiveDoParserContext.getTargetJsonElement().addElement(new JsonPrimitiveStr(token.getContent()));

                return 3;
            }

            throw new MuJsonParserException("unexpected token! index=" + jsonTokenReader.currentIndex());
        }
    }
}
</code></pre>
<h5 id="_-16"></h5>
<ul>
<li>ç¸æ¯objectç»æçç¶æèªå¨æºï¼arrayç»æçç¶æèªå¨æºåæ¾å¾æ¯è¾ç®åãåæ ·å¨éå°å¤æç±»åçç»ææ¶ï¼éè¿å½åtokençç±»åéå½çåå»ºä¸ä¸ªæ°çç¶ææºå»æé åºå­AST(JsonElement)ï¼ç¶åå å¥å°å½åJsonArrayä¸­(getTargetJsonElement().addElement)ã</li>
</ul>
<h2 id="4-åºäºastçæbeauty-jsonå­ç¬¦ä¸²">4. åºäºASTçæbeauty jsonå­ç¬¦ä¸²</h2>
<p>ç°å¨æä»¬å·²ç»å®ç°äºjsonçè¯æ³è§£æåè¯­æ³è§£æï¼å¯ä»¥å°ä¸ä¸ªåå§çåæ³çjsonå­ç¬¦ä¸²æ­£ç¡®çè½¬æ¢æå¯¹åºçASTäºã<br>
æ¿å°ASTä¹åçè®ºä¸å¯ä»¥åå¾å¤äºæï¼æ¯å¦å°jsonä¸²ååºååä¸ºjavaå¯¹è±¡ãè¿éæä»¬å®ç°ä¸ä¸ª<strong>æ´ç®åä¹æ´ç´è§çåè½</strong>ï¼å³å°åå§çjsonå­ç¬¦ä¸²æ ¼å¼åæç¼©è¿è¯å¥½ï¼æ´ç¾è§ï¼å¯è¯»æ§æ´ä½³çbeautyå­ç¬¦ä¸²ã</p>
<h5 id="çææ ¼å¼ååçbeauty-jsonå­ç¬¦ä¸²å®ç°">çææ ¼å¼ååçbeauty jsonå­ç¬¦ä¸²å®ç°</h5>
<pre><code class="language-java">public abstract class JsonElement {

    private static final String BEAUTY_INDENT = "    ";  // åä¸ªç©ºæ ¼ç¼©è¿
    private static final String BEAUTY_KV_INDENT = " ";  // kvå¤ä¸ä¸ªç©ºæ ¼
    private static final String BEAUTY_LINE_BREAK = "\n"; // æ¢è¡åå²

    /**
     * çæç¾ååçbeautyå­ç¬¦ä¸²
     * */
    public String buildBeautyJsonString(){
        StringBuilder jsonStringBuilder = new StringBuilder();

        buildJsonString(this,jsonStringBuilder,"",BEAUTY_LINE_BREAK,BEAUTY_INDENT,BEAUTY_KV_INDENT);

        return jsonStringBuilder.toString();
    }

    private static void buildJsonString(JsonElement jsonElement, StringBuilder jsonStringBuilder, String currentIndent,
                                        String lineBreak, String indent, String kvIndent){
        if(jsonElement instanceof JsonPrimitiveStr){
            jsonStringBuilder.append(jsonElement);
            return;
        }

        if(jsonElement instanceof JsonArray){
            JsonArray jsonArray  = (JsonArray) jsonElement;
            jsonStringBuilder.append("[").append(lineBreak);
            List&lt;JsonElement&gt; jsonArrayList = jsonArray.getArray();
            int i=0;
            for(JsonElement arrayItem : jsonArrayList){
                jsonStringBuilder.append(currentIndent).append(indent);
                // éå½ä¸å»ï¼currentIndentå¤ç¼©è¿ä¸å±
                buildJsonString(arrayItem,jsonStringBuilder,currentIndent + indent,lineBreak,indent,kvIndent);
                if(i != jsonArrayList.size()-1){
                    jsonStringBuilder.append(",");
                }

                jsonStringBuilder.append(lineBreak);
                i++;
            }

            jsonStringBuilder.append(currentIndent).append("]");
        }

        if(jsonElement instanceof JsonObject){
            JsonObject jsonObject  = (JsonObject) jsonElement;
            jsonStringBuilder.append("{").append(lineBreak);

            Map&lt;String, JsonElement&gt; objMap = jsonObject.getObjMap();

            int i=0;
            for(Map.Entry&lt;String, JsonElement&gt; entry : objMap.entrySet()){
                String key = entry.getKey();
                JsonElement value = entry.getValue();

                // keyæ¯stringç±»åçï¼å­é¢ééèªå¸¦åå¼å·ç
                jsonStringBuilder.append(currentIndent).append(indent).append(key).append(kvIndent).append(":").append(kvIndent);
                // éå½ä¸å»ï¼currentIndentå¤ç¼©è¿ä¸å±
                buildJsonString(value,jsonStringBuilder,  currentIndent + indent, lineBreak,indent,kvIndent);

                if(i != objMap.size()-1){
                    jsonStringBuilder.append(",");
                }

                jsonStringBuilder.append(lineBreak);
                i++;
            }

            jsonStringBuilder.append(currentIndent).append("}");
        }
    }
}
</code></pre>
<h5 id="_-17"></h5>
<ul>
<li>ä»æºç å®ç°ä¸­å¯ä»¥çå°ï¼è¾åºç¾ååçbeautyå­ç¬¦ä¸²æ¬è´¨ä¸å°±æ¯ä¸ä¸ªéå¯¹ASTæ å½¢ç»æç<strong>æ·±åº¦ä¼åéå</strong>ï¼åªéè¦æ³¨æéçéå½æ·±åº¦å¨æè°æ´ç¼©è¿é¿åº¦å³å¯ã</li>
<li>æ ¼å¼åjsonçæ¹å¼å¤ç§å¤æ ·ï¼åjacksonè¿æ ·æççjsonå¤çæ¡æ¶ä¸­æä¾äºå¤§éçéç½®åæ°åè®¸ç¨æ·ä»¥ææ³è¦çæ¹å¼éå¸¸çµæ´»ççææéæ ¼å¼çjsonå­ç¬¦ä¸²ãæä»¬è¿éçå®ç°ä¸å¤çµæ´»ï¼æ§è½ä¹ä¸å¤é«æï¼ä»ä»æ¯èµ·å°ä¸ä¸ªæç å¼ççä½ç¨ã</li>
</ul>
<h5 id="json-beautyç¤ºæå¾">json beautyç¤ºæå¾</h5>
<p><img src="https://img2024.cnblogs.com/blog/1506329/202602/1506329-20260211200026283-104525624.png" alt="json_beauty_demo" loading="lazy"></p>
<h2 id="5-æµå¼çjsonè¯æ³è§£æ">5. æµå¼çjsonè¯æ³è§£æ</h2>
<p>æªæ­¢ç®åæä»¬å·²ç»å®ç°äºjsonå­ç¬¦ä¸²çè§£æåè½ï¼ä½è¿å­å¨ä¸¤ä¸ªä¸¥éçæ§è½é®é¢éè¦ä¼åã</p>
<ul>
<li>é¦åæ¯ç®åçè¯æ³åæå¨æ¯ä¸æ¬¡æ§çè§£æåºææçtokenåï¼åäº¤ç»è¯­æ³åæå»è§£æçãèè¿å­å¨ä¸ä¸ªéæ£ï¼å ä¸ºå¾å¤æ¶åæä»¬å®éè§£æçå¹¶ä¸æ»æ¯ä¸ä¸ªåæ³çjsonå­ç¬¦ä¸²ã<br>
å¦æä¸ä¸ªéå¸¸é¿çä¸åæ³çjsonå­ç¬¦ä¸²ï¼å¨è¯æ³åæé¶æ®µçä¸åºä»»ä½çé®é¢(æ¯å¦å¨åæ³çä»¥<code>{</code>å¼å¤´ç jsonå­ç¬¦ä¸²çåé¢è¯¯è¿½å ä¸ä¸ª123)ï¼èç´å°è¯­æ³åææåç°å­å¨è¯­æ³éè¯¯ï¼é£ä¹è¯æ³åæé¶æ®µè±è´¹çè®¡ç®èµæºå°±ç»ç»æµªè´¹äºã</li>
<li>å¦æè½å¤å¨å®æ´çè¯æ³åæå¤ççè¿ç¨ä¸­æååç°è¯­æ³éè¯¯å°±è½é¿åè¿ä¸ªé®é¢ãä½å®ç°è¿ä¸ªåè½ä¸éè¦å°è¯æ³åæåè¯­æ³åæçåè½è¦åå¨ä¸èµ·ï¼èæ¯å°è¯æ³åæå¨æ¹é ææéå è½½çæµå¼è§£æå³å¯ã<br>
æµå¼çè¯æ³åæè½å¤å¨è¯­æ³è§£æå¨éè¦è¯»åtokenæ¶æè§¦åè¯æ³åæï¼å¹¶ä¸ä¸æ¬¡å¯ä»¥åªæéçå®æ´è§£æåºä¸ä¸ªå®æ´çtokenäº¤ç»parserã</li>
<li>æäºæµå¼çè¯æ³åæï¼åä¸é¢ä¸¾å¾ä¾å­ï¼å¨åæ³çéå¸¸é¿çjsonå­ç¬¦ä¸²çåé¢è¯¯å ä¸ä¸ª123çåºæ¯ï¼ä¾¿è½å¤å¾æ©çå°±åç°è¯­æ³éè¯¯ï¼ç»æè§£æè¿ç¨ã</li>
</ul>
<h5 id="æµå¼çè¯æ³åæè§£æå®ç°">æµå¼çè¯æ³åæè§£æå®ç°</h5>
<pre><code class="language-java">public class StreamJsonLexer extends AbstractJsonLexer{

    public StreamJsonLexer(String jsonString) {
        super(jsonString);
    }

    public JsonToken doLex(){
        if(doLexContext.currentIndex &gt;= jsonStringArray.length){
            return new JsonToken(JsonTokenTypeEnum.EOF);
        }

        while(true) {
            char ch = jsonStringArray[doLexContext.currentIndex];

            // æ¯ä¸æ¬¡å°è¯è§£æä¸ä¸ªå®æ´çtokenåï¼é½æ¯ç¶æ0
            switch (ch) {
                case '{':
                    doLexContext.currentIndex++;
                    return new JsonToken(JsonTokenTypeEnum.LEFT_BRACE);
                case '}':
                    doLexContext.currentIndex++;
                    return new JsonToken(JsonTokenTypeEnum.RIGHT_BRACE);
                case '[':
                    doLexContext.currentIndex++;
                    return new JsonToken(JsonTokenTypeEnum.LEFT_BRACKET);
                case ']':
                    doLexContext.currentIndex++;
                    return new JsonToken(JsonTokenTypeEnum.RIGHT_BRACKET);
                case ',':
                    doLexContext.currentIndex++;
                    return new JsonToken(JsonTokenTypeEnum.COMMA);
                case ':':
                    doLexContext.currentIndex++;
                    return new JsonToken(JsonTokenTypeEnum.COLON);
                case '"':
                    return parseString(jsonStringArray, doLexContext);
                case 't':
                    // å°è¯è§£ætrueå³é®å­
                    return parseTrueKeyword(jsonStringArray, doLexContext);
                case 'f':
                    // å°è¯è§£æfalseå³é®å­
                    return parseFalseKeyword(jsonStringArray, doLexContext);
                case 'n':
                    // å°è¯è§£ænullå³é®å­
                    return parseNullKeyword(jsonStringArray, doLexContext);
                default:
                    // èµ°å¶å®case
                    break;
            }

            // å¶å®case
            if (CommonStringUtil.is0_9(ch) || ch == '-') {
                // numberè§£æ
                return parseNumber(jsonStringArray, doLexContext);
            } else if (CommonStringUtil.isWhitespace(ch)) {
                // whiteSpace ç´æ¥è·³è¿
                doLexContext.currentIndex++;
            } else{
                throw new MuJsonParserException("unexpected character: " + ch + ",charIndex=" + doLexContext.currentIndex);
            }
        }
    }
}
</code></pre>
<pre><code class="language-java">public class StreamJsonTokenReader implements JsonTokenReader {

    private int currentIndex;
    private final StreamJsonLexer streamJsonLexer;

    private JsonToken peekToken;
    private boolean hasNextToken;

    public StreamJsonTokenReader(String jsonString) {
        this.currentIndex = 0;
        this.hasNextToken = true;
        this.streamJsonLexer = new StreamJsonLexer(jsonString);
    }

    @Override
    public boolean hasNextToken() {
        return hasNextToken;
    }

    @Override
    public JsonToken nextToken() {
        JsonToken nextToken = getNextToken();
        if(nextToken.getType() == JsonTokenTypeEnum.EOF){
            hasNextToken = false;
        }

        currentIndex++;
        return nextToken;
    }

    private JsonToken getNextToken() {
        if(peekToken != null){
            JsonToken nextToken = peekToken;
            this.peekToken = null;
            return nextToken;
        }

        return streamJsonLexer.doLex();
    }

    @Override
    public JsonToken peek() {
        if(peekToken == null) {
            peekToken = streamJsonLexer.doLex();
        }

        return peekToken;
    }

    @Override
    public int currentIndex() {
        return currentIndex;
    }
}
</code></pre>
<h5 id="_-18"></h5>
<ul>
<li>æµå¼çè¯æ³è§£æå¨StreamJsonLexerçæ ¸å¿å·¥ä½åçä¸ä¹åå·²ç»å®ç°çéæçStaticJsonLexerå«æ äºè´ï¼å¶åºå±ä¾èµçä»£ç é½æ¯ç¸åçã<br>
æå¤§çåºå«å¨äºè§£æåºä¸ä¸ªå®æ´çtokenåï¼å¨ç»´æ¤å½åå­ç¬¦æµä¸æ çåæ¶æåç»æ­¢äºåç»­çè¯æ³åæãå¨StreamJsonTokenReaderè°ç¨nextTokenæ¶ï¼æä¼æéçæ°æ§è§£ææ°çtokenå¹¶è¿åã</li>
<li>æµå¼çè¯æ³è§£ææ¯«æ çé®æ¯æ§è½æ´å¥½çï¼ä¸»æµçjsonè§£æå¨ä¹é½æ¯æµå¼çè§£æãä½éæçè¯æ³è§£ææ´å®¹æçè§£ï¼ä¹æ´å®¹æè°è¯ï¼æä»¥å¨ä¸å¼å§ä»ç»è¯æ³åæåçæ¶ï¼æä»¬åå®ç°äºéæçè¯æ³åæï¼å°å¶ä½ä¸ºåºç¡ï¼ç¥å¾®çæ¹é åä¾¿å®ç°äºæµå¼çè¯æ³è§£æã</li>
</ul>
<h2 id="6-åºäºå æ å®ç°çjsonè¯­æ³è§£æ">6. åºäºå æ å®ç°çjsonè¯­æ³è§£æ</h2>
<p>ç¬¬äºä¸ªæ§è½é®é¢åæ¯åºäºéå½å®ç°çjsonè¯­æ³è§£æå¨åéäºè¾å°ççº¿ç¨æ ç©ºé´ï¼æ æ³å¤çåµå¥å±çº§éå¸¸æ·±çjsonä¸²ã</p>
<ul>
<li>æä»¬ç¥éï¼ä¸ä¸ªæ®éçjavaè¿ç¨éå¸¸é½å«æå¤§éççº¿ç¨ï¼å æ­¤ç»æ¯ä¸ªçº¿ç¨åéççº¿ç¨æ éå¸¸é½æ¯è¾å°ï¼æ¯å¦1mãèéå½å®ç°çè¯­æ³è§£æå¨ï¼å¨æ¯æ·±å¥ä¸ä¸ªå±æ¬¡çjsonå­æ æ¶ä¾¿ä¼åæ ä¸åå¥ä¸äºå±é¨åéï¼å½æç«¯æåµä¸è¦è§£æçjsonä¸²å±æ¬¡è¿æ·±æ¶ï¼åä¼åºç°StackOverflowErrorï¼å¯¼è´è§£æå¤±è´¥ã</li>
<li>èåå­çå éå¸¸é½æ¯ä»¥GBä¸ºåä½çï¼å æ­¤å¦ææéå½ä¸­éå¼åæ çè§£æé»è¾è½¬æ¢ä¸ºç­ä»·çæ¾å¼åºäºåå­å çåæ ï¼åå¯ä»¥å¾å¥½çè§£å³çº¿ç¨æ è¿å°æ æ³å¤çå¤§æ·±åº¦jsonä¸²çé®é¢äºã</li>
</ul>
<h5 id="åºäºå æ çè¯­æ³è§£æç¶æèªå¨æºç¤ºæå¾">åºäºå æ çè¯­æ³è§£æç¶æèªå¨æºç¤ºæå¾</h5>
<p><img src="https://img2024.cnblogs.com/blog/1506329/202602/1506329-20260211200035364-62927704.png" alt="stack_base_json_parser_state_machine" loading="lazy"></p>
<ul>
<li>ä¸ºäºå°½å¯è½çå°ç¶æè½¬ç§»ä¸éå½å®ç°çé»è¾ä¿æä¸è´ï¼å æ çç¶æèªå¨æºä¾ç¶åä½äºä¸¤ä¸ªç¶æ(obj-0åarr-0)ã</li>
<li>å¯ä»¥çå°ï¼åºäºå æ çç¶æèªå¨æºä¼å¨arrayä¸objectçè§£æç¶æä¸­äºç¸è½¬ç§»ï¼ç¸å½äºå°ä¹åéå½å®ç°çåä¸ªç¶æèªå¨æºçå­ç¶æå¾åå¹¶ä¸ºäºä¸ä¸ªå¤§èå¨çç¶æèªå¨æºã</li>
<li>åæ¶ï¼ç±äºè¿æ¶åäºæå¨æ¨¡æçå¥æ ä¸åºæ å¤ç(obj-2ï¼obj-4ï¼arr-1ï¼arr-2)ï¼å æ­¤æ´ä½çå¤æåº¦æ¯èµ·éå½å®ç°è¦é«åºä¸ä¸ªéçº§ã</li>
</ul>
<h5 id="jsonæ ¹èç¹è§£æç¶æèªå¨æºå®ç°æºç ">jsonæ ¹èç¹è§£æç¶æèªå¨æºå®ç°æºç </h5>
<pre><code class="language-java">/**
 * åºäºå æ çï¼ééå½çjsonè¯­æ³è§£æå¨
 * */
public class StackBaseJsonParser extends JsonParser {

    private final JsonParseStack parseStack = new JsonParseStack();

    private StackBaseJsonParserStatusEnum currentStatus;

    public StackBaseJsonParser(JsonTokenReader tokenReader) {
        super(tokenReader);

        this.currentStatus = StackBaseJsonParserStatusEnum.START_PARSE;
    }

    private void accept(){
        jsonTokenReader.nextToken();
    }

    @Override
    public JsonElement doParse() {
        while(jsonTokenReader.hasNextToken()){
            JsonToken token = jsonTokenReader.peek();

            if(currentStatus == StackBaseJsonParserStatusEnum.END_PARSE){
                break;
            }

            switch (currentStatus){
                case START_PARSE:
                    processInStartParse(token);
                    break;
                case PARSE_OBJECT_0:
                    processInParseObject0(token);
                    break;
                case PARSE_OBJECT_1:
                    processInParseObject1(token);
                    break;
                case PARSE_OBJECT_2:
                    processInParseObject2(token);
                    break;
                case PARSE_OBJECT_3:
                    processInParseObject3(token);
                    break;
                case PARSE_OBJECT_4:
                    processInParseObject4(token);
                    break;
                case PARSE_OBJECT_5:
                    processInParseObject5(token);
                    break;
                case PARSE_OBJECT_6:
                    processInParseObject6(token);
                    break;
                case PARSE_ARR_0:
                    processInParseArr0(token);
                    break;
                case PARSE_ARR_1:
                    processInParseArr1(token);
                    break;
                case PARSE_ARR_2:
                    processInParseArr2(token);
                    break;
                case PARSE_ARR_3:
                    processInParseArr3(token);
                    break;
                default:
                    throw new MuJsonParserException("Unexpected currentStatus: " + currentStatus);
            }
        }

        // å¦æjsonå­ç¬¦ä¸²æ¯åæ³çï¼é£ä¹æåæ é¡¶å¿ç¶æ¯æä¸å¯ä¸çä¸ä¸ªJsonElementç±»åçå¯¹è±¡
        if(this.parseStack.size() != 1){
            throw new MuJsonParserException("after parseï¼stack element size &gt; 1! stack=" + this.parseStack);
        }

        JsonParseStackValue object = this.parseStack.pop();
        return (JsonElement) object.getValue();
    }

    private void processInStartParse(JsonToken token){
        if (token.getType() == JsonTokenTypeEnum.LEFT_BRACE) {
            this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_OBJECT_0;
            this.parseStack.push(new JsonParseStackValue(JsonParseStackValueTypeEnum.JSON_OBJECT,new JsonObject()));
            return;
        }

        if (token.getType() == JsonTokenTypeEnum.LEFT_BRACKET) {
            this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_ARR_0;
            this.parseStack.push(new JsonParseStackValue(JsonParseStackValueTypeEnum.JSON_ARRAY,new JsonArray()));
            return;
        }

        if (token.getType().isPrimitiveValue()) {
            accept();
            this.currentStatus = StackBaseJsonParserStatusEnum.END_PARSE;
            this.parseStack.push(new JsonParseStackValue(JsonParseStackValueTypeEnum.JSON_PRIMITIVE,new JsonPrimitiveStr(token.getContent())));
            return;
        }

        // ç¬¬ä¸ä¸ªtokenï¼ä¸å±äºjsonè§åçf(1)éå
        throw new MuJsonParserException("unexpected start json token! token=" + jsonTokenReader.currentIndex());
    }

    private void processInParseObject0(JsonToken token){
        if(token.getType() != JsonTokenTypeEnum.LEFT_BRACE){
            throw new MuJsonParserException("unexpected token! index=" + jsonTokenReader.currentIndex());
        }

        accept();

        this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_OBJECT_1;
    }

    private void processInParseObject1(JsonToken token){
        if(token.getType() == JsonTokenTypeEnum.RIGHT_BRACE){
            this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_OBJECT_2;
            return;
        }

        if(token.getType() == JsonTokenTypeEnum.STRING){
            // ækeyååå¥æ ä¸­ï¼ç¶åç­æé kvå¯¹æ¶å¼¹åº
            this.parseStack.push(new JsonParseStackValue(JsonParseStackValueTypeEnum.JSON_KEY,token));
            accept();
            this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_OBJECT_3;
            return;
        }

        throw new MuJsonParserException("unexpected token! index=" + jsonTokenReader.currentIndex());
    }

    private void processInParseObject2(JsonToken token){
        // éå°'}'æä¼è¿æ¥
        if(token.getType() != JsonTokenTypeEnum.RIGHT_BRACE){
            throw new MuJsonParserException("unexpected token! index=" + jsonTokenReader.currentIndex());
        }else{
            accept();
        }

        // å½åæ é¡¶å¿å®æ¯JsonObjectï¼åå°å¶å¼¹åºï¼ç¶åçæ é¡¶çåç´ ç±»åå¤æ­
        JsonParseStackValue currentJsonObjectStackValue = this.parseStack.popAndCheck(JsonParseStackValueTypeEnum.JSON_OBJECT);
        if(this.parseStack.isEmpty()){
            // è¯´ææ¯rootçJsonObjectè§£æå®äºï¼åæ¨åå»ç´æ¥è¿å
            this.parseStack.push(currentJsonObjectStackValue);
            this.currentStatus = StackBaseJsonParserStatusEnum.END_PARSE;
            return;
        }

        JsonObject currentJsonObject = (JsonObject) currentJsonObjectStackValue.getValue();

        JsonParseStackValueTypeEnum topObjType = this.parseStack.peekTopType();

        if(topObjType == JsonParseStackValueTypeEnum.JSON_KEY){
            // å¦ææ¯json_keyï¼è¯´ææ¯å½åjsonObjectæ¯ç¶objectçä¸ä¸ªk/vé¡¹ä¸­çvalueã
            JsonParseStackValue keyStackValue = this.parseStack.popAndCheck(JsonParseStackValueTypeEnum.JSON_KEY);
            JsonToken keyJsonToken = (JsonToken) keyStackValue.getValue();
            JsonParseStackValue parentObject = this.parseStack.peekAndCheck(JsonParseStackValueTypeEnum.JSON_OBJECT);

            // å°å½åk/vé¡¹éå å¨ç¶objectä¸
            ((JsonObject)parentObject.getValue()).putKV(keyJsonToken.getContent(), currentJsonObject);

            // åºäºä¸ä¸ä¸ªtokenå¤æ­ç¶æè·³è½¬
            JsonToken nextJsonToken = this.jsonTokenReader.peek();
            if(nextJsonToken.getType() == JsonTokenTypeEnum.COMMA){
                this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_OBJECT_5;
                return;
            }else if (nextJsonToken.getType() == JsonTokenTypeEnum.RIGHT_BRACE){
                this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_OBJECT_2;
                return;
            }else{
                throw new MuJsonParserException("unexpected token! index=" + (jsonTokenReader.currentIndex()+1));
            }

        }else if(topObjType == JsonParseStackValueTypeEnum.JSON_ARRAY){
            // è¯´æå½åjsonObjectæ¯jsonArrayçä¸ä¸ªåç´ 

            JsonParseStackValue parentArr = this.parseStack.peekAndCheck(JsonParseStackValueTypeEnum.JSON_ARRAY);
            ((JsonArray)parentArr.getValue()).addElement(currentJsonObject);

            // åºäºä¸ä¸ä¸ªtokenå¤æ­ç¶æè·³è½¬
            JsonToken nextJsonToken = this.jsonTokenReader.peek();
            if(nextJsonToken.getType() == JsonTokenTypeEnum.COMMA){
                this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_ARR_3;
                return;
            }else if (nextJsonToken.getType() == JsonTokenTypeEnum.RIGHT_BRACKET){
                this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_ARR_2;
                return;
            }else{
                throw new MuJsonParserException("unexpected token! index=" + (jsonTokenReader.currentIndex()+1));
            }
        }else{
            // å«çæåµé½è¯´ææé®é¢ï¼ä¸æ¯åæ³çjson
            throw new MuJsonParserException("unexpected token! index=" + jsonTokenReader.currentIndex());
        }
    }

    private void processInParseObject3(JsonToken token){
        if(token.getType() == JsonTokenTypeEnum.COLON){
            accept();
            this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_OBJECT_4;
            return;
        }

        throw new MuJsonParserException("unexpected token! index=" + jsonTokenReader.currentIndex());
    }

    private void processInParseObject4(JsonToken token){
        // åµå¥çjsonObjectç»æ
        if(token.getType() == JsonTokenTypeEnum.LEFT_BRACE){
            // åç°'{'ï¼æ ä¸æ¨è¿ä¸ä¸ªJsonObject
            this.parseStack.push(new JsonParseStackValue(JsonParseStackValueTypeEnum.JSON_OBJECT, new JsonObject()));
            accept();
            this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_OBJECT_1;
            return;
        }

        // åµå¥çjsonArrayç»æ
        if(token.getType() == JsonTokenTypeEnum.LEFT_BRACKET){
            // åç°'['ï¼æ ä¸æ¨è¿ä¸ä¸ªJsonArr
            this.parseStack.push(new JsonParseStackValue(JsonParseStackValueTypeEnum.JSON_ARRAY, new JsonArray()));
            accept();
            this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_ARR_1;
            return;
        }

        // åºç¡ç±»åçvalue
        if(token.getType().isPrimitiveValue()){
            JsonParseStackValue jsonKeyToken = this.parseStack.popAndCheck(JsonParseStackValueTypeEnum.JSON_KEY);

            JsonToken keyToken  = (JsonToken) jsonKeyToken.getValue();
            Assert.assertTrue(keyToken.getType() == JsonTokenTypeEnum.STRING,"parse object keyToken not match!");

            // è·åæ é¡¶çjsonObjectå¯¹è±¡ï¼è®¾ç½®k/v
            JsonParseStackValue topJsonObject = this.parseStack.peekAndCheck(JsonParseStackValueTypeEnum.JSON_OBJECT);

            ((JsonObject) topJsonObject.getValue()).putKV(keyToken.getContent(), new JsonPrimitiveStr(token.getContent()));

            accept();

            // åºäºä¸ä¸ä¸ªtokenå¤æ­ç¶æè·³è½¬
            JsonToken nextJsonToken = this.jsonTokenReader.peek();
            if(nextJsonToken.getType() == JsonTokenTypeEnum.COMMA){
                this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_OBJECT_5;
                return;
            }else if (nextJsonToken.getType() == JsonTokenTypeEnum.RIGHT_BRACE){
                this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_OBJECT_2;
                return;
            }else{
                throw new MuJsonParserException("unexpected token! index=" + (jsonTokenReader.currentIndex()+1));
            }
        }

        throw new MuJsonParserException("unexpected token! index=" + jsonTokenReader.currentIndex());
    }

    private void processInParseObject5(JsonToken token){
        if(token.getType() == JsonTokenTypeEnum.COMMA){
            accept();
            this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_OBJECT_6;
            return;
        }

        throw new MuJsonParserException("unexpected token! index=" + jsonTokenReader.currentIndex());
    }

    private void processInParseObject6(JsonToken token){
        if(token.getType() == JsonTokenTypeEnum.STRING){
            // ækeyååå¥æ ä¸­ï¼ç¶åç­æé kvå¯¹æ¶å¼¹åº
            this.parseStack.push(new JsonParseStackValue(JsonParseStackValueTypeEnum.JSON_KEY,token));
            accept();
            this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_OBJECT_3;
            return;
        }

        throw new MuJsonParserException("unexpected token! index=" + jsonTokenReader.currentIndex());
    }

    private void processInParseArr0(JsonToken token){
        if(token.getType() == JsonTokenTypeEnum.LEFT_BRACKET){
            accept();
            this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_ARR_1;
            return;
        }

        throw new MuJsonParserException("unexpected token! index=" + jsonTokenReader.currentIndex());
    }

    private void processInParseArr1(JsonToken token){
        if(token.getType() == JsonTokenTypeEnum.RIGHT_BRACKET){
            this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_ARR_2;
            return;
        }

        // åµå¥çjsonObjectç»æ
        if(token.getType() == JsonTokenTypeEnum.LEFT_BRACE){
            // åç°'{'ï¼æ ä¸æ¨è¿ä¸ä¸ªJsonObject
            this.parseStack.push(new JsonParseStackValue(JsonParseStackValueTypeEnum.JSON_OBJECT, new JsonObject()));
            accept();
            this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_OBJECT_1;
            return;
        }

        // åµå¥çjsonArrayç»æ
        if(token.getType() == JsonTokenTypeEnum.LEFT_BRACKET){
            // åç°'['ï¼æ ä¸æ¨è¿ä¸ä¸ªJsonArr
            this.parseStack.push(new JsonParseStackValue(JsonParseStackValueTypeEnum.JSON_ARRAY, new JsonArray()));
            accept();
            this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_ARR_1;
            return;
        }

        // åºç¡ç±»åçvalue
        if(token.getType().isPrimitiveValue()){
            // è·åæ é¡¶çjsonArrå¯¹è±¡ï¼æ·»å ä¸ä¸ªåç´ 
            JsonParseStackValue topJsonArr = this.parseStack.peekAndCheck(JsonParseStackValueTypeEnum.JSON_ARRAY);

            ((JsonArray) topJsonArr.getValue()).addElement(new JsonPrimitiveStr(token.getContent()));

            accept();

            // åºäºä¸ä¸ä¸ªtokenå¤æ­ç¶æè·³è½¬
            JsonToken nextJsonToken = this.jsonTokenReader.peek();
            if(nextJsonToken.getType() == JsonTokenTypeEnum.COMMA){
                this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_ARR_3;
                return;
            }else if (nextJsonToken.getType() == JsonTokenTypeEnum.RIGHT_BRACKET){
                this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_ARR_2;
                return;
            }else{
                throw new MuJsonParserException("unexpected token! index=" + (jsonTokenReader.currentIndex()+1));
            }
        }

        throw new MuJsonParserException("unexpected token! index=" + jsonTokenReader.currentIndex());
    }

    private void processInParseArr2(JsonToken token){
        // éå°']'æä¼è¿æ¥
        if(token.getType() != JsonTokenTypeEnum.RIGHT_BRACKET){
            throw new MuJsonParserException("unexpected token! index=" + jsonTokenReader.currentIndex());
        }else{
            accept();
        }

        // å½åæ é¡¶å¿å®æ¯JsonArrayï¼åå°å¶å¼¹åºï¼ç¶åçæ é¡¶çåç´ ç±»åå¤æ­
        JsonParseStackValue currentJsonObjectStackValue = this.parseStack.popAndCheck(JsonParseStackValueTypeEnum.JSON_ARRAY);
        if(this.parseStack.isEmpty()){
            // è¯´ææ¯rootçJsonArrè§£æå®äºï¼åæ¨åå»ç´æ¥è¿å
            this.parseStack.push(currentJsonObjectStackValue);
            this.currentStatus = StackBaseJsonParserStatusEnum.END_PARSE;
            return;
        }

        JsonArray jsonArray = (JsonArray) currentJsonObjectStackValue.getValue();

        JsonParseStackValueTypeEnum topObjType = this.parseStack.peekTopType();

        if(topObjType == JsonParseStackValueTypeEnum.JSON_KEY){
            // å¦ææ¯json_keyï¼è¯´ææ¯å½åjsonArrayæ¯ç¶objectçä¸ä¸ªk/vé¡¹ä¸­çvalueã
            JsonParseStackValue keyStackValue = this.parseStack.popAndCheck(JsonParseStackValueTypeEnum.JSON_KEY);
            JsonToken keyJsonToken = (JsonToken) keyStackValue.getValue();

            JsonParseStackValue parentObject = this.parseStack.peekAndCheck(JsonParseStackValueTypeEnum.JSON_OBJECT);

            // å°å½åk/vé¡¹éå å¨ç¶objectä¸
            ((JsonObject)parentObject.getValue()).putKV(keyJsonToken.getContent(), jsonArray);

            // åºäºä¸ä¸ä¸ªtokenå¤æ­ç¶æè·³è½¬
            JsonToken nextJsonToken = this.jsonTokenReader.peek();
            if(nextJsonToken.getType() == JsonTokenTypeEnum.COMMA){
                this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_OBJECT_5;
                return;
            }else if (nextJsonToken.getType() == JsonTokenTypeEnum.RIGHT_BRACE){
                this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_OBJECT_2;
                return;
            }else{
                throw new MuJsonParserException("unexpected token! index=" + (jsonTokenReader.currentIndex()+1));
            }

        }else if(topObjType == JsonParseStackValueTypeEnum.JSON_ARRAY){
            // è¯´æå½åjsonObjectæ¯jsonArrayçä¸ä¸ªåç´ 

            JsonParseStackValue parentArr = this.parseStack.peekAndCheck(JsonParseStackValueTypeEnum.JSON_ARRAY);
            ((JsonArray)parentArr.getValue()).addElement(jsonArray);

            // åºäºä¸ä¸ä¸ªtokenå¤æ­ç¶æè·³è½¬
            JsonToken nextJsonToken = this.jsonTokenReader.peek();
            if(nextJsonToken.getType() == JsonTokenTypeEnum.COMMA){
                this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_ARR_3;
                return;
            }else if (nextJsonToken.getType() == JsonTokenTypeEnum.RIGHT_BRACKET){
                this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_ARR_2;
                return;
            }else{
                throw new MuJsonParserException("unexpected token! index=" + (jsonTokenReader.currentIndex()+1));
            }
        }else{
            // å«çæåµé½è¯´ææé®é¢ï¼ä¸æ¯åæ³çjson
            throw new MuJsonParserException("unexpected token! index=" + jsonTokenReader.currentIndex());
        }
    }

    private void processInParseArr3(JsonToken token){
        if(token.getType() == JsonTokenTypeEnum.COMMA){
            accept();
            this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_ARR_1;
            return;
        }

        throw new MuJsonParserException("unexpected token! index=" + jsonTokenReader.currentIndex());
    }
}

</code></pre>
<h5 id="æ¯è¾å æ ä¸éå½å®ç°æ§è½å·®å¼çdemo">æ¯è¾å æ ä¸éå½å®ç°æ§è½å·®å¼çdemo</h5>
<p>æä»¬å¯ä»¥å¾ç®åçæé åºä¸ä¸ªéå¸¸æ·±åµå¥å±æ¬¡çjsonä¸²ï¼å³ç±è¿ç»­Nä¸ªâ[âåè¿ç»­Nä¸ªâ]âææçjsonå­ç¬¦ä¸²ãå³æ ¹èç¹ä¸ºæ°ç»ï¼åæ¶æ¯ä¸ªæ°ç»ä¸­é½æä¸ä»æä¸ä¸ªå­åç´ ï¼å­åç´ çç±»åä¾ç¶æ¯æ°ç»ï¼ä¾æ¬¡ç±»æ¨ã</p>
<pre><code class="language-java">public class TestHugeLevelJsonParse {

    @Test
    public void testHugeLevelJsonParse() {
        int level = 3500;
        String hugeLevelJson = TestUtil.buildHugeLevelJson(level);

        // 3500å±çæ·±åº¦ï¼ä¼StackOverflowErroræ æº¢åº
        Error recursiveJsonParseEx = null;
        try{
            RecursiveJsonParser recursiveJsonParser = new RecursiveJsonParser(new StreamJsonTokenReader(hugeLevelJson));
            JsonElement obj = recursiveJsonParser.doParse();
        }catch (Error e){
            recursiveJsonParseEx = e;
        }

        Assert.assertTrue(recursiveJsonParseEx instanceof StackOverflowError);
        System.out.println("level = " + level + " recursiveJsonParseEx has StackOverflowError!");

        // jacksoné»è®¤jsonæ·±åº¦ä¸º1000ï¼è¶è¿äºä¼æ¥é
        {
            try {
                Object obj = JackSonUtil.string2Obj(hugeLevelJson, Object.class);
            }catch (Exception e){
                // ä¼æ¥é
                System.out.println("jackson parse hugeLevelJson error!   " + e.getCause().getMessage());
            }
        }

        // åºäºå æ çè½æ­£ç¡®çè§£æåºæ¥ï¼ä¸ä¼StackOverflowErroræ æº¢åº
        {
            StackBaseJsonParser stackBaseJsonParser = new StackBaseJsonParser(new StreamJsonTokenReader(hugeLevelJson));
            JsonElement obj = stackBaseJsonParser.doParse();
            int arrayLevel = TestUtil.getSpecialJsonArrayLevel(obj);
            Assert.assertEquals(arrayLevel, level - 1);
            System.out.println("stackBaseJsonParser parseï¼arrayLevel=" + arrayLevel);
        }
    }
}
</code></pre>
<p><img src="https://img2024.cnblogs.com/blog/1506329/202602/1506329-20260211200045678-964632399.png" alt="test_huge_level_json_parse" loading="lazy"></p>
<h5 id="éå½-vs-å æ è§£æçåè">éå½ vs å æ è§£æçåè</h5>
<ul>
<li>åºäºéå½çjsonè¯­æ³è§£æå¨å®ç°ç®åï¼æè·¯æ´ç´è§ï¼ä½åéäºçº¿ç¨æ å¤§å°ï¼å¨ææ·±å±çº§ä¸ä¼åºç°StackOverflowã</li>
<li>åºäºå æ çjsonè¯­æ³è§£æå¨ç¶ææºæ´åºå¤§ï¼å®ç°èµ·æ¥æ´å¤æï¼ä½å°è°ç¨æ æ¬å°å ä¸ä¹åï¼è½å¤çææ·±å±çº§çjsonï¼åªè¦å åå­è¶³å¤ï¼ã</li>
<li>Jacksonç­æççä¸æ¹åºå³ä½¿åæ ·åºäºå æ å®ç°ï¼éå¸¸ä¹ä¼è®¾ç½®ä¸ä¸ªåççæ·±åº¦ä¸éï¼é¿åæ¶ææå¼å¸¸çjsonå¯¼è´ç³»ç»èµæºèå°½ã</li>
</ul>
<h2 id="æ»ç»">æ»ç»</h2>
<p>å°è¿éï¼æä»¬å·²ç»å¦å¼å¤´æè¯´çé£è¬ï¼ä¸æ­¥ä¸æ­¥çä»é¶å¼å§å®ç°äºä¸ä¸ªç®åçjsonè§£æå¨ã<br>
è½ç¶ç½ç»ä¸å·²ç»æçå¤§éå³äºjsonè§£æå¨å®ç°åççåå®¢ï¼çè³å©ç¨aié½è½å¸®ä½ å®ç°çå¤§å·®ä¸å·®ãä½æ¯çº¸ä¸å¾æ¥ç»è§æµï¼ç»ç¥æ­¤äºè¦èº¬è¡ï¼æ³è¦æ´å¥½çå­¦ä¹ ç¼è¯åçï¼å»çè§£ä¹è³å®ç°æ´å¤æçç¼è¯å¨ãè§£éå¨ï¼éè¿èªå·±å¨æå»ä½ä¼é£äºæ¦æ¶©æ½è±¡çåçä¹è®¸æ¯ä¸ç§æçè¾ä½ä½é¿è¿çåçæ ç©·çå­¦ä¹ æ¹å¼ã</p>
<h5 id="_-19"></h5>
<p>åå®¢ä¸­å±ç¤ºçå®æ´ä»£ç å¨æçgithubä¸ï¼<a href="https://github.com/1399852153/MySimpleJsonParser" target="_blank" rel="noopener nofollow">https://github.com/1399852153/MySimpleJsonParser</a> (mainåæ¯)ã<br>
å¸æè½å¤å¸®å©å°å¯¹jsonè§£æææ¯ç¼è¯åçæå´è¶£çè¯»èï¼åå®¹å¦æéè¯¯ï¼è¿è¯·å¤å¤ææã</p>


</div>
<div class="clear"></div>

	<div class="postDesc">posted on 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-02-11 20:23">2026-02-11 20:23</span>&nbsp;
<a href="https://www.cnblogs.com/xiaoxiongcanguan">å°çé¤é¦</a>&nbsp;
éè¯»(<span id="post_view_count">97</span>)&nbsp;
è¯è®º(<span id="post_comment_count">1</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19605794);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19605794', targetLink: 'https://www.cnblogs.com/xiaoxiongcanguan/p/19605794', title: 'ä»é¶å¼å§å®ç°ä¸ä¸ªç®æjsonè§£æå¨' })">ä¸¾æ¥</a>
</div>
 ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ ç±»åæ¦é¤ä¸é¨åå¼æ­¥ç¼ç¨ ]]></title>
    <link>https://www.cnblogs.com/suiyuan129/p/19605836</link>
    <guid>55518f514c3ebe17d7eff0dc90176303</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/suiyuan129/p/19605836" title="åå¸äº 2026-02-11 20:16">
    <span role="heading" aria-level="2">ç±»åæ¦é¤ä¸é¨åå¼æ­¥ç¼ç¨</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h1 id="ç±»åæ¦é¤ä¸é¨åå¼æ­¥ç¼ç¨-æ¶é¤å·®å«ç»ä¸ä½¿ç¨">ç±»åæ¦é¤ä¸é¨åå¼æ­¥ç¼ç¨: æ¶é¤å·®å«ï¼ç»ä¸ä½¿ç¨</h1>
<p>C++ ä¸­ç±»åæ¦é¤æå¸åçå®ç°æè·¯åä¸ºä¸¤ç±»ââæ¨¡æ¿ï¼ç¼è¯ææ¦é¤ï¼ä¸å¤æï¼è¿è¡æ¶æ¦é¤ï¼ï¼è¿ä¸¤ç§æ¹å¼å¤§å®¶é½æ¯è¾çæãèæ ååºä¸ºæä»¬å°è£äºæ´æç¨çç±»åæ¦é¤å·¥å·ï¼æ ¸å¿åæ¬ <code>std::function</code>ã<code>std::any</code>ã<code>std::span</code> å <code>std::variant</code>ï¼å®ä»¬å¨ä¸ååºæ¯ä¸å¸®æä»¬âæ¶é¤ç±»åå·®å«ï¼å®ç°ç»ä¸ä½¿ç¨âï¼åæ¶ï¼ç±»åæ¦é¤ä¹æ¯å¼æ­¥ç¼ç¨çæ ¸å¿åºç¡ï¼<code>std::function</code> æ­éç¸å³ç»ä»¶å¯å®ç°ä»»æå¼æ­¥ä»»å¡çç»ä¸è°åº¦ï¼è¿ä¹æ¯æä»¬å°ä¸¤èç»åè®²è§£çæ ¸å¿åå ã</p>
<h2 id="1-stdfunctionå¯è°ç¨å¯¹è±¡çç»ä¸è°ç¨æ¥å£">1. std::functionï¼å¯è°ç¨å¯¹è±¡çâç»ä¸è°ç¨æ¥å£â</h2>
<p><code>std::function</code> æ¯éå¯¹<strong>å¯è°ç¨å¯¹è±¡</strong>çç±»åæ¦é¤å·¥å·ï¼å¶åºå±å®ç°æ ¸å¿æ¯ãæ½è±¡åºç±» + æ¨¡æ¿å­ç±»ãçå¤ææ¨¡å¼ï¼ä¹æ¯è¿è¡æ¶ç±»åæ¦é¤çå¸ååºç¨ï¼</p>
<ul>
<li>æ½è±¡åºç±»ï¼å®ä¹äºä¸âå½æ°ç­¾åâå®å¨å¹éççº¯èè°ç¨æ¥å£ï¼æ¯å¦ <code>virtual Ret call(Args...) = 0</code>ï¼ï¼ä½ä¸ºç»ä¸è°ç¨çåºåï¼</li>
<li>æ¨¡æ¿å­ç±»ï¼å­å¨å·ä½çå¯è°ç¨å¯¹è±¡ï¼å½æ°ãlambdaãä»¿å½æ°ã<code>std::bind</code> ç»æç­ï¼ï¼å¹¶éåæ½è±¡åºç±»ç <code>call</code> æ¹æ³ï¼ééå·ä½å¯¹è±¡çè°ç¨é»è¾ã</li>
</ul>
<p>æ­£å ä¸º <code>std::function</code> æ¯éè¿è°ç¨<strong>æ½è±¡åºç±»çç»ä¸æ¥å£</strong>ï¼é´æ¥å¼å«å­å¥æ¨¡æ¿å­ç±»ä¸­çå·ä½å½æ°ï¼æä»¥æä»¬<strong>å¿é¡»æåæç¡®åç¥ <code>std::function</code> å®æ´çå½æ°ç­¾åï¼è¿åå¼ç±»åãåæ°ç±»åãåæ°ä¸ªæ°ï¼</strong> ââ è¿æ¯æ½è±¡åºç±»å®ä¹ç»ä¸è°ç¨æ¥å£çåæï¼åªæç­¾åä¸è´ï¼ææè¢«æ¦é¤ç±»åçå¯è°ç¨å¯¹è±¡ï¼æè½éè¿æ½è±¡åºç±»çæ¥å£è¢«æ­£ç¡®è°ç¨ãä¹æ­£å è¿è¡æ¶çå¤ææ´¾åï¼éè¿æ½è±¡åºç±»æéè°ç¨å­ç±»ç <code>call</code> æ¹æ³ï¼ï¼<code>std::function</code> ä¼äº§çä¸å®çè¿è¡æ¶å¼éã</p>
<h3 id="æµè¯ä»£ç stdfunction-ç»ä¸è°ç¨ä¸åå¯è°ç¨å¯¹è±¡">æµè¯ä»£ç ï¼std::function ç»ä¸è°ç¨ä¸åå¯è°ç¨å¯¹è±¡</h3>
<pre><code class="language-cpp">#include &lt;iostream&gt;
#include &lt;functional&gt;
#include &lt;string&gt;

// æ®éå½æ°
int add(int a, int b) { return a + b; }

// ä»¿å½æ°
struct Multiply {
    int operator()(int a, int b) { return a * b; }
};

int main() {
    // å®ä¹å½æ°ç­¾åï¼int(int, int)
    std::function&lt;int(int, int)&gt; func;

    // å­å¨æ®éå½æ°
    func = add;
    std::cout &lt;&lt; "add(3,4) = " &lt;&lt; func(3, 4) &lt;&lt; std::endl; // è¾åº7

    // å­å¨lambdaè¡¨è¾¾å¼
    func = [](int a, int b) { return a - b; };
    std::cout &lt;&lt; "sub(3,4) = " &lt;&lt; func(3, 4) &lt;&lt; std::endl; // è¾åº-1

    // å­å¨ä»¿å½æ°
    func = Multiply{};
    std::cout &lt;&lt; "mul(3,4) = " &lt;&lt; func(3, 4) &lt;&lt; std::endl; // è¾åº12

    return 0;
}
</code></pre>
<p>ä»£ç è¯´æï¼æ è®ºå­å¨çæ¯æ®éå½æ°ãlambdaè¿æ¯ä»¿å½æ°ï¼åªè¦å½æ°ç­¾åå¹é <code>int(int, int)</code>ï¼å°±è½éè¿ <code>std::function</code> ç»ä¸è°ç¨ï¼ä½ç°äºç±»åæ¦é¤âæ¶é¤å·®å«ï¼ç»ä¸ä½¿ç¨âçæ ¸å¿ã</p>
<h2 id="2-stdany--stdvariantæ°æ®å­å¨çç±»åæ¦é¤åé">2. std::any &amp; std::variantï¼æ°æ®å­å¨çâç±»åæ¦é¤åéâ</h2>
<p>ä¸¤èåç¨äºå®ç°æ°æ®å­å¨çç±»åæ¦é¤ï¼ä½å®ä½äºè¡¥ï¼<code>std::variant</code> æ ¸å¿æ¯å¼¥è¡¥ <code>std::any</code> çç¹çä¸ä½æé®é¢ã</p>
<h3 id="stdanyæ çº¦æçå¨ç±»åæ¦é¤">std::anyï¼æ çº¦æçå¨ç±»åæ¦é¤</h3>
<p><code>std::any</code> æ¯ç»å¸çâå¨ç±»åæ¦é¤âå·¥å·ï¼å®å®å¨æ¦é¤ç¼è¯æçç±»åä¿¡æ¯ï¼ä»ä¿çâæ°æ®æ¬èº« + è¿è¡æ¶ç±»åIDï¼<code>std::type_info</code>ï¼âï¼ç¸å½äºä¸ä¸ªâå¸¦ç±»åæ ç­¾çä¸è½çå­âï¼è½å­å¨ä»»æç±»åçæ°æ®ã<br>
å <code>std::function</code> ç±»ä¼¼ï¼<code>std::any</code> éå¨è¿è¡æ¶éè¿ç±»åIDè¯å«åé¨æ°æ®ç±»åï¼å æ­¤å­å¨è¿è¡æ¶å¼éï¼æ­¤å¤ï¼<code>std::any</code> å¯¹å¤§ç±»åä¼è¿è¡å åå­åéï¼è¿ä¸æ­¥å¢å è½»å¾®çåå­å¼éãå¶æå¤§çç¹ç¹æ¯èªç±æ çº¦æï¼ä½è¿ä»½èªç±ä¹å¸¦æ¥äºæä½ç¹ççé®é¢ââä½¿ç¨æ¶å¿é¡»æå¨éè¿ <code>typeid</code> æ£æ¥ç±»åï¼åç¨ <code>any_cast</code> æåæ°æ®ï¼ä¸ç±»åéè¯¯åªè½å¨è¿è¡æ¶æ´é²ï¼æåº <code>std::bad_any_cast</code> å¼å¸¸ï¼ã</p>
<h3 id="stdvariantæéå¶çé«æç±»åæ¦é¤">std::variantï¼æéå¶çé«æç±»åæ¦é¤</h3>
<p><code>std::variant</code> æ¯ä¸ºè§£å³ <code>std::any</code> ççç¹èçï¼å®éè¿<strong>ç¼è¯ææåå£°æå¯å­å¨çç±»åèå´</strong>ï¼å®ç°äºæ´é«æãæ´å®å¨çç±»åæ¦é¤ï¼å±äºâæéç±»åæ¦é¤âï¼</p>
<ul>
<li>ç¼è¯æååºï¼åéç±»åï¼æ¯å¦ç¨ <code>std::get</code> æåéæ´»è·ç±»åï¼ä¼è¢«ç¼è¯å¨åæ¶æéï¼æ´æ©æ´é²é®é¢ï¼é¿åè¿è¡æ¶å¼å¸¸é¾ä»¥è°è¯ï¼</li>
<li>ç»ä¸ä¾¿æ·å¤çï¼æ éæåä¸å  <code>if (typeid)</code> å¤æ­åæ¯ï¼éè¿ <code>std::visit</code> å°±è½æ¹éå¤çææé¢å®ä¹ç±»åï¼ä»£ç æ´ç®æ´ãä¸ææ¼åæ¯ï¼</li>
<li>é¶å å¼éï¼<code>std::variant</code> çå¤§å°å¨ç¼è¯æç¡®å®ï¼ç­äºææé¢å®ä¹ç±»åä¸­æå¤§ç±»åçå°ºå¯¸ + ç±»åæ ç­¾å°ºå¯¸ï¼ï¼æææ°æ®åå­å¨å¨æ ä¸ï¼æ å åéå¼éï¼</li>
<li>å®å¨æåï¼æä¾ <code>std::holds_alternative</code>ï¼å¤æ­æ¯å¦ä¸ºæå®ç±»åï¼ã<code>std::get_if</code>ï¼å®å¨æåï¼ä¸å¹éè¿å <code>nullptr</code>ï¼ç­å·¥å·ï¼æ éæè·å¼å¸¸ï¼ç±»åæ£æ¥åæ°æ®æåæ´ç´è§ãå®å¨ã</li>
</ul>
<p>ç®åæ¥è¯´ï¼<code>std::any</code> æ¯âæ ææ æä½å¨é æå¨âï¼<code>std::variant</code> æ¯âæéå¶ä½ç¼è¯å¨å¸®ä½ ååºâï¼è¿ä»½éå¶æ°æ°æ¯å®ç®åæä½ãæåæççæ ¸å¿ã</p>
<h3 id="æµè¯ä»£ç stdany-ä¸-stdvariant-å¯¹æ¯">æµè¯ä»£ç ï¼std::any ä¸ std::variant å¯¹æ¯</h3>
<pre><code class="language-cpp">#include &lt;iostream&gt;
#include &lt;any&gt;
#include &lt;variant&gt;
#include &lt;string&gt;
#include &lt;typeinfo&gt;

// å¤çstd::any
void process_any(std::any val) {
    if (val.type() == typeid(int)) {
        std::cout &lt;&lt; "anyå­å¨intï¼" &lt;&lt; std::any_cast&lt;int&gt;(val) &lt;&lt; std::endl;
    } else if (val.type() == typeid(std::string)) {
        std::cout &lt;&lt; "anyå­å¨stringï¼" &lt;&lt; std::any_cast&lt;std::string&gt;(val) &lt;&lt; std::endl;
    } else if (val.type() == typeid(double)) {
        std::cout &lt;&lt; "anyå­å¨doubleï¼" &lt;&lt; std::any_cast&lt;double&gt;(val) &lt;&lt; std::endl;
    }
}

// å¤çstd::variant
using MyVariant = std::variant&lt;int, std::string, double&gt;;
void process_variant(const MyVariant&amp; val) {
    // æ éæåif(typeid)ï¼std::visitæ¹éå¤ç
    std::visit([](const auto&amp; v) {
        using T = std::decay_t&lt;decltype(v)&gt;;
        if constexpr (std::is_same_v&lt;T, int&gt;) {
            std::cout &lt;&lt; "variantå­å¨intï¼" &lt;&lt; v &lt;&lt; std::endl;
        } else if constexpr (std::is_same_v&lt;T, std::string&gt;) {
            std::cout &lt;&lt; "variantå­å¨stringï¼" &lt;&lt; v &lt;&lt; std::endl;
        } else if constexpr (std::is_same_v&lt;T, double&gt;) {
            std::cout &lt;&lt; "variantå­å¨doubleï¼" &lt;&lt; v &lt;&lt; std::endl;
        }
    }, val);
}

int main() {
    // std::anyæµè¯
    std::any a = 10;
    process_any(a); // è¾åºanyå­å¨intï¼10
    a = std::string("hello any");
    process_any(a); // è¾åºanyå­å¨stringï¼hello any
    a = 3.14;
    process_any(a); // è¾åºanyå­å¨doubleï¼3.14

    // std::variantæµè¯
    MyVariant v = 20;
    process_variant(v); // è¾åºvariantå­å¨intï¼20
    v = std::string("hello variant");
    process_variant(v); // è¾åºvariantå­å¨stringï¼hello variant
    v = 6.28;
    process_variant(v); // è¾åºvariantå­å¨doubleï¼6.28

    // std::variantå®å¨æåç¤ºä¾
    if (std::holds_alternative&lt;double&gt;(v)) {
        auto p = std::get_if&lt;double&gt;(&amp;v);
        std::cout &lt;&lt; "å®å¨æådoubleï¼" &lt;&lt; *p &lt;&lt; std::endl; // è¾åº6.28
    }

    return 0;
}
</code></pre>
<p>ä»£ç è¯´æï¼</p>
<ul>
<li><code>std::any</code> éæå¨å <code>if (typeid)</code> åæ¯ï¼æ°å¢ç±»åæ¶éæå¨æ©å±ï¼</li>
<li><code>std::variant</code> åå© <code>std::visit</code> æ¹éå¤çææé¢å®ä¹ç±»åï¼ä»£ç æ´ç®æ´ï¼ä¸ <code>holds_alternative</code>/<code>get_if</code> è®©ç±»åæ£æ¥/æåæ´å®å¨ã</li>
</ul>
<h2 id="3-stdspanè¿ç»­å®¹å¨çé¶å¼éç±»åæ¦é¤">3. std::spanï¼è¿ç»­å®¹å¨çâé¶å¼éç±»åæ¦é¤â</h2>
<p><code>std::span</code> æ¯éå¯¹<strong>è¿ç»­åå­å®¹å¨</strong>çâç¹å¶ç±»åæ¦é¤å·¥å·âï¼ä¸é¨ç¨äºæ¶é¤ä¸åè¿ç»­å®¹å¨çç±»åå·®å¼ï¼å®ç°ç»ä¸è®¿é®ï¼<br>
å®ä¼æ¦é¤ <code>std::vector</code>ã<code>std::array</code>ãCé£æ ¼æ°ç»ç­è¿ç»­å®¹å¨çå·ä½ç±»åï¼ä»ä¿çâèµ·å§æé + åç´ é¿åº¦âä¸¤ä¸ªæ ¸å¿ç¹å¾ï¼ç¸å½äºç»ææè¿ç»­åå­å®¹å¨æä¾äºä¸ä¸ªç»ä¸çâè§å¾âã<br>
<code>std::span</code> çæ ¸å¿ä¼å¿æ¯<strong>é¶è¿è¡æ¶å¼é</strong>ââç±»åæ¦é¤å¨ç¼è¯æå®æï¼æ éè¿è¡æ¶é¢å¤è®¡ç®æåå­åéï¼ä½ä¹ææç¡®éå¶ï¼ä»æ¯æè¿ç»­åå­å®¹å¨ï¼æ æ³å¤ç <code>std::list</code> ç­éè¿ç»­åå­å®¹å¨ã</p>
<h3 id="æµè¯ä»£ç stdspan-ç»ä¸è®¿é®ä¸åè¿ç»­å®¹å¨">æµè¯ä»£ç ï¼std::span ç»ä¸è®¿é®ä¸åè¿ç»­å®¹å¨</h3>
<pre><code class="language-cpp">#include &lt;iostream&gt;
#include &lt;span&gt;
#include &lt;vector&gt;
#include &lt;array&gt;

// ç»ä¸å¤çææè¿ç»­intå®¹å¨
void print_span(std::span&lt;int&gt; sp) {
    std::cout &lt;&lt; "å®¹å¨é¿åº¦ï¼" &lt;&lt; sp.size() &lt;&lt; "ï¼åå®¹ï¼";
    for (int val : sp) {
        std::cout &lt;&lt; val &lt;&lt; " ";
    }
    std::cout &lt;&lt; std::endl;
}

int main() {
    // std::vector
    std::vector&lt;int&gt; vec = {1, 2, 3};
    print_span(vec); // è¾åºå®¹å¨é¿åº¦ï¼3ï¼åå®¹ï¼1 2 3

    // std::array
    std::array&lt;int, 4&gt; arr = {4, 5, 6, 7};
    print_span(arr); // è¾åºå®¹å¨é¿åº¦ï¼4ï¼åå®¹ï¼4 5 6 7

    // Cé£æ ¼æ°ç»
    int c_arr[] = {8, 9, 10};
    print_span(c_arr); // è¾åºå®¹å¨é¿åº¦ï¼3ï¼åå®¹ï¼8 9 10

    // åçè®¿é®ï¼spançé¢å¤ä¼å¿ï¼
    print_span(std::span(vec).subspan(1, 2)); // è¾åºå®¹å¨é¿åº¦ï¼2ï¼åå®¹ï¼2 3

    return 0;
}
</code></pre>
<p>ä»£ç è¯´æï¼<code>print_span</code> å½æ°æ éå³å¿ä¼ å¥çæ¯ <code>vector</code>ã<code>array</code> è¿æ¯Cæ°ç»ï¼<code>std::span</code> æ¦é¤äºå®¹å¨ç±»åå·®å¼ï¼å®ç°ç»ä¸è®¿é®ï¼ä¸æ ä»»ä½è¿è¡æ¶å¼éã</p>
<h2 id="4-ç±»åæ¦é¤å¨å¼æ­¥ç¼ç¨ä¸­çæ ¸å¿åºç¨">4. ç±»åæ¦é¤å¨å¼æ­¥ç¼ç¨ä¸­çæ ¸å¿åºç¨</h2>
<p>ä¸ºä»ä¹è¦å°ç±»åæ¦é¤ä¸å¼æ­¥ç¼ç¨ç»åï¼å ä¸º <code>std::function</code> çç±»åæ¦é¤è½åï¼æ¯å¼æ­¥ä»»å¡âç»ä¸ç®¡çâçæ ¸å¿ï¼å®å¸¸æ­é lambda è¡¨è¾¾å¼ã<code>std::packaged_task</code>ã<code>std::bind</code> å®ç°ä»»æå¼æ­¥ä»»å¡çç»ä¸è°åº¦ï¼æ ¸å¿é»è¾æ¯âæ¦é¤ä»»å¡å·®å¼ï¼ç»ä¸ç®¡çï¼æéè·åç»æâï¼</p>
<ol>
<li>ç¨ <code>std::bind</code> å°ä»»å¡åæ°ä¸å¯è°ç¨å¯¹è±¡ç»å®ï¼æ¦é¤ä¸åä»»å¡çåæ°ç±»åå·®å¼ï¼è®©æåä»»å¡ééç»ä¸çè°ç¨å½¢å¼ï¼</li>
<li>å°ç»å®åçä»»å¡è£å¥ <code>std::packaged_task</code>ï¼éè¿ <code>std::packaged_task</code> åç½®ç <code>std::promise</code>ï¼è·å <code>std::future</code> å¯¹è±¡ï¼ç¨äºåç»­æ¥æ¶å¼æ­¥ä»»å¡çè¿åå¼ï¼ââ æ­¤æ¶ä»»å¡çè¿åå¼ç±»åæªè¢«æ¦é¤ï¼</li>
<li>éè¿ lambda è¡¨è¾¾å¼å°è£ <code>std::packaged_task</code> çæ§è¡é»è¾ï¼å°âæè¿åå¼çä»»å¡âåè£ææ è¿åå¼ç <code>void()</code> ç±»åï¼ä»èæ¦é¤è¿åå¼å·®å¼ï¼</li>
<li>æç»ï¼ææå¼æ­¥ä»»å¡åå¯ç»ä¸è£è¿ <code>std::function&lt;void()&gt;</code> ä¸­è¿è¡ç®¡çï¼ä»»å¡çè¿åå¼åå¨å¼æ­¥æ§è¡å®æåï¼èªå¨å­å¥ <code>std::packaged_task</code> åé¨ç <code>std::promise</code>ï¼æä»¬éè¿ä¹åè·åç <code>std::future</code> å°±è½æéè·åå¼æ­¥ç»æï¼å®ç°âä»»å¡ç»ä¸ç®¡ç + ç»ææéè·åâã</li>
</ol>
<h3 id="æµè¯ä»£ç ç±»åæ¦é¤å®ç°å¼æ­¥ä»»å¡ç»ä¸ç®¡ç">æµè¯ä»£ç ï¼ç±»åæ¦é¤å®ç°å¼æ­¥ä»»å¡ç»ä¸ç®¡ç</h3>
<pre><code class="language-cpp">#include &lt;iostream&gt;
#include &lt;functional&gt;
#include &lt;future&gt;
#include &lt;thread&gt;
#include &lt;queue&gt;
#include &lt;mutex&gt;
#include &lt;condition_variable&gt;
#include &lt;string&gt;

// å¨å±ä»»å¡éåï¼å­å¨ç»ä¸çæ è¿åå¼ä»»å¡
std::queue&lt;std::function&lt;void()&gt;&gt; task_queue;
std::mutex mtx;
std::condition_variable cv;
bool stop = false;

// å·¥ä½çº¿ç¨ï¼æ¶è´¹ä»»å¡éå
void worker() {
    while (!stop) {
        std::function&lt;void()&gt; task;
        // å éåä»»å¡
        {
            std::unique_lock&lt;std::mutex&gt; lock(mtx);
            cv.wait(lock, []() { return stop || !task_queue.empty(); });
            if (stop &amp;&amp; task_queue.empty()) return;
            task = std::move(task_queue.front());
            task_queue.pop();
        }
        // æ§è¡ä»»å¡
        task();
    }
}

// æäº¤ä»»å¡æ¨¡æ¿ï¼æ¦é¤åæ°/è¿åå¼å·®å¼ï¼ç»ä¸å­å¥éå
template&lt;typename F, typename... Args&gt;
auto submit_task(F&amp;&amp; f, Args&amp;&amp;... args) -&gt; std::future&lt;decltype(f(args...))&gt; {
    // ç»å®åæ°ï¼æ¦é¤åæ°å·®å¼
    auto bound_task = std::bind(std::forward&lt;F&gt;(f), std::forward&lt;Args&gt;(args)...);
    // å®ä¹packaged_taskï¼ä¿çè¿åå¼ç±»å
    using RetType = decltype(f(args...));
    std::packaged_task&lt;RetType()&gt; pt(std::move(bound_task));
    // è·åfutureç¨äºæ¥æ¶ç»æ
    std::future&lt;RetType&gt; fut = pt.get_future();
    // å°è£ævoid()ä»»å¡ï¼æ¦é¤è¿åå¼å·®å¼
    std::function&lt;void()&gt; wrapper = [pt = std::move(pt)]() mutable {
        pt(); // æ§è¡packaged_taskï¼ç»æå­å¥promise
    };
    // å­å¥ä»»å¡éå
    {
        std::lock_guard&lt;std::mutex&gt; lock(mtx);
        task_queue.push(std::move(wrapper));
    }
    cv.notify_one(); // å¤éå·¥ä½çº¿ç¨
    return fut;
}

// æµè¯ä»»å¡1ï¼æåæè¿åå¼ï¼è®¡ç®å¹³æ¹ï¼
int square(int x) {
    std::this_thread::sleep_for(std::chrono::seconds(1));
    return x * x;
}

// æµè¯ä»»å¡2ï¼æåæè¿åå¼ï¼æ¼æ¥å­ç¬¦ä¸²ï¼
std::string concat(const std::string&amp; a, const std::string&amp; b) {
    std::this_thread::sleep_for(std::chrono::seconds(1));
    return a + b;
}

int main() {
    // å¯å¨å·¥ä½çº¿ç¨
    std::thread t(worker);

    // æäº¤ä»»å¡1ï¼è®¡ç®5çå¹³æ¹
    auto fut1 = submit_task(square, 5);
    // æäº¤ä»»å¡2ï¼æ¼æ¥å­ç¬¦ä¸²
    auto fut2 = submit_task(concat, "hello ", "async");

    // ä¸»çº¿ç¨ç­å¾ç»æ
    std::cout &lt;&lt; "ç­å¾å¼æ­¥ä»»å¡ç»æ..." &lt;&lt; std::endl;
    std::cout &lt;&lt; "5çå¹³æ¹ï¼" &lt;&lt; fut1.get() &lt;&lt; std::endl; // è¾åº25
    std::cout &lt;&lt; "å­ç¬¦ä¸²æ¼æ¥ï¼" &lt;&lt; fut2.get() &lt;&lt; std::endl; // è¾åºhello async

    // åæ­¢å·¥ä½çº¿ç¨
    stop = true;
    cv.notify_one();
    t.join();

    return 0;
}
</code></pre>
<p>ä»£ç è¯´æï¼</p>
<ul>
<li><code>square</code> å <code>concat</code> æ¯ä¸åç­¾åçä»»å¡ï¼åæ°/è¿åå¼åä¸åï¼ï¼</li>
<li>éè¿ <code>std::bind</code> æ¦é¤åæ°å·®å¼ï¼<code>std::packaged_task</code> ä¿çè¿åå¼å¹¶ç»å® <code>future</code>ï¼lambda å°è£æ <code>void()</code> æ¦é¤è¿åå¼å·®å¼ï¼</li>
<li>æç»ææä»»å¡é½è½å­å¥ <code>std::function&lt;void()&gt;</code> éåï¼å®ç°ç»ä¸ç®¡çï¼ä½ç°äºç±»åæ¦é¤å¨å¼æ­¥ç¼ç¨ä¸­çæ ¸å¿ä»·å¼ã</li>
</ul>
<h2 id="æ´ä½æ»ç»">æ´ä½æ»ç»</h2>
<p>æ ååºä¸­çåç§ç±»åæ¦é¤å·¥å·ï¼è½å®ä½ä¸åï¼ä½æ ¸å¿ç®æ ä¸è´ââ<strong>æ¶é¤ç±»åå·®å«ï¼å®ç°ç»ä¸ä½¿ç¨</strong>ï¼</p>
<ol>
<li><code>std::function</code>ï¼éå¯¹å¯è°ç¨å¯¹è±¡ï¼ç»ä¸è°ç¨æ¥å£ï¼ä¾èµå½æ°ç­¾ååå¤æå®ç°ï¼æè¿è¡æ¶å¼éï¼</li>
<li><code>std::any</code>ï¼éå¯¹ä»»ææ°æ®ï¼å¨ç±»åæ¦é¤ï¼èªç±ä½ç¹çãæè¿è¡æ¶åå åå­å¼éï¼</li>
<li><code>std::variant</code>ï¼éå¯¹æéèå´æ°æ®ï¼å¼¥è¡¥ <code>std::any</code> ä¸è¶³ï¼ç¼è¯æååºãé«æä¾¿æ·ãé¶å å¼éï¼</li>
<li><code>std::span</code>ï¼éå¯¹è¿ç»­å®¹å¨ï¼é¶å¼éç±»åæ¦é¤ï¼ç»ä¸è¿ç»­åå­è®¿é®æ¥å£ï¼ä»æ¯æè¿ç»­å®¹å¨ã</li>
</ol>
<p>èç±»åæ¦é¤ä¸å¼æ­¥ç¼ç¨çç»åï¼æ ¸å¿æ¯åå© <code>std::function</code> çç»ä¸ç®¡çè½åï¼æ­é lambdaã<code>std::packaged_task</code>ã<code>std::bind</code> ç­ç»ä»¶ï¼æ¦é¤ä¸åå¼æ­¥ä»»å¡çåæ°åè¿åå¼å·®å¼ï¼å®ç°ä»»æå¼æ­¥ä»»å¡çç»ä¸è°åº¦ï¼è¿ä¹æ¯ç±»åæ¦é¤å¨å®éå¼åä¸­æå¸¸ç¨çåºæ¯ä¹ä¸ã</p>


</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.003472222222222222" data-date-updated="2026-02-11 20:21">2026-02-11 20:16</span>&nbsp;
<a href="https://www.cnblogs.com/suiyuan129">suiyuan129</a>&nbsp;
éè¯»(<span id="post_view_count">22</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19605836);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19605836', targetLink: 'https://www.cnblogs.com/suiyuan129/p/19605836', title: 'ç±»åæ¦é¤ä¸é¨åå¼æ­¥ç¼ç¨' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ ç®æçåå¸å¼kvè®¾è®¡ ]]></title>
    <link>https://www.cnblogs.com/jackjavacpp/p/19605754</link>
    <guid>41de02f9f6dcc481cf83e91759f9ef13</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/jackjavacpp/p/19605754" title="åå¸äº 2026-02-11 19:47">
    <span role="heading" aria-level="2">ç®æçåå¸å¼kvè®¾è®¡</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h1 id="ç®æçåå¸å¼kvè®¾è®¡--ä¸">ç®æçåå¸å¼kvè®¾è®¡--(ä¸)</h1>
<p><strong>è¿ç¯æç« ç®ååªè®¾è®¡å°éç¾¤å¯å¨ï¼ç¶åèªå¨éä¸»çåè½ã</strong></p>
<p>å°åï¼<a href="https://github.com/Jack-txf/easy-kv" target="_blank" rel="noopener nofollow">https://github.com/Jack-txf/easy-kv</a></p>
<p><strong>TIPS</strong>ï¼æ­¤æç« å¯¹åºçåæ¯çæ¬æ¯<strong>version0211</strong></p>
<p>raftåºç¡ç¥è¯ï¼<a href="https://mp.weixin.qq.com/s/DHO2CK87kI-clf4O96t5Cw" target="_blank" rel="noopener nofollow">https://mp.weixin.qq.com/s/DHO2CK87kI-clf4O96t5Cw</a></p>
<h1 id="1-åè¨">1. åè¨</h1>
<p>å¨ Raft KV ç³»ç»ä¸­ï¼æ¯ä¸ªèç¹ï¼Nodeï¼é½æ¯å¯¹ç­çãä¸ä¸ªå¸åçè¯·æ±æµåæ¯ï¼ <code>Client</code> -&gt; <code>Leader Node</code> -&gt; <code>Raft æ¥å¿åæ­¥</code> -&gt; <code>å¤§å¤æ°èç¹ç¡®è®¤</code> -&gt; <code>åºç¨å°ç¶ææº (KV Store)</code> -&gt; <code>è¿å Client</code>ã</p>
<h1 id="2-è®¾è®¡æ­¥éª¤">2. è®¾è®¡æ­¥éª¤</h1>
<p>Raft æ ¸å¿ç»ä»¶åæ¬ï¼ä¸è´æ§ç»ç¹æ¨¡åï¼RPC éä¿¡ï¼æ¥å¿æ¨¡åã</p>
<h2 id="21-æ¥å¿">2.1 æ¥å¿</h2>
<pre><code class="language-txt">åæ¥å¿ â å¤å¶æ¥å¿ â commit â apply ãleaderåºç¨é¡ºåºã

ç»åä¸ä¸çè¯å°±å¦ä¸ï¼
Client
   â
Leader
   â append log (æ¬å°)
   â
åé AppendEntries
   â
Followers append log
   â
å¤æ°æå
   â
Leader commit
   â
Leader apply
   â
è¿åå®¢æ·ç«¯æå
   â
Leader ä¸æ¬¡å¿è·³å¸¦ commitIndex
   â
Followers apply
</code></pre>
<p>é¦åçä¸ä¸ï¼å®¢æ·ç«¯åéä¸ä¸ªè¯·æ±ï¼æ¶åå°çå¤§è´ä¸è¥¿æåªäºï¼</p>
<img src="https://img2024.cnblogs.com/blog/2358057/202602/2358057-20260211194613207-412932482.png" style="zoom: 80%">
<p>ä»åå¾åçï¼æä»¬éè¦è®¾è®¡çå°±æ¯å¦ä½åå¥æ¥å¿æä»¶ï¼ä»¥åæ¥å¿æä»¶çæ ¼å¼è¯¥å¦ä½è®¾è®¡å¢ï¼æ­¤å¤æä»¬å°±å¼ç®åä¸ç¹å¿å°±å¥½äº</p>
<table>
<thead>
<tr>
<th>totalLength ï¼intï¼</th>
<th>termï¼longï¼</th>
<th>indexï¼longï¼</th>
<th>commandLengthï¼intï¼</th>
<th>commandï¼byte[]ï¼</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ´æ¡log entry é¿åº¦</td>
<td>Raft term</td>
<td>æ¥å¿ index</td>
<td>å½ä»¤é¿åº¦</td>
<td>çæ­£å½ä»¤ï¼è¿ä¸ªè¯å®æ¯åé¿ç</td>
</tr>
</tbody>
</table>
<p>totalLength = 8 (term) + 8 (index) + 4 (commandLength) + commandLength</p>
<pre><code class="language-java">public class LogEntry {
    private final long term;
    private final long index;
    private final String command;
    ....
}
</code></pre>
<p>æ¥å¿å­å¨ä¸ç®¡ç</p>
<pre><code class="language-java">/**
 * @Description: æ¥å¿å­å¨ä¸ç®¡ç
 * @Author: txf
 * @Date: 2026/2/9
 */
public class LogManager {
    // æ¥å¿æä»¶è·¯å¾
    private static final String LOG_FILE_PATH = "easy_kv_log.dat";
    // åå­æ å°çåæ®µå¤§å°ï¼128MBï¼å¯æ ¹æ®åå­è°æ´ï¼,è¿éåè°æ´ä¸ºä¸¤å
    private static final int MAPPED_SIZE = 2 * 1024 * 1024;
    // æä»¶æå¼æ¨¡å¼ï¼rw = è¯»å
    private static final String FILE_MODE = "rw";

    private final File logFile;
    private RandomAccessFile raf;
    private FileChannel fileChannel;
    // å½åæ å°çåå­ç¼å²åº
    private MappedByteBuffer currentMappedBuffer;
    // å½åæ å°æ®µçèµ·å§åç§»ï¼æä»¶åç§»ï¼
    private long currentMappedOffset = 0;
    // å½ååå¥çä½ç½®ï¼ç¸å¯¹äºæä»¶çæ»åç§»ï¼
    private long writePosition = 0;

    public LogManager() {
        this.logFile = new File(LOG_FILE_PATH);
        initFileChannel();
        initMappedBuffer();
        // åå§åæ¶å®ä½å°æä»¶æ«å°¾ï¼ç»§ç»­è¿½å åï¼
        try {
            this.writePosition = fileChannel.size();
        } catch (IOException e) {
            throw new RuntimeException("è·åæä»¶å¤§å°å¤±è´¥", e);
        }
    }

    /**
     * è¿½å åå¥åæ¡æ¥å¿ï¼æ ¸å¿é«æ§è½åå¥ï¼
     * @param term Raftä»»æ
     * @param index æ¥å¿ç´¢å¼
     * @param command KVæä½å½ä»¤ï¼å¦"PUT key value"ï¼
     */
    public void appendLogEntry(long term, long index, String command) {
        // 1. åå¤å½ä»¤å­èæ°ç»
        byte[] commandBytes = command.getBytes(StandardCharsets.UTF_8);
        int commandLength = commandBytes.length;
        // 2. è®¡ç®æ»é¿åº¦
        int totalLength = 4 + 8 + 8 + 4 + commandLength;

        // 3. åå¤ç´æ¥ç¼å²åºï¼å å¤åå­ï¼é¿åæ·è´ï¼
        ByteBuffer directBuffer = ByteBuffer.allocateDirect(totalLength);
        // ææ ¼å¼åå¥ç¼å²åº -- è¿éæ¯åå¥äºè¿å¶çï¼æä»¶åå®¹æä»¬äººç±»å°±è¯»ä¸æäº
        directBuffer.putInt(totalLength);
        directBuffer.putLong(term);
        directBuffer.putLong(index);
        directBuffer.putInt(commandLength);
        directBuffer.put(commandBytes);

        // è¿éæ¯åå¥å­ç¬¦ä¸²ç
        // directBuffer.put((term + index + command).getBytes(StandardCharsets.UTF_8));

        // ç¿»è½¬ç¼å²åºï¼ä»åæ¨¡å¼è½¬ä¸ºè¯»æ¨¡å¼ï¼
        directBuffer.flip();
        // 4. åå¥å°åå­æ å°ç¼å²åºï¼æ ¸å¿ï¼é¶æ·è´ï¼
        writeToMappedBuffer(directBuffer);        // 5. æ´æ°å¨å±åå¥ä½ç½®
        writePosition += totalLength;
    }

    /**
     * å°ç¼å²åºæ°æ®åå¥åå­æ å°åºï¼èªå¨æ©å®¹æ å°æ®µï¼
     */
    private void writeToMappedBuffer(ByteBuffer buffer) {
        while (buffer.hasRemaining()) {
            // æ£æ¥å½åæ å°ç¼å²åºæ¯å¦æè¶³å¤å©ä½ç©ºé´
            if (currentMappedBuffer.remaining() &lt; buffer.remaining()) {
                // ååå¥å½åæ å°åºçå©ä½ç©ºé´
                int remaining = currentMappedBuffer.remaining();
                byte[] temp = new byte[remaining];
                buffer.get(temp);
                currentMappedBuffer.put(temp);
                // å¼ºå¶å·çï¼å°æ å°åå­çæ°æ®åæ­¥å°ç£çï¼å¯éï¼æ¹éå·çå¯æåæ§è½ï¼
                currentMappedBuffer.force();
                // æ©å®¹æ å°æ®µ
                initMappedBuffer();
            } else {
                // ç´æ¥åå¥æ å°ç¼å²åº
                currentMappedBuffer.put(buffer);
            }
        }
    }

    /**
     * è¯»åæå®ç´¢å¼çæ¥å¿æ¡ç®ï¼é«æ§è½è¯»åï¼
     */
    public LogEntry readLogEntry(long index) {
        try {
            // ä½¿ç¨FileChannel + ç´æ¥ç¼å²åºè¯»å
            ByteBuffer directBuffer = ByteBuffer.allocateDirect(1024 * 1024); // 1MBç´æ¥ç¼å²åº
            long fileOffset = 0;
            long fileSize = fileChannel.size();

            while (fileOffset &lt; fileSize) {
                // éç½®ç¼å²åº
                directBuffer.clear();
                // ä»æä»¶æå®åç§»è¯»åæ°æ®å°ç¼å²åº
                int readBytes = fileChannel.read(directBuffer, fileOffset);
                if (readBytes == -1) break;
                directBuffer.flip();

                // è§£æç¼å²åºä¸­çæ¥å¿æ¡ç®
                while (directBuffer.hasRemaining()) {
                    // æ£æ¥å©ä½å­èæ¯å¦è¶³å¤è¯»ååºå®å¤´é¨ï¼4+8+8+4=24å­èï¼
                    if (directBuffer.remaining() &lt; 24) break;
                    // è¯»ååºå®å­æ®µ
                    int totalLength = directBuffer.getInt();
                    long term = directBuffer.getLong();
                    long currentIndex = directBuffer.getLong();
                    int commandLength = directBuffer.getInt();
                    // æ£æ¥å©ä½å­èæ¯å¦è¶³å¤è¯»åcommand
                    if (directBuffer.remaining() &lt; commandLength) {
                        // åéç¼å²åºpositionï¼ä¸æ¬¡ç»§ç»­è§£æ
                        directBuffer.position(directBuffer.position() - 24);
                        break;
                    }
                    // è¯»åcommand
                    byte[] commandBytes = new byte[commandLength];
                    directBuffer.get(commandBytes);
                    String command = new String(commandBytes, StandardCharsets.UTF_8);
                    // æ ¡éªæ»é¿åº¦
                    int actualLength = 4 + 8 + 8 + 4 + commandLength;
                    if (totalLength != actualLength) {
                        throw new RuntimeException("æ¥å¿æä»¶æåï¼æ»é¿åº¦ä¸å¹é");
                    }
                    // æ¾å°ç®æ ç´¢å¼åè¿å
                    if (currentIndex == index) {
                        return new LogEntry(term, index, command);
                    }
                    // æ´æ°æä»¶åç§»
                    fileOffset += totalLength;
                }
            }
        } catch (IOException e) {
            throw new RuntimeException("è¯»åæ¥å¿æ¡ç®å¤±è´¥ [index=" + index + "]", e);
        }
        return null;
    }

    /**
     * å è½½æææ¥å¿æ¡ç®ï¼èç¹å¯å¨æ¶æ¢å¤ï¼
     */
    public List&lt;LogEntry&gt; loadAllLogEntries() {
        List&lt;LogEntry&gt; logEntries = new ArrayList&lt;&gt;();
        try {
            ByteBuffer directBuffer = ByteBuffer.allocateDirect(1024 * 1024);
            long fileOffset = 0;
            long fileSize = fileChannel.size();

            while (fileOffset &lt; fileSize) {
                directBuffer.clear();
                int readBytes = fileChannel.read(directBuffer, fileOffset);
                if (readBytes == -1) break;
                directBuffer.flip();

                while (directBuffer.hasRemaining()) {
                    if (directBuffer.remaining() &lt; 24) break;

                    int totalLength = directBuffer.getInt();
                    long term = directBuffer.getLong();
                    long index = directBuffer.getLong();
                    int commandLength = directBuffer.getInt();

                    if (directBuffer.remaining() &lt; commandLength) {
                        directBuffer.position(directBuffer.position() - 24);
                        break;
                    }

                    byte[] commandBytes = new byte[commandLength];
                    directBuffer.get(commandBytes);
                    String command = new String(commandBytes, StandardCharsets.UTF_8);

                    int actualLength = 4 + 8 + 8 + 4 + commandLength;
                    if (totalLength != actualLength) {
                        throw new RuntimeException("æ¥å¿æä»¶æåï¼æ»é¿åº¦ä¸å¹é");
                    }

                    logEntries.add(new LogEntry(term, index, command));
                    fileOffset += totalLength;
                }
            }
        } catch (IOException e) {
            throw new RuntimeException("å è½½æææ¥å¿æ¡ç®å¤±è´¥", e);
        }
        return logEntries;
    }

    /**
     * å¼ºå¶å·çï¼å°æ å°åå­çæ°æ®åæ­¥å°ç£çï¼
     */
    public void forceFlush() {
        if (currentMappedBuffer != null) {
            currentMappedBuffer.force(); // åæ­¥æ å°åå­å°ç£ç
        }
        try {
            fileChannel.force(true); // å¼ºå¶å·çï¼åå«åæ°æ®ï¼
        } catch (IOException e) {
            throw new RuntimeException("å·çå¤±è´¥", e);
        }
    }

    /**
     * å³é­èµæºï¼å¿é¡»è°ç¨ï¼å¦åä¼å¯¼è´æä»¶å¥ææ³æ¼ï¼
     */
    public void close() {
        try {
            forceFlush();
            if (fileChannel != null) {
                fileChannel.close();
            }
            if (raf != null) {
                raf.close();
            }
        } catch (IOException e) {
            throw new RuntimeException("å³é­èµæºå¤±è´¥", e);
        }
    }
    /**
     * åå§å/æ©å®¹åå­æ å°ç¼å²åº
     */
    private void initMappedBuffer() {
        try {
            // è®¡ç®éè¦æ å°çèµ·å§ä½ç½®åå¤§å°
            long fileSize = fileChannel.size();
            // å¦æå½åæ å°æ®µå·²åæ»¡ï¼æé¦æ¬¡åå§åï¼åå»ºæ°çæ å°
            if (currentMappedBuffer == null || writePosition &gt;= currentMappedOffset + MAPPED_SIZE) {
                currentMappedOffset = (writePosition / MAPPED_SIZE) * MAPPED_SIZE;
                // æ å°æä»¶çæå®åºé´å°åå­ï¼FileChannel.MapMode.READ_WRITEï¼è¯»åæ¨¡å¼ï¼
                currentMappedBuffer = fileChannel.map(
                        FileChannel.MapMode.READ_WRITE,
                        currentMappedOffset,
                        MAPPED_SIZE
                );
                // å°ç¼å²åºçpositionå®ä½å°å½ååå¥ä½ç½®ç¸å¯¹äºæ å°æ®µçåç§»
                currentMappedBuffer.position((int) (writePosition - currentMappedOffset));
            }
        } catch (IOException e) {
            throw new RuntimeException("åå§ååå­æ å°ç¼å²åºå¤±è´¥", e);
        }
    }

    /**
     * åå§åFileChannelï¼æ ¸å¿é«æ§è½ééï¼
     */
    private void initFileChannel() {
        try {
            // ä¸å­å¨ååå»ºæä»¶
            if (!logFile.exists()) {
                boolean newFile = logFile.createNewFile();
                if (!newFile) {
                    throw new RuntimeException("åå»ºæä»¶å¤±è´¥");
                }
            }
            this.raf = new RandomAccessFile(logFile, FILE_MODE);
            this.fileChannel = raf.getChannel();
        } catch (IOException e) {
            throw new RuntimeException("åå§åFileChannelå¤±è´¥", e);
        }
    }
}
</code></pre>
<h2 id="22-æå¡ç«¯è®¾è®¡">2.2 æå¡ç«¯è®¾è®¡</h2>
<h3 id="221-æ¶æ¯è®¾è®¡">2.2.1 æ¶æ¯è®¾è®¡</h3>
<p>æ¥å¿è®¾è®¡å¥½äºä¹åï¼æ¥ä¸æ¥çæå¡ç«¯å¦ä½è®¾è®¡ãæä»¬ä½¿ç¨çæ¯nettyæ¡æ¶ï¼è¦æ±ænettyåºç¡ãç¶ååºåååè®®éç¨çæ¯protobufï¼è¯»èå¯ä»¥åèè¿ç¯æç« ï¼<a href="https://mp.weixin.qq.com/s/kg_-AMHRn_DzFbfBnkK4VQ" target="_blank" rel="noopener nofollow">https://mp.weixin.qq.com/s/kg_-AMHRn_DzFbfBnkK4VQ</a> è¿ç¯æç« å¤§è´è®²è§£äºä¸ä¸è¯¥åºåååè®®ï¼å¹¶ä¸ä¹æ¯éç¨nettyæ´åçãæ ¹æ®protoæä»¶çæç±»çå½ä»¤å¦ä¸ï¼ä¹å¯ä»¥ç¨ideaçæä»¶èªå¨çæã</p>
<pre><code class="language-proto">protoc  --proto_path=xxxxç®å½  --java_out=xxxç®å½  å·ä½çprotoæä»¶
</code></pre>
<p>æ¶æ¯æ¨¡æ¿å¦ä¸ï¼</p>
<pre><code class="language-proto">syntax = "proto3";
option java_outer_classname = "KvRaftProto"; // çæçå¤å±ç±»å
option java_multiple_files = false; // çæå¤ä¸ªç¬ç«çJavaç±»ï¼èéåé¨ç±»ï¼

// ===================== 1. éç¨æ¶æ¯å°è£ä½ï¼æ ¸å¿ï¼ =====================
// Nettyä¼ è¾æ¶åªä¼ è¿ä¸ªæ¶æ¯ï¼éè¿typeè¯å«å·ä½æ¶æ¯ç±»å
message RaftKvMessage {
  // æ¶æ¯ç±»åæä¸¾ï¼è¦çææäº¤äºåºæ¯ï¼
  enum MessageType {
    UNKNOWN = 0; // æªç¥ç±»åï¼ååºï¼
    // å®¢æ·ç«¯ â èç¹ï¼KVæä½
    KV_REQUEST = 1;    // å®¢æ·ç«¯åèµ·KVè¯·æ±ï¼PUT/GET/DELETEï¼
    KV_RESPONSE = 2;   // èç¹ååºå®¢æ·ç«¯KVè¯·æ±
    // èç¹ â èç¹ï¼Raftå±è¯
    VOTE_REQUEST = 3;  // éä¸¾è¯·æ±ï¼CandidateâFollowerï¼
    VOTE_RESPONSE = 4; // éä¸¾ååºï¼FollowerâCandidateï¼
    APPEND_ENTRIES_REQUEST = 5;  // æ¥å¿è¿½å /å¿è·³ï¼LeaderâFollowerï¼
    APPEND_ENTRIES_RESPONSE = 6; // æ¥å¿è¿½å ååºï¼FollowerâLeaderï¼
  }

  MessageType type = 1; // æ¶æ¯ç±»åï¼å¿ä¼ ï¼
  string node_id = 2;   // åéæ¹èç¹IDï¼ç¨äºè¯å«èç¹ï¼

  // å·ä½æ¶æ¯ä½ï¼æ ¹æ®typeéæ©å¶ä¸­ä¸ä¸ªï¼
  KvRequest kv_request = 3;
  KvResponse kv_response = 4;
  VoteRequest vote_request = 5;
  VoteResponse vote_response = 6;
  AppendEntriesRequest append_entries_request = 7;
  AppendEntriesResponse append_entries_response = 8;
}

// ===================== 2. å®¢æ·ç«¯KVæä½ç¸å³ =====================
// å®¢æ·ç«¯åèµ·çKVè¯·æ±ï¼PUT/GET/DELETEï¼
message KvRequest {
  enum OpType {
    PUT = 0;    // åå¥/æ´æ°
    GET = 1;    // è¯»å
    DELETE = 2; // å é¤
  }
  OpType op_type = 1; // æä½ç±»åï¼å¿ä¼ ï¼
  string key = 2;     // KVçkeyï¼å¿ä¼ ï¼
  string value = 3;   // KVçvalueï¼ä»PUTæ¶ä¼ ï¼
  // å¯éï¼è¯·æ±IDï¼ç¨äºå¹ç­æ§ï¼é²æ­¢éå¤è¯·æ±ï¼
  string request_id = 4;
}

// èç¹ååºå®¢æ·ç«¯çKVç»æ
message KvResponse {
  bool success = 1;    // æä½æ¯å¦æå
  string message = 2;  // éè¯¯ä¿¡æ¯/æç¤ºï¼å¤±è´¥æ¶å¿ä¼ ï¼
  string value = 3;    // è¿åçvalueï¼ä»GETæåæ¶ä¼ ï¼
  string request_id = 4; // å¯¹åºè¯·æ±çIDï¼å¹ç­æ§ï¼
}

// ===================== 3. Raftéä¸¾ç¸å³ =====================
// CandidateåFolloweråèµ·çæç¥¨è¯·æ±
message VoteRequest {
  int64 term = 1;                // Candidateçå½åä»»æï¼å¿ä¼ ï¼
  string candidate_id = 2;       // Candidateçèç¹IDï¼å¿ä¼ ï¼
  int64 last_log_index = 3;      // Candidateæåä¸æ¡æ¥å¿çç´¢å¼ï¼ç¨äºæ¥å¿ä¸è´æ§æ£æ¥ï¼
  int64 last_log_term = 4;       // Candidateæåä¸æ¡æ¥å¿çä»»æï¼ç¨äºæ¥å¿ä¸è´æ§æ£æ¥ï¼
}

// FollowerååºCandidateçæç¥¨ç»æ
message VoteResponse {
  int64 term = 1;                // Followerçå½åä»»æï¼å¿ä¼ ï¼ç¨äºæ´æ°Candidateçä»»æï¼
  bool vote_granted = 2;         // æ¯å¦æèµæç¥¨ï¼å¿ä¼ ï¼
}

// ===================== 4. Raftæ¥å¿è¿½å /å¿è·³ç¸å³ =====================
// æ¥å¿æ¡ç®ï¼ä¸ä½ è®¾è®¡çæ¥å¿æ ¼å¼å¯¹é½ï¼åºåååå¯ç´æ¥åå¥æ¥å¿æä»¶ï¼
message LogEntry {
  int64 term = 1;        // Raftä»»æï¼å¯¹åºä½ æ¥å¿æ ¼å¼çtermï¼
  int64 index = 2;       // æ¥å¿ç´¢å¼ï¼å¯¹åºä½ æ¥å¿æ ¼å¼çindexï¼
  string command = 3;    // KVæä½å½ä»¤ï¼å¦"PUT key1 value1"ï¼å¯¹åºä½ æ¥å¿æ ¼å¼çcommandï¼
}

// LeaderåFolloweråéçæ¥å¿è¿½å /å¿è·³è¯·æ±
message AppendEntriesRequest {
  int64 term = 1;                // Leaderçå½åä»»æï¼å¿ä¼ ï¼
  string leader_id = 2;          // Leaderçèç¹IDï¼å¿ä¼ ï¼
  int64 prev_log_index = 3;      // åä¸æ¡æ¥å¿çç´¢å¼ï¼ç¨äºæ¥å¿ä¸è´æ§æ£æ¥ï¼
  int64 prev_log_term = 4;       // åä¸æ¡æ¥å¿çä»»æï¼ç¨äºæ¥å¿ä¸è´æ§æ£æ¥ï¼
  repeated LogEntry entries = 5; // å¾è¿½å çæ¥å¿æ¡ç®ï¼å¿è·³æ¶ä¸ºç©ºï¼
  int64 leader_commit = 6;       // Leaderå·²æäº¤çæ¥å¿ç´¢å¼ï¼Followeræ®æ­¤æ´æ°èªå·±çæäº¤ç´¢å¼ï¼
}

// FollowerååºLeaderçæ¥å¿è¿½å ç»æ
message AppendEntriesResponse {
  int64 term = 1;                // Followerçå½åä»»æï¼å¿ä¼ ï¼ç¨äºæ´æ°Leaderçä»»æï¼
  bool success = 2;              // æ¥å¿è¿½å æ¯å¦æåï¼å¿ä¼ ï¼
  int64 match_index = 3;         // Followerå·²å¹éçæ¥å¿ç´¢å¼ï¼Leaderæ®æ­¤æ´æ°nextIndexï¼
}
</code></pre>
<p>ä¸é¢æ¯æ¶æ¯çå¤§è´æ ¼å¼ã</p>
<p>æ¥ä¸æ¥çæå¡ç«¯çèç¹è®¾è®¡ï¼æä»¬ä»nettyæå¡å¯å¨å¼å§å¾ä¸çï¼</p>
<p>å¨kv-coreçappåéé¢</p>
<pre><code class="language-java">public static void main(String[] args) {
    int port = getPort(args);
    RaftNettyServer raftNettyServer = new RaftNettyServer(port);
    try {
        raftNettyServer.start();
    } catch (InterruptedException e) {
        throw new RuntimeException(e);
    }
}

private static int getPort(String[] args) {
    for (String arg : args) {
        if (arg.startsWith("node.port=")) {
            return Integer.parseInt(arg.substring(10));
        }
    }
    return 7777;
}
</code></pre>
<p>ä»javaç¨åºå¯å¨çå½ä»¤è¡è¯»åç»ç¹çç«¯å£åæ°ï¼æä»¬å¯ä»¥ç¨ä¸å°çµèå¼å¯å¤ä¸ªåºç¨ï¼å¨ideaä¸­è¿æ ·éç½®å°±å¯ä»¥äºï¼å¦ä¸å¾æç¤º</p>
<img src="https://img2024.cnblogs.com/blog/2358057/202602/2358057-20260211194613557-847947640.png" style="zoom: 50%">
<p>ä»ä¸å¾ä¸­å¯ä»¥çå°ï¼éç½®äºä¸ä¸ªèç¹ï¼ç¶åæ¬é¡¹ç®çjdkæ¯éç¨ç21è¿ä¸ªçæ¬ãéç½®å¥½äºä¹åï¼å¨ideaçserviceséé¢å¯ä»¥æè¿äºéç½®ä¸èµ·å è¿å»ï¼ç¶åå°±å¯ä»¥åæ¶å¯å¨å¤ä¸ªèç¹äºã</p>
<h3 id="222-è¿æ¥è®¾è®¡">2.2.2 è¿æ¥è®¾è®¡</h3>
<pre><code class="language-java">RaftNettyServer raftNettyServer = new RaftNettyServer(port);
...
raftNettyServer.start();
</code></pre>
<p>ä»ä¸ä¸èçå¯å¨ç±»çåºæ¥ä¸»è¦å°±æ¯newäºä¸ä¸ªserverå¯¹è±¡ï¼ç¶åè°ç¨startæ¹æ³ãæä»¬é¡ºçè¿ä¸¤ä¸ªçå°±å¯ä»¥äºã</p>
<p>é¦åæ¯æé æ¹æ³ï¼</p>
<pre><code class="language-java">public class RaftNettyServer {
  	....
    private final int port;
    private final RaftNode node;

    public RaftNettyServer(int port) {
        this.port = port;
         // è¿éåå»ºäºä¸ä¸ªraftç»ç¹å¯¹è±¡
        this.node = new RaftNode(port);
    }
}

// è¿ä¸ªæ¯RaftNodeç±»ï¼
public RaftNode(int port) {
    this.port = port;

    // ä»éç½®æä»¶ä¸­æ¾å°èªå·±
    this.nodesConfig = new NodesConfig();
    this.nodeId = nodesConfig.findSelf(port);

    // éè¦æèªèº«ç»ç¹
    this.rpcPeers = nodesConfig.getNodeList().stream()
        // nodeçæ ¼å¼æ¯'ip:port'
        .map(node -&gt; new RpcPeer(node, node.split(":")[0],
                                 Integer.parseInt(node.split(":")[1]), this))
        .toList();

    this.logManager = new LogManager();
    this.storage = new MemoryStorage();

    // æä¸¤ä¸ªæ¶é´ååå§åå¯
    this.electionTimeout = 8000 + ThreadLocalRandom.current().nextInt(4000);
    this.lastHeartbeatTime = System.currentTimeMillis();
    log.info("åå§åéä¸¾è¶æ¶ï¼{}", electionTimeout);

    // å®æ¶å¨
    scheduler = Executors.newScheduledThreadPool(2);
    scheduler.scheduleAtFixedRate(this::tick, 2, 2000, TimeUnit.MILLISECONDS);
}
</code></pre>
<p>Raftç±»æ¯ææ ¸å¿çä¸ä¸ªç±»ãä¸é¢çæé æ¹æ³å¶å®å¾ç®åãè¯»èèªè¡çè§£ãéè¦è¯´æä¸ä¸çå°±æ¯nodeIdçæ ¼å¼ï¼ãip:ç«¯å£ã</p>
<pre><code class="language-java">127.0.0.1:8888 // å°±æ¯è¿ç§å­ç¬¦ä¸²çæ ¼å¼
</code></pre>
<p>è¿æè¦è¯´æçå°±æ¯rpcPeersè¿ä¸ªListçæå»ºï¼å¯ä»¥çåºæ¥åæ¯ä»éç½®æä»¶è¯»åå°äºéç¾¤èç¹åè¡¨ï¼ç¶åéåè¿ä¸ªåè¡¨åå»ºäºå¯¹è±¡ï¼è¿ä¸ªå·ä½æ¯ä»ä¹ææå¢ï¼</p>
<p>é¦åçä¸ä¸Nettyçå®¢æ·ç«¯åéè¯·æ±å°æå¡ç«¯ï¼æå¡ç«¯å¤çåå¨è¿åç»å®¢æ·ç«¯ï¼å®¢æ·ç«¯æ ¹æ®ååºç»æè¿è¡é»è¾å¤çãè¿æ ·ä¸ä¸ªç¤ºæå¾ï¼</p>
<img src="https://img2024.cnblogs.com/blog/2358057/202602/2358057-20260211194613912-363189595.png" style="zoom: 50%">
<p>åçä¸ä¸ä¸é¢çè¿æ¥ç¤ºæå¾ï¼</p>
<img src="https://img2024.cnblogs.com/blog/2358057/202602/2358057-20260211194614275-746707923.png" style="zoom: 50%">
<p>NettyClientä¸ä»ä»æ¯ç»å®¢æ·ç¨çï¼éç¾¤ç»ç¹åé¨äºç¸éä¿¡ä¹è¦ç¨å°è¿ä¸ªï¼rpcPeerså°±æ¯éç¾¤èç¹åé¨éä¿¡ä½¿ç¨çãå¦ä¸å¾æç¤ºï¼æ¯ä¸ªèç¹é½æä¸ä¸ªNettyServerå¯å¨å¹¶çå¬çç«¯å£ï¼åæ¶Leaderç»ç¹éè¦ç»ææçFollowerç»ç¹åéå¿è·³è¯·æ±ï¼æ­¤æ¶è¿ä¸ªLeaderç¸å½äºå¶ä»ä¸¤ä¸ªFollowerç»ç¹å°±ç¸å½äºClientäºï¼æä»¥å¨ç»ç¹ä¸éé¢æclientçé¨åï¼å¨é¡¹ç®å½å°äºrpcçåä¸ï¼ä¹å°±æ¯ä¸é¢é£ä¸ªrpcPeersçç±æ¥äºã</p>
<p>å¨éç¾¤å¯å¨çæ¶åï¼é½æ¯Followerç»ç¹ï¼åªæç­å°è¶æ¶äºæä¼å¼å§éä¸»ï¼å¨æ­¤ä¹åï¼æ¯ä¸ªèç¹é½ææä¸ºCandidateçå¯è½ï¼ä¹å°±æ¯è¯´æ¯ä¸ªèç¹é½æåå¶ä»ç»ç¹åéæç¥¨è¯·æ±çå¯è½ï¼VoteRequestï¼ï¼é£ä¹æ¯ä¸ªèç¹éé¢é½è¦æä¸å¥Netty Clientåå¤çæµç¨ãå°±å¦ä¸å¾æç¤ºï¼</p>
<img src="https://img2024.cnblogs.com/blog/2358057/202602/2358057-20260211194614720-1938302844.png" style="zoom: 50%">
<p>è¿æ ·å°±æä¸ä¸ªé®é¢äºï¼ä¸ä¸ªèç¹ï¼æå°±è¦å­ä¸ªtcpè¿æ¥äºï¼åä¸ªèç¹å°±è¦12ä¸ªè¿æ¥ï¼åä¸ªèç¹å¢ï¼å°±è¦90ä¸ªè¿æ¥ï¼è¿ä¹å¤ªå¤äºå§ï¼é£ä¹ç¡®å®æ¯çãæä¸ä¸ªæè·¯æ¯æä¸ä¸ªä¸­é´å±å«årouteCenterï¼ææç»ç¹è¿åå®ï¼ç¶åæ¶æ¯é½ç»è¿è¿ä¸ªè·¯ç±ä¸­å¿æ¥è½¬åï¼è¿æ ·è¿æ¥æ°å°±ä¼å°å¾å¤äºã</p>
<p>è¿æä¸ä¸ªæè·¯ï¼åæ­£NettyClient + ä¸ä¸ªNettyServeræå»ºåºä¸ä¸ªChannelï¼çè®ºä¸æåªéè¦ä¸ä¸ªtcpè¿æ¥å°±å¯ä»¥äºåãå¦ä¸å¾æç¤ºï¼</p>
<img src="https://img2024.cnblogs.com/blog/2358057/202602/2358057-20260211194615069-208910434.png" style="zoom: 50%">
<p>ä½æ¯è¿æ ·çè¯ï¼èç¹é´éä¿¡éè¦è½¬åäºï¼ä»£ç é»è¾å°±å¤ªå¤æäºï¼åµä¸è¿æä¸ä¸ªé®é¢ï¼é£å°±æ¯å¦ä½ç¡®å®è¿ä¸ªtcpçè¿æ¥é¡ºåºå¢ï¼è¿ä¸ªå¯ä»¥æç§nodeIdçå­å¸é¡ºåºæ¥åãåæ­£å°±æ¯éº»ç¦å°±å®äºå¿äºããã</p>
<p>ç»¼ä¸æè¿°ï¼è¿æ¯æå¼å§çæ¹æ¡æç®åç´æ¥äºï¼åæ­£è¿å°±æ¯ä¸ä¸ªç®æçæ¡ä¾ï¼ä¸è¦èèå¤ªå¤äºãå¦ææä¸äºå¶ä»åéçæè·¯ï¼æ¬¢è¿è¯»èç»åºã</p>
<p>èç¹ä¹é´çè¿æ¥è®¾è®¡å°±æ¯ä¸é¢çæ ·å­äºã</p>
<p>æ¥ä¸æ¥çRaftNodeçè®¾è®¡ã</p>
<h3 id="223-raftnodeè®¾è®¡">2.2.3 RaftNodeè®¾è®¡</h3>
<p>é£å°±ä»æé å¨å¼å§çå§ï¼</p>
<pre><code class="language-java">public RaftNode(int port) {
    this.port = port;

    // ä»éç½®æä»¶ä¸­æ¾å°èªå·±
    this.nodesConfig = new NodesConfig();
    this.nodeId = nodesConfig.findSelf(port);

    // éè¦æèªèº«ç»ç¹
    this.rpcPeers = nodesConfig.getNodeList().stream()
        // nodeçæ ¼å¼æ¯'ip:port'
        .map(node -&gt; new RpcPeer(node, node.split(":")[0],
                                 Integer.parseInt(node.split(":")[1]), this))
        .toList();

    this.logManager = new LogManager();
    this.storage = new MemoryStorage();

    // æä¸¤ä¸ªæ¶é´ååå§åå¯
    this.electionTimeout = 8000 + ThreadLocalRandom.current().nextInt(4000);
    this.lastHeartbeatTime = System.currentTimeMillis();
    log.info("åå§åéä¸¾è¶æ¶ï¼{}", electionTimeout);

    // å®æ¶å¨
    scheduler = Executors.newScheduledThreadPool(2);
    scheduler.scheduleAtFixedRate(this::tick, 2, 2000, TimeUnit.MILLISECONDS);
}
</code></pre>
<p>å¯ä»¥çå°é½æ¯åä¸äºåå§åçå·¥ä½ï¼ç¶åä¸é¢æ¯å¼å¯äºä¸ä¸ªå®æ¶ä»»å¡tick</p>
<pre><code class="language-java">private void tick() {
    log.info("æ£æ¥æ¯å¦è¶æ¶ï¼{} ç¶æ: {}", nodeId, state);
    try {
        if (state != NodeState.LEADER &amp;&amp; isTimeout()) {
            becomeCandidate();
        } else if (state == NodeState.LEADER) {
            // sendHeartbeats();
        }
    } catch ( Exception e ) {
        log.error("{} èç¹tickå®æ¶ä»»å¡å¼å¸¸", nodeId, e);
    }
}
private void becomeCandidate() {
    log.info("{} éä¸¾è¶æ¶ï¼è½¬ä¸º Candidateï¼å¼å§ä»»æ: {}", nodeId, currentTerm.get() + 1);
    state = NodeState.CANDIDATE;
    currentTerm.getAndIncrement(); // ä»»æ+1
    votedFor = nodeId; // ç»èªå·±æä¸ç¥¨
    resetElectionTimeout();
    // éç¾¤åéæç¥¨è¯·æ±
    requestVotes();
}
 private boolean isTimeout() {
     return System.currentTimeMillis() - lastHeartbeatTime &gt; electionTimeout;
 }
private void resetElectionTimeout() {
    // 8000ms ~ 12000ms éæºè¶æ¶ï¼é¿åå¹³ç¥¨
    this.electionTimeout = 8000 + ThreadLocalRandom.current().nextInt(4000);
    log.info("éç½® {} èç¹éä¸¾æ¶é´ï¼éæºè¶æ¶ï¼{} ms", nodeId, electionTimeout);
    this.lastHeartbeatTime = System.currentTimeMillis();
}
</code></pre>
<p>ä¸»è¦å°±æ¯çbecomeCandidateè¿ä¸ªæ¹æ³æåçåéç¾¤åéæç¥¨è¯·æ±ã</p>
<pre><code class="language-java">private void requestVotes() {
    // 1. åå§åç¥¨æ°ï¼èªå·±çä¸ç¥¨
    AtomicInteger grantedVotes = new AtomicInteger(1);
    long count = rpcPeers.stream().filter(peer -&gt; !peer.isSelf()).count(); // ä¸åå«èªå·±çç»ç¹æ°
    int majority = (int) ((count + 1) / 2 + 1); // æ»èç¹æ°(åå«èªå·±)çåæ°ä»¥ä¸

    // 2.æé æç¥¨æ¶æ¯
    KvRaftProto.VoteRequest voteRequest = KvRaftProto.VoteRequest.newBuilder()
        .setTerm(currentTerm.get())
        .setCandidateId(nodeId)
        .setLastLogIndex(logManager.getLastLogIndex())
        .setLastLogTerm(logManager.getLastLogTerm())
        .build();
    // 3. åéæç¥¨è¯·æ±
    // æå»ºä¸ä¸ªå¯¹è±¡ï¼è¡¨ç¤ºå½åæç¥¨è¯·æ±çç¶æ
    // String voteId = UUID.randomUUID().toString().replaceAll("-", "");
    // è¿éä¸ºä»ä¹å¯ä»¥ç¨termï¼å ä¸º Raft è§å®ï¼ä¸ä¸ªèç¹å¨ä¸ä¸ª term ååªè½æä¸å¼ ç¥¨ã
    // æä»¥ï¼åªè¦ term å¹éï¼è¿ä¸ªååºå°±ä¸å®æ¯éå¯¹ä½ å½ååèµ·çè¿ä¸è½®éä¸¾çã
    GlobalVoteManager.setVoteState(currentTerm.get(), new VoteState(nodeId, currentTerm.get(), majority));

    int countSend = 0;
    for (RpcPeer peer : rpcPeers) {
        if (!peer.isSelf()) { // ä¸æ¯èªèº«ç»ç¹ï¼å°±åéæç¥¨è¯·æ±
            // sendæ¹æ³å°±å¾ç®åäºï¼è¯·è¯»èèªè¡æ¥ç
            boolean send = peer.send(KvRaftProto.RaftKvMessage.newBuilder()
                                     .setType(KvRaftProto.RaftKvMessage.MessageType.VOTE_REQUEST)
                                     .setVoteRequest(voteRequest)
                                     .build());
            if ( send ) countSend++;
        }
    }
    log.info("åéæç¥¨è¯·æ±ï¼{}ï¼å·²åéç»äº {} ä¸ªç»ç¹..", voteRequest, countSend);
}
</code></pre>
<p>è¿æ ·æç¥¨è¯·æ±å°±åéåºå»äºï¼æ­¤æ¶ç»ç¹æ¯ä½ä¸ºå®¢æ·ç«¯åéç»å¶ä»èç¹çï¼æ¥ä¸æ¥çé»è¾å°±æ¯å¶ä»èç¹æ¥æ¶å°voteRequestè¯·æ±ç¶ååé»è¾å¤çï¼æä»¥å°±è¦å¨serveråä¸é¢å»æ¥çå·ä½é»è¾ã</p>
<pre><code class="language-java">// å¨kv-coreçserveråä¸é¢çKvBusinessHandler.java
// 1.å¦ææ¯æç¥¨è¯·æ±
if ( raftKvMessage.getType() == KvRaftProto.RaftKvMessage.MessageType.VOTE_REQUEST) {
    log.info("receive vote request.........");
    KvRaftProto.VoteRequest voteRequest = raftKvMessage.getVoteRequest();
    // å¯ä»¥çå°äº¤ç»äºnodeå»å¤ç
    KvRaftProto.VoteResponse voteResponse = node.tackleVoteRequest(voteRequest);
    ctx.writeAndFlush(KvRaftProto.RaftKvMessage.newBuilder()
                      .setType(KvRaftProto.RaftKvMessage.MessageType.VOTE_RESPONSE)
                      .setVoteResponse(voteResponse)
                      .build());
}

// ååå°äºRaftNodeç±»äº
public KvRaftProto.VoteResponse tackleVoteRequest(KvRaftProto.VoteRequest voteRequest) {
    // æ¯è¾ä»»æ
    if (voteRequest.getTerm() &lt; currentTerm.get()) {
        log.info("{} æç¥¨è¯·æ±ä»»æå¤ªå°ï¼æç»æç¥¨", nodeId);
        return buildVoteResponse(false, currentTerm.get());
    }
    if ( votedFor != null &amp;&amp; !voteRequest.getCandidateId().equals(votedFor) ) {
        log.info("{}å·²æç»å¶ä»äººï¼æç»è¯¥æç¥¨è¯·æ±", nodeId);
        return buildVoteResponse(false, currentTerm.get());
    }
    // åæ¯è¾æ¥å¿æåµ
    if ( voteRequest.getLastLogIndex() &gt;= logManager.getLastLogIndex() &amp;&amp;
        voteRequest.getLastLogTerm() &gt;= logManager.getLastLogTerm() ) {
        log.info("{} æç¥¨è¯·æ±okï¼èµææç¥¨", nodeId);
        currentTerm.set(voteRequest.getTerm()); // æ´æ°èªå·±çä»»æ
        votedFor = voteRequest.getCandidateId(); // æç¥¨ç»è¯¥èç¹
        return buildVoteResponse(true, voteRequest.getTerm());
    }
    log.info("{} æç¥¨è¯·æ±æ¥å¿å¤ªæ§ï¼æç»è¯¥æç¥¨è¯·æ±", nodeId);
    return buildVoteResponse(false, currentTerm.get());
}
</code></pre>
<p>å¶ä»èç¹æ¶å°äºæç¥¨è¯·æ±ï¼ä¼è¿åresponseç»candidateç»ç¹ï¼candidateç»ç¹æ¯ä½ä¸ºClientåéçæç¥¨è¯·æ±ï¼æ¶å°çååºè¯å®æ¯å¨å®¢æ·ç«¯çå¤çå¨handlerï¼æ¥ä¸æ¥çé»è¾å°±è¦å¨rpcåä¸é¢çRpcClientHandlerå»æ¥çäºï¼</p>
<pre><code class="language-java">@Override
protected void channelRead0(ChannelHandlerContext ctx, KvRaftProto.RaftKvMessage msg) {
    // 2.VOTE_RESPONSE æç¥¨è¯·æ±åæ¥çååºãæç¥¨è¯·æ±æ¯ç»ç¹ä½ä¸ºå®¢æ·ç«¯ååºçï¼åºè¯¥å¨å®¢æ·ç«¯çhandlerå¤çååºã
    if (msg.getType() == KvRaftProto.RaftKvMessage.MessageType.VOTE_RESPONSE) {
        log.info("receive vote response.........");
        KvRaftProto.VoteResponse voteResponse = msg.getVoteResponse();
        raftNode.tackleVoteResponse(voteResponse); // ååå°äºRaftNode
    }
}

// RaftNode.java
// æç¥¨ç»æå¤ç,ãæç¥¨è¯·æ±æ¯ç»ç¹ä½ä¸ºå®¢æ·ç«¯ååºçï¼è¦å¨å®¢æ·ç«¯çhandlerå¤çååºã
public synchronized void tackleVoteResponse(KvRaftProto.VoteResponse voteResponse) {
    long term = voteResponse.getTerm();
    // 2. åç°æ´é«ä»»æï¼ç«å³éçº§å¹¶æ´æ°
    // 1. ä»»ææ£æ¥ï¼å¯¹æ¹æ¯æå¤§ï¼æç«å³è®¤è¾
    if (term &gt; currentTerm.get()) {
        stepDown(term);
        return;
    }
    // 2. ç¶ææ£æ¥ï¼å¦ææå·²ç»ä¸æ¯ Candidate äºï¼æ¯å¦å·²ç»è¶æ¶ééææ¶å°å¿è·³ï¼ï¼å¿½ç¥
    if (state != NodeState.CANDIDATE) return;

    // 3. ä»»æå¹éæ£æ¥ï¼ç¡®ä¿è¿æ¯å¯¹âå½åè¿ä¸è½®âéä¸¾çåå¤
    // å¦ææ¶å°çååºä»»ææ¯å½åå°ï¼è¯´ææ¯ä¹åè¿æçéä¸¾åå¤ï¼ç´æ¥ä¸¢å¼
    if (term &lt; currentTerm.get()) {
        return;
    }

    // 4. ä»å¨å±ç®¡çå¨è·åå½åéä¸¾çæç¥¨ç¶æ
    VoteState voteState = GlobalVoteManager.getVoteState(term);
    if (voteState == null) {
        log.error("æªæ¾å°ä»»æ {} çæç¥¨è®°å½ç¶æ", term);
        return;
    }

    // 5. å¦æå¯¹æ¹æäºèµæç¥¨
    if (voteResponse.getVoteGranted()) {
        // å¢å ç¥¨æ°ï¼è¿é AtomicInteger å¨ VoteState åé¨ä¿è¯äºçº¿ç¨å®å¨ï¼
        // ä½ç±äºæ¬æ¹æ³å äº synchronizedï¼å¶å®åéä¿é©ï¼
        int currentVotes = voteState.addVote();
        int majority = voteState.getMajority();
        log.info("èµæç¥¨ï¼å½åç¥¨æ°: {}/{}", currentVotes, nodesConfig.getNodeList().size());

        // 6. æ£æ¥æ¯å¦è¾¾å°å¤æ°æ´¾
        if (currentVotes &gt;= majority) {
            log.info("èç¹ {} è·å¾è¿åéç¥¨ ({})ï¼åå¤æåä¸º Leader", nodeId, currentVotes);
            becomeLeader();
        }
    } else {
        log.info("æç»äºæçæç¥¨è¯·æ±");
    }
}
private synchronized void becomeLeader() {
    if (state != NodeState.CANDIDATE) return;
    if (state == NodeState.LEADER) return;

    this.state = NodeState.LEADER;
    log.info("Node {} èµ¢å¾éä¸¾ï¼å³å°æä¸º Leader, Term: {}", nodeId, currentTerm.get());
    // 1. æ¸çä¸ä¸ä»»æçæ®çç¶æ
    this.votedFor = null;

    // 2. ç«å³åéç¬¬ä¸æ³¢å¿è·³ï¼å®£ç¤ºä¸»æ (é²æ­¢å¶ä»èç¹åè¶æ¶)
    sendHeartbeats();

    // 3. å¯å¨å®æ¶å¿è·³ä»»å¡ (æ¯å¦æ¯ 2 ç§ä¸æ¬¡)
    if (heartbeatTask != null) heartbeatTask.cancel(true);
    heartbeatTask = scheduler.scheduleAtFixedRate(this::sendHeartbeats,
                                                  0, 1000, TimeUnit.MILLISECONDS);
    log.info("&lt;&lt;&lt;&lt;&lt; èç¹ {} æ­£å¼æä¸º Term {} ç Leader &gt;&gt;&gt;&gt;&gt;", nodeId, currentTerm.get());
}
</code></pre>
<h1 id="3å¯å¨æµè¯éä¸»">3.å¯å¨æµè¯éä¸»</h1>
<p>æéç½®å¥½çä¸ä¸ªèç¹å¯å¨ä¸ä¸ççç»æ</p>
<p><img src="https://img2024.cnblogs.com/blog/2358057/202602/2358057-20260211194611564-1443963355.png" alt="" loading="lazy"></p>
<hr>
<p><img src="https://img2024.cnblogs.com/blog/2358057/202602/2358057-20260211194612379-843476723.png" alt="" loading="lazy"></p>
<hr>
<p><img src="https://img2024.cnblogs.com/blog/2358057/202602/2358057-20260211194612841-1185877353.png" alt="" loading="lazy"></p>
<p>ä»ä¸å¾å¯ä»¥çåºï¼ç«¯å£9999æä¸ºäºLeaderç»ç¹ï¼ç¶ååå¶ä»èç¹åéå¿è·³æ°æ®äºã</p>
<p>æ¥ä¸æ¥å°±æ¯å®åä¸ä¸æ¥å¿ååé£äºé»è¾äºã</p>
<h1 id="end-åè">end. åè</h1>
<ol>
<li><a href="http://thinkinjava.cn/2019/01/12/2019/2019-01-12-lu-raft-kv/#%E4%BB%80%E4%B9%88%E6%98%AF-Java-%E7%89%88-Raft-%E5%88%86%E5%B8%83%E5%BC%8F-KV-%E5%AD%98%E5%82%A8" target="_blank" rel="noopener nofollow">http://thinkinjava.cn/2019/01/12/2019/2019-01-12-lu-raft-kv/#ä»ä¹æ¯-Java-ç-Raft-åå¸å¼-KV-å­å¨</a></li>
<li><a href="https://github.com/stateIs0/lu-raft-kv" target="_blank" rel="noopener nofollow">https://github.com/stateIs0/lu-raft-kv</a></li>
</ol>


</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-02-11 19:47">2026-02-11 19:47</span>&nbsp;
<a href="https://www.cnblogs.com/jackjavacpp">å«æ¥æ æâ²</a>&nbsp;
éè¯»(<span id="post_view_count">20</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19605754);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19605754', targetLink: 'https://www.cnblogs.com/jackjavacpp/p/19605754', title: 'ç®æçåå¸å¼kvè®¾è®¡' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
        </channel>
        </rss>