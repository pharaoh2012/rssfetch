<?xml version="1.0" encoding="UTF-8" ?>
    <rss version="2.0">
    <channel>
        <title><![CDATA[ ä¸»é¡µ - åå®¢å­ ]]></title>
        <link><![CDATA[ https://www.cnblogs.com/ ]]></link>
        <lastBuildDate>2025-12-29T12:35:18.918Z</lastBuildDate>
        <description><![CDATA[
        ä¸»é¡µ - åå®¢å­ RSS
    ]]></description>
        <language>zh-cn</language>
        <item>
    <title><![CDATA[ docker-compose é¨ç½²åèç¹ kafka 4.0 æµè¯ç¯å¢ ]]></title>
    <link>https://www.cnblogs.com/apocelipes/p/19417908</link>
    <guid>75d9efcc5077d799d7d37cace482aade</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/apocelipes/p/19417908" title="åå¸äº 2025-12-29 20:33">
    <span role="heading" aria-level="2">docker-compose é¨ç½²åèç¹ kafka 4.0 æµè¯ç¯å¢</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<p>é«çæ¬kafkaå·²ç»ä¸åéè¦ZooKeeperå½ä¿å§æè½å¯å¨äºï¼ç°å¨é¨ç½²ä¸ä¸ªåæºåèç¹æµè¯ç¯å¢æ¯åæ¥æ¹ä¾¿ä¸å°ã</p>
<p>ä¸è¿æå¸¸ç¨ç<code>bitnami/kafka</code>ä¸åæä¾åè´¹éåï¼å¯¼è´æä»¬åªè½ç¨<code>apache/kafka</code>ï¼æ°éåçéç½®ä¼ç¨å¾®éº»ç¦ä¸äºï¼æä»¥è®°å½ä¸ä¸ã</p>
<p>é¨ç½²åå®¹ï¼</p>
<ul>
<li>åèç¹kafkaæå¡ï¼çæ¬4.0+</li>
<li>kafka UIï¼æ¹ä¾¿ç®¡çï¼çæ¬ç¨ææ°ç</li>
<li>å¼å¯ç®åçç¨æ·åå¯ç éªè¯</li>
</ul>
<p>docker-composeæä»¶ï¼</p>
<pre><code class="language-yaml">version: '3'

networks:
  kafka-net:

services:
  kafka:
    image: apache/kafka:latest
    container_name: kafka
    networks:
      - kafka-net
    ports:
      - "9092:9092"
    volumes:
      - ./kafka_data:/var/lib/kafka/data
      - ./kafka_server_jaas.conf:/etc/kafka/kafka_server_jaas.conf # éç½®ç¨æ·åå¯ç 
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: 'broker,controller'
      KAFKA_CONTROLLER_QUORUM_VOTERS: '1@localhost:9093'
      KAFKA_CONTROLLER_LISTENER_NAMES: 'CONTROLLER'
      
      # å®ä¹çå¬å¨ï¼EXTERNAL(9092) èµ° SASL è®¤è¯ï¼PLAINTEXT(29092) ç»å®¹å¨åç¨ï¼è¿éä¹æ¹ä¸º SASL ç¡®ä¿å®å¨ï¼
      KAFKA_LISTENERS: 'SASL_PLAINTEXT://0.0.0.0:29092,EXTERNAL://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093'
      KAFKA_ADVERTISED_LISTENERS: 'SASL_PLAINTEXT://kafka:29092,EXTERNAL://localhost:9092'
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: 'CONTROLLER:PLAINTEXT,SASL_PLAINTEXT:SASL_PLAINTEXT,EXTERNAL:SASL_PLAINTEXT'
      KAFKA_INTER_BROKER_LISTENER_NAME: 'SASL_PLAINTEXT'
      
      # SASL/PLAIN è®¤è¯éç½®
      KAFKA_SASL_ENABLED_MECHANISMS: 'PLAIN'
      KAFKA_SASL_MECHANISM_INTER_BROKER_PROTOCOL: 'PLAIN'
      # åè¯ Kafka è¯»åæä»¬ç JAAS æä»¶
      KAFKA_OPTS: "-Djava.security.auth.login.config=/etc/kafka/kafka_server_jaas.conf"

      # æ°æ®æä¹å
      KAFKA_LOG_DIRS: '/var/lib/kafka/data'

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: kafka-ui
    depends_on:
      - kafka
    networks:
      - kafka-net
    ports:
      # æ å°å°8090ï¼å ä¸º8080ä¸è¬è¿å¾æå¶ä»çæå¡åæµè¯
      - "8090:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: local
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:29092
      # éç½® UI ä½¿ç¨ç¨æ·ååå¯ç è¿æ¥ Kafka
      KAFKA_CLUSTERS_0_PROPERTIES_SECURITY_PROTOCOL: SASL_PLAINTEXT
      KAFKA_CLUSTERS_0_PROPERTIES_SASL_MECHANISM: PLAIN
      KAFKA_CLUSTERS_0_PROPERTIES_SASL_JAAS_CONFIG: 'org.apache.kafka.common.security.plain.PlainLoginModule required username="ä½ éç½®çç¨æ·å" password="ä½ éç½®çå¯ç ";'
</code></pre>
<p>éç½®æä»¶éè¾å¥ç¨æ·åå¯ç ï¼</p>
<pre><code class="language-conf">KafkaServer {
    org.apache.kafka.common.security.plain.PlainLoginModule required
    username="èç¹å¨éç¾¤åéä¿¡æ¶çç¨æ·å"
    password="èç¹å¨éç¾¤åéä¿¡æ¶çå¯ç "
    # ä¸é¢è¿äºææ¯ç¨æ·éç½®
    # æ ¼å¼user_&lt;ç¨æ·å&gt;="å¯ç "
    user_apot="ä½ éç½®çå¯ç ";
};
</code></pre>
<p>åå»ºå¥½æä»¶åç®å½ä¹åç¨<code>docker-compose up -d</code>å°±è½å¯å¨æå¡äºãè®¿é®<code>localhost:8090</code>å¯ä»¥çå°kafkaçwebæ§å¶é¢æ¿ï¼</p>
<p><img src="https://img2024.cnblogs.com/blog/1434464/202512/1434464-20251229202723957-374430349.png" alt="image" loading="lazy"></p>
<p>å®è£å¥½ä¹åå¯ä»¥ç¨ä¸é¢çå½ä»¤æ¥ççæ¬ï¼</p>
<pre><code class="language-console">$ docker exec -it kafka /opt/kafka/bin/kafka-server-start.sh --version

[2025-12-29 11:08:34,595] INFO Registered kafka:type=kafka.Log4jController MBean (kafka.utils.Log4jControllerRegistration$)
4.0.0
</code></pre>
<p>å¯ä»¥çå°å·²ç»éç½®å¥½äºkafka 4.0ç¯å¢ã</p>
<p><code>apache/kafka</code>çéåéåç½®äºåç§æä½kafkaçèæ¬ï¼ä¸è¿è¿äºèæ¬æ²¡è¢«æ·»å è¿<code>$PATH</code>ï¼æ§è¡çæ¶åéè¦æå®è·¯å¾ï¼</p>
<pre><code class="language-bash"># åéç½®ç»å½éªè¯ä¿¡æ¯
docker exec -it kafka bash -c "cat &lt;&lt;EOF &gt; /tmp/client.conf
security.protocol=SASL_PLAINTEXT
sasl.mechanism=PLAIN
sasl.jaas.config=org.apache.kafka.common.security.plain.PlainLoginModule required \
  username='å®¢æ·ç«¯ç»å½ç¨æ·åï¼å°±æ¯æä»¬ä¹åç¨user_xxxéç½®çé£äº' \
  password='å®¢æ·ç«¯ç»å½å¯ç ';
EOF"

# è°ç¨èæ¬åå»ºä¸ä¸ªtopicï¼éè¦æå®èæ¬è·¯å¾
docker exec -it kafka /opt/kafka/bin/kafka-topics.sh --command-config /tmp/client.conf \
  --bootstrap-server localhost:9092 \
  --create \
  --topic test.data \
  --partitions 1 \
  --replication-factor 1 \
  --config cleanup.policy=delete \
  --config retention.ms=86400000
</code></pre>
<p>ææèæ¬é½å­æ¾å¨<code>/opt/kafka/bin</code>è·¯å¾ä¸ï¼è°ç¨åè¿éè¦æä¾ç»å½å­è¯ä¿¡æ¯ï¼è¿äºéè¦æ³¨æãæå¼<code>localhost:8090</code>ä¸çweb UIï¼å°±è½æ¾å°æä»¬åååå»ºçtopicäºï¼</p>
<p><img src="https://img2024.cnblogs.com/blog/1434464/202512/1434464-20251229202843717-1676041370.png" alt="image" loading="lazy"></p>
<p>ååºåè¿ææ¶é´ä¹å·²ç»è¢«æ­£ç¡®è®¾ç½®ï¼</p>
<p><img src="https://img2024.cnblogs.com/blog/1434464/202512/1434464-20251229203013465-1213915024.png" alt="image" loading="lazy"></p>
<p>æ»ä½èè¨æ§è¡èæ¬è¿æ¯æäºç¹çï¼ææ´æ¿æéè¿ä»£ç æèwebçé¢æ¥åè¿äºæä½ã</p>
<p>æåæä»¬åä¸ä¸ªgoçæµè¯ä»£ç ï¼åæä»¬çæµè¯ç¨åèç¹kafkaéåå¥ä¸äºæ°æ®ï¼</p>
<pre><code class="language-golang">package main

import (
	"context"
	"math/rand/v2"
	"strconv"
	"time"

	"github.com/segmentio/kafka-go"
	"github.com/segmentio/kafka-go/sasl/plain"
)

const (
	topic         = "lean.data1"
	kafkaEndpoint = "localhost:9092"
)

func main() {
	mechanism := plain.Mechanism{
		Username: "å®¢æ·ç«¯ç»å½ç¨æ·å",
		Password: "å®¢æ·ç«¯ç»å½å¯ç ",
	}

	dialer := &amp;kafka.Dialer{
		Timeout:       10 * time.Second,
		DualStack:     true,
		SASLMechanism: mechanism,
	}

	w := kafka.NewWriter(kafka.WriterConfig{
		Brokers: []string{kafkaEndpoint},
		Dialer:  dialer, // å¿é¡»ä¼ å¥å¸¦ SASL ç dialer
		Async:   false,
	})
	defer w.Close()

	msg := kafka.Message{
		Topic: topic,
		Key:   []byte("test"),
		Value: []byte(strconv.Itoa(rand.Int())), // éä¾¿åå¥ä¸äºéæºæ°æ®
	}

	ctx, cancel := context.WithTimeout(context.Background(), 10*time.Second)
	defer cancel()

	err := w.WriteMessages(ctx, msg)
	if err != nil {
		panic(err)
	}
}
</code></pre>
<p><img src="https://img2024.cnblogs.com/blog/1434464/202512/1434464-20251229202601662-326565622.png" alt="image" loading="lazy"></p>
<p>å¯ä»¥çå°æä»¬çéæºæ°å·²ç»æ­£å¸¸åå¥topicäºã</p>
<p>æ³¨æï¼è¿ä¸ªéç½®åªä½¿ç¨äºæåºæ¬çéªè¯ï¼ä¸æ¯åèç¹ï¼ä¸éåå¨æµè¯åå­¦ä¹ ä¹å¤çä»»ä½ç¨éä½¿ç¨ï¼ä¸ºäºå®å¨æä¹å»ºè®®å¨æµè¯å®æä¹åå°±ç«å»ç¨<code>docker-compose down</code>å³é­æå¡ã</p>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2025-12-29 20:34">2025-12-29 20:33</span>&nbsp;
<a href="https://www.cnblogs.com/apocelipes">apocelipes</a>&nbsp;
éè¯»(<span id="post_view_count">0</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19417908);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19417908', targetLink: 'https://www.cnblogs.com/apocelipes/p/19417908', title: 'docker-compose é¨ç½²åèç¹ kafka 4.0 æµè¯ç¯å¢' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ ãå¤§æ°æ® & AIãFlink Agents æºç è§£è¯» --- (2) ---  æ ¸å¿æ¶æ ]]></title>
    <link>https://www.cnblogs.com/rossiXYZ/p/19369781</link>
    <guid>3e73e9ef6d384f88f508205efca71659</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/rossiXYZ/p/19369781" title="åå¸äº 2025-12-29 20:24">
    <span role="heading" aria-level="2">ãå¤§æ°æ® &amp; AIãFlink Agents æºç è§£è¯» --- (2) ---  æ ¸å¿æ¶æ</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h1 id="å¤§æ°æ®--aiflink-agents-æºç è§£è¯»-----2------æ ¸å¿æ¶æ">ãå¤§æ°æ® &amp; AIãFlink Agents æºç è§£è¯» --- (2) ---  æ ¸å¿æ¶æ</h1>
<p></p><div class="toc"><div class="toc-container-header">ç®å½</div><ul><li><a href="#å¤§æ°æ®--aiflink-agents-æºç è§£è¯»-----2------æ ¸å¿æ¶æ" rel="noopener nofollow">ãå¤§æ°æ® &amp; AIãFlink Agents æºç è§£è¯» --- (2) ---  æ ¸å¿æ¶æ</a><ul><li><a href="#0x00-æè¦" rel="noopener nofollow">0x00 æè¦</a></li><li><a href="#0x01-flink-agentsä¸»è¦ç»ä»¶" rel="noopener nofollow">0x01 Flink Agentsä¸»è¦ç»ä»¶</a><ul><li><a href="#11-ä¸»è¦ç»ä»¶" rel="noopener nofollow">1.1 ä¸»è¦ç»ä»¶</a></li><li><a href="#12-åé¨æååéæ å°å³ç³»" rel="noopener nofollow">1.2 åé¨æååéæ å°å³ç³»</a><ul><li><a href="#121-agent-å°-agentplan" rel="noopener nofollow">1.2.1 Agent å° AgentPlan</a></li><li><a href="#122-agentplan-å°-actionexecutionoperator" rel="noopener nofollow">1.2.2 AgentPlan å° ActionExecutionOperator</a><ul><li><a href="#è¯¦ç»æ å°åæ" rel="noopener nofollow">è¯¦ç»æ å°åæ</a><ul><li><a href="#å¨ä½æ§è¡æ å°" rel="noopener nofollow">å¨ä½æ§è¡æ å°</a></li><li><a href="#èµæºç®¡çæ å°" rel="noopener nofollow">èµæºç®¡çæ å°</a></li><li><a href="#éç½®æ å°" rel="noopener nofollow">éç½®æ å°</a></li><li><a href="#ç¶æç®¡çæ å°" rel="noopener nofollow">ç¶æç®¡çæ å°</a></li></ul></li></ul></li></ul></li><li><a href="#13-æ§è¡æµç¨" rel="noopener nofollow">1.3 æ§è¡æµç¨</a></li></ul></li><li><a href="#0x02-ä¸åçflinkæ¯å¯¹" rel="noopener nofollow">0x02 ä¸åçFlinkæ¯å¯¹</a><ul><li><a href="#21-æ ¸å¿" rel="noopener nofollow">2.1 æ ¸å¿</a></li><li><a href="#22-å·ä½æ¯å¯¹" rel="noopener nofollow">2.2 å·ä½æ¯å¯¹</a><ul><li><a href="#221-agent" rel="noopener nofollow">2.2.1 Agent</a></li><li><a href="#222-agentplan" rel="noopener nofollow">2.2.2 AgentPlan</a></li><li><a href="#223-actionexecutionoperator" rel="noopener nofollow">2.2.3 ActionExecutionOperator</a></li><li><a href="#223-actiontask" rel="noopener nofollow">2.2.3 ActionTask</a></li></ul></li></ul></li><li><a href="#0x03-å®ä¾æè§£" rel="noopener nofollow">0x03 å®ä¾æè§£</a><ul><li><a href="#31-ç¬¬ä¸å±çº§agent--é¤åèååè§åæåblueprint" rel="noopener nofollow">3.1 ç¬¬ä¸å±çº§ï¼Agent â é¤åèååè§åæåï¼Blueprintï¼</a></li><li><a href="#32-ç¬¬äºå±çº§agentplan--é¤åçè¯¦ç»æä½æµç¨å¾compiled-planè®¡åç¼è¯å±" rel="noopener nofollow">3.2 ç¬¬äºå±çº§ï¼AgentPlan â é¤åçè¯¦ç»æä½æµç¨å¾ï¼Compiled Plan,è®¡åç¼è¯å±ï¼</a><ul><li><a href="#ç»æåè§£æ" rel="noopener nofollow">ç»æåè§£æ</a></li><li><a href="#å¹³å°ééæ§" rel="noopener nofollow">å¹³å°ééæ§</a></li></ul></li><li><a href="#33-ç¬¬ä¸å±çº§actionexecutionoperator--é¤åçæ§è¡ç®¡çå±runtime-executoræ§è¡å¼æå±" rel="noopener nofollow">3.3 ç¬¬ä¸å±çº§ï¼ActionExecutionOperator â é¤åçæ§è¡ç®¡çå±ï¼Runtime Executorï¼æ§è¡å¼æå±ï¼</a></li><li><a href="#34-ç¬¬åå±çº§actiontask--å·ä½çæå¡æ­¥éª¤execution-unit" rel="noopener nofollow">3.4 ç¬¬åå±çº§ï¼ActionTask â å·ä½çæå¡æ­¥éª¤ï¼Execution Unitï¼</a></li><li><a href="#35-å·¥ä½æµç¨ä¸¾ä¾" rel="noopener nofollow">3.5 å·¥ä½æµç¨ä¸¾ä¾</a></li></ul></li><li><a href="#0x04-å¹¶åæ§åå¹¶è¡æ§" rel="noopener nofollow">0x04 å¹¶åæ§åå¹¶è¡æ§</a><ul><li><a href="#41-flinkåçå¹¶åæ¨¡å" rel="noopener nofollow">4.1 Flinkåçå¹¶åæ¨¡å</a></li><li><a href="#42-æ¯ä¸ªkeyçç¶æç®¡ç" rel="noopener nofollow">4.2 æ¯ä¸ªKeyçç¶æç®¡ç</a></li><li><a href="#43-é®ç®±çº¿ç¨æ¨¡å" rel="noopener nofollow">4.3 é®ç®±çº¿ç¨æ¨¡å</a></li><li><a href="#44-å¼æ­¥ä»»å¡å¤ç" rel="noopener nofollow">4.4 å¼æ­¥ä»»å¡å¤ç</a></li><li><a href="#45-åå­ä¸è´æ§" rel="noopener nofollow">4.5 åå­ä¸è´æ§</a></li><li><a href="#46-æ°´å°åäºä»¶æ¶é´å¤ç" rel="noopener nofollow">4.6 æ°´å°åäºä»¶æ¶é´å¤ç</a></li><li><a href="#47-æ£æ¥ç¹åæ¢å¤" rel="noopener nofollow">4.7 æ£æ¥ç¹åæ¢å¤</a></li><li><a href="#48-æ»ç»" rel="noopener nofollow">4.8 æ»ç»</a></li></ul></li><li><a href="#0xff-åè" rel="noopener nofollow">0xFF åè</a></li></ul></li></ul></div><p></p>
<h2 id="0x00-æè¦">0x00 æè¦</h2>
<p>Flink Agents æ¡æ¶çæ ¸å¿æ¯ <strong>âäºä»¶é©±å¨ + ç¶æéç¦» + å¤è¯­è¨åä½â</strong>ï¼éè¿ Agent/AgentPlan å®ç°ä¸å¡é»è¾çå£°æå¼å®ä¹ï¼åå© Flink åççåå¸å¼ãé«å¹¶åè½åå®ç°å¯é æ§è¡ï¼åæ¶æ¯æ Python çæçå·¥å· / æ¨¡åéæï¼å¼é¡¾äºå¼åçµæ´»æ§ä¸è¿è¡æ¶æçï¼éç¨äºå¤æ AI ä»£çä»»å¡çåå¸å¼é¨ç½²ä¸æ§è¡ã</p>
<p>å·ä½èè¨ï¼Flink Agents çç»ä»¶æ¯å¯¹åç Flink ç»ä»¶å¨ âAgent ä¸å¡åºæ¯â ä¸çè¯­ä¹åå°è£ï¼èéå¨æ°åæãå æ­¤ï¼æ¬æå°åä»ç»Flink Agentsçåºæ¬ç»ä»¶ï¼ç¶åå°å¶ç»ä»¶ä¸Flink åçç»ä»¶åå¯¹æ¯ï¼æåç»åºä¸ä¸ªè¯¦ç»çä¾å­ï¼è¿æ ·è¯»èå¯ä»¥æ´å¥½ççè§£å¶è®¾è®¡ç²¾è¦ã</p>
<h2 id="0x01-flink-agentsä¸»è¦ç»ä»¶">0x01 Flink Agentsä¸»è¦ç»ä»¶</h2>
<p>å¯ä»¥æ Flink Agents çæ´ä¸ªæ§è¡æµç¨æ¯ä½ âåä¸éèâï¼æä»¬åæ­¤è¿è¡åæã</p>
<h3 id="11-ä¸»è¦ç»ä»¶">1.1 ä¸»è¦ç»ä»¶</h3>
<p>Flink Agents æ¯åºäºåç Flink åå¸å¼æµå¤çè½åå°è£çä¸å±æ¡æ¶ãå¶ä¸­åä¸ªä¸»è¦ç»ä»¶ä»£è¡¨äº Flink Agents æ¡æ¶ä¸­çåä¸ªå±æ¬¡ï¼</p>
<ul>
<li><strong>Agentï¼é¡¶å±è®¾è®¡ï¼å®ä¹äºâåä»ä¹âï¼</strong>ï¼ç¨æ·å®ä¹çæºè½å®ä½ï¼ç±»ä¼¼ âé¤åèå + è§åæåâï¼åå«ä¸å¡é»è¾ãå¨ä½ï¼Actionï¼åèµæºï¼å·¥å·ãæ¨¡åç­ï¼å®ä¹ï¼æç¡® âåä»ä¹âã</li>
<li><strong>AgentPlanï¼ä¸­é´ç¼è¯å±ï¼ç¡®å®äºâæä¹åâï¼</strong>ï¼å° Agent ç¼è¯åçå¯æ§è¡è®¡åï¼ç±»ä¼¼ âè¯¦ç»æä½æµç¨å¾âï¼æç¡®å¨ä½è§¦åè§åãèµæºæ å°å³ç³»ï¼ç¡®å® âæä¹åâã</li>
<li><strong>ActionExecutionOperatorï¼è¿è¡æ¶æ§è¡å±ï¼æ¯æ§è¡ç¯å¢ï¼è´è´£âåè°è°åº¦âï¼</strong>ï¼Flink éç¾¤ä¸­çæ§è¡æ ¸å¿ï¼å¨ Flink æµå¤çç¯å¢ä¸­å®éæ§è¡æä½ï¼ç±»ä¼¼ âé¤åé¦å¸­å¤§å¨âï¼è´è´£æ¥æ¶æ°æ®ãè°åº¦ä»»å¡ãç®¡çç¶æï¼åè°æ´ä½æ§è¡æµç¨ã</li>
<li><strong>ActionTaskï¼æå°æ§è¡ååï¼è´è´£âå·ä½å®æ½âï¼</strong>ï¼å·ä½çæ§è¡ä»»å¡ï¼ç±»ä¼¼ âåå·¥çåä¸ªæå¡æ­¥éª¤âï¼åä¸º JavaActionTask å PythonActionTaskï¼å¤çåä¸ªäºä»¶å¹¶è¿åç»æã</li>
</ul>
<p>å·ä½å¯ä»¥åè§ä¸å¾ã</p>
<pre><code class="language-python">[Agent] èåæå
    âï¼ç¼è¯ï¼
[AgentPlan] è¯¦ç»æµç¨å¾
    âï¼è¿è¡æ¶å®ä¾åï¼
[ActionExecutionOperator] é¤åé¦å¸­å¤§å¨
    âï¼åéä»»å¡ï¼
[ActionTask] åå·¥å·ä½ä»»å¡
</code></pre>
<p>è¿æ ·çè®¾è®¡ä½¿å¾ç³»ç»æ¢çµæ´»åé«æï¼è½å¤å¤çå¤æçAIä»£çä»»å¡ï¼åæ¶ä¿è¯äºè¯å¥½çæ©å±æ§åç»´æ¤æ§ã</p>
<h3 id="12-åé¨æååéæ å°å³ç³»">1.2 åé¨æååéæ å°å³ç³»</h3>
<p>AgentãAgentPlan å ActionExecutionOperator ä¹é´çå³ç³»ä»¥åå®ä»¬åé¨æååéçæ å°å³ç³»å¦ä¸ã</p>
<h4 id="121-agent-å°-agentplan">1.2.1 Agent å° AgentPlan</h4>
<p>Agent å° AgentPlan çæ å°å¦ä¸ï¼</p>
<table>
<thead>
<tr>
<th>Agent æå</th>
<th>AgentPlan å¯¹åºæå</th>
<th>è¯´æ</th>
</tr>
</thead>
<tbody>
<tr>
<td>_actionsï¼è£é¥°å¨å®ä¹ï¼</td>
<td>actions, actions_by_event</td>
<td>Agent ä¸­éè¿ @action è£é¥°å¨å®ä¹çå¨ä½è¢«ç¼è¯å° AgentPlan çå¨ä½æ å°ä¸­</td>
</tr>
<tr>
<td>_actionsï¼add_action æ·»å ï¼</td>
<td>actions, actions_by_event</td>
<td>éè¿ add_action æ¹æ³æ·»å çå¨ä½åæ ·ç¼è¯å°å¨ä½æ å°ä¸­</td>
</tr>
<tr>
<td>_resources</td>
<td>resource_providers</td>
<td>Agent ä¸­æ³¨åçèµæºè¢«è½¬æ¢ä¸ºèµæºæä¾è</td>
</tr>
</tbody>
</table>
<h4 id="122-agentplan-å°-actionexecutionoperator">1.2.2 AgentPlan å° ActionExecutionOperator</h4>
<p>AgentPlan å° ActionExecutionOperator çæ å°å¦ä¸ï¼</p>
<table>
<thead>
<tr>
<th>AgentPlan æå</th>
<th>ActionExecutionOperator å¯¹åºæå</th>
<th>è¯´æ</th>
</tr>
</thead>
<tbody>
<tr>
<td>actions</td>
<td>éè¿ getActionsTriggeredBy() æ¹æ³è°ç¨</td>
<td>Operator æ ¹æ®äºä»¶ç±»åæ¥æ¾å¯¹åºçå¨ä½</td>
</tr>
<tr>
<td>resource_providers</td>
<td>å¨ RunnerContextImpl ä¸­ä½¿ç¨</td>
<td>æä¾è¿è¡æ¶æéçèµæº</td>
</tr>
<tr>
<td>config</td>
<td>metricGroup, builtInMetrics ç­</td>
<td>ç¨äºéç½®ææ åå¶ä»è¿è¡æ¶è¡ä¸º</td>
</tr>
</tbody>
</table>
<h5 id="è¯¦ç»æ å°åæ">è¯¦ç»æ å°åæ</h5>
<h6 id="å¨ä½æ§è¡æ å°">å¨ä½æ§è¡æ å°</h6>
<p>å¨ <code>ActionExecutionOperator</code> ä¸­ï¼</p>
<pre><code class="language-java">// æ ¹æ®äºä»¶ç±»åè·åè§¦åçå¨ä½
private List&lt;Action&gt; getActionsTriggeredBy(Event event) {
    if (event instanceof PythonEvent) {
        return agentPlan.getActionsTriggeredBy(((PythonEvent) event).getEventType());
    } else {
        return agentPlan.getActionsTriggeredBy(event.getClass().getName());
    }
}

// åå»º ActionTask æ¥æ§è¡å¨ä½
private ActionTask createActionTask(Object key, Action action, Event event) {
    if (action.getExec() instanceof JavaFunction) {
        return new JavaActionTask(
            key, event, action, getRuntimeContext().getUserCodeClassLoader());
    } else if (action.getExec() instanceof PythonFunction) {
        return new PythonActionTask(key, event, action);
    }
    // ..
}
</code></pre>
<h6 id="èµæºç®¡çæ å°">èµæºç®¡çæ å°</h6>
<p><code>AgentPlan</code> ä¸­çèµæºæä¾èå¨ <code>ActionExecutionOperator</code> ä¸­éè¿ <code>RunnerContextImpl</code> è®¿é®ï¼</p>
<pre><code class="language-java">// å¨ RunnerContextImpl ä¸­
public Resource getResource(String name, ResourceType type) {
    return agentPlan.getResource(name, type);
}
</code></pre>
<h6 id="éç½®æ å°">éç½®æ å°</h6>
<p>AgentPlan ä¸­çéç½®ä¿¡æ¯è¢«ç¨äºåå§åActionExecutionOperatorçåç§è¿è¡æ¶ç»ä»¶ï¼</p>
<pre><code class="language-java">// å¨ ActionExecutionOperator.open() ä¸­
metricGroup = new FlinkAgentsMetricGroupImpl(getMetricGroup());
builtInMetrics = new BuiltInMetrics(metricGroup, agentPlan);

// ActionStateStore åå§åä¹ä¾èµäºéç½®
if (actionStateStore == null &amp;&amp; KAFKA.getType().equalsIgnoreCase(agentPlan.getConfig().get(ACTION_STATE_STORE_BACKEND))) {
    actionStateStore = new KafkaActionStateStore(agentPlan.getConfig());
}
</code></pre>
<h6 id="ç¶æç®¡çæ å°">ç¶æç®¡çæ å°</h6>
<p>ActionExecutionOperator ä¸­çåç§ç¶æä¸ AgentPlan çæ§è¡éæ±ç¸å¯¹åºï¼</p>
<pre><code class="language-java">// ç­æåå­ç¶æç¨äºå¨ä½é´çæ°æ®å±äº«
private transient MapState&lt;String, MemoryObjectImpl.MemoryItem&gt; shortTermMemState;

// å¨ä½ä»»å¡ç¶æç¨äºå¼æ­¥æ§è¡ç®¡ç
private transient ListState&lt;ActionTask&gt; actionTasksState;

// å¾å¤çäºä»¶ç¶æç¨äºæµæ§
private transient ListState&lt;Event&gt; pendingInputEventsState;
</code></pre>
<h3 id="13-æ§è¡æµç¨">1.3 æ§è¡æµç¨</h3>
<p>å·ä½æµç¨å¦ä¸ï¼</p>
<pre><code class="language-python">Action Code â Agent â AgentPlan â ActionExecutionOperator â ActionTask â Flink Runtime
</code></pre>
<p>ä»¥ ReActAgent ä¸ºä¾ï¼å¶æµç¨å¦ä¸ï¼</p>
<ul>
<li>
<p>ç¨æ·å®ä¹ ReActAgentï¼åå« <code>start_action</code> å <code>stop_action</code></p>
</li>
<li>
<p>éè¿ <code>AgentPlan.from_agent()</code> ç¼è¯æè®¡åï¼</p>
<ul>
<li>
<p><code>actions</code>ï¼åå« <code>start_action</code> å <code>stop_action</code></p>
</li>
<li>
<p><code>actions_by_event</code>ï¼æ å° <code>InputEvent</code> â <code>start_action</code>ï¼<code>ChatResponseEvent</code> â <code>stop_action</code></p>
</li>
</ul>
</li>
<li>
<p>å¨è¿è¡ç¯å¢ä¸­ï¼AgentPlan è¢«ä¼ éç» ActionExecutionOperatorFactoryãActionExecutionOperatorFactory åå»º ActionExecutionOperator å®ä¾ã</p>
</li>
<li>
<p>ActionExecutionOperator å¨è¿è¡æ¶æ ¹æ® AgentPlan æ§è¡å·ä½æä½ãå¨ ActionExecutionOperator ä¸­ï¼</p>
<ul>
<li>æ¥æ¶å° InputEvent åï¼æ¥æ¾å¹¶æ§è¡ start_action</li>
<li>start_action åé ChatRequestEvent</li>
<li>æ¥æ¾å¹¶æ§è¡å¤ç ChatRequestEvent çåç½®å¨ä½ï¼å¦ CHAT_MODEL_ACTIONï¼</li>
<li>PythonActionTask æ§è¡å·¥å·å½æ°ï¼è¥ä¸ºçæå¨ååå»º PythonGeneratorActionTask æç»­æ§è¡ï¼</li>
<li>å·¥å·æ§è¡å®æçæ ChatResponseEvent</li>
<li>æ¥æ¾å¹¶æ§è¡ stop_action</li>
<li>stop_action äº§ç OutputEvent å¹¶åéå°ä¸æ¸¸</li>
</ul>
</li>
</ul>
<p>è¿ç§è®¾è®¡å®ç°äºå³æ³¨ç¹åç¦»ï¼ç¨æ·åªéå³æ³¨ä¸å¡é»è¾å®ä¹ï¼æ¡æ¶è´è´£å°å¶ç¼è¯ä¸ºé«æçè¿è¡æ¶æ§è¡è®¡åã</p>
<h2 id="0x02-ä¸åçflinkæ¯å¯¹">0x02 ä¸åçFlinkæ¯å¯¹</h2>
<p>Flink Agents æ¯åç Flink ç âé¢åå°è£âï¼ææç»ä»¶é½è½æ å°å°åç Flink æ ¸å¿ç»ä»¶ï¼æªè±ç¦» Flink æµå¤ççæ ¸å¿æ¶æãæä»¬æ¥ä¸æ¥çç Flink Agents éç AgentãAgentPlanãActionExecutionOperatorãActionTask è¿äºæ ¸å¿ç»ä»¶ï¼åå«å¯¹åºåç Flink ä¸­çåªäºæ ¸å¿ç»ä»¶ï¼ä»¥åå®ä»¬çç¸ä¼¼æ§é»è¾ã</p>
<h3 id="21-æ ¸å¿">2.1 æ ¸å¿</h3>
<p>æä»¬åç¨ä¸å¼ è¡¨æ¥æ¦æ¬æ¯å¯¹å³ç³»ã</p>
<table>
<thead>
<tr>
<th>Flink Agents ç»ä»¶</th>
<th>åç Flink å¯¹åºç»ä»¶</th>
<th>æ ¸å¿è§è²</th>
</tr>
</thead>
<tbody>
<tr>
<td>Agent</td>
<td>StreamGraph / ç¨æ· DataStream ä»£ç </td>
<td>é«å±ä¸å¡é»è¾å£°æï¼åä»ä¹ï¼</td>
</tr>
<tr>
<td>AgentPlan</td>
<td>JobGraph</td>
<td>ç¼è¯åçå¯æ§è¡è®¡åï¼æä¹æï¼</td>
</tr>
<tr>
<td>ActionExecutionOperator</td>
<td>KeyedProcessOperator/StreamOperator</td>
<td>è¿è¡æ¶æ ¸å¿æ§è¡ç®å­ï¼æ ¸å¿è½½ä½ï¼</td>
</tr>
<tr>
<td>ActionTask</td>
<td>ç®å­åå¤çåå / AsyncFunction ä»»å¡</td>
<td>åå­æ§è¡ä»»å¡ï¼æå°æ§è¡ååï¼</td>
</tr>
</tbody>
</table>
<p>æ ¸å¿æ å°é»è¾å¦ä¸ï¼ãå£°æå±ï¼Agentï¼â ç¼è¯å±ï¼AgentPlanï¼â æ§è¡ç®å­ï¼ActionExecutionOperatorï¼â åå­ä»»å¡ï¼ActionTaskï¼ãå¯¹åºåç Flink çãStreamGraph â JobGraph â StreamOperator â ç®å­åå¤çååãï¼</p>
<p>åå° âåä¸éèâ ï¼æä»¬è¿è¡åæå¯¹æ¯ã</p>
<ul>
<li>Agent = ä½ åç âèè°±é»è¾âï¼æ¯å¦ âåçªèçèï¼åçèåççªèâï¼â å¯¹åº Flink StreamGraphï¼çº¯é»è¾ï¼ï¼</li>
<li>AgentPlan = é¤ååå¨æèè°±è½¬æ¢æç âå¯æ§è¡å·¥åâï¼æç¡® âè°æ¥çãç¨åªä¸ªéãæ¾å¤å°çâï¼â å¯¹åº  Flink JobGraphï¼å¯æ§è¡è®¡åï¼ï¼</li>
<li>ActionExecutionOperator = æåºå¨å¸ï¼æ§è¡å·¥åï¼â å¯¹åº Flink  StreamOperatorï¼</li>
<li>ActionTask = å¨å¸ç âåä¸ªç¿»çå¨ä½ââ å¯¹åº Flink ç®å­åçåå­å¤çä»»å¡ï¼</li>
<li>Flink ExecutionGraph = å¨å¸å®éç«å¨åªä¸ªç¶å°ãç¨åªå¥å¨å· â ç©çæ§è¡å±ï¼å AgentPlan æ å³ã</li>
</ul>
<h3 id="22-å·ä½æ¯å¯¹">2.2 å·ä½æ¯å¯¹</h3>
<h4 id="221-agent">2.2.1 Agent</h4>
<ul>
<li><strong>ç¸ä¼¼ç»ä»¶</strong>ï¼Flink Job çä¸å¡é»è¾å®ä¹ï¼å¦ DataStream ç®å­é¾ï¼ãStreamGraphï¼æµå¼ä½ä¸çé»è¾ææï¼</li>
<li><strong>ç¸ä¼¼æ§æ ¸å¿</strong>ï¼Agent æ¯ç¨æ·å®ä¹ç âæºè½å®ä½âï¼åå«ä¸å¡é»è¾ãå¨ä½ãèµæºï¼ï¼æ¬è´¨æ¯ä¸å¡å±é¢ç âä½ä¸é»è¾å£°æâï¼è¿ååç Flink ä¸­ç¨æ·ç¼åç DataStream ä»£ç ï¼å®ä¹ âæ°æ®æä¹å¤çâï¼ãStreamGraphï¼æè¿°é»è¾ææï¼çè§è²å®å¨ä¸è´ ââ é½æ¯ âåè¯ç³»ç»è¦åä»ä¹â çé¡¶å±é»è¾å®ä¹ï¼ä¸æ¶åå·ä½æ§è¡ã</li>
<li><strong>å·®å¼</strong>ï¼Agent æ´èç¦ âAgent è¡ä¸º / å·¥å·è°ç¨â çè¯­ä¹ï¼èåç StreamGraph æ¯éç¨çæ°æ®æµææã</li>
</ul>
<h4 id="222-agentplan">2.2.2 AgentPlan</h4>
<ul>
<li><strong>ç¸ä¼¼ç»ä»¶</strong>ï¼Flink ç JobGraphï¼StreamGraph ç¼è¯åçå¯æ§è¡ææï¼</li>
<li><strong>ç¸ä¼¼æ§æ ¸å¿</strong>ï¼AgentPlan æ¯ Agent ç¼è¯åç âå¯æ§è¡è®¡åâï¼æç¡®å¨ä½è§¦åè§åãèµæºæ å°ï¼ï¼æ¬è´¨æ¯å°é«å±ä¸å¡é»è¾è½¬æ¢ä¸ºç³»ç»å¯è¯å«çæ§è¡è®¡åï¼è¿ååç Flink ä¸­ StreamGraph ç¼è¯ä¸º JobGraph çè¿ç¨ä¸è´ ââJobGraph æç¨æ·çé»è¾ææè½¬æ¢ä¸ºåå«å¹¶è¡åº¦ãç®å­é¾ãä¸­é´ç»æä¼ éçå¯æ§è¡ææï¼AgentPlan åæ Agent ç âè¡ä¸ºè§åâ è½¬æ¢ä¸ºç³»ç»å¯è°åº¦ç âå¨ä½æ§è¡è§åâã</li>
<li><strong>å³é®å±æ§</strong>ï¼é½æ¯ âç¼è¯å±â äº§ç©ï¼è¿æ¥é«å±å®ä¹ä¸åºå±æ§è¡ã</li>
</ul>
<h4 id="223-actionexecutionoperator">2.2.3 ActionExecutionOperator</h4>
<ul>
<li>
<p><strong>ç¸ä¼¼ç»ä»¶</strong>ï¼Flink æ ¸å¿ç StreamOperatorï¼å¦ ProcessOperatorãFlatMapOperatorï¼ãKeyedProcessOperator</p>
</li>
<li>
<p><strong>ç¸ä¼¼æ§æ ¸å¿</strong>ï¼ActionExecutionOperator æ¯ Flink éç¾¤ä¸­æ§è¡ Agent é»è¾çæ ¸å¿ç®å­ï¼æ¬è´¨æ¯è¿è¡æ¶çæ ¸å¿æ§è¡ååï¼è¿ååç Flink ç StreamOperator å®å¨å¯¹åº ââStreamOperator æ¯å¤çæ°æ®æµçæ ¸å¿è½½ä½ï¼å¦ ProcessOperator å¤ç KeyedStreamãå®ç°ç¶æç®¡çï¼ï¼ActionExecutionOperator å°±æ¯éå¯¹ âAgent å¨ä½æ§è¡â åºæ¯å®å¶ç StreamOperatorï¼</p>
<ul>
<li>é½è¿è¡å¨ TaskManager ä¸­ï¼å¤çæµæ°æ®ï¼Eventï¼ï¼</li>
<li>é½æ¯æé®æ§ç¶æï¼Keyed Stateï¼ï¼æ key éç¦»æ§è¡ä¸ä¸æï¼</li>
<li>é½ä¾èµ Mailbox æºå¶è°åº¦ä»»å¡ï¼é¿åé»å¡ï¼</li>
<li>é½è´è´£ç¶æç®¡çãäºä»¶å¤çãç»æè¾åºã</li>
</ul>
</li>
<li>
<p><strong>å¸åå¯¹åº</strong>ï¼ActionExecutionOperator ææ¥è¿åçç <code>KeyedProcessOperator</code>ï¼é®æ§å¤çãç¶æç®¡çãå¼æ­¥ä»»å¡è°åº¦ï¼ã</p>
</li>
</ul>
<h4 id="223-actiontask">2.2.3 ActionTask</h4>
<ul>
<li>
<p><strong>ç¸ä¼¼ç»ä»¶</strong>ï¼Flink çãç®å­åçå¤çä»»å¡ãï¼å¦ ProcessFunction ä¸­çåä¸ªåç´ å¤çé»è¾ï¼ãAsync I/O ä¸­ç <code>AsyncFunction</code> ä»»å¡</p>
</li>
<li>
<p><strong>ç¸ä¼¼æ§æ ¸å¿</strong>ï¼ActionTask æ¯ âæå°æ§è¡ååâï¼å¦åä¸ª Python/Java å¨ä½æ§è¡ï¼ï¼æ¬è´¨æ¯ç®å­åçåå­å¤çä»»å¡ï¼è¿ååç Flink ä¸­ï¼</p>
<ul>
<li>ProcessOperator å¤çåä¸ª StreamElementï¼å¦ä¸æ¡æ°æ®ï¼çé»è¾ååï¼</li>
<li>Async I/O ä¸­ AsyncFunction å°è£çå¼æ­¥ä»»å¡ï¼å¦å¼æ­¥æ¥è¯¢æ°æ®åºï¼ï¼</li>
</ul>
<p>è§è²å®å¨ä¸è´ ââ é½æ¯ âç®å­åçæå°å¯æ§è¡ä»»å¡âï¼æ§è¡å®æåè¿åç»æï¼æ¯æå¼æ­¥ / åé¶æ®µæ§è¡ã</p>
</li>
<li>
<p><strong>å³é®å±æ§</strong>ï¼</p>
<ul>
<li>é½æ¯ âåå­æ§è¡ååâï¼ä¸å¯åæåï¼</li>
<li>æ¯æå¼æ­¥æ§è¡ï¼å¦ PythonActionTask å¯¹åº Async I/Oï¼ï¼</li>
<li>æ§è¡ç»æå¯è§¦ååç»­ä»»å¡ï¼å¦ ActionTaskResult çææ°ä»»å¡ï¼å¯¹åº Async I/O åè°è§¦ååç»­å¤çï¼ã</li>
</ul>
</li>
<li>
<p><strong>ç»åå¯¹åº</strong>ï¼</p>
<ul>
<li>JavaActionTask â åçåæ­¥å¤çä»»å¡ï¼å¦ ProcessFunction ä¸­çåæ­¥é»è¾ï¼ï¼</li>
<li>PythonActionTask â åç Async I/O ä»»å¡ï¼å¼æ­¥è°ç¨å¤é¨æå¡ / èæ¬ï¼ã</li>
</ul>
</li>
</ul>
<h2 id="0x03-å®ä¾æè§£">0x03 å®ä¾æè§£</h2>
<p>æä»¬æ¥è¿ä¸æ­¥è§£é Flink Agents è¿å ä¸ªæ ¸å¿æ¦å¿µçå³ç³»åéåãä¸ºäºæ´å¥½çè¯´æï¼æä»¬å¯ä»¥ææ´ä¸ªFlink Agentsç³»ç»ä»âåä¸éèâæå±å°âä¸ä¸ªæºè½é¤åèªå¨åæå¡ç³»ç»âãåæ¶ï¼ç»åå®ä¾ä¹æ·±å¥ä¸ææ¯ç»èã</p>
<h3 id="31-ç¬¬ä¸å±çº§agent--é¤åèååè§åæåblueprint">3.1 ç¬¬ä¸å±çº§ï¼Agent â é¤åèååè§åæåï¼Blueprintï¼</h3>
<p>Flink Agents ä¸­ç Agent æ¯ç¨æ·å®ä¹çæºè½å®ä½ï¼è´è´£åè°åç§èµæºåè¡ä¸ºæ¥å®æç¹å®çä»»å¡ãæä»¬æ Agent æ³è±¡æé¤åçèååè¿è¥æåï¼</p>
<ul>
<li>
<p>å®ä¹äºé¤åè½æä¾åªäºèååæå¡ï¼å¨ä½ï¼</p>
</li>
<li>
<p>è§å®äºéè¦ç¨å°åªäºè®¾å¤åé£æï¼èµæºï¼ï¼å¦åä¸ºæ°åå·¥éå¤å·¥å·ç®±ï¼å¯¹åºç¨åºåå®éç¨å°çï¼å¯ä»¥æ¯ï¼</p>
<ul>
<li>åç§ API æ¥å£ï¼ç¸å½äºå·¥å·ï¼</li>
<li>æ°æ®åºè®¿é®æéï¼ç¸å½äºåèèµæï¼</li>
<li>å³ç­é»è¾ä»£ç ï¼ç¸å½äºå¹è®­ææï¼</li>
</ul>
</li>
<li>
<p>éå°ä»ä¹æåµåºè¯¥åä»ä¹ï¼å¯¹åºäºä»¶çå¬ï¼</p>
</li>
<li>
<p>æè¿°äºé¡¾å®¢ç¹é¤å°ä¸èçå®æ´æµç¨</p>
<ul>
<li>æä¸ä¸ª start_actionï¼æ¥å¾åï¼è´è´£æ¥æ¶é¡¾å®¢é®é¢</li>
<li>æä¸ä¸ª stop_actionï¼æ¶é¶åï¼è´è´£æç»ç»è´¦è¾åºç»æ</li>
</ul>
</li>
</ul>
<p>è¿äºé½è¢«å°è£å¨ Agent å¯¹è±¡ä¸­ã</p>
<h3 id="32-ç¬¬äºå±çº§agentplan--é¤åçè¯¦ç»æä½æµç¨å¾compiled-planè®¡åç¼è¯å±">3.2 ç¬¬äºå±çº§ï¼AgentPlan â é¤åçè¯¦ç»æä½æµç¨å¾ï¼Compiled Plan,è®¡åç¼è¯å±ï¼</h3>
<p>Flink Agentæ¡æ¶ä¼æç¨æ·ç Agent è½¬æ¢ä¸ºä¸ä¸ªæ´éç¨ãæ´éåç³»ç»å¤ççå½¢å¼ ââ AgentPlanãå¨æ¬ä¾ä¸­ï¼AgentPlan ç¸å½äºå°é¤åè¿è¥æåç¼è¯æçè¯¦ç»å·¥ä½æµç¨å¾ï¼æ½è±¡åçå·¥ä½èå¾ï¼ï¼</p>
<ul>
<li>æèåä¸çæ¯éèåè§£æå·ä½çæ­¥éª¤</li>
<li>æç¡®æ¯ä¸ªå²ä½ï¼å¨ä½ï¼å¨ä»ä¹æåµä¸è¢«è§¦åï¼å³éå°å¥äºä»¶ï¼Eventï¼è¯¥å¹²å¥æ´»ï¼Actionï¼</li>
<li>åå¤å¥½ææéè¦çå·¥å·åæææ¸åï¼Resourceï¼</li>
</ul>
<p>å°±åé¤åç»çä¼å¶å®è¯¦ç»çæä½æåï¼åè¯æå¡åä»ä¹æ¶åè¯¥åä»ä¹äºã</p>
<h4 id="ç»æåè§£æ">ç»æåè§£æ</h4>
<p>AgentPlan åå«å ä¸ªå³é®é¨åï¼</p>
<p><strong>Actions æ å°è¡¨</strong></p>
<ul>
<li>æç¡®ååºææå¯ä»¥æ§è¡çå¨ä½åå¶è§¦åæ¡ä»¶</li>
<li>ä¾å¦ï¼âæ¶å°è®¢åæ¥è¯¢è¯·æ±â â âæ§è¡è®¢åæ¥è¯¢å¨ä½â</li>
</ul>
<p><strong>èµæºæä¾èç®å½</strong></p>
<ul>
<li>è®°å½ææå¯ç¨èµæºçä½ç½®åè·åæ¹å¼</li>
<li>ç±»ä¼¼äºå·¥åéåä¸ªä¾åºé¨é¨çèç³»æ¹å¼æ¸å</li>
</ul>
<p><strong>éç½®åæ°é</strong></p>
<ul>
<li>å­å¨è¿è¡æéçåé¡¹è®¾ç½®éé¡¹</li>
<li>åæ¯è®¾å¤æä½è§ç¨åææ¯è§è</li>
</ul>
<h4 id="å¹³å°ééæ§">å¹³å°ééæ§</h4>
<p>éè¿è¿ç§æ½è±¡åï¼æ è®ºåºå±æ¯ Java è¿æ¯ Python å®ç°ï¼é½å¯ä»¥ç»ä¸ç¨åä¸ä»½ AgentPlan æ¥è¿è¡è°åº¦ç®¡çã</p>
<h3 id="33-ç¬¬ä¸å±çº§actionexecutionoperator--é¤åçæ§è¡ç®¡çå±runtime-executoræ§è¡å¼æå±">3.3 ç¬¬ä¸å±çº§ï¼ActionExecutionOperator â é¤åçæ§è¡ç®¡çå±ï¼Runtime Executorï¼æ§è¡å¼æå±ï¼</h3>
<p>å¨å¤§è§æ¨¡çäº§ç¯å¢ä¸­ï¼ä¸è½åªé ä¸ä¸ªç®¡å®¶å¹²æ´»ï¼èæ¯éè¦ä¸æ¡èªå¨åæµæ°´çº¿ãActionExecutionOperator å°±åæ¯ä¸æ¡æºè½åçå·¥åè£éçº¿ï¼å®æç§æä½æåï¼AgentPlanï¼ç»ç»å¤ä¸ªå·¥ä½ç«æ¥ååå®æä»»å¡ãæèè¯´ï¼ActionExecutionOperator æ¯é¤åçç°åºæ§è¡ç®¡çå±ï¼æ¯æ´ä¸ªç³»ç»çâå¤§è + ä¸­æ¢æ§å¶å®¤âï¼</p>
<ul>
<li>è´è´£æ¥å¾è¿åºçé¡¾å®¢ï¼æ¥æ¶æ°æ®ï¼</li>
<li>æ ¹æ®æµç¨å¾åéä»»å¡ç»ä¸åçåå·¥ï¼æ§è¡å¨ä½ï¼</li>
<li>åè°åä¸ªå²ä½ä¹é´çå·¥ä½ï¼çæ§è¿åº¦ç¶æ / ç®¡çç¶æååå­ï¼</li>
<li>ç¡®ä¿æå¡æµç¨é¡ºçï¼å¤çå¹¶ååå®¹éï¼</li>
<li>é¤åç»çæ¿çè¯¦ç»æµç¨å¾ï¼ææ¥åä¸ªåå·¥ååå·¥ä½ã</li>
</ul>
<h3 id="34-ç¬¬åå±çº§actiontask--å·ä½çæå¡æ­¥éª¤execution-unit">3.4 ç¬¬åå±çº§ï¼ActionTask â å·ä½çæå¡æ­¥éª¤ï¼Execution Unitï¼</h3>
<p>ActionTask å°±åæ¯åå·¥æ§è¡çå·ä½æå¡æ­¥éª¤ï¼æ¯çäº§çº¿ä¸çæå°å·¥ä½ï¼ä¸æ¬¡åªå¹²ä¸ä»¶å·ä½æ´»ï¼è°ç¨ Python å½æ°ãæ¥æ°æ®åºãå HTTPãå Kafka â¦ï¼ï¼</p>
<ul>
<li>æ¯ä¸ªæå¡åæ¥å°çä»»å¡å°±æ¯ä¸ä¸ª ActionTask</li>
<li>å¯è½æ¯ç®åä¸æ­¥å®æï¼æ®éæå¡åï¼</li>
<li>å¯è½æ¯éè¦å¤æ­¥å®æï¼éè¦åè®¿çææ¯åï¼ï¼å³å¦ææ´»å¤ªå¤ï¼å¼æ­¥ãé¿èæ¶ï¼ï¼æå¡åä¼æèªå·±ãååãææ°ä»»å¡ï¼ç­ä¸æ¬¡è½®è¯¢åæ¥çå¹²ï¼å®ç°éé»å¡çåä½å¼è°åº¦ã</li>
<li>å®æåæ¥åç»æï¼å¹¶å¯è½è§¦åä¸ä¸æ­¥å·¥ä½ï¼å³å¹²å®å°±è½ç«å³æç»æï¼Eventï¼æåä¼ éå¸¦ï¼ç»§ç»­ä¸ä¸è½®</li>
</ul>
<h3 id="35-å·¥ä½æµç¨ä¸¾ä¾">3.5 å·¥ä½æµç¨ä¸¾ä¾</h3>
<p>åè®¾é¡¾å®¢æ¥å°é¤åç¹äºä¸ä»½å¤æçå¥é¤ï¼</p>
<ul>
<li>é¡¾å®¢è¿åºï¼InputEventï¼
<ul>
<li>é¤åç»çï¼ActionExecutionOperatorï¼æ¥å¾é¡¾å®¢</li>
<li>æ ¹æ®æµç¨å¾ç¥éåºè¯¥è®©æ¥å¾åï¼start_actionï¼å¤ç</li>
</ul>
</li>
<li>æ¥å¾åå¤çï¼ActionTaskï¼
<ul>
<li>æ¥å¾åï¼PythonActionTaskï¼æ¥å°ä»»å¡</li>
<li>çè§£é¡¾å®¢éæ±ï¼çæå¨æ¿è®¢åï¼ChatRequestEventï¼</li>
</ul>
</li>
<li>å¨æ¿å¶ä½ï¼åç½®å¨ä½ï¼
<ul>
<li>å¨å¸ï¼CHAT_MODEL_ACTIONï¼æ¶å°è®¢åå¼å§å¶ä½</li>
<li>å¶ä½å®æåéç¥æå¡åï¼ChatResponseEventï¼</li>
</ul>
</li>
<li>æ¶é¶ç»è´¦ï¼ActionTaskï¼
<ul>
<li>æ¶é¶åï¼stop_actionï¼å¤çæç»ç»æ</li>
<li>é¡¾å®¢æåå¸¦èµ°ï¼OutputEventï¼</li>
</ul>
</li>
</ul>
<p>ãç¨æ·åªç®¡æç®¡å®¶è®­å¥½ï¼æ¡æ¶è´è´£æç®¡å®¶åææåï¼åææååæå¹¶è¡çäº§çº¿ï¼æåè®©æ æ°workeræ key éç¦»ãäºä»¶é©±å¨ãå¯æ£æ¥ç¹çæ¹å¼è·å¨ Flink ä¸ããã</p>
<h2 id="0x04-å¹¶åæ§åå¹¶è¡æ§">0x04 å¹¶åæ§åå¹¶è¡æ§</h2>
<p>Flink Agents ç³»ç»å¨è®¾è®¡æ¶å·²ç»ååèèäºå¹¶åæ§åå¹¶è¡æ§ï¼æ¯å¦ï¼</p>
<ul>
<li><strong>äºä»¶é©±å¨æ¨¡å</strong>ï¼åºäºäºä»¶æµè½¬è§¦åå¨ä½ï¼åå§ä¸º InputEventï¼ç»å¤è½®äºä»¶ï¼å¦ ChatRequestEventãChatResponseEventï¼è§¦åï¼æç»è¾åº OutputEventã</li>
<li><strong>å¹¶åä¸éç¦»è®¾è®¡</strong>ï¼å©ç¨ Flink é®æ§æµï¼KeyedStreamï¼å®ç°æ key ååºï¼æ¯ä¸ª key æ¥æç¬ç«ç¶æï¼éè¿é®ç®±çº¿ç¨æ¨¡åï¼MailboxExecutorï¼å®ç°åä½å¼å¤ä»»å¡ï¼é¿åé»å¡ã</li>
<li><strong>ä»»å¡ååæºå¶</strong>ï¼é¿æ¶é´è¿è¡çä»»å¡ï¼å¦ Python çæå¨ï¼ä¼è¢«ååä¸ºå¤ä¸ª ActionTaskï¼æ§è¡åéè¿ ActionTaskResult ä¼ éä¸ä¸ä¸ªä»»å¡ï¼ç¡®ä¿å¹¶åæçã</li>
<li><strong>æ¬å°ä¸è¿ç¨æ§è¡</strong>ï¼æ¬å°ç¨ LocalRunner æ¨¡ææ§è¡ï¼è¿ç¨åºäº Flink éç¾¤ç ActionExecutionOperator åå¸å¼æ§è¡ï¼ä¿æ API ä¸è´æ§ã</li>
</ul>
<p>ä»¥ä¸æ¯å·ä½å®ç°æ¹å¼ï¼</p>
<h3 id="41-flinkåçå¹¶åæ¨¡å">4.1 Flinkåçå¹¶åæ¨¡å</h3>
<p>ç³»ç»ååå©ç¨äºApache Flinkçåçå¹¶åæºå¶ï¼</p>
<ul>
<li>é®æ§æµï¼Keyed Streamsï¼ï¼ä½¿ç¨FlinkçKeyedStreamækeyå¯¹æ°æ®è¿è¡ååºï¼ç¡®ä¿ç¸åkeyçäºä»¶ç±åä¸ä¸ªå¹¶è¡å®ä¾å¤ç</li>
<li>å¹¶è¡æä½ç¬¦ï¼ActionExecutionOperatorå¯ä»¥å¨Flinkéç¾¤ä¸­çå¤ä¸ªå®ä¾ä¸å¹¶è¡è¿è¡</li>
</ul>
<pre><code class="language-java">// å¨CompileUtils.javaä¸­ - å°ä»£çè¿æ¥å°é®æ§æµ
public static &lt;IN, K&gt; DataStream&lt;Object&gt; connectToAgent(
    DataStream&lt;IN&gt; inputStream, KeySelector&lt;IN, K&gt; keySelector, AgentPlan agentPlan) {
    return connectToAgent(inputStream.keyBy(keySelector), agentPlan);
}
</code></pre>
<p>å¨ RemoteExecutionEnvironment ä¸­æï¼</p>
<pre><code class="language-java">@Override
public DataStream&lt;Object&gt; toDataStream() {
    if (agentPlan == null) {
        throw new IllegalStateException("Must apply agent before calling toDataStream");
    }

    if (outputDataStream == null) {
        if (keySelector != null) {
            outputDataStream =
                    CompileUtils.connectToAgent(inputDataStream, keySelector, agentPlan);
        } else {
            // If no key selector provided, use a simple pass-through key selector
            outputDataStream =
                    CompileUtils.connectToAgent(inputDataStream, x -&gt; x, agentPlan);
        }
    }

    return outputDataStream;
}
</code></pre>
<h3 id="42-æ¯ä¸ªkeyçç¶æç®¡ç">4.2 æ¯ä¸ªKeyçç¶æç®¡ç</h3>
<p>æ¯ä¸ªkeyé½ç»´æ¤ç¬ç«çç¶æéç¦»ï¼</p>
<pre><code class="language-java">// å¨ActionExecutionOperator.javaä¸­ - ç»´æ¤æ¯ä¸ªkeyçç¶æ
private transient ListState&lt;ActionTask&gt; actionTasksKState;
private transient ListState&lt;Event&gt; pendingInputEventsKState;
private transient ValueState&lt;Long&gt; sequenceNumberKState;
</code></pre>
<p>è¿äºé½æ¯é®æ§ç¶æï¼keyed stateï¼ï¼æå³çæ¯ä¸ªkeyé½æèªå·±çç¬ç«ç¶æå®ä¾ï¼é²æ­¢ä¸åkeyä¹é´çç«äºæ¡ä»¶ã</p>
<h3 id="43-é®ç®±çº¿ç¨æ¨¡å">4.3 é®ç®±çº¿ç¨æ¨¡å</h3>
<p>ç³»ç»ä½¿ç¨Flinkçé®ç®±çº¿ç¨æ¨¡åå®ç°åä½å¼å¤ä»»å¡å¤çï¼</p>
<pre><code class="language-java">// å¨ActionExecutionOperator.javaä¸­
private final transient MailboxExecutor mailboxExecutor;

// æäº¤ä»»å¡è¿è¡å¤ç
mailboxExecutor.submit(() -&gt; tryProcessActionTaskForKey(key), "process action task");
</code></pre>
<p>è¿åè®¸é¿æ¶é´è¿è¡çæä½è®©åºæ§å¶æï¼é²æ­¢é»å¡æ´ä¸ªæä½ç¬¦ã</p>
<h3 id="44-å¼æ­¥ä»»å¡å¤ç">4.4 å¼æ­¥ä»»å¡å¤ç</h3>
<p>æ¯æå¼æ­¥æ§è¡å¹¶å·å¤éå½çç¶æç®¡çï¼</p>
<pre><code class="language-java">// å¨ ActionTask.java ä¸­ - æ¯æåºäºå»¶ç»­çæ§è¡
public class ActionTaskResult {
    private final boolean finished;
    private final List&lt;Event&gt; outputEvents;
    private final Optional&lt;ActionTask&gt; generatedActionTaskOpt;

    // åè®¸ä¸ä¸ªå¨ä½çæå»¶ç»­ä»»å¡
    public Optional&lt;ActionTask&gt; getGeneratedActionTask() {
        return generatedActionTaskOpt;
    }
}
</code></pre>
<h3 id="45-åå­ä¸è´æ§">4.5 åå­ä¸è´æ§</h3>
<p>å·æç¼å­ç¶æè®¿é®ççº¿ç¨å®å¨åå­ç®¡çï¼</p>
<pre><code class="language-java">// å¨ ActionExecutionOperator.java ä¸­
private void createAndSetRunnerContext(ActionTask actionTask) {
    // æ­£ç¡®ç®¡ç RunnerContext çåå»ºåéç¨
    if (actionTask.getRunnerContext() != null) {
        return;
    }
    // ... åå»ºéå½ç context
}
</code></pre>
<h3 id="46-æ°´å°åäºä»¶æ¶é´å¤ç">4.6 æ°´å°åäºä»¶æ¶é´å¤ç</h3>
<p>å·å¤å¹¶åæè¯çæ°´å°å¤çï¼</p>
<pre><code class="language-java">    private transient SegmentedQueue keySegmentQueue;
    
    keySegmentQueue = new SegmentedQueue();

    @Override
    public void processWatermark(Watermark mark) throws Exception {
        keySegmentQueue.addWatermark(mark);
        processEligibleWatermarks();
    }
</code></pre>
<h3 id="47-æ£æ¥ç¹åæ¢å¤">4.7 æ£æ¥ç¹åæ¢å¤</h3>
<p>ç¨äºå®¹éççº¿ç¨å®å¨ç¶æå¿«ç§</p>
<pre><code class="language-java">    @Override
    public void snapshotState(StateSnapshotContext context) throws Exception {
        if (actionStateStore != null) {
            Object recoveryMarker = actionStateStore.getRecoveryMarker();
            if (recoveryMarker != null) {
                recoveryMarkerOpState.update(List.of(recoveryMarker));
            }
        }

        HashMap&lt;Object, Long&gt; keyToSeqNum = new HashMap&lt;&gt;();
        getKeyedStateBackend()
                .applyToAllKeys(
                        VoidNamespace.INSTANCE,
                        VoidNamespaceSerializer.INSTANCE,
                        new ValueStateDescriptor&lt;&gt;(MESSAGE_SEQUENCE_NUMBER_STATE_NAME, Long.class),
                        (key, state) -&gt; keyToSeqNum.put(key, state.value()));
        checkpointIdToSeqNums.put(context.getCheckpointId(), keyToSeqNum);

        super.snapshotState(context);
    }
</code></pre>
<h3 id="48-æ»ç»">4.8 æ»ç»</h3>
<p>è®¾è®¡éç¨äºå¤ç§å¹¶åæºå¶ï¼</p>
<ul>
<li>Flinkå¹¶è¡å¤çï¼å©ç¨Flinkåççå¹¶è¡æ§åé®æ§æµ</li>
<li>æ¯ä¸ªKeyçéç¦»ï¼æ¯ä¸ªkeyç»´æ¤ç¬ç«ç¶æï¼æ¶é¤keyä¹é´çç«äº</li>
<li>åä½å¼çº¿ç¨ï¼ä½¿ç¨é®ç®±æ§è¡å¨å®ç°éé»å¡æ§è¡</li>
<li>å¼æ­¥å»¶ç»­ï¼éè¿ä»»å¡é¾æ¯æé¿æ¶é´è¿è¡çæä½</li>
<li>çº¿ç¨å®å¨ç¶æç®¡çï¼å¯¹å±äº«èµæºè¿è¡éå½çåæ­¥</li>
<li>å®¹éæºå¶ï¼æ£æ¥ç¹æºå¶ç¡®ä¿æéæåµä¸çæ°æ®ä¸è´æ§</li>
</ul>
<p>è¿ç§æ¹æ³ä½¿ç³»ç»è½å¤å¨ä¿æä¸è´æ§åæ¯ææ°´å¹³æ©å±çåæ¶å¤çé«ååéï¼å¯å¨ Flink éç¾¤çå¤ä¸ªèç¹é´æ©å±ã</p>
<h2 id="0xff-åè">0xFF åè</h2>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2025-12-29 20:25">2025-12-29 20:24</span>&nbsp;
<a href="https://www.cnblogs.com/rossiXYZ">ç½è¥¿çæè</a>&nbsp;
éè¯»(<span id="post_view_count">0</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19369781);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19369781', targetLink: 'https://www.cnblogs.com/rossiXYZ/p/19369781', title: 'ãå¤§æ°æ® &amp;amp; AIãFlink Agents æºç è§£è¯» --- (2) ---  æ ¸å¿æ¶æ' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ Java åªäºæåµä¼å¯¼è´åå­æ³æ¼ ]]></title>
    <link>https://www.cnblogs.com/yanshajiuzhou/p/19417793</link>
    <guid>75a705f582bb3bfbbaeb52795caf73eb</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/yanshajiuzhou/p/19417793" title="åå¸äº 2025-12-29 19:29">
    <span role="heading" aria-level="2">Java åªäºæåµä¼å¯¼è´åå­æ³æ¼</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                    <div id="cnblogs_post_description" style="display: none">
        
        åå­æ³æ¼ æ¯æå¯¹è±¡ å·²ç»ä¸åè¢«ç¨åºä½¿ç¨ï¼ä½å ä¸ºæäºåå  æ æ³è¢«åå¾åæ¶å¨åæ¶ï¼é¿æå ç¨åå­ï¼æç»å¯è½å¼å&nbsp;OOMï¼OutOfMemoryErrorï¼ã
    </div>
<div id="cnblogs_post_body" class="blogpost-body blogpost-body-html">
<p><span data-cke-copybin-start="1">â</span>ä»å¤©æä»¬æ¥ä¸èµ·èä¸èæåªäºæåµä¼å¯¼è´åå­æ³æ¼ã</p>
<p>ä»ä¹æ¯ <strong>åå­æ³æ¼</strong> å¢ï¼</p>
<p><strong>åå­æ³æ¼</strong> æ¯æå¯¹è±¡ <strong>å·²ç»ä¸åè¢«ç¨åºä½¿ç¨</strong>ï¼ä½å ä¸ºæäºåå  <strong>æ æ³è¢«åå¾åæ¶å¨åæ¶</strong>ï¼é¿æå ç¨åå­ï¼æç»å¯è½å¼å&nbsp;<strong>OOM</strong>ï¼OutOfMemoryErrorï¼ã</p>
<p>æ¥ä¸æ¥æä»¬çä¸ä¸å¸¸è§çå ç±»åå­æ³æ¼åºæ¯ã</p>
<p><strong>1ãçå½å¨æé¿çéå</strong></p>
<p>å°å¯¹è±¡æ¾å¥ <strong>éæ</strong> æ&nbsp;<strong>çå½å¨æå¾é¿&nbsp;</strong>çéåï¼å¦ public <strong>static</strong> List&lt;Object&gt; list = new ArrayList&lt;&gt;();ï¼ï¼å³ä½¿åé¢ä¸åéè¦ï¼éåä»ææå¶å¼ç¨ï¼å¯¼è´æ æ³<strong>GC</strong>ã</p>
<p><strong>2ãæªå³é­çèµæº</strong></p>
<p>è¿æ¥ãæµç­èµæºæªè°ç¨<strong> close() </strong>æ¹æ³å³é­ãè¿äºèµæºä¸ä»å ç¨åå­ï¼è¿å¯è½å ç¨æä»¶å¥æï¼æä½ç³»ç»åéçå¯ä¸æ è¯ï¼å­å®ï¼ä½ æè½æä½æä»¶èµæºï¼ãç½ç»è¿æ¥ç­ç³»ç»èµæºãæ¯å¦&nbsp;æ°æ®åºè¿æ¥ãæä»¶æµï¼FileInputStreamï¼ãSocketè¿æ¥ ç­ã</p>
<pre class="language-java highlighter-hljs"><code>public class FileTest {
    public static void main(String[] args) {
        FileInputStream fis = null;
        try {
            fis = new FileInputStream("test.txt");
            // è¯»åæä»¶ï¼æªè°ç¨ fis.close()
        } catch (FileNotFoundException e) {
            e.printStackTrace();
        } finally {
            // æªè°ç¨ fis.close() â fis ææ Native å¼ç¨ï¼æ æ³åæ¶
        }
    }
}</code></pre>
<p><strong>3ãThreadLocal ä½¿ç¨ä¸å½</strong></p>
<p>å°å¯¹è±¡å­å¥ <strong>ThreadLocal </strong>åï¼æªå¨åç»­è°ç¨ <strong>remove()</strong> æ¸çãè¥çº¿ç¨æ¥èªçº¿ç¨æ± ï¼ä¼å¤ç¨ï¼ï¼å¶ ThreadLocalMap ä¸­çå¼ä¼ä¸ç´å­æ´»ã</p>
<pre class="language-java highlighter-hljs"><code>public class ThreadLocalTest {
    private static ThreadLocal&lt;User&gt; userThreadLocal = new ThreadLocal&lt;&gt;();

    public static void main(String[] args) {
        // çº¿ç¨æ± ï¼æ ¸å¿çº¿ç¨é¿æå­æ´»ï¼
        TThreadPoolExecutor executor = new ThreadPoolExecutor(
                2,
                4,
                10,
                TimeUnit.SECONDS,
                new ArrayBlockingQueue&lt;&gt;(100),
                new ThreadFactoryBuilder().setNameFormat("my-thread-pool-%d").setDaemon(false).setPriority(Thread.NORM_PRIORITY).build(),
                new ThreadPoolExecutor.AbortPolicy()
        );

        executor.submit(() -&gt; {
            User user = new User("æå", 30);
            userThreadLocal.set(user); // å­å¨å° ThreadLocal

            // ä¸å¡æ§è¡å®æ¯ï¼æªè°ç¨ remove()
            // æ ¸å¿çº¿ç¨ä¸ä¼éæ¯ï¼ThreadLocal ä»ææ user å¼ç¨
        });
    }
}</code></pre>
<p>psï¼æªè¿è¡&nbsp;<strong>remove()</strong>ï¼è¿å¯è½ä¼å¯¼è´&nbsp;<strong>ThreadLocal </strong>åå¼ä¸²é¨ã</p>
<p><strong>4ãåé¨ç±»ä¸å¤é¨ç±»å¼ç¨</strong></p>
<p>ééæåé¨ç±»ï¼æå¿åç±»ï¼ä¼&nbsp;<strong>éå¼ææ&nbsp;</strong>å¤é¨ç±»çå¼ç¨ãå¦æåé¨ç±»å®ä¾çå½å¨ææ´é¿ï¼å¦è¢«ç¼å­æå¦ä¸ä¸ªçº¿ç¨å¼ç¨ï¼ï¼ä¼é»æ­¢å¤é¨ç±»è¢«åæ¶ã</p>
<pre class="language-java highlighter-hljs"><code>public class OuterClass {
    private byte[] bigData = new byte[1024 * 1024 * 10]; // 10MB å¤§å¯¹è±¡

    // ééæåé¨ç±»
    class InnerClass {
        // åé¨ç±»éå¼ææ OuterClass å¼ç¨
    }

    public InnerClass createInner() {
        return new InnerClass();
    }

    public static void main(String[] args) {
        OuterClass outer = new OuterClass();
        InnerClass inner = outer.createInner();

        // ç½®ç©ºå¤é¨ç±»å¼ç¨ï¼ä½ inner ä»ææ outer å¼ç¨
        outer = null;

        // è¥ inner è¢«éæåé/çº¿ç¨é¿æææ â outer å¯¹è±¡ï¼å« bigDataï¼æ æ³åæ¶
    }
}</code></pre>
<p><strong>5ã&nbsp;çå¬å¨ä¸åè°</strong></p>
<p>æ³¨åäº <strong>çå¬å¨&nbsp;</strong>æ <strong>åè°</strong> åï¼å¨å¯¹è±¡ä¸åéè¦æ¶ <strong>æ²¡ææ³¨é</strong>ï¼å¯¼è´æºå¯¹è±¡ä»ææçå¬å¨çå¼ç¨ï¼æ¯å¦ äºä»¶çå¬å¨ãæ¶æ¯éåçæ¶è´¹èç­ï¼ã</p>
<p><strong>ææ¥å·¥å·æ¨è</strong></p>
<ul>
<li><strong>MATï¼Memory Analyzer Toolï¼ï¼</strong>åæå  Dump æä»¶ï¼å®ä½æ³æ¼å¯¹è±¡ãå¼ç¨é¾ï¼è°å¨æææ³æ¼å¯¹è±¡ï¼ï¼</li>
<li><strong>VisualVMï¼</strong>JDK èªå¸¦å·¥å·ï¼çæ§åå­å ç¨è¶å¿ï¼çæå  Dumpï¼ç®åææ¥æ³æ¼ã</li>
</ul>
<p>è¿éæåªåäºå¸¸è§çå ç§æåµï¼æ¬¢è¿å¤§å®¶è¡¥åå¶ä»åå­æ³æ¼åºæ¯ã</p>
<p style="text-align: right"><span style="color: rgba(53, 152, 219, 1)">äººé´éååï¼åæåç§æï¼ä¸è¬è¦ã-- çæ²ä¹æ´²</span></p>
</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2025-12-29 19:29">2025-12-29 19:29</span>&nbsp;
<a href="https://www.cnblogs.com/yanshajiuzhou">çæ²ä¹æ´²</a>&nbsp;
éè¯»(<span id="post_view_count">0</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19417793);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19417793', targetLink: 'https://www.cnblogs.com/yanshajiuzhou/p/19417793', title: 'Java åªäºæåµä¼å¯¼è´åå­æ³æ¼' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ MAFå¿«éå¥é¨ï¼9ï¼å¤è·¯åæ¯è·¯ç±å·¥ä½æµ ]]></title>
    <link>https://www.cnblogs.com/edisontalk/p/-/quick-start-on-maf-chatper09</link>
    <guid>8d879eeff0eec1c38a24a10052f718a0</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/edisontalk/p/-/quick-start-on-maf-chatper09" title="åå¸äº 2025-12-29 18:30">
    <span role="heading" aria-level="2">MAFå¿«éå¥é¨ï¼9ï¼å¤è·¯åæ¯è·¯ç±å·¥ä½æµ</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                    <div id="cnblogs_post_description" style="display: none">
        <img src="https://img2024.cnblogs.com/blog/381412/202512/381412-20251224203108188-1569801702.png" alt="MAFå¿«éå¥é¨ï¼9ï¼å¤è·¯åæ¯è·¯ç±å·¥ä½æµ" class="desc_img">
        ä¸ä¸ç¯ï¼æä»¬å­¦ä¹ äºMAFä¸­å¦ä½è¿è¡if-elseç±»åçæ¡ä»¶è·¯ç±ï¼ä½æ¯å®éå·¥ä½ä¸­å¯è½ä¼æä¸­å¤ä¸ªåæ¯è·¯ç±çåºæ¯ãå¨å®éä¸å¡åºæ¯ä¸­ï¼å¾å¤çä¸å¡é»è¾æ¶åå°ä¸æ­¢ä¸¤ä¸ªå¤æ­æ¡ä»¶ï¼èæ¯å¤ä¸ªãå¨MAFä¸­ï¼æä»¬å¯ä»¥ä½¿ç¨ Switch-Case æ¥å®ç°è¿ç§å·¥ä½æµåé¨å¤ç±»å³ç­æ¡ä»¶ç å·¥ä½æµéæ±ã
    </div>
<div id="cnblogs_post_body" class="blogpost-body blogpost-body-html">
<p><span><span>å¤§å®¶å¥½ï¼ææ¯Edisonã</span></span></p>
<p><span><span>æè¿æä¸ç´å¨è·çå£æ°çã<a class="normal_text_link mp_article_text_link" href="https://www.cnblogs.com/sheng-jie/p/19200934" target="_blank" data-itemshowtype="0" data-linktype="2"><span>.NET+AIæºè½ä½å¼åè¿é¶</span></a><span>ãè¯¾ç¨å­¦ä¹ MAFçå¼åæå·§ï¼æå¼ºçæ¨èä½ ä¹ä¸è½¦è·æä¸èµ·åºåï¼</span></span></span></p>
<p><span><a class="normal_text_link mp_article_text_link" href="https://www.cnblogs.com/edisontalk/p/-/quick-start-on-maf-chatper08" target="_blank" data-itemshowtype="0" data-linktype="2"><span>ä¸ä¸ç¯</span></a><span>ï¼æä»¬å­¦ä¹ äºMAFä¸­å¦ä½è¿è¡if-elseç±»åçæ¡ä»¶è·¯ç±<span>ï¼ä½æ¯å®éå·¥ä½ä¸­å¯è½ä¼å­å¨å¤ä¸ªåæ¯è·¯ç±çåºæ¯ãæ¬ç¯ï¼æä»¬æ¥äºè§£ä¸MAFä¸­çswitch-caseè·¯ç±å®ç°å¤åæ¯è·¯ç±å·¥ä½æµã</span></span></span></p>
<h1><strong>Why switch-case?</strong></h1>
<p><span><span><span><span data-pm-slice="0 0 []"><span><span>å¨å®éä¸å¡åºæ¯ä¸­ï¼å¾å¤çä¸å¡é»è¾æ¶åå°ä¸æ­¢ä¸¤ä¸ªå¤æ­æ¡ä»¶ï¼èæ¯å¤ä¸ª<span>ã</span></span></span></span></span></span></span></p>
<p><span><span><span><span data-pm-slice="0 0 []"><span><span><span>ä¾å¦ï¼å¨ä¸ä¸ç¯çä¼ä¸åé¨é®ä»¶æ£æµæ¡ä¾ä¸­ï¼æä»¬çæ£æµç»æåªæä¸¤ä¸ªï¼åå¾é®ä»¶ æ æ­£å¸¸é®ä»¶ï¼ï¼ä½å¦ææä»¬æ³å¢å ä¸ä¸ªç»æï¼ä¸ç¡®å®ï¼å°±æ æ³éç¨äºã</span></span></span></span></span></span></span></p>
<p><span><span><span><span data-pm-slice="0 0 []"><span data-pm-slice="0 0 []"><span><span>å¨MAFä¸­ï¼æä»¬å¯ä»¥ä½¿ç¨ Switch-Case æ¥å®ç°è¿ç§å·¥ä½æµåé¨å¤ç±»å³ç­æ¡ä»¶ç å·¥ä½æµéæ±<span>ã</span></span></span></span></span></span></span></span></p>
<h1><strong>å®éªæ¡ä¾</strong></h1>
<p><span><span><span><span data-pm-slice="0 0 []"><span><span><span><span>ä»å¤©æ¥æä¸ä¸ä¸ç¯è¿ä¸ªä¼ä¸åé¨é®ä»¶æ£æµçå·¥ä½æµæ¡ä¾ï¼ä¸ä¸ç¯çæµç¨æ¯è¿æ ·çï¼</span></span></span></span></span></span></span></span></p>
<p><img src="https://img2024.cnblogs.com/blog/381412/202512/381412-20251224202006911-1817307092.png" alt="image" loading="lazy" style="display: block; margin-left: auto; margin-right: auto"></p>
<p><span><span><span><span data-pm-slice="0 0 []"><span><span><span><span><span><span>ä»å¤©åè®¾æä»¬éè¦ææ´ä¸ºç²¾ç»çåç±»ï¼</span></span></span></span></span></span></span></span></span></span></p>
<p data-pm-slice="0 0 []"><span><span>&nbsp; â&nbsp;<span><span>**æ­£å¸¸é®ä»¶**<span><span>ï¼NotSpamï¼ï¼å®¢æ·å¨è¯¢ãä¸å¡å¾æ¥</span></span></span></span></span></span></p>
<p><span><span>&nbsp; â&nbsp;<span><span>**åå¾é®ä»¶**<span><span>ï¼Spamï¼ï¼ææ¾çè¯éªãå¹¿å</span></span></span></span></span></span></p>
<p><span><span>&nbsp;&nbsp;<span><span>â ï¸&nbsp;<span><span>**ä¸ç¡®å®é®ä»¶**<span><span>ï¼Uncertainï¼ï¼å¯è½æ¯éé±¼é®ä»¶ï¼éè¦äººå·¥å®¡æ ¸</span></span></span></span></span></span></span></span></p>
<p><span><span><span><span data-pm-slice="0 0 []"><span><span><span><span><span data-pm-slice="1 1 [&quot;para&quot;,{&quot;tagName&quot;:&quot;section&quot;,&quot;attributes&quot;:{&quot;style&quot;:&quot;margin: 8px;text-align: left;&quot;},&quot;namespaceURI&quot;:&quot;http://www.w3.org/1999/xhtml&quot;}]"><span>é£ä¹è¿å°±æ¯ä¸ä¸ªä¸ååç±»çï¼å¨ä¸å¡å¼åä¸­æä»¬éå¸¸ä¼ç¨å°switch-caseè¯­æ³ï¼èå¨MAFå·¥ä½æµä¸­ï¼ä¹ä¸ºæä»¬å®ä¹äºè¿ç§switch-caseæ¥å£ã</span></span></span></span></span></span></span></span></span></span></p>
<p><span><span><span><span data-pm-slice="0 0 []"><span><span><span><span><span data-pm-slice="1 1 [&quot;para&quot;,{&quot;tagName&quot;:&quot;section&quot;,&quot;attributes&quot;:{&quot;style&quot;:&quot;margin: 8px;text-align: left;&quot;},&quot;namespaceURI&quot;:&quot;http://www.w3.org/1999/xhtml&quot;}]"><span>å¨ä¸é¢çä»£ç ç¤ºä¾ä¸­ï¼æ¯å¯¹äºä¸¤ç§æ¥å£çä½¿ç¨æ¹å¼ï¼</span></span></span></span></span></span></span></span></span></span></p>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> Conditional Edge</span>
<span style="color: rgba(0, 0, 0, 1)">builder
    .AddEdge(source, target1, condition: c </span>=&gt; c.IsSpam == <span style="color: rgba(0, 0, 255, 1)">false</span><span style="color: rgba(0, 0, 0, 1)">)
    .AddEdge(source, target2, condition: c </span>=&gt; c.IsSpam == <span style="color: rgba(0, 0, 255, 1)">true</span><span style="color: rgba(0, 0, 0, 1)">);
</span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> Switch-Case</span>
builder.AddSwitch(source, sb =&gt;<span style="color: rgba(0, 0, 0, 1)"> sb
    .AddCase(c </span>=&gt; c.Decision ==<span style="color: rgba(0, 0, 0, 1)"> NotSpam, target1)
    .AddCase(c </span>=&gt; c.Decision ==<span style="color: rgba(0, 0, 0, 1)"> Spam, target2)
    .WithDefault(target3)
);</span></pre>
</div>
<p><span><span><span><span data-pm-slice="0 0 []"><span><span><span><span><span data-pm-slice="1 1 [&quot;para&quot;,{&quot;tagName&quot;:&quot;section&quot;,&quot;attributes&quot;:{&quot;style&quot;:&quot;margin: 8px;text-align: left;&quot;},&quot;namespaceURI&quot;:&quot;http://www.w3.org/1999/xhtml&quot;}]"><span><span data-pm-slice="1 1 [&quot;para&quot;,{&quot;tagName&quot;:&quot;section&quot;,&quot;attributes&quot;:{&quot;style&quot;:&quot;margin: 8px;text-align: left;&quot;},&quot;namespaceURI&quot;:&quot;http://www.w3.org/1999/xhtml&quot;}]"><span>å¯ä»¥çå°ï¼switch-caseæ¨¡å¼å¶ä»·å¼ä¸»è¦å¨äºå¢å¼ºä»£ç å¯ç»´æ¤æ§ï¼å¯¹äºåç»­å¦æææ°å¢åç±»ï¼åªéè¦æ·»å ä¸ä¸ªAddCaseæ¥å£æ¹æ³å®ç°æ°å¢åç±»çå¤çï¼åæ¶åºäºWithDefaultæ¥å£æ¹æ³å®ç°ååºç¡®ä¿æææåµé½æå¤çã</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p><span><span><span><span data-pm-slice="0 0 []"><span><span><span><span><span data-pm-slice="1 1 [&quot;para&quot;,{&quot;tagName&quot;:&quot;section&quot;,&quot;attributes&quot;:{&quot;style&quot;:&quot;margin: 8px;text-align: left;&quot;},&quot;namespaceURI&quot;:&quot;http://www.w3.org/1999/xhtml&quot;}]"><span><span data-pm-slice="1 1 [&quot;para&quot;,{&quot;tagName&quot;:&quot;section&quot;,&quot;attributes&quot;:{&quot;style&quot;:&quot;margin: 8px;text-align: left;&quot;},&quot;namespaceURI&quot;:&quot;http://www.w3.org/1999/xhtml&quot;}]"><span>æåï¼ä¸é¢æ¯æä»¬éè¦éæåçåæ¯è·¯ç±å¾ï¼</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p><img src="https://img2024.cnblogs.com/blog/381412/202512/381412-20251224202047038-2027515638.png" alt="image" loading="lazy" style="display: block; margin-left: auto; margin-right: auto"></p>
<h1><strong>åå¤å·¥ä½</strong></h1>
<p><span><span><span><span data-pm-slice="0 0 []"><span><span><span><span><span data-pm-slice="1 1 [&quot;para&quot;,{&quot;tagName&quot;:&quot;section&quot;,&quot;attributes&quot;:{&quot;style&quot;:&quot;margin: 8px;text-align: left;&quot;},&quot;namespaceURI&quot;:&quot;http://www.w3.org/1999/xhtml&quot;}]"><span><span data-pm-slice="1 1 [&quot;para&quot;,{&quot;tagName&quot;:&quot;section&quot;,&quot;attributes&quot;:{&quot;style&quot;:&quot;margin: 8px;text-align: left;&quot;},&quot;namespaceURI&quot;:&quot;http://www.w3.org/1999/xhtml&quot;}]"><span><span>å¨ä»å¤©çè¿ä¸ªæ¡ä¾ä¸­ï¼æä»¬ä»ç¶åå»ºäºä¸ä¸ª.NETæ§å¶å°åºç¨ç¨åºï¼å®è£äºä»¥ä¸NuGetåï¼</span></span></span></span></span></span></span></span></span></span></span></span></span></p>
<ul class="list-paddingleft-1">
<li><span>Microsoft.Agents.AI.OpenAI</span></li>
<li><span>Microsoft.Agents.AI.Workflows</span></li>
<li><span>Microsoft.Extensions.AI.OpenAI</span></li>
</ul>
<p><span><span><span><span data-pm-slice="0 0 []"><span><span><span><span><span data-pm-slice="1 1 [&quot;para&quot;,{&quot;tagName&quot;:&quot;section&quot;,&quot;attributes&quot;:{&quot;style&quot;:&quot;margin: 8px;text-align: left;&quot;},&quot;namespaceURI&quot;:&quot;http://www.w3.org/1999/xhtml&quot;}]"><span><span data-pm-slice="1 1 [&quot;para&quot;,{&quot;tagName&quot;:&quot;section&quot;,&quot;attributes&quot;:{&quot;style&quot;:&quot;margin: 8px;text-align: left;&quot;},&quot;namespaceURI&quot;:&quot;http://www.w3.org/1999/xhtml&quot;}]"><span><span>æä»¬çéç½®æä»¶ä¸­å®ä¹äºLLM APIçä¿¡æ¯ï¼</span></span></span></span></span></span></span></span></span></span></span></span></span></p>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 0, 1)">{
  </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">OpenAI</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">: {
    </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">EndPoint</span><span style="color: rgba(128, 0, 0, 1)">"</span>: <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">https://api.siliconflow.cn</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">,
    </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">ApiKey</span><span style="color: rgba(128, 0, 0, 1)">"</span>: <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">******************************</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">,
    </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">ModelId</span><span style="color: rgba(128, 0, 0, 1)">"</span>: <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Qwen/Qwen3-30B-A3B-Instruct-2507</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">
  }
}</span></pre>
</div>
<p><span><span><span><span data-pm-slice="0 0 []"><span><span><span><span><span data-pm-slice="1 1 [&quot;para&quot;,{&quot;tagName&quot;:&quot;section&quot;,&quot;attributes&quot;:{&quot;style&quot;:&quot;margin: 8px;text-align: left;&quot;},&quot;namespaceURI&quot;:&quot;http://www.w3.org/1999/xhtml&quot;}]"><span><span data-pm-slice="1 1 [&quot;para&quot;,{&quot;tagName&quot;:&quot;section&quot;,&quot;attributes&quot;:{&quot;style&quot;:&quot;margin: 8px;text-align: left;&quot;},&quot;namespaceURI&quot;:&quot;http://www.w3.org/1999/xhtml&quot;}]"><span><span><span data-pm-slice="0 0 []"><span data-pm-slice="0 0 []"><span>è¿éæä»¬ä½¿ç¨ SiliconCloud æä¾<span><span>ç<span><span>&nbsp;<span><span>Qwen/Qwen3-30B-A3B-Instruct-2507&nbsp;<span><span>æ¨¡åï¼ä½ <span><span>å¯ä»¥éè¿è¿ä¸ªURLæ³¨åè´¦å·ï¼<span><span><a href="https://cloud.siliconflow.cn/i/DomqCefW" target="_blank" rel="noopener nofollow">https://cloud.siliconflow.cn/i/DomqCefW</a><span>&nbsp;è·åå¤§éåè´¹çTokenæ¥è¿è¡æ¬æ¬¡å®éªã</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></p>
<p><span><span><span><span data-pm-slice="0 0 []"><span><span><span><span><span data-pm-slice="1 1 [&quot;para&quot;,{&quot;tagName&quot;:&quot;section&quot;,&quot;attributes&quot;:{&quot;style&quot;:&quot;margin: 8px;text-align: left;&quot;},&quot;namespaceURI&quot;:&quot;http://www.w3.org/1999/xhtml&quot;}]"><span><span data-pm-slice="1 1 [&quot;para&quot;,{&quot;tagName&quot;:&quot;section&quot;,&quot;attributes&quot;:{&quot;style&quot;:&quot;margin: 8px;text-align: left;&quot;},&quot;namespaceURI&quot;:&quot;http://www.w3.org/1999/xhtml&quot;}]"><span><span><span data-pm-slice="0 0 []"><span><span>ç¶åï¼æä»¬å°éç½®æä»¶ä¸­çAPIä¿¡æ¯è¯»ååºæ¥ï¼</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></p>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 255, 1)">var</span> config = <span style="color: rgba(0, 0, 255, 1)">new</span><span style="color: rgba(0, 0, 0, 1)"> ConfigurationBuilder()
    .AddJsonFile($</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">appsettings.json</span><span style="color: rgba(128, 0, 0, 1)">"</span>, optional: <span style="color: rgba(0, 0, 255, 1)">false</span>, reloadOnChange: <span style="color: rgba(0, 0, 255, 1)">true</span><span style="color: rgba(0, 0, 0, 1)">)
    .Build();
</span><span style="color: rgba(0, 0, 255, 1)">var</span> openAIProvider = config.GetSection(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">OpenAI</span><span style="color: rgba(128, 0, 0, 1)">"</span>).Get&lt;OpenAIProvider&gt;();</pre>
</div>
<h2><span>å®ä¹æ°æ®ä¼ è¾æ¨¡å</span></h2>
<p><span><span>é¦åï¼æä»¬å®ä¹ä¸ä¸å¨è¿ä¸ªå·¥ä½æµä¸­éè¦çæä¼ éçæ°æ®æ¨¡åï¼</span></span></p>
<p><span><span>ï¼1ï¼DetectionResult ï¼æä»¶é®ä»¶æ£æµç»æ</span></span></p>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 255, 1)">public</span> <span style="color: rgba(0, 0, 255, 1)">sealed</span> <span style="color: rgba(0, 0, 255, 1)">class</span><span style="color: rgba(0, 0, 0, 1)"> DetectionResult
{
    </span><span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;summary&gt;</span>
    <span style="color: rgba(128, 128, 128, 1)">///</span><span style="color: rgba(0, 128, 0, 1)"> æ£æµå³ç­ï¼NotSpam / Spam / Uncertainï¼
    </span><span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;/summary&gt;</span>
    [JsonPropertyName(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">spam_decision</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)]
    [JsonConverter(</span><span style="color: rgba(0, 0, 255, 1)">typeof</span>(JsonStringEnumConverter))]  <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> JSON åºååä¸ºå­ç¬¦ä¸²</span>
    <span style="color: rgba(0, 0, 255, 1)">public</span> SpamDecision spamDecision { <span style="color: rgba(0, 0, 255, 1)">get</span>; <span style="color: rgba(0, 0, 255, 1)">set</span><span style="color: rgba(0, 0, 0, 1)">; }
    </span><span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;summary&gt;</span>
    <span style="color: rgba(128, 128, 128, 1)">///</span><span style="color: rgba(0, 128, 0, 1)"> å¤å®çç±ï¼ç¨äºå®¡è®¡åè°è¯ï¼
    </span><span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;/summary&gt;</span>
    [JsonPropertyName(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">reason</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)]
    </span><span style="color: rgba(0, 0, 255, 1)">public</span> <span style="color: rgba(0, 0, 255, 1)">string</span> Reason { <span style="color: rgba(0, 0, 255, 1)">get</span>; <span style="color: rgba(0, 0, 255, 1)">set</span>; } = <span style="color: rgba(0, 0, 255, 1)">string</span><span style="color: rgba(0, 0, 0, 1)">.Empty;
    </span><span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;summary&gt;</span>
    <span style="color: rgba(128, 128, 128, 1)">///</span><span style="color: rgba(0, 128, 0, 1)"> é®ä»¶IDï¼ç¨äºå³è Shared State ä¸­çåå§åå®¹ï¼
    </span><span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;/summary&gt;</span>
<span style="color: rgba(0, 0, 0, 1)">    [JsonIgnore]
    </span><span style="color: rgba(0, 0, 255, 1)">public</span> <span style="color: rgba(0, 0, 255, 1)">string</span> EmailId { <span style="color: rgba(0, 0, 255, 1)">get</span>; <span style="color: rgba(0, 0, 255, 1)">set</span>; } = <span style="color: rgba(0, 0, 255, 1)">string</span><span style="color: rgba(0, 0, 0, 1)">.Empty;
}

</span><span style="color: rgba(0, 0, 255, 1)">public</span> <span style="color: rgba(0, 0, 255, 1)">enum</span><span style="color: rgba(0, 0, 0, 1)"> SpamDecision
{
    Spam,        </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> åå¾é®ä»¶</span>
    NotSpam, <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> æ­£å¸¸é®ä»¶</span>
    UnCertain <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> æ æ³ç¡®å®ï¼éè¦äººå·¥å®¡æ ¸ï¼</span>
}</pre>
</div>
<p><span><span>ï¼2ï¼EmailStateConstants ï¼å¸¸éï¼ç±»ä¼¼äºCache Keyçä½ç¨ï¼åèä¸ä¸ç¯åå®¢åå®¹ã</span></span></p>
<p><span><span><span><span data-pm-slice="0 0 []"><span><span><span><span><span data-pm-slice="1 1 [&quot;para&quot;,{&quot;tagName&quot;:&quot;section&quot;,&quot;attributes&quot;:{&quot;style&quot;:&quot;margin: 8px;text-align: left;&quot;},&quot;namespaceURI&quot;:&quot;http://www.w3.org/1999/xhtml&quot;}]"><span><span data-pm-slice="1 1 [&quot;para&quot;,{&quot;tagName&quot;:&quot;section&quot;,&quot;attributes&quot;:{&quot;style&quot;:&quot;margin: 8px;text-align: left;&quot;},&quot;namespaceURI&quot;:&quot;http://www.w3.org/1999/xhtml&quot;}]"><span><span><span data-pm-slice="0 0 []"><span><span>ï¼3ï¼EmailMessage &amp; EmailResponse ï¼DTOä½ç¨ï¼åèä¸ä¸ç¯åå®¢åå®¹ã</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></p>
<h2><span>å¥å£èç¹ï¼åå¾é®ä»¶æ£æµExecutor</span></h2>
<p><span data-pm-slice="0 0 []"><span data-pm-slice="1 1 [&quot;para&quot;,{&quot;tagName&quot;:&quot;section&quot;,&quot;attributes&quot;:{&quot;style&quot;:&quot;margin: 8px;text-align: left;&quot;},&quot;namespaceURI&quot;:&quot;http://www.w3.org/1999/xhtml&quot;}]"><span data-pm-slice="1 1 [&quot;para&quot;,{&quot;tagName&quot;:&quot;section&quot;,&quot;attributes&quot;:{&quot;style&quot;:&quot;margin: 8px;text-align: left;&quot;},&quot;namespaceURI&quot;:&quot;http://www.w3.org/1999/xhtml&quot;}]"><span data-pm-slice="0 0 []">è¿ä¸ªåå¾é®ä»¶æ£æµæ¯æ¬æµç¨çæ ¸å¿èç¹ï¼è¿æ¬¡æä»¬å°å¶éæä¸ºæ¯æä¸åç±»ï¼</span></span></span></span></p>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 255, 1)">internal</span> <span style="color: rgba(0, 0, 255, 1)">sealed</span> <span style="color: rgba(0, 0, 255, 1)">class</span> SpamDetectionExecutor : Executor&lt;ChatMessage, DetectionResult&gt;<span style="color: rgba(0, 0, 0, 1)">
{
    </span><span style="color: rgba(0, 0, 255, 1)">private</span> <span style="color: rgba(0, 0, 255, 1)">readonly</span><span style="color: rgba(0, 0, 0, 1)"> AIAgent _agent;
    </span><span style="color: rgba(0, 0, 255, 1)">private</span> <span style="color: rgba(0, 0, 255, 1)">readonly</span><span style="color: rgba(0, 0, 0, 1)"> AgentThread _thread;
    </span><span style="color: rgba(0, 0, 255, 1)">public</span> SpamDetectionExecutor(AIAgent agent) : <span style="color: rgba(0, 0, 255, 1)">base</span>(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">SpamDetectionExecutor</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
    {
        </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> åå»º Agent åå¯¹è¯çº¿ç¨</span>
        <span style="color: rgba(0, 0, 255, 1)">this</span>._agent =<span style="color: rgba(0, 0, 0, 1)"> agent;
        </span><span style="color: rgba(0, 0, 255, 1)">this</span>._thread = <span style="color: rgba(0, 0, 255, 1)">this</span><span style="color: rgba(0, 0, 0, 1)">._agent.GetNewThread();
    }
    </span><span style="color: rgba(0, 0, 255, 1)">public</span> <span style="color: rgba(0, 0, 255, 1)">override</span> <span style="color: rgba(0, 0, 255, 1)">async</span> ValueTask&lt;DetectionResult&gt; HandleAsync(ChatMessage message, IWorkflowContext context, CancellationToken cancellationToken = <span style="color: rgba(0, 0, 255, 1)">default</span><span style="color: rgba(0, 0, 0, 1)">)
    {
        </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> 1ï¸â£ çæå¯ä¸é®ä»¶IDå¹¶ä¿å­åå®¹å° Shared State</span>
        <span style="color: rgba(0, 0, 255, 1)">var</span> trackedEmail = <span style="color: rgba(0, 0, 255, 1)">new</span><span style="color: rgba(0, 0, 0, 1)"> EmailMessage
        {
            EmailId </span>= Guid.NewGuid().ToString(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">N</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">),
            EmailContent </span>=<span style="color: rgba(0, 0, 0, 1)"> message.Text
        };
        </span><span style="color: rgba(0, 0, 255, 1)">await</span><span style="color: rgba(0, 0, 0, 1)"> context.QueueStateUpdateAsync(
            trackedEmail.EmailId,
            trackedEmail,
            scopeName: EmailStateConstants.EmailStateScope,
            cancellationToken
        );
        </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> 2ï¸â£ è°ç¨ AI Agent è¿è¡ä¸åç±»æ£æµ</span>
        <span style="color: rgba(0, 0, 255, 1)">var</span> agentResponse = <span style="color: rgba(0, 0, 255, 1)">await</span><span style="color: rgba(0, 0, 0, 1)"> _agent.RunAsync(
            message,
            _thread,
            cancellationToken: cancellationToken
        );
        </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> 3ï¸â£ è§£æç»æåè¾åº</span>
        <span style="color: rgba(0, 0, 255, 1)">var</span> detection = JsonSerializer.Deserialize&lt;DetectionResult&gt;<span style="color: rgba(0, 0, 0, 1)">(agentResponse.Text)
            </span>?? <span style="color: rgba(0, 0, 255, 1)">throw</span> <span style="color: rgba(0, 0, 255, 1)">new</span> InvalidOperationException(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">æ æ³è§£æ Spam Detection ååº</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">);
        </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> 4ï¸â£ å³è EmailIdï¼ä¾ä¸æ¸¸ Executor æ¥æ¾åå§åå®¹ï¼</span>
        detection.EmailId =<span style="color: rgba(0, 0, 0, 1)"> trackedEmail.EmailId;
        </span><span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)"> detection;
    }
}</span></pre>
</div>
<p>å¨è¿ä¸ªExecutorä¸­ï¼å®æ¥æ¶æä»¬å¦ä¸æç¤ºå®ä¹å¥½çAgentæ¥å®ç°ï¼</p>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 255, 1)">var</span> spamDetectionAgent = <span style="color: rgba(0, 0, 255, 1)">new</span><span style="color: rgba(0, 0, 0, 1)"> ChatClientAgent(
    chatClient,
    </span><span style="color: rgba(0, 0, 255, 1)">new</span><span style="color: rgba(0, 0, 0, 1)"> ChatClientAgentOptions(
        instructions: </span><span style="color: rgba(128, 0, 0, 1)">@"</span><span style="color: rgba(128, 0, 0, 1)">ä½ æ¯ä¸ä¸ªåå¾é®ä»¶æ£æµå©æãå¤å®è§åï¼
- NotSpam: ææ¾çæ­£å¸¸ä¸å¡é®ä»¶ï¼è®¢åæ¥è¯¢ãå®åå¨è¯¢ç­ï¼
- Spam: ææ¾çåå¾é®ä»¶ï¼è¯éªãå¹¿åãéé±¼ï¼
- Uncertain: æ æ³æç¡®å¤æ­ï¼åå«å¯çåç´ ä½ä¸ç¡®å®ï¼å¦å«å¯çé¾æ¥ä½åå®¹æ¨¡ç³ï¼
å¯¹äºæ¨¡æ£±ä¸¤å¯çæåµï¼å¾åäºæ è®°ä¸º Uncertain ä»¥ä¿è¯å®å¨ã</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">
    )
    {
        ChatOptions </span>= <span style="color: rgba(0, 0, 255, 1)">new</span><span style="color: rgba(0, 0, 0, 1)"> ChatOptions
        {
            ResponseFormat </span>= ChatResponseFormat.ForJsonSchema&lt;DetectionResult&gt;<span style="color: rgba(0, 0, 0, 1)">()
        }
    }
);</span></pre>
</div>
<p>å¨ChatOptionsä¸­æå®äºè¯¥Agentè¿åçæ¶æ¯éè¦è¿è¡åºååå°å¼ºç±»åï¼ä¾¿äºåç»­éè¿å¼ºç±»åæ°æ®è¿è¡å³ç­è·¯ç±ã</p>
<h2 data-pm-slice="2 3 []"><span>ä¸æ¸¸èç¹Aï¼æ­£å¸¸é®ä»¶å¤ç+åé</span></h2>
<p>è¿éæä»¬éå¯¹è¯å«å°çæ­£å¸¸é®ä»¶å¼åä¸¤ä¸ªæ§è¡å¨ï¼åè®¾å¶ç¨äºé®ä»¶å¤åè½¬åï¼</p>
<h3>é®ä»¶å¤çï¼è¯»åå±äº«ç¶æåºçåæï¼ç¶åè°ç¨Agentè¾åºJSONåå¤ã</h3>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 255, 1)">internal</span> <span style="color: rgba(0, 0, 255, 1)">sealed</span> <span style="color: rgba(0, 0, 255, 1)">class</span> EmailAssistantExecutor : Executor&lt;DetectionResult, EmailResponse&gt;<span style="color: rgba(0, 0, 0, 1)">
{
    </span><span style="color: rgba(0, 0, 255, 1)">private</span> <span style="color: rgba(0, 0, 255, 1)">readonly</span><span style="color: rgba(0, 0, 0, 1)"> AIAgent _agent;
    </span><span style="color: rgba(0, 0, 255, 1)">private</span> <span style="color: rgba(0, 0, 255, 1)">readonly</span><span style="color: rgba(0, 0, 0, 1)"> AgentThread _thread;

    </span><span style="color: rgba(0, 0, 255, 1)">public</span> EmailAssistantExecutor(AIAgent agent) : <span style="color: rgba(0, 0, 255, 1)">base</span>(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">EmailAssistantExecutor</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
    {
        </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> åå»º Agent åå¯¹è¯çº¿ç¨</span>
        <span style="color: rgba(0, 0, 255, 1)">this</span>._agent =<span style="color: rgba(0, 0, 0, 1)"> agent;
        </span><span style="color: rgba(0, 0, 255, 1)">this</span>._thread = <span style="color: rgba(0, 0, 255, 1)">this</span><span style="color: rgba(0, 0, 0, 1)">._agent.GetNewThread();
    }

    </span><span style="color: rgba(0, 0, 255, 1)">public</span> <span style="color: rgba(0, 0, 255, 1)">override</span> <span style="color: rgba(0, 0, 255, 1)">async</span> ValueTask&lt;EmailResponse&gt; HandleAsync(DetectionResult message, IWorkflowContext context, CancellationToken cancellationToken = <span style="color: rgba(0, 0, 255, 1)">default</span><span style="color: rgba(0, 0, 0, 1)">)
    {
        </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> ð¡ï¸ é²å¾¡æ§æ£æ¥ï¼ç¡®ä¿åªå¤çæ­£å¸¸é®ä»¶</span>
        <span style="color: rgba(0, 0, 255, 1)">if</span> (message.spamDecision ==<span style="color: rgba(0, 0, 0, 1)"> SpamDecision.Spam)
            </span><span style="color: rgba(0, 0, 255, 1)">throw</span> <span style="color: rgba(0, 0, 255, 1)">new</span><span style="color: rgba(0, 0, 0, 1)"> InvalidOperationException(
                </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">EmailAssistantExecutor ä¸åºå¤çåå¾é®ä»¶ï¼è¯·æ£æ¥è·¯ç±éç½®ã</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">
            );

        </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> 1ï¸â£ ä» Shared State è¯»ååå§é®ä»¶åå®¹</span>
        <span style="color: rgba(0, 0, 255, 1)">var</span> email = <span style="color: rgba(0, 0, 255, 1)">await</span> context.ReadStateAsync&lt;EmailMessage&gt;<span style="color: rgba(0, 0, 0, 1)">(
            message.EmailId,
            scopeName: EmailStateConstants.EmailStateScope,
            cancellationToken
        ) </span>?? <span style="color: rgba(0, 0, 255, 1)">throw</span> <span style="color: rgba(0, 0, 255, 1)">new</span> InvalidOperationException($<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">æ¾ä¸å° EmailId={message.EmailId} çé®ä»¶åå®¹</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">);

        </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> 2ï¸â£ è°ç¨ AI Agent çæåå¤</span>
        <span style="color: rgba(0, 0, 255, 1)">var</span> agentResponse = <span style="color: rgba(0, 0, 255, 1)">await</span><span style="color: rgba(0, 0, 0, 1)"> _agent.RunAsync(
            email.EmailContent,
            _thread,
            cancellationToken: cancellationToken
        );

        </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> 3ï¸â£ è§£æç»æåè¾åº</span>
        <span style="color: rgba(0, 0, 255, 1)">var</span> emailResponse = JsonSerializer.Deserialize&lt;EmailResponse&gt;<span style="color: rgba(0, 0, 0, 1)">(agentResponse.Text)
            </span>?? <span style="color: rgba(0, 0, 255, 1)">throw</span> <span style="color: rgba(0, 0, 255, 1)">new</span> InvalidOperationException(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">æ æ³è§£æ Email Assistant ååº</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">);

        </span><span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)"> emailResponse;
    }
}</span></pre>
</div>
<p>è¿éçAgentå®ä¹å¦ä¸ï¼</p>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 255, 1)">var</span> emailAssistantAgent = <span style="color: rgba(0, 0, 255, 1)">new</span><span style="color: rgba(0, 0, 0, 1)"> ChatClientAgent(
    chatClient,
    </span><span style="color: rgba(0, 0, 255, 1)">new</span><span style="color: rgba(0, 0, 0, 1)"> ChatClientAgentOptions(
        instructions: </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">ä½ æ¯ä¸ä¸ªä¼ä¸é®ä»¶å©æï¼ä¸ºå®¢æ·é®ä»¶çæä¸ä¸ãåå¥½çä¸­æåå¤ã</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">
    )
    {
        ChatOptions </span>= <span style="color: rgba(0, 0, 255, 1)">new</span><span style="color: rgba(0, 0, 0, 1)"> ChatOptions
        {
            ResponseFormat </span>= ChatResponseFormat.ForJsonSchema&lt;EmailResponse&gt;<span style="color: rgba(0, 0, 0, 1)">()
        }
    }
);</span></pre>
</div>
<h3><span data-pm-slice="1 1 [&quot;para&quot;,{&quot;tagName&quot;:&quot;section&quot;,&quot;attributes&quot;:{&quot;style&quot;:&quot;font-style: normal;font-variant-ligatures: normal;font-variant-caps: normal;text-transform: none;word-spacing: 0px;-webkit-text-stroke-width: 0px;white-space: normal;text-align: left;line-height: 1.75em;margin-bottom: 8px;margin-top: 8px;&quot;},&quot;namespaceURI&quot;:&quot;http://www.w3.org/1999/xhtml&quot;},&quot;node&quot;,{&quot;tagName&quot;:&quot;strong&quot;,&quot;attributes&quot;:{},&quot;namespaceURI&quot;:&quot;http://www.w3.org/1999/xhtml&quot;}]">é®ä»¶è½¬åï¼æ¨¡æé®ä»¶è½¬åå°å·ä½çå®¢æï¼è¿éä»ä»ä½¿ç¨YieldOutputAsyncå®æå·¥ä½æµè¾åºæ¶æ¯åå®¹ã</span></h3>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 255, 1)">internal</span> <span style="color: rgba(0, 0, 255, 1)">sealed</span> <span style="color: rgba(0, 0, 255, 1)">class</span> EmailSendingExecutor() : Executor&lt;EmailResponse&gt;(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">EmailSendingExecutor</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
{
    </span><span style="color: rgba(0, 0, 255, 1)">public</span> <span style="color: rgba(0, 0, 255, 1)">override</span> <span style="color: rgba(0, 0, 255, 1)">async</span> ValueTask HandleAsync(EmailResponse message, IWorkflowContext context, CancellationToken cancellationToken = <span style="color: rgba(0, 0, 255, 1)">default</span><span style="color: rgba(0, 0, 0, 1)">)
    {
        </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> æ¨¡æé®ä»¶åéï¼å®éé¡¹ç®ä¸­å¯è°ç¨ SMTPãSendGrid ç­æå¡ï¼</span>
        <span style="color: rgba(0, 0, 255, 1)">await</span><span style="color: rgba(0, 0, 0, 1)"> context.YieldOutputAsync(
            $</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">ð¤ é®ä»¶å·²åé: {message.Response}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">,
            cancellationToken
        );
    }
}</span></pre>
</div>
<h2 data-pm-slice="2 3 []"><span>ä¸æ¸¸èç¹Bï¼åå¾é®ä»¶å¤ç</span></h2>
<p>å½å¤æ­å°æ¯åå¾é®ä»¶æ¶ï¼è½¬äº¤ç»è¯¥æ§è¡å¨å¤çï¼è¿éæ¨¡æè¾åºäºä¸æ®µé£é©æç¤ºï¼å®éä¸­å¯è½æ¯ä¸æ¥äººå·¥è·è¿ç­ç­æä½ï¼</p>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 255, 1)">internal</span> <span style="color: rgba(0, 0, 255, 1)">sealed</span> <span style="color: rgba(0, 0, 255, 1)">class</span> SpamHandlingExecutor() : Executor&lt;DetectionResult&gt;(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">SpamHandlingExecutor</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
{
    </span><span style="color: rgba(0, 0, 255, 1)">public</span> <span style="color: rgba(0, 0, 255, 1)">override</span> <span style="color: rgba(0, 0, 255, 1)">async</span> ValueTask HandleAsync(DetectionResult message, IWorkflowContext context, CancellationToken cancellationToken = <span style="color: rgba(0, 0, 255, 1)">default</span><span style="color: rgba(0, 0, 0, 1)">)
    {
        </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> ð¡ï¸ é²å¾¡æ§æ£æ¥ï¼ç¡®ä¿åªå¤çåå¾é®ä»¶</span>
        <span style="color: rgba(0, 0, 255, 1)">if</span> (message.spamDecision !=<span style="color: rgba(0, 0, 0, 1)"> SpamDecision.Spam)
            </span><span style="color: rgba(0, 0, 255, 1)">throw</span> <span style="color: rgba(0, 0, 255, 1)">new</span><span style="color: rgba(0, 0, 0, 1)"> InvalidOperationException(
                </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">SpamHandlingExecutor åªåºå¤ç Spam ç±»åçé®ä»¶ï¼è¯·æ£æ¥è·¯ç±éç½®ã</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">
            );

        </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> è®°å½åå¾é®ä»¶ï¼å®éé¡¹ç®ä¸­å¯åå¥æ°æ®åºææ¥å¿ç³»ç»ï¼</span>
        <span style="color: rgba(0, 0, 255, 1)">await</span><span style="color: rgba(0, 0, 0, 1)"> context.YieldOutputAsync(
            $</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">ð« åå¾é®ä»¶å·²æ¦æª: {message.Reason}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">,
            cancellationToken
        );
    }
}</span></pre>
</div>
<h2 data-pm-slice="2 3 []"><span>ä¸æ¸¸èç¹Cï¼<span><span>ä¸ç¡®å®é®ä»¶å¤çæ§è¡å¨ï¼ååºå¤çï¼</span></span></span></h2>
<p>å½å¤æ­å°å±äºä¸ç¡®å®çé®ä»¶åç±»æ¶ï¼è½¬äº¤ç»è¯¥æ§è¡å¨åååºå¤ç æ é»è®¤å¤çï¼</p>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 255, 1)">internal</span> <span style="color: rgba(0, 0, 255, 1)">class</span> UncertainHandlingExecutor() : Executor&lt;DetectionResult&gt;(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">UncertainHandlingExecutor</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
{
    </span><span style="color: rgba(0, 0, 255, 1)">public</span> <span style="color: rgba(0, 0, 255, 1)">override</span> <span style="color: rgba(0, 0, 255, 1)">async</span><span style="color: rgba(0, 0, 0, 1)"> ValueTask HandleAsync(
        DetectionResult message,
        IWorkflowContext context,
        CancellationToken cancellationToken </span>= <span style="color: rgba(0, 0, 255, 1)">default</span><span style="color: rgba(0, 0, 0, 1)">)
    {
        </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> ð¡ï¸ é²å¾¡æ§æ£æ¥ï¼ç¡®ä¿åªå¤çä¸ç¡®å®é®ä»¶</span>
        <span style="color: rgba(0, 0, 255, 1)">if</span> (message.spamDecision !=<span style="color: rgba(0, 0, 0, 1)"> SpamDecision.UnCertain)
            </span><span style="color: rgba(0, 0, 255, 1)">throw</span> <span style="color: rgba(0, 0, 255, 1)">new</span><span style="color: rgba(0, 0, 0, 1)"> InvalidOperationException(
                </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">UncertainHandlingExecutor åªåºå¤ç Uncertain ç±»åçé®ä»¶ï¼æä½ä¸º Default Caseï¼ã</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">
            );

        </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> 1ï¸â£ ä» Shared State è¯»ååå§é®ä»¶åå®¹ï¼ç¨äºäººå·¥å®¡æ ¸ï¼</span>
        <span style="color: rgba(0, 0, 255, 1)">var</span> email = <span style="color: rgba(0, 0, 255, 1)">await</span> context.ReadStateAsync&lt;EmailMessage&gt;<span style="color: rgba(0, 0, 0, 1)">(
            message.EmailId,
            scopeName: EmailStateConstants.EmailStateScope,
            cancellationToken
        );

        </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> 2ï¸â£ è¾åºå¾å®¡æ ¸ä¿¡æ¯</span>
        <span style="color: rgba(0, 0, 255, 1)">await</span><span style="color: rgba(0, 0, 0, 1)"> context.YieldOutputAsync(
            $</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">â ï¸ ä¸ç¡®å®é®ä»¶éäººå·¥å®¡æ ¸:\n</span><span style="color: rgba(128, 0, 0, 1)">"</span> +<span style="color: rgba(0, 0, 0, 1)">
            $</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">åå : {message.Reason}\n</span><span style="color: rgba(128, 0, 0, 1)">"</span> +<span style="color: rgba(0, 0, 0, 1)">
            $</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">åå®¹é¢è§: {email?.EmailContent?.Substring(0, Math.Min(100, email.EmailContent.Length))}...</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">,
            cancellationToken
        );
    }
}</span></pre>
</div>
<h2>æå»ºå·¥ä½æµ</h2>
<p>ç°å¨ä¸äºä¿±å¤ï¼åªæ¬ ä¸ä¸ªWorkflowï¼ç°å¨Let's do it!</p>
<p><strong>Step1:</strong> è·åChatClient</p>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 255, 1)">var</span> chatClient = <span style="color: rgba(0, 0, 255, 1)">new</span><span style="color: rgba(0, 0, 0, 1)"> OpenAIClient(
        </span><span style="color: rgba(0, 0, 255, 1)">new</span><span style="color: rgba(0, 0, 0, 1)"> ApiKeyCredential(openAIProvider.ApiKey),
        </span><span style="color: rgba(0, 0, 255, 1)">new</span> OpenAIClientOptions { Endpoint = <span style="color: rgba(0, 0, 255, 1)">new</span><span style="color: rgba(0, 0, 0, 1)"> Uri(openAIProvider.Endpoint) })
    .GetChatClient(openAIProvider.ModelId)
    .AsIChatClient();</span></pre>
</div>
<p><strong><span><span>Step2<span>: </span></span></span></strong>å®ä¾åèªå®ä¹Agent &amp; Executors</p>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 255, 1)">var</span> spamDetectionExecutor = <span style="color: rgba(0, 0, 255, 1)">new</span><span style="color: rgba(0, 0, 0, 1)"> SpamDetectionExecutor(spamDetectionAgent);
</span><span style="color: rgba(0, 0, 255, 1)">var</span> emailAssistantExecutor = <span style="color: rgba(0, 0, 255, 1)">new</span><span style="color: rgba(0, 0, 0, 1)"> EmailAssistantExecutor(emailAssistantAgent);
</span><span style="color: rgba(0, 0, 255, 1)">var</span> sendEmailExecutor = <span style="color: rgba(0, 0, 255, 1)">new</span><span style="color: rgba(0, 0, 0, 1)"> EmailSendingExecutor();
</span><span style="color: rgba(0, 0, 255, 1)">var</span> handleSpamExecutor = <span style="color: rgba(0, 0, 255, 1)">new</span><span style="color: rgba(0, 0, 0, 1)"> SpamHandlingExecutor();
</span><span style="color: rgba(0, 0, 255, 1)">var</span> handleUncertainExecutor = <span style="color: rgba(0, 0, 255, 1)">new</span> UncertainHandlingExecutor();</pre>
</div>
<p><strong><span><span>Step3<span>: </span></span></span></strong>åå»ºswitch-caseå¤è·¯ç±å³ç­å·¥ä½æµ</p>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> âââââââââââââââââââââââââââââ
</span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> ð§ æ¡ä»¶å½æ°å·¥åæ¹æ³
</span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> âââââââââââââââââââââââââââââ</span>
Func&lt;<span style="color: rgba(0, 0, 255, 1)">object</span>?, <span style="color: rgba(0, 0, 255, 1)">bool</span>&gt; GetCondition(SpamDecision expectedDecision) =&gt;<span style="color: rgba(0, 0, 0, 1)">
    detectionResult </span>=&gt;<span style="color: rgba(0, 0, 0, 1)">
        detectionResult </span><span style="color: rgba(0, 0, 255, 1)">is</span> DetectionResult result &amp;&amp;<span style="color: rgba(0, 0, 0, 1)">
        result.spamDecision </span>==<span style="color: rgba(0, 0, 0, 1)"> expectedDecision;

</span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> âââââââââââââââââââââââââââââ
</span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> ð ä½¿ç¨ AddSwitch æå»º Switch-Case å·¥ä½æµ
</span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> âââââââââââââââââââââââââââââ</span>
<span style="color: rgba(0, 0, 255, 1)">var</span> builder = <span style="color: rgba(0, 0, 255, 1)">new</span><span style="color: rgba(0, 0, 0, 1)"> WorkflowBuilder(spamDetectionExecutor);
builder.AddSwitch(spamDetectionExecutor, sb </span>=&gt;<span style="color: rgba(0, 0, 0, 1)">
        sb
            </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> Case 1: NotSpam â EmailAssistant </span>
            .AddCase(GetCondition(expectedDecision: SpamDecision.NotSpam), <span style="color: rgba(0, 0, 255, 1)">new</span><span style="color: rgba(0, 0, 0, 1)">[] { (ExecutorBinding)emailAssistantExecutor })
            </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> Case 2: Spam â HandleSpam</span>
            .AddCase(GetCondition(expectedDecision: SpamDecision.Spam), <span style="color: rgba(0, 0, 255, 1)">new</span><span style="color: rgba(0, 0, 0, 1)">[] { (ExecutorBinding)handleSpamExecutor })
            </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> Default: Uncertain (æä»»ä½æªå¹éçæåµ) â HandleUncertain</span>
            .WithDefault(<span style="color: rgba(0, 0, 255, 1)">new</span><span style="color: rgba(0, 0, 0, 1)">[] { (ExecutorBinding)handleUncertainExecutor })
    )
    </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> EmailAssistant ä¹åèªå¨åéé®ä»¶</span>
<span style="color: rgba(0, 0, 0, 1)">    .AddEdge(emailAssistantExecutor, sendEmailExecutor)
    </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> éç½®è¾åºèç¹ï¼ä¸ä¸ªç»ç¹æ§è¡å¨é½ä¼äº§çè¾åºï¼</span>
<span style="color: rgba(0, 0, 0, 1)">    .WithOutputFrom(handleSpamExecutor, sendEmailExecutor, handleUncertainExecutor);
</span><span style="color: rgba(0, 0, 255, 1)">var</span> workflow =<span style="color: rgba(0, 0, 0, 1)"> builder.Build();

Console.OutputEncoding </span>=<span style="color: rgba(0, 0, 0, 1)"> Encoding.UTF8;
Console.WriteLine(</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">â Conditional Workflow æå»ºå®æ</span><span style="color: rgba(128, 0, 0, 1)">"</span>);</pre>
</div>
<h2>æµè¯å·¥ä½æµ</h2>
<p>é¦åï¼ä¸ºäºä¾¿äºåç»­æµè¯æä»¬å°æ§è¡å·¥ä½æµå°è£ä¸ºä¸ä¸ªéææ¹æ³ï¼</p>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 255, 1)">static</span> <span style="color: rgba(0, 0, 255, 1)">async</span><span style="color: rgba(0, 0, 0, 1)"> Task RunWorkflowAsync(
    Workflow workflow,
    </span><span style="color: rgba(0, 0, 255, 1)">string</span><span style="color: rgba(0, 0, 0, 1)"> scenarioName,
    </span><span style="color: rgba(0, 0, 255, 1)">string</span><span style="color: rgba(0, 0, 0, 1)"> emailContent)
{
    Console.WriteLine(</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">ââââââââââââââââââââââââââââââââ</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">);
    Console.WriteLine($</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">ð¬ æµè¯åºæ¯ï¼{scenarioName}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">);
    Console.WriteLine(</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">ââââââââââââââââââââââââââââââââ</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">);
    Console.WriteLine($</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">ð§ é®ä»¶åå®¹ï¼{emailContent.Substring(0, Math.Min(80, emailContent.Length))}...\n</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">);
    </span><span style="color: rgba(0, 0, 255, 1)">await</span> <span style="color: rgba(0, 0, 255, 1)">using</span> <span style="color: rgba(0, 0, 255, 1)">var</span> run = <span style="color: rgba(0, 0, 255, 1)">await</span><span style="color: rgba(0, 0, 0, 1)"> InProcessExecution.StreamAsync(
        workflow,
        </span><span style="color: rgba(0, 0, 255, 1)">new</span><span style="color: rgba(0, 0, 0, 1)"> ChatMessage(ChatRole.User, emailContent)
    );
    </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> åé Turn Tokenï¼å¯ç¨äºä»¶æ¨é</span>
    <span style="color: rgba(0, 0, 255, 1)">await</span> run.TrySendMessageAsync(<span style="color: rgba(0, 0, 255, 1)">new</span> TurnToken(emitEvents: <span style="color: rgba(0, 0, 255, 1)">true</span><span style="color: rgba(0, 0, 0, 1)">));
    </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> è®¢éäºä»¶æµ</span>
    <span style="color: rgba(0, 0, 255, 1)">await</span> <span style="color: rgba(0, 0, 255, 1)">foreach</span> (WorkflowEvent evt <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> run.WatchStreamAsync())
    {
        </span><span style="color: rgba(0, 0, 255, 1)">switch</span><span style="color: rgba(0, 0, 0, 1)"> (evt)
        {
            </span><span style="color: rgba(0, 0, 255, 1)">case</span><span style="color: rgba(0, 0, 0, 1)"> ExecutorCompletedEvent completedEvent:
                Console.WriteLine($</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">â {completedEvent.ExecutorId} å®æ</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">);
                </span><span style="color: rgba(0, 0, 255, 1)">break</span><span style="color: rgba(0, 0, 0, 1)">;
            </span><span style="color: rgba(0, 0, 255, 1)">case</span><span style="color: rgba(0, 0, 0, 1)"> WorkflowOutputEvent outputEvent:
                Console.WriteLine(</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">ââââââââââââââââââââââââââââââââââââââââââââââ</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">);
                Console.WriteLine(</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">ð å·¥ä½æµæ§è¡å®æ</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">);
                Console.WriteLine(</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">ââââââââââââââââââââââââââââââââââââââââââââââ\n</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">);
                Console.WriteLine($</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">{outputEvent.Data}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">);
                </span><span style="color: rgba(0, 0, 255, 1)">break</span><span style="color: rgba(0, 0, 0, 1)">;
            </span><span style="color: rgba(0, 0, 255, 1)">case</span><span style="color: rgba(0, 0, 0, 1)"> WorkflowErrorEvent errorEvent:
                Console.WriteLine(</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">â¨ æ¶å° Workflow Error Eventï¼</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">);
                Console.WriteLine($</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">{errorEvent.Data}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">);
                </span><span style="color: rgba(0, 0, 255, 1)">break</span><span style="color: rgba(0, 0, 0, 1)">;
            </span><span style="color: rgba(0, 0, 255, 1)">default</span><span style="color: rgba(0, 0, 0, 1)">:
                </span><span style="color: rgba(0, 0, 255, 1)">break</span><span style="color: rgba(0, 0, 0, 1)">;
        }
    }
    Console.WriteLine();
}</span></pre>
</div>
<p><strong>æµè¯ç¨ä¾1ï¼</strong>æ­£å¸¸å¨è¯¢é®ä»¶è¾å¥</p>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 255, 1)">var</span> scenarioName1 = <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">æ­£å¸¸é®ä»¶ â EmailAssistant â SendEmail</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">;
</span><span style="color: rgba(0, 0, 255, 1)">var</span> emailContent1 = <span style="color: rgba(128, 0, 0, 1)">@"</span><span style="color: rgba(128, 0, 0, 1)">
å°æ¬çå®¢æå¢éï¼
æ¨å¥½ï¼ææ¯è´µå¬å¸çé¿æå®¢æ·ï¼è®¢åå·ä¸º 
#2025
-001ã
ææ³ç¡®è®¤ä¸ä¸ä¸å¨æäº¤çéè´­è®¢åæ¯å¦å·²ç»å®æåè´§ã
å¦æéè¦è¡¥åä»»ä½ä¿¡æ¯ï¼è¯·éæ¶åç¥ã
æå¾æ¨çåå¤ï¼è°¢è°¢ï¼
å®¢æ·ï¼å¼ åç
</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">;
</span><span style="color: rgba(0, 0, 255, 1)">await</span><span style="color: rgba(0, 0, 0, 1)"> RunWorkflowAsync(workflow, scenarioName1, emailContent1);
Console.WriteLine(</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">â æ­£å¸¸é®ä»¶è·¯å¾éªè¯å®æ</span><span style="color: rgba(128, 0, 0, 1)">"</span>);</pre>
</div>
<p>æµè¯ç»æå¦ä¸å¾æç¤ºï¼</p>
<p><img src="https://img2024.cnblogs.com/blog/381412/202512/381412-20251224202754097-83329301.png" alt="image" loading="lazy" style="display: block; margin-left: auto; margin-right: auto"></p>
<p>å¯ä»¥çè§ï¼å¯¹äºæ­£å¸¸å¨è¯¢é®ä»¶ï¼è¿è¡æ­£å¸¸çé®ä»¶å¤çåè½¬åã</p>
<p><strong>æµè¯ç¨ä¾2ï¼</strong>åå¾é®ä»¶è¾å¥</p>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 255, 1)">var</span> scenarioName2 = <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">åå¾é®ä»¶ â HandleSpam</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">;
</span><span style="color: rgba(0, 0, 255, 1)">var</span> emailContent2 = <span style="color: rgba(128, 0, 0, 1)">@"</span><span style="color: rgba(128, 0, 0, 1)">
ððð æ­åæ¨ä¸­å¥å¦ï¼ððð

æ¨å·²è¢«éä¸­è·å¾ 100 ä¸ç°éå¤§å¥ï¼

ç«å³ç¹å»ä»¥ä¸é¾æ¥é¢åï¼
http://suspicious-site.com/claim-prize

ä»éä»æ¥ææï¼è¿æä½åºï¼
ä¸éè¦ä»»ä½æç»­è´¹ï¼å®å¨åè´¹ï¼

å¿«éè¡å¨ï¼æºä¸å¯å¤±ï¼
</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">;
</span><span style="color: rgba(0, 0, 255, 1)">await</span><span style="color: rgba(0, 0, 0, 1)"> RunWorkflowAsync(workflow, scenarioName2, emailContent2);
Console.WriteLine(</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">â åå¾é®ä»¶è·¯å¾éªè¯å®æ</span><span style="color: rgba(128, 0, 0, 1)">"</span>);</pre>
</div>
<p>æµè¯ç»æå¦ä¸å¾æç¤ºï¼</p>
<p><img src="https://img2024.cnblogs.com/blog/381412/202512/381412-20251224202904798-37631196.png" alt="image" loading="lazy" style="display: block; margin-left: auto; margin-right: auto"></p>
<p>å¯ä»¥çè§ï¼å¯¹äºåå¾é®ä»¶ï¼è¿è¡ææçæ¦æªï¼åç»­è¿å¯ä»¥è¿è¡ä¸æ¥äººå·¥è·è¸ªç­ç­ã</p>
<p><strong>æµè¯ç¨ä¾3ï¼</strong>æ æ³ç¡®è®¤ç±»åçé®ä»¶è¾å¥</p>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 255, 1)">var</span> uncertainEmail = <span style="color: rgba(128, 0, 0, 1)">@"</span><span style="color: rgba(128, 0, 0, 1)">
ä¸»é¢ï¼éè¦éªè¯æ¨çè´¦æ·
å°æ¬çå®¢æ·ï¼
æä»¬æ£æµå°æ¨çè´¦æ·å­å¨å¼å¸¸æ´»å¨ï¼éè¦éªè¯æ¨çèº«ä»½ä»¥ç¡®ä¿è´¦æ·å®å¨ã
è¯·ç»å½æ¨çè´¦æ·å¹¶å®æéªè¯æµç¨ï¼ä»¥ç»§ç»­ä½¿ç¨æå¡ã
è´¦æ·è¯¦æï¼
- ç¨æ·åï¼johndoe@contoso.com
- æåç»å½ï¼08/15/2025
- ç»å½å°ç¹ï¼è¥¿éå¾ï¼åçé¡¿å·
- ç»å½è®¾å¤ï¼ç§»å¨è®¾å¤
è¿æ¯ä¸é¡¹èªå¨å®å¨æªæ½ãå¦ææ¨è®¤ä¸ºæ­¤é®ä»¶æ¯éè¯¯åéçï¼è¯·ç«å³èç³»æä»¬çæ¯æå¢éã
æ­¤è´
å®å¨å¢é
å®¢æ·æå¡é¨é¨
</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">;
</span><span style="color: rgba(0, 0, 255, 1)">await</span><span style="color: rgba(0, 0, 0, 1)"> RunWorkflowAsync(
    workflow,
    </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">ä¸ç¡®å®é®ä»¶ â HandleUncertain (Default)</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">,
    uncertainEmail
);
Console.WriteLine(</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">â ä¸ç¡®å®é®ä»¶è·¯å¾éªè¯å®æ</span><span style="color: rgba(128, 0, 0, 1)">"</span>);</pre>
</div>
<p>æµè¯ç»æå¦ä¸å¾æç¤ºï¼</p>
<p><img src="https://img2024.cnblogs.com/blog/381412/202512/381412-20251224202940842-749043447.png" alt="image" loading="lazy" style="display: block; margin-left: auto; margin-right: auto"></p>
<p>å¯ä»¥çå°ï¼å¯¹äºLLMæ æ³ç¡®è®¤çç±»åï¼è¿å¥äºè¯¥æ§è¡å¨ï¼è¿æ¶å¯è½éè¦äººå·¥ä»å¥å®¡æ ¸ãåæ¶ï¼è¿ä¹æ¯å®éä¸­å¸¸è§çä¸ç§ååºæºå¶çå±ç°ï¼è¯å¥è¯è¯´ï¼<strong>å³ä½¿AIæ æ³æç¡®å¤æ­ï¼ä¹åºè¯¥æå¯¹åºçå¤çæµç¨</strong>ã</p>
<h1><strong><span>å°ç»</span></strong></h1>
<p>æ¬æä»ç»äºMAFä¸­çswitch-caseè·¯ç±ä»¥åå¦ä½å®ç°å¤æ¡ä»¶è·¯ç±ï¼æåä¼åäºä¸ä¸ç¯çä¼ä¸åé¨é®ä»¶æ£æµå·¥ä½æµæ¡ä¾ï¼ç¹å«éåäºå¤§äº3ä¸ªåæ¯çå¤æè·¯ç±åºæ¯ã</p>
<p>ä¸ä¸ç¯ï¼æä»¬å°ç»§ç»­å­¦ä¹ MAFä¸­å·¥ä½æµçå¾ªç¯å·¥ä½æµã</p>
<h1>åèèµæ</h1>
<p><span data-pm-slice="0 0 []"><span>å£æ°ï¼ã<a href="https://www.cnblogs.com/sheng-jie/p/19200934" target="_blank">.NET + AI æºè½ä½å¼åè¿é¶</a>ãï¼æ¨èææ°ï¼âââââï¼</span></span></p>
<p><span data-pm-slice="0 0 []"><span>Microsoft Learnï¼<span>ã<a href="https://learn.microsoft.com/en-us/agent-framework/overview/agent-framework-overview?wt.mc_id=MVP_397012" target="_blank" rel="noopener nofollow">Agent Framework Tutorials</a>ã</span></span></span></p>
<div><span data-pm-slice="0 0 []"><span>&nbsp;</span></span></div>
<p style="text-align: center"><img src="https://images.cnblogs.com/cnblogs_com/edisonchou/1647700/o_200902144330EdisonTalk-Footer.jpg" alt="" style="width: 65%; border: 1px solid rgba(221, 221, 221, 1); border-radius: 3px; box-shadow: 0 4px 8px rgba(3, 27, 78, 0.12)"></p>
<div id="Copyright">
<p>ä½èï¼<span style="text-decoration: underline">ç±è¿ªç</span></p>
<p>åºå¤ï¼<a title="from" href="https://edisontalk.cnblogs.com" target="_blank">https://edisontalk.cnblogs.com</a></p>
<p>æ¬æçæå½ä½èååå®¢å­å±æï¼æ¬¢è¿è½¬è½½ï¼ä½æªç»ä½èåæå¿é¡»ä¿çæ­¤æ®µå£°æï¼ä¸å¨æç« é¡µé¢ææ¾ä½ç½®ç»åºåæé¾æ¥ã</p>
</div>
</div>
<div id="MySignature" role="contentinfo">
    <div align="center"><a href="https://weibo.com/u/2068032061?s=6uyXnP" target="_blank"><img border="0" src="http://service.t.sina.com.cn/widget/qmd/2068032061/d643d182/10.png"></a></div>
</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2025-12-29 18:30">2025-12-29 18:30</span>&nbsp;
<a href="https://www.cnblogs.com/edisontalk">EdisonZhou</a>&nbsp;
éè¯»(<span id="post_view_count">0</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19394484);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19394484', targetLink: 'https://www.cnblogs.com/edisontalk/p/-/quick-start-on-maf-chatper09', title: 'MAFå¿«éå¥é¨ï¼9ï¼å¤è·¯åæ¯è·¯ç±å·¥ä½æµ' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ CodeSpirit å¼åç¯å¢æ­å»ºåå¯å¨æå ]]></title>
    <link>https://www.cnblogs.com/codelove/p/19392132</link>
    <guid>0a843efff4b9252f9b47679e48ee9529</guid>
    <description>
    <![CDATA[ 
		<h1 class="postTitle">
			<a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/codelove/p/19392132" title="åå¸äº 2025-12-29 15:07">
    <span role="heading" aria-level="2">CodeSpirit å¼åç¯å¢æ­å»ºåå¯å¨æå</span>
    

</a>

		</h1>
		<div class="clear"></div>
		<div class="postBody">
			<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h2 id="æ¦è¿°">æ¦è¿°</h2>
<p>æ¬æåå°å¸®å©æ¨å¿«éæ­å»ºCodeSpiritï¼ç çµï¼ä½ä»£ç æ¡æ¶çå¼åç¯å¢ãCodeSpiritåºäº .NET 10 å Aspire 13.0 æå»ºï¼éè¿ç®åçå ä¸ªæ­¥éª¤å³å¯å¯å¨å®æ´çå¼åç¯å¢ã</p>
<p><strong>æåæ´æ°</strong>: 2025å¹´12æ22æ¥<br>
<strong>æ¡æ¶çæ¬</strong>: v2.0.0<br>
<img src="https://img2024.cnblogs.com/blog/70544/202512/70544-20251224131727898-298580147.png" alt="image" loading="lazy"></p>
<h2 id="å¿«éå¼å§">å¿«éå¼å§</h2>
<h3 id="åç½®è¦æ±">åç½®è¦æ±</h3>
<ul>
<li><strong>æä½ç³»ç»</strong>: Windows 10/11, macOS 12+, æ Linux (Ubuntu 20.04+)</li>
<li><strong>CPU</strong>: Intel i5 æ AMD Ryzen 5 åä»¥ä¸ï¼æ¨èi7/Ryzen 7ï¼</li>
<li><strong>åå­</strong>: 16GB RAMï¼æ¨è32GBï¼</li>
<li><strong>å­å¨</strong>: è³å°20GBå¯ç¨ç©ºé´ï¼SSDæ¨èï¼</li>
</ul>
<blockquote>
<p><strong>æ³¨æ</strong>: CodeSpirité»è®¤ä½¿ç¨GreptimeDBè¿è¡å®¡è®¡æ¥å¿å­å¨åæç´¢ãElasticsearchä¸ºå¯éç»ä»¶ï¼å¦éä½¿ç¨è¯·åèç¸å³éç½®ææ¡£ã</p>
</blockquote>
<h3 id="1-å®è£-net-10-sdk">1. å®è£ .NET 10 SDK</h3>
<h4 id="windows">Windows</h4>
<pre><code class="language-powershell"># ä½¿ç¨ winget å®è£
winget install Microsoft.DotNet.SDK.10

# æä¸è½½å®è£å
# https://dotnet.microsoft.com/download/dotnet/10.0
</code></pre>
<h4 id="macos">macOS</h4>
<pre><code class="language-bash"># ä½¿ç¨ Homebrew
brew install --cask dotnet-sdk

# æä¸è½½å®è£å
# https://dotnet.microsoft.com/download/dotnet/10.0
</code></pre>
<h4 id="linux-ubuntu">Linux (Ubuntu)</h4>
<pre><code class="language-bash"># æ·»å å¾®è½¯åæº
wget https://packages.microsoft.com/config/ubuntu/22.04/packages-microsoft-prod.deb -O packages-microsoft-prod.deb
sudo dpkg -i packages-microsoft-prod.deb
sudo apt-get update
sudo apt-get install -y dotnet-sdk-10.0
</code></pre>
<h4 id="éªè¯å®è£">éªè¯å®è£</h4>
<pre><code class="language-bash">dotnet --version
# åºæ¾ç¤º 10.x.x
</code></pre>
<h3 id="2-å®è£å¼åå·¥å·">2. å®è£å¼åå·¥å·</h3>
<h4 id="visual-studio-2026-æ¨è">Visual Studio 2026 (æ¨è)</h4>
<ul>
<li>ä¸è½½å°å: <a href="https://visualstudio.microsoft.com/vs/" target="_blank" rel="noopener nofollow">https://visualstudio.microsoft.com/vs/</a></li>
<li>éæ©å·¥ä½è´è½½ï¼<strong>ASP.NET å Web å¼å</strong></li>
</ul>
<h4 id="æè-visual-studio-code">æè Visual Studio Code</h4>
<pre><code class="language-bash"># Windows
winget install Microsoft.VisualStudioCode

# macOS
brew install --cask visual-studio-code

# Linux
sudo snap install code --classic
</code></pre>
<p>VS Codeå¿éæ©å±ï¼</p>
<pre><code class="language-bash">code --install-extension ms-dotnettools.csharp
code --install-extension ms-dotnettools.vscode-dotnet-runtime
</code></pre>
<h3 id="3-å®è£docker-desktop">3. å®è£Docker Desktop</h3>
<ul>
<li>ä¸è½½å°å: <a href="https://www.docker.com/products/docker-desktop" target="_blank" rel="noopener nofollow">https://www.docker.com/products/docker-desktop</a></li>
<li>å®è£åå¯å¨Docker Desktop</li>
</ul>
<p>éªè¯å®è£ï¼</p>
<pre><code class="language-bash">docker --version
</code></pre>
<h2 id="é¡¹ç®å¯å¨">é¡¹ç®å¯å¨</h2>
<h3 id="1-åéé¡¹ç®">1. åéé¡¹ç®</h3>
<pre><code class="language-bash">git clone https://gitee.com/magicodes/code-spirit.git
cd code-spirit
</code></pre>
<h3 id="2-å¯å¨åºç¡æå¡">2. å¯å¨åºç¡æå¡</h3>
<p>CodeSpiritä½¿ç¨Aspireèªå¨ç®¡çææä¾èµæå¡ï¼æ éæå¨å¯å¨Dockerå®¹å¨ï¼</p>
<pre><code class="language-bash"># Aspireä¼èªå¨å¯å¨ä»¥ä¸æå¡ï¼
# - MySQL/SQL Server (æ ¹æ®éç½®éæ©ï¼ç«¯å£: 3306/1433)
# - Redis (ç«¯å£: 6380)
# - RabbitMQ (ç«¯å£: 5672, ç®¡ççé¢: 15672)
# - GreptimeDB (ç«¯å£: 4000/4001)
# - Seqæ¥å¿æå¡ (ç«¯å£: 5341)
</code></pre>
<blockquote>
<p><strong>æå¡è¯´æ</strong>:</p>
<ul>
<li><strong>MySQL/SQL Server</strong>: ä¸»æ°æ®åºå­å¨ï¼æ ¹æ®DatabaseTypeéç½®éæ©ï¼</li>
<li><strong>Redis</strong>: ç¼å­åä¼è¯å­å¨ï¼ç«¯å£: 6380ï¼</li>
<li><strong>RabbitMQ</strong>: æ¶æ¯éåæå¡ï¼ç®¡ççé¢ç«¯å£: 15672ï¼</li>
<li><strong>GreptimeDB</strong>: æ¶åºæ°æ®åºï¼ç¨äºå®¡è®¡æ¥å¿å­å¨ï¼HTTPç«¯å£: 4000, gRPCç«¯å£: 4001ï¼</li>
<li><strong>Seq</strong>: ç»æåæ¥å¿æå¡ï¼ç«¯å£: 5341ï¼</li>
</ul>
</blockquote>
<h3 id="3-è¿è¡é¡¹ç®">3. è¿è¡é¡¹ç®</h3>
<h4 id="ä½¿ç¨net-aspireæ¨è">ä½¿ç¨.NET Aspireï¼æ¨èï¼</h4>
<pre><code class="language-bash"># è¿å¥AppHosté¡¹ç®ç®å½
cd Src/CodeSpirit.AppHost

# è¿è¡Aspireåºç¨
dotnet run
</code></pre>
<p>å¦ææ¯æ­£å¸¸å¯å¨ï¼å°çå°ä»¥ä¸ç¼¤çº·çæ§å¶å°è¾åºï¼</p>
<p><img src="https://img2024.cnblogs.com/blog/70544/202512/70544-20251224131931648-1820053723.png" alt="image" loading="lazy"></p>
<p>å¯å¨åè®¿é®ï¼</p>
<ul>
<li><strong>Aspire Dashboard</strong>: <a href="http://localhost:17109" target="_blank" rel="noopener nofollow">http://localhost:17109</a>ï¼èªå¨æå¼ï¼</li>
<li><strong>Webåºç¨</strong>: <a href="https://localhost:7120" target="_blank" rel="noopener nofollow">https://localhost:7120</a>ï¼å¯å¨åæ¾ç¤ºå·ä½ç«¯å£ï¼</li>
</ul>
<blockquote>
<p><strong>æ³¨æ</strong>:</p>
</blockquote>
<blockquote>
<ol>
<li>å®éç«¯å£å·å¯è½å ç³»ç»éç½®èå¼ï¼è¯·æ¥çAspire Dashboardè·ååç¡®çç«¯å£ä¿¡æ¯ã</li>
<li>å¦ä½ç»å½é¡µæ²¡ææ­£å¸¸åç°ï¼è¯·æç§ä¸é¢çå¿å¡«åæ°éç½®è¿è¡éç½®ã</li>
</ol>
</blockquote>
<h4 id="æèä½¿ç¨visual-studio">æèä½¿ç¨Visual Studio</h4>
<ol>
<li>
<p>æå¼ <code>CodeSpirit.sln</code></p>
</li>
<li>
<p>è®¾ç½® <code>CodeSpirit.AppHost</code> ä¸ºå¯å¨é¡¹ç®</p>
</li>
<li>
<p>æ F5 è¿è¡<br>
<img src="https://img2024.cnblogs.com/blog/70544/202512/70544-20251224131917733-1101676572.png" alt="image" loading="lazy"><br>
æ³¨æï¼éç¡®ä¿ä»¥ä¸æå¡åæ­£å¸¸å¯å¨ï¼<br>
<img src="https://img2024.cnblogs.com/blog/70544/202512/70544-20251224131931648-1820053723.png" alt="image" loading="lazy"></p>
</li>
</ol>
<h2 id="é¡¹ç®ç»æ">é¡¹ç®ç»æ</h2>
<p>CodeSpiritéç¨Clean Architectureè®¾è®¡ï¼é¡¹ç®ç»æå¦ä¸ï¼</p>
<pre><code>CodeSpirit/
âââ Src/
â   âââ ApiServices/                     # APIæå¡ï¼è§£å³æ¹æ¡æä»¶å¤¹ï¼
â   â   âââ CodeSpirit.IdentityApi/      # èº«ä»½è®¤è¯API
â   â   âââ CodeSpirit.ExamApi/          # èè¯ç³»ç»API  
â   â   âââ CodeSpirit.MessagingApi/     # æ¶æ¯æå¡API
â   â   âââ CodeSpirit.ConfigCenter/    # éç½®ä¸­å¿API
â   â   âââ CodeSpirit.FileStorageApi/  # æä»¶å­å¨API
â   â   âââ CodeSpirit.SurveyApi/        # é®å·è°æ¥API
â   â   âââ CodeSpirit.ApprovalApi/      # å®¡æ¹å·¥ä½æµAPI
â   â   âââ CodeSpirit.PathfinderApi/    # AIç®æ ç®¡çAPI
â   â   âââ CodeSpirit.AiCardsApi/       # AIå¡çAPI
â   âââ Components/                     # ç»ä»¶åº
â   â   âââ CodeSpirit.Aggregator/       # èåå¨ç»ä»¶
â   â   âââ CodeSpirit.AiFormFill/       # AIè¡¨åæºè½å¡«åç»ä»¶
â   â   âââ CodeSpirit.Amis/             # UIçæå¼æ
â   â   âââ CodeSpirit.Authorization/    # æéç»ä»¶
â   â   âââ CodeSpirit.Audit/            # å®¡è®¡ç»ä»¶
â   â   âââ CodeSpirit.Caching/          # åå¸å¼ç¼å­ç»ä»¶
â   â   âââ CodeSpirit.Charts/           # æºè½å¾è¡¨ç»ä»¶
â   â   âââ CodeSpirit.ConfigCenter.Client/ # éç½®ä¸­å¿å®¢æ·ç«¯
â   â   âââ CodeSpirit.LLM/              # å¤§è¯­è¨æ¨¡åç»ä»¶
â   â   âââ CodeSpirit.Messaging/        # æ¶æ¯éåç»ä»¶
â   â   âââ CodeSpirit.MultiTenant/      # å¤ç§æ·ç»ä»¶
â   â   âââ CodeSpirit.Navigation/       # å¯¼èªç»ä»¶
â   â   âââ CodeSpirit.PdfGeneration/    # PDFçæç»ä»¶
â   â   âââ CodeSpirit.ScheduledTasks/   # å®æ¶ä»»å¡ç»ä»¶
â   â   âââ CodeSpirit.Settings/         # è®¾ç½®ç®¡çç»ä»¶
â   â   âââ CodeSpirit.Shared/           # ç»ä»¶å±äº«åº
â   â   âââ CodeSpirit.UdlCards/         # UDLå¡çç»ä»¶
â   âââ CodeSpirit.AppHost/              # Aspireåºç¨å®¿ä¸»
â   âââ CodeSpirit.Core/                 # æ ¸å¿å®ä¹
â   âââ CodeSpirit.ServiceDefaults/      # æå¡é»è®¤éç½®
â   âââ CodeSpirit.Shared/               # å¨å±å±äº«åº
â   âââ CodeSpirit.Web/                  # Webåç«¯é¡¹ç®
âââ Tests/                               # æµè¯é¡¹ç®
âââ Docs/                                # é¡¹ç®ææ¡£
âââ k8s/                                 # Kubernetesé¨ç½²æä»¶
âââ CodeSpirit.sln                       # è§£å³æ¹æ¡æä»¶
</code></pre>
<h2 id="é»è®¤éç½®">é»è®¤éç½®</h2>
<p>é¡¹ç®ä½¿ç¨ä»¥ä¸é»è®¤éç½®ï¼ç±.NET Aspireèªå¨ç®¡çï¼</p>
<h3 id="æ°æ®åºè¿æ¥">æ°æ®åºè¿æ¥</h3>
<ul>
<li>
<p><strong>æ°æ®åºç±»å</strong>: æ¯æMySQLåSQL Serverä¸¤ç§æ°æ®åºï¼éè¿<code>DatabaseType</code>éç½®éæ©ï¼</p>
</li>
<li>
<p><strong>MySQL</strong>: ç«¯å£3306ï¼ç±Aspireèªå¨éç½®</p>
<p>å¯ä»¥ä»èµæºé¢æ¿è®¿é®ç®¡çUIï¼phpmyadminï¼ï¼<br>
<img src="https://img2024.cnblogs.com/blog/70544/202512/70544-20251224132002956-598129788.png" alt="image" loading="lazy"></p>
<p><img src="https://img2024.cnblogs.com/blog/70544/202512/70544-20251224132042244-558588173.png" alt="image" loading="lazy"></p>
</li>
<li>
<p><strong>SQL Server</strong>: ç«¯å£1433ï¼ç±Aspireèªå¨éç½®</p>
</li>
<li>
<p><strong>æ°æ®åº</strong>: èªå¨åå»ºåè¿ç§»</p>
</li>
<li>
<p><strong>è¿æ¥å­ç¬¦ä¸²</strong>: ç±Aspireèªå¨ç®¡ç</p>
</li>
</ul>
<h3 id="ç¼å­åæ¶æ¯éå">ç¼å­åæ¶æ¯éå</h3>
<ul>
<li>
<p><strong>Redis</strong>: <code>localhost:6380</code>ï¼å·ä½è§ç®¡çUIï¼</p>
</li>
<li>
<p><strong>RabbitMQ</strong>: <code>localhost:5672</code> (ç®¡ççé¢: <a href="http://localhost:15672" target="_blank" rel="noopener nofollow">http://localhost:15672</a>, ç¨æ·å/å¯ç : admin/Password123)</p>
<p><img src="https://img2024.cnblogs.com/blog/70544/202512/70544-20251224132123458-1426760447.png" alt="image" loading="lazy"></p>
</li>
</ul>
<h3 id="å¶ä»æå¡ç«¯å£">å¶ä»æå¡ç«¯å£</h3>
<ul>
<li>
<p><strong>GreptimeDB</strong>:</p>
<ul>
<li>HTTPç«¯å£: <code>localhost:4000</code></li>
<li>gRPCç«¯å£: <code>localhost:4001</code></li>
<li>å¥åº·æ£æ¥: <a href="http://localhost:4000/health" target="_blank" rel="noopener nofollow">http://localhost:4000/health</a></li>
</ul>
</li>
<li>
<p><strong>Seqæ¥å¿æå¡</strong>: <code>localhost:5341</code>ï¼å·ä½ç«¯å£è§èµæºé¢æ¿ï¼</p>
<p><img src="https://img2024.cnblogs.com/blog/70544/202512/70544-20251224132136208-2065968736.png" alt="image" loading="lazy"></p>
</li>
<li>
<p><strong>Redis Commander</strong>: éè¿Aspire Dashboardè®¿é®</p>
</li>
</ul>
<p><img src="https://img2024.cnblogs.com/blog/70544/202512/70544-20251224132147317-671812413.png" alt="image" loading="lazy"></p>
<h2 id="å¿å¡«åæ°éç½®">å¿å¡«åæ°éç½®</h2>
<p>CodeSpirit ä½¿ç¨ .NET Aspire çåæ°ç®¡çæºå¶æ¥éç½®ææä¿¡æ¯åç¯å¢ç¸å³åæ°ãå¨é¦æ¬¡å¯å¨åï¼æ¨éè¦éç½®ä»¥ä¸å¿å¡«åæ°ãæç¤ºUIå¦ä¸ï¼<br>
<img src="https://img2024.cnblogs.com/blog/70544/202512/70544-20251224132156259-1567610099.png" alt="image" loading="lazy"><br>
<img src="https://img2024.cnblogs.com/blog/70544/202512/70544-20251224132203941-1321498621.png" alt="image" loading="lazy"></p>
<h3 id="åæ°éç½®æ¹å¼">åæ°éç½®æ¹å¼</h3>
<p>Aspire æ¯æä¸¤ç§åæ°éç½®æ¹å¼ï¼éç½®ç³»ç»ä¼æä»¥ä¸ä¼åçº§è¯»åï¼é«ä¼åçº§ä¼è¦çä½ä¼åçº§ï¼ï¼</p>
<ol>
<li><strong>User Secrets</strong>ï¼å¼åç¯å¢æ¨èï¼é¿åæäº¤ææä¿¡æ¯å°ä»£ç åºï¼</li>
<li><strong>appsettings.json</strong>ï¼å¼åç¯å¢å¤éæ¹æ¡ï¼</li>
</ol>
<blockquote>
<p><strong>æç¤º</strong>: å¯¹äºææä¿¡æ¯ï¼å¦ API å¯é¥ï¼ï¼å¼ºçæ¨èä½¿ç¨ User Secretsï¼é¿åå°å¯é¥æäº¤å°ä»£ç åºã</p>
</blockquote>
<h3 id="å¿å¡«åæ°åè¡¨">å¿å¡«åæ°åè¡¨</h3>
<h4 id="llm-éç½®åæ°">LLM éç½®åæ°</h4>
<p>ä»¥ä¸åæ°ç¨äºéç½®éç¨ LLM æå¡ï¼å¦ AI å¡çãæºè½å®¡æ¹ç­åè½ï¼ï¼</p>
<table>
<thead>
<tr>
<th>åæ°åç§°</th>
<th>è¯´æ</th>
<th>æ¯å¦å¿å¡«</th>
<th>é»è®¤å¼</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>llm-ApiKey</code></td>
<td>LLM APIå¯é¥</td>
<td>â <strong>å¿å¡«</strong></td>
<td>æ </td>
</tr>
<tr>
<td><code>llm-ApiBaseUrl</code></td>
<td>LLM APIåºç¡å°å</td>
<td>å¯é</td>
<td><code>https://dashscope.aliyuncs.com/compatible-mode/v1</code></td>
</tr>
<tr>
<td><code>llm-ModelName</code></td>
<td>LLMæ¨¡ååç§°</td>
<td>å¯é</td>
<td><code>qwen-flash</code></td>
</tr>
<tr>
<td><code>llm-TimeoutSeconds</code></td>
<td>è¯·æ±è¶æ¶æ¶é´ï¼ç§ï¼</td>
<td>å¯é</td>
<td><code>120</code></td>
</tr>
<tr>
<td><code>llm-MaxTokens</code></td>
<td>æå¤§Tokenæ°</td>
<td>å¯é</td>
<td><code>2048</code></td>
</tr>
<tr>
<td><code>llm-UseProxy</code></td>
<td>æ¯å¦ä½¿ç¨ä»£ç</td>
<td>å¯é</td>
<td><code>false</code></td>
</tr>
<tr>
<td><code>llm-ProxyAddress</code></td>
<td>ä»£çå°å</td>
<td>å¯é</td>
<td>ç©ºå­ç¬¦ä¸²</td>
</tr>
</tbody>
</table>
<h4 id="aiè¡¨åå¡«å-llm-éç½®åæ°">AIè¡¨åå¡«å LLM éç½®åæ°</h4>
<p>ä»¥ä¸åæ°ç¨äºéç½® AI è¡¨åæºè½å¡«ååè½ï¼</p>
<table>
<thead>
<tr>
<th>åæ°åç§°</th>
<th>è¯´æ</th>
<th>æ¯å¦å¿å¡«</th>
<th>é»è®¤å¼</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ai-form-fill-llm-ApiKey</code></td>
<td>AIè¡¨åå¡«åLLM APIå¯é¥</td>
<td>â <strong>å¿å¡«</strong></td>
<td>æ </td>
</tr>
<tr>
<td><code>ai-form-fill-llm-ApiBaseUrl</code></td>
<td>APIåºç¡å°å</td>
<td>å¯é</td>
<td><code>https://dashscope.aliyuncs.com/compatible-mode/v1</code></td>
</tr>
<tr>
<td><code>ai-form-fill-llm-ModelName</code></td>
<td>æ¨¡ååç§°</td>
<td>å¯é</td>
<td><code>qwen3-max-preview</code></td>
</tr>
<tr>
<td><code>ai-form-fill-llm-DisableThinking</code></td>
<td>ç¦ç¨æèæ¨¡å¼</td>
<td>å¯é</td>
<td><code>true</code></td>
</tr>
<tr>
<td><code>ai-form-fill-llm-ResponseFormatType</code></td>
<td>ååºæ ¼å¼ç±»å</td>
<td>å¯é</td>
<td><code>json_object</code></td>
</tr>
<tr>
<td><code>ai-form-fill-llm-Temperature</code></td>
<td>æ¸©åº¦åæ°</td>
<td>å¯é</td>
<td><code>0.1</code></td>
</tr>
<tr>
<td><code>ai-form-fill-llm-TopP</code></td>
<td>TopPåæ°</td>
<td>å¯é</td>
<td><code>0.9</code></td>
</tr>
<tr>
<td><code>ai-form-fill-llm-EnableStreaming</code></td>
<td>å¯ç¨æµå¼ååº</td>
<td>å¯é</td>
<td><code>true</code></td>
</tr>
</tbody>
</table>
<h4 id="å¶ä»å¯éåæ°">å¶ä»å¯éåæ°</h4>
<p>ä»¥ä¸åæ°å·²æé»è®¤å¼ï¼éå¸¸æ éä¿®æ¹ï¼</p>
<table>
<thead>
<tr>
<th>åæ°åç§°</th>
<th>è¯´æ</th>
<th>é»è®¤å¼</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>jwt-SecretKey</code></td>
<td>JWTå¯é¥</td>
<td><code>ECBF8FA013844D77AE041A6800D7FF8F</code></td>
</tr>
<tr>
<td><code>jwt-Issuer</code></td>
<td>JWTé¢åè</td>
<td><code>codespirit.com</code></td>
</tr>
<tr>
<td><code>jwt-Audience</code></td>
<td>JWTåä¼</td>
<td><code>CodeSpirit</code></td>
</tr>
<tr>
<td><code>mysql-password</code></td>
<td>MySQLå¯ç </td>
<td><code>Password123</code></td>
</tr>
<tr>
<td><code>sqlserver-password</code></td>
<td>SQL Serverå¯ç </td>
<td><code>P@ssword123456</code></td>
</tr>
<tr>
<td><code>rabbitmq-username</code></td>
<td>RabbitMQç¨æ·å</td>
<td><code>admin</code></td>
</tr>
<tr>
<td><code>rabbitmq-password</code></td>
<td>RabbitMQå¯ç </td>
<td><code>Password123</code></td>
</tr>
</tbody>
</table>
<h3 id="éç½®æ¹æ³">éç½®æ¹æ³</h3>
<h4 id="æ¹æ³ä¸ä½¿ç¨-user-secretsæ¨èå¼åç¯å¢">æ¹æ³ä¸ï¼ä½¿ç¨ User Secretsï¼æ¨èå¼åç¯å¢ï¼</h4>
<p>ä½¿ç¨ .NET User Secrets å¯ä»¥å®å¨å°å­å¨ææä¿¡æ¯ï¼æ éæå¿æäº¤å°ä»£ç åºï¼</p>
<pre><code class="language-bash"># è¿å¥ AppHost é¡¹ç®ç®å½
cd Src/CodeSpirit.AppHost

# åå§å User Secretsï¼å¦æå°æªåå§åï¼
dotnet user-secrets init

# è®¾ç½® LLM API å¯é¥
dotnet user-secrets set "llm-ApiKey" "your-llm-api-key-here"

# è®¾ç½® AI è¡¨åå¡«å LLM API å¯é¥
dotnet user-secrets set "ai-form-fill-llm-ApiKey" "your-ai-form-fill-llm-api-key-here"

# æ¸é¤ææå¯é¥
# dotnet user-secrets clear
</code></pre>
<h4 id="æ¹æ³äºä½¿ç¨-appsettingsjsonå¼åç¯å¢å¤é">æ¹æ³äºï¼ä½¿ç¨ appsettings.jsonï¼å¼åç¯å¢å¤éï¼</h4>
<p>ç¼è¾ <code>Src/CodeSpirit.AppHost/appsettings.json</code> æä»¶ï¼æ·»å åæ°éç½®ï¼</p>
<pre><code class="language-json">{
  "DatabaseType": "MySql",
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning",
      "Aspire.Hosting.Dcp": "Warning"
    }
  },
  "llm-ApiKey": "your-llm-api-key-here",
  "ai-form-fill-llm-ApiKey": "your-ai-form-fill-llm-api-key-here"
}
</code></pre>
<blockquote>
<p><strong>â ï¸ éè¦æç¤º</strong>:</p>
<ul>
<li>å¦æä½¿ç¨ <code>appsettings.json</code> éç½®ææä¿¡æ¯ï¼è¯·ç¡®ä¿è¯¥æä»¶å·²æ·»å å° <code>.gitignore</code> ä¸­</li>
<li>æèåå»º <code>appsettings.Local.json</code> æä»¶ï¼è¯¥æä»¶é»è®¤å·²å¨ <code>.gitignore</code> ä¸­ï¼ï¼é¿åå° API å¯é¥æäº¤å°ä»£ç åº</li>
<li><strong>å¼ºçæ¨èä½¿ç¨ User Secrets æ¹å¼</strong>ï¼æ´å®å¨ä¸ä¸ä¼è¯¯æäº¤</li>
</ul>
</blockquote>
<h3 id="è·å-api-å¯é¥">è·å API å¯é¥</h3>
<h4 id="é¿éäºéä¹åé®dashscope">é¿éäºéä¹åé®ï¼DashScopeï¼</h4>
<p>å¼åé¶æ®µåè´¹é¢åº¦å®å¨å¤ç¨ï¼</p>
<ol>
<li>è®¿é® <a href="https://www.aliyun.com/benefit?userCode=nw99vwgt" target="_blank" rel="noopener nofollow">é¿éäº DashScope</a></li>
<li>æ³¨å/ç»å½è´¦å·</li>
<li>åå»º API Key</li>
<li>å° API Key éç½®å°ä¸è¿°åæ°ä¸­</li>
</ol>
<blockquote>
<p>ð¡ <strong>æ¨èéè¯»</strong>ï¼<a href="./%E9%98%BF%E9%87%8C%E4%BA%91%E9%80%9A%E4%B9%89%E5%8D%83%E9%97%AE%E5%85%8D%E8%B4%B9%E4%BD%93%E9%AA%8C%E6%8C%87%E5%8D%97.md" target="_blank" rel="noopener nofollow">é¿éäºéä¹åé®åè´¹ä½éªæå</a> - è¯¦ç»çæ³¨åæåãéç½®æç¨åææ¬åæï¼å¸®å©æ¨é¶ææ¬ä½éª CodeSpirit çå¼ºå¤§ AI è½åï¼</p>
</blockquote>
<h4 id="openaiå¦ä½¿ç¨-openai-å¼å®¹æ¥å£">OpenAIï¼å¦ä½¿ç¨ OpenAI å¼å®¹æ¥å£ï¼</h4>
<p>å¦æä½¿ç¨ OpenAI å¼å®¹ç API æå¡ï¼éè¦ä¿®æ¹ä»¥ä¸åæ°ï¼</p>
<p>ä½¿ç¨ User Secrets éç½®ï¼</p>
<pre><code class="language-bash">dotnet user-secrets set "llm-ApiBaseUrl" "https://api.openai.com/v1"
dotnet user-secrets set "llm-ModelName" "gpt-4"
dotnet user-secrets set "llm-ApiKey" "your-openai-api-key-here"
</code></pre>
<p>æä½¿ç¨ appsettings.json éç½®ï¼</p>
<pre><code class="language-json">{
  "llm-ApiBaseUrl": "https://api.openai.com/v1",
  "llm-ModelName": "gpt-4",
  "llm-ApiKey": "your-openai-api-key-here"
}
</code></pre>
<h3 id="éªè¯åæ°éç½®">éªè¯åæ°éç½®</h3>
<p>å¯å¨é¡¹ç®åï¼å¦æåæ°éç½®ä¸æ­£ç¡®ï¼æ¨ä¼å¨æ§å¶å°æ Aspire Dashboard ä¸­çå°ç¸å³éè¯¯ä¿¡æ¯ãç¡®ä¿ä»¥ä¸æå¡è½å¤æ­£å¸¸å¯å¨ï¼</p>
<ul>
<li>â ConfigCenterï¼éç½®ä¸­å¿ï¼- éè¦ LLM åæ°</li>
<li>â Web åç«¯ - éè¦ AI è¡¨åå¡«å LLM åæ°</li>
</ul>
<blockquote>
<p><strong>æç¤º</strong>: å¦æææ¶ä¸éè¦ä½¿ç¨ AI åè½ï¼å¯ä»¥è®¾ç½®ä¸ä¸ªå ä½ç¬¦å¼ï¼ä½æäºä¾èµ AI çåè½å°æ æ³æ­£å¸¸å·¥ä½ã</p>
</blockquote>
<h2 id="å¼åå·¥å·éç½®">å¼åå·¥å·éç½®</h2>
<h3 id="visual-studio-code">Visual Studio Code</h3>
<p>åå»º <code>.vscode/launch.json</code>ï¼</p>
<pre><code class="language-json">{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "Launch CodeSpirit",
      "type": "coreclr",
      "request": "launch",
      "preLaunchTask": "build",
      "program": "${workspaceFolder}/Src/CodeSpirit.AppHost/bin/Debug/net10.0/CodeSpirit.AppHost.dll",
      "cwd": "${workspaceFolder}/Src/CodeSpirit.AppHost",
      "env": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    }
  ]
}
</code></pre>
<p>åå»º <code>.vscode/tasks.json</code>ï¼</p>
<pre><code class="language-json">{
  "version": "2.0.0",
  "tasks": [
    {
      "label": "build",
      "command": "dotnet",
      "type": "process",
      "args": ["build", "${workspaceFolder}/CodeSpirit.sln"],
      "problemMatcher": "$msCompile"
    }
  ]
}
</code></pre>
<h2 id="éªè¯å®è£-1">éªè¯å®è£</h2>
<h3 id="1-æ£æ¥æå¡ç¶æ">1. æ£æ¥æå¡ç¶æ</h3>
<p>è®¿é®Aspire Dashboard (<a href="http://localhost:17109" target="_blank" rel="noopener nofollow">http://localhost:17109</a>) ç¡®è®¤æææå¡æ­£å¸¸è¿è¡ï¼</p>
<ul>
<li>â CodeSpirit.Web (Webåç«¯)</li>
<li>â CodeSpirit.IdentityApi (èº«ä»½è®¤è¯)</li>
<li>â CodeSpirit.ConfigCenter (éç½®ä¸­å¿)</li>
<li>â CodeSpirit.MessagingApi (æ¶æ¯æå¡)</li>
<li>â CodeSpirit.ExamApi (èè¯ç³»ç»)</li>
<li>â CodeSpirit.FileStorageApi (æä»¶å­å¨)</li>
<li>â CodeSpirit.SurveyApi (é®å·è°æ¥)</li>
<li>â CodeSpirit.ApprovalApi (å®¡æ¹æµç¨)</li>
<li>â CodeSpirit.PathfinderApi (AIç®æ ç®¡ç)</li>
<li>â MySQL/SQL Server (æ°æ®åºï¼æ ¹æ®éç½®)</li>
<li>â Redis (ç¼å­)</li>
<li>â RabbitMQ (æ¶æ¯éå)</li>
<li>â GreptimeDB (æ¶åºæ°æ®åº)</li>
<li>â Seq (æ¥å¿æå¡)</li>
</ul>
<h3 id="2-æ£æ¥éè¯¯">2. æ£æ¥éè¯¯</h3>
<p>æå¼ç»æåæ¥å¿é¢æ¿ï¼æ£æ¥æ¯å¦å­å¨éè¯¯ï¼</p>
<p><img src="https://img2024.cnblogs.com/blog/70544/202512/70544-20251224132237841-409615542.png" alt="image" loading="lazy"></p>
<h3 id="3-è®¿é®webçé¢">3. è®¿é®Webçé¢</h3>
<p>ç³»ç»å¹³å°ï¼<a href="https://localhost:7120" target="_blank" rel="noopener nofollow">https://localhost:7120</a></p>
<p>è´¦å·ï¼systemadmin</p>
<p>å¯ç ï¼CodeSpirit@2025</p>
<p><img src="https://img2024.cnblogs.com/blog/70544/202512/70544-20251224132247398-182230200.png" alt="image" loading="lazy"></p>
<p>ç»å½åå¯ä»¥çå°ç³»ç»å¹³å°åå°ç®¡çUIï¼</p>
<p><img src="https://img2024.cnblogs.com/blog/70544/202512/70544-20251224132258347-1684698426.png" alt="image" loading="lazy"></p>
<p>ç§æ·å¹³å°ï¼é»è®¤ç§æ·ï¼ï¼<a href="https://localhost:7120/default/login" target="_blank" rel="noopener nofollow">https://localhost:7120/default/login</a></p>
<p>è´¦å·ï¼admin</p>
<p>å¯ç ï¼123@Admin</p>
<p><img src="https://img2024.cnblogs.com/blog/70544/202512/70544-20251224132312276-873776487.png" alt="image" loading="lazy"></p>
<p><img src="https://img2024.cnblogs.com/blog/70544/202512/70544-20251224132320900-136012642.png" alt="image" loading="lazy"></p>
<h2 id="å¸¸è§é®é¢">å¸¸è§é®é¢</h2>
<h3 id="æ æ³æå¼ç½é¡µ">æ æ³æå¼ç½é¡µ</h3>
<p>ä¸è¬æ¯ä»¥ä¸æåµå¯¼è´ï¼</p>
<ol>
<li>
<p>éåæ æ³æåï¼ä¸è¬å¨dockeré¢æ¿æAspireç®¡çé¢æ¿çæ¥å¿ä¸­å¯ä»¥çå°ãå»ºè®®éç½®éåæºæè·¯ç±ä¸ç½ã</p>
</li>
<li>
<p>å³é®æå¡æéï¼æ¯å¦Webæå¡åºç°æéã</p>
</li>
<li>
<p>ç«¯å£å²çªæç½ç»éè¯¯ï¼å·ä½å¯ä»¥çå¯å¨æ§å¶å°éè¯¯ï¼</p>
</li>
</ol>
<p><img src="https://img2024.cnblogs.com/blog/70544/202512/70544-20251224132339285-1584044125.png" alt="image" loading="lazy"></p>
<h3 id="ç«¯å£å²çª">ç«¯å£å²çª</h3>
<p>å¦æéå°ç«¯å£å²çªï¼ä¿®æ¹ <code>Src/CodeSpirit.AppHost/Program.cs</code> ä¸­çç«¯å£éç½®ã</p>
<h3 id="dockeræå¡å¯å¨å¤±è´¥">Dockeræå¡å¯å¨å¤±è´¥</h3>
<p>ç±äºé¡¹ç®ä½¿ç¨.NET Aspireç®¡çæå¡ï¼å¦æéå°æå¡å¯å¨é®é¢ï¼</p>
<pre><code class="language-bash"># éå¯Aspireåºç¨
cd Src/CodeSpirit.AppHost
dotnet run --force

# æ¥çAspire Dashboardä¸­çæå¡ç¶æ
# è®¿é® http://localhost:17109
</code></pre>
<h3 id="greptimedbå¯å¨å¤±è´¥">GreptimeDBå¯å¨å¤±è´¥</h3>
<pre><code class="language-bash"># å¨Aspire Dashboardä¸­æ¥çGreptimeDBç¶æ
# å¦æåå­ä¸è¶³ï¼å¯ä»¥å¨Program.csä¸­è°æ´GreptimeDBéç½®

# æ£æ¥ç³»ç»èµæºä½¿ç¨æåµ
# GreptimeDBéè¦è³å°512MBåå­
</code></pre>
<h3 id="sslè¯ä¹¦é®é¢">SSLè¯ä¹¦é®é¢</h3>
<pre><code class="language-bash"># ä¿¡ä»»å¼åè¯ä¹¦
dotnet dev-certs https --trust
</code></pre>
<h3 id="æ°æ®åºè¿æ¥é®é¢">æ°æ®åºè¿æ¥é®é¢</h3>
<pre><code class="language-bash"># æ£æ¥æ°æ®åºå®¹å¨ç¶æï¼æ ¹æ®éç½®çæ°æ®åºç±»åï¼
docker ps | grep mysql    # MySQL
docker ps | grep sqlserver # SQL Server

# éå¯æ°æ®åºå®¹å¨
docker restart mysql      # MySQL
docker restart sqlserver  # SQL Server

# æå¨Aspire Dashboardä¸­æ¥çæ°æ®åºç¶æåè¿æ¥ä¿¡æ¯
</code></pre>
<h3 id="åå­ä¸è¶³é®é¢">åå­ä¸è¶³é®é¢</h3>
<p>å¦æç³»ç»åå­ä¸è¶³ï¼å¯ä»¥ï¼</p>
<ol>
<li>å³é­ä¸å¿è¦çåºç¨ç¨åº</li>
<li>è°æ´GreptimeDBåå­è®¾ç½®ï¼å¨Program.csä¸­ï¼</li>
<li>èèåçº§ç³»ç»åå­å°æ¨èéç½®ï¼16GBæ¨èï¼32GBæ´ä½³ï¼</li>
</ol>
<h3 id="llm-api-å¯é¥æªéç½®">LLM API å¯é¥æªéç½®</h3>
<p>å¦æå¯å¨æ¶éå°ä»¥ä¸éè¯¯ææå¡æ æ³æ­£å¸¸å¯å¨ï¼</p>
<ul>
<li>ConfigCenter æå¡å¯å¨å¤±è´¥</li>
<li>Web åç«¯æ æ³è®¿é® AI åè½</li>
<li>æ§å¶å°æç¤ºç¼ºå° LLM éç½®åæ°</li>
</ul>
<p><strong>è§£å³æ¹æ¡</strong>ï¼</p>
<ol>
<li>
<p><strong>æ£æ¥åæ°æ¯å¦å·²éç½®</strong>ï¼</p>
<pre><code class="language-bash"># æ¥ç User Secretsï¼å¦æä½¿ç¨ï¼
cd Src/CodeSpirit.AppHost
dotnet user-secrets list
</code></pre>
</li>
<li>
<p><strong>éç½®ç¼ºå¤±çåæ°</strong>ï¼</p>
<ul>
<li>åè <a href="#%E5%BF%85%E5%A1%AB%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE" rel="noopener nofollow">å¿å¡«åæ°éç½®</a> ç« è</li>
<li>ç¡®ä¿è³å°éç½®äº <code>llm-ApiKey</code> å <code>ai-form-fill-llm-ApiKey</code> ä¸¤ä¸ªå¿å¡«åæ°</li>
</ul>
</li>
<li>
<p><strong>éªè¯éç½®</strong>ï¼</p>
<ul>
<li>éå¯åºç¨åï¼æ£æ¥ Aspire Dashboard ä¸­çæå¡ç¶æ</li>
<li>æ¥çæå¡æ¥å¿ç¡®è®¤åæ°æ¯å¦æ­£ç¡®å è½½</li>
</ul>
</li>
</ol>
<blockquote>
<p><strong>æç¤º</strong>: å¦æææ¶ä¸éè¦ä½¿ç¨ AI åè½ï¼å¯ä»¥è®¾ç½®å ä½ç¬¦å¼ï¼å¦ <code>placeholder-key</code>ï¼ï¼ä½ç¸å³ AI åè½å°æ æ³æ­£å¸¸å·¥ä½ã</p>
</blockquote>
<h2 id="å¼åæ¨¡å¼">å¼åæ¨¡å¼</h2>
<h3 id="ç­éè½½å¼å">ç­éè½½å¼å</h3>
<pre><code class="language-bash"># å¯ç¨ç­éè½½
cd Src/CodeSpirit.AppHost
dotnet watch run
</code></pre>
<h3 id="è°è¯æ¨¡å¼">è°è¯æ¨¡å¼</h3>
<p>å¨Visual StudioæVS Codeä¸­è®¾ç½®æ­ç¹ï¼æF5å¯å¨è°è¯ã</p>
<h2 id="çäº§ç¯å¢é¨ç½²">çäº§ç¯å¢é¨ç½²</h2>
<h3 id="ä½¿ç¨kubernetesé¨ç½²">ä½¿ç¨Kubernetesé¨ç½²</h3>
<p>é¡¹ç®æä¾äºå®æ´çKubernetesé¨ç½²æä»¶ï¼</p>
<pre><code class="language-bash"># é¨ç½²å°Kuberneteséç¾¤
kubectl apply -f k8s/

# æ¥çé¨ç½²ç¶æ
kubectl get pods -n code-spirit-release
</code></pre>
<h3 id="ä½¿ç¨dockeré¨ç½²">ä½¿ç¨Dockeré¨ç½²</h3>
<pre><code class="language-bash"># æå»ºæææå¡çDockeréå
dotnet publish CodeSpirit.sln -c Release

# ä½¿ç¨é¡¹ç®æä¾çDockerfileæå»ºéå
docker build -f Src/CodeSpirit.Web/Dockerfile -t codespirit-web:latest .
docker build -f Src/CodeSpirit.IdentityApi/Dockerfile -t codespirit-identity:latest .
</code></pre>
<h3 id="éç½®ç®¡ç">éç½®ç®¡ç</h3>
<p>çäº§ç¯å¢éç½®éè¿ä»¥ä¸æ¹å¼ç®¡çï¼</p>
<ul>
<li><strong>Kubernetes ConfigMap</strong>: å­å¨åºç¨éç½®</li>
<li><strong>Kubernetes Secret</strong>: å­å¨ææä¿¡æ¯</li>
<li><strong>éç½®ä¸­å¿</strong>: å¨æéç½®ç®¡ç</li>
</ul>
<h2 id="ä¸ä¸æ­¥">ä¸ä¸æ­¥</h2>
<p>ç¯å¢æ­å»ºå®æåï¼æ¨å¯ä»¥ï¼</p>
<ol>
<li>ð éè¯» <a href="./%E9%A1%B9%E7%9B%AE%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1.md" target="_blank" rel="noopener nofollow">é¡¹ç®æ´ä½æ¶æè®¾è®¡</a></li>
<li>ð§ äºè§£ <a href="./CodeSpirit.Core%E6%A0%B8%E5%BF%83%E6%A1%86%E6%9E%B6.md" target="_blank" rel="noopener nofollow">CodeSpirit.Coreæ ¸å¿æ¡æ¶</a></li>
<li>ð æ¥ç <a href="./%E6%80%BB%E4%BD%93%E6%8A%80%E6%9C%AF%E4%BD%93%E7%B3%BB%E8%AF%B4%E6%98%8E.md" target="_blank" rel="noopener nofollow">æ»ä½ææ¯ä½ç³»è¯´æ</a></li>
<li>ð å­¦ä¹  <a href="./CodeSpirit%E7%BB%9F%E4%B8%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%8C%87%E5%8D%97.md" target="_blank" rel="noopener nofollow">ç»ä¸å¼å¸¸å¤çæå</a></li>
<li>ð» åè <a href="./CRUD%E5%BC%80%E5%8F%91%E7%A4%BA%E4%BE%8B.md" target="_blank" rel="noopener nofollow">CRUDå¼åç¤ºä¾</a> å¼å§å¼å</li>
</ol>
<h2 id="è·åå¸®å©">è·åå¸®å©</h2>
<p>å¦æéå°é®é¢ï¼è¯·åèï¼</p>
<ul>
<li><a href="https://github.com/your-org/code-spirit/issues" target="_blank" rel="noopener nofollow">GitHub Issues</a></li>
<li><a href="https://github.com/your-org/code-spirit/wiki" target="_blank" rel="noopener nofollow">é¡¹ç®Wiki</a></li>
<li><a href="https://github.com/your-org/code-spirit/discussions" target="_blank" rel="noopener nofollow">è®¨è®ºåº</a></li>
</ul>
<p>ç¥æ¨å¼åæå¿«ï¼ð</p>

</div>
<div id="MySignature" role="contentinfo">
    ä½èï¼<a href="http://www.cnblogs.com/codelove/" target="_blank">éªé</a><br>åºå¤ï¼<a href="http://www.cnblogs.com/codelove/" target="_blank">http://www.cnblogs.com/codelove/</a>
<br>å¦æåæ¬¢ä½èçæç« ï¼è¯·å³æ³¨ãCodeSpirit-ç çµãå¬ä¼å·ä»¥ä¾¿ç¬¬ä¸æ¶é´è·å¾ææ°åå®¹ãæ¬æçæå½ä½èææï¼æ¬¢è¿è½¬è½½ï¼ä½æªç»ä½èåæå¿é¡»ä¿çæ­¤æ®µå£°æï¼ä¸å¨æç« é¡µé¢ææ¾ä½ç½®ç»åºåæè¿æ¥ï¼å¦åä¿çè¿½ç©¶æ³å¾è´£ä»»çæå©ã<br><b>éå¬é¸è¯­è±é¦ï¼æ¼«èµäºå·äºèã</b>
<br>
<img src="https://images.cnblogs.com/cnblogs_com/codelove/315887/o_251224070213_%E5%85%AC%E4%BC%97%E5%8F%B7.jpg" width="100" height="100">
</div>
<div class="clear"></div>

		</div>
		<div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2025-12-29 15:08">2025-12-29 15:07</span>&nbsp;
<a href="https://www.cnblogs.com/codelove">éªé</a>&nbsp;
éè¯»(<span id="post_view_count">117</span>)&nbsp;
è¯è®º(<span id="post_comment_count">1</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19392132);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19392132', targetLink: 'https://www.cnblogs.com/codelove/p/19392132', title: 'CodeSpirit å¼åç¯å¢æ­å»ºåå¯å¨æå' })">ä¸¾æ¥</a>
</div>
	 ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ æ°çMOSï¼My Oracle Supportï¼ä¸»è¦åå ]]></title>
    <link>https://www.cnblogs.com/jyzhao/p/19415968/xin-banmosmy-oracle-support-zhu-yao-bian-hua</link>
    <guid>d1cc4f63ff929d5583c419ed845a7d85</guid>
    <description>
    <![CDATA[ 
    <a name="top"></a>
    <h2><a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/jyzhao/p/19415968/xin-banmosmy-oracle-support-zhu-yao-bian-hua" title="åå¸äº 2025-12-29 15:01">
    <span role="heading" aria-level="2">æ°çMOSï¼My Oracle Supportï¼ä¸»è¦åå</span>
    

</a>
</h2>
    <small>
<span id="post-date" data-last-update-days="0" data-date-updated="2025-12-29 15:01">2025-12-29 15:01</span>&nbsp;
<a href="https://www.cnblogs.com/jyzhao">AlfredZhao</a>&nbsp;
éè¯»(<span id="post_view_count">24</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19415968);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19415968', targetLink: 'https://www.cnblogs.com/jyzhao/p/19415968/xin-banmosmy-oracle-support-zhu-yao-bian-hua', title: 'æ°çMOSï¼My Oracle Supportï¼ä¸»è¦åå' })">ä¸¾æ¥</a>
</small>
    <div class="entry">
        <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<p>æ¬æ My Oracle Support åäºå¨é¢çåçº§ãOracle ç¡¬ä»¶ãè½¯ä»¶åæç®¡äºæå¡çæ¯æä¹å¨é¨è¿ç§»è³å¨æ°çæ¯æå¹³å°ãææ SR çåå»ºãæ´æ°ä¸ç®¡çæä½ä¹é½å°å¨è¿ä¸æ°å¹³å°ä¸å®æï¼åæ¥çç³»ç»å°ä¸åä½¿ç¨ã</p>
<p>å³äºæ°çMOSï¼å¾å¤æ©å·²çæå¤å¹´èçæ¬MOSçä»ä¸èæäºæå¿ï¼å®éä¸ï¼æ°çå¹¶æ²¡æå¢å ä»»ä½ä½¿ç¨é¾åº¦ï¼åèæ¯æå¤§å°éä½äºMOSä½¿ç¨é¨æ§ã</p>
<p>ä½è¿æ¯æä¸äºä¼åé¡¹å¯è½ä¼è®©èç¨æ·å¨åå¼å§æ¥è§¦æ°ççæ¶åæäºéçï¼è¿éååºæ¥è®©å¤§å®¶æåæ³¨æä¸ï¼åå°å¿ä¸­ææ°ï¼</p>
<h2 id="01--mosç¥è¯åºä¸­çæç« å·å½åé£æ ¼æ¹å">01 | MOSç¥è¯åºä¸­çæç« å·å½åé£æ ¼æ¹å</h2>
<p>æ°çæ¯<code>KB+ä¸ç»æ°å­</code>ï¼æ§çæ¯<code>æ°å­.æ°å­</code>æ ¼å¼ã</p>
<p>ä½æ¯ç¬èäº²æµå¯¹äºæäºæ¯è¾å¸¸ç¨çææ¡£æ¯å¯ä»¥éè¿æ§çæç´¢å°çï¼ä½è¿æ¯å»ºè®®çææ°ççå½åé£æ ¼ã</p>
<p>æ¯å¦çæExadataçå°ä¼ä¼´é½è³çè½è¯¦çä¸ç¯ææ¡£å·ï¼<code>888828.1</code></p>
<p>å¨æ°çæç´¢ä¹è½æ£ç´¢å°ï¼æ°çç»å®çç¼å·å°±æ¯ <code>KB153930</code></p>
<p><img src="https://img2024.cnblogs.com/blog/635610/202512/635610-20251229150101685-1968954989.jpg" alt="" loading="lazy"></p>
<p>æå¼åï¼ä¹å¯ä»¥çå°éé¢ä¼è¯´æå°±æ¯å¯¹åºä¹åç 888828.1ï¼</p>
<p><img src="https://img2024.cnblogs.com/blog/635610/202512/635610-20251229150101698-2096446677.jpg" alt="" loading="lazy"></p>
<h2 id="02--mosä¸è½½è¡¥ä¸å¥å£æ´å ä¾¿å©">02 | MOSä¸è½½è¡¥ä¸å¥å£æ´å ä¾¿å©</h2>
<p>ä¹åç³»ç»ä¸è½½è¡¥ä¸ä»è´¨æ¶ï¼å¾å¤æ°æçè³é½æ¾ä¸å°åéçå¥å£ãç°å¨æ°çåå¾éå¸¸ç®åï¼å¨ä¸»é¡µé¢è¿éçæç´¢æ¡ç´æ¥éæ©è¡¥ä¸è¿ä¸ªåç±»ã</p>
<p><img src="https://img2024.cnblogs.com/blog/635610/202512/635610-20251229150101696-686065035.jpg" alt="" loading="lazy"></p>
<p>å°±ä¼å¼¹åºçªå£ï¼å¯ä»¥æéè¾å¥æéè¡¥ä¸ä¿¡æ¯ï¼Applyå³å¯çå°å¯¹åºçå¥å£ï¼</p>
<p><img src="https://img2024.cnblogs.com/blog/635610/202512/635610-20251229150101584-539479973.jpg" alt="" loading="lazy"></p>
<h2 id="03--sråç¼æ°å­æ¹åä¸º4-å¼å¤´">03 | SRåç¼æ°å­æ¹åä¸º4-å¼å¤´</h2>
<p>ä¹åçSRå·ç é½æ¯<code>3-</code>å¼å¤´å ä¸æ®µæ°å­ï¼ç°å¨æ¯<code>4-</code>å¼å¤´å ä¸æ®µæ°å­ï¼å ä¸ºç¬èçè´¦å·æ²¡æåå»ºä»»ä½SRï¼æä»¥çä¸å°è¿ä¸ªååãæè½çSRæéçå°ä¼ä¼´å¯ä»¥å¸®å¿ç¡®è®¤ä¸ï¼æ¬¢è¿çè¨ã</p>
<h2 id="04--ä¿®æ¹è´¦æ·ä¿¡æ¯æ¶éæ³¨æå®å¨pin">04 | ä¿®æ¹è´¦æ·ä¿¡æ¯æ¶éæ³¨æå®å¨PIN</h2>
<p>å¨ è´¦æ· -&gt; é¦éé¡¹ä¸é¢ï¼å¡«åè´¦å·ä¿¡æ¯æ¶ï¼æä¸ä¸ª <code>å®å¨PIN</code> æ®è¯´å¨SRçµè¯æ²éè¿ç¨ä¸­ï¼åå°ä¼è¦æ±ä½ æä¾è¿ä¸ªç æå¯ä»¥ãè¿æ¯ä¸ä¸ªå å¼ºå®å¨æ§çèèãç¬èæ²¡æè¿ä¸ªéæ±ï¼æè¿ä¸ªéæ±çå°ä¼ä¼´ä¹å¯ä»¥å¸®å¿ç¡®è®¤ä¸äºå®æ¯å¦å¦æ­¤ã</p>
<p>å¦å¤ï¼ååå·¥ç¨å¸ä¸ºæ­¤ä¸é¨å½å¶è¿ä¸æ®µè¯¦ç»çä¸­æä»ç»è§é¢ï¼æå´è¶£çåå­¦å¯ä»¥ç´æ¥ç»å½æ°çMOSï¼æç´¢ <code>KB822414</code> çå°è¿ç¯ä¸­æçæç« åè§é¢ã</p>
<p>å ä¸ºè¿æ¯ä¸ç¯ä¸­æçææ¡£ï¼å¦æé»è®¤æ¥ä¸å°ï¼æ³¨ææç´¢è¯­è¨åæ¢æä¸­æå³å¯ã</p>
<p><img src="https://img2024.cnblogs.com/blog/635610/202512/635610-20251229150101687-372899130.jpg" alt="" loading="lazy"></p>

</div>
<div id="MySignature" role="contentinfo">
    <a href="https://www.cnblogs.com/jyzhao/" target="_blank">AlfredZhao</a>Â©çæææãä»Oracleèµ·èªï¼é¢ç¥ç²¾å½©çITææ¯ãã<br>
è½¬è½½è¯·æ³¨æåæé¾æ¥ï¼<a href="https://www.cnblogs.com/jyzhao/p/19415968/xin-banmosmy-oracle-support-zhu-yao-bian-hua" target="_blank">https://www.cnblogs.com/jyzhao/p/19415968/xin-banmosmy-oracle-support-zhu-yao-bian-hua</a>
<hr>
<div style="text-align:center; margin-top:30px;">
  <p style="font-size:14px;color:#555;">
    ð æè°¢éè¯»ï¼æ¬¢è¿å³æ³¨æçå¬ä¼å· <b>ãèµµéå®ã</b>
  </p>
  <img src="https://images.cnblogs.com/cnblogs_com/jyzhao/824234/o_250208075013_qrcode-zjy.jpg" width="160" style="border:1px solid #ddd;border-radius:8px;">
</div>
</div>
<div class="clear"></div>

        <div class="clear"></div>
        
</div>
    <ul class="postmetadata">
        <vc:categories-tags blog-app="jyzhao" blog-id="186567" post-id="19415968"></vc:categories-tags>
    </ul>
 ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ å½æè¯å¾ææ¸æ¥ FFmpeg çç¡¬ä»¶å éæ¶ï¼æåäºä¸ä¸ªè½èªå¨æ£æµææ GPU ç¼ç å¨çå°å·¥å· ]]></title>
    <link>https://www.cnblogs.com/hyb1/p/19415077</link>
    <guid>3b62bc54efd0ad9d06e4d73683d62d9f</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/hyb1/p/19415077" title="åå¸äº 2025-12-29 12:04">
    <span role="heading" aria-level="2">å½æè¯å¾ææ¸æ¥ FFmpeg çç¡¬ä»¶å éæ¶ï¼æåäºä¸ä¸ªè½èªå¨æ£æµææ GPU ç¼ç å¨çå°å·¥å·</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                    <div id="cnblogs_post_description" style="display: none">
        
        ffmpeg ç¡¬ä»¶å é GPUç¼ç  è§é¢ç¼è§£ç  NVEnc NVDec Intel QSV AMD AMF VAAPI Vulkan è§é¢ç¼ç  VideoToolbox Media Foundation DXVA2 D3D11VA D3D12VA
    </div>
<div id="cnblogs_post_body" class="blogpost-body blogpost-body-html">
<p style="white-space: normal"><span style="white-space: pre-wrap">å¨è¿å»çå å¹´éï¼æ¬äººééç»­ç»­æ¥è§¦äºä¸å°è§é¢å¤çç¸å³çé¡¹ç®ãæ¯å½æ¶åå°FFmpegçç¡¬ä»¶å éé¨åï¼æ¬äººé½ä¼é·å¥ä¸ç§âä¿¡æ¯è¿è½½âçç¶æï¼ææ¡£å¾å¤ãæ¥å£å¾å¤ãé©±å¨å·®å¼å·¨å¤§ï¼çè³åä¸å°æºå¨å¨ä¸åç³»ç»ä¸çè¡¨ç°é½ä¸ä¸æ ·ã</span></p>
<p style="white-space: normal"><span style="white-space: pre-wrap">å¦ææ¨ä¹æ¾ç»å°è¯è¿è®©FFmpegè°ç¨GPUç¼ç /è§£ç å¨ï¼å¤§æ¦çä¼éå°ç±»ä¼¼çæåµï¼</span></p>
<ul style="white-space: normal">
<li style="white-space: normal">
<p style="white-space: normal"><span style="white-space: pre-wrap">æææ¾å¡æ¯æ H.265ï¼å´å§ç»æ æ³æ­£å¸¸ç¼ç </span></p>
</li>
<li style="white-space: normal">
<p style="white-space: normal"><span style="white-space: pre-wrap">NVEncãQSVãAMFãVAAPIâ¦â¦å°åºåªä¸ªè½ç¨ï¼</span></p>
</li>
<li style="white-space: normal">
<p style="white-space: normal"><span style="white-space: pre-wrap">ä¸ºä»ä¹ 1080p å¯ä»¥ï¼4K å´å¤±è´¥</span></p>
</li>
<li style="white-space: normal">
<p style="white-space: normal"><span style="white-space: pre-wrap">Windows å Linux çç¡¬ä»¶å éæ¥å£å®å¨ä¸æ¯ä¸å¥é»è¾</span></p>
</li>
<li style="white-space: normal">
<p style="white-space: normal"><span style="white-space: pre-wrap">FFmpeg çâæ¯æåè¡¨âå¹¶ä¸è½ä»£è¡¨ä½ çè®¾å¤ççæ¯æ</span></p>
</li>
</ul>
<p style="white-space: normal"><span style="white-space: pre-wrap">è¿äºé®é¢çä¼¼ç®åï¼ä½çæ­£ææ¥èµ·æ¥éå¸¸èæ¶é´åååã äºæ¯æ¬äººå¹²èåäºä¸ä¸ªå·¥å·ï¼è®©å®èªå¨å¸®ææææç¡¬ä»¶ç¼ç å¨åè§£ç å¨é½æµä¸éã</span></p>
<p style="white-space: normal"><span style="white-space: pre-wrap">è¿ä¸ªå·¥å·å°±æ¯ï¼ <span style="font-size: 16px"><strong style="white-space: normal">HwCodecDetect</strong> </span></span></p>
<p style="white-space: normal"><span style="white-space: pre-wrap; font-size: 15px">GitHub å°åï¼ <a href="https://github.com/whyb/HwCodecDetect" target="_blank" rel="noopener nofollow"><span style="white-space: normal" data-url="https://github.com/whyb/HwCodecDetect">https://github.com/whyb/HwCodecDetect</span></a></span></p>
<h1 style="white-space: normal">FFmpeg çç¡¬ä»¶å éçæï¼å¤æï¼ä½çå®</h1>
<p style="white-space: normal"><span style="white-space: pre-wrap">å¦æåªç¨ CPU ç¼ç ï¼FFmpeg çä½éªéå¸¸ç»ä¸ï¼ä½ä¸æ¦æ¶å GPUï¼æåµå°±å®å¨ä¸åäºã</span></p>
<h2 style="white-space: normal">å¤ååãå¤æ¥å£ãå¤åå²åè¢±</h2>
<p style="white-space: normal"><span style="white-space: pre-wrap">ä¸åååæä¸åçç¡¬ä»¶å éæ¥å£ï¼</span></p>
<ul style="white-space: normal">
<li style="white-space: normal">
<p style="white-space: normal"><span style="white-space: pre-wrap"><strong style="white-space: pre-wrap">NVIDIA</strong>ï¼NVEnc / NVDec</span></p>
</li>
<li style="white-space: normal">
<p style="white-space: normal"><span style="white-space: pre-wrap"><strong style="white-space: pre-wrap">Intel</strong>ï¼QSV</span></p>
</li>
<li style="white-space: normal">
<p style="white-space: normal"><span style="white-space: pre-wrap"><strong style="white-space: pre-wrap">AMD</strong>ï¼AMF</span></p>
</li>
<li style="white-space: normal">
<p style="white-space: normal"><span style="white-space: pre-wrap"><strong style="white-space: pre-wrap">Apple</strong>ï¼VideoToolbox</span></p>
</li>
<li style="white-space: normal">
<p style="white-space: normal"><span style="white-space: pre-wrap"><strong style="white-space: pre-wrap">Linux</strong>ï¼VAAPI / Vulkan</span></p>
</li>
<li style="white-space: normal">
<p style="white-space: normal"><span style="white-space: pre-wrap"><strong style="white-space: pre-wrap">Windows</strong>ï¼Media Foundation / DXVA2 / D3D11VA / D3D12VA</span></p>
</li>
</ul>
<p style="white-space: normal"><span style="white-space: pre-wrap">è¿äºæ¥å£ä¹é´æ²¡æç»ä¸æ åï¼çè³åä¸ååå¨ä¸åç³»ç»ä¸çè¡¨ç°ä¹ä¸ä¸è´ã</span></p>
<h2 style="white-space: normal">âæ¯æâä¸ç­äºâå¯ç¨â</h2>
<p style="white-space: normal"><span style="white-space: pre-wrap">FFmpeg ææ¡£éåçâæ¯æææç¼ç å¨âï¼ä½å®éæåµå¯è½æ¯ï¼</span></p>
<ul style="white-space: normal">
<li style="white-space: normal">
<p style="white-space: normal"><span style="white-space: pre-wrap">é©±å¨çæ¬ä¸å¤</span></p>
</li>
<li style="white-space: normal">
<p style="white-space: normal"><span style="white-space: pre-wrap">æ¾å¡æ¶æä¸æ¯ææä¸ªåè¾¨ç</span></p>
</li>
<li style="white-space: normal">
<p style="white-space: normal"><span style="white-space: pre-wrap">ç³»ç»ç¼ºå°ä¾èµ</span></p>
</li>
<li style="white-space: normal">
<p style="white-space: normal"><span style="white-space: pre-wrap">FFmpeg ç¼è¯åæ°ä¸å®æ´</span></p>
</li>
<li style="white-space: normal">
<p style="white-space: normal"><span style="white-space: pre-wrap">æäºæ¥å£åªæ¯æè§£ç ï¼ä¸æ¯æç¼ç </span></p>
</li>
</ul>
<p style="white-space: normal"><span style="white-space: pre-wrap">ä½ ä¸æµè¯ï¼æ ¹æ¬ä¸ç¥éä½ çæºå¨å°åºè½ä¸è½ç¨ã</span></p>
<h1 style="white-space: normal">HwCodecDetectï¼æææç¡¬ä»¶ç¼ç å¨é½è·ä¸éï¼ç»æä¸ç®äºç¶</h1>
<p style="white-space: normal"><span style="white-space: pre-wrap">è¿ä¸ªå·¥å·çæ ¸å¿ç®æ éå¸¸ç´æ¥ï¼</span></p>
<blockquote style="white-space: normal">
<p style="white-space: normal"><span style="white-space: pre-wrap"><strong style="white-space: pre-wrap">èªå¨æ£æµå½åç³»ç»ä¸ææå¯ç¨çç¡¬ä»¶ç¼ç å¨/è§£ç å¨ï¼å¹¶æµè¯å®ä»¬è½å¤ççæå¤§åè¾¨çã</strong></span></p>
</blockquote>
<p style="white-space: normal"><span style="white-space: pre-wrap">å®çå·¥ä½æ¹å¼æ¯ï¼</span></p>
<ol style="white-space: normal" start="1">
<li style="white-space: normal">
<p style="white-space: normal"><span style="white-space: pre-wrap">èªå¨çæä¸ååè¾¨ççæµè¯è§é¢ï¼ä» 240p å° 8Kï¼</span></p>
</li>
<li style="white-space: normal">
<p style="white-space: normal"><span style="white-space: pre-wrap">ä½¿ç¨ FFmpeg è°ç¨åç§ç¡¬ä»¶ç¼ç å¨</span></p>
</li>
<li style="white-space: normal">
<p style="white-space: normal"><span style="white-space: pre-wrap">è®°å½æåä¸å¤±è´¥</span></p>
</li>
<li style="white-space: normal">
<p style="white-space: normal"><span style="white-space: pre-wrap">è¾åºä¸ä»½æ¸æ°çæ£æµæ¥å</span></p>
</li>
</ol>
<p style="white-space: normal"><span style="white-space: pre-wrap">æ¯æçç¼ç å¨åæ¬ï¼</span></p>
<ul style="white-space: normal">
<li style="white-space: normal">
<p style="white-space: normal"><span style="white-space: pre-wrap">NVEnc / NVDec</span></p>
</li>
<li style="white-space: normal">
<p style="white-space: normal"><span style="white-space: pre-wrap">QSV</span></p>
</li>
<li style="white-space: normal">
<p style="white-space: normal"><span style="white-space: pre-wrap">AMF</span></p>
</li>
<li style="white-space: normal">
<p style="white-space: normal"><span style="white-space: pre-wrap">VAAPI</span></p>
</li>
<li style="white-space: normal">
<p style="white-space: normal"><span style="white-space: pre-wrap">Vulkan</span></p>
</li>
<li style="white-space: normal">
<p style="white-space: normal"><span style="white-space: pre-wrap">Media Foundation</span></p>
</li>
<li style="white-space: normal">
<p style="white-space: normal"><span style="white-space: pre-wrap">DXVA2 / D3D11VA / D3D12VA</span></p>
</li>
<li style="white-space: normal">
<p style="white-space: normal"><span style="white-space: pre-wrap">Apple VideoToolbox</span></p>
</li>
</ul>
<p style="white-space: normal"><span style="white-space: pre-wrap">åºæ¬è¦çäºç®åææä¸»æµ GPU å éæ¥å£ã</span></p>
<h1 style="white-space: normal">ä¸ºä»ä¹æéè¦è¿æ ·ä¸ä¸ªå·¥å·ï¼</h1>
<p style="white-space: normal"><span style="white-space: pre-wrap">æ¬äººåè¿ä¸ªå·¥å·çåå å¶å®å¾ç®åï¼</span></p>
<h3 style="white-space: normal">1. æ¬äººä¸æ³åçæ¾å¡å°åºè½ä¸è½ç¨</h3>
<p style="white-space: normal"><span style="white-space: pre-wrap">ä¸åæ¾å¡ãä¸åé©±å¨ãä¸åç³»ç»ï¼ç»åèµ·æ¥å°±æ¯ä¸å æªç¥æ°ã</span></p>
<h3 style="white-space: normal">2. æ¬äººä¸æ³åæ¥ææ¡£</h3>
<p style="white-space: normal"><span style="white-space: pre-wrap">ææ¡£åå¾åè¯¦ç»ï¼ä¹ä¸å¦ç´æ¥è·ä¸éæ¥å¾åç¡®ã</span></p>
<h3 style="white-space: normal">3. æ¬äººä¸æ³åè¢«é©±å¨å</h3>
<p style="white-space: normal"><span style="white-space: pre-wrap">é©±å¨æ´æ°åç¼ç è½åååæ¯å¸¸è§æåµï¼èªå¨æ£æµè½é¿åè¸©åã</span></p>
<h3 style="white-space: normal">4. æ¬äººå¸æå®è½æä¸ºâè§é¢å¤çå·¥ç¨å¸çä½æ£å·¥å·â</h3>
<p style="white-space: normal"><span style="white-space: pre-wrap">è·ä¸æ¬¡ï¼ä½ å°±ç¥éä½ çæºå¨å°åºè½å¹²ä»ä¹ã</span></p>
<h1 style="white-space: normal">å¦ä½ä½¿ç¨ï¼éå¸¸ç®åï¼</h1>
<h2 style="white-space: normal">æ¹å¼ä¸ï¼pip å®è£ï¼æ¨èï¼</h2>
<div class="cnblogs_code">
<pre>pip <span style="color: rgba(0, 0, 255, 1)">install</span><span style="color: rgba(0, 0, 0, 1)"> hwcodecdetect
hwcodecdetect</span></pre>
</div>
<h2 style="white-space: normal">æ¹å¼äºï¼ä¸è½½å¯æ§è¡æä»¶ï¼æ é Pythonï¼</h2>
<p style="white-space: normal"><span style="white-space: pre-wrap">Releases é¡µé¢ï¼ <a href="https://github.com/whyb/HwCodecDetect/releases" target="_blank" rel="noopener nofollow"><span style="white-space: pre-wrap" data-url="https://github.com/whyb/HwCodecDetect/releases">https://github.com/whyb/HwCodecDetect/releases</span></a></span></p>
<p style="white-space: normal"><span style="white-space: pre-wrap">ä¸è½½å¯¹åºç³»ç»çå¯æ§è¡æä»¶å³å¯è¿è¡ã</span></p>
<h2 style="white-space: normal">æ¹å¼ä¸ï¼ä»æºç å®è£</h2>
<div style="white-space: normal">
<div class="rounded-b-xl bg-background-static-850 px-4 pb-1.5 dark:bg-background-static-900">
<div style="white-space: pre">
<div class="cnblogs_code">
<pre>git clone https:<span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">github.com/whyb/HwCodecDetect.git</span>
<span style="color: rgba(0, 0, 0, 1)">cd HwCodecDetect
pip </span><span style="color: rgba(0, 0, 255, 1)">install</span><span style="color: rgba(0, 0, 0, 1)"> .
hwcodecdetect</span></pre>
</div>
</div>
</div>
</div>
<h1 style="white-space: normal">æ£æµç»æé¿ä»ä¹æ ·ï¼</h1>
<p style="white-space: normal"><span style="white-space: pre-wrap">å·¥å·ä¼è¾åºä¸ä»½ç±»ä¼¼âç¡¬ä»¶è½åä½æ£æ¥åâçç»æï¼åå«ï¼</span></p>
<ul style="white-space: normal">
<li style="white-space: normal">
<p style="white-space: normal"><span style="white-space: pre-wrap">åªäºç¼ç å¨å¯ç¨</span></p>
</li>
<li style="white-space: normal">
<p style="white-space: normal"><span style="white-space: pre-wrap">åªäºè§£ç å¨å¯ç¨</span></p>
</li>
<li style="white-space: normal">
<p style="white-space: normal"><span style="white-space: pre-wrap">æ¯ä¸ªç¼ç å¨æ¯æçåè¾¨ç</span></p>
</li>
<li style="white-space: normal">
<p style="white-space: normal"><span style="white-space: pre-wrap">åªäºæ¥å£å¤±è´¥äº</span></p>
</li>
<li style="white-space: normal">
<p style="white-space: normal"><span style="white-space: pre-wrap">åªäºæ ¼å¼è¢«æ¾å¡ç¡¬ä»¶æ¯æ</span></p>
</li>
</ul>
<p style="white-space: normal"><span style="white-space: pre-wrap">å¯¹äºéè¦åè§é¢è½¬ç ãåªä½æå¡å¨ãAI è§é¢å¤çãäºæ¸²æçå¼åèæ¥è¯´ï¼è¿ä»½æ¥åéå¸¸æä»·å¼ã</span></p>
<p style="white-space: normal"><span style="white-space: pre-wrap">æææ¼ç¤ºï¼</span></p>
<p style="white-space: normal"><span style="white-space: pre-wrap"><img src="https://img2024.cnblogs.com/blog/511612/202512/511612-20251229115741599-1997577731.gif" alt="hwcodecdetect" loading="lazy"></span></p>
<p style="white-space: normal">&nbsp;</p>
<h1 style="white-space: normal">è¿ä¸ªé¡¹ç®éååªäºäººï¼</h1>
<p style="white-space: normal"><span style="white-space: pre-wrap">å¦ææ¨æ­£å¨åï¼</span></p>
<ul style="white-space: normal">
<li style="white-space: normal">
<p style="white-space: normal"><span style="white-space: pre-wrap">è§é¢è½¬ç æå¡</span></p>
</li>
<li style="white-space: normal">
<p style="white-space: normal"><span style="white-space: pre-wrap">FFmpeg èªå¨åèæ¬</span></p>
</li>
<li style="white-space: normal">
<p style="white-space: normal"><span style="white-space: pre-wrap">åªä½æå¡å¨ï¼Jellyfin / Emby / Plexï¼</span></p>
</li>
<li style="white-space: normal">
<p style="white-space: normal"><span style="white-space: pre-wrap">GPU å éæ¨çåå¤ç</span></p>
</li>
<li style="white-space: normal">
<p style="white-space: normal"><span style="white-space: pre-wrap">è§é¢ç¼ç æ§è½æµè¯</span></p>
</li>
<li style="white-space: normal">
<p style="white-space: normal"><span style="white-space: pre-wrap">å¤å¹³å°è§é¢å·¥å·å¼å</span></p>
</li>
</ul>
<p style="white-space: normal"><span style="white-space: pre-wrap">é£ä¹è¿ä¸ªå·¥å·è½å¸®ä½ èçå¤§éæ¶é´ã</span></p>
<h1 style="white-space: normal">æå</h1>
<p style="white-space: normal"><span style="white-space: pre-wrap">å¦æä½ è§å¾è¿ä¸ªå·¥å·å¯¹ä½ æå¸®å©ï¼æ¬¢è¿æ¥ <strong>GitHub</strong> ç¹ä¸ª Star åååï¼ä¹æ¬¢è¿åäº«ç»æ¨çåäºææåã</span></p>
<p style="white-space: normal"><span style="font-size: 18px"><a href="https://github.com/whyb/HwCodecDetect" target="_blank" rel="noopener nofollow"><span style="white-space: pre-wrap"><span style="white-space: pre-wrap" data-url="https://github.com/whyb/HwCodecDetect">https://github.com/whyb/HwCodecDetect</span></span></a></span></p>
<p style="white-space: normal"><span style="white-space: pre-wrap">å¦ææ¨å¨ä½¿ç¨è¿ç¨ä¸­éå°ä»»ä½é®é¢ï¼ä¹æ¬¢è¿å¨ issue éäº¤æµï¼æä¼æç»­ç»´æ¤åæ¹è¿ã</span></p>
<p style="white-space: normal">&nbsp;</p>
<p style="white-space: normal">&nbsp;</p>
<p style="white-space: normal">&nbsp;</p>
</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.003472222222222222" data-date-updated="2025-12-29 12:09">2025-12-29 12:04</span>&nbsp;
<a href="https://www.cnblogs.com/hyb1">éåºDebug</a>&nbsp;
éè¯»(<span id="post_view_count">200</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19415077);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19415077', targetLink: 'https://www.cnblogs.com/hyb1/p/19415077', title: 'å½æè¯å¾ææ¸æ¥ FFmpeg çç¡¬ä»¶å éæ¶ï¼æåäºä¸ä¸ªè½èªå¨æ£æµææ GPU ç¼ç å¨çå°å·¥å·' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ V8å¼æ ç²¾åæ¼«æ¸¸æå -è§£æç¯  è¯­æ³è§£æ AST ä½ç¨å é­å å­èç  ä¼å ä¸æéå³ ]]></title>
    <link>https://www.cnblogs.com/f20171110/p/19417566</link>
    <guid>a8bdba8eca3f29ef3bd108aad3aa0760</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/f20171110/p/19417566" title="åå¸äº 2025-12-29 18:17">
    <span role="heading" aria-level="2">V8å¼æ ç²¾åæ¼«æ¸¸æå -è§£æç¯  è¯­æ³è§£æ AST ä½ç¨å é­å å­èç  ä¼å ä¸æéå³</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                    <div id="cnblogs_post_description" style="display: none">
        
        åå®¹é¾æ¡å¦ä¸ï¼1è¯å«-2æµå¼å¤ç-3åå-4é¢è§£æåå¨éè§£æ-5è§£ææ¦è¿°-6è§£æå·ä½è¿ç¨.è¡¨è¾¾å¼çè§£æ-7å£°æçè§£æ-8å½æ°çè§£æ-9åéçè§£æ-10ç±»çè§£æ-11è¯­å¥çè§£æ
å¶ä¸­åå«åä¸ªå®æ´çç¥è¯ç¹åæ£å¨åé¨åï¼é­å  ä½ç¨å ä½ç¨åé¾/æ   ææ¶æ§æ­»åºãããå¯æç´¢å³é®å­æ¥æ¾ã
    </div>
<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<p>è¿æ¯å®æ´çä¸ç¯è¶é¿æç« ï¼åå®¹ä¸ºjavascript  V8å¼æç è¯æ³åæ è¯­æ³åæ ç¼è¯ æ§è¡ ä¼å  ç­å®æ´çä¸ä¸ªé¾æ¡ï¼åå®¹è¯¦ç¥å¾å½  å¯ä»¥æéè¦é¨åéè¯»  ä¹å¯ä»¥éç¯ä»ç»è§çã</p>
<p>ä¾æ§æ¯æ å¾æ ç ï¼ç½æé£æ ¼ãæè§å¾ï¼è½ç¨æå­æé»è¾æèæ¦å¿µè¡¨è¿°æ¸æ¥ï¼ä¸æ¯å¯¹ä½èæ¬èº«çè½åæåæå¥½å¤ï¼äºæ¯å¯¹è¯»èæ¥è¯´ æèæå­è¡¨è¾¾çåå®¹ æå©äºå¤ä½¿ç¨æ½è±¡æç»´åé»è¾æç»´è½åï¼æå»ºèªå·±çæèæ¨¡å¼ï¼ç¨ç°å¨æµè¡çè¯´æ³  å°±æ¯å¿æºæ¨¡åãä½ èªå·±ä»ä¹é½å¯ä»¥èè¡¥ï¼é£ä¸æ¯åå®³å¤§äºåã</p>
<p>ä¸é¢çè¯ä¸è¦ç¸ä¿¡ï¼å¶å®æå°±æ¯ä¸ºèªå·±ææ¾çåå£ã</p>
<p>è¿é¨ååå®¹ï¼è½å­¦ä¹ äºè§£ï¼å½ç¶æå¥½ï¼å¯¹å¹³æ¶çåç«¯å¼åï¼ä¹æå¥½å¤ï¼ä¸äºè§£ï¼ä¹ä¸å½±åæ¥å¸¸çå·¥ä½ãä½æ¯æ»ä½æ¥è¯´ï¼å¾å¤å¼åä¸­çé®é¢ï¼å¨è¿é¨ååå®¹ä¸­ é½å¯ä»¥æ¾å°æ ¹æºãæäºç»èåäºçç¥  æäºè¾¹çæåµåäºç®åè¡¨è¿°ãä¸è¿ ï¼  åç¡®æ§è¿æ¯ç¸å½ä¸éçãä¾æ§æ¯åæ±é«åç¡®æ§ï¼ç¬¦åè§èï¼è´´åå®ç°ã</p>
<p>ç¯å¹æ¯è¾é¿ï¼å¯ä»¥æéè¦éè¯»ï¼åå®¹é¾æ¡å¦ä¸ï¼</p>
<p>1è¯å«-2æµå¼å¤ç-3åå-4é¢è§£æåå¨éè§£æ-5è§£ææ¦è¿°-6è§£æå·ä½è¿ç¨.è¡¨è¾¾å¼çè§£æ-7å£°æçè§£æ-8å½æ°çè§£æ-9åéçè§£æ-10ç±»çè§£æ-11è¯­å¥çè§£æ</p>
<p>å¶ä¸­åå«åä¸ªå®æ´çç¥è¯ç¹åæ£å¨åé¨åï¼é­å  ä½ç¨å ä½ç¨åé¾/æ   ææ¶æ§æ­»åºãããå¯æç´¢å³é®å­æ¥æ¾ã</p>
<p>çæå£°æå¢ãããç å­ä¸æï¼çº¯èåçæ´è¾åºæ´ä¸æ</p>
<p>æ¬¢è¿ä»¥ä¼ æ­ç¥è¯ä¸ºç®ç<strong>å¨æ</strong>è½¬è½½ï¼è°¢ç»çæ®µæå½ã è°¢ç»æç§åæµéçè½¬è½½ã</p>
<h2 id="ä¸è¯æ³åæåè¯­æ³åæ">ä¸.è¯æ³åæåè¯­æ³åæ</h2>
<p>å½æµè§å¨ä»ç½ç»ä¸è½½äºjsæä»¶ï¼æ¯å¦app.jsï¼æµè§å¨å¼ææ¿å°çæåå½¢ææ¯ä¸ä¸²**å­èæµ **ã</p>
<ol>
<li>
<p><strong>è¯å«ï¼</strong>æµè§å¨æ ¹æ® HTTP ååºå¤´ï¼éå¸¸æ¯ <code>Content-Type: text/javascript; charset=utf-8</code> å°ä¸è½½çå­èæµ<strong>è§£ç ä¸ºå­ç¬¦æµ</strong>å¹¶äº¤ç» V8ã<strong>V8 å¨åå­ä¸­å­å¨å­ç¬¦ä¸²æ¶éç¨å¨æç¼ç ç­ç¥</strong>ï¼å¨å¯è¡çæåµä¸ä¼åä½¿ç¨åå­èï¼Latin-1ï¼æ ¼å¼å­å¨ï¼åªæå½å­ç¬¦ä¸²ä¸­åºç° Latin-1 èå´å¤çå­ç¬¦ï¼å¦ä¸­æãEmojiï¼æ¶ï¼æä¼è½¬ä¸º<strong>åå­èï¼UTF-16ï¼</strong>æ ¼å¼ã</p>
</li>
<li>
<p><strong>æµå¼å¿«éå¤çï¼</strong> å¼æå¹¶ä¸æ¯ç­æ´ä¸ªæä»¶ä¸è½½å®æå¼å§å¹²æ´»çãåªè¦ç½ç»ä¼ è¿æ¥ä¸æ®µæ°æ®ï¼V8 ç<strong>æ«æå¨</strong>å°±å¼å§å·¥ä½äºã è¿æ ·å¯ä»¥å å¿«å¯å¨éåº¦ãæ­¤æ¶çç¶æå°±æ¯æ¯«æ æä¹çå­ç¬¦  <code>c</code>, <code>o</code>, <code>n</code>, <code>s</code>, <code>t</code>, <code>   </code>, <code>a</code>, <code>   </code>, <code>=</code>, <code>   </code>, <code>1</code>, <code>;</code> ...</p>
</li>
<li>
<p>ç¶åçè¿ä¸æ­¥å« <strong>Tokenization è¯è¯­åå</strong>ã è´è´£è¿ä¸æ­¥çç»ä»¶å°±æ¯ä¸é¢æå°çå« <strong>Scannerï¼æ«æå¨ï¼</strong>ãå®çå·¥ä½å°±åæ¯ä¸ä¸ªåèå·¥ï¼ææ»æ»ä¸ç»è¿ç»µä¸æ­çå­ç¬¦ä¸²åæä¸ä¸ªä¸ªæè¯­æ³æä¹çæå°åä½ï¼å«å <strong>Tokenï¼è®°å·ï¼</strong>ãçå°è¿ä¸ªè¯ ï¼å¤§å®¶æ¯ä¸æ¯æè§å¿ä¸ç¼©ï¼æ²¡éï¼å°±æ¯å®ï¼<strong>å®ä»¬</strong>å°±æ¯ä»¥å®ä¸ºåä½æ¥æ¶å±é±çã</p>
<p>scanner åé¨æ¯ä¸ä¸ªç¶ææºãå®éä¸ªè¯»åå­ç¬¦ï¼</p>
<ul>
<li>è¯»å° <code>c</code>  å¯è½æ¯ <code>const</code>ï¼ä¹å¯è½æ¯åéåï¼ç»§ç»­ã</li>
<li>è¯»å° <code>o</code>, <code>n</code>, <code>s</code>, <code>t</code>  åé½äº5ä¸ªå¨ï¼<strong>ä¸ä¸ä¸ä¸ªå­ç¬¦ä¸æ¯å­æ¯ï¼æ¯å¦æ¯ç©ºæ ¼ï¼</strong>ï¼ç¡®è®¤è¿æ¯ä¸ä¸ªå³é®å­ constãâï¼é²æ­¢è¯¯å¤ <code>constant</code> è¿ç§åéåï¼</li>
<li>è¯»å° <code>   </code> ç©ºæ ¼ å¿½ç¥ï¼è·³è¿å»ã</li>
<li>è¯»å° <code>1</code>   è¿æ¯ä¸ä¸ªæ°å­ã</li>
</ul>
<p>è¿æ ·å°±ç±åæ¥çå­èæµåæäº <strong>Token æµ</strong>ãè¿æ¯ä¸ç§æå¹³çåè¡¨ç»æã</p>
<ul>
<li><strong>æºç ï¼</strong> <code>const a = 1;</code></li>
<li><strong>Token æµï¼</strong>
<ul>
<li><code>CONST</code> (å³é®å­)</li>
<li><code>IDENTIFIER</code> (å¼ä¸º "a")</li>
<li><code>ASSIGN</code> (ç¬¦å· "=")</li>
<li><code>SMI</code> (å°æ´æ° "1")</li>
<li><code>SEMICOLON</code> (ç¬¦å· ";")</li>
</ul>
</li>
</ul>
<p>è¿ä¸æ­¥ï¼æ³¨éåå¤ä½çç©ºæ ¼åæ¢è¡ç¬¦ä¼è¢«æå¼ã</p>
</li>
<li>
<p>ç°å¨å°±æ¯è§£æé¶æ®µäº</p>
<p>å¶å®è§£ææ¯ä¸ä¸ªæ»ç§°ï¼å®åä¸º å¨éè§£æ å é¢è§£æ ä¸¤ç§å½¢å¼ã</p>
<p>è¿å°±æ¯v8çæè§£ææºå¶ãçå°è¿ä¸ªæå­ï¼ä¹å·®ä¸å¤è½æç½äºå§ã</p>
<p>å¯¹äºé£äº<strong>ä¸æ¯ç«å³æ§è¡</strong>çå½æ°ï¼æ¯å¦ç¹å»æé®æè§¦åçåè°ï¼ï¼V8 ä¼åç¨é¢è§£æå¿«éæ«ä¸éã</p>
<p>æ£æ¥åºæ¬çè¯­æ³éè¯¯ï¼æ¯å¦ææ²¡æå°åæ¬å·ï¼ï¼<strong>ç¡®è®¤è¿æ¯ä¸ä¸ªå½æ°</strong>ãå¹¶ä¸ä¼çæå¤æç AST ç»æï¼ä¹ä¸å»ºç«å·ä½çåéç»å®ï¼åªè¿è¡æåºç¡çé­åå¼ç¨æ£æ¥ãå¾¡å§åçç»ææ¯è¿ä¸ªå½æ°å¨åå­éåªæ¯ä¸ä¸ªå¾å°ç<strong>å ä½ç¬¦</strong>ï¼è·³è¿åé¨ç»èã</p>
<p>èåªæé£äº<strong>ç«å³æ§è¡å½æ°</strong>æèé¡¶å±ä»£ç ï¼æä¼è¿å¥çæ­£çå¨éè§£æï¼è¿è¡å®æ´ç AST æå»ºã</p>
<p>é£ä¹ï¼é®é¢å°±æ¥äºï¼v8æä¹å¤æ­å°åºæ¯ä½¿ç¨é¢è§£æè¿æ¯ä½¿ç¨å¨éè§£æå¢ï¼</p>
<p>å®çååå°±æ¯  ææ°ä¸ºä¸»  å¨éä¸ºè¾</p>
<p>å°±æ¯v8é»è®¤ä½ åçå½æ°ææ¶ä¸ä¼æ§è¡ï¼é¤éæ¯å·²ç»æ¾å¼çéè¿è¯­æ³åè¯å®ï¼è¿æ®µè¿è¡ä»£ç  é©¬ä¸å°±è¦è· ä½ èµ¶å¿«å¨éè§£æã</p>
<p>ä¸é¢ æä»¬ç¨å¾®è¯¦ç»çè¯´ä¸ä¸</p>
<ul>
<li>
<p>é»è®¤ç»å¤§å¤æ°å½æ°é½æ¯é¢è§£æ</p>
<p>v8è®¤ä¸ºjså¨åå§è¿è¡æ¶ï¼ä»ä»åªæå¾å°å¾å°ä¸é¨åä»£ç  æ¯éè¦é©¬ä¸ä½¿ç¨ç  å¶ä»è§å¾å¤§é¨å é½æ¯è¦ä¹æ¯åè° è¦ä¹æ¯å¶ä»çææ¶ç¨ä¸å°çï¼æä»¥ï¼<strong>å¡æ¯å·åå½æ°å£°æãåµå¥å½æ°</strong>ï¼é»è®¤é½æ¯é¢è§£æã</p>
<pre><code>function clickHandler() {
  console.log("è¦ä¸è¦è§£ææ");
}
// å¼æè®¤ä¸º è¿æ¯ä¸ä¸ªå½æ°å£°æ  çèµ·æ¥è¿æ²¡äººè°åå®
// åä¸æµªè´¹æ¶é´äºï¼åªæ£æ¥ä¸ä¸æ¬å·å¹éå§ï¼
// æå®æ è®°ä¸º 'uncompiled'ï¼ç¶åè·³è¿ã"
</code></pre>
</li>
<li>
<p>é£ä¹  å¦ä½æè½ç¬¦åå®è¿è¡å¨éè§£æçæ¡ä»¶å¢</p>
<ol>
<li>
<p>é¡¶å±ä»£ç </p>
<p>åå¨æå¤å± ä¸å¨ä»»ä½å½æ°å çä»£ç ï¼å è½½å®å¿é¡»ç«å³æ§è¡ã</p>
<p><strong>å¤æ­ä¾æ®ï¼</strong> åªè¦ä¸å¨ <code>function</code> åéçä»£ç ï¼å¨æ¯é¡¶å±ä»£ç ï¼å¿é¡»å¨éè§£æã</p>
</li>
<li>
<p>ç«å³æ§è¡å½æ°</p>
<p>é£ä¹è¿éæä¸ªé®é¢ï¼å°±æ¯V8 å¦ä½å¨è¿æ²¡è¿è¡ä»£ç æ¶ï¼å°±ç¥éè¿ä¸ªå½æ°æ¯ç«å³è°ç¨æ§è¡å½æ°å¢ï¼</p>
<p>ç­æ¡å°±æ¯  çæ¬å·ï¼ï¼</p>
<p>å½è§£æå¨æ«æå°ä¸ä¸ªå½æ°å³é®å­ <code>function</code> æ¶ï¼å®ä¼çä¸ç¼<strong>è¿ä¸ª function ä¹åææ²¡æå·¦æ¬å· <code>(</code></strong></p>
<ul>
<li>
<p>æ²¡æ¬å·</p>
<pre><code>function foo() { ... }
// æ²¡çå°å·¦æ¬å·ï¼é£ä½ åé è¾¹å§ï¼ å¯¹å®é¢è§£æã
</code></pre>
</li>
<li>
<p>ææ¬å·</p>
<pre><code>(function() { ... })();
// æ«æå¨æ«å°äºè¿ä¸ªå·¦æ¬å·
// æ¬¸ï¼è¿æä¸ªå·¦æ¬å·åç function
// æ ¹æ®ä¸å¹´ç»éªï¼è¿æ¯ä¸ªç«å³æ§è¡å½æ°ï¼é©¬ä¸å°±è¦æ§è¡ã
// ç´æ¥ä¸å¤§èï¼å¨éè§£æï¼çæ AST
</code></pre>
</li>
<li>
<p>å¶ä»çç«å³æ§è¡çè¿¹è±¡ï¼é¤äºæ¬å·ï¼<code>!</code>ã<code>+</code>ã<code>-</code> ç­ä¸åè¿ç®ç¬¦æ¾å¨ <code>function</code> åé¢ï¼ä¹ä¼è§¦åå¨éè§£æ</p>
<pre><code>!function() { ... }(); // å¨éè§£æ
</code></pre>
</li>
</ul>
</li>
<li>
<p>é¤äºè¿äºä»¥å¤ï¼ v8è¿æä¸äºå¯åå¼çè§åæ¥è§¦åå¨éè§£æãæ¯å¦  å¦ææ¯ä½ç§¯å¾å°çå½æ°ï¼V8 ææ¶ä¹ä¼ç´æ¥å¨éè§£æï¼å ä¸ºé¢è§£æåå¨éè§£æçå¼éå¯è½æ¯ç´æ¥è§£æè¿å¤§ãããç­ç­ã</p>
</li>
</ol>
</li>
<li>
<p>å¦ææåµå¥å½æ°ååå¢</p>
<p>åµå¥å½æ°é»è®¤æ¯é¢è§£æï¼å³ä½¿å¤é¨å½æ°è¿è¡çæ¯å¨éè§£æï¼å®åé¨å®ä¹çå­å½æ°ï¼é»è®¤ä¾ç¶æ¯é¢è§£æãåªæå½å­å½æ°ççè¢«<strong>è°ç¨</strong>æ¶ï¼V8 æä¼æåæ§è¡ï¼å»æå­å½æ°çå¨éè§£æåå® æ AST è¡¥é½</p>
<pre><code>//é¡¶å±ä»£ç å¨éè§£æ
(function outer() {
  var a = 1;

  // åé¨å½æ° innerï¼
  // è½ç¶ outer æ­£å¨æ§è¡ï¼ä½ inner è¿æ²¡è¢«è°ç¨
  // å¼æä¹ä¸ç¡®å® inner ä¼ä¸ä¼è¢«è°ç¨ã
  // æä»¥inner é»è®¤é¢è§£æã
  function inner() {
    var b = 2;
  }

  inner(); // ç´å°æ§è¡å°è¿ä¸è¡ï¼å¼ææä¼åå¤´å»å¯¹ inner è¿è¡å¨éè§£æ
})();
</code></pre>
</li>
<li>
<p>é£ä¹  å¼ææ ¹æ®èªå·±çå¤æ­ è¿è¡å¨éè§£ææèé¢è§£æï¼ä¼åºéå</p>
<p>å½ç¶ä¼ï¼</p>
<p>å¦ææ¯æ¬è¯¥é¢è§£æç  ç»æå¤æ­éäº  è¿è¡äºå¨éè§£æ   æµªè´¹äºæ¶é´ååå­çæäº AST åå­èç ï¼ç»æè¿ä»£ç æ ¹æ¬æ²¡è·ã</p>
<p>å¦ææ¯æ¬è¯¥å¨éè§£æçåå·¨åå¤§åéçå½æ°  ç»æå¤æ­éäº  è¿è¡äºé¢è§£æï¼ç¶åé©¬ä¸ä¸ä¸è¡ä»£ç å°±è°ç¨äºï¼ç»æå°±æ¯  ç½ç½é¢è§£æäºä¸éï¼æµªè´¹äºæ¶é´ï¼åç°é©¬ä¸è¢«è°ç¨ï¼åé©¬ä¸åå¤´å¨éè§£æä¸è¾¹ åè±äºæ¶é´ï¼ä¸¤æ¬¡çè±è´¹ã</p>
</li>
</ul>
</li>
<li>
<p>å¨ä¸é¢åªæ¯è®²äºè§£æé¶æ®µçé¢è§£æåå¨éè§£æçä¸åï¼ç°å¨æä»¬è®²è§£æé¶æ®µçè¿ç¨</p>
<p>V8 ä½¿ç¨çæ¯éå½ä¸éåææ³ãå®æ ¹æ®js çè¯­æ³è§åæ¥å¹é Tokenã</p>
<p>å®çè§åç±»ä¼¼äºï¼å½æä»¬éå° <code>const</code>ï¼æ ¹æ®è¯­æ³è§åï¼åé¢å¿é¡»è·ä¸ä¸ªåéåï¼ç¶åæ¯ä¸ä¸ªèµå¼å·ï¼ç¶åæ¯ä¸ä¸ªè¡¨è¾¾å¼ã</p>
<p>è¿ç¨ç¤ºä¾ï¼</p>
<p>çå° <code>const</code>  åå»ºä¸ä¸ªåéå£°æèç¹ã</p>
<p>çå° <code>a</code> æå®ä½ä¸ºå£°æç<strong>æ è¯ç¬¦</strong>ã</p>
<p>çå° <code>= </code> ç¥éåé¢æ¯<strong>åå§å¼</strong>ã</p>
<p>çå° <code>1</code> åå»ºä¸ä¸ªå­é¢éèç¹ï¼æå¨ <code>=</code> çå³è¾¹ã</p>
<p>èå¨è¿ä¸ªé¶æ®µçåæ¶ï¼ä½ç¨ååæä¹å¨åæ­¥è¿è¡ï¼å ä¸ºå¨æå»º AST çè¿ç¨ä¸­ï¼è§£æå¨å¿é¡»è¦ææ¸æ¥<strong>åéå¨åªé</strong>ã</p>
<p>å®ä¼çç® è¿ä¸ª <code>a</code> æ¯å¨å±åéï¼è¿æ¯å½æ°åçå±é¨åéï¼</p>
<p>å¦æå½åå½æ°åé¨å¼ç¨äºå¤å±çåéï¼è§£æå¨ä¼å¨è¿ä¸ªé¶æ®µæä¸æ è®°ï¼âè¦å°å¿ï¼è¿ä¸ªåéè¢«é®ä½äºï¼å°æ¥å¯è½éè¦ä¸ä¸ææ¥åéâã</p>
<p>è¿ä¸ªä½ç¨ååææ¯è¾éè¦ï¼æä»¬ç¨ç¨å¾®å¤§ç¹çç¯å¹æ¥è®²è®²ã</p>
<p>é¦å å¼ºçå»ºè®® ä¸è¦åå»ç¨ä»¥åç æ´»å¨å¯¹è±¡AO  vo ç­ç­çè¯´æ³æ¥æèé®é¢ãåºè¯¥ä½¿ç¨ç°å¨çè¯æ³ä½ç¨å ç¯å¢è®°å½ ç­ç­æèæ¨¡åã</p>
<h4 id="è¯æ³ä½ç¨å-lexical-scoping-çå®ä¹ä½ç¨åæ¯ç±ä»£ç ä¹¦åçä½ç½®å³å®çèä¸æ¯ç±è°ç¨ä½ç½®å³å®ç"><strong>è¯æ³ä½ç¨å (Lexical Scoping)â</strong> çå®ä¹ï¼<strong>ä½ç¨åæ¯ç±ä»£ç ä¹¦åçä½ç½®å³å®çï¼èä¸æ¯ç±è°ç¨ä½ç½®å³å®çã</strong></h4>
<p>è¿è¯´æï¼å¼æå¨è¿æ²¡å¼å§æ§è¡ä»£ç ï¼ä»ä»éè¿âæ«æâæºä»£ç çæ AST çé¶æ®µï¼å°±å·²ç»æâè°è½è®¿é®è°âãâè°è¢«è°é®ä½âè¿ç¬è´¦ç®å¾æ¸æ¸æ¥æ¥äºã</p>
<p>ä¸æ¦ASTè¢«çæï¼é£ä¹è³å°æå³çä¸é¢çæåµ</p>
<h3 id="ä½ç¨åå±çº§è¢«ç¡®å®">ä½ç¨åå±çº§è¢«ç¡®å®</h3>
<p>AST æ¬èº«çæ ç¶ç»æï¼å°±æ¯ä½ç¨åå±çº§çç©çä½ç°ã</p>
<ul>
<li><strong>AST èç¹ï¼</strong> å½è§£æå¨éå°ä¸ä¸ª <code>function</code> å³é®å­ï¼å®ä¼å¨ AST ä¸çæä¸ä¸ª <code>FunctionLiteral</code> èç¹ã</li>
<li><strong>Scope å¯¹è±¡ï¼</strong> å¨ V8 åé¨ï¼éç AST ççæï¼è§£æå¨ä¼åæ¶ç»´æ¤ä¸æ£µ <strong>âä½ç¨åæ â</strong>ã
<ul>
<li>æ¯è¿å¥ä¸ä¸ªå½æ°ï¼V8 å°±ä¼åå»ºä¸ä¸ªæ°ç <code>Scope</code> å¯¹è±¡ã</li>
<li>è¿ä¸ª <code>Scope</code> å¯¹è±¡ä¼æä¸ä¸ªæéæåå®ç <code>Outer Scope</code>ç¶ä½ç¨åã</li>
</ul>
</li>
<li><strong>ç»æï¼</strong> è¿ç§âç¶å­å³ç³»âæ¯éæéå®çãæ è®ºä½ å°æ¥å¨åªéè°ç¨è¿ä¸ªå½æ°ï¼å®çâç¶çº§âæ°¸è¿æ¯å®ä¹æ¶çé£ä¸ªä½ç¨åã</li>
</ul>
<h3 id="åéå¼ç¨å³ç³»è¢«è¯å«">åéå¼ç¨å³ç³»è¢«è¯å«</h3>
<p>è¿æ¯è§£æå¨æå¿ç¢çå·¥ä½ä¹ä¸ï¼å«å <strong>åéè§£æ</strong>ã</p>
<ul>
<li><strong>å£°æï¼</strong> å½è§£æå¨éå° <code>let a = 1</code>ï¼å®ä¼å¨å½å Scope è®°å½ï¼âææäºä¸ä¸ªå« <code>a</code> çåéâã</li>
<li><strong>å¼ç¨ï¼</strong> å½è§£æå¨éå° <code>console.log(a)</code> æ¶ï¼å®ä¼çæä¸ä¸ª <strong>åéä»£ç</strong>ã</li>
<li><strong>é¾æ¥è¿ç¨ï¼</strong> è§£æå¨ä¼å°è¯âè¿æ¥âè¿ä¸ªä»£çåå£°æï¼
<ol>
<li>åå¨å½å Scope æ¾ <code>a</code>ã</li>
<li>æ¾ä¸å°ï¼æ²¿ç Scope Tree å¾ä¸æ¾ç¶ä½ç¨åã</li>
<li>æ¾å°äºï¼<strong>å»ºç«ç»å®ã</strong></li>
<li>ä¸ç´å°äºå¨å±è¿æ²¡æ¾å°ï¼æ è®°ä¸ºå¨å±åéï¼æèæ¥éï¼ã</li>
</ol>
</li>
</ul>
<p><strong>è¿éè¦æ³¨æï¼</strong> è¿ä¸ªâæ¾âçè¿ç¨æ¯å¨<strong>ç¼è¯é¶æ®µ</strong>å®æçé»è¾æ¨å¯¼ã</p>
<h3 id="é­åçèå¾è¢«é¢å¤">é­åçèå¾è¢«é¢å¤</h3>
<p>è¿ä¸æ­¥æ¯ V8 æ§è½ä¼åçå³é®ï¼ä¹å°±æ¯ä½ç¨ååæã</p>
<ul>
<li>
<p><strong>åç°é­åï¼</strong> è§£æå¨åç°åé¨å½æ° <code>inner</code> å¼ç¨äºå¤é¨å½æ° <code>outer</code> çåé <code>x</code>ã</p>
</li>
<li>
<p><strong>æä¸ªå¤§æ ç­¾ï¼</strong></p>
<ul>
<li>è§£æå¨ä¼ç» <code>x</code> æä¸ä¸ä¸ªæ ç­¾ï¼<strong>âå¼ºå¶ä¸ä¸æåéâ</strong>ã</li>
<li>æææ¯ï¼âè½ç¶ <code>x</code> æ¯å±é¨åéï¼ä½å ä¸ºæäººè·¨ä½ç¨åå¼ç¨å®ï¼æä»¥å®ä¸è½ä½å¨æ®éçæ ï¼Stackï¼ä¸äº... å¿é¡»æ¬å®¶ï¼ä½å°å ï¼Heapï¼éä¸é¨å¼è¾ç <strong>Contextï¼ä¸ä¸æå¯¹è±¡ï¼</strong> ä¸­å»ãâ</li>
</ul>
</li>
<li>
<p><strong>è¿æ²¡æå®ä¾åï¼</strong></p>
<ul>
<li>
<p>æ­¤æ¶åå­é<strong>æ²¡æ</strong>ä¸ä¸æå¯¹è±¡ï¼ä¹<strong>æ²¡æ</strong>åé <code>x</code> çå¼ï¼é£æ¯è¿è¡æ¶çäºï¼ã</p>
</li>
<li>
<p>AST åªæ¯çæäºä¸å¼ <strong>âèå¾â</strong>ï¼å¾çº¸ä¸åçï¼âæ³¨æï¼å°æ¥è¿è¡çæ¶åï¼è¿ä¸ª <code>x</code> è¦æ¾å¨ç¹å«çå°æ¹ - Contextéï¼å«æ¾å¨æ ä¸ãâ</p>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>ç°å¨ æä»¬æ¥å¤ä¸ä¸ç  éç¹å­¦ä¹ è§£æè¿ç¨</p>
<p>å­èæµ---è¢«åææè¯­æ³æä¹çæå°ååtoken---æä¸ºtokenæµ---è§£æé¶æ®µ(è¿è¡é¢è§£ææèå¨éè§£æ)---å¾å°ASTåä½ç¨åæ ååéå¼ç¨å³ç³»  è¿å°±æ¯æä»¬ç¬¬ä¸é¨åæè®²çè¯æ³åæåè¯­æ³åæçåå®¹ã</p>
<p>å ä¸ºè¿é¨åæ¯è¾éè¦ï¼æä»¥æä»¬å°ç»§ç»­æ·±å¥çå­¦ä¹ ä¸ä¸ãããåæ­£å­¦é½å­¦äº  è¦å­¦è¿ä¸è¶æºå¤å­¦ç¹ï¼æä»¥ åé¢çåå®¹ åªæ¯å¼èè  æä¸æå æä¸æå¤ .</p>
<p>å¶å®ï¼æ¯å ä¸ºå¨æ´ä¸ªé¾æ¡ä¸­ï¼ä»å¼å§å°ASTçæï¼æ¯ä¸ä¸ªè¾ä¸ºå®æ´çç¬ç«çå°é¶æ®µãæ­¤æ¶ï¼ä»ä»æ¯<strong>éæåæè¿ç¨å®æ</strong>ã</p>
<p>ä»æ´ä¸ªæµç¨æ¥çï¼ ASTçæï¼è¡¨ç¤ºç©çå±çº§ç¡®å®  ä½ç¨åé¾æå»ºå®æï¼é­åèå¾ä¾æä½ç¨åé¾ åéè·¯å¾å¼ç¨ä¾æä½ç¨åé¾ï¼çè³è¿æ åcontextä¸­çä½ç½®åéé½æäºèå¾ã æä»¥ éç¹äºè§£è¿é¨ååå®¹ï¼ä¹æ¯è·å¾ææ»¡æ»¡äºã</p>
<p>ä¸é¢ æä»¬æ¥éç¹å­¦ä¹ è§£æçè¿ç¨ã</p>
<p>ä¸é¢è®²äºè§£æçè¿ç¨å« éå½ä¸éåææ³ å¬èµ·æ¥æ¯ä¸æ¯å¾é«å¤§ä¸ï¼å¶å®  å®è¿æä¸ªå°åï¼å«â<strong>å±å±ç©éå·¥ä½æ³</strong>âã</p>
<ul>
<li>
<p>è§£æå¨æä¸¤å¤§ç¥æï¼è¿ä¸¤å¤§ç¥æï¼æ¯å®çæå¤§åä»</p>
<ul>
<li>
<p>æåå·ç Lookahead</p>
<p>å®å¤çå½åtokenæ¶ï¼æ»æ¯åæ¬¢ç¯çä¸ä¸ä¸ªï¼ çè³ä¸å ä¸ªï¼ï¼æ¯å¦ å½å®æéæ¿çconstäºï¼ç¶åå®æåå·çåé¢ç æ¬¸ æ¯ä¸ª aï¼ é£å°±æ²¡é è¿æç¨³äºï¼æ¯ä¸ªåéå£°æã</p>
<p>è¿ä¸ªç¥æï¼æä¸ªæ¯è¾æ­£è§çåå­ å«åç» lookaheadã</p>
<p>å½è§£æå¨å¨è§£ææå¥æææ®µä»£ç æ¶ï¼æ¯è§£æå¨ä¸­çæä¸ä¸ªè§£æå½æ°å¨å·¥ä½ï¼å¾æå¯è½æ¯è¢«ä¸é¢å±å±ç©éç©ä¸æ¥çï¼è½®å°è¿ä¸ªè§£æå½æ°æ¶ï¼å¾å¤§çå¯è½ï¼æ¯è¿å¥æè¿æ®µä»£ç çè§£æï¼å°±å±äºå®çæ¬èå·¥ä½ï¼å®æç§èªå·±çè§£ææµç¨å¤æ­é»è¾ï¼æ¥ä½¿ç¨åç»æè½ï¼é¢å¤ä¸ä¸ä¸ªtokenæ¯å¦ç¬¦åå®çå·¥ä½é»è¾éæ±ã</p>
</li>
<li>
<p>æ¶è´¹ consume   å½ç¡®è®¤è¿ä¸ªå½åç Token æ²¡é®é¢ï¼å°±æå®âåæâï¼consume å³æ¶è´¹æï¼åæ¶æéç§»å¨ï¼æåä¸ä¸ä¸ªtokenï¼åå¤å¤çä¸ä¸ä¸ªã</p>
<p>æ¯å¦ å½åæéæçconstï¼å®å·çåé¢çï¼æ¯ä¸ªaï¼å®å°±ç¡®å®  ç¬¦åå®<strong>åéå£°æçå²ä½</strong>çå¤æ­é»è¾ï¼äºæ¯ï¼å®å°±åæ æ¶è´¹æå½åæéæççconstï¼ç¶åæéç§»å¨å°aï¼éå¤å®çå·çåæ¶è´¹çæ­¥éª¤ã</p>
</li>
</ul>
</li>
<li>
<p>ç®åæ¥è¯´ï¼è§£æè¿ç¨å°±æ¯ï¼ç¨ <strong>åç»</strong> æåå·ç lookahead å³ç­ï¼ç¨ <strong>æ¶è´¹</strong> consume åè¿ï¼ä¸å±å±æå·¥ä½äº¤ç»åéçè§£æå½æ°ï¼ç´å°æ´æ®µä»£ç è¢«è§£æå®æã</p>
</li>
<li>
<p>åé¢è¯´  ææ°ä¸ºä¸»  å¨éä¸ºè¾ï¼æææ¯ä»<strong>è§£æç»æ</strong>  ä»<strong>è§£ææ°é</strong>ä¸æ¥çï¼ å¾å¤§å¾å¤§é¨åé½æ¯åçææ°è§£æ  é¢è§£æï¼æ¯å ä¸»è¦çé¨åã  èå¨éè§£æåçå¾å°ã</p>
<p>é£ä¹  ä»è§£ææµç¨çå³ç­å±é¢æ¥çï¼<strong>ä»âææ¥æâæ¥çï¼å¨éè§£æä¸ºä¸»</strong>ã</p>
<ul>
<li>å¨éè§£æè´è´£å¼åºï¼å®è´è´£åå³å®ï¼å®è´è´£ææ§å¨å±ãæ²¡æå®ï¼é¢è§£ææ ¹æ¬ä¸ç¥éä»ä¹æ¶åè¿åºå·¥ä½ãå³ å¨éè§£ææ¯<strong>ä¸»å¯¼</strong>æµç¨ç</li>
<li>è¿éè¦ç¹å«æ³¨æï¼æä»¬æ ä¸»è§£æå¨åå¨éè§£æ ä½ä¸ºä¸ä¸ªæ´ä½æ¥è®²çï¼å¨v8ä¸­ï¼ä¸»è§£æå¨åå¨éè§£æå¨ åºæ¬ä¸å¯ä»¥åä¸ç­å·ï¼æä»¥ è¯´å¨éè§£æä¸ºä¸»å¯¼æµç¨ ï¼å°±æ¯è¯´ä¸»è§£æå¨ä¸»å¯¼æµç¨ã  ä¸»è§£æå¨/å¨éè§£æ æ¨è¿æµç¨ï¼ éå°éç«å³æ§è¡çä»£ç ï¼å°±å¼å¤é¢è§£æå¨æ¥å·¥ä½ã</li>
</ul>
<pre><code>// å¨éè§£æ å³ä¸»è§£æå¨æ­£å¨å¹²æ´» æå»ºå¨å±AST
var a = 1; 

// çªç¶éå°äºä¸ä¸ªå½æ°å£°æï¼
function lazy() {
  var b = 2;
  console.log(b);
}

// å¨éè§£æï¼"ååï¼æ¯ä¸ªå½æ°å£°æï¼ä¼°è®¡æ²¡äººè°ç¨å®ï¼æä¸è¿å»äºï¼å¤ªè´¹å²ã"
// äºæ¯ææ¥ é¢è§£æå»å¹²æ´»

// åæ¢å°äº é¢è§£æ
// é¢è§£æå¿«éæ«æ lazy åé¨ï¼
// 1. æ£æ¥ææ²¡æè¯­æ³éè¯¯ï¼(æ²¡æ)
// 2. æ£æ¥ææ²¡æå¼ç¨å¤é¨åéï¼(æ²¡æ)
// 3. æ£æ¥ç»æï¼"éé¢å®å¨ï¼æ¯ä¸ªæ®éå½æ°ã"
// 4. äºæ¯çæä¸ä¸ª"å ä½ç¬¦èç¹"ï¼é¢è§£æå¨æ¶å·¥ã

// åæ¢åå°äº å¨éè§£æ/ä¸»è§£æå¨
// å¨éè§£æç»§ç»­å¾ä¸
var c = 3;

// éå°äº ç«å³æ§è¡å½æ° 
// å¨éè§£æä¸çï¼"åï¼è¿åé¢æä¸ªæ¬å· ()ï¼é©¬ä¸è¦è·"
// ä¸è½åå¤åäºï¼å¾èªå·±æ¥å¹²è¿ä¸ç¥¨ã
// å¨éè§£æè¿å¥å½æ°åé¨æå»º AST
(function urgent() {
   var d = 4;
})();
</code></pre>
</li>
<li>
<p>æä»¬è¯´é¢è§£æ è½ç¶ä¸çæASTèç¹ï¼åªæ¯çæå ä½ç¬¦èç¹ï¼ä½æ¯ä¹éè¦å¿«éæ«æåé¨ã</p>
<pre><code>// å¯¹å¤é¨å½æ°è¿è¡å¨éè§£æï¼å¯¹åé¨å½æ°è¿è¡é¢è§£æ
function father() {
  let dad = 'ç¸ç¸'; 

  //å¨éè§£æä¸­ï¼éå°åé¨å½æ°ï¼é¢å¤ªç´¯ï¼å¼å«å¤å é¢è§£æ
  // é¢è§£æè¿æ¥  å¼å§å¿«éæ«æ son çåé¨ææ¬...
  function son() {
    console.log(dad); 
  }
}


é¢è§£æ ï¼
å®çå° console.logï¼ä¸çæ AST èç¹ã
å®çå° dad è¿ä¸ªæ è¯ç¬¦
å¤æ­ï¼son åé¨å£°æè¿ dad åï¼ï¼æ²¡æï¼ã
å¤æ­ï¼è¿æ¯ä¸ä¸ªæªè§£æçå¼ç¨ (Unresolved Reference)ã
ç»æï¼ é¢è§£æ æ«æå® son åï¼è½ç¶æä¸­é´çä¿¡æ¯æäºï¼ä¸å­ ASTï¼ï¼ä½ä¼ç» father çä½ç¨åçä¸ä¸æ¡æå¶éè¦çææ¥ï¼
è¯¥å­å½æ°åé¨å¼ç¨äºä½ ç dad åé

fatherå½æ°çååº (Context åé)
æ¶å°é¢è§£æçææ¥åï¼father å½æ°æ­¤æ¶å·²ç»å¨å¿ç¢ä¸­äºï¼å®å°±ä¼ååºååºï¼

æ¬æ¥ dad æ¯åå¤åéå¨ æ  (Stack) ä¸çã

å ä¸ºæ¶å°äºé¢è§£ææä¾çé­åå¼ç¨ä¿¡æ¯ï¼æä»¥
father çä½ç¨ååæç»æä¸­ï¼dad è¢«æ è®°ä¸º éè¦ Context åéã

ç»æï¼ dad è¢«ç§»å¥å åå­ç Context ä¸­ï¼ç¡®ä¿ father æ­»å dad è¿è½æ´»ã

è¿éè¦ç¹å«æ³¨æï¼è¿æ¯èå¾ èå¾ï¼ æ­¤æ¶æ¯éæè§£æé¶æ®µï¼æè¯´çé½æ¯èå¾  é½æ¯ç»çå¤§é¥¼ã
å³äºæä¹æè¿° è¢«ç§»å¥å åå­çä¸ä¸æä¸­ï¼åé¢ä¼è¯¦ç»è®²ã

é£ä¹ è¿ä¸ªå ä½ç¬¦éæ¯ä»ä¹åå®¹å¢ï¼
å¯¹äºé¢è§£æçå½æ° sonï¼
AST æ ä¸åªæä¸ä¸ªâå ä½ç¬¦èç¹âï¼UncompiledFunctionEntryï¼ï¼å¨ V8 ä¸­ï¼è¿ä¸ªå ä½è¡¨ç¤ºä¼ä¸ä¸ä¸ª SharedFunctionInfo å³èï¼ç¨æ¥ä¿å­å½æ°çåä¿¡æ¯ï¼å¦åæ°ãä½ç¨åãæ¯å¦ä¸ºé­åç­ï¼ï¼ä¾åé¢çæ­£å¨éè§£æåç¼è¯æ¶ä½¿ç¨ï¼
åä¿¡æ¯ä¸­å¤§è´æå¦ä¸åå®¹ï¼
æ²¡æ ASTèç¹ï¼ä¹å°±æ¯æ²¡æå·ä½çä»£ç é»è¾ç»æã
æä½ç¨åä¿¡æ¯ (ScopeInfo)ï¼
å®ç¥éèªå·±åé¨å¼ç¨äºåªäºå¤é¨åéã
å®ç¥éèªå·±æ¯ä¸æ¯é­åã

</code></pre>
<p>å³äºä½ç¨åï¼åé¢ä¼è¯¦ç»è®²ãä¸é¢æ¯åè®²å ä½ç¬¦éæ¯æè¿äºä¿¡æ¯çï¼å¦åæ æ³ä¿è¯é­åèå¾çå®æ´æ§ååç¡®æ§ã</p>
</li>
<li>
<p>ç»è¿ä¸é¢çéºå«ï¼æä»¬ç°å¨å¼å§ASTçè§£æäºãè¿é¨ååå®¹æ¯å¦æå¿è¦å±å¼ï¼ æçº ç»äºèµ·ç ä¸¤çç­è¶çæ¶é´ï¼å ä¸ºä»äºè§£çè§åº¦æ¥è¯´ ï¼ä¸é¢çåå®¹ï¼å·²ç»è¶³å¤äºï¼çè³å¨ä¸­çº§é«çº§åç«¯å¼åçå²ä½é¢è¯ä¸­ï¼ä¹è¶³å¤äºã ä½æ¯ï¼æåè§å¾å·ä½çè§£æä¹æå¿è¦è®²è®²ï¼æ¯ç«é½å­¦å°è¿ååå®¹äºï¼ç¨å¾®åå¾æ·±å¤çé£ä¹å ç¼ï¼ä¹å¯ä»¥çã</p>
<p>æä»¬ä»¥v8ä¸ºä¾ã</p>
<p>ä¸ºäºè¯´æç½ï¼ç°å¨å¼å§å°±ä¸å¾ä¸ä½¿ç¨å·ä½çå½æ°åäºï¼ä¸è¿åºæ¬ä¸è¿äºå½æ°åé½æè§å¾ï¼çåå­å°±å·®ä¸å¤ç¥éå«ä¹äºã</p>
<p><strong><code>ParseStatementList</code></strong>ï¼è¯­å¥åè¡¨è§£æï¼æ¯çæ­£ç<strong>å¾ªç¯é©±å¨è</strong>ãå¦æä¸ä¸¥æ ¼åºåé¡¶å±å¥å£çè¯ï¼æä»¬å¯ä»¥æå®çä½è§£ææµç¨çä¸»å¼æãå®çå·¥ä½éå¸¸åçº¯æ¯ç¥ï¼å°±æ¯å¼å¯ä¸ä¸ª <code>while</code> å¾ªç¯ï¼åªè¦æ²¡å°æä»¶ç»å°¾ï¼å°±é©±å¨ <strong>é¡¹/Item</strong> è¿ä¸çº§å«çè§£æã</p>
<p>èå¨å¾ªç¯åé¨ï¼å®ä¼ææ¯ä¸æ¬¡çå¤çä»»å¡ç©éç» <strong><code>ParseStatementListItem</code></strong>ï¼é¡¹çº§å¥å£ï¼ã</p>
<p>å¯è½ææåä¼çé®ï¼ä»ä¹æ¯âé¡¹ï¼item / æ¡ç®ï¼âè¿ä¸çº§å«ï¼å¯ä»¥è¿æ ·çè§£ï¼ä»è¯­æ³ä¸è®²ï¼è¯­å¥å ä¸å£°æï¼å°±ææäº é¡¹/item/æ¡ç®ï¼ ä½æ¯è¯­å¥åå£°æ   ä»ä»¬æå¾å¤§çä¸åãæ¢è¦åºåä»ä»¬ï¼åè¦å¨ä¸ä¸ªå¤§å¾ªç¯éç»ä¸å¤çä»ä»¬ï¼æä»¥æäº é¡¹ è¿ä¸ªç§°å¼ã</p>
<p>æäº å£°æãæ¨¡åç <code>import</code> / <code>export</code>ãå¨åè®¸ä½ç½®ä¸éè¦æåå¹¶ä¸ç»è®°å°ä½ç¨åçå½æ°å£°æãéè¦åæ©æéè¯¯æ£æµçå°æ¹ç­ç­ï¼å°±è¦æ±ä¼åçå¤ç   æ¯å¦<strong>æåç»è®°åç§°åä½ç¨åä¿¡æ¯ãæ¥æ©æéè¯¯ï¼æèåé¢è§£æå¹¶çä¸å ä½ç¬¦</strong>ã</p>
<p><code>ParseStatementListItem()</code> è´è´£åé¡¹çº§çåæµï¼å¦ææ£æµå°æ¯ import/exportãå¯æåçå½æ°å£°ææå¶ä»é¡¹çº§å¿é¡»ä¼åå¤ççåå®¹ï¼å°±å¨æ­¤å¤<strong>å®åç©é</strong>ï¼éå¸¸æ¯ç´æ¥ç©ç»å¯¹åºçå·ä½è§£æå½æ°ï¼å¦ææ£æµå°ä¸æ¯éè¦ä¼åå¤ççå£°æå®ä¹ï¼èæ¯æ®éçè¯­å¥ï¼å®ä¼æè¯¥æ¡<strong>ç©é</strong>ç» <code>ParseStatement()</code>ï¼å°±æ¯æ®éçè¯­å¥çº§è§£æï¼ç±è¯­å¥çº§è´è´£æ®éè¯­å¥ï¼æ§å¶æµãåãè¡¨è¾¾å¼è¯­å¥ç­ï¼çè¯¦ç»è§£æãå¨è§£æå¨å±é¢ä¸çè¿ä¸¤ç§åæµä¿è¯äº æåãæ¨¡å è§ååè¯­å¥è¯­ä¹æ¢è½æ­£ç¡®åä¾¿äºä¼åå®ç°ã</p>
<pre><code>ParseStatementListï¼è´è´£æ´ä½æ¨å¨å¾ªç¯ï¼å·çä¸ç¼ï¼ç°å¨åªè¦ä¸æ¯eofç»ææ è®°ï¼ä¸ç®¡å¶ä»æ¯ä»ä¹åå®¹ï¼ç»ç»ä¸è¡èçç©éã

ParseStatementListItemï¼è´è´£å¨ é¡¹çº§ è¿ä¸å±é¢åæµï¼ ç»¼åä»¥ä¸å¤æ­ï¼
å½å token + å½åçè¯­å¢ + è¯­æ³è§å + å¯è½æçé¢å¤
åæµä¸ºå£°æçº§è§£æåæ®éè¯­å¥çº§è§£æï¼
å¦ææ¯å£°æçº§  importãfunctionãclassãlet ç­ï¼å°±ä¼åå¤çï¼æåå®åç©éï¼ä»¥å®ç°æåæç»è®°ä½ç¨åã
</code></pre>
<p>éè¿ä»¥ä¸åå®¹ï¼æä»¬ç¥éäºï¼ParseStatementListItem å·æè§£è¦çç¨éï¼å®åºåäºå£°æåè¯­å¥ï¼ä½æ¯å®åä¸å·ä½å¹²æ´»ï¼ä¾æ§æ¯æå®æ¦æªçå£°æé¡¹æ´¾åã</p>
<p>ä¸é¢æä»¬æ¥ç ParseStatement ï¼éè¿ä¸é¢çè¯­å¥åå£°æçåæµï¼è¯­å¥é¡¹æ¥å°äºè¿ä¸ªå°æ¹ï¼è¿éåæ¯ä¸ä¸ªç©éå¤ãParseStatement åä½¿ç¨ç¥æ åç»lookaheadå·çtokenï¼ä½¿ç¨ç±»ä¼¼äº if æ  switch case çå½¢å¼ï¼å°è¯å¹éææå·æ<strong>ç¡®å®èµ·å§å³é®å­æç¬¦å·</strong>çè¯­å¥å½¢å¼ï¼å¦ <code>if</code>ã<code>for</code>ã<code>return</code>ã<code>{</code> ç­ï¼ãå¹éä¸ä»¥å  å¯¹åé£ä¸ªå¹éæåçè§£æå½æ°ï¼ç©éä¸å»ãå¶ä»å°æªè¯å«ç åç©ç»è¡¨è¾¾å¼è§£æï¼è¿æ¯å ä¸ºè¡¨è¾¾å¼çå½¢å¼æå¾å¤ï¼èä¸æ æ³æ ¹æ®å³é®å­æ¥è¯å«ï¼æä»¥ å¯ä»¥è¯´è¡¨è¾¾å¼è§£ææ¯ä¸ª<strong>ååº</strong>ã å¦ææ¯è¢«ç©éå°è¡¨è¾¾å¼è§£æï¼é¦åç±è¡¨è¾¾å¼çèµå¼è§£ææ¥æï¼ è§£ææµç¨ç»ä¸ä» <strong>ParseAssignmentExpression</strong> è¿ä¸æä½ä¼åçº§è§åå¼å§ã</p>
<p>å ä¸ºå¯¹äºè¡¨è¾¾å¼è§£æï¼å®åå¶ä»çè§£æä¸åï¼å¶ä»çå¯ä»¥<strong>ä¾é å³é®å­</strong>æ¥ç©éï¼ä½æ¯è¡¨è¾¾å¼å¿é¡»<strong>ä¾é ä¼åçº§</strong>æ¥ç©éãèµå¼è§£æä½ä¸ºä½ä¼åçº§çä¸å±ï¼å®æ æ³é¢ç¥å½åä»£ç çå«ä¹ï¼å æ­¤å®å¿é¡»<strong>åæ æ¡ä»¶å°å°è§£æä»»å¡ç©éç»æ´é«ä¼åçº§</strong>çä¸å±è§£æå¨ï¼å¦ä¸åãäºåãè°ç¨ç­ï¼ã</p>
<p>ç­ä¸å±è§£æå¨è¿åäºä¸ä¸ªè¡¨è¾¾å¼èç¹åï¼èµå¼è§£æå¨å<strong>å·ç</strong>åç»­ tokenãåªæå½åç»­ token æ¯ <code>=</code> æ¶ï¼å®æå°å¶ç»è£æèµå¼è¡¨è¾¾å¼ï¼å¦åï¼å®å°±ç´æ¥å°åæä¸å±è§£æå¨è¿åçç»æï¼åå°ä¸å¨å°åä¸è¿åã</p>
<p>æä»¬ä»¥ä¸ä¸ªè¡¨è¾¾å¼çä¾å­æ¥è¯´æè§£æè¿ç¨ï¼</p>
<p><strong>m=1+3</strong></p>
<p>ParseStatementéè¿åç»ï¼å¹éä¸å°è¯­å¥ï¼ç©éå°è¡¨è¾¾å¼ ParseExpression()ï¼è¿ä¸ªä¹æ¯ç´æ¥è½¬äº¤ç»ParseAssignmentExpressionï¼ æ­¤æ¶æ5ä¸ªtoken</p>
<ul>
<li>
<p>åé¢è¯´è¿ è¿ä¸ªèµå¼è§£æä¼åçº§éå¸¸ä½ï¼å®æ æ³é¢ç¥å½åtokençå«ä¹ï¼å¿é¡»åç©éç»å«äººï¼åæåºæ¥ä¸ä¸ªä¸è¥¿ççã</p>
<p>è¿éè¯å®ææåä¼é®äºï¼èµå¼è§£ææ¿å°mï¼å·çåé¢ç  æ¯ä¸ª = å·ï¼ä¸å°±ç¥éäºåï¼</p>
<p>ä½æ¯ï¼åå¦ä¸æ¯mï¼èæ¯m[0]  ï¼æ¯m.b   çè³æ¯m(888) ï¼å½æ°è°ç¨ï¼è½ç¶è¿å¨èµå¼ä¸­æ¯éæ³çï¼ä½è§£æå¨å¾åæå®è§£æåºæ¥ï¼ç¶åå·çå°=å·ï¼æä¼ç¥ééæ³ï¼å¢ï¼ èä¸ï¼è§£æå½æ°çè®¾è®¡ï¼æ¯éè¦ç»ä¸æ§  éç¨æ§ çï¼æä»¥ å®å¿é¡»åç©éï¼å¿é¡»å¾å°ä¸ä¸ªç¡®å®çè¡¨è¾¾å¼èç¹ï¼æè½åå³å®ã</p>
</li>
<li>
<p>æä»¥ èµå¼è§£æç´æ¥æ´¾åç»äºä¸åè§£æParseConditionalExpression</p>
<p>ä¸åè§£æè¯´ çä¸æ  ä¸å½å®ç®¡ ä¾æ§å¾ä¸ç©éã</p>
</li>
<li>
<p>ParseBinaryExpression</p>
<p>ä¸¤åè§£æ ä¾æ§ç©é</p>
</li>
<li>
<p>ParseUnaryExpression</p>
<p>ä¸åè§£æ ä¾æ§ç©é</p>
</li>
<li>
<p>ParseLeftHandSideExpression</p>
<p>LHS å¤çnew<code>, </code>()<code>, </code>.<code>, </code>[] çè§£æï¼ ä¾æ§ç©é</p>
</li>
<li>
<p>ParsePrimaryExpression</p>
<p>å°äºåå­å±ï¼è¿éæ¯ä¸é¨å¤çm<code>, </code>1<code>, </code>(expr)<code>, </code>this çå°æ¹ã</p>
<p>è¿å±ä¸ç æ¬¸  æ¯æçæ´»åï¼ ç¶ååæ token <code>m</code>ã</p>
<p>çæ <code>VariableProxy(m)</code> èç¹ã äº¤åä¸å±ã</p>
</li>
<li>
<p>è¿åå°ParseLeftHandSideExpression</p>
<p>è¿å±çè§£ææ¿å°mèç¹ï¼å·çåé¢  æ¯ä¸ª = å·ï¼å¯  æ²¡æçäºï¼å¿«èµ°å§ãç»§ç»­å¾ä¸äº¤</p>
</li>
<li>
<p>è¿åå°ParseUnaryExpression</p>
<p>è¿å±æ¿å°mï¼å·ç æ¯ä¸ª=å·ï¼åæçå·¥ä½æ²¡å³ç³»ï¼å¿«èµ°å§</p>
</li>
<li>
<p>è¿åå°ParseBinaryExpression</p>
<p>è¿å±æ¿å°mï¼å·ç æ¯ä¸ª=å· ï¼ææ¯æä¸¤åçï¼åææ²¡å³ç³»  ï¼å¿«èµ°å§</p>
</li>
<li>
<p>è¿åå°ParseConditionalExpression</p>
<p>è¿å±æ¿å°mï¼å·ç æ¯ä¸ª=å·ï¼ææ¯æä¸åçï¼åææ²¡å³ç³»ï¼å¿«èµ°å§</p>
</li>
<li>
<p>è¿åå°ParseAssignmentExpression</p>
<p>è¿å±æ¿å°mï¼å·ç æ¯ä¸ª=å·ï¼åååï¼æå°±æ¯æèµå¼çï¼å°±æ¯æçæ´»ï¼</p>
<p>ç¶åæ¥æ¶mèç¹ï¼åæ=å·  å¹¶ä¸ä¿å­=å·ï¼ <strong>å³é®ç¹æ¥äºï¼</strong> æ­¤æ¶å®éè¦è§£æç­å·å³è¾¹çåå®¹ãè½ç¶æä»¬çå°çæ¯ <code>1+3</code>ï¼ä½è§£æå¨å¹¶ä¸ç¥éå³è¾¹æ¯ä¸æ¯è¿èçå¦ä¸ä¸ªèµå¼ï¼æ¯å¦ <code>m = n = 1+3</code>ï¼ã ä¸ºäºä¿è¯<strong>èµå¼çå³ç»åæ§</strong>ï¼å³è¿ç­èµå¼ï¼ï¼å®å¿é¡»<strong>éå½è°ç¨èªå·±ï¼ParseAssignmentExpressionï¼</strong> æ¥è§£æå³è¾¹ã</p>
<p><strong>ç¬¬2æ¬¡è¿å¥ ParseAssignmentExpression</strong> æ°çä¸å±èµå¼è§£æå¨å¯å¨äºãå®ä¾ç¶éµå¾ªèè§ç©ï¼åçä¸æï¼ç©é</p>
</li>
<li>
<p>ParseConditionalExpression</p>
<p>ä¸åè§£ææ¿å°1ï¼å¥ä¸è¥¿åï¼ç©é</p>
</li>
<li>
<p>ãããä¸ç´ç©å°åå­å±</p>
</li>
<li>
<p>ParsePrimaryExpression</p>
<p>æ¿å°1ï¼ååï¼åæ¯æçæ´»ï¼åå  æ¶è´¹ætoken 1ï¼çæ Literal(1) èç¹ï¼å¾ä¸äº¤</p>
</li>
<li>
<p>è¿åå°ParseLeftHandSideExpression</p>
<p>æ¿å°Literal(1)èç¹ï¼å·ç æ¯ä¸ª + å·ï¼å¿«èµ°å§</p>
</li>
<li>
<p>è¿åå°ParseUnaryExpression</p>
<p>æ¿å°Literal(1)èç¹ï¼å·ç  æ¯ä¸ª+å·ï¼åæçå·¥ä½æ²¡å³ç³»ï¼å¿«èµ°å§</p>
</li>
<li>
<p><strong>è¿åå°ParseBinaryExpression</strong></p>
<p>æ¿å°Literal(1)èç¹ï¼å·ç æ¯ä¸ª+å·ï¼å¤©å  æå°±æ¯<strong>æä¸¤åç</strong>ï¼æçæ´»ï¼</p>
<p>ç¶å æ¥æ¶Literal(1)èç¹   æ¶è´¹æ+å· å¹¶ä¸ä¿å­+å·ï¼</p>
<p>è¿ä¸ªæ¶å å®è¦è§£æåé¢çtoken 3ï¼åé¢è®²è¿ï¼è§£æå½æ°çè®¾è®¡ï¼è¦å¼é¡¾å°ç»ä¸æ§åéç¨æ§ï¼è½ç¶æ¬ä¾æ¯1+3ï¼ä½æ¯äºåè§£æä¸­ï¼+å·åé¢   ä¾æ§å¯è½æ¯ä¸ªäºé¢è§£æå¼ï¼æ¯å¦ 3+5*9 ç­ç­ï¼æä»¥ï¼æ¬ä¾è½ç¶å¯ä»¥ç´æ¥ç©éå°ä¸é¢çä¸åè§£ælhsè§£æå°åå­è§£æï¼ä½æ¯ï¼ä»ç»ä¸åéç¨æ§çè§åº¦ï¼v8è®¾è®¡æäºéå½è°ç¨ã</p>
<p>å°±æ¯å¯¹äº+å·åé¢çè§£æï¼ä¾æ§æ¯è°ç¨ParseBinaryExpressionï¼åªä¸è¿ï¼å¿é¡»è¦å ä¸ä¼åçº§ï¼ æ¯å¦ + å·çä¼åçº§æ¯12ï¼  ä¹æ³*çä¼åçº§æ¯13ï¼ è¿ä¸ªä¼åçº§ä¼ éå¾ç®å  å°±æ¯éè¿å½æ°çåæ°ä¼ çã</p>
<p>åæ¬¡è°ç¨ä»¥åï¼æ¬ä¾æ¯3ï¼åæ¬¡ç©éï¼ç©å°åå­å±ï¼å¾å°èç¹3ï¼è¿åå°è¿éï¼</p>
<p>è¿ç¬¬2æ¬¡è°ç¨ å¾å°3èç¹ï¼å®å·çä¸ç¼ åé¢æ²¡äºï¼å¯ å¯å¯  è¿ä¸ªè¡¨è¾¾å¼å°±æ¯ä¸ä¸ªèç¹3ï¼è¿ä¼åçº§å¤æ­é½æ²¡ç¨å°ã å®å°±è¿åä¸äº¤ï¼éåºç¬¬2æ¬¡è°ç¨ï¼  åå°äºå½åï¼ æ­¤æ¶ï¼å®å·¦ææ1èç¹  å³ææ3èç¹ï¼èå­éè¿è®°å¾ä¸ä¸ª+å·ï¼ äºæ¯  å®å¬å¤åºfactoryå·¥åæ¹æ³NewBinaryOperation(op, left, right)ï¼çæäºå¤§çæ°çèç¹ï¼è¿ä¸ªèç¹  ä¸é¢æ¯+å·èç¹ å·¦å­©å­æ¯èç¹1ï¼å³å­©å­æ¯èç¹3ã</p>
<p>åé¢ä»ä¹é½æ²¡äºï¼å¾ä¸äº¤æ´»äºã</p>
</li>
<li>
<p>è¿åå°ParseConditionalExpression</p>
<p>ä¸åè§£æä¸ç  è¿æ¯ä¸ª1+3çå°ASTæ ï¼å·çåé¢  æ²¡ætokenäºï¼ å¿«èµ°å§</p>
</li>
<li>
<p>è¿åå°ParseAssignmentExpression</p>
<p>èµå¼è§£ææ¿å°è¿æ£µ <code>1+3</code> çå° AST æ ï¼å·çä¸ç¼ åé¢æ²¡äºï¼ äºæ¯<strong>ç¬¬2æ¬¡çè°ç¨è¿å</strong>ï¼</p>
<p>ç°å¨ï¼èªå·±å·¦ææ¯ä¸ª <code>m</code>ï¼å³ææ¯ä¸ª <code>1+3</code>ï¼èå­éè¿è®°å¾ä¸ª <code>=</code>ï¼å¨å¦¥äºã äºæ¯å®å°±å¬å¤ factory å·¥åæ¹æ³ <strong><code>NewAssignment(ASSIGN, m, right_node)</code></strong>ã</p>
<p>éçä¸ééåï¼ä¸ä¸ª <strong>Assignmentèµå¼èç¹</strong> è¯çäº  è¿è¡ä»£ç  <code>m=1+3</code> çè¯­æ³åæå½»åºå®æï¼æç»è¿åç»æé¡¶å±ç <code>ParseStatement</code>ã</p>
</li>
<li>
<p>ä¸é¢æä»¬ä»¥ä¸ä¸ªç®åçèµå¼è¡¨è¾¾å¼m=1+3çä¾å­ è¯¦ç»è®²è§£äºASTççæè¿ç¨ãå¹¶éè¿èµå¼è§£æçéå½è°ç¨ è½äºè§£è¿ç­èµå¼çå³ç»åæ¯æä¹å®ç°çï¼äºåè¿ç®è§£æä¸­çéå½è°ç¨ï¼æä»¬ä¹è½ç¥ééè¿åæ°ä¼ éè¿ç®ç¬¦çä¼åçº§ã</p>
</li>
</ul>
<p><strong>è§£æ m = 1 + 2 * 3</strong></p>
<ol>
<li><strong>èµå¼å±å¯å¨</strong>ï¼èµå¼è§£ææ¿å° <code>m</code>ï¼æ¶è´¹æ <code>=</code> å·ï¼å¹¶è®°ä½ <code>=</code>ã</li>
<li><strong>å¼å§ç¬¬ä¸æ¬¡éå½è°ç¨ï¼èµå¼è¡¨è¾¾å¼è§£æï¼</strong>ï¼ä¸ºäºè§£æå³å¼ã
<ul>
<li><strong>ç©éç¯è</strong>ï¼æ¿å° <code>1</code>ï¼ä¸è®¤è¯ï¼ç©ç©ç©...</li>
<li><code>1</code> èç¹è¢«è¿åï¼è¿åå° <strong>äºåè§£æï¼Level 0ï¼</strong> è¿éã</li>
</ul>
</li>
<li><strong>äºåè§£æï¼Level 0ï¼</strong>ï¼
<ul>
<li><strong>ç¶æ</strong>ï¼æ¥æ¶ <code>1</code> èç¹ã</li>
<li><strong>å·ç</strong>ï¼<code>+</code> å·ï¼ä¼åçº§ 12ï¼ã</li>
<li><strong>å¤æ­</strong>ï¼å½åé¨æ§ 0ï¼12 &gt; 0ï¼æ¶è´¹ <code>+</code> å·ï¼è®°å¿ <code>+</code> å·ã</li>
<li><strong>éå½è°ç¨</strong>ï¼è°ç¨äºåè§£æï¼é¨æ§è®¾ä¸º 12ã</li>
</ul>
</li>
<li><strong>ç¬¬ä¸æ¬¡éå½äºåè§£æï¼Level 1ï¼å¼å§</strong>ï¼
<ul>
<li><strong>ç©éç¯è</strong>ï¼<code>2</code> ä¸è®¤è¯ï¼ç©ç©ç©... è¿å <code>2</code> èç¹ã</li>
<li><strong>ç¶æ</strong>ï¼æ¥æ¶ <code>2</code> èç¹ã</li>
<li><strong>å·ç</strong>ï¼<code>*</code> å·ï¼ä¼åçº§ 13ï¼ã</li>
<li><strong>å¤æ­</strong>ï¼å½åé¨æ§ 12ï¼13 &gt; 12ï¼<strong>å¯ä»¥åï¼</strong> æ¶è´¹ <code>*</code> å·ï¼è®°å¿ <code>*</code> å·ã</li>
<li><strong>éå½è°ç¨</strong>ï¼è°ç¨äºåè§£æï¼é¨æ§è®¾ä¸º 13ã</li>
</ul>
</li>
<li><strong>ç¬¬äºæ¬¡éå½äºåè§£æï¼Level 2ï¼å¼å§</strong>ï¼
<ul>
<li><strong>ç©éç¯è</strong>ï¼<code>3</code> ä¸è®¤è¯ï¼ç©ç©ç©... è¿å <code>3</code> èç¹ã</li>
<li><strong>ç¶æ</strong>ï¼æ¥æ¶ <code>3</code> èç¹ã</li>
<li><strong>å·ç</strong>ï¼æ²¡äºï¼æèåå·ï¼ã</li>
<li><strong>å¤æ­</strong>ï¼ä¼åçº§ä¸å¤ã</li>
<li><strong>è¿å</strong>ï¼ç´æ¥è¿å <code>3</code> èç¹ã</li>
</ul>
</li>
<li><strong>åå°ç¬¬ä¸æ¬¡éå½ï¼Level 1ï¼</strong>ï¼
<ul>
<li><strong>ç»è£</strong>ï¼æ¥æ¶å° <code>3</code> èç¹ãå·¦ææ¯ <code>2</code>ï¼å³ææ¯ <code>3</code>ï¼è®°å¿æ¯ <code>*</code>ã</li>
<li><strong>å¨ä½</strong>ï¼ç»åæ <code>2 * 3</code> èç¹ã</li>
<li><strong>è¿å</strong>ï¼æ <code>2 * 3</code> èç¹å¾ä¸äº¤ãç¬¬ä¸æ¬¡éå½ç»æã</li>
</ul>
</li>
<li><strong>åå°äºåè§£æï¼Level 0ï¼</strong>ï¼
<ul>
<li><strong>ç»è£</strong>ï¼æ¥æ¶å° <code>2 * 3</code> èç¹ãå·¦ææ¯ <code>1</code>ï¼å³ææ¯ <code>2 * 3</code>ï¼è®°å¿æ¯ <code>+</code>ã</li>
<li><strong>å¨ä½</strong>ï¼ç»åæ <code>1 + (2 * 3)</code> èç¹ã</li>
<li><strong>è¿å</strong>ï¼å¾ä¸äº¤ãç´å°èµå¼è¡¨è¾¾å¼ã</li>
</ul>
</li>
<li><strong>åå°èµå¼è¡¨è¾¾å¼ï¼ç¬¬ä¸æ¬¡éå½è°ç¨å¤ï¼</strong>ï¼
<ul>
<li><strong>ç¶æ</strong>ï¼æ¥æ¶ <code>1 + 2 * 3</code> èç¹ã</li>
<li><strong>å·ç</strong>ï¼æ²¡äºã</li>
<li><strong>è¿å</strong>ï¼ç¬¬ä¸æ¬¡èµå¼è§£æéå½è°ç¨è¿åã</li>
</ul>
</li>
<li><strong>åå°æé¡¶å±èµå¼è§£æ</strong>ï¼
<ul>
<li><strong>ç»è£</strong>ï¼å½åå·¦æ <code>m</code>ï¼å³æ <code>1 + 2 * 3</code>ï¼è®°å¿ <code>=</code>ã</li>
<li><strong>å¨ä½</strong>ï¼ç»åæ <code>m = 1 + 2 * 3</code>ã<strong>è§£æå®æ</strong>ã</li>
</ul>
</li>
</ol>
<p>ä¸é¢æä»¬åä»¥ m=1+2*3çä¾å­ï¼è¯¦ç»è§£è¯´äºèµå¼è§£æä¸­çéå½è°ç¨ï¼äºåè§£æä¸­çå¤æ¬¡éå½è°ç¨ï¼å¹¶ä¸å¨éå½çæ¶åï¼å å¥äºä¼åçº§å¥é¤ï¼ç¸ä¿¡è½çå°è¿éçæåï¼å¯¹äºè§£æçå¥è·¯ï¼å·²ç»æé£ä¹ä¸ç¹ç¹çæè§äºå§ã</p>
<p><strong>m = 1 * 2 + 3</strong>  è¿ä¸ªä¾å­  æ¯ä¸ª<strong>ä¼åçº§é«çå¨å</strong></p>
<p><strong>èç¹ 1 è¿ä¸æ¥</strong>ï¼è¢«äºåè§£ææ¦æªãå·ç  æ¯* å·  ä¼åçº§13ï¼å½å0ï¼åæã</p>
<p>è®°ä½*å·ï¼ ç¶åå¼å§éå½ï¼è°ç¨ <code>ParseBinaryExpression(13)</code></p>
<p>ç¬¬ä¸æ¬¡éå½ï¼æ¿å°2ï¼ä¸è®¤è¯ ç©ç©ç©ï¼  èç¹2è¿ä¸æ¥ï¼æ¥æ¶èç¹2ï¼ å·ç + ï¼ä¼åçº§12ï¼èå½åä¼åçº§13ï¼<strong>å¤ªå¼±äº  ä¸æ­ç</strong>ï¼å¸¦çèç¹2è¿åï¼ç»ææ¬æ¬¡éå½ã</p>
<p>æ­¤æ¶ï¼å·¦æèç¹1ï¼å³ææ¯åè¿åå¾èç¹2ï¼è®°ä½çæ¯*å·ï¼</p>
<p>ç»è£èç¹  1*2  .  ç¶åç»§ç»­ï¼  å·çåé¢  + å·ï¼ å½åä¼åçº§0ï¼+å·ä¼åçº§12ï¼</p>
<p>åææ¶è´¹æ+å·ï¼è®°ä½+å·ï¼ å¼å§ç¬¬äºæ¬¡éå½ParseBinaryExpression(12)</p>
<p>æ¿å°3  ä¸è®¤è¯ ç©ç©ç©ï¼ èç¹3è¿ä¸æ¥ æ¥æ¶èç¹3ï¼å·ç  åé¢æ²¡äºãå¸¦çèç¹3è¿åï¼ç¬¬äºæ¬¡éå½ç»æã æ­¤æ¶ å·¦ææ¯ 1*2 èç¹ï¼ å³ææ¯åè¿åæ¥ç3èç¹ï¼èå­è®°ççæ¯+å·ï¼</p>
<p>éåä¸éªï¼ 1*2+3 å®æã</p>
<p>ç®åæè¿°äºä¸ä¸ä¼åçº§é«çå¨åçä¾å­ã</p>
<p>æåè®¿é® <code>obj.data.list</code></p>
<p>è¿æ¯ä»èµå¼è§£æå¼å§ï¼çå° <code>obj</code>ï¼ä¸è®¤è¯ï¼ç©ç©ç©ï¼ä¸è·¯ä¸å»ï¼ç´å°åå­å±ã åå­å±çæ <code>VariableProxy(obj)</code> èç¹ï¼è¿åãåè¿åä¸å±ï¼å°äº <code>ParseLeftHandSideExpression</code>ã</p>
<p><strong>è¢«æ¦æªï¼</strong> æéæ¿ç <code>obj</code> èç¹ï¼å·çåé¢æ¯ä¸ª <code>.</code> ç¬¦å·ï¼æ¯æçæ´»ï¼æ¥æ¶ <code>obj</code> èç¹ï¼æ¶è´¹æ <code>.</code> ç¬¦å·ã</p>
<p>è¿éå®ä¸éè¦åå¤ç <code>[]</code> é£æ ·ï¼å»è°ç¨é£ä¸ªæ²éå¤æçè¡¨è¾¾å¼è§£æå¨ï¼å ä¸º <code>[]</code> éçè³å¯ä»¥å <code>1+1</code>ï¼ï¼èæ¯<strong>èªå·±è§£æ <code>data</code></strong>ã å ä¸ºç¹å·åé¢ï¼åªåè®¸è·ä¸ä¸ªâåå­âãæä»¥å®ç´æ¥èªå·±ä¸æï¼å¿«éæ«æè¿ä¸ªåå­ãåªæä½ åçæ¯ <code>obj.if</code> æè <code>obj.class</code>ï¼å¨è¿éä¹è¢«å½ä½æ®éçåå­å¤çãè§£æå®åå­ï¼ç«é©¬æåãè¿ç§èªåæ´ççå¤çæ¹å¼ï¼æ¯æ <code>data</code> ç©éç»åå­å±æ´å¿«éã</p>
<p>ç°å¨ï¼å·¦ææ¯ <code>obj</code> èç¹ï¼å³ææ¯åè§£æç <code>data</code>ï¼èå­è®°çç¹å·ï¼ååä¸ä¸ï¼ç»è£æ <code>obj.data</code> èç¹ã</p>
<p><strong>æ³¨æï¼è¿éæ¯ä¸ªå¾ªç¯ï¼</strong> ç»è£å®åå®ä¸èµ°ï¼å·çåé¢ï¼åï¼è¿æ¯ä¸ª <code>.</code> ç¹å·ï¼ äºæ¯æ¶è´¹æç¬¬äºä¸ª <code>.</code> å·ï¼ç»§ç»­èªå·±è§£æ <code>list</code>ã æ­¤æ¶ï¼å®çå·¦æåæäºåæç»è£å¥½ç <code>(obj.data)</code> èç¹ï¼å³ææ¯æ°æ¿å°ç <code>list</code>ï¼åæ¬¡ç»è£ï¼çæ <code>(obj.data).list</code>ã</p>
<p>åå·çï¼åé¢æ²¡äºï¼äº¤ä¸å»ã</p>
<p>ä¸åè¡¨è¾¾å¼ <code>ok ? 1 : 0</code></p>
<p>ä»èµå¼è§£æå¼å§ï¼çå°ok ä¸è®¤è¯ï¼ç©ç©ç©ï¼ä»åå­å±è¿åokèç¹ï¼è¿åå°ä¸åè§£æå±ï¼</p>
<p>æ¿çok å·ç ï¼å·åï¼ é£æ¯æçæ´»äºï¼æ¥æ¶okï¼åæï¼ï¼æ³¨æï¼ç°å¨å°±ä¸éè¦è®°ä½ï¼äºï¼å ä¸ºä¸åè¡¨è¾¾å¼æ¯åºå®çè¯­æ³ç»æï¼å¨è¿ä¸å½æ°è§£æç é½æ¯åºå®çæ ¼å¼ï¼ä¸éåè®°ï¼å·ã</p>
<p>è°ç¨ParseAssignmentExpression() ï¼å¾å°æ¡ä»¶ä¸ºçæ¶çèç¹ï¼æ­¤ä¾ä¸ºèç¹1. æ­¤æ¶ï¼å·¦æok å³æèç¹1ï¼å·ç æ¯ï¼å·ï¼å¦¥äºï¼åæï¼å·ï¼å¿é¡»æ¯åå·ï¼å¦æä¸æ¯ï¼<strong>ç´æ¥æ¥é</strong> <code>SyntaxError: Unexpected token</code></p>
<p>åæ¬¡è°ç¨ParseAssignmentExpression()ï¼å¾å°æ¡ä»¶ä¸ºåæ¶çèç¹ï¼æ­¤ä¾ä¸ºèç¹0ï¼</p>
<p>æ­¤æ¶ï¼å·¦æok å³æèç¹1    å ä¸ååè¿åçèç¹0ï¼ å¨é½äºï¼ å¬å¤</p>
<p>factory å·¥åå½æ°ï¼ NewConditional(condition, then_expr, else_expr)</p>
<p>çæä¸ä¸ª Conditional(ok, 1, 0)ï¼ä¸åæ ï¼è¿éè¦æ³¨æï¼å¹¶ä¸æ¯å·¦æå³æçäºåäºï¼èæ¯æä¸ä¸ªå­èç¹çä¸åäºï¼å³ä¸ä¸ªConditionalèç¹ï¼å¸¦3ä¸ªå­èç¹ï¼èç¹ï¼è¿åå°èµå¼è§£æå±ã</p>
<p>a || b è¿ä¸ªè§£ææ¶åå æ³å·®ä¸å¤ åªæ¯æä½ç¬¦ä¸åã</p>
<p>m = (1+2) * 8 è¿ä¸ªè¡¨è¾¾å¼å¸¦æ¬å·ï¼å®éä¹å¾ç®åï¼æ¥æ¶m å·ç=  æ¶è´¹æ=ï¼éå½è°ç¨èµå¼è§£æï¼( ä¸è·¯å°äºåå­å±ï¼åå­å±åæ <code>(</code> ï¼ç¶åè°ç¨æé«çº§ç <strong><code>ParseExpression</code></strong>ï¼æ³¨æï¼æ¯éæ°ä»å¤´è°ç¨è¡¨è¾¾å¼è§£æï¼ç¸å½äºå¼å¯äºä¸ä¸ªæ°çç¬ç«å¯æ¬ï¼ã ç¶åæ¥æ¶1+2èç¹ï¼å·ç ï¼ï¼æ¬£æ°ï¼åæåäºä¸ªï¼ï¼ç°å¨æå¯¹äºï¼ äºæ¯åæ ï¼ï¼ æ1+2 èç¹ä¸äº¤ããã åé¢å°±æ´ç®åäºãçç¥ã</p>
<p>add(1, 2, 3)</p>
<p>ä¾æ§æ¯ä»åå­å±è¿åaddèç¹ï¼è¿åå°ParseLeftHandSideExpressionå±ï¼å·ç æ¯ ï¼</p>
<p>ï¼æ¥æ¶addèç¹ï¼ åæï¼ ï¼ è°ç¨ParseArgumentsï¼æ¶éåæ°ï¼ä¾æ¬¡è°ç¨ParseAssignmentExpression æ¶éåæ°ï¼ç´å°ç¢°å° ï¼ï¼åæ ï¼ï¼è¿åï¼æ­¤æ¶ParseLeftHandSideExpressionå·¦æaddèç¹  å³æåææ¿å°çåæ°åè¡¨ï¼ç»è£ï¼å®å·¥ã</p>
<p>**m[2] **</p>
<p>è¿æ¯å¸¦æè®¡ç®å±æ§çæåè®¿é®å½¢å¼ã LHS å±å¨å¤çæ¶ï¼ä¼æè§£æç¹å· <code>.</code> åä¸­æ¬å· <code>[</code> çä»»å¡ï¼ç»ä¸ç©ç» <strong><code>ParseMemberExpression</code></strong> æ¥å¤çï¼<code>new</code> æä½ç¬¦ä¹å½å®ç®¡ï¼ï¼è LHS èªå·±è´è´£å½æ°è°ç¨åæ¨¡æ¿å­ç¬¦ä¸²çè§£æã</p>
<p><strong>ç®è¦æµç¨ï¼</strong></p>
<ol>
<li>
<p><strong>åæ¾å¤´ï¼</strong> åè§£æåº <code>m</code>ã</p>
</li>
<li>
<p><strong>è¿å¥å¾ªç¯ï¼</strong> <code>ParseMemberExpression</code> å¯å¨ <code>while</code> å¾ªç¯ï¼å·çåé¢ã</p>
</li>
<li>
<p><strong>å¤çä¸­æ¬å·ï¼</strong> åç°æ¯ <code>[</code>ï¼åæå®ã</p>
<p>è¿éä¼è°ç¨ <strong><code>ParseExpression(true)</code></strong>ãè¿ä¸ª <code>true</code> è¡¨ç¤ºåè®¸åå«éå·ï¼è¡¨ç¤ºä¸­æ¬å·éå¯ä»¥åå®æ´çè¡¨è¾¾å¼ï¼æ¯å¦ <code>1+1</code>æèæ´å¤æçè¡¨è¾¾å¼ï¼ã</p>
</li>
<li>
<p><strong>ç»è£ï¼</strong> <code>ParseExpression</code> è¿åèç¹ <code>2</code>ï¼åæ <code>]</code>ï¼å° <code>m</code> å <code>2</code> ç»è£èµ·æ¥ã</p>
</li>
<li>
<p><strong>ç»§ç»­å¾ªç¯ï¼</strong> å¦æåé¢è¿æ <code>[</code> æ <code>.</code>ï¼æ¯å¦äºç»´æ°ç»æé¾å¼è°ç¨ï¼ï¼å°±ç»§ç»­è§£æãç»§ç»­åå¨å¤é¢ç»è£ï¼å¦ææ²¡æï¼å°±è¿åã</p>
</li>
</ol>
<blockquote>
<p>ä¸é¢æä»¬è¿å¥æèæ¨¡å¼</p>
</blockquote>
<p>æä»¬è¯´  å¨èµå¼è§£æçæ¶å  è¦ä½¿ç¨éå½è°ç¨ï¼è¿æ¯æ²¡æä»»ä½é®é¢çï¼å ä¸ºéå½è°ç¨æ¬èº«å°±å¯ä»¥å¾å°å³ç»åçç®çï¼åè¿ç­èµå¼çå®ä¹æ¯ç¸ç¬¦åçã</p>
<p>å¨äºåè§£æçæ¶åï¼æä»¬ä¹è¯´ä½¿ç¨éå½è°ç¨ï¼ä½æ¯è¿å°±æäºé®é¢ï¼å ä¸ºéå½è°ç¨ä¼äº§çå³ç»åï¼èéè¿ä½¿ç¨ä¼åçº§  åéå°åçº§æä½ç¬¦ åéåºéå½  ç±ä¸çº§å¤çå·¦ç»åä»¥å  åæ¬¡éå½ï¼è¿æ ·ä¹å¯ä»¥è¾¾å°å·¦ç»åçç®çã  è¿ç§æ¹å¼æ¬èº«ä¹æ²¡é®é¢ï¼ä»åµå¥æ·±åº¦ä¸æ¥è®²ï¼æéæåµä¸ ä¹ä¸è¿æ¯åå¤ä¸ªéå½åµå¥ï¼å¹¶ä¸ä¼æ æº¢åºã ä½æ¯ä»æ¨ªåä¸æ¥çï¼æ¯å¦ æå¤ä¸ªåçº§æä½ç¬¦çæ¶å  å°±æ¯è¾ç¹çï¼æå¶é¢ç¹çå½æ°è°ç¨ï¼å¼éæ¯è¾å¤§ã</p>
<p>soï¼ v8å¨å·ä½å®ç°äºåè§£æçæ¶å  éç¨çæ¯ å¾ªç¯ä¸ºä¸»  éå½ä¸ºè¾ çæ¹å¼ãç¨å¾ªç¯å¤çåçº§å·¦ç»åï¼ç¨éå½ä¸éå¤çæ´é«ä¼åçº§çå­è¡¨è¾¾å¼</p>
<p>ä¸»è¦æè·¯å°±æ¯å¨whileå¾ªç¯éå¤çåä¼åçº§ï¼é«ä¼åçº§ç åè¿å°éå½éå¤çï¼ ä¸ä¸ªwhileå¾ªç¯éå¤çåä¸çº§ï¼é«ä¼åçº§ç  è¿å°éå½é ç»§ç»­å¨éå½éçé£ä¸ªwhileéå¤çé£ä¸ªé«ä¼åçº§çåçº§ãå¦æ­¤å¾ªç¯ï¼æä»¥ï¼å®éä¸ï¼è·æä»¬ä¹åä¾å­éå­¦çï¼å¨é¨éå½çæ¹å¼ï¼å¨éå½å±æ¬¡ä¸ç¸åï¼æéæåµä¸  ä¹ä¸è¿æ¯åå¤ä¸ªåµå¥éå½ï¼ ä½æ¯ï¼æ¨ªåçåçº§ï¼åè¢«åææå¨ä¸ä¸ªwhileå¾ªç¯éå¤çã</p>
<pre><code>ä¼ªä»£ç 

// å¥å£ï¼è§£æäºåè¡¨è¾¾å¼ï¼ä¼ å¥å½ååè®¸çæå°ä¼åçº§
function ParseBinaryExpression(min_precedence) {

  //  [åå§å·¦å¼] åæå®å·¦è¾¹çåå­ (ä¾å¦: 1)
  let x = ParseUnaryExpression(); 

  //   å¼å¯å¤§å¾ªç¯
  // åªè¦åé¢è¿æè½åçç¬¦å·ï¼å°±ä¸ç´å¨è¿ä¸ªå¾ªç¯éè½¬
  while (true) {
      let op = Peek(); // å·çä¸ä¸ä¸ªç¬¦å·
  
      // éå°è¿ä¸¤ç§æåµ 1æ¯ç¬¦å·æ²¡äºï¼å°å¤´äº 2æ¯ä¸ä¸ªç¬¦å·å¤ªå¼±äºï¼è¯¥ä¸å±éå½è¦ç®¡çäºæï¼
      // è¿æ¶ï¼å°±å¸¦çæéç§¯æç x èµ¶ç´§è¿å
      if (!op || op.precedence &lt;= min_precedence) {
         return x;
       }

      //  [æ¶è´¹] ä¼åçº§å¤æ ¼ï¼åæç¬¦å· (æ¯å¦ +)
       Consume(op);

      // [éå½è·åå³å¼] 
      // è®©éå½å½æ°å»æ¿å³è¾¹çæ°ã
      // å³é®ç¹ï¼æå½å op çä¼åçº§ä¼ ä¸å»
      // è¿æ ·å¦æå³è¾¹æ¯åçº§è¿ç®(å¦ 1+2+3)ï¼éå½å½æ°ä¼åç°ä¼åçº§ä¸å¤ï¼åªæ¿ä¸ä¸ªæ°å°±ç«é©¬       //   è¿åã
      // å¦æå³è¾¹æ¯é«çº§è¿ç®(å¦ 1+2*3)ï¼éå½å½æ°ä¼æ·±å¥å¤çã
      let y = ParseBinaryExpression(op.precedence);

      // [åå°ç´¯å  åæ»éªç] 
      // æå·¦è¾¹(x)ãç¬¦å·(op)ãå³è¾¹(y) ç»è£ææ°èç¹ã
      // æ ¸å¿å¨ä½ï¼ææ°èç¹èµå¼å x
      // ç°å¨ç x ä» "1" åæäº "(1+2)"ã
      x = NewBinaryNode(op, x, y);

      //  [å¾ªç¯ç»§ç»­] 
      // ä»£ç è¿è¡å°è¿éï¼ä¼åå°å¤§å¾ªç¯å¼å§å¤ã
      // æ­¤æ¶æéæ¿çæ°ç xï¼ (1+2)ï¼å»å·çä¸ä¸ä¸ªç¬¦å·ï¼æ¯å¦ +3 çé£ä¸ª +ï¼ã
      // å¦æä¸ä¸ä¸ªç¬¦å·ä¼åçº§è¿å¤ï¼å°±ç»§ç»­åï¼ä¸å¤å°±ç±ifè¯­å¥éåºã  
   } 
   
}
      

</code></pre>
<p>ä¸é¢æ¯ä½¿ç¨å¾ªç¯ä¸ºä¸»  éå½ä¸ºè¾ å®ç°<strong>äºåè§£æ  å·¦ç»å</strong>çä¼ªä»£ç ã</p>
<p>çè§£ä¼ªä»£ç  çè§£æè·¯ä»¥åï¼ä¼æè§  çè³æ¯ååççº¯éå½æ´å®¹æãå·ä½çä¾å­å°±ä¸ä¸¾äºã</p>
<p>æ³¨æ   <strong>è¿éè¦è¯´æ éåæ¯å¦ä½ä¸éªç</strong></p>
<p>ä¹åæä»¬è¯´  å¬å¤å·¥åæ¹æ³ï¼éåä¸éªï¼èç¹è¯çï¼ v8ä¸­çASTèç¹çåå»ºï¼æèªå·±çåå­åéæ¹æ³ï¼å®éç¨çæ¯ä¸ç§å« Zone Allocationçåéæ¹å¼ãç±»ä¼¼äºæååå°æ¨¡å¼ã</p>
<p>è§£æåï¼V8 ç´æ¥åç³»ç»âåâäºä¸å¤§çè¿ç»­çåå­ï¼ååä¸º <strong>Zone</strong>ã</p>
<p>å½å·¥åå½æ° <code>factory() --- NewAssignment(...)</code> è¢«è°ç¨æ¶ï¼å®åªæ¯å¨èªå·±åå¥½çè¿åå°éï¼æ<strong>æéå¾åæªä¸æª</strong>ï¼ååºä¸å°åå°ç»è¿ä¸ªèç¹ä½ã</p>
<p>è¿ä¸ªå¨ä½å¿«å°ä¸å¯æè®®ï¼ä»ä»æ¯ç®åçæéå æ³æä½ã</p>
<p>èå½éè¦éæ¯æ¶ï¼V8 ä¸éè¦ä¸ä¸ªä¸ªèç¹å»æé¤ï¼å®åªéè¦æ <strong>Zone</strong> æ´ä¸ªæ¨å¹³ã<strong>ä¸é®æ¸ç©ºï¼ç¬é´æ»¡è¡ã</strong></p>
<p>æä»¥ï¼AST èç¹çåå»ºï¼æ¯<strong>æéçæéè·³å¨</strong>ãè¿ä¿è¯äºåªæä»£ç éåå¤§ï¼è§£æå¨çåå­åééåº¦ä¹å¿«å¦éªçµã</p>
<p>å¨è¡¨è¾¾å¼è§£æçå®¶æéï¼è¿æä¸ä¸ªä¸å¾ä¸æçéç£äººç©ï¼é£å°±æ¯ ES6 å¼å¥ç <strong>ç®­å¤´å½æ°</strong> <code>() =&gt; {}</code>ã</p>
<p>ä½ å¯è½ä¼é®ï¼âå®ä¸æ¯å½æ°åï¼ä¸ºä»ä¹è¦å¨è¡¨è¾¾å¼è¿éè®²ï¼â è¿æ¯å ä¸ºå¨ V8 ç¼éï¼<strong>ç®­å¤´å½æ°é¦åæ¯ä¸ä¸ªè¡¨è¾¾å¼</strong>ãå®éå¸¸åºç°å¨èµå¼å·å³è¾¹ï¼<code>let a = () =&gt; {}</code>ï¼æèä½ä¸ºåæ°ï¼<code>func(() =&gt; {})</code>ï¼ãå®ä¸è½å <code>function</code> å³é®å­é£æ ·ç¬ç«æè¡ï¼é¤éä½ æ²¡ååå­ä¸ä¸èµå¼ï¼è½ç¶åæ³ä½æ²¡æä¹ï¼ã</p>
<p>ä½å®è®©è§£æå¨éå¸¸å¤´ç¼ï¼å ä¸ºå®åæ¬¢ <strong>ä¼ªè£</strong>ã</p>
<p>çè¿è¡ä»£ç ï¼</p>
<p>let x = (a, b ...</p>
<p>å½è§£æå¨è¯»å°è¿éæ¶ï¼å®æäºç³æ¶äºã</p>
<ul>
<li>å¦ææ¯ <code>let x = (a, b);</code> ââ è¿æ¯ä¸ä¸ª <strong>åç»è¡¨è¾¾å¼</strong>ï¼éé¢æ¯ä¸ªéå·è¿ç®ã</li>
<li>å¦ææ¯ <code>let x = (a, b) =&gt; a + b;</code> ââ è¿æ¯ä¸ä¸ª <strong>ç®­å¤´å½æ°</strong>ã</li>
</ul>
<p>å¨è¯»å° =&gt; è¿ä¸ªå³é® Token ä¹åï¼è§£æå¨æ ¹æ¬ä¸ç¥éåé¢ç (a, b) å°åºæ¯ä¸ªä»ä¹ã</p>
<p>è¿å°±æ¯è§£æå¨é¢ä¸´ç æ­§ä¹ ã</p>
<p>å¦æ V8 åªæè¯»å° =&gt; æç¥éåé¢æ¯åæ°ï¼é£é¾éè¦åå­ç Token ä¸è§£æï¼ç­çå°äºç®­å¤´ååå¤´è§£æåï¼</p>
<p>ä¸ï¼V8 éå¸¸ä¸æ¿æåå¤´ã å®éç¨äºä¸ç§ âå°éå°±éï¼åæä¿®æ­£â çç­ç¥ï¼æ¯è¯­å« Cover Grammarï¼è¦çè¯­æ³ï¼ã</p>
<p>æä»¬ä»¥ <code>(a, b) = a + b</code> ä¸ºä¾ï¼ççè§£æå¨æ¯æä¹è¢«éªï¼åæ¯æä¹ååºè¿æ¥çã</p>
<h4 id="é¶æ®µä¸æè¡¨è¾¾å¼è§£æ">é¶æ®µä¸ï¼æè¡¨è¾¾å¼è§£æ</h4>
<p><strong>1. å¥å£ä¸è¯¯å¤</strong></p>
<p>è§£æå¨å¨æ«æå°å·¦æ¬å· <code>(</code> æ¶ï¼å®æ­¤æ¶å¤äº <code>ParsePrimaryExpression</code>ï¼åºç¡è¡¨è¾¾å¼è§£æï¼çä¸ä¸æä¸­ã æ­¤æ¶ï¼è§£æå¨å¿éåªæä¸ç§æ³æ³ï¼âè¿è¯å®æ¯ä¸ª <strong>åç»è¡¨è¾¾å¼ (Parenthesized Expression)</strong>ï¼éé¢åçä¸äºè¿ç®é»è¾ãâ</p>
<p><strong>2. è¡¨è¾¾å¼è§£ææ¨¡å¼å¯å¨</strong></p>
<p>è§£æå¨å¼å§è°ç¨ <code>ParseExpression</code> æ¥å¤çæ¬å·éçåå®¹ï¼</p>
<ul>
<li><strong>è¯»å° <code>a</code></strong>ï¼
<ul>
<li>è§£æå¨è®¤ä¸ºè¿æ¯å¨ä½¿ç¨åé <code>a</code>ã</li>
<li><strong>äº§ç©</strong>ï¼çæä¸ä¸ª <code>VariableProxy</code> èç¹ï¼åéä»£çï¼è¡¨ç¤ºâæè¦å¼ç¨ aâï¼ã</li>
</ul>
</li>
<li><strong>è¯»å° <code>,</code></strong>ï¼
<ul>
<li>è§£æå¨è®¤ä¸ºè¿æ¯ <strong>éå·è¿ç®ç¬¦ (Comma Operator)</strong>ã</li>
<li>å®çä½ç¨æ¯è¿æ¥ä¸¤ä¸ªè¡¨è¾¾å¼ï¼å¹¶è¿ååèã</li>
</ul>
</li>
<li><strong>è¯»å° <code>b</code></strong>ï¼
<ul>
<li>çæ <code>VariableProxy</code> èç¹ï¼è¡¨ç¤ºâæè¦å¼ç¨ bâï¼ã</li>
</ul>
</li>
</ul>
<p><strong>3. é¶æ®µæ§äº§ç©</strong> å½è§£æå¨åæå³æ¬å· <code>)</code> æ¶ï¼å®æéæ§çä¸ä¸ª å¤åè¿ç® æèå« <strong><code>éå·è¡¨è¾¾å¼</code></strong>ã å¨è§£æå¨ç¼éï¼<code>(a, b)</code> ç®åçå«ä¹æ¯ï¼<strong>âåæ§è¡ aï¼ææç»æï¼åæ§è¡ bï¼è¿å bãâ</strong> <em>è¿æ¾ç¶ä¸æ¯æä»¬æ³è¦çç»æï¼ä½å¨è¯»å° <code>=&gt;</code> ä¹åï¼è¿æ¯å¯ä¸åæ³çè§£éã</em></p>
<h4 id="é¶æ®µäºåäº--åç°ç®­å¤´">é¶æ®µäºï¼åäº  åç°ç®­å¤´</h4>
<p>è§£æå¨ååå® <code>)</code>ï¼ç«å»å¯å¨ <strong>åç» (Lookahead/Peek)</strong> æè½ï¼å·çä¸ä¸ä¸ª Tokenã</p>
<ul>
<li><strong>å¦æåé¢æ¯ <code>+</code></strong>ï¼é£åé¢å°±æ¯ä¸ªéå·è¡¨è¾¾å¼ï¼ç»§ç»­åå æ³ã</li>
<li><strong>ä½è¿æ¬¡ï¼å®çå°äº <code>=&gt;</code></strong>ï¼</li>
</ul>
<p><strong>è§£æå¨ï¼</strong></p>
<p>âååï¼æä¸ç®­å¤´äºï¼ åé¢é£ä¸ªæ¬å·éçæ ¹æ¬ä¸æ¯ä»ä¹éå·è¿ç®ï¼é£æ¯ <strong>ç®­å¤´å½æ°çåæ°åè¡¨ (Formal Parameters)</strong>ï¼ æéæ§ççè¿äº <code>VariableProxy</code>ï¼åéå¼ç¨ï¼ï¼å¨é½æ¯åºçº¸ï¼å®ä»¬åºè¯¥æ¯ <strong>åæ°å£°æ</strong> æå¯¹ï¼â</p>
<p>æ­¤æ¶ï¼è§£æå¨å¿é¡»å¯å¨ç´§æ¥é¢æ¡ï¼<strong>éè§£é (Reinterpretation)</strong>ã</p>
<h4 id="é¶æ®µä¸-ast-è¿è¡åå°ä¿®æ­£åèº«">é¶æ®µä¸ï¼ AST è¿è¡åå°ä¿®æ­£åèº«</h4>
<p>V8  éå¸¸ä¸ä¼åéæééæ°è§£æä¸éï¼é£å¤ªæ¢äºï¼ãå®éæ©ç´æ¥å¯¹åå­éå·²æç AST èç¹ä¿®æ¹ã</p>
<p><strong>1. åæ³æ§æ£æ¥</strong> è§£æå¨éååæé£ä¸ª <code>CommaExpression</code> éçæ¯ä¸ä¸ªå­èç¹ï¼ï¼</p>
<ul>
<li><strong>æ£æ¥ <code>a</code></strong>ï¼ä½ æ¯ä¸ª <code>VariableProxy</code> åï¼æ¯ãä½ çåå­æ¯åæ³çåæ°ååï¼æ¯ã -<strong>éè¿</strong>ã</li>
<li><strong>æ£æ¥ <code>b</code></strong>ï¼ä½ æ¯ä¸ª <code>VariableProxy</code> åï¼æ¯ã -<strong>éè¿</strong>ã</li>
<li><strong>åå¦</strong>ï¼åå¦ä½ åçæ¯ <code>(a + 1) =&gt; ...</code>ã
<ul>
<li>è§£æå¨ä¼åç°åè¡¨éæä¸ª <code>BinaryOperation</code>ï¼å æ³èç¹ï¼ã</li>
<li>é®ï¼â<code>a+1</code> è½å½åæ°ååï¼â</li>
<li><strong>åç­</strong>ï¼ä¸è½ã -<strong>ç´æ¥æ¥é <code>SyntaxError</code></strong>ã</li>
</ul>
</li>
<li>å¨è¿éè¿è¦è¿è¡å¶ä»çå¿é¡»æ£æ¥ï¼ä»¥ä¿è¯å®ä»¬ä½ä¸ºåæ°çåæ³æ§ã</li>
</ul>
<p><strong>2. èç¹è½¬å (Transformation)</strong> è¿æ¯æéè¦çä¸æ­¥ãè§£æå¨ä¸éæ¯èç¹ï¼èæ¯ä¿®æ¹èç¹ç <strong>æ§è´¨</strong>ã</p>
<ul>
<li>å®æ <code>a</code> å <code>b</code> ç <code>VariableProxy</code> èç¹ï¼<strong>åå°è½¬å</strong> ä¸º <strong>åæ°å£°æ</strong>ã</li>
<li><strong>å³é®å¨ä½</strong>ï¼
<ul>
<li>ä¹åï¼<code>a</code> æåçæ¯å¤å±ä½ç¨åï¼è¯å¾å¼ç¨ï¼ã</li>
<li>ç°å¨ï¼è§£æå¨æ <code>a</code> ä»å¤å±ä½ç¨åçå¼ç¨åè¡¨ä¸­<strong>æé¤</strong>ã</li>
<li>ç¶åï¼æ <code>a</code> ä½ä¸º <strong>æ°å£°æ</strong>ï¼ç»è®°å°å³å°åå»ºç <strong>FunctionScope</strong> éã</li>
</ul>
</li>
</ul>
<p>ä»æ­¤ï¼<code>a</code> å <code>b</code> ä»âæ¶è´¹èâï¼å¼ç¨ï¼åæäºâçäº§èâï¼å£°æï¼ã</p>
<h4 id="é¶æ®µåè§£æå½æ°ä½">é¶æ®µåï¼è§£æå½æ°ä½</h4>
<p>åæ°æå®äºï¼ç°å¨å¤ç <code>=&gt;</code> åé¢ç <code>a + b</code>ã</p>
<p><strong>1. åå»ºä½ç¨å</strong> V8 è°ç¨ <code>NewFunctionScope</code>ï¼åå»ºä¸ä¸ªæ°çå½æ°ä½ç¨åã</p>
<ul>
<li><strong>æ³¨æ</strong>ï¼å ä¸ºæ¯ç®­å¤´å½æ°ï¼æä»¥è¿ä¸ª Scope è¢«æ è®°ä¸º <code>is_arrow_scope</code>ï¼æä»¥å®<strong>ä¸ä¼</strong>å£°æ <code>this</code>ï¼ä¹ä¸ä¼å£°æ <code>arguments</code>ã</li>
</ul>
<p><strong>2. å·çä¸å¤å®</strong> è§£æå¨å·çç®­å¤´åé¢ç Tokenï¼</p>
<ul>
<li>æ¯ <code>{</code> åï¼ä¸æ¯ã</li>
<li>é£è¿æ¯ä¸ä¸ª <strong>Concise Body (ç®åä½)</strong>ã</li>
</ul>
<p><strong>3. èªå¨åè£ (Desugaring)</strong> å¯¹äº <code>a + b</code> è¿ç§ç®åä½ï¼è§£æå¨å¹¶ä¸æ¯ç´æ¥æå®å½è¡¨è¾¾å¼æå¨é£ã å®ä¼ç±å·¥åæ¹æ³çæä¸ä¸ª <strong><code>ReturnStatement</code></strong> èç¹ï¼æ <code>a + b</code> åå¨éé¢ã</p>
<p><strong>æç»äº§ç©ï¼</strong> è½ç¶ä½ åçæ¯ <code>(a, b) =&gt; a + b</code>ï¼ä½å¨ V8 ç AST éï¼å®é¿å¾åä¸é¢è¿æ®µä»£ç å ä¹ä¸æ¨¡ä¸æ ·ï¼</p>
<pre><code>function (a, b) {
  return a + b;
}
</code></pre>
<p>è¿å°±æ¯è¦çè¯­æ³ <strong>Cover Grammar</strong> ï¼<strong>åæéç¨çè¡¨è¾¾å¼è§£æï¼ä¸æ¦åç°ç¹å¾ï¼ç®­å¤´ï¼ï¼ç«å»æå·²æç AST ç»æéç»ä¸ºç¹å®è¯­æ³ç»æã</strong></p>
<p>é¢è¯å®å¿è¢«åæé¢ï¼<strong>ä¸ºä»ä¹ç®­å¤´å½æ°æ²¡æ <code>this</code>ï¼</strong></p>
<p>å¾å¤æç¨è¯´ï¼âç®­å¤´å½æ°ç this æåå¤å±ãâ</p>
<p>è¿å¥è¯æ¯å¯¹çï¼ä½å¨ V8 çå®ç°éï¼æ´åç¡®çè¯´æ³æ¯ï¼ç®­å¤´å½æ°æ ¹æ¬å°±ä¸å¨è¿ä¸ªä½ç¨åéå®ä¹ thisã</p>
<p>æä»¬æ¥çç <strong>Scope åæ</strong> é¶æ®µåçäºä»ä¹ï¼</p>
<p><strong>æ®éå½æ° (<code>function</code>) ç Scopeï¼</strong></p>
<ul>
<li>V8 åå»º <code>FunctionScope</code>ã</li>
<li>V8 ä¼å¨è¿ä¸ª Scope éä¸é¨å£°æä¸ä¸ªéèåéï¼<code>this</code>ã</li>
<li>å½ä½ è®¿é® <code>this</code> æ¶ï¼æ¾å°çå°±æ¯è¿ä¸ªä¸é¨å£°æçåéï¼ç±è°ç¨æ¹å¼å³å®å¼ï¼ã</li>
</ul>
<p><strong>ç®­å¤´å½æ° (<code>=&gt;</code>) ç Scopeï¼</strong></p>
<ul>
<li>V8 åå»º <code>FunctionScope</code>ã</li>
<li><strong>å³é®ç¹</strong>ï¼V8 ç»è¿ä¸ª Scope æä¸ä¸ä¸ªæ è®° ââ <strong><code>is_arrow_scope</code></strong>ã</li>
<li><strong>åæ</strong>ï¼V8 <strong>ä¸ä¼</strong> å¨è¿ä¸ª Scope éå£°æ <code>this</code> åéã</li>
</ul>
<p>æ¥æ¾è¿ç¨ï¼</p>
<p>å½ä½ å¨ç®­å¤´å½æ°éå console.log(this)ï¼</p>
<ol>
<li>è§£æå¨å¨å½å Scope æ¾ <code>this</code>ã</li>
<li><strong>æ¾ä¸å°ï¼</strong>ï¼å ä¸ºæ ¹æ¬æ²¡å£°æï¼ã</li>
<li><strong>å¾ä¸æ¾</strong>ï¼æ²¿ç <code>outer_scope</code> æéå»ç¶çº§ä½ç¨åæ¾ã</li>
<li><strong>ç»æ</strong>ï¼å®èªç¶èç¶å°å°±ç¨äºå¤å±ç <code>this</code>ã</li>
</ol>
<p>è¿ä¸æ¯ä»ä¹ç¹æ®çâç»å®æºå¶âï¼è¿åçº¯å°±æ¯âåéæ¥æ¾æºå¶âçèªç¶ç»æã</p>
<p>å ä¸ºå®èªå·±æ²¡æï¼æä»¥åªè½ç¨èç¸çãè¿å°±æ¯ è¯æ³ä½ç¨å (Lexical Scoping) çæ¬è´¨ã</p>
<p>ä»è§£æå¨çè§åº¦çï¼ç®­å¤´å½æ°æ¯ä¸ä¸ª <strong>âä¸æ â</strong> äº§åï¼è¿æ­£æ¯å®è½»éçåå ï¼</p>
<ol>
<li><strong>æ  <code>this</code></strong>ï¼Scope éä¸å£°æ <code>this</code>ï¼ç´æ¥éä¼ å¤å±ã</li>
<li><strong>æ  <code>arguments</code></strong>ï¼Scope éä¸å£°æ <code>arguments</code> å¯¹è±¡ï¼ä¹æ¯éä¼ ã</li>
<li><strong>æ  <code>construct</code></strong>ï¼çæç <code>FunctionLiteral</code> èç¹ä¼è¢«æ è®°ä¸ºâä¸å¯æé âãå¦æä½ æ³ <code>new</code> å®ï¼ç°å¨ç¸ä¸äºä½ ï¼è¿ä¸ä¼è¯å®ç¸é£ä½ ã</li>
</ol>
<p>éè¿ç®­å¤´å½æ°çå­¦ä¹ ï¼è¯´æä¿©é®é¢ã</p>
<ol>
<li><strong>è§£æå±é¢çæ­§ä¹</strong>ï¼ä¸ºä»ä¹è§£æå¨è¦åæº¯ãéè§£éï¼ã</li>
<li><strong>ä½ç¨åå±é¢ç <code>this</code> æ¬è´¨</strong>ï¼ä¸æ¯ç»å®ï¼èæ¯æ¥æ¾ï¼ã</li>
</ol>
<p>ä¸é¢ æä»¬å·²ç»åºæ¬ä¸å°è¡¨è¾¾å¼è§£æçæ¯è¾å¸¸è§çå½¢å¼  ä»è¶çº§è¯¦ç»çææ¯å°ç®ç¥çæ¢³çï¼è®²äºå ä¸ªï¼å¦æè½èå¿ççå®ï¼ç¸ä¿¡èªå·±ä¹å¯ä»¥åæäºï¼å³ä½¿è¿ææ²¡éå°çè¡¨è¾¾å¼å½¢å¼ï¼æ ¹æ®æ¯ç¨çå¥è·¯ï¼ä¹è½èªå·±æå®ã</p>
<p>å¨å­¦ä¹ è¿äºåå®¹æ¶ï¼è¦èç³»å°å¨jså±é¢ç¼ç æ¶ï¼è¡¨ç°åºçç¹ç¹ãè¿æ ·ä¸ä»jsè½ææ¡çç¢ï¼ åºå±ä¹è®°å¾ä½ã æ¯å¦obj.data.listçè§£æï¼ä¸»è¦æ¯å¨LHSå±éçwhileå¤§å¾ªç¯éè§£æç¹åé¢çåå®¹ï¼åå®¹æ¯å­ç¬¦ä¸²çå½¢å¼ï¼ æ¯åºå®çï¼ èm[2]ï¼è§£æçæ¶åï¼Lhsçå°æ¯ä¸­æ¬å·éçåå®¹ï¼æ¯è°ç¨äºé¡¶å±çè¡¨è¾¾å¼è§£æå½æ°æ¥å¹²æ´»çï¼è¡¨è¾¾å¼è§£æå¯ä»¥è§£æçä¸è¥¿é£å¯å¤äºï¼èä¸è¿å¯è½æéå½ï¼æä»¥å¨jsçç¼ç æ¶ï¼è¦ç¥éè¿ä¸¤ç§çåºå«åæ§è½ä¸çå·®å¼ãè½ç¶è¯´ ç°å¨çµèæ§è½å¿«å°é£èµ·ï¼é½å¾ç¨ç³å¤´åä½ï¼èä¸æµè§å¨æ¬èº«çä¼åä¹å¾åå®³ï¼ä¸ä¸¢ä¸¢ä¸¢ä¸¢çæ§è½å·®å¼å®å¨ä¸ç¨æå¿ï¼ä½æ¯ï¼ä¸ä¸ä½ æ¢å·¥ä½å»é¢è¯ï¼æ­£å·§é®å°ä½ è¿ä¸¤ç§çåºå«ãããå¿å¿å¿ï¼ä½ å°±ççå¯ä»¥åé£äºå«è¡æéè¯´çé£æ ·  åæé¢è¯å®äºãæ³æ³é½åºæ¿ã</p>
</li>
</ul>
</li>
<li>
<p>å¨åé¢ï¼æä»¬äºè§£äºï¼å¨ é¡¹ çº§çè§£æä¸­ï¼å®å®éæ¯ä¸ªåæµå¤ï¼æå£°æçé¡¹æ¦æªåç´æ¥ç©éï¼ æè¯­å¥çé¡¹ç©éç»è¯­å¥è§£æãèä¸é¢æä»¬è±äºå¤§ç¯å¹è®²çè¡¨è¾¾å¼è§£æï¼æ¯è¯­å¥è§£æä¸­ï¼è´è´£ååºçè¡¨è¾¾å¼è§£æã æä»¥ æä»¬è¿å©ä¸å¯ç¨å³é®å­å¹éçè¯­å¥è§£æ  å å¨é¡¹ çº§å°±è¢«ç´æ¥æ´¾åçå£°æçè§£æãç°å¨æä»¬å¼å§äºè§£å£°æçè§£æã</p>
</li>
</ol>
<p><strong>å£°æçè§£æ</strong></p>
<p>å£°æçè§£æä¸å¤ï¼æ»ç»èµ·æ¥ï¼å°±æ¯ï¼<strong>ä¸ç±»åå½ä¸¤åé</strong>ã</p>
<pre><code>class C {}   // ç±»

function f() {}  //åç§å½¢å¼çfunction

function* g() {}

async function f() {}

async function* g() {}

let     //åé
const
</code></pre>
<p>å¯è½ææåä¼é®äºï¼varåªå¿å»äºï¼  å¨jsè§èä¸­ï¼ varå±äº è¯­å¥ï¼ä¸å±äºå£°æï¼å³ varå±äºVariableStatement  ã ä½æ¯ ä»varçææåè¯­ä¹ä¸æ¥è¯´ï¼å®ç¡®å®æ¯å£°æåéã</p>
<p>æä»¥ ä»è§èçè§åº¦æ¥è¯´ï¼ å£°æ åªæè¿ä¸ç±»åå½ä¸¤åéï¼ æ²¡ævarï¼ ä½å¯æ¯ï¼ å¨v8çå·ä½å®ç°ä¸­ï¼let const var  è¿ä¸ä¸ªå´æ¯è¢«åå°ä¸èµ· ä½ä¸ºåéå®ä¹ æ´¾åå°äºParseVariableDeclarationsä¸­è§£æï¼åªæ¯å¨éé¢è§£æçæ¶å ä»ä»¬æä¸åçå¤çåæ¯ã</p>
<p>å¨è¿è¡ä¸ä¸æ­¥å­¦ä¹ ä¹å ï¼æä»¬åæ¬¡çæ»ç»ä¸ä¸ï¼</p>
<p>å¼å§è§£æä¹åï¼æ¥å° é¡¹çº§  è¢«åæµæä¸¤ç§ï¼ <strong>ä¸ä¸ª</strong>æ¯å£°æ  åæ¬ï¼ä¸ç±»åå½ä¸¤åéï¼4ç§å½æ°è¢«åå°ParseHoistableDeclarationï¼ç±»è¢«åå°ParseClassDeclarationï¼åéå£°æ(è¿éè¦æ³¨æï¼jsè§èvarä¸å±äºå£°æï¼ä½æ¯v8ä¸­ varä¹å¨è¿éè¢«ååäº) è¢«åå°ParseVariableDeclarationsï¼</p>
<p>è¿æ<strong>ä¸ä¸ª</strong>æ¯è¯­å¥ï¼è¯­å¥ç»ä¸è¢«ç©éå°ParseStatementè¿è¡è§£æï¼å¨è§£ææ¶  åæå³é®å­æ´¾åï¼æ å³é®å­å¹éçç©ç»è¡¨è¾¾å¼ååºã</p>
<p>æä»¬é¦åä»¥ä¸ä¸ªç®åçå½æ°å£°æçè§£æä¸ºä¾ã</p>
<pre><code>function add(x, y) {
  let result = x + y;
  return result;
}
</code></pre>
<p>åå§æåµï¼</p>
<ul>
<li><strong>å½åä½ç¨åï¼</strong> Global Scopeï¼å¨å±ä½ç¨åï¼ã</li>
<li><strong>æ«æå¨ç¶æï¼</strong> æéåå¨ <code>function</code> è¿ä¸ª token ä¸ã</li>
</ul>
<hr>
<p>ç¬¬ä¸é¶æ®µï¼é¡¹çº§åæµ</p>
<p><strong>1. ParseStatementListItem (é¡¹çº§å¥å£)</strong></p>
<ul>
<li>
<p><strong>å¨ä½ï¼</strong> è§£æå¨è¢«ä¸å±å¾ªç¯è°ç¨ï¼è¦æ±è§£æä¸ä¸é¡¹ã</p>
</li>
<li>
<p><strong>å·ç (Lookahead)ï¼</strong> å½å Token æ¯ <code>function</code>ã</p>
</li>
<li>
<p><strong>å¤æ­ï¼</strong> è¿æ¯ä¸ä¸ªå½æ°å£°æãå®å±äº <strong>Declaration (å£°æ)</strong>ï¼ä¸å±äº <strong>HoistableDeclaration (å¯æåå£°æ)</strong>ã</p>
</li>
<li>
<p><strong>ç©éï¼</strong> è¿æ´»å¿ä¸è½å½æ®éè¯­å¥å¤çï¼å¾èµ°âæåééâã</p>
<blockquote>
<p>å¨åé¢åå¤å¤æ¬¡æå°ï¼é¡¹çº§åæµä¸»è¦åä¸¤ç§ï¼ä¸æ¯è¯­å¥ï¼ä¸æ¯å£°æãå£°æåç±é¡¹çº§åæµèªå·±æ´¾å  æç§âä¸ç±»åå½ä¸¤åéâãæ­¤å¤æ¯æ®éå½æ°å£°æï¼è¢«é¡¹çº§ç²¾åæ´¾åå° <code>ParseHoistableDeclaration</code>ã</p>
</blockquote>
</li>
<li>
<p><strong>è°ç¨ï¼</strong> <code>ParseHoistableDeclaration</code>ã</p>
</li>
</ul>
<p><strong>2. ParseHoistableDeclaration (å¯æåå£°æè§£æ)</strong></p>
<ul>
<li><strong>å¨ä½ï¼</strong> ç¡®è®¤æ¯ <code>function</code>ã</li>
<li><strong>å·çï¼</strong> åé¢ä¸æ¯ <code>*</code> (Generator)ï¼æ²¡æ <code>async</code>ã</li>
<li><strong>å³å®ï¼</strong> è¿æ¯ä¸ä¸ªæ åçå½æ°å£°æã</li>
<li><strong>ç©éï¼</strong> è°ç¨ <code>ParseFunctionDeclaration</code>ã</li>
</ul>
<p><strong>3. ParseFunctionDeclaration (å½æ°å£°æè§£æ)</strong></p>
<ul>
<li><strong>æ¶è´¹ï¼</strong> åæ <code>function</code> å³é®å­ã</li>
<li><strong>è§£ææ è¯ç¬¦ï¼</strong> è¯»å° <code>add</code>ã</li>
<li><strong>å³é®å¨ä½ï¼ç»è®°åå­ï¼ï¼</strong> è§£æå¨ç«å»è½¬å¤´åè¯å½åç Global Scopeï¼âèå¨å¤´ï¼æè¦å¨ä½ è¿é<strong>é¢è®¢</strong>ä¸ä¸ªå« <code>add</code> çåå­ãâ
<ul>
<li><strong>Global Scope è®°å½ï¼</strong> <code>add</code> ---- <strong>ç»è®°ä¸ºå½æ°å£°æ</strong>ã</li>
<li><strong>æ³¨æï¼</strong> è½ç¶è§£æå¨ç°å¨åªè¯»å°äºåå­ï¼ä½å ä¸ºå®è®°å½çæ¯âå½æ°å£°æâï¼V8 ä¼å¨åç»­çç¼è¯/å®ä¾åé¶æ®µï¼ç¡®ä¿<strong>å¨ä»»ä½ä»£ç æ§è¡å</strong>ï¼è¿ä¸ªåå­å°±å·²ç»æåäºå®æ´çå½æ°ä½ãè¿å°±å®ç°äºæä»¬å¸¸è¯´çâå½æ°æ´ä½æåâã</li>
<li>æä»¥ï¼è½ç¶æ­¤æ¶åªæ¯å¨å°æ¬æ¬ä¸è®°äºä¸ªåå­ï¼å ä½ï¼ï¼çæ­£çå½æ°å¯¹è±¡åå»ºåç»å®è¦ç­å°åç»­é¶æ®µãä½å¯¹è§£æå¨æ¥è¯´ï¼åå­æäºï¼å°±å¯ä»¥ç»§ç»­å¾ä¸èµ°äºã</li>
</ul>
</li>
<li><strong>åå¤è¿å¥å®ä½ï¼</strong> åå­æå®åï¼å©ä¸ç <code>(x, y) { ... }</code> å±äºå½æ°å­é¢éé¨åã</li>
<li><strong>ç©éï¼</strong> è°ç¨ <code>ParseFunctionLiteral</code>ã
<ul>
<li>è¿ä¸ªå½æ°æ¯ä¸ªè§£æå½æ°å­é¢éçä¸»åãä¸æ­¢å£°æè¿éå¯ä»¥è°ç¨ï¼å¶ä»å°æ¹ä¹ç»å¸¸è°ç¨å®å»å¹²è¦åæ´»ã</li>
</ul>
</li>
</ul>
<hr>
<p>ç¬¬äºé¶æ®µï¼å½æ°ä½è§£æ</p>
<p>è¿éæ¯éç¹ï¼æ¯æå³é®çä¸æ­¥ï¼æä»¬ä»å¤é¨è·¨å¥äºåé¨ã</p>
<p><strong>4. ParseFunctionLiteral (å½æ°å­é¢éè§£æ)</strong></p>
<ul>
<li><strong>åå§åä¸ä¸æï¼</strong>
<ul>
<li><strong>åå»ºæ°ä½ç¨åï¼</strong> V8 åå»ºä¸ä¸ªæ°ç <strong>FunctionScope</strong>ãè¿éï¼å½æ°ä½ç¨åè¢«åå»ºäºã</li>
<li><strong>ç¶æéè¿æ¥ï¼</strong> æ° Scope ç <code>outer_scope</code> æå Global Scopeãè¿éï¼ä½ç¨åçå¤é¨è¿æ¥æéè¢«åå»ºäºï¼æåç¶ä½ç¨åãï¼è¿ä¸æ­¥å½¢æäºä½ç¨åé¾ï¼ä¸ºä»¥åçåéæ¥æ¾éºå¥½äºè·¯ï¼ã</li>
</ul>
</li>
<li><strong>å½åç¶æï¼</strong> è§£æå¨ç°å¨çâå½åä½ç¨åâåæ¢ä¸ºè¿ä¸ªæ°ç <code>FunctionScope</code>ï¼ç°å¨å·²ç»å¨é¨è¿å¥å½æ°åé¨å¼å§å¹²æ´»äºã</li>
<li><strong>æ¶è´¹ï¼</strong> åæ <code>(</code>ã</li>
</ul>
<p><strong>5. ParseFormalParameters (è§£æåæ°)</strong></p>
<ul>
<li><strong>å¾ªç¯è¯»åå½æ°åæ°ï¼</strong>
<ul>
<li>è¯»å° <code>x</code>ï¼å¨ FunctionScope ç»è®°åæ° <code>x</code>ã</li>
<li>è¯»å° <code>,</code>ï¼è·³è¿ã</li>
<li>è¯»å° <code>y</code>ï¼å¨ FunctionScope ç»è®°åæ° <code>y</code>ã</li>
</ul>
</li>
<li><strong>æ¶è´¹ï¼</strong> åæ <code>)</code>ã</li>
<li><strong>AST èç¹ï¼</strong> æ­¤æ¶ï¼åæ°åè¡¨ç AST èç¹å·²å®æã</li>
</ul>
<p><strong>6. ParseFunctionBody (è§£æå½æ°ä½)</strong></p>
<ul>
<li><strong>æ¶è´¹ï¼</strong> åæ <code>{</code>ã</li>
<li><strong>å¨ä½ï¼</strong> ç°å¨è¿å¥äºå½æ°ä½åé¨ãè¿éæ¬è´¨ä¸æ¯ä¸ä¸ªè¯­å¥åè¡¨ (Statement List)ã</li>
<li><strong>å¼å§å¾ªç¯ï¼</strong> è°ç¨ <code>ParseStatementList</code>ã
<ul>
<li>è¿éå°±ç¸å½äºå¼å¯äºä¸ä¸ªå°ä¸çã</li>
</ul>
</li>
</ul>
<hr>
<p>ç¬¬ä¸é¶æ®µï¼ä½åçå¾ªç¯</p>
<p>ç°å¨ï¼æä»¬å¨ <code>add</code> å½æ°çåé¨ï¼å¼å§å¾ªç¯å¤çæ¯ä¸è¡ä»£ç ã</p>
<p><strong>====== ç¬¬ä¸è¡ä»£ç ï¼<code>let result = x + y;</code> ======</strong></p>
<p><strong>7. ParseStatementListItem (åæ¬¡åå°é¡¹çº§å¥å£)</strong></p>
<ul>
<li>
<p><code>ParseStatementList</code> å¼å¯ä»¥åï¼ç©éç»é¡¹çº§å¥å£ï¼è¿è¡åæµã</p>
</li>
<li>
<p><strong>å·çï¼</strong> Token æ¯ <code>let</code>ã</p>
</li>
<li>
<p><strong>å¤æ­ï¼</strong> è¿æ¯ä¸ª <strong>LexicalDeclaration (è¯æ³å£°æ)</strong>ã</p>
</li>
<li>
<p><strong>ç©éï¼</strong> è°ç¨ <code>ParseVariableStatement</code>ã</p>
<blockquote>
<p>é¡¹çº§åæµï¼ä¸æ¯è¯­å¥ï¼äºæ¯å£°æã<code>let</code> æ¯åéå£°æï¼å¨æ­¤å¤è¢«é¡¹çº§ç´æ¥æ´¾åå° <code>ParseVariableStatement</code>ãå¯å¯å¯ï¼åå¤çéå¤ï¼å æ·±èåå°è±¡ã</p>
</blockquote>
</li>
</ul>
<p><strong>8. ParseVariableStatement (åéå£°æè§£æ)</strong></p>
<ul>
<li><strong>æ¶è´¹ï¼</strong> åæ <code>let</code>ã</li>
<li><strong>è§£ææ è¯ç¬¦ï¼</strong> è¯»å° <code>result</code>ã</li>
<li><strong>ä½ç¨åæä½ï¼</strong>
<ul>
<li>é®èªå·±ï¼å½å FunctionScope æ <code>result</code> åï¼ï¼æ²¡æï¼ã</li>
<li><strong>å¨ä½ï¼</strong> å¨ FunctionScope ä¸­ç»è®° <code>result</code>ã</li>
<li><strong>æ è®°ï¼</strong> ææ¶æ è®°ä¸º <strong>âæ å±é¨åéäºº (Stack Local Candidate)â</strong>ã
<ul>
<li>ä¸ºä»ä¹æ¯åéï¼å ä¸ºç°å¨è¿ä¸ç¥éææ²¡æé­åè¿ä¸ªèç»å¨åé¢ç­çæè·å®ãåæâä½æ âå¤çï¼ç­æåç®æ»è´¦æ¶åå³å®ã</li>
</ul>
</li>
</ul>
</li>
<li><strong>å·çï¼</strong> åé¢æ¯ <code>=</code>ï¼è¿è¡¨ç¤ºæåå§å¼ï¼éè¦è§£æèµå¼è¡¨è¾¾å¼ã</li>
</ul>
<p><strong>9. ParseAssignmentExpression (èµå¼è§£æ)</strong></p>
<ul>
<li>ç¼çå§ï¼ä¿ºè¡¨è¾¾å¼è§£æååæ¥äºãçæçæèä¹åæ¥äºã</li>
<li><strong>å·¦æï¼</strong> æ¿å° <code>result</code> çåéä»£çèç¹ã</li>
<li><strong>æ¶è´¹ï¼</strong> åæ <code>=</code>ã</li>
<li><strong>å³æï¼éå½ï¼ï¼</strong> è§£æ <code>x + y</code>ã
<ul>
<li><strong>ParseBinaryExpression (+å·)ï¼</strong>
<ul>
<li>è¯»å° <code>x</code>  <strong>Resolve</strong>ï¼å¨å½å Scope æ¾å°åæ° <code>x</code>ï¼çæå¼ç¨èç¹ã</li>
<li>åæ <code>+</code>ã</li>
<li>è¯»å° <code>y</code>  <strong>Resolve</strong>ï¼å¨å½å Scope æ¾å°åæ° <code>y</code>ï¼çæå¼ç¨èç¹ã</li>
<li><strong>ç»è£ï¼</strong> çæ <code>BinaryOperation(+, x, y)</code> èç¹ã</li>
</ul>
</li>
<li>è¿éçè¯»å°åéçæ¶åï¼é¦åå¨å½åçä½ç¨åæ¾ï¼æ¾ä¸å°å°±éè¿æåç¶ä½ç¨åçæéï¼å°ä¸å±ä½ç¨åéæ¾ã</li>
</ul>
</li>
<li><strong>ç»æç»è£ï¼</strong>
<ul>
<li>çæ <code>Assignment</code> èç¹ï¼<code>result = (x + y)</code>ã</li>
</ul>
</li>
<li><strong>AST æè½½ï¼</strong> è¿ä¸ª Assignment èç¹è¢« push å°å½æ°ä½ç statements åè¡¨ä¸­ã</li>
<li><strong>æ¶è´¹ï¼</strong> åæ <code>;</code>ã</li>
</ul>
<p><strong>====== ç¬¬äºè¡ä»£ç ï¼<code>return result;</code> ======</strong></p>
<p><strong>10. ParseStatementListItem</strong></p>
<ul>
<li>
<p><strong>å·çï¼</strong> Token æ¯ <code>return</code>ã</p>
</li>
<li>
<p><strong>å¤æ­ï¼</strong> è¿æ¯ä¸ª <code>ReturnStatement</code>ã</p>
</li>
<li>
<p><strong>ç©éï¼</strong> è°ç¨ <code>ParseReturnStatement</code>ã</p>
<blockquote>
<p>é¡¹çº§åæµï¼è¿éæ¯è¯­å¥ï¼è¢«ç©éç»è¯­å¥è§£æå½æ°ï¼ç¶åæ ¹æ®å³é®å­ï¼è¢«ç©éç» <code>ParseReturnStatement</code>ãè¿ç¨è¿è®°å¾å§ï¼åå¦å³é®å­å¹éä¸å°ï¼å°±ç©ç»ååºçè¡¨è¾¾å¼è§£æãç»§ç»­éå¤ä¸ä¸ï¼å æ·±å°è±¡ã</p>
</blockquote>
</li>
</ul>
<p><strong>11. ParseReturnStatement (è¿åè¯­å¥è§£æ)</strong></p>
<ul>
<li><strong>æ¶è´¹ï¼</strong> åæ <code>return</code>ã</li>
<li><strong>å·çï¼</strong> åé¢ä¸æ¯ <code>;</code>ï¼è¯´ææè¿åå¼ã</li>
<li><strong>ç©éè¡¨è¾¾å¼ï¼</strong> è°ç¨ <code>ParseExpression</code> è§£æ <code>result</code>ã
<ul>
<li>åç©ç»è¡¨è¾¾å¼è§£æäºï¼ç»§ç»­é£ä¸å¥è¿ç¨ããã</li>
</ul>
</li>
<li><strong>åéçè§£å³ï¼</strong>
<ul>
<li>è¯»å° <code>result</code>ã</li>
<li><strong>æ¥æ¾ï¼</strong> å¨å½å FunctionScope æ¾å°äºååç»è®°ç <code>result</code>ã</li>
<li><strong>çæï¼</strong> <code>VariableProxy(result)</code> èç¹ã</li>
</ul>
</li>
<li><strong>ç»è£ï¼</strong> çæ <code>ReturnStatement(result)</code> èç¹ã</li>
<li><strong>AST æè½½ï¼</strong> æå°å½æ°ä½åè¡¨ä¸­ã</li>
<li><strong>æ¶è´¹ï¼</strong> åæ <code>;</code>ã</li>
</ul>
<hr>
<p>ç¬¬åé¶æ®µï¼æ¶å·¥é¶æ®µ</p>
<p><strong>12. ParseStatementListItem (å¾ªç¯ç»§ç»­)</strong></p>
<ul>
<li><strong>å·çï¼</strong> Token æ¯ <code>}</code>ã</li>
<li><strong>å¤æ­ï¼</strong> åè¡¨ç»æäºã</li>
<li><strong>è¿åï¼</strong> éåº <code>ParseStatementList</code>ã</li>
</ul>
<p><strong>13. éåºå½æ°ä½ä¸ä½ç¨åè®¡ç® (Scope Finalization)</strong></p>
<ul>
<li>
<p><strong>æ¶è´¹ï¼</strong> åæ <code>}</code>ã</p>
</li>
<li>
<p>ä½ç¨åæ¶å°¾ (Scope Finalization) ââ ç®æ»è´¦æ¶å»ï¼</p>
<p>ç°å¨ä»£ç è§£æå®äºï¼è¦ç¦»å¼ FunctionScope äºãä½æ¯è¿å¿é¡»åä¸æ¬¡æç»çç¹ã</p>
<ul>
<li>
<p><strong>æ£æ¥ææ âåé¨å½æ°âï¼</strong> çè¿ä¸ª <code>add</code> å½æ°éï¼ææ²¡æå®ä¹å¶ä»çå­å½æ°ã</p>
<ul>
<li><code>add</code> æ¯ä¸ªåæå¸ä»¤ï¼èå­éæ²¡æå­å½æ°ã</li>
</ul>
</li>
<li>
<p><strong>å³å®åéå½è¿ï¼</strong> éä¸ªæ£æ¥ <code>x</code>, <code>y</code>, <code>result</code>ã</p>
<ul>
<li>å¦ææå­å½æ°å¼ç¨äºå®ä»¬ï¼å®ä»¬å°±å¾âè¢«è¿«æ¬å®¶âï¼è¢«æ¾è¿ <strong>å åå­ (Context)</strong> éï¼ä¾å­å½æ°éæ¶è®¿é®ã</li>
<li>ä½å¨è¿éï¼å ä¸ºæ²¡æå­å½æ°å¼ç¨ï¼<strong>è¿å ä¸ªåéé½æ¯æ¸ç½ç</strong>ï¼æ²¡æè¢«æè·ï¼ã</li>
</ul>
</li>
<li>
<p><strong>è®¡ç®æ å¸§ï¼</strong> æ¢ç¶é½ä¸ç¨è¿å ï¼é£å°±å¨é¨å®æå¨ <strong>æ  (Stack)</strong> ä¸ãè§£æå¨è®¡ç®åºï¼è¿è¡è¿ä¸ªå½æ°åªéè¦ç³è¯·å ä¸ªæ ä¸æ§½ä½å°±å¯ä»¥äºã</p>
<blockquote>
<p>æ åéæå¶å»ä»·ï¼å½æ°æ§è¡å®ï¼æ æéä¸å¼¹ï¼åå­ç¬é´åæ¶ãæ¯è¿å ï¼Contextï¼å¿«å¾å¤ã</p>
</blockquote>
</li>
<li>
<p><strong>æç»ç»æï¼</strong> è¿ä¸ªä½ç¨åè¢«æ è®°ä¸ºâä¸éè¦ Contextâã</p>
</li>
</ul>
</li>
<li>
<p><strong>AST ç»ææåï¼</strong></p>
<ul>
<li>åå»ºä¸ä¸ªå·¨å¤§ç <strong>FunctionLiteral</strong> èç¹ã</li>
<li>æ <code>Name: add</code> æä¸å»ã</li>
<li>æ <code>Scope: FunctionScope</code> æä¸å»ã</li>
<li>æ <code>Body: [AssignmentNode, ReturnNode]</code> æä¸å»ã</li>
<li>æ <code>Length: 2</code> (åæ°ä¸ªæ°) æä¸å»ã</li>
</ul>
</li>
</ul>
<p><strong>14. æ­¤æ¶çäº§ç©ä¸æç»åè£</strong></p>
<ul>
<li><strong>è¿åï¼</strong> <code>ParseFunctionLiteral</code> ä»»å¡å®æï¼æéæ§çååºçç <code>FunctionLiteral</code> èç¹ï¼å«ä»£ç ä½ + ä½ç¨åï¼ï¼è¿åç»ä¸ä¸å±ç <code>ParseFunctionDeclaration</code>ã</li>
<li><strong>å³é®æå (The Packaging)ï¼</strong> <code>ParseFunctionDeclaration</code> æ¥è¿è¿ä¸ª Literal èç¹ï¼æå®åä¹åè§£æå¥½çåå­ <code>add</code> (VariableProxy) ç»å¨ä¸èµ·ã</li>
<li><strong>å¬å¤å·¥åï¼</strong> è°ç¨å·¥åæ¹æ³ï¼çæä¸ä¸ªæ´å¤§ç <strong>FunctionDeclaration</strong> èç¹ã
<ul>
<li>å·¦æï¼åå­ <code>add</code>ã</li>
<li>å³æï¼å®ä½ <code>FunctionLiteral</code>ã</li>
</ul>
</li>
<li><strong>æç»æè½½ï¼</strong> è¿ä¸ª <code>FunctionDeclaration</code> èç¹ï¼èä¸æ¯è£¸é²ç Literalï¼ï¼è¢« push å° Global AST ç body åè¡¨ä¸­ã</li>
</ul>
<p>å¨ååååé¢ï¼æä»¬æå°è¿åéä»£ççè¯´æ³ï¼åé¢æä»¬åæå°äºåéä»£çèç¹ã é£ä¹è¿ä¸ªåéä»£çå°åºæ¯ä¸ªä»ä¹ä¸ä¸å¢ï¼è¿ä¸ªæ¦å¿µæ¯è¾éè¦ï¼éè¦ç¨å¾®è®²ä¸ä¸ã</p>
<p><strong>å£°æ (Declaration)ï¼</strong> <code>var a = 1;</code> è¿æ¯å¨<strong>é åé</strong>ãå¼æå¨ä½ç¨åéå®æå®å°ç»è®°äºä¸ä¸ªå« <code>a</code> çä¸è¥¿ã</p>
<p><strong>ä»£ç (Proxy)ï¼</strong> <code>console.log(a);</code> è¿æ¯å¨<strong>ç¨åé</strong>ã</p>
<p>è§£æå¨è¯»å°è¿éç <code>a</code> æ¶ï¼å®å¿éæ¯æ²¡åºæ°çï¼âæè¦ç¨ä¸ä¸ªå« <code>a</code> çä¸ä¸ï¼ä½æç°å¨æå¤´æ²¡æå®çè¯¦ç»æ¡£æ¡ï¼ä¸ç¥éå®æ¯å¨æ ä¸ãå ä¸ï¼è¿æ¯å¨å±éï¼ãä¸ç®¡äºï¼æåå¼ä¸å¼ âæè¦æ¾ aâç<strong>å°ç¥¨</strong>æ¾å¨è¿å¿ãâ</p>
<p>è¿å¼ âå°ç¥¨âï¼å¨ AST éå°±æ¯ <strong>VariableProxy</strong>ã</p>
<p>é£ä¹ææåå°±ä¼è¯´äºï¼è¯»å° <code>a</code> çæ¶åï¼ç´æ¥å»æ¥ä¸ä¸ä¸å°±è¡äºåï¼ä¸ºä»ä¹è¿è¦è¿ä¹éº»ç¦æä¸ªä»£çï¼</p>
<p>åå ä¸»è¦æä¸¤ä¸ªï¼</p>
<ol>
<li><strong>æ¯å ä¸º JS åè®¸å¨åéå®ä¹åä½¿ç¨å®</strong>ï¼æ¯å¦å½æ°æåã<code>var</code> æåãå½å®è¯»å°ä¸ä¸ªä¸ç¡®å®çåéæ¶ï¼ä¸è½æ¥éä¹ä¸è½ç«å»ç»å®ï¼æä»¥å®åªè½åçæä¸ä¸ª <code>VariableProxy(a)</code> æ¾å¨ AST éé¢ï¼è¡¨æè¿éæä¸ª <code>a</code> çåï¼ç­å¨é¨è§£æå®äºï¼æå¾è¿æ¥å¡«åã</li>
<li><strong>æ¯å ä¸ºè§£æçé¡ºåºéå¶</strong>ï¼è§£æå¨æ¯ä»ä¸å¾ä¸è¯»çãä¸¾ä¸ªæç®åçä¾å­ï¼<code>console.log(a); var a = 1;</code>ãå½è§£æå¨è¯»å°ç¬¬ä¸è¡ <code>console.log(a)</code> æ¶ï¼å¦æä½ éè¦å®ç«å»ãé©¬ä¸å°±æ <code>a</code> æ¾åºæ¥ï¼å®å»åªéæ¾ï¼å®å¯è½ä¼å»å¤å±æ¾ï¼ç»ææ¾éäºäººãå ä¸ºå®è¿æ²¡è¯»å°ç¬¬äºè¡ï¼æ ¹æ¬ä¸ç¥éä½ å¨åé¢å·å·èäºä¸ªå±é¨åé <code>a</code>ãæä»¥ï¼è§£æå¨å¿é¡»<strong>åå¿ä¸æ</strong>ãå®å¿é¡»åæå½åå½æ°éçä»£ç å¨é½æ«å®ï¼æè¯¥ç»è®°çåéé½ç»è®°å¨åï¼Scopeæå»ºå®æï¼ï¼ç¶ååå¤´ç®æ»è´¦æ¶ï¼æè½åç¡®å°ç¥éï¼å¦ï¼åæ¥è¿ä¸ª <code>a</code> æçæ¯ç¬¬äºè¡å£°æçé£ä¸ªåå¼ï¼èä¸æ¯å¤é¢çéå£èçã</li>
</ol>
<p><strong>æä»¥ï¼å ä¸ºä¸é¢è¿ä¸¤ä¸ªåå ï¼å°±åçæä»£çï¼ç­ AST é å¥½äºï¼æèè¿å¥ä½ç¨ååæçé¶æ®µï¼åç»ä¸å¤çè¿äºä»£ççåã</strong></p>
<p>æä»¬ç¨ä¸ä¸ªå°ä¾å­æ¥æ¼ç¤ºï¼</p>
<p>JavaScript</p>
<pre><code>function order() {
  return dish;     // A: ä½¿ç¨ dish
}
var dish = 'å¨é»é¸­'; // B: å®ä¹ dish
</code></pre>
<p><strong>ç¬¬ä¸æ­¥ï¼çæä»£ç</strong> è§£æå¨è§£æ <code>order</code> å½æ°åé¨ï¼</p>
<ol>
<li>è¯»å° <code>return</code>ã</li>
<li>è¯»å° <code>dish</code>ã âè¿æ¯ä¸ªåéåãä½æç°å¨åªè´è´£é æ ï¼ä¸ç¥é <code>dish</code> æ¯è°ãâ</li>
<li><strong>å¨ä½</strong>ï¼åå»ºä¸ä¸ª <code>VariableProxy</code> èç¹ã
<ul>
<li>åå­: "dish"</li>
<li>ç¶æ: Unresolved (æªè§£å³/æªæ¾å°)</li>
</ul>
</li>
<li>æè¿ä¸ªèç¹æå¨ <code>ReturnStatement</code> ä¸é¢ã</li>
</ol>
<p><strong>æ­¤æ¶ AST çç¶æï¼</strong> <code>ReturnStatement</code> - <code>VariableProxy("dish")</code> <em>(æéæ¿è¿ä¸ªåªæåå­çå°ç¥¨ï¼ä¸ç¥éå»åªé¢è)</em></p>
<p><strong>ç¬¬äºæ­¥ï¼åéè§£å³ (Variable Resolution) ââ åæ¢</strong> è¿ä¸æ­¥éå¸¸åçå¨åé¢è®²è§£ä¾å­çæ¶åçç¬¬13æ­¥ï¼ <strong>Scope Finalizationï¼ä½ç¨åæ¶å°¾/ç®æ»è´¦ï¼</strong> é¶æ®µï¼ä¹æå¯è½æ¯åç»­çç¼è¯é¶æ®µã</p>
<p>V8 å¼å§æ¿çè¿å¼ å°ç¥¨ï¼Proxyï¼å»åæ¢ï¼</p>
<ol>
<li><strong>é®å½åä½ç¨å (FunctionScope)</strong>ï¼âä½ è¿éæ <code>dish</code> çå£°æåï¼â
<ul>
<li>åç­ï¼æ²¡æã</li>
</ul>
</li>
<li><strong>é®ç¶ä½ç¨å (Script/Global Scope)</strong>ï¼âä½ è¿éæ <code>dish</code> çå£°æåï¼â
<ul>
<li>åç­ï¼æï¼æè¿éæä¸ª <code>var dish</code>ã</li>
</ul>
</li>
</ol>
<p><strong>é¾æ¥ (Bind)ï¼</strong> V8 å°±ä¼æè¿ä¸ª <code>VariableProxy</code> èç¹ï¼åä¸ä¸ªå·ä½ç <code>VariableDeclaration</code>ï¼æèå·ä½çæ¡£æ¡ä¿¡æ¯ï¼è¿ä¸çº¢çº¿ã</p>
<p><strong>æ­¤æ¶çç¶æï¼</strong> <code>VariableProxy</code> ä¸åæ¯ä¸å¼ ç©ºå¤´å°ç¥¨ï¼å®åæäºä¸ä¸ªæéï¼æç¡®æåäºå¤é¨ä½ç¨åçé£ä¸ª <code>dish</code>ã</p>
<p>âä»£çâè¿ä¸ªè¯çæææ¯ <strong>âä»£è¡¨æäººè¡äºâ</strong>ã å¨ AST ä¸­ï¼è¿ä¸ªèç¹ææ¶ä»£è¡¨äºé£ä¸ªçå®çåéãå¨çæ­£çè¿æ¥å»ºç«ä¹åï¼å®å°±æ¯é£ä¸ªåéç<strong>é­é¬¼ä»£è¨äºº</strong>ãä¸æ¦è¿æ¥å»ºç«ï¼æä½è¿ä¸ª Proxyï¼å®éä¸å°±æ¯å¨æä½é£ä¸ªçå®çåé<strong>æ¡£æ¡ï¼æèè¯´é»è¾å°åï¼</strong>ï¼å ä¸ºæ­¤æ¶è¿å¨éæè§£æé¶æ®µã</p>
<p><strong>å¯å¯å¯ãããè¯å®åææåä¼é®äºï¼é£é¾æ¥ç»å®ä»¥åï¼æ¯ä»ä¹æ ·å­çï¼</strong></p>
<p>æ ·å­å°±æ¯ï¼ä»æ­¤ä»¥åï¼V8 å°±ä¸ä¼åå³å¿å®å«ä»ä¹åå­ï¼åå­åªæ¯ç»äººççï¼ï¼åªå³å¿å®ä½å¨åªéãå®ä¼è¢«æ è®°ä¸ºä»¥ä¸ä¸ç§âä½åâä¹ä¸ï¼</p>
<ul>
<li><strong>ä½å Aï¼æ  (Stack / Local)</strong>
<ul>
<li><strong>å«ä¹</strong>ï¼è¿æ¯ä¸ªæ®éå±é¨åéï¼æ²¡è¢«é­åæè·ã</li>
<li><strong>ç»æ</strong>ï¼Proxy æ¿å°ä¸ä¸ª <strong>å¯å­å¨ç´¢å¼ (Register Index)</strong>ã</li>
<li><strong>è¡¨ç¤º</strong>ï¼âè¿å°å­å°±å¨éå£æ¿é´ï¼å¯å­å¨ r0, r1...ï¼ï¼ä¼¸æå°±è½æ¿ï¼éåº¦æå¿«ï¼â</li>
</ul>
</li>
<li><strong>ä½å Bï¼ä¸ä¸æ (Context / Heap)</strong>
<ul>
<li><strong>å«ä¹</strong>ï¼è¿æ¯ä¸ªè¢«é­åæè·çåéï¼æè <code>with</code> (withå·²ç»è¢«å¼ºçå»ºè®®ä¸è¦ä½¿ç¨äº)éçåéã</li>
<li><strong>ç»æ</strong>ï¼Proxy æ¿å°ä¸ä¸ª <strong>ä¸ä¸ææ§½ä½ç´¢å¼ (Context Slot Index)</strong>ã</li>
<li><strong>è¡¨ç¤º</strong>ï¼âè¿å°å­æ¬å®¶äºï¼ä½å¨å åå­ç Context è±ªåå¤§å«ééãè®¿é®å®å¾åæ¿å° Context æéï¼åæ ¹æ®åç§»éï¼æ¯å¦ç¬¬ 3 ä¸ªæ ¼å­ï¼å»æ¾ãâ</li>
</ul>
</li>
<li><strong>ä½å Cï¼å¨å± (Global)</strong>
<ul>
<li><strong>å«ä¹</strong>ï¼è¿æ¯ä¸ªå¨å±å¯¹è±¡ï¼window/globalï¼ä¸çå±æ§ã</li>
<li><strong>ç»æ</strong>ï¼Proxy è¢«æ è®°ä¸º <strong>å¨å±è®¿é®</strong>ã</li>
<li><strong>è¡¨ç¤º</strong>ï¼âè¿æ¯å¤§èæ¿ï¼å¾å»æ¥å¨å±å­å¸ãâ</li>
</ul>
</li>
</ul>
<p>ä¸é¢æä¸ªéè®²äºä¸ä¸åéä»£ççæ¦å¿µï¼å¨æä»¬ç»§ç»­å­¦ä¹ å£°æçè§£æä¹åï¼æä»¬åæä¸ªéï¼è®²ä¸ä¸ <strong>ä½ç¨å</strong>ã</p>
<p>è½çå°è¿éçæåï¼ä¼°è®¡å¯¹ä½ç¨åé½äºè§£ãä½æ¯ï¼ä¸è®²ä½ç¨ååè®²å£°æï¼å°±ååé¥ºå­ä¸è¸éï¼æµèº«ä¸å¾å²ã</p>
<p>åé¢è®²åéä»£ççæ¶åï¼é£å¼ å¯»æ¾åé <code>a</code> çâå°ç¥¨â (Proxy)ï¼ç°å¨è¦æ¿çå®å»åæ¢äºãå»åªéåæ¢å¢ï¼å°±æ¯å» <strong>ä½ç¨å</strong>ã</p>
<p>æäºæç¨ä¸è¯´âä½ç¨åæ¯åéçå¯è®¿é®èå´âï¼è¿è¯æ¯æ²¡éï¼ä½è¿ä»ä»æ¯ä»åéçè§åº¦æ¥è¯´ï¼å¹¶æ²¡æä»ä½ç¨åæ¬èº«çè§è§æ¥è®²ã</p>
<p><strong>ä½ç¨åæ¯ä¸å¥è¯­æ³è§åï¼å®å°±æ¯âå°çâãå®ä¸åè§å®äºè°å¨å°çéï¼è¿è§å®äºè¿æ¯è°çå°çã</strong></p>
<p><strong>è¯æ³ä½ç¨å (Lexical Scope)</strong>ï¼</p>
<p>è¿å¥è¯ç¿»è¯è¿æ¥å°±æ¯ï¼<strong>âåºèº«å³å®å½è¿â</strong>ã ä¸ä¸ªåéçä½ç¨åï¼å¨ä½ <strong>åä»£ç </strong>çé£ä¸å»ï¼å°±ç±å®å¨æºä»£ç éç<strong>ç©çä½ç½®</strong>å³å®äºã å®çç¹ç¹å°±æ¯ <strong>éæ</strong>ï¼åäºå°±å³å®äºï¼åå®å°±éæ­»ãä»¥åä¸ç®¡æä¹è°ç¨ãå¨åªå¿è°ç¨ãæä¹è°ç¨ï¼ä½ç¨åæ°¸è¿ä¸åã</p>
<p><strong>ä½ç¨åå°±æ¯ä¸å¼ å¨ç¼è¯é¶æ®µå°±ç»å¥½çéæå°å¾ã</strong></p>
<p>è½åå°ççï¼æåªäºå¤§ä½¬å¢ï¼</p>
<ul>
<li><strong>å¨å± (Global)</strong>ï¼æå¤§çå°ä¸»ï¼æ®å¤©ä¹ä¸è«éçåã</li>
<li><strong>æ¨¡å (Module)</strong>ï¼æ¯ä¸ªæä»¶ä¸ä¸ªç¬ç«å°çï¼èªå¸¦é²çé¨ï¼äºä¸å¹²æ°ã</li>
<li><strong>å½æ° (Function)</strong>ï¼è¿æ¯æèççå°ä¸»ãæ¯åä¸ä¸ª <code>function</code>ï¼å°±åäºä¸åå°ãå½æ°éç <code>var</code>ã<code>let</code>ãåæ°ï¼é½å½å®ç®¡ã</li>
<li><strong>å (Block)</strong>ï¼è¿æ¯ ES6 æ°æçå°å°ä¸»ãå¡æ¯ <code>{ ... }</code> åèµ·æ¥çï¼æ¯å¦ <code>if</code>ã<code>for</code> æèç´æ¥åçå¤§æ¬å·ï¼ï¼å¨è¯­æ³ä¸é½ç®ä½âåâã</li>
</ul>
<p><strong>ä½æ¯ï¼V8 å¨åçº§ä½ç¨åè¿éæ¯éå¸¸ç°å®çã</strong></p>
<p>å¦æå¤§æ¬å·éæ²¡æ <code>let</code> æ <code>const</code>ï¼V8 è§å¾ä¸é¨ä¸ºä½ å»ºä¸ä¸ª Scope å¯¹è±¡å¤ªæµªè´¹åå­äºï¼æ ¹æ¬æå¾æ­çä½ ãæ­¤æ¶ï¼å®å¨ V8 ç¼éå®éä¸å¹¶ä¸ææç¬ç«ä½ç¨åï¼åéæ¥æ¾ç´æ¥èµ°å¤å±ã</p>
<p>åªæå½å¤§æ¬å·éåºç°äº <code>let</code> æ <code>const</code> è¿ç§æ°è´µå°çå­æ¶ï¼V8 æä¼ççç»å®åâæ¿äº§è¯âï¼ä¸é¨åå»ºä¸ä¸ªç±å¤§æ¬å·ä¸ºæ å¿çåçº§ä½ç¨å <code>BlockScope</code>ã</p>
<p><strong>æ³¨æ var</strong>ï¼è³äº <code>var</code>ï¼å®æ¯è¾ç¹æ®ãå®çä¸ä¸åçº§è¿ç§å°å°çï¼è¿ç§å¤§æ¬å·æ ¹æ¬å³ä¸ä½å®ãå®ä¼ç´æ¥<strong>ç©¿å¢</strong>åºå»ï¼å»æ¾å¤é¢çå½æ°å°ä¸»æèå¨å±å°ä¸»ã</p>
<p><strong>é£ä¹ï¼åéææ²¡æä½ç¨åå¢ï¼</strong></p>
<p>åç¡®å°è¯´ï¼<strong>åéæ¬èº«å¹¶ä¸è½æ¥æä½ç¨åï¼ä½æ¯åéå±äºæä¸ªä½ç¨åã</strong></p>
<p>æä»¬è¯´ <code>a</code> çä½ç¨åæ¯å½æ° <code>f</code>ï¼å®éæ¯å¨è¯´ï¼åé <code>a</code> å¤å¨å½æ° <code>f</code> çä½ç¨åéã</p>
<p>å¨ V8 åé¨ï¼æ¯ä¸ªä½ç¨åé½æä¸ä¸ªæ¸åï¼ä¸é¢è¯¦ç»è®°å½äºï¼</p>
<p>âæè¿åå°çä¸ï¼ä½äºå¼ ä¸ãæåãè¿æèç...â</p>
<p>å¦æè§£æå¨å¨è¿ä¸å±æ²¡æ¾å°äººï¼è¯´æè¿ä¸ªäººä¸ä½è¿å¿ï¼å°±ä¼æ²¿ <strong>ä½ç¨åé¾</strong> å»å¾ä¸æ¾ã</p>
<p>é£ä¹   é®é¢æ¥äºï¼</p>
<p><strong>ä½ç¨åé¾æ¯æä¹å½¢æçå¢ï¼</strong></p>
<p>å½ä¸ä¸ªæ°çä½ç¨åè¢«åå»ºåºæ¥çæ¶åï¼æ°çä½ç¨åéé½æä¸ä¸ª <code>outer</code> æéï¼æ´å¨ç¶çº§ä½ç¨åä¸ã</p>
<p>å­å½æ°çä½ç¨åéï¼ä¹æä¸ª <code>outer</code> æéæ´çå¤é¨å½æ°çä½ç¨åï¼</p>
<p>å¤é¨å½æ°çä½ç¨åéï¼ä¹æä¸ª <code>outer</code> æéæ´çå¨å±çä½ç¨åï¼<strong>è¿å°±å½¢æäºä¸æ ¹é¾æ¡</strong>ã</p>
<p><strong>è¯å®ææåä¼æçé®äºï¼</strong></p>
<p>âä»ä¹ä½ç¨åé¾ï¼ä¸å°±æ¯å­å½æ°æåç¶å½æ°åï¼å¹³æ¶å±åä»£ç ï¼å½æ°åµå¥ä¸ªä¸¤ä¸å±ä¹å°±é¡¶å¤©äºï¼è¿ä¹ç­ä¸ç¹ï¼ä¹å¥½ææå«âé¾âï¼</p>
<p>è¿éæä¸¤ç¹ï¼</p>
<p><strong>ç¬¬ä¸ï¼è¿æ¯ç±æ°æ®çç»ç»å½¢å¼å³å®çã</strong> åªè¦æ¯éè¿æéä¸ä¸ªè¿ä¸ä¸ªçæ°æ®ç»æï¼é½å« <strong>é¾è¡¨</strong>ãè¿è·å®é¿ç­æ²¡å³ç³»ï¼åªè¦æ¯è¿ç§ç»æï¼5åç±³æ¯é¾è¡¨ï¼25åç±³ä¹æ¯é¾è¡¨ï¼ç¹æå®è¿ç§âé¡ºè¤æ¸çâçè¿æ¥æ¹å¼ãå®ä¸æ¯æ°ç»ï¼ä¸è½éè¿ä¸æ ç´æ¥è®¿é®ï¼ä¹ä¸æ¯æ æå¾ãåªæå®åªæä¸¤å±ï¼åªè¦æ¯é æéæè¿å»çï¼å®å°±æ¯é¾è¡¨ç»æã</p>
<p><strong>ç¬¬äºï¼å®æ¯åå­éå®å®å¨å¨çç©çé¾æ¡ã</strong> ä¸å®è¦åæ¸<strong>è§£æåæ§è¡</strong>ãç°å¨æä»¬æ¯å¨è§£æé¶æ®µï¼è¿æ ¹é¾æ¡å¨å¾çº¸ä¸ï¼æ¯èå¾ãç­å°åç»­ä»£ç çæ­£<strong>æ§è¡</strong>çæ¶åï¼å¨å åå­éï¼ççä¼åå»ºåºä¸ä¸²ä¸²ç <code>Context</code> å¯¹è±¡ï¼å®ä»¬ä¹é´ççæ¯éè¿ç©çæéè¿æ¥èµ·æ¥çã æä»¥ï¼å®ä¸åæ¯é»è¾ä¸çé¾ï¼æ´æ¯ç©çä¸çé¾ã</p>
<p><strong>æ³è±¡ä¸ä¸æ¥æ¾è¿ç¨ï¼</strong> å½è¦æ¥æ¾ä¸ä¸ªåéæ¶ï¼</p>
<ol>
<li><strong>åçèªå·±å®¶</strong>ï¼å½åä½ç¨åæåï¼æ¨æã</li>
<li><strong>é¡ºçç»³å­æ¾ç¸ç¸</strong>ï¼ç¶çº§ä½ç¨åæåï¼æ¨æã</li>
<li><strong>ä¸å±å±å¾ä¸</strong>ï¼ç´å°æ¾å°å¨å±ä½ç¨åã
<ul>
<li><strong>æ¾å°äº</strong>ï¼çå¤§æ¬¢åã</li>
<li><strong>å°é¡¶äºè¿æ²¡æ¾å°</strong>ï¼
<ul>
<li>å¦ææ¯èµå¼ <code>a=1</code> ä¸ä¸æ¯ä¸¥æ ¼æ¨¡å¼ï¼é£å°±å¨å¨å±ç»ä½ é ä¸ä¸ªã</li>
<li>å¦ææ¯åå¼ <code>b=a</code>ï¼ååï¼æ¾å°å¨å±é½æ²¡æï¼ä½ æ­çå§ï¼ç´æ¥æ¥é <code>ReferenceError</code>ã</li>
</ul>
</li>
</ul>
</li>
</ol>
<p><strong>ä¸å®è¦æ³¨æï¼</strong> æä»¬ç°å¨æè¯´çï¼é½æ¯å¨ <strong>è§£æé¶æ®µ</strong>ã è¿ä¸åé½æ¯ <strong>èå¾</strong>ãä½ç¨ååä½ç¨åé¾ï¼å¨è§£æé¶æ®µå°±éå®äºãéå°åéè¯¥æä¹æ¾ãè¯¥å»åªéæ¾ï¼å¨è¿ä¸å»é½å·²ç»æäºèå¾ã</p>
<p>å¨è®²å®ä½ç¨åé¾ä»¥åï¼è¦åä¸æ¥ï¼æªåºä¸ä¸ªæ«çç¼ç®çç¾ï¼è¿å°±æ¯å¯¹è±¡ã</p>
<p><strong>å¯¹è±¡  Object ï¼å®æ²¡æä½ç¨åã</strong></p>
<pre><code>var obj = {
  name: 'é¿ç¥',
  say: 'ææ¯' + name  // æ¥éï¼æèæ¯æ¿å°å¨å±ç name
};
</code></pre>
<p>ä¸ºä»ä¹ï¼åæ ·æ¯å¤§æ¬å·ï¼å½æ°é£éæ¯ä½ç¨åï¼å¯¹è±¡è¿éå´åªæ¯ä¸ä¸ªæ¡æ¡ï¼åªè¡¨ç¤ºä¸ä¸ªæ°æ®ç»æï¼</p>
<p>å¯ä»¥ä»ä»¥ä¸å ä¸ªæ¹é¢æ¥è¯´ï¼</p>
<ul>
<li>
<p>è¯­æ³</p>
<p>ä½ç¨åçå¤§æ¬å·ï¼å®éé¢è£çæ¯è¯­å¥ï¼ æ¯å¨è¯ æ¯å½ä»¤ æ¯å¦ a=1ï¼è¿é=æ¯èµå¼è¿ç®ï¼è¡¨ç¤ºä¸ä¸ªå¨ä½ï¼ä»çæææ¯ å¨è¿ä¸ªä½ç¨åéé¢ï¼å¼ä¸ä¸ªæ§½ä½ï¼æ1æ¾è¿å»ã</p>
<p>å¯¹è±¡çå¤§æ¬å·ï¼å®éé¢è£çæ¯å±æ§å®ä¹ï¼å±æ§æ¯æè¿°ï¼æ¯åè¯ãæ¯å¦ nameï¼âé¿ç¥â ï¼è¿éè¦ç¨åå·ï¼ ä¸è½ç¨=å·ï¼å¦æææç¨äº=å·ï¼é©¬ä¸åºé SyntaxError: Unexpected token '=' ã å¨å¯¹è±¡éï¼æ²¡æåéçè¯´æ³ åªæ é® å  å¼ çæ å°å³ç³»ï¼åªå¯ä»¥ç¨åå·ã</p>
</li>
<li>
<p>æ¶åº</p>
<p>å½æ°æ¯ææåçï¼ èå¯¹è±¡æ²¡æï¼</p>
<pre><code>var obj = {
  a: 1,
  b: a  // æ³å¼ç¨ä¸é¢ç a
};
</code></pre>
<p>å½å¼æè§£ææ¶ï¼</p>
<p>è¯»å° <code>var obj =</code>ï¼å¥½ï¼åå¤åå»ºä¸ä¸ªåé <code>obj</code>ã</p>
<p>è¯»å° <code>{</code>ï¼å¥½ï¼å¼å§åå¤æå»ºä¸ä¸ªå¯¹è±¡ã</p>
<p>è¯»å° <code>a: 1</code>ï¼è®°å½å±æ§ <code>a</code> å¼ä¸º 1ã</p>
<p>è¯»å° <code>b: a</code>ï¼</p>
<ul>
<li>è¿éåå·å³è¾¹ç <code>a</code>ï¼æ¯ä¸ä¸ª<strong>è¡¨è¾¾å¼</strong>ã</li>
<li>è§£æå¨éè¦æ±åºè¿ä¸ªè¡¨è¾¾å¼çå¼ï¼ä½ä¸ºå±æ§ <code>b</code> çå¼ã</li>
<li>**å³é®ç¹ï¼è§£æå¨æ­¤æ¶ä¼å **å½åä½ç¨å ååºæ¥æ¾è¯·æ±ï¼âè°æ¯ aï¼â</li>
</ul>
<p>å½åä½ç¨åæ¯è°ï¼</p>
<p>æ¯ obj æå¨çä½ç¨åï¼æ¯å¦å¨å±ä½ç¨åï¼ï¼èç»ä¸æ¯ obj åé¨ï¼</p>
<p>å ä¸ºæ­¤æ¶æ­¤å»ï¼obj è¿ä¸ªå¯¹è±¡è¿æ²¡çåºæ¥å¢ï¼</p>
<p>ç©¶æåå ï¼æ¯å ä¸º å¯¹è±¡çåå§å  æ¯ä¸ä¸ªä¸å¯åå²çåå­è¿ç¨ï¼è¦ä¹  å°±æ¯æ²¡æ  ï¼è¦ä¹  å°±æ¯å·²ç»æå»ºå®æï¼ç»ä¸ä¼åºç°å¨æå»ºå½ä¸­å¯ä»¥ä½¿ç¨çæåµï¼é¤éè¿ä¸ªåå­è¿ç¨å·²ç»å®æäºï¼å¦å  è¿ä¸ªobjæ¯ä¸å­å¨çã</p>
<p>æä»¥ï¼<strong>å¯¹è±¡åå§åæ¯ä¸ä¸ªåå­è¿ç¨</strong>ãå¨å¤§æ¬å·é­å <code>}</code> ä¹åï¼è¿ä¸ªå¯¹è±¡å¨é»è¾ä¸æ¯âä¸å­å¨âçï¼èªç¶æ æ³æå»ºèµ·æè°çâåé¨å¼ç¨ç¯å¢âï¼</p>
</li>
<li>
<p>ç»æ</p>
<p>å¨v8çä¸çéï¼ä½ç¨ååå¯¹è±¡æ¯å®å¨ä¸åçã</p>
<p>ä½ç¨å å¯¹åºç context</p>
<ul>
<li>å®æ¯ä¸ä¸ªç¯å¢</li>
<li>å°±åä¸ä¸ªæ å¸§æèä¸ä¸æçåè¡¨</li>
<li>éé¢çåéæ¯ä½¿ç¨ç´¢å¼ï¼æ¯å¦  let a æ¯ç¬¬0å·æ§½ä½ï¼let b æ¯ç¬¬1å·æ§½ä½ã</li>
<li>ä½ç¨åæ¯ä¸ºäºä»£ç æ§è¡æå¡çã</li>
</ul>
<p>å¯¹è±¡ å¯¹åºç æ å° éèç±»</p>
<ul>
<li>å®æ¯ä¸ä¸ªå­å¸ï¼ å¯¹è±¡çå®ä¹æ¯ä»ä¹ï¼å®çå®ä¹å°±å¾æ¸æ¥çè¯´æ  å±æ§çæ åºéåãå°±æ¯ä¸ä¸ªå­å¸ã</li>
<li>å®æ¯ä¸å é®åå¼çæ åºçéåã</li>
<li>éé¢çå±æ§æ¥æ¾ï¼æ¯ä½¿ç¨åå¸è®¡ç®æèåç§»éæè¿°ç¬¦çï¼è¿æè¿ä¸ªéèç±»ï¼åé¢æä»¬ä¼è®²å°ã</li>
<li>å®æ¯ä¸ºäºå­å¨æ°æ®æå¡çã</li>
</ul>
</li>
</ul>
<p>å¯¹è±¡åä½ç¨åï¼v8åçç¹å«æ¸æ¥ï¼æ¾åéï¼èµ°ä½ç¨åï¼æ¥æ å¸§ æ¥context  éåº¦å¿«å°èµ·é£ã</p>
<p>æ¾å±æ§ï¼èµ°ååé¾ï¼æ¥map éèç±»ï¼ç¨å¾®æ¢ç¹ã</p>
<p>è¯å®ææåè¯´ï¼ä½ å°±æ¯ä¸ªéªå­ï¼ ä½ çï¼classç°å¨é½è½å¨éé¢å = å·äºã</p>
<pre><code>class Obj {
  name = 'é¿ç¥'; // è¿éåäºç­å·
  say = () =&gt; { console.log(this.name) }; // è¿éä¹ç¨äºåé
}
</code></pre>
<p>classæ¯æé å½æ°çè¯­æ³ç³ï¼å¨es6ä»¥åï¼ç¡®å®å¯ä»¥å=å·ã</p>
<p>ä½æ¯  å¯ä»¥å=å·ï¼ä¹æ¯ä¸ä¸ªè¯­æ³ç³ãå¼æå¹¶ä¸ä¼æç±»éç=å· å½æåéå£°æï¼èæ¯æå®æ¾å°constructoræé å½æ°éé¢ï¼ æ¹æ</p>
<pre><code>// å¼æå·æ¸çæä½
function Obj() {
  this.name = 'é¿ç¥'; // åæäºå±æ§èµå¼
  this.say = ...
}
</code></pre>
<p>å¼æææçä½¿ç¨ this.name=ããã  è¿è¡äºå±æ§èµå¼ï¼èä¸æ¯ var name=ãããï¼å®ä½¿ç¨çä¾æ§æ¯å¯¹è±¡çè§åï¼ä¸æ¯ä½ç¨åçè§åã</p>
<p>ä½ å¨ class éé¢å nameï¼å¦æä¸å  thisï¼ä¾ç¶è®¿é®ä¸å°è¿ä¸ªå±æ§ï¼è¿å¾å»å¤å±ä½ç¨åæ¾ã</p>
<p>æ»ç»å¯¹è±¡ï¼</p>
<ul>
<li><strong>å¯¹è±¡æ²¡æå¢</strong>ï¼å®åªæ¯æ°æ®çå®¹å¨ï¼ä¸æ¯åéçéç¦»åºã</li>
<li>å¯¹è±¡ç<strong>å¤§æ¬å·æ¯éªå­</strong>ï¼ä¸è¦å ä¸ºé¿å¾ååçº§ä½ç¨åï¼å°±ä»¥ä¸ºå®æ¯ä½ç¨åã</li>
<li><strong>åå·ä¸æ¯ç­å·</strong>ï¼<code>:</code> æ¯ç»å°å¾ï¼å®ä¹ç»æï¼ï¼<code>=</code> æ¯åæä»¤ï¼æ§è¡èµå¼ï¼ã</li>
<li><strong>ç®çä¸å</strong>ï¼ä½ç¨åæ¯ä¸ºäº<strong>æ§è¡</strong>ä»£ç ï¼å¯¹è±¡æ¯ä¸ºäº<strong>å­å¨</strong>æ°æ®ãV8 ä»åºå±å°±æå®ä»¬åå°äºä¸åçâé¨é¨âã</li>
</ul>
<p>è¯é³æªè½ï¼åææåå¤§å£°è¯´ éªå­ ç°å¨ç±»éé¢ä¸æ­¢=å·ï¼ä»ä¹é½è½åï¼è¿æä½ç¨åã</p>
<pre><code>class Database {
  static data = [];
  
  // éæåå§åå
  static {
    try {
      const content = loadFromFile(); // å¯ä»¥åé»è¾å
      this.data = content;
    } catch {
      this.data = []; // å¯ä»¥å try-catchå
    }
  }
}
</code></pre>
<p>å®å¹¶ä¸æ¯ å¯¹è±¡å±æ§ï¼ èæ¯æ«çå¤§æ¬å·å¤è¡£çå½æ°ã</p>
<p>è½ç¶staticåå¨classéé¢ï¼ä½æ¯ static{...} å¹¶ä¸æ¯å®ä¹ä¸ä¸ªå« <code>static</code> çå±æ§ï¼ä¸å <code>name: 'é¿ç¥'</code>ï¼ãå¨ V8 ç¼ä¸­ï¼çå° <code>static</code> å³é®å­åé¢ç´§è·ä¸ä¸ª <code>{</code>ï¼è§£æå¨ä¼ç«é©¬åæ¢æ¨¡å¼ï¼</p>
<p>âæ³¨æï¼è¿ä¸æ¯å¨åæ¸åå®ä¹å±æ§ï¼è¿æ¯è¦<strong>æ§è¡ä»£ç </strong>ï¼ç»æå¼è¾ä¸ä¸ªæ°ç <strong>ç±»ä½ç¨å (Class Scope)</strong>â</p>
<p>æä»¥ï¼static { ... } åé¨ï¼å®æå®å°æ¥æä¸ä¸ªåçº§ä½ç¨åã</p>
<p>ä½ å¨static{...}éé¢ let a = 1ï¼è¿ä¸ª a å°±æ­»å¨è¿ä¸ªå¤§æ¬å·éï¼å¤é¢è°ä¹çä¸è§ãè¿å®å¨ç¬¦åä½ç¨åçå®ä¹ã</p>
<p>æ¬è´¨ä¸ï¼è¿ä¸ªéæåç¸å½äºä¸ä¸ªç»å®äº <code>this</code> çç«å³æ§è¡å½æ° ï¼thiså¼ä¸ºè¿ä¸ªclassæé å½æ°æ¬èº«ã</p>
<pre><code>// æä»¬çä»£ç 
class C {
  static { ...code... }
}

// V8 ç¼ä¸­çä»£ç 
class C { ... }
// é©¬ä¸æ§è¡çç«å³æ§è¡å½æ°
(() =&gt; {
   // ...code...
   // è¿éç this æå C
}).call(C);
</code></pre>
<p>æ­£å ä¸ºå®æ¬è´¨ä¸æ¯<strong>ä»£ç æ§è¡</strong>ï¼èä¸æ¯<strong>æ°æ®æè¿°</strong>ï¼æä»¥å®éé¢å½ç¶å¯ä»¥æä½ç¨åï¼å½ç¶å¯ä»¥åè¯­å¥ã</p>
<p>è¿å¹¶ä¸æ¯å¯¹è±¡å¤§æ¬å·åæäºä½ç¨åï¼</p>
<p>èæ¯ ES2022 ä¸é¨å¨ Class å®ä¹éæäºä¸ä¸ªä»£ç æ§è¡åºã</p>
<ul>
<li><strong>æ®éçå¯¹è±¡å­é¢é</strong> <code>{ a: 1 }</code>ï¼ä¾ç¶æ¯<strong>æ°æ®æ¸å</strong>ï¼æ²¡æä½ç¨åï¼ä¸è½åè¯­å¥ã</li>
<li><strong>ç±»çéæå</strong> <code>static { a = 1 }</code>ï¼æ¯<strong>é»è¾ä»£ç å</strong>ï¼æ¯ä½ç¨åï¼æ¯ ä¸ä¸ª VIP æ§è¡ééã</li>
</ul>
<p>è½åè¯­å¥çå°æ¹ï¼æå¯ä»¥å«ä½ç¨åï¼åªè½åé®å¼å¯¹çå°æ¹ï¼ å«å­å¸ å«å¯¹è±¡ã</p>
<p>é¡ºå¸¦çï¼è¿æä¸ªææ¶æ§æ­»åºçæ¦å¿µï¼è¿ä¹æ¯å¾å¤å«è¡æéè¦åæé¢è¯å®çå°æ¹ã</p>
<p>å¨v8ä¸­ï¼ åéçç»³å½å¨æï¼å¤§è´æ3ä¸ªé¶æ®µ</p>
<p><strong>åå»º</strong>  å¨ä½ç¨åéå ä¸ªå  ç»è®°åå­ã</p>
<p><strong>åå§å</strong> ç»è¿ä¸ªåå¡«ä¸ªåå§å¼  <strong>undefined</strong> ä¹ç®çã</p>
<p><strong>èµå¼</strong> å¡«å¥çæ­£çç¨æ·æ°æ® æ¯å¦ 1</p>
<p>varçå¾éï¼</p>
<p>var çâåå»ºâåâåå§åâæ¯ç»å®å¨ä¸èµ·æåçã</p>
<p>å½è¿å¥ä½ç¨åï¼æ¯å¦å½æ°å¼å§ï¼æ¶ï¼V8 ç´æ¥æ var a åå»ºåºæ¥ï¼å¹¶ä¸é¡ºæå°±ç»å®åå§åä¸º undefinedã</p>
<p>æä»¥ï¼ä½ åªæå¨ç¬¬ä¸è¡å°±è®¿é® aï¼å®è½ç¶æ²¡æ°æ®ï¼ä½èµ·ç æ¯ä¸ªåæ³ç undefinedã</p>
<p>let const çå¾éï¼</p>
<p>å®ä»¬çâåå»ºâè¢«æåäºï¼ä½âåå§åâè¢«æ£çäºã</p>
<p>å½è¿å¥ä½ç¨åæ¶ï¼V8 ç¡®å®å¨åå­éç» let a å ä¸ªåä½ï¼ç»è®°äºåå­ï¼ä½æ¯ <strong>V8</strong> å¹¶æ²¡æç»å®åå§å undefinedï¼èæ¯ç»å®å¡«å¥äºä¸ä¸ªæå¶ç¹æ®çè­¦å«  TheHoleã</p>
<p>TheHole æ¯ V8 åé¨çä¸ä¸ªç¹æ®å¯¹è±¡ï¼å¯ä»¥æä»çè§£ä¸ºä¼å¹å¨å­çè­¦å«ã</p>
<ul>
<li><strong>ææ¶æ§æ­»åºçæå¤é¶æ®µå®ä¹</strong>ï¼ä»<strong>è¿å¥ä½ç¨åï¼åå»ºåéï¼</strong>å¼å§ï¼ä¸ç´å°<strong>ä»£ç æ§è¡å°å£°æé£ä¸è¡ï¼åå§ååéï¼</strong>ä¸ºæ­¢ãè¿æ®µæ¶é´ï¼åéä¸ç´å¤äºè¢«è­¦å«çå®ç¶æã</li>
<li><strong>å¹å¨å­</strong>ï¼å¨è¿æ®µæ¶é´åï¼ä»»ä½è¯å¾è¯»åè¯¥åéçæä½ï¼v8ä¸çï¼âååï¼è¿åéæ¯ <code>TheHole</code>ï¼â é©¬ä¸åæ­¢æ§è¡ï¼æåº <code>ReferenceError: Cannot access 'a' before initialization</code>ã</li>
</ul>
<p>ææ¶æ§æ­»åºï¼æ¯ææ¶çï¼æä»¥ å³æ³¨ç¹  ä¸å®è¦åçå¨ ææ¶ç  è¿ä¸ªæ¶é´ç¹ä¸ã</p>
<p>è¢«æåäºï¼ä½æ¯æ²¡çæ­£è¢«èµå¼ï¼ é½å±äºè¿ä¸ª  ææ¶æ§  æåæ¬çæ¶é´é¶æ®µåã</p>
<p>soï¼ææ¶æ§æ­»åº å¹¶ä¸æ¯åéæ²¡ææåï¼èæ¯åéè¢«âå»ç»âäºã</p>
<ul>
<li><code>var</code>ï¼å¼å±éè£å¤ï¼<code>undefined</code>ï¼ã</li>
<li><code>let/const</code>ï¼å¼å±éè­¦å«ï¼<code>TheHole</code>ï¼ãè­¦å«å¨åéçæ­£åå§ååä¸ç´å¹å¨å­ï¼é»æ­¢è®¿é®ãåªæç­å°ä»£ç æ§è¡æµçæ­£è·å°å£°æçé£ä¸è¡ï¼è­¦å«æä¼ææå¨å­ä¸å²èµ°äººï¼æ¢ä¸ææçå¼ã</li>
</ul>
<p>è¿ä¹æ¯ V8 å¼ºè¿«å¼åèå»æåå£°æï¼åä½¿ç¨çå¥½ä¹ æ¯çä¸ç§ææ®µã</p>
<p>æä»¬åè®²ä¸ä¸ªåæ çé®é¢ï¼ç¶åå°±ç»§ç»­å­¦ä¹ å£°æçè§£æã</p>
<p>å½æä»¬è¯´è§£æé¶æ®µçæäºASTæ çæ¶åï¼å¤§å¤æ°äººï¼å°±åªä¼æ³å°è¿æ£µåæ³è¯­æ³æ ã</p>
<p>ä½æ¯å¨V8çè§£æè¿ç¨ä¸­ï¼ å¶å®æ¯è¿æä¸æ£µæ å¨åæ­¥çæï¼åASTæ äºç¸ç¼ ç»ã</p>
<p>è¿å°±æ¯ä½ç¨åæ ã</p>
<ol>
<li>AST (æ½è±¡è¯­æ³æ )</li>
</ol>
<ul>
<li>è¯­æ³ç»æçæ ã</li>
<li>å®æè¿°äºä»£ç ç <strong>è¯­æ³ç»æ</strong>ã</li>
<li><code>Block</code>ã<code>FunctionLiteral</code>ã<code>BinaryExpression</code>ã<code>ReturnStatement</code>...</li>
<li>ç» Ignition è§£éå¨çãè§£éå¨éåè¿æ£µæ ï¼çæå­èç ã
<ul>
<li>çå° <code>BinaryExpression</code> --çæ <code>Add</code> æä»¤ã</li>
<li>çå° <code>Literal</code> -- çæ <code>LdaSmi</code> æä»¤ã</li>
</ul>
</li>
<li>å°±å¥½åæ¯æ­å»ºæ¿å­ç <strong>æ¡æ¶ç»æ</strong>ãå¢å¨åªãçªæ·å¨åªãæ¿éæ±å¨åªã</li>
</ul>
<ol start="2">
<li>Scope Tree (ä½ç¨åæ )</li>
</ol>
<ul>
<li>é»è¾å³ç³»çæ ã</li>
<li>å®æè¿°äºåéç <strong>å¯è§æ§</strong> å <strong>çå½å¨æ</strong>ã</li>
<li><code>GlobalScope</code>ã<code>ModuleScope</code>ã<code>FunctionScope</code>ã<code>BlockScope</code>ã</li>
<li>ç»åéæ¥çã
<ul>
<li>å³å®åéæ¯ä½æ ãä½å ãè¿æ¯ä½å¨å±ã</li>
<li>å¤çé­åçæè·å³ç³»ã</li>
</ul>
</li>
<li>å°±ç±»ä¼¼äº æè¿°æ¿å­ä¸­çåä¸ªé¨ä»¶çé»è¾å³ç³»ã
<ul>
<li>ä¸»å§çå¼å³è½æ§å¶å®¢åçç¯åï¼ï¼åéå¯è§æ§ï¼</li>
<li>è¿æ ¹æ°´ç®¡æ¯éåå¨æ¿è¿æ¯éåå¸æ¿æ»ç®¡éï¼ï¼ä½ç¨åé¾æ¥æ¾ï¼</li>
</ul>
</li>
</ul>
<ol start="3">
<li>åæ ççº ç¼ </li>
</ol>
<p>è¿ä¸¤æ£µæ è½ç¶æ¯åå¼çæ°æ®ç»æï¼ä½å®ä»¬æ¯ <strong>ä¼´ç</strong> çã</p>
<ul>
<li>
<p>ä¼´ççé¿ï¼</p>
<p>å½è§£æå¨è§£æå°ä¸ä¸ª function æ¶ï¼</p>
<ol>
<li><strong>AST å±é¢</strong>ï¼çæä¸ä¸ª <code>FunctionLiteral</code> èç¹ï¼ASTé¿åºäºä¸ä¸ªæä¸«ï¼ã</li>
<li><strong>Scope å±é¢</strong>ï¼<code>NewFunctionScope</code> è¢«è°ç¨ï¼çæä¸ä¸ª <code>FunctionScope</code> å¯¹è±¡ï¼å¹¶ä¸ <code>outer</code> æéæåç¶çº§ï¼ä½ç¨åæ ä¹é¿åºäºä¸ä¸ªæä¸«ï¼ã</li>
<li><strong>æè½½</strong>ï¼V8 ä¼æè¿ä¸ª <code>FunctionScope</code> æå¨ <code>FunctionLiteral</code> çèº«ä¸ã</li>
<li>AST èç¹è¯´ï¼âæçå°çå½è¿ä¸ª Scope ç®¡ã</li>
</ol>
</li>
<li>
<p>è¿æ¥ç¹ï¼VariableProxy</p>
<p>è¿è®°å¾ä¹åè¯´çâå°ç¥¨âåï¼</p>
<p>VariableProxy æ¯æå¨ AST ä¸çèç¹ï¼å ä¸ºå®åºç°å¨æºç éï¼ã</p>
<p>ä½å®ç <strong>å°ç¥¨åæ¢ resolve</strong> è¿ç¨ï¼æ¯å¨ Scope Tree ä¸ç¬æ¥¼æ¢¯ã</p>
<p>ä¸æ¦ resolve åæ¢æåï¼AST ä¸çè¿ä¸ªâå°ç¥¨âå°±è·å¾äºä¸ä¸ªéå Scope Tree ä¸æä¸ªâæ§½ä½âçé¾æ¥ã</p>
</li>
</ul>
<p>ä¸ºä»ä¹è¦åä¸¤æ£µæ ï¼å ä¸º ç»æ å æ°æ® æ¯ä¸¤ç äºã</p>
<ul>
<li>
<p><code>if (true) { let a = 1 }</code></p>
</li>
<li>
<p>ä» <strong>AST</strong> çï¼è¿æ¯ä¸ä¸ª <code>IfStatement</code> åçä¸ä¸ª <code>Block</code>ã</p>
</li>
<li>
<p>ä» <strong>Scope</strong> çï¼<code>IfStatement</code> æ¬èº«ä¸äº§çä½ç¨åï¼ä½éé¢ç <code>Block</code> äº§çäºä¸ä¸ª <code>BlockScope</code>ã</p>
</li>
<li>
<p>ææ¶å AST å¾å¤æï¼åµå¥å¾å¤å±æ¬å·ï¼ï¼ä½ Scope å¾ç®åï¼è¿å¨åä¸ä¸ªä½ç¨åï¼ï¼ææ¶å AST å¾ç®åï¼ä½ Scope åäºï¼æ¯å¦ <code>static</code> åï¼ã</p>
</li>
<li>
<p><strong>AST</strong> æ¯ä¸ºäº <strong>çæä»£ç </strong>ï¼æä¹åï¼ã</p>
</li>
<li>
<p><strong>Scope Tree</strong> æ¯ä¸ºäº <strong>æ¥æ¾æ°æ®</strong>ï¼å¨åªéï¼ã</p>
</li>
<li>
<p>è§£æå¨çå·¥ä½ï¼å°±æ¯ä¸è¾¹æ­æ¿å­ASTï¼ä¸è¾¹çæScopeï¼å¹¶ä¸éºå¥½æ­£ç¡®çé¾æ¥å³ç³»ï¼ç¡®ä¿çå¨ AST éçæ¯ä¸ä¸ªProxyï¼é½è½å¨ Scope éæ¾å°å¯¹åºççèº«ã</p>
</li>
</ul>
<p>ç­ç±å­¦ä¹ çæåå¯è½åæçé®äºï¼ ä¸ºä»ä¹ä»¥åè¯´ä½ç¨åé¾  ç°å¨åæ¯ä½ç¨åæ ï¼å°åºæ¯é¾è¿æ¯æ ï¼</p>
<p>è¿å¶å®æ¯<strong>è§å¯è§åº¦-è§è§</strong>çä¸åã</p>
<ul>
<li>
<p>ä¸å¸çå¨å±è§è§ââ å®æ¯âæ â</p>
<p>ç«å¨ Global çé«åº¦å¾ä¸çï¼</p>
<p>å¨å±ä¸é¢æå½æ° Aãå½æ° Bãå½æ° Cã</p>
<p>å½æ° A ä¸é¢åæå­å½æ° A1ãA2ã</p>
<p>å½æ° B ä¸é¢æå­å½æ° B1ã</p>
<p>è¿æ¶åï¼å®ä»¬çå³ç³»æ¯å¼ææ£å¶çï¼æä»¥æ´ä½ç»ææ¯ ä½ç¨åæ  (Scope Tree)ã</p>
</li>
<li>
<p>æ§è¡æ¶çèèè§è§ââ å®æ¯âé¾â</p>
<p>å½ä½ æ­£å¨æ§è¡æéé¢çå­å½æ° A1 æ¶ï¼ä½ æ ¹æ¬ä¸å³å¿éå£ç A2ï¼ä¹ä¸å³å¿å½æ° B å Cã</p>
<p>ä½ åªå³å¿ï¼æèªå·± --æç¸ç¸(A) -- æç·ç·(Global)ã</p>
<p>å¯¹äºæ­£å¨è¿è¡çä»£ç æ¥è¯´ï¼å®åªçå°äºä¸æ¡éå¾å¨å±çåè¡éã</p>
<p>è¿æ¡çº¿æ§çè·¯å¾ï¼å°±å« ä½ç¨åé¾ (Scope Chain)ã</p>
</li>
</ul>
<p>æä»¥ï¼<strong>è¯´æ ï¼æ¯è¯´å®çæ´ä½ç»æï¼è¯´é¾ï¼æ¯è¯´å®çæ¥æ¾è·¯å¾ã</strong></p>
<ol start="8">
<li>
<p>å¨ç¬¬ä¸å¤§é¨åçç¬¬7å°é¨åï¼æä»¬é¦åè®²äºå£°æçè§£æï¼å¹¶ç¨ä¸ä¸ªä¾å­è¯¦ç»è¯´æäºè§£æè¿ç¨ï¼ç¶åï¼æéè®²è§£äºå ä¸ªæ¯è¾éè¦ç  èä¸å¨åç»­å­¦ä¹ ä¸­éè¦ç¨å°çç¥è¯ç¹ï¼è¿å ä¸ªç¥è¯ç¹ï¼å³ä½¿å¨å¹³æ¶çåç«¯å¼åä¸­ï¼ä¹å±äºæ¯è¾éè¦çãç°å¨æä»¬ç»§ç»­ä¸èµ·å­¦ä¹  å£°æçè§£æ å§ã å¦æå¯¹è§£æçæµç¨æäºå¿è®°äºæåï¼å¯ä»¥å¾ä¸ç¿»ï¼åçä¸ä¸ç¬¬ä¸ä¸ªå½æ°çè§£æã</p>
<p>ç°å¨æä»¬å¼å§å­¦ä¹ å¸¦é­åçå½æ°çè§£æ</p>
<pre><code>function outer() {
  let treasure = 'å¤§å®è´'; // 1. å£°æåé
  
  function inner() {
    return treasure;     // 2. åé¨å¼ç¨ï¼é­åï¼
  }
  
  return inner;
}
</code></pre>
<ul>
<li>
<p>è§£æå¤é¨å½æ°</p>
<p>è§£æå¨è¿å¥outerå½æ°ï¼åå»ºäº outerscopeã</p>
<p>è¯»å° let treasure çæ¶åï¼è§£æå¨åä»¥åä¸æ ·ï¼è¿è¡ç»è®°ã</p>
<p>âtreasure æ¯ä¸ªæ®éåéãæç§ V8 çé»è®¤çé±è§åï¼è¿ç§å±é¨åéåºè¯¥åéå¨ æ  (Stack) ä¸ãå ä¸ºæ æå¿«ï¼èä¸å½æ°æ§è¡å®ï¼æ æéä¸å¼¹ï¼åå­èªå¨åæ¶ï¼å¤çå¿ï¼â</p>
<p>äºæ¯ï¼å¨ AST çèå¾ä¸ï¼treasure è¢«ææ¶æ è®°ä¸ºï¼Stack Localï¼æ å±é¨åéï¼ã</p>
<p>å®è¢«åéäºä¸ä¸ªä¸´æ¶çå¯å­å¨ç´¢å¼ï¼æ¯å¦ r0ï¼ã</p>
<p>å²æéå¥½åã</p>
</li>
<li>
<p>è§£æåé¨å½æ°</p>
<p>è§£æå¨ç»§ç»­å¾ä¸èµ°ï¼çå°äº function innerã</p>
<p>è¿æ¶åï¼è½ç¶ inner å¯è½åªæ¯é¢è§£æï¼ä½é¢è§£æå¨ä¾ç¶æ¯éè¦å·¥ä½çï¼å®å¿«éæ«æ inner çåé¨ä»£ç ï¼ç®çæ¯ä¸ºäºæ£æ¥ææ²¡æè¯­æ³éè¯¯ï¼ä»¥åæéåéå¼ç¨ã</p>
<p>æ«æå¨è¯»å°äº <code>return treasure</code>ã</p>
<p><strong>å³é®æ¶å»</strong>æ¥äº</p>
<ol>
<li><strong>çæå°ç¥¨</strong>ï¼è§£æå¨çæäºä¸ä¸ª <code>VariableProxy("treasure")</code>ï¼å¯»æ¾å®èçå°ç¥¨ï¼ã</li>
<li><strong>å¼å§åæ¢</strong>ï¼
<ul>
<li>é® <code>InnerScope</code>ï¼âä½ æ <code>treasure</code> åï¼â --- <strong>æ²¡æ</strong>ã</li>
<li>é¡ºç <code>outer</code> æéå¾ä¸ç¬ï¼é® <code>OuterScope</code>ï¼âä½ æ <code>treasure</code> åï¼â ---<strong>æï¼</strong></li>
</ul>
</li>
</ol>
<p>æ¾å°äºï¼ä½æ¯ï¼è§£æå¨å¹¶æ²¡æè¿å°±ç»æï¼å®åç°äºä¸ä»¶äºæï¼</p>
<p>è¿ä¸ª <code>treasure</code> æ¯å®ä¹å¨ <code>outer</code> éçï¼ä½æ¯å´è¢« <code>inner</code> è¿ä¸ª<strong>ä¸çº§</strong>ç»å¼ç¨äºï¼èä¸ <code>inner</code> å¯è½ä¼è¢«è¿åå°å¤é¢å»æ§è¡ï¼</p>
<p>è¿å°±æ¯ <strong>è·¨ä½ç¨åå¼ç¨</strong>ã</p>
</li>
<li>
<p>å¼ºå¶æ¬å®¶</p>
<p>è§£æå¨æè¯å°æäºéº»ç¦äºã</p>
<p>å¦æ treasure ä¾ç¶çå¨ æ  ä¸ï¼é£ä¹ç­ outer å½æ°æ§è¡å®æ¯ï¼æ å¸§è¢«éæ¯ï¼treasure å°±ä¼ç°é£çç­ã</p>
<p>ç­å°æ¥ inner å¨å¤é¢è¢«è°ç¨æ¶ï¼å®æ³æ¾ treasureï¼ç»æåªæ¾å°ä¸çåºå¢ï¼é£ç¨åºå°±å´©äºã</p>
<p>äºæ¯ï¼è§£æå¨ç«é©¬ä¿®æ¹äº <code>OuterScope</code> çèå¾ï¼ä¸è¾¾äº <strong>âå¼ºå¶æ¬å®¶ä»¤â</strong>ï¼</p>
<ol>
<li>
<p><strong>ææ¯æ ç­¾</strong>ï¼æ <code>treasure</code> èº«ä¸ç <strong>Stack Local</strong> æ ç­¾ææã</p>
</li>
<li>
<p><strong>è´´æ°æ ç­¾</strong>ï¼æ¢æ <strong>Context Variableï¼ä¸ä¸æåéï¼</strong>ã</p>
</li>
<li>
<p>å¼è¾ä¸åºï¼</p>
<p>V8 å³å®ï¼å¨ outer å½æ°æ§è¡æ¶ï¼ä¸è½åªå¨æ ä¸å¹²æ´»äºãå¿é¡»å¨ å åå­ (Heap) éä¸é¨å¼è¾ä¸ä¸ªå¯¹è±¡ï¼è¿å°±å« Context (ä¸ä¸æå¯¹è±¡)ã</p>
</li>
<li>
<p>åéæ§½ä½ï¼</p>
<p>treasure è¢«åéå°äºè¿ä¸ª Context å¯¹è±¡éçæä¸ªæ§½ä½ï¼æ¯å¦ Slot 0ï¼ã</p>
</li>
</ol>
<p><strong>æ­¤æ¶çåå­èå¾åæäºè¿æ ·ï¼</strong></p>
<ul>
<li><strong>æ®éåé</strong>ï¼å¦ææï¼ï¼ä¾ç¶ä½å¨æ ä¸ï¼ç¨å®å³å¼ã</li>
<li><strong>é­ååé (<code>treasure</code>)</strong>ï¼ä½å¨å éç Context å¯¹è±¡ä¸­ï¼è½æ­»ç¹çã</li>
</ul>
</li>
<li>
<p>å»ºç«è¿æ¥</p>
<p>æ¢ç¶åéæ¬å®¶äºï¼é£ <code>inner</code> å½æ°æä¹ç¥éå»åªæ¾å®å¢ï¼</p>
<p>å¨çæ <code>inner</code> ç <code>SharedFunctionInfo</code>ï¼è¿ä¸ªå°±æ¯å¨æç« åå¼å§é¨åè®²çï¼é¢è§£ææ¶ï¼ä¼çæçå ä½ç¬¦èç¹åä¸ä¸ªSharedFunctionInfoç¸å³èï¼SFIä¸­æé¢è§£æå¾å°çåä¿¡æ¯ï¼æ¶ï¼V8 ä¼è®°å½ä¸è¿ä¸ªéè¦çææ¥ï¼</p>
<p><strong>æ³¨æï¼</strong>æ¬å½æ°æ¯ä¸ä¸ªé­åãæ§è¡æ¶ï¼è¯·å¡å¿éèº«æºå¸¦ç¶çº§ä½ç¨åç <strong>Context æé</strong>ã</p>
<p>è¿å°±å¥½æ¯ inner å½æ°éèº«å¸¦çä¸æé¥åã</p>
<p>ä¸ç®¡å®æµæµªå°ä»£ç çåªä¸ªè§è½ï¼åªè¦å®æ³è®¿é® treasureï¼å®å°±ä¼æ¿åºé¥åï¼æå¼é£ä¸ªè¢«ç²¾å¿ä¿çä¸æ¥ç Context ä¿é©ç®±ï¼ååºéé¢çå¼ã</p>
</li>
<li>
<p>æ»ç»ä¸ä¸</p>
<p>å¨è§£æå±é¢ï¼é­åä¸ä»ä»æ¯âå½æ°å¥å½æ°âï¼å®æ¯ä¸æ¬¡ <strong>âåéå­å¨ä½ç½®çéé¸åæâ</strong>ã</p>
<ol>
<li><strong>æ²¡æé­åæ¶</strong>ï¼ç¶å½æ°çåéé½å¨<strong>æ </strong>ä¸ï¼å½æ°éæ ï¼åééæ¯ã</li>
<li><strong>æé­åæ¶</strong>ï¼è§£æå¨åç°æåé¨å½æ°å¼ç¨äºç¶çº§åéï¼å¼ºè¡æè¯¥åéä»<strong>æ </strong>æªå°<strong>å  (Context)</strong>ã</li>
</ol>
<p>è¿å°±æ¯ä¸ºä»ä¹é­åä¼æ¶èæ´å¤åå­ã</p>
<p>å¹¶ä¸æ¯å ä¸ºå½æ°æ²¡éæ¯ï¼èæ¯å ä¸ºæ¬è¯¥éçæ å¸§éæ¯çåéï¼è¢«è¿«æ¬å°äºå éï¼å¹¶ä¸å¿é¡»é¿æå»çå®ã</p>
<p>ç°å¨ï¼åçé­åï¼æ¯ä¸æ¯æè§çå°çä¸åæ¯ä»£ç ï¼èæ¯ V8 åå­éé£ä¸ä¸ªä¸ªè¢«å¼ºè¡ä¿çä¸æ¥ç <strong>Context å°çå­</strong>ã</p>
</li>
<li>
<p>æè®°å¾å¨åé¢æä¸ªå°æ¹ï¼æå°è¿ï¼æ æcontextä¸­æä¹åéä½ç½®ï¼ å ä¸ºè¿æ¯å¨è§£æé¶æ®µï¼é½æ¯ç»å¤§é¥¼é¶æ®µï¼ æä¹æ¥åéå·ä½ä½ç½®å¢ï¼</p>
<p>è¿ä¸ªæ¯ä½¿ç¨ <strong>ç¸å¯¹ä½ç½®</strong> æ¥è¯´çï¼</p>
<p>æ¯å¦ï¼ èæ¿åä½ è¯´  é¿ç¥ ä½ å¥½å¥½å¹²  ç­å±å¬å¸æäºèªå·±çå¤§æ¥¼ï¼ç¬¬88å±åºäºçµæ¢¯å·¦æç¬¬ä¸é´åå¬å®¤ï¼å°±ç»ä½ ç¨ã</p>
<p>æè¾¹åæ­¦ç¼çº¢äºï¼ èæ¿è¯´  åæ­¦ä½ ä¹å¥½å¥½å¹²ï¼ç¬¬188å±åºäºçµæ¢¯å³æç¬¬ä¸é´åå¬å®¤ï¼ç»ä½ ç¨ã</p>
<p>é¿ç¥ååæ­¦æå¨çå½æå°±å ç­å°åæ¨8ç¹æ´ã</p>
<p>æä»¥ï¼è½ç¶è¿æ¯èå¾  è¿å¨ç»å¤§é¥¼   ä½æ¯ç¸å¯¹ä½ç½®æ¯å¯ä»¥ç¡®å®çï¼ç±»ä¼¼äºåºåå åç§»éçå½¢å¼ã</p>
</li>
<li>
<p>æ¯çï¼ç°å¨åè¯¥<strong>æ ä¸­çå</strong>äºï¼æåå­¦çæåï¼è¯´ ï¼é­åå  å°±æ¯æåé¨å½æ°éè¦ç¨å°çå¤é¨å½æ°çæ°æ®  é½ç»æåå°é­äºãå¬èµ·æ¥ä¼¼ä¹ä¹å¯ä»¥ã é£ä¹ï¼é½åäºä»ä¹ä¸è¥¿å¨éé¢ï¼æ¯å¤§å ä¸­å  è¿æ¯å°åï¼</p>
<p>è¿ä¸ªå¯è½ä¹ä¸ä»æ¯åå­¦æåççæã</p>
<p>é£ä¹  é®é¢å°±ççæ¥äºï¼å°åºæ¯åäºå¤å°ä¸è¥¿ï¼</p>
<p><strong>V8 æ¯éå¸¸æ æçï¼å®åæâå°åâï¼ä½ææ¶åä¼è¢«è¿«ç¨ä¸­åï¼çè³å¤§åã</strong></p>
<ul>
<li>
<p>é»è®¤å°åï¼æéæå  æ ææ¨¡å¼</p>
<p>v8å¨åæä½ç¨åæ¶ï¼ä¼ç²¾åè®¡ç®ï¼</p>
<ul>
<li>
<p><strong>åé A</strong>ï¼è¢«åé¨å½æ°å¼ç¨äºåï¼æ²¡æï¼å¥½ï¼çä½ å¨æ ä¸ï¼ç¨å®å°±éæ¯ã</p>
</li>
<li>
<p><strong>åé B</strong>ï¼è¢«å¼ç¨äºï¼å¥½ï¼ä½ æ¬è¿ Context éå»ã</p>
<p>åªæè·ç¨å°çï¼ç»ä¸æµªè´¹ä¸ç²ç±³ãé»è®¤ç å°å</p>
</li>
</ul>
</li>
<li>
<p>ç¹æ®æåµä¸ï¼è¢«è¿«è¿å ä¸­å</p>
<pre><code>function factory() {
  let heavyData = new Array(1000000); // è¿æ¯ä¸ä¸ªè¶å¤§çæ°æ®
  let lightData = 'å°å½å°';

  function useHeavy() {
    // è¿ä¸ªé­åç¨äº heavyData
    console.log(heavyData.length);
  }

  function useLight() {
    // è¿ä¸ªé­ååªç¨äº lightData
    console.log(lightData);
  }

  // åªæ useLight è¿ååºå»äºï¼useHeavy æ ¹æ¬æ²¡è¿åï¼æäº
  return useLight;
}

const myClosure = factory();
</code></pre>
<ol>
<li>
<p>æ«æ <code>useHeavy</code>ï¼åç°å®ç¨äº <code>heavyData</code>ã--- <code>heavyData</code> å¿é¡»è¿ Contextã</p>
</li>
<li>
<p>æ«æ <code>useLight</code>ï¼åç°å®ç¨äº <code>lightData</code>ã--- <code>lightData</code> å¿é¡»è¿ Contextã</p>
<p>å³é®ç¹æ¥äºï¼</p>
<p>åä¸ä¸ªä½ç¨åï¼factoryï¼ä¸çæçé­åï¼å®ä»¬å±äº« åä¸ä¸ª Context å¯¹è±¡ã</p>
<p>åªè¦æä¸ä¸ªé­åï¼åªææ¯æ²¡è¢«è¿åç useHeavyï¼æ heavyData æè¿äº Contextï¼é£ä¹è¿ä¸ª Context éå°±å®æå®å°å­ç heavyDataã</p>
<p>è½ç¶åªè¿åäº useLightï¼ä½ useLight æéæ¡ççé¥åï¼æå¼çæ¯é£ä¸ª åå«äº heavyData ç Contextã</p>
<p>åªè¦ useLight è¿è¦æ´»ä¸å»ï¼é£ä¸ª Context å°±å¾æ´»ä¸å»ï¼é£ä¸ªè¶å¤§ç heavyData ä¹å°±å¾æ´»ä¸å»ï¼æ æ³è¢«åå¾åæ¶ã</p>
<p><strong>ç»è®ºï¼æåçæ¯ ä¸­åãåä¸ä¸ªä½ç¨åä¸çææé­åï¼å±äº«åä¸ä¸ªâåâãè¿äºåä»¥åï¼æ æ³åºååªä¸ªè¢«ççreturnåºå»ï¼æä»¥åå¼è¿åã</strong></p>
</li>
</ol>
</li>
<li>
<p>ç¹æ®æåµäºï¼eval  ä¸éç«¯å¤§å</p>
<pre><code>function risk() {
  let a = 1;
  let b = 2;
  // ... è¿éè¿æ 100 ä¸ªåé ...
  
  return function inner() {
    eval("console.log(a)"); // æ²ç¹åæ²¹ç£åºï¼
  };
}
</code></pre>
<p>è§£æå¨æ«æ inner æ¶ï¼çå°äº evalã</p>
<p>ç¬é´æçé±åçå­ï¼âè¿ç©æå¿è½å¨ææ§è¡ä»£ç ï¼å®å¯è½å¼ç¨ aï¼ä¹å¯è½å¼ç¨ bï¼çè³å¯è½å¼ç¨æè¿æ²¡è¯»å°çåé... æ ¹æ¬æ æ³éæåæå®å°åºè¦ç¨è°ï¼â</p>
<p>ä¸ºäºå®å¨èµ·è§ï¼V8 åªè½èººå¹³äºï¼</p>
<p>å«åæäºãæ risk ä½ç¨åéç ææåéï¼ç»ç»æåè¿ Contextï¼</p>
<p>è¿æ¶åï¼å°±ä¸åæ¯æéåéäºï¼èæ¯çæ­£çä¸éç«¯çå¤§åãææåéå¨é¨ç±æ è½¬å ï¼æ§è½ååå­å¼éç¬é´ææ»¡ã</p>
<p>è¿ä¹æ¯ä¸ºä»ä¹ç¼ç æç¤ºéï¼é½ä¼æéï¼ä¸è¦ç¨ eval ã</p>
<p>ä¸ä»æ¯å ä¸ºå®å¨é®é¢ï¼æ´æ¯å ä¸ºå®ä¼æç V8 çéé¸åæä¼åï¼å¼ºå¶ä¿çææä¸ä¸æã</p>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>ä¸é¢æä»¬è±äºå¾å¤§ç¯å¹è®²äºæ®éå½æ°çè§£æãè¿æ¶åè¯å®ææåé®ï¼âä¸æ¯è¯´âä¸ç±»åå½ä¸¤åéâåï¼è¿æä¸ç§å½æ°ï¼å¼æ­¥ãçæå¨ãå¼æ­¥çæå¨ï¼å¢ï¼â</p>
<p><strong>å®éä¸ï¼å®ä»¬ç¨çæ¯åä¸å¥æ¨¡å·ã</strong></p>
<p>å¨ V8 éï¼<code>ParseHoistableDeclaration</code> è´è´£æ¥å¾è¿åä½å¤©çãç»è¿ <code>ParseFunctionDeclaration</code> çç®ååè£åï¼å¤çå½æ°å­é¢éçå¥å£å¨é½æååä¸ä¸ªè¦åï¼<strong><code>ParseFunctionLiteral</code></strong>ã</p>
<p>æ è®ºæ¯ <code>function</code>ã<code>function*</code>ã<code>async function</code> è¿æ¯ <code>async function*</code>ï¼å®ä»¬å¨ V8 ç¼éé½æ¯âç©¿äºä¸åé©¬ç²âçæ®éå½æ°ã</p>
<p>è§£æå¨åªéè¦å¨è¿é¨æ¶åä¸æ¬¡âå®æ£âï¼æ ¹æ® <code>*</code> å <code>async</code> å³é®å­æä¸ä¸åçæ ç­¾ï¼Flagï¼ï¼æ¥ä¸æ¥çè§£ææµç¨ââæ¥åæ°ãå¼ä½ç¨åãååä»£ç åââ<strong>å®å¨å¤ç¨</strong>ã</p>
<p>ä¸è¿ï¼éå¯¹è¿ä¸ä½âç¹æé¶çº§âï¼è§£æå¨ç¡®å®ä¼å·å·åä¸ä»¶ä¸åçå°æä½ï¼</p>
<ol>
<li><strong>å³é®å­åå</strong>ï¼ å¨æ®éå½æ°éï¼<code>yield</code> å <code>await</code> åªæ¯æ®éçåéåãä½å¨ç¹æ®å½æ°éï¼è§£æå¨ä¼æå®ä»¬è¯å«ä¸º <strong>æä½ç¬¦</strong>ï¼çæä¸é¨ç AST èç¹ã</li>
<li><strong>å¤¹å¸¦ <code>.generator</code></strong>ï¼ å¯¹äºçæå¨åå¼æ­¥å½æ°ï¼è§£æå¨ä¼å·å·å¨ä½ç¨åéå¡ä¸ä¸ªéå½¢ç <code>.generator</code> åéã è¿æ¯ä¸ºäºå°æ¥å½æ°âæåâæ¶ï¼è½æå½åçå¯å­å¨ãåéå¼ç­ <strong>âæ¡åç°åºâ</strong> ä¿å­å¨è¿ä¸ªåééã æä»¥ï¼è¿å ç§å½æ° <strong>å¤©ç¶å°±æ¯é­å</strong>ï¼å ä¸ºå®ä»¬å¿é¡»å¼ç¨è¿ä¸ªéå½¢çä¸ä¸æã</li>
<li><strong>ä¼æ¯ç¹ <code>Suspend</code></strong>ï¼ è§£æå¨ä¼å¨ AST éåä¸ <strong><code>Suspend</code> (æèµ·)</strong> èç¹ã è¿ç¸å½äºåè¯æªæ¥çè§£éå¨ï¼âè¯»å°è¿å¿å«ç¡¬å²äºï¼å¾åä¸æ¥æ­ä¼å¿ï¼ææ§å¶æäº¤åºå»ãâ</li>
</ol>
<p>è½ç¶å·ä½è§£ææ¶æä¸å°å·®å¼ï¼ä½æ¯ï¼æäºåé¢æä»¬è§£ææ®éå½æ°çåºç¡ï¼åæ¥è§£æè¿ä¸ç§âé­æ¹çâçå½æ°ï¼é¾åº¦å¹¶ä¸å¤§ã æä»¬å°±ä¸å·ä½å±å¼äºï¼æ¯ç«ï¼å½æ°åç¾ï¼çå¤äºä¹ä¼<strong>å®¡ç¾ç²å³</strong>åã</p>
<p>æä»¥ï¼æä»¬ç°å¨å­¦ä¹ å£°æä¸­ç åéå£°æã</p>
<p>è½ç¶åé¢ä¸ç´å¨è¯´ ä¸¤åéï¼é£æ¯ä»è§èä¸è¯´ç <strong>varå±äºè¯­å¥</strong>ï¼ å¨ V8 ä¸­ï¼let const  var è¿ä¸ä¸ªåéå£°æ ï¼æ¯ä½¿ç¨åä¸ä¸ªè§£æå½æ°å¤ççã</p>
<p>æä¸ä¸ªæ ¸å¿å½æ°å« <strong><code>ParseVariableDeclarations</code></strong>ã</p>
<p>ä¸ç®¡è§£æå¨è¯»å°çæ¯ <code>var</code>ï¼è¿æ¯ <code>let</code>ï¼è¿æ¯ <code>const</code>ï¼å¨ç»è¿<strong>é¡¹çº§åæµ</strong>åï¼æç»é½ä¼æ®éåå½ï¼è°ç¨è¿ä¸ªå½æ°ParseVariableDeclarationsã</p>
<p>ä¸é¢ï¼æä»¬å°±å¼å§åéçå£°æä¹æå§ã</p>
<ul>
<li>
<p>é¡¹çº§åæµ</p>
<p>å°ç¹ï¼ParseStatementListItem</p>
<p>åºæ¯ï¼è§£æå¨æ­£å¨ä¸ä¸ªå¤§æ¬å· { ... } æèå½æ°ä½éï¼éè¡æ«æä»£ç ã</p>
<ol>
<li>
<p>**å·ç **ï¼ççä¸ä¸ä¸ª Token æ¯ä»ä¹å¢ï¼</p>
</li>
<li>
<p><strong>å¤æ­</strong>ï¼</p>
<ul>
<li>å¦æçå° <code>var</code>ï¼</li>
<li>å¦æçå° <code>let</code>ï¼</li>
<li>å¦æçå° <code>const</code>ï¼</li>
</ul>
</li>
<li>
<p>ç»ä¸ç©éï¼</p>
<p>V8 åç°æ¯è¿ä¸ä¸ªå³é®å­ä¹ä¸ï¼ç«é©¬å³å®ï¼âè¿æ¯å£°æåéçæ´»å¿ï¼â</p>
<p>å®ä¸ååºåä½ æ¯è¯­å¥è¿æ¯å£°æï¼è¿éå°±ç´æ¥ævarä¹åæ¬è¿æ¥äºï¼ç´æ¥æè¿ä¸åå¼æåï¼ç»ä¸è°ç¨åä¸ä¸ªå½æ°ï¼ParseVariableDeclarationsã</p>
<p>ä½ç©éçæ¶åï¼å®ç»æ¯äººè´´äºä¸ªä¸åçåæ°ï¼</p>
<ul>
<li>éå° <code>var</code> ---ä¼ å <code>kVar</code></li>
<li>éå° <code>let</code> ---ä¼ å <code>kLet</code></li>
<li>éå° <code>const</code> --- ä¼ å  <code>kConst</code></li>
</ul>
</li>
</ol>
</li>
<li>
<p>éç¨è½¦é´</p>
<p>å°ç¹ï¼ParseVariableDeclarations</p>
<p>åºæ¯ï¼è¿æ¯ä¸åå¼å±ç¨çè½¦é´ã</p>
<p>è¿ä¸ªå½æ°æ¯æ ¸å¿ãå®ä¸ä»è¦è§£æ <code>var a = 1</code>ï¼è¿è¦è´è´£è§£æ <code>var a = 1, b = 2</code> è¿ç§è¿çåçï¼è¿è¦è´è´£è§£æèµå¼ã</p>
<p>æ­¥éª¤ <strong>1</strong>ï¼æ¶è´¹å³é®å­</p>
<p>è§£æå¨é¦åæ ¹æ®åæä¼ è¿æ¥çä¸å<strong>åæ°</strong>ï¼è°ç¨ consume() åæå¯¹åºçå³é®å­ï¼var/let/constï¼ã</p>
<p>æ­¥éª¤ <strong>2</strong>ï¼å¼å¯å¾ªç¯</p>
<p>å ä¸º JS åè®¸ var a, b, c; è¿ç§åæ³ï¼æä»¥è¿éå¼å¯äºä¸ä¸ª do...while å¾ªç¯ï¼åªè¦çå°éå· , å°±ç»§ç»­ã</p>
<p><strong>æ­¥éª¤ 3ï¼è§£æåéå</strong></p>
<ul>
<li>è§£æå¨è¯»åæ è¯ç¬¦ï¼æ¯å¦ <code>a</code>ï¼ã</li>
<li><strong>è¯­æ³æ£æ¥</strong>ï¼
<ul>
<li>å¦ææ¯ <code>let/const</code>ï¼ä¸åéåå« <code>let</code>ï¼--- <strong>æ¥é</strong>  åéåæ³å«å³é®å­  ä¸è¾¹å»å§ã</li>
<li>å¦ææ¯ä¸¥æ ¼æ¨¡å¼ï¼åéåå« <code>arguments</code> æ <code>eval</code>ï¼--- <strong>æ¥é</strong>ï¼æ³å¨è¾¹ç¼è¯æ¢  ä¹ä¸è¾¹å»å§ã</li>
</ul>
</li>
</ul>
</li>
<li>
<p>åå¤´å·¥ä½</p>
<p>å°ç¹ï¼DeclareVariableName (å¨è§£æåºåå­åç«å»è°ç¨)</p>
<p>åºæ¯ï¼åå­æäºï¼ç°å¨è¦å»Scope Treeï¼ä½ç¨åæ ï¼ ä¸ç»è®°æ·å£äºãè¿æ¶åï¼å¿é¡»æ ¹æ®</p>
<p><strong>åæ°</strong> æ¥åºåå¾éã</p>
<p>è¿éæ¯é»è¾æå¤æçå°æ¹ï¼ä¹æ¯ <code>var</code> å <code>let</code> è¡ä¸ºå·®å¼ç<strong>æ ¹æº</strong>ã</p>
<p><strong>åæ¯ Aï¼æéæ¿çæ¯ <code>kVar</code> åæ°</strong></p>
<ol>
<li><strong>åä¸ç©¿å¢</strong>ï¼è§£æå¨æ è§å½åçåçº§ä½ç¨å <code>BlockScope</code>ï¼æ²¿ç <code>scope--outer_scope()</code> æéä¸ç´å¾ä¸ç¬ã</li>
<li><strong>å¯»æ¾å®¿ä¸»</strong>ï¼ç´å°æå°äºä¸ä¸ª <code>FunctionScope</code> æè <code>GlobalScope</code>ï¼å½æ°ä½ç¨åæå¨å±ä½ç¨å  æ¯varçç®æ ã</li>
<li><strong>ç»è®°</strong>ï¼å¨é£ä¸ªé«å±ä½ç¨åéï¼è®°å½ä¸åå­ <code>a</code>ã</li>
<li><strong>æ¨¡å¼</strong>ï¼æ è®°ä¸º <code>VariableMode::kVar</code>ï¼å¯å¯å¯  è¿éæ¯åé¨çä¸ä¸äºã</li>
<li><strong>åå§å</strong>ï¼æ è®°ä¸º <code>kCreatedInitialized</code>ï¼åå»ºå³åå§åï¼ãæææ¯ï¼âvarè¿å®¶ä¼ä¸ç¨æ­»åºï¼ç´æ¥ç»ä¸ª <code>undefined</code> å°±è½ç¨ãâ</li>
</ol>
<p><strong>åæ¯ Bï¼æéæ¿çæ¯ <code>kLet</code> æ <code>kConst</code> åæ°</strong></p>
<ol>
<li><strong>åå°ä¸å¨</strong>ï¼è§£æå¨ç´æ¥éå®å½åç <code>Scope</code>ï¼åªæå®åªæ¯ä¸ä¸ª <code>if</code> åï¼ã</li>
<li>**æ¥é **ï¼ç¿»å¼å½åä½ç¨åçå°æ¬æ¬ï¼ççææ²¡æéåçï¼
<ul>
<li>æï¼-- <strong>æ¥é</strong> <code>SyntaxError: Identifier has already been declared</code>ã</li>
</ul>
</li>
<li><strong>ç»è®°</strong>ï¼å¨å½åä½ç¨åè®°å½åå­ <code>a</code>ã</li>
<li><strong>æ¨¡å¼</strong>ï¼æ è®°ä¸º <code>VariableMode::kLet</code> æ <code>VariableMode::kConst</code>ã</li>
<li><strong>åå§å</strong>ï¼æ è®°ä¸º <code>kNeedsInitialization</code>ï¼éè¦åå§åï¼ã
<ul>
<li><strong>è¿å°±æ¯ TDZ çæºå¤´äºï¼</strong> è¿ä¸ªæ è®°æå³çï¼å¨æ­£å¼èµå¼ä¹åï¼è°æ¢è®¿é®è¿ä¸ªä½ç½®ï¼å°±æéã</li>
</ul>
</li>
<li><strong>æ³¨æç¹</strong>ï¼ ä»è¿éè½çåº  letåconstä¹ä¼æåï¼åªä¸è¿letåconstçæåæ¯å°æåï¼åªå¨èªå·±çå½åä½ç¨åéæåï¼æåå½æåï¼æ²¡è¢«çæ­£èµå¼åï¼TDZåï¼è¢«éä¼å¹å¨å­çè­¦å«çå®çã</li>
</ol>
</li>
<li>
<p>å¤çåå§å¼</p>
<p>å°ç¹ï¼åå°éç¨è½¦é´</p>
<p>åºæ¯ï¼åå­ç»è®°å®äºï¼ç°å¨çææ²¡æèµå¼å· =ã</p>
<p><strong>æ­¥éª¤ 1ï¼const çæ£æ¥</strong></p>
<ul>
<li>è§£æå¨å·çä¸ä¸ä¸ª Tokenã</li>
<li>å¦ææ¯ <code>kConst</code> ä¸åé¢<strong>æ²¡æ</strong> <code>=</code> å·ï¼
<ul>
<li><strong>ç´æ¥å´©äº</strong> æåº <code>SyntaxError: Missing initializer in const declaration</code>ã</li>
<li><code>var</code> å <code>let</code> ä¼å·ç¬ï¼å ä¸ºå®ä»¬åè®¸æ²¡æ <code>=</code>ã</li>
</ul>
</li>
</ul>
<p><strong>æ­¥éª¤ 2ï¼è§£æèµå¼</strong></p>
<ul>
<li>å¦æçå°äº <code>=</code>ï¼åæå®ã</li>
<li><strong>éå½ç©é</strong>ï¼è°ç¨ <code>ParseAssignmentExpression</code> è§£æ <code>=</code> å³è¾¹çè¡¨è¾¾å¼ï¼æ¯å¦ <code>1 + 2</code>ï¼ãããè¿éè¿éè¿é  åé¢è¶å¤§ç¯å¹è®²è¿çè¡¨è¾¾å¼è§£æï¼çå°äº²ååï¼</li>
</ul>
<p><strong>æ­¥éª¤ 3ï¼çæ AST èç¹</strong></p>
<p>è¿éæ¯ AST ç©çç»æççæã</p>
<ul>
<li>
<p>å¯¹äº varï¼</p>
<p>ç±äº var çåå­å·²ç»æåèµ°äºï¼è¿éå©ä¸çå¶å®æ¯ä¸ä¸ª èµå¼æä½ã</p>
<p>V8 ä¼çæä¸ä¸ª Assignment èç¹ï¼æèç±»ä¼¼çåå§åèç¹ï¼ï¼æå¨å½åçè¯­å¥åè¡¨ä¸­ã</p>
<ul>
<li>æææ¯ï¼âåå­å½ä¸é¢ç®¡ï¼ä½æå¾å¨è¿éæå¼èµè¿å»ãâ</li>
<li>è¿éä¹éè¦<strong>æ³¨æ</strong>ï¼varçåå­è¢«æåèµ°äºï¼ä½æ¯èµå¼æä½è¿çå¨è¿éå¢ï¼å¨èµå¼ä¹åï¼varé½æ¯undefinedã</li>
</ul>
</li>
<li>
<p>å¯¹äº let / constï¼</p>
<p>V8 ä¼çæä¸ä¸ªå®æ´ç VariableDeclaration èç¹ï¼åå«åå­ååå§å¼ã</p>
<p>èä¸ï¼å¦æè¿æ¯ constï¼V8 ä¼ç»è¿ä¸ªåéæä¸ âåªè¯»â çæ ç­¾ãå¦æä»¥å AST éæå«çèç¹æ³ä¿®æ¹å®ï¼ç¼è¯é¶æ®µæè¿è¡é¶æ®µå°±ä¼æ¦æªæ¥éã</p>
<p>è¿ä¸ªåªè¯»ï¼æ¯æç»å®çå¼ç¨ä¸å¯åï¼å¦æå¼ç¨çæ¯ä¸ªå¯¹è±¡ï¼å¯¹è±¡åé¨çåå®¹è¿æ¯å¯ä»¥æ¹çã</p>
</li>
</ul>
</li>
<li>
<p>æ¶å°¾å½</p>
<p>å°ç¹ï¼å¾ªç¯æ«å°¾</p>
<ol>
<li><strong>éå·æ£æ¥</strong>ï¼å·çåé¢æ¯ä¸æ¯éå· <code>,</code>ï¼
<ul>
<li>æ¯ -- åæéå·ï¼åå° <strong>éç¨è½¦é´çæ­¥éª¤ 3</strong>ï¼ç»§ç»­è§£æä¸ä¸ä¸ªåéã</li>
<li>å¦ --- ç»æå¾ªç¯ã</li>
</ul>
</li>
<li><strong>åå·å¤ç</strong>ï¼æå¾ä¸ä¸ªåå· <code>;</code>ãå¦ææ²¡æï¼èªå¨åå·æå¥ã</li>
<li><strong>äº¤è´§</strong>ï¼è¿åè¿ä¸æ´æ¡è¯­å¥ç AST èç¹ã</li>
</ol>
</li>
</ul>
<p>ä¸é¢æä»¬åä»¥åä¸ªçä¾å­æ¥å­¦ä¹ ä¸ä¸</p>
<pre><code>function foo() {
  if (true) {
    var a = 1; 
  }
}
</code></pre>
<ul>
<li>
<p>Scope æä½ï¼</p>
<p>è§£æå¨æ¿å° aï¼å¼å§å¨ Scope Tree ä¸è¿è¡ä¸æ¬¡ç¬æ </p>
<p>å®ä¼é®å½åç BlockScopeï¼if åï¼ï¼</p>
<p>âä½ æ¯å½æ°ä½ç¨ååï¼ä½ æ¯å¨å±ä½ç¨ååï¼â</p>
<p>âæä¸æ¯ãâ</p>
<p>âå¥½ï¼é£æç»§ç»­å¾ä¸æ¾ãâ</p>
<p>å®ä¼è·³è¿ BlockScopeï¼ä¸ç´æ¾å° FunctionScopeï¼foo å½æ°ï¼ã</p>
<p>ç¶åï¼è°ç¨ DeclareVariableNameï¼æ a ç»è®°å¨ FunctionScope çè±ååä¸ã</p>
<p>æ³¨æï¼æ­¤æ¶ a çä½ç½®å¨é»è¾ä¸å·²ç»å±äº foo äºï¼å°½ç®¡ç©çä»£ç è¿å¨ if éã</p>
</li>
<li>
<p>è§£æå¨è¯»å° <code>= 1</code>ã</p>
</li>
<li>
<p>AST çæï¼</p>
<p>å¯¹äº var a = 1ï¼V8 å¨ AST å±é¢ï¼éå¸¸ä¼æå®æè§£æä¸¤é¨åï¼</p>
<ol>
<li><strong>å£°æ (Declaration)</strong>ï¼<code>var a</code>ãè¿é¨åå¨ AST ä¸è¢«æ è®°ä¸ºâå¯æåâã</li>
<li><strong>èµå¼ (Assignment)</strong>ï¼<code>a = 1</code>ã</li>
</ol>
<p>è§£æå¨ä¼å¨å½åä½ç½®<code>if</code> åçè¯­å¥åè¡¨ä¸­ï¼çæä¸ä¸ª <strong><code>Assignment</code> (èµå¼)</strong> èç¹ï¼èä¸æ¯ä¸ä¸ªåçº¯çå£°æèç¹ã</p>
</li>
<li>
<p><strong>Scope æ </strong>ï¼åå­è¢«âç©¿å¢âæå°äºé¡¶å±ã</p>
</li>
<li>
<p><strong>AST æ </strong>ï¼åå°çä¸äºä¸ä¸ªèµå¼èç¹ <code>a = 1</code>ã</p>
</li>
<li>
<p>è¿å°±æ¯ä¸ºä»ä¹ <code>var</code> ææåï¼åå­ä¸å»äºï¼ï¼ä½èµå¼æ²¡æåï¼èµå¼èç¹è¿å¨åå°ï¼ã</p>
</li>
</ul>
<pre><code>{
  let b = 2;
}
</code></pre>
<ul>
<li>
<p><strong>å¨ä½</strong>ï¼æ¶è´¹ <code>let</code>ï¼è¯»å°æ è¯ç¬¦ <code>b</code>ã</p>
</li>
<li>
<p>Scope æä½ï¼</p>
<p>è§£æå¨ç´æ¥éå®å½åç BlockScopeã</p>
<p>å®ä¸å¾ä¸æ¾ï¼èæ¯ç«å»æ¥éå½åçè±ååï¼</p>
<p>âè¿éé¢æå« <code>b</code> çåï¼â</p>
<ul>
<li>å¦ææï¼<strong>éå¤å®ä¹ï¼æ¥é</strong> æåº <code>SyntaxError: Identifier 'b' has already been declared</code>ã</li>
<li>å¦ææ²¡æï¼<strong>ç»è®°</strong></li>
</ul>
</li>
<li>
<p>Scope æä½ï¼å³é®ï¼ï¼</p>
<p>å¨ç»è®° b çæ¶åï¼V8 ä¼ç»å®æä¸ä¸ä¸ªç¹æ®ç Modeï¼kLetã</p>
<p>å¹¶ä¸å¨åå§åæ è®°ä½ä¸ï¼æä¸ kNeedsInitializationï¼éè¦åå§åï¼ã</p>
<p>å¨åé¢çä¸ä¸ªåéä¸èµ·è®²çä¾å­éè®²è¿äºï¼è¿å°±æ¯ TDZ çç©çæ¥æºãè¿ä¸ªæ è®°è¡¨ç¤ºï¼âå¨ç» b èµå¼ä¹åï¼ä»»ä½è®¿é®é½è¦æéãâ</p>
</li>
<li>
<p>è§£æå¨è¯»å° <code>= 2</code>ã</p>
</li>
<li>
<p>AST çæï¼</p>
<p>è¿æ¬¡ä¸åvaré£æ ·éè¦æåäºã</p>
<p>è§£æå¨ç´æ¥å¨å½åä½ç½®ï¼çæä¸ä¸ª VariableDeclaration èç¹ã</p>
<p>è¿ä¸ªèç¹åå«ï¼</p>
<ul>
<li><strong>Proxy</strong>ï¼åé <code>b</code> çå¼ç¨ã</li>
<li><strong>Initializer</strong>ï¼å­é¢é <code>2</code>ã</li>
<li><strong>Mode</strong>ï¼LETã</li>
</ul>
<p>è¯¥èç¹è¢«ç´æ¥ Push å°å½å <code>Block</code> çè¯­å¥åè¡¨ä¸­ã</p>
</li>
<li>
<p><strong>Scope æ </strong>ï¼åå­ç»è®°å¨å½ååï¼ä¸å¯éå¤ï¼æ è®°ä¸ºæ­»åºç¶æã</p>
</li>
<li>
<p><strong>AST æ </strong>ï¼åå°çæä¸ä¸ªå®æ´ç <code>VariableDeclaration</code> èç¹ã</p>
</li>
</ul>
<p><strong>è¿å©ä¸constäº</strong>ï¼<code>const</code> çæµç¨å <code>let</code> å ä¹ä¸æ¨¡ä¸æ ·ï¼åªæä¸¤ä¸ªé¢å¤çæ£æ¥ç¯èã</p>
<p><strong>ç¬¬ä¸</strong>ï¼<strong>å¿é¡»å¸¦åå§å¼</strong></p>
<ul>
<li>å¨è§£æå®åéåä¹åï¼è§£æå¨ä¼ç«å»å·çä¸ä¸ä¸ª Tokenã</li>
<li>å¦æä¸æ¯ <code>=</code>ï¼</li>
<li><strong>æ²¡æåå§åï¼æ¥é</strong> æåº <code>SyntaxError: Missing initializer in const declaration</code>ã</li>
<li><code>const</code> åéåºçå¿é¡»å¸¦å¼ï¼è¿æ¯è¯­æ³å±é¢çè§å®ã</li>
</ul>
<p><strong>ç¬¬äºï¼ åªè¯»å±æ§</strong></p>
<ul>
<li>
<p>Scope æä½ï¼</p>
<p>å¨ç»è®°constçåéæ¶ï¼å®ç Mode è¢«æ è®°ä¸º kConstã</p>
<p>è¿è¡¨ç¤ºå¨ Scope çè®°å½éï¼è¿ä¸ªåéæ¯ Immutable ä¸å¯å çã</p>
<p>å¦æ AST çå¶ä»å°æ¹è¯å¾çæä¸ä¸ª Assignment èç¹å»ä¿®æ¹constå£°æçåéï¼è½ç¶è§£æé¶æ®µå¯è½ä¸ä¼ç«å»æ¥éï¼ææ¶è¦ç­å°è¿è¡æ¶ï¼ï¼ä½æ¯åç»­ä¸å®ä¼å¨åå¥åªè¯»åéçæä½æ¶ï¼è¢«æ¦æªå¹¶æéã</p>
</li>
</ul>
</li>
<li>
<p>ä¸é¢è®²äºvar let const ä¸ç§åéçè§£æãæä»¬ç»§ç»­å£°æçè§£æï¼è¿æä¸ä¸ªç±»ã</p>
<pre><code>class Hero {
  name = 'é¿ç¥';             // 1. å®ä¾å­æ®µ (Field)
  static version = '1.0';    // 2. éæå±æ§ (Static)
  
  constructor(skill) {       // 3. æé å½æ°
    this.skill = skill;
  }

  say() {                    // 4. ååæ¹æ³
    return 'ææ¯' + this.name;
  }
}
</code></pre>
<ul>
<li>
<p>ç¯å¢åå§å</p>
<p>å½è§£æå¨è¯»å°classå³é®å­çæ¶åï¼è¿æ²¡çå°åå®¹ï¼å°±å¿é¡»ååä¸ä»¶äºã</p>
<ol>
<li><strong>å¼ºå¶å¼å¯ä¸¥æ ¼æ¨¡å¼</strong>
<ul>
<li>è§£æå¨å°å½åç <code>language_mode</code> æ å¿ä½å¼ºè¡è®¾ç½®ä¸º <code>kStrict</code>ã</li>
<li>ä¸æ¦è·¨è¿ <code>Hero {</code> è¿éé¨æ§ï¼ææä¸¥æ ¼æ¨¡å¼çè§åç«å³çæï¼æ¯å¦ç¦ç¨ <code>with</code>ï¼ç¦ç¨<code>arguments</code> ååæ°ä¸åç»å®ç­ï¼ã</li>
</ul>
</li>
<li><strong>åå»ºç±»ä½ç¨å</strong>
<ul>
<li>V8 è°ç¨ <code>NewClassScope</code>ï¼åå»ºä¸ä¸ªæ°çä½ç¨åå¯¹è±¡ã</li>
<li><strong>æ·ç±ç»è®°</strong>ï¼è§£æå¨è¯»å°æ è¯ç¬¦ <code>Hero</code>ãå®ç«å»å¨è¿ä¸ªæ°çä½ç¨åéï¼å£°æä¸ä¸ªåå­å« <code>Hero</code> çåéã</li>
<li><strong>éèµ·æ¥</strong>ï¼è¿ä¸ªåéè¢«æ è®°ä¸º <code>CONST</code>ï¼å¸¸éï¼ãè¿è¡¨ç¤ºå¨ç±»ä½åé¨ï¼<code>Hero = 1</code> è¿ç§ä»£ç ä¼å¨è§£æé¶æ®µç´æ¥æ¥éã</li>
<li><strong>ç®ç</strong>ï¼è¿æ¯ä¸ºäºè®©ç±»åé¨çæ¹æ³è½å¼ç¨å°ç±»æ¬èº«ï¼èªå¼ç¨ï¼ã</li>
</ul>
</li>
<li><strong>åå§ååè¡¨</strong>
<ul>
<li>è§£æå¨å¨åå­éåå¤äºä¸ä¸ªç©ºçåè¡¨ï¼Listï¼ï¼ç¨æ¥åç±»å­æ¾å³å°åå²ä¸æ¥çä¸åé¨ä½ï¼åè¶å¸éé¸¡è¿ é¸¡ç¿  é¸¡æ åå¼æçï¼
<ul>
<li><code>instance_fields</code> (å®ä¾å­æ®µåè¡¨)ï¼å­æ¾ <code>name = ...</code> è¿ç§ã</li>
<li><code>static_fields</code> (éæå­æ®µåè¡¨)ï¼å­æ¾ <code>static version = ...</code> è¿ç§ã</li>
<li><code>properties</code> (æ¹æ³å±æ§åè¡¨)ï¼å­æ¾ <code>say()</code>, <code>constructor</code> è¿ç§ã</li>
</ul>
</li>
</ul>
</li>
</ol>
</li>
<li>
<p>å¼å§è§£æ</p>
<p>ç°å¨ï¼è§£æå¨è¿å¥å¤§æ¬å· <code>{ ... }</code>ï¼å¼å§æ«æã</p>
<p><code>name = 'é¿ç¥';</code> ââ å®ä¾å­æ®µçè§£æ</p>
<ol>
<li><strong>è¯å« Key</strong>ï¼è§£æå¨è¯»å° <code>name</code>ã</li>
<li>**å·ç **ï¼å¾åå·çä¸ç¼ï¼åç°æ¯ <code>=</code>ã</li>
<li><strong>å¤å®</strong>ï¼è¿ä¸æ¯æ¹æ³ï¼è¿æ¯ä¸ä¸ª <strong>Field (å­æ®µ)</strong>ãä¸æ²¡æ <code>static</code>ï¼æä»¥æ¯ <strong>Instance Field (å®ä¾å­æ®µ)</strong>ã</li>
<li><strong>è§£æ</strong>ï¼
<ul>
<li>è§£æå¨æ <code>=</code> åé¢ç <code>'é¿ç¥'</code> ä½ä¸ºä¸ä¸ª <strong>è¡¨è¾¾å¼</strong> è¿è¡è§£æã</li>
<li>çæä¸ä¸ª <code>Literal</code> å­ç¬¦ä¸²èç¹ã</li>
</ul>
</li>
<li><strong>åè£</strong>ï¼
<ul>
<li><strong>å³é®</strong>ï¼æ¶è´¹å®äºä»¥åï¼V8 ä¸ä¼æ <code>'é¿ç¥'</code> ç´æ¥ææãå®ä¼åå»ºä¸ä¸ª <strong>"åæå½æ°" (Synthetic Function)</strong> çå¤å£³ã</li>
<li><strong>ä¸ºä»ä¹è¦åä¸å±ï¼</strong> è¿æ¯ V8 ä¸ºäºéç¦»ä½ç¨åèéç¨çç­ç¥ãå­æ®µåå§åè¡¨è¾¾å¼éå¯è½ä¼æ <code>this</code>ï¼æèå¤æçé»è¾ãéè¿å°è£æä¸ä¸ªç¬ç«çå½æ°å£³ï¼V8 ç¡®ä¿äºå®åæé å½æ°çåæ°ï¼æ¯å¦ <code>skill</code>ï¼äºä¸å¹²æ°ï¼<strong>è¿ä¹ç¬¦å JS è§èï¼å­æ®µå®ä¹æ¬æ¥å°±çä¸è§æé å½æ°çåæ°ã</strong></li>
<li><strong>åéç¹</strong>ï¼<code>name</code> çå¼æä¹ç®ï¼è¢«å°è£æäºä¸ä¸ªå¯ä»¥å¨æªæ¥æ§è¡çå½æ°ã</li>
<li><strong>è¿ééè¦æ³¨æï¼= å·åé¢çå¼ï¼å¹¶ä¸æ¯ä¸æ¬¡æ§ä½¿ç¨ï¼æå¯è½è¢«ä½¿ç¨å¾å¤æ¬¡ï¼è½ç¶æä»¬ä¾å­ä¸­æ¯ é¿ç¥ï¼ä½æ¯  ä¹å¯è½æ¯å¶ä»åå«é»è¾çè®¡ç®å¼ï¼æä»¥ï¼æä»¬éè¦çä¸æ¯å¼ï¼èæ¯å¦ä½çæè¿ä¸ªå¼ç  æ´ä¸ªé»è¾ï¼ å æ­¤ è§£æåºæ¥ä»¥åï¼ç»å®åä¸ä¸å±å¸¦ç¬ç«ä½ç¨åçå½æ°å£³ã</strong></li>
</ul>
</li>
<li><strong>å½æ¡£</strong>ï¼æè¿ä¸ªåæå½æ°æè¿ <code>instance_fields</code> åè¡¨ã</li>
</ol>
<p><code>static version = '1.0';</code> ââ éæå­æ®µçè§£æ</p>
<ol>
<li>
<p><strong>è¯å«</strong>ï¼è¯»å° <code>static</code> å³é®å­ã</p>
</li>
<li>
<p><strong>æ è®°</strong>ï¼å¼å¯ <code>is_static</code> æ å¿ä½ã</p>
</li>
<li>
<p><strong>è¯å« Key</strong>ï¼è¯»å° <code>version</code>ã</p>
</li>
<li>
<p><strong>å·ç</strong>ï¼çå° <code>=</code>ã</p>
</li>
<li>
<p><strong>å¤å®</strong>ï¼è¿æ¯ä¸ä¸ª <strong>Static Field (éæå­æ®µ)</strong>ã</p>
</li>
<li>
<p><strong>è§£æä¸å½æ¡£</strong>ï¼</p>
<ul>
<li>è§£æ <code>'1.0'</code> çæå­ç¬¦ä¸²èç¹ã</li>
<li>åæ ·åè£æä¸ä¸ªâåæå½æ°âã</li>
<li>æè¿ <code>static_fields</code> åè¡¨ã</li>
<li><strong>æ³¨æ</strong>ï¼è¿ä¸ªåè¡¨å°æ¥æ¯è¦æå¨ <code>Hero</code> æé å½æ°å¯¹è±¡æ¬èº«ä¸çï¼ä¸æ¯æå¨ <code>this</code> ä¸çã</li>
</ul>
</li>
</ol>
<p><code>constructor(skill) { ... }</code> ââ æ ¸å¿åå®¹çè§£æ</p>
<ol>
<li><strong>è¯å«</strong>ï¼è¯»å° <code>constructor</code> å³é®å­ã</li>
<li><strong>å¤å®</strong>ï¼è¿æ¯ç±»ç <strong>æ ¸å¿æé å½æ°</strong>ã</li>
<li><strong>è§£æå½æ°ä½</strong>ï¼
<ul>
<li>è§£æåæ° <code>skill</code>ã</li>
<li>è§£æä»£ç å <code>this.skill = skill</code>ã</li>
<li>çæä¸ä¸ª <code>FunctionLiteral</code> èç¹ã</li>
</ul>
</li>
<li><strong>å½æ¡£</strong>ï¼è½ç¶å®æ¯æ ¸å¿åå®¹ï¼ä½å¨ AST ç»è£åï¼å®ææ¶è¢«å­å¨ä¸ä¸ªå« <code>constructor_property</code> çç¹æ®æ§½ä½éï¼ç­å¾åç»­çç»è£ã</li>
</ol>
<p><code>say() { ... }</code> ââ ååæ¹æ³çè§£æ</p>
<ol>
<li><strong>è¯å«</strong>ï¼è¯»å° <code>say</code>ï¼åé¢ç´§è· <code>(</code>ã</li>
<li><strong>å¤å®</strong>ï¼è¿æ¯ä¸ä¸ª <strong>Method (æ¹æ³)</strong>ã</li>
<li><strong>å±æ§æè¿°ç¬¦çæ (Property Descriptor)</strong>ï¼
<ul>
<li>è¿æ¯ç±»åå¯¹è±¡æå¤§çä¸åç¹ãV8 ä¼çç®ç</li>
<li><code>writable: true</code></li>
<li><code>configurable: true</code></li>
<li><strong><code>enumerable: false</code></strong> (ç±»çæ¹æ³é»è®¤ä¸å¯æä¸¾)</li>
</ul>
</li>
<li><strong>HomeObject ç»å®</strong>ï¼
<ul>
<li>è§£æå¨ä¼ç» <code>say</code> å½æ°æ è®°ä¸ä¸ª <code>HomeObject</code>ãè¿æ¯ä¸ºäºå¦æä½ å¨ <code>say</code> éç¨äº <code>super</code>ï¼å®ç¥éå»åªéæ¾ç¶ç±»ã</li>
</ul>
</li>
<li><strong>å½æ¡£</strong>ï¼æçæç <code>say</code> å½æ°èç¹ï¼æè¿ <code>properties</code> åè¡¨ã</li>
</ol>
</li>
<li>
<p>è¿è¡è±ç³</p>
<p>æ«æå® <code>}</code>ï¼ææçéä»¶é½æå¥½äºãé©¬ä¸å¼å§çï¼è¿å°±æ¯ä¼ è¯´ä¸­ç <strong>è±ç³</strong> è¿ç¨ã</p>
<p><strong>ç±»æ¯è¯­æ³ç³ï¼ç°å¨ï¼æä»¬è¦è±ç³ã</strong></p>
<ul>
<li>
<p>æ¹é æé å½æ°</p>
<ol>
<li>æ¿åºåæè§£æå¥½ç <code>constructor</code> å½æ°èç¹ã</li>
<li><strong>å®ä½</strong>ï¼
<ul>
<li>V8 å¯»æ¾å½æ°ä½ç <strong>èµ·å§ä½ç½®</strong>ã</li>
<li>å¦ææç»§æ¿ (<code>extends</code>)ï¼ä½ç½®å¨ <code>super()</code> è°ç¨<strong>ä¹å</strong>ï¼å ä¸º <code>super</code> è¿åå <code>this</code> è¿æ²¡åºçï¼ã</li>
<li>æ²¡æç»§æ¿ï¼ä½ç½®å°±å¨å½æ°ä½ç <strong>æåé¢</strong>ã</li>
</ul>
</li>
<li><strong>æ·»å </strong>ï¼
<ul>
<li>V8 æ <code>instance_fields</code> åè¡¨éçåå®¹æ¿åºæ¥ï¼é£ä¸ª <code>name = 'é¿ç¥'</code> çåæå½æ°ï¼ã</li>
<li>å®å°å¶è½¬åä¸ºèµå¼è¯­å¥ ASTï¼<code>this.name = 'é¿ç¥'</code>ã</li>
<li>å®æè¿æ¡è¯­å¥ <strong>æå¥</strong> å° <code>constructor</code> åæ¬çç¨æ·ä»£ç  <code>this.skill = skill</code> ä¹åã</li>
</ul>
</li>
</ol>
<p>æ­¤æ¶ï¼å¨ V8 çåå­ AST ä¸­ï¼æé å½æ°å®éä¸åæäºè¿æ ·ï¼</p>
<pre><code>// V8 åå­ä¸­çæé å½æ°ï¼ä¼ªä»£ç ï¼
function Hero(skill) {
  // --- V8 æ·»å çå­æ®µåå§åé»è¾ ---
  // æ³¨æï¼è¿éæ¯ä¸ä¸ªéå¼ç Block
  // æ¯å ä¸ºè¿éæ¯ç±åæå½æ°è½¬åçï¼åå«äºé»è¾  ä¹åå«äºç¬ç«çä½ç¨å
  this.name = 'é¿ç¥'; 
  // -----------------------------

  // --- ç¨æ·åçé»è¾ ---
  this.skill = skill;
}
</code></pre>
</li>
<li>
<p>ç»è£ ClassLiteral</p>
<p>ç°å¨æé å½æ°æ¹é å®æ¯ï¼V8 å¼å§ç»è£æç»ç <strong><code>ClassLiteral</code></strong> èç¹ã</p>
<ol>
<li><strong>æè½½æé å½æ°</strong>ï¼ææ¹é åç <code>Hero</code> å½æ°æ¾cä½ã</li>
<li><strong>æè½½ååæ¹æ³</strong>ï¼
<ul>
<li>éå <code>properties</code> åè¡¨ã</li>
<li>æ¿åº <code>say</code>ã</li>
<li>çææä»¤ï¼å¨è¿è¡æ¶ï¼å° <code>say</code> æè½½å° <code>Hero.prototype</code> ä¸ï¼å¹¶è®¾ç½® <code>enumerable: false</code>ã</li>
</ul>
</li>
<li><strong>æè½½éæå­æ®µ</strong>ï¼
<ul>
<li>éå <code>static_fields</code> åè¡¨ã</li>
<li>æ¿åº <code>version = '1.0'</code>ã</li>
<li>çææä»¤ï¼å¨ç±»åå»ºå®æåï¼ç«å»æ§è¡ <code>Hero.version = '1.0'</code>ã</li>
</ul>
</li>
<li><strong>å³èä½ç¨å</strong>ï¼ææå¼å§åå»ºç <code>ClassScope</code> å³èå°è¿ä¸ªèç¹ä¸ã</li>
</ol>
</li>
</ul>
</li>
<li>
<p>å®æå½</p>
<p>å°½ç®¡æä»¬åçæ¯ä¸ä¸ªclassï¼ä½æ¯ï¼å®éçè§£æè¿ç¨å¦ä¸</p>
<ol>
<li>å¼å¯ä¸¥æ ¼æ¨¡å¼ã</li>
<li>åå»ºä¸ä¸ªå« <code>Hero</code> çå¸¸éç¯å¢ã</li>
<li>å®ä¹ä¸ä¸ªå« <code>Hero</code> çå½æ°ã
<ul>
<li>å½æ°ä½åï¼åæ§è¡ <code>this.name = 'é¿ç¥'</code>ã</li>
<li>å½æ°ä½åï¼åæ§è¡ <code>this.skill = skill</code>ã</li>
</ul>
</li>
<li>å®ä¹ä¸ä¸ªå« <code>say</code> çå½æ°ã
<ul>
<li>æå®æå° <code>Hero.prototype</code> ä¸ï¼è®¾ä¸ºä¸å¯æä¸¾ã</li>
</ul>
</li>
<li>å®ä¹ä¸ä¸ªå« <code>version</code> çå¼ã
<ul>
<li>æå®ç´æ¥æå° <code>Hero</code> å½æ°å¯¹è±¡ä¸ã</li>
</ul>
</li>
<li>è¿åè¿ä¸ª <code>Hero</code> å½æ°ã</li>
</ol>
<p>ä½ ä¼åç°ï¼è§£æå¨æç»çæçæ¯ä¸ä¸ªè¡¨ç¤ºç±»ç <code>ClassLiteral</code>ï¼ä½ä¹æ¯ä»æ¯åå­èå·²ï¼å¶ä»çææåå®¹ï¼å·²ç»è±ç³ä¸ºå½æ°ãèµå¼ãååæè½½ è¿äºjsè¯­æ³ã</p>
<p>æä»¥ï¼ä» <strong>V8 çå®ç°</strong>ä¸æ¥è¯´ï¼ç±»è§£æçæ¬è´¨ï¼å°±æ¯è§£æå¨éè¿å¼å¥ <strong>åæå½æ°</strong> å <strong>ä»£ç æ¤å¥</strong> ç­ææ®µï¼æç°ä»£åçè¯­æ³ç³ï¼ç¿»è¯æäºåºå±å¼æè½çè§£çå½æ°ãä½ç¨ååååæä½ã</p>
</li>
</ul>
</li>
<li>
<p>æä»¬åé¢é¦åå­¦ä¹ çå°±æ¯è¯­å¥éçååºè¡¨è¾¾å¼çè§£æï¼ç¶åæ¯å£°æä¸­ç å½æ° åé ç±»ï¼ ç°å¨å°±è¿å©è¯­å¥ä¸­çå¯ä»¥ç¨å³é®å­ç©éçé¨åäºã</p>
<p>æä»¬åå°ParseStatementListItem çåæµè·¯å£ï¼å¦ææ¥ç Token ä¸æ¯ classï¼ä¸æ¯ functionï¼ä¹ä¸æ¯ var/let/constï¼é£å®æå¤§å¯è½å°±æ¯ä¸ä¸ªæ®éç è¯­å¥Statementã</p>
<p>è§£æå¨å¤§æä¸æ¥ï¼âå»å§ï¼æ¾ ParseStatementãâ</p>
<p><strong>ParseStatementæ¯è¯­å¥è§£æçæ»è°åº¦</strong></p>
<p>åºæ¯ï¼è¿æ¯æ®éè¯­å¥çæ»è°åº¦ä¸­å¿ã</p>
<p>é»è¾ï¼æ¥è¡¨ååï¼Lookahead Dispatchï¼ã</p>
<p>è§£æå¨ç¯çå½å Token çè¸ï¼çå³é®å­æ¯ä»ä¹ï¼ç¶åå³å®ç©éç»è°ï¼</p>
<ul>
<li>çå° <code>{</code>ï¼ - ç©ç» <code>ParseBlock</code>ï¼ä»£ç åï¼ã</li>
<li>çå° <code>if</code>ï¼ -ç©ç» <code>ParseIfStatement</code>ï¼æ¡ä»¶å¤æ­ï¼ã</li>
<li>çå° <code>for/while/do</code>ï¼ -ç©ç»å¾ªç¯è§£æå®¶æã</li>
<li>çå° <code>return/break/continue</code>ï¼ -ç©ç»è·³è½¬è§£æå®¶æã</li>
<li><strong>å¥å³é®å­é½ä¸æ¯ï¼</strong>ï¼æ¯å¦ <code>a = 1 + 2;</code>ï¼ -ç©ç» <strong><code>ParseExpressionStatement</code></strong>ï¼è¡¨è¾¾å¼è¯­å¥ï¼ãè¿æ¯ååºçï¼ä¹æ¯æå¸¸è§çï¼ä¹æ¯æä»¬è±äºå¤§åæ°å­¦ä¹ è¿çã</li>
</ul>
<p><strong>ä»£ç åè§£æï¼<code>{ ... }</code></strong></p>
<p>å½è§£æå¨çå° <code>{</code> æ¶ï¼å®ç¥éè¿æ¯ä¸ä¸ª <strong>Block (å)</strong>ã</p>
<p><strong>è§£ææµç¨ï¼</strong></p>
<ol>
<li><strong>æ¶è´¹</strong>ï¼åæ <code>{</code>ã</li>
<li><strong>éå½</strong>ï¼æ­¤æ¶ï¼ä»¿ä½ååå°äºä¸çèµ·æºãè§£æå¨ä¼åæ¬¡è°ç¨é£ä¸ªææææ ¸å¿çå¾ªç¯é©±å¨è ââ <strong><code>ParseStatementList</code></strong>ã
<ul>
<li><em>è¿å°±æ¯ä¸ºä»ä¹ä»£ç å¯ä»¥æ éåµå¥ï¼åéå¥åï¼å¥å¨å¥å¨å¨ã</em></li>
</ul>
</li>
<li><strong>æ¶è´¹</strong>ï¼åæ <code>}</code>ã</li>
</ol>
<p>æ³¨æï¼éæä½ç¨å (Scope Optimization)</p>
<p>è¿éæä¸ªæ¯è¾éè¦çå°æ¹ï¼æä»¬å¨åä»£ç æ¶ï¼çå° {...} å°±ä¼æ¬è½å°è§å¾ï¼âè¿æä¸ä¸ªåçº§ä½ç¨åâã</p>
<p>ä½å¨ V8 ç¼éï¼ä¸ä¸å®ã V8 éå¸¸æ æï¼å®ä¼æ ¹æ®åéçåå®¹å³å®è¦ä¸è¦å»ºå¢--åçº§ä½ç¨åã</p>
<p><strong>åºæ¯ Aï¼éæçæ¡</strong></p>
<pre><code>{
  var a = 1;
  console.log(a);
}
</code></pre>
<p>V8 æ«æè¿ä¸ªåï¼åç°éé¢åªæ varï¼æèæ®éè¯­å¥ï¼ï¼æ²¡æ let/const/classã</p>
<p>V8 ä¼æ³ï¼âæ¬¸ï¼åªæ var è¿ç§ç©¿å¢æªï¼æèåªæ¯æ®éçè®¡ç®ï¼é£ææ²¡å¿è¦ä¸é¨ç³è¯·ä¸ä¸ª BlockScope å¯¹è±¡æµªè´¹åå­äºãâ</p>
<p>ç»æå°±æ¯ è¿ä¸ª Block å¨ Scope æ ä¸æ¯ éæ çãAST ä¸è½ç¶æ Block èç¹ï¼ä½å®ä¸å¯¹åºä»»ä½ Scopeãåé a ç´æ¥ç»è®°å¨æå¨ç<strong>å½æ°ä½ç¨å</strong>éã</p>
<p><strong>åºæ¯ Bï¼å®ä½çå¢</strong></p>
<pre><code>{
  let b = 1;
}
</code></pre>
<p>V8 æ«æå°äº letã</p>
<p>V8 æ±æï¼âæ°è´µå°çå­ï¼å¿é¡»ç»å¾éãâ</p>
<p>ç»æå°±æ¯  V8 æä¼ççåå»ºä¸ä¸ª BlockScopeï¼æ b å³å¨éé¢ã</p>
<p>æä»¥ï¼<strong>ä»£ç å <code>{}</code> å¨ AST ä¸è¯å®æ¯ä¸ª Block èç¹ï¼ä½å¨ Scope æ ä¸ä¸ä¸å®æå¯¹åºçèç¹ã</strong></p>
<p>è¿ä¸ªé®é¢ï¼å¨åé¢æä»¬å¥½åå·²ç»è®²è¿ä¸¤ä¸æ¬¡äºï¼å¤è®²ä¸æ¬¡ï¼å°±å½å æ·±å°è±¡äºã</p>
<p><strong>æ¡ä»¶å¤æ­ï¼<code>if</code></strong></p>
<p>å½è§£æå¨çå° <code>if</code> æ¶ï¼ç©éç» <code>ParseIfStatement</code>ã</p>
<p><strong>è§£ææµç¨ï¼</strong></p>
<ol>
<li><strong>æ¶è´¹</strong>ï¼åæ <code>if</code>ï¼åæ <code>(</code>ã</li>
<li><strong>æ¡ä»¶</strong>ï¼è°ç¨ <code>ParseExpression</code> è§£ææ¡ä»¶ï¼æ¯å¦ <code>a &gt; 1</code>ï¼ï¼æ¿å° Condition èç¹ã</li>
<li><strong>æ¶è´¹</strong>ï¼åæ <code>)</code>ã</li>
<li><strong>Then åæ¯</strong>ï¼è°ç¨ <code>ParseStatement</code> è§£æ <code>then</code> çé¨åã</li>
<li><strong>Else åæ¯</strong>ï¼
<ul>
<li>å·çï¼åé¢æ <code>else</code> åï¼</li>
<li>æï¼åæ <code>else</code>ï¼è°ç¨ <code>ParseStatement</code> è§£æ <code>else</code> çé¨åã</li>
<li>æ²¡æï¼é£ <code>else</code> é¨åå°±æ¯ç©ºçã</li>
</ul>
</li>
</ol>
<p>éå°è¯­æ³æ­§ä¹é®é¢å¹éåªä¸ªå¢ï¼</p>
<pre><code>if (a)
  if (b) x++;
else y++;
</code></pre>
<p>è¿ä¸ª <code>else</code> å°åºå±äºåªä¸ª <code>if</code>ï¼æ¯å±äº <code>if(a)</code> è¿æ¯ <code>if(b)</code>ï¼</p>
<p>V8ä½¿ç¨ âè´ªå©ªå¹éâ ååï¼</p>
<p>else æ»æ¯å¹éæè¿çãè¿æ²¡éå¯¹çé£ä¸ª ifã</p>
<p>æä»¥å¨ AST éï¼è¿ä¸ª else æ¯æå¨åå± if (b) åé¢çãå¦æä½ æ³è®©å®å±äºå¤å±ï¼å¿é¡»æ¾å¼å°å  {}ï¼æä»¥ ï¼ä»åæ³ä¸åå°è¿äºæ­§ä¹æ¯æå¥½çã</p>
<p><strong>å¾ªç¯è§£æï¼<code>for</code></strong></p>
<p>while å do-while æ¯è¾ç®åï¼æä»¬éç¹è®²æå¤æç for å¾ªç¯ã</p>
<p>å½è§£æå¨çå° forï¼ç©éç» ParseForStatementã</p>
<p>AST çç»æï¼</p>
<p>V8 ä¼çæä¸ä¸ª ForStatement èç¹ï¼å®æ 4 ä¸ªææ§½ï¼</p>
<ol>
<li><strong>Init</strong> (åå§å)ï¼æ¯å¦ <code>let i = 0</code>ã</li>
<li><strong>Cond</strong> (æ¡ä»¶)ï¼æ¯å¦ <code>i &lt; 10</code>ã</li>
<li><strong>Next</strong> (æ­¥è¿)ï¼æ¯å¦ <code>i++</code>ã</li>
<li><strong>Body</strong> (å¾ªç¯ä½)ï¼æ¯å¦ <code>{ console.log(i) }</code>ã</li>
</ol>
<p>å¯å¯å¯ï¼è¿éåæä¸ªé¢è¯å®å®¹æè¢«åæçå°æ¹äº</p>
<p>å°±æ¯ for å¾ªç¯ä½ç¨åé®é¢ï¼V8 å¨è¿éåäºæ¯è¾å¤æçå¤çã</p>
<p>å¦æè¿éç¨çæ¯ varï¼V8 æ ¹æ¬ä¸ç®¡ï¼ç´æ¥æç»å¤å±å½æ°ä½ç¨åã</p>
<p>ä½å¦ææ¯ letï¼V8 å¿é¡»å¶é åº âå¤éä½ç¨åâ çææã</p>
<p>å¨è§£æ <code>for(let ...)</code> æ¶ï¼V8 ä¼å¨ AST å Scope æ ä¸æå»ºåº <strong>ä¸¤å±</strong> çè³ <strong>N+1 å±</strong> ä½ç¨åï¼</p>
<ol>
<li>
<p><strong>å¾ªç¯å¤´ä½ç¨å (Loop Header Scope)</strong>ï¼</p>
</li>
<li>
<p><strong>å¾ªç¯ä½ä½ç¨å (Loop Body Scope)</strong>ï¼</p>
</li>
<li>
<p><strong>è¿­ä»£ä½ç¨å (Per-Iteration Scope)</strong>ï¼</p>
</li>
</ol>
<p>ããããããçèµ·æ¥ä¼¼ä¹æºå¤æï¼å®éä¸ä¹ä¸æ¯å¾ç®åï¼æä»¥æä»¬éè¦ä»ç»èå¿çå­¦ä¹ ã</p>
<pre><code>for (var i = 0; i &lt; 3; i++) {
  setTimeout(() =&gt; console.log(i), 0);
}
</code></pre>
<p>åæè¿ä¸ªä¾å­</p>
<h4 id="ç¬¬ä¸é¶æ®µä¸»çº¿ç¨-å¾ªç¯é¶æ®µ">ç¬¬ä¸é¶æ®µï¼ä¸»çº¿ç¨ å¾ªç¯é¶æ®µ</h4>
<p>å ä¸º <code>var</code> å£°æç <code>i</code> æ²¡æåçº§ä½ç¨åï¼å®æ¯ä¸ä¸ª<strong>å¨å±åé</strong>ï¼æå½æ°ä½ç¨ååéï¼ã<strong>å¨è¿ä¸ªåå­éï¼åªæä¸ä¸ª <code>i</code>ã</strong></p>
<ol>
<li><strong>åå§å</strong>ï¼<code>i = 0</code>ã
<ul>
<li>æ£æ¥ <code>0 &lt; 3</code>ï¼æ¯çã</li>
<li>éå° <code>setTimeout</code>ï¼æµè§å¨æâæå° iâè¿ä¸ªä»»å¡è®°å¨<strong>å®ä»»å¡éå</strong>çå°æ¬æ¬ä¸ã<strong>æ³¨æï¼æ­¤æ¶ä¸æ§è¡æå°ï¼ä¹ä¸å­ i çå¼ï¼åªæ¯è®°ä¸âåå¤´è¦æ¾ i æå°âè¿ä»¶äºã</strong></li>
</ul>
</li>
<li><strong>æ­¥è¿</strong>ï¼<code>i</code> åæ <strong>1</strong>ã
<ul>
<li>æ£æ¥ <code>1 &lt; 3</code>ï¼æ¯çã</li>
<li>éå° <code>setTimeout</code>ï¼åè®°ä¸ç¬âåå¤´æ¾ i æå°âã</li>
</ul>
</li>
<li><strong>æ­¥è¿</strong>ï¼<code>i</code> åæ <strong>2</strong>ã
<ul>
<li>æ£æ¥ <code>2 &lt; 3</code>ï¼æ¯çã</li>
<li>éå° <code>setTimeout</code>ï¼åè®°ä¸ç¬âåå¤´æ¾ i æå°âã</li>
</ul>
</li>
<li><strong>æ­¥è¿ï¼å³é®æ­¥éª¤ï¼</strong>ï¼<code>i</code> åæ <strong>3</strong>ã
<ul>
<li>æ£æ¥ <code>3 &lt; 3</code>ï¼<strong>ä¸æç«ï¼</strong></li>
<li><strong>å¾ªç¯ç»æ</strong>ã</li>
</ul>
</li>
</ol>
<p><strong>éç¹æ¥äºï¼</strong> æ­¤æ¶å¾ªç¯ç»æäºï¼<strong>åé <code>i</code> åçå¨ä»ä¹å¼ï¼</strong> ç­æ¡æ¯ <strong>3</strong>ã å ä¸ºå®å¿é¡»åæ 3ï¼æ¡ä»¶å¤æ­ <code>i &lt; 3</code> æä¼å¤±è´¥ï¼å¾ªç¯æä¼åæ­¢ã</p>
<h4 id="ç¬¬äºé¶æ®µå¼æ­¥éååè°-æå°é¶æ®µ">ç¬¬äºé¶æ®µï¼å¼æ­¥éååè° æå°é¶æ®µ</h4>
<p>ç°å¨ä¸»çº¿ç¨ç©ºé²äºï¼Event Loop å¼å§å¤çåæè®°å¨å°æ¬æ¬ä¸ç <code>setTimeout</code> ä»»å¡ã</p>
<ol>
<li><strong>ç¬¬ 1 ä¸ªåè°è¿è¡</strong>ï¼<code>console.log(i)</code>ã
<ul>
<li>å®å»åå­éæ¾ <code>i</code>ã</li>
<li>è¿æ¶åç <code>i</code> æ¯å¤å°ï¼æ¯ <strong>3</strong>ã</li>
<li><strong>æå°ï¼3</strong>ã</li>
</ul>
</li>
<li><strong>ç¬¬ 2 ä¸ªåè°è¿è¡</strong>ï¼<code>console.log(i)</code>ã
<ul>
<li>å®è¿æ¯å»åä¸ä¸ªåå­å°åæ¾ <code>i</code>ã</li>
<li><code>i</code> è¿æ¯ <strong>3</strong>ã</li>
<li><strong>æå°ï¼3</strong>ã</li>
</ul>
</li>
<li><strong>ç¬¬ 3 ä¸ªåè°è¿è¡</strong>ï¼
<ul>
<li>åçï¼<strong>æå°ï¼3</strong>ã</li>
</ul>
</li>
</ol>
<p>è¿ä¸ªä¾å­çéç¹ï¼</p>
<p><strong>ä¸ï¼âå¾ªç¯å° 2 å°±ç»æäºï¼æä»¥ i åºè¯¥æ¯ 2â</strong></p>
<ul>
<li><strong>å®éæåµ</strong>ï¼å¾ªç¯ä½ç¡®å®åªæ§è¡å° <code>i=2</code> çæ¶åãä½æ¯ <code>for</code> å¾ªç¯ç <code>i++</code> æ¯å¨å¾ªç¯ä½æ§è¡<strong>ä¹å</strong>æ§è¡çãæåä¸æ¬¡ï¼<code>i</code> ä» 2 åæäº 3ï¼ç¶åå¤æ­ <code>3 &lt; 3</code> å¤±è´¥ï¼æéåºçãæä»¥ <code>i</code> çæç»å°¸ä½æ¯ 3ã</li>
</ul>
<p><strong>äºï¼âsetTimeout ä¼æè·å½æ¶ç iâ</strong></p>
<ul>
<li><strong>å®éæåµ</strong>ï¼<code>var</code> ä¸ä¼æè·å¿«ç§ãå ä¸º <code>var</code> åªæä¸ä¸ªå±äº«ç <code>i</code>ï¼é­åå¼ç¨çæ¯<strong>å¼ç¨ï¼å°åï¼</strong>ï¼èä¸æ¯<strong>å¼ï¼å¿«ç§ï¼</strong>ãç­å°æå°çæ¶åï¼å¤§å®¶é¡ºçå°åæ¾è¿å»ï¼çå°çé½æ¯é£ä¸ªå·²ç»åæ 3 ç <code>i</code>ã</li>
</ul>
<p>æä»¬åæ¥çè¿ä¸ªä¾å­</p>
<pre><code>for (var i = 0; i &lt; 3; i++) { 
  let x = i;
  setTimeout(() =&gt; console.log(x), 0); 
}
</code></pre>
<p>è¿éæä¸¤ä¸ªåéï¼</p>
<p><strong><code>var i</code></strong>ï¼<strong>å¬å±å¤§æé</strong></p>
<ul>
<li><strong>å®ä¹ä½ç½®</strong>ï¼<code>for</code> å¾ªç¯å¤´é¨ã</li>
<li><strong>æ§è´¨</strong>ï¼<strong><code>var</code></strong>ã</li>
<li><strong>ä½å</strong>ï¼å½æ°ä½ç¨åï¼æèå¨å±ï¼ãå®å°±åæå¨å¢ä¸ç<strong>å¯ä¸çä¸ä¸ªå¤§æ¶é</strong>ãä¸ç®¡å¾ªç¯è·å¤å°æ¬¡ï¼å¤§å®¶é½çè¿åä¸ä¸ªæ¶éï¼å®çæéä¸ç´å¨åï¼0 - 1 - 2 - 3ï¼ã</li>
</ul>
<p><strong><code>let x</code> ç§äººçæè¡¨</strong>ï¼</p>
<ul>
<li><strong>å®ä¹ä½ç½®</strong>ï¼å¾ªç¯ä½ <code>{ ... }</code> åé¨ã</li>
<li><strong>æ§è´¨</strong>ï¼<strong><code>let</code></strong>ã</li>
<li><strong>ä½å</strong>ï¼<strong>Block Scopeï¼åçº§ä½ç¨åï¼</strong>ãå®å°±åæ¯ä½ æéæ¿ç<strong>è®°äºæ¬</strong>ãæ¯æ¬¡å¾ªç¯ï¼V8 é½ä¼æä¸å¼ æ°ççº¸ï¼åå»ºæ°ä½ç¨åï¼ç»ä½ ã</li>
</ul>
<p>è¿ä¸ªä¾å­çæ ¸å¿é»è¾å¨äº <code>let x = i;</code>ã  å¯¹äº v8æ¥è¯´  å°±æ¯ âè¯·æå¢ä¸é£ä¸ªå¬å±æ¶éï¼iï¼å½åçæ¶é´ï¼å¤å°ä¸ä»½ï¼åå¨æè¿å¼ æ°ççº¸ï¼xï¼ä¸ãâ</p>
<h4 id="ç¬¬ä¸è½®å¾ªç¯-i--0">ç¬¬ä¸è½®å¾ªç¯ (i = 0)</h4>
<ol>
<li><strong>å¬å±æ¶é <code>i</code></strong>ï¼æå 0ã</li>
<li><strong>è¿å¥æ¿é´</strong>ï¼V8 éå° <code>{</code>ï¼åå»ºä¸ä¸ªå¨æ°ç <strong>Block Scope A</strong>ã</li>
<li><strong>æ§è¡ <code>let x = i</code></strong>ï¼
<ul>
<li>V8 å¨ Scope A éåå»ºåé <code>x</code>ã</li>
<li>è¯»åå¤é¢ç <code>i</code> (0)ã</li>
<li><strong>èµå¼</strong>ï¼<code>x = 0</code>ã</li>
</ul>
</li>
<li><strong>é­åçæ</strong>ï¼
<ul>
<li><code>setTimeout</code> éçç®­å¤´å½æ°çæã</li>
<li>å³é®ç¹ï¼å®æè·çæ¯è°ï¼æ¯ <strong>Scope A éç <code>x</code></strong>ã</li>
<li><em>æ­¤æ¶ï¼è¿ä¸ªé­åæéç´§ç´§æ¥ç x=0 çç§çã</em></li>
</ul>
</li>
</ol>
<h4 id="ç¬¬äºè½®å¾ªç¯-i--1">ç¬¬äºè½®å¾ªç¯ (i = 1)</h4>
<ol>
<li><strong>å¬å±æ¶é <code>i</code></strong>ï¼åæäº 1ï¼æ³¨æï¼i è¿æ¯é£ä¸ª iï¼åªæ¯å¼åäºï¼ã</li>
<li><strong>è¿å¥æ¿é´</strong>ï¼V8 éå° <code>{</code>ï¼åå»ºä¸ä¸ªå¨æ°ç <strong>Block Scope B</strong>ï¼å A æ²¡å³ç³»ï¼ã</li>
<li><strong>æ§è¡ <code>let x = i</code></strong>ï¼
<ul>
<li>V8 å¨ Scope B éåå»ºåé <code>x</code>ã</li>
<li>è¯»åå¤é¢ç <code>i</code> (1)ã</li>
<li><strong>èµå¼</strong>ï¼<code>x = 1</code>ã</li>
</ul>
</li>
<li><strong>é­åçæ</strong>ï¼
<ul>
<li>çæç¬¬äºä¸ªç®­å¤´å½æ°ã</li>
<li>å®æè·çæ¯ <strong>Scope B éç <code>x</code></strong>ã</li>
<li><em>è¿ä¸ªé­åæéæ¥ç x=1 çç§çã</em></li>
</ul>
</li>
</ol>
<h4 id="ç¬¬ä¸è½®å¾ªç¯-i--2">ç¬¬ä¸è½®å¾ªç¯ (i = 2)</h4>
<ol>
<li><strong>å¬å±æ¶é <code>i</code></strong>ï¼åæäº 2ã</li>
<li><strong>è¿å¥æ¿é´</strong>ï¼åå»º <strong>Block Scope C</strong>ã</li>
<li><strong>æ§è¡ <code>let x = i</code></strong>ï¼
<ul>
<li><code>x = 2</code>ã</li>
</ul>
</li>
<li><strong>é­åçæ</strong>ï¼
<ul>
<li>æè· <strong>Scope C éç <code>x</code></strong>ã</li>
<li><em>æéæ¥ç x=2 çç§çã</em></li>
</ul>
</li>
</ol>
<p><strong>å¾ªç¯ç»æäºã</strong></p>
<ul>
<li><strong>å¬å±åé <code>i</code></strong>ï¼åæäº 3ãå¦æè¿æ¶åæäººæå° <code>i</code>ï¼é£å°±æ¯ 3ã</li>
<li>åæé£ä¸ä¸ªé­åï¼å®æ¶å¨åè°ï¼ï¼æ ¹æ¬ä¸å³å¿ <code>i</code> æ¯å¤å°ã</li>
</ul>
<p>å½ 0ms ä¹åï¼å®æ¶å¨è§¦åï¼</p>
<ol>
<li><strong>åè° 1</strong>ï¼æ¿åº Scope A éç <code>x</code> - <strong>æå° 0</strong>ã</li>
<li><strong>åè° 2</strong>ï¼æ¿åº Scope B éç <code>x</code> - <strong>æå° 1</strong>ã</li>
<li><strong>åè° 3</strong>ï¼æ¿åº Scope C éç <code>x</code> - <strong>æå° 2</strong>ã</li>
</ol>
<p>è¿ä¸ªä¾å­æ¯å©ç¨äº <strong><code>let</code> å¨ Block éççå½å¨æ</strong>ã</p>
<ul>
<li><strong><code>var i</code></strong> è´è´£å¨å¤é¢è·å¨ï¼ä¸æ­ååï¼ç»´æå¾ªç¯çè¿è¡ã</li>
<li><strong><code>let x</code></strong> è´è´£å¨éé¢<strong>å®æ ¼</strong>ï¼æ¯æ¬¡å¾ªç¯é½åå»ºä¸ä¸ªæ°çå®ä¾ï¼æé£ä¸ç¬é´ç <code>i</code> å¼ç»âåºåâä¸æ¥ã</li>
</ul>
<p>ä¸é¢æ¯ç®åçè®²äºä¸ä¸var åletéåçæ­£ç¡®æ¹å¼ã ç°å¨ï¼æä»¬åå°ä½¿ç¨letçä¾å­</p>
<pre><code>for (let i = 0; i &lt; 3; i++) {
  let x = i;
  setTimeout(() =&gt; console.log(x), 0);
}
</code></pre>
<p>è¿ä¸ªææ¯æä»¬forå¾ªç¯éç¹çä¾å­ã</p>
<p>å½è§£æå¨è¯»å° <code>for (let i ...)</code> æ¶ï¼å®å¨ Scope Tree ä¸å¹¶ä¸æ¯ç®åå°æä¸ä¸ª BlockScopeï¼èæ¯æå»ºäºä¸ä¸ªç²¾å¯çå±çº§ã</p>
<h4 id="ç¬¬-1-å±å¤å±ä½ç¨å-outer-scope">ç¬¬ 1 å±ï¼å¤å±ä½ç¨å (Outer Scope)</h4>
<p>è¿æ¯ <code>for</code> å¾ªç¯æå¨çå°æ¹ï¼æ¯å¦å½æ°ä½ç¨åï¼ãæ²¡æä»ä¹ç¹æ®çã</p>
<h4 id="ç¬¬-2-å±å¾ªç¯å¤´ä½ç¨å-loop-header-scope">ç¬¬ 2 å±ï¼å¾ªç¯å¤´ä½ç¨å (Loop Header Scope)</h4>
<p><strong>è¿æ¯å³é®å±ï¼</strong></p>
<ul>
<li><strong>è¯çæ¶å»</strong>ï¼è§£æå¨è¯»å° <code>for (</code> ä¸åç°åé¢è·ç <code>let</code> æ¶ï¼ç«å»åå»ºã</li>
<li><strong>ä½æ·</strong>ï¼<strong>å¾ªç¯åé <code>i</code></strong> å°±ä½å¨è¿éã</li>
<li><strong>èè´£</strong>ï¼å®åè£¹çæ´ä¸ªå¾ªç¯ï¼åæ¬åå§åãæ¡ä»¶å¤æ­ãæ­¥è¿æä½ãå®å°±åæ¯å¾ªç¯çæ»ææ¥é¨ã</li>
</ul>
<h4 id="ç¬¬-3-å±å¾ªç¯ä½ä½ç¨å-loop-body-scope">ç¬¬ 3 å±ï¼å¾ªç¯ä½ä½ç¨å (Loop Body Scope)</h4>
<ul>
<li><strong>è¯çæ¶å»</strong>ï¼è§£æå¨è¯»å° <code>{</code> æ¶åå»ºã</li>
<li><strong>ä½æ·</strong>ï¼<strong>å¾ªç¯ä½åçåé <code>x</code></strong> ä½å¨è¿éã</li>
<li><strong>å³ç³»</strong>ï¼å®ç <code>outer</code> æéæå <strong>å¾ªç¯å¤´ä½ç¨å</strong>ã</li>
</ul>
<p>ä¸ºäºæ»¡è¶³âæ¯æ¬¡å¾ªç¯é½æ¯æ° <code>i</code>âçåæè¦æ±ï¼V8 ä¼ææçæä»£ç è¿è¡éå</p>
<pre><code>ä¼ªä»£ç 

{ // 1. å¾ªç¯å¤´ä½ç¨å (Header Scope)
  let i = 0; // çæ­£ç i å£°æå¨è¿é

  // å¾ªç¯å¼å§
  loop_start:
  if (i &lt; 3) {
      
      // 2. [v8å·æ¸æ½æ³] è¿­ä»£ä½ç¨å (Iteration Scope)
      // V8 ä¼å¨æ¯æ¬¡è¿å¥å¾ªç¯ä½åï¼ææçåå»ºä¸ä¸ªæ°ä½ç¨å
      // å¹¶ä¸æå½åç i å¼ï¼"å¤å°" ç»ä¸ä¸ªä¸´æ¶åé
      { 
         let _k = i; // å½±å­åéï¼æè·å½åç i
         
         // 3. å¾ªç¯ä½ä½ç¨å (Body Scope)
         {
            let x = _k; // ç¨æ·åç x = iï¼å®éä¸åæäº x = _k
            setTimeout(() =&gt; console.log(x), 0);
         }
      }

      // æ­¥è¿æä½
      i++; 
      goto loop_start;
  }
}
</code></pre>
<p>è¿æ®µä¼ªä»£ç å¾ç®åï¼è§£æå¨å¨åæä½ç¨åæ¶ï¼è¯å«åº for å¤´é¨å®ä¹äº letï¼å¹¶ä¸å¾ªç¯ä½åæé­åå¼ç¨äºè¿ä¸ª letã</p>
<p>äºæ¯ï¼å®ææå¼å¯èªå·±çé­æ³-è¿­ä»£çä½ç¨å</p>
<p>æä»¥</p>
<ol>
<li><strong>ç©çä¸</strong>ï¼<code>i</code> ç¡®å®åªæä¸ä¸ªï¼å¨ Header Scope éï¼ä¸æ­ <code>++</code> åæ 0, 1, 2, 3ã</li>
<li><strong>é»è¾ä¸</strong>ï¼æ¯æ¬¡è¿å¥å¤§æ¬å·ï¼V8 é½ä¼å·å·åå»ºä¸ä¸ª <strong>å½±å­ä½ç¨å</strong>ã</li>
<li><strong>å¤å°</strong>ï¼å¨è¿ä¸ªå½±å­ä½ç¨åéï¼V8 ä¼ææ­¤å»ç <code>i</code> çå¼ï¼èµå¼ç»ä¸ä¸ªæ°çéèåé  ä¼ªä»£ç éæä»¬å«å® <code>_k</code> ã</li>
<li><strong>æè·</strong>ï¼å¾ªç¯ä½éçé­åï¼å®éä¸æè·çä¸æ¯é£ä¸ªä¸ç´å¨åç <code>i</code>ï¼èæ¯è¿ä¸ª <strong>æ°¸è¿ä¸ä¼åçå½±å­åé <code>_k</code></strong>ã</li>
</ol>
<p>ä¸é¢ï¼æä»¬åè¯¦ç»çèµ°ä¸ä¸æµç¨ï¼</p>
<p><strong>æ­¥éª¤ 1ï¼è§£æå¤´é¨ <code>for (let i = 0;</code></strong></p>
<ul>
<li><strong>æ¶è´¹</strong>ï¼<code>for</code>, <code>(</code>, <code>let</code>, <code>i</code>ã</li>
<li><strong>Scope æä½</strong>ï¼åå»º <strong>Loop Header Scope</strong>ã</li>
<li><strong>ç»è®°</strong>ï¼å¨ Header Scope éç»è®°åé <code>i</code>ã</li>
<li><strong>AST</strong>ï¼çæ <code>ForStatement</code> èç¹ï¼æ <code>let i = 0</code> æå¨ Init ææ§½ã</li>
</ul>
<p><strong>æ­¥éª¤ 2ï¼è§£ææ¡ä»¶ä¸æ­¥è¿ <code>; i &lt; 3; i++)</code></strong></p>
<ul>
<li><strong>è§£æ</strong>ï¼å¨ Header Scope çç¯å¢ä¸è§£æ <code>i &lt; 3</code> å <code>i++</code>ã</li>
<li><strong>å³è</strong>ï¼è¿éç <code>i</code> æå Header Scope éç <code>i</code>ã</li>
</ul>
<p><strong>æ­¥éª¤ 3ï¼è§£æå¾ªç¯ä½ <code>{ ... }</code></strong></p>
<ul>
<li><strong>æ¶è´¹</strong>ï¼<code>{</code>ã</li>
<li><strong>Scope æä½</strong>ï¼åå»º <strong>Loop Body Scope</strong>ã</li>
<li><strong>è¿æ¥</strong>ï¼Body Scope çç¸ç¸æ¯ Header Scopeã</li>
</ul>
<p><strong>æ­¥éª¤ 4ï¼è§£æ <code>let x = i</code></strong></p>
<ul>
<li><strong>ç»è®°</strong>ï¼å¨ Body Scope éç»è®°åé <code>x</code>ã</li>
<li><strong>æ¥æ¾ <code>i</code></strong>ï¼
<ul>
<li>Body Scope éæ <code>i</code> åï¼æ ã</li>
<li>Header Scope éæ <code>i</code> åï¼æï¼</li>
<li><strong>å³é®å¤å®</strong>ï¼è§£æå¨åç° <code>i</code> æ¯ Header Scope éç <code>let</code> åéï¼èä¸æ­£å¨è¢«åé¨ä½ç¨åå¼ç¨ã</li>
<li><strong>æä¸ªæ è®°</strong>ï¼è§£æå¨ç» <code>i</code> æä¸ <strong>"éæè¿­ä»£æ·è´ (Copy on Iteration)"</strong> çæ ç­¾ã</li>
</ul>
</li>
</ul>
<p><strong>æ­¥éª¤ 5ï¼è§£æé­å <code>setTimeout(...)</code></strong></p>
<ul>
<li>é­åå¼ç¨äº <code>x</code>ã</li>
<li><code>x</code> å¼ç¨äº <code>i</code>ï¼å®éä¸æ¯é£ä¸ªå½±å­ç <code>i</code>ï¼ã</li>
<li>è§£æå¨ç¡®è®¤ï¼è¿ä¸ä»æ¯ä¸ªé­åï¼è¿æ¯ä¸ª <strong>Loop éçé­å</strong>ãå¿é¡»å¼ºå¶æè¿äºåéåéå° <strong>å åå­ (Context)</strong> ä¸­ï¼ä¸è½çå¨æ ä¸ã</li>
</ul>
<p>è¿ä¸ªforè®²èµ·æ¥å¾è´¹å²çå§</p>
<p>æ¯å ä¸º<strong>è¡¨é¢ä¸</strong>åªå£°æäºä¸ä¸ª <code>i</code>ï¼</p>
<p>ä½<strong>å®éä¸ï¼AST/Scopeï¼</strong>     V8 æå»ºäº <strong>Header Scope</strong>ï¼æ¾çæ­£ç <code>i</code>ï¼å <strong>Body Scope</strong>ï¼æ¾å¾ªç¯ä½ï¼ã</p>
<p><strong>è¿è¡çæ¶å</strong>   V8 éè¿ <strong>å½±å­åéæ·è´ææ¯</strong>ï¼å¨æ¯ä¸è½®å¾ªç¯éé½çæäºä¸ä¸ªæ°çãåªå±äºè¿ä¸è½®ç <code>i</code> çå¯æ¬ãé­åéæ­»çæ¯è¿ä¸ªå¯æ¬ï¼èä¸æ¯å¤é¢é£ä¸ªä¸ç´å¨åçæ¬ä½ã</p>
<p>æä»¬ä¹ç©ä¸ªéï¼ç©ç»è§èï¼</p>
<p><strong>ä¸ºä»ä¹ <code>for (let ...)</code> æ¯ <code>for (var ...)</code> å¤æï¼</strong><br>
å ä¸º<strong>è§èè¦æ±</strong>å¯¹ <code>let</code> å¾ªç¯åéå®ç° <em>per-iteration</em>ï¼æ¯æ¬¡è¿­ä»£ï¼è¯­ä¹ï¼<strong>è¡¨é¢ä¸ä½ åªåäºä¸ä¸ª <code>i</code>ï¼ä½æ¯è½®è¿­ä»£è¦è¡¨ç°ä¸ºä¸ä¸ªæ°çç»å®å¯æ¬</strong>ï¼ä»¥ä¾¿é­åæè·å°çæ¯è¯¥è½®çå¿«ç§ã<code>var</code> æ²¡æåçº§ç»å®ï¼å®æ¯å½æ°/å¨å±ä½ç¨åçå±äº«ç»å®ï¼ï¼å æ­¤ä¸ä¼äº§çå¿«ç§ææã</p>
<p><strong>è·³è½¬è¯­å¥ï¼<code>return</code></strong></p>
<p>return<code>ã</code>break<code>ã</code>continue çè§£æé»è¾é½å¾ç´ç½ï¼âåæå³é®å­ --æ£æ¥åå·âã</p>
<p>ä½ <code>ParseReturnStatement</code> æä¸ä¸ªå·¨å¤§çåï¼å«å <strong>ASI (èªå¨åå·æå¥)</strong>ã</p>
<p>çè¿æ®µ</p>
<pre><code>return
true;
</code></pre>
<p>è§£æå¨è¯»å° <code>return</code> åï¼å®çå¨ä½æ¯è¿æ ·çï¼</p>
<ol>
<li><strong>å·ç</strong>ï¼å·çä¸ä¸ä¸ª Tokenã</li>
<li><strong>åç°</strong>ï¼ååï¼æ¯ä¸ä¸ª <strong>æ¢è¡ç¬¦ (LineTerminator)</strong>ã</li>
<li><strong>å¤å®</strong>ï¼æ ¹æ® JS è¯­æ³è§åï¼<code>return</code> åé¢ä¸è½è·æ¢è¡ç¬¦ãæ¢ç¶ä½ æ¢è¡äºï¼æå°±å½ä½ åå®äºã</li>
<li><strong>æå¥</strong>ï¼V8 å¼ºè¡å¨è¿éæå¥ä¸ä¸ªåå· <code>;</code>ã</li>
<li><strong>ç»æ</strong>ï¼ä»£ç åæäº <code>return;</code>ï¼è¿å <code>undefined</code>ï¼ãä¸é¢ç <code>true;</code> åæäºæ°¸è¿æ§è¡ä¸å°çåºè¯ã</li>
</ol>
<p>è¿å°±æ¯ä¸ºä»ä¹è¦å¼ºè°çï¼<strong><code>return</code> çå¼åä¸å«æ¢è¡åï¼</strong></p>
<p><strong>ååºï¼è¡¨è¾¾å¼è¯­å¥</strong></p>
<p>è¿ä¸ªå°±ä¸ç¨è®²äºï¼é½è®²çå¤´æäºã</p>
<hr>
<p>åæ¬æ¯æ³å¨é¨åå®ä»¥åååçï¼ä½æ¯ç°å¨è§£æç¯åå®å°±å·²ç»ä¸ä¸äºåå¤å­äºï¼ç¯å¹å¤ªå¤§ï¼ä¸ç¥éåæç« ææ²¡æåç¯å­æ°éå¶ï¼å°±ä¸ç¯ä¸ç¯çåå§ã</p>
<p>è³æ­¤<strong>è§£æç¯</strong> çåå®¹å¨é¨ç»æã</p>
</li>
</ol>
<p>éæçæç¨ç»æäºã æ¥ä¸æ¥ï¼æ¯ä¸ä¸ªæ°çå¼å§-------------Ignition è§£éå¨ç¯ã</p>
<p>æ¬æé¦åäºï¼ <a href="https://juejin.cn/post/7578705123208708139" target="_blank" rel="noopener nofollow">æéç¤¾åº</a></p>
<p>åæ­¥åè¡¨äºï¼ <a href="https://blog.csdn.net/f20171110/article/details/155758607?spm=1001.2014.3001.5502" target="_blank" rel="noopener nofollow">csdn</a></p>
<p><a href="https://www.cnblogs.com/f20171110" target="_blank">åå®¢å­</a></p>
<p><strong>ç å­è½ä¸æ ç¥è¯èç»çæ¢³çæ´æ¯ä¸æ ï¼ä½æ¯ç¥è¯çä¼ æ­æ´éè¦ï¼</strong></p>
<p><strong>æ¬¢è¿è½¬è½½ï¼è¯·ä¿æå¨æå®æ´ã</strong></p>
<p><strong>è°¢ç»çæ®µæå½ã</strong></p>
<p>åèèµæï¼</p>
<p><a href="https://github.com/v8/v8" target="_blank" rel="noopener nofollow">https://github.com/v8/v8</a></p>
<p><a href="https://v8.dev/blog" target="_blank" rel="noopener nofollow">https://v8.dev/blog</a></p>
<p><a href="https://v8.dev/blog/scanner" target="_blank" rel="noopener nofollow">https://v8.dev/blog/scanner</a></p>
<p><a href="https://v8.dev/blog/preparser" target="_blank" rel="noopener nofollow">https://v8.dev/blog/preparser</a></p>
<p><a href="https://tc39.es/ecma262/" target="_blank" rel="noopener nofollow">https://tc39.es/ecma262/</a></p>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2025-12-29 18:18">2025-12-29 18:17</span>&nbsp;
<a href="https://www.cnblogs.com/f20171110">ç¨æ·æ°</a>&nbsp;
éè¯»(<span id="post_view_count">0</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19417566);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19417566', targetLink: 'https://www.cnblogs.com/f20171110/p/19417566', title: 'V8å¼æ ç²¾åæ¼«æ¸¸æå -è§£æç¯  è¯­æ³è§£æ AST ä½ç¨å é­å å­èç  ä¼å ä¸æéå³' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ åç»åç«¯çè¡ç¥¨è¡æ SDK: stock-sdkï¼ç»äºä¸ç¨åæ±åç«¯å¸®å¿äº ]]></title>
    <link>https://www.cnblogs.com/chengzp/p/19417561/stock-sdk</link>
    <guid>dad89fdcfcc5a925e94a7e158299aa65</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/chengzp/p/19417561/stock-sdk" title="åå¸äº 2025-12-29 18:16">
    <span role="heading" aria-level="2">Stockåç»åç«¯çè¡ç¥¨è¡æ SDK: stock-sdkï¼ç»äºä¸ç¨åæ±åç«¯å¸®å¿äº</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                    <div id="cnblogs_post_description" style="display: none">
        <img src="https://img2024.cnblogs.com/blog/1265396/202512/1265396-20251229181351247-1080670278.png" alt="Stockåç»åç«¯çè¡ç¥¨è¡æ SDK: stock-sdkï¼ç»äºä¸ç¨åæ±åç«¯å¸®å¿äº" class="desc_img">
        ä½èèªå·±å¨æåäºä¸ä¸ª JavaScript/TypeScript çæ¬çè¡ç¥¨è¡æ SDKãæç« ä»ç»äºè¿ä¸ª SDK è½è·å A è¡ãæ¸¯è¡ãç¾è¡çå®æ¶è¡æå K çº¿æ°æ®ï¼è¿åç½®äºå¸¸ç¨çææ¯ææ è®¡ç®ï¼æ¯ææµè§å¨å Node.js åç«¯è¿è¡ï¼éåç¨æ¥åè¡æçæ¿ãæ°æ®å¯è§åãéåéªè¯è¿ç±»é¡¹ç®ã
    </div>
<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<blockquote>
<p>ç¨ JavaScript è·åè¡ç¥¨æ°æ®ï¼ççæè¿ä¹é¾åï¼</p>
</blockquote>
<h2 id="èµ·å ">èµ·å </h2>
<p>è¯´å®è¯ï¼è¿ä¸ªé¡¹ç®çè¯çå®å¨æ¯è¢«é¼åºæ¥çã</p>
<p>å»å¹´ææ³åä¸ä¸ªè¡ç¥¨è¡æçæ¿ï¼å°±æ¯é£ç§ç®åçé¡µé¢ï¼è½å®æ¶æ¾ç¤ºå åªèªéè¡çæ¶¨è·ãå¬èµ·æ¥å¾ç®åå¯¹å§ï¼ä½å½æçæ­£å¼å§å¨æçæ¶åï¼æåç°äºææ²¡é£ä¹ç®åã</p>
<p>ç½ä¸æä¸åï¼è¡ç¥¨æ°æ®æ¥å£ç¸å³çå·¥å·å ä¹å¨æ¯ Python çãAkShareãTushareãæééåâ¦â¦ç¡®å®çï¼åè½ä¹ç¡®å®å¨ï¼ä½é®é¢æ¯ââ<strong>ææ¯ä¸ªåç«¯å</strong>ã</p>
<p>ä¸ºäºä¸ä¸ªå°çæ¿ï¼é¾éè¦æä¸é¨æ­ä¸ä¸ª Python åç«¯ï¼ååä¸ªæ¥å£è½¬åç»åç«¯ï¼è¿ä¹å¤ªæè¾äºã</p>
<p>äºæ¯æå¼å§æ¾ææ²¡æ JavaScript è½ç¨çæ¹æ¡ãç»æä½ çæä¹çï¼ç¿»éäº npmï¼å ä¹æ¾ä¸å°ä¸ä¸ªå¥½ç¨çãæçå¹´ä¹å¤±ä¿®ï¼æçåªæ¯æ Node.js ä¸æ¯ææµè§å¨ï¼æçç±»åæ¯æä¸å¡ç³æ¶ï¼è¿æçæ¥å£è«åå¶å¦å°±æäºã</p>
<p>æ¸ç´¢äºä¸åä¹åï¼æå³å®ï¼<strong>ç®äºï¼èªå·±åä¸ä¸ªå¾äºã</strong></p>
<h2 id="stock-sdk-æ¯ä»ä¹">stock-sdk æ¯ä»ä¹ï¼</h2>
<p>ç®åè¯´ï¼<strong>stock-sdk</strong> å°±æ¯ä¸ä¸ªä¸é¨ç»åç«¯å Node.js ç¨çè¡ç¥¨è¡æ SDKã</p>
<p>æ ¸å¿ç®æ å°±ä¸ä¸ªï¼è®©ä½ ç¨æçæç JavaScript / TypeScriptï¼10 è¡ä»£ç æå®è¡ç¥¨æ°æ®è·åã</p>
<pre><code class="language-ts">import { StockSDK } from 'stock-sdk';

const sdk = new StockSDK();

const quotes = await sdk.getSimpleQuotes(['sh000001', 'sz000858', 'sh600519']);

quotes.forEach(q =&gt; {
  console.log(`${q.name}: ${q.price} (${q.changePercent}%)`);
});
</code></pre>
<p>å°±è¿ä¹ç®åãä¸ç¨æ­åç«¯ï¼ä¸ç¨è£ Pythonï¼æµè§å¨éç´æ¥è·ã</p>
<h2 id="å®è½å¹²ä»ä¹">å®è½å¹²ä»ä¹ï¼</h2>
<p>åå°ç°å¨ï¼åè½å·²ç»æ¯è¾é½å¨äºï¼</p>
<p><strong>è¡ææ°æ®</strong></p>
<ul>
<li>A è¡ãæ¸¯è¡ãç¾è¡ãå¬ååºéçå®æ¶è¡æ</li>
<li>åå² K çº¿ï¼æ¥çº¿ãå¨çº¿ãæçº¿ï¼</li>
<li>åé K çº¿ï¼1 åéå° 60 åéé½æ¯æï¼</li>
<li>å½æ¥åæ¶èµ°å¿</li>
</ul>
<p><strong>æ¿åæ°æ®</strong></p>
<ul>
<li>è¡ä¸æ¿åãæ¦å¿µæ¿åçåè¡¨åå®æ¶è¡æ</li>
<li>æ¿åæåè¡</li>
<li>æ¿å K çº¿æ°æ®</li>
</ul>
<p><strong>ææ¯ææ </strong></p>
<ul>
<li>åç½® MAãMACDãBOLLãKDJãRSI ç­å¸¸ç¨ææ </li>
<li>ä¸ä¸ªæ¥å£æå® K çº¿ + ææ è®¡ç®</li>
</ul>
<p><strong>æ©å±æ°æ®</strong></p>
<ul>
<li>èµéæµå</li>
<li>çå£å¤§å</li>
<li>A è¡äº¤ææ¥å</li>
</ul>
<p><strong>æ¹éè½å</strong></p>
<ul>
<li>ä¸æ¬¡æ§è·åå¨å¸åº 5000+ åª A è¡è¡æ</li>
<li>åç½®å¹¶åæ§å¶ï¼ä¸ä¼ææ¥å£ææ</li>
<li>è¿åº¦åè°ï¼ç¥éå½åæåå°åªéäº</li>
</ul>
<h2 id="ä¸ºä»ä¹è¦ç¨å®">ä¸ºä»ä¹è¦ç¨å®ï¼</h2>
<p>è¯´å®è¯ï¼è¿ä¸ªé®é¢æèªå·±ä¹æ³è¿å¾ä¹ãæ¯ç«å¸é¢ä¸ä¸æ¯æ²¡æå¶ä»æ¹æ¡ã</p>
<p>ä½ä»ç»æ³æ³ï¼stock-sdk ç¡®å®è§£å³äºä¸äºçç¹ï¼</p>
<p><strong>1. é¶ä¾èµï¼ççå¾å°</strong></p>
<p>åç¼©åä¸å° 20KBãæ²¡æä¹±ä¸å«ç³çä¾èµï¼ä¸ä¼ç»ä½ çé¡¹ç®å¢å é¢å¤è´æã</p>
<p><strong>2. æµè§å¨å Node.js é½è½è·</strong></p>
<p>è¿ä¸ªæ¯æä¸å¼å§å°±ç¡®å®çè®¾è®¡ç®æ ãä¸ç®¡ä½ æ¯å Web é¡µé¢è¿æ¯ Node.js èæ¬ï¼é½è½ç´æ¥ç¨ãåæ¶æä¾ ESM å CommonJS ä¸¤ç§æ ¼å¼ï¼ç°ä»£é¡¹ç®åèé¡¹ç®é½å¼å®¹ã</p>
<p><strong>3. TypeScript ç±»åå®æ´</strong></p>
<p>è¯´ççï¼ç±»åæç¤ºè¿ä¸ªä¸è¥¿ï¼ç¨è¿å°±åä¸å»äºãæ¯ä¸ªæ¥å£è¿åä»ä¹å­æ®µãæ¯ä¸ªåæ°æ¯ä»ä¹ç±»åï¼IDE éä¸ç®äºç¶ãåä»£ç çæ¶åä¸ç¨åå¤æ¥ææ¡£ã</p>
<p><strong>4. æ¥å£ç¨³å®</strong></p>
<p>æ°æ®æºç¨çæ¯è¾è®¯è´¢ç»åä¸æ¹è´¢å¯çå¬å¼æ¥å£ï¼ç¨³å®æ§è¿æ¯æä¿éçãèä¸æåäºæ¯è¾å®åçéè¯¯å¤çï¼ä¸ä¼å ä¸ºæä¸ªè¯·æ±å¤±è´¥å°±æ´ä¸ªå´©æã</p>
<h2 id="éåä»ä¹åºæ¯">éåä»ä¹åºæ¯ï¼</h2>
<p>è¿ä¸ª SDK ä¸æ¯ä¸è½çï¼æä¹ä¸æç®æå®åæå¤§èå¨çä¸è¥¿ãå®æ¯è¾éåè¿äºåºæ¯ï¼</p>
<ul>
<li><strong>è¡ç¥¨çæ¿</strong>ï¼åä¸ä¸ªèªéè¡é¡µé¢ï¼ççæ¶¨è·</li>
<li><strong>æ°æ®å¯è§å</strong>ï¼ç¨ ECharts æè TradingView ç» K çº¿å¾</li>
<li><strong>å­¦ä¹  Demo</strong>ï¼éèè¯¾ç¨ãéåå¥é¨çæ¼ç¤ºé¡¹ç®</li>
<li><strong>éåéªè¯</strong>ï¼å¿«ééªè¯ä¸ä¸ªäº¤æç­ç¥çæ³æ³</li>
<li><strong>å®æ¶èæ¬</strong>ï¼Node.js å®æ¶æåè¡ææ°æ®</li>
</ul>
<p>å¦æä½ éè¦æ´ä¸ä¸çéååæµãé«é¢äº¤æä¹ç±»çï¼è¿ä¸ª SDK å¯è½å°±ä¸å¤ªå¤ç¨äºãé£ç§åºæ¯è¿æ¯ Python çææ´æçã</p>
<h2 id="ä¸äºå®éçä¾å­">ä¸äºå®éçä¾å­</h2>
<p><strong>è·åå¨å¸åº A è¡è¡æ</strong></p>
<pre><code class="language-ts">const allQuotes = await sdk.getAllAShareQuotes({
  batchSize: 300,
  concurrency: 5,
  onProgress: (completed, total) =&gt; {
    console.log(`è¿åº¦: ${completed}/${total}`);
  },
});

console.log(`å±è·å ${allQuotes.length} åªè¡ç¥¨`);
</code></pre>
<p>5000 å¤åªè¡ç¥¨ï¼å ç§éå°±æå®äºãå¹¶åæ§å¶æ¯åç½®çï¼ä¸ç¨èªå·±æå¿ã</p>
<p><strong>è·åå¸¦ææ¯ææ ç K çº¿</strong></p>
<pre><code class="language-ts">const data = await sdk.getKlineWithIndicators('sh600519', {
  period: 'daily',
  count: 100,
  indicators: {
    ma: { periods: [5, 10, 20] },
    macd: true,
    boll: true,
  },
});

// data.kline æ¯åå§ K çº¿
// data.indicators.ma æ¯åçº¿æ°æ®
// data.indicators.macd æ¯ MACD æ°æ®
// data.indicators.boll æ¯å¸æå¸¦æ°æ®
</code></pre>
<p>ä¸ä¸ªæ¥å£æ K çº¿åææ é½ç®å¥½äºï¼ç´æ¥æ¿å»ç»å¾å°±è¡ã</p>
<h2 id="åå¨æå">åå¨æå</h2>
<p>è¿ä¸ªé¡¹ç®ä»å»å¹´å¼å§åï¼æ­æ­ç»­ç»­ç»´æ¤å°ç°å¨ï¼åè½ä¹è¶æ¥è¶å®åäºã</p>
<p>å¶å®æä¸ç´è§å¾ï¼å·¥å·è¿ä¸ªä¸è¥¿ï¼å¥½ä¸å¥½ç¨èªå·±ææ¸æ¥ãstock-sdk å°±æ¯æèªå·±å¨ç¨çä¸è¥¿ï¼éå°é®é¢å°±ä¿®ï¼éè¦æ°åè½å°±å ã</p>
<p>å¦æä½ ä¹æ¯åç«¯ï¼ä¹éè¦è·åè¡ç¥¨æ°æ®ï¼ä¸å¦¨è¯è¯ãæé®é¢æ¬¢è¿æ Issueï¼æä¼å°½éååºã</p>
<hr>
<p><strong>ç¸å³é¾æ¥</strong></p>
<ul>
<li>ð¦ <a href="https://www.npmjs.com/package/stock-sdk" target="_blank" rel="noopener nofollow">NPM</a></li>
<li>ð <a href="https://github.com/chengzuopeng/stock-sdk" target="_blank" rel="noopener nofollow">GitHub</a></li>
<li>ð <a href="https://stock-sdk.linkdiary.cn/" target="_blank" rel="noopener nofollow">å®æ¹ææ¡£</a></li>
<li>ð® <a href="https://stock-sdk.linkdiary.cn/playground/" target="_blank" rel="noopener nofollow">å¨çº¿æ¼ç¤º</a></li>
</ul>
<p>å®è£å°±ä¸è¡å½ä»¤ï¼</p>
<pre><code class="language-bash">npm install stock-sdk
</code></pre>
<p>å¦æè§å¾è¿ä¸éï¼ç»ä¸ª Star â­ å~</p>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2025-12-29 18:16">2025-12-29 18:16</span>&nbsp;
<a href="https://www.cnblogs.com/chengzp">ç¨åºç¿çç¨</a>&nbsp;
éè¯»(<span id="post_view_count">0</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19417561);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19417561', targetLink: 'https://www.cnblogs.com/chengzp/p/19417561/stock-sdk', title: 'Stockåç»åç«¯çè¡ç¥¨è¡æ SDK: stock-sdkï¼ç»äºä¸ç¨åæ±åç«¯å¸®å¿äº' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ åºäº Git æä¸ªåæ¯åå»ºä¸ä¸ªå¨æ°çä»åºï¼GitHub / GitLabï¼ ]]></title>
    <link>https://www.cnblogs.com/foury/p/19417533</link>
    <guid>11123bd1ca3fc979b5485a042a79688a</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/foury/p/19417533" title="åå¸äº 2025-12-29 18:10">
    <span role="heading" aria-level="2">åºäº Git æä¸ªåæ¯åå»ºä¸ä¸ªå¨æ°çä»åºï¼GitHub / GitLabï¼</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h1 id="åºäº-git-æä¸ªåæ¯åå»ºä¸ä¸ªå¨æ°çä»åºgithub--gitlab">åºäº Git æä¸ªåæ¯åå»ºä¸ä¸ªå¨æ°çä»åºï¼GitHub / GitLabï¼</h1>
<p><strong>èæ¯:</strong> æè¿ææ°çé¡¹ç®ï¼éè¦åºäºåé¡¹ç®çæä¸ªåæ¯å¼åï¼ç°å¨æ³è¦å°GitHub(æGitLab)ä»åºä¸­çè¿ä¸ªåæ¯æååºæ¥ï¼åç¬æä¸ºä¸ä¸ªæ°çä»åºã</p>
<p><strong>å·¥å·ï¼</strong> Git</p>
<ul>
<li>åä»åºï¼old-repo</li>
<li>ååæ¯ï¼develop-drone</li>
<li>æ°ä»åºï¼new-repo</li>
<li>ç®æ åæ¯ï¼develop</li>
</ul>
<h2 id="æ­¥éª¤ä¸åéååæ¯å°æ¬å°">æ­¥éª¤ä¸ï¼åéååæ¯å°æ¬å°</h2>
<p>å¨æ¬å°æ¾ä¸ä¸ªæä»¶å¤¹ï¼æ§è¡ä¸åå½ä»¤ï¼åéååæ¯ï¼</p>
<pre><code class="language-bash">git clone -b develop-drone --single-branch &lt;your-old-repo-address&gt; old-repo

cd old-repo
</code></pre>
<ul>
<li><code>-b develop-drone</code> è¡¨ç¤ºåéå®æåï¼æ¬å°ä»åºé»è®¤æ£åºï¼checkoutï¼å° <strong>develop-drone</strong> åæ¯</li>
<li><code>--single-branch</code> åªåéæå®åæ¯ï¼ä¸æåå¶å®åæ¯çåå²</li>
</ul>
<h2 id="æ­¥éª¤äºä¿®æ¹åæ¯åç§°">æ­¥éª¤äºï¼ä¿®æ¹åæ¯åç§°</h2>
<p>å¦æä½ å¸ææ¬åæ¯å¨æ°ä»åºä¸­æä¸º<code>develop</code>åæ¯ï¼</p>
<pre><code class="language-bash">git branch -m develop
</code></pre>
<h2 id="æ­¥éª¤ä¸åæ¢å°æ°ä»åº">æ­¥éª¤ä¸ï¼åæ¢å°æ°ä»åº</h2>
<ol>
<li>å é¤åä»åºçè¿ç¨å°åï¼</li>
</ol>
<pre><code class="language-bash">git remote remove origin
</code></pre>
<ol start="2">
<li>æ·»å æ°ä»åºçè¿ç¨å°å</li>
</ol>
<pre><code class="language-bash">git remote add origin &lt;your-new-repo-address&gt;
</code></pre>
<h2 id="æ­¥éª¤åæ¨éå°æ°ä»åº">æ­¥éª¤åï¼æ¨éå°æ°ä»åº</h2>
<pre><code class="language-bash">git push -u origin develop
</code></pre>
<ul>
<li><code>-u</code> ææ¬å° develop åæ¯æ¨å° origin/developï¼å¹¶è®¾ä¸ºé»è®¤ä¸æ¸¸åæ¯ã</li>
<li>å®æåï¼æ°ä»åºç<code>develop</code>å°±æ¯æ¬å°developåæ¯çå®æ´åå®¹ååå²ã</li>
</ul>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2025-12-29 18:11">2025-12-29 18:10</span>&nbsp;
<a href="https://www.cnblogs.com/foury">æ·±ç´«è²çä¸åå­å·</a>&nbsp;
éè¯»(<span id="post_view_count">0</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19417533);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19417533', targetLink: 'https://www.cnblogs.com/foury/p/19417533', title: 'åºäº Git æä¸ªåæ¯åå»ºä¸ä¸ªå¨æ°çä»åºï¼GitHub / GitLabï¼' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
        </channel>
        </rss>