<?xml version="1.0" encoding="UTF-8" ?>
    <rss version="2.0">
    <channel>
        <title><![CDATA[ ä¸»é¡µ - åå®¢å­ ]]></title>
        <link><![CDATA[ https://www.cnblogs.com/ ]]></link>
        <lastBuildDate>2026-01-12T20:20:16.662Z</lastBuildDate>
        <description><![CDATA[
        ä¸»é¡µ - åå®¢å­ RSS
    ]]></description>
        <language>zh-cn</language>
        <item>
    <title><![CDATA[ ç¡¬æ ¸å®ç¨ï¼Windowsä¸ä½¿ç¨ PowerShell ç¼åå±åç½è®¾å¤æ«æå¨ ]]></title>
    <link>https://www.cnblogs.com/zjw-blog/p/19474721</link>
    <guid>1217ae8d20af4f4c953d08dac6d6f5a7</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/zjw-blog/p/19474721" title="åå¸äº 2026-01-13 03:29">
    <span role="heading" aria-level="2">ç¡¬æ ¸å®ç¨ï¼Windowsä¸ä½¿ç¨ PowerShell ç¼åå±åç½è®¾å¤æ«æå¨</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h3 id="åè¨">åè¨</h3>
<p>å¨è¿è¡ç½ç»è°è¯æè®¾å¤ç®¡çæ¶ï¼æä»¬ç»å¸¸éè¦ç¥éå±åç½åæåªäºè®¾å¤å¨çº¿ãä¼ ç»ç <code>ping</code> å½ä»¤éä¸ªæ«æå¤ªæ¢ï¼èä¸ä¸çæ«æå·¥å·åæ¾å¾å¤§æå°ç¨ãä»å¤©ï¼æä»¬éè¿ä¸æ®µ PowerShell èæ¬ï¼å©ç¨ç½ç»åè®®çåºå±ç¹æ§ï¼æé ä¸ä¸ªå±åç½æ«æå·¥å·ã</p>
<hr>
<h3 id="åçåæä¸ºä»ä¹è¿ä¸ªèæ¬æ¯æ®é-ping-æ´å¿«æ´å">åçåæï¼ä¸ºä»ä¹è¿ä¸ªèæ¬æ¯æ®é Ping æ´å¿«ãæ´åï¼</h3>
<p>å¤§å¤æ°äººè®¤ä¸ºæ«æå±åç½å°±æ¯ç®åå°ç»æ¯ä¸ª IP åé Ping åãä½è¿ç§æ¹å¼æä¸¤å¤§å¼ç«¯ï¼</p>
<ol>
<li><strong>æçä½</strong>ï¼ç­å¾ä¸å¨çº¿çè®¾å¤è¶æ¶ä¼èè´¹å¤§éæ¶é´ã</li>
<li><strong>ä¸åç¡®</strong>ï¼è®¸å¤è®¾å¤ï¼å¦å¼å¯é²ç«å¢ç Windows çµèï¼ä¼ç¦æ ICMP åæ¾ï¼å¯¼è´ææå¨çº¿å´æ¾ç¤ºâç¦»çº¿âã</li>
</ol>
<p>æ¬èæ¬éç¨äº <strong>âå¼æ­¥æ¢æµ + ARP è¡¨è§£æâ</strong> çåéæºå¶ï¼å¶å·¥ä½åçæµç¨å¾å¦ä¸ï¼</p>
<h4 id="1-å¼æ­¥æ¢æµasynchronous-probing">1. å¼æ­¥æ¢æµï¼Asynchronous Probingï¼</h4>
<p>èæ¬å¹¶æ²¡æç­å¾æ¯ä¸ä¸ª Ping çç»æãå®ä½¿ç¨ <code>SendPingAsync</code> åç½æ®µåçææ 254 ä¸ª IP å°åå¿«éæåºæ¢æµåã</p>
<ul>
<li><strong>ç®ç</strong>ï¼æä»¬å¹¶ä¸å¨ä¹è¿äºåæ¯å¦ççæ¶å°äºåå¤ï¼å¶çæ­£çç®çæ¯<strong>è§¦åæä½ç³»ç»ç ARP å¹¿æ­</strong>ã</li>
</ul>
<h4 id="2-arp-åè®®çå¦ç¨">2. ARP åè®®çå¦ç¨</h4>
<p>å½ä½ ççµèå°è¯åå±åç½åæä¸ª IP åéæ°æ®æ¶ï¼å®é¦åéè¦ç¥éå¯¹æ¹ç MAC å°åï¼ç©çå°åï¼ãå³ä¾¿å¯¹æ¹é²ç«å¢æ¦æªäº Ping åï¼åªè¦è¯¥è®¾å¤å­å¨ï¼å®éå¸¸ä¹ä¼å¯¹ ARP è¯·æ±ååºååºã</p>
<ul>
<li><strong>ARP è¡¨</strong>ï¼ä¸æ¦è®¾å¤ååºï¼å®ç IP å MAC å°åå°±ä¼è¢«è®°å½å¨æä½ç³»ç»ç ARP ç¼å­è¡¨ä¸­ã</li>
</ul>
<h4 id="3-ç¶æå¤å®ç®æ³">3. ç¶æå¤å®ç®æ³</h4>
<p>èæ¬éè¿ <code>Get-NetNeighbor</code> æ£æ¥ç³»ç»ç ARP è®°å½ï¼å°ç¶æåä¸ºä¸ç±»å¤å®ï¼</p>
<ul>
<li><strong>Ping å¨çº¿</strong>ï¼è®¾å¤ååºäº ICMPã</li>
<li><strong>ARP å¨çº¿</strong>ï¼è®¾å¤è½ä¸ååº Pingï¼ä½å¨ ARP è¡¨ä¸­ç¶æä¸º <code>Reachable</code> æ <code>Stale</code>ã</li>
<li><strong>ç¦»çº¿</strong>ï¼ARP è¡¨æ è®°å½ææ¾ç¤ºç¼å­å¤±æã</li>
</ul>
<hr>
<h3 id="å®æ´ä»£ç ">å®æ´ä»£ç </h3>
<details>
<summary>ç¹å»æ¥ç PowerShell èæ¬ä»£ç </summary>
<pre><code class="language-bash">Write-Host "==========================================" -ForegroundColor Green
Write-Host "         å±åç½è®¾å¤æ«æå¨         " -ForegroundColor Green
Write-Host "==========================================" -ForegroundColor Green

# -----------------------------
# å¨çº¿æ£æµå½æ°ï¼æ ¸å¿ï¼
# -----------------------------
function Test-DeviceOnline {
    param([string]$IP)
    $arp = Get-NetNeighbor -IPAddress $IP -ErrorAction SilentlyContinue
    if (-not $arp) {
        return @{ Online = $false; Reason = "æ ARP" }
    }
    if ($arp.State -in 'Reachable','Stale','Delay','Probe') {
        if (Test-Connection $IP -Count 1 -Quiet -ErrorAction SilentlyContinue) {
            return @{ Online = $true; Reason = "Ping" }
        }
        return @{ Online = $true; Reason = "ARPå¨çº¿" }
    }
    return @{ Online = $false; Reason = "ç¼å­å¤±æ" }
}

# -----------------------------
# 1. è·å IPv4 ç½å¡
# -----------------------------
$adapters = Get-NetIPAddress -AddressFamily IPv4 |
Where-Object {
    $_.IPAddress -notmatch '^127\.|^169\.254\.' -and
    $_.PrefixLength -eq 24
}

if (-not $adapters) {
    Write-Host "æªåç°å¯ç¨ IPv4 ç½å¡" -ForegroundColor Red
    Read-Host
    exit
}

# -----------------------------
# 2. çæç½æ®µ
# -----------------------------
$networks = $adapters.IPAddress |
ForEach-Object {
    if ($_ -match '^(\d+\.\d+\.\d+)\.\d+$') {
        "$($Matches[1]).0/24"
    }
} | Select-Object -Unique

# -----------------------------
# 3. éæ©ç½æ®µ
# -----------------------------
if ($networks.Count -eq 1) {
    $network = $networks[0]
    Write-Host "`nä»æ£æµå°ä¸ä¸ªç½æ®µï¼èªå¨ä½¿ç¨ï¼$network" -ForegroundColor Yellow
}
else {
    do {
        Write-Host "`næ£æµå°å¤ä¸ªç½æ®µï¼è¯·éæ©è¦æ«æçç½æ®µï¼" -ForegroundColor Cyan
        for ($i = 0; $i -lt $networks.Count; $i++) {
            Write-Host "[$($i + 1)] $($networks[$i])"
        }

        $choice = Read-Host "è¯·è¾å¥ç¼å· (1-$($networks.Count))"
        $valid  = [int]::TryParse($choice, [ref]$null) -and
                  $choice -ge 1 -and
                  $choice -le $networks.Count

        if (-not $valid) {
            Write-Host "è¾å¥æ æï¼è¯·éæ°éæ©ã" -ForegroundColor Red
        }
    } until ($valid)

    $network = $networks[$choice - 1]
}

$prefix = $network -replace '\.0/24',''

# -----------------------------
# 4. å¿«éå»ºç« ARP è¡¨
# -----------------------------
Write-Host "`n[1/2] æ­£å¨åç½æ®µ $network åéæ¢æµå (Ping)..." -ForegroundColor Cyan
foreach ($i in 1..254) {
    $p = New-Object System.Net.NetworkInformation.Ping
    [void]$p.SendPingAsync("$prefix.$i", 800)
}
Start-Sleep -Seconds 1

# -----------------------------
# 5. è·åæ¬æº IP â MAC
# -----------------------------
$localMapping = @{}
Get-NetIPAddress -AddressFamily IPv4 |
Where-Object { $_.IPAddress -notmatch '^127\.|^169\.254\.' } |
ForEach-Object {
    $adapter = Get-NetAdapter -InterfaceIndex $_.InterfaceIndex -ErrorAction SilentlyContinue
    if ($adapter) {
        $localMapping[$_.IPAddress] = $adapter.MacAddress.Replace("-", ":").ToUpper()
    }
}

# -----------------------------
# 6. è§£æ ARP è¡¨
# -----------------------------
$arpRegex = '(?&lt;IP&gt;\d{1,3}(\.\d{1,3}){3})\s+(?&lt;MAC&gt;([0-9a-f]{2}[:-]){5}[0-9a-f]{2})'
$globalArp = arp -a

$potentialIPs = @()
foreach ($line in $globalArp) {
    if ($line -match $arpRegex) {
        $ip  = $Matches.IP
        $mac = $Matches.MAC.ToUpper().Replace("-", ":")

        if ($ip.StartsWith("$prefix.") -and
            -not $localMapping.ContainsKey($ip) -and
            $ip -notmatch '\.255$') {

            $potentialIPs += [PSCustomObject]@{
                IP  = $ip
                MAC = $mac
            }
        }
    }
}

# -----------------------------
# 7. æå»ºç»æ
# -----------------------------
$finalList = @()

# æ¬æº
foreach ($ip in $localMapping.Keys) {
    if ($ip.StartsWith("$prefix.")) {
        $finalList += [PSCustomObject]@{
            IP       = "$ip*"
            MAC      = $localMapping[$ip]
            IsOnline = $true
            Reason   = "æ¬æº"
            RawIP    = $ip
        }
    }
}

Write-Host "[2/2] æ­£å¨å¤æ­è®¾å¤å¨çº¿ç¶æ..." -ForegroundColor Cyan

foreach ($dev in $potentialIPs | Select-Object -Unique IP, MAC) {
    $result = Test-DeviceOnline $dev.IP
    $finalList += [PSCustomObject]@{
        IP       = $dev.IP
        MAC      = $dev.MAC
        IsOnline = $result.Online
        Reason   = $result.Reason
        RawIP    = $dev.IP
    }
}

# -----------------------------
# 8. è¾åº
# -----------------------------
Write-Host "`n============== æ«æç»æ ==============" -ForegroundColor Cyan

$sorted = $finalList | Sort-Object {[version]$_.RawIP}

foreach ($item in $sorted) {
    $status = if ($item.IsOnline) {
		switch ($item.Reason) {
			"Ping"     { "å¨çº¿" }
			"ARPå¨çº¿"  { "å¨çº¿ï¼æªååº Pingï¼" }
			"æ¬æº"     { "æ¬æº" }
			default    { "å¨çº¿" }
		}
	} else {
		switch ($item.Reason) {
			"ç¼å­å¤±æ" { "ç¦»çº¿ï¼ç¼å­å¤±æï¼" }
			default    { "ç¦»çº¿" }
		}
	}


    $line = "{0,-20} {1,-22} {2}" -f $item.IP, $item.MAC, $status

    if ($item.IsOnline) {
        Write-Host $line -ForegroundColor Green
    } else {
        Write-Host $line -ForegroundColor DarkGray
    }
}

$online = ($finalList | Where-Object { $_.IsOnline }).Count
$total  = $finalList.Count

Write-Host "`næ«æå®æï¼$online / $total å°è®¾å¤å¨çº¿" -ForegroundColor Green
Write-Host "`næä»»æé®éåº..."
$null = [System.Console]::ReadKey()
</code></pre>
</details>
<h3 id="æ ¸å¿ä»£ç äº®ç¹è¯´æ">æ ¸å¿ä»£ç äº®ç¹è¯´æ</h3>
<h4 id="ç½æ®µèªå¨è¯å«">ç½æ®µèªå¨è¯å«</h4>
<p>èæ¬ä¼èªå¨æé¤ <code>127.0.0.1</code>ï¼åç¯å°åï¼å <code>169.254.x.x</code>ï¼èªå¨ç§æ IPï¼ï¼å¹¶æºè½è¯å«å½åæ´»è·çç½æ®µï¼æ éç¨æ·æå¨è¾å¥ IP èå´ã</p>
<h4 id="ç»æç¾åè¾åº">ç»æç¾åè¾åº</h4>
<p>ä¸ºäºæåä½¿ç¨ä½éªï¼èæ¬ä½¿ç¨äºæ ¼å¼åæä½ç¬¦ <code>-f</code>ï¼</p>
<pre><code class="language-bash">$line = "{0,-20} {1,-22} {2}" -f $item.IP, $item.MAC, $status
</code></pre>
<p>å®å¯ä»¥ç¡®ä¿è¾åºç IPãMAC å°ååç¶æå¨æ§å¶å°ä¸­å®ç¾å¯¹é½ï¼å¹¶ä½¿ç¨ç»¿è²ï¼å¨çº¿ï¼åç°è²ï¼ç¦»çº¿ï¼è¿è¡è§è§åºåã</p>
<hr>
<h3 id="å¦ä½ä½¿ç¨">å¦ä½ä½¿ç¨ï¼</h3>
<ol>
<li>å°èæ¬ä»£ç ç²è´´è¿ç¼è¾å¨ï¼æä¿å­ä¸º <code>.ps1</code> æä»¶ï¼,ç¼ç <code>UTF8 BOM</code>ãä¹å¯éè¿<a href="https://files.cnblogs.com/files/zjw-blog/LANScanner%E5%B1%80%E5%9F%9F%E7%BD%91%E6%89%AB%E6%8F%8F%E5%99%A8.zip" target="_blank">LANScannerå±åç½æ«æå¨.zip</a>é¾æ¥è¿è¡ä¸è½½</li>
<li>ä½¿ç¨powershell.exeè¿è¡ï¼å»ºè®®ä½¿ç¨powershell<a href="https://www.cnblogs.com/zjw-blog/p/19449891" target="_blank">æä»¶å³è</a>åç´æ¥è¿è¡ã</li>
</ol>
<h3 id="è¿è¡æªå¾">è¿è¡æªå¾</h3>
<p><img src="https://img2024.cnblogs.com/blog/1745057/202601/1745057-20260113032751492-35872645.png" alt="å¾ç" loading="lazy"></p>
<h3 id="æ»ç»">æ»ç»</h3>
<p>è¿ä¸ªèæ¬ä¸ä»æ¯ä¸ä¸ªå·¥å·ï¼æ´æ¯å¯¹ <strong>Layer 2ï¼æ°æ®é¾è·¯å±ï¼</strong> å <strong>Layer 3ï¼ç½ç»å±ï¼</strong> ååå·¥ä½çä¸æ¬¡å®è·µãéè¿å©ç¨ç³»ç»åºå±ç ARP ç¼å­ï¼æä»¬å®ç°äºæ¯ä¼ ç»æ«æå¨æ´é«æãæ´å·ç©¿éåçæ¢æµææã</p>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.006944444444444444" data-date-updated="2026-01-13 03:39">2026-01-13 03:29</span>&nbsp;
<a href="https://www.cnblogs.com/zjw-blog">é¨ä¸­éæ³</a>&nbsp;
éè¯»(<span id="post_view_count">6</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19474721);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19474721', targetLink: 'https://www.cnblogs.com/zjw-blog/p/19474721', title: 'ç¡¬æ ¸å®ç¨ï¼Windowsä¸ä½¿ç¨ PowerShell ç¼åå±åç½è®¾å¤æ«æå¨' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ electron39-vue3aiçµèç«¯AIæ¨¡æ¿|electron39+deepseek+vite7èå¤©aiåºç¨ ]]></title>
    <link>https://www.cnblogs.com/xiaoyan2017/p/19474565</link>
    <guid>796d4d2c5cde93687b2d477b95e5fc57</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/xiaoyan2017/p/19474565" title="åå¸äº 2026-01-12 23:54">
    <span role="heading" aria-level="2">electron39-vue3aiçµèç«¯AIæ¨¡æ¿|electron39+deepseek+vite7èå¤©aiåºç¨</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body blogpost-body-html">
<p><span style="font-size: 18px; font-family: å®ä½, &quot;Songti SC&quot;; color: rgba(0, 0, 255, 1)">2026ææ°ç å<span style="background-color: rgba(255, 255, 0, 1)">Electron39.2+Vue3.5+DeepSeek-R1</span>æ¡é¢<strong>å®¢æ·ç«¯AI</strong>æµå¼ä¼è¯å°å¸®æã</span></p>
<p><span style="font-size: 12px"><strong>electron-vue3-deepseek</strong>ï¼è·¨å¹³å°aiå®æ<span style="background-color: rgba(204, 255, 204, 1)">electron39+vite7.2+vue3+arco</span>è°ç¨<strong>deepseek-v3.2</strong>æ¥å£æ­å»ºæµå¼è¾åºaiæ¨¡æ¿ãæ¯æ<strong>æé»+æµè²</strong>çé¢ã<span style="background-color: rgba(255, 204, 255, 1)">æ·±åº¦æèãlatexå¬å¼ãmermaidå¾è¡¨è§£æãæ¬å°å­å¨å¯¹è¯</span>ç­åè½ã</span></p>
<p><img alt="360æªå¾20260111004235577" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1289798/202601/1289798-20260112225745335-506035057.png" class="lazyload"></p>
<p><img alt="p4" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1289798/202601/1289798-20260112230001432-657878801.gif" class="lazyload"></p>
<h3>ðææ¯æ </h3>
<ul>
<li><span style="font-size: 12px">å¼åå·¥å·ï¼vscode</span></li>
<li><span style="font-size: 12px">è·¨å¹³å°æ¡æ¶ï¼electron^39.2.7</span></li>
<li><span style="font-size: 12px">ææ¯æ¡æ¶ï¼vite^7.2.4+vue^3.5.24+vue-router^4.6.4</span></li>
<li><span style="font-size: 12px">AIæ¨¡åæ¡æ¶ï¼DeepSeek-V3.2 + OpenAI</span></li>
<li><span style="font-size: 12px">UIç»ä»¶åºï¼arco-design^2.57.0</span></li>
<li><span style="font-size: 12px">ç¶ææä»¶ï¼pinia^3.0.4</span></li>
<li><span style="font-size: 12px">ä¼è¯ç¼å­ï¼pinia-plugin-persistedstate^4.7.1</span></li>
<li><span style="font-size: 12px">é«äº®æä»¶ï¼highlight.js^11.11.1</span></li>
<li><span style="font-size: 12px">markdownæ¸²ææä»¶ï¼markdown-it^14.1.0</span></li>
<li><span style="font-size: 12px">æåå·¥å·ï¼electron-builder^26.0.12</span></li>
</ul>
<p><img alt="p5" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1289798/202601/1289798-20260112230157572-624247613.gif" class="lazyload"></p>
<p><img alt="p5-1" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1289798/202601/1289798-20260112230232299-1654407875.gif" class="lazyload"></p>
<h3>ð¤é¡¹ç®ç¹æ§</h3>
<ol>
<li><span style="font-size: 12px">ææ°è·¨å¹³å°Electron39æ¡æ¶ï¼æ¥å¥DeepSeek-V3.2ï¼æµå¼å¯¹è¯æ´ä¸æ»</span></li>
<li><span style="font-size: 12px">æ¯æåç§ä»£ç é«äº®/å¤å¶ä»£ç ãä¾¿äºåäº«ä»£ç çæ®µ</span></li>
<li><span style="font-size: 12px">æ¯ææé»+æµè²ä¸»é¢ãæ·±åº¦æèãä¸ä¸æå¤è½®å¯¹è¯ãæ¬å°å­å¨å¯¹è¯</span></li>
<li><span style="font-size: 12px">æ¯ækatexæ°å­¦å¬å¼</span></li>
<li><span style="font-size: 12px">æ¯æmermaidçç¹å¾/æµç¨å¾/ç±»å¾ç­å¾è¡¨</span></li>
<li><span style="font-size: 12px">æ¯ææ°çªå£æå¼å¯¹è¯éé¢çé¾æ¥</span></li>
<li><span style="font-size: 12px">éç¨arco-designç»ä»¶åºï¼ä¿è¯é£æ ¼ä¸è´æ§</span></li>
</ol>
<p><img alt="p1" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1289798/202601/1289798-20260112230518631-2113757198.gif" class="lazyload"></p>
<h3>ð½é¡¹ç®æ¡æ¶ç®å½</h3>
<p><span style="font-size: 12px">åºäº&nbsp;<span class="cnblogs_code">electron39+vite7</span>&nbsp;åå»ºé¡¹ç®æ¨¡æ¿ï¼å¯¹æ¥&nbsp;<span class="cnblogs_code">deepseek-v3.2</span>&nbsp; apiå¤§æ¨¡åï¼éç¨&nbsp;<span class="cnblogs_code">vue3 setup</span>&nbsp;è¯­æ³ç³ç¼ç å¼åã</span></p>
<p><img alt="360æªå¾20260110235013580" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1289798/202601/1289798-20260112230757821-921162360.png" class="lazyload"></p>
<blockquote>
<h3><em>Electron39-Vue3AIæ¡é¢çaiå¯¹è¯å·²ç»æ´æ°å°æçååä½åå°éºï¼æè°¢æ¯æï¼</em></h3>
<p><a href="https://mall.bilibili.com/neul-next/detailuniversal/detail.html?page=detailuniversal_detail&amp;itemsId=12195006&amp;loadingShow=1&amp;noTitleBar=1#noReffer=true&amp;msource=merchant_share" target="_blank" rel="noopener nofollow"><span style="font-size: 12px">electron39+deepseek+vite7æ¡é¢ç«¯AIæµå¼èå¤©å¯¹è¯EXE</span></a></p>
</blockquote>
<p><img alt="p2" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1289798/202601/1289798-20260112231203946-2012928850.gif" class="lazyload"></p>
<h3>é¡¹ç®éç½®.env</h3>
<p><span style="font-size: 12px">å»deepseekç½ç«ç³è¯·ä¸ä¸ªapikeyï¼æ¿æ¢æé¡¹ç®æ ¹ç®å½.envæä»¶éçkeyå­æ®µï¼å³å¯ä½éªä¸æ»è¬aiæµå¼å¯¹è¯ã</span></p>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 0, 1)"># é¡¹ç®åç§°
VITE_APPNAME </span>= 'Electron39-DeepSeek'<span style="color: rgba(0, 0, 0, 1)">

# è¿è¡ç«¯å£
VITE_PORT </span>= 3003<span style="color: rgba(0, 0, 0, 1)">

# æ¯å¦å è½½è°è¯å·¥å·devtools
VITE_DEVTOOLS </span>= <span style="color: rgba(0, 0, 255, 1)">true</span><span style="color: rgba(0, 0, 0, 1)">

# æ¯å¦æå¼è°è¯å·¥å·devtools
VITE_OPEN_DEVTOOLS </span>= <span style="color: rgba(0, 0, 255, 1)">true</span><span style="color: rgba(0, 0, 0, 1)">

# æ¯å¦å é¤çäº§ç¯å¢console
VITE_DROP_CONSOLE </span>= <span style="color: rgba(0, 0, 255, 1)">true</span><span style="color: rgba(0, 0, 0, 1)">

# DeepSeek APIéç½®
VITE_DEEPSEEK_API_KEY </span>=<span style="color: rgba(0, 0, 0, 1)"> æ¿æ¢ä¸ºä½ ç API Key</span><span style="color: rgba(0, 0, 0, 1)">
VITE_DEEPSEEK_BASE_URL </span>= https:<span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">api.deepseek.com</span></pre>
</div>
<h3>å¥å£éç½®main.js</h3>
<div class="cnblogs_code">
<pre>import { createApp } from 'vue'<span style="color: rgba(0, 0, 0, 1)">
import </span>'./style.scss'<span style="color: rgba(0, 0, 0, 1)">
import App from </span>'./App.vue'<span style="color: rgba(0, 0, 0, 1)">

import { launchApp } from </span>'@/windows/actions'

<span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> å¼å¥è·¯ç±/ç¶æéç½®</span>
import Router from './router'<span style="color: rgba(0, 0, 0, 1)">
import Pinia from </span>'./pinia'

<span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> å¼å¥æä»¶éç½®</span>
import Plugins from './plugins'<span style="color: rgba(0, 0, 0, 1)">

launchApp().then(config </span>=&gt;<span style="color: rgba(0, 0, 0, 1)"> {
  </span><span style="color: rgba(0, 0, 255, 1)">if</span>(config) {<span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> å¨å±å­å¨çªå£éç½®</span>
    window.config =<span style="color: rgba(0, 0, 0, 1)"> config
  }

  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> åå§åappå®ä¾</span>
<span style="color: rgba(0, 0, 0, 1)">  createApp(App)
  .use(Router)
  .use(Pinia)
  .use(Plugins)
  .mount(</span>'#app'<span style="color: rgba(0, 0, 0, 1)">)
})</span></pre>
</div>
<p><img alt="360æªå¾20260110235323921" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1289798/202601/1289798-20260112231649763-548880812.png" class="lazyload"></p>
<p><img alt="360æªå¾20260110235614279" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1289798/202601/1289798-20260112231745565-123182722.png" class="lazyload"></p>
<p><img alt="360æªå¾20260111000749813" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1289798/202601/1289798-20260112231811602-103133938.png" class="lazyload"></p>
<p><img alt="360æªå¾20260111002639770" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1289798/202601/1289798-20260112231843509-761558984.png" class="lazyload"></p>
<p><img alt="360æªå¾20260111004513665" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1289798/202601/1289798-20260112232119057-1038567850.png" class="lazyload"></p>
<h3>é¡¹ç®éç¨å¸å±</h3>
<p><img alt="image" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1289798/202601/1289798-20260112232146084-713352723.png" class="lazyload"></p>
<p><span style="font-size: 12px"><strong>é¡¹ç®æ´ä½ç»æå¦ä¸å¾ï¼</strong></span></p>
<p><img alt="360æªå¾20260110235013585" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1289798/202601/1289798-20260112232433274-1593541557.png" class="lazyload"></p>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">script </span><span style="color: rgba(255, 0, 0, 1)">setup</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span><span style="background-color: rgba(245, 245, 245, 1); color: rgba(0, 0, 0, 1)">
  import Titlebar from </span><span style="background-color: rgba(245, 245, 245, 1); color: rgba(0, 0, 0, 1)">'</span><span style="background-color: rgba(245, 245, 245, 1); color: rgba(0, 0, 0, 1)">@/layouts/components/titlebar/index.vue</span><span style="background-color: rgba(245, 245, 245, 1); color: rgba(0, 0, 0, 1)">'</span><span style="background-color: rgba(245, 245, 245, 1); color: rgba(0, 0, 0, 1)">
  import Sidebar from </span><span style="background-color: rgba(245, 245, 245, 1); color: rgba(0, 0, 0, 1)">'</span><span style="background-color: rgba(245, 245, 245, 1); color: rgba(0, 0, 0, 1)">@/layouts/components/sidebar/index.vue</span><span style="background-color: rgba(245, 245, 245, 1); color: rgba(0, 0, 0, 1)">'</span>
<span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">script</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>

<span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">template</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
  <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">div </span><span style="color: rgba(255, 0, 0, 1)">class</span><span style="color: rgba(0, 0, 255, 1)">="vu__container"</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
    <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">div </span><span style="color: rgba(255, 0, 0, 1)">class</span><span style="color: rgba(0, 0, 255, 1)">="vu__layout flexbox flex-col"</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
      <span style="color: rgba(0, 128, 0, 1)">&lt;!--</span><span style="color: rgba(0, 128, 0, 1)"> å¯¼èªæ  </span><span style="color: rgba(0, 128, 0, 1)">--&gt;</span>
      <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">Titlebar </span><span style="color: rgba(0, 0, 255, 1)">/&gt;</span>

      <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">div </span><span style="color: rgba(255, 0, 0, 1)">class</span><span style="color: rgba(0, 0, 255, 1)">="vu__layout-body flex1 flexbox"</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
        <span style="color: rgba(0, 128, 0, 1)">&lt;!--</span><span style="color: rgba(0, 128, 0, 1)"> ä¾§è¾¹ </span><span style="color: rgba(0, 128, 0, 1)">--&gt;</span>
        <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">Sidebar </span><span style="color: rgba(0, 0, 255, 1)">/&gt;</span>

        <span style="color: rgba(0, 128, 0, 1)">&lt;!--</span><span style="color: rgba(0, 128, 0, 1)"> å¯¹è¯åº </span><span style="color: rgba(0, 128, 0, 1)">--&gt;</span>
        <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">div </span><span style="color: rgba(255, 0, 0, 1)">class</span><span style="color: rgba(0, 0, 255, 1)">="vu__layout-main flex1"</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
          <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">router-view </span><span style="color: rgba(255, 0, 0, 1)">v-slot</span><span style="color: rgba(0, 0, 255, 1)">="{ Component, route }"</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
            <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">keep-alive</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
              <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">component </span><span style="color: rgba(255, 0, 0, 1)">:is</span><span style="color: rgba(0, 0, 255, 1)">="Component"</span><span style="color: rgba(255, 0, 0, 1)"> :key</span><span style="color: rgba(0, 0, 255, 1)">="route.path"</span> <span style="color: rgba(0, 0, 255, 1)">/&gt;</span>
            <span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">keep-alive</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
          <span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">router-view</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
        <span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">div</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
      <span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">div</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
    <span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">div</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
  <span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">div</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
<span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">template</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span></pre>
</div>
<p><img alt="001360æªå¾20260111091110026" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1289798/202601/1289798-20260112232825425-219436283.png" class="lazyload"></p>
<p><img alt="001360æªå¾20260111091146362" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1289798/202601/1289798-20260112232836954-189324599.png" class="lazyload"></p>
<p><img alt="002360æªå¾20260111091359337" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1289798/202601/1289798-20260112232855118-1586945918.png" class="lazyload"></p>
<p><img alt="002360æªå¾20260111091853610" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1289798/202601/1289798-20260112232919591-1564068051.png" class="lazyload"></p>
<p><img alt="003360æªå¾20260111212428019" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1289798/202601/1289798-20260112233015826-428717212.png" class="lazyload"></p>
<p><img alt="004360æªå¾20260111093959478" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1289798/202601/1289798-20260112233031904-66802884.png" class="lazyload"></p>
<p><img alt="004360æªå¾20260111094201625" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1289798/202601/1289798-20260112233051212-843408756.png" class="lazyload"></p>
<p><img alt="005360æªå¾20260111094511696" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1289798/202601/1289798-20260112233108787-1421844393.png" class="lazyload"></p>
<p><img alt="005360æªå¾20260111094630870" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1289798/202601/1289798-20260112233128809-789443328.png" class="lazyload"></p>
<p><img alt="009360æªå¾20260111100122262" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1289798/202601/1289798-20260112233203771-733597883.png" class="lazyload"></p>
<p><img alt="010360æªå¾20260111110033716" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1289798/202601/1289798-20260112233222883-37264862.png" class="lazyload"></p>
<p><img alt="011360æªå¾20260111110757421" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1289798/202601/1289798-20260112233250614-843513518.png" class="lazyload"></p>
<p><img alt="012360æªå¾20260111110935003" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1289798/202601/1289798-20260112233320631-1913237101.png" class="lazyload"></p>
<p><img alt="013360æªå¾20260111111004067" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1289798/202601/1289798-20260112233339425-582788510.png" class="lazyload"></p>
<p><img alt="015360æªå¾20260111111143283" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1289798/202601/1289798-20260112233400205-1400188350.png" class="lazyload"></p>
<p><img alt="360æªå¾20260111004513663" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1289798/202601/1289798-20260112233451019-1628788110.png" class="lazyload"></p>
<h3>electron39+vue3å¯¹æ¥deepseekæ·±åº¦æè</h3>
<p><img alt="image" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1289798/202601/1289798-20260112233702511-483916062.png" class="lazyload"></p>
<p><img alt="image" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1289798/202601/1289798-20260112234037227-1035065180.png" class="lazyload"></p>
<div class="cnblogs_code">
<pre>const completion =<span style="color: rgba(0, 0, 0, 1)"> await openai.chat.completions.create({
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> åä¸ä¼è¯</span>
  <span style="color: rgba(0, 128, 0, 1)">/*</span><span style="color: rgba(0, 128, 0, 1)"> messages: [
    {role: 'user', content: editorValue}
  ], </span><span style="color: rgba(0, 128, 0, 1)">*/</span>
  <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> å¤è½®ä¼è¯</span>
  messages: props.multiConversation ? historySession.value : [{role: 'user'<span style="color: rgba(0, 0, 0, 1)">, content: editorValue}],
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> deepseek-chatå¯¹è¯æ¨¡å deepseek-reasoneræ¨çæ¨¡å</span>
  model: sessionstate.thinkingEnabled ? 'deepseek-reasoner' : 'deepseek-chat'<span style="color: rgba(0, 0, 0, 1)">,
  stream: </span><span style="color: rgba(0, 0, 255, 1)">true</span>, <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> æµå¼è¾åº</span>
  max_tokens: 8192, <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> ä¸æ¬¡è¯·æ±ä¸­æ¨¡åçæ completion çæå¤§ token æ°(é»è®¤ä½¿ç¨ 4096)</span>
  temperature: 0.4, <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> ä¸¥è°¨éæ ·</span>
})</pre>
</div>
<p><strong>éækatexå¬å¼åmermaidå¾è¡¨</strong></p>
<div class="cnblogs_code">
<pre>import { katex } from "@mdit/plugin-katex"; <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> æ¯ææ°å­¦å¬å¼</span>
import 'katex/dist/katex.min.css'
<span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> æ¸²æmermaidå¾è¡¨</span>
import { markdownItMermaidPlugin } from '@/components/markdown/plugins/mermaidPlugin'</pre>
</div>
<p><strong>æ¸²æè§£æmarkdownæµæ°æ®</strong></p>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">Markdown
  </span><span style="color: rgba(255, 0, 0, 1)">:source</span><span style="color: rgba(0, 0, 255, 1)">="item.content"</span><span style="color: rgba(255, 0, 0, 1)">
  :html</span><span style="color: rgba(0, 0, 255, 1)">="true"</span><span style="color: rgba(255, 0, 0, 1)">
  :linkify</span><span style="color: rgba(0, 0, 255, 1)">="true"</span><span style="color: rgba(255, 0, 0, 1)">
  :typographer</span><span style="color: rgba(0, 0, 255, 1)">="true"</span><span style="color: rgba(255, 0, 0, 1)">
  :plugins</span><span style="color: rgba(0, 0, 255, 1)">="[
    [katex, {delimiters: 'all'}],
    [markdownItMermaidPlugin, { ... }]
  ]"</span><span style="color: rgba(255, 0, 0, 1)">
  @copy</span><span style="color: rgba(0, 0, 255, 1)">="onCopy"</span>
<span style="color: rgba(0, 0, 255, 1)">/&gt;</span></pre>
</div>
<p><img alt="010360æªå¾20260111110212061" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1289798/202601/1289798-20260112234259896-396023218.png" class="lazyload"></p>
<p><img alt="011360æªå¾20260111110721388" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1289798/202601/1289798-20260112234320614-1942369438.png" class="lazyload"></p>
<h3>AIç¼è¾å¯¹è¯æ¡</h3>
<p><img alt="image" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1289798/202601/1289798-20260112234521280-90984710.png" class="lazyload"></p>
<p><img alt="image" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1289798/202601/1289798-20260112234624286-780576975.png" class="lazyload"></p>
<p><img alt="image" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1289798/202601/1289798-20260112234725697-575231144.png" class="lazyload"></p>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">template</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
  <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">div </span><span style="color: rgba(255, 0, 0, 1)">class</span><span style="color: rgba(0, 0, 255, 1)">="v3ai__inputbox flexbox flex-col"</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
    <span style="color: rgba(0, 128, 0, 1)">&lt;!--</span><span style="color: rgba(0, 128, 0, 1)"> ç¼è¾å¨ </span><span style="color: rgba(0, 128, 0, 1)">--&gt;</span>
    <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">div </span><span style="color: rgba(255, 0, 0, 1)">class</span><span style="color: rgba(0, 0, 255, 1)">="v3ai__editor flexbox"</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
      <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">a-textarea </span><span style="color: rgba(255, 0, 0, 1)">v-model</span><span style="color: rgba(0, 0, 255, 1)">="editorText"</span><span style="color: rgba(255, 0, 0, 1)"> :auto-size</span><span style="color: rgba(0, 0, 255, 1)">="autoSize"</span><span style="color: rgba(255, 0, 0, 1)"> :spellcheck</span><span style="color: rgba(0, 0, 255, 1)">="false"</span><span style="color: rgba(255, 0, 0, 1)"> placeholder</span><span style="color: rgba(0, 0, 255, 1)">="ç» DeepSeek åéæ¶æ¯"</span><span style="color: rgba(255, 0, 0, 1)"> @input</span><span style="color: rgba(0, 0, 255, 1)">="handleInput"</span> <span style="color: rgba(0, 0, 255, 1)">/&gt;</span>
    <span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">div</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
    <span style="color: rgba(0, 128, 0, 1)">&lt;!--</span><span style="color: rgba(0, 128, 0, 1)"> æä½æ  </span><span style="color: rgba(0, 128, 0, 1)">--&gt;</span>
    <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">div </span><span style="color: rgba(255, 0, 0, 1)">class</span><span style="color: rgba(0, 0, 255, 1)">="v3ai__tools flexbox flex-alignc"</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
      <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">div </span><span style="color: rgba(255, 0, 0, 1)">class</span><span style="color: rgba(0, 0, 255, 1)">="option flex1 flexbox"</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
        <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">a-tooltip </span><span style="color: rgba(255, 0, 0, 1)">content</span><span style="color: rgba(0, 0, 255, 1)">="åæèååç­ï¼è§£å³æ¨çé®é¢"</span><span style="color: rgba(255, 0, 0, 1)"> position</span><span style="color: rgba(0, 0, 255, 1)">="top"</span><span style="color: rgba(255, 0, 0, 1)"> mini</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
          <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">div </span><span style="color: rgba(255, 0, 0, 1)">class</span><span style="color: rgba(0, 0, 255, 1)">="btn"</span><span style="color: rgba(255, 0, 0, 1)"> :class</span><span style="color: rgba(0, 0, 255, 1)">="{'active': sessionstate.thinkingEnabled}"</span><span style="color: rgba(255, 0, 0, 1)"> @click</span><span style="color: rgba(0, 0, 255, 1)">="sessionstate.thinkingEnabled =! sessionstate.thinkingEnabled"</span><span style="color: rgba(0, 0, 255, 1)">&gt;&lt;</span><span style="color: rgba(128, 0, 0, 1)">i </span><span style="color: rgba(255, 0, 0, 1)">class</span><span style="color: rgba(0, 0, 255, 1)">="iconfont ai-deepthink"</span><span style="color: rgba(0, 0, 255, 1)">&gt;&lt;/</span><span style="color: rgba(128, 0, 0, 1)">i</span><span style="color: rgba(0, 0, 255, 1)">&gt;&lt;</span><span style="color: rgba(128, 0, 0, 1)">span</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>æ·±åº¦æè<span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">span</span><span style="color: rgba(0, 0, 255, 1)">&gt;&lt;/</span><span style="color: rgba(128, 0, 0, 1)">div</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
        <span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">a-tooltip</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
        <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">div </span><span style="color: rgba(255, 0, 0, 1)">class</span><span style="color: rgba(0, 0, 255, 1)">="btn"</span><span style="color: rgba(255, 0, 0, 1)"> :class</span><span style="color: rgba(0, 0, 255, 1)">="{'active': sessionstate.searchEnabled}"</span><span style="color: rgba(255, 0, 0, 1)"> @click</span><span style="color: rgba(0, 0, 255, 1)">="sessionstate.searchEnabled =! sessionstate.searchEnabled"</span><span style="color: rgba(0, 0, 255, 1)">&gt;&lt;</span><span style="color: rgba(128, 0, 0, 1)">i </span><span style="color: rgba(255, 0, 0, 1)">class</span><span style="color: rgba(0, 0, 255, 1)">="iconfont ai-network"</span><span style="color: rgba(0, 0, 255, 1)">&gt;&lt;/</span><span style="color: rgba(128, 0, 0, 1)">i</span><span style="color: rgba(0, 0, 255, 1)">&gt;&lt;</span><span style="color: rgba(128, 0, 0, 1)">span</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>èç½<span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">span</span><span style="color: rgba(0, 0, 255, 1)">&gt;&lt;/</span><span style="color: rgba(128, 0, 0, 1)">div</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
        <span style="color: rgba(0, 128, 0, 1)">&lt;!--</span><span style="color: rgba(0, 128, 0, 1)"> æè½æ  </span><span style="color: rgba(0, 128, 0, 1)">--&gt;</span>
        <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">a-dropdown </span><span style="color: rgba(255, 0, 0, 1)">v-if</span><span style="color: rgba(0, 0, 255, 1)">="skillbar"</span><span style="color: rgba(255, 0, 0, 1)"> position</span><span style="color: rgba(0, 0, 255, 1)">="tl"</span><span style="color: rgba(255, 0, 0, 1)"> :content-style</span><span style="color: rgba(0, 0, 255, 1)">="{'min-width': '120px'}"</span><span style="color: rgba(255, 0, 0, 1)"> @select</span><span style="color: rgba(0, 0, 255, 1)">="handleSkill"</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
          <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">div </span><span style="color: rgba(255, 0, 0, 1)">class</span><span style="color: rgba(0, 0, 255, 1)">="btn"</span><span style="color: rgba(0, 0, 255, 1)">&gt;&lt;</span><span style="color: rgba(128, 0, 0, 1)">icon-command </span><span style="color: rgba(255, 0, 0, 1)">size</span><span style="color: rgba(0, 0, 255, 1)">="16"</span> <span style="color: rgba(0, 0, 255, 1)">/&gt;&lt;</span><span style="color: rgba(128, 0, 0, 1)">span</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>æè½<span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">span</span><span style="color: rgba(0, 0, 255, 1)">&gt;&lt;/</span><span style="color: rgba(128, 0, 0, 1)">div</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
          <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">template </span><span style="color: rgba(255, 0, 0, 1)">#content</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
            <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">a-doption </span><span style="color: rgba(255, 0, 0, 1)">v-for</span><span style="color: rgba(0, 0, 255, 1)">="(item, index) in skills"</span><span style="color: rgba(255, 0, 0, 1)"> :key</span><span style="color: rgba(0, 0, 255, 1)">="index"</span><span style="color: rgba(255, 0, 0, 1)"> :value</span><span style="color: rgba(0, 0, 255, 1)">="item"</span><span style="color: rgba(0, 0, 255, 1)">&gt;&lt;</span><span style="color: rgba(128, 0, 0, 1)">template </span><span style="color: rgba(255, 0, 0, 1)">#icon</span><span style="color: rgba(0, 0, 255, 1)">&gt;&lt;</span><span style="color: rgba(128, 0, 0, 1)">i </span><span style="color: rgba(255, 0, 0, 1)">class</span><span style="color: rgba(0, 0, 255, 1)">="iconfont"</span><span style="color: rgba(255, 0, 0, 1)"> :class</span><span style="color: rgba(0, 0, 255, 1)">="item.icon"</span><span style="color: rgba(0, 0, 255, 1)">&gt;&lt;/</span><span style="color: rgba(128, 0, 0, 1)">i</span><span style="color: rgba(0, 0, 255, 1)">&gt;&lt;/</span><span style="color: rgba(128, 0, 0, 1)">template</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>{{item.text}}<span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">a-doption</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
          <span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">template</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
        <span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">a-dropdown</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
      <span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">div</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
      <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">a-dropdown </span><span style="color: rgba(255, 0, 0, 1)">trigger</span><span style="color: rgba(0, 0, 255, 1)">="hover"</span><span style="color: rgba(255, 0, 0, 1)"> :show-arrow</span><span style="color: rgba(0, 0, 255, 1)">="false"</span><span style="color: rgba(255, 0, 0, 1)"> position</span><span style="color: rgba(0, 0, 255, 1)">="lb"</span><span style="color: rgba(255, 0, 0, 1)"> :content-style</span><span style="color: rgba(0, 0, 255, 1)">="{'min-width': '200px'}"</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
        <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">a-button </span><span style="color: rgba(255, 0, 0, 1)">class</span><span style="color: rgba(0, 0, 255, 1)">="icon-btn"</span><span style="color: rgba(255, 0, 0, 1)"> shape</span><span style="color: rgba(0, 0, 255, 1)">="circle"</span><span style="color: rgba(0, 0, 255, 1)">&gt;&lt;</span><span style="color: rgba(128, 0, 0, 1)">icon-attachment </span><span style="color: rgba(255, 0, 0, 1)">size</span><span style="color: rgba(0, 0, 255, 1)">="18"</span> <span style="color: rgba(0, 0, 255, 1)">/&gt;&lt;/</span><span style="color: rgba(128, 0, 0, 1)">a-button</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
        <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">template </span><span style="color: rgba(255, 0, 0, 1)">#content</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
          <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">a-dgroup</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
            <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">template </span><span style="color: rgba(255, 0, 0, 1)">#title</span><span style="color: rgba(0, 0, 255, 1)">&gt;&lt;</span><span style="color: rgba(128, 0, 0, 1)">div </span><span style="color: rgba(255, 0, 0, 1)">style</span><span style="color: rgba(0, 0, 255, 1)">="margin-bottom: 5px;"</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>ä»ç½çæ·»å <span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">div</span><span style="color: rgba(0, 0, 255, 1)">&gt;&lt;/</span><span style="color: rgba(128, 0, 0, 1)">template</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
            <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">a-doption </span><span style="color: rgba(255, 0, 0, 1)">value</span><span style="color: rgba(0, 0, 255, 1)">="wx"</span><span style="color: rgba(0, 0, 255, 1)">&gt;&lt;</span><span style="color: rgba(128, 0, 0, 1)">icon-more </span><span style="color: rgba(0, 0, 255, 1)">/&gt;</span> éæ©ç½çæä»¶<span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">a-doption</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
          <span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">a-dgroup</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
          <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">a-dgroup</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
            <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">template </span><span style="color: rgba(255, 0, 0, 1)">#title</span><span style="color: rgba(0, 0, 255, 1)">&gt;&lt;</span><span style="color: rgba(128, 0, 0, 1)">div </span><span style="color: rgba(255, 0, 0, 1)">style</span><span style="color: rgba(0, 0, 255, 1)">="margin-bottom: 5px;"</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>ä»æ¬å°æ·»å <span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">div</span><span style="color: rgba(0, 0, 255, 1)">&gt;&lt;/</span><span style="color: rgba(128, 0, 0, 1)">template</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
            <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">a-doption </span><span style="color: rgba(255, 0, 0, 1)">value</span><span style="color: rgba(0, 0, 255, 1)">="wx"</span><span style="color: rgba(0, 0, 255, 1)">&gt;&lt;</span><span style="color: rgba(128, 0, 0, 1)">icon-apps </span><span style="color: rgba(0, 0, 255, 1)">/&gt;</span> ä¸ä¼ æä»¶<span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">a-doption</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
            <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">a-dsubmenu </span><span style="color: rgba(255, 0, 0, 1)">trigger</span><span style="color: rgba(0, 0, 255, 1)">="hover"</span><span style="color: rgba(255, 0, 0, 1)"> position</span><span style="color: rgba(0, 0, 255, 1)">="rb"</span><span style="color: rgba(255, 0, 0, 1)"> :popup-translate</span><span style="color: rgba(0, 0, 255, 1)">="[5, 5]"</span><span style="color: rgba(255, 0, 0, 1)"> value</span><span style="color: rgba(0, 0, 255, 1)">="option-1"</span><span style="color: rgba(255, 0, 0, 1)"> :content-style</span><span style="color: rgba(0, 0, 255, 1)">="{'min-width': '120px'}"</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
              <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">template </span><span style="color: rgba(255, 0, 0, 1)">#default</span><span style="color: rgba(0, 0, 255, 1)">&gt;&lt;</span><span style="color: rgba(128, 0, 0, 1)">icon-apps </span><span style="color: rgba(0, 0, 255, 1)">/&gt;</span> ä¸ä¼ ä»£ç <span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">template</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
              <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">template </span><span style="color: rgba(255, 0, 0, 1)">#content</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
                <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">a-doption </span><span style="color: rgba(255, 0, 0, 1)">value</span><span style="color: rgba(0, 0, 255, 1)">="pyq"</span><span style="color: rgba(0, 0, 255, 1)">&gt;&lt;</span><span style="color: rgba(128, 0, 0, 1)">icon-apps </span><span style="color: rgba(0, 0, 255, 1)">/&gt;</span> ä»£ç æä»¶<span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">a-doption</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
                <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">a-doption </span><span style="color: rgba(255, 0, 0, 1)">value</span><span style="color: rgba(0, 0, 255, 1)">="qq"</span><span style="color: rgba(0, 0, 255, 1)">&gt;&lt;</span><span style="color: rgba(128, 0, 0, 1)">icon-apps </span><span style="color: rgba(0, 0, 255, 1)">/&gt;</span> ä»£ç æä»¶å¤¹<span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">a-doption</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
                <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">a-doption </span><span style="color: rgba(255, 0, 0, 1)">value</span><span style="color: rgba(0, 0, 255, 1)">="qq"</span><span style="color: rgba(0, 0, 255, 1)">&gt;&lt;</span><span style="color: rgba(128, 0, 0, 1)">icon-apps </span><span style="color: rgba(0, 0, 255, 1)">/&gt;</span> GitHubä»åº<span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">a-doption</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
              <span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">template</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
            <span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">a-dsubmenu</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
          <span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">a-dgroup</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
        <span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">template</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
      <span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">a-dropdown</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
      <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">a-tooltip </span><span style="color: rgba(255, 0, 0, 1)">content</span><span style="color: rgba(0, 0, 255, 1)">="æªå¾æé®"</span><span style="color: rgba(255, 0, 0, 1)"> position</span><span style="color: rgba(0, 0, 255, 1)">="top"</span><span style="color: rgba(255, 0, 0, 1)"> mini</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
        <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">a-button </span><span style="color: rgba(255, 0, 0, 1)">class</span><span style="color: rgba(0, 0, 255, 1)">="icon-btn"</span><span style="color: rgba(255, 0, 0, 1)"> shape</span><span style="color: rgba(0, 0, 255, 1)">="circle"</span><span style="color: rgba(0, 0, 255, 1)">&gt;&lt;</span><span style="color: rgba(128, 0, 0, 1)">icon-scissor </span><span style="color: rgba(255, 0, 0, 1)">size</span><span style="color: rgba(0, 0, 255, 1)">="18"</span><span style="color: rgba(255, 0, 0, 1)"> @click</span><span style="color: rgba(0, 0, 255, 1)">="handleCut"</span> <span style="color: rgba(0, 0, 255, 1)">/&gt;&lt;/</span><span style="color: rgba(128, 0, 0, 1)">a-button</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
      <span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">a-tooltip</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
      <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">a-dropdown </span><span style="color: rgba(255, 0, 0, 1)">:show-arrow</span><span style="color: rgba(0, 0, 255, 1)">="false"</span><span style="color: rgba(255, 0, 0, 1)"> position</span><span style="color: rgba(0, 0, 255, 1)">="top"</span><span style="color: rgba(255, 0, 0, 1)"> :content-style</span><span style="color: rgba(0, 0, 255, 1)">="{'min-width': '160px'}"</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
        <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">a-button </span><span style="color: rgba(255, 0, 0, 1)">class</span><span style="color: rgba(0, 0, 255, 1)">="icon-btn"</span><span style="color: rgba(255, 0, 0, 1)"> shape</span><span style="color: rgba(0, 0, 255, 1)">="circle"</span><span style="color: rgba(0, 0, 255, 1)">&gt;&lt;</span><span style="color: rgba(128, 0, 0, 1)">icon-plus </span><span style="color: rgba(255, 0, 0, 1)">size</span><span style="color: rgba(0, 0, 255, 1)">="18"</span> <span style="color: rgba(0, 0, 255, 1)">/&gt;&lt;/</span><span style="color: rgba(128, 0, 0, 1)">a-button</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
        <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">template </span><span style="color: rgba(255, 0, 0, 1)">#content</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
          <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">a-doption </span><span style="color: rgba(255, 0, 0, 1)">value</span><span style="color: rgba(0, 0, 255, 1)">="image"</span><span style="color: rgba(0, 0, 255, 1)">&gt;&lt;</span><span style="color: rgba(128, 0, 0, 1)">icon-file-image </span><span style="color: rgba(0, 0, 255, 1)">/&gt;</span> å¾ç<span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">a-doption</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
            <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">a-doption </span><span style="color: rgba(255, 0, 0, 1)">value</span><span style="color: rgba(0, 0, 255, 1)">="file"</span><span style="color: rgba(0, 0, 255, 1)">&gt;&lt;</span><span style="color: rgba(128, 0, 0, 1)">icon-file </span><span style="color: rgba(0, 0, 255, 1)">/&gt;</span> æ¬å°æä»¶<span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">a-doption</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
            <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">a-doption </span><span style="color: rgba(255, 0, 0, 1)">value</span><span style="color: rgba(0, 0, 255, 1)">="pdf"</span><span style="color: rgba(0, 0, 255, 1)">&gt;&lt;</span><span style="color: rgba(128, 0, 0, 1)">icon-file-pdf </span><span style="color: rgba(0, 0, 255, 1)">/&gt;</span> PDFææ¡£åæ<span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">a-doption</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
            <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">a-doption </span><span style="color: rgba(255, 0, 0, 1)">value</span><span style="color: rgba(0, 0, 255, 1)">="page"</span><span style="color: rgba(0, 0, 255, 1)">&gt;&lt;</span><span style="color: rgba(128, 0, 0, 1)">icon-cloud </span><span style="color: rgba(0, 0, 255, 1)">/&gt;</span> ç½é¡µæ»ç»<span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">a-doption</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
        <span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">template</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
      <span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">a-dropdown</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
      <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">a-divider </span><span style="color: rgba(255, 0, 0, 1)">direction</span><span style="color: rgba(0, 0, 255, 1)">="vertical"</span><span style="color: rgba(255, 0, 0, 1)"> style</span><span style="color: rgba(0, 0, 255, 1)">="margin: 0 15px 0 10px; height: 15px;"</span> <span style="color: rgba(0, 0, 255, 1)">/&gt;</span>
      <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">a-button </span><span style="color: rgba(255, 0, 0, 1)">class</span><span style="color: rgba(0, 0, 255, 1)">="btn-submit"</span><span style="color: rgba(255, 0, 0, 1)"> v-if</span><span style="color: rgba(0, 0, 255, 1)">="!sessionstate.loading"</span><span style="color: rgba(255, 0, 0, 1)"> type</span><span style="color: rgba(0, 0, 255, 1)">="primary"</span><span style="color: rgba(255, 0, 0, 1)"> shape</span><span style="color: rgba(0, 0, 255, 1)">="circle"</span><span style="color: rgba(255, 0, 0, 1)"> :disabled</span><span style="color: rgba(0, 0, 255, 1)">="!editorText?.trim() || sessionstate.loading"</span><span style="color: rgba(255, 0, 0, 1)"> @click</span><span style="color: rgba(0, 0, 255, 1)">="handleSubmit"</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
        <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">icon-arrow-up </span><span style="color: rgba(255, 0, 0, 1)">size</span><span style="color: rgba(0, 0, 255, 1)">="20"</span> <span style="color: rgba(0, 0, 255, 1)">/&gt;</span>
      <span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">a-button</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
      <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">a-button </span><span style="color: rgba(255, 0, 0, 1)">class</span><span style="color: rgba(0, 0, 255, 1)">="btn-submit"</span><span style="color: rgba(255, 0, 0, 1)"> v-else type</span><span style="color: rgba(0, 0, 255, 1)">="primary"</span><span style="color: rgba(255, 0, 0, 1)"> shape</span><span style="color: rgba(0, 0, 255, 1)">="circle"</span><span style="color: rgba(255, 0, 0, 1)"> @click</span><span style="color: rgba(0, 0, 255, 1)">="handleStopStream"</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
        <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">div </span><span style="color: rgba(255, 0, 0, 1)">style</span><span style="color: rgba(0, 0, 255, 1)">="background:#fff;border-radius:2px;height:10px;width:10px;"</span><span style="color: rgba(0, 0, 255, 1)">&gt;&lt;/</span><span style="color: rgba(128, 0, 0, 1)">div</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
      <span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">a-button</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
    <span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">div</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
  <span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">div</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
<span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">template</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span></pre>
</div>
<h3>electron39+vue3è°ç¨deepseek api</h3>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> è°ç¨deepseekæ¥å£</span>
const completion =<span style="color: rgba(0, 0, 0, 1)"> await openai.chat.completions.create({
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> åä¸ä¼è¯</span>
  <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> messages: [{role: 'user', content: editorValue}],</span>
  <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> å¤è½®ä¼è¯</span>
  messages: props.multiConversation ? historySession.value : [{role: 'user'<span style="color: rgba(0, 0, 0, 1)">, content: editorValue}],
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> deepseek-chatå¯¹è¯æ¨¡å deepseek-reasoneræ¨çæ¨¡å</span>
  model: sessionstate.thinkingEnabled ? 'deepseek-reasoner' : 'deepseek-chat'<span style="color: rgba(0, 0, 0, 1)">,
  stream: </span><span style="color: rgba(0, 0, 255, 1)">true</span>, <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> æµå¼è¾åº</span>
  max_tokens: 8192<span style="color: rgba(0, 0, 0, 1)">,
  temperature: </span>0.4<span style="color: rgba(0, 0, 0, 1)">
})

</span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> å¤çæµå¼è¿åç»æ</span>
<span style="color: rgba(0, 0, 255, 1)">for</span><span style="color: rgba(0, 0, 0, 1)"> await (const chunk of completion) {
  </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> æ£æ¥æ¯å¦å·²ç»æ­¢</span>
  <span style="color: rgba(0, 0, 255, 1)">if</span>(sessionstate.aborted) <span style="color: rgba(0, 0, 255, 1)">break</span><span style="color: rgba(0, 0, 0, 1)">

  const content </span>= chunk.choices[0]?.delta?.content || ''
  <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> è·åæ¨çåå®¹</span>
  const reasoningContent = chunk.choices[0]?.delta?.reasoning_content || ''
  
  <span style="color: rgba(0, 0, 255, 1)">if</span>(content ||<span style="color: rgba(0, 0, 0, 1)"> reasoningContent) {
    answerText </span>+=<span style="color: rgba(0, 0, 0, 1)"> content
    reasoningText </span>+=<span style="color: rgba(0, 0, 0, 1)"> reasoningContent

    </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> éå¶æ´æ°é¢çï¼æ¯100msæå¤æ´æ°ä¸æ¬¡</span>
    const now =<span style="color: rgba(0, 0, 0, 1)"> Date.now()
    </span><span style="color: rgba(0, 0, 255, 1)">if</span>(now - lastUpdate &gt; 100<span style="color: rgba(0, 0, 0, 1)">) {
      lastUpdate </span>=<span style="color: rgba(0, 0, 0, 1)"> now
      requestAnimationFrame(() </span>=&gt;<span style="color: rgba(0, 0, 0, 1)"> {
        </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> ...</span>
<span style="color: rgba(0, 0, 0, 1)">      })
    }
  }
  </span><span style="color: rgba(0, 0, 255, 1)">if</span>(chunk.choices[0]?.finish_reason === 'stop'<span style="color: rgba(0, 0, 0, 1)">) {
    </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> ...</span>
<span style="color: rgba(0, 0, 0, 1)">  }
}</span></pre>
</div>
<p><img alt="æªæ é¢-4" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1289798/202601/1289798-20260112234938471-813089309.png" class="lazyload"></p>
<p>Okï¼åºäºelectron39+vue3æ¥å¥deepseekæ­å»ºå®¢æ·ç«¯aièå¤©å¯¹è¯ç³»ç»å°±åäº«å°è¿éï¼å¸æå¯¹å¤§å®¶æç¹å¸®å©ï¼</p>
<p><strong>æ¨èå ä¸ªææ°å®æé¡¹ç®</strong></p>
<blockquote>
<p><span style="font-size: 12px"><a class="postTitle2 vertical-middle" href="https://www.cnblogs.com/xiaoyan2017/p/19440082" target="_blank">Vite7+DeepSeekç½é¡µçAiå©æ|vue3+arcoç½é¡µwebæµå¼çæaièå¤©é®ç­ç³»ç»</a></span></p>
<p><span style="font-size: 12px"><a class="postTitle2 vertical-middle" href="https://www.cnblogs.com/xiaoyan2017/p/18853514" target="_blank">Uniapp-DeepSeekè·¨ä¸ç«¯AIå©æ|uniapp+vue3+deepseek-v3æµå¼aièå¤©æ¨¡æ¿</a></span></p>
<p><span style="font-size: 12px"><a class="postTitle2 vertical-middle" href="https://www.cnblogs.com/xiaoyan2017/p/19385909" target="_blank">vite7+deepseekæµå¼aiæ¨¡æ¿|vue3.5+deepseek3.2+markdownæå­è¾åºaiå©æ</a></span></p>
<p><span style="font-size: 12px"><a class="postTitle2 vertical-middle" href="https://www.cnblogs.com/xiaoyan2017/p/19136187" target="_blank">Electron38-Vue3OSå®¢æ·ç«¯OSç³»ç»|vite7+electron38+arcoæ¡é¢osåå°ç®¡ç</a></span></p>
<p><span style="font-size: 12px"><a class="postTitle2 vertical-middle" href="https://www.cnblogs.com/xiaoyan2017/p/19116145" target="_blank">electron38-adminæ¡é¢ç«¯åå°|Electron38+Vue3+ElementPlusç®¡çç³»ç»</a></span></p>
<p><span style="font-size: 12px"><a class="postTitle2 vertical-middle" href="https://www.cnblogs.com/xiaoyan2017/p/19088804" target="_blank">Electron38-Wechatçµèç«¯èå¤©|vite7+electron38ä»¿å¾®ä¿¡æ¡é¢ç«¯èå¤©ç³»ç»</a></span></p>
<p><span style="font-size: 12px"><a class="postTitle2 vertical-middle" href="https://www.cnblogs.com/xiaoyan2017/p/19313982" target="_blank">ææ°çFlutter3.38+Dart3.10ä»¿åæé³APPç´æ­+ç­è§é¢+èå¤©åºç¨ç¨åº</a></span></p>
<p><span style="font-size: 12px"><a class="postTitle2 vertical-middle" href="https://www.cnblogs.com/xiaoyan2017/p/18894117" target="_blank">flutter3-deepseekæµå¼AIæ¨¡æ¿|Flutter3.27+Dio+DeepSeeekèå¤©aiå©æ</a></span></p>
<p><span style="font-size: 12px"><a class="postTitle2 vertical-middle" href="https://www.cnblogs.com/xiaoyan2017/p/18962574" target="_blank">ææ°çuniapp+vue3+uv-uiè·¨ä¸ç«¯ç­è§é¢+ç´æ­+èå¤©ãH5+å°ç¨åº+Appç«¯ã</a></span></p>
<p><span style="font-size: 12px"><a class="postTitle2 vertical-middle" href="https://www.cnblogs.com/xiaoyan2017/p/19031695" target="_blank">ææ°çuni-app+vue3+uv-uiè·¨ä¸ç«¯ä»¿å¾®ä¿¡appèå¤©åºç¨ãh5+å°ç¨åº+appç«¯ã</a></span></p>
<p><span style="font-size: 12px"><a class="postTitle2 vertical-middle" href="https://www.cnblogs.com/xiaoyan2017/p/19018641" target="_blank">Flutter3-MacOSæ¡é¢OSç³»ç»|flutter3.32+window_managerå®¢æ·ç«¯OSæ¨¡æ¿</a></span></p>
<p><span style="font-size: 12px"><a class="postTitle2 vertical-middle" href="https://www.cnblogs.com/xiaoyan2017/p/19181509" target="_blank">Tauri2-Vite7Adminå®¢æ·ç«¯ç®¡çåå°|tauri2.9+vue3+element-plusåå°ç³»ç»</a></span></p>
<p><span style="font-size: 12px"><a class="postTitle2 vertical-middle" href="https://www.cnblogs.com/xiaoyan2017/p/19235565" target="_blank">Tauri2.9+Vue3æ¡é¢çOSç³»ç»|vite7+tauri2+arcoDesignçµèç«¯osåå°æ¨¡æ¿</a></span></p>
</blockquote>
<p><img alt="s13.sinaimg" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1289798/202511/1289798-20251107235037424-153089694.gif" class="lazyload"></p>
<p>&nbsp;</p>
</div>
<div id="MySignature" role="contentinfo">
    æ¬æä¸ºåä¸»ååæç« ï¼æªç»åä¸»åè®¸ä¸å¾è½¬è½½ï¼æ¬¢è¿å¤§å®¶ä¸èµ·äº¤æµ QQï¼282310962ï¼ wxï¼xy190310ï¼
</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-01-12 23:54">2026-01-12 23:54</span>&nbsp;
<a href="https://www.cnblogs.com/xiaoyan2017">xiaoyan2017</a>&nbsp;
éè¯»(<span id="post_view_count">0</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19474565);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19474565', targetLink: 'https://www.cnblogs.com/xiaoyan2017/p/19474565', title: 'electron39-vue3aiçµèç«¯AIæ¨¡æ¿|electron39+deepseek+vite7èå¤©aiåºç¨' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ .NET ç£çç®¡ç-ææ¯æ¹æ¡éå ]]></title>
    <link>https://www.cnblogs.com/kybs0/p/19473484</link>
    <guid>ae5e2d66d51b941bdd17307ab0e5e253</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/kybs0/p/19473484" title="åå¸äº 2026-01-12 23:50">
    <span role="heading" aria-level="2">.NET ç£çç®¡ç-ææ¯æ¹æ¡éå</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body blogpost-body-html">
<p>å¨å®¶åº­ä»¥åä¼ä¸åºæ¯ä¸çç½ç»ç£çäº§åï¼ä½¿ç¨Iscsiåéè¦å¯¹ç£çè¿è¡ç®¡çãä¸åWindowsçæ¬ãå®è£ç¬¬ä¸æ¹è½¯ä»¶ï¼å¯¼è´æ¯ä¸ªCç«¯ç¨æ·çè¿è¡ç¯å¢ä¸åï¼å¯¹ç£ççç®¡çå¸¦æ¥ä¸å®çä½¿ç¨å¹²æ°</p>
<p>æ¬æä»ç»ä¸ç£çç®¡ççå ç§æ¹æ¡ä»¥åå­å¨çä¸äºé®é¢</p>
<p>å¯¹ç£çç®¡çä¸»è¦æä»¥ä¸æä½å¥å£/æ¹å¼ï¼</p>
<ol>
<li>Powershell</li>
<li>Diskpart</li>
<li>WMI</li>
<li>WIN32(IOCTL)</li>
</ol>
<p>ä¸é¢ä»ç»ä¸åèä¹é´çå³ç³»ä»¥åæä¾èµçwindowsç³»ç»æå¡</p>
<h1>Windowsç£çç®¡çæå¡ä¾èµå±çº§</h1>
<p>ä»æä½ç³»ç»è§åº¦çï¼è¿å ç§æ¹å¼ç¼ç¨/æä½å¥å£æ¯å´ç»åä¸å¥åæ ¸ä¸æå¡å æ çä¸åâå£³âï¼å®æ<strong>å¥å¨å°è£</strong></p>
<p>ä»é«å°ä½ï¼ä¾æ¬¡åä¸windowsä¸»è¦çç£çç¸å³å¥å£åæå¡</p>
<p>1. GUI/å·¥å·å±</p>
<p>MMC -&nbsp;Windowsç³»ç»ç£çç®¡çå·¥å·ï¼å¦æéè¦å¿«éæ¥çåæä½ç£çååºçè¯ï¼å¯ä»¥ç¨è¿ä¸ª</p>
<p><img src="https://img2024.cnblogs.com/blog/685541/202601/685541-20260112154249299-1528163380.png" alt="image" width="529" height="270" loading="lazy"></p>
<p>ä»¥åStorage Spaces GUI - Windowsç³»ç»è®¾ç½®å­å¨ç®¡ç</p>
<p><img src="https://img2024.cnblogs.com/blog/685541/202601/685541-20260112154850543-1013979831.png" alt="image" width="533" height="306" loading="lazy"><img src="https://img2024.cnblogs.com/blog/685541/202601/685541-20260112155107194-71293024.png" alt="image" width="403" height="305" loading="lazy"></p>
<p>è¿ä¿©ä¸ªå·¥å·ä¸»è¦æ¯ä½¿ç¨WMIç¸å³æä½æ¥å®ç°</p>
<p>2. èæ¬/å½ä»¤å±</p>
<p>Powershellç£çç®¡çå½ä»¤</p>
<p>diskpartç£çç®¡çå½ä»¤</p>
<p>CIMç£çç®¡çå½ä»¤</p>
<p>3. API/ç®¡çæ¥å£å±</p>
<p>WMIæå¡ï¼Winmgmtï¼Windows Management Instrumentationï¼ï¼ä½¿ç¨Win32_DiskDrive ç­</p>
<p><img src="https://img2024.cnblogs.com/blog/685541/202601/685541-20260112181124821-2050380879.png" alt="image" loading="lazy"></p>
<p>ç£çç®¡çæå¡ï¼Virtual Diskï¼VDSè¿ç¨åç§°vds.exe</p>
<p><img src="https://img2024.cnblogs.com/blog/685541/202601/685541-20260112180656866-1672546299.png" alt="image" loading="lazy"></p>
<p>ç£çå­å¨æå¡ï¼Microsoft Storage Spaces SMP</p>
<p><img src="https://img2024.cnblogs.com/blog/685541/202601/685541-20260112163817548-1975243303.png" alt="image" loading="lazy"></p>
<p>4. åæ ¸/é©±å¨/IOCTLå±</p>
<p>Storage Management Providerï¼ç³»ç»ç»ä»¶ï¼ä¸æ¯åç¬æå¡å¯è§<br>IOCTLï¼ Win32APIãDevicerIoControl</p>
<p>ç£çç±»é©±å¨ï¼disk.sysï¼ãå·ç®¡çå¨ï¼volmgr/vdsciï¼ãæä»¶ç³»ç»é©±å¨ï¼NTFS/ReFSï¼</p>
<p><strong>èä¸é¢è¯´çåç§æ¹æ¡ï¼ä¾èµçåºå±æå¡ï¼</strong></p>
<p>PowerShell åºäº WMI / Storage Management APIå°è£ï¼ä¾èµçç»ä»¶æå¤ï¼WinmgmtãMicrosoft Storage Spaces SMPãStorage ServiceãVDSç­<br>WMI/CIM æé¨åæ¯èµ° VDS / Storage APIï¼æé¨åç´æ¥è°ç¨åºå±é©±å¨ï¼ä¾èµï¼VDSæå¡ãWinmgmtæå¡</p>
<p>diskpart åé¨æ¯è°ç¨ VDS / Storage API / IOCTLï¼ä¾èµç¸å¯¹è¾å°ï¼VDSæå¡ç­</p>
<p>Win32 IOCTL æ¯æåºå±ï¼ç¨æ·æå¯è¾¾ï¼çæ¥å£ï¼ä¸ä¾èµä¸å±æ¡æ¶</p>
<p>æ¯å¦ä¸æ¹çWMIæå¡ä¸å­å¨ï¼ä¼å¯¼è´powershellç£çæ¥è¯¢ä¸å°ï¼WMIç£çæ¥è¯¢ä¸å°ï¼ä½diskpartè®¿é®æ­£å¸¸ï¼</p>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 128, 128, 1)"> 1</span> PS C:\Users\yudong04&gt; G<span style="color: rgba(0, 0, 255, 1)">et-Disk</span>
<span style="color: rgba(0, 128, 128, 1)"> 2</span> PS C:\Users\yudong04&gt; <span style="color: rgba(0, 0, 255, 1)">Get-CimInstance</span> -Namespace root/Microsoft/Windows/Storage -<span style="color: rgba(0, 0, 0, 1)">ClassName MSFT_Disk
</span><span style="color: rgba(0, 128, 128, 1)"> 3</span> PS C:\Users\yudong04&gt;<span style="color: rgba(0, 0, 0, 1)"> diskpart
</span><span style="color: rgba(0, 128, 128, 1)"> 4</span> 
<span style="color: rgba(0, 128, 128, 1)"> 5</span> Microsoft DiskPart çæ¬ 10.0.26100.1150
<span style="color: rgba(0, 128, 128, 1)"> 6</span> 
<span style="color: rgba(0, 128, 128, 1)"> 7</span> <span style="color: rgba(0, 0, 0, 1)">Copyright (C) Microsoft Corporation.
</span><span style="color: rgba(0, 128, 128, 1)"> 8</span> å¨è®¡ç®æºä¸: GIH-D-24762
<span style="color: rgba(0, 128, 128, 1)"> 9</span> 
<span style="color: rgba(0, 128, 128, 1)">10</span> DISKPART&gt;<span style="color: rgba(0, 0, 0, 1)"> list disk
</span><span style="color: rgba(0, 128, 128, 1)">11</span> 
<span style="color: rgba(0, 128, 128, 1)">12</span>   ç£ç <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)">##  ç¶æ           å¤§å°     å¯ç¨     Dyn  Gpt</span>
<span style="color: rgba(0, 128, 128, 1)">13</span>   --------  -------------  -------  -------  ---  ---
<span style="color: rgba(0, 128, 128, 1)">14</span>   ç£ç 0    èæº             3726 GB  1024 KB        *
<span style="color: rgba(0, 128, 128, 1)">15</span>   ç£ç 1    èæº             3726 GB  1024 KB        *
<span style="color: rgba(0, 128, 128, 1)">16</span>   ç£ç 2    èæº             2794 GB      0 B        *
<span style="color: rgba(0, 128, 128, 1)">17</span>   ç£ç 3    èæº              931 GB      0 B        *
<span style="color: rgba(0, 128, 128, 1)">18</span>   ç£ç 4    èæº              465 GB  1024 KB        *
<span style="color: rgba(0, 128, 128, 1)">19</span>   ç£ç 5    èæº             1863 GB      0<span style="color: rgba(0, 0, 0, 1)"> B
</span><span style="color: rgba(0, 128, 128, 1)">20</span>   ç£ç 6    èæº             7452 GB      0 B        *</pre>
</div>
<p><span style="font-size: 14px">è¿æMicrosoft Storage Spaces SMPæå¡è¢«ç¬¬ä¸æ¹è½¯ä»¶ç¦ç¨ï¼å¯¼è´Powershell Get-Diskè·åç»æä¸ºç©ºï¼</span></p>
<p><img src="https://img2024.cnblogs.com/blog/685541/202601/685541-20260112205453476-213941181.png" alt="image" width="1009" height="554" loading="lazy"></p>
<p><span style="font-size: 14px">ä¸é¢å¯¹åä¸ªæ¨¡åå±å¼ä»ç»ä¸</span></p>
<h1>Powershellç£çç®¡ç</h1>
<p>ä¸é¢è¯´äºï¼PowerShellä½¿ç¨ Storage Management API + æ°ç WMI/CIM ç±»ï¼ç£çå½ä»¤æ¬è´¨æ¯å¯¹è¿äº WMI ç±»çåè£ãå±çº§å¦ä¸ï¼</p>
<p>PowerShell cmdlet<br>-&gt; MSFT_* WMI ç±» (CIM)ãWMIæå¡Winmgmt<br>-&gt; Storage Management Provider<br>-&gt; åæ ¸é©±å¨ (disk.sys, partmgr.sys, volmgr.sys)<br>-&gt; è®¾å¤ç¡¬ä»¶</p>
<p>powershellæä»¥ä¸æ¥æ¾ä¸»è¦å½ä»¤ï¼</p>
<p>Get-Disk - æ¥æ¾ç£ç</p>
<p>Get-Partition - æ¥æ¾ååº</p>
<p>Get-Volume - æ¥æ¾å·</p>
<p>Get-Disk | Where-Object -FilterScript {&nbsp; $_.BusType -Eq "iSCSI" -and $_.SerialNumber -Eq "8fa461f8-9436-4260-8191-789b23859757"} - æ¥æ¾æå®Iscsiåè®®ç£ç</p>
<p><img src="https://img2024.cnblogs.com/blog/685541/202601/685541-20260112162810665-890504091.png" alt="image" loading="lazy"></p>
<p>æä½ç£çå½ä»¤ï¼æ¯å¦åå§åGPTç£çï¼Initialize-Disk -PartitionStyle GPT -PassThru | New-Partition -UseMaximumSize | Format-Volume -FileSystem:NTFS -NewFileSystemLabel:æµè¯ç -Confirm:$false -Force</p>
<p>Powershellå½ä»¤å æç¨æ§ï¼éå¸¸éåèæ¬èªå¨åãç¨æ·çº§çä½¿ç¨ãä½éå¸¸ä¸ç¨æ·ç¯å¢æå³ï¼æ¢ä¸ªç¨æ·ææ¢å°æºå¨å°±ç»å¸¸è¡¨ç°ä¸åï¼æ¯å¦ï¼å¡å¾ä¹ãè¶æ¶ãç´æ¥æ¥éãç£ççå°±æ¯æ¥è¯¢ä¸å°</p>
<p>å ä¸ªåå ï¼</p>
<p>WMI / CIM è°ç¨è¶æ¶</p>
<ul>
<li>WMI æå¡å¡ä½ãå­å¨é©±å¨ååºæ¢</li>
<li>ç½ç»/é²ç«å¢å¯¼è´è¿ç¨è°ç¨è¶æ¶</li>









</ul>
<p>ç¡¬ä»¶IOè¶æ¶</p>
<ul>
<li>åç / å U ç / USB æ©å±åè´¨éé®é¢</li>
<li>å¤§ééæ°å°è¯ I/O å¯¼è´æä½æ´ä½æå¾å¾é¿</li>








</ul>
<p>å·ä½åºæ¯ï¼åç°å¬å¸åé¨æä¸ªé¨é¨åçpowershellå½ä»¤è¶æ¶æ¦çå¾å¤ï¼å ä¸ºè¿äºè®¾å¤é½å¨è·è½¯ä»¶ååæµè¯ãããå¯¼è´ç£çè·åå½ä»¤ï¼å¾å®¹æè¶æ¶</p>
<p>è¿æäºç¹æ®æåµï¼æå¡å¼å¸¸åºç°çæåµæ¯è¾å¤ãå¦WMIæå¡ï¼ä»¥ä¸æ¯ä¿®å¤æåæ¡ä¾ï¼</p>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 128, 128, 1)"> 1</span> PS C:\Users\yudong04&gt; <span style="color: rgba(0, 0, 255, 1)">Get-WmiObject</span><span style="color: rgba(0, 0, 0, 1)"> Win32_OperatingSystem
</span><span style="color: rgba(0, 128, 128, 1)"> 2</span> <span style="color: rgba(0, 0, 255, 1)">Get-WmiObject</span><span style="color: rgba(0, 0, 0, 1)"> : æ æç±» âWin32_OperatingSystemâ
</span><span style="color: rgba(0, 128, 128, 1)"> 3</span> æå¨ä½ç½® è¡:1 å­ç¬¦: 1
<span style="color: rgba(0, 128, 128, 1)"> 4</span> + <span style="color: rgba(0, 0, 255, 1)">Get-WmiObject</span><span style="color: rgba(0, 0, 0, 1)"> Win32_OperatingSystem
</span><span style="color: rgba(0, 128, 128, 1)"> 5</span> +<span style="color: rgba(0, 0, 0, 1)"> ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
</span><span style="color: rgba(0, 128, 128, 1)"> 6</span>     + CategoryInfo          : InvalidType: (:) [<span style="color: rgba(0, 0, 255, 1)">Get-WmiObject</span><span style="color: rgba(0, 0, 0, 1)">], ManagementException
</span><span style="color: rgba(0, 128, 128, 1)"> 7</span>     +<span style="color: rgba(0, 0, 0, 1)"> FullyQualifiedErrorId : GetWMIManagementException,Microsoft.PowerShell.Commands.GetWmiObjectCommand
</span><span style="color: rgba(0, 128, 128, 1)"> 8</span> 
<span style="color: rgba(0, 128, 128, 1)"> 9</span> PS C:\Users\yudong04&gt; net stop winmgmt /<span style="color: rgba(0, 0, 0, 1)">y
</span><span style="color: rgba(0, 128, 128, 1)">10</span> <span style="color: rgba(0, 0, 0, 1)">Windows Management Instrumentation æå¡æ­£å¨åæ­¢.
</span><span style="color: rgba(0, 128, 128, 1)">11</span> <span style="color: rgba(0, 0, 0, 1)">Windows Management Instrumentation æå¡å·²æååæ­¢ã
</span><span style="color: rgba(0, 128, 128, 1)">12</span> 
<span style="color: rgba(0, 128, 128, 1)">13</span> PS C:\Users\yudong04&gt; winmgmt /<span style="color: rgba(0, 0, 0, 1)">resetrepository
</span><span style="color: rgba(0, 128, 128, 1)">14</span> <span style="color: rgba(0, 0, 0, 1)">WMI å­å¨åºå·²éç½®
</span><span style="color: rgba(0, 128, 128, 1)">15</span> 
<span style="color: rgba(0, 128, 128, 1)">16</span> PS C:\Users\yudong04&gt; <span style="color: rgba(0, 0, 255, 1)">Get-WmiObject</span><span style="color: rgba(0, 0, 0, 1)"> Win32_OperatingSystem
</span><span style="color: rgba(0, 128, 128, 1)">17</span> 
<span style="color: rgba(0, 128, 128, 1)">18</span> 
<span style="color: rgba(0, 128, 128, 1)">19</span> <span style="color: rgba(0, 0, 0, 1)">SystemDirectory : C:\WINDOWS\system32
</span><span style="color: rgba(0, 128, 128, 1)">20</span> <span style="color: rgba(0, 0, 0, 1)">Organization    : Online Game Dept
</span><span style="color: rgba(0, 128, 128, 1)">21</span> BuildNumber     : 26100
<span style="color: rgba(0, 128, 128, 1)">22</span> <span style="color: rgba(0, 0, 0, 1)">RegisteredUser  : Windows ç¨æ·
</span><span style="color: rgba(0, 128, 128, 1)">23</span> SerialNumber    : 00329-00000-00003-<span style="color: rgba(0, 0, 0, 1)">AA238
</span><span style="color: rgba(0, 128, 128, 1)">24</span> Version         : 10.0.26100</pre>
</div>
<p>è¿æMicrosoft Storage Spaces SMPæå¡ï¼å¦æGet-Diskæ¿ä¸å°ç£çï¼å®ä½å®¢æ·é®é¢åç°å¾å¤§å¯è½æ¯è¿ä¸ªæå¡å¼å¸¸äºãéå¯ä¸ä¸å³å¯</p>
<h1>WMI/CIMç£çç®¡ç</h1>
<p>WMIç¸å³å½ä»¤ï¼éè¦æåä¸ºä¿©é¨åï¼WIN32_*ç»å¸ç±»ï¼ä»¥åMSFT_*æ°çStorageWMIç±»</p>
<p><strong>ç»å¸ç±»ï¼</strong></p>
<ul>
<li>Win32_DiskDrive</li>
<li>Win32_DiskPartition</li>
<li>Win32_LogicalDisk</li>
<li>Win32_Volume</li>
</ul>
<p>æ©æè®¾è®¡ï¼å¾å¤æ¯éè¿åæ ¸ API + IOCTL å VDS å®ç°ãä¸»è¦ç¨äºæ¥è¯¢ï¼ä¿®æ¹æä½æé</p>
<p>ä¾èµæå¡ï¼WinmgmtãRPCSSï¼RPCæå¡ï¼ãä»¥åå°éä¾èµVDS</p>
<p><strong>StorageWmiç±»</strong></p>
<ul>
<li>MSFT_Disk</li>
<li>MSFT_Partition</li>
<li>MSFT_Volume</li>
<li>MSFT_StoragePool</li>
<li>MSFT_VirtualDisk</li>
</ul>
<p>è¿æ¯Windows8ä¹åçæ°å­å¨ç®¡çWMIæ¥å£ï¼è¯¦è§å®ç½ææ¡£ï¼<a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/storage/storage-management-api-classes" rel="noopener nofollow">Storage Management API Classes - Windows drivers | Microsoft Learn</a>, ä¾èµå±çº§ï¼</p>
<p>WMI (MSFT_* ç±»)<br>  -&gt; Storage Management Provider<br>     -&gt; IOCTL -&gt; disk.sys / partmgr.sys / ...</p>
<p>å·ä½ä¾èµçæå¡ï¼Winmgmtï¼WMI æå¡ï¼</p>
<p>WMI æ¯âç®¡çæ°æ®æ¨¡å + æ¥å£âï¼æ¬èº«ä¸æ¯ä¸ä¸ªç£çç®¡çâæ¹æ¡âï¼èæ¯å¾å¤æ¹æ¡çåºç¡æ¥å£ãç¸å¯¹Powershell Storageç®¡çï¼ç®æ¯æ¯è¾ç¨³å®åä¾èµè¾å°çäº</p>
<p>ç´æ¥ä½¿ç¨.NETéè¿WMIè·åè¯¦ç»çç£çåè¡¨æ°æ®ï¼ä»£ç å¦ä¸ï¼</p>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 128, 128, 1)"> 1</span>     <span style="color: rgba(0, 0, 255, 1)">public</span> OperateResult&lt;List&lt;LocalDisk&gt;&gt;<span style="color: rgba(0, 0, 0, 1)"> GetDisks()
</span><span style="color: rgba(0, 128, 128, 1)"> 2</span> <span style="color: rgba(0, 0, 0, 1)">    {
</span><span style="color: rgba(0, 128, 128, 1)"> 3</span>         <span style="color: rgba(0, 0, 255, 1)">var</span> disks = <span style="color: rgba(0, 0, 255, 1)">new</span> List&lt;LocalDisk&gt;<span style="color: rgba(0, 0, 0, 1)">();
</span><span style="color: rgba(0, 128, 128, 1)"> 4</span>         <span style="color: rgba(0, 0, 255, 1)">try</span>
<span style="color: rgba(0, 128, 128, 1)"> 5</span> <span style="color: rgba(0, 0, 0, 1)">        {
</span><span style="color: rgba(0, 128, 128, 1)"> 6</span>             <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> Win32_DiskDrive: ç©çç£ç</span>
<span style="color: rgba(0, 128, 128, 1)"> 7</span>             <span style="color: rgba(0, 0, 255, 1)">using</span> (<span style="color: rgba(0, 0, 255, 1)">var</span> searcher = <span style="color: rgba(0, 0, 255, 1)">new</span> ManagementObjectSearcher(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">SELECT * FROM Win32_DiskDrive</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">))
</span><span style="color: rgba(0, 128, 128, 1)"> 8</span>             <span style="color: rgba(0, 0, 255, 1)">using</span> (<span style="color: rgba(0, 0, 255, 1)">var</span> driveCollection =<span style="color: rgba(0, 0, 0, 1)"> searcher.Get())
</span><span style="color: rgba(0, 128, 128, 1)"> 9</span> <span style="color: rgba(0, 0, 0, 1)">            {
</span><span style="color: rgba(0, 128, 128, 1)">10</span>                 <span style="color: rgba(0, 0, 255, 1)">foreach</span> (ManagementObject drive <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> driveCollection)
</span><span style="color: rgba(0, 128, 128, 1)">11</span> <span style="color: rgba(0, 0, 0, 1)">                {
</span><span style="color: rgba(0, 128, 128, 1)">12</span>                     <span style="color: rgba(0, 0, 255, 1)">var</span> diskInfo = <span style="color: rgba(0, 0, 255, 1)">new</span><span style="color: rgba(0, 0, 0, 1)"> LocalDisk();
</span><span style="color: rgba(0, 128, 128, 1)">13</span> 
<span style="color: rgba(0, 128, 128, 1)">14</span>                     <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> 1. ç£çç¼å· PhysicalDriveN
</span><span style="color: rgba(0, 128, 128, 1)">15</span>                     <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> Win32_DiskDrive.DeviceID ä¸è¬ä¸º "\\.\PHYSICALDRIVE0"</span>
<span style="color: rgba(0, 128, 128, 1)">16</span>                     <span style="color: rgba(0, 0, 255, 1)">var</span> deviceId = (drive[<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">DeviceID</span><span style="color: rgba(128, 0, 0, 1)">"</span>] <span style="color: rgba(0, 0, 255, 1)">as</span> <span style="color: rgba(0, 0, 255, 1)">string</span>) ?? <span style="color: rgba(0, 0, 255, 1)">string</span><span style="color: rgba(0, 0, 0, 1)">.Empty;
</span><span style="color: rgba(0, 128, 128, 1)">17</span>                     <span style="color: rgba(0, 0, 255, 1)">var</span> diskNumber =<span style="color: rgba(0, 0, 0, 1)"> ParsePhysicalDriveNumber(deviceId);
</span><span style="color: rgba(0, 128, 128, 1)">18</span>                     diskInfo.Number =<span style="color: rgba(0, 0, 0, 1)"> diskNumber;
</span><span style="color: rgba(0, 128, 128, 1)">19</span> 
<span style="color: rgba(0, 128, 128, 1)">20</span>                     <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> 2. åºåå· (ä¸åååæ ¼å¼ä¸ç»ä¸ï¼ææ¶éè¦ Win32_PhysicalMedia)</span>
<span style="color: rgba(0, 128, 128, 1)">21</span>                     diskInfo.SerialNumber = (drive[<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">SerialNumber</span><span style="color: rgba(128, 0, 0, 1)">"</span>] <span style="color: rgba(0, 0, 255, 1)">as</span> <span style="color: rgba(0, 0, 255, 1)">string</span>)?.Trim() ?? <span style="color: rgba(0, 0, 255, 1)">string</span><span style="color: rgba(0, 0, 0, 1)">.Empty;
</span><span style="color: rgba(0, 128, 128, 1)">22</span> 
<span style="color: rgba(0, 128, 128, 1)">23</span>                     <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> 3. DeviceName</span>
<span style="color: rgba(0, 128, 128, 1)">24</span>                     diskInfo.DeviceName = (drive[<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Model</span><span style="color: rgba(128, 0, 0, 1)">"</span>] <span style="color: rgba(0, 0, 255, 1)">as</span> <span style="color: rgba(0, 0, 255, 1)">string</span>)?.Trim() ?? <span style="color: rgba(0, 0, 255, 1)">string</span><span style="color: rgba(0, 0, 0, 1)">.Empty;
</span><span style="color: rgba(0, 128, 128, 1)">25</span> 
<span style="color: rgba(0, 128, 128, 1)">26</span>                     <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> 4. åªè¯»/å¨çº¿ç¶æï¼WMI å¹¶æ²¡æéå¸¸æ åçå­æ®µï¼è¿éç¨ç²ç¥æ å°ï¼
</span><span style="color: rgba(0, 128, 128, 1)">27</span>                     <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">   Win32_DiskDrive.Status: "OK" / "Error" / "Degraded" ...</span>
<span style="color: rgba(0, 128, 128, 1)">28</span>                     diskInfo.IsOffline =<span style="color: rgba(0, 0, 0, 1)"> GetOffline(diskNumber);
</span><span style="color: rgba(0, 128, 128, 1)">29</span> 
<span style="color: rgba(0, 128, 128, 1)">30</span>                     <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> æ²¡æç´æ¥ readonly æ è®°ï¼åé»è®¤ä¸º falseï¼
</span><span style="color: rgba(0, 128, 128, 1)">31</span>                     <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> å¦éæ´ç²¾ç¡®å¯ä»¥éè¿ Win32_Volume æ DeviceIoControl è·åã</span>
<span style="color: rgba(0, 128, 128, 1)">32</span>                     diskInfo.IsReadOnly =<span style="color: rgba(0, 0, 0, 1)"> GetReadonly(diskNumber);
</span><span style="color: rgba(0, 128, 128, 1)">33</span> 
<span style="color: rgba(0, 128, 128, 1)">34</span>                     <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> 5. æ»çº¿ç±»åï¼æ²¡æ STORAGE_BUS_TYPE æä¸¾ï¼ä½¿ç¨ InterfaceType ç²ç¥æ å°ï¼</span>
<span style="color: rgba(0, 128, 128, 1)">35</span>                     <span style="color: rgba(0, 0, 255, 1)">var</span> interfaceType = (drive[<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">InterfaceType</span><span style="color: rgba(128, 0, 0, 1)">"</span>] <span style="color: rgba(0, 0, 255, 1)">as</span> <span style="color: rgba(0, 0, 255, 1)">string</span>)?<span style="color: rgba(0, 0, 0, 1)">.Trim();
</span><span style="color: rgba(0, 128, 128, 1)">36</span>                     diskInfo.BusType =<span style="color: rgba(0, 0, 0, 1)"> MapBusType(interfaceType, diskInfo.DeviceName);
</span><span style="color: rgba(0, 128, 128, 1)">37</span> 
<span style="color: rgba(0, 128, 128, 1)">38</span>                     <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> 6. ç£çå®¹é (å­è -&gt; GB)
</span><span style="color: rgba(0, 128, 128, 1)">39</span>                     <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> Win32_DiskDrive.Size ä¸ºå­èæ°ï¼stringï¼</span>
<span style="color: rgba(0, 128, 128, 1)">40</span>                     <span style="color: rgba(0, 0, 255, 1)">if</span> (drive[<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Size</span><span style="color: rgba(128, 0, 0, 1)">"</span>] != <span style="color: rgba(0, 0, 255, 1)">null</span> &amp;&amp; <span style="color: rgba(0, 0, 255, 1)">long</span>.TryParse(drive[<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Size</span><span style="color: rgba(128, 0, 0, 1)">"</span>].ToString(), <span style="color: rgba(0, 0, 255, 1)">out</span> <span style="color: rgba(0, 0, 255, 1)">long</span><span style="color: rgba(0, 0, 0, 1)"> sizeBytes))
</span><span style="color: rgba(0, 128, 128, 1)">41</span> <span style="color: rgba(0, 0, 0, 1)">                    {
</span><span style="color: rgba(0, 128, 128, 1)">42</span>                         diskInfo.DiskSize =<span style="color: rgba(0, 0, 0, 1)"> sizeBytes;
</span><span style="color: rgba(0, 128, 128, 1)">43</span> <span style="color: rgba(0, 0, 0, 1)">                    }
</span><span style="color: rgba(0, 128, 128, 1)">44</span> 
<span style="color: rgba(0, 128, 128, 1)">45</span>                     <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> 7. è·åæè½½ç¹åå·²ç¨å®¹éï¼éè¿ 3 å¼  WMI å³èè¡¨ï¼
</span><span style="color: rgba(0, 128, 128, 1)">46</span>                     <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> Win32_DiskDrive -&gt; Win32_DiskDriveToDiskPartition -&gt; Win32_DiskPartition -&gt;
</span><span style="color: rgba(0, 128, 128, 1)">47</span>                     <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> Win32_LogicalDiskToPartition -&gt; Win32_LogicalDisk</span>
<span style="color: rgba(0, 128, 128, 1)">48</span> <span style="color: rgba(0, 0, 0, 1)">                    FillMountPathsAndUsedSize(diskInfo, drive);
</span><span style="color: rgba(0, 128, 128, 1)">49</span> <span style="color: rgba(0, 0, 0, 1)">                    disks.Add(diskInfo);
</span><span style="color: rgba(0, 128, 128, 1)">50</span> 
<span style="color: rgba(0, 128, 128, 1)">51</span>                     diskInfo.Tag =<span style="color: rgba(0, 0, 0, 1)"> GetVolumeLabel(diskInfo.MountPaths.FirstOrDefault());
</span><span style="color: rgba(0, 128, 128, 1)">52</span> <span style="color: rgba(0, 0, 0, 1)">                }
</span><span style="color: rgba(0, 128, 128, 1)">53</span> <span style="color: rgba(0, 0, 0, 1)">            }
</span><span style="color: rgba(0, 128, 128, 1)">54</span> 
<span style="color: rgba(0, 128, 128, 1)">55</span>             <span style="color: rgba(0, 0, 255, 1)">return</span> OperateResult&lt;List&lt;LocalDisk&gt;&gt;.ToSuccess(disks.OrderBy(i =&gt;<span style="color: rgba(0, 0, 0, 1)"> i.Number).ToList());
</span><span style="color: rgba(0, 128, 128, 1)">56</span> <span style="color: rgba(0, 0, 0, 1)">        }
</span><span style="color: rgba(0, 128, 128, 1)">57</span>         <span style="color: rgba(0, 0, 255, 1)">catch</span><span style="color: rgba(0, 0, 0, 1)"> (Exception ex)
</span><span style="color: rgba(0, 128, 128, 1)">58</span> <span style="color: rgba(0, 0, 0, 1)">        {
</span><span style="color: rgba(0, 128, 128, 1)">59</span>             <span style="color: rgba(0, 0, 255, 1)">return</span> OperateResult&lt;List&lt;LocalDisk&gt;&gt;<span style="color: rgba(0, 0, 0, 1)">.ToError(ex.Message);
</span><span style="color: rgba(0, 128, 128, 1)">60</span> <span style="color: rgba(0, 0, 0, 1)">        }
</span><span style="color: rgba(0, 128, 128, 1)">61</span>     }</pre>
</div>
<p>éå¸¦çä¸äºå±æ§è·åå½æ°ï¼</p>
<div class="cnblogs_code"><img src="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" id="code_img_closed_ac2201cc-0955-4850-bc5f-4794df011a32" class="code_img_closed"><img src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" id="code_img_opened_ac2201cc-0955-4850-bc5f-4794df011a32" class="code_img_opened" style="display: none">
<div id="cnblogs_code_open_ac2201cc-0955-4850-bc5f-4794df011a32" class="cnblogs_code_hide">
<pre><span style="color: rgba(0, 128, 128, 1)">  1</span>     <span style="color: rgba(0, 0, 255, 1)">private</span> <span style="color: rgba(0, 0, 255, 1)">int</span> ParsePhysicalDriveNumber(<span style="color: rgba(0, 0, 255, 1)">string</span><span style="color: rgba(0, 0, 0, 1)"> deviceId)
</span><span style="color: rgba(0, 128, 128, 1)">  2</span> <span style="color: rgba(0, 0, 0, 1)">    {
</span><span style="color: rgba(0, 128, 128, 1)">  3</span>         <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> "\\.\PHYSICALDRIVE0" -&gt; 0</span>
<span style="color: rgba(0, 128, 128, 1)">  4</span>         <span style="color: rgba(0, 0, 255, 1)">if</span> (<span style="color: rgba(0, 0, 255, 1)">string</span><span style="color: rgba(0, 0, 0, 1)">.IsNullOrWhiteSpace(deviceId))
</span><span style="color: rgba(0, 128, 128, 1)">  5</span>             <span style="color: rgba(0, 0, 255, 1)">return</span> -<span style="color: rgba(128, 0, 128, 1)">1</span><span style="color: rgba(0, 0, 0, 1)">;
</span><span style="color: rgba(0, 128, 128, 1)">  6</span> 
<span style="color: rgba(0, 128, 128, 1)">  7</span>         <span style="color: rgba(0, 0, 255, 1)">var</span> upper =<span style="color: rgba(0, 0, 0, 1)"> deviceId.ToUpperInvariant();
</span><span style="color: rgba(0, 128, 128, 1)">  8</span>         <span style="color: rgba(0, 0, 255, 1)">var</span> idx = upper.LastIndexOf(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">PHYSICALDRIVE</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">, StringComparison.Ordinal);
</span><span style="color: rgba(0, 128, 128, 1)">  9</span>         <span style="color: rgba(0, 0, 255, 1)">if</span> (idx &lt; <span style="color: rgba(128, 0, 128, 1)">0</span>) <span style="color: rgba(0, 0, 255, 1)">return</span> -<span style="color: rgba(128, 0, 128, 1)">1</span><span style="color: rgba(0, 0, 0, 1)">;
</span><span style="color: rgba(0, 128, 128, 1)"> 10</span> 
<span style="color: rgba(0, 128, 128, 1)"> 11</span>         <span style="color: rgba(0, 0, 255, 1)">var</span> numPart = upper.Substring(idx + <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">PHYSICALDRIVE</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">.Length);
</span><span style="color: rgba(0, 128, 128, 1)"> 12</span>         <span style="color: rgba(0, 0, 255, 1)">if</span> (<span style="color: rgba(0, 0, 255, 1)">int</span>.TryParse(numPart, NumberStyles.Integer, CultureInfo.InvariantCulture, <span style="color: rgba(0, 0, 255, 1)">out</span> <span style="color: rgba(0, 0, 255, 1)">var</span><span style="color: rgba(0, 0, 0, 1)"> num))
</span><span style="color: rgba(0, 128, 128, 1)"> 13</span>             <span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)"> num;
</span><span style="color: rgba(0, 128, 128, 1)"> 14</span> 
<span style="color: rgba(0, 128, 128, 1)"> 15</span>         <span style="color: rgba(0, 0, 255, 1)">return</span> -<span style="color: rgba(128, 0, 128, 1)">1</span><span style="color: rgba(0, 0, 0, 1)">;
</span><span style="color: rgba(0, 128, 128, 1)"> 16</span> <span style="color: rgba(0, 0, 0, 1)">    }
</span><span style="color: rgba(0, 128, 128, 1)"> 17</span> 
<span style="color: rgba(0, 128, 128, 1)"> 18</span>     <span style="color: rgba(0, 0, 255, 1)">private</span> StorageBusType MapBusType(<span style="color: rgba(0, 0, 255, 1)">string</span> interfaceType, <span style="color: rgba(0, 0, 255, 1)">string</span><span style="color: rgba(0, 0, 0, 1)"> deviceName)
</span><span style="color: rgba(0, 128, 128, 1)"> 19</span> <span style="color: rgba(0, 0, 0, 1)">    {
</span><span style="color: rgba(0, 128, 128, 1)"> 20</span>         <span style="color: rgba(0, 0, 255, 1)">if</span> (<span style="color: rgba(0, 0, 255, 1)">string</span><span style="color: rgba(0, 0, 0, 1)">.IsNullOrEmpty(interfaceType))
</span><span style="color: rgba(0, 128, 128, 1)"> 21</span>             <span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)"> StorageBusType.Unknown;
</span><span style="color: rgba(0, 128, 128, 1)"> 22</span> 
<span style="color: rgba(0, 128, 128, 1)"> 23</span>         <span style="color: rgba(0, 0, 255, 1)">switch</span><span style="color: rgba(0, 0, 0, 1)"> (interfaceType.ToUpperInvariant())
</span><span style="color: rgba(0, 128, 128, 1)"> 24</span> <span style="color: rgba(0, 0, 0, 1)">        {
</span><span style="color: rgba(0, 128, 128, 1)"> 25</span>             <span style="color: rgba(0, 0, 255, 1)">case</span> <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">SCSI</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">:
</span><span style="color: rgba(0, 128, 128, 1)"> 26</span>                 <span style="color: rgba(0, 0, 255, 1)">if</span> (deviceName.Contains(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">SCSI</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">))
</span><span style="color: rgba(0, 128, 128, 1)"> 27</span> <span style="color: rgba(0, 0, 0, 1)">                {
</span><span style="color: rgba(0, 128, 128, 1)"> 28</span>                     <span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)"> StorageBusType.Iscsi;
</span><span style="color: rgba(0, 128, 128, 1)"> 29</span> <span style="color: rgba(0, 0, 0, 1)">                }
</span><span style="color: rgba(0, 128, 128, 1)"> 30</span>                 <span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)"> StorageBusType.Scsi;
</span><span style="color: rgba(0, 128, 128, 1)"> 31</span>             <span style="color: rgba(0, 0, 255, 1)">case</span> <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">IDE</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">:
</span><span style="color: rgba(0, 128, 128, 1)"> 32</span>             <span style="color: rgba(0, 0, 255, 1)">case</span> <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">ATA</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">:
</span><span style="color: rgba(0, 128, 128, 1)"> 33</span>                 <span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)"> StorageBusType.Ata;
</span><span style="color: rgba(0, 128, 128, 1)"> 34</span>             <span style="color: rgba(0, 0, 255, 1)">case</span> <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">USB</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">:
</span><span style="color: rgba(0, 128, 128, 1)"> 35</span>                 <span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)"> StorageBusType.Usb;
</span><span style="color: rgba(0, 128, 128, 1)"> 36</span>             <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> å¯æ ¹æ®éè¦æ©å±æ å°</span>
<span style="color: rgba(0, 128, 128, 1)"> 37</span>             <span style="color: rgba(0, 0, 255, 1)">default</span><span style="color: rgba(0, 0, 0, 1)">:
</span><span style="color: rgba(0, 128, 128, 1)"> 38</span>                 <span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)"> StorageBusType.Unknown;
</span><span style="color: rgba(0, 128, 128, 1)"> 39</span> <span style="color: rgba(0, 0, 0, 1)">        }
</span><span style="color: rgba(0, 128, 128, 1)"> 40</span> <span style="color: rgba(0, 0, 0, 1)">    }
</span><span style="color: rgba(0, 128, 128, 1)"> 41</span> 
<span style="color: rgba(0, 128, 128, 1)"> 42</span>     <span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;summary&gt;</span>
<span style="color: rgba(0, 128, 128, 1)"> 43</span>     <span style="color: rgba(128, 128, 128, 1)">///</span><span style="color: rgba(0, 128, 0, 1)"> å¡«å MountPathsï¼çç¬¦ï¼å DiskUsedSizeï¼GBï¼
</span><span style="color: rgba(0, 128, 128, 1)"> 44</span>     <span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;/summary&gt;</span>
<span style="color: rgba(0, 128, 128, 1)"> 45</span>     <span style="color: rgba(0, 0, 255, 1)">private</span><span style="color: rgba(0, 0, 0, 1)"> OperateResult FillMountPathsAndUsedSize(LocalDisk diskInfo, ManagementObject diskDrive)
</span><span style="color: rgba(0, 128, 128, 1)"> 46</span> <span style="color: rgba(0, 0, 0, 1)">    {
</span><span style="color: rgba(0, 128, 128, 1)"> 47</span>         <span style="color: rgba(0, 0, 255, 1)">long</span> totalUsedBytes = <span style="color: rgba(128, 0, 128, 1)">0</span><span style="color: rgba(0, 0, 0, 1)">;
</span><span style="color: rgba(0, 128, 128, 1)"> 48</span> 
<span style="color: rgba(0, 128, 128, 1)"> 49</span>         <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> éè¿ Win32_DiskDriveToDiskPartition å³èå°ååº</span>
<span style="color: rgba(0, 128, 128, 1)"> 50</span>         <span style="color: rgba(0, 0, 255, 1)">using</span> (<span style="color: rgba(0, 0, 255, 1)">var</span> partitionRel = <span style="color: rgba(0, 0, 255, 1)">new</span><span style="color: rgba(0, 0, 0, 1)"> ManagementObjectSearcher(
</span><span style="color: rgba(0, 128, 128, 1)"> 51</span>                    <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">ASSOCIATORS OF {Win32_DiskDrive.DeviceID='</span><span style="color: rgba(128, 0, 0, 1)">"</span> + diskDrive[<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">DeviceID</span><span style="color: rgba(128, 0, 0, 1)">"</span>] +
<span style="color: rgba(0, 128, 128, 1)"> 52</span>                    <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">'} WHERE AssocClass = Win32_DiskDriveToDiskPartition</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">))
</span><span style="color: rgba(0, 128, 128, 1)"> 53</span>         <span style="color: rgba(0, 0, 255, 1)">using</span> (<span style="color: rgba(0, 0, 255, 1)">var</span> partitions =<span style="color: rgba(0, 0, 0, 1)"> partitionRel.Get())
</span><span style="color: rgba(0, 128, 128, 1)"> 54</span> <span style="color: rgba(0, 0, 0, 1)">        {
</span><span style="color: rgba(0, 128, 128, 1)"> 55</span>             <span style="color: rgba(0, 0, 255, 1)">foreach</span> (ManagementObject partition <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> partitions)
</span><span style="color: rgba(0, 128, 128, 1)"> 56</span> <span style="color: rgba(0, 0, 0, 1)">            {
</span><span style="color: rgba(0, 128, 128, 1)"> 57</span>                 <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> éè¿ Win32_LogicalDiskToPartition å³èå°é»è¾ç£çï¼çç¬¦ï¼</span>
<span style="color: rgba(0, 128, 128, 1)"> 58</span>                 <span style="color: rgba(0, 0, 255, 1)">using</span> (<span style="color: rgba(0, 0, 255, 1)">var</span> logicalRel = <span style="color: rgba(0, 0, 255, 1)">new</span><span style="color: rgba(0, 0, 0, 1)"> ManagementObjectSearcher(
</span><span style="color: rgba(0, 128, 128, 1)"> 59</span>                            <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">ASSOCIATORS OF {Win32_DiskPartition.DeviceID='</span><span style="color: rgba(128, 0, 0, 1)">"</span> + partition[<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">DeviceID</span><span style="color: rgba(128, 0, 0, 1)">"</span>] +
<span style="color: rgba(0, 128, 128, 1)"> 60</span>                            <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">'} WHERE AssocClass = Win32_LogicalDiskToPartition</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">))
</span><span style="color: rgba(0, 128, 128, 1)"> 61</span>                 <span style="color: rgba(0, 0, 255, 1)">using</span> (<span style="color: rgba(0, 0, 255, 1)">var</span> logicalDisks =<span style="color: rgba(0, 0, 0, 1)"> logicalRel.Get())
</span><span style="color: rgba(0, 128, 128, 1)"> 62</span> <span style="color: rgba(0, 0, 0, 1)">                {
</span><span style="color: rgba(0, 128, 128, 1)"> 63</span>                     <span style="color: rgba(0, 0, 255, 1)">foreach</span> (ManagementObject logicalDisk <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> logicalDisks)
</span><span style="color: rgba(0, 128, 128, 1)"> 64</span> <span style="color: rgba(0, 0, 0, 1)">                    {
</span><span style="color: rgba(0, 128, 128, 1)"> 65</span>                         <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> è®¡ç®å·²ç¨ç©ºé´</span>
<span style="color: rgba(0, 128, 128, 1)"> 66</span>                         <span style="color: rgba(0, 0, 255, 1)">if</span> (logicalDisk[<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Size</span><span style="color: rgba(128, 0, 0, 1)">"</span>] != <span style="color: rgba(0, 0, 255, 1)">null</span> &amp;&amp;
<span style="color: rgba(0, 128, 128, 1)"> 67</span>                             logicalDisk[<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">FreeSpace</span><span style="color: rgba(128, 0, 0, 1)">"</span>] != <span style="color: rgba(0, 0, 255, 1)">null</span> &amp;&amp;
<span style="color: rgba(0, 128, 128, 1)"> 68</span>                             <span style="color: rgba(0, 0, 255, 1)">long</span>.TryParse(logicalDisk[<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Size</span><span style="color: rgba(128, 0, 0, 1)">"</span>].ToString(), <span style="color: rgba(0, 0, 255, 1)">out</span> <span style="color: rgba(0, 0, 255, 1)">long</span> volSize) &amp;&amp;
<span style="color: rgba(0, 128, 128, 1)"> 69</span>                             <span style="color: rgba(0, 0, 255, 1)">long</span>.TryParse(logicalDisk[<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">FreeSpace</span><span style="color: rgba(128, 0, 0, 1)">"</span>].ToString(), <span style="color: rgba(0, 0, 255, 1)">out</span> <span style="color: rgba(0, 0, 255, 1)">long</span><span style="color: rgba(0, 0, 0, 1)"> free))
</span><span style="color: rgba(0, 128, 128, 1)"> 70</span> <span style="color: rgba(0, 0, 0, 1)">                        {
</span><span style="color: rgba(0, 128, 128, 1)"> 71</span>                             totalUsedBytes += (volSize -<span style="color: rgba(0, 0, 0, 1)"> free);
</span><span style="color: rgba(0, 128, 128, 1)"> 72</span> <span style="color: rgba(0, 0, 0, 1)">                        }
</span><span style="color: rgba(0, 128, 128, 1)"> 73</span> <span style="color: rgba(0, 0, 0, 1)">                    }
</span><span style="color: rgba(0, 128, 128, 1)"> 74</span> <span style="color: rgba(0, 0, 0, 1)">                }
</span><span style="color: rgba(0, 128, 128, 1)"> 75</span> <span style="color: rgba(0, 0, 0, 1)">            }
</span><span style="color: rgba(0, 128, 128, 1)"> 76</span> <span style="color: rgba(0, 0, 0, 1)">        }
</span><span style="color: rgba(0, 128, 128, 1)"> 77</span> 
<span style="color: rgba(0, 128, 128, 1)"> 78</span>         diskInfo.DiskUsedSize =<span style="color: rgba(0, 0, 0, 1)">totalUsedBytes;
</span><span style="color: rgba(0, 128, 128, 1)"> 79</span> 
<span style="color: rgba(0, 128, 128, 1)"> 80</span>         <span style="color: rgba(0, 0, 255, 1)">try</span>
<span style="color: rgba(0, 128, 128, 1)"> 81</span> <span style="color: rgba(0, 0, 0, 1)">        {
</span><span style="color: rgba(0, 128, 128, 1)"> 82</span>             <span style="color: rgba(0, 0, 255, 1)">var</span> paths =<span style="color: rgba(0, 0, 0, 1)"> GetAccessPaths(diskInfo.Number);
</span><span style="color: rgba(0, 128, 128, 1)"> 83</span>             <span style="color: rgba(0, 0, 255, 1)">var</span> filtedPaths = paths.Where(i =&gt; !i.StartsWith(<span style="color: rgba(128, 0, 0, 1)">@"</span><span style="color: rgba(128, 0, 0, 1)">\\?\Volume</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)).ToList();
</span><span style="color: rgba(0, 128, 128, 1)"> 84</span>             diskInfo.MountPaths =<span style="color: rgba(0, 0, 0, 1)"> filtedPaths;
</span><span style="color: rgba(0, 128, 128, 1)"> 85</span>             <span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)"> OperateResult.ToSuccess();
</span><span style="color: rgba(0, 128, 128, 1)"> 86</span> <span style="color: rgba(0, 0, 0, 1)">        }
</span><span style="color: rgba(0, 128, 128, 1)"> 87</span>         <span style="color: rgba(0, 0, 255, 1)">catch</span><span style="color: rgba(0, 0, 0, 1)"> (Exception e)
</span><span style="color: rgba(0, 128, 128, 1)"> 88</span> <span style="color: rgba(0, 0, 0, 1)">        {
</span><span style="color: rgba(0, 128, 128, 1)"> 89</span>            <span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)"> OperateResult.ToError(e);
</span><span style="color: rgba(0, 128, 128, 1)"> 90</span> <span style="color: rgba(0, 0, 0, 1)">        }
</span><span style="color: rgba(0, 128, 128, 1)"> 91</span> <span style="color: rgba(0, 0, 0, 1)">    }
</span><span style="color: rgba(0, 128, 128, 1)"> 92</span>     <span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;summary&gt;</span>
<span style="color: rgba(0, 128, 128, 1)"> 93</span>     <span style="color: rgba(128, 128, 128, 1)">///</span><span style="color: rgba(0, 128, 0, 1)"> è·åç£ççææè®¿é®è·¯å¾
</span><span style="color: rgba(0, 128, 128, 1)"> 94</span>     <span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;/summary&gt;</span>
<span style="color: rgba(0, 128, 128, 1)"> 95</span>     <span style="color: rgba(0, 0, 255, 1)">private</span> List&lt;<span style="color: rgba(0, 0, 255, 1)">string</span>&gt; GetAccessPaths(<span style="color: rgba(0, 0, 255, 1)">int</span><span style="color: rgba(0, 0, 0, 1)"> diskNumber)
</span><span style="color: rgba(0, 128, 128, 1)"> 96</span> <span style="color: rgba(0, 0, 0, 1)">    {
</span><span style="color: rgba(0, 128, 128, 1)"> 97</span>         ManagementScope scope = <span style="color: rgba(0, 0, 255, 1)">new</span> ManagementScope(<span style="color: rgba(128, 0, 0, 1)">@"</span><span style="color: rgba(128, 0, 0, 1)">\\.\root\Microsoft\Windows\Storage</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">);
</span><span style="color: rgba(0, 128, 128, 1)"> 98</span> <span style="color: rgba(0, 0, 0, 1)">        scope.Connect();
</span><span style="color: rgba(0, 128, 128, 1)"> 99</span>         <span style="color: rgba(0, 0, 255, 1)">string</span> query = $<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">SELECT * FROM MSFT_Partition WHERE DiskNumber = {diskNumber}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">;
</span><span style="color: rgba(0, 128, 128, 1)">100</span>         <span style="color: rgba(0, 0, 255, 1)">using</span> ManagementObjectSearcher searcher = <span style="color: rgba(0, 0, 255, 1)">new</span> ManagementObjectSearcher(scope, <span style="color: rgba(0, 0, 255, 1)">new</span><span style="color: rgba(0, 0, 0, 1)"> ObjectQuery(query));
</span><span style="color: rgba(0, 128, 128, 1)">101</span>         <span style="color: rgba(0, 0, 255, 1)">var</span> pathList = <span style="color: rgba(0, 0, 255, 1)">new</span> List&lt;<span style="color: rgba(0, 0, 255, 1)">string</span>&gt;<span style="color: rgba(0, 0, 0, 1)">();
</span><span style="color: rgba(0, 128, 128, 1)">102</span>         <span style="color: rgba(0, 0, 255, 1)">foreach</span> (<span style="color: rgba(0, 0, 255, 1)">var</span> partition <span style="color: rgba(0, 0, 255, 1)">in</span> searcher.Get().Cast&lt;ManagementObject&gt;<span style="color: rgba(0, 0, 0, 1)">())
</span><span style="color: rgba(0, 128, 128, 1)">103</span> <span style="color: rgba(0, 0, 0, 1)">        {
</span><span style="color: rgba(0, 128, 128, 1)">104</span>             <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> è·å AccessPaths å±æ§ï¼æ°ç»ï¼</span>
<span style="color: rgba(0, 128, 128, 1)">105</span>             <span style="color: rgba(0, 0, 255, 1)">var</span> accessPaths = partition[<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">AccessPaths</span><span style="color: rgba(128, 0, 0, 1)">"</span>] <span style="color: rgba(0, 0, 255, 1)">as</span> <span style="color: rgba(0, 0, 255, 1)">string</span><span style="color: rgba(0, 0, 0, 1)">[];
</span><span style="color: rgba(0, 128, 128, 1)">106</span>             <span style="color: rgba(0, 0, 255, 1)">if</span> (accessPaths == <span style="color: rgba(0, 0, 255, 1)">null</span><span style="color: rgba(0, 0, 0, 1)">)
</span><span style="color: rgba(0, 128, 128, 1)">107</span> <span style="color: rgba(0, 0, 0, 1)">            {
</span><span style="color: rgba(0, 128, 128, 1)">108</span>                 <span style="color: rgba(0, 0, 255, 1)">continue</span><span style="color: rgba(0, 0, 0, 1)">;
</span><span style="color: rgba(0, 128, 128, 1)">109</span> <span style="color: rgba(0, 0, 0, 1)">            }
</span><span style="color: rgba(0, 128, 128, 1)">110</span> <span style="color: rgba(0, 0, 0, 1)">            pathList.AddRange(accessPaths);
</span><span style="color: rgba(0, 128, 128, 1)">111</span> <span style="color: rgba(0, 0, 0, 1)">        }
</span><span style="color: rgba(0, 128, 128, 1)">112</span>         <span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)"> pathList;
</span><span style="color: rgba(0, 128, 128, 1)">113</span>     }</pre>
</div>
<span class="cnblogs_code_collapse">View Code</span></div>
<p>éåç£çåè¡¨ï¼4åçèæ¶æ¥è¿1sï¼</p>
<p><img src="https://img2024.cnblogs.com/blog/685541/202601/685541-20260112202253746-677311477.png" alt="image" loading="lazy"></p>
<h1>DiskPartç£çç®¡ç</h1>
<p>diskpart æ¯ åç Win32 å½ä»¤è¡å·¥å·ï¼åé¨å¤§è´éè¿ï¼</p>
<ul>
<li>VDS / Storage Management APIï¼èç³»ç»ï¼</li>
<li>æ°ç³»ç»ä¸ï¼ä¸é¨ååè½ç±æ°ç Storage API æ¥ç®¡</li>
<li>åå¾ä¸è¿æ¯ IOCTL è°ç¨åæ ¸é©±å¨</li>
</ul>
<p>è°ç¨å±çº§å¦ä¸ï¼diskpart.exe<br>  -&gt; VDS / Storage Management API<br>     -&gt; åæ ¸é©±å¨ (disk.sys, partmgr.sys, volmgr.sys)<br>        -&gt; è®¾å¤ç¡¬ä»¶</p>
<p>diskpartå¸¸ç¨å½ä»¤åè¡¨ï¼</p>
<ul>
<li>list disk</li>
<li>select disk 1</li>
<li>detail disk</li>
<li>list partition</li>
<li>list volume</li>








</ul>
<p><img src="https://img2024.cnblogs.com/blog/685541/202601/685541-20260112202413306-148039174.png" alt="image" loading="lazy"></p>
<p>DiskPartå¯¹WMIå¹¶ä¸å¼ºä¾èµï¼åºæ¬ä¸ä¾èµæå¡å°±ä¸ä¸ªVirtual Diskäºï¼æä½ä¹æ¯è¾ç®åãä½ç¼ºç¹ä¹æ¯è¾ææ¾ï¼è®¿é®æ§è½æ¯è¾å·®ãç£çæä½ä½¿ç¨Powersehellè°ç¨diskpartå½ä»¤åºæ¬ä¹å¨sçº§ä»¥ä¸</p>
<h1>Win32 IOCTLç£çç®¡ç</h1>
<p>IOCTLæ¯æéè¿ç´æ¥è°ç¨ Windows API DeviceIoControl å¯¹ç£çãå·ãæä»¶å¥æåéæ§å¶ç ï¼</p>
<ul>
<li>IOCTL_DISK_*</li>
<li>IOCTL_STORAGE_*</li>
<li>FSCTL_*ï¼éå¯¹æä»¶ç³»ç»ï¼</li>








</ul>
<p>IOCTLææ¡£ï¼<a href="https://learn.microsoft.com/zh-cn/windows/win32/api/ioapiset/nf-ioapiset-deviceiocontrol" rel="noopener nofollow">deviceIoControl å½æ° (ioapiset.h) - Win32 apps | Microsoft Learn</a>ã<a href="https://learn.microsoft.com/zh-cn/windows/win32/api/winioctl/" rel="noopener nofollow">Winioctl.h æ å¤´ - Win32 apps | Microsoft Learn</a></p>
<p>ç£çç®¡çè¯¦ç»ææ¡£ï¼<a href="https://learn.microsoft.com/zh-cn/windows/win32/fileio/disk-management" rel="noopener nofollow">ç£çç®¡ç - Win32 apps | Microsoft Learn</a></p>
<p>WIN32æ¹æ¡ï¼ä¸ä¾èµ VDS / WMI ç­ä¸å±æ¡æ¶</p>
<p>ä»ä¾èµï¼</p>
<ul>
<li>Win32 å­ç³»ç» + åæ ¸ I/O æ </li>
<li>å¯¹åºçè®¾å¤é©±å¨ï¼disk.sys, storport.sys, nvme.sys ç­ï¼</li>








</ul>
<p>éè¦åºäºWIN32APIä¸å±å±å¤çç»èï¼æ¯å¦è·åç£çåè¡¨ï¼</p>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 128, 128, 1)"> 1</span>     <span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;summary&gt;</span>
<span style="color: rgba(0, 128, 128, 1)"> 2</span>     <span style="color: rgba(128, 128, 128, 1)">///</span><span style="color: rgba(0, 128, 0, 1)"> éè¿ç£çç¼å·è·ååºåå·SerialNumber
</span><span style="color: rgba(0, 128, 128, 1)"> 3</span>     <span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;/summary&gt;</span>
<span style="color: rgba(0, 128, 128, 1)"> 4</span>     <span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;param name="diskNumber"&gt;</span><span style="color: rgba(0, 128, 0, 1)">ç£çç¼å·</span><span style="color: rgba(128, 128, 128, 1)">&lt;/param&gt;</span>
<span style="color: rgba(0, 128, 128, 1)"> 5</span>     <span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;param name="volumeMaps"&gt;&lt;/param&gt;</span>
<span style="color: rgba(0, 128, 128, 1)"> 6</span>     <span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;returns&gt;&lt;/returns&gt;</span>
<span style="color: rgba(0, 128, 128, 1)"> 7</span>     <span style="color: rgba(0, 0, 255, 1)">private</span> OperateResult&lt;LocalDisk&gt; GetDiskInfoByDiskNumber(<span style="color: rgba(0, 0, 255, 1)">int</span> diskNumber, Dictionary&lt;<span style="color: rgba(0, 0, 255, 1)">int</span>, List&lt;<span style="color: rgba(0, 0, 255, 1)">string</span>&gt;&gt;<span style="color: rgba(0, 0, 0, 1)"> volumeMaps)
</span><span style="color: rgba(0, 128, 128, 1)"> 8</span> <span style="color: rgba(0, 0, 0, 1)">    {
</span><span style="color: rgba(0, 128, 128, 1)"> 9</span>         <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">éä¸ªå°è¯ PhysicalDrive0..N</span>
<span style="color: rgba(0, 128, 128, 1)">10</span>         <span style="color: rgba(0, 0, 255, 1)">string</span> physicalDrive = <span style="color: rgba(128, 0, 0, 1)">@"</span><span style="color: rgba(128, 0, 0, 1)">\\.\PhysicalDrive</span><span style="color: rgba(128, 0, 0, 1)">"</span> +<span style="color: rgba(0, 0, 0, 1)"> diskNumber;
</span><span style="color: rgba(0, 128, 128, 1)">11</span>         IntPtr hDisk =<span style="color: rgba(0, 0, 0, 1)"> CreateFile(
</span><span style="color: rgba(0, 128, 128, 1)">12</span> <span style="color: rgba(0, 0, 0, 1)">            physicalDrive,
</span><span style="color: rgba(0, 128, 128, 1)">13</span> <span style="color: rgba(0, 0, 0, 1)">            GENERIC_READ,
</span><span style="color: rgba(0, 128, 128, 1)">14</span>             FILE_SHARE_READ | FILE_SHARE_WRITE |<span style="color: rgba(0, 0, 0, 1)"> FILE_SHARE_DELETE,
</span><span style="color: rgba(0, 128, 128, 1)">15</span> <span style="color: rgba(0, 0, 0, 1)">            IntPtr.Zero,
</span><span style="color: rgba(0, 128, 128, 1)">16</span> <span style="color: rgba(0, 0, 0, 1)">            OPEN_EXISTING,
</span><span style="color: rgba(0, 128, 128, 1)">17</span>             <span style="color: rgba(128, 0, 128, 1)">0</span><span style="color: rgba(0, 0, 0, 1)">,
</span><span style="color: rgba(0, 128, 128, 1)">18</span> <span style="color: rgba(0, 0, 0, 1)">            IntPtr.Zero);
</span><span style="color: rgba(0, 128, 128, 1)">19</span>         <span style="color: rgba(0, 0, 255, 1)">try</span>
<span style="color: rgba(0, 128, 128, 1)">20</span> <span style="color: rgba(0, 0, 0, 1)">        {
</span><span style="color: rgba(0, 128, 128, 1)">21</span>             <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> ä¸å­å¨è¿ä¸ªç©ççï¼æèæ æéï¼,å¿½ç¥æ­¤å¼å¸¸</span>
<span style="color: rgba(0, 128, 128, 1)">22</span>             <span style="color: rgba(0, 0, 255, 1)">if</span> (hDisk ==<span style="color: rgba(0, 0, 0, 1)"> INVALID_HANDLE_VALUE)
</span><span style="color: rgba(0, 128, 128, 1)">23</span> <span style="color: rgba(0, 0, 0, 1)">            {
</span><span style="color: rgba(0, 128, 128, 1)">24</span>                 <span style="color: rgba(0, 0, 255, 1)">return</span> OperateResult&lt;LocalDisk&gt;<span style="color: rgba(0, 0, 0, 1)">.ToSuccess();
</span><span style="color: rgba(0, 128, 128, 1)">25</span> <span style="color: rgba(0, 0, 0, 1)">            }
</span><span style="color: rgba(0, 128, 128, 1)">26</span>             <span style="color: rgba(0, 0, 255, 1)">var</span> diskInfo = <span style="color: rgba(0, 0, 255, 1)">new</span><span style="color: rgba(0, 0, 0, 1)"> LocalDisk();
</span><span style="color: rgba(0, 128, 128, 1)">27</span>             diskInfo.Number =<span style="color: rgba(0, 0, 0, 1)"> diskNumber;
</span><span style="color: rgba(0, 128, 128, 1)">28</span> 
<span style="color: rgba(0, 128, 128, 1)">29</span>             <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">è·åç£çåºç¡ä¿¡æ¯</span>
<span style="color: rgba(0, 128, 128, 1)">30</span>             <span style="color: rgba(0, 0, 255, 1)">var</span> getDiskPropertiesResult =<span style="color: rgba(0, 0, 0, 1)"> GetDiskProperties(hDisk);
</span><span style="color: rgba(0, 128, 128, 1)">31</span>             <span style="color: rgba(0, 0, 255, 1)">if</span> (!<span style="color: rgba(0, 0, 0, 1)">getDiskPropertiesResult.Success)
</span><span style="color: rgba(0, 128, 128, 1)">32</span> <span style="color: rgba(0, 0, 0, 1)">            {
</span><span style="color: rgba(0, 128, 128, 1)">33</span>                 <span style="color: rgba(0, 0, 255, 1)">return</span> OperateResult&lt;LocalDisk&gt;.ToError($<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Get disk {physicalDrive} properties failed, {getDiskPropertiesResult.Message}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">, getDiskPropertiesResult.Exception, getDiskPropertiesResult.Code);
</span><span style="color: rgba(0, 128, 128, 1)">34</span> <span style="color: rgba(0, 0, 0, 1)">            }
</span><span style="color: rgba(0, 128, 128, 1)">35</span>             <span style="color: rgba(0, 0, 255, 1)">var</span> diskProperties =<span style="color: rgba(0, 0, 0, 1)"> getDiskPropertiesResult.Data;
</span><span style="color: rgba(0, 128, 128, 1)">36</span>             diskInfo.SerialNumber =<span style="color: rgba(0, 0, 0, 1)"> diskProperties.SerialNumber;
</span><span style="color: rgba(0, 128, 128, 1)">37</span>             diskInfo.DeviceName =<span style="color: rgba(0, 0, 0, 1)"> diskProperties.DeviceName;
</span><span style="color: rgba(0, 128, 128, 1)">38</span>             diskInfo.BusType =<span style="color: rgba(0, 0, 0, 1)"> diskProperties.BusType;
</span><span style="color: rgba(0, 128, 128, 1)">39</span> 
<span style="color: rgba(0, 128, 128, 1)">40</span>             <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">æ¯å¦åªè¯»/èæº</span>
<span style="color: rgba(0, 128, 128, 1)">41</span>             <span style="color: rgba(0, 0, 255, 1)">var</span> diskAttributesResult =<span style="color: rgba(0, 0, 0, 1)"> GetDiskAttributes(hDisk);
</span><span style="color: rgba(0, 128, 128, 1)">42</span>             <span style="color: rgba(0, 0, 255, 1)">if</span> (!<span style="color: rgba(0, 0, 0, 1)">diskAttributesResult.Success)
</span><span style="color: rgba(0, 128, 128, 1)">43</span> <span style="color: rgba(0, 0, 0, 1)">            {
</span><span style="color: rgba(0, 128, 128, 1)">44</span>                 <span style="color: rgba(0, 0, 255, 1)">return</span> OperateResult&lt;LocalDisk&gt;.ToError($<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Get disk {diskProperties.DeviceName} attributes failed, {diskAttributesResult.Message}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">, diskAttributesResult.Exception, diskAttributesResult.Code);
</span><span style="color: rgba(0, 128, 128, 1)">45</span> <span style="color: rgba(0, 0, 0, 1)">            }
</span><span style="color: rgba(0, 128, 128, 1)">46</span>             <span style="color: rgba(0, 0, 255, 1)">var</span> diskStorageAttributes =<span style="color: rgba(0, 0, 0, 1)"> diskAttributesResult.Data;
</span><span style="color: rgba(0, 128, 128, 1)">47</span>             diskInfo.IsReadOnly =<span style="color: rgba(0, 0, 0, 1)"> diskStorageAttributes.IsReadOnly;
</span><span style="color: rgba(0, 128, 128, 1)">48</span>             diskInfo.IsOffline =<span style="color: rgba(0, 0, 0, 1)"> diskStorageAttributes.IsOffline;
</span><span style="color: rgba(0, 128, 128, 1)">49</span> 
<span style="color: rgba(0, 128, 128, 1)">50</span>             <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">ç£çå®¹é</span>
<span style="color: rgba(0, 128, 128, 1)">51</span>             <span style="color: rgba(0, 0, 255, 1)">var</span> getDiskSizeResult =<span style="color: rgba(0, 0, 0, 1)"> GetDiskSize(hDisk);
</span><span style="color: rgba(0, 128, 128, 1)">52</span>             diskInfo.DiskSize =<span style="color: rgba(0, 0, 0, 1)"> getDiskSizeResult.Data;
</span><span style="color: rgba(0, 128, 128, 1)">53</span> 
<span style="color: rgba(0, 128, 128, 1)">54</span>             <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">è·åååºä¿¡æ¯</span>
<span style="color: rgba(0, 128, 128, 1)">55</span>             <span style="color: rgba(0, 0, 255, 1)">var</span> partitionInfoResult =<span style="color: rgba(0, 0, 0, 1)"> GetPartitionInfo(hDisk);
</span><span style="color: rgba(0, 128, 128, 1)">56</span>             <span style="color: rgba(0, 0, 255, 1)">if</span> (!<span style="color: rgba(0, 0, 0, 1)">partitionInfoResult.Success)
</span><span style="color: rgba(0, 128, 128, 1)">57</span> <span style="color: rgba(0, 0, 0, 1)">            {
</span><span style="color: rgba(0, 128, 128, 1)">58</span>                 <span style="color: rgba(0, 0, 255, 1)">return</span> OperateResult&lt;LocalDisk&gt;.ToError($<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Get disk {diskProperties.DeviceName} partition failed, {partitionInfoResult.Message}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">, partitionInfoResult.Exception, partitionInfoResult.Code);
</span><span style="color: rgba(0, 128, 128, 1)">59</span> <span style="color: rgba(0, 0, 0, 1)">            }
</span><span style="color: rgba(0, 128, 128, 1)">60</span>             <span style="color: rgba(0, 0, 255, 1)">var</span> diskPartitionInfo =<span style="color: rgba(0, 0, 0, 1)"> partitionInfoResult.Data;
</span><span style="color: rgba(0, 128, 128, 1)">61</span>             diskInfo.PartitionStyle =<span style="color: rgba(0, 0, 0, 1)"> (DiskPartitionStyle)diskPartitionInfo.PartitionStyle;
</span><span style="color: rgba(0, 128, 128, 1)">62</span>             diskInfo.PartitionCount =<span style="color: rgba(0, 0, 0, 1)"> diskPartitionInfo.PartitionCount;
</span><span style="color: rgba(0, 128, 128, 1)">63</span>             <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">åºç¡æ°æ®åºåå¤§å°</span>
<span style="color: rgba(0, 128, 128, 1)">64</span>             diskInfo.DiskAllocateSize = diskPartitionInfo.Partitions.FirstOrDefault(i =&gt; i.PartitionType.ToUpper() == <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">EBD0A0A2-B9E5-4433-87C0-68B6B72699C7</span><span style="color: rgba(128, 0, 0, 1)">"</span>)?.PartitionLength ?? <span style="color: rgba(128, 0, 128, 1)">0</span><span style="color: rgba(0, 0, 0, 1)">;
</span><span style="color: rgba(0, 128, 128, 1)">65</span> 
<span style="color: rgba(0, 128, 128, 1)">66</span>             <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">æè½½è·¯å¾</span>
<span style="color: rgba(0, 128, 128, 1)">67</span>             <span style="color: rgba(0, 0, 255, 1)">if</span> (volumeMaps.TryGetValue(diskNumber, <span style="color: rgba(0, 0, 255, 1)">out</span> <span style="color: rgba(0, 0, 255, 1)">var</span> mounts) &amp;&amp; mounts != <span style="color: rgba(0, 0, 255, 1)">null</span><span style="color: rgba(0, 0, 0, 1)">)
</span><span style="color: rgba(0, 128, 128, 1)">68</span> <span style="color: rgba(0, 0, 0, 1)">            {
</span><span style="color: rgba(0, 128, 128, 1)">69</span>                 diskInfo.MountPaths =<span style="color: rgba(0, 0, 0, 1)"> mounts;
</span><span style="color: rgba(0, 128, 128, 1)">70</span> <span style="color: rgba(0, 0, 0, 1)">            }
</span><span style="color: rgba(0, 128, 128, 1)">71</span>             <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">è·åå·æ åç§°</span>
<span style="color: rgba(0, 128, 128, 1)">72</span>             <span style="color: rgba(0, 0, 255, 1)">if</span><span style="color: rgba(0, 0, 0, 1)"> (diskInfo.MountPaths.Any())
</span><span style="color: rgba(0, 128, 128, 1)">73</span> <span style="color: rgba(0, 0, 0, 1)">            {
</span><span style="color: rgba(0, 128, 128, 1)">74</span>                 <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">éè¿ä»»æä¸ä¸ªmountPathè·å</span>
<span style="color: rgba(0, 128, 128, 1)">75</span>                 <span style="color: rgba(0, 0, 255, 1)">var</span> mountPath =<span style="color: rgba(0, 0, 0, 1)"> diskInfo.MountPaths.First();
</span><span style="color: rgba(0, 128, 128, 1)">76</span>                 <span style="color: rgba(0, 0, 255, 1)">var</span> getVolumeInfoResult =<span style="color: rgba(0, 0, 0, 1)"> GetVolumeInfo(mountPath);
</span><span style="color: rgba(0, 128, 128, 1)">77</span>                 diskInfo.Tag = getVolumeInfoResult.Data?.VolumeLabel ?? <span style="color: rgba(0, 0, 255, 1)">string</span><span style="color: rgba(0, 0, 0, 1)">.Empty;
</span><span style="color: rgba(0, 128, 128, 1)">78</span>                 diskInfo.FileSystemType = getVolumeInfoResult.Data?.FileSystemType ?? <span style="color: rgba(0, 0, 255, 1)">string</span><span style="color: rgba(0, 0, 0, 1)">.Empty;
</span><span style="color: rgba(0, 128, 128, 1)">79</span> <span style="color: rgba(0, 0, 0, 1)">            }
</span><span style="color: rgba(0, 128, 128, 1)">80</span>             <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">ç£çå·²ä½¿ç¨å¤§å°</span>
<span style="color: rgba(0, 128, 128, 1)">81</span>             <span style="color: rgba(0, 0, 255, 1)">if</span><span style="color: rgba(0, 0, 0, 1)"> (diskInfo.MountPaths.Any())
</span><span style="color: rgba(0, 128, 128, 1)">82</span> <span style="color: rgba(0, 0, 0, 1)">            {
</span><span style="color: rgba(0, 128, 128, 1)">83</span>                 <span style="color: rgba(0, 0, 255, 1)">long</span> diskUsedSize = <span style="color: rgba(128, 0, 128, 1)">0L</span><span style="color: rgba(0, 0, 0, 1)">;
</span><span style="color: rgba(0, 128, 128, 1)">84</span>                 <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">éè¿ææmountPathç¸å ,è·åç£çå·²ä½¿ç¨å¤§å°</span>
<span style="color: rgba(0, 128, 128, 1)">85</span>                 <span style="color: rgba(0, 0, 255, 1)">foreach</span> (<span style="color: rgba(0, 0, 255, 1)">var</span> mountPath <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> diskInfo.MountPaths)
</span><span style="color: rgba(0, 128, 128, 1)">86</span> <span style="color: rgba(0, 0, 0, 1)">                {
</span><span style="color: rgba(0, 128, 128, 1)">87</span>                     <span style="color: rgba(0, 0, 255, 1)">var</span> usageByMountPathResult =<span style="color: rgba(0, 0, 0, 1)"> GetDiskSizeUsageByMountPath(mountPath);
</span><span style="color: rgba(0, 128, 128, 1)">88</span>                     diskUsedSize += usageByMountPathResult.Data?.UsedBytes ?? <span style="color: rgba(128, 0, 128, 1)">0</span><span style="color: rgba(0, 0, 0, 1)">;
</span><span style="color: rgba(0, 128, 128, 1)">89</span> <span style="color: rgba(0, 0, 0, 1)">                }
</span><span style="color: rgba(0, 128, 128, 1)">90</span>                 diskInfo.DiskUsedSize =<span style="color: rgba(0, 0, 0, 1)"> diskUsedSize;
</span><span style="color: rgba(0, 128, 128, 1)">91</span> <span style="color: rgba(0, 0, 0, 1)">            }
</span><span style="color: rgba(0, 128, 128, 1)">92</span>             <span style="color: rgba(0, 0, 255, 1)">return</span> OperateResult&lt;LocalDisk&gt;<span style="color: rgba(0, 0, 0, 1)">.ToSuccess(diskInfo);
</span><span style="color: rgba(0, 128, 128, 1)">93</span> <span style="color: rgba(0, 0, 0, 1)">        }
</span><span style="color: rgba(0, 128, 128, 1)">94</span>         <span style="color: rgba(0, 0, 255, 1)">finally</span>
<span style="color: rgba(0, 128, 128, 1)">95</span> <span style="color: rgba(0, 0, 0, 1)">        {
</span><span style="color: rgba(0, 128, 128, 1)">96</span> <span style="color: rgba(0, 0, 0, 1)">            CloseHandle(hDisk);
</span><span style="color: rgba(0, 128, 128, 1)">97</span> <span style="color: rgba(0, 0, 0, 1)">        }
</span><span style="color: rgba(0, 128, 128, 1)">98</span>     }</pre>
</div>
<p>å¶ä¸­ç£çå±æ§è·åç»èï¼å°±ä¸å±ç¤ºäºï¼</p>
<div class="cnblogs_code"><img src="https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" id="code_img_closed_ed064c18-3858-41af-a354-0d53b9fb10bf" class="code_img_closed"><img src="https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" id="code_img_opened_ed064c18-3858-41af-a354-0d53b9fb10bf" class="code_img_opened" style="display: none">
<div id="cnblogs_code_open_ed064c18-3858-41af-a354-0d53b9fb10bf" class="cnblogs_code_hide">
<pre><span style="color: rgba(0, 128, 128, 1)">  1</span>         <span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;summary&gt;</span>
<span style="color: rgba(0, 128, 128, 1)">  2</span>         <span style="color: rgba(128, 128, 128, 1)">///</span><span style="color: rgba(0, 128, 0, 1)"> è·åææç£ç
</span><span style="color: rgba(0, 128, 128, 1)">  3</span>         <span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;/summary&gt;</span>
<span style="color: rgba(0, 128, 128, 1)">  4</span>         <span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;returns&gt;&lt;/returns&gt;</span>
<span style="color: rgba(0, 128, 128, 1)">  5</span>         <span style="color: rgba(0, 0, 255, 1)">public</span> OperateResult&lt;List&lt;LocalDisk&gt;&gt;<span style="color: rgba(0, 0, 0, 1)"> GetDisks()
</span><span style="color: rgba(0, 128, 128, 1)">  6</span> <span style="color: rgba(0, 0, 0, 1)">        {
</span><span style="color: rgba(0, 128, 128, 1)">  7</span>             <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> 1. åæ¿å· -&gt; å·æå±çç©çç£çå· + çç¬¦/æè½½ç¹</span>
<span style="color: rgba(0, 128, 128, 1)">  8</span>             <span style="color: rgba(0, 0, 255, 1)">var</span> getVolumesResult =<span style="color: rgba(0, 0, 0, 1)"> GetAllVolumeMountPaths();
</span><span style="color: rgba(0, 128, 128, 1)">  9</span>             <span style="color: rgba(0, 0, 255, 1)">if</span> (!<span style="color: rgba(0, 0, 0, 1)">getVolumesResult.Success)
</span><span style="color: rgba(0, 128, 128, 1)"> 10</span> <span style="color: rgba(0, 0, 0, 1)">            {
</span><span style="color: rgba(0, 128, 128, 1)"> 11</span>                 <span style="color: rgba(0, 0, 255, 1)">return</span> OperateResult&lt;List&lt;LocalDisk&gt;&gt;<span style="color: rgba(0, 0, 0, 1)">.ToError(getVolumesResult.Message, getVolumesResult.Exception, getVolumesResult.Code);
</span><span style="color: rgba(0, 128, 128, 1)"> 12</span> <span style="color: rgba(0, 0, 0, 1)">            }
</span><span style="color: rgba(0, 128, 128, 1)"> 13</span>             <span style="color: rgba(0, 0, 255, 1)">var</span> volumeMaps =<span style="color: rgba(0, 0, 0, 1)"> getVolumesResult.Data;
</span><span style="color: rgba(0, 128, 128, 1)"> 14</span> 
<span style="color: rgba(0, 128, 128, 1)"> 15</span>             <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> 2. è·åç£çåè¡¨</span>
<span style="color: rgba(0, 128, 128, 1)"> 16</span>             <span style="color: rgba(0, 0, 255, 1)">var</span> diskList = <span style="color: rgba(0, 0, 255, 1)">new</span> List&lt;LocalDisk&gt;<span style="color: rgba(0, 0, 0, 1)">();
</span><span style="color: rgba(0, 128, 128, 1)"> 17</span>             <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> æ ¹æ®å·ä¿¡æ¯æ¨ä¸ä¸ªæå¤§ç£çå·ï¼åæ¶è³å°æ¥è¯¢16 ä¸ª</span>
<span style="color: rgba(0, 128, 128, 1)"> 18</span>             <span style="color: rgba(0, 0, 255, 1)">int</span> maxDiskNumberCount = Math.Max(volumeMaps.Max(i =&gt; i.Key), <span style="color: rgba(128, 0, 128, 1)">16</span><span style="color: rgba(0, 0, 0, 1)">);
</span><span style="color: rgba(0, 128, 128, 1)"> 19</span>             <span style="color: rgba(0, 0, 255, 1)">for</span> (<span style="color: rgba(0, 0, 255, 1)">int</span> diskNumber = <span style="color: rgba(128, 0, 128, 1)">0</span>; diskNumber &lt;= maxDiskNumberCount; diskNumber++<span style="color: rgba(0, 0, 0, 1)">)
</span><span style="color: rgba(0, 128, 128, 1)"> 20</span> <span style="color: rgba(0, 0, 0, 1)">            {
</span><span style="color: rgba(0, 128, 128, 1)"> 21</span>                 <span style="color: rgba(0, 0, 255, 1)">var</span> getDiskResult =<span style="color: rgba(0, 0, 0, 1)"> GetDiskInfoByDiskNumber(diskNumber, volumeMaps);
</span><span style="color: rgba(0, 128, 128, 1)"> 22</span>                 <span style="color: rgba(0, 0, 255, 1)">if</span> (!<span style="color: rgba(0, 0, 0, 1)">getDiskResult.Success)
</span><span style="color: rgba(0, 128, 128, 1)"> 23</span> <span style="color: rgba(0, 0, 0, 1)">                {
</span><span style="color: rgba(0, 128, 128, 1)"> 24</span>                     <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">ç»ææ¥è¯¢</span>
<span style="color: rgba(0, 128, 128, 1)"> 25</span>                     <span style="color: rgba(0, 0, 255, 1)">if</span> (diskNumber == maxDiskNumberCount - <span style="color: rgba(128, 0, 128, 1)">1</span><span style="color: rgba(0, 0, 0, 1)">)
</span><span style="color: rgba(0, 128, 128, 1)"> 26</span> <span style="color: rgba(0, 0, 0, 1)">                    {
</span><span style="color: rgba(0, 128, 128, 1)"> 27</span>                         <span style="color: rgba(0, 0, 255, 1)">return</span> getDiskResult.ToResult&lt;List&lt;LocalDisk&gt;&gt;<span style="color: rgba(0, 0, 0, 1)">();
</span><span style="color: rgba(0, 128, 128, 1)"> 28</span> <span style="color: rgba(0, 0, 0, 1)">                    }
</span><span style="color: rgba(0, 128, 128, 1)"> 29</span>                     <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">ç»§ç»­æ¥è¯¢å¶å®</span>
<span style="color: rgba(0, 128, 128, 1)"> 30</span>                     <span style="color: rgba(0, 0, 255, 1)">continue</span><span style="color: rgba(0, 0, 0, 1)">;
</span><span style="color: rgba(0, 128, 128, 1)"> 31</span> <span style="color: rgba(0, 0, 0, 1)">                }
</span><span style="color: rgba(0, 128, 128, 1)"> 32</span>                 <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">å¯è½ä¸ºç©º</span>
<span style="color: rgba(0, 128, 128, 1)"> 33</span>                 <span style="color: rgba(0, 0, 255, 1)">if</span> (getDiskResult.Data == <span style="color: rgba(0, 0, 255, 1)">null</span><span style="color: rgba(0, 0, 0, 1)">)
</span><span style="color: rgba(0, 128, 128, 1)"> 34</span> <span style="color: rgba(0, 0, 0, 1)">                {
</span><span style="color: rgba(0, 128, 128, 1)"> 35</span>                     <span style="color: rgba(0, 0, 255, 1)">continue</span><span style="color: rgba(0, 0, 0, 1)">;
</span><span style="color: rgba(0, 128, 128, 1)"> 36</span> <span style="color: rgba(0, 0, 0, 1)">                }
</span><span style="color: rgba(0, 128, 128, 1)"> 37</span> <span style="color: rgba(0, 0, 0, 1)">                diskList.Add(getDiskResult.Data);
</span><span style="color: rgba(0, 128, 128, 1)"> 38</span> <span style="color: rgba(0, 0, 0, 1)">            }
</span><span style="color: rgba(0, 128, 128, 1)"> 39</span> 
<span style="color: rgba(0, 128, 128, 1)"> 40</span>             <span style="color: rgba(0, 0, 255, 1)">return</span> OperateResult&lt;List&lt;LocalDisk&gt;&gt;<span style="color: rgba(0, 0, 0, 1)">.ToSuccess(diskList);
</span><span style="color: rgba(0, 128, 128, 1)"> 41</span> <span style="color: rgba(0, 0, 0, 1)">        }
</span><span style="color: rgba(0, 128, 128, 1)"> 42</span> 
<span style="color: rgba(0, 128, 128, 1)"> 43</span>         <span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;summary&gt;</span>
<span style="color: rgba(0, 128, 128, 1)"> 44</span>         <span style="color: rgba(128, 128, 128, 1)">///</span><span style="color: rgba(0, 128, 0, 1)"> è·åææç£çå·çæè½½è·¯å¾ä¿¡æ¯
</span><span style="color: rgba(0, 128, 128, 1)"> 45</span>         <span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;remarks&gt;</span><span style="color: rgba(0, 128, 0, 1)">éè¿æä¸¾å·ï¼å¹¶ä½¿ç¨ IOCTL_STORAGE_GET_DEVICE_NUMBER æ å°å°è®¾å¤å·ã</span><span style="color: rgba(128, 128, 128, 1)">&lt;/remarks&gt;</span>
<span style="color: rgba(0, 128, 128, 1)"> 46</span>         <span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;/summary&gt;</span>
<span style="color: rgba(0, 128, 128, 1)"> 47</span>         <span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;returns&gt;</span><span style="color: rgba(0, 128, 0, 1)">PhysicalDiskNumber -&gt; å¯¹åºçæææè½½è·¯å¾ï¼çç¬¦ãæè½½ç¹ï¼</span><span style="color: rgba(128, 128, 128, 1)">&lt;/returns&gt;</span>
<span style="color: rgba(0, 128, 128, 1)"> 48</span>         <span style="color: rgba(0, 0, 255, 1)">private</span> OperateResult&lt;Dictionary&lt;<span style="color: rgba(0, 0, 255, 1)">int</span>, List&lt;<span style="color: rgba(0, 0, 255, 1)">string</span>&gt;&gt;&gt;<span style="color: rgba(0, 0, 0, 1)"> GetAllVolumeMountPaths()
</span><span style="color: rgba(0, 128, 128, 1)"> 49</span> <span style="color: rgba(0, 0, 0, 1)">        {
</span><span style="color: rgba(0, 128, 128, 1)"> 50</span>             <span style="color: rgba(0, 0, 255, 1)">var</span> diskDict = <span style="color: rgba(0, 0, 255, 1)">new</span> Dictionary&lt;<span style="color: rgba(0, 0, 255, 1)">int</span>, List&lt;<span style="color: rgba(0, 0, 255, 1)">string</span>&gt;&gt;<span style="color: rgba(0, 0, 0, 1)">();
</span><span style="color: rgba(0, 128, 128, 1)"> 51</span> 
<span style="color: rgba(0, 128, 128, 1)"> 52</span>             <span style="color: rgba(0, 0, 255, 1)">int</span> maxPath = <span style="color: rgba(128, 0, 128, 1)">1024</span><span style="color: rgba(0, 0, 0, 1)">;
</span><span style="color: rgba(0, 128, 128, 1)"> 53</span>             <span style="color: rgba(0, 0, 255, 1)">var</span> volNameSb = <span style="color: rgba(0, 0, 255, 1)">new</span><span style="color: rgba(0, 0, 0, 1)"> StringBuilder(maxPath);
</span><span style="color: rgba(0, 128, 128, 1)"> 54</span>             IntPtr findVolumeHandle = FindFirstVolumeW(volNameSb, (<span style="color: rgba(0, 0, 255, 1)">uint</span><span style="color: rgba(0, 0, 0, 1)">)volNameSb.Capacity);
</span><span style="color: rgba(0, 128, 128, 1)"> 55</span>             <span style="color: rgba(0, 0, 255, 1)">try</span>
<span style="color: rgba(0, 128, 128, 1)"> 56</span> <span style="color: rgba(0, 0, 0, 1)">            {
</span><span style="color: rgba(0, 128, 128, 1)"> 57</span>                 <span style="color: rgba(0, 0, 255, 1)">if</span> (findVolumeHandle == (IntPtr)(-<span style="color: rgba(128, 0, 128, 1)">1</span><span style="color: rgba(0, 0, 0, 1)">))
</span><span style="color: rgba(0, 128, 128, 1)"> 58</span> <span style="color: rgba(0, 0, 0, 1)">                {
</span><span style="color: rgba(0, 128, 128, 1)"> 59</span>                     <span style="color: rgba(0, 0, 255, 1)">return</span> OperateResult&lt;Dictionary&lt;<span style="color: rgba(0, 0, 255, 1)">int</span>, List&lt;<span style="color: rgba(0, 0, 255, 1)">string</span>&gt;&gt;&gt;<span style="color: rgba(0, 0, 0, 1)">.ToSuccess(diskDict);
</span><span style="color: rgba(0, 128, 128, 1)"> 60</span> <span style="color: rgba(0, 0, 0, 1)">                }
</span><span style="color: rgba(0, 128, 128, 1)"> 61</span>                 <span style="color: rgba(0, 0, 255, 1)">while</span> (<span style="color: rgba(0, 0, 255, 1)">true</span><span style="color: rgba(0, 0, 0, 1)">)
</span><span style="color: rgba(0, 128, 128, 1)"> 62</span> <span style="color: rgba(0, 0, 0, 1)">                {
</span><span style="color: rgba(0, 128, 128, 1)"> 63</span>                     <span style="color: rgba(0, 0, 255, 1)">string</span> volumeName =<span style="color: rgba(0, 0, 0, 1)"> volNameSb.ToString();
</span><span style="color: rgba(0, 128, 128, 1)"> 64</span>                     <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> volumeName: \\?\Volume{GUID}\
</span><span style="color: rgba(0, 128, 128, 1)"> 65</span> 
<span style="color: rgba(0, 128, 128, 1)"> 66</span>                     <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> æå¼å·è®¾å¤</span>
<span style="color: rgba(0, 128, 128, 1)"> 67</span>                     <span style="color: rgba(0, 0, 255, 1)">string</span> volumePathForDevice = volumeName.TrimEnd(<span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">\\</span><span style="color: rgba(128, 0, 0, 1)">'</span>); <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> \\?\Volume{GUID}</span>
<span style="color: rgba(0, 128, 128, 1)"> 68</span>                     IntPtr hVolume =<span style="color: rgba(0, 0, 0, 1)"> CreateFile(
</span><span style="color: rgba(0, 128, 128, 1)"> 69</span> <span style="color: rgba(0, 0, 0, 1)">                        volumePathForDevice,
</span><span style="color: rgba(0, 128, 128, 1)"> 70</span>                         <span style="color: rgba(128, 0, 128, 1)">0</span>, <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> åªéè¦ IOCTLï¼ä¸è¯»å</span>
<span style="color: rgba(0, 128, 128, 1)"> 71</span>                         FILE_SHARE_READ |<span style="color: rgba(0, 0, 0, 1)"> FILE_SHARE_WRITE,
</span><span style="color: rgba(0, 128, 128, 1)"> 72</span> <span style="color: rgba(0, 0, 0, 1)">                        IntPtr.Zero,
</span><span style="color: rgba(0, 128, 128, 1)"> 73</span> <span style="color: rgba(0, 0, 0, 1)">                        OPEN_EXISTING,
</span><span style="color: rgba(0, 128, 128, 1)"> 74</span>                         <span style="color: rgba(128, 0, 128, 1)">0</span><span style="color: rgba(0, 0, 0, 1)">,
</span><span style="color: rgba(0, 128, 128, 1)"> 75</span> <span style="color: rgba(0, 0, 0, 1)">                        IntPtr.Zero);
</span><span style="color: rgba(0, 128, 128, 1)"> 76</span> 
<span style="color: rgba(0, 128, 128, 1)"> 77</span>                     <span style="color: rgba(0, 0, 255, 1)">uint</span>? diskNumber = <span style="color: rgba(0, 0, 255, 1)">null</span><span style="color: rgba(0, 0, 0, 1)">;
</span><span style="color: rgba(0, 128, 128, 1)"> 78</span> 
<span style="color: rgba(0, 128, 128, 1)"> 79</span>                     <span style="color: rgba(0, 0, 255, 1)">if</span> (hVolume != (IntPtr)(-<span style="color: rgba(128, 0, 128, 1)">1</span><span style="color: rgba(0, 0, 0, 1)">))
</span><span style="color: rgba(0, 128, 128, 1)"> 80</span> <span style="color: rgba(0, 0, 0, 1)">                    {
</span><span style="color: rgba(0, 128, 128, 1)"> 81</span>                         <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> å STORAGE_DEVICE_NUMBER</span>
<span style="color: rgba(0, 128, 128, 1)"> 82</span>                         <span style="color: rgba(0, 0, 255, 1)">uint</span> size = (<span style="color: rgba(0, 0, 255, 1)">uint</span>)Marshal.SizeOf&lt;STORAGE_DEVICE_NUMBER&gt;<span style="color: rgba(0, 0, 0, 1)">();
</span><span style="color: rgba(0, 128, 128, 1)"> 83</span>                         IntPtr outBuf = Marshal.AllocHGlobal((<span style="color: rgba(0, 0, 255, 1)">int</span><span style="color: rgba(0, 0, 0, 1)">)size);
</span><span style="color: rgba(0, 128, 128, 1)"> 84</span>                         <span style="color: rgba(0, 0, 255, 1)">try</span>
<span style="color: rgba(0, 128, 128, 1)"> 85</span> <span style="color: rgba(0, 0, 0, 1)">                        {
</span><span style="color: rgba(0, 128, 128, 1)"> 86</span>                             <span style="color: rgba(0, 0, 255, 1)">if</span><span style="color: rgba(0, 0, 0, 1)"> (DeviceIoControl(
</span><span style="color: rgba(0, 128, 128, 1)"> 87</span> <span style="color: rgba(0, 0, 0, 1)">                                    hVolume,
</span><span style="color: rgba(0, 128, 128, 1)"> 88</span> <span style="color: rgba(0, 0, 0, 1)">                                    IOCTL_STORAGE_GET_DEVICE_NUMBER,
</span><span style="color: rgba(0, 128, 128, 1)"> 89</span> <span style="color: rgba(0, 0, 0, 1)">                                    IntPtr.Zero,
</span><span style="color: rgba(0, 128, 128, 1)"> 90</span>                                     <span style="color: rgba(128, 0, 128, 1)">0</span><span style="color: rgba(0, 0, 0, 1)">,
</span><span style="color: rgba(0, 128, 128, 1)"> 91</span> <span style="color: rgba(0, 0, 0, 1)">                                    outBuf,
</span><span style="color: rgba(0, 128, 128, 1)"> 92</span> <span style="color: rgba(0, 0, 0, 1)">                                    size,
</span><span style="color: rgba(0, 128, 128, 1)"> 93</span>                                     <span style="color: rgba(0, 0, 255, 1)">out</span> <span style="color: rgba(0, 0, 255, 1)">uint</span><span style="color: rgba(0, 0, 0, 1)"> bytesReturned,
</span><span style="color: rgba(0, 128, 128, 1)"> 94</span> <span style="color: rgba(0, 0, 0, 1)">                                    IntPtr.Zero))
</span><span style="color: rgba(0, 128, 128, 1)"> 95</span> <span style="color: rgba(0, 0, 0, 1)">                            {
</span><span style="color: rgba(0, 128, 128, 1)"> 96</span>                                 STORAGE_DEVICE_NUMBER devNum = Marshal.PtrToStructure&lt;STORAGE_DEVICE_NUMBER&gt;<span style="color: rgba(0, 0, 0, 1)">(outBuf);
</span><span style="color: rgba(0, 128, 128, 1)"> 97</span>                                 <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> DeviceType ä¸º FILE_DEVICE_DISK(0x07) ä¸è¬è¡¨ç¤ºç©çç£ç</span>
<span style="color: rgba(0, 128, 128, 1)"> 98</span>                                 diskNumber =<span style="color: rgba(0, 0, 0, 1)"> devNum.DeviceNumber;
</span><span style="color: rgba(0, 128, 128, 1)"> 99</span> <span style="color: rgba(0, 0, 0, 1)">                            }
</span><span style="color: rgba(0, 128, 128, 1)">100</span> <span style="color: rgba(0, 0, 0, 1)">                        }
</span><span style="color: rgba(0, 128, 128, 1)">101</span>                         <span style="color: rgba(0, 0, 255, 1)">finally</span>
<span style="color: rgba(0, 128, 128, 1)">102</span> <span style="color: rgba(0, 0, 0, 1)">                        {
</span><span style="color: rgba(0, 128, 128, 1)">103</span> <span style="color: rgba(0, 0, 0, 1)">                            Marshal.FreeHGlobal(outBuf);
</span><span style="color: rgba(0, 128, 128, 1)">104</span> <span style="color: rgba(0, 0, 0, 1)">                            CloseHandle(hVolume);
</span><span style="color: rgba(0, 128, 128, 1)">105</span> <span style="color: rgba(0, 0, 0, 1)">                        }
</span><span style="color: rgba(0, 128, 128, 1)">106</span> <span style="color: rgba(0, 0, 0, 1)">                    }
</span><span style="color: rgba(0, 128, 128, 1)">107</span> 
<span style="color: rgba(0, 128, 128, 1)">108</span>                     <span style="color: rgba(0, 0, 255, 1)">if</span><span style="color: rgba(0, 0, 0, 1)"> (diskNumber.HasValue)
</span><span style="color: rgba(0, 128, 128, 1)">109</span> <span style="color: rgba(0, 0, 0, 1)">                    {
</span><span style="color: rgba(0, 128, 128, 1)">110</span>                         <span style="color: rgba(0, 0, 255, 1)">if</span> (!diskDict.TryGetValue((<span style="color: rgba(0, 0, 255, 1)">int</span>)diskNumber.Value, <span style="color: rgba(0, 0, 255, 1)">out</span> <span style="color: rgba(0, 0, 255, 1)">var</span><span style="color: rgba(0, 0, 0, 1)"> list))
</span><span style="color: rgba(0, 128, 128, 1)">111</span> <span style="color: rgba(0, 0, 0, 1)">                        {
</span><span style="color: rgba(0, 128, 128, 1)">112</span>                             list = <span style="color: rgba(0, 0, 255, 1)">new</span> List&lt;<span style="color: rgba(0, 0, 255, 1)">string</span>&gt;<span style="color: rgba(0, 0, 0, 1)">();
</span><span style="color: rgba(0, 128, 128, 1)">113</span>                             diskDict[(<span style="color: rgba(0, 0, 255, 1)">int</span>)diskNumber.Value] =<span style="color: rgba(0, 0, 0, 1)"> list;
</span><span style="color: rgba(0, 128, 128, 1)">114</span> <span style="color: rgba(0, 0, 0, 1)">                        }
</span><span style="color: rgba(0, 128, 128, 1)">115</span>                         <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> è·åå·çæè½½è·¯å¾åè¡¨ï¼å¯è½æå¤ä¸ªï¼</span>
<span style="color: rgba(0, 128, 128, 1)">116</span>                         <span style="color: rgba(0, 0, 255, 1)">var</span> getMountPathsResult =<span style="color: rgba(0, 0, 0, 1)"> GetMountPathsForVolume(volumeName);
</span><span style="color: rgba(0, 128, 128, 1)">117</span>                         <span style="color: rgba(0, 0, 255, 1)">if</span> (!<span style="color: rgba(0, 0, 0, 1)">getMountPathsResult.Success)
</span><span style="color: rgba(0, 128, 128, 1)">118</span> <span style="color: rgba(0, 0, 0, 1)">                        {
</span><span style="color: rgba(0, 128, 128, 1)">119</span>                             <span style="color: rgba(0, 0, 255, 1)">return</span> OperateResult&lt;Dictionary&lt;<span style="color: rgba(0, 0, 255, 1)">int</span>, List&lt;<span style="color: rgba(0, 0, 255, 1)">string</span>&gt;&gt;&gt;.ToError($<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">ç£ç{diskNumber}å·æè½½è·¯å¾è·åå¤±è´¥, {getMountPathsResult.Message}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">, getMountPathsResult.Exception, getMountPathsResult.Code);
</span><span style="color: rgba(0, 128, 128, 1)">120</span> <span style="color: rgba(0, 0, 0, 1)">                        }
</span><span style="color: rgba(0, 128, 128, 1)">121</span>                         <span style="color: rgba(0, 0, 255, 1)">foreach</span> (<span style="color: rgba(0, 0, 255, 1)">var</span> mp <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> getMountPathsResult.Data)
</span><span style="color: rgba(0, 128, 128, 1)">122</span> <span style="color: rgba(0, 0, 0, 1)">                        {
</span><span style="color: rgba(0, 128, 128, 1)">123</span>                             <span style="color: rgba(0, 0, 255, 1)">if</span> (!<span style="color: rgba(0, 0, 0, 1)">list.Contains(mp))
</span><span style="color: rgba(0, 128, 128, 1)">124</span> <span style="color: rgba(0, 0, 0, 1)">                                list.Add(mp);
</span><span style="color: rgba(0, 128, 128, 1)">125</span> <span style="color: rgba(0, 0, 0, 1)">                        }
</span><span style="color: rgba(0, 128, 128, 1)">126</span> <span style="color: rgba(0, 0, 0, 1)">                    }
</span><span style="color: rgba(0, 128, 128, 1)">127</span> 
<span style="color: rgba(0, 128, 128, 1)">128</span>                     <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> ä¸ä¸å·</span>
<span style="color: rgba(0, 128, 128, 1)">129</span> <span style="color: rgba(0, 0, 0, 1)">                    volNameSb.Clear();
</span><span style="color: rgba(0, 128, 128, 1)">130</span> <span style="color: rgba(0, 0, 0, 1)">                    volNameSb.EnsureCapacity(maxPath);
</span><span style="color: rgba(0, 128, 128, 1)">131</span> 
<span style="color: rgba(0, 128, 128, 1)">132</span>                     <span style="color: rgba(0, 0, 255, 1)">if</span> (!FindNextVolumeW(findVolumeHandle, volNameSb, (<span style="color: rgba(0, 0, 255, 1)">uint</span><span style="color: rgba(0, 0, 0, 1)">)volNameSb.Capacity))
</span><span style="color: rgba(0, 128, 128, 1)">133</span> <span style="color: rgba(0, 0, 0, 1)">                    {
</span><span style="color: rgba(0, 128, 128, 1)">134</span>                         <span style="color: rgba(0, 0, 255, 1)">int</span> err =<span style="color: rgba(0, 0, 0, 1)"> Marshal.GetLastWin32Error();
</span><span style="color: rgba(0, 128, 128, 1)">135</span>                         <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> ERROR_NO_MORE_FILES</span>
<span style="color: rgba(0, 128, 128, 1)">136</span>                         <span style="color: rgba(0, 0, 255, 1)">if</span> (err == <span style="color: rgba(128, 0, 128, 1)">18</span><span style="color: rgba(0, 0, 0, 1)">)
</span><span style="color: rgba(0, 128, 128, 1)">137</span>                             <span style="color: rgba(0, 0, 255, 1)">break</span><span style="color: rgba(0, 0, 0, 1)">;
</span><span style="color: rgba(0, 128, 128, 1)">138</span> 
<span style="color: rgba(0, 128, 128, 1)">139</span>                         <span style="color: rgba(0, 0, 255, 1)">return</span> OperateResult&lt;Dictionary&lt;<span style="color: rgba(0, 0, 255, 1)">int</span>, List&lt;<span style="color: rgba(0, 0, 255, 1)">string</span>&gt;&gt;&gt;.ToWin32Error(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">query disk volumes failed</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">, err);
</span><span style="color: rgba(0, 128, 128, 1)">140</span> <span style="color: rgba(0, 0, 0, 1)">                    }
</span><span style="color: rgba(0, 128, 128, 1)">141</span> <span style="color: rgba(0, 0, 0, 1)">                }
</span><span style="color: rgba(0, 128, 128, 1)">142</span> <span style="color: rgba(0, 0, 0, 1)">            }
</span><span style="color: rgba(0, 128, 128, 1)">143</span>             <span style="color: rgba(0, 0, 255, 1)">catch</span><span style="color: rgba(0, 0, 0, 1)"> (Exception ex)
</span><span style="color: rgba(0, 128, 128, 1)">144</span> <span style="color: rgba(0, 0, 0, 1)">            {
</span><span style="color: rgba(0, 128, 128, 1)">145</span>                 <span style="color: rgba(0, 0, 255, 1)">return</span> OperateResult&lt;Dictionary&lt;<span style="color: rgba(0, 0, 255, 1)">int</span>, List&lt;<span style="color: rgba(0, 0, 255, 1)">string</span>&gt;&gt;&gt;.ToError(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">query disk volumes error</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">, ex);
</span><span style="color: rgba(0, 128, 128, 1)">146</span> <span style="color: rgba(0, 0, 0, 1)">            }
</span><span style="color: rgba(0, 128, 128, 1)">147</span>             <span style="color: rgba(0, 0, 255, 1)">finally</span>
<span style="color: rgba(0, 128, 128, 1)">148</span> <span style="color: rgba(0, 0, 0, 1)">            {
</span><span style="color: rgba(0, 128, 128, 1)">149</span> <span style="color: rgba(0, 0, 0, 1)">                FindVolumeClose(findVolumeHandle);
</span><span style="color: rgba(0, 128, 128, 1)">150</span> <span style="color: rgba(0, 0, 0, 1)">            }
</span><span style="color: rgba(0, 128, 128, 1)">151</span>             <span style="color: rgba(0, 0, 255, 1)">return</span> OperateResult&lt;Dictionary&lt;<span style="color: rgba(0, 0, 255, 1)">int</span>, List&lt;<span style="color: rgba(0, 0, 255, 1)">string</span>&gt;&gt;&gt;<span style="color: rgba(0, 0, 0, 1)">.ToSuccess(diskDict);
</span><span style="color: rgba(0, 128, 128, 1)">152</span> <span style="color: rgba(0, 0, 0, 1)">        }
</span><span style="color: rgba(0, 128, 128, 1)">153</span> 
<span style="color: rgba(0, 128, 128, 1)">154</span>         <span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;summary&gt;</span>
<span style="color: rgba(0, 128, 128, 1)">155</span>         <span style="color: rgba(128, 128, 128, 1)">///</span><span style="color: rgba(0, 128, 0, 1)"> è·åååºä¿¡æ¯
</span><span style="color: rgba(0, 128, 128, 1)">156</span>         <span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;/summary&gt;</span>
<span style="color: rgba(0, 128, 128, 1)">157</span>         <span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;param name="hDisk"&gt;&lt;/param&gt;</span>
<span style="color: rgba(0, 128, 128, 1)">158</span>         <span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;returns&gt;&lt;/returns&gt;</span>
<span style="color: rgba(0, 128, 128, 1)">159</span>         <span style="color: rgba(0, 0, 255, 1)">private</span> OperateResult&lt;DiskPartitionInfo&gt;<span style="color: rgba(0, 0, 0, 1)"> GetPartitionInfo(IntPtr hDisk)
</span><span style="color: rgba(0, 128, 128, 1)">160</span> <span style="color: rgba(0, 0, 0, 1)">        {
</span><span style="color: rgba(0, 128, 128, 1)">161</span>             <span style="color: rgba(0, 0, 255, 1)">int</span> outSize = Marshal.SizeOf&lt;DRIVE_LAYOUT_INFORMATION_EX&gt;() + <span style="color: rgba(128, 0, 128, 1)">128</span> * <span style="color: rgba(128, 0, 128, 1)">64</span>; <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> ç»å¤ä¸ç¹ç©ºé´</span>
<span style="color: rgba(0, 128, 128, 1)">162</span>             IntPtr outBuffer =<span style="color: rgba(0, 0, 0, 1)"> Marshal.AllocHGlobal(outSize);
</span><span style="color: rgba(0, 128, 128, 1)">163</span> 
<span style="color: rgba(0, 128, 128, 1)">164</span>             <span style="color: rgba(0, 0, 255, 1)">try</span>
<span style="color: rgba(0, 128, 128, 1)">165</span> <span style="color: rgba(0, 0, 0, 1)">            {
</span><span style="color: rgba(0, 128, 128, 1)">166</span>                 <span style="color: rgba(0, 0, 255, 1)">if</span> (!<span style="color: rgba(0, 0, 0, 1)">DeviceIoControl(
</span><span style="color: rgba(0, 128, 128, 1)">167</span> <span style="color: rgba(0, 0, 0, 1)">                        hDisk,
</span><span style="color: rgba(0, 128, 128, 1)">168</span> <span style="color: rgba(0, 0, 0, 1)">                        IOCTL_DISK_GET_DRIVE_LAYOUT_EX,
</span><span style="color: rgba(0, 128, 128, 1)">169</span> <span style="color: rgba(0, 0, 0, 1)">                        IntPtr.Zero,
</span><span style="color: rgba(0, 128, 128, 1)">170</span>                         <span style="color: rgba(128, 0, 128, 1)">0</span><span style="color: rgba(0, 0, 0, 1)">,
</span><span style="color: rgba(0, 128, 128, 1)">171</span> <span style="color: rgba(0, 0, 0, 1)">                        outBuffer,
</span><span style="color: rgba(0, 128, 128, 1)">172</span>                         (<span style="color: rgba(0, 0, 255, 1)">uint</span><span style="color: rgba(0, 0, 0, 1)">)outSize,
</span><span style="color: rgba(0, 128, 128, 1)">173</span>                         <span style="color: rgba(0, 0, 255, 1)">out</span><span style="color: rgba(0, 0, 0, 1)"> _,
</span><span style="color: rgba(0, 128, 128, 1)">174</span> <span style="color: rgba(0, 0, 0, 1)">                        IntPtr.Zero))
</span><span style="color: rgba(0, 128, 128, 1)">175</span> <span style="color: rgba(0, 0, 0, 1)">                {
</span><span style="color: rgba(0, 128, 128, 1)">176</span>                     <span style="color: rgba(0, 0, 255, 1)">return</span> OperateResult&lt;DiskPartitionInfo&gt;.ToWin32Error(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">DeviceIoControl.IOCTL_DISK_GET_DRIVE_LAYOUT_EX failed</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">, Marshal.GetLastWin32Error());
</span><span style="color: rgba(0, 128, 128, 1)">177</span> <span style="color: rgba(0, 0, 0, 1)">                }
</span><span style="color: rgba(0, 128, 128, 1)">178</span> 
<span style="color: rgba(0, 128, 128, 1)">179</span>                 <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> åªåç»æå¼å¤´</span>
<span style="color: rgba(0, 128, 128, 1)">180</span>                 <span style="color: rgba(0, 0, 255, 1)">var</span> layout = Marshal.PtrToStructure&lt;DRIVE_LAYOUT_INFORMATION_EX_HEADER&gt;<span style="color: rgba(0, 0, 0, 1)">(outBuffer);
</span><span style="color: rgba(0, 128, 128, 1)">181</span>                 <span style="color: rgba(0, 0, 255, 1)">var</span> partitionInfo = <span style="color: rgba(0, 0, 255, 1)">new</span><span style="color: rgba(0, 0, 0, 1)"> DiskPartitionInfo()
</span><span style="color: rgba(0, 128, 128, 1)">182</span> <span style="color: rgba(0, 0, 0, 1)">                {
</span><span style="color: rgba(0, 128, 128, 1)">183</span>                     PartitionCount = (<span style="color: rgba(0, 0, 255, 1)">int</span><span style="color: rgba(0, 0, 0, 1)">)layout.PartitionCount,
</span><span style="color: rgba(0, 128, 128, 1)">184</span>                     PartitionStyle =<span style="color: rgba(0, 0, 0, 1)"> layout.PartitionStyle,
</span><span style="color: rgba(0, 128, 128, 1)">185</span>                     DiskId =<span style="color: rgba(0, 0, 0, 1)"> layout.Gpt.DiskId,
</span><span style="color: rgba(0, 128, 128, 1)">186</span>                     StartingUsableOffset =<span style="color: rgba(0, 0, 0, 1)"> layout.Gpt.StartingUsableOffset,
</span><span style="color: rgba(0, 128, 128, 1)">187</span>                     UsableLength =<span style="color: rgba(0, 0, 0, 1)"> layout.Gpt.UsableLength,
</span><span style="color: rgba(0, 128, 128, 1)">188</span>                     MaxPartitionCount =<span style="color: rgba(0, 0, 0, 1)"> layout.Gpt.MaxPartitionCount
</span><span style="color: rgba(0, 128, 128, 1)">189</span> <span style="color: rgba(0, 0, 0, 1)">                };
</span><span style="color: rgba(0, 128, 128, 1)">190</span>                 <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> æåç¬¬ä¸ä¸ª PARTITION_INFORMATION_EX çæéï¼</span>
<span style="color: rgba(0, 128, 128, 1)">191</span> 
<span style="color: rgba(0, 128, 128, 1)">192</span>                 IntPtr pCurrent = IntPtr.Add(outBuffer, Marshal.SizeOf&lt;DRIVE_LAYOUT_INFORMATION_EX&gt;<span style="color: rgba(0, 0, 0, 1)">());
</span><span style="color: rgba(0, 128, 128, 1)">193</span>                 <span style="color: rgba(0, 0, 255, 1)">int</span> partSize = Marshal.SizeOf&lt;PARTITION_INFORMATION_EX&gt;<span style="color: rgba(0, 0, 0, 1)">();
</span><span style="color: rgba(0, 128, 128, 1)">194</span>                 <span style="color: rgba(0, 0, 255, 1)">for</span> (<span style="color: rgba(0, 0, 255, 1)">int</span> i = <span style="color: rgba(128, 0, 128, 1)">0</span>; i &lt; layout.PartitionCount; i++<span style="color: rgba(0, 0, 0, 1)">)
</span><span style="color: rgba(0, 128, 128, 1)">195</span> <span style="color: rgba(0, 0, 0, 1)">                {
</span><span style="color: rgba(0, 128, 128, 1)">196</span>                     <span style="color: rgba(0, 0, 255, 1)">var</span> part = Marshal.PtrToStructure&lt;PARTITION_INFORMATION_EX&gt;<span style="color: rgba(0, 0, 0, 1)">(pCurrent);
</span><span style="color: rgba(0, 128, 128, 1)">197</span>                     <span style="color: rgba(0, 0, 255, 1)">var</span> item = <span style="color: rgba(0, 0, 255, 1)">new</span><span style="color: rgba(0, 0, 0, 1)"> PartitionEntryInfo
</span><span style="color: rgba(0, 128, 128, 1)">198</span> <span style="color: rgba(0, 0, 0, 1)">                    {
</span><span style="color: rgba(0, 128, 128, 1)">199</span>                         PartitionNumber = (<span style="color: rgba(0, 0, 255, 1)">int</span><span style="color: rgba(0, 0, 0, 1)">)part.PartitionNumber,
</span><span style="color: rgba(0, 128, 128, 1)">200</span>                         StartingOffset =<span style="color: rgba(0, 0, 0, 1)"> part.StartingOffset,
</span><span style="color: rgba(0, 128, 128, 1)">201</span>                         PartitionLength =<span style="color: rgba(0, 0, 0, 1)"> part.PartitionLength,
</span><span style="color: rgba(0, 128, 128, 1)">202</span>                         PartitionType =<span style="color: rgba(0, 0, 0, 1)"> part.Gpt.PartitionType.ToString(),
</span><span style="color: rgba(0, 128, 128, 1)">203</span>                         PartitionName =<span style="color: rgba(0, 0, 0, 1)"> part.Gpt.Name
</span><span style="color: rgba(0, 128, 128, 1)">204</span> <span style="color: rgba(0, 0, 0, 1)">                    };
</span><span style="color: rgba(0, 128, 128, 1)">205</span> 
<span style="color: rgba(0, 128, 128, 1)">206</span> <span style="color: rgba(0, 0, 0, 1)">                    partitionInfo.Partitions.Add(item);
</span><span style="color: rgba(0, 128, 128, 1)">207</span>                     pCurrent =<span style="color: rgba(0, 0, 0, 1)"> IntPtr.Add(pCurrent, partSize);
</span><span style="color: rgba(0, 128, 128, 1)">208</span> <span style="color: rgba(0, 0, 0, 1)">                }
</span><span style="color: rgba(0, 128, 128, 1)">209</span> 
<span style="color: rgba(0, 128, 128, 1)">210</span>                 <span style="color: rgba(0, 0, 255, 1)">return</span> OperateResult&lt;DiskPartitionInfo&gt;<span style="color: rgba(0, 0, 0, 1)">.ToSuccess(partitionInfo);
</span><span style="color: rgba(0, 128, 128, 1)">211</span> <span style="color: rgba(0, 0, 0, 1)">            }
</span><span style="color: rgba(0, 128, 128, 1)">212</span>             <span style="color: rgba(0, 0, 255, 1)">finally</span>
<span style="color: rgba(0, 128, 128, 1)">213</span> <span style="color: rgba(0, 0, 0, 1)">            {
</span><span style="color: rgba(0, 128, 128, 1)">214</span> <span style="color: rgba(0, 0, 0, 1)">                Marshal.FreeHGlobal(outBuffer);
</span><span style="color: rgba(0, 128, 128, 1)">215</span> <span style="color: rgba(0, 0, 0, 1)">            }
</span><span style="color: rgba(0, 128, 128, 1)">216</span> <span style="color: rgba(0, 0, 0, 1)">        }
</span><span style="color: rgba(0, 128, 128, 1)">217</span> 
<span style="color: rgba(0, 128, 128, 1)">218</span>         <span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;summary&gt;</span>
<span style="color: rgba(0, 128, 128, 1)">219</span>         <span style="color: rgba(128, 128, 128, 1)">///</span><span style="color: rgba(0, 128, 0, 1)"> è·åç£çéæå±æ§
</span><span style="color: rgba(0, 128, 128, 1)">220</span>         <span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;/summary&gt;</span>
<span style="color: rgba(0, 128, 128, 1)">221</span>         <span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;param name="hDisk"&gt;&lt;/param&gt;</span>
<span style="color: rgba(0, 128, 128, 1)">222</span>         <span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;returns&gt;&lt;/returns&gt;</span>
<span style="color: rgba(0, 128, 128, 1)">223</span>         <span style="color: rgba(0, 0, 255, 1)">private</span> OperateResult&lt;DiskStorageProperty&gt;<span style="color: rgba(0, 0, 0, 1)"> GetDiskProperties(IntPtr hDisk)
</span><span style="color: rgba(0, 128, 128, 1)">224</span> <span style="color: rgba(0, 0, 0, 1)">        {
</span><span style="color: rgba(0, 128, 128, 1)">225</span>             <span style="color: rgba(0, 0, 255, 1)">var</span> storageProperties = <span style="color: rgba(0, 0, 255, 1)">new</span><span style="color: rgba(0, 0, 0, 1)"> DiskStorageProperty();
</span><span style="color: rgba(0, 128, 128, 1)">226</span>             <span style="color: rgba(0, 0, 255, 1)">var</span> query = <span style="color: rgba(0, 0, 255, 1)">new</span><span style="color: rgba(0, 0, 0, 1)"> STORAGE_PROPERTY_QUERY
</span><span style="color: rgba(0, 128, 128, 1)">227</span> <span style="color: rgba(0, 0, 0, 1)">            {
</span><span style="color: rgba(0, 128, 128, 1)">228</span>                 PropertyId =<span style="color: rgba(0, 0, 0, 1)"> STORAGE_PROPERTY_ID.StorageDeviceProperty,
</span><span style="color: rgba(0, 128, 128, 1)">229</span>                 QueryType =<span style="color: rgba(0, 0, 0, 1)"> STORAGE_QUERY_TYPE.PropertyStandardQuery,
</span><span style="color: rgba(0, 128, 128, 1)">230</span>                 AdditionalParameters = <span style="color: rgba(0, 0, 255, 1)">new</span> <span style="color: rgba(0, 0, 255, 1)">byte</span>[<span style="color: rgba(128, 0, 128, 1)">1</span><span style="color: rgba(0, 0, 0, 1)">]
</span><span style="color: rgba(0, 128, 128, 1)">231</span> <span style="color: rgba(0, 0, 0, 1)">            };
</span><span style="color: rgba(0, 128, 128, 1)">232</span>             <span style="color: rgba(0, 0, 255, 1)">uint</span> allocSize = <span style="color: rgba(128, 0, 128, 1)">1024</span><span style="color: rgba(0, 0, 0, 1)">;
</span><span style="color: rgba(0, 128, 128, 1)">233</span>             IntPtr buffer = Marshal.AllocHGlobal((<span style="color: rgba(0, 0, 255, 1)">int</span><span style="color: rgba(0, 0, 0, 1)">)allocSize);
</span><span style="color: rgba(0, 128, 128, 1)">234</span>             <span style="color: rgba(0, 0, 255, 1)">try</span>
<span style="color: rgba(0, 128, 128, 1)">235</span> <span style="color: rgba(0, 0, 0, 1)">            {
</span><span style="color: rgba(0, 128, 128, 1)">236</span>                 <span style="color: rgba(0, 0, 255, 1)">if</span> (!<span style="color: rgba(0, 0, 0, 1)">DeviceIoControl(
</span><span style="color: rgba(0, 128, 128, 1)">237</span> <span style="color: rgba(0, 0, 0, 1)">                        hDisk,
</span><span style="color: rgba(0, 128, 128, 1)">238</span> <span style="color: rgba(0, 0, 0, 1)">                        IOCTL_STORAGE_QUERY_PROPERTY,
</span><span style="color: rgba(0, 128, 128, 1)">239</span>                         <span style="color: rgba(0, 0, 255, 1)">ref</span><span style="color: rgba(0, 0, 0, 1)"> query,
</span><span style="color: rgba(0, 128, 128, 1)">240</span>                         (<span style="color: rgba(0, 0, 255, 1)">uint</span>)Marshal.SizeOf&lt;STORAGE_PROPERTY_QUERY&gt;<span style="color: rgba(0, 0, 0, 1)">(),
</span><span style="color: rgba(0, 128, 128, 1)">241</span> <span style="color: rgba(0, 0, 0, 1)">                        buffer,
</span><span style="color: rgba(0, 128, 128, 1)">242</span> <span style="color: rgba(0, 0, 0, 1)">                        allocSize,
</span><span style="color: rgba(0, 128, 128, 1)">243</span>                         <span style="color: rgba(0, 0, 255, 1)">out</span> <span style="color: rgba(0, 0, 255, 1)">var</span><span style="color: rgba(0, 0, 0, 1)"> bytesReturned,
</span><span style="color: rgba(0, 128, 128, 1)">244</span> <span style="color: rgba(0, 0, 0, 1)">                        IntPtr.Zero))
</span><span style="color: rgba(0, 128, 128, 1)">245</span> <span style="color: rgba(0, 0, 0, 1)">                {
</span><span style="color: rgba(0, 128, 128, 1)">246</span>                     <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">è¯»åå¤±è´¥</span>
<span style="color: rgba(0, 128, 128, 1)">247</span>                     <span style="color: rgba(0, 0, 255, 1)">int</span> err =<span style="color: rgba(0, 0, 0, 1)"> Marshal.GetLastWin32Error();
</span><span style="color: rgba(0, 128, 128, 1)">248</span>                     <span style="color: rgba(0, 0, 255, 1)">if</span> (err == ERROR_INSUFFICIENT_BUFFER &amp;&amp; bytesReturned &gt;<span style="color: rgba(0, 0, 0, 1)"> allocSize)
</span><span style="color: rgba(0, 128, 128, 1)">249</span> <span style="color: rgba(0, 0, 0, 1)">                    {
</span><span style="color: rgba(0, 128, 128, 1)">250</span>                         <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> éæ°åéæ´å¤§ç¼å²åº</span>
<span style="color: rgba(0, 128, 128, 1)">251</span> <span style="color: rgba(0, 0, 0, 1)">                        Marshal.FreeHGlobal(buffer);
</span><span style="color: rgba(0, 128, 128, 1)">252</span>                         allocSize =<span style="color: rgba(0, 0, 0, 1)"> bytesReturned;
</span><span style="color: rgba(0, 128, 128, 1)">253</span>                         buffer = Marshal.AllocHGlobal((<span style="color: rgba(0, 0, 255, 1)">int</span><span style="color: rgba(0, 0, 0, 1)">)allocSize);
</span><span style="color: rgba(0, 128, 128, 1)">254</span>                         <span style="color: rgba(0, 0, 255, 1)">if</span> (!<span style="color: rgba(0, 0, 0, 1)">DeviceIoControl(
</span><span style="color: rgba(0, 128, 128, 1)">255</span> <span style="color: rgba(0, 0, 0, 1)">                                hDisk,
</span><span style="color: rgba(0, 128, 128, 1)">256</span> <span style="color: rgba(0, 0, 0, 1)">                                IOCTL_STORAGE_QUERY_PROPERTY,
</span><span style="color: rgba(0, 128, 128, 1)">257</span>                                 <span style="color: rgba(0, 0, 255, 1)">ref</span><span style="color: rgba(0, 0, 0, 1)"> query,
</span><span style="color: rgba(0, 128, 128, 1)">258</span>                                 (<span style="color: rgba(0, 0, 255, 1)">uint</span>)Marshal.SizeOf&lt;STORAGE_PROPERTY_QUERY&gt;<span style="color: rgba(0, 0, 0, 1)">(),
</span><span style="color: rgba(0, 128, 128, 1)">259</span> <span style="color: rgba(0, 0, 0, 1)">                                buffer,
</span><span style="color: rgba(0, 128, 128, 1)">260</span> <span style="color: rgba(0, 0, 0, 1)">                                allocSize,
</span><span style="color: rgba(0, 128, 128, 1)">261</span>                                 <span style="color: rgba(0, 0, 255, 1)">out</span><span style="color: rgba(0, 0, 0, 1)"> bytesReturned,
</span><span style="color: rgba(0, 128, 128, 1)">262</span> <span style="color: rgba(0, 0, 0, 1)">                                IntPtr.Zero))
</span><span style="color: rgba(0, 128, 128, 1)">263</span> <span style="color: rgba(0, 0, 0, 1)">                        {
</span><span style="color: rgba(0, 128, 128, 1)">264</span>                             <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">éæ°åéç¼å²åºï¼è¯»åå¤±è´¥</span>
<span style="color: rgba(0, 128, 128, 1)">265</span>                             <span style="color: rgba(0, 0, 255, 1)">return</span> OperateResult&lt;DiskStorageProperty&gt;.ToWin32Error(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">DeviceIoControl.IOCTL_STORAGE_QUERY_PROPERTY execute failed after adjust buffer size</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">, Marshal.GetLastWin32Error());
</span><span style="color: rgba(0, 128, 128, 1)">266</span> <span style="color: rgba(0, 0, 0, 1)">                        }
</span><span style="color: rgba(0, 128, 128, 1)">267</span> <span style="color: rgba(0, 0, 0, 1)">                    }
</span><span style="color: rgba(0, 128, 128, 1)">268</span>                     <span style="color: rgba(0, 0, 255, 1)">else</span>
<span style="color: rgba(0, 128, 128, 1)">269</span> <span style="color: rgba(0, 0, 0, 1)">                    {
</span><span style="color: rgba(0, 128, 128, 1)">270</span>                         <span style="color: rgba(0, 0, 255, 1)">return</span> OperateResult&lt;DiskStorageProperty&gt;.ToWin32Error(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">DeviceIoControl.IOCTL_STORAGE_QUERY_PROPERTY execute failed</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">, err);
</span><span style="color: rgba(0, 128, 128, 1)">271</span> <span style="color: rgba(0, 0, 0, 1)">                    }
</span><span style="color: rgba(0, 128, 128, 1)">272</span> <span style="color: rgba(0, 0, 0, 1)">                }
</span><span style="color: rgba(0, 128, 128, 1)">273</span> 
<span style="color: rgba(0, 128, 128, 1)">274</span>                 <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> è³å°è¦åå« Version/Size/å ä¸ª offset</span>
<span style="color: rgba(0, 128, 128, 1)">275</span>                 <span style="color: rgba(0, 0, 255, 1)">if</span> (bytesReturned &lt; <span style="color: rgba(128, 0, 128, 1)">24</span><span style="color: rgba(0, 0, 0, 1)">)
</span><span style="color: rgba(0, 128, 128, 1)">276</span>                     <span style="color: rgba(0, 0, 255, 1)">return</span> OperateResult&lt;DiskStorageProperty&gt;.ToError($<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">DeviceIoControl.IOCTL_STORAGE_QUERY_PROPERTY execute success but bytesReturned {bytesReturned} is lower than 24</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">);
</span><span style="color: rgba(0, 128, 128, 1)">277</span> 
<span style="color: rgba(0, 128, 128, 1)">278</span>                 <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> --- è¯»åå¤´é¨åºå®å­æ®µï¼æå®æ¹ C ç»ææå·¥åç§»ï¼---
</span><span style="color: rgba(0, 128, 128, 1)">279</span>                 <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> Size    (ULONG) at offset 0x04</span>
<span style="color: rgba(0, 128, 128, 1)">280</span>                 <span style="color: rgba(0, 0, 255, 1)">uint</span> size = (<span style="color: rgba(0, 0, 255, 1)">uint</span>)Marshal.ReadInt32(buffer, <span style="color: rgba(128, 0, 128, 1)">4</span><span style="color: rgba(0, 0, 0, 1)">);
</span><span style="color: rgba(0, 128, 128, 1)">281</span>                 <span style="color: rgba(0, 0, 255, 1)">if</span> (size &gt; bytesReturned) size =<span style="color: rgba(0, 0, 0, 1)"> bytesReturned;
</span><span style="color: rgba(0, 128, 128, 1)">282</span> 
<span style="color: rgba(0, 128, 128, 1)">283</span>                 <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> ç£çåºåå·ï¼å Get-Disk ç SerialNumber</span>
<span style="color: rgba(0, 128, 128, 1)">284</span>                 <span style="color: rgba(0, 0, 255, 1)">uint</span> serialOffset = (<span style="color: rgba(0, 0, 255, 1)">uint</span>)Marshal.ReadInt32(buffer, <span style="color: rgba(128, 0, 128, 1)">0x18</span><span style="color: rgba(0, 0, 0, 1)">);
</span><span style="color: rgba(0, 128, 128, 1)">285</span>                 <span style="color: rgba(0, 0, 255, 1)">string</span> serialRaw =<span style="color: rgba(0, 0, 0, 1)"> ReadAnsiStringSafe(buffer, size, serialOffset);
</span><span style="color: rgba(0, 128, 128, 1)">286</span>                 <span style="color: rgba(0, 0, 255, 1)">string</span> serialClean =<span style="color: rgba(0, 0, 0, 1)"> CleanSerialString(serialRaw);
</span><span style="color: rgba(0, 128, 128, 1)">287</span>                 storageProperties.SerialNumber =<span style="color: rgba(0, 0, 0, 1)"> serialClean;
</span><span style="color: rgba(0, 128, 128, 1)">288</span> 
<span style="color: rgba(0, 128, 128, 1)">289</span>                 <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> ç£çåå/åç§°ç¸å³</span>
<span style="color: rgba(0, 128, 128, 1)">290</span>                 <span style="color: rgba(0, 0, 255, 1)">uint</span> vendorOffset = (<span style="color: rgba(0, 0, 255, 1)">uint</span>)Marshal.ReadInt32(buffer, <span style="color: rgba(128, 0, 128, 1)">0x0C</span><span style="color: rgba(0, 0, 0, 1)">);
</span><span style="color: rgba(0, 128, 128, 1)">291</span>                 <span style="color: rgba(0, 0, 255, 1)">uint</span> productOffset = (<span style="color: rgba(0, 0, 255, 1)">uint</span>)Marshal.ReadInt32(buffer, <span style="color: rgba(128, 0, 128, 1)">0x10</span><span style="color: rgba(0, 0, 0, 1)">);
</span><span style="color: rgba(0, 128, 128, 1)">292</span>                 <span style="color: rgba(0, 0, 255, 1)">uint</span> revisionOffset = (<span style="color: rgba(0, 0, 255, 1)">uint</span>)Marshal.ReadInt32(buffer, <span style="color: rgba(128, 0, 128, 1)">0x14</span><span style="color: rgba(0, 0, 0, 1)">);
</span><span style="color: rgba(0, 128, 128, 1)">293</span>                 storageProperties.Vendor =<span style="color: rgba(0, 0, 0, 1)"> ReadAnsiStringSafe(buffer, size, vendorOffset);
</span><span style="color: rgba(0, 128, 128, 1)">294</span>                 storageProperties.Product =<span style="color: rgba(0, 0, 0, 1)"> ReadAnsiStringSafe(buffer, size, productOffset);
</span><span style="color: rgba(0, 128, 128, 1)">295</span>                 storageProperties.Version =<span style="color: rgba(0, 0, 0, 1)"> ReadAnsiStringSafe(buffer, size, revisionOffset);
</span><span style="color: rgba(0, 128, 128, 1)">296</span>                 storageProperties.DeviceName = $<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">{storageProperties.Vendor} {storageProperties.Product}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">;
</span><span style="color: rgba(0, 128, 128, 1)">297</span>                 <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> BusType</span>
<span style="color: rgba(0, 128, 128, 1)">298</span>                 <span style="color: rgba(0, 0, 255, 1)">uint</span> busTypeOffset = (<span style="color: rgba(0, 0, 255, 1)">uint</span>)Marshal.ReadInt32(buffer, <span style="color: rgba(128, 0, 128, 1)">0x1C</span><span style="color: rgba(0, 0, 0, 1)">);
</span><span style="color: rgba(0, 128, 128, 1)">299</span>                 storageProperties.BusType = Enum.IsDefined(<span style="color: rgba(0, 0, 255, 1)">typeof</span>(StorageBusType), (<span style="color: rgba(0, 0, 255, 1)">int</span><span style="color: rgba(0, 0, 0, 1)">)busTypeOffset)
</span><span style="color: rgba(0, 128, 128, 1)">300</span>                     ?<span style="color: rgba(0, 0, 0, 1)"> (StorageBusType)busTypeOffset
</span><span style="color: rgba(0, 128, 128, 1)">301</span> <span style="color: rgba(0, 0, 0, 1)">                    : StorageBusType.Unknown;
</span><span style="color: rgba(0, 128, 128, 1)">302</span>                 <span style="color: rgba(0, 0, 255, 1)">return</span> OperateResult&lt;DiskStorageProperty&gt;<span style="color: rgba(0, 0, 0, 1)">.ToSuccess(storageProperties);
</span><span style="color: rgba(0, 128, 128, 1)">303</span> <span style="color: rgba(0, 0, 0, 1)">            }
</span><span style="color: rgba(0, 128, 128, 1)">304</span>             <span style="color: rgba(0, 0, 255, 1)">catch</span><span style="color: rgba(0, 0, 0, 1)"> (Exception ex)
</span><span style="color: rgba(0, 128, 128, 1)">305</span> <span style="color: rgba(0, 0, 0, 1)">            {
</span><span style="color: rgba(0, 128, 128, 1)">306</span>                 <span style="color: rgba(0, 0, 255, 1)">return</span> OperateResult&lt;DiskStorageProperty&gt;<span style="color: rgba(0, 0, 0, 1)">.ToError(ex);
</span><span style="color: rgba(0, 128, 128, 1)">307</span> <span style="color: rgba(0, 0, 0, 1)">            }
</span><span style="color: rgba(0, 128, 128, 1)">308</span>             <span style="color: rgba(0, 0, 255, 1)">finally</span>
<span style="color: rgba(0, 128, 128, 1)">309</span> <span style="color: rgba(0, 0, 0, 1)">            {
</span><span style="color: rgba(0, 128, 128, 1)">310</span> <span style="color: rgba(0, 0, 0, 1)">                Marshal.FreeHGlobal(buffer);
</span><span style="color: rgba(0, 128, 128, 1)">311</span> <span style="color: rgba(0, 0, 0, 1)">            }
</span><span style="color: rgba(0, 128, 128, 1)">312</span> <span style="color: rgba(0, 0, 0, 1)">        }
</span><span style="color: rgba(0, 128, 128, 1)">313</span> 
<span style="color: rgba(0, 128, 128, 1)">314</span>         <span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;summary&gt;</span>
<span style="color: rgba(0, 128, 128, 1)">315</span>         <span style="color: rgba(128, 128, 128, 1)">///</span><span style="color: rgba(0, 128, 0, 1)"> è·åç£çå¤§å°ï¼Bytesï¼
</span><span style="color: rgba(0, 128, 128, 1)">316</span>         <span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;/summary&gt;</span>
<span style="color: rgba(0, 128, 128, 1)">317</span>         <span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;param name="hDisk"&gt;&lt;/param&gt;</span>
<span style="color: rgba(0, 128, 128, 1)">318</span>         <span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;returns&gt;&lt;/returns&gt;</span>
<span style="color: rgba(0, 128, 128, 1)">319</span>         <span style="color: rgba(0, 0, 255, 1)">public</span> OperateResult&lt;<span style="color: rgba(0, 0, 255, 1)">long</span>&gt;<span style="color: rgba(0, 0, 0, 1)"> GetDiskSize(IntPtr hDisk)
</span><span style="color: rgba(0, 128, 128, 1)">320</span> <span style="color: rgba(0, 0, 0, 1)">        {
</span><span style="color: rgba(0, 128, 128, 1)">321</span>             <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> ç¨ä¸ä¸ªè¶³å¤å¤§çç¼å²åºï¼ä¸è¬ 1024 å­èè¶³å¤</span>
<span style="color: rgba(0, 128, 128, 1)">322</span>             <span style="color: rgba(0, 0, 255, 1)">const</span> <span style="color: rgba(0, 0, 255, 1)">int</span> bufferSize = <span style="color: rgba(128, 0, 128, 1)">1024</span><span style="color: rgba(0, 0, 0, 1)">;
</span><span style="color: rgba(0, 128, 128, 1)">323</span>             IntPtr buffer =<span style="color: rgba(0, 0, 0, 1)"> Marshal.AllocHGlobal(bufferSize);
</span><span style="color: rgba(0, 128, 128, 1)">324</span>             <span style="color: rgba(0, 0, 255, 1)">try</span>
<span style="color: rgba(0, 128, 128, 1)">325</span> <span style="color: rgba(0, 0, 0, 1)">            {
</span><span style="color: rgba(0, 128, 128, 1)">326</span>                 <span style="color: rgba(0, 0, 255, 1)">bool</span> ok =<span style="color: rgba(0, 0, 0, 1)"> DeviceIoControl(
</span><span style="color: rgba(0, 128, 128, 1)">327</span> <span style="color: rgba(0, 0, 0, 1)">                    hDisk,
</span><span style="color: rgba(0, 128, 128, 1)">328</span> <span style="color: rgba(0, 0, 0, 1)">                    IOCTL_DISK_GET_DRIVE_GEOMETRY_EX,
</span><span style="color: rgba(0, 128, 128, 1)">329</span> <span style="color: rgba(0, 0, 0, 1)">                    IntPtr.Zero,
</span><span style="color: rgba(0, 128, 128, 1)">330</span>                     <span style="color: rgba(128, 0, 128, 1)">0</span><span style="color: rgba(0, 0, 0, 1)">,
</span><span style="color: rgba(0, 128, 128, 1)">331</span> <span style="color: rgba(0, 0, 0, 1)">                    buffer,
</span><span style="color: rgba(0, 128, 128, 1)">332</span>                     (<span style="color: rgba(0, 0, 255, 1)">uint</span><span style="color: rgba(0, 0, 0, 1)">)bufferSize,
</span><span style="color: rgba(0, 128, 128, 1)">333</span>                     <span style="color: rgba(0, 0, 255, 1)">out</span> <span style="color: rgba(0, 0, 255, 1)">var</span><span style="color: rgba(0, 0, 0, 1)"> bytesReturned,
</span><span style="color: rgba(0, 128, 128, 1)">334</span> <span style="color: rgba(0, 0, 0, 1)">                    IntPtr.Zero);
</span><span style="color: rgba(0, 128, 128, 1)">335</span>                 <span style="color: rgba(0, 0, 255, 1)">if</span> (!<span style="color: rgba(0, 0, 0, 1)">ok)
</span><span style="color: rgba(0, 128, 128, 1)">336</span>                     <span style="color: rgba(0, 0, 255, 1)">return</span> OperateResult&lt;<span style="color: rgba(0, 0, 255, 1)">long</span>&gt;.ToError(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">DeviceIoControl.IOCTL_DISK_GET_DRIVE_GEOMETRY_EX failed</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">, Marshal.GetLastWin32Error());
</span><span style="color: rgba(0, 128, 128, 1)">337</span>                 <span style="color: rgba(0, 0, 255, 1)">if</span> (bytesReturned &lt; Marshal.SizeOf&lt;DISK_GEOMETRY_EX&gt;<span style="color: rgba(0, 0, 0, 1)">())
</span><span style="color: rgba(0, 128, 128, 1)">338</span>                     <span style="color: rgba(0, 0, 255, 1)">return</span> OperateResult&lt;<span style="color: rgba(0, 0, 255, 1)">long</span>&gt;.ToSuccess(<span style="color: rgba(128, 0, 128, 1)">0</span><span style="color: rgba(0, 0, 0, 1)">);
</span><span style="color: rgba(0, 128, 128, 1)">339</span> 
<span style="color: rgba(0, 128, 128, 1)">340</span>                 <span style="color: rgba(0, 0, 255, 1)">var</span> geomEx = Marshal.PtrToStructure&lt;DISK_GEOMETRY_EX&gt;<span style="color: rgba(0, 0, 0, 1)">(buffer);
</span><span style="color: rgba(0, 128, 128, 1)">341</span>                 <span style="color: rgba(0, 0, 255, 1)">return</span> OperateResult&lt;<span style="color: rgba(0, 0, 255, 1)">long</span>&gt;<span style="color: rgba(0, 0, 0, 1)">.ToSuccess(geomEx.DiskSize);
</span><span style="color: rgba(0, 128, 128, 1)">342</span> <span style="color: rgba(0, 0, 0, 1)">            }
</span><span style="color: rgba(0, 128, 128, 1)">343</span>             <span style="color: rgba(0, 0, 255, 1)">catch</span><span style="color: rgba(0, 0, 0, 1)"> (Exception e)
</span><span style="color: rgba(0, 128, 128, 1)">344</span> <span style="color: rgba(0, 0, 0, 1)">            {
</span><span style="color: rgba(0, 128, 128, 1)">345</span>                 <span style="color: rgba(0, 0, 255, 1)">return</span> OperateResult&lt;<span style="color: rgba(0, 0, 255, 1)">long</span>&gt;<span style="color: rgba(0, 0, 0, 1)">.ToError(e);
</span><span style="color: rgba(0, 128, 128, 1)">346</span> <span style="color: rgba(0, 0, 0, 1)">            }
</span><span style="color: rgba(0, 128, 128, 1)">347</span>             <span style="color: rgba(0, 0, 255, 1)">finally</span>
<span style="color: rgba(0, 128, 128, 1)">348</span> <span style="color: rgba(0, 0, 0, 1)">            {
</span><span style="color: rgba(0, 128, 128, 1)">349</span> <span style="color: rgba(0, 0, 0, 1)">                Marshal.FreeHGlobal(buffer);
</span><span style="color: rgba(0, 128, 128, 1)">350</span> <span style="color: rgba(0, 0, 0, 1)">            }
</span><span style="color: rgba(0, 128, 128, 1)">351</span> <span style="color: rgba(0, 0, 0, 1)">        }
</span><span style="color: rgba(0, 128, 128, 1)">352</span> 
<span style="color: rgba(0, 128, 128, 1)">353</span>         <span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;summary&gt;</span>
<span style="color: rgba(0, 128, 128, 1)">354</span>         <span style="color: rgba(128, 128, 128, 1)">///</span><span style="color: rgba(0, 128, 0, 1)"> è·åç£çæ©å±å±æ§
</span><span style="color: rgba(0, 128, 128, 1)">355</span>         <span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;/summary&gt;</span>
<span style="color: rgba(0, 128, 128, 1)">356</span>         <span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;param name="hDisk"&gt;&lt;/param&gt;</span>
<span style="color: rgba(0, 128, 128, 1)">357</span>         <span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;returns&gt;&lt;/returns&gt;</span>
<span style="color: rgba(0, 128, 128, 1)">358</span>         <span style="color: rgba(0, 0, 255, 1)">private</span> OperateResult&lt;DiskStorageAttribues&gt;<span style="color: rgba(0, 0, 0, 1)"> GetDiskAttributes(IntPtr hDisk)
</span><span style="color: rgba(0, 128, 128, 1)">359</span> <span style="color: rgba(0, 0, 0, 1)">        {
</span><span style="color: rgba(0, 128, 128, 1)">360</span>             <span style="color: rgba(0, 0, 255, 1)">try</span>
<span style="color: rgba(0, 128, 128, 1)">361</span> <span style="color: rgba(0, 0, 0, 1)">            {
</span><span style="color: rgba(0, 128, 128, 1)">362</span>                 <span style="color: rgba(0, 0, 255, 1)">int</span> getSize = Marshal.SizeOf&lt;GET_DISK_ATTRIBUTES&gt;<span style="color: rgba(0, 0, 0, 1)">();
</span><span style="color: rgba(0, 128, 128, 1)">363</span>                 <span style="color: rgba(0, 0, 255, 1)">var</span> getAttr = <span style="color: rgba(0, 0, 255, 1)">new</span><span style="color: rgba(0, 0, 0, 1)"> GET_DISK_ATTRIBUTES
</span><span style="color: rgba(0, 128, 128, 1)">364</span> <span style="color: rgba(0, 0, 0, 1)">                {
</span><span style="color: rgba(0, 128, 128, 1)">365</span>                     Version = (<span style="color: rgba(0, 0, 255, 1)">uint</span>)getSize, <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> å³é®ï¼Version = sizeof(GET_DISK_ATTRIBUTES)</span>
<span style="color: rgba(0, 128, 128, 1)">366</span>                     Reserved1 = <span style="color: rgba(128, 0, 128, 1)">0</span><span style="color: rgba(0, 0, 0, 1)">,
</span><span style="color: rgba(0, 128, 128, 1)">367</span>                     Attributes = <span style="color: rgba(128, 0, 128, 1)">0</span>
<span style="color: rgba(0, 128, 128, 1)">368</span> <span style="color: rgba(0, 0, 0, 1)">                };
</span><span style="color: rgba(0, 128, 128, 1)">369</span> 
<span style="color: rgba(0, 128, 128, 1)">370</span>                 <span style="color: rgba(0, 0, 255, 1)">if</span> (!<span style="color: rgba(0, 0, 0, 1)">DeviceIoControl_DiskAttributes(
</span><span style="color: rgba(0, 128, 128, 1)">371</span> <span style="color: rgba(0, 0, 0, 1)">                        hDisk,
</span><span style="color: rgba(0, 128, 128, 1)">372</span> <span style="color: rgba(0, 0, 0, 1)">                        IOCTL_DISK_GET_DISK_ATTRIBUTES,
</span><span style="color: rgba(0, 128, 128, 1)">373</span>                         <span style="color: rgba(0, 0, 255, 1)">ref</span><span style="color: rgba(0, 0, 0, 1)"> getAttr,
</span><span style="color: rgba(0, 128, 128, 1)">374</span>                         (<span style="color: rgba(0, 0, 255, 1)">uint</span><span style="color: rgba(0, 0, 0, 1)">)getSize,
</span><span style="color: rgba(0, 128, 128, 1)">375</span>                         <span style="color: rgba(0, 0, 255, 1)">ref</span><span style="color: rgba(0, 0, 0, 1)"> getAttr,
</span><span style="color: rgba(0, 128, 128, 1)">376</span>                         (<span style="color: rgba(0, 0, 255, 1)">uint</span><span style="color: rgba(0, 0, 0, 1)">)getSize,
</span><span style="color: rgba(0, 128, 128, 1)">377</span>                         <span style="color: rgba(0, 0, 255, 1)">out</span><span style="color: rgba(0, 0, 0, 1)"> _,
</span><span style="color: rgba(0, 128, 128, 1)">378</span> <span style="color: rgba(0, 0, 0, 1)">                        IntPtr.Zero))
</span><span style="color: rgba(0, 128, 128, 1)">379</span> <span style="color: rgba(0, 0, 0, 1)">                {
</span><span style="color: rgba(0, 128, 128, 1)">380</span>                     <span style="color: rgba(0, 0, 255, 1)">return</span> OperateResult&lt;DiskStorageAttribues&gt;.ToWin32Error(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">IOCTL_DISK_GET_DISK_ATTRIBUTES å¤±è´¥</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">, Marshal.GetLastWin32Error());
</span><span style="color: rgba(0, 128, 128, 1)">381</span> <span style="color: rgba(0, 0, 0, 1)">                }
</span><span style="color: rgba(0, 128, 128, 1)">382</span>                 <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">ç£çæ©å±å±æ§</span>
<span style="color: rgba(0, 128, 128, 1)">383</span>                 <span style="color: rgba(0, 0, 255, 1)">var</span> diskStorageAttributes = <span style="color: rgba(0, 0, 255, 1)">new</span><span style="color: rgba(0, 0, 0, 1)"> DiskStorageAttribues();
</span><span style="color: rgba(0, 128, 128, 1)">384</span>                 diskStorageAttributes.IsOffline = (getAttr.Attributes &amp; DISK_ATTRIBUTE_OFFLINE) != <span style="color: rgba(128, 0, 128, 1)">0</span><span style="color: rgba(0, 0, 0, 1)">;
</span><span style="color: rgba(0, 128, 128, 1)">385</span>                 diskStorageAttributes.IsReadOnly = (getAttr.Attributes &amp; DISK_ATTRIBUTE_READ_ONLY) != <span style="color: rgba(128, 0, 128, 1)">0</span><span style="color: rgba(0, 0, 0, 1)">;
</span><span style="color: rgba(0, 128, 128, 1)">386</span>                 <span style="color: rgba(0, 0, 255, 1)">return</span> OperateResult&lt;DiskStorageAttribues&gt;<span style="color: rgba(0, 0, 0, 1)">.ToSuccess(diskStorageAttributes);
</span><span style="color: rgba(0, 128, 128, 1)">387</span> <span style="color: rgba(0, 0, 0, 1)">            }
</span><span style="color: rgba(0, 128, 128, 1)">388</span>             <span style="color: rgba(0, 0, 255, 1)">catch</span><span style="color: rgba(0, 0, 0, 1)"> (Exception ex)
</span><span style="color: rgba(0, 128, 128, 1)">389</span> <span style="color: rgba(0, 0, 0, 1)">            {
</span><span style="color: rgba(0, 128, 128, 1)">390</span>                 <span style="color: rgba(0, 0, 255, 1)">return</span> OperateResult&lt;DiskStorageAttribues&gt;<span style="color: rgba(0, 0, 0, 1)">.ToError(ex);
</span><span style="color: rgba(0, 128, 128, 1)">391</span> <span style="color: rgba(0, 0, 0, 1)">            }
</span><span style="color: rgba(0, 128, 128, 1)">392</span> <span style="color: rgba(0, 0, 0, 1)">        }
</span><span style="color: rgba(0, 128, 128, 1)">393</span> 
<span style="color: rgba(0, 128, 128, 1)">394</span>         <span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;summary&gt;</span>
<span style="color: rgba(0, 128, 128, 1)">395</span>         <span style="color: rgba(128, 128, 128, 1)">///</span><span style="color: rgba(0, 128, 0, 1)"> éè¿ä»»ææè½½è·¯å¾ï¼çç¬¦ãç®å½æè½½ç¹ãVolume GUIDï¼è·åå·å¤§å°ä¸ä½¿ç¨é
</span><span style="color: rgba(0, 128, 128, 1)">396</span>         <span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;/summary&gt;</span>
<span style="color: rgba(0, 128, 128, 1)">397</span>         <span style="color: rgba(0, 0, 255, 1)">private</span> OperateResult&lt;DiskSizeUsage&gt; GetDiskSizeUsageByMountPath(<span style="color: rgba(0, 0, 255, 1)">string</span><span style="color: rgba(0, 0, 0, 1)"> mountPath)
</span><span style="color: rgba(0, 128, 128, 1)">398</span> <span style="color: rgba(0, 0, 0, 1)">        {
</span><span style="color: rgba(0, 128, 128, 1)">399</span>             <span style="color: rgba(0, 0, 255, 1)">if</span> (<span style="color: rgba(0, 0, 255, 1)">string</span><span style="color: rgba(0, 0, 0, 1)">.IsNullOrWhiteSpace(mountPath))
</span><span style="color: rgba(0, 128, 128, 1)">400</span> <span style="color: rgba(0, 0, 0, 1)">            {
</span><span style="color: rgba(0, 128, 128, 1)">401</span>                 <span style="color: rgba(0, 0, 255, 1)">return</span> OperateResult&lt;DiskSizeUsage&gt;.ToError($<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">parameter {nameof(mountPath)} is empty</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">);
</span><span style="color: rgba(0, 128, 128, 1)">402</span> <span style="color: rgba(0, 0, 0, 1)">            }
</span><span style="color: rgba(0, 128, 128, 1)">403</span> 
<span style="color: rgba(0, 128, 128, 1)">404</span>             <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> ç¡®ä¿è·¯å¾æ«å°¾æåææ å¯¹æäºåºæ¯æ´ç¨³å¦¥</span>
<span style="color: rgba(0, 128, 128, 1)">405</span>             <span style="color: rgba(0, 0, 255, 1)">if</span> (!mountPath.EndsWith(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">\\</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">))
</span><span style="color: rgba(0, 128, 128, 1)">406</span>                 mountPath += <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">\\</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">;
</span><span style="color: rgba(0, 128, 128, 1)">407</span> 
<span style="color: rgba(0, 128, 128, 1)">408</span>             <span style="color: rgba(0, 0, 255, 1)">if</span> (!<span style="color: rgba(0, 0, 0, 1)">GetDiskFreeSpaceExW(mountPath,
</span><span style="color: rgba(0, 128, 128, 1)">409</span>                     <span style="color: rgba(0, 0, 255, 1)">out</span> <span style="color: rgba(0, 0, 255, 1)">var</span><span style="color: rgba(0, 0, 0, 1)"> freeAvailable,
</span><span style="color: rgba(0, 128, 128, 1)">410</span>                     <span style="color: rgba(0, 0, 255, 1)">out</span> <span style="color: rgba(0, 0, 255, 1)">var</span><span style="color: rgba(0, 0, 0, 1)"> totalBytes,
</span><span style="color: rgba(0, 128, 128, 1)">411</span>                     <span style="color: rgba(0, 0, 255, 1)">out</span> <span style="color: rgba(0, 0, 255, 1)">var</span><span style="color: rgba(0, 0, 0, 1)"> totalFreeBytes))
</span><span style="color: rgba(0, 128, 128, 1)">412</span> <span style="color: rgba(0, 0, 0, 1)">            {
</span><span style="color: rgba(0, 128, 128, 1)">413</span>                 <span style="color: rgba(0, 0, 255, 1)">return</span> OperateResult&lt;DiskSizeUsage&gt;.ToError(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">GetDiskFreeSpaceExW failed</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">, Marshal.GetLastWin32Error());
</span><span style="color: rgba(0, 128, 128, 1)">414</span> <span style="color: rgba(0, 0, 0, 1)">            }
</span><span style="color: rgba(0, 128, 128, 1)">415</span> 
<span style="color: rgba(0, 128, 128, 1)">416</span>             <span style="color: rgba(0, 0, 255, 1)">return</span> OperateResult&lt;DiskSizeUsage&gt;.ToSuccess(<span style="color: rgba(0, 0, 255, 1)">new</span> DiskSizeUsage((<span style="color: rgba(0, 0, 255, 1)">long</span>)totalBytes, (<span style="color: rgba(0, 0, 255, 1)">long</span><span style="color: rgba(0, 0, 0, 1)">)totalFreeBytes));
</span><span style="color: rgba(0, 128, 128, 1)">417</span> <span style="color: rgba(0, 0, 0, 1)">        }
</span><span style="color: rgba(0, 128, 128, 1)">418</span> 
<span style="color: rgba(0, 128, 128, 1)">419</span>         <span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;summary&gt;</span>
<span style="color: rgba(0, 128, 128, 1)">420</span>         <span style="color: rgba(128, 128, 128, 1)">///</span><span style="color: rgba(0, 128, 0, 1)"> éè¿æè½½è·¯å¾è·åå·ä¿¡æ¯
</span><span style="color: rgba(0, 128, 128, 1)">421</span>         <span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;/summary&gt;</span>
<span style="color: rgba(0, 128, 128, 1)">422</span>         <span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;param name="mountPath"&gt;</span><span style="color: rgba(0, 128, 0, 1)">çç¬¦, e.g. "E:\\"</span><span style="color: rgba(128, 128, 128, 1)">&lt;/param&gt;</span>
<span style="color: rgba(0, 128, 128, 1)">423</span>         <span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;returns&gt;&lt;/returns&gt;</span>
<span style="color: rgba(0, 128, 128, 1)">424</span>         <span style="color: rgba(0, 0, 255, 1)">private</span> OperateResult&lt;VolumeInfo&gt; GetVolumeInfo(<span style="color: rgba(0, 0, 255, 1)">string</span><span style="color: rgba(0, 0, 0, 1)"> mountPath)
</span><span style="color: rgba(0, 128, 128, 1)">425</span> <span style="color: rgba(0, 0, 0, 1)">        {
</span><span style="color: rgba(0, 128, 128, 1)">426</span>             <span style="color: rgba(0, 0, 255, 1)">var</span> volumeName = <span style="color: rgba(0, 0, 255, 1)">new</span> StringBuilder(<span style="color: rgba(128, 0, 128, 1)">256</span><span style="color: rgba(0, 0, 0, 1)">);
</span><span style="color: rgba(0, 128, 128, 1)">427</span>             <span style="color: rgba(0, 0, 255, 1)">var</span> fileSystemType = <span style="color: rgba(0, 0, 255, 1)">new</span> StringBuilder(<span style="color: rgba(128, 0, 128, 1)">256</span><span style="color: rgba(0, 0, 0, 1)">);
</span><span style="color: rgba(0, 128, 128, 1)">428</span> 
<span style="color: rgba(0, 128, 128, 1)">429</span>             <span style="color: rgba(0, 0, 255, 1)">if</span> (!mountPath.EndsWith(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">\\</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">))
</span><span style="color: rgba(0, 128, 128, 1)">430</span>                 mountPath += <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">\\</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">;
</span><span style="color: rgba(0, 128, 128, 1)">431</span>             <span style="color: rgba(0, 0, 255, 1)">var</span> success =<span style="color: rgba(0, 0, 0, 1)"> GetVolumeInformationW(
</span><span style="color: rgba(0, 128, 128, 1)">432</span> <span style="color: rgba(0, 0, 0, 1)">                mountPath,
</span><span style="color: rgba(0, 128, 128, 1)">433</span> <span style="color: rgba(0, 0, 0, 1)">                volumeName, volumeName.Capacity,
</span><span style="color: rgba(0, 128, 128, 1)">434</span>                 <span style="color: rgba(0, 0, 255, 1)">out</span> _, <span style="color: rgba(0, 0, 255, 1)">out</span> _, <span style="color: rgba(0, 0, 255, 1)">out</span><span style="color: rgba(0, 0, 0, 1)"> _,
</span><span style="color: rgba(0, 128, 128, 1)">435</span> <span style="color: rgba(0, 0, 0, 1)">                fileSystemType, fileSystemType.Capacity);
</span><span style="color: rgba(0, 128, 128, 1)">436</span>             <span style="color: rgba(0, 0, 255, 1)">if</span> (!<span style="color: rgba(0, 0, 0, 1)">success)
</span><span style="color: rgba(0, 128, 128, 1)">437</span> <span style="color: rgba(0, 0, 0, 1)">            {
</span><span style="color: rgba(0, 128, 128, 1)">438</span>                 <span style="color: rgba(0, 0, 255, 1)">int</span> err =<span style="color: rgba(0, 0, 0, 1)"> Marshal.GetLastWin32Error();
</span><span style="color: rgba(0, 128, 128, 1)">439</span>                 <span style="color: rgba(0, 0, 255, 1)">return</span> OperateResult&lt;VolumeInfo&gt;.ToWin32Error($<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">GetVolumeInformationW get {mountPath} volume info failed</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">, err);
</span><span style="color: rgba(0, 128, 128, 1)">440</span> <span style="color: rgba(0, 0, 0, 1)">            }
</span><span style="color: rgba(0, 128, 128, 1)">441</span> 
<span style="color: rgba(0, 128, 128, 1)">442</span>             <span style="color: rgba(0, 0, 255, 1)">var</span> volumeInfo = <span style="color: rgba(0, 0, 255, 1)">new</span><span style="color: rgba(0, 0, 0, 1)"> VolumeInfo()
</span><span style="color: rgba(0, 128, 128, 1)">443</span> <span style="color: rgba(0, 0, 0, 1)">            {
</span><span style="color: rgba(0, 128, 128, 1)">444</span>                 VolumeLabel =<span style="color: rgba(0, 0, 0, 1)"> volumeName.ToString(),
</span><span style="color: rgba(0, 128, 128, 1)">445</span>                 FileSystemType =<span style="color: rgba(0, 0, 0, 1)"> fileSystemType.ToString()
</span><span style="color: rgba(0, 128, 128, 1)">446</span> <span style="color: rgba(0, 0, 0, 1)">            };
</span><span style="color: rgba(0, 128, 128, 1)">447</span>             <span style="color: rgba(0, 0, 255, 1)">return</span> OperateResult&lt;VolumeInfo&gt;<span style="color: rgba(0, 0, 0, 1)">.ToSuccess(volumeInfo);
</span><span style="color: rgba(0, 128, 128, 1)">448</span> <span style="color: rgba(0, 0, 0, 1)">        }
</span><span style="color: rgba(0, 128, 128, 1)">449</span> 
<span style="color: rgba(0, 128, 128, 1)">450</span>         <span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;summary&gt;</span>
<span style="color: rgba(0, 128, 128, 1)">451</span>         <span style="color: rgba(128, 128, 128, 1)">///</span><span style="color: rgba(0, 128, 0, 1)"> éè¿æè½½è·¯å¾è·åç£çä¿¡æ¯
</span><span style="color: rgba(0, 128, 128, 1)">452</span>         <span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;para&gt;</span><span style="color: rgba(0, 128, 0, 1)">åè·åç£çåè¡¨ï¼åç­é</span><span style="color: rgba(128, 128, 128, 1)">&lt;/para&gt;</span>
<span style="color: rgba(0, 128, 128, 1)">453</span>         <span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;/summary&gt;</span>
<span style="color: rgba(0, 128, 128, 1)">454</span>         <span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;param name="mountPath"&gt;&lt;/param&gt;</span>
<span style="color: rgba(0, 128, 128, 1)">455</span>         <span style="color: rgba(128, 128, 128, 1)">///</span> <span style="color: rgba(128, 128, 128, 1)">&lt;returns&gt;&lt;/returns&gt;</span>
<span style="color: rgba(0, 128, 128, 1)">456</span>         <span style="color: rgba(0, 0, 255, 1)">public</span> OperateResult&lt;LocalDisk&gt; GetDiskByMountPath(<span style="color: rgba(0, 0, 255, 1)">string</span><span style="color: rgba(0, 0, 0, 1)"> mountPath)
</span><span style="color: rgba(0, 128, 128, 1)">457</span> <span style="color: rgba(0, 0, 0, 1)">        {
</span><span style="color: rgba(0, 128, 128, 1)">458</span>             <span style="color: rgba(0, 0, 255, 1)">var</span> getDisksResult =<span style="color: rgba(0, 0, 0, 1)"> GetDisks();
</span><span style="color: rgba(0, 128, 128, 1)">459</span>             <span style="color: rgba(0, 0, 255, 1)">if</span> (!<span style="color: rgba(0, 0, 0, 1)">getDisksResult.Success)
</span><span style="color: rgba(0, 128, 128, 1)">460</span> <span style="color: rgba(0, 0, 0, 1)">            {
</span><span style="color: rgba(0, 128, 128, 1)">461</span>                 <span style="color: rgba(0, 0, 255, 1)">return</span> getDisksResult.ToResult&lt;LocalDisk&gt;<span style="color: rgba(0, 0, 0, 1)">();
</span><span style="color: rgba(0, 128, 128, 1)">462</span> <span style="color: rgba(0, 0, 0, 1)">            }
</span><span style="color: rgba(0, 128, 128, 1)">463</span> 
<span style="color: rgba(0, 128, 128, 1)">464</span>             <span style="color: rgba(0, 0, 255, 1)">var</span> iscsiDisks = getDisksResult.Data.FirstOrDefault(i =&gt;<span style="color: rgba(0, 0, 0, 1)"> i.MountPaths.Contains(mountPath));
</span><span style="color: rgba(0, 128, 128, 1)">465</span>             <span style="color: rgba(0, 0, 255, 1)">return</span> OperateResult&lt;LocalDisk&gt;<span style="color: rgba(0, 0, 0, 1)">.ToSuccess(iscsiDisks);
</span><span style="color: rgba(0, 128, 128, 1)">466</span>         }</pre>
</div>
<span class="cnblogs_code_collapse">View Code</span></div>
<p>åæ ·çéåç£çåè¡¨ï¼4åï¼ï¼é¦æ¬¡èæ¶20msï¼äºæ¬¡æ¥è¯¢ä»7msï¼</p>
<p><img src="https://img2024.cnblogs.com/blog/685541/202601/685541-20260112203649643-1418202473.png" alt="image" loading="lazy"></p>
<p>å°è£WIN32ï¼å¼å¸¸ç åªæåºç¡çWin32Exceptionå¼å¸¸ç ï¼ä¸åPowershell Storageæç¸å¯¹ä¸å±æ´å¤çä¸å¡å¼å¸¸ç åå¼å¸¸æè¿°é£ä¹å¥½çè§£ã</p>
<p>æ¯å¦å¥æCreateFileå¤±è´¥,GetLastErrorå¼å¸¸ç æ¯&nbsp;0x00000002ï¼è½¬æ¢Win32Exceptionæè¿°ï¼âç³»ç»æ¾ä¸å°æå®çæä»¶âãé¬¼ç¥éæ¯å¥é®é¢ãããç»åä¸ä¸æï¼æç¥éåæ¥ç£çIsOfflineç¶ææ¯æ æ³æ¥æ¾å·ãä¹æ æ³åå»ºååºè®¿é®å¥æ</p>
<p>&nbsp;</p>
<p><strong>åå°.NETç£çç®¡çæ¹æ¡éåï¼</strong></p>
<p>æ²¡æå¤æçCç«¯ç¯å¢çè¯ãä»è¿ç»´ç­åºå®åºæ¯ï¼ç£çç®¡çæä½å¯ä»¥ä½¿ç¨Powersshell</p>
<p>å¯¹ç£çæä½è¦æ±ç¨³å®ãä½åæ³å¿«éå®ç°åè½ï¼è¾å°çç£çåè½è°ç¨ï¼æ¨èWMI</p>
<p>å¯¹ç£çæä½è¦æ±ç¨³å®ãæ§è½è¦æ±é«ï¼åäº§åçº§çå­å¨è½¯ä»¶ï¼æ¨èWIN32</p>
<p>&nbsp;</p>
<p>ç£çç¸å³çå¶å®æç« ï¼</p>
<p><a href="https://www.cnblogs.com/kybs0/p/18701464">Windows æ¬å°èæç£ç - åå®åææ¸2188 - åå®¢å­</a></p>
<a href="https://www.cnblogs.com/kybs0/p/18712317">Windows ç½ç»å­å¨ISCSIä»ç» - åå®åææ¸2188 - åå®¢å­</a><br>
<p><a href="https://www.cnblogs.com/kybs0/p/18766881">ç½ç»èæå­å¨ Iscsiå®ç°æ¹æ¡ - åå®åææ¸2188 - åå®¢å­</a></p>
</div>
<div id="MySignature" role="contentinfo">
    <div>ä½èï¼<a href="http://www.cnblogs.com/kybs0/" target="_blank">åå®åææ¸2188</a></div>
<div>åºå¤ï¼<a href="http://www.cnblogs.com/kybs0/" target="_blank">http://www.cnblogs.com/kybs0/</a></div>
<div>è®©å­¦ä¹ æä¸ºä¹ æ¯ï¼åè®¾æå¤©å°±æéå¤§æºéç­çä½ ï¼ä½ åå¤å¥½äºä¹</div>
<div>æ¬æçæå½ä½èååå®¢å­å±æï¼æ¬¢è¿è½¬è½½ï¼ä½æªç»ä½èåæå¿é¡»å¨æç« é¡µé¢ç»åºåæè¿æ¥ï¼å¦åä¿çè¿½ç©¶æ³å¾è´£ä»»çæå©ã </div>
</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.0006944444444444445" data-date-updated="2026-01-12 23:51">2026-01-12 23:50</span>&nbsp;
<a href="https://www.cnblogs.com/kybs0">åå®åææ¸2188</a>&nbsp;
éè¯»(<span id="post_view_count">3</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19473484);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19473484', targetLink: 'https://www.cnblogs.com/kybs0/p/19473484', title: '.NET ç£çç®¡ç-ææ¯æ¹æ¡éå' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ å¹¶åï¼å¹¶è¡ä¸å¼æ­¥ ]]></title>
    <link>https://www.cnblogs.com/kklldog/p/19474533</link>
    <guid>7bbf19a360ac9d73f48557c00d34a6b4</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/kklldog/p/19474533" title="åå¸äº 2026-01-12 23:33">
    <span role="heading" aria-level="2">å¹¶åï¼å¹¶è¡ä¸å¼æ­¥</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<p>å¨æä¸ä¸ç¯é¢ä¸ºãä¸ºä»ä¹å¼æ­¥å¨IOæä½ä¸æææä¹ãçæç« åå¸åï¼æ¶å°äºå¾å¤åå­¦çåé¦ä¸æ¢è®¨ãå¨æ·±å¥äº¤æµåï¼æåç°ä¸ä¸ªæ®éçå°æç¹æµ®ç°åºæ¥ï¼å¶æ ¹æºå¨äºæ··æ·äºâå¹¶åâãâå¹¶è¡âä¸âå¼æ­¥âï¼ç¹å«æ¯ä¸æè¯å°å°å¼æ­¥ç­åäºå©ç¨å¤æ ¸CPUè¿è¡å¹¶è¡å¤çã</p>
<p>ä¸ºäºå½»åºæ¾æ¸è¿äºåºç¡ä½è³å³éè¦çæ¦å¿µï¼æä»¬æ·±å¥åæçè®ºååå¹¶ä¸åæ¶æå¼æä»¬æ¥å¸¸ä½¿ç¨çç°ä»£æ¡æ¶ï¼å¦.NETï¼ä¸­çå·ä½å®ç°ï¼è¿å¾å¾ä¼è¯¯å¯¼ï¼ï¼ä»¥è¾¨æå¹¶åï¼Concurrencyï¼ã<strong>å¹¶è¡ï¼parallelï¼åå¼æ­¥ï¼Asynchronousï¼</strong>è¿ä¸ä¸ªæ ¸å¿æ¦å¿µã</p>
<h2 id="æ ¸å¿æ¦å¿µè§£æ">æ ¸å¿æ¦å¿µè§£æ</h2>
<h3 id="ä»ä¹æ¯å¹¶åconcurrency">ä»ä¹æ¯å¹¶åï¼Concurrencyï¼ï¼</h3>
<p><img src="https://static.xbaby.xyz/blog/concurrency.jpg" alt="" loading="lazy"></p>
<ul>
<li>
<p>å®ä¹ï¼ å¹¶åæ¯æä¸ä¸ªç³»ç»æè½åå¨ä¸æ®µæ¶é´åå¤çå¤ä¸ªä»»å¡ãè¿äºä»»å¡çæ§è¡å¨å®è§ä¸æ¯éå çï¼ä½å¨å¾®è§ä¸æ¯éè¿ä»»å¡çäº¤æ¿æ§è¡å®ç°çã</p>
</li>
<li>
<p>ç²¾é«ï¼ Goè¯­è¨ä¹ç¶ Rob Pike å¯¹æ­¤æéå¸¸ç²¾è¾çè®ºè¿°ï¼âConcurrency is about dealing with lots of things at once.âï¼å¹¶åæ¯å³äºå¤çå¤ä»¶äºæçè½åï¼ãè¿éçå³é®è¯æ¯âdealing withâï¼å¤çï¼ï¼å®å¼ºè°çæ¯ä¸ç§ç¨åºç»æï¼ä½¿å¶è½å¤åºå¯¹åç®¡çå¤ä¸ªä»»å¡æµã</p>
</li>
<li>
<p>ä¸¾ä¾è¯´æï¼ ä¸ä¸ªé¤åçªç¶æ¥äºä¸ä¸ªå®¢äººï¼ä½é¤ååªæä¸ä¸ªæå¡åãä»æå¡åçè§åº¦æ¥çï¼ä»éè¦åæ¶æå¡è¿äºå®¢äººãå½ç¶è¿æ¯å®è§ä¸çåæ¶ï¼å ä¸ºæå¡åæ§è¡äºä»¶çéåº¦æ¯å¨æ¯å¤ªæ¢äºã</p>
</li>
</ul>
<h3 id="ä»ä¹æ¯å¹¶è¡parallel">ä»ä¹æ¯å¹¶è¡ï¼parallelï¼ï¼</h3>
<p><img src="https://static.xbaby.xyz/blog/%E5%B9%B6%E8%A1%8C.jpg" alt="" loading="lazy"></p>
<ul>
<li>
<p>å®ä¹ï¼ å¹¶è¡æ¯æç³»ç»è½å¤å¨åä¸ç©çæ¶å»çæ­£å°åæ¶æ§è¡å¤ä¸ªä»»å¡ã</p>
</li>
<li>
<p>åæï¼ å¹¶è¡å¿é¡»ä¾èµäºå¤æ ¸CPUãå¨å¤æ ¸å¤çå¨ä¸ï¼æ¯ä¸ªæ ¸å¿å¯ä»¥å¨å®å¨ç¸åçæ¶å»ç¬ç«å°æ§è¡ä¸ä¸ªä¸åçä»»å¡æä»¤ï¼å®ç°ç©çæä¹ä¸çâåæ¶âã</p>
</li>
<li>
<p>ç²¾é«ï¼ åæ ·å¼ç¨ Rob Pike çè®ºè¿°è¿è¡å¯¹æ¯ï¼âparallel is about doing lots of things at once.âï¼å¹¶è¡æ¯å³äºå®æå¤ä»¶äºæçè½åï¼ãè¿éçå³é®è¯æ¯âdoingâï¼å®æï¼ï¼å¼ºè°çæ¯ç©çä¸çåæ¶æ§è¡ï¼æ¯çæ­£æä¹ä¸çâä¸èµ·åâã</p>
</li>
<li>
<p>ä¸¾ä¾ï¼ è¿æ¯é¤åçä¾å­ï¼ä¸ä¸ªé¤åçªç¶æ¥äºä¸ä¸ªå®¢äººï¼é¤åè¿æ¬¡æ3ä¸ªæå¡åï¼æ¯ä¸ªæå¡åæ­£å¥½æå¡ä¸ä½å®¢äººãè¿å°±æ¯å¹¶è¡ã</p>
</li>
</ul>
<h3 id="ä»ä¹æ¯å¼æ­¥asynchronous">ä»ä¹æ¯å¼æ­¥ï¼Asynchronousï¼ï¼</h3>
<p><img src="https://static.xbaby.xyz/blog/async.jpg" alt="" loading="lazy"></p>
<ul>
<li>
<p>å®ä¹ï¼ å¼æ­¥æ¯ä¸ç§ç¼ç¨æ¨¡åææ¨¡å¼ï¼å¶æ ¸å¿ææ³æ¯éé»å¡ï¼Non-blockingï¼ãå®æè¿°çæ¯ä¸ç§è°ç¨è¡ä¸ºï¼å°¤å¶å¨å¤çèæ¶çI/Oæä½æ¶ï¼å¦ç½ç»è¯·æ±ãæ°æ®åºæ¥è¯¢ãæä»¶è¯»åï¼æ¾å¾è³å³éè¦ã</p>
</li>
<li>
<p>æºå¶ï¼ å½ä¸ä¸ªçº¿ç¨åèµ·ä¸ä¸ªå¼æ­¥I/Oæä½æ¶ï¼ä¾å¦ï¼å¨.NETä¸­è°ç¨ await client.GetStringAsync(...)ï¼ï¼å®å¹¶ä¸ä¼åå°é»å¡ç­å¾ãå®éåççè¿ç¨æ¯ï¼</p>
</li>
</ul>
<ol>
<li>è¯¥çº¿ç¨åæä½ç³»ç»ååºI/Oè¯·æ±ï¼ç¶åç«å³è¿åã</li>
<li>è¿ä¸ªå®è´µççº¿ç¨è¢«éæ¾åçº¿ç¨æ± ï¼å¯ä»¥ç«å³å»å¤çå¶ä»çå·¥ä½ï¼æ¯å¦ååºå¦ä¸ä¸ªç¨æ·çè¯·æ±ãCPUå®å¨æ²¡æè¢«é²ç½®ã</li>
<li>I/Oæä½ç±ç¡¬ä»¶ï¼å¦ç½å¡ãç£çæ§å¶å¨ï¼ç¬ç«å®æã</li>
<li>å½æä½å®æåï¼ç¡¬ä»¶ä¼åCPUåéä¸ä¸ªä¸­æ­ä¿¡å·ã</li>
<li>æä½ç³»ç»æè·è¿ä¸ªä¸­æ­ï¼å¹¶å°ä¸ä¸ªå®æäºä»¶æå¥éåã</li>
<li>çº¿ç¨æ± ä¸­çæä¸ªå¯ç¨çº¿ç¨ä¼ååºè¿ä¸ªäºä»¶ï¼å¹¶ä»ä¹å await çå°æ¹ç»§ç»­æ§è¡åç»­ä»£ç ã</li>
</ol>
<ul>
<li>
<p>ç®çï¼ å¼æ­¥çä¸»è¦ç®æ æ¯é¿åå¨ç­å¾I/Oå¯éåæä½æ¶æµªè´¹æè´µççº¿ç¨èµæºï¼ä»èç¨å°éççº¿ç¨å®ç°æé«çç³»ç»ååéåå¯ä¼¸ç¼©æ§ï¼ä¾å¦ï¼å¤çæåä¸ä¸çå¹¶åç½ç»è¿æ¥ï¼ãå®å³æ³¨çæ¯è°ç¨æ¹ççº¿ç¨æ¯å¦è¢«é»å¡ï¼èéä»»å¡æ¯å¦å¨å¤æ ¸ä¸åæ¶è¿è¡ã</p>
</li>
<li>
<p>è¯¯åºæ¾æ¸ï¼ âAsynchronous is not Concurrency.âï¼å¼æ­¥ä¸æ¯å¹¶åï¼ãè¿æ¯ä¸ä¸ªæå¶éè¦çåºåãå¼æ­¥æ¯ä¸ç§åè®¸ä»£ç ä»¥éçº¿æ§ï¼å¤ä»»å¡è§åº¦ï¼é¡ºåºæ­£ç¡®æ§è¡çå±æ§ï¼å®è½å¤ç¨æ¥å®ç°å¹¶åï¼ä½å¶æ¬èº«å¹¶éå¹¶åãå¼æ­¥å¯ä»¥å¨åçº¿ç¨ä¸å®ç°ï¼ä¸ä¸ªçº¿ç¨åèµ·è¯·æ±åå»åå«çäºï¼ï¼èå¹¶è¡åå¿é¡»æ¯å¤ä¸ªçº¿ç¨å¨å¤ä¸ªCPUæ ¸å¿ä¸åæ¶æ§è¡ã</p>
</li>
<li>
<p>ä¸¾ä¾ï¼ è¿æ¯é¤åçä¾å­ï¼ä¸ä¸ªé¤ååæ¶æ¥äºä¸ä¸ªå®¢äººï¼ä¸ä¸ªæå¡åæ¯äººä¸ä¸ªå®¢äººãæå¡åå¨ä¸å®ååæä¸¤ä¸ªéæ©ï¼</p>
</li>
</ul>
<ol>
<li>åæ­¥ï¼å¨åå¨é¨å£å»ç­ï¼ç´å°åºé¤åéå°å®¢äººæ¡ä¸ã</li>
<li>å¼æ­¥ï¼ä¸ååé©¬ä¸å»æ¥å¾å¶ä»å®¢äººæèå¤çå¶ä»äºæï¼ç­åå¨å¯¹è®²æºééç¥èç§å¥½äºæå»åé¤éé¤ã</li>
</ol>
<p><em>ï¼ï¼ï¼è¿éè¯·å¤§å®¶æ³¨æ ï¼ï¼ï¼ï¼</em></p>
<blockquote>
<p>å¼æ­¥æ¨¡åæä»¬å¼ºè°çæ¯è¿ä¸ªæå¡åè¢«éæ¾åºæ¥äºï¼ä»æ´å çµæ´»çè°åº¦ï¼ä»å¯ä»¥åæ´å¤çäºæ¥æé«é¤åçè¿è¡æçãè³äºåå¨åèè¿ä»¶äºæ¯ä¸ä¸ªå¨å¸æ¥åï¼è¿æ¯åä¸ªå¨å¸æ¥åé£æ¯å¦ä½æ´å¿«çåèçé®é¢ãè¿è·å¼æ­¥è¿æ¯åæ­¥æ²¡æå³ç³»ãåæ­¥æ¨¡å¼ä¸åèè¿ä»¶äºä¹å¯ä»¥è¯·åä¸ªå¨å¸æ¥åèå å¿«åºé¤çéåº¦ã</p>
</blockquote>
<h2 id="ä¸èçå³ç³»ä¸åºå«">ä¸èçå³ç³»ä¸åºå«</h2>
<p>ä¸ºäºæ´ç´è§å°çè§£å®ä»¬ï¼æä»¬å¯ä»¥éè¿ä¸ä¸ªè¡¨æ ¼æ¥å¯¹æ¯ï¼</p>
<table>
<thead>
<tr>
<th style="text-align: left">ç»´åº¦</th>
<th style="text-align: left">å¹¶å (Concurrency)</th>
<th style="text-align: left">å¹¶è¡ (parallel)</th>
<th style="text-align: left">å¼æ­¥ (Asynchronous)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left"><strong>æ ¸å¿ææ³</strong></td>
<td style="text-align: left">äº¤æ¿æ§è¡ï¼é»è¾ä¸åæ¶ï¼</td>
<td style="text-align: left">åæ¶æ§è¡ï¼ç©çä¸åæ¶ï¼</td>
<td style="text-align: left">éé»å¡ä¸åè°/ç»­å»¶</td>
</tr>
<tr>
<td style="text-align: left"><strong>CPUè¦æ±</strong></td>
<td style="text-align: left">åæ ¸å³å¯</td>
<td style="text-align: left">å¿é¡»å¤æ ¸</td>
<td style="text-align: left">ä¸æ ¸å¿æ°æ ç´æ¥å³ç³»</td>
</tr>
<tr>
<td style="text-align: left"><strong>å¤çæ¹å¼</strong></td>
<td style="text-align: left">OSè°åº¦å¨æ¶é´åç</td>
<td style="text-align: left">å¤æ ¸ç©çæ§è¡</td>
<td style="text-align: left">åèµ·I/Oåéæ¾çº¿ç¨</td>
</tr>
<tr>
<td style="text-align: left"><strong>è§£å³é®é¢</strong></td>
<td style="text-align: left">åºå¯¹é»è¾ä¸éè¦åæ¶å¤çå¤ä»»å¡çåºæ¯</td>
<td style="text-align: left">æåè®¡ç®å¯éåä»»å¡çæ§è¡æç</td>
<td style="text-align: left">é¿åI/Oå¯éåä»»å¡é»å¡ï¼æåç³»ç»ååé</td>
</tr>
</tbody>
</table>
<h2 id="æ»ç»">æ»ç»</h2>
<p>æ»èè¨ä¹ï¼å¹¶åãå¹¶è¡åå¼æ­¥æ¯ä»ä¸åç»´åº¦æè¿°ä»»å¡æ§è¡æ¹å¼çæ¦å¿µãå¹¶åæ¯ä¸ç§ç¨åºè®¾è®¡ç»æï¼ä½¿å¶è½å¤é»è¾ä¸å¤çå¤ä¸ªä»»å¡ï¼å¹¶è¡æ¯å©ç¨ç¡¬ä»¶ï¼å¤æ ¸CPUï¼å¨ç©çä¸åæ¶æ§è¡å¤ä¸ªä»»å¡çè®¡ç®è½åï¼èå¼æ­¥æ¯ä¸ç§ç¼ç¨èå¼ï¼éè¿éé»å¡IOè°ç¨æ¥æè´å°æé«ç³»ç»èµæºçå©ç¨çã</p>
<h2 id="å³æ³¨æçå¬ä¼å·ä¸èµ·ç©è½¬ææ¯">å³æ³¨æçå¬ä¼å·ä¸èµ·ç©è½¬ææ¯</h2>
<p><img src="https://static.xbaby.xyz/qrcode.jpg" alt="" loading="lazy"></p>

</div>
<div id="MySignature" role="contentinfo">
    <div id="AllanboltSignature">        
<p id="PSignature" style="border-top: #e0e0e0 1px dashed; border-right: #e0e0e0 1px dashed; border-bottom: #e0e0e0 1px dashed; border-left: #e0e0e0 1px dashed; padding-top: 10px; padding-right: 10px; padding-bottom: 10px; padding-left: 10px; font-family: å¾®è½¯éé»; font-size: 11px">       
QQç¾¤ï¼1022985150 VXï¼kklldog ä¸èµ·æ¢è®¨å­¦ä¹ .NETææ¯
<br>
ä½èï¼<a href="http://www.cnblogs.com/kklldog" target="_blank">Agile.Zhou(kklldog)</a>            
<br> 
åºå¤ï¼<a href="http://www.cnblogs.com/kklldog/" target="_blank">http://www.cnblogs.com/kklldog/</a>
<br>æ¬æçæå½ä½èååå®¢å­å±æï¼æ¬¢è¿è½¬è½½ï¼ä½æªç»ä½èåæå¿é¡»ä¿çæ­¤æ®µå£°æï¼ä¸å¨æç« é¡µé¢ææ¾ä½ç½®ç»åºåæè¿æ¥ï¼å¦åä¿çè¿½ç©¶æ³å¾è´£ä»»çæå©ã
 </p>  
</div>
</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-01-12 23:33">2026-01-12 23:33</span>&nbsp;
<a href="https://www.cnblogs.com/kklldog">Agile.Zhou</a>&nbsp;
éè¯»(<span id="post_view_count">0</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19474533);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19474533', targetLink: 'https://www.cnblogs.com/kklldog/p/19474533', title: 'å¹¶åï¼å¹¶è¡ä¸å¼æ­¥' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ å´æ©è¾¾æ·±åº¦å­¦ä¹ è¯¾ç¨äºï¼èªç¶è¯­è¨å¤ç  ç¬¬ä¸å¨ï¼å¾ªç¯ç¥ç»ç½ç» ï¼å­ï¼é¿ç­æè®°å¿ LSTM ]]></title>
    <link>https://www.cnblogs.com/Goblinscholar/p/19474433</link>
    <guid>6ab25167f20ce9f74a70f8eb27ecc473</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/Goblinscholar/p/19474433" title="åå¸äº 2026-01-12 22:25">
    <span role="heading" aria-level="2">å´æ©è¾¾æ·±åº¦å­¦ä¹ è¯¾ç¨äºï¼èªç¶è¯­è¨å¤ç  ç¬¬ä¸å¨ï¼å¾ªç¯ç¥ç»ç½ç» ï¼å­ï¼é¿ç­æè®°å¿ LSTM</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<p>æ­¤åç±»ç¨äºè®°å½å´æ©è¾¾æ·±åº¦å­¦ä¹ è¯¾ç¨çå­¦ä¹ ç¬è®°ã<br>
è¯¾ç¨ç¸å³ä¿¡æ¯é¾æ¥å¦ä¸ï¼</p>
<ol>
<li>åè¯¾ç¨è§é¢é¾æ¥ï¼<a href="https://www.bilibili.com/video/BV1FT4y1E74V?buvid=XU762317353676D786954061C192FE625463B&amp;from_spmid=playlist.playlist-detail.0.0&amp;is_story_h5=false&amp;mid=zqernykrmpf7XfIorMR%2FnA%3D%3D&amp;plat_id=116&amp;share_from=ugc&amp;share_medium=android&amp;share_plat=android&amp;share_session_id=ce0bc526-db69-428a-962e-c65ed8c267bc&amp;share_source=COPY&amp;share_tag=s_i&amp;spmid=united.player-video-detail.0.0&amp;timestamp=1713085655&amp;unique_k=DfBgvFW&amp;up_id=8654113&amp;vd_source=e035e9878d32f414b4354b839a4c31a4" target="_blank" rel="noopener nofollow">[åè¯­å­å¹]å´æ©è¾¾æ·±åº¦å­¦ä¹ deeplearning.ai</a></li>
<li>githubè¯¾ç¨èµæï¼å«è¯¾ä»¶ä¸ç¬è®°:<a href="https://github.com/robbertliu/deeplearning.ai-andrewNG" target="_blank" rel="noopener nofollow">å´æ©è¾¾æ·±åº¦å­¦ä¹ æå­¦èµæ</a></li>
<li>è¯¾ç¨éå¥ç»ä¹ ï¼ä¸­è±ï¼ä¸ç­æ¡ï¼<a href="https://blog.csdn.net/u013733326/article/details/79827273" target="_blank" rel="noopener nofollow">å´æ©è¾¾æ·±åº¦å­¦ä¹ è¯¾åä¹ é¢ä¸ç­æ¡</a></li>
</ol>
<p>æ¬ç¯ä¸ºç¬¬äºè¯¾çç¬¬ä¸å¨åå®¹ï¼<a href="https://www.bilibili.com/video/BV1FT4y1E74V/?spm_id_from=333.788.videopod.episodes&amp;vd_source=e035e9878d32f414b4354b839a4c31a4&amp;p=160" target="_blank" rel="noopener nofollow">1.10</a>çåå®¹ä»¥åä¸äºç¸å³åºç¡çè¡¥åã</p>
<hr>
<p>æ¬å¨ä¸ºç¬¬äºè¯¾çç¬¬ä¸å¨åå®¹ï¼ä¸ CV ç¸å¯¹åºçï¼è¿ä¸è¯¾ææåå®¹çä¸­å¿åªæä¸ä¸ªï¼<strong>èªç¶è¯­è¨å¤çï¼Natural Language Processingï¼NLPï¼</strong>ã<br>
åºç¨å¨æ·±åº¦å­¦ä¹ éï¼å®æ¯ä¸é¨ç¨æ¥è¿è¡<strong>ææ¬ä¸åºåä¿¡æ¯å»ºæ¨¡</strong>çæ¨¡ååææ¯ï¼æ¬è´¨ä¸æ¯å¨å¨è¿æ¥ç½ç»ä¸ç»è®¡è¯­è¨æ¨¡ååºç¡ä¸çä¸æ¬¡âç»æåç¹åâï¼ä¹æ¯äººå·¥æºè½ä¸­<strong>æè´´è¿äººç±»æç»´è¡¨è¾¾æ¹å¼</strong>çéè¦ç ç©¶æ¹åä¹ä¸ã<br>
<strong>è¿ä¸æ´èè¯¾åæ ·æ¶åå¤§ééè¦åå¤æ¶åçåå®¹ï¼æ¨ªè·¨æºå¨å­¦ä¹ ãæ¦çç»è®¡ãçº¿æ§ä»£æ°ä»¥åè¯­è¨å­¦ç´è§ã</strong><br>
è¯­è¨ä¸åå¾åé£æ ·âç´è§å¯è§âï¼æ´å¤æ¯æ½è±¡ç¬¦å·ä¸ä¸ä¸æå³ç³»çç»åï¼å æ­¤<strong>çè§£é¨æ§åèæ´é«</strong>ã<br>
å æ­¤ï¼æåæ ·ä¼å°½éè¡¥è¶³å¿è¦çèæ¯ç¥è¯ï¼å°½å¯è½ç¨æ¯å»åå®ä¾éä½çè§£é¾åº¦ã<br>
æ¬ç¯çåå®¹å³äº<strong>é¿ç­æè®°å¿ LSTM</strong>ï¼å®å GRU ä¸æ ·ï¼æ¯æåç¼è§£ RNN çé¿è·ç¦»ä¾èµé®é¢ä¸æµè¡è³ä»çææ¯ã</p>
<h1 id="1-ä»ä¹æ¯-lstmlong-short-term-memory">1. ä»ä¹æ¯ LSTMï¼Long Short-Term Memoryï¼ï¼</h1>
<p>å¨ <a href="https://www.cnblogs.com/Goblinscholar/p/19463351" target="_blank">GRU</a> ä¸­ï¼æä»¬å·²ç»çå°ï¼<strong>éè¿é¨æ§æºå¶å¯¹ä¿¡æ¯æµè¿è¡éæ©æ§æ§å¶ï¼ç¡®å®å¯ä»¥æ¾èç¼è§£ä¼ ç» RNN çé¿è·ç¦»ä¾èµé®é¢</strong>ã<br>
æ è®ºæ¯æ´æ°é¨å¯¹åå²ä¿¡æ¯çä¿çï¼è¿æ¯éç½®é¨å¯¹å½åè¾å¥çå¼ºè°ï¼æ¬è´¨ä¸é½æ¯å¨åç­åä¸ä¸ªé®é¢ï¼<strong>åªäºä¿¡æ¯å¼å¾è¢«ç»§ç»­ä¼ éï¼åªäºå¯ä»¥è¢«éå¿ã</strong></p>
<p>ç¶èï¼ä»æ´é¿æ¶é´è·¨åº¦çå»ºæ¨¡éæ±æ¥çï¼GRU <strong>ä»ç¶å­å¨ä¸ä¸ªç»æä¸çå±é</strong>ï¼å®ä¾ç¶åªæ<strong>åä¸çéèç¶æ</strong>æ¥åæ¶æ¿æâç­æè®¡ç®ç»æâåâé¿æè®°å¿è½½ä½âè¿ä¸¤ç§è§è²ã<br>
è¿æå³çï¼<strong>å³ä¾¿å¼å¥äºé¨æ§æºå¶ï¼ä¸åæ¶é´å°ºåº¦çä¿¡æ¯ä»ç¶è¢«è¿«æ··åå¨åä¸æ¡ç¶æééä¸­ä¼ é</strong>ï¼å¨æé¿åºåæç²¾ç»æ¶åºæ§å¶çåºæ¯ä¸ï¼è¿ç§è¦åä»å¯è½éå¶æ¨¡åçè¡¨è¾¾è½åã</p>
<p>è<strong>LSTM</strong>ä¾¿è½åºå¯¹è¿ç±»é®é¢ï¼æ©å¨ <strong>1997</strong> å¹´ï¼Hochreiter å Schmidhuber å¨è®ºæï¼<a href="https://www.bioinf.jku.at/publications/older/2604.pdf" target="_blank" rel="noopener nofollow">Long Short-Term Memory</a>ä¸­ï¼ä¾¿ä»çè®ºå±é¢ç³»ç»æ§å°åæäº RNN ä¸­æ¢¯åº¦æ¶å¤±çé®é¢ï¼å¹¶ç»åºäºä¸ç§<strong>ç»ææ§è§£å³æ¹æ¡</strong>ï¼éè¿æ¾å¼å¼å¥ä¸æ¡<strong>ä¸é¨ç¨äºé¿æä¿¡æ¯ä¼ éçè®°å¿ååï¼cell stateï¼</strong>ï¼å¹¶éåç²¾ç»è®¾è®¡çé¨æ§ç»æï¼ä½¿å¾å³é®ä¿¡æ¯å¯ä»¥å¨é¿æ¶é´è·¨åº¦åå ä¹ä¸åå¹²æ°å°ååä¼ æ­ã</p>
<p>è¿éè¦è¯´æä¸ç¹ï¼ä½ ä¼åç°ï¼ä»æ¶é´é¡ºåºä¸çï¼<strong>LSTM çæåºæ©äº GRU</strong>ã<br>
LSTM æ¯ææ©ä»ç»æå±é¢ç³»ç»æ§è§£å³ RNN é¿è·ç¦»ä¾èµé®é¢çé¨æ§å¾ªç¯ååã<br>
è<strong>å¨ä¸ä¸ç¯æä»¬è¯´ GRU å¯ä»¥çä½ LSTM çä¸ç§ç®åå½¢å¼</strong>ï¼æ­£æ¯å ä¸ºå®å¨ LSTM çåºç¡ä¸åå¹¶äºé¨åé¨æ§ç»æï¼åæ¶äºæ¾å¼çè®°å¿ååï¼ç¨æ´ç´§åçå½¢å¼å®ç°äºç¸ä¼¼çå»ºæ¨¡ç®æ ã</p>
<p>ä¹æ­£å ä¸ºè¿ç§ç®åï¼GRU å¨åæ°æ°éãè®¡ç®å¼éä»¥åå·¥ç¨å®ç°å¤æåº¦ä¸é½æ´ä¸ºåå¥½ã<br>
å æ­¤ï¼å¨è®¸å¤å®éä»»å¡ä¸­ï¼å½åºåé¿åº¦å¹¶æªæç«¯æé¿ï¼æå¯¹é¿æè®°å¿çç²¾ç»æ§å¶è¦æ±ä¸é«æ¶ï¼<strong>GRU å¾å¾è½å¤ä»¥æ´ä½çææ¬è·å¾ä¸ LSTM æ¥è¿çæ§è½</strong>ãè¿ä¹æ¯ä¸ºä»ä¹ï¼å°½ç®¡ LSTM å¨çè®ºä¸å·å¤æ´å¼ºçè¡¨è¾¾ä¸è®°å¿è½åï¼<strong>ç»ææ´ç®åç GRU ä»ç¶å¨å¤§é NLP ä¸æ¶åºå»ºæ¨¡åºæ¯ä¸­è¢«å¹¿æ³éç¨</strong>ã</p>
<p>åæ ·ç®åè¿äºè¿åå²ï¼ä¸é¢æä»¬æ¥å±å¼ä»ç»ã</p>
<h2 id="11-gru-ççè®ºå±é">1.1 GRU ççè®ºå±é</h2>
<p>å¨ GRU ä¸­ï¼æä»¬å·²ç»çå°ï¼éè¿å¼å¥æ´æ°é¨åéç½®é¨ï¼æ¨¡åä¸åè¢«å¨å°âè®°ä½ä¸åâï¼èæ¯å­¦ä¼äº<strong>éæ©æ§ä¿çä¸éæ©æ§ä½¿ç¨åå²ä¿¡æ¯</strong>ã<br>
è¿ä½¿å¾ RNN å¨é¿åºåå»ºæ¨¡ä¸­çè¡¨ç°å¾å°äºæ¾èæ¹åã</p>
<p>ä½å¦ææä»¬ç»§ç»­è¿½é®ä¸ä¸ªé®é¢ï¼<strong>è¿äºè¢«âç²¾å¿ç­éâçåå²ä¿¡æ¯ï¼å°åºè¢«å­æ¾å¨åªéï¼</strong><br>
ç­æ¡æ¯ï¼<strong>ä»ç¶å¨åä¸ä¸ªéèç¶æéã</strong></p>
<p>ä¹å°±æ¯è¯´ï¼å¨ GRU ä¸­ï¼éèç¶ææ¢æ¿æ<strong>å½åè®¡ç®ç»æ</strong>ï¼åæ¿æ<strong>é¿æè®°å¿è½½ä½</strong>ã<br>
è¿æ ·åçç»æå°±æ¯æä»¬ååæå°çï¼ææä¿¡æ¯ï¼æ è®ºæ¶é´å°ºåº¦é¿ç­ï¼æç»é½è¦âæ¤âå¨åä¸ä¸ªåéä¸­ä¼ éï¼å¯è½éå¶æ¨¡åçè¡¨è¾¾è½åã</p>
<p>å¨å¤æ°ä»»å¡ä¸­ï¼è¿å·²ç»è¶³å¤ææï¼ä½å¨<strong>æé¿åºåãç²¾ç»æ¶åºæ§å¶æé¿æè¯­ä¹ä¸è´æ§è¦æ±å¾é«</strong>çåºæ¯ä¸ï¼è¿ç§âæ··åå­å¨âä»ç¶å¯è½æä¸ºç¶é¢ã<br>
<img src="https://img2024.cnblogs.com/blog/3708248/202601/3708248-20260112222201121-1094822425.png" alt="image.png" loading="lazy"></p>
<h2 id="12-lstm-çè®°å¿ç»è">1.2 LSTM çè®°å¿ç»è</h2>
<p>å®éä¸ï¼LSTM çè®¾è®¡å°±è½å¾å¥½çè§£å³ååçæ··åå­å¨é®é¢ã<br>
å®å¼å¥äºä¸ä¸ª<strong>ç»æå±é¢çæ¹å</strong>ï¼<strong>ä¸åè®©åä¸ä¸ªç¶æåæ¶è´è´£âé¿æè®°å¿âåâç­æè®¡ç®âã</strong></p>
<p>ä¸ºæ­¤ï¼LSTM æç¡®åºåäºä¸¤æ¡ä¿¡æ¯ééï¼</p>
<ul>
<li><strong>ç»èç¶æï¼cell stateï¼ <span class="math inline">\(c^{}\)</span></strong>  â ä¸é¨è´è´£<strong>é¿æä¿¡æ¯çå­å¨ä¸ä¼ éã</strong></li>
<li><strong>éèç¶æï¼hidden stateï¼ <span class="math inline">\(a^{}\)</span></strong>  â è´è´£<strong>å½åæ¶å»çè¾åºä¸ç­æè®¡ç®ã</strong></li>
</ul>
<p>ä½ å¯ä»¥æå®çè§£ä¸ºï¼</p>
<blockquote>
<p>éèç¶ææ¯âå½åèå­éå¨æ³ä»ä¹âï¼<br>
ç»èç¶ææ¯âä¸æ¡å ä¹ä¸è¢«ææ°çé¿æå¤å¿å½âã</p>
</blockquote>
<p>è¿ä¹æ¯ LSTM åå­ä¸­ <strong>Long Short-Term</strong> çå«ä¹ï¼  <strong>é¿æä¿¡æ¯ï¼Long-Termï¼åç­æä¿¡æ¯ï¼Short-Termï¼å¨ç»æä¸è¢«æ¾å¼åºåäºã</strong><br>
<img src="https://img2024.cnblogs.com/blog/3708248/202601/3708248-20260112222133456-1134110847.png" alt="image.png" loading="lazy"><br>
æä¸ªæ¯æ¹æ¥æ»ç» GRU å LSTM çå·®å«ï¼GRUåæ¯å¨<strong>ä¸å¼ çº¸ä¸åå¤ä¿®æ¹åå®¹</strong>ï¼LSTMååæ¯<strong>åç¬åå¤äºä¸æ¬ç¬è®°æ¬</strong>ã</p>
<h2 id="13-lstm-çé¨æ§æºå¶">1.3 LSTM çé¨æ§æºå¶</h2>
<p>æ¢ç¶å¼å¥äºä¸é¨çè®°å¿ç»èæ¥ä½ä¸º LSTM ä¸­ç<strong>é¿æè®°å¿éé</strong>ï¼æ°çé®é¢èªç¶åºç°äºï¼è¿æ¡è®°å¿ï¼ä»ä¹æ¶åè¯¥ä¿çï¼ ä»ä¹æ¶åè¯¥æ´æ°ï¼ä»ä¹æ¶åè¯¥è¾åºç»å½åè®¡ç®ä½¿ç¨ï¼</p>
<p>ç­æ¡ä¾ç¶æ¯ï¼<strong>é¨æ§æºå¶</strong>ã<br>
ç®åæ¥è¯´ï¼LSTM éè¿ä¸éé¨æ¥ç²¾ç»æ§å¶é¿æè®°å¿ï¼</p>
<ol>
<li><strong>éå¿é¨ï¼Forget Gateï¼</strong>ï¼å³å®æ§è®°å¿ä¿çå¤å°ã</li>
<li><strong>è¾å¥é¨ï¼Input Gateï¼</strong>ï¼å³å®æ°ä¿¡æ¯åå¥å¤å°ã</li>
<li><strong>è¾åºé¨ï¼Output Gateï¼</strong>ï¼å³å®å½åæ¶å»å¯¹å¤æ´é²å¤å°è®°å¿ã</li>
</ol>
<p><img src="https://img2024.cnblogs.com/blog/3708248/202601/3708248-20260112222316186-1000139547.png" alt="image.png" loading="lazy"></p>
<p>ä¹æ­£æ¯å ä¸ºè¿äºé¨çå­å¨ï¼ <strong>cell state æè½å¤å¨æ¶é´ç»´åº¦ä¸ç¨³å®æµå¨ï¼èä¸è¢«é¢ç¹æ¹å</strong>ã<br>
æäº GRU çåºç¡åï¼æä»¬å°±ä¸ååç¬éä¸ªå±å¼æ¯éé¨çè¯­ä¹äºï¼å¨ä¸é¢çå®ç°é¨ååæ¥è¯¦ç»å±å¼å®ä»¬çä½ç¨é»è¾ã</p>
<h1 id="2-å¦ä½å®ç°-lstm">2. å¦ä½å®ç° LSTMï¼</h1>
<p>å¨ä¹åç GRU ä¸­ï¼æä»¬å·²ç»çå°ï¼<strong>é¨æ§çæ¬è´¨ä¸æ¯å¢å å¤æåº¦ï¼èæ¯ä¸ºâä¿¡æ¯æ¯å¦ç»§ç»­å­å¨âæä¾å¯å­¦ä¹ çéæ©æã</strong></p>
<p>LSTM å¨è¿ä¸ªææ³ä¸æ´è¿ä¸æ­¥ï¼å®ä¸åè¯å¾è®©<strong>åä¸ä¸ªç¶æ</strong>åæ¶æ¿æâé¿æè®°å¿âåâå½åè®¡ç®âï¼ èæ¯<strong>æ¾å¼å¼å¥äºä¸æ¡å ä¹çº¿æ§ä¼ æ­çé¿æè®°å¿ééââç»èç¶æ <span class="math inline">\(c^{\langle t \rangle}\)</span></strong>ï¼å¹¶éè¿éå¿é¨ï¼è¾å¥é¨åè¾åºé¨æ¥æ§å¶ç»èç¶æã<br>
äºè§£äºåºæ¬åçåï¼ç°å¨å°±æ¥ççï¼å¨ä¸ä¸ªæ¶é´æ­¥ <span class="math inline">\(t\)</span>ï¼ä¸ä¸ªæ å LSTM ååæ¯å¦ä½å®ç°çã<br>
å®éä¸ï¼å®åªæ¯æ¯ GRU å¤äºäºæ­¥éª¤ï¼å¨æäº GRU çåºç¡åï¼LSTM çå®ç°å¹¶ä¸é¾çè§£ï¼åæåºå®çååç»æå¾å¦ä¸ï¼<br>
<img src="https://img2024.cnblogs.com/blog/3708248/202601/3708248-20260112222130915-556405424.png" alt="image.png" loading="lazy"><br>
è¦å¼ºè°çè¿æ¯æä»¬ä»ç»çè®¡ç®é¡ºåºæ¯<strong>é»è¾ä¸çååé¡ºåº</strong>ï¼å®éä¸å¾å¤æ­¥éª¤é½æ¯å¯ä»¥åæ­¥è®¡ç®çã</p>
<h2 id="21-è®¡ç®éå¿é¨forget-gate">2.1 è®¡ç®éå¿é¨ï¼Forget Gateï¼</h2>
<p>LSTM çç¬¬ä¸æ­¥ï¼æ¯è®¡ç® <strong>éå¿é¨</strong> <span class="math inline">\(f^{\langle t \rangle}\)</span>ã</p>
<p>å®çä½ç¨å°±ç¸å½äº GRU çéç½®é¨ï¼<strong>å¯¹ä¸ä¸æ¶å»çç»èç¶æ <span class="math inline">\(c^{\langle t-1 \rangle}\)</span> è¿è¡âææ¯ä¾ä¿çâã</strong><br>
ä½è¦æ³¨æï¼è¿éæ¯â<strong>ç»èç¶æ</strong>â èä¸æ¯ â<strong>éèç¶æ</strong>âã<br>
è¿ç¨å¦ä¸ï¼<br>
<img src="https://img2024.cnblogs.com/blog/3708248/202601/3708248-20260112222131252-989637007.png" alt="image.png" loading="lazy"><br>
è®¡ç®å¬å¼è¿æ¯æ¯çº¿æ§ç»åï¼</p>
<p></p><div class="math display">\[f^{\langle t \rangle}  
= sigmoid\big( W_{xf} x^{\langle t \rangle} + W_{af} a^{\langle t-1 \rangle} + b_f \big)  
\]</div><p></p><p>éå¿é¨å¼çå«ä¹æ¯è¿æ ·çï¼</p>
<ul>
<li><span class="math inline">\(f^{\langle t \rangle}_i \approx 1\)</span>ï¼ç¬¬ <span class="math inline">\(i\)</span> ä¸ªè®°å¿ååå ä¹<strong>å®å¨ä¿ç</strong>ã</li>
<li><span class="math inline">\(f^{\langle t \rangle}_i \approx 0\)</span>ï¼ç¬¬ <span class="math inline">\(i\)</span> ä¸ªè®°å¿ååè¢«<strong>ä¸»å¨éå¿</strong>ã</li>
</ul>
<p>è¿éåºç°äºæ°çåå®¹éè¦è¯´æï¼<strong>ç»èç¶æ <span class="math inline">\(c^{\langle t \rangle}\)</span> ä¸éèç¶æ <span class="math inline">\(a^{\langle t \rangle}\)</span> å¨ç»´åº¦ä¸æ¯ä¸è´ç</strong>ã<br>
è¥éèç¶ææ¯ä¸ä¸ª <span class="math inline">\(d\)</span> ç»´åéï¼é£ä¹ç»èç¶æåæ ·åå« <span class="math inline">\(d\)</span> ä¸ª<strong>è®°å¿åå</strong>ã<br>
å æ­¤ï¼éå¿é¨ <span class="math inline">\(f^{\langle t \rangle}\)</span> çæ¯ä¸ä¸ªåé <span class="math inline">\(f_i^{\langle t \rangle}\)</span>ï¼å¹¶ä¸æ¯æ§å¶âä¸æ´æ®µè®°å¿âï¼èæ¯<strong>ç¬ç«æ§å¶ç¬¬ <span class="math inline">\(i\)</span> ä¸ªè®°å¿ååå¨æ¶é´ç»´åº¦ä¸çä¿çæ¯ä¾</strong>ã</p>
<p>åç»åä¸ä¸ GRU ï¼ä½ ä¼åç°ï¼è¿æ®µé»è¾å¨GRUä¸­ä»¥éç½®é¨çå½¢å¼å®æ´ä¿çäºã</p>
<h2 id="22-è®¡ç®è¾å¥é¨input-gate">2.2 è®¡ç®è¾å¥é¨ï¼Input Gateï¼</h2>
<p>LSTM çç¬¬äºæ­¥ï¼æ¯è®¡ç® <strong>è¾å¥é¨</strong> <span class="math inline">\(i^{\langle t \rangle}\)</span>ã</p>
<p>å®çä½ç¨æ¯ï¼<strong>å³å®å½åæ­¥çæçæ°ä¿¡æ¯æå¤å°å¯ä»¥åå¥ç»èç¶æ <span class="math inline">\(c^{\langle t \rangle}\)</span></strong>ã<br>
æ¢å¥è¯è¯´ï¼å®æ§å¶äºâæ°è®°å¿æ´æ°æ¯ä¾âï¼å¨åè½ä¸ç±»ä¼¼ GRU çæ´æ°é¨ï¼ä½å¨ LSTM ä¸­ï¼å®åªè´è´£ <strong>æ°ä¿¡æ¯åå¥</strong>ï¼èåå²ä¿¡æ¯ä¿çç±éå¿é¨æ§å¶ã</p>
<p>è¿ç¨å¦ä¸ï¼<br>
<img src="https://img2024.cnblogs.com/blog/3708248/202601/3708248-20260112222315717-85455316.png" alt="image.png" loading="lazy"><br>
å¬å¼è¡¨ç¤ºä¸ºï¼</p>
<p></p><div class="math display">\[i^{\langle t \rangle} = sigmoid\big( W_{xi} x^{\langle t \rangle} + W_{ai} a^{\langle t-1 \rangle} + b_i \big)  
\]</div><p></p><p>è¾å¥é¨å¼çè¯­ä¹åæ ·æ¸æ°ï¼</p>
<ul>
<li><span class="math inline">\(i_i^{\langle t \rangle} \approx 1\)</span>ï¼ç¬¬ <span class="math inline">\(i\)</span> ä¸ªè®°å¿ååå ä¹<strong>å¨é¨æ¥æ¶æ°ä¿¡æ¯</strong>ã</li>
<li><span class="math inline">\(i_i^{\langle t \rangle} \approx 0\)</span>ï¼ç¬¬ <span class="math inline">\(i\)</span> ä¸ªè®°å¿ååå ä¹<strong>ä¸åå¥æ°ä¿¡æ¯</strong>ã</li>
</ul>
<p>åæ ·å°ï¼è¾å¥é¨ <span class="math inline">\(i^{\langle t \rangle}\)</span> ä¸ç»èç¶æ <span class="math inline">\(c^{\langle t \rangle}\)</span> çç»´åº¦ä¸è´ï¼æ¯ä¸ªåéç¬ç«æ§å¶å¯¹åºè®°å¿ååçåå¥æ¯ä¾ã<br>
è¿æ ·åå¯ä»¥ä¿è¯ <strong>é¿æè®°å¿å¨æ¶é´ç»´åº¦ä¸æ¢ä¿çéè¦ä¿¡æ¯ï¼åæéæ´æ°æ°åå®¹</strong>ï¼å®ç°æ´ç²¾ç»çè®°å¿ç®¡çã</p>
<h2 id="23-è®¡ç®åéç»èç¶æcandidate-cell-state">2.3 è®¡ç®åéç»èç¶æï¼Candidate Cell Stateï¼</h2>
<p>è¿æ¯è¦åå¼ºè°ä¸ç¹ï¼è¿æ¯â<strong>åéç»èç¶æ</strong>âï¼ä¸æ¯â<strong>åééèç¶æ</strong>âãå°è¿ä¸æ­¥ï¼éèç¶æè¿æ²¡æåºåºã</p>
<p>å¨è®¡ç®å®è¾å¥é¨ <span class="math inline">\(i^{\langle t \rangle}\)</span> ä¹åï¼LSTM çä¸ä¸æ­¥æ¯çæ <strong>åéç»èç¶æ</strong> <span class="math inline">\(\tilde{c}^{\langle t \rangle}\)</span>ã<br>
å®çä½ç¨æ¯ï¼<strong>è¡¨ç¤ºå½åæ­¥çæ°ä¿¡æ¯åå®¹</strong>ï¼ç±å½åè¾å¥ <span class="math inline">\(x^{\langle t \rangle}\)</span> åä¸ä¸æ¶å»éèç¶æ <span class="math inline">\(a^{\langle t-1 \rangle}\)</span> å±åå³å®ï¼ä½å°æªåå¥ç»èç¶æ <span class="math inline">\(c^{\langle t \rangle}\)</span>ã<br>
æ¢å¥è¯è¯´ï¼åéç»èç¶æå°±æ¯ <strong>åå¤å¥½å¯ä»¥åå¥çâæ°è®°å¿â</strong>ã<br>
è®¡ç®è¿ç¨å¦ä¸ï¼<br>
<img src="https://img2024.cnblogs.com/blog/3708248/202601/3708248-20260112222130982-1988780214.png" alt="image.png" loading="lazy"></p>
<p>å¬å¼è¡¨ç¤ºä¸ºï¼</p>
<p></p><div class="math display">\[\tilde{c}^{\langle t \rangle} = \tanh\big( W_{xc} x^{\langle t \rangle} + W_{ac} a^{\langle t-1 \rangle} + b_c \big)  
\]</div><p></p><p>å°åä¸ä¸æ­¥ä½ å°±ä¼åç°ï¼åéç¶ææ¬èº«å¹¶ä¸ç´æ¥å½±åæç»è¾åºï¼å®åªæ¯è¡¨ç¤ºâæå¤å°æ°è®°å¿âï¼è<strong>è¾å¥é¨ <span class="math inline">\(i^{\langle t \rangle}\)</span></strong> æå³å®âåå¥å¤å°æ°è®°å¿âã<br>
è¿æ®µè®¾è®¡ä¸åäº GRUï¼<strong>LSTM å°âæ°ä¿¡æ¯çæâåâæ°ä¿¡æ¯åå¥âæç¡®åç¦»</strong>ï¼æ¹ä¾¿éè¿é¨æ§ç²¾ç»æ§å¶è®°å¿æ´æ°ã</p>
<h2 id="24-æ´æ°ç»èç¶æ">2.4 æ´æ°ç»èç¶æ</h2>
<p>ç°å¨æä»¬å·²ç»æäºè¿æ ·ä¸è¥¿ï¼</p>
<ul>
<li>ä¸ä¸æ¶å»çç»èç¶æ <span class="math inline">\(c^{\langle t-1 \rangle}\)</span>ï¼æ§é¿æè®°å¿ï¼</li>
<li>éå¿é¨ <span class="math inline">\(f^{\langle t \rangle}\)</span>ï¼ä¿çæ¯ä¾ï¼</li>
<li>è¾å¥é¨ <span class="math inline">\(i^{\langle t \rangle}\)</span> ä¸åéè®°å¿ <span class="math inline">\(\tilde{c}^{\langle t \rangle}\)</span>ï¼æ°ä¿¡æ¯ï¼<br>
LSTM ä¼ç¨ä¸é¢è¿ä¸ª<strong>æ ¸å¿å¬å¼</strong>æ¥æ´æ°é¿æè®°å¿ï¼</li>
</ul>
<p></p><div class="math display">\[c^{\langle t \rangle}  
= f^{\langle t \rangle} \odot c^{\langle t-1 \rangle}
+ i^{\langle t \rangle} \odot \tilde{c}^{\langle t \rangle}  
\]</div><p></p><p><img src="https://img2024.cnblogs.com/blog/3708248/202601/3708248-20260112222315839-1698415516.png" alt="image.png" loading="lazy"></p>
<p>è¿ä¸ªå¬å¼çæä¹ä¹éå¸¸ç´è§ï¼</p>
<ul>
<li>ç¬¬ä¸é¡¹ï¼<strong>ä¿çå¤å°æ§è®°å¿</strong>ã</li>
<li>ç¬¬äºé¡¹ï¼<strong>åå¥å¤å°æ°è®°å¿</strong>ã<br>
ä¹æ­£æ¯å ä¸ºè¿éå­å¨ä¸æ¡è¿ä¼¼âç´éâçè·¯å¾ï¼è®©æ¢¯åº¦å¯ä»¥ç´æ¥ä» <span class="math inline">\(c^{\langle t \rangle}\)</span> åä¼ å° <span class="math inline">\(c^{\langle t-1 \rangle}\)</span> ï¼ <strong>ç»èç¶ææè½å¨æ¶é´ç»´åº¦ä¸ç¨³å®ä¼ æ­ï¼æ¢¯åº¦ä¹ä¸å®¹æè¡°åã</strong></li>
</ul>
<h2 id="35-è®¡ç®è¾åºé¨output-gate">3.5 è®¡ç®è¾åºé¨ï¼Output Gateï¼</h2>
<p>éè¦ç¹å«å¼ºè°çæ¯ï¼  <strong>ç»èç¶æå¹¶ä¸ç´æ¥ä½ä¸ºæ¨¡åè¾åºã</strong><br>
å¨ä¹åå æ­¥å®æäºå¯¹ç»èç¶æçæ´æ°ï¼æä»¬å°è¿éæå¼å§è¿è¡<strong>ä¸æ¨¡åè¾åºç¸å³çéèç¶æè®¡ç®</strong>ã</p>
<p>å¨æ´æ°å®ç»èç¶æ <span class="math inline">\(c^{\langle t \rangle}\)</span> ä¹åï¼LSTM çä¸ä¸æ­¥æ¯è®¡ç® <strong>è¾åºé¨</strong> <span class="math inline">\(o^{\langle t \rangle}\)</span><br>
è¾åºé¨çä½ç¨æ¯ï¼<strong>æ§å¶ç»èç¶æä¸­çä¿¡æ¯æå¤å°è¢«âæ´é²âç»ä¸ä¸å±æä¸ä¸æ¶é´æ­¥ä½¿ç¨</strong>ã<br>
æ¢å¥è¯è¯´ï¼è¾åºé¨å³å®äºâé¿æè®°å¿ééä¸­çä¿¡æ¯å¦ä½å½±åå½åè®¡ç®âã</p>
<p>è®¡ç®è¿ç¨å·²ç»çäºå¾å¤éäºï¼<br>
<img src="https://img2024.cnblogs.com/blog/3708248/202601/3708248-20260112222316249-153285731.png" alt="image.png" loading="lazy"><br>
é¨çè®¡ç®é½æ¯ç¸åçï¼å¬å¼ä¸ºï¼</p>
<p></p><div class="math display">\[o^{\langle t \rangle} = sigmoid\big( W_{xo} x^{\langle t \rangle} + W_{ao} a^{\langle t-1 \rangle} + b_o \big)  
\]</div><p></p><ul>
<li>å½ <span class="math inline">\(o_i^{\langle t \rangle} \approx 1\)</span> æ¶ï¼ç¬¬ <span class="math inline">\(i\)</span> ä¸ªè®°å¿ååçé¿æä¿¡æ¯å ä¹<strong>å¨é¨æ´é²</strong>ç»éèç¶æã</li>
<li>å½ <span class="math inline">\(o_i^{\langle t \rangle} \approx 0\)</span> æ¶ï¼ç¬¬ <span class="math inline">\(i\)</span> ä¸ªè®°å¿ååçé¿æä¿¡æ¯å ä¹<strong>å®å¨å±è½</strong>ã</li>
</ul>
<h2 id="36-æ´æ°éèç¶æ">3.6 æ´æ°éèç¶æ</h2>
<p>æäºè¾åºé¨ <span class="math inline">\(o^{\langle t \rangle}\)</span> åæ´æ°åçç»èç¶æ <span class="math inline">\(c^{\langle t \rangle}\)</span> åï¼å°±å¯ä»¥çæå½åæ¶å»çéèç¶æ <span class="math inline">\(a^{\langle t \rangle}\)</span>ï¼è¿ä¹æ¯ LSTM çå®éè¾åºï¼ç¨äºä¼ éå°ä¸ä¸æ¶é´æ­¥æä¸ä¸å±ç½ç»ã<br>
<img src="https://img2024.cnblogs.com/blog/3708248/202601/3708248-20260112222131324-2047519086.png" alt="image.png" loading="lazy"></p>
<p>çæå¬å¼ä¸ºï¼</p>
<p></p><div class="math display">\[a^{\langle t \rangle} = o^{\langle t \rangle} \odot \tanh(c^{\langle t \rangle})  
\]</div><p></p><p>æç»ï¼è¾åºé¨ä¸ç»èç¶æãéèç¶æç»´åº¦ä¸è´ï¼<strong>æ¯ä¸ªåéç¬ç«æ§å¶å¯¹åºè®°å¿ååçè¾åº</strong>ï¼å®ç°å¯¹é¿æè®°å¿ç<strong>éæ©æ§è¯»å</strong>ã<br>
æåï¼çå°é¿æè®°å¿ï¼ä½ å¯è½ä¼åæ¬¡æ³å° GRU ä¸­ä¸ä»æé¿æè®°å¿ï¼è¿æç­æè®°å¿ï¼é£ LSTM çç­æè®°å¿è¢«éå«å¨åªä¸æ­¥äºï¼<br>
å®éä¸ï¼å¨ LSTM ä¸­ï¼ç­æè®°å¿ <strong>å°±æ¯å½åæ­¥çéèç¶æ <span class="math inline">\(a^{\langle t \rangle}\)</span></strong>ï¼å®ä¼ä¼ ç»ä¸ä¸æ¶é´æ­¥æä¸ä¸å±åä¸è®¡ç®ï¼èä¸å GRU é£æ ·æé¿æè®°å¿åç­æè®°å¿åå¹¶å¨åä¸ç¶æä¸­ã</p>
<p>è³æ­¤ï¼ä¸ä¸ª LSTM ååè®¡ç®å°±å®æäºã</p>
<h2 id="37-å°ç»lstm-çå®æ´è®¡ç®æµç¨">3.7 å°ç»ï¼LSTM çå®æ´è®¡ç®æµç¨</h2>
<p>å¨æ¶é´æ­¥ <span class="math inline">\(t\)</span>ï¼ä¸ä¸ªæ å LSTM ååçè®¡ç®é¡ºåºå¯ä»¥æ»ç»ä¸ºï¼</p>
<ol>
<li><strong>éå¿é¨</strong>ï¼å³å®æ§è®°å¿ä¿çå¤å°ã</li>
</ol>
<p></p><div class="math display">\[    f^{\langle t \rangle}  
    = \sigma(W_{xf} x^{\langle t \rangle} + W_{af} a^{\langle t-1 \rangle} + b_f)  
\]</div><p></p><ol start="2">
<li><strong>è¾å¥é¨</strong>ï¼å³å®æ°ä¿¡æ¯åå¥å¤å°ã</li>
</ol>
<p></p><div class="math display">\[    i^{\langle t \rangle}  
    = \sigma(W_{xi} x^{\langle t \rangle} + W_{ai} a^{\langle t-1 \rangle} + b_i)  
\]</div><p></p><ol start="3">
<li><strong>åéè®°å¿</strong>ï¼çææ°è®°å¿åå®¹ã</li>
</ol>
<p></p><div class="math display">\[    \tilde{c}^{\langle t \rangle}  
    = \tanh(W_{xc} x^{\langle t \rangle} + W_{ac} a^{\langle t-1 \rangle} + b_c)  
\]</div><p></p><ol start="4">
<li><strong>æ´æ°ç»èç¶æ</strong>ï¼é¿æè®°å¿èåã</li>
</ol>
<p></p><div class="math display">\[    c^{\langle t \rangle}  
    = f^{\langle t \rangle} \odot c^{\langle t-1 \rangle}
    

+ i^{\langle t \rangle} \odot \tilde{c}^{\langle t \rangle}  
\]</div><p></p><ol start="5">
<li><strong>è¾åºé¨ä¸éèç¶æ</strong>ï¼çæå½åè¾åºã</li>
</ol>
<p></p><div class="math display">\[o^{\langle t \rangle}  
= \sigma(W_{xo} x^{\langle t \rangle} + W_{ao} a^{\langle t-1 \rangle} + b_o)  
\]</div><p></p><p></p><div class="math display">\[ a^{\langle t \rangle}  
 = o^{\langle t \rangle} \odot \tanh(c^{\langle t \rangle})  
\]</div><p></p><p>è³æ­¤ï¼è¿ä¸¤ç¯æä»¬å®æäºå¯¹é¨æ§æºå¶çä¸äºç¸å³ææ¯çäºè§£ï¼ä½ ä¼åç°ï¼é¨æ§æºå¶å¹¶æ²¡æåæ°ç½ç»æ¬èº«çç»æï¼èæ¯éè¿ç½ç»å³ç³»åè®¡ç®é»è¾ä¸ºå¨è¿æ¥å±èµäºäºå¨æ°çè¯­ä¹ï¼<strong>å®ç°äºå¯¹è®°å¿çéæ©æ§ä¿çãæ´æ°ä¸è¾åº</strong>ã<br>
è¿ç§è®¾è®¡çå·§å¦ä¹å¤å¨äºï¼ç½ç»å¯ä»¥èªä¸»å³å®åªäºä¿¡æ¯å¼å¾é¿æè®°å¿ï¼åªäºä¿¡æ¯åªç¨äºå½åè®¡ç®ï¼ä½¿æ¢¯åº¦å¨æ¶é´ç»´åº¦ä¸ç¨³å®ä¼ æ­ï¼åæ¶è®©æ¨¡åè½å¤ç²¾ç»ç®¡çç­æä¸é¿æè®°å¿ï¼ä»èæ¾èæååºåæ°æ®å»ºæ¨¡çè½åã<br>
åæ¶ï¼ä¹ç»äºæä»¬å³äºåæ°çæ°ççµæï¼<strong>ä¸è¦ä¸å³å¢å å¤æç»æï¼èæ¯èµäºå·²ææºå¶æ°çè¯­ä¹ä¸æ§å¶è½åã</strong></p>
<h1 id="3-æ»ç»">3. æ»ç»</h1>
<table>
<thead>
<tr>
<th>æ¦å¿µ</th>
<th>åç</th>
<th>æ¯å»</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>LSTMï¼Long Short-Term Memoryï¼</strong></td>
<td>ä¸ºäºè§£å³ RNN/GRU å¨é¿åºåä¸­é¿æä¾èµçé®é¢ï¼å¼å¥<strong>æ¾å¼çè®°å¿ååï¼cell stateï¼</strong>ï¼å¹¶éå<strong>éå¿é¨ãè¾å¥é¨ãè¾åºé¨</strong>è¿è¡ç²¾ç»æ§å¶ï¼å®ç°é¿æä¿¡æ¯çç¨³å®ä¼ éã</td>
<td>éèç¶æåâå½åèå­éå¨æ³ä»ä¹âï¼ç»èç¶æåâä¸æ¬å ä¹ä¸è¢«ææ°çé¿æå¤å¿å½âã</td>
</tr>
<tr>
<td><strong>GRU çå±é</strong></td>
<td>GRU åªæåä¸éèç¶æï¼æ¢æ¿æç­æè®¡ç®ï¼åæ¿æé¿æè®°å¿ï¼ä½¿ä¸åæ¶é´å°ºåº¦çä¿¡æ¯æ··åå¨åä¸åéä¸­ï¼é¿åºåæç²¾ç»æ¶åºåºæ¯å¯è½åéã</td>
<td>GRU åæ¯å¨âä¸å¼ çº¸ä¸åå¤ä¿®æ¹åå®¹âï¼é¿æä¸ç­æä¿¡æ¯æ··åå­å¨ã</td>
</tr>
<tr>
<td><strong>ç»èç¶æï¼Cell State <span class="math inline">\(c^{\langle t \rangle}\)</span>ï¼</strong></td>
<td>ä¸é¨å­å¨é¿æä¿¡æ¯ï¼å¯è¿ä¼¼çº¿æ§ä¼ æ­ï¼æ¢¯åº¦ä¸ææ¶å¤±ãéè¿éå¿é¨æ§å¶ä¿çï¼è¾å¥é¨æ§å¶åå¥ã</td>
<td>âé¿æå¤å¿å½âï¼å¯ä»¥é¿æä¿å­å³é®ä¿¡æ¯ï¼ä¸è¢«é¢ç¹æ¹åã</td>
</tr>
<tr>
<td><strong>éèç¶æï¼Hidden State <span class="math inline">\(a^{\langle t \rangle}\)</span>ï¼</strong></td>
<td>è¡¨ç¤ºå½åæ¶å»çè¾åºåç­æè®¡ç®ç»æï¼ä¼ éå°ä¸ä¸æ¶é´æ­¥æä¸ä¸å±ã</td>
<td>âèå­éå½åæ­£å¨å¤ççåå®¹âã</td>
</tr>
<tr>
<td><strong>éå¿é¨ï¼Forget Gate <span class="math inline">\(f^{\langle t \rangle}\)</span>ï¼</strong></td>
<td>å³å®æ§è®°å¿ä¿çæ¯ä¾ï¼<span class="math inline">\(f^{\langle t \rangle} \odot c^{\langle t-1 \rangle}\)</span>ã</td>
<td>âå³å®æåªäºæ§ä¿¡æ¯ä¿çä¸æ¥ï¼åªäºä¸¢æâã</td>
</tr>
<tr>
<td><strong>è¾å¥é¨ï¼Input Gate <span class="math inline">\(i^{\langle t \rangle}\)</span>ï¼</strong></td>
<td>å³å®æ°ä¿¡æ¯åå¥æ¯ä¾ï¼<span class="math inline">\(i^{\langle t \rangle} \odot \tilde{c}^{\langle t \rangle}\)</span>ã</td>
<td>âå³å®æ°è®°å¿åå¥å¤å°å°é¿æå¤å¿å½âã</td>
</tr>
<tr>
<td><strong>åéç»èç¶æï¼<span class="math inline">\(\tilde{c}^{\langle t \rangle}\)</span>ï¼</strong></td>
<td>å½åæ­¥çæçæ°ä¿¡æ¯ï¼ç±å½åè¾å¥ä¸ä¸ä¸éèç¶æè®¡ç®ï¼ä½å°æªåå¥ç»èç¶æã</td>
<td>âåå¤å¥½å¯ä»¥åå¥çæ°è®°å¿âã</td>
</tr>
<tr>
<td><strong>æ´æ°ç»èç¶æï¼<span class="math inline">\(c^{\langle t \rangle}\)</span>ï¼</strong></td>
<td>ç»åéå¿é¨ä¸è¾å¥é¨æ´æ°é¿æè®°å¿ï¼<span class="math inline">\(c^{\langle t \rangle} = f^{\langle t \rangle} \odot c^{\langle t-1 \rangle} + i^{\langle t \rangle} \odot \tilde{c}^{\langle t \rangle}\)</span>ã</td>
<td>âæ§å¤å¿å½ä¿çå¤å° + æ°ä¿¡æ¯åå¥å¤å°âã</td>
</tr>
<tr>
<td><strong>è¾åºé¨ï¼Output Gate <span class="math inline">\(o^{\langle t \rangle}\)</span>ï¼</strong></td>
<td>å³å®ç»èç¶ææ´é²ç»éèç¶æçæ¯ä¾ï¼<span class="math inline">\(a^{\langle t \rangle} = o^{\langle t \rangle} \odot \tanh(c^{\langle t \rangle})\)</span>ã</td>
<td>âå³å®é¿æè®°å¿ä¸­åªäºåå®¹ç°å¨è¢«ä½¿ç¨âã</td>
</tr>
<tr>
<td><strong>ç­æè®°å¿</strong></td>
<td>LSTM çç­æè®°å¿å³å½åæ¶å»çéèç¶æ <span class="math inline">\(a^{\langle t \rangle}\)</span>ï¼ç¨äºè®¡ç®å½åè¾åºåä¸ä¸æ­¥ä¼ éã</td>
<td>âèå­éå½åæ³çä¸è¥¿âã</td>
</tr>
<tr>
<td><strong>é¿æè®°å¿</strong></td>
<td>LSTM çé¿æè®°å¿å³ç»èç¶æ <span class="math inline">\(c^{\langle t \rangle}\)</span>ï¼ç¨³å®ä¼ éå³é®åå²ä¿¡æ¯ï¼æ¢¯åº¦ä¸ææ¶å¤±ã</td>
<td>âé¿æå¤å¿å½âï¼å¯è·¨æ¶é´æ­¥ä¿å­ä¿¡æ¯ã</td>
</tr>
</tbody>
</table>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-01-12 22:26">2026-01-12 22:25</span>&nbsp;
<a href="https://www.cnblogs.com/Goblinscholar">å¥å¸æå­¦è</a>&nbsp;
éè¯»(<span id="post_view_count">12</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19474433);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19474433', targetLink: 'https://www.cnblogs.com/Goblinscholar/p/19474433', title: 'å´æ©è¾¾æ·±åº¦å­¦ä¹ è¯¾ç¨äºï¼èªç¶è¯­è¨å¤ç  ç¬¬ä¸å¨ï¼å¾ªç¯ç¥ç»ç½ç» ï¼å­ï¼é¿ç­æè®°å¿ LSTM' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ .NETå¨åã12æç¬¬2æ 2025-12-14ã ]]></title>
    <link>https://www.cnblogs.com/InCerry/p/-/dotnet_week_25_12_2</link>
    <guid>8cb3f6820902f8e7babbabe8e6de8366</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/InCerry/p/-/dotnet_week_25_12_2" title="åå¸äº 2026-01-12 21:32">
    <span role="heading" aria-level="2">.NETå¨åã12æç¬¬2æ 2025-12-14ã</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h2 id="å½åæç« ">å½åæç« </h2>
<h3 id="avalonia-å®ç°è·¨å¹³å°çè§é¢ä¼è®®windowslinuxä¿¡å">Avalonia å®ç°è·¨å¹³å°çè§é¢ä¼è®®ï¼WindowsãLinuxãä¿¡åï¼</h3>
<p><a href="https://www.cnblogs.com/shawshank/p/19305884" target="_blank">https://www.cnblogs.com/shawshank/p/19305884</a></p>
<p>Avalonia 11 çåå¸æ¾èæåäº .NET çæä¸­çè·¨å¹³å° UI å¼åè½åï¼ç¹å«æ¯æä¾äºé«è´¨éç Fluent 2 é£æ ¼æ§ä»¶ãæç« ä»ç»äºç¨ Avalonia æ¡æ¶å¼åçè·¨å¹³å°è§é¢ä¼è®®ç³»ç» Demoï¼æ¯æå¤ç§åè½ï¼å¦è§é¢ä¼è®®ãå±å¹åäº«åçµå­ç½æ¿ï¼å¹¶ä¿è¯è¯­é³è´¨éåå¨æè°èç¼ç ãå¼åç¯å¢åºäº Visual Studio 2022 ä¸.NET 8.0ï¼ä½¿ç¨ C#ç¼åãé¡¹ç®åä¸ºæå¡ç«¯ä¸å®¢æ·ç«¯ï¼æ¶åéè¦ç±»åææ¯ç»èï¼å±ç¤ºäºå®éåºç¨çå¯è¡æ§ä¸åæ¯ã</p>
<h3 id="avalonia-ui-çæ¼è¿é»è¾ä¸-qt-çææ·±åº¦å¯¹æ¯">Avalonia UI çæ¼è¿é»è¾ä¸ Qt çææ·±åº¦å¯¹æ¯</h3>
<p><a href="https://www.cnblogs.com/shanyou/p/19329439" target="_blank">https://www.cnblogs.com/shanyou/p/19329439</a></p>
<p>æ¬ææ¢è®¨è·¨å¹³å°å¾å½¢ç¨æ·çé¢çåå±ï¼éç¹åæ Mike James ä» Qt å° Avalonia çææ¯è½¬åãåå²ä¸ï¼å¼åèå¨é«æä¸æ§è½é´ä¸¾æ­¥ç»´è°ï¼Qt ä»¥å¶æ§è½å æ®ä¸»å¯¼å°ä½ãéç.NET çæçå´èµ·ï¼å¼åèæ¸´æä¸ä¸ªå· C#ä¼å¿çè·¨å¹³å°æ¡æ¶ãå¾®è°çææ¯ä½¿ Avalonia åºè¿èçï¼å±ç°åºä¸ Qt å¨æ¸²æãç¶æç®¡çç­æ¹é¢çæ¾èå·®å¼ãæç« è¿æ¢è®¨äº Avalonia çåä¸åè·¯å¾ï¼éè¿æ ¸å¿å¼æºä¸åä¸é­æºçç»åï¼ææ Qt å¨å¸åºçå°ä½ã</p>
<h3 id="wpf-æ°æææç¨ä¸---èµ°ä¸åºæ°ææå«æ¾æ">WPF æ°æææç¨ï¼ä¸ï¼ - èµ°ä¸åºæ°ææå«æ¾æ</h3>
<p><a href="https://www.cnblogs.com/leaf-7-scouts/p/19336808" target="_blank">https://www.cnblogs.com/leaf-7-scouts/p/19336808</a></p>
<p>æ¬æä»ç»äº WPF ä¸­ XAML çåºç¡è¯­æ³ä¸ç»ä»¶ï¼å¼ºè°äº XAML ä½ä¸ºå£°ææ§æ è®°è¯­è¨çç®åä½ç¨ãæä¸­è¯¦ç»è§£éäºå¯¹è±¡åç´ çç¨æ³ï¼åæ¬èªé­ååæå¯¹æ ç­¾çè¯­æ³ï¼ä»¥åå¦ä½ä¸ºæ§ä»¶è®¾ç½®å±æ§ãä½èä½¿ç¨ç®åæäºçç¤ºä¾ï¼å±ç°äºæé®åææ¬æ¡çç¨æ³ï¼å¹¶æåºäºéåå±æ§çæ¦å¿µï¼åºåäºæ¾å¼åéå¼åæ³ãæ´ä½ä¸ï¼æç« ä»¥éä¿ææçæ¹å¼ä»ç»äº XAML çåºç¡ç¥è¯ï¼éååå­¦èå­¦ä¹ ã</p>
<h3 id="net-10-ç½ç»æ¹è¿httpå®å¨ä¸ç½ç»åè¯­çå¨é¢åçº§">.NET 10 ç½ç»æ¹è¿ï¼HTTPãå®å¨ä¸ç½ç»åè¯­çå¨é¢åçº§</h3>
<p><a href="https://www.cnblogs.com/powertoolsteam/p/19330426" target="_blank">https://www.cnblogs.com/powertoolsteam/p/19330426</a></p>
<p>.NET 10 æä¾äºå¤é¡¹ç½ç»æ¹è¿ï¼åæ¬æå¡å¨è¯ä¹¦éªè¯ä¼åãæ°ç HTTP å¨è¯ QUERY å WebSocketStream æ½è±¡å±ãWinHttpHandler ç®åæ¯æåºäºæå¡å¨ IP å°åçè¯ä¹¦ç¼å­æºå¶ï¼å¢å¼ºæ§è½ãQUERY æ¹æ³åè®¸å¨è¯·æ±ä½ä¸­åéæ¥è¯¢ï¼éç¨äºè¶é¿ URI çåºæ¯ãWebSocketStream ç®åäºææ¬åäºè¿å¶åè®®çæ°æ®å¤çï¼æ¯æå¤ç§åè®®ãåæ¶ï¼.NET 10 å¨ OSX ä¸å¼å¥äºå®¢æ·ç«¯ TLS 1.3 æ¯æï¼éè¿ AppContext å¼å³å¯ç¨ï¼æåäºå®å¨æ§ãæ´ä½ä¸ï¼è¿äºæ´æ°æåäºå¼åèçç½ç»ç¼ç¨è½åã</p>
<h3 id="å«åè¯´-winform-åçå·¥ä¸è½¯ä»¶ä¸äºè¿äºå¼æºåºè®©å®é¢å¼ææ»¡äº¤äºæµç">å«åè¯´ WinForm åçå·¥ä¸è½¯ä»¶ä¸äºï¼è¿äºå¼æºåºè®©å®é¢å¼ææ»¡ãäº¤äºæµç</h3>
<p><a href="https://www.cnblogs.com/1312mn/p/19321609" target="_blank">https://www.cnblogs.com/1312mn/p/19321609</a></p>
<p>WinForm ä½ä¸º.NET çæä¸­æçå¯é çæ¡é¢å¼åæ¡æ¶ï¼å°½ç®¡å­å¨è§è§åäº¤äºéå¶ï¼ä½å¨ä¼ä¸ç®¡çãå·¥ä¸æ§å¶ç­é¢åä¾ç¶å¹¿æ³åºç¨ãä¸ºäºæå UI ææï¼å¼åèå¯åå©ç¬¬ä¸æ¹å¼æº UI åºï¼è¿äºåºå¨ä¸æ¹å WinForm æ ¸å¿ç»æçåæä¸ï¼éè¿æ§ä»¶éç»åä¼åå¸å±ï¼ä½¿ä¼ ç»æ¡æ¶çåæ°çãæä¸­ä»ç»ç ReaLTaiizor æ§ä»¶åºï¼æä¾ä¸°å¯çç¤ºä¾åå¼å®¹ççæ¬ï¼è½å¿«éåå»ºé«è´¨éçåºç¨çé¢ï¼éä½ç°ä»£åæ¹é çææ¯é¨æ§ã</p>
<h3 id="åäº«-4-æ¬¾åºäº-c-ç¼åå®ç¨å¼æºç-visual-studio-æ©å±æä»¶">åäº« 4 æ¬¾åºäº C# ç¼åãå®ç¨ãå¼æºç Visual Studio æ©å±æä»¶</h3>
<p><a href="https://www.cnblogs.com/Can-daydayup/p/19328798" target="_blank">https://www.cnblogs.com/Can-daydayup/p/19328798</a></p>
<p>EFCore.Visualizer æ¯ä¸æ¬¾ç¨äºå¨ Visual Studio ä¸­å¯è§å EF Core æ¥è¯¢è®¡åçå·¥å·ï¼æ¯æå¤ç§æ°æ®åºãEF Core Power Tools æä¾æ°æ®åºååå·¥ç¨åæ¨¡åå¯è§ååè½ï¼éä½å¼åé¨æ§ãAntDeploy æ¯ä¸æ¬¾å¼æºé¨ç½²æä»¶ï¼æ¯æå¤å¹³å°åå¸ãFileEncoding æä»¶å¯å®æ¶æ¾ç¤ºææ¡£ç¼ç ï¼ç®åç¼ç ç®¡çãææé¡¹ç®åæ¶å½å¨ C#/.NET ä¼ç§é¡¹ç®ç²¾éä¸­ï¼æ¹ä¾¿å¼åèè·åææ°å¨æåæä½³å®è·µã</p>
<h3 id="è¾è®¯äº-edgeone-pages-æç®¡-blazor-wasm">è¾è®¯äº EdgeOne Pages æç®¡ Blazor Wasm</h3>
<p><a href="https://www.cnblogs.com/CKExp/p/19319722" target="_blank">https://www.cnblogs.com/CKExp/p/19319722</a></p>
<p>æ¬æä»ç»äºå¦ä½ä½¿ç¨ Blazor WebAssembly å¨è¾è®¯äº EdgeOne Pages ä¸é¨ç½²éæç½ç«ãEdgeOne Pages ä¸ Github Pages ç¸ä¼¼ï¼æä¾åè´¹çéæç«ç¹é¨ç½²æå¡ãä½èæè¿°äºåå»º Blazor WebAssembly é¡¹ç®çè¿ç¨ï¼ä¸ä¼ ä»£ç è³ Githubï¼å¹¶ä½¿ç¨ Github Actions è¿è¡èªå¨æå»ºåé¨ç½²ãç¨ yml æä»¶éç½®äºæå»ºå·¥ä½æµï¼æ­¥éª¤åæ¬è®¾ç½®.NET ç¯å¢ååå¸é¡¹ç®ï¼æç»å°æå»ºåçæä»¶æ¨éè³ Github Pagesãæç« é»è¾æ¸æ°ï¼åå«å·ä½çæä»¤åç¤ºä¾ï¼éåå¼åèåèã</p>
<h3 id="net-8-å¾®æå¡æ¡æ¶é¿ä»ä¹æ ·éæ-ai-æºè½ä½å¤ç§æ·èªå¨è°åº¦ä¸å®æ¶éä¿¡">.NET 8 å¾®æå¡æ¡æ¶é¿ä»ä¹æ ·ï¼éæ AI æºè½ä½ãå¤ç§æ·ãèªå¨è°åº¦ä¸å®æ¶éä¿¡</h3>
<p><a href="https://www.cnblogs.com/1312mn/p/19273206" target="_blank">https://www.cnblogs.com/1312mn/p/19273206</a></p>
<p>è¯¥æç« ä»ç»äºåºäº .NET 8 çå¾®æå¡èææ¶ï¼å³ NetCoreKevinï¼æ¨å¨å¸®å©å¿«éæ­å»ºæ¯æå¤ç§æ·ä¸åå¸å¼é¨ç½²çç³»ç»ãæç« å¼ºè°é¡¹ç®åºç¨é¢åé©±å¨è®¾è®¡ï¼DDDï¼ï¼ååç«¯åç¦»æ¶æï¼å¹¶éæå¤ç§å¸¸ç¨åè½å¦å®å¨è®¤è¯ãå¤äºå­å¨ä¸ AI è½åãææ¯äº®ç¹åæ¬è·¨æå¡äºä»¶éä¿¡ãRedis ç¼å­å Quartz å®æ¶ä»»å¡ãè¯¦ç»æä¾äºé¡¹ç®å¯å¨éç½®åä¸ææç¨ï¼å¸®å©å¢éå¿«éå®ç° SaaS ç±»ç³»ç»çå¼åä¸é¨ç½²ã</p>
<h3 id="ä¸åéå®ç°net-ä¸é£ä¹¦é¿è¿æ¥ç-websocket-æ¶æ">ä¸åéå®ç°.NET ä¸é£ä¹¦é¿è¿æ¥ç WebSocket æ¶æ</h3>
<p><a href="https://www.cnblogs.com/mudtools/p/19320597" target="_blank">https://www.cnblogs.com/mudtools/p/19320597</a></p>
<p>æ¬æä»ç»äºå¦ä½å¨.NET ç¯å¢ä¸­å®ç°é£ä¹¦ WebSocket é¿è¿æ¥ï¼å¼ºè°äºé¿è¿æ¥ç¸å¯¹äºä¼ ç» Webhook çä¼å¿ï¼ç¹å«æ¯å¨å¼åææ¬åå®æ¶æ§æ¹é¢ãæä¸­éè¿°äºé£ä¹¦å¹³å°æ¯æçå¤ç§äºä»¶ç±»åï¼å¹¶æ¢è®¨äº Mud.Feishu æ¶æçäºä»¶å¤çè®¾è®¡ï¼éç¨ç­ç¥æ¨¡å¼ä»¥å®ç°é«æçäºä»¶å¤çæºå¶ãå·ä½ç¤ºä¾å±ç¤ºäºå¦ä½åå»ºç¨æ·åå¤çæ¶æ¯æ¥æ¶äºä»¶ï¼å¼ºè°äºæ¸æ°çåä¸èè´£ãå¯æµè¯æ§ä»¥åå¨æéæ©å¤çç­ç¥çéè¦æ§ã</p>
<h3 id="åæµæ°æ®åäº«cç-threadpoolsetmaxthreads-éç½®æå¤§çº¿ç¨æ°å°åºå¯¹æ§è½æå¤å¤§å½±å">ãåæµæ°æ®åäº«ãC#ç <code>ThreadPool.SetMaxThreads()</code> éç½®æå¤§çº¿ç¨æ°å°åºå¯¹æ§è½æå¤å¤§å½±å</h3>
<p><a href="https://www.cnblogs.com/ahfuzhang/p/19340661" target="_blank">https://www.cnblogs.com/ahfuzhang/p/19340661</a></p>
<p>æç« å±ç¤ºäºéè¿ async æ¹æ³å Kestrel åºæä¾ HTTP æå¡çå¼ºå¤§æ§è½ï¼æåºçº¿ç¨æ± çº¿ç¨æ°ä¸ CPU æ ¸æ°çå³ç³»ãæ§è½éè¿è°æ´çº¿ç¨æ± çæå°åæå¤§çº¿ç¨æ°å¾ä»¥ä¼åãå®éªè¡¨æï¼çº¿ç¨æ± çæä½³è¡¨ç°éè¦æå¤§çº¿ç¨æ°ä¸æ ¸æ°ä¸è´ï¼è¿å¤æè¿å°é½ä¼éä½æ§è½ãä½¿ç¨ Kestrel åºå¼åç HTTP 1.1 echo æå¡å¨ï¼è¿è¡å¨ Docker ç¯å¢ä¸­ï¼å±ç¤ºäºå¶é«æçå¼æ­¥å¤çè½åãå®éªæ°æ®æä¾äºä¸åçº¿ç¨è®¾ç½®ä¸çæ§è½ææ ï¼éªè¯äºä½èçè§ç¹ã</p>
<h3 id="cai-ç³»å6-cç¦»çº¿å®ç°é«æ-ocr">C#AI ç³»å(6): C#ç¦»çº¿å®ç°é«æ OCR</h3>
<p><a href="https://www.cnblogs.com/luojin765/p/19346320" target="_blank">https://www.cnblogs.com/luojin765/p/19346320</a></p>
<p>æ¬æä»ç»äºå¦ä½å¨ C#ä¸­ä½¿ç¨ Tesseract å®ç° OCRãTesseract æ¯ä¸ä¸ªå¼ºå¤§çå¼æºåå­¦å­ç¬¦è¯å«å¼æï¼æ¯æè¶è¿ 100 ç§è¯­è¨ãä½èæä¾äºå½ä»¤è¡å Wrapper ä¸¤ç§è°ç¨æ¹å¼ï¼å¹¶éç¹è¯´æäºä½¿ç¨ Wrapper æ¹æ³ï¼éè¿ç®æ´çåè¡ä»£ç å®ç° OCRãè¯»èéæååå¤å¥½è®­ç»æ¨¡åï¼å¹¶å¯éæ©åæ¶å è½½å¤ç§è¯­è¨æ¨¡åãæ¬æä¹è¯¦ç»æè¿°äºå¼ææ¨¡å¼åé¡µé¢åå²æ¨¡å¼çéæ©ï¼å¸®å©ç¨æ·ä¼å OCR ææãé¡¹ç®èµæºå·²å¼æºï¼æ¬¢è¿å­¦ä¹ äº¤æµã</p>
<h3 id="maf-å¿«éå¥é¨6æ··åç¼æå·¥ä½æµ">MAF å¿«éå¥é¨ï¼6ï¼æ··åç¼æå·¥ä½æµ</h3>
<p><a href="https://www.cnblogs.com/edisontalk/p/-/quick-start-on-maf-chatper06" target="_blank">https://www.cnblogs.com/edisontalk/p/-/quick-start-on-maf-chatper06</a></p>
<p>æ¬æä»ç»äºå¨ MAF ä¸­æ··åä½¿ç¨ Executor å Agent çå·¥ä½æµï¼éç¹å¨äºéå¯¹åå®¹å®¡æ ¸çæ¡ä¾ãExecutor è´è´£ç¡®å®æ§é»è¾å¤çï¼å¦æ°æ®éªè¯ï¼è Agent ç¨äº AI æºè½å³ç­ï¼å·æä¸ç¡®å®æ§ãæç« æä¾äºä¸ä¸ªå·ä½å®ä¾ï¼ä½¿ç¨.NET æ§å¶å°åºç¨éç½®ç¸å³ NuGet åï¼å¹¶å±ç¤ºäºå¦ä½è¯»å API ä¿¡æ¯åå®ä¹æ°æ®ä¼ è¾æ¨¡åãéè¿å·ä½çä»£ç ç¤ºä¾ï¼æ¸æ¥è¯´æäºå·¥ä½æµçæå»ºè¿ç¨ï¼éåå¼åèå­¦ä¹ åå®è·µã</p>
<h3 id="cå®ç°ä¸è±-mc-éè®¯åè®®åº4c-å¸§-æ ¼å¼-1">C#å®ç°ä¸è± MC éè®¯åè®®åºï¼4C å¸§-æ ¼å¼ 1ï¼</h3>
<p><a href="https://www.cnblogs.com/dragonet-Z/p/19318911" target="_blank">https://www.cnblogs.com/dragonet-Z/p/19318911</a></p>
<p>æ¬æä»ç»äº C#å®ç°çä¸è± MC éè®¯åè®®åºï¼ä½¿ç¨ VS2022 .NET Standard 2.0 å¼åãéè¿ä¸²å£å®ç° PC ä¸ PLC çéè®¯ï¼æ¯æ QnA å¼å®¹ 4C å¸§æ ¼å¼ 1 çå¼æ­¥è¯»åæä½ãMC åè®®æ¯ä¸ä¸è± PLC éè®¯çå¬å¼åè®®ï¼è½å¤éè¿ä¸åæ¨¡åè¯»å PLC çç¶æãæç« è¯¦ç»è¯´æäº MC åè®®çéä¿¡æ¡æ¶ãæ°æ®åå®¹åæä»¤ãè¿æä¾äºåæ ¡éªå®ç°ä»£ç ï¼å¸®å©å¼åèè°è¯ãæä¸­éæç¸å³æåé¾æ¥ï¼ä¾¿äºæ·±å¥äºè§£åè®®ãæåå¼ºè°åè®®åè½å¼ºå¤§ï¼ä»è¦çåºç¡åå®¹ã</p>
<h3 id="ef-corecode-firstæ¹æ¡ä¸ä»¥ç¼ç¨æ¹å¼çæè¿ç§»">ãEF CoreãâCode Firstâæ¹æ¡ä¸ä»¥ç¼ç¨æ¹å¼çæè¿ç§»</h3>
<p><a href="https://www.cnblogs.com/tcjiaan/p/19345236" target="_blank">https://www.cnblogs.com/tcjiaan/p/19345236</a></p>
<p>è¿ç§»ï¼Migrationsï¼æ¯ç¨äºåå»ºåä¿®è®¢æ°æ®åºçæºå¶ãå®éè¿çæä¸ç³»å .NET ç±»æ¥è¡¨ç¤ºæ°æ®åºçä¸åçæ¬ãå¼åèå¯ä»¥å¨è¿äºçæ¬ä¹é´åè¿æåéï¼ä»¥ä¿®æ¹æ°æ®åºç»æèéæ°æ®ãç¡®ä¿åå»ºæ°æ®åºçæ¹æ³ä¸è½åç»­ä¿®æ¹ï¼èè¿ç§»ä¼ä¿å­è¿ç§»çæ¬ä¿¡æ¯ãå¼åèå¯ä»¥èªå®ä¹è¿ç§»å½åæ¹å¼ï¼å¹¶éè¿å®ç° IMigrationsIdGenerator æ¥å£æ¥å®å¶å½åãè¿ç§»ç±å¤ç§æä½ç»æï¼éè¿çæ SQL è¯­å¥å®ç°æ°æ®åºä¿®æ¹ãè¿ä¸ªè¿ç¨ä¸°å¯ä¸å®ç¨ï¼å¯¹å¼åèæå·å¸®å©ã</p>
<h3 id="net-10-ç½ç»å æ æ·±åº¦æ¶æè§£æhttp3æ§è½ä¼åä¸åéå­å å¯çèåæ¼è¿">.NET 10 ç½ç»å æ æ·±åº¦æ¶æè§£æï¼HTTP/3ãæ§è½ä¼åä¸åéå­å å¯çèåæ¼è¿</h3>
<p><a href="https://www.cnblogs.com/shanyou/p/19350080/dotnet10network" target="_blank">https://www.cnblogs.com/shanyou/p/19350080/dotnet10network</a></p>
<p>éç.NET 10 çæ¨åºï¼å¾®è½¯éæ°å®ä¹äºäºåçæ¶ä»£çç½ç»éä¿¡æ åãè¯¥çæ¬èç¦ç°ä»£ãé«æåå¼åèåå¥½ï¼æ¯æ HTTP/3 å QUIC åè®®ï¼è§£å³äºé¿æå­å¨çéå¤´é»å¡é®é¢ï¼å¹¶å¼å¥åéå­å å¯ç®æ³ï¼å¢å¼ºäºå®å¨æ§åæ§è½ãéè¿ JIT ç¼è¯å¨ä¼ååèµæºç®¡çï¼.NET 10 å¨é«å¹¶ååºæ¯ä¸è¡¨ç°åºè²ãæ°ç System.Net.Quic åºä½ä¸ºæ ¸å¿ç»ä»¶ï¼æé«äºæµçç¬ç«æ§åç½ç»ä¼ è¾æçï¼ç®åäºå¼åèçä½éªï¼æ å¿ç.NET çææ¯éå¤§è¿æ­¥ã</p>
<h3 id="net-å¾®æå¡ç½å³æ³¨ååç®¡çåºäº-consul--nginx-å®ç°">.Net å¾®æå¡ç½å³æ³¨ååç®¡çï¼åºäº Consul + Nginx å®ç°ï¼</h3>
<p><a href="https://www.cnblogs.com/net-kevin-li/p/19332353" target="_blank">https://www.cnblogs.com/net-kevin-li/p/19332353</a></p>
<p>æç« è¯¦ç»ä»ç»äºå¦ä½åºäº Consul å Nginx å®ç°.NET å¾®æå¡çç½å³æ³¨åä¸ç®¡çãå®éè¿°äºå¾®æå¡æ¶æä¸­ API ç½å³çåè½ãConsul çæå¡æ³¨åä¸åç°ä»¥å Nginx çå¨æè·¯ç±éç½®ãæç« è¿æå°å¥åº·æ£æ¥ä¸æéè½¬ç§»æºå¶ï¼ä»¥åè´è½½åè¡¡ç­ç¥çä¼åãæåï¼æ¶åå®å¨ä¸è®¤è¯çéæï¼å±ç¤ºäºå®éçä»£ç ç¤ºä¾åéç½®ï¼å·æå®ç¨æ§åææ¯æ·±åº¦ã</p>
<h3 id="å¨net-ä¸­å®ç°ä¸åºå¤ç§æ·single-database-multi-tenancyæ¨¡å¼ä¸»è¦éè¿å±äº«æ°æ®åºä½éç¦»æ°æ®çæ¹å¼å®ç°">å¨.NET ä¸­å®ç°ä¸åºå¤ç§æ·ï¼Single Database Multi-Tenancyï¼æ¨¡å¼ï¼ä¸»è¦éè¿å±äº«æ°æ®åºä½éç¦»æ°æ®çæ¹å¼å®ç°ã</h3>
<p><a href="https://www.cnblogs.com/net-kevin-li/p/19327739" target="_blank">https://www.cnblogs.com/net-kevin-li/p/19327739</a></p>
<p>æ¬æè®¨è®ºäºå¨.NET ä¸­å®ç°ä¸åºå¤ç§æ·æ¨¡å¼çæ¹æ³ï¼ä»ç»äºå±äº«æ°æ®åºåæ°æ®éç¦»çå®ç°æ¹æ¡ãæç« è¯¦ç»éè¿°äºååç«¯åç¦»è®¾è®¡ãé¢åé©±å¨è®¾è®¡åå¤çº§ç¼å­æºå¶ç­æ¶æç¹æ§ãåå®¹æ¶å CAP äºä»¶æ»çº¿ãSignalR å®æ¶éä¿¡åä»»å¡è°åº¦ç­æ ¸å¿ææ¯ãè¿æè¿°äºå¦ä½éè¿ç§æ· ID åãå¨æ Schema åè¡çº§å®å¨ç­ç¥å®ç°æ°æ®éç¦»ï¼æåºäºéè¿å­ååæ JWT è¿è¡ç§æ·è¯å«çæ¹æ¡ãæ­¤å¤ï¼æç« å»ºè®®äºæ§è½ä¼åæ¹æ¡ï¼å¦ç´¢å¼ä¼ååæ°æ®åçã</p>
<h3 id="opencvsharpå­¦ä¹ è¿éæ§æ£æµçä½¿ç¨">OpenCVSharpï¼å­¦ä¹ è¿éæ§æ£æµçä½¿ç¨</h3>
<p><a href="https://www.cnblogs.com/mingupupu/p/19344713" target="_blank">https://www.cnblogs.com/mingupupu/p/19344713</a></p>
<p>è¿éæ§æ£æµæ¯è®¡ç®æºè§è§ä¸­çå¾åå¤çææ¯ï¼ç¨äºæ è®°äºå¼å¾åçç¸äºè¿æ¥åç´ åºåãè¯¥ææ¯éå¸¸ç¨ä½å¶ä»å¾åå¤ççåç½®æ­¥éª¤ï¼è½ç»è®¡ç©ä½æ°éï¼ä½åºç¨åºæ¯æéãé¦åå°å¾åç°åº¦åï¼åè¿è¡äºå¼åå¤çãä½¿ç¨ OpenCVSharp åºä¸­ç Cv2.AdaptiveThreshold å½æ°ï¼å¯ä»¥å¯¹åç§ä¸åçå¾åè¿è¡å±é¨èªéåºçäºå¼åï¼ä»èæ´åç¡®å°è¿è¡è¿éåºåæ£æµãè¯¥æ¹æ³éè¿è®¡ç®å±é¨åºåçå¹³åå¼å¨æè°æ´éå¼ï¼éåºä¸åäº®åº¦çåºåãå¨å±éå¼å¤çå¨å¤ææåµä¸ææè¾å·®ãæ´ä½åå®¹å±ç¤ºäºå¾åå¤ççæ ¸å¿ææ¯ååºç¨ã</p>
<h3 id="solon-ai-å¼åå­¦ä¹ -19---ç»å-solon-flow-å®ç°-react-ææ">Solon AI å¼åå­¦ä¹  19 - ç»å Solon Flow å®ç° ReAct ææ</h3>
<p><a href="https://www.cnblogs.com/noear/p/19328690" target="_blank">https://www.cnblogs.com/noear/p/19328690</a></p>
<p>Solon Flow æ¯ä¸ä¸ªéç¨çæµç¨ç¼æå¼æï¼ä½¿ç¨ YAML æ JSON è¿è¡éç½®ãè¯¥ç¤ºä¾å±ç¤ºäºå¦ä½éè¿ LLM ç¼åæç« å¹¶è¿è¡äººå·¥å®¡æ ¸çæµç¨ãæµç¨å¼å§æ¶ï¼Agent ç¼ååç¨¿ï¼æ¥çè¿å¥å®¡æ ¸ç¯èãå¦æå®¡æ ¸ä¸éè¿ï¼ç¨æ·å¯ä»¥æä¾åé¦ï¼Agent æ ¹æ®åé¦ä¿®æ¹åå®¹ï¼åæ¬¡è¿å¥å®¡æ ¸ãæç»ï¼æµç¨å¨è·å¾æ¹åæè¾¾å°æå¤§ä¿®æ¹æ¬¡æ°åç»æãä»£ç é¨åå±ç¤ºäº Agent çå®ç°ï¼åæ¬åç¨¿ç¼åååé¦å¤ççé»è¾ãæ´ä½ä¸ï¼è¯¥æµç¨é«æå®ç°äºäººæºäº¤äºä¸åå®¹å®¡æ ¸çç»åã</p>
<h3 id="maui-åºæ¨èä¸mauiicons">MAUI åºæ¨èä¸ï¼MAUIIcons</h3>
<p><a href="https://www.cnblogs.com/sesametech-dotnet/p/19349735" target="_blank">https://www.cnblogs.com/sesametech-dotnet/p/19349735</a></p>
<p>MAUIIcons æ¯ä¸ä¸ªä¸º Maui æä¾çå¾æ éååºï¼éæ FluentãMaterialãCupertino å FontAwesome å¾æ ãç¨æ·è½ä¾¿æ·å°å¨ MAUI åºç¨ä¸­ä½¿ç¨è¿äºå¾æ ãä¸ºäºä½¿ç¨è¯¥åºï¼éè¦å¨ nuget ä¸ä¸è½½ï¼å¹¶å¨ MauiProgram.cs ä¸­æ·»å ä»£ç è¿è¡åå§åãæ­¤å¤ï¼æä¸­ä»ç»äºå¦ä½å¨ XAML ä¸­ä½¿ç¨å¾æ ï¼å¹¶æä¾äºæ°æ®ç»å®çç¤ºä¾ãè¥éç¼è¯éè¯¯ï¼å¯ä»¥éè¿åå»º MauiIcon å®ä¾è§£å³ãè¯¥ææäºçè§£ï¼ä¸åå«å®ç¨ç¤ºä¾ã</p>
<h3 id="åå»ºæé³æ°å·åäº«ç¥è¯æ¨å¹¿å¼æºé¡¹ç®">åå»ºæé³æ°å·åäº«ç¥è¯æ¨å¹¿å¼æºé¡¹ç®</h3>
<p><a href="https://www.cnblogs.com/fanliang11/p/19332240" target="_blank">https://www.cnblogs.com/fanliang11/p/19332240</a></p>
<p>ä½èæ¯ä¸åæ¥æäºåå¹´å¼åç»éªç 85 åï¼å§ç»åæ.NET ææ¯ï¼å°½ç®¡é¢ä¸´è¯¸å¤ææãä»åäº«äºèªå·±å¯¹äº§åå¼åçç­æï¼åä¿¡æç»ä¼åå¾æåãåæ¶ï¼ä»å¼è®¾äºä¸ä¸ªæ°çæé³å·ï¼å¸æéè¿ç´æ­æå¨ç²ä¸åå®£ä¼ äº§åï¼è¿æå°ç´æ­äºå¨çç®çå¨äºå­¦ä¹ äº¤æµã</p>
<blockquote>
<p>æ¬å¨å½éå¨åæªæ´æ°ï¼æçç©º</p>
</blockquote>
<h2 id="ä»æ¥äººç©">ä»æ¥äººç©</h2>
<p><strong>æ¥å°æ¯Â·å®ä¸å°¼Â·çæ¥å¾·Â·éå°</strong><a href="https://zh.wikipedia.org/wiki/%E7%88%B5%E5%A3%AB" target="_blank" rel="noopener nofollow">çµå£«</a>ï¼è±è¯­ï¼Sir <strong>Charles Antony Richard Hoare</strong>ï¼ç¼©åä¸º C. A. R. Hoareï¼1934 å¹´ 1 æ 11 æ¥âï¼ï¼æµç§°ä¸º<strong>ä¸å°¼Â·éå°</strong>ï¼è±è¯­ï¼<strong>Tony Hoare</strong>ï¼ä¸è¯<strong>æå°¼Â·éå°</strong>ï¼ï¼çäº<a href="https://zh.wikipedia.org/wiki/%E5%A4%A7%E8%8B%B1%E5%B8%9D%E5%9C%8B" target="_blank" rel="noopener nofollow">å¤§è±å¸å½</a><a href="https://zh.wikipedia.org/wiki/%E8%8B%B1%E5%B1%AC%E9%8C%AB%E8%98%AD" target="_blank" rel="noopener nofollow">é¡å°</a><a href="https://zh.wikipedia.org/wiki/%E5%8F%AF%E5%80%AB%E5%9D%A1" target="_blank" rel="noopener nofollow">å¯ä¼¦å¡</a>ï¼ä»<a href="https://zh.wikipedia.org/wiki/%E6%96%AF%E9%87%8C%E8%98%AD%E5%8D%A1" target="_blank" rel="noopener nofollow">æ¯éå°å¡</a>ï¼ï¼è±å½<a href="https://zh.wikipedia.org/wiki/%E8%A8%88%E7%AE%97%E6%A9%9F%E7%A7%91%E5%AD%B8%E5%AE%B6" target="_blank" rel="noopener nofollow">è®¡ç®æºç§å­¦å®¶</a>ï¼<a href="https://zh.wikipedia.org/wiki/%E5%9B%BE%E7%81%B5%E5%A5%96" target="_blank" rel="noopener nofollow">å¾çµå¥</a>å¾ä¸»ãä»è®¾è®¡äº<a href="https://zh.wikipedia.org/wiki/%E5%BF%AB%E9%80%9F%E6%8E%92%E5%BA%8F" target="_blank" rel="noopener nofollow">å¿«éæåº</a><a href="https://zh.wikipedia.org/wiki/%E6%BC%94%E7%AE%97%E6%B3%95" target="_blank" rel="noopener nofollow">ç®æ³</a>ã<a href="https://zh.wikipedia.org/wiki/%E9%9C%8D%E5%B0%94%E9%80%BB%E8%BE%91" target="_blank" rel="noopener nofollow">éå°é»è¾</a>ã<a href="https://zh.wikipedia.org/wiki/%E9%80%9A%E4%BF%A1%E9%A1%BA%E5%BA%8F%E8%BF%9B%E7%A8%8B" target="_blank" rel="noopener nofollow">éä¿¡é¡ºåºè¿ç¨</a>ã</p>
<p>ä¸å°¼Â·éå°çç¶äº²æ¯ä¸ä½å¬å¡åï¼æå¡äº<a href="https://zh.wikipedia.org/wiki/%E8%8B%B1%E5%B1%AC%E9%8C%AB%E8%98%AD" target="_blank" rel="noopener nofollow">è±å±é¡å°</a>ãå¶æ¯äº²æ¯è¶å­ä¸»äººçå¥³å¿ã</p>
<p>ä¸å°¼Â·éå°å¨å¯ä¼¦å¡åºçï¼å¨è±å½æ¬ååæè²ã1956 å¹´ï¼å¨<a href="https://zh.wikipedia.org/wiki/%E7%89%9B%E6%B4%A5%E5%A4%A7%E5%AD%B8" target="_blank" rel="noopener nofollow">çæ´¥å¤§å­¦</a><a href="https://zh.wikipedia.org/wiki/%E7%89%9B%E6%B4%A5%E5%A4%A7%E5%AD%B8%E5%A2%A8%E9%A0%93%E5%AD%B8%E9%99%A2" target="_blank" rel="noopener nofollow">å¢¨é¡¿å­¦é¢</a>åå¾<a href="https://zh.wikipedia.org/wiki/%E8%A5%BF%E6%B4%8B%E5%8F%A4%E5%85%B8%E5%AD%B8" target="_blank" rel="noopener nofollow">è¥¿æ´å¤å¸å­¦</a><a href="https://zh.wikipedia.org/wiki/%E5%AD%B8%E5%A3%AB" target="_blank" rel="noopener nofollow">å­¦å£«</a>å­¦ä½ã<a href="https://zh.wikipedia.org/wiki/%E6%9D%B1%E5%B0%BC%C2%B7%E9%9C%8D%E7%88%BE#cite_note-MCreg-1" target="_blank" rel="noopener nofollow">[1]</a>å¨å¤§å­¦æ¯ä¸åï¼è¿å¥<a href="https://zh.wikipedia.org/wiki/%E8%8B%B1%E5%9C%8B%E7%9A%87%E5%AE%B6%E6%B5%B7%E8%BB%8D" target="_blank" rel="noopener nofollow">è±å½çå®¶æµ·å</a>æåµå½¹ 18 ä¸ªæï¼<a href="https://zh.wikipedia.org/wiki/%E6%9D%B1%E5%B0%BC%C2%B7%E9%9C%8D%E7%88%BE#cite_note-MCreg-1" target="_blank" rel="noopener nofollow">[1]</a>å¨æ­¤å­¦ä¼<a href="https://zh.wikipedia.org/wiki/%E4%BF%84%E8%AA%9E" target="_blank" rel="noopener nofollow">ä¿è¯­</a>ã<a href="https://zh.wikipedia.org/wiki/%E6%9D%B1%E5%B0%BC%C2%B7%E9%9C%8D%E7%88%BE#cite_note-Hoare_autobio-2" target="_blank" rel="noopener nofollow">[2]</a>1958 å¹´éä¼åï¼åå°çæ´¥å¤§å­¦ï¼ç è¯»ç»è®¡å­¦ï¼åå¾å­¦å£«åå­¦ä½ã<a href="https://zh.wikipedia.org/wiki/%E6%9D%B1%E5%B0%BC%C2%B7%E9%9C%8D%E7%88%BE#cite_note-MCreg-1" target="_blank" rel="noopener nofollow">[1]</a>å¨æ­¤æé´ï¼å¼å§å­¦ä¹ ç¨å¼è®¾è®¡ï¼ä»è·ç<a href="https://zh.wikipedia.org/w/index.php?title=Leslie_Fox&amp;action=edit&amp;redlink=1" target="_blank" rel="noopener nofollow">Leslie Fox</a>å­¦ä¹ <a href="https://zh.wikipedia.org/w/index.php?title=Autocode&amp;action=edit&amp;redlink=1" target="_blank" rel="noopener nofollow">Autocode</a>ãä¸ºäºè¿ä¸æ­¥å­¦ä¹ <a href="https://zh.wikipedia.org/wiki/%E4%BF%84%E8%AA%9E" target="_blank" rel="noopener nofollow">ä¿è¯­</a>ï¼ä»ä»¥<a href="https://zh.wikipedia.org/wiki/%E8%8B%B1%E5%9C%8B%E6%96%87%E5%8C%96%E5%8D%94%E6%9C%83" target="_blank" rel="noopener nofollow">è±å½æååä¼</a>çäº¤æ¢å­¦çèº«ä»½ï¼è³<a href="https://zh.wikipedia.org/wiki/%E8%98%87%E8%81%AF" target="_blank" rel="noopener nofollow">èè</a><a href="https://zh.wikipedia.org/wiki/%E8%8E%AB%E6%96%AF%E7%A7%91%E5%9C%8B%E7%AB%8B%E5%A4%A7%E5%AD%B8" target="_blank" rel="noopener nofollow">è«æ¯ç§å½ç«å¤§å­¦</a>çå­¦ï¼<a href="https://zh.wikipedia.org/wiki/%E6%9D%B1%E5%B0%BC%C2%B7%E9%9C%8D%E7%88%BE#cite_note-MCreg-1" target="_blank" rel="noopener nofollow">[1]</a>è·é<a href="https://zh.wikipedia.org/wiki/%E5%AE%89%E5%BE%B7%E9%9B%B7%C2%B7%E6%9F%AF%E7%88%BE%E8%8E%AB%E5%93%A5%E6%B4%9B%E5%A4%AB" target="_blank" rel="noopener nofollow">å®å¾·é·Â·æ¯å°è«å¥æ´å¤«</a>å­¦ä¹ æ°å­¦ï¼å¹¶ç ç©¶<a href="https://zh.wikipedia.org/wiki/%E6%A9%9F%E5%99%A8%E7%BF%BB%E8%AD%AF" target="_blank" rel="noopener nofollow">æºå¨ç¿»è¯</a>ã<a href="https://zh.wikipedia.org/wiki/%E6%9D%B1%E5%B0%BC%C2%B7%E9%9C%8D%E7%88%BE#cite_note-Hoare_autobio-2" target="_blank" rel="noopener nofollow">[2]</a></p>
<p>1960 å¹´ï¼å¨<a href="https://zh.wikipedia.org/wiki/%E8%8E%AB%E6%96%AF%E7%A7%91%E5%9C%8B%E7%AB%8B%E5%A4%A7%E5%AD%B8" target="_blank" rel="noopener nofollow">è«æ¯ç§å½ç«å¤§å­¦</a>åå¾<a href="https://zh.wikipedia.org/wiki/%E5%8D%9A%E5%A3%AB%E5%AD%A6%E4%BD%8D" target="_blank" rel="noopener nofollow">åå£«å­¦ä½</a>åï¼ä»»èäºä¼¦æ¦<a href="https://zh.wikipedia.org/w/index.php?title=%E8%89%BE%E7%95%A5%E7%89%B9%E5%85%84%E5%BC%9F%E5%85%AC%E5%8F%B8&amp;action=edit&amp;redlink=1" target="_blank" rel="noopener nofollow">è¾ç¥ç¹åå¼å¬å¸</a>ï¼Elliott Brothers Ltdï¼ï¼å¼ååºç¬¬ä¸ä¸ªåç¨ç<a href="https://zh.wikipedia.org/wiki/ALGOL_60" target="_blank" rel="noopener nofollow">ALGOL 60</a>ç¼è¯å¨ï¼å¾å¿«å°±æä¸ºå¬å¸çé¦å¸­å·¥ç¨å¸ã</p>
<p>1968 å¹´ï¼æä¸º<a href="https://zh.wikipedia.org/wiki/%E8%B2%9D%E7%88%BE%E6%B3%95%E6%96%AF%E7%89%B9%E5%A5%B3%E7%8E%8B%E5%A4%A7%E5%AD%B8" target="_blank" rel="noopener nofollow">è´å°æ³æ¯ç¹å¥³çå¤§å­¦</a>çææã1977 å¹´åå°<a href="https://zh.wikipedia.org/wiki/%E7%89%9B%E6%B4%A5%E5%A4%A7%E5%AD%B8" target="_blank" rel="noopener nofollow">çæ´¥å¤§å­¦</a>æä»»ææãç°ä¸ºçæ´¥å¤§å­¦è£èªææï¼å¹¶å¨åæ¡¥<a href="https://zh.wikipedia.org/wiki/%E5%BE%AE%E8%BB%9F%E7%A0%94%E7%A9%B6%E9%99%A2" target="_blank" rel="noopener nofollow">å¾®è½¯ç ç©¶é¢</a>æä»»ç ç©¶åã</p>
<p><img src="https://img2024.cnblogs.com/blog/997046/202601/997046-20260112213059697-501020170.jpg" alt="æ¥å°æ¯Â·å®ä¸å°¼Â·çæ¥å¾·Â·éå°çµå£«" loading="lazy"></p>
<h2 id="c-net-äº¤æµç¾¤">C# .NET äº¤æµç¾¤</h2>
<p>ç¸ä¿¡å¤§å®¶å¨å¼åä¸­ç»å¸¸ä¼éå°ä¸äºæ§è½é®é¢ï¼è¦äºæ²¡æææçå·¥å·å»åç°æ§è½ç¶é¢ï¼æèæ¯åç°ç¶é¢ä»¥åä¸ç¥éè¯¥å¦ä½ä¼åãä¹åä¸ç´æè¯»èæåè¯¢é®ææ²¡æææ¯äº¤æµç¾¤ï¼ä½æ¯ç±äºåç§åå ä¸ç´é½æ²¡åå»ºï¼ç°å¨å¾é«å´çå¨è¿éå®£å¸ï¼æåå»ºäºä¸ä¸ªä¸é¨äº¤æµ.NET æ§è½ä¼åç»éªçç¾¤ç»ï¼ä¸»é¢åæ¬ä½ä¸éäºï¼</p>
<ul>
<li>å¦ä½æ¾å°.NET æ§è½ç¶é¢ï¼å¦ä½¿ç¨ APMãdotnet tools ç­å·¥å·</li>
<li>.NET æ¡æ¶åºå±åççå®ç°ï¼å¦åå¾åæ¶å¨ãJIT ç­ç­</li>
<li>å¦ä½ç¼åé«æ§è½ç.NET ä»£ç ï¼åªäºå°æ¹å­å¨æ§è½é·é±</li>
</ul>
<p>å¸æè½ææ´å¤å¿åéåæåå å¥ï¼åäº«ä¸äºå·¥ä½ä¸­éå°ç.NET é®é¢åå®è´µçåæä¼åç»éªã<strong>ç®åä¸ç¾¤å·²æ»¡ï¼ç°å¨å¼æ¾äºç¾¤ã</strong>å¯ä»¥å æ vxï¼ææä½ è¿ç¾¤: <strong>ls1075</strong> å¦å¤ä¹åå»ºäº <strong>QQ Group</strong>: 687779078ï¼æ¬¢è¿å¤§å®¶å å¥ã</p>
<h3 id="æ¬å¨ç¾¤èåæ">æ¬å¨ç¾¤èåæ</h3>
<p><img src="https://img2024.cnblogs.com/blog/997046/202601/997046-20260112213059747-418753626.jpg" alt="image-20260112212730495" loading="lazy"></p>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-01-12 21:33">2026-01-12 21:32</span>&nbsp;
<a href="https://www.cnblogs.com/InCerry">InCerry</a>&nbsp;
éè¯»(<span id="post_view_count">3</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19474329);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19474329', targetLink: 'https://www.cnblogs.com/InCerry/p/-/dotnet_week_25_12_2', title: '.NETå¨åã12æç¬¬2æ 2025-12-14ã' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ ä¸ºä»ä¹æçäººè¯´âè¶èæç»´è¶åºåâï¼æä¹æè½å·å¤æé¿åæç»´ï¼ ]]></title>
    <link>https://www.cnblogs.com/jiujuan/p/19473443</link>
    <guid>479822263c1bd1690f8774de1e4e49ff</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/jiujuan/p/19473443" title="åå¸äº 2026-01-12 18:25">
    <span role="heading" aria-level="2">ä¸ºä»ä¹æçäººè¯´âè¶èæç»´è¶åºåâï¼æä¹æè½å·å¤æé¿åæç»´ï¼</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h2 id="ä¸åè¨ä¸ºä»ä¹æçäººè¯´è¶èæç»´è¶åºå">ä¸ï¼åè¨ï¼ä¸ºä»ä¹æçäººè¯´è¶èæç»´è¶åºå</h2>
<p>å¨æ¥å¸¸çæ´»ä¸­ï¼æä»¬å¸¸å¸¸å¬å°è¿æ ·çè¯´æ³ï¼"äººèäºå°±åå¾åºæ§äº"ã"å¹´è½»äººçæ³æ³å°±æ¯çµæ´»"ã"ä¸­å¹´ä¹åå­¦ä¹ è½åå°±ä¸éäº"ã</p>
<p>è¿äºè§å¿µæ ¹æ·±èåºï¼ä»¥è³äºè®¸å¤äººå°å¹´é¾å¢é¿ä¸æç»´åºåç»ä¸ç­å·ï¼è®¤ä¸ºéçå²æçæ¨ç§»ï¼æ¹ååæé¿åå¾è¶æ¥è¶ä¸å¯è½ã</p>
<p>ç¶èï¼æ¯å¦ç¦å¤§å­¦å¿çå­¦å®¶å¡ç½å°Â·å¾·é¦åçç ç©¶å½»åºé¢ è¦äºè¿ä¸ä¼ ç»è®¤ç¥ï¼å¥¹æåºç"æé¿åæç»´"æ¦å¿µæ­ç¤ºäºä¸ä¸ªä»¤äººæ¯å¥çäºå®ï¼<br>
<strong>å¤§èå·æç»èº«å¯å¡æ§ï¼æç»´æ¨¡å¼çéæ©åå³äºæä»¬å¯¹å¾è½ååææçæåº¦ï¼èéä¸å¯æ¹åçççå®¿å½</strong>ã</p>
<p>æé¿åæç»´çæ ¸å¿ä¿¡å¿µï¼è½åæ¯å¯å¡çã</p>
<blockquote>
<p>è®¤ä¸ºäººçææºåè½åä¸æ¯å¤©ççåºå®å¼ï¼ææºåè½åæ¯å¯ä»¥éè¿åå¤©åªåï¼éè¿å»æç»ä¹ åç­ç¥æ¹è¿ï¼å¹¶é¿æåæï¼æ¯è½å¤ä¸æ­åå±æé«çã</p>
</blockquote>
<p>ä¸ä¹ç¸å¯¹çæ¯"åºå®åæç»´"ââç¸ä¿¡äººçåºæ¬è½åæ¯å¤©çåºå®å¼ãé¾ä»¥æ¹åçã</p>
<p>è¿ä¸¤ç§æç»´æ¨¡å¼å¹¶éç®åçæ§æ ¼æ ç­¾ï¼èæ¯å½±åçæä»¬å¨äººçé¶æ®µååºéæ©ãä¸ä¸ªæ¥ææé¿åæç»´çäººï¼ä¼å°æ«æè§ä¸ºå­¦ä¹ æºä¼ï¼å°æ¹è¯å½ä½åé¦ï¼å°åªåè§ä¸ºéåä¸æ­æé¿çå¿ç»ä¹è·¯ãèåºå®åæç»´çäººï¼åé¿ææï¼å°å¤±è´¥è§ä¸ºèªèº«ä¸è¶³ï¼åå¨èªå·±çèéåºã</p>
<h2 id="äºä¸¤ç§æç»´çç§å­¦åæ">äºï¼ä¸¤ç§æç»´çç§å­¦åæ</h2>
<h3 id="ç¥ç»ç§å­¦çè§åº¦æ¥ç">ç¥ç»ç§å­¦çè§åº¦æ¥ç</h3>
<p>æé¿åæç»´çé©å½æ§å¨äºå®å¯¹"è½å"è¿ä¸æ¦å¿µçéæ°å®ä¹ãä¼ ç»è§å¿µå¾å¾å°è½åè§ä¸ºæç§åºå®çå®¹å¨ââä½ çæ¥æå¤å¤§å®¹éï¼è¿è¾å­åºæ¬å°±å±éå¨è¿ä¸ªèå´åãå¾·é¦åçç ç©¶è¡¨æï¼è¿ç§è§£éæ¯çé¢çãäºå®ä¸ï¼äººç±»çå¤§èåè®¤ç¥è½åæ´åæ¯ä¸ççææï¼èéä¸ä¸ªæéçå®¹å¨ãè¿ççææè½å¤ä¸æ­æ©å±ãæ·±ååéæ°ç»ç»ï¼å¶æ½åè¿è¶æä»¬éå¸¸ææ³è±¡çèå´ã</p>
<p>ä»ç¥ç»ç§å­¦çè§åº¦æ¥çï¼å¤§èçå¯å¡æ§æ¯ç»èº«çã</p>
<p>è½ç¶å¤§èå¨éå°å¹´æ¶æç¡®å®ç»åçå§ççéå¡è¿ç¨ï¼ç¥ç»åä¹é´ççªè§¦è¿æ¥ç»åçå¤§è§æ¨¡çä¿®åªãè¿æ¥åå¼ºåï¼ä½è¿å¹¶ä¸æå³çæå¹´åå¤§èå°±å¤±å»äºæ¹åçè½åã</p>
<p>æ°çç¥ç»è¿æ¥å¯ä»¥å¨ä»»ä½å¹´é¾å½¢æï¼æ°çæè½å¯ä»¥è¢«å­¦ä¹ ï¼æ°çä¹ æ¯å¯ä»¥è¢«å¹å»ãåæ¡¥å¤§å­¦çä¸é¡¹ç ç©¶è¿½è¸ªäºæå¹´äººå¨å­¦ä¹ æ°æè½æ¶çå¤§èååï¼åç°å³ä½¿æ¯äºåå²ä»¥ä¸çæå¹´äººï¼å¨å­¦ä¹ å¤ææè½ï¼å¦æèææ°çè¯­è¨ï¼æ¶ï¼å¤§èç®å±çç»æä¹ä¼åçå¯æµéçååãè¿æå³çå¤§èå®åè®ºæ¬èº«å°±æ¯ä¸ä¸ªéè¦è¢«æå¼çåºå®åæç»´ã</p>
<h3 id="åºå®åæç»´å¿çè§åº¦æ¥ç">åºå®åæç»´å¿çè§åº¦æ¥ç</h3>
<p>çè§£åºå®åæç»´çè¿ä½æºå¶ï¼å¯¹äºæç ´å®è³å³éè¦ã</p>
<p>åºå®åæç»´å¹¶éç®åçä¸æ¿ææ¹åï¼èæ¯ä¸å¥å¤æçå¿çé²å¾¡ç³»ç»ã</p>
<p>è¿ä¸ªç³»ç»å¨æä»¬é¢å¯¹ææãæ«æåä¸ç¡®å®æ§æ¶èªå¨å¯å¨ï¼å¶æ ¸å¿åè½æ¯ä¿æ¤æä»¬çèªææ¦å¿µåèªå°ãå½æä»¬æ¥æåºå®åæç»´æ¶ï¼æ¯ä¸æ¬¡å¤±è´¥é½ä¸ä»ä»æ¯ä¸æ¬¡æ«æï¼èæ¯å¯¹èªæä»·å¼çå¦å®ï¼æ¯ä¸æ¬¡ææé½ä¸ä»ä»æ¯å­¦ä¹ æºä¼ï¼èæ¯æ´é²èªèº«ä¸è¶³çé£é©ã</p>
<p>å æ­¤ï¼åºå®åæç»´çäººä¼å¾åäºéæ©å®å¨çãè½å¤è¯æèªå·±è½åçä»»å¡ï¼åé¿é£äºå¯è½å¯¼è´å¤±è´¥çææã</p>
<p>è¿ç§æç»´æ¨¡å¼çå½¢æå¾å¾å¯ä»¥è¿½æº¯å°ç«¥å¹´æ¶æçç»åã<br>
å½ç¶æ¯åèå¸è¿åº¦å¼ºè°ç»æèéè¿ç¨ï¼å½æåè¢«å®ä¹ä¸º"èµ¢"èå¤±è´¥è¢«å®ä¹ä¸º"ä¸¢è¸"ï¼å½åªåè¢«è§ä¸ºå¤©èµä¸è¶³çæ å¿æ¶ï¼å¿ç«¥å°±éæ¸å½¢æäºå³äºè½ååæåçåºå®åä¿¡å¿µã</p>
<p>è¿äºä¿¡å¿µä¸æ¦ååï¼å°±ä¼æä¸ºè¿æ»¤ä¸çä¿¡æ¯çééââåæ ·çç»åä¼è¢«ä¸åæç»´æ¨¡å¼çäººååºæªç¶ä¸åçè§£è¯»ã</p>
<h2 id="ä¸ä¸¤ç§ä¸åæç»´çè¡¨ç°">ä¸ï¼ä¸¤ç§ä¸åæç»´çè¡¨ç°</h2>
<p>ä¸ä¸ªæ¥ææé¿åæç»´çäººéå°ä¸ä¼çäºæï¼ä¼æ³ï¼"æè¿æ²¡ææ¡è¿ä¸ªï¼ä½æå¯ä»¥éè¿ç»ä¹ æ¥æé«"ï¼èä¸ä¸ªæ¥æåºå®åæç»´çåå¯è½æ³ï¼"æå°±æ¯ä¸æé¿è¿ä¸ªï¼è¿æ¯å¤©çç"ã</p>
<p>è¿ç§è®¤ç¥å·®å¼ä¼å¨å¤å¹´åäº§çå·¨å¤§çç´¯ç§¯æåºï¼å½±åå­¦ä¸ãèä¸ãäººéå³ç³»åä»¥åççæ´»æåº¦ã</p>
<p>å¨å­¦ä¹ ä¸æé¿ç»´åº¦ä¸ï¼æ¥ææé¿åæç»´çäººå°éè¯¯è§ä¸ºå®è´µçåé¦ï¼å°å°é¾è§ä¸ºæé¿çå¬ååãä»ä»¬ç¸ä¿¡"ä¸ä¼"åªæ¯"ææ¶è¿ä¸ä¼"ï¼å æ­¤æ´æ¿æèµ°åºèéåºï¼æ¥åææã</p>
<p>å¨äººéå³ç³»ä¸­ï¼æé¿åæç»´å¸®å©äººä»¬å°å²çªè§ä¸ºçè§£åæ·±åå³ç³»çæºä¼ï¼èéè¯æå¯¹æ¹æ¯éçè¯æ®ã</p>
<p><strong>éè¦å¼ºè°çæ¯ï¼æé¿åæç»´å¹¶ä¸æå³çç²ç®ä¹è§æå¿½è§ç°å®</strong>ã</p>
<p>æé¿åæç»´æ¯å³äºè¿ç¨çæç»´ââå®æ¿è®¤å½åçç¶æï¼è®¤å¯åªåçä»·å¼ï¼ç¸ä¿¡æ¹è¿çå¯è½æ§ï¼åæ¶èè¸å®å°éåè¡å¨ã</p>
<p>ä¸¤ç§æç»´å¯¹æ¯å¾ï¼</p>
<p><img src="https://img2024.cnblogs.com/blog/650581/202601/650581-20260112193839386-1115149159.png" alt="æé¿åæç»´ååºå®åæç»´å¯¹æ¯å¾" loading="lazy"><br>
ï¼å¾çæ¥èªï¼å¡ç½å°Â·å¾·é¦åãç»èº«æé¿ãï¼</p>
<h2 id="åæ¯ä»ä¹é»ç¢äºæé¿åæç»´å½¢æ">åï¼æ¯ä»ä¹é»ç¢äºæé¿åæç»´å½¢æï¼</h2>
<h3 id="æ©ææè²çå½±å">æ©ææè²çå½±å</h3>
<p>ç«¥å¹´ç»åå¯¹æç»´æ¨¡å¼çå¡é å·æéå¤§çå½±åï¼è¿ç§å½±åå¾å¾å¨æä»¬è¿æ æ³ç¨è¯­è¨è¡¨è¾¾çæ¶åå°±å·²ç»å¼å§ã</p>
<p>å¿çå­¦å®¶è¯å«åºå ç§å¸åçæè²è¡ä¸ºï¼å®ä»¬å¨æ æä¸­å¼ºåäºåºå®åæç»´ã</p>
<p>ç¬¬ä¸ç§æ¯è¿åº¦èµç¾å¤©èµèéåªåãå½å­©å­å®ææä»¶äºæ¶ï¼å¦ææäººçåé¦éä¸­å¨âä½ çèªæâãâä½ çæå¤©èµâä¸ï¼å­©å­å°±ä¼å°è¿äºå¤å¨çãä¸å¯æ§çç¹è´¨ä¸èªæä»·å¼èç³»èµ·æ¥ãè¿æå³çå½ä»ä»¬éå°å°é¾æ¶ï¼ä¼æå¿å¤±å»èªæçæ ç­¾ï¼ä»èåé¿ææã</p>
<p>ç¬¬äºç§æ¯å°å¤±è´¥ä¸èº«ä»½ç­åãå¦æå­©å­å¨å¤±è´¥æ¶å¬å°çæ¯âä½ æä¹è¿ä¹ç¬¨âãâä½ ä¸è¡âè¿æ ·çè¯ï¼ä»ä»¬å°±ä¼å°å¤±è´¥ååä¸ºèªæå®ä¹çä¸é¨åï¼èä¸æ¯ä¸ä¸ªå¯ä»¥æ¹åçç¶æã</p>
<p>æè²ç¯å¢ä¸­çè¯ä»·ä½ç³»ä¹èµ·çå³é®ä½ç¨ãå½å­¦æ ¡åç¤¾ä¼é«åº¦å¼ºè°æ ååèè¯æç»©ãå½å­¦çè¢«æååæ¯è¾ãå½æ­£ç¡®ç­æ¡è¢«è¿åº¦å¼ºè°æ¶ï¼å­¦çå°±å­¦ä¼äºå³æ³¨ç»æèéè¿ç¨ï¼å³æ³¨è¯æèªå·±èéæåèªå·±ã</p>
<p>è¿ç§ç¯å¢ä¸ï¼å³ä½¿å£å¤´ä¸å¼ºè°è¿ç¨æ¯ç»æéè¦ï¼å®éè¡å¨ä¼ éçä¿¡æ¯å´æªç¶ç¸åãå­©å­ä»¬æ¯éå¸¸æéçä¿¡æ¯æ¥æ¶èï¼ä»ä»¬è½å¤ä»æäººè¡ä¸ºçç»å¾®å·®å«ä¸­ï¼å¤æ­ä»ä¹ææ¯çæ­£è¢«éè§çã</p>
<p>ç ç©¶è¡¨æï¼å¨å¼ºè°åªååè¿æ­¥çç¯å¢ä¸­æé¿çå­©å­ï¼ä¸ä»å­¦ä¸è¡¨ç°æ´å¥½ï¼èä¸é¢å¯¹æ«ææ¶æ´å åé§ï¼æ´æ¿æè¿½æ±æææ§çç®æ ã</p>
<p>å®¶åº­æ°å´ä¸­çéæ§ä¿¡æ¯åæ ·éè¦ã</p>
<p>å¦æç¶æ¯æ¬èº«ææåºå®åæç»´ââä¾å¦ç»å¸¸è¡¨è¾¾"æå°±æ¯ä¸æé¿æ°å­¦"æ"äººèäºå­¦ä¸äºæ°ä¸è¥¿"ââå­©å­å°±ä¼å¨è³æ¿¡ç®æä¸­å¸æ¶è¿äºè§å¿µã</p>
<p>æ´å¾®å¦çæ¯ï¼ç¶æ¯å¦ä½å¯¹å¾èªå·±çéè¯¯åå¤±è´¥ï¼ä¼ç´æ¥å½±åå­©å­å¯¹å¾è¿äºé®é¢çæ¹å¼ãå¦æç¶æ¯å¨ç¯éæ¶è¡¨ç°åºèªè´£ãç¾è»æé²å¾¡ï¼å­©å­å°±ä¼å°è¿äºæç»ªååºæ¨¡å¼ååã</p>
<p>ç¸åï¼å¦æç¶æ¯è½å¤å¹³éå°æ¿è®¤éè¯¯å¹¶è®¨è®ºæ¹è¿æ¹æ³ï¼å­©å­å°±å­¦ä¼äºä»¥æé¿åçæ¹å¼å¯¹å¾å¤±è¯¯ã</p>
<h3 id="å¤§èåè²ä¸è®¤ç¥åå">å¤§èåè²ä¸è®¤ç¥åå</h3>
<p>å¤§èåè²çå¤ææ§ä¸ºçè§£æç»´æ¨¡å¼æä¾äºç¥ç»çç©å­¦çåºç¡ã</p>
<p>åé¢å¶ç®å±ââè´è´£æ§è¡åè½ãè®¡åãå²å¨æ§å¶åæ½è±¡æç»´çå¤§èåºåââæ¯äººç±»å¤§èä¸­æææççåºåä¹ä¸ãå®çåè²ä»éæ¥æå¼å§ï¼ä¸ç´å»¶ç»­å°äºåäºå²å·¦å³ã</p>
<p>è¿æå³çå¹´è½»äººå¨å¤æ­ãè§ååè°èæç»ªæ¹é¢çè½åç¡®å®ä¸æå¹´äººå­å¨å·®å¼ï¼è¿å¨ä¸å®ç¨åº¦ä¸è§£éäºä¸ºä»ä¹éå°å¹´ææ¶ä¼ååºå²å¨çå³å®ãç¶èï¼è¿å¹¶ä¸æå³çå¹´è½»äººçæç»´å°±æ¯åºåçï¼æ°æ°ç¸åï¼éå°å¹´å¤§èçé«åº¦å¯å¡æ§ä½¿å¾è¿ä¸ªé¶æ®µæ¯å¹å»æé¿åæç»´çç»ä½³æ¶æºã</p>
<p>éçå¹´é¾å¢é¿ï¼å¤§èç¡®å®ä¼ç»åä¸äºååï¼æå¹´åï¼å¤§èä»ç¶ä¿æçå¯å¡æ§ï¼å°½ç®¡å¶è¿ä½æ¹å¼ä¸å¹´è½»æ¶æææä¸åã</p>
<p>èå¹´å¤§èå¨æäºæ¹é¢çè³å·æä¼å¿ï¼ç ç©¶è¡¨æï¼èå¹´äººå¨æ´åå¤æä¿¡æ¯ãæç»ªè°èåå©ç¨å·²æç¥è¯æ¹é¢å¾å¾è¡¨ç°åºè²ã</p>
<p>æè°çè®¤ç¥è¡°éå¨å¾å¤§ç¨åº¦ä¸æ¯å¯ä»¥è¢«çæ´»æ¹å¼å ç´ æå½±åçââåæ¬è®¤ç¥æ´»å¨ãç¤¾ä¼åä¸ãä½è²é»ç¼åé¥®é£ç­ãæ´éè¦çæ¯ï¼å¤§èçå¯å¡æ§æ¯åºåç¹å¼æ§çï¼è¿æå³çç¹å®ç±»åçè®­ç»å¯ä»¥å¨ç¸åºåºåå¢å¼ºåè½ï¼å³ä½¿å¨å¶ä»åºåå¯è½åºç°å¹´é¾ç¸å³ååçæåµä¸ä¹æ¯å¦æ­¤ã</p>
<p>å¼å¾å¼ºè°çæ¯ï¼ç¥ç»å¯å¡æ§æ¯ååçãå¤§èä¸ä»ä¼å ä¸ºä¸ä½¿ç¨è"çé"ï¼ä¹ä¼å ä¸ºç§¯æä½¿ç¨èåå±ãè¿è¢«ç§°ä¸º"ç¨è¿åºé"ååï¼å¨è®¤ç¥å¿çå­¦åç¥ç»ç§å­¦ä¸­æçååçå®è¯æ¯æã</p>
<p>æé¿åæç»´æ¬è´¨ä¸æ¯ä¸ç§å¯¹å¤§èå¯å¡æ§çä¿¡å¿µçä¸ç§âå©ç¨âãå½æä»¬ç¸ä¿¡æ¹åæ¯å¯è½çï¼æä»¬å°±ä¼æå¥åªåå»å®ç°æ¹åï¼èè¿ç§æå¥æ¬èº«åä¼ä¿è¿å®éçç¥ç»ååï¼å½¢æè¯æ§å¾ªç¯ã</p>
<h3 id="å¿çé²å¾¡æºå¶ä¸èéåºä¾èµ">å¿çé²å¾¡æºå¶ä¸èéåºä¾èµ</h3>
<p>ä»å¿çå­¦è§åº¦æ¥çï¼åºå®åæç»´å¨å¾å¤§ç¨åº¦ä¸æ¯ä¸ç§é²å¾¡æºå¶ãå®ä¿æ¤æä»¬ååå¤±è´¥åæ«æå¸¦æ¥ççè¦æè§ï¼ç»´æ¤æä»¬çèªæå½¢è±¡åèªå°ã</p>
<p>å½æä»¬å®³æå¤±è´¥æ¶ï¼åºå®åæç»´åè¯æä»¬ï¼"è¿ä¸æ¯çæ­£çæï¼åªæ¯æè¿æ²¡å±ç°åºæçæ½å"ï¼æè"å¦ææå°è¯äºä½å¤±è´¥äºï¼é£æè¯´ææççä¸è¡"ãéè¿åé¿ææï¼æä»¬é¿åäºå¤±è´¥çé£é©ï¼ä½ä¹åæ¶æç»äºæé¿çæºä¼ã</p>
<p>è¿ç§é²å¾¡æºå¶å¨ç­æåç¡®å®è½å¤åå°ç¦èåä¸éï¼ä½å¨é¿æä¸­å´å¯¼è´äºè½åçåæ»åæ½åçæµªè´¹ã</p>
<p>èéåºæ¯å¦ä¸ä¸ªéè¦çæ¦å¿µãæä»¬é½æä¸ç§å¾åï¼å°±æ¯åçå¨è®©æä»¬æå°å®å¨åçæçèå´åã</p>
<p>è¿ç§å¾åæ¬èº«å¹¶éé®é¢ï¼å®æ¯äººç±»è¿åè¿ç¨ä¸­å½¢æçæ­£å¸¸æºå¶ââå¨è¿å¤æ¶ä»£ï¼åé©ç¦»å¼çæçç¯å¢å¾å¾æå³çå±é©ã</p>
<p>ç¶èï¼å¨ç°ä»£ç¤¾ä¼ä¸­ï¼è¿åº¦ä¾èµèéåºä¼å¯¼è´æé¿åæ»ã</p>
<p>èéåºçé®é¢ä¸å¨äºå®æ¬èº«ï¼èå¨äºæä»¬ç¨å®ä½ä¸ºåé¿æé¿ææçåå£ãæä»¬å¯è½æ»¡è¶³äºå¤ç¨çæè½ï¼åé¿ç²¾éæéçå¤§éç»ä¹ ï¼æ»¡è¶³äºè¿å¾å»çå³ç³»ï¼åé¿å»ºç«æ´æ·±è¿æ¥æéçèå¼±åå¦è¯ï¼æ»¡è¶³äºå¯è¡çè§£å³æ¹æ¡ï¼åé¿å¯»æ¾æ´ä¼æ¹æ¡æéçåæ°åé£é©æ¿æã</p>
<p>èº«ä»½è®¤åçåºåæ¯åºå®åæç»´çæ·±å±è¡¨ç°ã</p>
<p>å½æä»¬å°èªå·±å®ä¹ä¸º"ææ¯æç§äºº"æ¶ï¼è¿ç§å®ä¹å°±æä¸ºäºèªæéå¶çæ¡æ¶ã"ææ¯ä¸ä¸ªä¸æé¿æ°å­¦çäºº"ã"ææ¯ä¸ä¸ªååçäºº"ã"ææ¯ä¸ä¸ªæ²¡æåé åçäºº"ââè¿äºèªæå®ä¹ä¸æ¦å½¢æï¼å°±ä¼æå¯¼æä»¬éæ©æ§å°æ¥è§¦é£äº"ç¬¦å"æä»¬èº«ä»½çä¿¡æ¯åç»éªï¼åé¿é£äºå¯è½æææä»¬èº«ä»½çå¯è½æ§ã</p>
<p>æé¿åæç»´è¦æ±æä»¬æç ´è¿ç§èº«ä»½åºåï¼è®¤è¯å°èº«ä»½ä¸æ¯åºå®çæ ç­¾ï¼èæ¯å¯ä»¥ä¸æ­æ©å±åéæ°å®ä¹çã</p>
<h2 id="äºæä¹çªç ´éç¢æåªäºæ¹æ³">äºï¼æä¹çªç ´éç¢ï¼æåªäºæ¹æ³ï¼</h2>
<h3 id="è®¤ç¥éæä»åå¨å¯¹è¯å¼å§">è®¤ç¥éæï¼ä»åå¨å¯¹è¯å¼å§</h3>
<p>æé¿åæç»´çæ ¸å¿å¨äºæä»¬å¦ä½è§£è¯»èªå·±çç»åââç¹å«æ¯é£äºå°é¾åææçæ¶å»ã</p>
<p>è®¤ç¥éææ¯ä¸ç§ç³»ç»æ§çæ¹æ³ï¼å¸®å©æä»¬è¯å«åæ¹åé£äºå¼ºååºå®åæç»´çåå¨å¯¹è¯ã</p>
<p>è¿ä¸ªè¿ç¨å§äºå¯¹èªææç»´çè§å¯ãæä»¬éè¦å­¦ä¼æ³¨æå°èªå·±ä»ä¹æ¶åå¨ä½¿ç¨åºå®åæç»´çè¯­è¨ââ"æå°±æ¯ä¸æé¿è¿ä¸ª"ã"è¿è¯ææä¸è¡"ã"å¦ææå°è¯äºä½å¤±è´¥äºå¤ªä¸¢äººäº"ãä¸æ¦è¯å«åºè¿äºæç»´æ¨¡å¼ï¼æä»¬å°±å¯ä»¥ææè¯å°ææåéæå®ä»¬ã</p>
<p>è®¤ç¥éæçå·ä½ææ¯åæ¬å ä¸ªå±æ¬¡ã</p>
<ul>
<li>
<p>é¦åæ¯è¯æ®æ£éªââå½æä»¬äº§ç"æä¸æé¿è¿ä¸ª"çæç»´æ¶ï¼é®èªå·±ï¼è¿ä¸ªç»è®ºçè¯æ®æ¯ä»ä¹ï¼æä»ä¹è¯æ®ä¸è¿ä¸ªç»è®ºçç¾ï¼éå¸¸æä»¬ä¼åç°ï¼åºå®åæç»´çç»è®ºæ¯åºäºå°æ°è´é¢ç»åï¼èå¿½è§äºæ­£é¢ç»ååæ¹åçå¯è½æ§ã</p>
</li>
<li>
<p>å¶æ¬¡æ¯å½å éå¡ââå°å¤±è´¥å½å äºå¯æ§å ç´ ï¼å¦åªåç¨åº¦ãç­ç¥éæ©ï¼èéä¸å¯æ§å ç´ ï¼å¦å¤©èµãè¿æ°ï¼ï¼è¿æ ·å¤±è´¥å°±åæäºå¯ä»¥æ¹è¿çé®é¢ï¼èéåºå®çèº«ä»½ç¹å¾ã</p>
</li>
<li>
<p>ç¬¬ä¸æ¯æ¡æ¶è½¬æ¢ââå°"æåä¸å°"è½¬æ¢ä¸º"æææ¶è¿åä¸å°"ï¼å°"è¿å¤ªé¾äº"è½¬æ¢ä¸º"è¿éè¦æ´å¤æ¶é´åç»ä¹ "ï¼å°"å¤±è´¥æ¯åäº"è½¬æ¢ä¸º"å¤±è´¥æä¾äºå­¦ä¹ çæºä¼"ã</p>
</li>
</ul>
<p>å»ºç«æ¯ææ§çèªæå¯¹è¯æ¯è®¤ç¥éæçæç»­å®è·µã</p>
<p>å½æä»¬ç¯éæéå°å°é¾æ¶ï¼åå¨çæ¹è¯å£°é³å¾å¾ä¼å å§çè¦åé²å¾¡ï¼èé¼å±åæ¯æçå£°é³åè½ä¿è¿å­¦ä¹ åæé¿ãæé¿åæç»´è¦æ±æä»¬å°è¿ç§æ¯ææ§çå£°é³ååï¼æä¸ºé¢å¯¹æææ¶çé»è®¤ååºãè¿éè¦å»æç»ä¹ ï¼å°±åå¹å»ä»»ä½æ°ä¹ æ¯ä¸æ ·ã</p>
<h3 id="è¡ä¸ºæ¹åè¡å¨å¡é æç»´">è¡ä¸ºæ¹åï¼è¡å¨å¡é æç»´</h3>
<p>æç»´åè¡å¨æ¯ç¸äºå½±åçââæ¹åå¶ä¸­ä¸ä¸ªå¾å¾ä¼å¯¼è´å¦ä¸ä¸ªçæ¹åãä»ä»å¨è®¤ç¥ä¸çè§£æé¿åæç»´æ¯ä¸å¤çï¼æä»¬éè¦éè¿è¡ä¸ºæ¥å¼ºååæ·±åå®ã</p>
<p>éæ©æææ§ä»»å¡æ¯å¹å»æé¿åæç»´æç´æ¥çè¡ä¸ºæ¹å¼ãå½æä»¬ä¸»å¨éæ©é£äºéè¦åªåååææè½å®æçä»»å¡æ¶ï¼æä»¬å°±å¨ç¨è¡å¨åèªå·±è¯æï¼è½åæ¯å¯ä»¥åå±çï¼åªåæ¯ææçãè¿ç§è¡ä¸ºäº§ççæ°æ®æ¯ä»»ä½è¨è¯­é½æ´æè¯´æåã</p>
<p>å·ä½æ¥è¯´ï¼å¯ä»¥ä»å°å¤å¼å§ãéæ©ä¸ä¸ªä½ è®¤ä¸ºèªå·±"ä¸æé¿"çé¢åï¼æå¥æ¶é´åç²¾åå»å­¦ä¹ åç»ä¹ ãæ³¨æè§å¯è¿ä¸ªè¿ç¨ä¸­çååââæåçæè§ãéæ¸çè¿æ­¥ãéå°çå°é¾åçªç ´ã</p>
<p>è¿ç§äº²èº«ä½éªæ¯çè®ºæ´è½è¯´æä½ ï¼è½åç¡®å®æ¯å¯ä»¥åå±çãéè¦çæ¯éæ©éåº¦ææçä»»å¡ââå¤ªå®¹æçä»»å¡æ æ³ä¿è¿æé¿ï¼å¤ªé¾çä»»å¡å¯è½å¯¼è´æ«è´¥ãæä½³çéæ©æ¯é£äºéè¦åªåä½ä¸æ¯ä¸å¯è½å®æçä»»å¡ã</p>
<p>å»ºç«åé¦å¾ªç¯æ¯å¦ä¸ä¸ªéè¦çè¡ä¸ºç­ç¥ãæé¿åæç»´éè¦åæ¶ãåç¡®çåé¦æ¥è°æ´åªåçæ¹åãä»ä»åªåæ¯ä¸å¤çââæä»¬éè¦ç¥éåªåæ¯å¦ææï¼åªééè¦è°æ´ã</p>
<p>è¿æå³çä¸»å¨å¯»æ±åé¦ï¼æ è®ºæ¯æ¥èªèå¸ãåäºãæåè¿æ¯èªæåæãè®°å½è¿å±ãåé¡¾ç®æ è¾¾ææåµãè¯å®å°è¯ä¼°èªå·±çè¡¨ç°ââè¿äºé½æ¯å»ºç«ææåé¦å¾ªç¯çæ¹æ³ãæ²¡æåé¦ï¼æä»¬å¯è½åªæ¯å¨éå¤æ æçåªåï¼æèéè¿äºæ¹è¿çæºä¼ã</p>
<h3 id="ä¹ æ¯å»æå°æé¿ä¹ æ¯å">ä¹ æ¯å»æï¼å°æé¿ä¹ æ¯å</h3>
<p>æé¿åæç»´å¦æåªæ¯å¶å°çè§æï¼å¶æææ¯æéçã</p>
<p>çæ­£çæä¹æ¹åéè¦å°æé¿åæç»´è½¬åä¸ºèªå¨çä¹ æ¯ãè¿éè¦çè§£ä¹ æ¯çè¿ä½æºå¶ââä¹ æ¯ç±è§¦åãè¡ä¸ºåå¥å±ä¸é¨åç»æãè®¾è®¡æ¯ææé¿åæç»´çä¹ æ¯ï¼æå³çå°æé¿å¯¼åçè¡ä¸ºä¸ç§¯æçææä½éªèç³»èµ·æ¥ï¼ä½¿å¶éæ¸èªå¨åã</p>
<p>å·ä½çæ¹æ³åæ¬å»ºç«å®æåæçä¹ æ¯ã</p>
<p>æ¯å¨ææ¯æè±æ¶é´åé¡¾èªå·±çå­¦ä¹ åæé¿ï¼éå°äºä»ä¹ææï¼ä»ä¸­å­¦å°äºä»ä¹ï¼ä¸æ¬¡å¯ä»¥å¦ä½æ¹è¿ï¼è¿ç§åæä¸ä»æä¾åé¦ï¼è¿å¼ºåäºæé¿æ¯éè¦çãå¼å¾å³æ³¨çè¿ä¸ä¿¡å¿µã</p>
<p>è®°å½æé¿æ¥å¿ä¹æ¯ç±»ä¼¼çæ¹æ³ââè®°å½é£äºå°é¾æ¶å»ãå¦ä½åºå¯¹çãä»ä¸­è·å¾äºä»ä¹ãè¿äºè®°å½æä¸ºå¯è§çæé¿è¯æ®ï¼å¯ä»¥ç¨æ¥å¯¹æåºå®åæç»´çæ¶æç»è®ºã</p>
<p>å°æé¿è¯­è¨èå¥æ¥å¸¸äº¤æµä¹å¾éè¦ã</p>
<p>æ³¨æèªå·±ä½¿ç¨çè¯­è¨ï¼ç¹å«æ¯å¯¹ä»äººï¼ç¹å«æ¯å­©å­åå­¦çï¼çåé¦ãç¨"ä½ éè¿åªåæé«äº"ä»£æ¿"ä½ çèªæ"ï¼ç¨"ä½ è¿æ²¡ææ¡è¿ä¸ªæå·§ï¼ä½æä»¬ä¸èµ·æ¥æ¾æ¹æ³"ä»£æ¿"ä½ ä¸è¡"ã</p>
<p>è¿ç§è¯­è¨ä¸ä»å½±åä»äººï¼ä¹éæ¸æ¹åèªå·±çæç»´ä¹ æ¯ãå¨å­©å­æè²ä¸­ï¼è¿ä¸ç¹å°¤ä¸ºéè¦ââç¶æ¯åèå¸ä½¿ç¨çè¯­è¨ç±»åå¯ä»¥å¡é å­©å­çæç»´æ¨¡å¼ã</p>
<h3 id="ç¯å¢è®¾è®¡åé æ¯ææ§çæç³»ç»">ç¯å¢è®¾è®¡ï¼åé æ¯ææ§çæç³»ç»</h3>
<p>ç¯å¢å¯¹æç»´æ¨¡å¼çå½±åå¾å¾è¢«ä½ä¼°ã</p>
<p>æä»¬æå¤çç©çç¯å¢ãç¤¾äº¤ç¯å¢åæåç¯å¢æç»­ä¸æ­å°åæä»¬ä¼ éä¿¡æ¯ï¼å½±åæä»¬çæç»´åè¡ä¸ºã</p>
<p>è®¾è®¡ä¸ä¸ªæ¯ææé¿åæç»´çç¯å¢ï¼æå³çææè¯å°åé é£äºé¼å±å­¦ä¹ ãæ¥åææãéè§æé¿çæ¡ä»¶ãè¿ä¸ä»åæ¬ç©çç¯å¢çå®æï¼æ´éè¦çæ¯ç¤¾äº¤ç¯å¢çæå»ºã</p>
<p>ç©çç¯å¢çè®¾è®¡å¯ä»¥ä¿è¿æé¿åæç»´ãå±ç¤ºèªå·±æä»äººæé¿è¿ç¨çç©åï¼å¦æ©æçä½ååç°å¨çä½åçå¯¹æ¯ï¼ãæ¾ç½®æ¿å±æ§çä¹¦ç±åèµæãåé å¯ä»¥ä¸æ³¨å­¦ä¹ ååé çç©ºé´ââè¿äºé½å¨æ å½¢ä¸­ä¼ éçæé¿çä¿¡æ¯ãç¸åï¼è¿åå¼ºè°æå°±åæåçç¯å¢å¯è½å¼ºååºå®åæç»´ï¼å ä¸ºå®ä»¬å¼ºè°çæ¯ç»æèéè¿ç¨ã</p>
<p>ç¤¾äº¤ç¯å¢çè®¾è®¡åæ ·å³é®ãå¯»æ¾åå»ºç«é£äºéè§æé¿ãæ¯ææ¹åçç¤¾ç¾¤ââå­¦ä¹ å°ç»ãå´è¶£ç¤¾ç¾¤ãå¯¼å¸å³ç³»ç­ãå¨è¿äºç¤¾ç¾¤ä¸­ï¼åäº«å°é¾åå¤±è´¥æ¯è¢«é¼å±çï¼åªååè¿æ­¥æ¯è¢«è®¤å¯çï¼æ°å°è¯æ¯è¢«æ¯æçãç¸åï¼é£äºå¼ºåæ¯è¾ãç«äºåèªææ ç­¾çç¤¾äº¤ç¯å¢ä¼å¼ºååºå®åæç»´ã</p>
<h2 id="å­ç»èº«æé¿ä¸æä¹">å­ï¼ç»èº«æé¿ä¸æä¹</h2>
<h3 id="æ´å¤§è§è§ä¸çç»èº«æé¿">æ´å¤§è§è§ä¸çç»èº«æé¿</h3>
<p>æé¿åæç»´ä¸æ¯ä¸ä¸ªéè¦å¨æä¸ªå¹´é¾é¶æ®µå®æçä»»å¡ï¼èæ¯è´¯ç©¿æ´ä¸ªçå½å¨æçæç»­å®è·µã</p>
<p>çæ­£çè§£æé¿åæç»´æå³çè®¤è¯å°ï¼æ è®ºå¤äºä»ä¹å¹´é¾ï¼æ è®ºå·²ç»åå¾äºä»ä¹æå°±ï¼æ»ææ´å¤å¯ä»¥å­¦ä¹ ãåå±åè´¡ç®çç©ºé´ã</p>
<p>è¿ç§è®¤è¯æ¬èº«å°±å·æè§£æ¾æ§ââå®è§£é¤äº"å·²ç»å¤ªæäº"æ"å·²ç»è¶³å¤å¥½äº"çèªæéå¶ï¼è®©çå½ä¿æå¼æ¾åå¯è½ã</p>
<p>ä»æ´åçè§è§æ¥çï¼äººççåä¸ªé¶æ®µä¸æ¯å½¼æ­¤å²è£çï¼èæ¯ç¸äºèç³»ãç¸äºä¸°å¯çã</p>
<p>éå¹´æ¶æçç­æååé©ãä¸­å¹´æ¶æçæ·±åº¦åæºæ§ãèå¹´æ¶æçæ²æ·åè¶è¶ââè¿äºåè´¨å¯ä»¥ç¸äºæ¸éï¼åé åºç¬ç¹ççå½å½¢æã</p>
<p>ä¸ä¸ªæ¥ææé¿åæç»´çå¹´è½»äººå¯ä»¥å¹å»èå¹´äººçæ²ç¨³åè¿è§ï¼ä¸ä¸ªæ¥ææé¿åæç»´çä¸­å¹´äººå¯ä»¥ä¿æå¹´è½»äººçå¥½å¥åå¼æ¾ï¼ä¸ä¸ªæ¥ææé¿åæç»´çèå¹´äººå¯ä»¥è´¡ç®å¹´è½»äººçæ´»åååé åã</p>
<p>è¿ç§è·¨å¹´é¾çåè´¨æ´åï¼æ¯æé¿åæç»´å¨çå½å±é¢çæé«ä½ç°ã</p>
<h3 id="æé¿åæç»´ä¸æä¹å»ºæ">æé¿åæç»´ä¸æä¹å»ºæ</h3>
<p>æé¿åæç»´çæ·±å±ä»·å¼ä¸ä»å¨äºæé«è½ååæå°±ï¼æ´å¨äºå»ºæææä¹çäººçã</p>
<p>å½æä»¬ç¸ä¿¡æ¹åæ¯å¯è½çï¼æä»¬å°±ä¸ä¼è¢«å½åçå°å¢æå®ä¹ï¼å°±è½å¤çå°æªæ¥çå¯è½æ§ï¼å°±æè½åå¨å°é¾ä¸­æ¾å°æä¹ã</p>
<p>è¿ç§æä¹å»ºæçè½åæ¯å¿çå¥åº·åäººçæ»¡æåº¦çæ ¸å¿è¦ç´ ãç ç©¶è¡¨æï¼é£äºè½å¤å¨æ«æä¸­å¯»æ¾æä¹çäººï¼æ¯é£äºåªå³æ³¨ç»æçäººæ´æå¯è½ä»éå¢ä¸­æ¢å¤ï¼å¹¶å¨é¿æä¸­åå¾æ´å¥½çç»æã</p>
<p>æé¿åæç»´ä¹æå³çå¯¹çå½æ¬èº«çå¼æ¾æåº¦ã</p>
<p>æ¯ä¸ä¸ªäººçé¶æ®µé½æå¶ç¬ç¹çææåæºéï¼æ¯ä¸ä¸ªç»åââæ è®ºæ¯æåçè¿æ¯å¤±è´¥çââé½å¯ä»¥æä¸ºæé¿çç´ æãå½æä»¬ç¨è¿ç§ç¼åçå¾çæ´»æ¶ï¼çæ´»å°±ä¸åæ¯å¿é¡»ç¬è¿å»çé¶æ®µï¼èæ¯å¼å¾æ´»åºæ¥çæç¨ãè¿ç§æåº¦ä¸æ¯ç²ç®çä¹è§ï¼èæ¯åºäºå¯¹äººç±»æ½åçæ·±å»çè§£åä¿¡ä»»ã</p>
<h2 id="ä¸æåéæ°å®ä¹å¯è½æ§">ä¸ï¼æåï¼éæ°å®ä¹å¯è½æ§</h2>
<p>"è¶èè¶åºæ§"ä¸å¶è¯´æ¯ä¸ä¸ªä¸å¯é¿åçççå½è¿ï¼ä¸å¦è¯´æ¯ä¸ä¸ªèªæå®ç°çé¢è¨ã</p>
<p>å®ä¹æä»¥æµè¡ï¼æ¯å ä¸ºå®åæ äºè®¸å¤äººççå®ä½éªââä»ä»¬ç¡®å®æå°éçå¹´é¾å¢é¿ï¼æ¹ååå¾æ´å å°é¾ãç¶èï¼è¿ç§ä½éªçåå æ¯å¤æçï¼å¯è½åæ¬ä¹ æ¯çå¼ºåãèº«ä»½çåºåãç¤¾ä¼ææçååï¼ä»¥åå¤§èæäºå å·¥éåº¦çèªç¶ååãä½è¿äºåå å¹¶ä¸æå³çæé¿åæç»´æ¯ä¸å¯è½çï¼å®ä»¬åªæ¯æå³çæä»¬éè¦æ´å»æå°å¹å»åé»ç¼è¿ç§æç»´æ¨¡å¼ã</p>
<p>æé¿åæç»´æ¯ä¸ç§éæ©ââéæ©ç¸ä¿¡æ¹åæ¯å¯è½çï¼éæ©å°ææè§ä¸ºæºä¼ï¼éæ©ç¨è¿ç¨èéç»ææ¥å®ä¹èªå·±ãè¿ç§éæ©ä¸åå¹´é¾éå¶ãè½ç¶ä¸åå¹´é¾é¶æ®µé¢ä¸´çææä¸åï¼ä½æé¿çå¯è½æ§æ¯æ®éçãä¸ä¸ªäºåå²çäººå¯ä»¥éæ©ç»´æç°ç¶ï¼æç»å­¦ä¹ åæ¹åï¼ä¸ä¸ªä¸åå²çäººå¯ä»¥éæ©æ¥æ±æ°äºç©ï¼æç»­æé¿ååå±ãå³å®å ç´ ä¸æ¯å¹´é¾ï¼èæ¯å¯¹æé¿çæåº¦åæ¿è¯ºã</p>
<p>æç»ï¼æé¿åæç»´æ¯ä¸ç§å³äºäººçå¯è½æ§çä¿¡å¿µã</p>
<p>å®åè¯æä»¬ï¼äººä¸åºè¯¥è¢«ä»»ä½æ ç­¾æå®ä¹ââæ è®ºè¿ä¸ªæ ç­¾æ¯å¹´é¾ãè½åãèæ¯è¿æ¯è¿å»çç»åãè¿ç§ä¿¡å¿µä¸æ¯å¦è®¤éå¶ï¼èæ¯ç¸ä¿¡å¨éå¶ä¹ååä¹å¤ï¼é½å­å¨çæªè¢«åæçæ½åã</p>
<p>å¹å»åç»´ææé¿åæç»´ï¼å°±æ¯éæ©æ´»å¨è¿ç§å¯è½æ§çç©ºé´ä¸­ï¼ä¸æ­æ©å±èªå·±çè¾¹çï¼åæ¶æ¥çº³åçè§èªå·±ç¬ç¹ççå½æç¨ãå¨è¿ä¸ªæä¹ä¸ï¼æé¿åæç»´ä¸ä»æ¯ä¸ç§è®¤ç¥ç­ç¥ï¼æ´æ¯ä¸ç§çå½æåº¦ââä¸ç§å¯¹çå½çå¼æ¾ãå¥½å¥ååæ¢çæåº¦ã</p>
<h2 id="åè">åè</h2>
<ul>
<li>ãç»èº«æé¿ã<a href="https://book.douban.com/subject/27154533/" target="_blank" rel="noopener nofollow">https://book.douban.com/subject/27154533/</a></li>
<li>ãä¸å¼ºå¿çç¶æ¯ï¼æè²å­©å­è¦æå¿çå­¦ã<a href="https://book.douban.com/subject/37233750/" target="_blank" rel="noopener nofollow">https://book.douban.com/subject/37233750/</a></li>
<li>ãè®¤ç¥è§éã<a href="https://book.douban.com/subject/35193035/" target="_blank" rel="noopener nofollow">https://book.douban.com/subject/35193035/</a></li>
<li>å¦ä½ä»åºå®åæç»´è½¬åä¸ºæé¿åæç»´ï¼-ç¥ä¹é®ç­ï¼<a href="https://www.zhihu.com/question/21099982" target="_blank" rel="noopener nofollow">https://www.zhihu.com/question/21099982</a></li>
<li>ãå¯å¡çæï¼èªæåå±å¿çå­¦ç35å å¿ä¿®è¯¾ã<a href="https://book.douban.com/subject/35388653/" target="_blank" rel="noopener nofollow">https://book.douban.com/subject/35388653/</a></li>
</ul>

</div>
<div id="MySignature" role="contentinfo">
    == just do it ==
</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.052083333333333336" data-date-updated="2026-01-12 19:40">2026-01-12 18:25</span>&nbsp;
<a href="https://www.cnblogs.com/jiujuan">ä¹å·</a>&nbsp;
éè¯»(<span id="post_view_count">82</span>)&nbsp;
è¯è®º(<span id="post_comment_count">1</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19473443);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19473443', targetLink: 'https://www.cnblogs.com/jiujuan/p/19473443', title: 'ä¸ºä»ä¹æçäººè¯´âè¶èæç»´è¶åºåâï¼æä¹æè½å·å¤æé¿åæç»´ï¼' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ åºäº nano-vLLM å­¦ä¹ å¤§æ¨¡åæ¨çå³é®åè½ ]]></title>
    <link>https://www.cnblogs.com/cswuyg/p/19471225</link>
    <guid>bf8764e806e486971452e1672f4b5754</guid>
    <description>
    <![CDATA[ 
	<div class="postTitle">
		<h1><a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/cswuyg/p/19471225" title="åå¸äº 2026-01-12 12:38">
    <span role="heading" aria-level="2">åºäº nano-vLLM å­¦ä¹ å¤§æ¨¡åæ¨çå³é®åè½</span>
    

</a>
</h1>
	</div>
	<div id="cnblogs_post_body" class="blogpost-body blogpost-body-html">
<blockquote>æ³¨ï¼æ¬æå·²äº2025.12.31 åè¡¨äºç¥ä¹åå¬ä¼å·</blockquote>
<h1 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="avn4e-0-0"><span data-offset-key="avn4e-0-0">1. èæ¯</span></h1>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="7ouoo-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="7ouoo-0-0"><span data-offset-key="7ouoo-0-0">å¦æè¦åä¸ä½å®å¨ä¸äºè§£å¤§æ¨¡åæ¨çææ¯çå¼åèä»ç»è¿ä¸ªé¢åï¼æåºè¯¥ä»åªéè®²èµ·ï¼</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="6ps33-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="6ps33-0-0"><span data-offset-key="6ps33-0-0">å¤§æ¨¡åæ¨ççæç®æµç¨å¯ä»¥æ¦æ¬ä¸ºï¼è¾å¥ä¸ä¸²ææ¬ â ææ¬éè¿è¯å¸æ å°è¡¨è½¬æ¢æä¸ä¸²æ°å­åºå· â åºå·åç»è¿ embedding å±çè®¡ç®ï¼åæä¸ç»è½ä»£è¡¨è¯­ä¹çæµ®ç¹æ°åé â è¿ç»åééå¥æ¨çç³»ç»ï¼ç»è¿å±å±çç©éµä¹æ³ãå æ³ååç±»ä¸ç¨å½æ°çè¿ç®ï¼å¾å°æ°çè¾åºåé â å¯¹è¾åºåéåæ¦çç­éï¼éåºæ¦çæé«çé£ä¸ªæ°å¼å¯¹åºçåºå· â æååéè¿è¯å¸æ å°è¡¨ âç¿»è¯â åæå­ï¼å¾å°æç»è¾åºçä¸ä¸ªè¯ã</span></div>
</div>
<div class="Image-captionContainer" data-size="normal">
<div class="Image-resizerContainer css-ym3v7r" data-size="normal">
<div class="css-79elbk">
<div class="ImageDelete-Container css-xi606m">
<div class="ImageDelete-Wrapper css-1gomreu"><img src="https://pic1.zhimg.com/80/v2-52738e1009b99b73843b74399250f825_1440w.png?source=ccfced1a" width="877" height="204" class="Image FocusPlugin--unfocused Image--isBlock css-1phd9a0" loading="lazy" style="display: block; margin-left: auto; margin-right: auto" data-size="normal" data-rawwidth="2052" data-rawheight="478" data-watermark="original" data-original-src="https://picx.zhimg.com/v2-52738e1009b99b73843b74399250f825.jpg?source=ccfced1a" data-watermark-src="https://pic1.zhimg.com/v2-9a8c84bc6a77d0b121efaf2adca21dc7_1440w.jpg?source=ccfced1a">
<div class="ImageEdit-button css-187js3w" style="text-align: center">å¾ 1&nbsp;</div>
<div class="ImageEdit-button css-187js3w"><span data-offset-key="5galm-0-0">è¿æ¯å¯¹å¤§æ¨¡åæ¨çææ´ç´ ççè§£ï¼ä¸è¿°æµç¨çä¼¼ç®åï¼ä½èåçæ¨çè®¡ç®ç¯èå¯¹æ®éå¼åèèè¨ä»æ¯ä¸ä¸ª âé»çâãå¦ææ³æ´è¿ä¸æ­¥æè§£æ¨çå¼æçåºå±å éåçï¼nano-vllm ä¼æ¯ä¸ä¸ªæä½³çå¥é¨åå¥ç¹ã</span></div>
</div>
</div>
</div>
</div>
</div>
<h1 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="5jkt4-0-0"><span data-offset-key="5jkt4-0-0">2. ç®ä»</span></h1>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="34rn0-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="34rn0-0-0"><a class="Link ztext-link" href="https://github.com/GeeeekExplorer/nano-vllm" target="_blank" data-offset-key="34rn0-0-0" data-editable="true" data-draft-title="nano-vLLM" rel="noopener nofollow">nano-vLLM</a><span data-offset-key="34rn0-1-0"> ä»£ç éä»çº¦ 1200 è¡ï¼å´å®ç°äºçäº§çº§æ¨çæ¡æ¶çæ ¸å¿ææ¯ååï¼å·ä½åæ¬ï¼</span></div>
</div>
<ul class="public-DraftStyleDefault-ul" data-offset-key="56lsc-0-0">
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-reset public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="56lsc-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="56lsc-0-0"><span data-offset-key="56lsc-0-0">è¿ç»­æ¹å¤çï¼Continuous Batchingï¼</span></div>
</li>
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="b1vo5-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="b1vo5-0-0"><span data-offset-key="b1vo5-0-0">KV ç¼å­ï¼Prefix KV Cache / Paged KV Cacheï¼</span></div>
</li>
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="fckbm-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="fckbm-0-0"><span data-offset-key="fckbm-0-0">é«æ§è½ç¼è¯ä¸æ§è¡ä¼åï¼Torch CompilationãTritonãCUDA Graphï¼</span></div>
</li>
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="96skh-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="96skh-0-0"><span data-offset-key="96skh-0-0">å¼ éå¹¶è¡ï¼Tensor Parallelismï¼</span></div>
</li>
</ul>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="etuu5-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="etuu5-0-0"><span data-offset-key="etuu5-0-0">è¯¥æ¡æ¶æå·å¥é¨å­¦ä¹ ä»·å¼ï¼æ¬æå°åä»ç» nano-vLLM çåºæ¬ç»ææ¶æï¼åå¯¹é¨åæ ¸å¿ææ¯è¦ç¹å±å¼æ·±å¥è§£æã</span></div>
</div>
<h1 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="dhpij-0-0"><span data-offset-key="dhpij-0-0">3. ç³»ç»æ¶æ</span></h1>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="9fnhn-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="9fnhn-0-0"><span data-offset-key="9fnhn-0-0">nano-vLLM çæ¶æéå¸¸æå±æ¬¡æã</span></div>
</div>
<h2 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="6ai7a-0-0"><span data-offset-key="6ai7a-0-0">3.1. æ´ä½æ¶ææ¦è§</span></h2>
<div class="Image-captionContainer" data-size="normal">
<div class="Image-resizerContainer css-ym3v7r" data-size="normal">
<div class="css-79elbk">
<div class="ImageDelete-Container css-xi606m">
<div class="ImageDelete-Wrapper css-1gomreu"><img src="https://picx.zhimg.com/80/v2-41cd766bd06373d580df6302b2ba3203_1440w.png?source=ccfced1a" width="655" height="403" class="Image FocusPlugin--unfocused Image--isBlock css-1phd9a0" loading="lazy" style="display: block; margin-left: auto; margin-right: auto" data-size="normal" data-rawwidth="1846" data-rawheight="1136" data-watermark="original" data-original-src="https://picx.zhimg.com/v2-41cd766bd06373d580df6302b2ba3203.jpg?source=ccfced1a" data-watermark-src="https://pic1.zhimg.com/v2-30e994f5b2ec017f3337ad91f566eb88_1440w.jpg?source=ccfced1a">
<div class="ImageEdit-button css-187js3w" style="text-align: center">å¾ 2, æ¥èªï¼https://deepwiki.com/GeeeekExplorer/nano-vllm</div>
</div>
</div>
</div>
</div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="3rfae-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="3rfae-0-0"><span data-offset-key="3rfae-0-0">ä¸å±ç»æ</span></div>
</div>
<ul class="public-DraftStyleDefault-ul" data-offset-key="b0vi3-0-0">
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-reset public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="b0vi3-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="b0vi3-0-0"><span data-offset-key="b0vi3-0-0">æ¥å£å±ï¼User Interface Layer</span></div>
</li>
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="510uv-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="510uv-0-0"><span data-offset-key="510uv-0-0">æ¨çå¼æä¸­æ§å±ï¼Inference Engine Layer</span></div>
</li>
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="2ao8p-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="2ao8p-0-0"><span data-offset-key="2ao8p-0-0">æ¾å­ç®¡çåæ¨¡åæ§è¡å±ï¼Memory Management &amp; Model Execution Layer</span></div>
</li>
</ul>
<h2 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="4o3ac-0-0"><span data-offset-key="4o3ac-0-0">3.2. ç±»å±é¢æ¶æ</span></h2>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="7vkaq-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="7vkaq-0-0"><span data-offset-key="7vkaq-0-0">ä»ç±»è®¾è®¡å±é¢è§å¯ nano-vLLM çæ¶æã</span></div>
</div>
<div class="Image-captionContainer" data-size="normal">
<div>
<div class="Image-resizerContainer css-ym3v7r" data-size="normal">
<div class="css-79elbk">
<div>
<div class="ImageDelete-Container css-xi606m">
<div class="ImageDelete-Wrapper css-1gomreu"><img src="https://pic1.zhimg.com/80/v2-8612f2dcf6e20d6dd1fccb4ebb494bd2_1440w.png?source=ccfced1a" width="409" height="433" class="Image FocusPlugin--unfocused Image--isBlock css-1phd9a0" loading="lazy" style="display: block; margin-left: auto; margin-right: auto" data-size="normal" data-rawwidth="841" data-rawheight="891" data-watermark="original" data-original-src="https://pic1.zhimg.com/v2-8612f2dcf6e20d6dd1fccb4ebb494bd2.jpg?source=ccfced1a" data-watermark-src="https://picx.zhimg.com/v2-3a6dff4e142735a4f58fc285f1b2f992_1440w.jpg?source=ccfced1a">
<div class="ImageEdit-button css-187js3w" style="text-align: center">&nbsp;</div>
<div class="ImageDelete-button css-5sjb75" style="text-align: center">&nbsp;å¾ 3</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="ar0pl-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="ar0pl-0-0"><span data-offset-key="ar0pl-0-0">ä¸å¾ä¸­åç§é¢è²ä»£è¡¨ç³»ç»çåä¸ªç»æé¨å</span></div>
</div>
<ul class="public-DraftStyleDefault-ul" data-offset-key="en3rk-0-0">
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-reset public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="en3rk-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="en3rk-0-0"><span data-offset-key="en3rk-0-0">æµèè²ï¼å¥å£åæ¨çå¼æä¸­æ§å±</span></div>
</li>
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="13d2e-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="13d2e-0-0"><span data-offset-key="13d2e-0-0">æµç»¿è²ï¼æ¨¡åæ¨ç</span></div>
</li>
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="5cb7v-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="5cb7v-0-0"><span data-offset-key="5cb7v-0-0">æµçº¢è²ï¼KV Cache ç®¡ç</span></div>
</li>
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="56eii-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="56eii-0-0"><span data-offset-key="56eii-0-0">æµç´«è²ï¼æéå è½½åç©éµè®¡ç®çå°è£</span></div>
</li>
</ul>
<h2 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="7a956-0-0"><span data-offset-key="7a956-0-0">3.3. æºç å±é¢åå</span></h2>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="44m2c-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="44m2c-0-0"><span data-offset-key="44m2c-0-0">æºç è§åä¸ä¹è¾ä¸ºç®æ´ãç®å½ç»æå¦ä¸ï¼</span></div>
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="44m2c-0-0">
<div class="cnblogs_Highlighter">
<pre class="brush:bash;gutter:true;">nanovllm/
âââ engine
âââ layers
âââ models
âââ utils</pre>
</div>
</div>
</div>
<ul class="public-DraftStyleDefault-ul" data-offset-key="lkpt-0-0">
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-reset public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="lkpt-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="lkpt-0-0"><span data-offset-key="lkpt-0-0">engineï¼å¼æçå¥å£ãä¸­æ§ï¼åæ¶ KV Cache æ¯è¾ç®åï¼ä»£ç ä¹æ¾å¨è¿ä¸ªç®å½ä¸ã</span></div>
</li>
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="b95lg-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="b95lg-0-0"><span data-offset-key="b95lg-0-0">layersï¼æ¨¡åæ¨ççéç¨ç»ä»¶ï¼åé¨åæ¬ï¼linearãlayernormãrotary_embeddingãattentionãactivation ç­åºç¡åè½çå°è£ï¼å¯ä»¥è¢«ä¸åæ¨¡åä½¿ç¨ã</span></div>
</li>
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="4eca5-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="4eca5-0-0"><span data-offset-key="4eca5-0-0">modelsï¼æ¨¡åçå®ç°ï¼ä¾èµ layers çç»ä»¶å®ç°ä¸åæ¨¡åçæ¨çã</span></div>
</li>
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="upvc-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="upvc-0-0"><span data-offset-key="upvc-0-0">utilsï¼ä¸åå±é½å¯è½ä¼ç¨å°çå·¥å·å½æ°ã</span></div>
</li>
</ul>
<h1 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="4n7nk-0-0"><span data-offset-key="4n7nk-0-0">4. è¿ç»­æ¹å¤ç</span></h1>
<h2 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="6772e-0-0"><span data-offset-key="6772e-0-0">4.1. æ¦å¿µçè§£</span></h2>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="3533u-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="3533u-0-0"><span data-offset-key="3533u-0-0">ï¼1ï¼å®ä¹</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="5ps6c-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="5ps6c-0-0"><span data-offset-key="5ps6c-0-0">è¿ç»­æ¹å¤ç (Continuous Batching)ï¼æ¯ä¸ç§è¿­ä»£çº§ï¼Iteration-levelï¼çè°åº¦ç­ç¥ãå®ä»¥âToken çææ­¥éª¤âä¸ºè°åº¦ç²åº¦ãéè¿å¨æå°å¨æ¯ä¸è½®è¿­ä»£ä¸­æ¿æ¢å·²å®æçä»»å¡ï¼æ¶é¤äºç±äºçæé¿åº¦ä¸ä¸å¯¼è´ç GPU è®¡ç®æ°æ³¡ï¼æå¤§å°æåäºç³»ç»çååéã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="9hoep-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="9hoep-0-0"><span data-offset-key="9hoep-0-0">ï¼2ï¼æ´ç´ çè§£</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="btvpi-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="btvpi-0-0"><span data-offset-key="btvpi-0-0">ä¸ä¸ªè¯·æ±éè¦æ§è¡å¤è½®ï¼ä¸åè¯·æ±éè¦æ§è¡çè½®æ°ä¸åï¼ç³»ç»ä¸è½®æå¤åªè½åæ¶æ§è¡ä¸æ¹ N ä¸ªè¯·æ±ï¼å½ä¸ä¸ªæ¹æ¬¡éçè¯·æ±åå·®ä¸é½çå®ææ¶ï¼æ¯å®æä¸ä¸ªè¯·æ±å°±å°å¶ç¨æ°è¯·æ±æ¿ä»£æã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="f4ss9-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="f4ss9-0-0"><span data-offset-key="f4ss9-0-0">å¯¹æ¯ä¼ ç»æ¹å¤çåè¿ç»­æ¹å¤çï¼</span></div>
</div>
<ul class="public-DraftStyleDefault-ul" data-offset-key="e3hch-0-0">
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-reset public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="e3hch-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="e3hch-0-0"><span data-offset-key="e3hch-0-0">ä¼ ç»æ¹å¤ç (Static Batching)ï¼å¿é¡»ç­å¾ Batch ä¸­çæåºåæé¿çé£ä¸ªè¯·æ±å®æï¼æ´ä¸ª Batch æä¼éæ¾ãå¨æ­¤æé´ï¼çæåºåç­è¯·æ±å®æåæ§½ä½ä¼ç©ºè½¬ã</span></div>
</li>
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="5sueq-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="5sueq-0-0"><span data-offset-key="5sueq-0-0">è¿ç»­æ¹å¤ç (Continuous Batching)ï¼è¯·æ±å®æå³éåºï¼æ°è¯·æ±ç«å³è¡¥ä½ï¼æ§½ä½å§ç»æ»¡è½½ã</span></div>
</li>
</ul>
<h2 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="fl0na-0-0"><span data-offset-key="fl0na-0-0">4.2. æåºç¡çè¿ç»­æ¹å¤ç</span></h2>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="fuvou-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="fuvou-0-0"><span data-offset-key="fuvou-0-0">æç®åçè¿ç»­æ¹å¤çï¼ä¸èè prefill å decode çå·®å¼ï¼ç¤ºä¾ä»£ç ï¼</span></div>
</div>
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="2i7d8-0-0">
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> time
</span><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> threading
</span><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> queue
</span><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> random

</span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> 1. åå§åçº¿ç¨å®å¨çç­å¾éå</span>
waiting_queue =<span style="color: rgba(0, 0, 0, 1)"> queue.Queue()
MAX_BATCH_SIZE </span>= 3

<span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> --- æ¨¡æç¨æ·è¯·æ±çº¿ç¨ (çäº§è) ---</span>
<span style="color: rgba(0, 0, 255, 1)">def</span><span style="color: rgba(0, 0, 0, 1)"> user_request_producer():
    request_id </span>= 1
    <span style="color: rgba(0, 0, 255, 1)">while</span><span style="color: rgba(0, 0, 0, 1)"> True:
        </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> æ¨¡æç¨æ·éæºå°è¾¾ï¼æ¯ 1~2 ç§æ¥ä¸ä¸ªæ°è¯·æ±</span>
        time.sleep(random.uniform(1, 2<span style="color: rgba(0, 0, 0, 1)">))
        
        </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> æ¯ä¸ªè¯·æ±éè¦ç Token é¿åº¦éæºï¼3å°8ä¹é´ï¼</span>
        req = {<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">id</span><span style="color: rgba(128, 0, 0, 1)">"</span>: f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">REQ-{request_id}</span><span style="color: rgba(128, 0, 0, 1)">"</span>, <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">remain</span><span style="color: rgba(128, 0, 0, 1)">"</span>: random.randint(3, 8<span style="color: rgba(0, 0, 0, 1)">)}
        waiting_queue.put(req)
        
        </span><span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">\n[ç¨æ·ç«¯] éå¥æ°è¯·æ±: {req['id']} (é¢è®¡é¿åº¦: {req['remain']})</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
        request_id </span>+= 1
        <span style="color: rgba(0, 0, 255, 1)">if</span> request_id &gt; 5<span style="color: rgba(0, 0, 0, 1)">:
          </span><span style="color: rgba(0, 0, 255, 1)">break</span>

<span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> --- æ ¸å¿æ¨çå¾ªç¯ (æ¶è´¹è/æ§è¡å¨) ---</span>
<span style="color: rgba(0, 0, 255, 1)">def</span><span style="color: rgba(0, 0, 0, 1)"> inference_loop():
    running_batch </span>=<span style="color: rgba(0, 0, 0, 1)"> []
    
    </span><span style="color: rgba(0, 0, 255, 1)">print</span>(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">--- æ¨çå¼æå·²å¯å¨ ---</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
    iteration </span>=<span style="color: rgba(0, 0, 0, 1)"> 0
    </span><span style="color: rgba(0, 0, 255, 1)">while</span><span style="color: rgba(0, 0, 0, 1)"> True:
        </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> A. è¡¥ä½é»è¾ï¼åªè¦ Batch æ²¡æ»¡ä¸éåéæè´§ï¼å°±æè¿æ¥</span>
        <span style="color: rgba(0, 0, 255, 1)">while</span> len(running_batch) &lt;<span style="color: rgba(0, 0, 0, 1)"> MAX_BATCH_SIZE:
            </span><span style="color: rgba(0, 0, 255, 1)">try</span><span style="color: rgba(0, 0, 0, 1)">:
                </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> ä½¿ç¨ block=Falseï¼å¦æéåç©ºäºç´æ¥æ¥éè¿ exceptï¼ä¸é»å¡æ¨çé»è¾</span>
                new_req = waiting_queue.get(block=<span style="color: rgba(0, 0, 0, 1)">False)
                running_batch.append(new_req)
                </span><span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">  &gt;&gt;&gt; [è°åº¦] {new_req['id']} è¿å¥ Batch</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
            </span><span style="color: rgba(0, 0, 255, 1)">except</span><span style="color: rgba(0, 0, 0, 1)"> queue.Empty:
                </span><span style="color: rgba(0, 0, 255, 1)">break</span>

        <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> B. æ¨çé»è¾ï¼å¦æå½å Batch æä»»å¡ï¼å°±æ§è¡ä¸æ¬¡ Step</span>
        <span style="color: rgba(0, 0, 255, 1)">if</span><span style="color: rgba(0, 0, 0, 1)"> running_batch:
            iteration </span>+= 1
            <span style="color: rgba(0, 0, 255, 1)">print</span>(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">=</span><span style="color: rgba(128, 0, 0, 1)">"</span>*20 + f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">{iteration=}</span><span style="color: rgba(128, 0, 0, 1)">"</span> + <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">=</span><span style="color: rgba(128, 0, 0, 1)">"</span>*20<span style="color: rgba(0, 0, 0, 1)">)
            </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> æ¨¡æ GPU æ¨çèæ¶ (Step èæ¶)</span>
            time.sleep(1.2<span style="color: rgba(0, 0, 0, 1)">) 
            
            </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> å½å Batch ç¶æå±ç¤º</span>
            active_ids = [f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">{r['id']}(å©{r['remain']-1})</span><span style="color: rgba(128, 0, 0, 1)">"</span> <span style="color: rgba(0, 0, 255, 1)">for</span> r <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> running_batch]
            </span><span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">[GPUæ¨ç] å¤çä¸­: {active_ids}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
            
            </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> æ¯ä¸ä¸ªè¯·æ±çå©ä½é¿åº¦å 1</span>
            finished_this_step =<span style="color: rgba(0, 0, 0, 1)"> []
            </span><span style="color: rgba(0, 0, 255, 1)">for</span> req <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> running_batch:
                req[</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">remain</span><span style="color: rgba(128, 0, 0, 1)">"</span>] -= 1
                <span style="color: rgba(0, 0, 255, 1)">if</span> req[<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">remain</span><span style="color: rgba(128, 0, 0, 1)">"</span>] &lt;=<span style="color: rgba(0, 0, 0, 1)"> 0:
                    finished_this_step.append(req)
            
            </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> C. åé¤é»è¾ï¼åå®çç«å»è¸¢åºï¼ä¸ä¸è½®å¾ªç¯å¼å¤´å°±ä¼ææ°è¯·æ±è¡¥è¿æ¥</span>
            <span style="color: rgba(0, 0, 255, 1)">for</span> req <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> finished_this_step:
                </span><span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">  &lt;&lt;&lt; [å®æ] {req['id']} çæå®æ¯ï¼éæ¾ä½ç½®</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
                running_batch.remove(req)
        </span><span style="color: rgba(0, 0, 255, 1)">else</span><span style="color: rgba(0, 0, 0, 1)">:
            </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> å¦æ Batch å éåé½ç©ºäºï¼ç¨å¾®æ­ä¼ï¼é¿å CPU ç©ºè½¬</span>
            time.sleep(0.5<span style="color: rgba(0, 0, 0, 1)">)

</span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> --- å¯å¨ç¨åº ---</span>
<span style="color: rgba(0, 0, 255, 1)">if</span> <span style="color: rgba(128, 0, 128, 1)">__name__</span> == <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">__main__</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">:
    </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> å¯å¨ç¨æ·è¯·æ±çº¿ç¨</span>
    t = threading.Thread(target=user_request_producer, daemon=<span style="color: rgba(0, 0, 0, 1)">True)
    t.start()

    </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> ä¸»çº¿ç¨æ§è¡æ¨çå¾ªç¯</span>
    <span style="color: rgba(0, 0, 255, 1)">try</span><span style="color: rgba(0, 0, 0, 1)">:
        inference_loop()
    </span><span style="color: rgba(0, 0, 255, 1)">except</span><span style="color: rgba(0, 0, 0, 1)"> KeyboardInterrupt:
        </span><span style="color: rgba(0, 0, 255, 1)">print</span>(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">\næå¡å·²åæ­¢</span><span style="color: rgba(128, 0, 0, 1)">"</span>)</pre>
</div>
<p><span data-offset-key="2a0tv-0-0">æ ¸å¿é»è¾ï¼</span></p>
</div>
<ul class="public-DraftStyleDefault-ul" data-offset-key="4phrk-0-0">
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-reset public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="4phrk-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="4phrk-0-0"><span data-offset-key="4phrk-0-0">å­å¨ç»æï¼ä»£ç çæ ¸å¿æä¸¤ä¸ªéåï¼waiting_queue è´è´£å­å¨è¯·æ±çº¿ç¨ä¸æ­æ¥æ¶å°çæ°è¯·æ±ï¼running_queue è´è´£å­å¨å·²ç»è¿è¡ä½è¿æ²¡æç»æçè¯·æ±ã</span></div>
</li>
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="ahrhj-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="ahrhj-0-0"><span data-offset-key="ahrhj-0-0">è¿­ä»£å¾ªç¯ï¼çäº§èæç»­å¾ waiting_queue åå¥æ°è¯·æ±ï¼è¿­ä»£å¾ªç¯æç»­ä» waiting_queue è·åæ°è¯·æ±å å¥å° running_queueï¼åæ¶æ¸ç running_queue éå·²ç»å®æçè¯·æ±ã</span></div>
</li>
</ul>
<h2 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="7obml-0-0"><span data-offset-key="7obml-0-0">4.3. prefill ä¼åçè¿ç»­æ¹å¤ç</span></h2>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="4uau9-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="4uau9-0-0"><span data-offset-key="4uau9-0-0">prefill ä¼åçæ¹å¤çï¼éè¦åºå prefll å decodeï¼ä¼åå¤çæ°è¯·æ±ï¼ç¤ºä¾ä»£ç ï¼</span></div>
</div>
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="45mns-0-0">
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> time
</span><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> queue
</span><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> random
</span><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> threading

</span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> æ ¸å¿éå</span>
waiting_queue =<span style="color: rgba(0, 0, 0, 1)"> queue.Queue()  
running_queue </span>=<span style="color: rgba(0, 0, 0, 1)"> []             

MAX_BATCH_SIZE </span>= 4

<span style="color: rgba(0, 0, 255, 1)">def</span><span style="color: rgba(0, 0, 0, 1)"> user_request_producer():
    </span><span style="color: rgba(128, 0, 0, 1)">"""</span><span style="color: rgba(128, 0, 0, 1)">
    ä¿®æ¹ç¹ï¼æ¨¡æçåå¼è¯·æ±å°è¾¾ï¼ä»¥è§¦åå¤è¯·æ± Prefill
    </span><span style="color: rgba(128, 0, 0, 1)">"""</span>
    <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> ç¬¬ä¸æ³¢ï¼çåå¼å°è¾¾ (3ä¸ªè¯·æ±åæ¶è¿å¥éå)</span>
    <span style="color: rgba(0, 0, 255, 1)">print</span>(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">\n[ç¨æ·] --- çåå¼è¯·æ±å°è¾¾ (3ä¸ªè¯·æ±) ---</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
    </span><span style="color: rgba(0, 0, 255, 1)">for</span> i <span style="color: rgba(0, 0, 255, 1)">in</span> range(1, 4<span style="color: rgba(0, 0, 0, 1)">):
        req </span>= {<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">id</span><span style="color: rgba(128, 0, 0, 1)">"</span>: f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">REQ-{i}</span><span style="color: rgba(128, 0, 0, 1)">"</span>, <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">remain</span><span style="color: rgba(128, 0, 0, 1)">"</span>: random.randint(2, 5<span style="color: rgba(0, 0, 0, 1)">)}
        waiting_queue.put(req)
        </span><span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">[ç¨æ·] è¯·æ± {req['id']} è¿å¥ç­å¾éå</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
    
    </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> å»¶è¿ä¸ä¼å¿ï¼åæ¥ç¬¬äºæ³¢åç¹è¯·æ±</span>
    time.sleep(5<span style="color: rgba(0, 0, 0, 1)">)
    </span><span style="color: rgba(0, 0, 255, 1)">print</span>(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">\n[ç¨æ·] --- å»¶è¿è¯·æ±å°è¾¾ (1ä¸ªè¯·æ±) ---</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
    req </span>= {<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">id</span><span style="color: rgba(128, 0, 0, 1)">"</span>: <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">REQ-4</span><span style="color: rgba(128, 0, 0, 1)">"</span>, <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">remain</span><span style="color: rgba(128, 0, 0, 1)">"</span>: 3<span style="color: rgba(0, 0, 0, 1)">}
    waiting_queue.put(req)
    </span><span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">[ç¨æ·] è¯·æ± {req['id']} è¿å¥ç­å¾éå</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)

</span><span style="color: rgba(0, 0, 255, 1)">def</span><span style="color: rgba(0, 0, 0, 1)"> inference_loop():
    </span><span style="color: rgba(0, 0, 255, 1)">print</span>(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">--- è¿ç»­æ¹å¤çå¼æï¼å¤è¯·æ± Prefill æ¨¡å¼ ---</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
    iteration </span>=<span style="color: rgba(0, 0, 0, 1)"> 0
    
    </span><span style="color: rgba(0, 0, 255, 1)">while</span><span style="color: rgba(0, 0, 0, 1)"> True:
        current_batch </span>=<span style="color: rgba(0, 0, 0, 1)"> []
        is_prefill_stage </span>=<span style="color: rgba(0, 0, 0, 1)"> False
        
        </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> 1. è°åº¦ï¼æå»ºå½åæ¹æ¬¡</span>
        <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> åªè¦ waiting_queue éç©ºï¼å°±å°½å¯è½å¡«æ»¡ MAX_BATCH_SIZE</span>
        <span style="color: rgba(0, 0, 255, 1)">if</span> <span style="color: rgba(0, 0, 255, 1)">not</span><span style="color: rgba(0, 0, 0, 1)"> waiting_queue.empty():
            is_prefill_stage </span>=<span style="color: rgba(0, 0, 0, 1)"> True
            </span><span style="color: rgba(0, 0, 255, 1)">while</span> <span style="color: rgba(0, 0, 255, 1)">not</span> waiting_queue.empty() <span style="color: rgba(0, 0, 255, 1)">and</span> len(current_batch) &lt;<span style="color: rgba(0, 0, 0, 1)"> MAX_BATCH_SIZE:
                req </span>=<span style="color: rgba(0, 0, 0, 1)"> waiting_queue.get()
                current_batch.append(req)
        </span><span style="color: rgba(0, 0, 255, 1)">elif</span><span style="color: rgba(0, 0, 0, 1)"> running_queue:
            is_prefill_stage </span>=<span style="color: rgba(0, 0, 0, 1)"> False
            current_batch </span>=<span style="color: rgba(0, 0, 0, 1)"> list(running_queue)
        
        </span><span style="color: rgba(0, 0, 255, 1)">if</span> <span style="color: rgba(0, 0, 255, 1)">not</span><span style="color: rgba(0, 0, 0, 1)"> current_batch:
            time.sleep(</span>0.5<span style="color: rgba(0, 0, 0, 1)">)
            </span><span style="color: rgba(0, 0, 255, 1)">continue</span>

        <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> 2. æ§è¡ï¼æ¨¡ææ¨ç</span>
        iteration += 1
        <span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">\n{'='*15} Iteration {iteration} {'='*15}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
        
        </span><span style="color: rgba(0, 0, 255, 1)">if</span><span style="color: rgba(0, 0, 0, 1)"> is_prefill_stage:
            </span><span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">[PREFILL] æ¹éçæä¸­: {[r['id'] for r in current_batch]}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
            time.sleep(</span>1.5<span style="color: rgba(0, 0, 0, 1)">) 
        </span><span style="color: rgba(0, 0, 255, 1)">else</span><span style="color: rgba(0, 0, 0, 1)">:
            </span><span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">[DECODE ] æ¹éçæä¸­: {[f'{r['id']}(å©{r['remain']})' for r in current_batch]}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
            time.sleep(</span>0.4<span style="color: rgba(0, 0, 0, 1)">) 

        </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> 3. ç»ä¸ç¶ææ´æ°</span>
        <span style="color: rgba(0, 0, 255, 1)">for</span> req <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> current_batch:
            req[</span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">remain</span><span style="color: rgba(128, 0, 0, 1)">'</span>] -= 1

        <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> 4. ç»ä¸å¤æ­çå½å¨æ</span>
        <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> æ³¨æï¼ä¸ºäºé¿åå¨éååè¡¨æ¶å é¤åç´ ï¼æä»¬åæ¶éè¦å é¤çå¯¹è±¡</span>
        to_remove_from_running =<span style="color: rgba(0, 0, 0, 1)"> []
        
        </span><span style="color: rgba(0, 0, 255, 1)">for</span> req <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> current_batch:
            </span><span style="color: rgba(0, 0, 255, 1)">if</span> req[<span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">remain</span><span style="color: rgba(128, 0, 0, 1)">'</span>] &lt;=<span style="color: rgba(0, 0, 0, 1)"> 0:
                </span><span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">  &lt;&lt;&lt; [å®æ] {req['id']} éåºç³»ç»</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
                </span><span style="color: rgba(0, 0, 255, 1)">if</span> req <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> running_queue:
                    to_remove_from_running.append(req)
            </span><span style="color: rgba(0, 0, 255, 1)">else</span><span style="color: rgba(0, 0, 0, 1)">:
                </span><span style="color: rgba(0, 0, 255, 1)">if</span><span style="color: rgba(0, 0, 0, 1)"> is_prefill_stage:
                    running_queue.append(req)
                    </span><span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">  -&gt; {req['id']} Prefill å®æï¼è½¬å¥ running_queue</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
                </span><span style="color: rgba(0, 0, 255, 1)">else</span><span style="color: rgba(0, 0, 0, 1)">:
                    </span><span style="color: rgba(0, 0, 255, 1)">pass</span>
        
        <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> çæ­£çä» running_queue ç§»é¤</span>
        <span style="color: rgba(0, 0, 255, 1)">for</span> req <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> to_remove_from_running:
            running_queue.remove(req)

</span><span style="color: rgba(0, 0, 255, 1)">if</span> <span style="color: rgba(128, 0, 128, 1)">__name__</span> == <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">__main__</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">:
    t </span>= threading.Thread(target=user_request_producer, daemon=<span style="color: rgba(0, 0, 0, 1)">True)
    t.start()
    </span><span style="color: rgba(0, 0, 255, 1)">try</span><span style="color: rgba(0, 0, 0, 1)">:
        inference_loop()
    </span><span style="color: rgba(0, 0, 255, 1)">except</span><span style="color: rgba(0, 0, 0, 1)"> KeyboardInterrupt:
        </span><span style="color: rgba(0, 0, 255, 1)">pass</span></pre>
</div>
<p><span data-offset-key="95l8v-0-0">å å ä¸ prefill ä¼åä¹åçè¿ç»­æ¹å¤çä»£ç ä¹è¾ä¸ºç®åï¼ä¸»è¦æ¯ç»´æ¤ä¸ä¸ªåéï¼waiting_queueãrunning_queueãcurrent_batchã</span></p>
</div>
<h1 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="bfmk2-0-0"><span data-offset-key="bfmk2-0-0">5. KV Cache</span></h1>
<h2 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="4fpfc-0-0"><span data-offset-key="4fpfc-0-0">5.1. æ¦å¿µçè§£</span></h2>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="egp60-0-0">
<h3 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="egp60-0-0"><span data-offset-key="egp60-0-0">5.1.1. KV Cache çç¨é</span></h3>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="dj0l-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="dj0l-0-0"><span data-offset-key="dj0l-0-0">KV Cache æä¸¤å±ç¨éãä¸æ¯ç¨å¨åä¸ä¸ªè¯·æ±ç Decode é¶æ®µï¼å¤ç¨ä¹åå·²ç»è®¡ç®è¿ç KV ç»æä»¥é¿åéå¤è®¡ç®ï¼äºæ¯ç¨å¨ä¸åè¯·æ±ä¹é´ï¼ä½¿å·æç¸ååç¼çè¯·æ±å¯ä»¥å±äº«ä¸é¨å KV æ°æ®ï¼è¿å°±æ¯ Prefix KV Cacheã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="6qu2l-0-0">
<h3 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="6qu2l-0-0"><span data-offset-key="6qu2l-0-0">5.1.2. PagedAttention ææ¯</span></h3>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="cp1e3-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="cp1e3-0-0"><span data-offset-key="cp1e3-0-0">å¨ Cache çå­å¨å±é¢ï¼PagedAttention å®ç°äºæ¾å­çæéç³è¯·ãç±äº KV Cache ç©ºé´ä¸åä¸æ¬¡æ§é¢åéï¼è¯·æ±åºåå¯¹åºçç©çå°åæ¯ç¦»æ£çãPagedAttention çæ ¸å¿å¨äºï¼å®è½å¤ç´æ¥è¯»åè¿äºç©çç¦»æ£çåæ¥å®ææ³¨æåè®¡ç®ï¼è¿èåå®ç°äºä¸å±ä»âé»è¾è¿ç»­å°åâå°âç©çç¦»æ£å°åâçæ å°ã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="a494u-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="a494u-0-0"><span data-offset-key="a494u-0-0">å¯¹äºæ²¡ææ¥è§¦è¿é PagedAttention å®ç°çè¯»èæ¥è¯´ï¼è¿ç§è®¾è®¡ä¼¼ä¹çæå½ç¶ï¼æéç³è¯·ãåé¡µç®¡çãå°åæ å°ãå±é¨æ§åçââè¿äºé½æ¯è®¡ç®æºç§å­¦ä¸­éå¸¸å¸¸è§çæç»´ï¼çè³å¾é¾æ³å°ä¸è¿ä¹åççç±ãé£ä¹ï¼ä¸ºä»ä¹ PagedAttention ä¼è¢«è®¤ä¸ºæ¯ä¸é¡¹éç¨ç¢å¼çåè¿ææ¯å¢ï¼</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="8elsr-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="8elsr-0-0"><span data-offset-key="8elsr-0-0">é¦åï¼å¨ PagedAttention åºç°ä¹åï¼ä¸çæ®éè®¤ä¸º KV Cache å¨æ¾å­ä¸­å¿é¡»ç©çè¿ç»­ï¼å¦åä¼å è®¿å­ä¸è¿ç»­å¯¼è´æ§è½å¤§å¹ä¸éãå¶æ¬¡ï¼å½æ¶çæ³¨æåç®å­ï¼å¦æ åç FlashAttentionï¼å¹¶ä¸æ¯æäºæ¬¡å¯»åæ å°ãPagedAttention è¯æäºå³ä¾¿ç©çå­å¨ä¸è¿ç»­ï¼æ§è½ä¾ç¶å¯ä»¥ä¿ææé«ãå¶ä»£ç å®ç°æå³é®çç¹å¨äºéæäº CUDA åæ ¸ï¼ä½¿å¶åçæ¯æ KV Cache äºæ¬¡å¯»åãä¸ä¸ªåºåç KV Cache ä¸éè¦ç©çè¿ç»­ï¼ä¹æ­£æ¯ä¸ååºåé´è½å¤çµæ´»å¤ç¨ Prefix KV Cache çææ¯åæã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="tdgu-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="tdgu-0-0"><span data-offset-key="tdgu-0-0">æ»çæ¥è¯´ï¼è½ç¶åé¡µèæåå­å¨ CPU é¢åæ¯å¸¸è¯ï¼ä½å¨ GPU ç®å­é¢åå¶åå±ç¸å¯¹ç¼æ¢ãå®ç°ä¸å¥æ¢è½åé¡µç®¡çãåä¸æå¤±ç®åå©ç¨çç Attention Kernel æ¯ PagedAttention çæ ¸å¿æå¨ã</span></div>
</div>
<h2 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="4t417-0-0"><span data-offset-key="4t417-0-0">5.2. Prefix KV Cache çå®ç°</span></h2>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="1qbm4-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="1qbm4-0-0"><span data-offset-key="1qbm4-0-0">Cache çç®¡çè¾ä¸ºç®åï¼åªæ BlockManager ç±»ï¼è´è´£ç»´æ¤æ¾å­æ± åä¸ª block ççç¶æã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="3hqqi-0-0">
<h3 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="3hqqi-0-0"><span data-offset-key="3hqqi-0-0">5.2.1. åè½ç»è</span></h3>
</div>
<ul class="public-DraftStyleDefault-ul" data-offset-key="eo7ib-0-0">
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-reset public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="eo7ib-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="eo7ib-0-0"><span data-offset-key="eo7ib-0-0">ä½¿ç¨ hash æ¥è¯å«æ¯å¦æå¯å¤ç¨åç¼ï¼ä»¥ block ä¸ºåºæ¬åå</span></div>
</li>
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="eu2dc-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="eu2dc-0-0"><span data-offset-key="eu2dc-0-0">é¾å¼ hashï¼æ¯ä¸ª block ç hash è®¡ç®è¾å¥ä¸ºååº block ç hash å¼å ä¸æ¬ block ç token id</span></div>
</li>
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="53r4m-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="53r4m-0-0"><span data-offset-key="53r4m-0-0">æ¯ä¸ä¸ª block æå¯¹åºç meta ä¿¡æ¯å¯¹è±¡ï¼è®°å½ block è¢«å¤ç¨çå¼ç¨è®¡æ°ï¼ç¡®ä¿å¤ç¨æ¶ä¸ä¼è¢«éæ¾</span></div>
</li>
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="5ep1l-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="5ep1l-0-0"><span data-offset-key="5ep1l-0-0">ä¸ºé¿å hash ç¢°æåºç°éè¯¯ï¼block meta ä¿¡æ¯è¿éè¦è®°å½åå§ç token id</span></div>
</li>
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="ep2of-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="ep2of-0-0"><span data-offset-key="ep2of-0-0">å¨è·å KV Cache ç©ºé´æ¶éè¦èèæ¯å¦è·¨ block</span></div>
</li>
</ul>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="1n8ab-0-0">
<h3 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="1n8ab-0-0"><span data-offset-key="1n8ab-0-0">5.2.2. åå­æ± </span></h3>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="92dgk-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="92dgk-0-0"><span data-offset-key="92dgk-0-0">å¨è¿ç¨å¯å¨æ¶ï¼ä¸æ¬¡æ§ç³è¯·åå­æ± çç©ºé´ï¼</span></div>
</div>
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="7mlt7-0-0">
<div class="cnblogs_code">
<pre>kv_cache =<span style="color: rgba(0, 0, 0, 1)"> torch.empty(
    </span>2,                          <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> K å V</span>
    num_layers,                 <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> å±æ°</span>
    num_blocks,                 <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> æ»åæ°</span>
    block_size,                 <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> æ¯å token æ°</span>
    num_kv_heads // tp_size,    <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> KV head æ°ï¼èèå¼ éå¹¶è¡ï¼</span>
    head_dim                    <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> head ç»´åº¦</span>
)</pre>
</div>
<p><span data-offset-key="c1fh4-0-0">ä¸è¿°ç³è¯·æ¾å­ä»£ç ä¸­ç num_blocks æ¯æ ¹æ®å¯ç¨äº KV Cache çæ¾å­ç®åºæ¥çï¼</span></p>
<div class="cnblogs_code">
<pre>block_bytes = 2 * hf_config.num_hidden_layers * self.block_size * num_kv_heads * head_dim *<span style="color: rgba(0, 0, 0, 1)"> hf_config.torch_dtype.itemsize
config.num_kvcache_blocks </span>= int(total * config.gpu_memory_utilization - used - peak + current) // block_bytes</pre>
</div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="2itrb-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="2itrb-0-0"><span data-offset-key="2itrb-0-0">ä¸è¿°ä»£ç ä¸­ç block_bytes å¹¶ä¸æ¯æ block çå¤§å°ï¼èæ¯æè®¡ç® blocks æ°çææé¤æ°ä¹å°äºä¸èµ·ï¼é¤æ°åæ¬ï¼block å¤§å°ãk å vãæ¨¡åå±æ°ã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="9u53j-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="9u53j-0-0"><span data-offset-key="9u53j-0-0"><span data-text="true">total * config.gpu_memory_utilization - used - peak + current<span data-offset-key="9u53j-0-1"> è¿é¨ååæ¯æ ¹æ®æé«çæ¾å­å©ç¨çç®åºæ¥å¯ç¨æ¾å­ï¼åå»å½åæ¨¡åå è½½å®åä½¿ç¨äºçé¨åï¼ååå»æ¨¡åé¢ç­æ¶ä½¿ç¨çæ¿æ´»æ¾å­ï¼<span data-offset-key="9u53j-0-2"><span data-text="true">peak - current<span data-offset-key="9u53j-0-3">ã</span></span></span></span></span></span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="an724-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="an724-0-0"><span data-offset-key="an724-0-0">ç³è¯·å°åå­æ± åï¼æå±å±äº«è§å¾ç»åä¸ªå±ç Attention å¯¹è±¡ï¼ä»£ç çèµ·æ¥æ¯è¾ trickyï¼ä½å¨ python éåæ¯è¾å¸¸è§ï¼</span></div>
</div>
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="aectp-0-0">
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 255, 1)">for</span> module <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> self.model.modules():
    </span><span style="color: rgba(0, 0, 255, 1)">if</span> hasattr(module, <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">k_cache</span><span style="color: rgba(128, 0, 0, 1)">"</span>) <span style="color: rgba(0, 0, 255, 1)">and</span> hasattr(module, <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">v_cache</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">):
        module.k_cache </span>=<span style="color: rgba(0, 0, 0, 1)"> self.kv_cache[0, layer_id]
        module.v_cache </span>= self.kv_cache[1<span style="color: rgba(0, 0, 0, 1)">, layer_id]
        layer_id </span>+= 1</pre>
</div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="8plc7-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="8plc7-0-0"><span data-offset-key="8plc7-0-0">éåæ¨¡åä¸­çææ nn.Module å­æ¨¡åï¼éè¿æ£æ¥æ¯å¦å­å¨ k_cache å v_cache å±æ§æ¥è¯å« Attention å±ãå¯¹äºæ¯ä¸ª Attention å±ï¼å°å¶ k_cache å v_cache å±æ§æ¿æ¢ä¸ºæåå¨å± KV Cache æ¾å­æ± çå¼ éè§å¾ï¼è¿æ ·ææå±å±äº«åä¸åè¿ç»­çæ¾å­ç©ºé´ï¼ä½æ¯å±åªè½è®¿é®èªå·±å¯¹åºçåçã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="5gjke-0-0">
<h3 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="5gjke-0-0"><span data-offset-key="5gjke-0-0">5.2.3. KV Cache åå¥</span></h3>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="dqio4-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="dqio4-0-0"><span data-offset-key="dqio4-0-0">å¨ attention å­å±ç forward åå KV Cache çåå¥ï¼ä½¿ç¨ç store_kvcache_kernel å½æ°æ¯ triton.jit å®ç°çï¼ä»£ç ä¹æ¯è¾ç®æ´ï¼</span></div>
</div>
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="97mjq-0-0">
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 0, 1)">@triton.jit
</span><span style="color: rgba(0, 0, 255, 1)">def</span><span style="color: rgba(0, 0, 0, 1)"> store_kvcache_kernel(
    key_ptr,
    key_stride,
    value_ptr,
    value_stride,
    k_cache_ptr,
    v_cache_ptr,
    slot_mapping_ptr,
    D: tl.constexpr,
):
    idx </span>=<span style="color: rgba(0, 0, 0, 1)"> tl.program_id(0)
    slot </span>= tl.load(slot_mapping_ptr +<span style="color: rgba(0, 0, 0, 1)"> idx)
    </span><span style="color: rgba(0, 0, 255, 1)">if</span> slot == -1: <span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)">
    key_offsets </span>= idx * key_stride +<span style="color: rgba(0, 0, 0, 1)"> tl.arange(0, D)
    value_offsets </span>= idx * value_stride +<span style="color: rgba(0, 0, 0, 1)"> tl.arange(0, D)
    key </span>= tl.load(key_ptr +<span style="color: rgba(0, 0, 0, 1)"> key_offsets)
    value </span>= tl.load(value_ptr +<span style="color: rgba(0, 0, 0, 1)"> value_offsets)
    cache_offsets </span>= slot * D +<span style="color: rgba(0, 0, 0, 1)"> tl.arange(0, D)
    tl.store(k_cache_ptr </span>+<span style="color: rgba(0, 0, 0, 1)"> cache_offsets, key)
    tl.store(v_cache_ptr </span>+<span style="color: rgba(0, 0, 0, 1)"> cache_offsets, value)

</span><span style="color: rgba(0, 0, 255, 1)">def</span><span style="color: rgba(0, 0, 0, 1)"> store_kvcache(key: torch.Tensor, value: torch.Tensor, k_cache: torch.Tensor, v_cache: torch.Tensor, slot_mapping: torch.Tensor):
    N, num_heads, head_dim </span>=<span style="color: rgba(0, 0, 0, 1)"> key.shape
    D </span>= num_heads *<span style="color: rgba(0, 0, 0, 1)"> head_dim
    </span><span style="color: rgba(0, 0, 255, 1)">assert</span> key.stride(-1) == 1 <span style="color: rgba(0, 0, 255, 1)">and</span> value.stride(-1) == 1
    <span style="color: rgba(0, 0, 255, 1)">assert</span> key.stride(1) == head_dim <span style="color: rgba(0, 0, 255, 1)">and</span> value.stride(1) ==<span style="color: rgba(0, 0, 0, 1)"> head_dim
    </span><span style="color: rgba(0, 0, 255, 1)">assert</span> k_cache.stride(1) == D <span style="color: rgba(0, 0, 255, 1)">and</span> v_cache.stride(1) ==<span style="color: rgba(0, 0, 0, 1)"> D
    </span><span style="color: rgba(0, 0, 255, 1)">assert</span> slot_mapping.numel() ==<span style="color: rgba(0, 0, 0, 1)"> N
    store_kvcache_kernel[(N,)](key, key.stride(0), value, value.stride(0), k_cache, v_cache, slot_mapping, D)</span></pre>
</div>
<p><span data-offset-key="eot2n-0-0">ä½¿ç¨ stride å½æ°æ¥ç¡®è®¤æ¾å­æ¯å¦è¿ç»­ï¼å ä¸ºå¨ store_kvcache_kernel çå®ç°éä¼æç§æ¾å­è¿ç»­æ¥è¯»åæå®ä½ç½®çå¼ã</span></p>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="fgn05-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="fgn05-0-0"><span data-offset-key="fgn05-0-0">æ¾å­è¿ç»­åä¸è¿ç»­çä¾å­ï¼</span></div>
</div>
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="bgucp-0-0">
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> torch

key </span>= torch.randn(2, 3, 4<span style="color: rgba(0, 0, 0, 1)">)
</span><span style="color: rgba(0, 0, 255, 1)">print</span><span style="color: rgba(0, 0, 0, 1)">(key.stride())  
key_t </span>= key.transpose(1, 2<span style="color: rgba(0, 0, 0, 1)">)
</span><span style="color: rgba(0, 0, 255, 1)">print</span>(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">è½¬ç½®åï¼éè¿ç»­ï¼:</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">, key_t.stride())  
key_t </span>= key_t.contiguous()  <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> éæ°åéï¼ä½¿å¶è¿ç»­</span>
<span style="color: rgba(0, 0, 255, 1)">print</span>(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">contiguous å:</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">, key_t.stride())

</span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> è¾åºï¼</span><span style="color: rgba(0, 128, 0, 1)">
#</span><span style="color: rgba(0, 128, 0, 1)"> (12, 4, 1)</span><span style="color: rgba(0, 128, 0, 1)">
#</span><span style="color: rgba(0, 128, 0, 1)"> è½¬ç½®åï¼éè¿ç»­ï¼: (12, 1, 4)</span><span style="color: rgba(0, 128, 0, 1)">
#</span><span style="color: rgba(0, 128, 0, 1)"> contiguouså: (12, 3, 1)</span></pre>
</div>
</div>
<h1 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="ci2i3-0-0"><span data-offset-key="ci2i3-0-0">6. cuda graph</span></h1>
<h2 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="2jdp4-0-0"><span data-offset-key="2jdp4-0-0">6.1. æ¦å¿µçè§£</span></h2>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="35eln-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="35eln-0-0"><span data-offset-key="35eln-0-0">CUDA Graph æ¯ä¸ç§å°ä¸ç³»å CUDA æä½å½å¶æå¾çææ¯ï¼å¨éå¤æ§è¡çåºå®æä½åºååºæ¯ä¸å¯ä»¥æ¾èæåæ¨çæ§è½ï¼ä¸»è¦åºäºè¿å æ¹é¢ï¼</span></div>
</div>
<ul class="public-DraftStyleDefault-ul" data-offset-key="c79s9-0-0">
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-reset public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="c79s9-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="c79s9-0-0"><span data-offset-key="c79s9-0-0">åå° CPU ä¸ GPU ä¹é´çé¢ç¹åæ­¥åæä»¤ä¸åå¼éï¼éä½ä¼ ç»ç¬ç«æä½å¸¦æ¥çæ§å¶æµäº¤äºæèï¼</span></div>
</li>
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="e6vfa-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="e6vfa-0-0"><span data-offset-key="e6vfa-0-0">åå°æ§è¡è¿ç¨ä¸­ç CPU å¹²é¢ï¼GPU èªä¸»æ¹éæ§è¡å¾åæä½ï¼æå¤§å GPU å©ç¨çï¼éä½å»¶è¿ãæåååã</span></div>
</li>
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="boou5-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="boou5-0-0"><span data-offset-key="boou5-0-0">è§é¿å¤æ¬¡ç¬ç« CUDA Kernel çå¯å¨åºå®å¼éï¼å¤ä¸ª Kernel æååä»éä¸æ¬¡è°åº¦è§¦åï¼å¤§å¹æåå° Kernel å¯éåºæ¯çæ§è¡æçï¼</span></div>
</li>
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="dopod-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="dopod-0-0"><span data-offset-key="dopod-0-0">å¯éåæ¾å­æ± å®ç°æ¾å­èµæºå¤ç¨ï¼åå° âå°éå¤æ¬¡â æ¾å­ç³è¯· / éæ¾çå¼éï¼åæ¶é©±å¨ä¼åºäºå¾åæ¾å­è®¿é®æ¨¡å¼ä¼åå¸¦å®½å©ç¨çï¼</span></div>
</li>
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="4h8t0-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="4h8t0-0-0"><span data-offset-key="4h8t0-0-0">CUDA é©±å¨å¯è·åæä½åºåçå¨å±è§å¾ï¼åºäºå®æ´çä¾èµå³ç³»è¿è¡å¨å±ä¼åï¼å¦ Kernel é¡ºåºè°æ´ãèµæºåå¹¶ç­ï¼ï¼</span></div>
</li>
</ul>
<h2 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="t84f-0-0"><span data-offset-key="t84f-0-0">6.2. åè½ç»è</span></h2>
<ul class="public-DraftStyleDefault-ul" data-offset-key="5flpk-0-0">
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-reset public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="5flpk-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="5flpk-0-0"><span data-offset-key="5flpk-0-0">å½å¶æ¶ä½¿ç¨çå¼ éåå­å°åï¼å¨éæ¾æ¶å¿é¡»ä¿æä¸åï¼ä¹å°±æ¯åé¢å¤æ¬¡ replay é½ä¼ä½¿ç¨æè·æ¶ç³è¯·çåéç©ºé´</span></div>
</li>
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="4p4jf-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="4p4jf-0-0"><span data-offset-key="4p4jf-0-0">æè·åç graph å¯¹è±¡è®°å½å¨æååééï¼ä¾ä¸æ¬¡æ¨çæ¶éæ©</span></div>
</li>
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="7n2p4-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="7n2p4-0-0"><span data-offset-key="7n2p4-0-0">éæ¾æ¶éæ©æ¯è¯·æ± batch size å¤§çæå° graph batch size</span></div>
</li>
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="4k7ao-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="4k7ao-0-0"><span data-offset-key="4k7ao-0-0">æè·æ¶ä¸åç batch size å±äº«ç¸åçéææ¾å­ç©ºé´ï¼å¹¶è®©å¤ä¸ªæ¹æ¬¡å±äº«æ¾å­æ± ï¼ä½¿å¾è½ç¶æå¤ä¸ª batch sizeï¼ä½åªä¼ä½¿ç¨ Max Batch Size çæ¾å­ç©ºé´</span></div>
</li>
</ul>
<h2 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="ej75t-0-0"><span data-offset-key="ej75t-0-0">6.3. ç¤ºä¾ä»£ç </span></h2>
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="atcuu-0-0">
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> torch
</span><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> torch.nn as nn

</span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> 1. åºç¡éç½®</span>
device = <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">cuda</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">
D </span>= 512                 <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> ç»´åº¦</span>
graph_bs = [1, 8, 32]   <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> é¢å®ä¹çæ¡¶ï¼åæ¡¶å°ºå¯¸ï¼</span>
NUM_LAYERS = 100        <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> ææ·±æ¨¡åï¼å¢å  Kernel æ°éä»¥æ¾å¤§ Graph ä¼å¿</span>
iters = 50              <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> æ§è½æµè¯è¿­ä»£æ¬¡æ°</span>
max_bs =<span style="color: rgba(0, 0, 0, 1)"> max(graph_bs)

</span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> 2. å®ä¹æ·±å±æ¨¡å (äº§ççº¦ 400 ä¸ª Kernel)</span>
<span style="color: rgba(0, 0, 255, 1)">class</span><span style="color: rgba(0, 0, 0, 1)"> UltraDeepModel(nn.Module):
    </span><span style="color: rgba(0, 0, 255, 1)">def</span> <span style="color: rgba(128, 0, 128, 1)">__init__</span><span style="color: rgba(0, 0, 0, 1)">(self):
        super().</span><span style="color: rgba(128, 0, 128, 1)">__init__</span><span style="color: rgba(0, 0, 0, 1)">()
        self.blocks </span>=<span style="color: rgba(0, 0, 0, 1)"> nn.ModuleList()
        </span><span style="color: rgba(0, 0, 255, 1)">for</span> _ <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> range(NUM_LAYERS):
            block </span>=<span style="color: rgba(0, 0, 0, 1)"> nn.ModuleDict({
                </span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">ln</span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(0, 0, 0, 1)">: nn.LayerNorm(D).to(device),
                </span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">linear</span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(0, 0, 0, 1)">: nn.Linear(D, D).to(device),
                </span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">act</span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(0, 0, 0, 1)">: nn.ReLU()
            })
            self.blocks.append(block)

    </span><span style="color: rgba(0, 0, 255, 1)">def</span><span style="color: rgba(0, 0, 0, 1)"> forward(self, x):
        </span><span style="color: rgba(0, 0, 255, 1)">for</span> block <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> self.blocks:
            identity </span>=<span style="color: rgba(0, 0, 0, 1)"> x
            x </span>= block[<span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">ln</span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(0, 0, 0, 1)">](x)
            x </span>= block[<span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">linear</span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(0, 0, 0, 1)">](x)
            x </span>= block[<span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">act</span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(0, 0, 0, 1)">](x)
            x </span>= x +<span style="color: rgba(0, 0, 0, 1)"> identity 
        </span><span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)"> x

model </span>=<span style="color: rgba(0, 0, 0, 1)"> UltraDeepModel().eval()

</span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> 3. éæç¼å²åºåå¤</span>
static_input = torch.empty(max_bs, D, device=<span style="color: rgba(0, 0, 0, 1)">device)
static_output </span>= torch.empty(max_bs, D, device=<span style="color: rgba(0, 0, 0, 1)">device)

graphs </span>=<span style="color: rgba(0, 0, 0, 1)"> {}
graph_pool </span>=<span style="color: rgba(0, 0, 0, 1)"> None

</span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> 4. å½å¶é¶æ®µ (ä»å¤§å°å°ï¼å±äº«åå­æ± )</span>
<span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">--- å¼å§å½å¶åæ¡¶ CUDA Graphs ---</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
</span><span style="color: rgba(0, 0, 255, 1)">for</span> bs <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> reversed(sorted(graph_bs)):
    current_input </span>=<span style="color: rgba(0, 0, 0, 1)"> static_input[:bs]
    </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> Warmup</span>
    <span style="color: rgba(0, 0, 255, 1)">for</span> _ <span style="color: rgba(0, 0, 255, 1)">in</span> range(5<span style="color: rgba(0, 0, 0, 1)">):
        _ </span>=<span style="color: rgba(0, 0, 0, 1)"> model(current_input)
    
    g </span>=<span style="color: rgba(0, 0, 0, 1)"> torch.cuda.CUDAGraph()
    with torch.cuda.graph(g, pool</span>=<span style="color: rgba(0, 0, 0, 1)">graph_pool):
        static_output[:bs] </span>=<span style="color: rgba(0, 0, 0, 1)"> model(current_input)
    
    </span><span style="color: rgba(0, 0, 255, 1)">if</span> graph_pool <span style="color: rgba(0, 0, 255, 1)">is</span><span style="color: rgba(0, 0, 0, 1)"> None:
        graph_pool </span>=<span style="color: rgba(0, 0, 0, 1)"> g.pool()
    graphs[bs] </span>=<span style="color: rgba(0, 0, 0, 1)"> g
    </span><span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">â å·²å½å¶æ¡¶ BS={bs}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)

</span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> 5. è¾å©å½æ°ï¼æ ¹æ®å®é BS å¹éæè¿çæ¡¶</span>
<span style="color: rgba(0, 0, 255, 1)">def</span><span style="color: rgba(0, 0, 0, 1)"> get_bucket_bs(actual_bs):
    </span><span style="color: rgba(0, 0, 255, 1)">for</span> b <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> sorted(graph_bs):
        </span><span style="color: rgba(0, 0, 255, 1)">if</span> actual_bs &lt;=<span style="color: rgba(0, 0, 0, 1)"> b:
            </span><span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)"> b
    </span><span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)"> None

</span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> 6. æ§è½å¯¹æ¯æµè¯ (åå« Padding é»è¾)</span>
<span style="color: rgba(0, 0, 255, 1)">def</span> benchmark(actual_test_bs=7<span style="color: rgba(0, 0, 0, 1)">):
    </span><span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">\n--- æ§è½æµè¯å¼å§: å®éè¯·æ± BS={actual_test_bs} ---</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
    
    </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> çææµè¯æ°æ®</span>
    test_data = torch.randn(actual_test_bs, D, device=<span style="color: rgba(0, 0, 0, 1)">device)
    
    start_event </span>= torch.cuda.Event(enable_timing=<span style="color: rgba(0, 0, 0, 1)">True)
    end_event </span>= torch.cuda.Event(enable_timing=<span style="color: rgba(0, 0, 0, 1)">True)

    </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> --- æ®µè½ A: Standard Eager Mode (ç´æ¥è· 7 ä¸ª) ---</span>
    torch.cuda.nvtx.range_push(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Eager_Mode</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
    start_event.record()
    </span><span style="color: rgba(0, 0, 255, 1)">for</span> _ <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> range(iters):
        _ </span>=<span style="color: rgba(0, 0, 0, 1)"> model(test_data)
    end_event.record()
    torch.cuda.synchronize()
    eager_time </span>=<span style="color: rgba(0, 0, 0, 1)"> start_event.elapsed_time(end_event)
    torch.cuda.nvtx.range_pop()

    </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> --- æ®µè½ B: CUDA Graph Mode (Padding å¯¹é½å° 8) ---</span>
    <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> 1. è·¯ç±é»è¾</span>
    bucket_bs =<span style="color: rgba(0, 0, 0, 1)"> get_bucket_bs(actual_test_bs)
    </span><span style="color: rgba(0, 0, 255, 1)">if</span> bucket_bs <span style="color: rgba(0, 0, 255, 1)">is</span><span style="color: rgba(0, 0, 0, 1)"> None:
        </span><span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">â éè¯¯: å®é BS={actual_test_bs} è¶è¿äºæå¤§åæ¡¶ {max_bs}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
        </span><span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)">

    torch.cuda.nvtx.range_push(f</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Graph_Mode_Bucket_{bucket_bs}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
    
    </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> 2. æ°æ®å¯¹é½ (Padding): å° 7 æ¡æ°æ®æ·å¥ 8 çéæåºå</span>
    <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> static_input çå 7 è¡è¢«è¦çï¼ç¬¬ 8 è¡ä¿æä¸åï¼å³ Padding ä½ï¼</span>
<span style="color: rgba(0, 0, 0, 1)">    static_input[:actual_test_bs].copy_(test_data)
    
    start_event.record()
    </span><span style="color: rgba(0, 0, 255, 1)">for</span> _ <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> range(iters):
        </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> 3. éæ¾åæ¡¶ 8 çå¾</span>
<span style="color: rgba(0, 0, 0, 1)">        graphs[bucket_bs].replay()
    end_event.record()
    torch.cuda.synchronize()
    graph_time </span>=<span style="color: rgba(0, 0, 0, 1)"> start_event.elapsed_time(end_event)
    
    </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> 4. ç»ææªæ­ (Slicing): ä»éæåºæ¿åå 7 æ¡</span>
    final_res =<span style="color: rgba(0, 0, 0, 1)"> static_output[:actual_test_bs]
    torch.cuda.nvtx.range_pop()

    </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> æå°ç»æ</span>
    <span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">å¹éå°çæ¡¶: {bucket_bs} (Padding æµªè´¹ç: {(bucket_bs-actual_test_bs)/bucket_bs*100:.1f}%)</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
    </span><span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">{'Mode':&lt;20} | {'Avg Time (ms)':&lt;15}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
    </span><span style="color: rgba(0, 0, 255, 1)">print</span>(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">-</span><span style="color: rgba(128, 0, 0, 1)">"</span> * 40<span style="color: rgba(0, 0, 0, 1)">)
    </span><span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">{'Eager Mode':&lt;20} | {eager_time/iters:&gt;15.4f}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
    </span><span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">{'Graph Mode':&lt;20} | {graph_time/iters:&gt;15.4f}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
    </span><span style="color: rgba(0, 0, 255, 1)">print</span>(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">-</span><span style="color: rgba(128, 0, 0, 1)">"</span> * 40<span style="color: rgba(0, 0, 0, 1)">)
    </span><span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">ð å éæ¯: {eager_time/graph_time:.2f}x</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
    </span><span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">æç»è¾åºå½¢ç¶: {final_res.shape}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)

</span><span style="color: rgba(0, 0, 255, 1)">if</span> <span style="color: rgba(128, 0, 128, 1)">__name__</span> == <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">__main__</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">:
    </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> æµè¯ä¸åçè¾å¥ BS</span>
    benchmark(actual_test_bs=7)  <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> è§¦åå¯¹é½å° 8</span>
    benchmark(actual_test_bs=1)  <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> ç²¾ç¡®å¹éå° 1</span></pre>
</div>
<p><span data-offset-key="b3jsd-0-0">æ§è¡ï¼nsys profile --trace=cuda,osrt,nvtx python3 cu2.py</span></p>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="e9suj-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="e9suj-0-0"><span data-offset-key="e9suj-0-0">è¾åºï¼</span></div>
</div>
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="bm2d3-0-0">
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 0, 1)">Collecting data...
</span>--- å¼å§å½å¶åæ¡¶ CUDA Graphs ---<span style="color: rgba(0, 0, 0, 1)">
â å·²å½å¶æ¡¶ BS</span>=32<span style="color: rgba(0, 0, 0, 1)">
â å·²å½å¶æ¡¶ BS</span>=8<span style="color: rgba(0, 0, 0, 1)">
â å·²å½å¶æ¡¶ BS</span>=1

--- æ§è½æµè¯å¼å§: å®éè¯·æ± BS=7 ---<span style="color: rgba(0, 0, 0, 1)">
å¹éå°çæ¡¶: </span>8 (Padding æµªè´¹ç: 12.5%<span style="color: rgba(0, 0, 0, 1)">)
Mode                 </span>|<span style="color: rgba(0, 0, 0, 1)"> Avg Time (ms)  
</span>----------------------------------------<span style="color: rgba(0, 0, 0, 1)">
Eager Mode           </span>|          7.9331<span style="color: rgba(0, 0, 0, 1)">
Graph Mode           </span>|          1.0136
----------------------------------------<span style="color: rgba(0, 0, 0, 1)">
ð å éæ¯: </span>7<span style="color: rgba(0, 0, 0, 1)">.83x
æç»è¾åºå½¢ç¶: torch.Size([</span>7, 512<span style="color: rgba(0, 0, 0, 1)">])

</span>--- æ§è½æµè¯å¼å§: å®éè¯·æ± BS=1 ---<span style="color: rgba(0, 0, 0, 1)">
å¹éå°çæ¡¶: </span>1 (Padding æµªè´¹ç: 0.0%<span style="color: rgba(0, 0, 0, 1)">)
Mode                 </span>|<span style="color: rgba(0, 0, 0, 1)"> Avg Time (ms)  
</span>----------------------------------------<span style="color: rgba(0, 0, 0, 1)">
Eager Mode           </span>|          8.1803<span style="color: rgba(0, 0, 0, 1)">
Graph Mode           </span>|          0.8011
----------------------------------------<span style="color: rgba(0, 0, 0, 1)">
ð å éæ¯: </span>10<span style="color: rgba(0, 0, 0, 1)">.21x
æç»è¾åºå½¢ç¶: torch.Size([</span>1, 512])</pre>
</div>
<p><span data-offset-key="f9vmd-0-0">æ¥ç nsysï¼</span></p>
</div>
<div class="Image-captionContainer" data-size="normal">
<div>
<div class="Image-resizerContainer css-ym3v7r" data-size="normal">
<div class="css-79elbk">
<div>
<div class="ImageDelete-Container css-xi606m">
<div class="ImageDelete-Wrapper css-1gomreu" style="text-align: center"><img src="https://picx.zhimg.com/80/v2-fa4eefbebda0472fa1f21d8bd01e4c17_1440w.png?source=ccfced1a" width="753" height="394" class="Image FocusPlugin--unfocused Image--isBlock css-1phd9a0" loading="lazy" data-size="normal" data-rawwidth="1787" data-rawheight="934" data-watermark="original" data-original-src="https://picx.zhimg.com/v2-fa4eefbebda0472fa1f21d8bd01e4c17.jpg?source=ccfced1a" data-watermark-src="https://pica.zhimg.com/v2-e7ab1f5e1056fe2adbf8d61f3be2c7b2_1440w.jpg?source=ccfced1a"></div>
</div>
</div>
</div>
</div>
</div>
<div style="text-align: center">å¾ 4</div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="dmkhc-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="dmkhc-0-0"><span data-offset-key="dmkhc-0-0">å¯ä»¥çå°ï¼å¨ cuda graph çæ¶åï¼SM ä½¿ç¨æ´ååã</span></div>
</div>
<h2 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="dchee-0-0"><span data-offset-key="dchee-0-0">6.4. Q&amp;A</span></h2>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="e35ln-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="e35ln-0-0"><span data-offset-key="e35ln-0-0">ï¼1ï¼ä¸ºä»ä¹æ¨çæ¶ cuda graph çéæ©è¦éç¨åä¸å¯¹é½çåæ¡¶ç­ç¥ï¼å³ï¼æ¹æ¬¡ç¸ç­æç¨å¤§çï¼èä¸æ¯éæ©æ¹æ¬¡æå¤§çï¼</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="2vaba-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="2vaba-0-0"><span data-offset-key="2vaba-0-0">è½ç¶å¨å»ºå¾ï¼Captureï¼é¶æ®µï¼ç³»ç»ä¼æç§æå¤§æ¹æ¬¡ï¼Max Batch Sizeï¼é¢åç³è¯·å¹¶éå®éææ¾å­ç©ºé´ï¼æ­¤æ¶å³ä¾¿éæ©æå¤§æ¹æ¬¡æ§è¡ä¹ä¸ä¼äº§çé¢å¤çæ¾å­å®¹éæµªè´¹ï¼ä½ä¼å¼å¥ä»¥ä¸ä¸¤ä¸ªç»´åº¦çæ§è½æèï¼</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="6v9hj-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="6v9hj-0-0"><span data-offset-key="6v9hj-0-0">æ¾å­å¸¦å®½çæ æå ç¨ï¼å¤§æ¨¡åæ¨çï¼å°¤å¶æ¯ Decoding é¶æ®µï¼å±äºå¸åçè®¿å­å¯éåä»»å¡ï¼å¶ç¶é¢å¨äºæ¨¡åæéä»æ¾å­å°è®¡ç®ååçæ¬è¿éåº¦ãå³ä¾¿å¤§é¨åæ¹æ¬¡ä½ç½®æ¯ Paddingï¼ç©ºæ°æ®ï¼ï¼CUDA Graph ä¾ç¶ä¼ä¸¥æ ¼æ§è¡å½å¶æ¶çåå­å¯»åå®ä¹ï¼æ¬è¿å®æ´æ¹æ¬¡çæ°æ®ãä½¿ç¨è¿å¤§çæ¹æ¬¡ä¼å¯¼è´ GPU æµªè´¹æå¶å®è´µçå¸¦å®½å»æ¬è¿âæ ææ°æ®âï¼ä»èå¢å åæ¬¡æ¨ççèæ¶ï¼æ¨é«æ¨çå»¶è¿ï¼Latencyï¼ã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="bn155-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="bn155-0-0"><span data-offset-key="bn155-0-0">è®¡ç®èµæºçæ æå ç¨ï¼GPU è°åº¦å¨ä¼æ ¹æ®å¾å®ä¹çè§æ¨¡é¢åéç¡¬ä»¶èµæºï¼å¦ SM æ ¸å¿ãå¯å­å¨ãå±äº«æ¾å­ç­ï¼ãè½ç¶ Padding é¨åçè®¡ç®é»è¾æå¿«ï¼ä½è¿äºèµæºå¨æ´ä¸ª CUDA Graph æ§è¡å®æåæ æ³è¢«éæ¾ãè¿ä¼å¯¼è´ GPU ç¡¬ä»¶å¤äºâèåç¹å¿âç¶æï¼é»å¡äºå¶ä»æ½å¨ä»»å¡ï¼å¦å¤æµå¹¶è¡ç­ï¼è·åç¡¬ä»¶èµæºï¼åå¼±äºç³»ç»æ´ä½çå¹¶åååè½åï¼Throughputï¼ã</span></div>
</div>
<h1 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="2lj8v-0-0"><span data-offset-key="2lj8v-0-0">7. Torch Compilation</span></h1>
<h2 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="5nq47-0-0"><span data-offset-key="5nq47-0-0">7.1. æ¦å¿µçè§£</span></h2>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="cm5ot-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="cm5ot-0-0"><span data-offset-key="cm5ot-0-0">torch.compile è½å¤å° PyTorch å¼ éè®¡ç®ç¸å³ç Python é»è¾ï¼è½¬åä¸ºæ´é«æçä¸­é´è¡¨ç¤ºï¼å¨ CUDA è®¾å¤ä¸ï¼éå¸¸æ¯ Triton åæ ¸ä»£ç ï¼ä¹æ¯æåç CUDA åæ ¸ï¼ãç¸è¾äºä¼ ç»çå³æ¶æ§è¡ï¼Eager Modeï¼ï¼è¿ç§æ¹å¼éè¿ä¼åè®¡ç®åæ ¸æ¬èº«å¸¦æ¥æ¾èçè¿è¡æçæåï¼æ­¤å¤ï¼å½è¾å¥å¼ éå½¢ç¶ãæ°æ®ç±»ååºå®æ¶ï¼torch.compile è¿ä¼èªå¨å¯ç¨ CUDA Graph ä¼åï¼è¿ä¸æ­¥æ¾å¤§æ§è½æ¶çã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="c8lai-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="c8lai-0-0"><span data-offset-key="c8lai-0-0">å¨ torch.compile é®ä¸ä¹åï¼PyTorch å¼åèè¥æ³è¿½æ±é«æ§è½ï¼ä»æä¸¤ç§æ ¸å¿éæ©ï¼ä¸æ¯ä½¿ç¨ Eager Mode æ¥åå¶åçæ§è½ä¸éï¼äºæ¯æå¨ç¼å Triton æ CUDA åºå±åæ ¸ä»£ç ï¼è¯¥æ¹å¼å¼åé¨æ§é«ãå¨æé¿ãç»´æ¤ææ¬é«ï¼ãèæäº torch.compile åï¼å¼åèåªéç¼åç®æ´ææç PyTorch Python ä¸å¡é»è¾ï¼æ éå³æ³¨åºå±ç¡¬ä»¶ééä¸åæ ¸å®ç°ï¼å³å¯è·å¾æ¥è¿æå Triton/CUDA çä¼å¼æ§è½ï¼å¤§å¹å¹³è¡¡äºå¼åæçä¸è¿è¡æ§è½ã</span></div>
</div>
<h2 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="6rc4c-0-0"><span data-offset-key="6rc4c-0-0">7.2. ä½¿ç¨æ¹æ³</span></h2>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="c5lru-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="c5lru-0-0"><span data-offset-key="c5lru-0-0">åºç¨ torch.compile éå¸¸ç®åï¼æ ¸å¿æä¸¤ç±»ä½¿ç¨æ¹å¼ï¼</span></div>
</div>
<ul class="public-DraftStyleDefault-ul" data-offset-key="fmk6u-0-0">
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-reset public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="fmk6u-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="fmk6u-0-0"><span data-offset-key="fmk6u-0-0">è£é¥°å¨æ¹å¼ï¼å¨ PyTorch å½æ°ä¸ç´æ¥æ·»å  @torch.compile è£é¥°å¨ï¼å®ä¹æ¶å³å®æç¼è¯å£°æï¼</span></div>
</li>
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="4elg8-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="4elg8-0-0"><span data-offset-key="4elg8-0-0">æ¾å¼è°ç¨æ¹å¼ï¼éè¿ compiled_obj = torch.compile(target) æ¾å¼ç¼è¯ç®æ å¯¹è±¡ï¼åç»­è°ç¨ compiled_obj å³å¯ä½¿ç¨ä¼ååçé»è¾ï¼</span></div>
</li>
</ul>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="5ho4n-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="5ho4n-0-0"><span data-offset-key="5ho4n-0-0">å¦å¤ï¼å¯ä»¥å¯¹æ¨¡åå®ä¾çç´æ¥ç¼è¯ï¼å¯¹äº PyTorch æ¨¡åï¼nn.Module å­ç±»å®ä¾ï¼ï¼å¯ç´æ¥ä¼ å¥ torch.compile å®ææ´ä½ç¼è¯ï¼æ éåç¬ä¿®é¥° forward æ¹æ³ã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="c8n8n-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="c8n8n-0-0"><span data-offset-key="c8n8n-0-0">ç¤ºä¾ä»£ç ï¼</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="b4tlg-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="b4tlg-0-0"><span data-offset-key="b4tlg-0-0">æ¹å¼ 1ï¼è£é¥°å¨æ¹å¼ï¼éç¨äºå½æ° / æ¨¡åæ¹æ³ï¼</span></div>
</div>
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="fipu7-0-0">
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> torch
</span><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> torch.nn as nn

</span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> å¯¹æ®éPyTorchå½æ°ä½¿ç¨è£é¥°å¨</span>
<span style="color: rgba(0, 0, 0, 1)">@torch.compile
</span><span style="color: rgba(0, 0, 255, 1)">def</span><span style="color: rgba(0, 0, 0, 1)"> my_tensor_func(x, y):
    </span><span style="color: rgba(0, 0, 255, 1)">return</span> torch.matmul(x, y) +<span style="color: rgba(0, 0, 0, 1)"> torch.relu(y)

</span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> å¯¹æ¨¡åçforwardæ¹æ³ä½¿ç¨è£é¥°å¨</span>
<span style="color: rgba(0, 0, 255, 1)">class</span><span style="color: rgba(0, 0, 0, 1)"> MyModel(nn.Module):
    @torch.compile  </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> ä¿®é¥°forwardæ¹æ³ï¼èªå¨ç¼è¯æ¨¡åæ¨çé»è¾</span>
    <span style="color: rgba(0, 0, 255, 1)">def</span><span style="color: rgba(0, 0, 0, 1)"> forward(self, x):
        </span><span style="color: rgba(0, 0, 255, 1)">return</span> nn.Linear(10, 20)(x)</pre>
</div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="3u91i-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="3u91i-0-0"><span data-offset-key="3u91i-0-0">æ¹å¼ 2ï¼æ¾å¼è°ç¨æ¹å¼ï¼éç¨äºå½æ° / æ¨¡åï¼çµæ´»æ§æ´é«ï¼</span></div>
</div>
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="75c4t-0-0">
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> torch
</span><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> torch.nn as nn

</span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> æ¾å¼ç¼è¯æ®éå½æ°</span>
<span style="color: rgba(0, 0, 255, 1)">def</span><span style="color: rgba(0, 0, 0, 1)"> my_tensor_func(x, y):
    </span><span style="color: rgba(0, 0, 255, 1)">return</span> torch.matmul(x, y) +<span style="color: rgba(0, 0, 0, 1)"> torch.relu(y)
compiled_func </span>= torch.compile(my_tensor_func)  <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> çæç¼è¯åçå½æ°</span>
output = compiled_func(torch.randn(32, 10), torch.randn(10, 20))  <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> è°ç¨ç¼è¯åçå½æ°</span>

<span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> æ¾å¼ç¼è¯æ¨¡åï¼ä¸æ¹å¼3æ¬è´¨ä¸è´ï¼æ´å¼ºè°âåç¼è¯åä½¿ç¨âçæ¾å¼æµç¨ï¼</span>
<span style="color: rgba(0, 0, 255, 1)">class</span><span style="color: rgba(0, 0, 0, 1)"> MyModel(nn.Module):
    </span><span style="color: rgba(0, 0, 255, 1)">def</span><span style="color: rgba(0, 0, 0, 1)"> forward(self, x):
        </span><span style="color: rgba(0, 0, 255, 1)">return</span> nn.Linear(10, 20<span style="color: rgba(0, 0, 0, 1)">)(x)
model </span>=<span style="color: rgba(0, 0, 0, 1)"> MyModel()
compiled_model </span>= torch.compile(model)  <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> ç´æ¥ç¼è¯æ´ä¸ªæ¨¡åå®ä¾</span>
output = compiled_model(torch.randn(32, 10))  <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> è°ç¨ç¼è¯åçæ¨¡å</span></pre>
</div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="ksl4-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="ksl4-0-0"><span data-offset-key="ksl4-0-0">æ¹å¼ 3ï¼ç´æ¥ç¼è¯æ¨¡åå®ä¾ï¼æ·±åº¦å­¦ä¹ ä¸­æå¸¸ç¨ï¼ç®ååæ³ï¼</span></div>
</div>
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="71fom-0-0">
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> torch
</span><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> torch.nn as nn

</span><span style="color: rgba(0, 0, 255, 1)">class</span><span style="color: rgba(0, 0, 0, 1)"> MyModel(nn.Module):
    </span><span style="color: rgba(0, 0, 255, 1)">def</span><span style="color: rgba(0, 0, 0, 1)"> forward(self, x):
        </span><span style="color: rgba(0, 0, 255, 1)">return</span> nn.Linear(10, 20<span style="color: rgba(0, 0, 0, 1)">)(x)

</span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> ç´æ¥ç¼è¯æ¨¡åå®ä¾ï¼ä¸æ­¥å°ä½ï¼æ éè£é¥°å¨ï¼æç®æ´å¸¸ç¨ï¼</span>
model =<span style="color: rgba(0, 0, 0, 1)"> torch.compile(MyModel())
output </span>= model(torch.randn(32, 10))</pre>
</div>
</div>
<h2 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="785ra-0-0"><span data-offset-key="785ra-0-0">7.3. æ§è½å¯¹æ¯</span></h2>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="3uufk-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="3uufk-0-0"><span data-offset-key="3uufk-0-0">ä¸é¢ä»¥ä¸ä¸ªç®åçä¾å­å¯¹æ¯ Eager Mode å Compiled Modeï¼</span></div>
</div>
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="54acu-0-0">
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> torch
</span><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> time

</span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> ç¡®ä¿ä½¿ç¨çæ¯ GPU</span>
device = <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">cuda</span><span style="color: rgba(128, 0, 0, 1)">"</span> <span style="color: rgba(0, 0, 255, 1)">if</span> torch.cuda.is_available() <span style="color: rgba(0, 0, 255, 1)">else</span> <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">cpu</span><span style="color: rgba(128, 0, 0, 1)">"</span>
<span style="color: rgba(0, 0, 255, 1)">if</span> device == <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">cpu</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">:
    </span><span style="color: rgba(0, 0, 255, 1)">print</span>(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">è­¦åï¼CUDA ä¸å¯ç¨ï¼å°ä½¿ç¨ CPU è¿è¡ï¼torch.compile çä¼å¿å¨ GPU ä¸æææ¾ï¼ã</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)

</span><span style="color: rgba(0, 0, 255, 1)">def</span><span style="color: rgba(0, 0, 0, 1)"> complex_operation_eager(x, y):
    z </span>= x *<span style="color: rgba(0, 0, 0, 1)"> y
    z </span>= z +<span style="color: rgba(0, 0, 0, 1)"> x
    z </span>=<span style="color: rgba(0, 0, 0, 1)"> torch.relu(z)
    </span><span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)"> z.sum()

@torch.compile
</span><span style="color: rgba(0, 0, 255, 1)">def</span><span style="color: rgba(0, 0, 0, 1)"> complex_operation_graph(x, y):
    z </span>= x *<span style="color: rgba(0, 0, 0, 1)"> y
    z </span>= z +<span style="color: rgba(0, 0, 0, 1)"> x
    z </span>=<span style="color: rgba(0, 0, 0, 1)"> torch.relu(z)
    </span><span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)"> z.sum()

</span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> 1. åå¤æ°æ®</span>
x = torch.randn(10000, 10000, device=<span style="color: rgba(0, 0, 0, 1)">device)
y </span>= torch.randn(10000, 10000, device=<span style="color: rgba(0, 0, 0, 1)">device)

</span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> 2. ç­èº« (Warm up)</span>
<span style="color: rgba(0, 0, 255, 1)">print</span>(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">æ­£å¨ç¼è¯å¹¶è¿è¡å¤æ¬¡ç­èº«ä»¥ç¨³å® GPU ç¶æ...</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
</span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> å¢å ç­èº«å¾ªç¯</span>
<span style="color: rgba(0, 0, 255, 1)">for</span> i <span style="color: rgba(0, 0, 255, 1)">in</span> range(3<span style="color: rgba(0, 0, 0, 1)">): 
    complex_operation_graph(x, y)
    </span><span style="color: rgba(0, 0, 255, 1)">if</span> i ==<span style="color: rgba(0, 0, 0, 1)"> 0:
        </span><span style="color: rgba(0, 0, 255, 1)">print</span>(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">-&gt; é¦æ¬¡ç¼è¯å®æï¼æ­£å¨è¿è¡åç»­é¢ç­...</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)

torch.cuda.synchronize()
</span><span style="color: rgba(0, 0, 255, 1)">print</span>(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">é¢ç­å®æ¯ï¼å¼å§æ­£å¼æµè¯ã</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)

</span><span style="color: rgba(0, 0, 255, 1)">def</span> benchmark(func, x, y, label, iterations=100<span style="color: rgba(0, 0, 0, 1)">):
    start_event </span>= torch.cuda.Event(enable_timing=<span style="color: rgba(0, 0, 0, 1)">True)
    end_event </span>= torch.cuda.Event(enable_timing=<span style="color: rgba(0, 0, 0, 1)">True)
    
    start_event.record()
    </span><span style="color: rgba(0, 0, 255, 1)">for</span> _ <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> range(iterations):
        func(x, y)
    end_event.record()
    
    torch.cuda.synchronize()
    
    elapsed_time_ms </span>=<span style="color: rgba(0, 0, 0, 1)"> start_event.elapsed_time(end_event)
    avg_time_s </span>= (elapsed_time_ms / 1000) /<span style="color: rgba(0, 0, 0, 1)"> iterations
    </span><span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">{label} å¹³åèæ¶: {avg_time_s:.6f} ç§</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
    </span><span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)"> avg_time_s

</span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> 3. æ§è¡æµè¯å¹¶è®¡ç®å éæ¯</span>
<span style="color: rgba(0, 0, 0, 1)">with torch.no_grad():
    </span><span style="color: rgba(0, 0, 255, 1)">print</span>(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">-</span><span style="color: rgba(128, 0, 0, 1)">"</span> * 30<span style="color: rgba(0, 0, 0, 1)">)
    eager_time </span>= benchmark(complex_operation_eager, x, y, <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Eager Mode   </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
    compile_time </span>= benchmark(complex_operation_graph, x, y, <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Compiled Mode</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
    </span><span style="color: rgba(0, 0, 255, 1)">print</span>(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">-</span><span style="color: rgba(128, 0, 0, 1)">"</span> * 30<span style="color: rgba(0, 0, 0, 1)">)
    
    </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> è®¡ç®å éæ¯é»è¾</span>
    speedup = eager_time /<span style="color: rgba(0, 0, 0, 1)"> compile_time
    improvement </span>= (speedup - 1) * 100
    
    <span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">æ§è½æåç»æ:</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
    </span><span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">å éæ¯ (Speedup): {speedup:.2f}x</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
    </span><span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">è¿è¡éåº¦æåäº: {improvement:.1f}%</span><span style="color: rgba(128, 0, 0, 1)">"</span>)</pre>
</div>
<p><span data-offset-key="2kshu-0-0">è¿è¡è¾åºï¼</span></p>
</div>
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="6b49q-0-0">
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 0, 1)">æ­£å¨ç¼è¯å¹¶è¿è¡å¤æ¬¡ç­èº«ä»¥ç¨³å® GPU ç¶æ...
</span>-&gt;<span style="color: rgba(0, 0, 0, 1)"> é¦æ¬¡ç¼è¯å®æï¼æ­£å¨è¿è¡åç»­é¢ç­...
é¢ç­å®æ¯ï¼å¼å§æ­£å¼æµè¯ã
</span>------------------------------<span style="color: rgba(0, 0, 0, 1)">
Eager Mode    å¹³åèæ¶: </span>0.005690<span style="color: rgba(0, 0, 0, 1)"> ç§
Compiled Mode å¹³åèæ¶: </span>0.001528<span style="color: rgba(0, 0, 0, 1)"> ç§
</span>------------------------------<span style="color: rgba(0, 0, 0, 1)">
æ§è½æåç»æ:
å éæ¯ (Speedup): </span>3<span style="color: rgba(0, 0, 0, 1)">.72x
è¿è¡éåº¦æåäº: </span>272.3%</pre>
</div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="8r98n-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="8r98n-0-0"><span data-offset-key="8r98n-0-0">æ§è½ææ°åçæåã</span></div>
</div>
<h2 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="a8508-0-0"><span data-offset-key="a8508-0-0">7.4. Q&amp;A</span></h2>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="1pjmk-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="1pjmk-0-0"><span data-offset-key="1pjmk-0-0">ï¼1ï¼æ¢ç¶ torch.compile æè¿ä¹å¤§çå¥½å¤ï¼ä¸ºä»ä¹ä¸è½ç»ææçå¼ éæä½å½æ°é½å ä¸ @torch.compileï¼</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="eem3i-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="eem3i-0-0"><span data-offset-key="eem3i-0-0">æå æ¹é¢çåå ï¼é¦åï¼å­å¨ç¼è¯å¼éï¼ä¼å¯¼è´é¦æ¬¡è¿è¡æ¾èåæ¢ï¼ç¶åï¼ç¼è¯å¨çæç Triton åæ ¸ï¼æå¶ä»åç«¯ä»£ç ï¼éå¸¸æ¯éå¯¹ç¹å®å¼ éå½¢ç¶ãæ°æ®ç±»ååè®¾å¤éç½®ä¼åçï¼å¦æè¾å¥å¼ éçè¿äºå±æ§é¢ç¹ååï¼ä¼åå¤è§¦åéæ°ç¼è¯ï¼å³ âç¼è¯ç¼å­å¤±æâï¼ï¼åèæµæ¶æ§è½æ¶çï¼ç¬¬ä¸ï¼torch.compile èªèº«ä¼å¸¦æ¥é¢å¤çæ¾å­å¼éï¼ç¨äºå­å¨ç¼è¯åçä¸­é´è¡¨ç¤ºãåæ ¸ç¼å­ç­ï¼ï¼è¿å¤æ å·®å«ä½¿ç¨å¯è½å¯¼è´æ¾å­ä¸è¶³ï¼OOMï¼ï¼æåï¼å¹¶éææä»£ç é½è½è¢«æåå¾åä¼åï¼å¦æå¼ éæä½ä¸­è°ç¨äºé PyTorch åççç¬¬ä¸æ¹åºï¼æçº¯ Python åçé»è¾ï¼ï¼ä¼å¯¼è´è®¡ç®å¾ä¸­æ­ï¼æ­¤æ¶ç¼è¯å¨æ æ³ç»§ç»­ä¼ååç»­é»è¾ï¼è¿éè¦å°æ§å¶æäº¤åç» Python è§£éå¨ï¼äº§çä¸å¿è¦çä¸ä¸æåæ¢å¼éï¼å¯è½å¯¼è´è´ä¼åã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="7ngdh-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="7ngdh-0-0"><span data-offset-key="7ngdh-0-0">ï¼2ï¼torch.compile æ¯æçæåç CUDA åæ ¸ä»£ç ï¼ä½éå¸¸æ¥è¯´ï¼ç¼è¯å¨èªå¨çæçéç¨åç CUDA ä»£ç ä¼åç²åº¦ä¸å¤ç²¾ç»ï¼è Triton åç½®äºæå¼ºç Autotuningï¼èªå¨è°ä¼ï¼è½åï¼éå¯¹æ·±åº¦å­¦ä¹ å¼ éè®¡ç®åºæ¯åäºæ·±åº¦ééï¼å æ­¤å¨ç»å¤§å¤æ°æ·±åº¦å­¦ä¹ ä»»å¡ä¸­ï¼Triton åæ ¸çæ§è½éå¸¸ä¼äºèªå¨çæçåç CUDA åæ ¸ã</span></div>
</div>
<h1 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="cjuuo-0-0"><span data-offset-key="cjuuo-0-0">8. Torch CompilationãTritionãCUDA Graph ä¸èçåºå«åèç³»</span></h1>
<h2 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="6nkil-0-0"><span data-offset-key="6nkil-0-0">8.1. æ ¸å¿åºå«</span></h2>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="2n3n3-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="2n3n3-0-0"><span data-offset-key="2n3n3-0-0">ï¼1ï¼Torch Compilationï¼PyTorch é«å±ä¸ç«å¼æ§è½ä¼åå¥å£ï¼ç¨æ·ææ½è±¡æ¥å£ï¼</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="apt7h-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="apt7h-0-0"><span data-offset-key="apt7h-0-0">ä½ä¸ºé¢åå¼åèçé¡¶çº§ä¼åå°è£ï¼torch.compile æ éå¼åèå³æ³¨åºå±ç¡¬ä»¶ç»èä¸ä¼åå®ç°ï¼å¶æ ¸å¿å®ä½æ¯å¯¹ PyTorch å¼ éè®¡ç®é»è¾ï¼å½æ° /nn.Module æ¨¡åï¼è¿è¡ç«¯å°ç«¯èªå¨ä¼åï¼å±è½äºåºå±åæ ¸çæä¸æ§è¡ä¼åçå¤ææ§ï¼æ¯ç»å¤§å¤æ° PyTorch å¼åèçé¦éæ§è½ä¼åå·¥å·ã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="9i7c0-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="9i7c0-0-0"><span data-offset-key="9i7c0-0-0">ï¼2ï¼Tritonï¼é«æ§è½ GPU åæ ¸ä¸ç¨ DSL </span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="5ts50-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="5ts50-0-0"><span data-offset-key="5ts50-0-0">Triton æ¢æ¯å¼åèæå¨ç¼åé«æ§è½åæ ¸çé¢åä¸ç¨è¯­è¨ï¼DSLï¼ï¼ä¹æ¯ torch.compile èªå¨åçæä»£ç çæ ¸å¿ç®æ åç«¯ãå¶ä¸­ï¼triton.jit æ¯ Triton æ¡æ¶æä¾çå³æ¶ç¼è¯è£é¥°å¨ï¼å®ä½ä¸ºé«æ§è½è·¨å¹³å° GPU åæ ¸çæå¨å¼åå¥å£ï¼æ½è±¡å±çº§ä½äº torch.compileãé«äºåç CUDA C++ãå®åè®¸å¼åèä»¥ Python é£æ ¼è¯­æ³ç¼å GPU åæ ¸é»è¾ï¼æ éæå¨å¤ççº¿ç¨è°åº¦ãå¯å­å¨åéç­åºå±ç»èï¼æç»ç¼è¯ä¸ºé«æ GPU æºå¨ç ï¼ç¨äºæ»¡è¶³å®å¶åç®å­çé«æ§è½éæ±ã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="7706f-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="7706f-0-0"><span data-offset-key="7706f-0-0">ï¼3ï¼CUDA Graphï¼GPU åºå±éæä»»å¡æµæ§è¡ä¼åææ¯</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="d2kt1-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="d2kt1-0-0"><span data-offset-key="d2kt1-0-0">CUDA Graph æ¯ä¸ç§éæä»»å¡æµè°åº¦ææ¯ï¼æ¨å¨æ¶é¤ä¸»æºç«¯ï¼Hostï¼ä¸è®¾å¤ç«¯ï¼Deviceï¼ä¹é´çäº¤äºå»¶è¿ãå®å¹¶é âåæ ¸çæå·¥å·âï¼ä¹é âç¨æ·æç¼ç¨æ¥å£âï¼èæ¯éå¯¹ CPU-GPU äº¤äºç¶é¢çåºå±æ§è¡ä¼åææ¯ï¼æ½è±¡å±çº§æä½ãå¶æ ¸å¿ä½ç¨æ¯åºåè¿ç»­ç CUDA åæ ¸è°ç¨åºåä¸åå­éç½®ï¼éè¿ âå½å¶ - éæ¾â æ¨¡å¼æ¶é¤éå¤åæ ¸å¯å¨ãCPU-GPU é¢ç¹éä¿¡çå¼éï¼ä»ä¼åæ§è¡æµç¨ï¼ä¸æ¹ååæ ¸æ¬èº«çè®¡ç®æ§è½ã</span></div>
</div>
<h2 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="b3b7c-0-0"><span data-offset-key="b3b7c-0-0">8.2. æ ¸å¿èç³»</span></h2>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="4qtm8-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="4qtm8-0-0"><span data-offset-key="4qtm8-0-0">ï¼1ï¼torch.compile ä¾èµ triton.jit å®ç°é«æ§è½åæ ¸çæ</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="1bgf5-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="1bgf5-0-0"><span data-offset-key="1bgf5-0-0">torch.compile çé»è®¤åºå±ç¼è¯å¨ï¼Inductorï¼å¨ CUDA è®¾å¤ä¸ï¼ä¼èªå¨å° PyTorch è®¡ç®é»è¾è½¬åä¸º Triton åæ ¸ä»£ç ï¼å¹¶éå¼è°ç¨ triton.jit å®æç¼è¯ï¼çæé«æ§è½ GPU åæ ¸ï¼å¼åèæ éæå¨ç¼å Triton ä»£ç ï¼ä¹æ éæç¥ triton.jit çå­å¨ï¼ãæ­¤å¤ï¼torch.compile ä¹æ¯æçæåç CUDA åæ ¸ï¼ä½ä¸º Triton åæ ¸çå¯éè¡¥åæ¹æ¡ã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="3toqg-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="3toqg-0-0"><span data-offset-key="3toqg-0-0">ï¼2ï¼torch.compile éæ CUDA Graph å®ç°æ§è¡å±äºæ¬¡ä¼å</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="ch8uv-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="ch8uv-0-0"><span data-offset-key="ch8uv-0-0">å½è¾å¥å¼ éçå½¢ç¶ãæ°æ®ç±»åç­å±æ§åºå®æ¶ï¼torch.compile ä¼èªå¨å¯ç¨ CUDA Graph ä¼åï¼å°ç¼è¯çæç Triton/CUDA åæ ¸è°ç¨åºåå½å¶ä¸º CUDA å¾ãåç»­éå¤æ§è¡è¯¥é»è¾æ¶ï¼ç´æ¥å¨ GPU ä¸éæ¾è¯¥å¾ï¼è¿ä¸æ­¥æ¾å¤§æ§è½æ¶çï¼å®ç° âåæ ¸è®¡ç®ä¼åâ ä¸ âæ§è¡æµç¨ä¼åâ çååå¢æã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="8idqa-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="8idqa-0-0"><span data-offset-key="8idqa-0-0">ï¼3ï¼triton.jit èªå®ä¹åæ ¸å¯ä¸ CUDA Graph æå¨åå</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="4r30e-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="4r30e-0-0"><span data-offset-key="4r30e-0-0">å¼åèæå¨éè¿ triton.jit ç¼åå¹¶ç¼è¯çèªå®ä¹åæ ¸ï¼å¨æ¹ééå¤æ§è¡ï¼è¾å¥å½¢ç¶åºå®ï¼çåºæ¯ä¸ï¼å¯æå¨éæ CUDA Graph å®æ âå½å¶ - éæ¾â æµç¨ï¼æ¶é¤ CPU å¯¹ GPU çè°åº¦å¼éï¼å®ç°åæ ¸è®¡ç®æ§è½ä¸æ§è¡æççåéæè´ä¼åã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="bju28-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="bju28-0-0"><span data-offset-key="bju28-0-0">ï¼4ï¼ä¸èååæå»ºæè´æ§è½è®¡ç®é¾è·¯</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="1aest-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="1aest-0-0"><span data-offset-key="1aest-0-0">å¸åæè´æ§è½é¾è·¯ï¼æå¨ç¼å triton.jit å®å¶åæ ¸ â åµå¥ PyTorch æ¨¡å / å½æ° â éè¿ torch.compile è¿è¡ä¸å±è®¡ç®å¾ä¼åï¼ç®å­èåãåå­å¤ç¨ç­ï¼ â torch.compile èªå¨å¯ç¨ CUDA Graph ä¼åæ§è¡æµç¨ â å®ç° GPU è®¡ç®æ§è½æå¤§åã</span></div>
</div>
<h1 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="fu2v8-0-0"><span data-offset-key="fu2v8-0-0">9. TP æ¨¡å¼</span></h1>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="7u897-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="7u897-0-0"><span data-offset-key="7u897-0-0">TP æ¨¡å¼å°ç©éµè®¡ç®æè¡ãåæåå°å¤é¢ GPU ä¸æ§è¡ï¼æ¶åä¸¤ä¸ªå³é®ç¹ï¼æéåæ°æä¹å è½½ãå¤æ ¸è®¡ç®ä¹é´å¦ä½ååï¼ä¸é¢åä»ç»ã</span></div>
</div>
<h2 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="9ug66-0-0"><span data-offset-key="9ug66-0-0">9.1. å è½½æéåæ°</span></h2>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="1ed97-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="1ed97-0-0"><span data-offset-key="1ed97-0-0">æéåæ°ä¸ç©éµè®¡ç®å¼ºç¸å³ï¼å æ­¤æéåæ°çå è½½é»è¾éå¸¸ä¸ç©éµè®¡ç®é»è¾ä¸åå°è£å¨åä¸ä¸ªç±»ä¸­ï¼å®ç°åè½çåèæ§ã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="a4too-0-0">
<h3 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="a4too-0-0"><span data-offset-key="a4too-0-0">9.1.1. å³é®ææ¯ç¹</span></h3>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="9sa3o-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="9sa3o-0-0"><span data-offset-key="9sa3o-0-0">ï¼1ï¼åæ°æä»¶ä¸­ï¼æéç©éµä»¥ Key-Value é®å¼å¯¹å½¢å¼å­å¨ï¼è¯»åæ¶åæ ·éç¨ Key-Value æ¹å¼è§£æãå¶ä¸­ key å¯¹åºæéç©éµå¨æ¨¡åä¸­çå½å±ä½ç½®ï¼ä¾å¦ï¼æ¨¡åç¬¬ 0 å± MLP å­å±ç down proj æéå¯¹åºç key ä¸º model.layers.0.mlp.down_proj.weightã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="7ppg-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="7ppg-0-0"><span data-offset-key="7ppg-0-0">ï¼2ï¼åæ°æä»¶ç±è®­ç»æµç¨åå¥ãæ¨çæµç¨è¯»åï¼è®­ç»ä¸æ¨çä¸¤ä¾§å¿é¡»ä¸¥æ ¼å¯¹é½ key çå½åè§åãæ¨¡ååæ°å è½½æ¶ï¼ä¼æ ¹æ®åæ°æä»¶ä¸­ç key åç§°ï¼å¨ nn.Module å¯¹è±¡ä¸­å¹éå¹¶è°ç¨å¯¹åºç weight_loader æ¹æ³å®æå è½½ã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="755gf-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="755gf-0-0"><span data-offset-key="755gf-0-0">ï¼3ï¼æ¨¡åç»æåå«å¤ä¸ªå±çº§ï¼æ¯ä¸å±åé¨ååå«å¤ä¸ªå­æ¨¡åï¼ä¸åå­æ¨¡åå¯¹åºåèªä¸å±çåæ°å è½½æ¹æ³ãPyTorch ç nn.Module éè¿ç¹æ®æ¹æ³ __setattr__ï¼å°æ¨¡åç»æä¸­çåä¸ªå­æ¨¡åæå»ºä¸ºæ å½¢ç»æï¼æ å½¢ç»æä¸­æ¯ä¸ªå¶å­èç¹çè·¯å¾ï¼ä¸åæ°æä»¶ä¸­ç key ä¸ä¸æ å°ï¼éè¿è¯¥è·¯å¾æ¾å°å¶å­èç¹åï¼å³å¯è·åå¯¹åºçåæ°å¯¹è±¡ nn.Parameterï¼èè¯¥åæ°å¯¹è±¡ç»å®äºå¶æå±å­æ¨¡åç weight_loader æ¹æ³ã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="6bnm0-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="6bnm0-0-0"><span data-offset-key="6bnm0-0-0">ï¼4ï¼ç©éµä¹æ³ A * B éµå¾ªãA çè¡ Ã B çåãè®¡ç®è§åï¼å¨æ¨¡åæ¨çä¸­ï¼B ä¸ºæéç©éµï¼å®éè®¿é®æ¶ä»¥åç»´åº¦ä¸ºä¸»ãä¸ºæåè¯»åæçãé¿åç¼å­ï¼Cacheï¼é¢ç¹å¤±æï¼æéç©éµ B éå¸¸ä»¥è½¬ç½®å½¢å¼å­å¨ãTPï¼Tensor Parallelï¼worker å è½½æéæ¶ï¼éééè¯¥è½¬ç½®å­å¨ç¹æ§ ââ å³æéç©éµç¬¬ 0 ç»´å¯¹åºåå§ç©éµçåæ°æ®ï¼ç¬¬ 1 ç»´å¯¹åºåå§ç©éµçè¡æ°æ®ã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="5ju20-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="5ju20-0-0"><span data-offset-key="5ju20-0-0">ä»ä¸è¿°ææ¯ç¹å¯å¾åºæ ¸å¿å¯¹åºå³ç³»ï¼åæ°æä»¶ä¸­çæ¨¡åç»æä»¥ä¸ä¸ªä¸ª key è¡¨ç¤ºï¼è¿äº key æå±çº§å³ç³»å¯æå»ºä¸ºä¸æ£µè·¯å¾æ ï¼ä»£ç ä¸­çæ¨¡åç»æä»¥æåå«å³ç³»çç±»å¯¹è±¡è¡¨ç¤ºï¼è¿äºç±»å¯¹è±¡åæ ·ææä¸æ£µä¸åæ°æä»¶è·¯å¾æ å®å¨å¯¹åºçæ ã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="b27tp-0-0">
<h3 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="b27tp-0-0"><span data-offset-key="b27tp-0-0">9.1.2. å®æä¸¾ä¾ï¼FFN å± up proj æéå è½½ï¼</span></h3>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="3icrf-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="3icrf-0-0"><span data-offset-key="3icrf-0-0">ï¼1ï¼åè®¾ TP size=2ï¼up proj æéç©éµçåå§å½¢ç¶ä¸º [1024, 3072]ï¼ä¸é¢ä»ç»ä¸ä¸ª TP worker å¦ä½å è½½æéã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="f26gi-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="f26gi-0-0"><span data-offset-key="f26gi-0-0">ï¼2ï¼é¦åï¼æé æ¨¡åå¯¹è±¡æ¶ï¼ä¼åå§å ColumnParallelLinear å¯¹è±¡ï¼å¹¶è®¾å®æ ¸å¿åæ°ï¼input_size=1024ï¼output_size=3072/2=1536ï¼æ TP å°ºå¯¸åååï¼ãè¿ä¸¤ä¸ªåæ°æç»ç¨äºåå§å nn.Parameter å¯¹è±¡ï¼å¯¹åºä»£ç ä¸º <span data-offset-key="f26gi-0-1"><span data-text="true">self.weight = nn.Parameter(torch.empty(output_size, input_size))<span data-offset-key="f26gi-0-2">ï¼éæ³¨ææ­¤å¤åå§åçå¼ éä»¥ output_size ä¸ºè¡ç»´åº¦ãinput_size ä¸ºåç»´åº¦ã</span></span></span></span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="6s4r7-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="6s4r7-0-0"><span data-offset-key="6s4r7-0-0">ï¼3ï¼éåï¼å¯å¨æ¨¡åæéå è½½æµç¨ï¼åä»åæ°æä»¶ä¸­è¯»åææ key-value é®å¼å¯¹ï¼åéè¿ key å¨ nn.Module æ å½¢ç»æä¸­æ¥æ¾å¯¹åºç nn.Parameter å¯¹è±¡ï¼å¹éå°åè°ç¨å¶ç»å®ç weight_loader å½æ°ï¼æ§è¡å·ä½çåæ°å è½½æä½ã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="egb30-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="egb30-0-0"><span data-offset-key="egb30-0-0">ï¼4ï¼åæ°å è½½é¶æ®µï¼éå¯¹åå¹¶è¡æ¨¡å¼ï¼éè¦å¯¹æéå¼ éçç¬¬ 0 ç»´åº¦è¿è¡æåï¼åæ ¹æ®å½åè¿ç¨ç tp_rankï¼TP è¿ç¨ç¼å·ï¼ï¼ç¡®å®æ¬è¿ç¨éè¦å è½½çæéåºé´ï¼å®æåçæéçå è½½ã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="49qid-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="49qid-0-0"><span data-offset-key="49qid-0-0">æ³¨ï¼ä»£ç å®ç°ä¸­ï¼ä¼å° gate ç©éµä¸ up ç©éµè¿è¡åå¹¶å è½½å°æ¾å­ä¸­ï¼å æ­¤å®éå è½½æµç¨ä¼å¨æ­¤åºç¡ä¸å¢å å æ­¥é¢å¤æ­¥éª¤ã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="248v7-0-0">
<h3 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="248v7-0-0"><span data-offset-key="248v7-0-0">9.1.3. æé æ å½¢ç»æç¤ºä¾ä»£ç </span></h3>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="elaid-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="elaid-0-0"><span data-offset-key="elaid-0-0">ä¸é¢ demo ä»£ç å±ç¤ºå¤ä¸ªæå±çº§çå¯¹è±¡å¦ä½éè¿ç¹æ®æ¹æ³ __setattr__ æé æ å½¢ç»æ.</span></div>
</div>
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="3hpeh-0-0">
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 255, 1)">class</span><span style="color: rgba(0, 0, 0, 1)"> MiniModule:
    </span><span style="color: rgba(0, 0, 255, 1)">def</span> <span style="color: rgba(128, 0, 128, 1)">__init__</span>(self, name=<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">root</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">):
        self._name </span>=<span style="color: rgba(0, 0, 0, 1)"> name
        self._modules </span>=<span style="color: rgba(0, 0, 0, 1)"> {}
        self._parameters </span>=<span style="color: rgba(0, 0, 0, 1)"> {}

    </span><span style="color: rgba(0, 0, 255, 1)">def</span> <span style="color: rgba(128, 0, 128, 1)">__setattr__</span><span style="color: rgba(0, 0, 0, 1)">(self, name, value):
        </span><span style="color: rgba(0, 0, 255, 1)">if</span><span style="color: rgba(0, 0, 0, 1)"> isinstance(value, MiniModule):
            self._modules[name] </span>=<span style="color: rgba(0, 0, 0, 1)"> value
        </span><span style="color: rgba(0, 0, 255, 1)">elif</span> name.endswith(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">_weight_loader</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">):
            self._parameters[name] </span>=<span style="color: rgba(0, 0, 0, 1)"> value

        super().</span><span style="color: rgba(128, 0, 128, 1)">__setattr__</span><span style="color: rgba(0, 0, 0, 1)">(name, value)

    </span><span style="color: rgba(0, 0, 255, 1)">def</span> get_all_paths(self, prefix=<span style="color: rgba(128, 0, 0, 1)">""</span><span style="color: rgba(0, 0, 0, 1)">):
        </span><span style="color: rgba(128, 0, 0, 1)">"""</span><span style="color: rgba(128, 0, 0, 1)">éå½éåå¹¶æ¶éææåæ°çå®æ´è·¯å¾</span><span style="color: rgba(128, 0, 0, 1)">"""</span><span style="color: rgba(0, 0, 0, 1)">
        paths </span>=<span style="color: rgba(0, 0, 0, 1)"> []

        </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> 1. åæ¶éå½åå±çº§çåæ°è·¯å¾</span>
        <span style="color: rgba(0, 0, 255, 1)">for</span> p_name <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> self._parameters:
            full_path </span>= f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">{prefix}.{p_name}</span><span style="color: rgba(128, 0, 0, 1)">"</span> <span style="color: rgba(0, 0, 255, 1)">if</span> prefix <span style="color: rgba(0, 0, 255, 1)">else</span><span style="color: rgba(0, 0, 0, 1)"> p_name
            paths.append(full_path)

        </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> 2. éå½è¿å¥å­æ¨¡åï¼ä¼ éæ´æ°åçåç¼</span>
        <span style="color: rgba(0, 0, 255, 1)">for</span> m_name, m_obj <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> self._modules.items():
            new_prefix </span>= f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">{prefix}.{m_name}</span><span style="color: rgba(128, 0, 0, 1)">"</span> <span style="color: rgba(0, 0, 255, 1)">if</span> prefix <span style="color: rgba(0, 0, 255, 1)">else</span><span style="color: rgba(0, 0, 0, 1)"> m_name
            paths.extend(m_obj.get_all_paths(new_prefix))

        </span><span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)"> paths

</span><span style="color: rgba(0, 0, 255, 1)">def</span><span style="color: rgba(0, 0, 0, 1)"> q_weight_loader():
    </span><span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">this is q_weight_loader</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)

</span><span style="color: rgba(0, 0, 255, 1)">def</span><span style="color: rgba(0, 0, 0, 1)"> down_weight_loader():
    </span><span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">this is down_weight_loader</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)

</span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> --- æé æ å½¢ç»æ ---</span>
model = MiniModule(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Qwen3</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
model.layers </span>= MiniModule(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Layers</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
model.layers.attention </span>= MiniModule(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Attention</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
model.layers.attention.q_weight_loader </span>=<span style="color: rgba(0, 0, 0, 1)"> q_weight_loader
model.layers.mlp </span>= MiniModule(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">MLP</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
model.layers.mlp.down_weight_loader </span>=<span style="color: rgba(0, 0, 0, 1)"> down_weight_loader

</span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> --- æå°ææè·¯å¾ ---</span>
<span style="color: rgba(0, 0, 255, 1)">print</span>(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">éåæ¨¡åçææåæ°è·¯å¾ï¼</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
all_paths </span>=<span style="color: rgba(0, 0, 0, 1)"> model.get_all_paths()
</span><span style="color: rgba(0, 0, 255, 1)">for</span> path <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> all_paths:
    </span><span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">è·¯å¾: {path}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)

</span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> --- æ¨¡æ nano-vllm çè®¿é®é»è¾ ---</span>
<span style="color: rgba(0, 0, 255, 1)">def</span><span style="color: rgba(0, 0, 0, 1)"> mock_get_parameter(root, path):
    parts </span>= path.split(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">.</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
    curr </span>=<span style="color: rgba(0, 0, 0, 1)"> root
    </span><span style="color: rgba(0, 0, 255, 1)">for</span> part <span style="color: rgba(0, 0, 255, 1)">in</span> parts[:-1<span style="color: rgba(0, 0, 0, 1)">]:
        curr </span>=<span style="color: rgba(0, 0, 0, 1)"> curr._modules[part]
    </span><span style="color: rgba(0, 0, 255, 1)">return</span> curr._parameters[parts[-1<span style="color: rgba(0, 0, 0, 1)">]]

target </span>= <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">layers.attention.q_weight_loader</span><span style="color: rgba(128, 0, 0, 1)">"</span>
<span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">\næ¨¡ææ¥æ¾è·¯å¾ '{target}':</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
loader </span>=<span style="color: rgba(0, 0, 0, 1)"> mock_get_parameter(model, target)
loader()</span></pre>
</div>
<p><span data-offset-key="a947g-0-0">è¾åºç»æï¼</span></p>
</div>
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="9169c-0-0">
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 0, 1)">éåæ¨¡åçææåæ°è·¯å¾ï¼
è·¯å¾: layers.attention.q_weight_loader
è·¯å¾: layers.mlp.down_weight_loader

æ¨¡ææ¥æ¾è·¯å¾ </span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">layers.attention.q_weight_loader</span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(0, 0, 0, 1)">:
this is q_weight_loader</span></pre>
</div>
<h2><span data-offset-key="1c5sg-0-0">9.2. å¤ GPU ä¹é´çè®¡ç®åå</span></h2>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="2akov-0-0">
<h3 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="2akov-0-0"><span data-offset-key="2akov-0-0">9.2.1. åè½ç»è</span></h3>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="e8sf9-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="e8sf9-0-0"><span data-offset-key="e8sf9-0-0">nano-vllm åªèèåæºåçå¤ GPU ååï¼ååè¿ç¨å¦ä¸ï¼</span></div>
</div>
<div class="Image-captionContainer" data-size="normal">
<div>
<div class="Image-resizerContainer css-ym3v7r" data-size="normal">
<div class="css-79elbk">
<div>
<div class="ImageDelete-Container css-xi606m">
<div class="ImageDelete-Wrapper css-1gomreu" style="text-align: center"><img src="https://pic1.zhimg.com/80/v2-7f054d91f4badab37cab087059b847da_1440w.png?source=ccfced1a" width="500" height="351" class="Image FocusPlugin--unfocused Image--isBlock css-1phd9a0" loading="lazy" data-size="normal" data-rawwidth="888" data-rawheight="624" data-watermark="original" data-original-src="https://picx.zhimg.com/v2-7f054d91f4badab37cab087059b847da.jpg?source=ccfced1a" data-watermark-src="https://pic1.zhimg.com/v2-2ef0dde703c5cd92d206eb126dd9addc_1440w.jpg?source=ccfced1a"></div>
</div>
</div>
</div>
</div>
</div>
<div style="text-align: center">å¾ 5</div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="8ko79-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="8ko79-0-0"><span data-offset-key="8ko79-0-0">ï¼1ï¼è¿ç¨éç¦»ä¸ç¬ç«å è½½ï¼ éç¨å¤è¿ç¨æ¨¡å¼ï¼ä¸ä¸ª GPU å¯¹åºä¸ä¸ªç¬ç«è¿ç¨ãåè¿ç¨å¹¶åè¯»åæéæä»¶ï¼å¹¶æ ¹æ®èªå·±ç tp_rank æç§é¢è®¾çååç­ç¥ï¼å¦ ColumnParallel çè¡ååæ RowParallel çåååï¼ï¼å°å±äºèªå·±çé£é¨åæ°æ®ä» safetensors å è½½å°æ¾å­ä¸­ã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="30dnu-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="30dnu-0-0"><span data-offset-key="30dnu-0-0">ï¼2ï¼æ§å¶é¢ååï¼Control Planeï¼ï¼ Rank 0 è´è´£å¨å±è°åº¦ï¼éè¿å±äº«åå­å°æ¨çè¯·æ±ï¼TokensãSampling Params ç­ï¼åæ­¥ç»å¶ä» Rankã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="e56gm-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="e56gm-0-0"><span data-offset-key="e56gm-0-0">ï¼3ï¼æ°æ®é¢éä¿¡ï¼Data Planeï¼ï¼ å¨ç©éµè®¡ç®çå³é®èç¹ï¼å©ç¨éä¿¡åè¯­ï¼å¦ all-reduce å¤çååæ±åãall-gather å¤çåºåæ¼æ¥ï¼å®æå¼ éå¹¶è¡çç»ææ±æ»ï¼ä½¿åå¸å¨ä¸åæ¾å¡ä¸çè®¡ç®ç»æå¨æ°å­¦ä¸ç­ä»·äºåå¡è®¡ç®ã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="1a163-0-0">
<h3 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="1a163-0-0"><span data-offset-key="1a163-0-0">9.2.2. ç¤ºä¾ä»£ç </span></h3>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="4et0l-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="4et0l-0-0"><span data-offset-key="4et0l-0-0">ä¸é¢åä¸ä¸ªç®åçæ°æ®éä¿¡ä¾å­ï¼</span></div>
</div>
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="bue3l-0-0">
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 0, 1)">import torch
import torch.distributed as dist
import torch.multiprocessing as mp
import </span><span style="color: rgba(0, 0, 255, 1)">time</span><span style="color: rgba(0, 0, 0, 1)">

def setup(rank, world_size):
    dist.init_process_group(
        </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">nccl</span><span style="color: rgba(128, 0, 0, 1)">"</span>, <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">tcp://127.0.0.1:2333</span><span style="color: rgba(128, 0, 0, 1)">"</span>, world_size=world_size, rank=<span style="color: rgba(0, 0, 0, 1)">rank
    )
    torch.cuda.set_device(rank)

def cleanup():
    dist.destroy_process_group()

def test_all_reduce(rank, world_size):
    </span><span style="color: rgba(128, 0, 0, 1)">"""
</span>    All-<span style="color: rgba(0, 0, 0, 1)">Reduce å­å½æ°ï¼å°ææ GPU çæ°æ®è¿è¡å½çº¦æä½ï¼æ±åï¼ï¼ç»æåæ­¥å°ææ GPU

    ä½¿ç¨åºæ¯ï¼
    </span>-<span style="color: rgba(0, 0, 0, 1)"> RowParallelLinear çè¾åºèå
    </span>-<span style="color: rgba(0, 0, 0, 1)"> éè¦ææ GPU é½å¾å°ç¸åçèåç»æ
    </span><span style="color: rgba(128, 0, 0, 1)">"""
</span>    print(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">[Rank {rank}] ===== All-Reduce ç¤ºä¾ =====</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)

    </span><span style="color: rgba(0, 0, 255, 1)">if</span> rank == <span style="color: rgba(128, 0, 128, 1)">0</span><span style="color: rgba(0, 0, 0, 1)">:
        data </span>= torch.tensor([<span style="color: rgba(128, 0, 128, 1)">1.0</span>, <span style="color: rgba(128, 0, 128, 1)">2.0</span>], device=f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">cuda:{rank}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
    </span><span style="color: rgba(0, 0, 255, 1)">else</span><span style="color: rgba(0, 0, 0, 1)">:
        data </span>= torch.tensor([<span style="color: rgba(128, 0, 128, 1)">3.0</span>, <span style="color: rgba(128, 0, 128, 1)">4.0</span>], device=f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">cuda:{rank}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)

    print(f</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">[Rank {rank}] All-Reduce before: {data}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
    dist.all_reduce(data, op</span>=<span style="color: rgba(0, 0, 0, 1)">dist.ReduceOp.SUM)
    print(f</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">[Rank {rank}] All-Reduce after:  {data}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)

def test_all_gather(rank, world_size):
    </span><span style="color: rgba(128, 0, 0, 1)">"""
</span>    All-<span style="color: rgba(0, 0, 0, 1)">Gather å­å½æ°ï¼æ¶éææ GPU çæ°æ®å°æ¯ä¸ª GPU ä¸

    ä½¿ç¨åºæ¯ï¼
    </span>-<span style="color: rgba(0, 0, 0, 1)"> VocabParallelEmbedding çè¾åºæ¶é
    </span>-<span style="color: rgba(0, 0, 0, 1)"> ParallelLMHead ç logits æ¶é
    </span>-<span style="color: rgba(0, 0, 0, 1)"> éè¦æ¯ä¸ª GPU é½è·å¾ææ GPU çå®æ´æ°æ®
    </span><span style="color: rgba(128, 0, 0, 1)">"""
</span>    print(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">[Rank {rank}] ===== All-Gather ç¤ºä¾ =====</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)

    # Rank </span><span style="color: rgba(128, 0, 128, 1)">0</span> äº§ç [<span style="color: rgba(128, 0, 128, 1)">10</span>, <span style="color: rgba(128, 0, 128, 1)">20</span>], Rank <span style="color: rgba(128, 0, 128, 1)">1</span> äº§ç [<span style="color: rgba(128, 0, 128, 1)">30</span>, <span style="color: rgba(128, 0, 128, 1)">40</span><span style="color: rgba(0, 0, 0, 1)">]
    local_data </span>=<span style="color: rgba(0, 0, 0, 1)"> torch.tensor(
        [</span><span style="color: rgba(128, 0, 128, 1)">10.0</span> + rank * <span style="color: rgba(128, 0, 128, 1)">20</span>, <span style="color: rgba(128, 0, 128, 1)">20.0</span> + rank * <span style="color: rgba(128, 0, 128, 1)">20</span>], device=f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">cuda:{rank}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">
    )
    print(f</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">[Rank {rank}] All-Gather local data: {local_data}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)

    gathered_list </span>= [torch.zeros_like(local_data) <span style="color: rgba(0, 0, 255, 1)">for</span> _ <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> range(world_size)]
    dist.all_gather(gathered_list, local_data)

    print(f</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">[Rank {rank}] All-Gather result: {gathered_list}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)

    gathered_tensor </span>= torch.<span style="color: rgba(0, 0, 255, 1)">cat</span>(gathered_list, dim=<span style="color: rgba(128, 0, 128, 1)">0</span><span style="color: rgba(0, 0, 0, 1)">)
    print(f</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">[Rank {rank}] All-Gather concatenated: {gathered_tensor}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)

def tp_demo(rank, world_size):
    setup(rank, world_size)

    test_all_reduce(rank, world_size)
    </span><span style="color: rgba(0, 0, 255, 1)">time</span>.<span style="color: rgba(0, 0, 255, 1)">sleep</span>(<span style="color: rgba(128, 0, 128, 1)">5</span><span style="color: rgba(0, 0, 0, 1)">)
    test_all_gather(rank, world_size)

    cleanup()

def run_demo():
    world_size </span>= <span style="color: rgba(128, 0, 128, 1)">2</span><span style="color: rgba(0, 0, 0, 1)">
    mp.spawn(tp_demo, args</span>=(world_size,), nprocs=world_size, <span style="color: rgba(0, 0, 255, 1)">join</span>=<span style="color: rgba(0, 0, 0, 1)">True)

</span><span style="color: rgba(0, 0, 255, 1)">if</span> __name__ == <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">__main__</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">:
    </span><span style="color: rgba(0, 0, 255, 1)">if</span> torch.cuda.device_count() &gt;= <span style="color: rgba(128, 0, 128, 1)">2</span><span style="color: rgba(0, 0, 0, 1)">:
        run_demo()
    </span><span style="color: rgba(0, 0, 255, 1)">else</span><span style="color: rgba(0, 0, 0, 1)">:
        print(f</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">éè¦è³å° 2 å¼  GPU æ¥è¿è¡æ­¤ TP ç¤ºä¾</span><span style="color: rgba(128, 0, 0, 1)">"</span>)</pre>
</div>
<h1><span data-offset-key="6gvaf-0-0">10. å¶ä»</span></h1>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="mg9h-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="mg9h-0-0"><span data-offset-key="mg9h-0-0">æ¬æåºäº nano-vllm é¡¹ç®ï¼èç¦è®²è§£å¤§æ¨¡åæ¨çå éé¢åä¸­æåºç¡çè¥å¹²æ ¸å¿ææ¯ç¹ãéè¦è¯´æçæ¯ï¼å¤§æ¨¡åæ¨çå éçææ¯ä½ç³»ååä¸°å¯ï¼æ¬é¡¹ç®å¹¶æªè¦çå¨é¨åå®¹ï¼ä¾å¦ï¼è®¡ç®éä¿¡éå ï¼Overlapï¼ãå¤ token é¢æµï¼MTPï¼MultiâToken Predictionï¼ãå¤æµãå¤è¿ç¨æå¡ï¼MPSï¼Multi-Process Serviceï¼ãæ°æ®å¹¶è¡ï¼DPï¼ãæµæ°´çº¿å¹¶è¡ï¼PPï¼ãä¸ä¸æå¹¶è¡ï¼CPï¼ãä¸å®¶å¹¶è¡ï¼EPï¼ä»¥å PD åç¦»ç­è¿é¶ææ¯æ¹åï¼å¯ä½ä¸ºåç»­æ·±å¥å­¦ä¹ çæå±åå®¹ã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="dq4gr-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="dq4gr-0-0"><span data-offset-key="dq4gr-0-0">&nbsp;</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="9n200-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="9n200-0-0"><span data-offset-key="9n200-0-0">æ³¨1ï¼å¨æ¬æçæ»ç»è¿ç¨ä¸­ï¼é¤äºæ¥çæºä»£ç ï¼ä¹åå© deepwiki ä»¥åå¶ä» AI å·¥å·è¾å©ã&nbsp;<br><br></span></div>
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="9n200-0-0"><span data-offset-key="9n200-0-0">æ¬æ:&nbsp;<a href="https://www.cnblogs.com/cswuyg/p/19471225" target="_blank">https://www.cnblogs.com/cswuyg/p/19471225</a></span></div>
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="9n200-0-0"><span data-offset-key="9n200-0-0">ç¥ä¹:&nbsp;<a href="https://zhuanlan.zhihu.com/p/1989806890381746916" target="_blank" rel="noopener nofollow">https://zhuanlan.zhihu.com/p/1989806890381746916</a></span></div>
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="9n200-0-0"><span data-offset-key="9n200-0-0">å¬ä¼å·:&nbsp;<a href="https://mp.weixin.qq.com/s/6mAZ49iP1SCKt5ZdWf6ErQ" target="_blank" rel="noopener nofollow">https://mp.weixin.qq.com/s/6mAZ49iP1SCKt5ZdWf6ErQ</a></span></div>



</div>
</div>
<div class="clear"></div>

	<div class="postDesc">posted on 
<span id="post-date" data-last-update-days="0.07847222222222222" data-date-updated="2026-01-12 14:31">2026-01-12 12:38</span>&nbsp;
<a href="https://www.cnblogs.com/cswuyg">-é¶å-</a>&nbsp;
éè¯»(<span id="post_view_count">181</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19471225);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19471225', targetLink: 'https://www.cnblogs.com/cswuyg/p/19471225', title: 'åºäº nano-vLLM å­¦ä¹ å¤§æ¨¡åæ¨çå³é®åè½' })">ä¸¾æ¥</a>
</div>
 ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ ãå¤§æ°æ® & AIãFlink Agents æºç è§£è¯» --- (6) ---  ActionTask ]]></title>
    <link>https://www.cnblogs.com/rossiXYZ/p/19468837</link>
    <guid>6b3ade2c8e7157873fb73c4482a6e06a</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/rossiXYZ/p/19468837" title="åå¸äº 2026-01-12 20:53">
    <span role="heading" aria-level="2">ãå¤§æ°æ® &amp; AIãFlink Agents æºç è§£è¯» --- (6) ---  ActionTask</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h1 id="å¤§æ°æ®--aiflink-agents-æºç è§£è¯»-----6------actiontask">ãå¤§æ°æ® &amp; AIãFlink Agents æºç è§£è¯» --- (6) ---  ActionTask</h1>
<p></p><div class="toc"><div class="toc-container-header">ç®å½</div><ul><li><a href="#å¤§æ°æ®--aiflink-agents-æºç è§£è¯»-----6------actiontask" rel="noopener nofollow">ãå¤§æ°æ® &amp; AIãFlink Agents æºç è§£è¯» --- (6) ---  ActionTask</a><ul><li><a href="#0x00-æ¦è¦" rel="noopener nofollow">0x00 æ¦è¦</a></li><li><a href="#0x01-åºç¡ç¥è¯" rel="noopener nofollow">0x01 åºç¡ç¥è¯</a><ul><li><a href="#11-ç¸å³ç»ä»¶" rel="noopener nofollow">1.1 ç¸å³ç»ä»¶</a></li><li><a href="#12-actiontask" rel="noopener nofollow">1.2 ActionTask</a></li><li><a href="#13-pythonactiontask" rel="noopener nofollow">1.3 PythonActionTask</a><ul><li><a href="#131-å®ä¹" rel="noopener nofollow">1.3.1 å®ä¹</a></li><li><a href="#132-pythonactiontask-ä¸-function-çå³ç³»" rel="noopener nofollow">1.3.2 PythonActionTask ä¸ Function çå³ç³»</a></li><li><a href="#133-ä¸å¶ä»ç»ä»¶çå³ç³»" rel="noopener nofollow">1.3.3 ä¸å¶ä»ç»ä»¶çå³ç³»</a></li><li><a href="#134-è°ç¨æµç¨" rel="noopener nofollow">1.3.4 è°ç¨æµç¨</a></li></ul></li><li><a href="#14-pythongeneratoractiontask" rel="noopener nofollow">1.4 PythonGeneratorActionTask</a></li><li><a href="#15-javaactiontask" rel="noopener nofollow">1.5 JavaActionTask</a></li><li><a href="#16-actiontaskresult-ç»æ" rel="noopener nofollow">1.6 ActionTaskResult ç»æ</a></li></ul></li><li><a href="#0x02-actiontask-ååæºå¶" rel="noopener nofollow">0x02 ActionTask ååæºå¶</a><ul><li><a href="#21-ååæ¹å¼" rel="noopener nofollow">2.1 ååæ¹å¼</a></li><li><a href="#22-å®ç°ç»è" rel="noopener nofollow">2.2 å®ç°ç»è</a></li><li><a href="#23-å³é®ç¹" rel="noopener nofollow">2.3 å³é®ç¹</a></li></ul></li></ul></li></ul></div><p></p>
<h2 id="0x00-æ¦è¦">0x00 æ¦è¦</h2>
<p>ActionTask æ¯ Action æ§è¡çåºæ¬åä½ï¼ä»£è¡¨ä¸ä¸ªå¯æ§è¡çä»»å¡åãä¸ä¸ªå®æ´ç Action å¯è½ä¼è¢«ååæå¤ä¸ª ActionTask æ¥æ§è¡ãActionTask å¨æ´ä½æµç¨çä½ç½®å¦ä¸ï¼</p>
<pre><code class="language-python">Action Code â Agent â AgentPlan â ActionExecutionOperator â ActionTask â Flink Runtime
</code></pre>
<h2 id="0x01-åºç¡ç¥è¯">0x01 åºç¡ç¥è¯</h2>
<p>ActionTask æ¯ Action æ§è¡è¿ç¨ä¸­çä¸ä¸ªçæ®µï¼ç¨äºæ¯æå¤æçæ§è¡é»è¾ï¼å¦å¼æ­¥å¤çï¼ï¼å¯¹åºå³ç³»å¦ä¸ï¼</p>
<ul>
<li>ä¸ä¸ª Action å¯¹åºä¸ä¸ªå½æ°</li>
</ul>
<p>å¨ AgentPlan ä¸­ï¼æ¯ä¸ª Action åå«ä¸ä¸ªæ§è¡å½æ° (exec)ï¼éå¸¸æ¯ PythonFunction æ JavaFunctionï¼ä¾å¦å¨ tool_call_action.py ä¸­ï¼</p>
<pre><code class="language-java">TOOL_CALL_ACTION = Action (
    name="tool_call_action",
    exec=PythonFunction.from_callable (process_tool_request), // ä¸ä¸ªå½æ°
    listen_event_types=[...]
)
</code></pre>
<ul>
<li>ä¸ä¸ª Action å¯è½äº§çå¤ä¸ª ActionTask
<ul>
<li>ActionTask æ¯ Action çæ§è¡æ¶è¡¨ç¤ºï¼å¯ä»¥çä½æ¯ Action ç âæ§è¡çæ®µâ</li>
<li>ä¸ä¸ª Action å¯è½å¨æ§è¡è¿ç¨ä¸­è¢«æåä¸ºå¤ä¸ª ActionTaskï¼ç¹å«æ¯å¨å¤çå¼æ­¥æä½æ¶</li>
</ul>
</li>
</ul>
<h3 id="11-ç¸å³ç»ä»¶">1.1 ç¸å³ç»ä»¶</h3>
<p>ActionTask æ¦å¿µçç¸å³ç»ä»¶å¦ä¸</p>
<table>
<thead>
<tr>
<th>ç»ä»¶</th>
<th>æ ¸å¿åè½</th>
</tr>
</thead>
<tbody>
<tr>
<td>JavaActionTask</td>
<td>æ§è¡ Java å½æ°</td>
</tr>
<tr>
<td>PythonActionTask</td>
<td>æ§è¡ Python å½æ°ï¼æ¯æå¼æ­¥ / çæå¨æ¨¡å¼ï¼æ¡¥æ¥ Java ä¸ Python çæ</td>
</tr>
<tr>
<td>LocalRunnerContext</td>
<td>æ¬å°æ§è¡ä¸ä¸æï¼æ¨¡æ Flink åå¸å¼ç¶æï¼ç®¡çäºä»¶éåãkey éç¦»ç¶æãèµæºè®¿é®</td>
</tr>
<tr>
<td>ActionTaskResult</td>
<td>å¨ä½æ§è¡ç»æè½½ä½ï¼åå«æ¯å¦å®æãè¾åºäºä»¶ãä¸ä¸ä¸ªå¾æ§è¡ä»»å¡ï¼è¥æï¼</td>
</tr>
<tr>
<td>PythonGeneratorActionTask</td>
<td>å¤ç Python çæå¨çå¼æ­¥ä»»å¡ï¼æç»­æ§è¡ç´å°å®æææå¼æ­¥æä½</td>
</tr>
<tr>
<td>Tool ç¸å³æºå¶</td>
<td>æ¯æè£é¥°å¨ï¼@toolï¼ãadd_resource ç­æ¹å¼æ³¨åå·¥å·ï¼éè¿ TOOL_CALL_ACTION è§¦åæ§è¡</td>
</tr>
</tbody>
</table>
<p>å¨ç³»ç»ä¸­çæ¶æå¦ä¸</p>
<p><img alt="flink-6-1" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1850883/202601/1850883-20260111194854672-978012366.png" class="lazyload"></p>
<h3 id="12-actiontask">1.2 ActionTask</h3>
<p>æä»¬æ¥ä¸æ¥çç ActionTask çå·ä½å®ç°ã</p>
<p>ActionTask æ¯åºç±»ã</p>
<pre><code class="language-java">/**
 * This class represents a task related to the execution of an action in {@link
 * ActionExecutionOperator}.
 *
 * &lt;p&gt;An action is split into multiple code blocks, and each code block is represented by an {@code
 * ActionTask}. You can call {@link #invoke()} to execute a code block and obtain invoke result
 * {@link ActionTaskResult}. If the action contains additional code blocks, you can obtain the next
 * {@code ActionTask} via {@link ActionTaskResult#getGeneratedActionTask()} and continue executing
 * it.
 */
public abstract class ActionTask {
    protected final Object key;
    protected final Event event;
    protected final Action action;
    /**
     * Since RunnerContextImpl contains references to the Operator and state, it should not be
     * serialized and included in the state with ActionTask. Instead, we should check if a valid
     * RunnerContext exists before each ActionTask invocation and create a new one if necessary.
     */
    protected transient RunnerContextImpl runnerContext;

    public ActionTask(Object key, Event event, Action action) {
        this.key = key;
        this.event = event;
        this.action = action;
    }

    public RunnerContextImpl getRunnerContext() {
        return runnerContext;
    }

    public void setRunnerContext(RunnerContextImpl runnerContext) {
        this.runnerContext = runnerContext;
    }

    public Object getKey() {
        return key;
    }

    /** Invokes the action task. */
    public abstract ActionTaskResult invoke() throws Exception;

    public class ActionTaskResult {
        private final boolean finished;
        private final List&lt;Event&gt; outputEvents;
        private final Optional&lt;ActionTask&gt; generatedActionTaskOpt;

        public ActionTaskResult(
                boolean finished,
                List&lt;Event&gt; outputEvents,
                @Nullable ActionTask generatedActionTask) {
            this.finished = finished;
            this.outputEvents = outputEvents;
            this.generatedActionTaskOpt = Optional.ofNullable(generatedActionTask);
        }

        public boolean isFinished() {
            return finished;
        }

        public List&lt;Event&gt; getOutputEvents() {
            return outputEvents;
        }

        public Optional&lt;ActionTask&gt; getGeneratedActionTask() {
            return generatedActionTaskOpt;
        }
    }
}
</code></pre>
<h3 id="13-pythonactiontask">1.3 PythonActionTask</h3>
<p>PythonActionTask æ¯ä¸ä¸ªä¸é¨ç¨äºæ§è¡ Python å¨ä½ä»»å¡çç¹æ® ActionTask å®ç°ãå®çä¸»è¦ä½ç¨åæ¬ï¼</p>
<ul>
<li>æ§è¡ Python å½æ°ï¼è°ç¨ Python å½æ°æ¥å¤çäºä»¶</li>
<li>å¤çå¼æ­¥æä½ï¼æ¯æ Python ä¸­çå¼æ­¥æä½ï¼éè¿çæå¨æºå¶å®ç°</li>
<li>æ¡¥æ¥ Java å Pythonï¼ä½ä¸º Java ç«¯å Python ç«¯ä¹é´çæ¡¥æ¢ï¼åè°ä¸¤èé´çäº¤äº</li>
</ul>
<h4 id="131-å®ä¹">1.3.1 å®ä¹</h4>
<p>PythonActionTask å¯¹åºä¸ä¸ª Python å½æ°ï¼æ´åç¡®å°è¯´æ¯ä¸ä¸ª PythonFunction å¯¹è±¡ï¼ï¼è¿ä¸ªå½æ°æ¯å¨åå»º Action æ¶å®ä¹çï¼å­å¨å¨ action.getExec() ä¸­ãä½PythonActionTask ä¸ä»ä»æ¯ç®åçå½æ°å°è£ï¼èæ¯ä½¿å¶è½å¤å¨ Flink Agents æ¡æ¶ä¸­æ­£ç¡®æ§è¡ï¼å¹¶æ¯ææ¡æ¶æéçé«çº§ç¹æ§ãå®æä¾äºä»¥ä¸éå ä»·å¼ï¼</p>
<ul>
<li>å¤æé»è¾ï¼PythonActionTask ä¸ä»ä»æ¯æ§è¡å½æ°ï¼è¿è´è´£å¤çå¤æçäº¤äºé»è¾</li>
<li>æ§è¡ç¯å¢ç®¡çï¼ä¸ºå½æ°æä¾åéçæ§è¡ä¸ä¸æ</li>
<li>å¼æ­¥æ¯æï¼éè¿çæå¨æºå¶æ¯æé¿æ¶é´è¿è¡çæä½</li>
<li>äºä»¶å¤çï¼ç®¡çåä¼ éæ§è¡è¿ç¨ä¸­äº§ççäºä»¶</li>
<li>ç¶æç»´æ¤ï¼å¨æ´ä¸ªæ§è¡è¿ç¨ä¸­ç»´æ¤å¿è¦çç¶æä¿¡æ¯</li>
</ul>
<p>PythonActionTask å¨ç³»ç»æ¶æä¸­çä½ç½®åäº¤äºå³ç³»å¦ä¸ï¼</p>
<p><img alt="Flink-6-2" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1850883/202601/1850883-20260111194915706-1143482556.png" class="lazyload"></p>
<p>ä»£ç å¦ä¸ï¼</p>
<pre><code class="language-java">public class PythonActionTask extends ActionTask {
    public ActionTaskResult invoke() throws Exception {
        PythonActionExecutor pythonActionExecutor = getPythonActionExecutor();

        // è¿éæ§è¡å®éç Python å½æ°
        String pythonGeneratorRef =
            pythonActionExecutor.executePythonFunction(
                (PythonFunction) action.getExec(), // &lt;-- è¿å°±æ¯å¯¹åºçå½æ°
                (PythonEvent) event,
                runnerContext);

        // å¤çå¼æ­¥æåµ
        if (pythonGeneratorRef != null) {
            // å¦æå½æ°è¿åäºçæå¨ï¼ååå»ºæ°çä»»å¡ç»§ç»­æ§è¡
            ActionTask tempGeneratedActionTask =
                new PythonGeneratorActionTask(key, event, action, pythonGeneratorRef);
            tempGeneratedActionTask.setRunnerContext(runnerContext);
        if (pythonGeneratorRef != null) {
            // å¦æå½æ°è¿åäºçæå¨ï¼ååå»ºæ°çä»»å¡ç»§ç»­æ§è¡
            ActionTask tempGeneratedActionTask = 
                new PythonGeneratorActionTask(key, event, action, pythonGeneratorRef);
            tempGeneratedActionTask.setRunnerContext(runnerContext);
            return tempGeneratedActionTask.invoke();
        }
        // å¦åè¡¨ç¤ºå½æ°å·²æ§è¡å®æ¯
        return new ActionTaskResult(
            true, 
            runnerContext.drainEvents(event.getSourceTimestamp()), 
            null);            
</code></pre>
<h4 id="132-pythonactiontask-ä¸-function-çå³ç³»">1.3.2 PythonActionTask ä¸ Function çå³ç³»</h4>
<p>PythonActionTask ä¸ Function çå³ç³»çå¦ä¸</p>
<p><img alt="Flink-6-3" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1850883/202601/1850883-20260111194926624-755868059.png" class="lazyload"></p>
<h4 id="133-ä¸å¶ä»ç»ä»¶çå³ç³»">1.3.3 ä¸å¶ä»ç»ä»¶çå³ç³»</h4>
<p>PythonActionTask ä¸å¶ä»ç»ä»¶çå³ç³»å¦ä¸å¾æç¤ºã</p>
<p><img alt="Flink-6-4" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1850883/202601/1850883-20260111194935116-1482160613.png" class="lazyload"></p>
<h4 id="134-è°ç¨æµç¨">1.3.4 è°ç¨æµç¨</h4>
<p>PythonActionTask.invoke() æµç¨å¦ä¸å¾æç¤ºï¼å¶å³é®ç¹ç¹ä¸ºï¼</p>
<ul>
<li>å¼æ­¥æ¯æï¼éè¿ Python çæå¨æºå¶æ¯æé¿æ¶é´è¿è¡çæä½</li>
<li>ç¶æç®¡çï¼ä¸ ActionExecutionOperator åä½ç®¡çæ§è¡ç¶æ</li>
<li>éè¯¯å¤çï¼éå½å°å¤ç Python æ§è¡è¿ç¨ä¸­å¯è½åºç°çå¼å¸¸</li>
<li>åå­ç®¡çï¼ä¸ RunnerContext éæï¼ç®¡çç­æè®°å¿åå¶ä»ç¶æ</li>
</ul>
<p><img alt="Flink-6-5" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1850883/202601/1850883-20260111194943648-52891277.png" class="lazyload"></p>
<p>PythonActionTask å¨æ´ä¸ªç³»ç»ä¸­èµ·å°äºè³å³éè¦çä½ç¨ï¼å®ä½¿å¾ Flink Agents è½å¤æ ç¼éæ Python çæç³»ç»ä¸­çåç§ AI å·¥å·ååºï¼åæ¶ä¿æä¸ Flink æµå¤çå¼æçè¯å¥½éæã</p>
<h3 id="14-pythongeneratoractiontask">1.4 PythonGeneratorActionTask</h3>
<p>PythonGeneratorActionTask æ¯ PythonActionTask çæ´¾çç±»ã</p>
<ul>
<li>å½ Python å½æ°ä¸­ä½¿ç¨äº yield æå¼æ­¥æä½æ¶ï¼Python æ§è¡å¨ä¼æ£æµå°è¿ç§æåµå¹¶è¿åä¸ä¸ª Generator å¼ç¨</li>
<li>ç³»ç»ä¼åå»º PythonGeneratorActionTask æ¥ç»§ç»­æ§è¡</li>
</ul>
<pre><code class="language-java">/** An {@link ActionTask} wrapper a Python Generator to represent a code block in Python action. */
public class PythonGeneratorActionTask extends PythonActionTask {
    private final String pythonGeneratorRef;

    public PythonGeneratorActionTask(
            Object key, Event event, Action action, String pythonGeneratorRef) {
        super(key, event, action);
        this.pythonGeneratorRef = pythonGeneratorRef;
    }

    @Override
    public ActionTaskResult invoke() {
        boolean finished = getPythonActionExecutor().callPythonGenerator(pythonGeneratorRef);
        ActionTask generatedActionTask = finished ? null : this;
        return new ActionTaskResult(
                finished,
                runnerContext.drainEvents(event.getSourceTimestamp()),
                generatedActionTask);
    }
}
</code></pre>
<h3 id="15-javaactiontask">1.5 JavaActionTask</h3>
<p>JavaActionTask æ§è¡ Java ActionTaskã</p>
<pre><code class="language-java">/**
 * A special {@link ActionTask} designed to execute a Java action task.
 *
 * &lt;p&gt;Note that Java action currently do not support asynchronous execution. As a result, a Java
 * action task will be invoked only once.
 */
public class JavaActionTask extends ActionTask {

    private final ClassLoader userCodeClassLoader;

    public JavaActionTask(Object key, Event event, Action action, ClassLoader userCodeClassLoader) {
        super(key, event, action);
        checkState(action.getExec() instanceof JavaFunction);
        this.userCodeClassLoader = userCodeClassLoader;
    }

    @Override
    public ActionTaskResult invoke() throws Exception {
        runnerContext.checkNoPendingEvents();
        ClassLoader cl = Thread.currentThread().getContextClassLoader();
        try {
            Thread.currentThread().setContextClassLoader(userCodeClassLoader);
            action.getExec().call(event, runnerContext);
        } finally {
            Thread.currentThread().setContextClassLoader(cl);
        }
        return new ActionTaskResult(
                true, runnerContext.drainEvents(event.getSourceTimestamp()), null);
    }
}
</code></pre>
<h3 id="16-actiontaskresult-ç»æ">1.6 ActionTaskResult ç»æ</h3>
<p>æ¯æ¬¡æ§è¡ ActionTask åä¼è¿åä¸ä¸ª ActionTaskResult å¯¹è±¡ï¼</p>
<pre><code class="language-java">public class ActionTaskResult {
    private final boolean finished;                 // æ¯å¦å·²å®æ
    private final List&lt;Event&gt; outputEvents;         // è¾åºäºä»¶
    private final Optional&lt;ActionTask&gt; generatedActionTaskOpt; // ä¸ä¸ä¸ª ActionTaskï¼å¦ææï¼
// ...
}
</code></pre>
<h2 id="0x02-actiontask-ååæºå¶">0x02 ActionTask ååæºå¶</h2>
<p>å¨ Flink Agents æ¡æ¶ä¸­ï¼ActionTask çååæ¯ä¸ºäºæ¯æé¿æ¶é´è¿è¡çæä½åå¼æ­¥æ§è¡ãååçå¥½å¤å¦ä¸ï¼</p>
<ul>
<li>é¿åé»å¡ï¼é¿æ¶é´è¿è¡çæä½ä¸ä¼é»å¡æ´ä¸ªæä½ç¬¦</li>
<li>æé«å¹¶åæ§ï¼åè®¸å¶ä» key çä»»å¡åæ¶æ§è¡</li>
<li>å®¹éè½åï¼æ¯ä¸ª ActionTask å¯ä»¥åç¬å¤±è´¥åæ¢å¤</li>
<li>èµæºç®¡çï¼æ´å¥½å°ç®¡çåå­åå¶ä»èµæº</li>
</ul>
<p>è¿ç§ååæºå¶ä½¿å¾ Flink Agents è½å¤é«æå°å¤çå¤æçï¼é¿æ¶é´è¿è¡ç AI Agent ä»»å¡ï¼åæ¶ä¿æç³»ç»çååºçç¨³å®æ§ã</p>
<h3 id="21-ååæ¹å¼">2.1 ååæ¹å¼</h3>
<p>ä¸»è¦ååæ¹å¼å¦ä¸ï¼</p>
<p>æ¦å¿µä¸çæå</p>
<ul>
<li>ä¸ä¸ª Action å¨æ¦å¿µä¸å¯è¢«ææå¤ä¸ªé¡ºåºæ§è¡çä»£ç åï¼æ¯ä¸ªä»£ç åæä¸ºä¸ä¸ª ActionTask å®ä¾ã</li>
<li>è®¾è®¡ç®çå¨äºç»ç²åº¦æ§å¶ï¼å°¤å¶éç¨äºå¼æ­¥æä½ã</li>
</ul>
<p>åå»ºä¸æµç¨</p>
<ul>
<li>åå§è§¦åï¼ActionExecutionOperator éè¿ createActionTask() ä¸ºæ¯ä¸ªå¨ä½çæé¦ä¸ª ActionTaskã</li>
<li>æ§è¡è¿ç¨ï¼è¥å¨ä½äº§ççæå¨ï¼å¼æ­¥ï¼ï¼å¯åå®ä¾åæ°ç ActionTask ç»§ç»­åç»­ä»£ç åã</li>
</ul>
<pre><code class="language-java">    /**
     * Processes an incoming event for the given key and may submit a new mail
     * `tryProcessActionTaskForKey` to continue processing.
     */
    private void processEvent(Object key, Event event) throws Exception {
        notifyEventProcessed(event);

        boolean isInputEvent = EventUtil.isInputEvent(event);
        if (EventUtil.isOutputEvent(event)) {
        } else {
            // We then obtain the triggered action and add ActionTasks to the waiting processing
            // queue.
            List&lt;Action&gt; triggerActions = getActionsTriggeredBy(event);
            if (triggerActions != null &amp;&amp; !triggerActions.isEmpty()) {
                for (Action triggerAction : triggerActions) {
                    actionTasksKState.add(createActionTask(key, triggerAction, event));
                }
            }
        }
    }
</code></pre>
<p>createActionTask ä»£ç å¦ä¸ã</p>
<pre><code class="language-java">    private ActionTask createActionTask(Object key, Action action, Event event) {
        if (action.getExec() instanceof JavaFunction) {
            return new JavaActionTask(
                    key, event, action, getRuntimeContext().getUserCodeClassLoader());
        } else if (action.getExec() instanceof PythonFunction) {
            return new PythonActionTask(key, event, action);
        } else {
            throw new IllegalStateException(
                    "Unsupported action type: " + action.getExec().getClass());
        }
    }

</code></pre>
<h3 id="22-å®ç°ç»è">2.2 å®ç°ç»è</h3>
<p>ActionTask.java ä¸­æå¦ä¸ï¼è¿æå³ç:</p>
<ul>
<li>ä¸ä¸ª Action å¯è½è¢«æåæå¤ä¸ªä»£ç å</li>
<li>æ¯ä¸ªä»£ç åç±ä¸ä¸ª ActionTask è¡¨ç¤º</li>
<li>éè¿è°ç¨ invoke () æ§è¡ä»£ç åå¹¶è·å¾ç»æ</li>
<li>å¦æ Action åå«æ´å¤ä»£ç åï¼å¯ä»¥ä» ActionTaskResult ä¸­è·åä¸ä¸ä¸ª ActionTask</li>
</ul>
<pre><code class="language-java">/**
 * æ­¤ç±»è¡¨ç¤ºå¨ ActionExecutionOperator ä¸­æ§è¡çå¨ä½ä»»å¡ã
 *
 * &lt;p&gt;ä¸ä¸ªå¨ä½ä¼è¢«æåä¸ºå¤ä¸ªä»£ç åï¼æ¯ä¸ªä»£ç åé½ç±ä¸ä¸ª ActionTask è¡¨ç¤ºã
 * å¯ä»¥è°ç¨ #invoke() æ¥æ§è¡ä¸ä¸ªä»£ç åå¹¶è·å¾æ§è¡ç»æï¼ActionTaskResultï¼ã
 * å¦æå¨ä½åå«é¢å¤çä»£ç åï¼å¯éè¿ ActionTaskResult#getGeneratedActionTask()
 * è·åä¸ä¸ä¸ª ActionTask å¹¶ç»§ç»­æ§è¡å®ã
 */

</code></pre>
<p>Python éæï¼PythonActionTask.javaï¼</p>
<ul>
<li>å½ Python å½æ°ä¸­ä½¿ç¨äº yield æå¼æ­¥æä½æ¶ï¼Python æ§è¡å¨ä¼æ£æµå°è¿ç§æåµå¹¶è¿åä¸ä¸ª Generator å¼ç¨</li>
<li>ç³»ç»ä¼åå»º PythonGeneratorActionTask æ¥ç»§ç»­æ§è¡</li>
</ul>
<p>è¿è¯´æå¨å¤çå¼æ­¥ Python å½æ°æ¶ï¼ä¸ä¸ª Action å¯è½ä¼äº§çå¤ä¸ª ActionTaskï¼</p>
<ul>
<li>åå§ç PythonActionTask</li>
<li>åç»­ç PythonGeneratorActionTaskï¼å¦æéè¦ï¼</li>
</ul>
<pre><code class="language-java">/**
 * ä¸é¨ç¨äºæ§è¡ Python å¨ä½ä»»å¡çç¹æ® ActionTaskã
 *
 * &lt;p&gt;å¨ Python ä¸­è¿è¡å¼æ­¥æ§è¡æé´ï¼PythonActionTask å¯ä»¥çæä¸ä¸ª
 * PythonGeneratorActionTask æ¥ä»£è¡¨åç»­éè¦çä»£ç åã
 */
public class PythonActionTask extends ActionTask {
    public ActionTaskResult invoke() throws Exception {
        ...
        String pythonGeneratorRef = 
            pythonActionExecutor.executePythonFunction(
                (PythonFunction)action.getExec(),
                (PythonEvent)event,
                runnerContext);

        // å¦æç¨æ·å®ä¹çå¨ä½ä½¿ç¨æ¥å£æäº¤äºå¼æ­¥ä»»å¡ï¼
        // å®å°å¨ç¬¬ä¸æ¬¡æ§è¡åè¿åä¸ä¸ª Python çæå¨å¯¹è±¡å®ä¾ã
        // å¦åæå³çæ²¡ææäº¤å¼æ­¥ä»»å¡ä¸å¨ä½å·²ç»å®æã
        if (pythonGeneratorRef != null) {
            // Python å¨ä½çæäºä¸ä¸ªçæå¨ãæä»¬éè¦æ§è¡ä¸æ¬¡å®ï¼
            // è¿å°æäº¤ä¸ä¸ªå¼æ­¥ä»»å¡å¹¶è¿åå¨ä½æ¯å¦å·²å®æã
            ActionTask tempGeneratedActionTask = 
                new PythonGeneratorActionTask(key, event, action, pythonGeneratorRef);
            tempGeneratedActionTask.setRunnerContext(runnerContext);
            return tempGeneratedActionTask.invoke();
        }
        return new ActionTaskResult(
            true, runnerContext.drainEvents(event.getSourceTimestamp()), null);
    }
}

</code></pre>
<h3 id="23-å³é®ç¹">2.3 å³é®ç¹</h3>
<p>ActionTask æåçå³é®ç¹å¦ä¸ï¼</p>
<ul>
<li>é¡ºåºæ§è¡ï¼å¯¹äºç»å®çé®ï¼ä»»å¡æé¡ºåºæ§è¡ï¼ä»¥ä¿æé¡ºåºæ§åä¸è´æ§</li>
<li>å¼æ­¥å¤çï¼å½å¨ä½æ¶åå¼æ­¥æä½æ¶ï¼
<ul>
<li>åå§ä»»å¡æ§è¡å°å¼æ­¥æä½ä¸ºæ­¢ï¼</li>
<li>è¿åä¸ä¸ªæ°ç ActionTask æ¥è¡¨ç¤ºåç»­çæä½ï¼</li>
<li>åç»­ä»»å¡å¤çå¼æ­¥ç»æå¹¶ç»§ç»­æ§è¡</li>
</ul>
</li>
<li>ç¶æç®¡çï¼æ¯ä¸ª ActionTask éè¿ RunnerContext ç»´æ¤å¶ç¶æï¼ç¡®ä¿æåä¹é´çè¿ç»­æ§</li>
</ul>
<ul>
<li>åºäºé®ç®±çå¤çï¼ä½¿ç¨ Flink çé®ç®±æ§è¡å¨æ¥è°åº¦åç»­ä»»å¡çå¤çï¼</li>
</ul>
<pre><code class="language-java">// æäº¤æ°é®ä»¶ä»¥ç»§ç»­å¤ç
mailboxExecutor.submit(() -&gt; tryProcessActionTaskForKey(key), "process action task");

</code></pre>
<p>è¿ç§è®¾è®¡åè®¸å°å¸¦æå¼æ­¥æä½çå¤æå¨ä½åè§£ä¸ºå¯ç®¡ççååï¼åæ¶ä¿ææ§è¡è¯­ä¹åç¶æä¸è´æ§ã</p>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-01-12 20:54">2026-01-12 20:53</span>&nbsp;
<a href="https://www.cnblogs.com/rossiXYZ">ç½è¥¿çæè</a>&nbsp;
éè¯»(<span id="post_view_count">9</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19468837);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19468837', targetLink: 'https://www.cnblogs.com/rossiXYZ/p/19468837', title: 'ãå¤§æ°æ® &amp;amp; AIãFlink Agents æºç è§£è¯» --- (6) ---  ActionTask' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ Flinkæºç éè¯»ï¼Nettyéä¿¡ ]]></title>
    <link>https://www.cnblogs.com/Jackeyzhe/p/19474170</link>
    <guid>ed557c0617b43ca437e7f48f8dc3f2ef</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/Jackeyzhe/p/19474170" title="åå¸äº 2026-01-12 20:40">
    <span role="heading" aria-level="2">Flinkæºç éè¯»ï¼Nettyéä¿¡</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                    <div id="cnblogs_post_description" style="display: none">
        <img src="https://img2024.cnblogs.com/blog/1828322/202601/1828322-20260112203959144-1309168916.png" alt="Flinkæºç éè¯»ï¼Nettyéä¿¡" class="desc_img">
        åæä¸­æä»¬äºè§£äº Flink çæ°æ®äº¤äºè¿ç¨ï¼ä¸æ¸¸ç Task å°æ°æ®åå¥å° ResultSubpartition ç buffers éåä¸­ãä¸æ¸¸ç Task éè¿ LocalInputChannel å RemoteInputChannel æ¶è´¹ä¸æ¸¸çæ°æ®ã
    </div>
<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<p>åæä¸­æä»¬äºè§£äº Flink çæ°æ®äº¤äºè¿ç¨ï¼ä¸æ¸¸ç Task å°æ°æ®åå¥å° ResultSubpartition ç buffers éåä¸­ãä¸æ¸¸ç Task éè¿ LocalInputChannel å RemoteInputChannel æ¶è´¹ä¸æ¸¸çæ°æ®ã</p>
<p>LocalInputChannel æ¯ä¸ä¸æ¸¸ç Task é¨ç½²å¨åä¸ä¸ª TaskManager æ¶ä½¿ç¨çï¼å¨æ¬å°å³å¯å®ææ°æ®äº¤æ¢ï¼æ éç½ç»éä¿¡ãå½ä¸ä¸æ¸¸ç Task é¨ç½²å¨ä¸åç TaskManager æ¶ï¼å°±éè¦ç¨å° RemoteInputChannelï¼Flink å©ç¨ Netty æ¥è¿è¡æ°æ®äº¤äºãæ¬ææä»¬æ¥ä¸èµ·æ¢³çä¸ä¸ Netty ç¸å³çæºç ã</p>
<h3 id="åå§å">åå§å</h3>
<p>æä»¬åæ¥ç NettyServer å NettyClient çåå§åè¿ç¨ã</p>
<p><img alt="NettyInit" loading="lazy" data-src="https://res.cloudinary.com/dxydgihag/image/upload/v1767601135/Blog/flink/19/NettyInit.png" class="lazyload"></p>
<p>Netty çåå§åé¶æ®µæ¯å¨ TaskManager å¯å¨çè¿ç¨ä¸­æ§è¡çãå¨ <code>TaskManagerServices.fromConfiguration</code> æ¹æ³ä¸­ï¼ä¼åå»ºå¹¶å¯å¨ ShuffleEnvironmentã</p>
<pre><code class="language-java">public static TaskManagerServices fromConfiguration(
        TaskManagerServicesConfiguration taskManagerServicesConfiguration,
        PermanentBlobService permanentBlobService,
        MetricGroup taskManagerMetricGroup,
        ExecutorService ioExecutor,
        ScheduledExecutor scheduledExecutor,
        FatalErrorHandler fatalErrorHandler,
        WorkingDirectory workingDirectory)
        throws Exception {
    ...

    final ShuffleEnvironment&lt;?, ?&gt; shuffleEnvironment =
            createShuffleEnvironment(
                    taskManagerServicesConfiguration,
                    taskEventDispatcher,
                    taskManagerMetricGroup,
                    ioExecutor,
                    scheduledExecutor);
    final int listeningDataPort = shuffleEnvironment.start();
    ...
}
</code></pre>
<p>æä»¬é¡ºçè°ç¨é¾è·¯å¯ä»¥ä¸ç´æ¾å° <code>NettyShuffleServiceFactory.createNettyShuffleEnvironment</code> æ¹æ³ï¼è¿ä¸ªæ¹æ³ä¸­åå»ºäº NettyConnectionManagerï¼å¨ NettyConnectionManager ä¸­æå ä¸ªå¾éè¦çå¯¹è±¡ã</p>
<pre><code class="language-java">public NettyConnectionManager(
        NettyBufferPool bufferPool,
        ResultPartitionProvider partitionProvider,
        TaskEventPublisher taskEventPublisher,
        NettyConfig nettyConfig,
        boolean connectionReuseEnabled) {

    this.server = new NettyServer(nettyConfig);
    this.client = new NettyClient(nettyConfig);
    this.bufferPool = checkNotNull(bufferPool);

    this.partitionRequestClientFactory =
            new PartitionRequestClientFactory(
                    client, nettyConfig.getNetworkRetries(), connectionReuseEnabled);

    this.nettyProtocol =
            new NettyProtocol(
                    checkNotNull(partitionProvider), checkNotNull(taskEventPublisher));
}
</code></pre>
<p>server å client ä¸éè¦å¤ä»ç»ï¼å°±æ¯ Netty çæå¡ç«¯åå®¢æ·ç«¯ãbufferPool æ¯ç¼å²æ± ï¼ç¨äºå­å¨è¦ä¼ è¾çæ°æ®ãnettyProtocol æä¾äº NettyClient å NettyServer å¼å¯¼å¯å¨æ³¨åç Channel Handlerã</p>
<p>åé¢å°±æ¯åå»º NettyShuffleEnvironment åå¶éè¦çå¯¹è±¡äºãå¨åå»ºå®æåï¼ä¼è°ç¨å®ç start æ¹æ³å¯å¨ãè¿ä¸ªå¯å¨æ¹æ³å°±æ¯è°ç¨äº <code>connectionManager.start</code>ï¼å¨ NettyConnectionManager ä¸­ï¼å°±æ¯åå§åå®¢æ·ç«¯åæå¡ç«¯ã</p>
<pre><code class="language-java">public int start() throws IOException {
    client.init(nettyProtocol, bufferPool);

    return server.init(nettyProtocol, bufferPool);
}
</code></pre>
<h4 id="client-åå§å">client åå§å</h4>
<p>client çåå§åè¿ç¨æ¯ååå»ºå¹¶åå§å Bootstrapã</p>
<pre><code class="language-java">private void initEpollBootstrap() {
    // Add the server port number to the name in order to distinguish
    // multiple clients running on the same host.
    String name =
            NettyConfig.CLIENT_THREAD_GROUP_NAME + " (" + config.getServerPortRange() + ")";

    EpollEventLoopGroup epollGroup =
            new EpollEventLoopGroup(
                    config.getClientNumThreads(), NettyServer.getNamedThreadFactory(name));
    bootstrap.group(epollGroup).channel(EpollSocketChannel.class);

    config.getTcpKeepIdleInSeconds()
            .ifPresent(idle -&gt; bootstrap.option(EpollChannelOption.TCP_KEEPIDLE, idle));
    config.getTcpKeepInternalInSeconds()
            .ifPresent(
                    interval -&gt; bootstrap.option(EpollChannelOption.TCP_KEEPINTVL, interval));
    config.getTcpKeepCount()
            .ifPresent(count -&gt; bootstrap.option(EpollChannelOption.TCP_KEEPCNT, count));
}
</code></pre>
<p>åå§åè¿ç¨éè¦è®¾ç½® EventLoopGroup å channelï¼å¯ä»¥ç¨ epoll çè¯å°±ç¨ epollï¼å¦åå°±ç¨ nioãè®¾ç½®å¥½è¿äºåå°±æ¯è®¾ç½®äºä¸äºééåæ°ï¼è¿æ¥è¶æ¶æ¶é´ãBufffer æ± ç­ï¼ã</p>
<p>å°è¿é client çåå§åå¶å®å¹¶æ²¡æç»æï¼è¿éè¦è®¾ç½® Handler æµæ°´çº¿ï¼è¿äºå·¥ä½æ¯å¨ Task å¯å¨æ¶æ§è¡äºã</p>
<h4 id="server-åå§å">server åå§å</h4>
<p>server çåå§åè¿ç¨æ¯ååå»ºå¹¶åå§åäº ServerBootstrapãä¹ååæ ·ä¹æ¯è®¾ç½® EventLoopGroup å channelï¼ä»¥åééç¸å³çåç§åæ°ã</p>
<p>è®¾ç½®å¥½ä¹åï¼ä¼æ·»å  ChannelHandler æµæ°´çº¿ï¼è¿éç ChannelHandler æµæ°´çº¿å°±æ¯æä»¬åé¢åå»ºç NettyProtocol æä¾çã</p>
<pre><code class="language-java">public ChannelHandler[] getServerChannelHandlers() {
    PartitionRequestQueue queueOfPartitionQueues = new PartitionRequestQueue();
    PartitionRequestServerHandler serverHandler =
            new PartitionRequestServerHandler(
                    partitionProvider, taskEventPublisher, queueOfPartitionQueues);

    return new ChannelHandler[] {
        messageEncoder,
        new NettyMessage.NettyMessageDecoder(),
        serverHandler,
        queueOfPartitionQueues
    };
}
</code></pre>
<p>æµæ°´çº¿ä¸åå«äºæ¶æ¯ç¼ç å¨ãè§£ç å¨ãPartitionRequestServerHandler è¯·æ±æå¡ç«¯å¤çå¨å PartitionRequestQueue ååºè¯·æ±éåã</p>
<p>è¿äºé½è®¾ç½®å¥½ä¹åï¼å°±å¼å§å¯å¨ NettyServer æå¡äºã</p>
<pre><code class="language-java">Iterator&lt;Integer&gt; portsIterator = config.getServerPortRange().getPortsIterator();
while (portsIterator.hasNext() &amp;&amp; bindFuture == null) {
    Integer port = portsIterator.next();
    LOG.debug("Trying to bind Netty server to port: {}", port);

    bootstrap.localAddress(config.getServerAddress(), port);
    try {
        bindFuture = bootstrap.bind().syncUninterruptibly();
    } catch (Exception e) {
        // syncUninterruptibly() throws checked exceptions via Unsafe
        // continue if the exception is due to the port being in use, fail early
        // otherwise
        if (isBindFailure(e)) {
            LOG.debug("Failed to bind Netty server", e);
        } else {
            throw e;
        }
    }
}

if (bindFuture == null) {
    throw new BindException(
            "Could not start rest endpoint on any port in port range "
                    + config.getServerPortRange());
}

localAddress = (InetSocketAddress) bindFuture.channel().localAddress();
</code></pre>
<h3 id="å®¢æ·ç«¯è¯·æ±è¿ç«¯å­ååº">å®¢æ·ç«¯è¯·æ±è¿ç«¯å­ååº</h3>
<p>æå¡ç«¯åå®¢æ·ç«¯åå§åä¹åï¼å¨ Task è¿è¡æ¶ï¼ä¼åå®æ Client ç ChannelHandler çéç½®ï¼ç¶åè¯·æ± Netty è¿ç«¯æå¡ã</p>
<p><img alt="NettyRequestPartition" loading="lazy" data-src="https://res.cloudinary.com/dxydgihag/image/upload/v1767668875/Blog/flink/19/NettyRequestPartition.png" class="lazyload"></p>
<p>æä»¬æ¥çå·ä½è¿ç¨ï¼å¨ Task åå§åæ¶ï¼ä¼è°ç¨ <code>StreamTask.invoke</code> æ¹æ³ï¼å¶åé¨ä¼è°ç¨ <code>StreamTask.restoreStateAndGate</code> æ¹æ³ï¼è¿éä¼ä¾¿å© Task çææ InputGateï¼ç¶åè°ç¨ requestPartitionsãå¨ InputGate ç requestPartitions é»è¾ä¸­ï¼åä¾¿å©ææç InputChannelï¼è°ç¨ requestSubpartitionsã</p>
<pre><code class="language-java">for (InputGate inputGate : inputGates) {
    recoveredFutures.add(inputGate.getStateConsumedFuture());

    inputGate
            .getStateConsumedFuture()
            .thenRun(
                    () -&gt;
                            mainMailboxExecutor.execute(
                                    inputGate::requestPartitions,
                                    "Input gate request partitions"));
}


private void internalRequestPartitions() {
    for (InputChannel inputChannel : inputChannels()) {
        try {
            inputChannel.requestSubpartitions();
        } catch (Throwable t) {
            inputChannel.setError(t);
            return;
        }
    }
}
</code></pre>
<p>æä»¬æ¥ç <code>RemoteInputChannel.requestSubpartitions</code> çé»è¾ã</p>
<pre><code class="language-java">public void requestSubpartitions() throws IOException, InterruptedException {
    if (partitionRequestClient == null) {
        LOG.debug(
                "{}: Requesting REMOTE subpartitions {} of partition {}. {}",
                this,
                consumedSubpartitionIndexSet,
                partitionId,
                channelStatePersister);
        // Create a client and request the partition
        try {
            partitionRequestClient =
                    connectionManager.createPartitionRequestClient(connectionId);
        } catch (IOException e) {
            // IOExceptions indicate that we could not open a connection to the remote
            // TaskExecutor
            throw new PartitionConnectionException(partitionId, e);
        }

        partitionRequestClient.requestSubpartition(
                partitionId, consumedSubpartitionIndexSet, this, 0);
    }
}
</code></pre>
<p>è¿éä¸»è¦æä¸¤ä¸ªæ­¥éª¤ï¼åæ¯åå»º partitionRequestClientï¼ç¶åè°ç¨ requestSubpartitionã</p>
<h4 id="åå»ºè¯·æ±å®¢æ·ç«¯">åå»ºè¯·æ±å®¢æ·ç«¯</h4>
<p>PartitionRequestClient æ¯å¨ <code>PartitionRequestClientFactory.connect</code> ä¸­åå»ºçãåè°ç¨äº <code>NettyClient.connect</code>ï¼åæ­¥ç­å¾å®¢æ·ç«¯è¿æ¥å°æå¡ç«¯ï¼è¿ä¸ªè¿ç¨ä¸­ä¼è¿è¡ ChannelHandler éç½®ï¼ä¹å°±æ¯æä»¬å¨åå§åçè¿ç¨ä¸­ä»ç»çï¼NettyClient æ²¡æå®æçæ­¥éª¤ã</p>
<pre><code class="language-java">public ChannelHandler[] getClientChannelHandlers() {
    NetworkClientHandler networkClientHandler = new CreditBasedPartitionRequestClientHandler();

    return new ChannelHandler[] {
        messageEncoder,
        new NettyMessageClientDecoderDelegate(networkClientHandler),
        networkClientHandler
    };
}
</code></pre>
<p>Handler åæ¬äºæ¶æ¯ç¼ç å¨ãè§£ç å¨å CreditBasedPartitionRequestClientHandler è¿ä¸ªåºäº Credit çååºè¯·æ±å®¢æ·ç«¯å¤çå¨ãHandler éç½®å¥½ä¹åä¼å©ç¨ bootstrap è¿æ¥å°æå¡ç«¯ã</p>
<p>å¨è·åå° Channel å NetworkClientHandler ä¹åï¼å°±ç´æ¥åå»ºäº NettyPartitionRequestClientã</p>
<h4 id="è¯·æ±å­ååºæ°æ®">è¯·æ±å­ååºæ°æ®</h4>
<p>è®©æä»¬ååå° RemoteInputChannel ç requestSubpartitions æ¹æ³ä¸­ï¼ç°å¨æä»¬åå»ºå¥½äº NettyPartitionRequestClientï¼æ¥ä¸æ¥å°±æ¯è°ç¨å®ç requestSubpartition æ¹æ³æ¥åèµ·è¯·æ±ã</p>
<p>è¿éé»è¾ä¹æ¯è¾ç®åï¼</p>
<ol>
<li>
<p>å NetworkClientHandler æ³¨åå½å RemoteInputChannelã</p>
</li>
<li>
<p>æé è¯·æ±å¯¹è±¡ PartitionRequestï¼è¿éåå«äºååº IDãå­ååºç´¢å¼ãinputChannel ID ä»¥ååè¯ç Creditã</p>
</li>
<li>
<p>è°ç¨ <code>tcpChannel.writeAndFlush</code> åèµ·è¯·æ±ï¼å¹¶æ·»å è¯·æ±å¤±è´¥ççå¬ã</p>
</li>
<li>
<p>å¦æè¯·æ±å¤±è´¥ï¼ç§»é¤å½å inputChannelã</p>
</li>
</ol>
<h3 id="æå¡ç«¯ååº">æå¡ç«¯ååº</h3>
<p>ç°å¨æ°æ®å°äºæå¡ç«¯ï¼æä»¬æ¥çæå¡ç«¯å¤ççå·ä½è¿ç¨ã</p>
<p><img alt="NettyServerHandler" loading="lazy" data-src="https://res.cloudinary.com/dxydgihag/image/upload/v1767684663/Blog/flink/19/NettyServerHandler.png" class="lazyload"></p>
<p>å¨ NettyServer åå§åçè¿ç¨ä¸­ï¼æä»¬æ·»å äºä¸¤ä¸ªéè¦ç Handlerï¼åå«æ¯ PartitionRequestServerHandler å PartitionRequestQueueãæå¡ç«¯ååºæ°æ®çè¿ç¨å°±æ¯è¿ä¸¤ä¸ª Handler å¨åæ¥ä½ç¨ã</p>
<p>PartitionRequestServerHandler è´è´£å¤ç Client ç«¯éè¿ PartitionRequestClient åéçè¯·æ±ï¼å¤çè¿ç¨æ¯ååå»º CreditBasedSequenceNumberingViewReader ç±»åç readerï¼ç¶åå°å®æ¾å¥ PartitionRequestQueue ç»´æ¤ç reader éåä¸­ãPartitionRequestQueue ä¼çå¬ Netty Channel çå¯åå¥ç¶æï¼å½ Netty Channel å¯åå¥æ¶ï¼ä¼æ¶è´¹æ°æ®å¹¶åå¥ç½ç»ã</p>
<p>ä¸é¢æä»¬æ¥çå·ä½çæºç ã</p>
<p>æå¡ç«¯çååºå¥å£å¨ <code>PartitionRequestServerHandler.channelRead0</code> æ¹æ³ï¼è¿éå¨å¤ç PartitionRequest è¯·æ±æ¶ï¼åæ¯åå»º CreditBasedSequenceNumberingViewReaderï¼ç¶åè°ç¨ requestSubpartitionViewOrRegisterListenerã</p>
<p>requestSubpartitionViewOrRegisterListener çé»è¾æ¯åå»º ResultSubpartitionViewï¼å¹¶æé PartitionRequestQueue ææ°æ®å¯ç¨ã</p>
<pre><code class="language-java">Optional&lt;ResultSubpartitionView&gt; subpartitionViewOptional =
        partitionProvider.createSubpartitionViewOrRegisterListener(
                resultPartitionId,
                subpartitionIndexSet,
                this,
                partitionRequestListener);
...

notifyDataAvailable(subpartitionView);
</code></pre>
<p>ResultSubpartitionView å°±æ¯ç¨æ¥æ¶è´¹ ResultSubpartition çæ°æ®ã</p>
<p>notifyDataAvailable åé¨è°ç¨äº notifyReaderNonEmptyï¼notifyReaderNonEmpty åè§¦åäº userEventTriggeredï¼è¿éè°ç¨ enqueueAvailableReader å° reader æ¾å¥å°å¯ç¨éå availableReaders ä¸­ã</p>
<pre><code class="language-java">private void enqueueAvailableReader(final NetworkSequenceViewReader reader) throws Exception {
    if (reader.isRegisteredAsAvailable()) {
        return;
    }

    ResultSubpartitionView.AvailabilityWithBacklog availabilityWithBacklog =
            reader.getAvailabilityAndBacklog();
    if (!availabilityWithBacklog.isAvailable()) {
        int backlog = availabilityWithBacklog.getBacklog();
        if (backlog &gt; 0 &amp;&amp; reader.needAnnounceBacklog()) {
            announceBacklog(reader, backlog);
        }
        return;
    }

    // Queue an available reader for consumption. If the queue is empty,
    // we try trigger the actual write. Otherwise this will be handled by
    // the writeAndFlushNextMessageIfPossible calls.
    boolean triggerWrite = availableReaders.isEmpty();
    registerAvailableReader(reader);

    if (triggerWrite) {
        writeAndFlushNextMessageIfPossible(ctx.channel());
    }
}
</code></pre>
<p>å¦æ reader æ¯éåä¸­çç¬¬ä¸ä¸ªåç´ ï¼ä¼è§¦åæ°æ®åå¥ç½ç»ã</p>
<p>writeAndFlushNextMessageIfPossible çå¤çæ­¥éª¤å¦ä¸ï¼</p>
<ol>
<li>
<p>ååºå¯ç¨ readerã</p>
</li>
<li>
<p>è°ç¨ <code>reader.getNextBuffer</code> è·åæ°æ®ã</p>
</li>
<li>
<p>å¦æ reader ä»ç¶å¯ç¨ï¼å°å¶å åéåã</p>
</li>
<li>
<p>åä¸æ¸¸åå¥æ°æ®å¹¶æ·»å ä¸æ¬¡åå¥ççå¬ã</p>
</li>
</ol>
<pre><code class="language-java">public BufferAndAvailability getNextBuffer() throws IOException {
    BufferAndBacklog next = subpartitionView.getNextBuffer();
    if (next != null) {
        if (next.buffer().isBuffer() &amp;&amp; --numCreditsAvailable &lt; 0) {
            throw new IllegalStateException("no credit available");
        }

        final Buffer.DataType nextDataType = getNextDataType(next);
        return new BufferAndAvailability(
                next.buffer(), nextDataType, next.buffersInBacklog(), next.getSequenceNumber());
    } else {
        return null;
    }
}
</code></pre>
<p>å¨ getNextBuffer æ¹æ³ä¸­ï¼ä¼å° credit å¼å 1ï¼å¹¶å¤æ­æ¯å¦å°äº 0ãå¦æå°äº 0 ä¼æåºå¼å¸¸ï¼reader æ¯å¦å¯ç¨ä¹æ¯æ ¹æ® numCreditsAvailable æ¯å¦å¤§äº 0 æ¥å¤æ­çã</p>
<h3 id="å®¢æ·ç«¯æ¥æ¶æ°æ®">å®¢æ·ç«¯æ¥æ¶æ°æ®</h3>
<p>NettyClient å¨æ¶è´¹æ°æ®æ¶ï¼åæ ·ä¹æ¯ä»¥ ChannelHandler ä½ä¸ºå¥å£ãè¿éçå¥å£æ¹æ³æ¯ <code>CreditBasedPartitionRequestClientHandler.channelRead</code> ã</p>
<p><img alt="NettyClientHandler" loading="lazy" data-src="https://res.cloudinary.com/dxydgihag/image/upload/v1767689791/Blog/flink/19/NettyClientHandler.png" class="lazyload"></p>
<p>å¨ decodeMsg æ¹æ³ä¸­ï¼åè§£ç  msgï¼å¤æ­ InputChannel æ¯å¦å¯ç¨ï¼å¦æä¸å¯ç¨ï¼ååæ¶å½å InputChannel çè®¢éãå¦æå¯ç¨ï¼ç»§ç»­è°ç¨ decodeBufferOrEvent è¿è¡å¤çãdecodeBufferOrEvent çæ ¸å¿é»è¾æ¯è°ç¨ <code>RemoteInputChannel.onBuffer</code> æ¹æ³ï¼å°æ°æ®å å¥å° receivedBuffers éåã</p>
<p>å¦æ receivedBuffers éåå¨æ­¤ä¹åå¤äºç©ºé²ç¶æï¼ä¼è°ç¨ notifyChannelNonEmptyï¼å°å½å RemoteInputChannel å å¥å° inputChannelsWithData éåä¸­ï¼åæ¶è¿ä¼å¤é inputChannelsWithData ä¸çé»å¡çº¿ç¨ï¼è®© inputGate å¯ä»¥æ¶è´¹ RemoteInputChannel çæ°æ®ã</p>
<pre><code class="language-java">private boolean queueChannelUnsafe(InputChannel channel, boolean priority) {
    assert Thread.holdsLock(inputChannelsWithData);
    if (channelsWithEndOfPartitionEvents.get(channel.getChannelIndex())) {
        return false;
    }

    final boolean alreadyEnqueued =
            enqueuedInputChannelsWithData.get(channel.getChannelIndex());
    if (alreadyEnqueued
            &amp;&amp; (!priority || inputChannelsWithData.containsPriorityElement(channel))) {
        // already notified / prioritized (double notification), ignore
        return false;
    }

    // å½å inputChannel å å¥å° inputChannelsWithData
    inputChannelsWithData.add(channel, priority, alreadyEnqueued);
    if (!alreadyEnqueued) {
        enqueuedInputChannelsWithData.set(channel.getChannelIndex());
    }
    return true;
}

// å¤éçº¿ç¨
public void notifyDataAvailable() {
    availabilityMonitor.notifyAll();
    toNotify = inputGate.availabilityHelper.getUnavailableToResetAvailable();
}
</code></pre>
<p>å¦æå®¢æ·ç«¯æç§¯åï¼è¿éè¦æ ¹æ®ç§¯åç³è¯· Buffer å¹¶æ´æ° Credit å¼ãè¿éç³è¯·ç buffer æ°éä¸ºç§¯åæ°é+åè¯ Credit å¼ã</p>
<pre><code class="language-java">public void onSenderBacklog(int backlog) throws IOException {
    notifyBufferAvailable(bufferManager.requestFloatingBuffers(backlog + initialCredit));
}
</code></pre>
<p>å¦æ RemoteInputChannel æ²¡æè¶³å¤ç bufferï¼åä¼å LocalBufferPool ç³è¯·æ°ç bufferï¼å¦æç³è¯·ä¸å°ï¼ä¼å ä¸ä¸ªçå¬ï¼ç­ LocalBufferPool æç©ºé²æ¶åè§¦åç³è¯· bufferã</p>
<pre><code class="language-java">private int tryRequestBuffers() {
    assert Thread.holdsLock(bufferQueue);

    int numRequestedBuffers = 0;
    while (bufferQueue.getAvailableBufferSize() &lt; numRequiredBuffers
            &amp;&amp; !isWaitingForFloatingBuffers) {
        BufferPool bufferPool = inputChannel.inputGate.getBufferPool();
        Buffer buffer = bufferPool.requestBuffer();
        if (buffer != null) {
            bufferQueue.addFloatingBuffer(buffer);
            numRequestedBuffers++;
        } else if (bufferPool.addBufferListener(this)) {
            isWaitingForFloatingBuffers = true;
            break;
        }
    }
    return numRequestedBuffers;
}
</code></pre>
<p>å½ RemoteInputChannel ç³è¯·å°äºéè¦ç buffer ä¹åï¼å°±ä¼å NettyServer åé AddCredit æ¶æ¯ï¼è¯·æ±æ´æ° Credit å¼ã</p>
<pre><code class="language-java">private void notifyCreditAvailable() throws IOException {
    checkPartitionRequestQueueInitialized();

    partitionRequestClient.notifyCreditAvailable(this);
}


public void notifyCreditAvailable(RemoteInputChannel inputChannel) {
    sendToChannel(new AddCreditMessage(inputChannel));
}
</code></pre>
<p>NettyServer æ¶å°è¯·æ±åï¼ä¼å°å¯¹åºç Credit å¼è¿è¡æ´æ°ã</p>
<pre><code class="language-java">else if (msgClazz == AddCredit.class) {
    AddCredit request = (AddCredit) msg;

    outboundQueue.addCreditOrResumeConsumption(
            request.receiverId, reader -&gt; reader.addCredit(request.credit));
}

void addCreditOrResumeConsumption(
        InputChannelID receiverId, Consumer&lt;NetworkSequenceViewReader&gt; operation)
        throws Exception {
    if (fatalError) {
        return;
    }

    NetworkSequenceViewReader reader = obtainReader(receiverId);

    operation.accept(reader);
    enqueueAvailableReader(reader);
}


public void addCredit(int creditDeltas) {
    numCreditsAvailable += creditDeltas;
}
</code></pre>
<p>æ­¤å¤ï¼Flink è¿æä¸¤ç§åºæ¯ä¼æ´æ° Credit å¼ã</p>
<p>ä¸ç§æ¯ LocalBufferPool åæ¶ç©ºé² buffer æ¶ï¼ä¼å° buffer åéç»ç³è¯·èï¼åéä¹åä¼è°ç¨å¯¹åº InputChannel ç notifyBufferAvailable æ¹æ³éç¥æ´æ° Creditã</p>
<p><img alt="LocalBufferPool" loading="lazy" data-src="https://res.cloudinary.com/dxydgihag/image/upload/v1767694630/Blog/flink/19/LocalBufferPoolRecycle.png" class="lazyload"></p>
<p>å¦ä¸ç§æ¯ RemoteInputChannel ç¬å ç buffer éåéæ¾ buffer æ¶ï¼ä¼è§¦å Credit æ´æ°ã</p>
<p><img alt="BufferManager" loading="lazy" data-src="https://res.cloudinary.com/dxydgihag/image/upload/v1767700038/Blog/flink/19/BufferManagerRecycle.png" class="lazyload"></p>
<h3 id="åå">åå</h3>
<p>éè¿åé¢çå­¦ä¹ ï¼æä»¬å¶å®å·²ç»çè§£äºååçæºå¶äºãå½å Flink çååå°±æ¯éè¿ Credit æ¥å®ç°ååçï¼å¦æä¸æ¸¸æ°æ®å¤çéåº¦æ¢ï¼Credit ä¼è¢«èå°½ï¼ä¸æ¸¸ä¹å°±ä¸ä¼ç»§ç»­å¤çåä¸åæ°æ®äºãç´å°ä¸æ¸¸å¤çå®æï¼æäºç©ºé²ç bufferï¼æ­¤æ¶åä¸æ¸¸åé¦æ´æ° Credit å¼ï¼ä¸æ¸¸å°±ä¼ç»§ç»­å¤çæ°æ®ã</p>
<h3 id="æ»ç»">æ»ç»</h3>
<p>æåæä»¬æ»ç»ä¸ä¸ï¼æ¬ææä»¬ä¸èµ·æ¢³çäº Flink Netty ç¸å³çæºç ãåæ¬ NettyClient å NettyServer çåå§åï¼åå§åè¿ç¨ä¸­ä¼åå»ºä¸ç³»å ChannelHandlerï¼ä¹åå©ç¨è¿äºHandler å¤çæ°æ®ï¼æ°æ®å¤çåæ¬ Client ç«¯çåéåæ¥æ¶æ¶æ¯ï¼Server ç«¯å¤çæ¶æ¯çè¿ç¨ãä¸­é´è¿ç©¿æç Credit çå¤çãFlink çååé»è¾å°±æ¯ä¾èµäº Credit æ¥å®ç°çã</p>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-01-12 20:40">2026-01-12 20:40</span>&nbsp;
<a href="https://www.cnblogs.com/Jackeyzhe">Jackeyzhe</a>&nbsp;
éè¯»(<span id="post_view_count">0</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19474170);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19474170', targetLink: 'https://www.cnblogs.com/Jackeyzhe/p/19474170', title: 'Flinkæºç éè¯»ï¼Nettyéä¿¡' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
        </channel>
        </rss>