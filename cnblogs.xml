<?xml version="1.0" encoding="UTF-8" ?>
    <rss version="2.0">
    <channel>
        <title><![CDATA[ ä¸»é¡µ - åå®¢å­ ]]></title>
        <link><![CDATA[ https://www.cnblogs.com/ ]]></link>
        <lastBuildDate>2026-02-11T13:15:29.978Z</lastBuildDate>
        <description><![CDATA[
        ä¸»é¡µ - åå®¢å­ RSS
    ]]></description>
        <language>zh-cn</language>
        <item>
    <title><![CDATA[ ä¸ºä»ä¹åæ ·æ¯"å­¦è¿C++"ï¼æäººé¢è¯ç¢¾åï¼æäººå¼å£å°±æï¼å·®è·å¨è¿18ä¸ªC++ç¡¬æ ¸é¡¹ç® ]]></title>
    <link>https://www.cnblogs.com/xiaokang-coding/p/19605989</link>
    <guid>a1f4b41c799f524ea4e14bac8b5e37ec</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/xiaokang-coding/p/19605989" title="åå¸äº 2026-02-11 21:05">
    <span role="heading" aria-level="2">ä¸ºä»ä¹åæ ·æ¯"å­¦è¿C++"ï¼æäººé¢è¯ç¢¾åï¼æäººå¼å£å°±æï¼å·®è·å¨è¿18ä¸ªC++ç¡¬æ ¸é¡¹ç®</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<p>å¿ï¼åä½C++erï¼ææ¯å°åº·ð</p>
<p>ä»å¤©è¿ç¯æç« ï¼ææ³åå¾åä»¥å¾ä¸å¤ªä¸æ ·ã</p>
<p>ä¸èææ¯åçï¼ä¸è®²æ¶æè®¾è®¡ï¼å°±èä¸ä¸ªé®é¢ï¼</p>
<p><strong>ä½ å­¦äºé£ä¹ä¹C++ï¼ä¸ºä»ä¹è¿æ¯åä¸åºä¸ä¸ªæ¿å¾åºæçé¡¹ç®ï¼</strong></p>
<h2 id="åçä¸æ¡è®©ææè§¦ææ·±çç§ä¿¡">åçä¸æ¡è®©ææè§¦ææ·±çç§ä¿¡</h2>
<p>åå å¤©ä¸ä¸ªå­¦ååç»æè¿æ®µè¯ï¼</p>
<p>"åº·å¥ï¼ææåå­æ± é¡¹ç®æ´çè¿ç®åï¼é¢è¯å®é®æ'ä½ è¿ä¸ªåå­æ± æ¯mallocå¿«7åï¼æä¹å®ç°ç'ï¼æä»ThreadCacheè®²å°PageHeapï¼åè®²å°æ¹éåéåæ éè®¾è®¡ï¼é¢è¯å®ç´æ¥è¯´'è¿ä¸ªææ¡å¾å¾æå®'ãä¸å¹´äºï¼ç¬¬ä¸æ¬¡å¨é¢è¯éæè§å°åºæ°ã"</p>
<p>è¿ä¸æ¯æ®µå­ï¼æ¯çå®åççäºã</p>
<p>è¿å»å¤§åå¹´ï¼æéç»­åäº<strong>18ä¸ªC++ç¡¬æ ¸é¡¹ç®å®æè¯¾ç¨</strong>ï¼å¸¦äº<strong>300å¤ä½åå­¦</strong>ä»é¶å¼å§å®ç°è¿äºé¡¹ç®ââ985ã211æï¼æ®éæ¬ç§æï¼å·¥ä½3å¹´æ¢æ¹åçæï¼åºå±çæï¼å¤§å®¶èæ¯å·®è·å¾å¤§ï¼ä½æ¶è·åºå¥å°ä¸è´ï¼</p>
<p><strong>ä»"çå¾æå«äººä»£ç "åçº§æäº"èªå·±è½ä»0ååºæ¥"ã</strong></p>
<p>è¿ç¯æç« ï¼æå°±æè¿18ä¸ªé¡¹ç®å®æ´ä»ç»ä¸éã</p>
<h2 id="åè¯´è¯´æå¯¹å¸é¢ä¸é£äºcè¯¾ç¨ççæ³">åè¯´è¯´æå¯¹å¸é¢ä¸é£äºC++è¯¾ç¨ççæ³</h2>
<p>ç´æ¥è¯´ï¼å¤§é¨åé½æ¯"ä¼ªå®æ"ã</p>
<p><strong>æ¨¡å¼ä¸ï¼å¼æºé¡¹ç®æ¬è¿å·¥ã</strong> å»GitHubæ¾ä¸ªé«staré¡¹ç®ï¼ç§çè®²ä¸éãä½ çå®ç¥é"è¿æ®µä»£ç å¨åä»ä¹"ï¼ä½æ ¹æ¬ä¸ç¥é"ä¸ºä»ä¹è¿æ ·è®¾è®¡"ï¼æ´ä¸ä¼èªå·±ä»å¤´åã</p>
<p><strong>æ¨¡å¼äºï¼ç»ä½ ä¸ªå®æ´ä»£ç èªå·±åã</strong> æä¸ä¸ª3000è¡é¡¹ç®ç»ä½ ï¼è¯´"å­¦å®å°±è¡äº"ãéå°é®é¢æ¾ä¸å°äººé®ï¼è¸©äºåä¸ç¥éæä¹è§£ã</p>
<p><strong>æ¨¡å¼ä¸ï¼åªæç©å·Demoã</strong> æ ¸å¿åè½ä¸å åå ï¼ç»æå¼åºæ¥çä¸è¥¿æ ¹æ¬ä¸ä¸äºçäº§ï¼é¢è¯ä¸é®ç»èå°±é²é¦ã</p>
<p>æçæ¹å¼ä¸ä¸æ ·ï¼<strong>ææé¡¹ç®é½æ¯ææ¬äººä»0å°1è®¾è®¡å®ç°çååä»£ç ï¼ç¨å¢éå¼æå­¦å¸¦ä½ ä¸æ­¥æ­¥æå»ºï¼æ¯å¤©é½æå¯è¿è¡ççæ¬ï¼æ¯ä¸ªè®¾è®¡å³ç­é½ä¼è§£é"ä¸ºä»ä¹è¿ä¹å"ã</strong></p>
<p><strong>ä¸è¿å¨ä»ç»é¡¹ç®ä¹åï¼åè¯´è¯´è¿å¥è¯¾ç¨æ´éååªäºäººï¼</strong></p>
<p><strong>â  æ­£å¨æ±èãä¸ç¥éç®åä¸è¯¥åä»ä¹é¡¹ç®çåå­¦</strong>ââä¸æ¯è¯´ä½ æ²¡è½åï¼èæ¯ä½ ç¼ºå°ä¸ä¸ªä»0å¼å§ãè½è®²åºæ¥ãç»å¾èµ·é¢è¯å®è¿½é®çé¡¹ç®ãè¿éé¢ä»»ä½ä¸ä¸ªï¼é½å¯ä»¥æ­£å¤§åæåè¿ç®åï¼èä¸é¢è¯å®è¶é®è¶æåºæ°ã</p>
<p><strong>â¡ å·¥ä½äºå å¹´ãä»£ç éä¸ç´ä¸ä¸å»çå¼åè</strong>ââä½ ä¸æ¯ç¼ºçè®ºï¼æ¯ç¼ºä¸æ¬¡æå·¥ä¸çº§ä»£ç ä»é¶ååºæ¥çå®æ´ç»åãå¾å¤äººå·¥ä½ä¸å¹´ï¼åçä»£ç é»è¾å¤æåº¦æ²¡è¶è¿CRUDï¼è¿äºé¡¹ç®å¯ä»¥å¸®ä½ å¿«éè¡¥ä¸è¿æ®µç»åã</p>
<p><strong>â¢ æ³ç³»ç»æåC++å®æè½åçåå­¦</strong>ââä¸ç®¡ä½ æ¯å¨æ ¡çè¿æ¯è½¬æ¹åçï¼è½ç¬ç«å®ç°ä¸ä¸ªé«æ§è½åå­æ± ãä¸ä¸ªæ ééåãä¸ä¸ªåç¨åºï¼ä½ çC++å·²ç»è¶è¿80%çåé¾äººäºã</p>
<p>ç¨ä¸å¥è¯æ¦æ¬ï¼<strong>è¿å¥è¯¾ç¨ä¸æ¯è®©ä½ "çæå«äººçä»£ç "ï¼èæ¯å¸¦ä½ å¿«éå®ç°é¡¹ç®ï¼ä»é¶å°ä¸ï¼çæ­£ååºæ¥ã</strong></p>
<p>å¥½äºï¼åºè¯å°è¯´ï¼ä¸é¢è¿å¥æ­£é¢ã</p>
<h2 id="-18ä¸ªé¡¹ç®å®æ´ä»ç»">ð¦ 18ä¸ªé¡¹ç®å®æ´ä»ç»</h2>
<h3 id="-åºç¡è®¾æ½ç¯6ä¸ªé¡¹ç®">ð§µ åºç¡è®¾æ½ç¯ï¼6ä¸ªé¡¹ç®ï¼</h3>
<p><strong>1. çº¿ç¨æ±  Â· 299å Â· 7å¤©</strong> ð <a href="https://mp.weixin.qq.com/s/10md6XvqpFug5S7LW8m29Q" target="_blank" rel="noopener nofollow">ç¹å»æ¥çè¯¦æ</a></p>
<p>å ä¹ææC++åå°é¢è¯å¿é®ï¼ä½99%çåéäººåªèè¿ç­æ¡ï¼æ²¡å®ç°è¿ã</p>
<p>è¿ä¸ªé¡¹ç®ä¸æ¯é£ç§"å åè¡å°±å®äº"çç©å·ã1700+è¡ä»£ç ï¼ä»åºç¡æ¡æ¶å°å®æ´çå·¥ä¸çº§çº¿ç¨æ± ï¼åå«ï¼ä»»å¡ä¼åçº§è°åº¦ãå¨æè°æ´çº¿ç¨æ°ãåºäº<code>std::future</code>çå¼æ­¥ç»æè·åãä»»å¡åæ¶ä¸è¶æ¶æºå¶ãå®æ´çç¶æçæ§â¦â¦</p>
<p>7å¤©æ¸è¿å¼å®ç°ï¼æ¯å¤©ä¸ä¸ªå¯è¿è¡çæ¬ãå­¦å®ä½ è½èªä¿¡è·é¢è¯å®è¯´ï¼è¿ä¸ªæèªå·±åè¿ï¼æ¥ï¼æç»ä½ ç»æ¶æå¾ã</p>
<p><strong>é¡¹ç®æ¶æå¾:</strong></p>
<p><img alt="" loading="lazy" data-src="https://files.mdnice.com/user/48364/b8cd1fc2-69df-4d17-ac24-c0d3b398e402.png" class="lazyload"></p>
<p><strong>2. é«æ§è½æ¥å¿åº MiniSpdlog Â· 299å Â· 8å¤©</strong> ð <a href="https://mp.weixin.qq.com/s/Gt4dgmq8V6tbPZOgEqDlZg" target="_blank" rel="noopener nofollow">ç¹å»æ¥çè¯¦æ</a></p>
<p>spdlogæºç æå ä¸è¡ï¼çä¸æãæ¹ä¸å¨ãMiniSpdlogç¨2500è¡æ ¸å¿ä»£ç ï¼å®ç°äºspdlogçç²¾åè®¾è®¡ââåæ­¥/å¼æ­¥ãå¤Sinkãæ ¼å¼åãæ»å¨æä»¶ãMPMCéåãçº¿ç¨æ± â¦â¦</p>
<p>å®æµä¸æ¥æ§è½å¯è½ä¸å¦å¼æºæ¥å¿åºspdlogï¼ä½æ¯ä»£ç å®å¨å¯è¯»å¯æ¹ï¼éåå­¦ä¹ ãè¿ææ¯"å­¦å®ççæ"çé¡¹ç®ã</p>
<p><strong>é¡¹ç®æ¶æå¾:</strong></p>
<p><img alt="" loading="lazy" data-src="https://files.mdnice.com/user/48364/085d8e46-2fc8-426b-a9f5-0025e0adee92.jpg" class="lazyload"></p>
<p><strong>3. é«æ§è½åå­æ±  Â· 299å Â· 10å¤©</strong> ð <a href="https://mp.weixin.qq.com/s/xpSUbVwRZuVoQpRorbpnqA" target="_blank" rel="noopener nofollow">ç¹å»æ¥çè¯¦æ</a></p>
<p>è±äºä¸å¨ï¼åäºä¸ä¸ªè®©malloc"ç ´é²"çåå­æ± ã</p>
<p>å®æµæ°æ®ï¼2048Bå¯¹è±¡åéæ¯mallocå¿«<strong>7.37å</strong>ï¼16çº¿ç¨å¹¶åä¸<strong>9æ9è</strong>ã</p>
<p>æ ¸å¿æ¯ä»¿TCMallocçä¸å±æ¶æï¼ThreadCacheï¼æ éåéï¼+ CentralCacheï¼æ¡¶éï¼éä½208åéç«äºï¼+ PageHeapï¼æ¹éç³è¯·ï¼1æ¬¡ç³»ç»è°ç¨æ1000+æ¬¡åéï¼ã4000+è¡ä»£ç ï¼æ¯ä¸ªä¼åå³ç­é½æperfæ°æ®æ¯æã</p>
<p><strong>é¡¹ç®æ¶æå¾:</strong></p>
<p><img alt="" loading="lazy" data-src="https://files.mdnice.com/user/48364/7729b58a-af55-4b90-8649-1136586f5cf8.png" class="lazyload"></p>
<p><strong>4. MySQLè¿æ¥æ±  Â· 299å Â· 8å¤©</strong> <a href="https://mp.weixin.qq.com/s/b01e8Muwpgnd1jBgwB2fgg" target="_blank" rel="noopener nofollow">ç¹å»æ¥çè¯¦æ</a></p>
<p>æ°æ®åºè¿æ¥ç®¡çæ¯åç«¯å¼åç"å³è"ãè¿ä¸ªé¡¹ç®4200+è¡ä»£ç ï¼åå«ï¼æºè½è¿æ¥ç®¡çãèªå®ä¹éè¿æºå¶ï¼æ¯MySQLå®æ¹éè¿æ´æºè½ï¼ãä¸ç§è´è½½åè¡¡ç®æ³ï¼éæº/è½®è¯¢/æéï¼ãå¥åº·æ£æ¥ãå®æ´äºå¡æ¯æã10+é¡¹æ§è½çæ§ææ â¦â¦</p>
<p>æå­¦åå­¦å®ç´æ¥ç¨å¨å¬å¸é¡¹ç®ä¼åä¸ï¼æ¿äºææ¯å¥å±ã</p>
<p><strong>é¡¹ç®æ¶æå¾:</strong></p>
<p><img alt="" loading="lazy" data-src="https://files.mdnice.com/user/48364/f79bd7da-5b9d-465d-bde3-f84df9518426.png" class="lazyload"></p>
<p><strong>5. åå­æ³æ¼æ£æµå¨ MemTracker Â· 299å Â· 7å¤©</strong> ð <a href="https://mp.weixin.qq.com/s/u7xa1rLz0kXD0cax84pxiw" target="_blank" rel="noopener nofollow">ç¹å»æ¥çè¯¦æ</a></p>
<p>Valgrindå¤ªéãASanéæå¤æãVSè¯æ­å·¥å·åªæ¯æWindowsâ¦â¦è¿äºçç¹ï¼MemTrackeré½è§£å³äºã</p>
<p>64æ®µåæ®µéæ¶æã16384åå¸æ¡¶ãéæåéæ£æµï¼ä¸çå°æï¼ãç²¾ç¡®å®ä½å°æä»¶ååè¡å·ï¼æ§è½å¼éå ä¹å¯ä»¥å¿½ç¥ã800è¡æ ¸å¿ä»£ç ï¼åªéåå«ä¸ä¸ªå¤´æä»¶å°±è½ç¨ã</p>
<p>é¢è¯å®é®"å¦ä½æ£æµåå­æ³æ¼"çæ¶åï¼ä½ å¯ä»¥è¯´ï¼æèªå·±å®ç°è¿ä¸ä¸ªã</p>
<p><strong>é¡¹ç®æ¶æå¾:</strong></p>
<p><img alt="" loading="lazy" data-src="https://files.mdnice.com/user/48364/34711bd7-e3e8-4d71-921e-d3334670cfae.jpg" class="lazyload"></p>
<p><strong>6. æ­»éæ£æµå·¥å· DeadLock-Sentinel Â· 299å Â· 6å¤©</strong> ð <a href="https://mp.weixin.qq.com/s/kp2yiGupj1ei3M6XPnKeRQ" target="_blank" rel="noopener nofollow">ç¹å»æ¥çè¯¦æ</a></p>
<p>æ­»éæ¯å¤çº¿ç¨å¼åèçå©æ¢¦ãè¿ä¸ªå·¥å·åºäºå¾è®ºç®æ³ï¼æææåºï¼èªå¨æ£æµï¼éæbackward-cppå®ç°å æ è¿½è¸ªï¼æ¥åç´æ¥æ¾ç¤ºæ­»éåççæä»¶ååè¡å·ï¼è¿éæspdlogèªå¨ä¿å­æ¥å¿ãé¶ä¾µå¥ï¼åªéæ<code>std::mutex</code>æ¢æ<code>DeadlockMutex</code>å³å¯å¯ç¨ï¼Releaseæ¶ä¸ä¸ªå®å³æï¼é¶æ§è½æèã</p>
<p><strong>é¡¹ç®æ¶æå¾:</strong></p>
<p><img alt="" loading="lazy" data-src="https://files.mdnice.com/user/48364/ee0f8291-d48f-407b-a6de-fc40733ad141.jpg" class="lazyload"></p>
<h3 id="-é«æ§è½ç»ä»¶ç¯5ä¸ªé¡¹ç®">â¡ é«æ§è½ç»ä»¶ç¯ï¼5ä¸ªé¡¹ç®ï¼</h3>
<p><strong>7. ReactorXäºä»¶é©±å¨å¼æ Â· 299å Â· 5å¤©</strong> ð <a href="https://mp.weixin.qq.com/s/OpHbNeLvmTaXA4ZlRI785w" target="_blank" rel="noopener nofollow">ç¹å»æ¥çè¯¦æ</a></p>
<p>è¾è®¯/å­èé¢è¯å®é½å¨é®çReactoræ¨¡å¼ï¼ç»äºæäººæä½ ä»0å°1å®ç°äºã</p>
<p>2000è¡ä»£ç å®ç°å®æ´çReactorå¼æï¼epollå°è£ãEventLoopäºä»¶å¾ªç¯ãåºäºtimerfdçé«ç²¾åº¦å®æ¶å¨ãeventfdè·¨çº¿ç¨éä¿¡ãEventLoopThreadPoolâ¦â¦å®æµæ¯æ50000+å¹¶åè¿æ¥ï¼QPSè¾¾50ä¸+ãè¿æ¯åç»­ç½ç»åºãHTTPæå¡å¨çåºç¡ã</p>
<p><strong>é¡¹ç®æ¶æå¾:</strong></p>
<p><img alt="" loading="lazy" data-src="https://files.mdnice.com/user/48364/7d575c8e-188a-4a7e-b8ee-60f9598f64b0.png" class="lazyload"></p>
<p><strong>8. æ éæ  InfiniteStack Â· 299å Â· 7å¤©</strong> ð <a href="https://mp.weixin.qq.com/s/tjtNHV-_92r2Z-JA_3_q6A" target="_blank" rel="noopener nofollow">ç¹å»æ¥çè¯¦æ</a></p>
<p>æ éç¼ç¨å¥é¨çæä½³é¡¹ç®ãä»CASåå­æä½åçè®²èµ·ï¼å°ABAé®é¢çå®æ´è§£å³æ¹æ¡ï¼åå°å·¥ä¸çº§çHazard Pointer(å±é©æé)åå­åæ¶æºå¶ï¼7å¤©å¸¦ä½ å½»åºæææ éæ°æ®ç»æè®¾è®¡ãæ§è½æ¯std::stack+mutexå¿«2-3åã</p>
<p><strong>9. æ ééå SPSC LightningQueue Â· 100å Â· 6å¤©</strong> ð <a href="https://mp.weixin.qq.com/s/VXbGq_27nnnPgJQWhaFzbw" target="_blank" rel="noopener nofollow">ç¹å»æ¥çè¯¦æ</a></p>
<p>SPSCï¼åçäº§èåæ¶è´¹èï¼æ ééåï¼æ¸¸æå¼æãé³è§é¢å¤çãéèäº¤æç³»ç»çæ éãå®æµæ¯queue+mutexæ¹æ¡å¿«2-4åï¼å»¶è¿éä½å°2411nsãåºäºç¯å½¢ç¼å²åºï¼6å¤©ä»åçå°çäº§å¯ç¨å®ç°ã</p>
<p><strong>10. æ ééå MPMC Thunder Queue Â· 299å Â· 6å¤©</strong> ð <a href="https://mp.weixin.qq.com/s/Nk91RZ6RD4gYRRT7VWfNyg" target="_blank" rel="noopener nofollow">ç¹å»æ¥çè¯¦æ</a></p>
<p>æ éç¼ç¨ç"ç ç©æçå³°"ãå¤çäº§èå¤æ¶è´¹èåºæ¯ï¼lock+queueæ¹æ¡åªæ0.27Mops/sï¼Thunder Queueè½è¾¾å°4.85Mops/sï¼æ§è½æå<strong>è¿20å</strong>ãåºäºFacebook Follyè®¾è®¡ææ³ï¼åå«turnæºå¶ãstrideä¼ªå±äº«ä¼åãèªéåºèªæ+Futexé»å¡ç­å³é®ææ¯ã</p>
<p><strong>11. å·¥ä¸çº§æºè½æé CraftedPtr Â· 299å Â· 7å¤©</strong> ð <a href="https://mp.weixin.qq.com/s/kfG1VoH9eRnCE0YCuKAD5w" target="_blank" rel="noopener nofollow">ç¹å»æ¥çè¯¦æ</a></p>
<p>ç½ä¸é£äºshared_ptrå®ç°å¤§å¤æ¯ç©å·ï¼CraftedPtræ¯çæ­£å¯¹æ std::shared_ptrçå·¥ä¸çº§å®ç°ãæ§å¶ååç¦»ãç±»åæ¦é¤ãHazard Pointerçº¿ç¨å®å¨ãweak_ptrå®æ´æ¯æãmake_sharedåæ¬¡åå­åéä¼åâ¦â¦é¨åæ§è½ææ è¶è¶æ ååºã7å¤©å®æ´å®ç°ï¼è¿ä½ ä¸ä¸ª"èªå·±é çå±äº«æé"ã</p>
<p><strong>é¡¹ç®æ¶æå¾:</strong></p>
<p><img alt="" loading="lazy" data-src="https://files.mdnice.com/user/48364/17eb7c54-a3e5-4728-91a4-49df38216c3e.png" class="lazyload"></p>
<h3 id="-ç»¼åå®æç¯7ä¸ªé¡¹ç®">ð ç»¼åå®æç¯ï¼7ä¸ªé¡¹ç®ï¼</h3>
<p><strong>12. é«æ§è½ç½ç»åº NetCore Â· 499å Â· 10å¤©</strong> ð <a href="https://mp.weixin.qq.com/s/Y3713qRGGQgCO8btemWR_w" target="_blank" rel="noopener nofollow">ç¹å»æ¥çè¯¦æ</a></p>
<p>muduoå ä¸è¡çä¸æï¼NetCoreç¨2200è¡æ ¸å¿ä»£ç å®æ´å®ç°äºMulti-Reactorå¤çº¿ç¨ç½ç»åºï¼Socket RAIIå°è£ãAcceptorè¿æ¥æ¥åãBufferèªå¨æ©å®¹ãTcpConnectionç¶ææºãTcpServerè´è½½åè¡¡â¦â¦å®æ´çEcho Serveræ¼ç¤ºï¼3è¡ä»£ç å¯å¨æå¡ã</p>
<p>å·²æ¥åReactorXçåå­¦ï¼è¡¥å·®ä»·200åå³å¯ã</p>
<p><strong>é¡¹ç®æ¶æå¾:</strong></p>
<p><img alt="" loading="lazy" data-src="https://files.mdnice.com/user/48364/41829bdb-7039-4a70-b5e5-b4b83ec9ce94.png" class="lazyload"></p>
<p><strong>13. é«æ§è½HTTPæå¡å¨ FlashHTTP Â· 699å Â· 16å¤©</strong> ð <a href="https://mp.weixin.qq.com/s/GGGDwi9VlXJKBk9cXlNbtw" target="_blank" rel="noopener nofollow">ç¹å»æ¥çè¯¦æ</a></p>
<p>3600+è¡ä»£ç ï¼16å¤©ä»Reactorå°HTTPæå¡å¨ãå®æµï¼<strong>45ä¸QPSï¼P99å»¶è¿22.96msï¼æ¯æ4ä¸å¹¶åè¿æ¥</strong>ï¼åæµç»æåæå¸é¢ä¸å¤§é¨åå¼æºHTTP Serverãæ¯æGET/POST/PUT/DELETEãç¶ææºè§£æãKeep-Aliveãéææä»¶æå¡ãå¤§æä»¶ä¿æ¤â¦â¦åè¿ç®åå°±æ¯ç¡¬è´§ã</p>
<p>å·²æ¥åReactorXçè¡¥å·®ä»·400åï¼å·²æ¥åç½ç»åºçè¡¥å·®ä»·200åã</p>
<p><strong>é¡¹ç®æ¶æå¾:</strong></p>
<p><img alt="" loading="lazy" data-src="https://files.mdnice.com/user/48364/fa576712-4839-4783-9256-22ab1889d5c8.jpg" class="lazyload"></p>
<p><strong>14. é«æ§è½å¼æ­¥æ¥å¿åº ZephyrLog Â· 299å Â· 6å¤©</strong> ð <a href="https://mp.weixin.qq.com/s/BdsY05V3OXzHAcrQoGbsGA" target="_blank" rel="noopener nofollow">ç¹å»æ¥çè¯¦æ</a></p>
<p>æ§è½æ°æ®è¯´è¯ï¼åçº¿ç¨ååé<strong>1250ä¸msg/s</strong>ï¼æ¯spdlogç6åï¼æ¯g3logç17åï¼16çº¿ç¨æéå¹¶åä¸ä¾ç¶ç¨³å¨<strong>1100ä¸QPS</strong>ï¼èspdlogç´æ¥å´©çãåæ¨¡å¼è®¾è®¡ï¼é«æ§è½æ¨¡å¼/é¶ä¸¢å¤±æ¨¡å¼ï¼ï¼800è¡æ ¸å¿ä»£ç ï¼6å¤©å®æ´å®ç°ã</p>
<p><strong>é¡¹ç®æ¶æå¾:</strong></p>
<p><img alt="" loading="lazy" data-src="https://files.mdnice.com/user/48364/098ec5b3-c9ef-4c04-a5eb-499ecb16a5a4.png" class="lazyload"></p>
<p><strong>15. å¤çº¿ç¨ä¸è½½å·¥å· FastDL Â· 299å Â· 7å¤©</strong> ð <a href="https://mp.weixin.qq.com/s/_Ldit_7qWYBS2kmasGiODA" target="_blank" rel="noopener nofollow">ç¹å»æ¥çè¯¦æ</a></p>
<p>32çº¿ç¨å¹¶åï¼éåº¦æå10åä»¥ä¸ï¼çæ­£è½å®è£å°ç³»ç»ä½¿ç¨çå½ä»¤è¡ä¸è½½ç¥å¨ãHTTP/2åè®®ãå®ä½åå¥é¶ç£çå ç¨ãJSONæ­ç¹ç»­ä¼ ãä¿¡å·å¤çä¼éä¸­æ­â¦â¦2200+è¡ä»£ç ï¼7å¤©å­¦å®ä½ å°±æäºä¸ä¸ªè½è·æåç«è"æèªå·±åç"çä¸è½½å·¥å·ã</p>
<p><strong>é¡¹ç®æ¶æå¾:</strong></p>
<p><img alt="" loading="lazy" data-src="https://files.mdnice.com/user/48364/57fccdf4-0b20-4a14-958c-97d78cd7bf49.png" class="lazyload"></p>
<p><strong>16. é«æ§è½åç¨åº CoroForge Â· 399å Â· 7å¤©</strong> ð <a href="https://mp.weixin.qq.com/s/tuInQxfwqWHFQLU3tKIROA" target="_blank" rel="noopener nofollow">ç¹å»æ¥çè¯¦æ</a></p>
<p>å¾®ä¿¡libcoåæ¬¾ææ¯ï¼æ§è½å®å¨åª²ç¾ââå¨2ä¸å¹¶åä¸ååéä¸libcoå®å¨ä¸è´ï¼å®æµï¼ãä»æ±ç¼ä¸ä¸æåæ¢è®²èµ·ï¼å°å±äº«æ è®¾è®¡ï¼åå­éä½99%ï¼ãepolläºä»¶é©±å¨ãHookç³»ç»è°ç¨å®ç°éæåç¨åâ¦â¦2000è¡ä»£ç æå®libcoéè¦3000è¡æè½åå°çäºã7å¤©ï¼ä»"ä¸æåç¨"å°"è½ååç¨åº"ã</p>
<p><strong>é¡¹ç®æ¶æå¾:</strong></p>
<p><img alt="" loading="lazy" data-src="https://files.mdnice.com/user/48364/49eb50e7-2326-47a8-a306-d3290aa83923.jpg" class="lazyload"></p>
<p><strong>17. HTTPåæµå·¥å·ï¼å³å°åå¸ï¼Â· 299å</strong></p>
<p>åèå¼æºé¡¹ç®wrkå®ç°ï¼wrkæ¯æçåè½å¨é¨æ¯æï¼å¤çº¿ç¨ãLuaèæ¬ãèªå®ä¹è¯·æ±ãå»¶è¿ç»è®¡ç­ï¼ãå¦æä½ åäºç½ç»åºæHTTPæå¡å¨ï¼æä¸ä¸ªèªå·±å®ç°çåæµå·¥å·æ¯éå¸¸å åçãè¯¦æåå¸åä¼ç¬¬ä¸æ¶é´éç¥ã</p>
<p><strong>é¡¹ç®æ¶æå¾:</strong></p>
<p><img alt="" loading="lazy" data-src="https://files.mdnice.com/user/48364/194f4102-5f64-4be3-a01c-a190c7f46b25.png" class="lazyload"></p>
<p><strong>18. Redisæ ¸å¿å®æ Â· 1200åï¼æ©é¸ä»·ï¼</strong> ð <a href="https://mp.weixin.qq.com/s/qwcEFKVfeU66AghX__tW7A" target="_blank" rel="noopener nofollow">ç¹å»æ¥çè¯¦æ</a></p>
<p>è¿ä¸ªé¡¹ç®ä½éæå¤§ï¼åºäºRedis 7.xçæ¬ï¼5å¤§é¶æ®µã16ä¸ªæ ¸å¿æ¨¡åï¼ä»SDS/è·³è¡¨/åå¸è¡¨ç­åºç¡æ°æ®ç»æï¼å°äºä»¶é©±å¨ãä¸»ä»å¤å¶ãå¨åµéç¾¤ï¼ä»0å°1æåRedisæ ¸å¿æ¨¡åã</p>
<p>ç®åè¯¾ç¨å¶ä½ä¸­ï¼æ©é¸ä»·1200åï¼å¶ä½å®æ¯åæ¶¨ä»·å°2000-2500åãæ³¨æï¼Redisé¡¹ç®ä¸åå«å¨æåå¥é¤åï¼åç¬æ¥åã</p>
<h2 id="-300å­¦åè¯´ä»ä¹">ð¬ 300+å­¦åè¯´ä»ä¹</h2>
<p><strong>åæ¥çä¸é¨åå­¦åççå®åé¦åè¯ä»·ï¼</strong></p>
<p><strong>å­¦å1ï¼</strong></p>
<p><img alt="" loading="lazy" data-src="https://files.mdnice.com/user/48364/9835cb63-c6f9-43fd-bd44-b65b2bbf47df.jpg" class="lazyload"></p>
<p><strong>å­¦å2ï¼</strong></p>
<p><img alt="" loading="lazy" data-src="https://files.mdnice.com/user/48364/48492788-acf1-4d9b-9656-b2f41fce3a0e.jpg" class="lazyload"></p>
<p><strong>å­¦å3ï¼</strong></p>
<p><img alt="" loading="lazy" data-src="https://files.mdnice.com/user/48364/896a0efc-6686-4c48-abef-0c693a26cf80.jpg" class="lazyload"></p>
<p><img alt="" loading="lazy" data-src="https://files.mdnice.com/user/48364/64840911-acdd-45aa-b82a-051f23efba9b.jpg" class="lazyload"></p>
<p><strong>å­¦å4ï¼</strong></p>
<p><img alt="" loading="lazy" data-src="https://files.mdnice.com/user/48364/cd51f75e-cd94-4f4c-9697-97fa759edfc7.jpg" class="lazyload"></p>
<p><strong>å­¦å5ï¼</strong></p>
<p><img alt="" loading="lazy" data-src="https://files.mdnice.com/user/48364/655e7d79-ece3-45c5-a1ff-bb82f338a928.jpg" class="lazyload"></p>
<p><strong>å­¦å6ï¼</strong></p>
<p><img alt="" loading="lazy" data-src="https://files.mdnice.com/user/48364/eaf8afb7-00fc-47b6-a8ba-93c9faa9ce1c.jpg" class="lazyload"></p>
<p><strong>å­¦å7ï¼</strong></p>
<p><img alt="" loading="lazy" data-src="https://files.mdnice.com/user/48364/4996534d-9f22-4ee0-802e-c219ca5d9cda.jpg" class="lazyload"></p>
<p><img alt="" loading="lazy" data-src="https://files.mdnice.com/user/48364/ef86f2b2-9587-4e6c-950d-22251ae43cef.jpg" class="lazyload"></p>
<p><strong>å­¦å8ï¼</strong></p>
<p><img alt="" loading="lazy" data-src="https://files.mdnice.com/user/48364/7b77a88f-1562-48f6-8299-67630c16fe1f.jpg" class="lazyload"></p>
<p><strong>å­¦å9ï¼</strong></p>
<p><img alt="" loading="lazy" data-src="https://files.mdnice.com/user/48364/1c420436-bfda-4bd9-b302-15187e0d87dc.jpg" class="lazyload"></p>
<p><strong>å­¦å10ï¼</strong></p>
<p><img alt="" loading="lazy" data-src="https://files.mdnice.com/user/48364/677fd0ff-0085-43f1-9b8c-e0176129861f.jpg" class="lazyload"></p>
<p><img alt="" loading="lazy" data-src="https://files.mdnice.com/user/48364/41191ad0-9cb8-4093-93fd-4e05280221e9.jpg" class="lazyload"></p>
<p><strong>å­¦å11ï¼</strong></p>
<p><img alt="" loading="lazy" data-src="https://files.mdnice.com/user/48364/7393d477-e754-456c-aaf0-8c8d04b78245.jpg" class="lazyload"></p>
<p><strong>å­¦å12ï¼</strong></p>
<p><img alt="" loading="lazy" data-src="https://files.mdnice.com/user/48364/dc9cd858-b0ea-48c9-a954-0522343fa9b3.jpg" class="lazyload"></p>
<p><img alt="" loading="lazy" data-src="https://files.mdnice.com/user/48364/3317091d-306d-4ea8-903d-fb59813545c7.jpg" class="lazyload"></p>
<p><strong>å­¦å13:</strong></p>
<p><img alt="" loading="lazy" data-src="https://files.mdnice.com/user/48364/29920d05-20fe-4c2f-8825-6a3b05fe1633.jpg" class="lazyload"></p>
<h2 id="-æ¥åæ¹å¼ä¸å®ä»·">ð° æ¥åæ¹å¼ä¸å®ä»·</h2>
<h3 id="åä¸ªé¡¹ç®è´­ä¹°">åä¸ªé¡¹ç®è´­ä¹°</h3>
<table>
<thead>
<tr>
<th>é¡¹ç®</th>
<th>ä»·æ ¼</th>
</tr>
</thead>
<tbody>
<tr>
<td>çº¿ç¨æ± </td>
<td><strong>299å</strong></td>
</tr>
<tr>
<td>é«æ§è½æ¥å¿åº MiniSpdlog</td>
<td><strong>299å</strong></td>
</tr>
<tr>
<td>é«æ§è½åå­æ± </td>
<td><strong>299å</strong></td>
</tr>
<tr>
<td>å¤çº¿ç¨ä¸è½½å·¥å· FastDL</td>
<td><strong>299å</strong></td>
</tr>
<tr>
<td>MySQLè¿æ¥æ± </td>
<td><strong>299å</strong></td>
</tr>
<tr>
<td>åå­æ³æ¼æ£æµå¨ MemTracker</td>
<td><strong>299å</strong></td>
</tr>
<tr>
<td>ReactorX äºä»¶é©±å¨å¼æ</td>
<td><strong>299å</strong></td>
</tr>
<tr>
<td>æ éæ  InfiniteStack</td>
<td><strong>299å</strong></td>
</tr>
<tr>
<td>æ ééå SPSC LightningQueue</td>
<td><strong>100å</strong></td>
</tr>
<tr>
<td>æ ééå MPMC ThunderQueue</td>
<td><strong>299å</strong></td>
</tr>
<tr>
<td>å·¥ä¸çº§æºè½æé CraftedPtr</td>
<td><strong>299å</strong></td>
</tr>
<tr>
<td>é«æ§è½ç½ç»åº NetCore</td>
<td><strong>499å</strong></td>
</tr>
<tr>
<td>é«æ§è½å¼æ­¥æ¥å¿åº ZephyrLog</td>
<td><strong>299å</strong></td>
</tr>
<tr>
<td>æ­»éæ£æµå·¥å· DeadLock-Sentinel</td>
<td><strong>299å</strong></td>
</tr>
<tr>
<td>é«æ§è½åç¨åº CoroForge</td>
<td><strong>399å</strong></td>
</tr>
<tr>
<td>Redis 7.x æºç å®æï¼æ©é¸ä»·ï¼</td>
<td><strong>1200å</strong> ï¼ä¸å«å¨æåéï¼</td>
</tr>
<tr>
<td>FlashHTTP HTTPæå¡å¨</td>
<td><strong>699å</strong></td>
</tr>
<tr>
<td>HTTPåæµå·¥å·</td>
<td><strong>299å</strong>ï¼å³å°åå¸ï¼</td>
</tr>
</tbody>
</table>
<p>åä¸ªè´­ä¹°æ»è®¡çº¦ <strong>4985 å</strong>ã</p>
<h3 id="æ¥èéæ¶ç¹æ --å¨å¥æå">æ¥èéæ¶ç¹æ  Â· å¨å¥æå</h3>
<p>åä»· 4985 å â <strong>æ¥èç¹æ ä»· 4200 å</strong>  ç´æ¥çä¸è¿ <strong>800</strong> åï¼ç¸å½äº<strong>é 3 ä¸ªé¡¹ç®</strong>ã</p>
<p>å¯¹äºæ³ç³»ç»æå C++ å·¥ç¨è½åãå¤æé¢è¯çä½ ï¼è¿å¯è½æ¯ä»å¹´æåç®çä¸ç¬æèµã</p>
<p>â°<strong>æ´»å¨æ¶é´</strong>ï¼<strong>å³æ¥èµ·è³å¤§å¹´åä¸ï¼2æ23æ¥ï¼</strong>ï¼è¿åæ¢å¤åä»·ã</p>
<p><strong>PSï¼</strong> å¦æææ¶åªæ³ä»æå ä¸ªæ¹åå¥æï¼<strong>è´­ä¹°é¨åè¯¾ç¨ä¹æä¼æ </strong>ï¼å·ä½å¯ä»¥ç§èæï¼ä¼æ ¹æ®ä½ çæåµç»åºæåéçæ¹æ¡ã</p>
<h3 id="-redis-7x-æºç å®æåç¬å®ä»·">ð Redis 7.x æºç å®æï¼åç¬å®ä»·ï¼</h3>
<p>è¿é¨è¯¾ä½éç¬ç«ãåå®¹åºå¤§ï¼å5é¶æ®µ16æ¨¡åï¼ä¸å¶ä»é¡¹ç®è¯¾å®ä»·é»è¾ä¸åï¼ä¸å«å¨æåä»·åã<a href="https://mp.weixin.qq.com/s/qwcEFKVfeU66AghX__tW7A" target="_blank" rel="noopener nofollow">ç¹å»æ¥çé¡¹ç®è¯¦æ</a></p>
<p>æ©é¸ä»·ï¼<strong>1200å</strong>ï¼è¯¾ç¨å¶ä½å®æåæ¶¨è³2000å-2500åï¼åæ¥åå¾ï¼</p>
<h2 id="-å¦ä½æ¥å">ð¤ å¦ä½æ¥åï¼</h2>
<ol>
<li>æ«æä¸æ¹äºç»´ç æ·»å æçå¾®ä¿¡ï¼æç´æ¥æç´¢ï¼<strong>jkfwdkf</strong></li>
<li>å¤æ³¨ã <strong>é¡¹ç®å®æ</strong> ã</li>
<li>ç¡®è®¤å <strong>å¾®ä¿¡/æ¯ä»å®</strong> ä»æ¬¾</li>
<li>å½å¤©å å¥ä¸å±å­¦ä¹ ç¾¤ï¼è·åå¨é¨èµæ</li>
</ol>
<p><strong>æèæ«ç å æå¾®ä¿¡</strong>:</p>
<p><img alt="" loading="lazy" data-src="https://files.mdnice.com/user/48364/a20050a8-4dbc-4774-902c-e72e3ba7606e.png" class="lazyload"></p>
<h2 id="æåè¯´å å¥çå¿è¯">æåè¯´å å¥çå¿è¯</h2>
<p>æåè¿äºé¡¹ç®è¯¾ç¨ï¼æä¸ªä¸åçååï¼<strong>ææä»£ç é½æ¯ææ¬äººä»é¶è®¾è®¡å®ç°çï¼ä¸ä»å¼æºé¡¹ç®æ¹é ï¼ä¸æ¼åï¼ä¸æ°´ã</strong></p>
<p>å ä¸ºæç¥éï¼ä¸ä¸ªçæ­£è½è®©å­¦ååççé¡¹ç®ï¼å¿é¡»è®©ä»ä»¬çè§£æ¯ä¸ä¸ªè®¾è®¡å³ç­èåçåå ââä¸åªæ¯"ä»£ç æ¯ä»ä¹"ï¼èæ¯"ä¸ºä»ä¹è¿ä¹å"ã</p>
<p>è¿ä¸å¹´å¤ï¼300å¤ä½åå­¦è·çæåäºè¿äºé¡¹ç®ãæäººé å®æ¿äºå¿ä»ªçOfferï¼æäººé å®å¨å¢ééèµ¢å¾äºè®¤å¯ï¼æäººåªæ¯çº¯ç²¹äº«å"èªå·±é åºæ¥äº"çæå°±æã</p>
<p>ä¸ç®¡ä½ çåºåç¹æ¯ä»ä¹ï¼åªè¦ä½ ççæ³æC++å­¦æå®ï¼æ³æ¥æé£ç§"æè½ä»0ååºæ¥"çåºæ°ââ é£å°±èµ¶ç´§æ¥ï¼æä»¬ä¸èµ·åã</p>
<p><strong>å¾®ä¿¡ï¼jkfwdkfï¼å¤æ³¨ ãé¡¹ç®å®æã</strong></p>
<p>æå¾ä½ çå å¥ ðª</p>


</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.0006944444444444445" data-date-updated="2026-02-11 21:06">2026-02-11 21:05</span>&nbsp;
<a href="https://www.cnblogs.com/xiaokang-coding">æ±å°åº·</a>&nbsp;
éè¯»(<span id="post_view_count">0</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19605989);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19605989', targetLink: 'https://www.cnblogs.com/xiaokang-coding/p/19605989', title: 'ä¸ºä»ä¹åæ ·æ¯&amp;quot;å­¦è¿C++&amp;quot;ï¼æäººé¢è¯ç¢¾åï¼æäººå¼å£å°±æï¼å·®è·å¨è¿18ä¸ªC++ç¡¬æ ¸é¡¹ç®' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ ç®åçå¹²æPPLçæ¹æ³ ]]></title>
    <link>https://www.cnblogs.com/PaperPlaneFly/p/19605893</link>
    <guid>89ce4f86f42906d4229df543dfd52bf0</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/PaperPlaneFly/p/19605893" title="åå¸äº 2026-02-11 20:36">
    <span role="heading" aria-level="2">ç®åçå¹²æPPLçæ¹æ³</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                    <div id="cnblogs_post_description" style="display: none">
        
        Windows Protected Process Light (PPL) æ¯ä¸é¡¹åæ ¸å¼ºå¶æ§è¡çå®å¨åè½ï¼æ¨å¨é²æ­¢æªç»ææè®¿é®åæçºµææç³»ç»è¿ç¨ï¼ä¾å¦ LSASSãåæ¶æè½¯ä»¶æå¡åå¶ä»å³é®ç»ä»¶ãé£ä¹å¾æ¾ç¶å¹²æPPLè¿ä»¶äºå¾å¨Driverå±å¹²
    </div>
<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h1 id="ç®åçå¹²æpplçæ¹æ³">ç®åçå¹²æPPLçæ¹æ³</h1>
<h2 id="åç">åç</h2>
<p>Windows Protected Process Light (PPL) æ¯ä¸é¡¹åæ ¸å¼ºå¶æ§è¡çå®å¨åè½ï¼æ¨å¨é²æ­¢æªç»ææè®¿é®åæçºµææç³»ç»è¿ç¨ï¼ä¾å¦ LSASSãåæ¶æè½¯ä»¶æå¡åå¶ä»å³é®ç»ä»¶ã</p>
<p>é£ä¹å¾æ¾ç¶å¹²æPPLè¿ä»¶äºå¾å¨Driverå±å¹²</p>
<p>æè·¯å¾ç®åï¼å°±æ¯ç¨æ·ç©ºé´ç¨åºåé©±å¨ç¨åºåéè¿ç¨ ID ï¼é©±å¨ç¨åºæ¾å°è¯¥è¿ç¨çåé¨åæ ¸ç»æï¼ <code>EPROCESS</code> ï¼ï¼ç¶åå¨ <code>EPROCESS</code> ä¸­æ¥æ¾ <strong>PS_PROTECTION</strong> å­æ®µï¼æåé©±å¨ç¨åºå°ä¿æ¤çº§å«è®¾ç½®ä¸º <strong>0</strong> ã</p>
<p><code>PS_PROTECTION</code>å¯ä»¥éè¿windbgæ¥çå¶åé¨æ¯æä¹å®ä¹çï¼éååºæ¥å°±æ¯</p>
<pre><code class="language-c">typedef struct _PS_PROTECTION {
    union {
        UCHAR Level;
        struct {
            UCHAR Type : 3;
            UCHAR Audit : 1;
            UCHAR Signer : 4;
        } Flags;
    } u;
} PS_PROTECTION;

</code></pre>
<p>ç¶åæ¿åºå®çåç§»é</p>
<pre><code class="language-c">PS_PROTECTION* protection =
    (PS_PROTECTION*)((UCHAR*)Process + 0x5fa);
</code></pre>
<p>è¿ä¸ª<code>0x5fa</code>æ¯åæ¥çå¢ï¼å½ç¶ä¹æ¯windbgç</p>
<p><img src="https://img2024.cnblogs.com/blog/3540252/202602/3540252-20260211203639080-1789561322.png" alt="image" loading="lazy"></p>
<p>éè¦æ³¨æçæ¯ï¼å¾®è½¯å®æ¹å¹¶æªç»åºå·ä½ <code>EPROCESS</code> çå®ä¹ï¼æ­¤åç§»éåå³äº Windows çæ¬ï¼å æ­¤å¾é¾ä¸ä¿è¯å¨ææ¬¡æ´æ°åå¶åç§»éå°±æ¹åäºï¼</p>
<pre><code class="language-c">DbgPrint("Old Level: %02x\n", protection-&gt;u.Level);
protection-&gt;u.Level = 0;
</code></pre>
<p>ç¶åæ¸é¶å°±å¯ä»¥äºã</p>
<h2 id="éªè¯">éªè¯</h2>
<p>é¦åå è½½é©±å¨ï¼ä½ éè¦ææµè¯ç¯å¢æè½å è½½æ ç­¾åé©±å¨ï¼</p>
<p><img src="https://img2024.cnblogs.com/blog/3540252/202602/3540252-20260211203455938-695518548.png" alt="image" loading="lazy"></p>
<p><img src="https://img2024.cnblogs.com/blog/3540252/202602/3540252-20260211203506511-835022939.png" alt="image" loading="lazy"></p>
<p>ç¶åæ¿<code>MsMpEng.exe</code>å¼åï¼æ´æ¹åï¼</p>
<p><img src="https://img2024.cnblogs.com/blog/3540252/202602/3540252-20260211203530101-2137232901.png" alt="image" loading="lazy"></p>
<p>å¯å¨ç¨æ·æexe</p>
<p><img src="https://img2024.cnblogs.com/blog/3540252/202602/3540252-20260211203606743-546561996.png" alt="image" loading="lazy"></p>
<p>åæ¥æ´æ¹åç</p>
<p><img src="https://img2024.cnblogs.com/blog/3540252/202602/3540252-20260211203616508-604517146.png" alt="image" loading="lazy"></p>
<p>å¯ä»¥çå°<code>Level</code>å·²ç»åæ0äº</p>
<h2 id="é©±å¨å±ä»£ç ">é©±å¨å±ä»£ç </h2>
<pre><code class="language-c">#include &lt;ntifs.h&gt;
#include &lt;ntddk.h&gt;


#define IOCTL_CLEAR_PROTECTION CTL_CODE(FILE_DEVICE_UNKNOWN, 0x800, METHOD_BUFFERED, FILE_ANY_ACCESS)


typedef struct _PS_PROTECTION
{
    union
    {
        UCHAR Level;
        struct
        {
            UCHAR Type : 3;
            UCHAR Audit : 1;
            UCHAR Signer : 4;
        } Flags;
    } u;
} PS_PROTECTION, * PPS_PROTECTION;

DRIVER_INITIALIZE DriverEntry;
DRIVER_UNLOAD UnloadDriver;
DRIVER_DISPATCH IrpCreateHandler;
DRIVER_DISPATCH DriverDeviceControl;

NTSTATUS IrpCreateHandler(PDEVICE_OBJECT DeviceObject, PIRP Irp) {
    UNREFERENCED_PARAMETER(DeviceObject);
    Irp-&gt;IoStatus.Status = STATUS_SUCCESS;
    Irp-&gt;IoStatus.Information = 0;
    IoCompleteRequest(Irp, IO_NO_INCREMENT);
    return STATUS_SUCCESS;
}

VOID UnloadDriver(PDRIVER_OBJECT DriverObject) {
    UNICODE_STRING dos;
    RtlInitUnicodeString(&amp;dos, L"\\DosDevices\\QuitPPLs"); 
    IoDeleteSymbolicLink(&amp;dos);
    IoDeleteDevice(DriverObject-&gt;DeviceObject);
    DbgPrint("Driver Unloaded\n");
}

NTSTATUS DriverDeviceControl(PDEVICE_OBJECT DeviceObject, PIRP Irp) {
    UNREFERENCED_PARAMETER(DeviceObject);
    PIO_STACK_LOCATION stack = IoGetCurrentIrpStackLocation(Irp);
    NTSTATUS status = STATUS_SUCCESS;
    ULONG ProcessId = 0;
    PEPROCESS Process;

    switch (stack-&gt;Parameters.DeviceIoControl.IoControlCode) {
    case IOCTL_CLEAR_PROTECTION:
        if (stack-&gt;Parameters.DeviceIoControl.InputBufferLength &lt; sizeof(ULONG)) {
            status = STATUS_BUFFER_TOO_SMALL;
            break;
        }

        ProcessId = *(ULONG*)Irp-&gt;AssociatedIrp.SystemBuffer;
        DbgPrint("Request to clear protection for PID: %d\n", ProcessId);

        status = PsLookupProcessByProcessId((HANDLE)(ULONG_PTR)ProcessId, &amp;Process);
        if (NT_SUCCESS(status)) {
            PS_PROTECTION* protection = (PS_PROTECTION*)((UCHAR*)Process + 0x5fa);
            DbgPrint("Old Level: %02x\n", protection-&gt;u.Level);
            protection-&gt;u.Level = 0;
            ObDereferenceObject(Process);
        }
        break;
    default:
        status = STATUS_INVALID_DEVICE_REQUEST;
        break;
    }

    Irp-&gt;IoStatus.Status = status;
    Irp-&gt;IoStatus.Information = 0;
    IoCompleteRequest(Irp, IO_NO_INCREMENT);
    return status;
}

NTSTATUS DriverEntry(PDRIVER_OBJECT DriverObject, PUNICODE_STRING RegistryPath) {
    UNREFERENCED_PARAMETER(RegistryPath);

    UNICODE_STRING dev, dos;
    RtlInitUnicodeString(&amp;dev, L"\\Device\\QuitPPLs");
    RtlInitUnicodeString(&amp;dos, L"\\DosDevices\\QuitPPLs");

    PDEVICE_OBJECT DeviceObject;
    NTSTATUS status = IoCreateDevice(DriverObject, 0, &amp;dev, FILE_DEVICE_UNKNOWN, FILE_DEVICE_SECURE_OPEN, FALSE, &amp;DeviceObject);

    if (!NT_SUCCESS(status)) return status;

    status = IoCreateSymbolicLink(&amp;dos, &amp;dev);
    if (!NT_SUCCESS(status)) {
        IoDeleteDevice(DeviceObject);
        return status;
    }

    DriverObject-&gt;DriverUnload = UnloadDriver;
    DriverObject-&gt;MajorFunction[IRP_MJ_DEVICE_CONTROL] = DriverDeviceControl;
    DriverObject-&gt;MajorFunction[IRP_MJ_CREATE] = IrpCreateHandler;

    return STATUS_SUCCESS;
}
</code></pre>


</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-02-11 20:37">2026-02-11 20:36</span>&nbsp;
<a href="https://www.cnblogs.com/PaperPlaneFly">çº¸é£æºä½ç©ºé£è¡</a>&nbsp;
éè¯»(<span id="post_view_count">0</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19605893);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19605893', targetLink: 'https://www.cnblogs.com/PaperPlaneFly/p/19605893', title: 'ç®åçå¹²æPPLçæ¹æ³' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ ä»é¶å¼å§å®ç°ä¸ä¸ªç®æjsonè§£æå¨ ]]></title>
    <link>https://www.cnblogs.com/xiaoxiongcanguan/p/19605794</link>
    <guid>1c2b2fb8de37c6f0d9bb583e9f32f4a0</guid>
    <description>
    <![CDATA[ 
	<h1 class="postTitle"><a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/xiaoxiongcanguan/p/19605794" title="åå¸äº 2026-02-11 20:23">
    <span role="heading" aria-level="2">ä»é¶å¼å§å®ç°ä¸ä¸ªç®æjsonè§£æå¨</span>
    

</a>
</h1>
	<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h1 id="ä»é¶å¼å§å®ç°ä¸ä¸ªç®æjsonè§£æå¨">ä»é¶å¼å§å®ç°ä¸ä¸ªç®æjsonè§£æå¨</h1>
<h2 id="1-mysimplejsonparser-ä»ç»ä¸æ´ä½è®¾è®¡">1. MySimpleJsonParser ä»ç»ä¸æ´ä½è®¾è®¡</h2>
<p>æè¿å¨å­¦ä¹ ç¼è¯åçç¸å³çç¥è¯ãä¸ºäºå æ·±å¯¹è¯æ³åæãè¯­æ³åæé¶æ®µä¸­è¯¸å¦<strong>æéèªå¨æºãèªé¡¶åä¸è¯­æ³åæãAST</strong> ç­æ¦å¿µççè§£ï¼æéæ©å®ç°ä¸ä¸ªjsonè§£æå¨ä½ä¸ºç»ææºä¼ã</p>
<h5 id="_"></h5>
<p>ç¸æ¯ç´æ¥å®ç°ä¸é¨å®æ´çç¼ç¨è¯­è¨ï¼å°jsonè§£æä½ä¸ºç»æå¯¹è±¡æå ä¸ªææ¾ä¼å¿ï¼</p>
<ol>
<li><strong>å ä¹é¶é¢å¤å­¦ä¹ ææ¬</strong>ï¼jsonä½ä¸ºä¸ç§è½»éçº§çæ°æ®äº¤æ¢æ ¼å¼æ¯æ¥å¸¸å¼åä¸­ä½¿ç¨æé¢ç¹çæ°æ®æ ¼å¼ä¹ä¸ã</li>
<li><strong>ææ³è¶³å¤ç®å</strong>ï¼å¯¹äºç¼è¯åçå¥é¨èæ¥è¯´ï¼è¥éæ©çè¯­è¨å¤ªå¤æï¼å¾å®¹æå¨è¯æ³/è¯­æ³è§åä¸è¢«åéï¼èjsonçè¯æ³åè¯­æ³æ¯è¾è§æ´ï¼è¯­æ³åææ¶éå¸¸åªéæ ¹æ®ä¸ä¸ä¸ªtokenå³å¯å³å®ASTçæé æ¹åã</li>
<li><strong>æ éè¿è¡æ¶</strong>ï¼jsonä¸æ¯ç¼ç¨è¯­è¨ï¼å¶å®å¨ä¸éè¦åç«¯çè¿è¡æ¶ãåªè¦è½æjsonææ¬è½¬æ¢ææ­£ç¡®çASTå°±å·²ç»ç®å®æä»»å¡ï¼å¨æ­¤åºç¡ä¸å®ç°ä¸ä¸ªåºäºASTçPretty JSONè¾åºï¼å°±è½äº§çä¸å®çæå°±æã</li>
</ol>
<h5 id="_-1"></h5>
<p>å¨æ¬ç¯åå®¢ä¸­ï¼æä»¬å°åºäº<strong>javaè¯­è¨</strong>ï¼ä¸ä¾èµä»»ä½ç¬¬ä¸æ¹åºï¼ä»é¶å¼å§å®ç°ä¸ä¸ªç®åçjsonè§£æå¨ï¼<strong>MySimpleJsonParser</strong>ãå¶åæ¬ä»¥ä¸å ä¸ªä¸»è¦æ¨¡åï¼</p>
<ol>
<li><strong><code>StaticJsonLexer</code></strong>ï¼ä¸æ¬¡æ§è§£æåºå¨é¨tokençéæjsonè¯æ³åæå¨</li>
<li><strong><code>StreamJsonLexer</code></strong>ï¼æéæ°æ§è§£ætokençæµå¼jsonè¯æ³åæå¨</li>
<li><strong><code>RecursiveJsonParser</code></strong>ï¼åºäºéå½çjsonè¯­æ³è§£æå¨</li>
<li><strong><code>StackBaseJsonParser</code></strong>ï¼åºäºæ¾å¼å æ çjsonè¯­æ³è§£æå¨ï¼ééå½ï¼</li>
<li><strong><code>ASTç»æ</code></strong>ï¼JsonElementåå¶å­ç±»ï¼å¹¶åºäºASTçæPretty JSONå­ç¬¦ä¸²çå·¥å·æ¹æ³</li>
</ol>
<h2 id="2-ä»ææ³å°è¯æ³åæå¨æå-json-lexer">2. ä»ææ³å°è¯æ³åæå¨ï¼æå json lexer</h2>
<p>è¯æ³åæé¶æ®µçä»»å¡æ¯ï¼å°åå§çå­ç¬¦æµï¼æç§jsonçè¯æ³è§åï¼è½¬æ¢ä¸ºtokenæµãä¹åçè¯­æ³åæä¼å¨tokenæµçåºç¡ä¸æææ³è§åæå»ºASTã</p>
<h3 id="21-jsonææ³ä¸åºæ¬ç»æ">2.1 jsonææ³ä¸åºæ¬ç»æ</h3>
<p>æ ¹æ®<a href="https://www.json.org/json-en.html" target="_blank" rel="noopener nofollow"><strong>jsonå®æ¹ææ¡£</strong></a>ï¼jsonä¸­ä¸»è¦åå«ä»¥ä¸å ç±»ç»æï¼</p>
<ol>
<li><strong>string</strong>ï¼ç±åå¼å·åä½çUnicodeå­ç¬¦ä¸²ï¼å¯åå«è½¬ä¹å­ç¬¦ãä¸ä¸ªå­ç¬¦ï¼characterï¼ä¹å¯ä»¥æ¯ä¸ä¸ªåç¬çå­ç¬¦ä¸²ï¼character stringï¼ã</li>
<li><strong>number</strong>ï¼ä»¥<code>0</code>æ<code>-</code>å¼å¤´ï¼å¯ä»¥æ¯æ´æ°ãå°æ°ããè´æ°æèæ¯åå«ä¸ä¸ªE/eç¬¦å·çææ°ã</li>
<li><strong>object</strong>ï¼ä»¥â<code>{</code>â å¼å¤´ï¼ä»¥â<code>}</code>âç»å°¾ã</li>
<li><strong>array</strong>ï¼ä»¥â<code>[</code>â å¼å¤´ï¼ä»¥â<code>]</code>âç»å°¾ã</li>
<li><strong>value</strong>ï¼å¯ä»¥æ¯stringãnumberã<code>true</code>(å³é®å­)ã<code>false</code>(å³é®å­)ã<code>null</code>(å³é®å­)ãobjectæèarrayã</li>
<li><strong>whitespace</strong>ï¼ç±ä»»æä¸ªspaceç©ºæ ¼ãlinefeedæ¢è¡ç¬¦ãcarriage returnåè½¦ç¬¦ä»¥åtabå¶è¡¨ç¬¦ç»æï¼æ¬èº«æ æä¹ï¼ä»èµ·å°åå²çä½ç¨ã</li>
</ol>
<h5 id="_-2"></h5>
<ul>
<li>ä»ç»åæåï¼åç°stringç»æãnumberç»æåwhitespaceç»æä»¥å<code>{</code>ã<code>}</code>ã<code>[</code>ã<code>]</code> è¿ç±»ç¬¦å·é½æ¯åºæ¬ç»æï¼æ¯èªèº«æ æ³ååµå¥å¶å®ç»æçåºæ¬ååï¼å æ­¤å¶é½æ¯æç»ASTä¸­çå¶å­èç¹ï¼èobjectãarrayåvalueé½æ¯å¯ä»¥äºç¸åµå¥çå¤åç»æï¼å¶é½æ¯ASTä¸­çéå¶å­èç¹ã</li>
<li>å¯¹äºè¿äºå¯åµå¥çéASTå¶å­èç¹ï¼å¿é¡»å¨è¯­æ³åæä¸­æè½å®æè§£æï¼èstringç»æãnumberç»æãfalseãtrueãnullå³é®å­ä»¥åâ{âãâ]âç­ç¹æ®ç¬¦å·ï¼åéåå¨è¯æ³åæä¸­å®æè§£æã<br>
å ä¸ºjsonè¯­æ³ä¸­ï¼æ è®ºåå§çjsonå­ç¬¦ä¸²ä¸­ä¸ä¸ªnumberå­é¢éæå¤å¤æ(æ¯å¦-2.03214e+6605218)ï¼å¨è¯­æ³åæä¸­é½åªéè¦å½åä¸ä¸ªå®æ´çnumberç±»åçtokenæ¥å¤çå³å¯ã</li>
<li>è¯æ³åæä¸æ³¨äºå±é¨ï¼å°åå§çå­ç¬¦æµæç§è¯æ³è§åæ­£ç¡®çè½¬æ¢ä¸ºtokenæµï¼èè¯­æ³åæåä¸æ³¨äºå°tokenæµæç§è¯­æ³è§åè½¬æ¢ä¸ºæ­£ç¡®çASTæ ç»æã<br>
éè¿å°æ´ä¸ªåææµç¨ï¼ææºçåè§£ä¸ºè¯æ³åæåè¯­æ³åæç­ç­ä¸åæ­¥éª¤ï¼æ¯ä¸ªæ­¥éª¤é½ä¾èµäºåä¸ä¸ªæ­¥éª¤çäº§åºçåå±è®¾è®¡ï¼è½å¤å¾å¥½çæ§å¶è§£æå¨æ´ä½çå¤æåº¦ï¼æ¹ä¾¿è°è¯çåæ¶æ§è½ä¸ä¹æå¾å¤§çæåã<br>
å æ­¤ï¼é¤äºå°æ°éå¸¸ç®åçè¯­è¨å¤ï¼å ä¹ææçç¼è¯å¨é½ä¼éç¨åå±çæ¶ææ¥å®ç°æ´ä½çåè½ã</li>
</ul>
<h3 id="22-tokenç±»åå®ä¹">2.2 tokenç±»åå®ä¹</h3>
<p>ä»ææ³è§åº¦ï¼jsonä¸­åè®¸çtokenç±»åå¤§è´å¯åä¸ºä¸ç±»ï¼</p>
<ol>
<li>ç¹æ®ç¬¦å·ï¼è¯¸å¦â<code>{</code>âãâ<code>}</code>âãâ<code>[</code>âãâ<code>]</code>âãâ<code>,</code>â,â<code>:</code>â,â<code>"</code>âç­ç¬ç«çå­ç¬¦æ¯jsonä¸­çç¹æ®ç¬¦å·</li>
<li>å³é®å­ï¼å®æ´ä¸ç¬ç«ç<code>true</code>ã<code>false</code>ã<code>null</code>è¢«è§ä¸ºå³é®å­</li>
<li>å­é¢éï¼numberãstringè¿ä¸¤ç§å¤æå­ç¬¦æµå­é¢é</li>
</ol>
<h5 id="_-3"></h5>
<p>å æ­¤æä»¬å¯ä»¥åå®ä¹åºjsonçtokenç±»åæä¸¾ãå¶ä¸­EOFç±»åæ¯é¢å¤çï¼ç¨äºå¨å®ææ´ä¸ªå­ç¬¦æµçè¯æ³åæåï¼è¿½å å°tokenæµçæåï¼æ å¿çtokenæµçç»æã</p>
<pre><code class="language-java">public enum JsonTokenTypeEnum {
    LEFT_BRACE("{"),
    RIGHT_BRACE("}"),

    LEFT_BRACKET("["),
    RIGHT_BRACKET("]"),

    COMMA(","),
    COLON(":"),

    TRUE("true"),
    FALSE("false"),
    NULL("null"),

    STRING("string"),
    NUMBER("number"),

    EOF("EOF"),
    ;
    private final String key;

    JsonTokenTypeEnum(String key) {
        this.key = key;
    }

    public String getKey() {
        return key;
    }
}
</code></pre>
<h3 id="23-è¯æ³åæå¨æ´ä½æ¡æ¶ä¸ç¹æ®å­ç¬¦çè¯æ³åæ">2.3 è¯æ³åæå¨æ´ä½æ¡æ¶ä¸ç¹æ®å­ç¬¦çè¯æ³åæ</h3>
<p>ç°å¨æä»¬å·²ç»ç¥éè¯¸å¦â{âãâ]âç­ç¬ç«å­ç¬¦æ¯jsonä¸­çç¹æ®ç¬¦å·ï¼ä½æ¯å½æä»¬å¨å­ç¬¦æµä¸­éå°äºä¸ä¸ªâ{âå­ç¬¦æ¶ï¼å¹¶ä¸è½æ èçå°å¶ä½ä¸ºä¸ä¸ªLEFT_BRACEç±»åçtokenæ¥å¤çãå ä¸ºå¦æå¶æ¯è¢«åå¼å·åè£¹çï¼ä½ä¸ºstringç±»åtokenåå®¹çä¸é¨åï¼é£ä¹å°±å¹¶ä¸è½å°å¶ç´æ¥å½åç¬ç«çtokenæ¥å¯¹å¾ã<br>
æä»¥ï¼è¯æ³åæä¸­ä¸è¬ä½¿ç¨æéç¶æèªå¨æºæ¥è§£å³æ­¤ç±»âåä¸å­ç¬¦å¨ä¸åä¸ä¸æå«ä¹ä¸åâçé®é¢ï¼å¨å¤æ­å¦ä½å¤çå­ç¬¦æµæ¶å¹¶ä¸ä»ä»åå³äºä¸ä¸ä¸ªå­ç¬¦æ¯ä»ä¹ï¼èè¿è¦ç»åå½åèªå¨æºçç¶ææ¥å³å®è¡ä¸ºã<br>
ä»¥ä¸è¿°å¯¹â{âå­ç¬¦çå¤çä¸ºä¾ï¼å¦ææ¯å¨åå§åç¶æä¸(å·²ç»å®æäºä¸ä¸ªå®æ´tokençè§£æ,åå¤å¼å§è§£æä¸ä¸ä¸ªæ°token)ï¼ç¢°å°â{âå­ç¬¦æ¶å¯ä»¥ç¡®å®çå°å¶è½¬åä¸ºLEFT_BRACEç±»åçtokenï¼ä½æ¯å½èªå¨æºå¤äºstringç±»åtokençè§£æç¶ææ¶ï¼åéè¦å°å¶ä½ä¸ºstringç±»åtokenåå®¹çä¸é¨åã</p>
<h5 id="jsonè¯æ³åæèªå¨æºæ»è§å¾">jsonè¯æ³åæèªå¨æºæ»è§å¾</h5>
<p>åºäºå®æ¹ææ¡£ä¸­çjsonææ³è§åï¼æä»¬å¯ä»¥è®¾è®¡åºä¸ä¸ªå¦ä¸å¾æç¤ºçjsonæéç¶æèªå¨æºæ¥å®ç°æä»¬çè¯æ³åæã<br>
<img src="https://img2024.cnblogs.com/blog/1506329/202602/1506329-20260211195126490-433213565.png" alt="lexer_total" loading="lazy"></p>
<h5 id="_-4"></h5>
<ul>
<li>å¨jsonè§£æä¸å¼å§ï¼èªå¨æºä½äºç¶æ0ï¼éåä¾¿ä¼åºäºå­ç¬¦æµçä¸ä¸ä¸ªå­ç¬¦çç±»åè¿è¡ç¶æè½¬æ¢ï¼å¨è¯»åå°è¯¸å¦â{âãâ[âãâ,âç­ç¬ç«ç¬¦å·æ¶ï¼ä¾¿ä¼ç´æ¥æ¥æ¶è¯¥å­ç¬¦ï¼æ¨è¿å­ç¬¦æµï¼åæ¶çæå¯¹åºç±»åçtokenã</li>
<li>å¨å®æ´çè§£æåºä¸ä¸ªå®æ´tokenåï¼èªå¨æºä¾¿ä¼éæ°åå°ç¶æ0ï¼åå¤å°è¯è§£æä¸ä¸ä¸ªæ°çtokenãç¶æ0åªè½åæ³çæ¥æ¶æéç§ç±»çå­ç¬¦ï¼å¯¹äºä¸ç¬¦åjsonææ³çå­ç¬¦å°è®¤ä¸ºå½åå­ç¬¦æµä¸æ¯åæ³çjsonå­ç¬¦ä¸²èç´æ¥æ¥éï¼éåºè§£æã</li>
<li>å¯¹äºæ´å¤æçstringç±»åãnumberç±»åtokençè§£æï¼æä»¬æ¾å¨åé¢çå°èåå±å¼ï¼æ»è§å¾ä¸­ææ¶çç¥ã</li>
</ul>
<h5 id="éæçè¯æ³åæå¨å®ç°">éæçè¯æ³åæå¨å®ç°</h5>
<pre><code class="language-java">public class StaticJsonLexer extends AbstractJsonLexer{

    public StaticJsonLexer(String jsonString) {
        super(jsonString);
    }

    /**
     * ä¸æ¬¡å®æ´çæ«æï¼éæµå¼çå¤ç
     * */
    public List&lt;JsonToken&gt; doLex(){
        char[] chars = super.jsonStringArray;

        // ç¸å½äºæ¯ç¶æ0
        while(doLexContext.currentIndex &lt; chars.length){
            char ch = chars[doLexContext.currentIndex];

            switch(ch){
                case '{':
                    doLexContext.tokenCollector.add(new JsonToken(JsonTokenTypeEnum.LEFT_BRACE));
                    doLexContext.currentIndex++;
                    break;
                case '}':
                    doLexContext.tokenCollector.add(new JsonToken(JsonTokenTypeEnum.RIGHT_BRACE));
                    doLexContext.currentIndex++;
                    break;
                case '[':
                    doLexContext.tokenCollector.add(new JsonToken(JsonTokenTypeEnum.LEFT_BRACKET));
                    doLexContext.currentIndex++;
                    break;
                case ']':
                    doLexContext.tokenCollector.add(new JsonToken(JsonTokenTypeEnum.RIGHT_BRACKET));
                    doLexContext.currentIndex++;
                    break;
                case ',':
                    doLexContext.tokenCollector.add(new JsonToken(JsonTokenTypeEnum.COMMA));
                    doLexContext.currentIndex++;
                    break;
                case ':':
                    doLexContext.tokenCollector.add(new JsonToken(JsonTokenTypeEnum.COLON));
                    doLexContext.currentIndex++;
                    break;
                case '"':
                    doLexContext.tokenCollector.add(parseString(chars, doLexContext));
                    break;
                case 't':
                    // å°è¯è§£ætrueå³é®å­
                    doLexContext.tokenCollector.add(parseTrueKeyword(chars, doLexContext));
                    break;
                case 'f':
                    // å°è¯è§£æfalseå³é®å­
                    doLexContext.tokenCollector.add(parseFalseKeyword(chars, doLexContext));
                    break;
                case 'n':
                    // å°è¯è§£ænullå³é®å­
                    doLexContext.tokenCollector.add(parseNullKeyword(chars, doLexContext));
                    break;
                default:
                    // å¶å®case
                    if(ch == '-' || CommonStringUtil.is0_9(ch)){
                        // numberè§£æ
                        JsonToken numberToken = parseNumber(chars, doLexContext);
                        doLexContext.tokenCollector.add(numberToken);
                        break;
                    }else if(CommonStringUtil.isWhitespace(ch)){
                        // whiteSpace ç´æ¥è·³è¿
                        doLexContext.currentIndex++;
                        break;
                    }else{
                        throw new MuJsonParserException("unexpected character: " + ch + " at index " + doLexContext.currentIndex);
                    }
            }
        }

        // æåå ä¸EOF
        doLexContext.tokenCollector.add(new JsonToken(JsonTokenTypeEnum.EOF));
        return doLexContext.tokenCollector;
    }
}
</code></pre>
<p>æ½è±¡ç¶ç±»<code>AbstractJsonLexer</code>å°è£äºstring/number/keywordç­å·ä½ç±»åçå¬å±è§£æé»è¾ï¼</p>
<pre><code class="language-java">public abstract class AbstractJsonLexer {

    protected final char[] jsonStringArray;

    protected final DoLexContext doLexContext;

    public AbstractJsonLexer(String jsonString) {
        this.jsonStringArray = jsonString.toCharArray();
        this.doLexContext = new DoLexContext();
    }

    protected JsonToken parseNumber(char[] chars, DoLexContext doLexContext){
        // numberç±»åçåå®¹
        String numberStr = new NumberLexStatemachine().tryParse(chars,doLexContext);

        return new JsonToken(JsonTokenTypeEnum.NUMBER, numberStr);
    }

    protected JsonToken parseString(char[] chars, DoLexContext doLexContext){
        // stringç±»åçåå®¹
        String stringStr = new StringLexStatemachine().tryParse(chars,doLexContext);

        return new JsonToken(JsonTokenTypeEnum.STRING, stringStr);
    }

    protected JsonToken parseTrueKeyword(char[] chars, DoLexContext doLexContext){
        // trueå³é®å­
        String stringStr = new KeywordTrueLexStatementMachine().tryParse(chars,doLexContext);

        return new JsonToken(JsonTokenTypeEnum.TRUE, stringStr);
    }

    protected JsonToken parseFalseKeyword(char[] chars, DoLexContext doLexContext){
        // falseå³é®å­
        String stringStr = new KeywordFalseLexStatementMachine().tryParse(chars,doLexContext);

        return new JsonToken(JsonTokenTypeEnum.FALSE, stringStr);
    }

    protected JsonToken parseNullKeyword(char[] chars, DoLexContext doLexContext){
        // nullå³é®å­
        String stringStr = new KeywordNullLexStatementMachine().tryParse(chars,doLexContext);

        return new JsonToken(JsonTokenTypeEnum.NULL, stringStr);
    }
}
</code></pre>
<h5 id="_-5"></h5>
<ul>
<li>ä¸ºäºæ¯æåç»­æµå¼çè¯æ³åæå¨ï¼éæçè¯æ³åæå¨StaticJsonLexerç»§æ¿èªAbstractJsonLexerç±»ï¼æé æ¹æ³ä¸­æ¥æ¶ä¸ä¸ªå­ç¬¦ä¸²ï¼å¹¶éè¿æ¹æ³doLexè¿è¡è§£æï¼è¿åä¸æ¬¡æ§å®æ´è§£æå­ç¬¦ä¸²åçtokenåè¡¨ã</li>
<li>doLexæ¹æ³ä¸­æ¯ä¸ä¸ªwhileå¾ªç¯ï¼æ¯ä¸æ¬¡å¾ªç¯å¼å§é½ç¸å½äºæ¯èªå¨æºä½äºç¶æ0ï¼å¨è§£ææ¶ä¼éè¿èªå¢currentIndexä¸æ­å°æ¨è¿å­ç¬¦æµï¼æåè§£æåºå®æ´çtokenåä¾¿ä¼å°æ°çtokenä¿å­å°ä¸ä¸æä¸­çtokenCollectorä¸­ãåªæå¨è§£ææ¥éæèæåå®æäºæ´ä¸ªå­ç¬¦ä¸²çè§£æåæä¼éåºå¾ªç¯ã</li>
<li>å¨æ­£å¸¸éåºwhileå¾ªç¯åï¼doLexæ¹æ³è¿ååtokenéåçå°¾é¨ä¼è¿½å ä¸ä¸ªç¹æ®çEOFç±»åçtokenï¼ç¨äºåç¥ä¸ä¸é¶æ®µçparserå·²ç»è§£æå°äºtokenæµçæ«å°¾ï¼è¯¥ç»æè§£æäºã</li>
</ul>
<h3 id="24-numberç±»åçè¯æ³åæ">2.4 numberç±»åçè¯æ³åæ</h3>
<p>numberçè¯æ³è§åç¸å¯¹å¤æï¼å ä¸ºnumberç±»åä½ä¸ºjsonä¸­è¡¨ç¤ºæ°å­çç»ä»¶ï¼å¶å¯ä»¥æ¯æ´æ°ï¼ä¹å¯ä»¥æ¯å°æ°ãè´æ°ï¼åæ¶è¿å¯ä»¥æ¯å¸¦ç¬¦å·e/Eçææ°å½¢å¼ã</p>
<h5 id="json-numberç±»åtokençè¯æ³è§å">json numberç±»åtokençè¯æ³è§å</h5>
<pre><code>number
    integer fraction exponent

integer
    digit
    onenine digits
    '-' digit
    '-' onenine digits

digits
    digit
    digit digits

digit
    '0'
    onenine

onenine
    '1' . '9'

fraction
    ""
    '.' digits

exponent
    ""
    'E' sign digits
    'e' sign digits

sign
    ""
    '+'
    '-'
</code></pre>
<p><img src="https://img2024.cnblogs.com/blog/1506329/202602/1506329-20260211195806369-790385529.png" alt="json_number_lex_rule" loading="lazy"></p>
<h5 id="_-6"></h5>
<p>åºäºä¸è¿°è¯æ³è§åï¼æä»¬å¯ä»¥æé åºå¦ä¸å¾æç¤ºçç¨äºè§£ænumberç±»åtokençç¶æèªå¨æºã</p>
<h5 id="numberç±»åè§£æçç¶æèªå¨æºç¤ºæå¾">numberç±»åè§£æçç¶æèªå¨æºç¤ºæå¾</h5>
<p><img src="https://img2024.cnblogs.com/blog/1506329/202602/1506329-20260211201818452-99218238.png" alt="json_number_lex_state_machine" loading="lazy"></p>
<h5 id="_-7"></h5>
<p>è®¾è®¡å¥½ä¸è¿°çç¶æèªå¨æºåï¼å°±å¯ä»¥æç§å¾ä¸­çç¶æè½¬ç§»å³ç³»æåä¸ä¸ªç®åçç¶ææºæ¥è§£ænumberç±»åçtokenäºã</p>
<h5 id="numberç±»åè§£æç¶ææºå®ç°æºç ">numberç±»åè§£æç¶ææºå®ç°æºç </h5>
<pre><code class="language-java">public class NumberLexStatemachine extends LexStatementMachine{

    private static final Map&lt;Integer,Boolean&gt; staticFinalStateMap;
    private static final LexStateHandler[] lexStateHandlers;

    static{
        staticFinalStateMap = new HashMap&lt;&gt;();
        staticFinalStateMap.put(-1,true);
        staticFinalStateMap.put(1,true);
        staticFinalStateMap.put(2,false);
        staticFinalStateMap.put(3,true);
        staticFinalStateMap.put(4,true);
        staticFinalStateMap.put(5,false);
        staticFinalStateMap.put(6,true);
        staticFinalStateMap.put(7,false);
        staticFinalStateMap.put(8,false);
        staticFinalStateMap.put(9,true);

        lexStateHandlers = new LexStateHandler[]{
            new State0Handler(), new State1Handler(), new State2Handler(), new State3Handler(), new State4Handler(),
            new State5Handler(),new State6Handler(),new State7Handler(),new State8Handler(),new State9Handler()
        };
    }

    public NumberLexStatemachine() {
        this.stateHandlers = lexStateHandlers;
        this.isFinalStateMap = staticFinalStateMap;
    }

    private static abstract class NumberLexStateHandler implements LexStateHandler {

        @Override
        public int processInState(char[] chars, DoLexContext doLexContext, LexStatementMachine lexStatementMachine, StringBuilder oneTokenAcceptResult) {
            char currentChar = chars[doLexContext.currentIndex];

            // whitespaceç¬¦å·ä»¥ånumberååæ³çç»ç»ç¬¦
            if(CommonStringUtil.isWhitespace(currentChar)
                || currentChar == ']' || currentChar == '}' || currentChar == ',' || currentChar == ':'){
                if(lexStatementMachine.currentStateIsFinal()){
                    // ç»ænumberçè§£æ
                    return -1;
                }else{
                    // éå°äºåéç¬¦ï¼ä½æ¯å½ånumberè§£æçç¶æä¸æ¯ç»æï¼æ æ³è½¬æ¢ä¸ºä¸ä¸ªåæ³çnumberç±»åçtokenï¼æå¼å¸¸
                    throw new MuJsonParserException("unexpected char " + currentChar + " " + doLexContext.currentIndex);
                }
            }

            return doProcessInState(currentChar,doLexContext, oneTokenAcceptResult);
        }

        abstract int doProcessInState(char currentChar, DoLexContext doLexContext, StringBuilder oneTokenAcceptResult);
    }

    private static class State0Handler extends NumberLexStateHandler {
        @Override
        int doProcessInState(char currentChar, DoLexContext doLexContext, StringBuilder oneTokenAcceptResult) {
            if(currentChar == '0'){
                // accept
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                // è¿å¥ç¶æ1
                return 1;
            }

            if(currentChar == '-'){
                // accept
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                // è¿å¥ç¶æ2
                return 2;
            }

            if(CommonStringUtil.is1_9(currentChar)){
                // accept
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                // è¿å¥ç¶æ3
                return 3;
            }

            throw new MuJsonParserException("unexpected char " + currentChar + " " + doLexContext.currentIndex);
        }
    }

    private static class State1Handler extends NumberLexStateHandler {
        @Override
        int doProcessInState(char currentChar, DoLexContext doLexContext, StringBuilder oneTokenAcceptResult) {
            if(currentChar == '.'){
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                return 5;
            }

            if(currentChar == 'e' || currentChar == 'E'){
                accept(currentChar,doLexContext, oneTokenAcceptResult);
                return 7;
            }

            throw new MuJsonParserException("unexpected char '" + currentChar + "', index=" + doLexContext.currentIndex);
        }
    }

    private static class State2Handler extends NumberLexStateHandler {
        @Override
        int doProcessInState(char currentChar, DoLexContext doLexContext, StringBuilder oneTokenAcceptResult) {
            if(currentChar == '0'){
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                return 1;
            }

            if(CommonStringUtil.is1_9(currentChar)){
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                return 3;
            }

            throw new MuJsonParserException("unexpected char " + currentChar + " " + doLexContext.currentIndex);
        }
    }

    private static class State3Handler extends NumberLexStateHandler {
        @Override
        int doProcessInState(char currentChar, DoLexContext doLexContext, StringBuilder oneTokenAcceptResult) {
            if(currentChar == '.'){
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                return 5;
            }

            if(currentChar == 'e' || currentChar == 'E'){
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                return 7;
            }

            if(CommonStringUtil.is0_9(currentChar)){
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                return 4;
            }

            throw new MuJsonParserException("unexpected char " + currentChar + " " + doLexContext.currentIndex);
        }
    }

    private static class State4Handler extends NumberLexStateHandler {
        @Override
        int doProcessInState(char currentChar, DoLexContext doLexContext,StringBuilder oneTokenAcceptResult) {
            if(currentChar == '.'){
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                return 5;
            }

            if(currentChar == 'e' || currentChar == 'E'){
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                return 7;
            }

            if(CommonStringUtil.is0_9(currentChar)){
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                return 4;
            }

            throw new MuJsonParserException("unexpected char " + currentChar + " " + doLexContext.currentIndex);
        }
    }

    private static class State5Handler extends NumberLexStateHandler {
        @Override
        int doProcessInState(char currentChar, DoLexContext doLexContext, StringBuilder oneTokenAcceptResult) {
            if(CommonStringUtil.is0_9(currentChar)){
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                return 6;
            }

            throw new MuJsonParserException("unexpected char " + currentChar + " " + doLexContext.currentIndex);
        }
    }

    private static class State6Handler extends NumberLexStateHandler {
        @Override
        int doProcessInState(char currentChar, DoLexContext doLexContext,StringBuilder oneTokenAcceptResult) {
            if(CommonStringUtil.is0_9(currentChar)){
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                return 6;
            }

            if(currentChar == 'e' || currentChar == 'E'){
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                return 7;
            }

            throw new MuJsonParserException("unexpected char " + currentChar + " " + doLexContext.currentIndex);
        }
    }

    private static class State7Handler extends NumberLexStateHandler {
        @Override
        int doProcessInState(char currentChar, DoLexContext doLexContext,StringBuilder oneTokenAcceptResult) {
            if(CommonStringUtil.is0_9(currentChar)){
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                return 9;
            }

            if(currentChar == '-' || currentChar == '+'){
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                return 8;
            }

            throw new MuJsonParserException("unexpected char " + currentChar + " " + doLexContext.currentIndex);
        }
    }

    private static class State8Handler extends NumberLexStateHandler {
        @Override
        int doProcessInState(char currentChar, DoLexContext doLexContext, StringBuilder oneTokenAcceptResult) {
            if(CommonStringUtil.is0_9(currentChar)){
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                return 9;
            }

            throw new MuJsonParserException("unexpected char " + currentChar + " " + doLexContext.currentIndex);
        }
    }

    private static class State9Handler extends NumberLexStateHandler {
        @Override
        int doProcessInState(char currentChar, DoLexContext doLexContext, StringBuilder oneTokenAcceptResult) {
            if(CommonStringUtil.is0_9(currentChar)){
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                return 9;
            }

            throw new MuJsonParserException("unexpected char " + currentChar + " " + doLexContext.currentIndex);
        }
    }
}

</code></pre>
<pre><code class="language-java">public abstract class LexStatementMachine {

    protected int currentState = 0;
    protected StringBuilder oneTokenAcceptResult = new StringBuilder();

    protected LexStateHandler[] stateHandlers;
    protected Map&lt;Integer,Boolean&gt; isFinalStateMap;

    public String tryParse(char[] chars, DoLexContext doLexContext){
        doParse(chars,doLexContext);

        boolean isFinalState = isFinalStateMap.get(currentState);
        if(isFinalState){
            return oneTokenAcceptResult.toString();
        }else{
            throw new MuJsonParserException(String.format("currentState is not finalState! acceptResult=%s, acceptResult=%s",currentState, oneTokenAcceptResult));
        }
    }

    public boolean currentStateIsFinal(){
        return isFinalStateMap.get(currentState);
    }

    protected static void accept(char currentChar, DoLexContext doLexContext, StringBuilder oneTokenAcceptResult){
        oneTokenAcceptResult.append(currentChar);
        doLexContext.currentIndex++;
    }

    private void doParse(char[] chars, DoLexContext doLexContext){
        // ä¸è¿æ¥æ¯ç¶æ0
        while(doLexContext.currentIndex &lt; chars.length){
            if(currentState == -1){
                // éå°äºåæ³çåéç¬¦å·ï¼éåºtokenè§£æ
                return;
            }

            if(currentState &gt;= stateHandlers.length){
                // æbug
                throw new MuJsonParserException(String.format("unknown state! currentState=%s",currentState));
            }
            LexStateHandler targetStateHandler = stateHandlers[currentState];
            
            currentState = targetStateHandler.processInState(chars,doLexContext,this,oneTokenAcceptResult);
        }
    }
}
</code></pre>
<h5 id="_-8"></h5>
<ul>
<li>NumberLexStatemachineç»§æ¿èªç¶ç±»LexStatementMachineãå¨LexStatementMachineä¸­ä¸doLexæ¹æ³ç±»ä¼¼ï¼ä¹æ¯ä¸ä¸ªwhileå¾ªç¯æ¥åå¤çå¤çæ¯ä¸æ¬¡çç¶æè·³è½¬ã</li>
<li>å­ç±»NumberLexStatemachineå®ä¹äºä¸ç³»åçLexStateHandlerç¶æå¤çå¨ï¼æ¯ä¸ä¸ªç¶æå¤çå¨é½å¯¹åºç¶ææºç¤ºæå¾ä¸­çä¸ä¸ªç¶æã</li>
<li>æ¯ä¸ä¸ªLexStateHandlerä¸­çåè½é½æ¯è¾ç±»ä¼¼ï¼å³å³å®å¨å½åç¶æä¸èªå·±è½å¤æ¥æ¶çå­ç¬¦ç±»åï¼ä»¥åæ§å¶å¨åæ³æ¥æ¶å­ç¬¦æµå½åå­ç¬¦ååºè¯¥è·³è½¬çä¸ä¸ä¸ªç¶ææ¯ä»ä¹ã<br>
å¨åæ³æ¥æ¶å­ç¬¦æ¶ï¼ä¼ä¿®æ¹ä¸ä¸æä¸­çå½åå­ç¬¦æéä»¥æ¨è¿å­ç¬¦æµï¼åæ¶å°æ¥åå°çå½ååæ³å­ç¬¦è¿½å å°oneTokenAcceptResultä¸­ã</li>
<li>å¦æéå°äºåæ³çç»æåéç¬¦ï¼æ¯å¦whitespaceæèâ}âãâ]âä¹ç±»çå­ç¬¦ï¼ä¸å½åç¶ææ¯å±äºnumberè§£æçç»æï¼åNumberLexStateHandlerä¼è¿å-1ï¼ç»æ­¢å½åtokençè§£æã(æ¯å¦{"number":-123.0}ç»ææ¶çç¶ææ¯6ï¼6æ¯ç»æï¼æä»¥å¶æ¯åæ³çjsonä¸²)<br>
å¦æç¶æå¤çå¨ä¸­éå°å½åç¶æä¸ä¸åæ³çå­ç¬¦ï¼æèå¨éåºè§£ææ¶å½åç¶æä¸å±äºnumberè§£æçç»æï¼è¯´æå½åå­ç¬¦ä¸²ä¸æ¯åæ³çjsonä¸²ï¼åä¼ç´æ¥æåºå¼å¸¸ï¼éåºè¯æ³è§£æã(æ¯å¦{"number":-123.}ç»ææ¶çç¶ææ¯5,5ä¸æ¯ç»æï¼æä»¥å¶æ¯ä¸åæ³çjsonä¸²)</li>
<li>NumberLexStatemachineç¶ææºæ­£å¸¸éåºå½ånumberç±»åtokenåï¼è¿åæ¶éå°çææå­ç¬¦oneTokenAcceptResultï¼ä½ä¸ºnumberç±»åçå­é¢éè¿åã</li>
</ul>
<h3 id="25-stringç±»åçè¯æ³åæ">2.5 stringç±»åçè¯æ³åæ</h3>
<p>stringç±»åçè¯æ³è§åç¸æ¯ä¹ä¸æ¯è¾ç®åï¼è¦æ±ä»¥åå¼å·å¼å¤´ï¼å¹¶ä»¥åå¼å·ç»å°¾å³å¯ï¼ä½éè¦é¢å¤å¤çè½¬ä¹å­ç¬¦ç¸å³çé»è¾ã</p>
<h5 id="json-stringç±»åtokençè¯æ³è§å">json stringç±»åtokençè¯æ³è§å</h5>
<pre><code>string
    '"' characters '"'

characters
    ""
    character characters

character
    '0020' . '10FFFF' - '"' - '\'
    '\' escape

escape
    '"'
    '\'
    '/'
    'b'
    'f'
    'n'
    'r'
    't'
    'u' hex hex hex hex

hex
    digit
    'A' . 'F'
    'a' . 'f'
</code></pre>
<p><img src="https://img2024.cnblogs.com/blog/1506329/202602/1506329-20260211195844242-1192651121.png" alt="json_string_lex_rule" loading="lazy"></p>
<h5 id="_-9"></h5>
<p>åºäºä¸è¿°è¯æ³è§åï¼æä»¬æé åºå¦ä¸å¾æç¤ºçç¨äºè§£æstringç±»åtokençç¶æèªå¨æºã</p>
<h5 id="stringç±»åè§£æçç¶æèªå¨æºç¤ºæå¾">stringç±»åè§£æçç¶æèªå¨æºç¤ºæå¾</h5>
<p><img src="https://img2024.cnblogs.com/blog/1506329/202602/1506329-20260211195854133-180088812.png" alt="json_string_lex_state_machine" loading="lazy"></p>
<h5 id="stringç±»åè§£æç¶ææºå®ç°æºç ">stringç±»åè§£æç¶ææºå®ç°æºç </h5>
<pre><code class="language-java">public class StringLexStatemachine extends LexStatementMachine{

    private static final Map&lt;Integer,Boolean&gt; staticFinalStateMap;
    private static final LexStateHandler[] lexStateHandlers;

    static{
        staticFinalStateMap = new HashMap&lt;&gt;();
        staticFinalStateMap.put(-1,true);
        staticFinalStateMap.put(1,false);
        staticFinalStateMap.put(2,true);
        staticFinalStateMap.put(3,false);
        staticFinalStateMap.put(4,false);
        staticFinalStateMap.put(5,false);
        staticFinalStateMap.put(6,false);
        staticFinalStateMap.put(7,false);

        lexStateHandlers = new LexStateHandler[]{
            new State0Handler(),new State1Handler(),new State2Handler(),new State3Handler(),new State4Handler(),
            new State5Handler(),new State6Handler(),new State7Handler()};
    }

    public StringLexStatemachine() {
        this.stateHandlers = lexStateHandlers;
        this.isFinalStateMap = staticFinalStateMap;
    }

    private static abstract class StringLexStateHandler implements LexStateHandler {

        @Override
        public int processInState(char[] chars, DoLexContext doLexContext, LexStatementMachine lexStatementMachine, StringBuilder oneTokenAcceptResult) {
            char currentChar = chars[doLexContext.currentIndex];

            return doProcessInState(currentChar,doLexContext,oneTokenAcceptResult);
        }

        abstract int doProcessInState(char currentChar, DoLexContext doLexContext, StringBuilder oneTokenAcceptResult);
    }

    private static class State0Handler extends StringLexStateHandler {
        @Override
        int doProcessInState(char currentChar, DoLexContext doLexContext, StringBuilder oneTokenAcceptResult) {
            if(currentChar == '"'){
                // accept
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                // è¿å¥ç¶æ1
                return 1;
            }

            throw new MuJsonParserException("unexpected char " + currentChar + " " + doLexContext.currentIndex);
        }
    }

    private static class State1Handler extends StringLexStateHandler {
        @Override
        int doProcessInState(char currentChar, DoLexContext doLexContext, StringBuilder oneTokenAcceptResult) {
            if(currentChar == '"'){
                // accept
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                // è¿å¥ç¶æ2
                return 2;
            }

            if(currentChar == '\\'){
                // accept
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                // è¿å¥ç¶æ3
                return 3;
            }

            // æ§å¶å­ç¬¦æ¯ä¸åæ³çï¼ä¸è½åºç°å¨stringä¸­
            if (currentChar &lt; 0x20) {
                throw new MuJsonParserException("unexpected control char " + currentChar + " in string, " + doLexContext.currentIndex);
            }

            // é¤äº["]å[\]ä¸¤ä¸ªå­ç¬¦ï¼å«çé½å½åå­ç¬¦ä¸²çä¸é¨åæ¥æ¶
            // accept
            accept(currentChar,doLexContext,oneTokenAcceptResult);
            return 1;
        }
    }

    private static class State2Handler extends StringLexStateHandler {
        @Override
        int doProcessInState(char currentChar, DoLexContext doLexContext, StringBuilder oneTokenAcceptResult) {
            // ç»æï¼å®æä¸ä¸ªstringçè§£æï¼ç´æ¥éåº
            return -1;
        }
    }

    private static class State3Handler extends StringLexStateHandler {
        @Override
        int doProcessInState(char currentChar, DoLexContext doLexContext, StringBuilder oneTokenAcceptResult) {
            // åæ³çè½¬ä¹å­ç¬¦
            if(currentChar == '"' || currentChar == '\\' || currentChar == '/' ||
                currentChar == 'b' || currentChar == 'f' || currentChar == 'n' ||
                currentChar == 'r' || currentChar == 't'){
                // æ¥æ¶ï¼åå°ç¶æ1
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                return 1;
            }

            if(currentChar == 'u'){
                // ç¹æ®case è¦æ±åé¢è¿ç»­4ä¸ªhexå­ç¬¦ '\\u hex hex hex hex'
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                return 4;
            }

            throw new MuJsonParserException("unexpected char " + currentChar + " " + doLexContext.currentIndex);
        }
    }

    private static class State4Handler extends StringLexStateHandler {
        @Override
        int doProcessInState(char currentChar, DoLexContext doLexContext, StringBuilder oneTokenAcceptResult) {
            if(CommonStringUtil.isHex(currentChar)){
                // æ¥æ¶ï¼è¿å¥ç¶æ5
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                return 5;
            }

            throw new MuJsonParserException("unexpected char " + currentChar + " " + doLexContext.currentIndex);
        }
    }

    private static class State5Handler extends StringLexStateHandler {
        @Override
        int doProcessInState(char currentChar, DoLexContext doLexContext, StringBuilder oneTokenAcceptResult) {
            if(CommonStringUtil.isHex(currentChar)){
                // æ¥æ¶ï¼è¿å¥ç¶æ6
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                return 6;
            }

            throw new MuJsonParserException("unexpected char " + currentChar + " " + doLexContext.currentIndex);
        }
    }

    private static class State6Handler extends StringLexStateHandler {
        @Override
        int doProcessInState(char currentChar, DoLexContext doLexContext, StringBuilder oneTokenAcceptResult) {
            if(CommonStringUtil.isHex(currentChar)){
                // æ¥æ¶ï¼è¿å¥ç¶æ7
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                return 7;
            }

            throw new MuJsonParserException("unexpected char " + currentChar + " " + doLexContext.currentIndex);
        }
    }

    private static class State7Handler extends StringLexStateHandler {
        @Override
        int doProcessInState(char currentChar, DoLexContext doLexContext, StringBuilder oneTokenAcceptResult) {
            if(CommonStringUtil.isHex(currentChar)){
                // è¿ç»­æ¥æ¶äº4ä¸ªhexå­ç¬¦ï¼åå°ç¶æ1
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                return 1;
            }

            throw new MuJsonParserException("unexpected char " + currentChar + " " + doLexContext.currentIndex);
        }
    }
}
</code></pre>
<h5 id="_-10"></h5>
<ul>
<li>stringç±»åtokenè§£æçç¶ææºä¸numberç±»åçå·¥ä½æ¨¡å¼ç±»ä¼¼ï¼åæ ·ç»§æ¿èªLexStatementMachineï¼å¹¶ä¸å®ä¹äºä¸ç³»åçå¯¹åºç¶ææºç¤ºæå¾ä¸­åä¸ªç¶æçLexStateHandlerã</li>
</ul>
<h3 id="26-å³é®å­çè¯æ³åæ">2.6 å³é®å­çè¯æ³åæ</h3>
<p>æåï¼jsonçè¯æ³åæä¸­è¿æå³é®å­ç±»åçtokenè§£æéè¦å®ç°ãæå¹¸jsonçææ³éå¸¸ç®åï¼åªætrueãfalseånullä¸ä¸ªå³é®å­ï¼ä¸è¿ä¸ä¸ªå³é®å­çf(1)é½ä¸ç¸åï¼ä¹ä¸å¶å®ç±»åçtokençf(1)ä¸ç¸åã<br>
å æ­¤ï¼å¨è¯æ³è§£ææ¶ï¼æä»¬å¯ä»¥å¾ç®åçæ ¹æ®ç¬¬ä¸ä¸ªå­ç¬¦æ¥å³å®è¦è§£æçå³é®å­ç±»åï¼å¨ç¶æ0æ¶ï¼å¦æç¢°å°å­ç¬¦tå°±å°è¯è§£ætrueç±»åçtokenï¼ç¢°å°å­ç¬¦få°±å°è¯è§£æfalseç±»åçtokenï¼ç¢°å°å­ç¬¦nå°±å°è¯è§£ænullç±»åçtokenã<br>
å æ­¤æä»¬å¯ä»¥å¾ç®åçå¾å°å¦ä¸å¾æç¤ºçä¸ä¸ªå³é®å­çç¶æèªå¨æºã</p>
<h5 id="å³é®å­ç±»åè§£æçç¶æèªå¨æºç¤ºæå¾">å³é®å­ç±»åè§£æçç¶æèªå¨æºç¤ºæå¾</h5>
<p><img src="https://img2024.cnblogs.com/blog/1506329/202602/1506329-20260211195910810-282453956.png" alt="json_keyword_lex_state_machine" loading="lazy"></p>
<h5 id="keywordç±»åè§£æç¶ææºå®ç°æºç ">keywordç±»åè§£æç¶ææºå®ç°æºç </h5>
<pre><code class="language-java">public abstract class KeywordLexStatementMachine extends LexStatementMachine{

    protected final String keyword;

    public KeywordLexStatementMachine(String keyword) {
        this.keyword = keyword;
    }

    protected static Map&lt;Integer,Boolean&gt; buildIsFinalStateMap(String keyword){
        Map&lt;Integer,Boolean&gt; isFinalStateMap = new HashMap&lt;&gt;(keyword.length() + 1);
        isFinalStateMap.put(-1,true);

        for(int i=0; i&lt;keyword.length(); i++) {
            isFinalStateMap.put(i,false);
        }

        // æåä¸ä¸ªå­ç¬¦å°±æ¯åççç»æ
        isFinalStateMap.put(keyword.length(),true);

        return isFinalStateMap;
    }

    protected static LexStateHandler[] buildLexStateHandlers(String keyword){
        LexStateHandler[] lexStateHandlers = new LexStateHandler[keyword.length() + 1];

        for(int i=0; i&lt;keyword.length(); i++) {
            char c = keyword.charAt(i);

            lexStateHandlers[i] = new KeywordLexStateHandler(c,i+1);
        }

        // æåä¸ä¸ªç¶æï¼ç´æ¥è¿å
        lexStateHandlers[keyword.length()] = new KeywordLexStateHandler(' ',-1);

        return lexStateHandlers;
    }

    private static class KeywordLexStateHandler implements LexStateHandler {

        private final char targetCh;
        private final int nextState;

        public KeywordLexStateHandler(char targetCh, int nextState) {
            this.targetCh = targetCh;
            this.nextState = nextState;
        }

        @Override
        public int processInState(char[] chars, DoLexContext doLexContext, LexStatementMachine lexStatementMachine, StringBuilder oneTokenAcceptResult) {
            char currentChar = chars[doLexContext.currentIndex];

            return doProcessInState(currentChar,doLexContext,oneTokenAcceptResult);
        }

        private int doProcessInState(char currentChar, DoLexContext doLexContext, StringBuilder oneTokenAcceptResult){
            if(nextState == -1){
                // -1æ¯ç¹æ®çç´æ¥è¿å
                return nextState;
            }

            if(currentChar == targetCh) {
                // æ¥æ¶ï¼è¿å¥ä¸ä¸ä¸ªç¶æ
                accept(currentChar,doLexContext,oneTokenAcceptResult);
                return nextState;
            }

            throw new MuJsonParserException("unexpected char " + currentChar + " " + doLexContext.currentIndex);
        }
    }
}
</code></pre>
<pre><code class="language-java">/**
 * è§£æå³é®å­trueçç¶æèªå¨æº
 * */
public class KeywordTrueLexStatementMachine extends KeywordLexStatementMachine{

    private static final String KEYWORD = JsonTokenTypeEnum.TRUE.getKey();
    private static final Map&lt;Integer,Boolean&gt; staticIsFinalStateMap;
    private static final LexStateHandler[] lexStateHandlers;

    static {
        staticIsFinalStateMap = buildIsFinalStateMap(KEYWORD);
        lexStateHandlers = buildLexStateHandlers(KEYWORD);
    }

    public KeywordTrueLexStatementMachine() {
        super(KEYWORD);

        super.isFinalStateMap = staticIsFinalStateMap;
        super.stateHandlers = lexStateHandlers;
    }
}
</code></pre>
<h5 id="_-11"></h5>
<ul>
<li>ç±äºå³é®å­çè§£æé½æ¯æç®åçååç¶æè½¬ç§»ï¼æä»¥åç¬æ½è±¡åºäºKeywordLexStatementMachineç±»ï¼å¶æ ¹æ®æé æ¹æ³ä¸­ä¼ å¥çå³é®å­å­é¢éï¼èªå¨çæå¯¹åºæ°éçLexStateHandleréååIsFinalStateMapã</li>
<li>falseånullå³é®å­çè¯æ³è§£æä¸trueåºæ¬ä¸è´ï¼è¿éçç¥æ</li>
</ul>
<h5 id="27-jsontokenreader">2.7 jsonTokenReader</h5>
<p>è³æ­¤ï¼æä»¬å°±å·²ç»å®ç°äºåºæ¬çjsonè¯æ³åæè½åï¼è½å¤å°jsonå­ç¬¦ä¸²ä¸æ¬¡æ§çè§£æætokenåè¡¨ä¾ä¸ä¸é¶æ®µçè¯­æ³åæä½¿ç¨ã<br>
ä½å¨è¯­æ³è§£æé¶æ®µï¼parseræ´å¸ææ¥æ¶çæ¯è½å¤èªå·±è®°å¿å½åæå¤çtokençtokenæµï¼èä¸æ¯ä¸ä¸ªå­¤é¶é¶çList<jsontoken>ï¼æä»¥è¿éç®åçä»¥è¿­ä»£å¨çæ¹å¼åè£ä¸ä¸æ¹ä¾¿ä½¿ç¨ã</jsontoken></p>
<pre><code class="language-java">public interface JsonTokenReader {

    boolean hasNextToken();

    JsonToken nextToken();

    JsonToken peek();

    int currentIndex();
}
</code></pre>
<p>éæè¯æ³åæå¨çå®ç°ï¼</p>
<pre><code class="language-java">public class StaticJsonTokenReader implements JsonTokenReader {

    private int currentIndex;

    private final List&lt;JsonToken&gt; tokens;

    public StaticJsonTokenReader(String jsonString) {
        this.currentIndex = 0;

        StaticJsonLexer staticJsonLexer = new StaticJsonLexer(jsonString);
        this.tokens = staticJsonLexer.doLex();
    }

    @Override
    public boolean hasNextToken() {
        return tokens.get(currentIndex).getType() != JsonTokenTypeEnum.EOF;
    }

    @Override
    public JsonToken nextToken() {
        JsonToken jsonToken = tokens.get(currentIndex);
        currentIndex++;
        return jsonToken;
    }

    @Override
    public JsonToken peek() {
        return tokens.get(currentIndex);
    }

    @Override
    public int currentIndex() {
        return this.currentIndex;
    }
}
</code></pre>
<p>ç®ådemoï¼</p>
<pre><code class="language-java">    public static void main(String[] args) {
        String json = "{\"k1\":{\"abc\":123},\"k2\":true}";

        StaticJsonLexer staticJsonLexer = new StaticJsonLexer(json);
        List&lt;JsonToken&gt; jsonTokenList = staticJsonLexer.doLex();
        System.out.println("json=" + json);
        jsonTokenList.forEach(System.out::println);
    }
</code></pre>
<p><img src="https://img2024.cnblogs.com/blog/1506329/202602/1506329-20260211195926464-23510035.png" alt="static_json_lexer_demo_result" loading="lazy"></p>
<h2 id="3-æå-json-è¯­æ³åæå¨ä»-token-å°-ast">3. æå json è¯­æ³åæå¨ï¼ä» token å° AST</h2>
<p>è¯­æ³åæé¶æ®µï¼æ¥æ¶è¯æ³åæé¶æ®µè¾åºçtokenæµï¼éè¦æç§è¯­æ³è§åè§£æåºæ­£ç¡®çASTæ½è±¡è¯­æ³æ ã<br>
å¨jsonçASTä¸­å¶å®æ¬è´¨ä¸åªæä¸ç§ç±»åçåç´ ï¼</p>
<ul>
<li><code>JsonObject</code>ï¼å¯¹è±¡</li>
<li><code>JsonArray</code>ï¼æ°ç»</li>
<li><code>JsonPrimitiveStr</code>ï¼primitiveåºç¡ç±»åï¼string/number/true/false/nullï¼å°è£ä¸ºå­ç¬¦ä¸²å­é¢é</li>
</ul>
<h5 id="_-12"></h5>
<p>primitiveåºç¡ç±»åæ¯æ æ³è¿è¡éå½åµå¥çç±»åï¼æ¯ASTä¸­çå¶èç¹ï¼èobjectåarrayåæ¯å¯ä»¥äºç¸åµå¥ç(å¯¹è±¡çä¸ä¸ªå±æ§å¯ä»¥æ¯æ°ç»æèå¦ä¸ä¸ªå¯¹è±¡ï¼æ°ç»ä¸­çåç´ ä¹å¯ä»¥æ¯å¯¹è±¡æèå¦ä¸ä¸ªæ°ç»)ï¼å¶å±äºASTä¸­çéå¶å­ç»ç¹ã</p>
<h3 id="31-json-astèç¹ç»æå®ä¹">3.1 json ASTèç¹ç»æå®ä¹</h3>
<pre><code class="language-java">public abstract class JsonElement {
}
</code></pre>
<pre><code class="language-java">/**
 * json ASTçobjectç±»åèç¹
 * */
public class JsonObject extends JsonElement{

    private final Map&lt;String,JsonElement&gt; objMap = new LinkedHashMap&lt;&gt;();

    public void putKV(String key, JsonElement value) {
        objMap.put(key, value);
    }

    public Map&lt;String, JsonElement&gt; getObjMap() {
        return objMap;
    }
}
</code></pre>
<pre><code class="language-java">/**
 * json ASTçarrayç±»åèç¹
 * */
public class JsonArray extends JsonElement{

    private List&lt;JsonElement&gt; array = new ArrayList&lt;&gt;();

    public void addElement(JsonElement element) {
        array.add(element);
    }

    public List&lt;JsonElement&gt; getArray() {
        return array;
    }
}
</code></pre>
<pre><code class="language-java">/**
 * json ASTçprimitiveç±»åèç¹
 * */
public class JsonPrimitiveStr extends JsonElement{

    /**
     * åºç¡ç±»åçå­ç¬¦ä¸²å­é¢é
     * */
    private final String primitiveValueStr;

    public JsonPrimitiveStr(String primitiveValueStr) {
        this.primitiveValueStr = primitiveValueStr;
    }

    public String getPrimitiveValueStr() {
        return primitiveValueStr;
    }
}
</code></pre>
<h5 id="_-13"></h5>
<ul>
<li>jsonElementæ¯ææASTèç¹çå±åæ½è±¡ç¶ç±»</li>
<li>jsonçobjectç»ææ å°ä¸ºjavaä¸­æ¯ä¸ä¸ªæåºçk/v Mapç»æ</li>
<li>jsonçarrayç»ææ å°ä¸ºjavaä¸­æ¯ä¸ä¸ªListç»æ</li>
<li>jsonçprimitiveç»ææ å°ä¸ºjavaä¸­çä¸ä¸ªç®åå­ç¬¦ä¸²å­é¢é</li>
</ul>
<h3 id="32-jsonæ ¹èç¹è¯­æ³è§£æ">3.2 jsonæ ¹èç¹è¯­æ³è§£æ</h3>
<pre><code>json
    element
    
element
    ws value ws

value
    object
    array
    string
    number
    "true"
    "false"
    "null"

object
    '{' ws '}'
    '{' members '}'    

array
    '[' ws ']'
    '[' elements ']'
</code></pre>
<h5 id="_-14"></h5>
<p>ä¸è¿°ææ³ä¸­ï¼jsonæ¯ASTçæ ¹èç¹ï¼å¶æç»å¯ä»¥æ¯objectãarrayæè5ç§åºæ¬ç±»åçä¸ç§ã<br>
objectç±»åçf(1)æä¸ä»æ'{'ï¼èarrayç±»åçf(1)æä¸ä»æ'['ï¼å æ­¤æä»¬å¯ä»¥æé åºä¸ä¸ªç®åçæ ¹èç¹è§£æçç¶ææºæ¥å®ç°è¯­æ³åæã</p>
<ul>
<li>è¥tokenæµä¸­çç¬¬ä¸ä¸ª token æ¯ <code>{</code> â è§£æä¸º <code>JsonObject</code>ã</li>
<li>è¥tokenæµä¸­çç¬¬ä¸ä¸ª token æ¯ <code>[</code> â è§£æä¸º <code>JsonArray</code>ã</li>
<li>è¥tokenæµä¸­çç¬¬ä¸ä¸ª token æ¯åºç¡ç±»å â è§£æä¸º <code>JsonPrimitiveStr</code>ã</li>
<li>å¦åé½æ¯éæ³jsonã</li>
</ul>
<h5 id="jsonæ ¹èç¹è¯­æ³è§£æç¶æèªå¨æº">jsonæ ¹èç¹è¯­æ³è§£æç¶æèªå¨æº</h5>
<p><img src="https://img2024.cnblogs.com/blog/1506329/202602/1506329-20260211195937409-994915878.png" alt="json_parser_root" loading="lazy"></p>
<h5 id="jsonæ ¹èç¹è§£æç¶æèªå¨æºå®ç°">jsonæ ¹èç¹è§£æç¶æèªå¨æºå®ç°</h5>
<pre><code class="language-java">/**
 * åºäºéå½å®ç°çjsonè§£æå¨
 * */
public class RecursiveJsonParser extends JsonParser {

    public RecursiveJsonParser(JsonTokenReader tokenReader) {
        super(tokenReader);
    }

    @Override
    public JsonElement doParse() {
        JsonToken token = jsonTokenReader.peek();

        if (token.getType() == JsonTokenTypeEnum.LEFT_BRACE) {
            JsonObjectParseStatementMachine jsonObjectParseStatementMachine = new JsonObjectParseStatementMachine(jsonTokenReader);

            return jsonObjectParseStatementMachine.parseJsonElement();
        }

        if (token.getType() == JsonTokenTypeEnum.LEFT_BRACKET) {
            JsonArrayParseStatementMachine jsonArrayParseStatementMachine = new JsonArrayParseStatementMachine(jsonTokenReader);

            return jsonArrayParseStatementMachine.parseJsonElement();
        }

        // åºç¡ç±»åçvalue
        if (token.getType().isPrimitiveValue()) {
            return new JsonPrimitiveStr(token.getContent());
        }

        // ç¬¬ä¸ä¸ªtokenï¼ä¸å±äºjsonè§åçf(1)éå
        throw new MuJsonParserException("unexpected start json token! token=" + jsonTokenReader.currentIndex());
    }
}
</code></pre>
<pre><code class="language-java">public enum JsonTokenTypeEnum {
    // çç¥äºæ å³é»è¾

    /**
     * åºç¡ç±»åçvalueï¼stringãnumberãtrueãfalseãnullï¼
     * */
    public boolean isPrimitiveValue(){
        return this == STRING || this == NUMBER || this == NULL ||this == TRUE || this == FALSE;
    }
}
</code></pre>
<h3 id="33-json-objectå¯¹è±¡ç»æè§£æ">3.3 json objectå¯¹è±¡ç»æè§£æ</h3>
<p>ç°å¨æä»¬æ¥ç ç©¶json objectå¯¹è±¡çè¯­æ³è§£æãobjectç»ææ¯ä»¥â{âå¼å¤´ï¼â}âç»å°¾çç»æï¼åé¨å¯ä»¥æ0å°Nä¸ªkvé®å¼å¯¹ï¼å¶ä¸­keyå¿é¡»æ¯stringç±»åï¼èvalueåå¯ä»¥æ¯åµå¥çç»æï¼keyåvalueä¹é´ä»¥åå·åéï¼kvå¯¹ä¹é´ä»¥éå·åå²ã<br>
å æ­¤ï¼ä½¿ç¨éå½çæ¹å¼æ¥å®ç°objectå¯¹è±¡çè¯­æ³è§£ææ¯å¾å®¹æçè§£åå®ç°ç(å°½ç®¡éå½çå®ç°æçä¸å¤é«)ã</p>
<h5 id="json-objectå¯¹è±¡ç»æè¯­æ³">json objectå¯¹è±¡ç»æè¯­æ³</h5>
<pre><code>object
    '{' ws '}'
    '{' members '}'

members
    member
    member ',' members

member
    ws string ws ':' element

element
    ws value ws    

value
    object
    array
    string
    number
    "true"
    "false"
    "null"
</code></pre>
<p><img src="https://img2024.cnblogs.com/blog/1506329/202602/1506329-20260211195946762-1722527366.png" alt="json_object_parser" loading="lazy"></p>
<h5 id="objectç»æè§£æç¶æèªå¨æºç¤ºæå¾">objectç»æè§£æç¶æèªå¨æºç¤ºæå¾</h5>
<p><img src="https://img2024.cnblogs.com/blog/1506329/202602/1506329-20260211195955922-1227811677.png" alt="json_object_state_machine" loading="lazy"></p>
<h5 id="objectç»æè§£æç¶æèªå¨æºéå½å®ç°éå½çæ¬">objectç»æè§£æç¶æèªå¨æºéå½å®ç°ï¼éå½çæ¬ï¼</h5>
<p>è¯­æ³åæä¸è¯æ³åæç±»ä¼¼ï¼ä¹æ¯ä½¿ç¨ç¶æèªå¨æºæ¥å®ç°çãå®ç°çå¤§è´æ¹å¼ä¹æ¯éè¿æ½è±¡åºä¸ä¸ªç¶ç±»(AbstractJsonParseStatementMachine),å¨ç¶ç±»ä¸­éè¿æç»­ä¸æ­çä»tokenæµä¸­è¯»åtokenæ¥æ¨è¿ç¶æãå¨å­ç±»ä¸­å®ä¹ç¸åºçç¶æå¤çå¨æ¥å®ç°æ¯ä¸ªç¶æçå¤ç</p>
<pre><code class="language-java">/**
 * åºäºéå½å®ç°ç objectç±»åè¯­æ³è§£æç¶æèªå¨æº
 * */
public class JsonObjectParseStatementMachine extends AbstractJsonParseStatementMachine&lt;JsonObject&gt;{

    public JsonObjectParseStatementMachine(JsonTokenReader jsonTokenReader) {
        this.jsonTokenReader = jsonTokenReader;
        this.targetJsonElement = new JsonObject();
        this.recursiveDoParserContext = new RecursiveDoParserContext&lt;&gt;(this.targetJsonElement);
        stateHandlers = new ParserStateHandler[]{
            new ParserState0Handler(),new ParserState1Handler(),new ParserState2Handler(),new ParserState3Handler(),
            new ParserState4Handler(),new ParserState5Handler(),new ParserState6Handler()
        };
    }

    private static class ParserState0Handler implements ParserStateHandler&lt;JsonObject&gt;{

        @Override
        public int processInState(JsonTokenReader jsonTokenReader, RecursiveDoParserContext&lt;JsonObject&gt; recursiveDoParserContext) {
            JsonToken token = jsonTokenReader.peek();

            if(token.getType() != JsonTokenTypeEnum.LEFT_BRACE){
                throw new MuJsonParserException("unexpected token! index=" + jsonTokenReader.currentIndex());
            }

            accept(jsonTokenReader);
            return 1;
        }
    }

    private static class ParserState1Handler implements ParserStateHandler&lt;JsonObject&gt;{

        @Override
        public int processInState(JsonTokenReader jsonTokenReader, RecursiveDoParserContext&lt;JsonObject&gt; recursiveDoParserContext) {
            JsonToken token = jsonTokenReader.peek();

            if(token.getType() == JsonTokenTypeEnum.RIGHT_BRACE){
                accept(jsonTokenReader);
                return 2;
            }

            if(token.getType() == JsonTokenTypeEnum.STRING){
                // ækeyååå¥æ ä¸­ï¼ç¶åç­æé kvå¯¹æ¶å¼¹åº
                recursiveDoParserContext.getTokenStack().push(token);
                accept(jsonTokenReader);
                return 3;
            }

            throw new MuJsonParserException("unexpected token! index=" + jsonTokenReader.currentIndex());
        }
    }

    private static class ParserState2Handler implements ParserStateHandler&lt;JsonObject&gt;{

        @Override
        public int processInState(JsonTokenReader jsonTokenReader, RecursiveDoParserContext&lt;JsonObject&gt; recursiveDoParserContext) {
            // ç»æï¼ç´æ¥è¿å
            return -1;
        }
    }

    private static class ParserState3Handler implements ParserStateHandler&lt;JsonObject&gt;{

        @Override
        public int processInState(JsonTokenReader jsonTokenReader, RecursiveDoParserContext&lt;JsonObject&gt; recursiveDoParserContext) {
            JsonToken token = jsonTokenReader.peek();

            if(token.getType() == JsonTokenTypeEnum.COLON){
                accept(jsonTokenReader);
                return 4;
            }

            throw new MuJsonParserException("unexpected token! index=" + jsonTokenReader.currentIndex());
        }
    }

    private static class ParserState4Handler implements ParserStateHandler&lt;JsonObject&gt;{

        @Override
        public int processInState(JsonTokenReader jsonTokenReader, RecursiveDoParserContext&lt;JsonObject&gt; recursiveDoParserContext) {
            JsonToken token = jsonTokenReader.peek();

            JsonToken keyToken = recursiveDoParserContext.getTokenStack().pop();
            Assert.assertTrue(keyToken != null &amp;&amp; keyToken.getType() == JsonTokenTypeEnum.STRING,"parse object keyToken not match!");

            // åµå¥çjsonObjectç»æ
            if(token.getType() == JsonTokenTypeEnum.LEFT_BRACE){
                JsonObjectParseStatementMachine jsonObjectParseStatementMachine = new JsonObjectParseStatementMachine(jsonTokenReader);

                JsonObject subJsonObject = jsonObjectParseStatementMachine.parseJsonElement();

                // æé å¥½äºä¸ä¸ªkvå¯¹ï¼key : objï¼
                recursiveDoParserContext.getTargetJsonElement().putKV(keyToken.getContent(), subJsonObject);

                return 5;
            }

            // åµå¥çjsonArrayç»æ
            if(token.getType() == JsonTokenTypeEnum.LEFT_BRACKET){
                // jsonArrayç¶ææº
                JsonArrayParseStatementMachine jsonArrayParseStatementMachine = new JsonArrayParseStatementMachine(jsonTokenReader);

                JsonArray jsonArray = jsonArrayParseStatementMachine.parseJsonElement();
                // æé å¥½äºä¸ä¸ªkvå¯¹ (key ï¼array)
                recursiveDoParserContext.getTargetJsonElement().putKV(keyToken.getContent(), jsonArray);

                return 5;
            }

            // åºç¡ç±»åçvalue
            if(token.getType().isPrimitiveValue()){
                accept(jsonTokenReader);
                recursiveDoParserContext.getTargetJsonElement().putKV(keyToken.getContent(), new JsonPrimitiveStr(token.getContent()));

                return 5;
            }

            throw new MuJsonParserException("unexpected token! index=" + jsonTokenReader.currentIndex());
        }
    }

    private static class ParserState5Handler implements ParserStateHandler&lt;JsonObject&gt;{

        @Override
        public int processInState(JsonTokenReader jsonTokenReader, RecursiveDoParserContext&lt;JsonObject&gt; recursiveDoParserContext) {
            JsonToken token = jsonTokenReader.peek();

            if(token.getType() == JsonTokenTypeEnum.RIGHT_BRACE){
                accept(jsonTokenReader);
                return 2;
            }

            if(token.getType() == JsonTokenTypeEnum.COMMA){
                accept(jsonTokenReader);
                return 6;
            }

            throw new MuJsonParserException("unexpected token! index=" + jsonTokenReader.currentIndex());
        }
    }

    private static class ParserState6Handler implements ParserStateHandler&lt;JsonObject&gt;{

        @Override
        public int processInState(JsonTokenReader jsonTokenReader, RecursiveDoParserContext&lt;JsonObject&gt; recursiveDoParserContext) {
            JsonToken token = jsonTokenReader.peek();

            if(token.getType() == JsonTokenTypeEnum.STRING){
                // ækeyååå¥æ ä¸­ï¼ç¶åç­æé kvå¯¹æ¶å¼¹åº
                recursiveDoParserContext.getTokenStack().push(token);
                accept(jsonTokenReader);
                return 3;
            }

            throw new MuJsonParserException("unexpected token! index=" + jsonTokenReader.currentIndex());
        }
    }
}
</code></pre>
<pre><code class="language-java">public class AbstractJsonParseStatementMachine&lt;T extends JsonElement&gt; {

    protected JsonTokenReader jsonTokenReader;

    protected RecursiveDoParserContext&lt;T&gt; recursiveDoParserContext;

    protected int currentState = 0;

    protected T targetJsonElement;

    protected ParserStateHandler[] stateHandlers;

    public T parseJsonElement(){
        while(jsonTokenReader.hasNextToken()){
            if(currentState == -1){
                // éå°äºåæ³çåéç¬¦å·ï¼éåºtokenè§£æ
                return targetJsonElement;
            }

            if(currentState &gt;= stateHandlers.length){
                // æbug
                throw new MuJsonParserException(String.format("unknown state! currentState=%s",currentState));
            }
            ParserStateHandler targetStateHandler = stateHandlers[currentState];
            
            currentState = targetStateHandler.processInState(jsonTokenReader, recursiveDoParserContext);
        }

        return targetJsonElement;
    }

    protected static void accept(JsonTokenReader jsonTokenReader){
        jsonTokenReader.nextToken();
    }
}
</code></pre>
<pre><code class="language-java">public class RecursiveDoParserContext&lt;T extends JsonElement&gt;  {

    private Stack&lt;JsonToken&gt; tokenStack = new Stack&lt;&gt;();

    private T targetJsonElement;

    public RecursiveDoParserContext(T targetJsonElement) {
        this.targetJsonElement = targetJsonElement;
    }

    public Stack&lt;JsonToken&gt; getTokenStack() {
        return tokenStack;
    }

    public T getTargetJsonElement() {
        return targetJsonElement;
    }
}
</code></pre>
<h5 id="_-15"></h5>
<ul>
<li>å¨è§£ækvå¯¹æ¶ï¼éè¦åå°stringç±»åçkeyææ¶ç¼å­èµ·æ¥ï¼ç­å¾åç»­çvalueç±»åç»æ(objectãarrayæèprimitive)ä¹å®æè§£æåï¼åä¸å¹¶çæ¾å¥ASTä¸­(getTargetJsonElement().putKV)ã</li>
<li>è§£ækvå¯¹çvalueæ¶ï¼å½åçå®ç°æ¯åºäºéå½å®ç°çãå³å½æ ¹æ®å½åtokençç±»ååå»ºä¸ä¸ªæ°çå¯¹åºç±»åçç¶ææºï¼å»éå½çè§£ææ´æ·±ä¸å±çASTç»æã<br>
éå½å®ç°çå¥½å¤æ¯æè·¯ç®åææï¼ä¸ç¨è¿å¤çèèä¸åç±»åç»æä¹é´ç¶æçäºç¸è½¬ç§»ï¼éè¿éå½è§£æå­ASTçæ¹å¼å¤©ç¶çå±è½æäºå¤§éçå¤æåº¦ã<br>
ä½ç¼ºç¹ä¹åæ ·ææ¾ï¼å¨è§£æå±æ¬¡éå¸¸æ·±çjsonå­ç¬¦ä¸²æ¶ï¼éå½çå±æ¬¡è¿æ·±å¯è½ä¼å¯¼è´å½åçº¿ç¨æ æº¢åºï¼è§£æå¤±è´¥ã</li>
</ul>
<h3 id="34-json-arrayæ°ç»ç»æè§£æ">3.4 json arrayæ°ç»ç»æè§£æ</h3>
<p>arrayç»ææ¯ä»¥â[âå¼å¤´ï¼â]âç»å°¾çç»æï¼åé¨å¯ä»¥æ0å°Nä¸ªvalueç±»åçåç´ ,ä»¥éå·ååå²ï¼valueåæ ·æ¯å¯ä»¥æ¯åµå¥çç»æãä¸ä¸é¢objectç»æçè§£æå®ç°æ¹å¼ä¸æ ·ï¼åæ ·æ¯åºäºéå½å®ç°çã</p>
<h5 id="json-arrayæ°ç»ç»æè¯­æ³">json arrayæ°ç»ç»æè¯­æ³</h5>
<pre><code>array
    '[' ws ']'
    '[' elements ']'

elements
    element
    element ',' elements

element
    ws value ws

value
    object
    array
    string
    number
    "true"
    "false"
    "null"
</code></pre>
<p><img src="https://img2024.cnblogs.com/blog/1506329/202602/1506329-20260211200007327-1872691214.png" alt="json_array_parser" loading="lazy"></p>
<h5 id="arrayç»æè§£æç¶æèªå¨æºç¤ºæå¾">arrayç»æè§£æç¶æèªå¨æºç¤ºæå¾</h5>
<p><img src="https://img2024.cnblogs.com/blog/1506329/202602/1506329-20260211200016319-1527985884.png" alt="json_array_state_machine" loading="lazy"></p>
<h5 id="arrayç»æè§£æç¶æèªå¨æºéå½å®ç°éå½çæ¬">arrayç»æè§£æç¶æèªå¨æºéå½å®ç°ï¼éå½çæ¬ï¼</h5>
<pre><code class="language-java">/**
 * åºäºéå½å®ç°ç arrayç±»åè¯­æ³è§£æç¶æèªå¨æº
 * */
public class JsonArrayParseStatementMachine extends AbstractJsonParseStatementMachine&lt;JsonArray&gt; {

    public JsonArrayParseStatementMachine(JsonTokenReader jsonTokenReader) {
        this.jsonTokenReader = jsonTokenReader;
        this.targetJsonElement = new JsonArray();
        this.recursiveDoParserContext = new RecursiveDoParserContext&lt;&gt;(this.targetJsonElement);
        stateHandlers = new ParserStateHandler[]{
            new ParserState0Handler(),new ParserState1Handler(),new ParserState2Handler(),
            new ParserState3Handler(), new ParserState4Handler()
        };
    }

    private static class ParserState0Handler implements ParserStateHandler&lt;JsonArray&gt;{

        @Override
        public int processInState(JsonTokenReader jsonTokenReader, RecursiveDoParserContext&lt;JsonArray&gt; recursiveDoParserContext) {
            JsonToken token = jsonTokenReader.peek();

            if(token.getType() != JsonTokenTypeEnum.LEFT_BRACKET){
                throw new MuJsonParserException("unexpected token! index=" + jsonTokenReader.currentIndex());
            }

            accept(jsonTokenReader);
            return 1;
        }
    }

    private static class ParserState1Handler implements ParserStateHandler&lt;JsonArray&gt;{

        @Override
        public int processInState(JsonTokenReader jsonTokenReader, RecursiveDoParserContext&lt;JsonArray&gt; recursiveDoParserContext) {
            JsonToken token = jsonTokenReader.peek();

            if(token.getType() == JsonTokenTypeEnum.RIGHT_BRACKET){
                accept(jsonTokenReader);
                return 2;
            }

            // åµå¥çjsonObjectç»æ
            if(token.getType() == JsonTokenTypeEnum.LEFT_BRACE){
                JsonObjectParseStatementMachine jsonObjectParseStatementMachine = new JsonObjectParseStatementMachine(jsonTokenReader);

                JsonObject subJsonObject = jsonObjectParseStatementMachine.parseJsonElement();

                // addä¸ä¸ªobj
                recursiveDoParserContext.getTargetJsonElement().addElement(subJsonObject);

                return 3;
            }

            // åµå¥çjsonArrayç»æ
            if(token.getType() == JsonTokenTypeEnum.LEFT_BRACKET){
                // jsonArrayç¶ææº
                JsonArrayParseStatementMachine jsonArrayParseStatementMachine = new JsonArrayParseStatementMachine(jsonTokenReader);

                JsonArray jsonArray = jsonArrayParseStatementMachine.parseJsonElement();

                // addä¸ä¸ªarray
                recursiveDoParserContext.getTargetJsonElement().addElement(jsonArray);

                return 3;
            }

            // åºç¡ç±»åçvalue
            if(token.getType().isPrimitiveValue()){
                accept(jsonTokenReader);
                recursiveDoParserContext.getTargetJsonElement().addElement(new JsonPrimitiveStr(token.getContent()));

                return 3;
            }

            throw new MuJsonParserException("unexpected token! index=" + jsonTokenReader.currentIndex());
        }
    }

    private static class ParserState2Handler implements ParserStateHandler&lt;JsonArray&gt;{

        @Override
        public int processInState(JsonTokenReader jsonTokenReader, RecursiveDoParserContext&lt;JsonArray&gt; recursiveDoParserContext) {
            // ç»æï¼ç´æ¥è¿å
            return -1;
        }
    }

    private static class ParserState3Handler implements ParserStateHandler&lt;JsonArray&gt;{

        @Override
        public int processInState(JsonTokenReader jsonTokenReader, RecursiveDoParserContext&lt;JsonArray&gt; recursiveDoParserContext) {
            JsonToken token = jsonTokenReader.peek();

            if(token.getType() == JsonTokenTypeEnum.RIGHT_BRACKET){
                accept(jsonTokenReader);
                return 2;
            }

            if(token.getType() == JsonTokenTypeEnum.COMMA){
                accept(jsonTokenReader);
                return 4;
            }

            throw new MuJsonParserException("unexpected token! index=" + jsonTokenReader.currentIndex());
        }
    }

    private static class ParserState4Handler implements ParserStateHandler&lt;JsonArray&gt;{

        @Override
        public int processInState(JsonTokenReader jsonTokenReader, RecursiveDoParserContext&lt;JsonArray&gt; recursiveDoParserContext) {
            JsonToken token = jsonTokenReader.peek();

            // åµå¥çjsonObjectç»æ
            if(token.getType() == JsonTokenTypeEnum.LEFT_BRACE){
                JsonObjectParseStatementMachine jsonObjectParseStatementMachine = new JsonObjectParseStatementMachine(jsonTokenReader);

                JsonObject subJsonObject = jsonObjectParseStatementMachine.parseJsonElement();

                // addä¸ä¸ªobj
                recursiveDoParserContext.getTargetJsonElement().addElement(subJsonObject);

                return 3;
            }

            // åµå¥çjsonArrayç»æ
            if(token.getType() == JsonTokenTypeEnum.LEFT_BRACKET){
                // jsonArrayç¶ææº
                JsonArrayParseStatementMachine jsonArrayParseStatementMachine = new JsonArrayParseStatementMachine(jsonTokenReader);

                JsonArray jsonArray = jsonArrayParseStatementMachine.parseJsonElement();

                // addä¸ä¸ªarray
                recursiveDoParserContext.getTargetJsonElement().addElement(jsonArray);

                return 3;
            }

            // åºç¡ç±»åçvalue
            if(token.getType().isPrimitiveValue()){
                accept(jsonTokenReader);
                recursiveDoParserContext.getTargetJsonElement().addElement(new JsonPrimitiveStr(token.getContent()));

                return 3;
            }

            throw new MuJsonParserException("unexpected token! index=" + jsonTokenReader.currentIndex());
        }
    }
}
</code></pre>
<h5 id="_-16"></h5>
<ul>
<li>ç¸æ¯objectç»æçç¶æèªå¨æºï¼arrayç»æçç¶æèªå¨æºåæ¾å¾æ¯è¾ç®åãåæ ·å¨éå°å¤æç±»åçç»ææ¶ï¼éè¿å½åtokençç±»åéå½çåå»ºä¸ä¸ªæ°çç¶ææºå»æé åºå­AST(JsonElement)ï¼ç¶åå å¥å°å½åJsonArrayä¸­(getTargetJsonElement().addElement)ã</li>
</ul>
<h2 id="4-åºäºastçæbeauty-jsonå­ç¬¦ä¸²">4. åºäºASTçæbeauty jsonå­ç¬¦ä¸²</h2>
<p>ç°å¨æä»¬å·²ç»å®ç°äºjsonçè¯æ³è§£æåè¯­æ³è§£æï¼å¯ä»¥å°ä¸ä¸ªåå§çåæ³çjsonå­ç¬¦ä¸²æ­£ç¡®çè½¬æ¢æå¯¹åºçASTäºã<br>
æ¿å°ASTä¹åçè®ºä¸å¯ä»¥åå¾å¤äºæï¼æ¯å¦å°jsonä¸²ååºååä¸ºjavaå¯¹è±¡ãè¿éæä»¬å®ç°ä¸ä¸ª<strong>æ´ç®åä¹æ´ç´è§çåè½</strong>ï¼å³å°åå§çjsonå­ç¬¦ä¸²æ ¼å¼åæç¼©è¿è¯å¥½ï¼æ´ç¾è§ï¼å¯è¯»æ§æ´ä½³çbeautyå­ç¬¦ä¸²ã</p>
<h5 id="çææ ¼å¼ååçbeauty-jsonå­ç¬¦ä¸²å®ç°">çææ ¼å¼ååçbeauty jsonå­ç¬¦ä¸²å®ç°</h5>
<pre><code class="language-java">public abstract class JsonElement {

    private static final String BEAUTY_INDENT = "    ";  // åä¸ªç©ºæ ¼ç¼©è¿
    private static final String BEAUTY_KV_INDENT = " ";  // kvå¤ä¸ä¸ªç©ºæ ¼
    private static final String BEAUTY_LINE_BREAK = "\n"; // æ¢è¡åå²

    /**
     * çæç¾ååçbeautyå­ç¬¦ä¸²
     * */
    public String buildBeautyJsonString(){
        StringBuilder jsonStringBuilder = new StringBuilder();

        buildJsonString(this,jsonStringBuilder,"",BEAUTY_LINE_BREAK,BEAUTY_INDENT,BEAUTY_KV_INDENT);

        return jsonStringBuilder.toString();
    }

    private static void buildJsonString(JsonElement jsonElement, StringBuilder jsonStringBuilder, String currentIndent,
                                        String lineBreak, String indent, String kvIndent){
        if(jsonElement instanceof JsonPrimitiveStr){
            jsonStringBuilder.append(jsonElement);
            return;
        }

        if(jsonElement instanceof JsonArray){
            JsonArray jsonArray  = (JsonArray) jsonElement;
            jsonStringBuilder.append("[").append(lineBreak);
            List&lt;JsonElement&gt; jsonArrayList = jsonArray.getArray();
            int i=0;
            for(JsonElement arrayItem : jsonArrayList){
                jsonStringBuilder.append(currentIndent).append(indent);
                // éå½ä¸å»ï¼currentIndentå¤ç¼©è¿ä¸å±
                buildJsonString(arrayItem,jsonStringBuilder,currentIndent + indent,lineBreak,indent,kvIndent);
                if(i != jsonArrayList.size()-1){
                    jsonStringBuilder.append(",");
                }

                jsonStringBuilder.append(lineBreak);
                i++;
            }

            jsonStringBuilder.append(currentIndent).append("]");
        }

        if(jsonElement instanceof JsonObject){
            JsonObject jsonObject  = (JsonObject) jsonElement;
            jsonStringBuilder.append("{").append(lineBreak);

            Map&lt;String, JsonElement&gt; objMap = jsonObject.getObjMap();

            int i=0;
            for(Map.Entry&lt;String, JsonElement&gt; entry : objMap.entrySet()){
                String key = entry.getKey();
                JsonElement value = entry.getValue();

                // keyæ¯stringç±»åçï¼å­é¢ééèªå¸¦åå¼å·ç
                jsonStringBuilder.append(currentIndent).append(indent).append(key).append(kvIndent).append(":").append(kvIndent);
                // éå½ä¸å»ï¼currentIndentå¤ç¼©è¿ä¸å±
                buildJsonString(value,jsonStringBuilder,  currentIndent + indent, lineBreak,indent,kvIndent);

                if(i != objMap.size()-1){
                    jsonStringBuilder.append(",");
                }

                jsonStringBuilder.append(lineBreak);
                i++;
            }

            jsonStringBuilder.append(currentIndent).append("}");
        }
    }
}
</code></pre>
<h5 id="_-17"></h5>
<ul>
<li>ä»æºç å®ç°ä¸­å¯ä»¥çå°ï¼è¾åºç¾ååçbeautyå­ç¬¦ä¸²æ¬è´¨ä¸å°±æ¯ä¸ä¸ªéå¯¹ASTæ å½¢ç»æç<strong>æ·±åº¦ä¼åéå</strong>ï¼åªéè¦æ³¨æéçéå½æ·±åº¦å¨æè°æ´ç¼©è¿é¿åº¦å³å¯ã</li>
<li>æ ¼å¼åjsonçæ¹å¼å¤ç§å¤æ ·ï¼åjacksonè¿æ ·æççjsonå¤çæ¡æ¶ä¸­æä¾äºå¤§éçéç½®åæ°åè®¸ç¨æ·ä»¥ææ³è¦çæ¹å¼éå¸¸çµæ´»ççææéæ ¼å¼çjsonå­ç¬¦ä¸²ãæä»¬è¿éçå®ç°ä¸å¤çµæ´»ï¼æ§è½ä¹ä¸å¤é«æï¼ä»ä»æ¯èµ·å°ä¸ä¸ªæç å¼ççä½ç¨ã</li>
</ul>
<h5 id="json-beautyç¤ºæå¾">json beautyç¤ºæå¾</h5>
<p><img src="https://img2024.cnblogs.com/blog/1506329/202602/1506329-20260211200026283-104525624.png" alt="json_beauty_demo" loading="lazy"></p>
<h2 id="5-æµå¼çjsonè¯æ³è§£æ">5. æµå¼çjsonè¯æ³è§£æ</h2>
<p>æªæ­¢ç®åæä»¬å·²ç»å®ç°äºjsonå­ç¬¦ä¸²çè§£æåè½ï¼ä½è¿å­å¨ä¸¤ä¸ªä¸¥éçæ§è½é®é¢éè¦ä¼åã</p>
<ul>
<li>é¦åæ¯ç®åçè¯æ³åæå¨æ¯ä¸æ¬¡æ§çè§£æåºææçtokenåï¼åäº¤ç»è¯­æ³åæå»è§£æçãèè¿å­å¨ä¸ä¸ªéæ£ï¼å ä¸ºå¾å¤æ¶åæä»¬å®éè§£æçå¹¶ä¸æ»æ¯ä¸ä¸ªåæ³çjsonå­ç¬¦ä¸²ã<br>
å¦æä¸ä¸ªéå¸¸é¿çä¸åæ³çjsonå­ç¬¦ä¸²ï¼å¨è¯æ³åæé¶æ®µçä¸åºä»»ä½çé®é¢(æ¯å¦å¨åæ³çä»¥<code>{</code>å¼å¤´ç jsonå­ç¬¦ä¸²çåé¢è¯¯è¿½å ä¸ä¸ª123)ï¼èç´å°è¯­æ³åææåç°å­å¨è¯­æ³éè¯¯ï¼é£ä¹è¯æ³åæé¶æ®µè±è´¹çè®¡ç®èµæºå°±ç»ç»æµªè´¹äºã</li>
<li>å¦æè½å¤å¨å®æ´çè¯æ³åæå¤ççè¿ç¨ä¸­æååç°è¯­æ³éè¯¯å°±è½é¿åè¿ä¸ªé®é¢ãä½å®ç°è¿ä¸ªåè½ä¸éè¦å°è¯æ³åæåè¯­æ³åæçåè½è¦åå¨ä¸èµ·ï¼èæ¯å°è¯æ³åæå¨æ¹é ææéå è½½çæµå¼è§£æå³å¯ã<br>
æµå¼çè¯æ³åæè½å¤å¨è¯­æ³è§£æå¨éè¦è¯»åtokenæ¶æè§¦åè¯æ³åæï¼å¹¶ä¸ä¸æ¬¡å¯ä»¥åªæéçå®æ´è§£æåºä¸ä¸ªå®æ´çtokenäº¤ç»parserã</li>
<li>æäºæµå¼çè¯æ³åæï¼åä¸é¢ä¸¾å¾ä¾å­ï¼å¨åæ³çéå¸¸é¿çjsonå­ç¬¦ä¸²çåé¢è¯¯å ä¸ä¸ª123çåºæ¯ï¼ä¾¿è½å¤å¾æ©çå°±åç°è¯­æ³éè¯¯ï¼ç»æè§£æè¿ç¨ã</li>
</ul>
<h5 id="æµå¼çè¯æ³åæè§£æå®ç°">æµå¼çè¯æ³åæè§£æå®ç°</h5>
<pre><code class="language-java">public class StreamJsonLexer extends AbstractJsonLexer{

    public StreamJsonLexer(String jsonString) {
        super(jsonString);
    }

    public JsonToken doLex(){
        if(doLexContext.currentIndex &gt;= jsonStringArray.length){
            return new JsonToken(JsonTokenTypeEnum.EOF);
        }

        while(true) {
            char ch = jsonStringArray[doLexContext.currentIndex];

            // æ¯ä¸æ¬¡å°è¯è§£æä¸ä¸ªå®æ´çtokenåï¼é½æ¯ç¶æ0
            switch (ch) {
                case '{':
                    doLexContext.currentIndex++;
                    return new JsonToken(JsonTokenTypeEnum.LEFT_BRACE);
                case '}':
                    doLexContext.currentIndex++;
                    return new JsonToken(JsonTokenTypeEnum.RIGHT_BRACE);
                case '[':
                    doLexContext.currentIndex++;
                    return new JsonToken(JsonTokenTypeEnum.LEFT_BRACKET);
                case ']':
                    doLexContext.currentIndex++;
                    return new JsonToken(JsonTokenTypeEnum.RIGHT_BRACKET);
                case ',':
                    doLexContext.currentIndex++;
                    return new JsonToken(JsonTokenTypeEnum.COMMA);
                case ':':
                    doLexContext.currentIndex++;
                    return new JsonToken(JsonTokenTypeEnum.COLON);
                case '"':
                    return parseString(jsonStringArray, doLexContext);
                case 't':
                    // å°è¯è§£ætrueå³é®å­
                    return parseTrueKeyword(jsonStringArray, doLexContext);
                case 'f':
                    // å°è¯è§£æfalseå³é®å­
                    return parseFalseKeyword(jsonStringArray, doLexContext);
                case 'n':
                    // å°è¯è§£ænullå³é®å­
                    return parseNullKeyword(jsonStringArray, doLexContext);
                default:
                    // èµ°å¶å®case
                    break;
            }

            // å¶å®case
            if (CommonStringUtil.is0_9(ch) || ch == '-') {
                // numberè§£æ
                return parseNumber(jsonStringArray, doLexContext);
            } else if (CommonStringUtil.isWhitespace(ch)) {
                // whiteSpace ç´æ¥è·³è¿
                doLexContext.currentIndex++;
            } else{
                throw new MuJsonParserException("unexpected character: " + ch + ",charIndex=" + doLexContext.currentIndex);
            }
        }
    }
}
</code></pre>
<pre><code class="language-java">public class StreamJsonTokenReader implements JsonTokenReader {

    private int currentIndex;
    private final StreamJsonLexer streamJsonLexer;

    private JsonToken peekToken;
    private boolean hasNextToken;

    public StreamJsonTokenReader(String jsonString) {
        this.currentIndex = 0;
        this.hasNextToken = true;
        this.streamJsonLexer = new StreamJsonLexer(jsonString);
    }

    @Override
    public boolean hasNextToken() {
        return hasNextToken;
    }

    @Override
    public JsonToken nextToken() {
        JsonToken nextToken = getNextToken();
        if(nextToken.getType() == JsonTokenTypeEnum.EOF){
            hasNextToken = false;
        }

        currentIndex++;
        return nextToken;
    }

    private JsonToken getNextToken() {
        if(peekToken != null){
            JsonToken nextToken = peekToken;
            this.peekToken = null;
            return nextToken;
        }

        return streamJsonLexer.doLex();
    }

    @Override
    public JsonToken peek() {
        if(peekToken == null) {
            peekToken = streamJsonLexer.doLex();
        }

        return peekToken;
    }

    @Override
    public int currentIndex() {
        return currentIndex;
    }
}
</code></pre>
<h5 id="_-18"></h5>
<ul>
<li>æµå¼çè¯æ³è§£æå¨StreamJsonLexerçæ ¸å¿å·¥ä½åçä¸ä¹åå·²ç»å®ç°çéæçStaticJsonLexerå«æ äºè´ï¼å¶åºå±ä¾èµçä»£ç é½æ¯ç¸åçã<br>
æå¤§çåºå«å¨äºè§£æåºä¸ä¸ªå®æ´çtokenåï¼å¨ç»´æ¤å½åå­ç¬¦æµä¸æ çåæ¶æåç»æ­¢äºåç»­çè¯æ³åæãå¨StreamJsonTokenReaderè°ç¨nextTokenæ¶ï¼æä¼æéçæ°æ§è§£ææ°çtokenå¹¶è¿åã</li>
<li>æµå¼çè¯æ³è§£ææ¯«æ çé®æ¯æ§è½æ´å¥½çï¼ä¸»æµçjsonè§£æå¨ä¹é½æ¯æµå¼çè§£æãä½éæçè¯æ³è§£ææ´å®¹æçè§£ï¼ä¹æ´å®¹æè°è¯ï¼æä»¥å¨ä¸å¼å§ä»ç»è¯æ³åæåçæ¶ï¼æä»¬åå®ç°äºéæçè¯æ³åæï¼å°å¶ä½ä¸ºåºç¡ï¼ç¥å¾®çæ¹é åä¾¿å®ç°äºæµå¼çè¯æ³è§£æã</li>
</ul>
<h2 id="6-åºäºå æ å®ç°çjsonè¯­æ³è§£æ">6. åºäºå æ å®ç°çjsonè¯­æ³è§£æ</h2>
<p>ç¬¬äºä¸ªæ§è½é®é¢åæ¯åºäºéå½å®ç°çjsonè¯­æ³è§£æå¨åéäºè¾å°ççº¿ç¨æ ç©ºé´ï¼æ æ³å¤çåµå¥å±çº§éå¸¸æ·±çjsonä¸²ã</p>
<ul>
<li>æä»¬ç¥éï¼ä¸ä¸ªæ®éçjavaè¿ç¨éå¸¸é½å«æå¤§éççº¿ç¨ï¼å æ­¤ç»æ¯ä¸ªçº¿ç¨åéççº¿ç¨æ éå¸¸é½æ¯è¾å°ï¼æ¯å¦1mãèéå½å®ç°çè¯­æ³è§£æå¨ï¼å¨æ¯æ·±å¥ä¸ä¸ªå±æ¬¡çjsonå­æ æ¶ä¾¿ä¼åæ ä¸åå¥ä¸äºå±é¨åéï¼å½æç«¯æåµä¸è¦è§£æçjsonä¸²å±æ¬¡è¿æ·±æ¶ï¼åä¼åºç°StackOverflowErrorï¼å¯¼è´è§£æå¤±è´¥ã</li>
<li>èåå­çå éå¸¸é½æ¯ä»¥GBä¸ºåä½çï¼å æ­¤å¦ææéå½ä¸­éå¼åæ çè§£æé»è¾è½¬æ¢ä¸ºç­ä»·çæ¾å¼åºäºåå­å çåæ ï¼åå¯ä»¥å¾å¥½çè§£å³çº¿ç¨æ è¿å°æ æ³å¤çå¤§æ·±åº¦jsonä¸²çé®é¢äºã</li>
</ul>
<h5 id="åºäºå æ çè¯­æ³è§£æç¶æèªå¨æºç¤ºæå¾">åºäºå æ çè¯­æ³è§£æç¶æèªå¨æºç¤ºæå¾</h5>
<p><img src="https://img2024.cnblogs.com/blog/1506329/202602/1506329-20260211200035364-62927704.png" alt="stack_base_json_parser_state_machine" loading="lazy"></p>
<ul>
<li>ä¸ºäºå°½å¯è½çå°ç¶æè½¬ç§»ä¸éå½å®ç°çé»è¾ä¿æä¸è´ï¼å æ çç¶æèªå¨æºä¾ç¶åä½äºä¸¤ä¸ªç¶æ(obj-0åarr-0)ã</li>
<li>å¯ä»¥çå°ï¼åºäºå æ çç¶æèªå¨æºä¼å¨arrayä¸objectçè§£æç¶æä¸­äºç¸è½¬ç§»ï¼ç¸å½äºå°ä¹åéå½å®ç°çåä¸ªç¶æèªå¨æºçå­ç¶æå¾åå¹¶ä¸ºäºä¸ä¸ªå¤§èå¨çç¶æèªå¨æºã</li>
<li>åæ¶ï¼ç±äºè¿æ¶åäºæå¨æ¨¡æçå¥æ ä¸åºæ å¤ç(obj-2ï¼obj-4ï¼arr-1ï¼arr-2)ï¼å æ­¤æ´ä½çå¤æåº¦æ¯èµ·éå½å®ç°è¦é«åºä¸ä¸ªéçº§ã</li>
</ul>
<h5 id="jsonæ ¹èç¹è§£æç¶æèªå¨æºå®ç°æºç ">jsonæ ¹èç¹è§£æç¶æèªå¨æºå®ç°æºç </h5>
<pre><code class="language-java">/**
 * åºäºå æ çï¼ééå½çjsonè¯­æ³è§£æå¨
 * */
public class StackBaseJsonParser extends JsonParser {

    private final JsonParseStack parseStack = new JsonParseStack();

    private StackBaseJsonParserStatusEnum currentStatus;

    public StackBaseJsonParser(JsonTokenReader tokenReader) {
        super(tokenReader);

        this.currentStatus = StackBaseJsonParserStatusEnum.START_PARSE;
    }

    private void accept(){
        jsonTokenReader.nextToken();
    }

    @Override
    public JsonElement doParse() {
        while(jsonTokenReader.hasNextToken()){
            JsonToken token = jsonTokenReader.peek();

            if(currentStatus == StackBaseJsonParserStatusEnum.END_PARSE){
                break;
            }

            switch (currentStatus){
                case START_PARSE:
                    processInStartParse(token);
                    break;
                case PARSE_OBJECT_0:
                    processInParseObject0(token);
                    break;
                case PARSE_OBJECT_1:
                    processInParseObject1(token);
                    break;
                case PARSE_OBJECT_2:
                    processInParseObject2(token);
                    break;
                case PARSE_OBJECT_3:
                    processInParseObject3(token);
                    break;
                case PARSE_OBJECT_4:
                    processInParseObject4(token);
                    break;
                case PARSE_OBJECT_5:
                    processInParseObject5(token);
                    break;
                case PARSE_OBJECT_6:
                    processInParseObject6(token);
                    break;
                case PARSE_ARR_0:
                    processInParseArr0(token);
                    break;
                case PARSE_ARR_1:
                    processInParseArr1(token);
                    break;
                case PARSE_ARR_2:
                    processInParseArr2(token);
                    break;
                case PARSE_ARR_3:
                    processInParseArr3(token);
                    break;
                default:
                    throw new MuJsonParserException("Unexpected currentStatus: " + currentStatus);
            }
        }

        // å¦æjsonå­ç¬¦ä¸²æ¯åæ³çï¼é£ä¹æåæ é¡¶å¿ç¶æ¯æä¸å¯ä¸çä¸ä¸ªJsonElementç±»åçå¯¹è±¡
        if(this.parseStack.size() != 1){
            throw new MuJsonParserException("after parseï¼stack element size &gt; 1! stack=" + this.parseStack);
        }

        JsonParseStackValue object = this.parseStack.pop();
        return (JsonElement) object.getValue();
    }

    private void processInStartParse(JsonToken token){
        if (token.getType() == JsonTokenTypeEnum.LEFT_BRACE) {
            this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_OBJECT_0;
            this.parseStack.push(new JsonParseStackValue(JsonParseStackValueTypeEnum.JSON_OBJECT,new JsonObject()));
            return;
        }

        if (token.getType() == JsonTokenTypeEnum.LEFT_BRACKET) {
            this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_ARR_0;
            this.parseStack.push(new JsonParseStackValue(JsonParseStackValueTypeEnum.JSON_ARRAY,new JsonArray()));
            return;
        }

        if (token.getType().isPrimitiveValue()) {
            accept();
            this.currentStatus = StackBaseJsonParserStatusEnum.END_PARSE;
            this.parseStack.push(new JsonParseStackValue(JsonParseStackValueTypeEnum.JSON_PRIMITIVE,new JsonPrimitiveStr(token.getContent())));
            return;
        }

        // ç¬¬ä¸ä¸ªtokenï¼ä¸å±äºjsonè§åçf(1)éå
        throw new MuJsonParserException("unexpected start json token! token=" + jsonTokenReader.currentIndex());
    }

    private void processInParseObject0(JsonToken token){
        if(token.getType() != JsonTokenTypeEnum.LEFT_BRACE){
            throw new MuJsonParserException("unexpected token! index=" + jsonTokenReader.currentIndex());
        }

        accept();

        this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_OBJECT_1;
    }

    private void processInParseObject1(JsonToken token){
        if(token.getType() == JsonTokenTypeEnum.RIGHT_BRACE){
            this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_OBJECT_2;
            return;
        }

        if(token.getType() == JsonTokenTypeEnum.STRING){
            // ækeyååå¥æ ä¸­ï¼ç¶åç­æé kvå¯¹æ¶å¼¹åº
            this.parseStack.push(new JsonParseStackValue(JsonParseStackValueTypeEnum.JSON_KEY,token));
            accept();
            this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_OBJECT_3;
            return;
        }

        throw new MuJsonParserException("unexpected token! index=" + jsonTokenReader.currentIndex());
    }

    private void processInParseObject2(JsonToken token){
        // éå°'}'æä¼è¿æ¥
        if(token.getType() != JsonTokenTypeEnum.RIGHT_BRACE){
            throw new MuJsonParserException("unexpected token! index=" + jsonTokenReader.currentIndex());
        }else{
            accept();
        }

        // å½åæ é¡¶å¿å®æ¯JsonObjectï¼åå°å¶å¼¹åºï¼ç¶åçæ é¡¶çåç´ ç±»åå¤æ­
        JsonParseStackValue currentJsonObjectStackValue = this.parseStack.popAndCheck(JsonParseStackValueTypeEnum.JSON_OBJECT);
        if(this.parseStack.isEmpty()){
            // è¯´ææ¯rootçJsonObjectè§£æå®äºï¼åæ¨åå»ç´æ¥è¿å
            this.parseStack.push(currentJsonObjectStackValue);
            this.currentStatus = StackBaseJsonParserStatusEnum.END_PARSE;
            return;
        }

        JsonObject currentJsonObject = (JsonObject) currentJsonObjectStackValue.getValue();

        JsonParseStackValueTypeEnum topObjType = this.parseStack.peekTopType();

        if(topObjType == JsonParseStackValueTypeEnum.JSON_KEY){
            // å¦ææ¯json_keyï¼è¯´ææ¯å½åjsonObjectæ¯ç¶objectçä¸ä¸ªk/vé¡¹ä¸­çvalueã
            JsonParseStackValue keyStackValue = this.parseStack.popAndCheck(JsonParseStackValueTypeEnum.JSON_KEY);
            JsonToken keyJsonToken = (JsonToken) keyStackValue.getValue();
            JsonParseStackValue parentObject = this.parseStack.peekAndCheck(JsonParseStackValueTypeEnum.JSON_OBJECT);

            // å°å½åk/vé¡¹éå å¨ç¶objectä¸
            ((JsonObject)parentObject.getValue()).putKV(keyJsonToken.getContent(), currentJsonObject);

            // åºäºä¸ä¸ä¸ªtokenå¤æ­ç¶æè·³è½¬
            JsonToken nextJsonToken = this.jsonTokenReader.peek();
            if(nextJsonToken.getType() == JsonTokenTypeEnum.COMMA){
                this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_OBJECT_5;
                return;
            }else if (nextJsonToken.getType() == JsonTokenTypeEnum.RIGHT_BRACE){
                this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_OBJECT_2;
                return;
            }else{
                throw new MuJsonParserException("unexpected token! index=" + (jsonTokenReader.currentIndex()+1));
            }

        }else if(topObjType == JsonParseStackValueTypeEnum.JSON_ARRAY){
            // è¯´æå½åjsonObjectæ¯jsonArrayçä¸ä¸ªåç´ 

            JsonParseStackValue parentArr = this.parseStack.peekAndCheck(JsonParseStackValueTypeEnum.JSON_ARRAY);
            ((JsonArray)parentArr.getValue()).addElement(currentJsonObject);

            // åºäºä¸ä¸ä¸ªtokenå¤æ­ç¶æè·³è½¬
            JsonToken nextJsonToken = this.jsonTokenReader.peek();
            if(nextJsonToken.getType() == JsonTokenTypeEnum.COMMA){
                this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_ARR_3;
                return;
            }else if (nextJsonToken.getType() == JsonTokenTypeEnum.RIGHT_BRACKET){
                this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_ARR_2;
                return;
            }else{
                throw new MuJsonParserException("unexpected token! index=" + (jsonTokenReader.currentIndex()+1));
            }
        }else{
            // å«çæåµé½è¯´ææé®é¢ï¼ä¸æ¯åæ³çjson
            throw new MuJsonParserException("unexpected token! index=" + jsonTokenReader.currentIndex());
        }
    }

    private void processInParseObject3(JsonToken token){
        if(token.getType() == JsonTokenTypeEnum.COLON){
            accept();
            this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_OBJECT_4;
            return;
        }

        throw new MuJsonParserException("unexpected token! index=" + jsonTokenReader.currentIndex());
    }

    private void processInParseObject4(JsonToken token){
        // åµå¥çjsonObjectç»æ
        if(token.getType() == JsonTokenTypeEnum.LEFT_BRACE){
            // åç°'{'ï¼æ ä¸æ¨è¿ä¸ä¸ªJsonObject
            this.parseStack.push(new JsonParseStackValue(JsonParseStackValueTypeEnum.JSON_OBJECT, new JsonObject()));
            accept();
            this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_OBJECT_1;
            return;
        }

        // åµå¥çjsonArrayç»æ
        if(token.getType() == JsonTokenTypeEnum.LEFT_BRACKET){
            // åç°'['ï¼æ ä¸æ¨è¿ä¸ä¸ªJsonArr
            this.parseStack.push(new JsonParseStackValue(JsonParseStackValueTypeEnum.JSON_ARRAY, new JsonArray()));
            accept();
            this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_ARR_1;
            return;
        }

        // åºç¡ç±»åçvalue
        if(token.getType().isPrimitiveValue()){
            JsonParseStackValue jsonKeyToken = this.parseStack.popAndCheck(JsonParseStackValueTypeEnum.JSON_KEY);

            JsonToken keyToken  = (JsonToken) jsonKeyToken.getValue();
            Assert.assertTrue(keyToken.getType() == JsonTokenTypeEnum.STRING,"parse object keyToken not match!");

            // è·åæ é¡¶çjsonObjectå¯¹è±¡ï¼è®¾ç½®k/v
            JsonParseStackValue topJsonObject = this.parseStack.peekAndCheck(JsonParseStackValueTypeEnum.JSON_OBJECT);

            ((JsonObject) topJsonObject.getValue()).putKV(keyToken.getContent(), new JsonPrimitiveStr(token.getContent()));

            accept();

            // åºäºä¸ä¸ä¸ªtokenå¤æ­ç¶æè·³è½¬
            JsonToken nextJsonToken = this.jsonTokenReader.peek();
            if(nextJsonToken.getType() == JsonTokenTypeEnum.COMMA){
                this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_OBJECT_5;
                return;
            }else if (nextJsonToken.getType() == JsonTokenTypeEnum.RIGHT_BRACE){
                this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_OBJECT_2;
                return;
            }else{
                throw new MuJsonParserException("unexpected token! index=" + (jsonTokenReader.currentIndex()+1));
            }
        }

        throw new MuJsonParserException("unexpected token! index=" + jsonTokenReader.currentIndex());
    }

    private void processInParseObject5(JsonToken token){
        if(token.getType() == JsonTokenTypeEnum.COMMA){
            accept();
            this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_OBJECT_6;
            return;
        }

        throw new MuJsonParserException("unexpected token! index=" + jsonTokenReader.currentIndex());
    }

    private void processInParseObject6(JsonToken token){
        if(token.getType() == JsonTokenTypeEnum.STRING){
            // ækeyååå¥æ ä¸­ï¼ç¶åç­æé kvå¯¹æ¶å¼¹åº
            this.parseStack.push(new JsonParseStackValue(JsonParseStackValueTypeEnum.JSON_KEY,token));
            accept();
            this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_OBJECT_3;
            return;
        }

        throw new MuJsonParserException("unexpected token! index=" + jsonTokenReader.currentIndex());
    }

    private void processInParseArr0(JsonToken token){
        if(token.getType() == JsonTokenTypeEnum.LEFT_BRACKET){
            accept();
            this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_ARR_1;
            return;
        }

        throw new MuJsonParserException("unexpected token! index=" + jsonTokenReader.currentIndex());
    }

    private void processInParseArr1(JsonToken token){
        if(token.getType() == JsonTokenTypeEnum.RIGHT_BRACKET){
            this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_ARR_2;
            return;
        }

        // åµå¥çjsonObjectç»æ
        if(token.getType() == JsonTokenTypeEnum.LEFT_BRACE){
            // åç°'{'ï¼æ ä¸æ¨è¿ä¸ä¸ªJsonObject
            this.parseStack.push(new JsonParseStackValue(JsonParseStackValueTypeEnum.JSON_OBJECT, new JsonObject()));
            accept();
            this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_OBJECT_1;
            return;
        }

        // åµå¥çjsonArrayç»æ
        if(token.getType() == JsonTokenTypeEnum.LEFT_BRACKET){
            // åç°'['ï¼æ ä¸æ¨è¿ä¸ä¸ªJsonArr
            this.parseStack.push(new JsonParseStackValue(JsonParseStackValueTypeEnum.JSON_ARRAY, new JsonArray()));
            accept();
            this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_ARR_1;
            return;
        }

        // åºç¡ç±»åçvalue
        if(token.getType().isPrimitiveValue()){
            // è·åæ é¡¶çjsonArrå¯¹è±¡ï¼æ·»å ä¸ä¸ªåç´ 
            JsonParseStackValue topJsonArr = this.parseStack.peekAndCheck(JsonParseStackValueTypeEnum.JSON_ARRAY);

            ((JsonArray) topJsonArr.getValue()).addElement(new JsonPrimitiveStr(token.getContent()));

            accept();

            // åºäºä¸ä¸ä¸ªtokenå¤æ­ç¶æè·³è½¬
            JsonToken nextJsonToken = this.jsonTokenReader.peek();
            if(nextJsonToken.getType() == JsonTokenTypeEnum.COMMA){
                this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_ARR_3;
                return;
            }else if (nextJsonToken.getType() == JsonTokenTypeEnum.RIGHT_BRACKET){
                this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_ARR_2;
                return;
            }else{
                throw new MuJsonParserException("unexpected token! index=" + (jsonTokenReader.currentIndex()+1));
            }
        }

        throw new MuJsonParserException("unexpected token! index=" + jsonTokenReader.currentIndex());
    }

    private void processInParseArr2(JsonToken token){
        // éå°']'æä¼è¿æ¥
        if(token.getType() != JsonTokenTypeEnum.RIGHT_BRACKET){
            throw new MuJsonParserException("unexpected token! index=" + jsonTokenReader.currentIndex());
        }else{
            accept();
        }

        // å½åæ é¡¶å¿å®æ¯JsonArrayï¼åå°å¶å¼¹åºï¼ç¶åçæ é¡¶çåç´ ç±»åå¤æ­
        JsonParseStackValue currentJsonObjectStackValue = this.parseStack.popAndCheck(JsonParseStackValueTypeEnum.JSON_ARRAY);
        if(this.parseStack.isEmpty()){
            // è¯´ææ¯rootçJsonArrè§£æå®äºï¼åæ¨åå»ç´æ¥è¿å
            this.parseStack.push(currentJsonObjectStackValue);
            this.currentStatus = StackBaseJsonParserStatusEnum.END_PARSE;
            return;
        }

        JsonArray jsonArray = (JsonArray) currentJsonObjectStackValue.getValue();

        JsonParseStackValueTypeEnum topObjType = this.parseStack.peekTopType();

        if(topObjType == JsonParseStackValueTypeEnum.JSON_KEY){
            // å¦ææ¯json_keyï¼è¯´ææ¯å½åjsonArrayæ¯ç¶objectçä¸ä¸ªk/vé¡¹ä¸­çvalueã
            JsonParseStackValue keyStackValue = this.parseStack.popAndCheck(JsonParseStackValueTypeEnum.JSON_KEY);
            JsonToken keyJsonToken = (JsonToken) keyStackValue.getValue();

            JsonParseStackValue parentObject = this.parseStack.peekAndCheck(JsonParseStackValueTypeEnum.JSON_OBJECT);

            // å°å½åk/vé¡¹éå å¨ç¶objectä¸
            ((JsonObject)parentObject.getValue()).putKV(keyJsonToken.getContent(), jsonArray);

            // åºäºä¸ä¸ä¸ªtokenå¤æ­ç¶æè·³è½¬
            JsonToken nextJsonToken = this.jsonTokenReader.peek();
            if(nextJsonToken.getType() == JsonTokenTypeEnum.COMMA){
                this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_OBJECT_5;
                return;
            }else if (nextJsonToken.getType() == JsonTokenTypeEnum.RIGHT_BRACE){
                this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_OBJECT_2;
                return;
            }else{
                throw new MuJsonParserException("unexpected token! index=" + (jsonTokenReader.currentIndex()+1));
            }

        }else if(topObjType == JsonParseStackValueTypeEnum.JSON_ARRAY){
            // è¯´æå½åjsonObjectæ¯jsonArrayçä¸ä¸ªåç´ 

            JsonParseStackValue parentArr = this.parseStack.peekAndCheck(JsonParseStackValueTypeEnum.JSON_ARRAY);
            ((JsonArray)parentArr.getValue()).addElement(jsonArray);

            // åºäºä¸ä¸ä¸ªtokenå¤æ­ç¶æè·³è½¬
            JsonToken nextJsonToken = this.jsonTokenReader.peek();
            if(nextJsonToken.getType() == JsonTokenTypeEnum.COMMA){
                this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_ARR_3;
                return;
            }else if (nextJsonToken.getType() == JsonTokenTypeEnum.RIGHT_BRACKET){
                this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_ARR_2;
                return;
            }else{
                throw new MuJsonParserException("unexpected token! index=" + (jsonTokenReader.currentIndex()+1));
            }
        }else{
            // å«çæåµé½è¯´ææé®é¢ï¼ä¸æ¯åæ³çjson
            throw new MuJsonParserException("unexpected token! index=" + jsonTokenReader.currentIndex());
        }
    }

    private void processInParseArr3(JsonToken token){
        if(token.getType() == JsonTokenTypeEnum.COMMA){
            accept();
            this.currentStatus = StackBaseJsonParserStatusEnum.PARSE_ARR_1;
            return;
        }

        throw new MuJsonParserException("unexpected token! index=" + jsonTokenReader.currentIndex());
    }
}

</code></pre>
<h5 id="æ¯è¾å æ ä¸éå½å®ç°æ§è½å·®å¼çdemo">æ¯è¾å æ ä¸éå½å®ç°æ§è½å·®å¼çdemo</h5>
<p>æä»¬å¯ä»¥å¾ç®åçæé åºä¸ä¸ªéå¸¸æ·±åµå¥å±æ¬¡çjsonä¸²ï¼å³ç±è¿ç»­Nä¸ªâ[âåè¿ç»­Nä¸ªâ]âææçjsonå­ç¬¦ä¸²ãå³æ ¹èç¹ä¸ºæ°ç»ï¼åæ¶æ¯ä¸ªæ°ç»ä¸­é½æä¸ä»æä¸ä¸ªå­åç´ ï¼å­åç´ çç±»åä¾ç¶æ¯æ°ç»ï¼ä¾æ¬¡ç±»æ¨ã</p>
<pre><code class="language-java">public class TestHugeLevelJsonParse {

    @Test
    public void testHugeLevelJsonParse() {
        int level = 3500;
        String hugeLevelJson = TestUtil.buildHugeLevelJson(level);

        // 3500å±çæ·±åº¦ï¼ä¼StackOverflowErroræ æº¢åº
        Error recursiveJsonParseEx = null;
        try{
            RecursiveJsonParser recursiveJsonParser = new RecursiveJsonParser(new StreamJsonTokenReader(hugeLevelJson));
            JsonElement obj = recursiveJsonParser.doParse();
        }catch (Error e){
            recursiveJsonParseEx = e;
        }

        Assert.assertTrue(recursiveJsonParseEx instanceof StackOverflowError);
        System.out.println("level = " + level + " recursiveJsonParseEx has StackOverflowError!");

        // jacksoné»è®¤jsonæ·±åº¦ä¸º1000ï¼è¶è¿äºä¼æ¥é
        {
            try {
                Object obj = JackSonUtil.string2Obj(hugeLevelJson, Object.class);
            }catch (Exception e){
                // ä¼æ¥é
                System.out.println("jackson parse hugeLevelJson error!   " + e.getCause().getMessage());
            }
        }

        // åºäºå æ çè½æ­£ç¡®çè§£æåºæ¥ï¼ä¸ä¼StackOverflowErroræ æº¢åº
        {
            StackBaseJsonParser stackBaseJsonParser = new StackBaseJsonParser(new StreamJsonTokenReader(hugeLevelJson));
            JsonElement obj = stackBaseJsonParser.doParse();
            int arrayLevel = TestUtil.getSpecialJsonArrayLevel(obj);
            Assert.assertEquals(arrayLevel, level - 1);
            System.out.println("stackBaseJsonParser parseï¼arrayLevel=" + arrayLevel);
        }
    }
}
</code></pre>
<p><img src="https://img2024.cnblogs.com/blog/1506329/202602/1506329-20260211200045678-964632399.png" alt="test_huge_level_json_parse" loading="lazy"></p>
<h5 id="éå½-vs-å æ è§£æçåè">éå½ vs å æ è§£æçåè</h5>
<ul>
<li>åºäºéå½çjsonè¯­æ³è§£æå¨å®ç°ç®åï¼æè·¯æ´ç´è§ï¼ä½åéäºçº¿ç¨æ å¤§å°ï¼å¨ææ·±å±çº§ä¸ä¼åºç°StackOverflowã</li>
<li>åºäºå æ çjsonè¯­æ³è§£æå¨ç¶ææºæ´åºå¤§ï¼å®ç°èµ·æ¥æ´å¤æï¼ä½å°è°ç¨æ æ¬å°å ä¸ä¹åï¼è½å¤çææ·±å±çº§çjsonï¼åªè¦å åå­è¶³å¤ï¼ã</li>
<li>Jacksonç­æççä¸æ¹åºå³ä½¿åæ ·åºäºå æ å®ç°ï¼éå¸¸ä¹ä¼è®¾ç½®ä¸ä¸ªåççæ·±åº¦ä¸éï¼é¿åæ¶ææå¼å¸¸çjsonå¯¼è´ç³»ç»èµæºèå°½ã</li>
</ul>
<h2 id="æ»ç»">æ»ç»</h2>
<p>å°è¿éï¼æä»¬å·²ç»å¦å¼å¤´æè¯´çé£è¬ï¼ä¸æ­¥ä¸æ­¥çä»é¶å¼å§å®ç°äºä¸ä¸ªç®åçjsonè§£æå¨ã<br>
è½ç¶ç½ç»ä¸å·²ç»æçå¤§éå³äºjsonè§£æå¨å®ç°åççåå®¢ï¼çè³å©ç¨aié½è½å¸®ä½ å®ç°çå¤§å·®ä¸å·®ãä½æ¯çº¸ä¸å¾æ¥ç»è§æµï¼ç»ç¥æ­¤äºè¦èº¬è¡ï¼æ³è¦æ´å¥½çå­¦ä¹ ç¼è¯åçï¼å»çè§£ä¹è³å®ç°æ´å¤æçç¼è¯å¨ãè§£éå¨ï¼éè¿èªå·±å¨æå»ä½ä¼é£äºæ¦æ¶©æ½è±¡çåçä¹è®¸æ¯ä¸ç§æçè¾ä½ä½é¿è¿çåçæ ç©·çå­¦ä¹ æ¹å¼ã</p>
<h5 id="_-19"></h5>
<p>åå®¢ä¸­å±ç¤ºçå®æ´ä»£ç å¨æçgithubä¸ï¼<a href="https://github.com/1399852153/MySimpleJsonParser" target="_blank" rel="noopener nofollow">https://github.com/1399852153/MySimpleJsonParser</a> (mainåæ¯)ã<br>
å¸æè½å¤å¸®å©å°å¯¹jsonè§£æææ¯ç¼è¯åçæå´è¶£çè¯»èï¼åå®¹å¦æéè¯¯ï¼è¿è¯·å¤å¤ææã</p>


</div>
<div class="clear"></div>

	<div class="postDesc">posted on 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-02-11 20:23">2026-02-11 20:23</span>&nbsp;
<a href="https://www.cnblogs.com/xiaoxiongcanguan">å°çé¤é¦</a>&nbsp;
éè¯»(<span id="post_view_count">16</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19605794);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19605794', targetLink: 'https://www.cnblogs.com/xiaoxiongcanguan/p/19605794', title: 'ä»é¶å¼å§å®ç°ä¸ä¸ªç®æjsonè§£æå¨' })">ä¸¾æ¥</a>
</div>
 ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ ç±»åæ¦é¤ä¸é¨åå¼æ­¥ç¼ç¨ ]]></title>
    <link>https://www.cnblogs.com/suiyuan129/p/19605836</link>
    <guid>55518f514c3ebe17d7eff0dc90176303</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/suiyuan129/p/19605836" title="åå¸äº 2026-02-11 20:16">
    <span role="heading" aria-level="2">ç±»åæ¦é¤ä¸é¨åå¼æ­¥ç¼ç¨</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h1 id="ç±»åæ¦é¤ä¸é¨åå¼æ­¥ç¼ç¨-æ¶é¤å·®å«ç»ä¸ä½¿ç¨">ç±»åæ¦é¤ä¸é¨åå¼æ­¥ç¼ç¨: æ¶é¤å·®å«ï¼ç»ä¸ä½¿ç¨</h1>
<p>C++ ä¸­ç±»åæ¦é¤æå¸åçå®ç°æè·¯åä¸ºä¸¤ç±»ââæ¨¡æ¿ï¼ç¼è¯ææ¦é¤ï¼ä¸å¤æï¼è¿è¡æ¶æ¦é¤ï¼ï¼è¿ä¸¤ç§æ¹å¼å¤§å®¶é½æ¯è¾çæãèæ ååºä¸ºæä»¬å°è£äºæ´æç¨çç±»åæ¦é¤å·¥å·ï¼æ ¸å¿åæ¬ <code>std::function</code>ã<code>std::any</code>ã<code>std::span</code> å <code>std::variant</code>ï¼å®ä»¬å¨ä¸ååºæ¯ä¸å¸®æä»¬âæ¶é¤ç±»åå·®å«ï¼å®ç°ç»ä¸ä½¿ç¨âï¼åæ¶ï¼ç±»åæ¦é¤ä¹æ¯å¼æ­¥ç¼ç¨çæ ¸å¿åºç¡ï¼<code>std::function</code> æ­éç¸å³ç»ä»¶å¯å®ç°ä»»æå¼æ­¥ä»»å¡çç»ä¸è°åº¦ï¼è¿ä¹æ¯æä»¬å°ä¸¤èç»åè®²è§£çæ ¸å¿åå ã</p>
<h2 id="1-stdfunctionå¯è°ç¨å¯¹è±¡çç»ä¸è°ç¨æ¥å£">1. std::functionï¼å¯è°ç¨å¯¹è±¡çâç»ä¸è°ç¨æ¥å£â</h2>
<p><code>std::function</code> æ¯éå¯¹<strong>å¯è°ç¨å¯¹è±¡</strong>çç±»åæ¦é¤å·¥å·ï¼å¶åºå±å®ç°æ ¸å¿æ¯ãæ½è±¡åºç±» + æ¨¡æ¿å­ç±»ãçå¤ææ¨¡å¼ï¼ä¹æ¯è¿è¡æ¶ç±»åæ¦é¤çå¸ååºç¨ï¼</p>
<ul>
<li>æ½è±¡åºç±»ï¼å®ä¹äºä¸âå½æ°ç­¾åâå®å¨å¹éççº¯èè°ç¨æ¥å£ï¼æ¯å¦ <code>virtual Ret call(Args...) = 0</code>ï¼ï¼ä½ä¸ºç»ä¸è°ç¨çåºåï¼</li>
<li>æ¨¡æ¿å­ç±»ï¼å­å¨å·ä½çå¯è°ç¨å¯¹è±¡ï¼å½æ°ãlambdaãä»¿å½æ°ã<code>std::bind</code> ç»æç­ï¼ï¼å¹¶éåæ½è±¡åºç±»ç <code>call</code> æ¹æ³ï¼ééå·ä½å¯¹è±¡çè°ç¨é»è¾ã</li>
</ul>
<p>æ­£å ä¸º <code>std::function</code> æ¯éè¿è°ç¨<strong>æ½è±¡åºç±»çç»ä¸æ¥å£</strong>ï¼é´æ¥å¼å«å­å¥æ¨¡æ¿å­ç±»ä¸­çå·ä½å½æ°ï¼æä»¥æä»¬<strong>å¿é¡»æåæç¡®åç¥ <code>std::function</code> å®æ´çå½æ°ç­¾åï¼è¿åå¼ç±»åãåæ°ç±»åãåæ°ä¸ªæ°ï¼</strong> ââ è¿æ¯æ½è±¡åºç±»å®ä¹ç»ä¸è°ç¨æ¥å£çåæï¼åªæç­¾åä¸è´ï¼ææè¢«æ¦é¤ç±»åçå¯è°ç¨å¯¹è±¡ï¼æè½éè¿æ½è±¡åºç±»çæ¥å£è¢«æ­£ç¡®è°ç¨ãä¹æ­£å è¿è¡æ¶çå¤ææ´¾åï¼éè¿æ½è±¡åºç±»æéè°ç¨å­ç±»ç <code>call</code> æ¹æ³ï¼ï¼<code>std::function</code> ä¼äº§çä¸å®çè¿è¡æ¶å¼éã</p>
<h3 id="æµè¯ä»£ç stdfunction-ç»ä¸è°ç¨ä¸åå¯è°ç¨å¯¹è±¡">æµè¯ä»£ç ï¼std::function ç»ä¸è°ç¨ä¸åå¯è°ç¨å¯¹è±¡</h3>
<pre><code class="language-cpp">#include &lt;iostream&gt;
#include &lt;functional&gt;
#include &lt;string&gt;

// æ®éå½æ°
int add(int a, int b) { return a + b; }

// ä»¿å½æ°
struct Multiply {
    int operator()(int a, int b) { return a * b; }
};

int main() {
    // å®ä¹å½æ°ç­¾åï¼int(int, int)
    std::function&lt;int(int, int)&gt; func;

    // å­å¨æ®éå½æ°
    func = add;
    std::cout &lt;&lt; "add(3,4) = " &lt;&lt; func(3, 4) &lt;&lt; std::endl; // è¾åº7

    // å­å¨lambdaè¡¨è¾¾å¼
    func = [](int a, int b) { return a - b; };
    std::cout &lt;&lt; "sub(3,4) = " &lt;&lt; func(3, 4) &lt;&lt; std::endl; // è¾åº-1

    // å­å¨ä»¿å½æ°
    func = Multiply{};
    std::cout &lt;&lt; "mul(3,4) = " &lt;&lt; func(3, 4) &lt;&lt; std::endl; // è¾åº12

    return 0;
}
</code></pre>
<p>ä»£ç è¯´æï¼æ è®ºå­å¨çæ¯æ®éå½æ°ãlambdaè¿æ¯ä»¿å½æ°ï¼åªè¦å½æ°ç­¾åå¹é <code>int(int, int)</code>ï¼å°±è½éè¿ <code>std::function</code> ç»ä¸è°ç¨ï¼ä½ç°äºç±»åæ¦é¤âæ¶é¤å·®å«ï¼ç»ä¸ä½¿ç¨âçæ ¸å¿ã</p>
<h2 id="2-stdany--stdvariantæ°æ®å­å¨çç±»åæ¦é¤åé">2. std::any &amp; std::variantï¼æ°æ®å­å¨çâç±»åæ¦é¤åéâ</h2>
<p>ä¸¤èåç¨äºå®ç°æ°æ®å­å¨çç±»åæ¦é¤ï¼ä½å®ä½äºè¡¥ï¼<code>std::variant</code> æ ¸å¿æ¯å¼¥è¡¥ <code>std::any</code> çç¹çä¸ä½æé®é¢ã</p>
<h3 id="stdanyæ çº¦æçå¨ç±»åæ¦é¤">std::anyï¼æ çº¦æçå¨ç±»åæ¦é¤</h3>
<p><code>std::any</code> æ¯ç»å¸çâå¨ç±»åæ¦é¤âå·¥å·ï¼å®å®å¨æ¦é¤ç¼è¯æçç±»åä¿¡æ¯ï¼ä»ä¿çâæ°æ®æ¬èº« + è¿è¡æ¶ç±»åIDï¼<code>std::type_info</code>ï¼âï¼ç¸å½äºä¸ä¸ªâå¸¦ç±»åæ ç­¾çä¸è½çå­âï¼è½å­å¨ä»»æç±»åçæ°æ®ã<br>
å <code>std::function</code> ç±»ä¼¼ï¼<code>std::any</code> éå¨è¿è¡æ¶éè¿ç±»åIDè¯å«åé¨æ°æ®ç±»åï¼å æ­¤å­å¨è¿è¡æ¶å¼éï¼æ­¤å¤ï¼<code>std::any</code> å¯¹å¤§ç±»åä¼è¿è¡å åå­åéï¼è¿ä¸æ­¥å¢å è½»å¾®çåå­å¼éãå¶æå¤§çç¹ç¹æ¯èªç±æ çº¦æï¼ä½è¿ä»½èªç±ä¹å¸¦æ¥äºæä½ç¹ççé®é¢ââä½¿ç¨æ¶å¿é¡»æå¨éè¿ <code>typeid</code> æ£æ¥ç±»åï¼åç¨ <code>any_cast</code> æåæ°æ®ï¼ä¸ç±»åéè¯¯åªè½å¨è¿è¡æ¶æ´é²ï¼æåº <code>std::bad_any_cast</code> å¼å¸¸ï¼ã</p>
<h3 id="stdvariantæéå¶çé«æç±»åæ¦é¤">std::variantï¼æéå¶çé«æç±»åæ¦é¤</h3>
<p><code>std::variant</code> æ¯ä¸ºè§£å³ <code>std::any</code> ççç¹èçï¼å®éè¿<strong>ç¼è¯ææåå£°æå¯å­å¨çç±»åèå´</strong>ï¼å®ç°äºæ´é«æãæ´å®å¨çç±»åæ¦é¤ï¼å±äºâæéç±»åæ¦é¤âï¼</p>
<ul>
<li>ç¼è¯æååºï¼åéç±»åï¼æ¯å¦ç¨ <code>std::get</code> æåéæ´»è·ç±»åï¼ä¼è¢«ç¼è¯å¨åæ¶æéï¼æ´æ©æ´é²é®é¢ï¼é¿åè¿è¡æ¶å¼å¸¸é¾ä»¥è°è¯ï¼</li>
<li>ç»ä¸ä¾¿æ·å¤çï¼æ éæåä¸å  <code>if (typeid)</code> å¤æ­åæ¯ï¼éè¿ <code>std::visit</code> å°±è½æ¹éå¤çææé¢å®ä¹ç±»åï¼ä»£ç æ´ç®æ´ãä¸ææ¼åæ¯ï¼</li>
<li>é¶å å¼éï¼<code>std::variant</code> çå¤§å°å¨ç¼è¯æç¡®å®ï¼ç­äºææé¢å®ä¹ç±»åä¸­æå¤§ç±»åçå°ºå¯¸ + ç±»åæ ç­¾å°ºå¯¸ï¼ï¼æææ°æ®åå­å¨å¨æ ä¸ï¼æ å åéå¼éï¼</li>
<li>å®å¨æåï¼æä¾ <code>std::holds_alternative</code>ï¼å¤æ­æ¯å¦ä¸ºæå®ç±»åï¼ã<code>std::get_if</code>ï¼å®å¨æåï¼ä¸å¹éè¿å <code>nullptr</code>ï¼ç­å·¥å·ï¼æ éæè·å¼å¸¸ï¼ç±»åæ£æ¥åæ°æ®æåæ´ç´è§ãå®å¨ã</li>
</ul>
<p>ç®åæ¥è¯´ï¼<code>std::any</code> æ¯âæ ææ æä½å¨é æå¨âï¼<code>std::variant</code> æ¯âæéå¶ä½ç¼è¯å¨å¸®ä½ ååºâï¼è¿ä»½éå¶æ°æ°æ¯å®ç®åæä½ãæåæççæ ¸å¿ã</p>
<h3 id="æµè¯ä»£ç stdany-ä¸-stdvariant-å¯¹æ¯">æµè¯ä»£ç ï¼std::any ä¸ std::variant å¯¹æ¯</h3>
<pre><code class="language-cpp">#include &lt;iostream&gt;
#include &lt;any&gt;
#include &lt;variant&gt;
#include &lt;string&gt;
#include &lt;typeinfo&gt;

// å¤çstd::any
void process_any(std::any val) {
    if (val.type() == typeid(int)) {
        std::cout &lt;&lt; "anyå­å¨intï¼" &lt;&lt; std::any_cast&lt;int&gt;(val) &lt;&lt; std::endl;
    } else if (val.type() == typeid(std::string)) {
        std::cout &lt;&lt; "anyå­å¨stringï¼" &lt;&lt; std::any_cast&lt;std::string&gt;(val) &lt;&lt; std::endl;
    } else if (val.type() == typeid(double)) {
        std::cout &lt;&lt; "anyå­å¨doubleï¼" &lt;&lt; std::any_cast&lt;double&gt;(val) &lt;&lt; std::endl;
    }
}

// å¤çstd::variant
using MyVariant = std::variant&lt;int, std::string, double&gt;;
void process_variant(const MyVariant&amp; val) {
    // æ éæåif(typeid)ï¼std::visitæ¹éå¤ç
    std::visit([](const auto&amp; v) {
        using T = std::decay_t&lt;decltype(v)&gt;;
        if constexpr (std::is_same_v&lt;T, int&gt;) {
            std::cout &lt;&lt; "variantå­å¨intï¼" &lt;&lt; v &lt;&lt; std::endl;
        } else if constexpr (std::is_same_v&lt;T, std::string&gt;) {
            std::cout &lt;&lt; "variantå­å¨stringï¼" &lt;&lt; v &lt;&lt; std::endl;
        } else if constexpr (std::is_same_v&lt;T, double&gt;) {
            std::cout &lt;&lt; "variantå­å¨doubleï¼" &lt;&lt; v &lt;&lt; std::endl;
        }
    }, val);
}

int main() {
    // std::anyæµè¯
    std::any a = 10;
    process_any(a); // è¾åºanyå­å¨intï¼10
    a = std::string("hello any");
    process_any(a); // è¾åºanyå­å¨stringï¼hello any
    a = 3.14;
    process_any(a); // è¾åºanyå­å¨doubleï¼3.14

    // std::variantæµè¯
    MyVariant v = 20;
    process_variant(v); // è¾åºvariantå­å¨intï¼20
    v = std::string("hello variant");
    process_variant(v); // è¾åºvariantå­å¨stringï¼hello variant
    v = 6.28;
    process_variant(v); // è¾åºvariantå­å¨doubleï¼6.28

    // std::variantå®å¨æåç¤ºä¾
    if (std::holds_alternative&lt;double&gt;(v)) {
        auto p = std::get_if&lt;double&gt;(&amp;v);
        std::cout &lt;&lt; "å®å¨æådoubleï¼" &lt;&lt; *p &lt;&lt; std::endl; // è¾åº6.28
    }

    return 0;
}
</code></pre>
<p>ä»£ç è¯´æï¼</p>
<ul>
<li><code>std::any</code> éæå¨å <code>if (typeid)</code> åæ¯ï¼æ°å¢ç±»åæ¶éæå¨æ©å±ï¼</li>
<li><code>std::variant</code> åå© <code>std::visit</code> æ¹éå¤çææé¢å®ä¹ç±»åï¼ä»£ç æ´ç®æ´ï¼ä¸ <code>holds_alternative</code>/<code>get_if</code> è®©ç±»åæ£æ¥/æåæ´å®å¨ã</li>
</ul>
<h2 id="3-stdspanè¿ç»­å®¹å¨çé¶å¼éç±»åæ¦é¤">3. std::spanï¼è¿ç»­å®¹å¨çâé¶å¼éç±»åæ¦é¤â</h2>
<p><code>std::span</code> æ¯éå¯¹<strong>è¿ç»­åå­å®¹å¨</strong>çâç¹å¶ç±»åæ¦é¤å·¥å·âï¼ä¸é¨ç¨äºæ¶é¤ä¸åè¿ç»­å®¹å¨çç±»åå·®å¼ï¼å®ç°ç»ä¸è®¿é®ï¼<br>
å®ä¼æ¦é¤ <code>std::vector</code>ã<code>std::array</code>ãCé£æ ¼æ°ç»ç­è¿ç»­å®¹å¨çå·ä½ç±»åï¼ä»ä¿çâèµ·å§æé + åç´ é¿åº¦âä¸¤ä¸ªæ ¸å¿ç¹å¾ï¼ç¸å½äºç»ææè¿ç»­åå­å®¹å¨æä¾äºä¸ä¸ªç»ä¸çâè§å¾âã<br>
<code>std::span</code> çæ ¸å¿ä¼å¿æ¯<strong>é¶è¿è¡æ¶å¼é</strong>ââç±»åæ¦é¤å¨ç¼è¯æå®æï¼æ éè¿è¡æ¶é¢å¤è®¡ç®æåå­åéï¼ä½ä¹ææç¡®éå¶ï¼ä»æ¯æè¿ç»­åå­å®¹å¨ï¼æ æ³å¤ç <code>std::list</code> ç­éè¿ç»­åå­å®¹å¨ã</p>
<h3 id="æµè¯ä»£ç stdspan-ç»ä¸è®¿é®ä¸åè¿ç»­å®¹å¨">æµè¯ä»£ç ï¼std::span ç»ä¸è®¿é®ä¸åè¿ç»­å®¹å¨</h3>
<pre><code class="language-cpp">#include &lt;iostream&gt;
#include &lt;span&gt;
#include &lt;vector&gt;
#include &lt;array&gt;

// ç»ä¸å¤çææè¿ç»­intå®¹å¨
void print_span(std::span&lt;int&gt; sp) {
    std::cout &lt;&lt; "å®¹å¨é¿åº¦ï¼" &lt;&lt; sp.size() &lt;&lt; "ï¼åå®¹ï¼";
    for (int val : sp) {
        std::cout &lt;&lt; val &lt;&lt; " ";
    }
    std::cout &lt;&lt; std::endl;
}

int main() {
    // std::vector
    std::vector&lt;int&gt; vec = {1, 2, 3};
    print_span(vec); // è¾åºå®¹å¨é¿åº¦ï¼3ï¼åå®¹ï¼1 2 3

    // std::array
    std::array&lt;int, 4&gt; arr = {4, 5, 6, 7};
    print_span(arr); // è¾åºå®¹å¨é¿åº¦ï¼4ï¼åå®¹ï¼4 5 6 7

    // Cé£æ ¼æ°ç»
    int c_arr[] = {8, 9, 10};
    print_span(c_arr); // è¾åºå®¹å¨é¿åº¦ï¼3ï¼åå®¹ï¼8 9 10

    // åçè®¿é®ï¼spançé¢å¤ä¼å¿ï¼
    print_span(std::span(vec).subspan(1, 2)); // è¾åºå®¹å¨é¿åº¦ï¼2ï¼åå®¹ï¼2 3

    return 0;
}
</code></pre>
<p>ä»£ç è¯´æï¼<code>print_span</code> å½æ°æ éå³å¿ä¼ å¥çæ¯ <code>vector</code>ã<code>array</code> è¿æ¯Cæ°ç»ï¼<code>std::span</code> æ¦é¤äºå®¹å¨ç±»åå·®å¼ï¼å®ç°ç»ä¸è®¿é®ï¼ä¸æ ä»»ä½è¿è¡æ¶å¼éã</p>
<h2 id="4-ç±»åæ¦é¤å¨å¼æ­¥ç¼ç¨ä¸­çæ ¸å¿åºç¨">4. ç±»åæ¦é¤å¨å¼æ­¥ç¼ç¨ä¸­çæ ¸å¿åºç¨</h2>
<p>ä¸ºä»ä¹è¦å°ç±»åæ¦é¤ä¸å¼æ­¥ç¼ç¨ç»åï¼å ä¸º <code>std::function</code> çç±»åæ¦é¤è½åï¼æ¯å¼æ­¥ä»»å¡âç»ä¸ç®¡çâçæ ¸å¿ï¼å®å¸¸æ­é lambda è¡¨è¾¾å¼ã<code>std::packaged_task</code>ã<code>std::bind</code> å®ç°ä»»æå¼æ­¥ä»»å¡çç»ä¸è°åº¦ï¼æ ¸å¿é»è¾æ¯âæ¦é¤ä»»å¡å·®å¼ï¼ç»ä¸ç®¡çï¼æéè·åç»æâï¼</p>
<ol>
<li>ç¨ <code>std::bind</code> å°ä»»å¡åæ°ä¸å¯è°ç¨å¯¹è±¡ç»å®ï¼æ¦é¤ä¸åä»»å¡çåæ°ç±»åå·®å¼ï¼è®©æåä»»å¡ééç»ä¸çè°ç¨å½¢å¼ï¼</li>
<li>å°ç»å®åçä»»å¡è£å¥ <code>std::packaged_task</code>ï¼éè¿ <code>std::packaged_task</code> åç½®ç <code>std::promise</code>ï¼è·å <code>std::future</code> å¯¹è±¡ï¼ç¨äºåç»­æ¥æ¶å¼æ­¥ä»»å¡çè¿åå¼ï¼ââ æ­¤æ¶ä»»å¡çè¿åå¼ç±»åæªè¢«æ¦é¤ï¼</li>
<li>éè¿ lambda è¡¨è¾¾å¼å°è£ <code>std::packaged_task</code> çæ§è¡é»è¾ï¼å°âæè¿åå¼çä»»å¡âåè£ææ è¿åå¼ç <code>void()</code> ç±»åï¼ä»èæ¦é¤è¿åå¼å·®å¼ï¼</li>
<li>æç»ï¼ææå¼æ­¥ä»»å¡åå¯ç»ä¸è£è¿ <code>std::function&lt;void()&gt;</code> ä¸­è¿è¡ç®¡çï¼ä»»å¡çè¿åå¼åå¨å¼æ­¥æ§è¡å®æåï¼èªå¨å­å¥ <code>std::packaged_task</code> åé¨ç <code>std::promise</code>ï¼æä»¬éè¿ä¹åè·åç <code>std::future</code> å°±è½æéè·åå¼æ­¥ç»æï¼å®ç°âä»»å¡ç»ä¸ç®¡ç + ç»ææéè·åâã</li>
</ol>
<h3 id="æµè¯ä»£ç ç±»åæ¦é¤å®ç°å¼æ­¥ä»»å¡ç»ä¸ç®¡ç">æµè¯ä»£ç ï¼ç±»åæ¦é¤å®ç°å¼æ­¥ä»»å¡ç»ä¸ç®¡ç</h3>
<pre><code class="language-cpp">#include &lt;iostream&gt;
#include &lt;functional&gt;
#include &lt;future&gt;
#include &lt;thread&gt;
#include &lt;queue&gt;
#include &lt;mutex&gt;
#include &lt;condition_variable&gt;
#include &lt;string&gt;

// å¨å±ä»»å¡éåï¼å­å¨ç»ä¸çæ è¿åå¼ä»»å¡
std::queue&lt;std::function&lt;void()&gt;&gt; task_queue;
std::mutex mtx;
std::condition_variable cv;
bool stop = false;

// å·¥ä½çº¿ç¨ï¼æ¶è´¹ä»»å¡éå
void worker() {
    while (!stop) {
        std::function&lt;void()&gt; task;
        // å éåä»»å¡
        {
            std::unique_lock&lt;std::mutex&gt; lock(mtx);
            cv.wait(lock, []() { return stop || !task_queue.empty(); });
            if (stop &amp;&amp; task_queue.empty()) return;
            task = std::move(task_queue.front());
            task_queue.pop();
        }
        // æ§è¡ä»»å¡
        task();
    }
}

// æäº¤ä»»å¡æ¨¡æ¿ï¼æ¦é¤åæ°/è¿åå¼å·®å¼ï¼ç»ä¸å­å¥éå
template&lt;typename F, typename... Args&gt;
auto submit_task(F&amp;&amp; f, Args&amp;&amp;... args) -&gt; std::future&lt;decltype(f(args...))&gt; {
    // ç»å®åæ°ï¼æ¦é¤åæ°å·®å¼
    auto bound_task = std::bind(std::forward&lt;F&gt;(f), std::forward&lt;Args&gt;(args)...);
    // å®ä¹packaged_taskï¼ä¿çè¿åå¼ç±»å
    using RetType = decltype(f(args...));
    std::packaged_task&lt;RetType()&gt; pt(std::move(bound_task));
    // è·åfutureç¨äºæ¥æ¶ç»æ
    std::future&lt;RetType&gt; fut = pt.get_future();
    // å°è£ævoid()ä»»å¡ï¼æ¦é¤è¿åå¼å·®å¼
    std::function&lt;void()&gt; wrapper = [pt = std::move(pt)]() mutable {
        pt(); // æ§è¡packaged_taskï¼ç»æå­å¥promise
    };
    // å­å¥ä»»å¡éå
    {
        std::lock_guard&lt;std::mutex&gt; lock(mtx);
        task_queue.push(std::move(wrapper));
    }
    cv.notify_one(); // å¤éå·¥ä½çº¿ç¨
    return fut;
}

// æµè¯ä»»å¡1ï¼æåæè¿åå¼ï¼è®¡ç®å¹³æ¹ï¼
int square(int x) {
    std::this_thread::sleep_for(std::chrono::seconds(1));
    return x * x;
}

// æµè¯ä»»å¡2ï¼æåæè¿åå¼ï¼æ¼æ¥å­ç¬¦ä¸²ï¼
std::string concat(const std::string&amp; a, const std::string&amp; b) {
    std::this_thread::sleep_for(std::chrono::seconds(1));
    return a + b;
}

int main() {
    // å¯å¨å·¥ä½çº¿ç¨
    std::thread t(worker);

    // æäº¤ä»»å¡1ï¼è®¡ç®5çå¹³æ¹
    auto fut1 = submit_task(square, 5);
    // æäº¤ä»»å¡2ï¼æ¼æ¥å­ç¬¦ä¸²
    auto fut2 = submit_task(concat, "hello ", "async");

    // ä¸»çº¿ç¨ç­å¾ç»æ
    std::cout &lt;&lt; "ç­å¾å¼æ­¥ä»»å¡ç»æ..." &lt;&lt; std::endl;
    std::cout &lt;&lt; "5çå¹³æ¹ï¼" &lt;&lt; fut1.get() &lt;&lt; std::endl; // è¾åº25
    std::cout &lt;&lt; "å­ç¬¦ä¸²æ¼æ¥ï¼" &lt;&lt; fut2.get() &lt;&lt; std::endl; // è¾åºhello async

    // åæ­¢å·¥ä½çº¿ç¨
    stop = true;
    cv.notify_one();
    t.join();

    return 0;
}
</code></pre>
<p>ä»£ç è¯´æï¼</p>
<ul>
<li><code>square</code> å <code>concat</code> æ¯ä¸åç­¾åçä»»å¡ï¼åæ°/è¿åå¼åä¸åï¼ï¼</li>
<li>éè¿ <code>std::bind</code> æ¦é¤åæ°å·®å¼ï¼<code>std::packaged_task</code> ä¿çè¿åå¼å¹¶ç»å® <code>future</code>ï¼lambda å°è£æ <code>void()</code> æ¦é¤è¿åå¼å·®å¼ï¼</li>
<li>æç»ææä»»å¡é½è½å­å¥ <code>std::function&lt;void()&gt;</code> éåï¼å®ç°ç»ä¸ç®¡çï¼ä½ç°äºç±»åæ¦é¤å¨å¼æ­¥ç¼ç¨ä¸­çæ ¸å¿ä»·å¼ã</li>
</ul>
<h2 id="æ´ä½æ»ç»">æ´ä½æ»ç»</h2>
<p>æ ååºä¸­çåç§ç±»åæ¦é¤å·¥å·ï¼è½å®ä½ä¸åï¼ä½æ ¸å¿ç®æ ä¸è´ââ<strong>æ¶é¤ç±»åå·®å«ï¼å®ç°ç»ä¸ä½¿ç¨</strong>ï¼</p>
<ol>
<li><code>std::function</code>ï¼éå¯¹å¯è°ç¨å¯¹è±¡ï¼ç»ä¸è°ç¨æ¥å£ï¼ä¾èµå½æ°ç­¾ååå¤æå®ç°ï¼æè¿è¡æ¶å¼éï¼</li>
<li><code>std::any</code>ï¼éå¯¹ä»»ææ°æ®ï¼å¨ç±»åæ¦é¤ï¼èªç±ä½ç¹çãæè¿è¡æ¶åå åå­å¼éï¼</li>
<li><code>std::variant</code>ï¼éå¯¹æéèå´æ°æ®ï¼å¼¥è¡¥ <code>std::any</code> ä¸è¶³ï¼ç¼è¯æååºãé«æä¾¿æ·ãé¶å å¼éï¼</li>
<li><code>std::span</code>ï¼éå¯¹è¿ç»­å®¹å¨ï¼é¶å¼éç±»åæ¦é¤ï¼ç»ä¸è¿ç»­åå­è®¿é®æ¥å£ï¼ä»æ¯æè¿ç»­å®¹å¨ã</li>
</ol>
<p>èç±»åæ¦é¤ä¸å¼æ­¥ç¼ç¨çç»åï¼æ ¸å¿æ¯åå© <code>std::function</code> çç»ä¸ç®¡çè½åï¼æ­é lambdaã<code>std::packaged_task</code>ã<code>std::bind</code> ç­ç»ä»¶ï¼æ¦é¤ä¸åå¼æ­¥ä»»å¡çåæ°åè¿åå¼å·®å¼ï¼å®ç°ä»»æå¼æ­¥ä»»å¡çç»ä¸è°åº¦ï¼è¿ä¹æ¯ç±»åæ¦é¤å¨å®éå¼åä¸­æå¸¸ç¨çåºæ¯ä¹ä¸ã</p>


</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.003472222222222222" data-date-updated="2026-02-11 20:21">2026-02-11 20:16</span>&nbsp;
<a href="https://www.cnblogs.com/suiyuan129">suiyuan129</a>&nbsp;
éè¯»(<span id="post_view_count">7</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19605836);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19605836', targetLink: 'https://www.cnblogs.com/suiyuan129/p/19605836', title: 'ç±»åæ¦é¤ä¸é¨åå¼æ­¥ç¼ç¨' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ æéOpenClawä¸Telegramçè¶è¯¦ç»å®ææç¨ ]]></title>
    <link>https://www.cnblogs.com/weipo0105/p/19605771</link>
    <guid>ec0a96dbb300582b9d29f667a2273f9c</guid>
    <description>
    <![CDATA[ 
		<h1 class="postTitle">
			<a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/weipo0105/p/19605771" title="åå¸äº 2026-02-11 19:52">
    <span role="heading" aria-level="2">æéOpenClawä¸Telegramçè¶è¯¦ç»å®ææç¨</span>
    

</a>

		</h1>
		<div class="clear"></div>
		<div class="postBody">
			    <div id="cnblogs_post_description" style="display: none">
        <img src="https://img2024.cnblogs.com/blog/1205021/202602/1205021-20260211195252126-719148591.png" alt="æéOpenClawä¸Telegramçè¶è¯¦ç»å®ææç¨" class="desc_img">
        æ¬æè¯¦ç»è®²è§£å¦ä½å¨OpenClawä¸­æ¥å¥Telegramï¼ä»BotFatherè·åTokenï¼åéæ¶æ¯è·åéå¯¹ç ï¼åå°éè¿`openclaw config`å®æéç½®ä¸éå¯¹ï¼æåæµè¯æåãè½»æ¾å®ç°Telegramä¸AIå©æçæ ç¼å¯¹æ¥ï¼å»¶ç»­é£ä¹¦ãDiscordç³»åæç¨ï¼ä¸æå­¦ä¼ã
    </div>
<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<p>åé¢æåäºä¸¤ç¯æç« ï¼è¯¦ç»è®²è§£äºå¦ä½å®è£ <code>openclaw</code> å¹¶æ¥å¥<strong>é£ä¹¦</strong>å<strong>Discord</strong>ï¼</p>
<ul>
<li><a href="https://mp.weixin.qq.com/s/JGd4u8g-Fti4sRcJcSiOLQ" target="_blank" rel="noopener nofollow">ãä¿å§çº§æç¨ãææææä½ å®è£OpenClawå¹¶æ¥å¥é£ä¹¦ï¼è®©AIå¨èå¤©è½¯ä»¶éå¸®ä½ å¹²æ´»</a></li>
<li><a href="https://mp.weixin.qq.com/s/D-7QGk5ZNbxIWO6haimaWg" target="_blank" rel="noopener nofollow">è¶è¯¦ç»æç¨ï¼æéOpenClawä¸Discordï¼ç¨MiniMax 2.1æé ä½ çè¶çº§AIå©æ</a></li>
</ul>
<p>å³äº <code>openclaw</code> çå®è£ï¼ä¸ä¸ç¯å·²ç»è®²å¾éå¸¸è¯¦ç»ï¼è¿æ²¡è£å¥½çæåå¯ä»¥ç¿»çä¹åçæç« ã</p>
<p>ä»å¤©ï¼æä»¬ç»§ç»­æ¨è¿ï¼ä¸ºå¤§å®¶å¸¦æ¥<strong>å¨ <code>openclaw</code> ä¸­æ¥å¥ Telegram</strong> çå®æ´æç¨ï¼å¾æå¹¶èï¼ä¸æ­¥æ­¥å¸¦ä½ æéã</p>
<hr>
<h2 id="ä¸è·å-token-ä¸éå¯¹ç ">ä¸ãè·å Token ä¸éå¯¹ç </h2>
<ol>
<li>
<p><strong>åå»º Bot å¹¶è·å Token</strong><br>
å¨ Telegram ä¸­æç´¢ <code>@BotFather</code>ï¼è¿å¥èå¤©çé¢ã<br>
<img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202602/1205021-20260211195228366-1885483550.png" class="lazyload"></p>
<p>è¾å¥ <code>/newbot</code>ï¼ææç¤ºè®¾ç½®æºå¨äººåç§°åç¨æ·åï¼å®æåä¼æ¶å°ä¸ä¸ª <strong>API Token</strong>ï¼<strong>è¯·å¡å¿ä¿å­å¥½</strong>ï¼åé¢éç½®æ¶éè¦ç¨å°ã<br>
<img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202602/1205021-20260211195228486-257335433.png" class="lazyload"></p>
</li>
<li>
<p><strong>è·åéå¯¹ç </strong><br>
æç´¢ä½ ååå»ºç Bot ç¨æ·åï¼è¿å¥èå¤©çé¢ï¼ç¹å» <strong>Start</strong>ã<br>
<img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202602/1205021-20260211195228459-695885497.png" class="lazyload"></p>
<p>éä¾¿åéä¸æ¡æ¶æ¯ï¼Bot ä¼èªå¨åå¤ä¸ä¸ª<strong>éå¯¹ç ï¼Pairing Codeï¼</strong>ï¼è¯·å¤å¶ä¿å­ï¼åé¢éå¯¹ç¯èä¼ç¨å°ã<br>
<img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202602/1205021-20260211195228375-1374554712.png" class="lazyload"></p>
</li>
</ol>
<hr>
<h2 id="äºéç½®-openclaw">äºãéç½® openclaw</h2>
<ol>
<li>
<p>æå¼ç»ç«¯ï¼è¾å¥ä»¥ä¸å½ä»¤å¼å§éç½®ï¼</p>
<pre><code class="language-bash">openclaw config
</code></pre>
<p>éæ© <code>local</code>ã<br>
<img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202602/1205021-20260211195228351-2977598.png" class="lazyload"></p>
</li>
<li>
<p>è¿å¥ <code>channels</code> éç½®é¡¹ã<br>
<img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202602/1205021-20260211195228313-1408987176.png" class="lazyload"></p>
</li>
<li>
<p>éæ© <strong>éç½®è¿æ¥</strong>ã<br>
<img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202602/1205021-20260211195228249-319147309.png" class="lazyload"></p>
</li>
<li>
<p>å¨å¹³å°åè¡¨ä¸­éæ© <strong>çµæ¥ï¼Telegramï¼</strong>ã<br>
<img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202602/1205021-20260211195228353-394225861.png" class="lazyload"></p>
</li>
<li>
<p>ç²è´´ååä¿å­ç Bot Tokenã<br>
<img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202602/1205021-20260211195228294-1423647272.png" class="lazyload"></p>
</li>
<li>
<p>ç¡®è®¤æ è¯¯åç¹å» <strong>å®æ</strong>ã<br>
<img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202602/1205021-20260211195228255-1605307563.png" class="lazyload"></p>
</li>
<li>
<p><strong>è¿å¥éå¯¹æ¨¡å¼</strong><br>
ç³»ç»ä¼è¯¢é®å®å¨ç­ç¥ï¼éæ© <code>yes</code>ï¼é»è®¤ä½¿ç¨éå¯¹æ¨¡å¼ã<br>
<img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202602/1205021-20260211195228315-494762371.png" class="lazyload"></p>
</li>
<li>
<p>éæ© <strong>éå¯¹ï¼Pairingï¼</strong>ã<br>
<img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202602/1205021-20260211195228304-800261770.png" class="lazyload"></p>
</li>
<li>
<p>ç¹å» <strong>ç»§ç»­</strong>ã<br>
<img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202602/1205021-20260211195228288-1306513674.png" class="lazyload"></p>
</li>
<li>
<p><strong>å®æéå¯¹</strong><br>
å¨ç»ç«¯æ§è¡ä»¥ä¸å½ä»¤ï¼å° <code>openclaw</code> ä¸ä½ ç Bot ç»å®ï¼</p>
<pre><code class="language-bash">openclaw pairing approve telegram ä½ çéå¯¹ç 
</code></pre>
<p>çå°æåæç¤ºå³è¡¨ç¤ºéå¯¹å®æã<br>
<img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202602/1205021-20260211195228262-596770424.png" class="lazyload"></p>
</li>
</ol>
<hr>
<h2 id="ä¸æµè¯ææ">ä¸ãæµè¯ææ</h2>
<p>ç°å¨åå° Telegram ä¸­ï¼åä½ ç Bot åéä»»ææ¶æ¯ãå¦æä¸åé¡ºå©ï¼ä½ ä¼æ¶å°æ¥èª <code>openclaw</code> çåå¤ï¼è¯´æ Telegram æ¥å¥å·²æåçæï¼</p>
<p><img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202602/1205021-20260211195228355-1235430573.png" class="lazyload"></p>
<hr>
<h2 id="åå¨æå">åå¨æå</h2>
<p>è³æ­¤ï¼ä½ å·²ç»å®æäº <code>openclaw</code> ä¸ Telegram çå¯¹æ¥ãå ä¸ä¹åçé£ä¹¦å Discordï¼ç°å¨ä½ å¯ä»¥å¨è¿ä¸ä¸ªä¸»æµèå¤©å¹³å°ä¸èªç±è°ç¨ AI å©ææ¥å¸®ä½ å¤çä»»å¡äºã</p>
<p>è¿å¥æµç¨è½ç¶æ­¥éª¤ç¨å¤ï¼ä½èå¨æ¸æ°å¯æ§ï¼ä¸æ¬¡éç½®å¥½åå°±å¯ä»¥é¿æä½¿ç¨ãå¦æä½ å¨æä½ä¸­éå°ä»»ä½é®é¢ï¼æ¬¢è¿çè¨äº¤æµï¼æä¼å°½ååå©ã</p>
<p>ä¸ä¸æ­¥ï¼æä»¬å¯ä»¥å°è¯ä¸º <code>openclaw</code> æ¥å¥æ´å¤æ¸ éï¼ææ¯å®å¶ä¸å±æä»¤ï¼è®© AI çæ­£æä¸ºä½ çâæ°å­åå·¥âãæ¬è¯·æå¾åç»­æç¨ï¼</p>


</div>
<div class="clear"></div>

		</div>
		<div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-02-11 19:53">2026-02-11 19:52</span>&nbsp;
<a href="https://www.cnblogs.com/weipo0105">é¿å¡RPA</a>&nbsp;
éè¯»(<span id="post_view_count">23</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19605771);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19605771', targetLink: 'https://www.cnblogs.com/weipo0105/p/19605771', title: 'æéOpenClawä¸Telegramçè¶è¯¦ç»å®ææç¨' })">ä¸¾æ¥</a>
</div>
	 ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ ç®æçåå¸å¼kvè®¾è®¡ ]]></title>
    <link>https://www.cnblogs.com/jackjavacpp/p/19605754</link>
    <guid>41de02f9f6dcc481cf83e91759f9ef13</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/jackjavacpp/p/19605754" title="åå¸äº 2026-02-11 19:47">
    <span role="heading" aria-level="2">ç®æçåå¸å¼kvè®¾è®¡</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h1 id="ç®æçåå¸å¼kvè®¾è®¡--ä¸">ç®æçåå¸å¼kvè®¾è®¡--(ä¸)</h1>
<p><strong>è¿ç¯æç« ç®ååªè®¾è®¡å°éç¾¤å¯å¨ï¼ç¶åèªå¨éä¸»çåè½ã</strong></p>
<p>å°åï¼<a href="https://github.com/Jack-txf/easy-kv" target="_blank" rel="noopener nofollow">https://github.com/Jack-txf/easy-kv</a></p>
<p><strong>TIPS</strong>ï¼æ­¤æç« å¯¹åºçåæ¯çæ¬æ¯<strong>version0211</strong></p>
<p>raftåºç¡ç¥è¯ï¼<a href="https://mp.weixin.qq.com/s/DHO2CK87kI-clf4O96t5Cw" target="_blank" rel="noopener nofollow">https://mp.weixin.qq.com/s/DHO2CK87kI-clf4O96t5Cw</a></p>
<h1 id="1-åè¨">1. åè¨</h1>
<p>å¨ Raft KV ç³»ç»ä¸­ï¼æ¯ä¸ªèç¹ï¼Nodeï¼é½æ¯å¯¹ç­çãä¸ä¸ªå¸åçè¯·æ±æµåæ¯ï¼ <code>Client</code> -&gt; <code>Leader Node</code> -&gt; <code>Raft æ¥å¿åæ­¥</code> -&gt; <code>å¤§å¤æ°èç¹ç¡®è®¤</code> -&gt; <code>åºç¨å°ç¶ææº (KV Store)</code> -&gt; <code>è¿å Client</code>ã</p>
<h1 id="2-è®¾è®¡æ­¥éª¤">2. è®¾è®¡æ­¥éª¤</h1>
<p>Raft æ ¸å¿ç»ä»¶åæ¬ï¼ä¸è´æ§ç»ç¹æ¨¡åï¼RPC éä¿¡ï¼æ¥å¿æ¨¡åã</p>
<h2 id="21-æ¥å¿">2.1 æ¥å¿</h2>
<pre><code class="language-txt">åæ¥å¿ â å¤å¶æ¥å¿ â commit â apply ãleaderåºç¨é¡ºåºã

ç»åä¸ä¸çè¯å°±å¦ä¸ï¼
Client
   â
Leader
   â append log (æ¬å°)
   â
åé AppendEntries
   â
Followers append log
   â
å¤æ°æå
   â
Leader commit
   â
Leader apply
   â
è¿åå®¢æ·ç«¯æå
   â
Leader ä¸æ¬¡å¿è·³å¸¦ commitIndex
   â
Followers apply
</code></pre>
<p>é¦åçä¸ä¸ï¼å®¢æ·ç«¯åéä¸ä¸ªè¯·æ±ï¼æ¶åå°çå¤§è´ä¸è¥¿æåªäºï¼</p>
<img src="https://img2024.cnblogs.com/blog/2358057/202602/2358057-20260211194613207-412932482.png" style="zoom: 80%">
<p>ä»åå¾åçï¼æä»¬éè¦è®¾è®¡çå°±æ¯å¦ä½åå¥æ¥å¿æä»¶ï¼ä»¥åæ¥å¿æä»¶çæ ¼å¼è¯¥å¦ä½è®¾è®¡å¢ï¼æ­¤å¤æä»¬å°±å¼ç®åä¸ç¹å¿å°±å¥½äº</p>
<table>
<thead>
<tr>
<th>totalLength ï¼intï¼</th>
<th>termï¼longï¼</th>
<th>indexï¼longï¼</th>
<th>commandLengthï¼intï¼</th>
<th>commandï¼byte[]ï¼</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ´æ¡log entry é¿åº¦</td>
<td>Raft term</td>
<td>æ¥å¿ index</td>
<td>å½ä»¤é¿åº¦</td>
<td>çæ­£å½ä»¤ï¼è¿ä¸ªè¯å®æ¯åé¿ç</td>
</tr>
</tbody>
</table>
<p>totalLength = 8 (term) + 8 (index) + 4 (commandLength) + commandLength</p>
<pre><code class="language-java">public class LogEntry {
    private final long term;
    private final long index;
    private final String command;
    ....
}
</code></pre>
<p>æ¥å¿å­å¨ä¸ç®¡ç</p>
<pre><code class="language-java">/**
 * @Description: æ¥å¿å­å¨ä¸ç®¡ç
 * @Author: txf
 * @Date: 2026/2/9
 */
public class LogManager {
    // æ¥å¿æä»¶è·¯å¾
    private static final String LOG_FILE_PATH = "easy_kv_log.dat";
    // åå­æ å°çåæ®µå¤§å°ï¼128MBï¼å¯æ ¹æ®åå­è°æ´ï¼,è¿éåè°æ´ä¸ºä¸¤å
    private static final int MAPPED_SIZE = 2 * 1024 * 1024;
    // æä»¶æå¼æ¨¡å¼ï¼rw = è¯»å
    private static final String FILE_MODE = "rw";

    private final File logFile;
    private RandomAccessFile raf;
    private FileChannel fileChannel;
    // å½åæ å°çåå­ç¼å²åº
    private MappedByteBuffer currentMappedBuffer;
    // å½åæ å°æ®µçèµ·å§åç§»ï¼æä»¶åç§»ï¼
    private long currentMappedOffset = 0;
    // å½ååå¥çä½ç½®ï¼ç¸å¯¹äºæä»¶çæ»åç§»ï¼
    private long writePosition = 0;

    public LogManager() {
        this.logFile = new File(LOG_FILE_PATH);
        initFileChannel();
        initMappedBuffer();
        // åå§åæ¶å®ä½å°æä»¶æ«å°¾ï¼ç»§ç»­è¿½å åï¼
        try {
            this.writePosition = fileChannel.size();
        } catch (IOException e) {
            throw new RuntimeException("è·åæä»¶å¤§å°å¤±è´¥", e);
        }
    }

    /**
     * è¿½å åå¥åæ¡æ¥å¿ï¼æ ¸å¿é«æ§è½åå¥ï¼
     * @param term Raftä»»æ
     * @param index æ¥å¿ç´¢å¼
     * @param command KVæä½å½ä»¤ï¼å¦"PUT key value"ï¼
     */
    public void appendLogEntry(long term, long index, String command) {
        // 1. åå¤å½ä»¤å­èæ°ç»
        byte[] commandBytes = command.getBytes(StandardCharsets.UTF_8);
        int commandLength = commandBytes.length;
        // 2. è®¡ç®æ»é¿åº¦
        int totalLength = 4 + 8 + 8 + 4 + commandLength;

        // 3. åå¤ç´æ¥ç¼å²åºï¼å å¤åå­ï¼é¿åæ·è´ï¼
        ByteBuffer directBuffer = ByteBuffer.allocateDirect(totalLength);
        // ææ ¼å¼åå¥ç¼å²åº -- è¿éæ¯åå¥äºè¿å¶çï¼æä»¶åå®¹æä»¬äººç±»å°±è¯»ä¸æäº
        directBuffer.putInt(totalLength);
        directBuffer.putLong(term);
        directBuffer.putLong(index);
        directBuffer.putInt(commandLength);
        directBuffer.put(commandBytes);

        // è¿éæ¯åå¥å­ç¬¦ä¸²ç
        // directBuffer.put((term + index + command).getBytes(StandardCharsets.UTF_8));

        // ç¿»è½¬ç¼å²åºï¼ä»åæ¨¡å¼è½¬ä¸ºè¯»æ¨¡å¼ï¼
        directBuffer.flip();
        // 4. åå¥å°åå­æ å°ç¼å²åºï¼æ ¸å¿ï¼é¶æ·è´ï¼
        writeToMappedBuffer(directBuffer);        // 5. æ´æ°å¨å±åå¥ä½ç½®
        writePosition += totalLength;
    }

    /**
     * å°ç¼å²åºæ°æ®åå¥åå­æ å°åºï¼èªå¨æ©å®¹æ å°æ®µï¼
     */
    private void writeToMappedBuffer(ByteBuffer buffer) {
        while (buffer.hasRemaining()) {
            // æ£æ¥å½åæ å°ç¼å²åºæ¯å¦æè¶³å¤å©ä½ç©ºé´
            if (currentMappedBuffer.remaining() &lt; buffer.remaining()) {
                // ååå¥å½åæ å°åºçå©ä½ç©ºé´
                int remaining = currentMappedBuffer.remaining();
                byte[] temp = new byte[remaining];
                buffer.get(temp);
                currentMappedBuffer.put(temp);
                // å¼ºå¶å·çï¼å°æ å°åå­çæ°æ®åæ­¥å°ç£çï¼å¯éï¼æ¹éå·çå¯æåæ§è½ï¼
                currentMappedBuffer.force();
                // æ©å®¹æ å°æ®µ
                initMappedBuffer();
            } else {
                // ç´æ¥åå¥æ å°ç¼å²åº
                currentMappedBuffer.put(buffer);
            }
        }
    }

    /**
     * è¯»åæå®ç´¢å¼çæ¥å¿æ¡ç®ï¼é«æ§è½è¯»åï¼
     */
    public LogEntry readLogEntry(long index) {
        try {
            // ä½¿ç¨FileChannel + ç´æ¥ç¼å²åºè¯»å
            ByteBuffer directBuffer = ByteBuffer.allocateDirect(1024 * 1024); // 1MBç´æ¥ç¼å²åº
            long fileOffset = 0;
            long fileSize = fileChannel.size();

            while (fileOffset &lt; fileSize) {
                // éç½®ç¼å²åº
                directBuffer.clear();
                // ä»æä»¶æå®åç§»è¯»åæ°æ®å°ç¼å²åº
                int readBytes = fileChannel.read(directBuffer, fileOffset);
                if (readBytes == -1) break;
                directBuffer.flip();

                // è§£æç¼å²åºä¸­çæ¥å¿æ¡ç®
                while (directBuffer.hasRemaining()) {
                    // æ£æ¥å©ä½å­èæ¯å¦è¶³å¤è¯»ååºå®å¤´é¨ï¼4+8+8+4=24å­èï¼
                    if (directBuffer.remaining() &lt; 24) break;
                    // è¯»ååºå®å­æ®µ
                    int totalLength = directBuffer.getInt();
                    long term = directBuffer.getLong();
                    long currentIndex = directBuffer.getLong();
                    int commandLength = directBuffer.getInt();
                    // æ£æ¥å©ä½å­èæ¯å¦è¶³å¤è¯»åcommand
                    if (directBuffer.remaining() &lt; commandLength) {
                        // åéç¼å²åºpositionï¼ä¸æ¬¡ç»§ç»­è§£æ
                        directBuffer.position(directBuffer.position() - 24);
                        break;
                    }
                    // è¯»åcommand
                    byte[] commandBytes = new byte[commandLength];
                    directBuffer.get(commandBytes);
                    String command = new String(commandBytes, StandardCharsets.UTF_8);
                    // æ ¡éªæ»é¿åº¦
                    int actualLength = 4 + 8 + 8 + 4 + commandLength;
                    if (totalLength != actualLength) {
                        throw new RuntimeException("æ¥å¿æä»¶æåï¼æ»é¿åº¦ä¸å¹é");
                    }
                    // æ¾å°ç®æ ç´¢å¼åè¿å
                    if (currentIndex == index) {
                        return new LogEntry(term, index, command);
                    }
                    // æ´æ°æä»¶åç§»
                    fileOffset += totalLength;
                }
            }
        } catch (IOException e) {
            throw new RuntimeException("è¯»åæ¥å¿æ¡ç®å¤±è´¥ [index=" + index + "]", e);
        }
        return null;
    }

    /**
     * å è½½æææ¥å¿æ¡ç®ï¼èç¹å¯å¨æ¶æ¢å¤ï¼
     */
    public List&lt;LogEntry&gt; loadAllLogEntries() {
        List&lt;LogEntry&gt; logEntries = new ArrayList&lt;&gt;();
        try {
            ByteBuffer directBuffer = ByteBuffer.allocateDirect(1024 * 1024);
            long fileOffset = 0;
            long fileSize = fileChannel.size();

            while (fileOffset &lt; fileSize) {
                directBuffer.clear();
                int readBytes = fileChannel.read(directBuffer, fileOffset);
                if (readBytes == -1) break;
                directBuffer.flip();

                while (directBuffer.hasRemaining()) {
                    if (directBuffer.remaining() &lt; 24) break;

                    int totalLength = directBuffer.getInt();
                    long term = directBuffer.getLong();
                    long index = directBuffer.getLong();
                    int commandLength = directBuffer.getInt();

                    if (directBuffer.remaining() &lt; commandLength) {
                        directBuffer.position(directBuffer.position() - 24);
                        break;
                    }

                    byte[] commandBytes = new byte[commandLength];
                    directBuffer.get(commandBytes);
                    String command = new String(commandBytes, StandardCharsets.UTF_8);

                    int actualLength = 4 + 8 + 8 + 4 + commandLength;
                    if (totalLength != actualLength) {
                        throw new RuntimeException("æ¥å¿æä»¶æåï¼æ»é¿åº¦ä¸å¹é");
                    }

                    logEntries.add(new LogEntry(term, index, command));
                    fileOffset += totalLength;
                }
            }
        } catch (IOException e) {
            throw new RuntimeException("å è½½æææ¥å¿æ¡ç®å¤±è´¥", e);
        }
        return logEntries;
    }

    /**
     * å¼ºå¶å·çï¼å°æ å°åå­çæ°æ®åæ­¥å°ç£çï¼
     */
    public void forceFlush() {
        if (currentMappedBuffer != null) {
            currentMappedBuffer.force(); // åæ­¥æ å°åå­å°ç£ç
        }
        try {
            fileChannel.force(true); // å¼ºå¶å·çï¼åå«åæ°æ®ï¼
        } catch (IOException e) {
            throw new RuntimeException("å·çå¤±è´¥", e);
        }
    }

    /**
     * å³é­èµæºï¼å¿é¡»è°ç¨ï¼å¦åä¼å¯¼è´æä»¶å¥ææ³æ¼ï¼
     */
    public void close() {
        try {
            forceFlush();
            if (fileChannel != null) {
                fileChannel.close();
            }
            if (raf != null) {
                raf.close();
            }
        } catch (IOException e) {
            throw new RuntimeException("å³é­èµæºå¤±è´¥", e);
        }
    }
    /**
     * åå§å/æ©å®¹åå­æ å°ç¼å²åº
     */
    private void initMappedBuffer() {
        try {
            // è®¡ç®éè¦æ å°çèµ·å§ä½ç½®åå¤§å°
            long fileSize = fileChannel.size();
            // å¦æå½åæ å°æ®µå·²åæ»¡ï¼æé¦æ¬¡åå§åï¼åå»ºæ°çæ å°
            if (currentMappedBuffer == null || writePosition &gt;= currentMappedOffset + MAPPED_SIZE) {
                currentMappedOffset = (writePosition / MAPPED_SIZE) * MAPPED_SIZE;
                // æ å°æä»¶çæå®åºé´å°åå­ï¼FileChannel.MapMode.READ_WRITEï¼è¯»åæ¨¡å¼ï¼
                currentMappedBuffer = fileChannel.map(
                        FileChannel.MapMode.READ_WRITE,
                        currentMappedOffset,
                        MAPPED_SIZE
                );
                // å°ç¼å²åºçpositionå®ä½å°å½ååå¥ä½ç½®ç¸å¯¹äºæ å°æ®µçåç§»
                currentMappedBuffer.position((int) (writePosition - currentMappedOffset));
            }
        } catch (IOException e) {
            throw new RuntimeException("åå§ååå­æ å°ç¼å²åºå¤±è´¥", e);
        }
    }

    /**
     * åå§åFileChannelï¼æ ¸å¿é«æ§è½ééï¼
     */
    private void initFileChannel() {
        try {
            // ä¸å­å¨ååå»ºæä»¶
            if (!logFile.exists()) {
                boolean newFile = logFile.createNewFile();
                if (!newFile) {
                    throw new RuntimeException("åå»ºæä»¶å¤±è´¥");
                }
            }
            this.raf = new RandomAccessFile(logFile, FILE_MODE);
            this.fileChannel = raf.getChannel();
        } catch (IOException e) {
            throw new RuntimeException("åå§åFileChannelå¤±è´¥", e);
        }
    }
}
</code></pre>
<h2 id="22-æå¡ç«¯è®¾è®¡">2.2 æå¡ç«¯è®¾è®¡</h2>
<h3 id="221-æ¶æ¯è®¾è®¡">2.2.1 æ¶æ¯è®¾è®¡</h3>
<p>æ¥å¿è®¾è®¡å¥½äºä¹åï¼æ¥ä¸æ¥çæå¡ç«¯å¦ä½è®¾è®¡ãæä»¬ä½¿ç¨çæ¯nettyæ¡æ¶ï¼è¦æ±ænettyåºç¡ãç¶ååºåååè®®éç¨çæ¯protobufï¼è¯»èå¯ä»¥åèè¿ç¯æç« ï¼<a href="https://mp.weixin.qq.com/s/kg_-AMHRn_DzFbfBnkK4VQ" target="_blank" rel="noopener nofollow">https://mp.weixin.qq.com/s/kg_-AMHRn_DzFbfBnkK4VQ</a> è¿ç¯æç« å¤§è´è®²è§£äºä¸ä¸è¯¥åºåååè®®ï¼å¹¶ä¸ä¹æ¯éç¨nettyæ´åçãæ ¹æ®protoæä»¶çæç±»çå½ä»¤å¦ä¸ï¼ä¹å¯ä»¥ç¨ideaçæä»¶èªå¨çæã</p>
<pre><code class="language-proto">protoc  --proto_path=xxxxç®å½  --java_out=xxxç®å½  å·ä½çprotoæä»¶
</code></pre>
<p>æ¶æ¯æ¨¡æ¿å¦ä¸ï¼</p>
<pre><code class="language-proto">syntax = "proto3";
option java_outer_classname = "KvRaftProto"; // çæçå¤å±ç±»å
option java_multiple_files = false; // çæå¤ä¸ªç¬ç«çJavaç±»ï¼èéåé¨ç±»ï¼

// ===================== 1. éç¨æ¶æ¯å°è£ä½ï¼æ ¸å¿ï¼ =====================
// Nettyä¼ è¾æ¶åªä¼ è¿ä¸ªæ¶æ¯ï¼éè¿typeè¯å«å·ä½æ¶æ¯ç±»å
message RaftKvMessage {
  // æ¶æ¯ç±»åæä¸¾ï¼è¦çææäº¤äºåºæ¯ï¼
  enum MessageType {
    UNKNOWN = 0; // æªç¥ç±»åï¼ååºï¼
    // å®¢æ·ç«¯ â èç¹ï¼KVæä½
    KV_REQUEST = 1;    // å®¢æ·ç«¯åèµ·KVè¯·æ±ï¼PUT/GET/DELETEï¼
    KV_RESPONSE = 2;   // èç¹ååºå®¢æ·ç«¯KVè¯·æ±
    // èç¹ â èç¹ï¼Raftå±è¯
    VOTE_REQUEST = 3;  // éä¸¾è¯·æ±ï¼CandidateâFollowerï¼
    VOTE_RESPONSE = 4; // éä¸¾ååºï¼FollowerâCandidateï¼
    APPEND_ENTRIES_REQUEST = 5;  // æ¥å¿è¿½å /å¿è·³ï¼LeaderâFollowerï¼
    APPEND_ENTRIES_RESPONSE = 6; // æ¥å¿è¿½å ååºï¼FollowerâLeaderï¼
  }

  MessageType type = 1; // æ¶æ¯ç±»åï¼å¿ä¼ ï¼
  string node_id = 2;   // åéæ¹èç¹IDï¼ç¨äºè¯å«èç¹ï¼

  // å·ä½æ¶æ¯ä½ï¼æ ¹æ®typeéæ©å¶ä¸­ä¸ä¸ªï¼
  KvRequest kv_request = 3;
  KvResponse kv_response = 4;
  VoteRequest vote_request = 5;
  VoteResponse vote_response = 6;
  AppendEntriesRequest append_entries_request = 7;
  AppendEntriesResponse append_entries_response = 8;
}

// ===================== 2. å®¢æ·ç«¯KVæä½ç¸å³ =====================
// å®¢æ·ç«¯åèµ·çKVè¯·æ±ï¼PUT/GET/DELETEï¼
message KvRequest {
  enum OpType {
    PUT = 0;    // åå¥/æ´æ°
    GET = 1;    // è¯»å
    DELETE = 2; // å é¤
  }
  OpType op_type = 1; // æä½ç±»åï¼å¿ä¼ ï¼
  string key = 2;     // KVçkeyï¼å¿ä¼ ï¼
  string value = 3;   // KVçvalueï¼ä»PUTæ¶ä¼ ï¼
  // å¯éï¼è¯·æ±IDï¼ç¨äºå¹ç­æ§ï¼é²æ­¢éå¤è¯·æ±ï¼
  string request_id = 4;
}

// èç¹ååºå®¢æ·ç«¯çKVç»æ
message KvResponse {
  bool success = 1;    // æä½æ¯å¦æå
  string message = 2;  // éè¯¯ä¿¡æ¯/æç¤ºï¼å¤±è´¥æ¶å¿ä¼ ï¼
  string value = 3;    // è¿åçvalueï¼ä»GETæåæ¶ä¼ ï¼
  string request_id = 4; // å¯¹åºè¯·æ±çIDï¼å¹ç­æ§ï¼
}

// ===================== 3. Raftéä¸¾ç¸å³ =====================
// CandidateåFolloweråèµ·çæç¥¨è¯·æ±
message VoteRequest {
  int64 term = 1;                // Candidateçå½åä»»æï¼å¿ä¼ ï¼
  string candidate_id = 2;       // Candidateçèç¹IDï¼å¿ä¼ ï¼
  int64 last_log_index = 3;      // Candidateæåä¸æ¡æ¥å¿çç´¢å¼ï¼ç¨äºæ¥å¿ä¸è´æ§æ£æ¥ï¼
  int64 last_log_term = 4;       // Candidateæåä¸æ¡æ¥å¿çä»»æï¼ç¨äºæ¥å¿ä¸è´æ§æ£æ¥ï¼
}

// FollowerååºCandidateçæç¥¨ç»æ
message VoteResponse {
  int64 term = 1;                // Followerçå½åä»»æï¼å¿ä¼ ï¼ç¨äºæ´æ°Candidateçä»»æï¼
  bool vote_granted = 2;         // æ¯å¦æèµæç¥¨ï¼å¿ä¼ ï¼
}

// ===================== 4. Raftæ¥å¿è¿½å /å¿è·³ç¸å³ =====================
// æ¥å¿æ¡ç®ï¼ä¸ä½ è®¾è®¡çæ¥å¿æ ¼å¼å¯¹é½ï¼åºåååå¯ç´æ¥åå¥æ¥å¿æä»¶ï¼
message LogEntry {
  int64 term = 1;        // Raftä»»æï¼å¯¹åºä½ æ¥å¿æ ¼å¼çtermï¼
  int64 index = 2;       // æ¥å¿ç´¢å¼ï¼å¯¹åºä½ æ¥å¿æ ¼å¼çindexï¼
  string command = 3;    // KVæä½å½ä»¤ï¼å¦"PUT key1 value1"ï¼å¯¹åºä½ æ¥å¿æ ¼å¼çcommandï¼
}

// LeaderåFolloweråéçæ¥å¿è¿½å /å¿è·³è¯·æ±
message AppendEntriesRequest {
  int64 term = 1;                // Leaderçå½åä»»æï¼å¿ä¼ ï¼
  string leader_id = 2;          // Leaderçèç¹IDï¼å¿ä¼ ï¼
  int64 prev_log_index = 3;      // åä¸æ¡æ¥å¿çç´¢å¼ï¼ç¨äºæ¥å¿ä¸è´æ§æ£æ¥ï¼
  int64 prev_log_term = 4;       // åä¸æ¡æ¥å¿çä»»æï¼ç¨äºæ¥å¿ä¸è´æ§æ£æ¥ï¼
  repeated LogEntry entries = 5; // å¾è¿½å çæ¥å¿æ¡ç®ï¼å¿è·³æ¶ä¸ºç©ºï¼
  int64 leader_commit = 6;       // Leaderå·²æäº¤çæ¥å¿ç´¢å¼ï¼Followeræ®æ­¤æ´æ°èªå·±çæäº¤ç´¢å¼ï¼
}

// FollowerååºLeaderçæ¥å¿è¿½å ç»æ
message AppendEntriesResponse {
  int64 term = 1;                // Followerçå½åä»»æï¼å¿ä¼ ï¼ç¨äºæ´æ°Leaderçä»»æï¼
  bool success = 2;              // æ¥å¿è¿½å æ¯å¦æåï¼å¿ä¼ ï¼
  int64 match_index = 3;         // Followerå·²å¹éçæ¥å¿ç´¢å¼ï¼Leaderæ®æ­¤æ´æ°nextIndexï¼
}
</code></pre>
<p>ä¸é¢æ¯æ¶æ¯çå¤§è´æ ¼å¼ã</p>
<p>æ¥ä¸æ¥çæå¡ç«¯çèç¹è®¾è®¡ï¼æä»¬ä»nettyæå¡å¯å¨å¼å§å¾ä¸çï¼</p>
<p>å¨kv-coreçappåéé¢</p>
<pre><code class="language-java">public static void main(String[] args) {
    int port = getPort(args);
    RaftNettyServer raftNettyServer = new RaftNettyServer(port);
    try {
        raftNettyServer.start();
    } catch (InterruptedException e) {
        throw new RuntimeException(e);
    }
}

private static int getPort(String[] args) {
    for (String arg : args) {
        if (arg.startsWith("node.port=")) {
            return Integer.parseInt(arg.substring(10));
        }
    }
    return 7777;
}
</code></pre>
<p>ä»javaç¨åºå¯å¨çå½ä»¤è¡è¯»åç»ç¹çç«¯å£åæ°ï¼æä»¬å¯ä»¥ç¨ä¸å°çµèå¼å¯å¤ä¸ªåºç¨ï¼å¨ideaä¸­è¿æ ·éç½®å°±å¯ä»¥äºï¼å¦ä¸å¾æç¤º</p>
<img src="https://img2024.cnblogs.com/blog/2358057/202602/2358057-20260211194613557-847947640.png" style="zoom: 50%">
<p>ä»ä¸å¾ä¸­å¯ä»¥çå°ï¼éç½®äºä¸ä¸ªèç¹ï¼ç¶åæ¬é¡¹ç®çjdkæ¯éç¨ç21è¿ä¸ªçæ¬ãéç½®å¥½äºä¹åï¼å¨ideaçserviceséé¢å¯ä»¥æè¿äºéç½®ä¸èµ·å è¿å»ï¼ç¶åå°±å¯ä»¥åæ¶å¯å¨å¤ä¸ªèç¹äºã</p>
<h3 id="222-è¿æ¥è®¾è®¡">2.2.2 è¿æ¥è®¾è®¡</h3>
<pre><code class="language-java">RaftNettyServer raftNettyServer = new RaftNettyServer(port);
...
raftNettyServer.start();
</code></pre>
<p>ä»ä¸ä¸èçå¯å¨ç±»çåºæ¥ä¸»è¦å°±æ¯newäºä¸ä¸ªserverå¯¹è±¡ï¼ç¶åè°ç¨startæ¹æ³ãæä»¬é¡ºçè¿ä¸¤ä¸ªçå°±å¯ä»¥äºã</p>
<p>é¦åæ¯æé æ¹æ³ï¼</p>
<pre><code class="language-java">public class RaftNettyServer {
  	....
    private final int port;
    private final RaftNode node;

    public RaftNettyServer(int port) {
        this.port = port;
         // è¿éåå»ºäºä¸ä¸ªraftç»ç¹å¯¹è±¡
        this.node = new RaftNode(port);
    }
}

// è¿ä¸ªæ¯RaftNodeç±»ï¼
public RaftNode(int port) {
    this.port = port;

    // ä»éç½®æä»¶ä¸­æ¾å°èªå·±
    this.nodesConfig = new NodesConfig();
    this.nodeId = nodesConfig.findSelf(port);

    // éè¦æèªèº«ç»ç¹
    this.rpcPeers = nodesConfig.getNodeList().stream()
        // nodeçæ ¼å¼æ¯'ip:port'
        .map(node -&gt; new RpcPeer(node, node.split(":")[0],
                                 Integer.parseInt(node.split(":")[1]), this))
        .toList();

    this.logManager = new LogManager();
    this.storage = new MemoryStorage();

    // æä¸¤ä¸ªæ¶é´ååå§åå¯
    this.electionTimeout = 8000 + ThreadLocalRandom.current().nextInt(4000);
    this.lastHeartbeatTime = System.currentTimeMillis();
    log.info("åå§åéä¸¾è¶æ¶ï¼{}", electionTimeout);

    // å®æ¶å¨
    scheduler = Executors.newScheduledThreadPool(2);
    scheduler.scheduleAtFixedRate(this::tick, 2, 2000, TimeUnit.MILLISECONDS);
}
</code></pre>
<p>Raftç±»æ¯ææ ¸å¿çä¸ä¸ªç±»ãä¸é¢çæé æ¹æ³å¶å®å¾ç®åãè¯»èèªè¡çè§£ãéè¦è¯´æä¸ä¸çå°±æ¯nodeIdçæ ¼å¼ï¼ãip:ç«¯å£ã</p>
<pre><code class="language-java">127.0.0.1:8888 // å°±æ¯è¿ç§å­ç¬¦ä¸²çæ ¼å¼
</code></pre>
<p>è¿æè¦è¯´æçå°±æ¯rpcPeersè¿ä¸ªListçæå»ºï¼å¯ä»¥çåºæ¥åæ¯ä»éç½®æä»¶è¯»åå°äºéç¾¤èç¹åè¡¨ï¼ç¶åéåè¿ä¸ªåè¡¨åå»ºäºå¯¹è±¡ï¼è¿ä¸ªå·ä½æ¯ä»ä¹ææå¢ï¼</p>
<p>é¦åçä¸ä¸Nettyçå®¢æ·ç«¯åéè¯·æ±å°æå¡ç«¯ï¼æå¡ç«¯å¤çåå¨è¿åç»å®¢æ·ç«¯ï¼å®¢æ·ç«¯æ ¹æ®ååºç»æè¿è¡é»è¾å¤çãè¿æ ·ä¸ä¸ªç¤ºæå¾ï¼</p>
<img src="https://img2024.cnblogs.com/blog/2358057/202602/2358057-20260211194613912-363189595.png" style="zoom: 50%">
<p>åçä¸ä¸ä¸é¢çè¿æ¥ç¤ºæå¾ï¼</p>
<img src="https://img2024.cnblogs.com/blog/2358057/202602/2358057-20260211194614275-746707923.png" style="zoom: 50%">
<p>NettyClientä¸ä»ä»æ¯ç»å®¢æ·ç¨çï¼éç¾¤ç»ç¹åé¨äºç¸éä¿¡ä¹è¦ç¨å°è¿ä¸ªï¼rpcPeerså°±æ¯éç¾¤èç¹åé¨éä¿¡ä½¿ç¨çãå¦ä¸å¾æç¤ºï¼æ¯ä¸ªèç¹é½æä¸ä¸ªNettyServerå¯å¨å¹¶çå¬çç«¯å£ï¼åæ¶Leaderç»ç¹éè¦ç»ææçFollowerç»ç¹åéå¿è·³è¯·æ±ï¼æ­¤æ¶è¿ä¸ªLeaderç¸å½äºå¶ä»ä¸¤ä¸ªFollowerç»ç¹å°±ç¸å½äºClientäºï¼æä»¥å¨ç»ç¹ä¸éé¢æclientçé¨åï¼å¨é¡¹ç®å½å°äºrpcçåä¸ï¼ä¹å°±æ¯ä¸é¢é£ä¸ªrpcPeersçç±æ¥äºã</p>
<p>å¨éç¾¤å¯å¨çæ¶åï¼é½æ¯Followerç»ç¹ï¼åªæç­å°è¶æ¶äºæä¼å¼å§éä¸»ï¼å¨æ­¤ä¹åï¼æ¯ä¸ªèç¹é½ææä¸ºCandidateçå¯è½ï¼ä¹å°±æ¯è¯´æ¯ä¸ªèç¹é½æåå¶ä»ç»ç¹åéæç¥¨è¯·æ±çå¯è½ï¼VoteRequestï¼ï¼é£ä¹æ¯ä¸ªèç¹éé¢é½è¦æä¸å¥Netty Clientåå¤çæµç¨ãå°±å¦ä¸å¾æç¤ºï¼</p>
<img src="https://img2024.cnblogs.com/blog/2358057/202602/2358057-20260211194614720-1938302844.png" style="zoom: 50%">
<p>è¿æ ·å°±æä¸ä¸ªé®é¢äºï¼ä¸ä¸ªèç¹ï¼æå°±è¦å­ä¸ªtcpè¿æ¥äºï¼åä¸ªèç¹å°±è¦12ä¸ªè¿æ¥ï¼åä¸ªèç¹å¢ï¼å°±è¦90ä¸ªè¿æ¥ï¼è¿ä¹å¤ªå¤äºå§ï¼é£ä¹ç¡®å®æ¯çãæä¸ä¸ªæè·¯æ¯æä¸ä¸ªä¸­é´å±å«årouteCenterï¼ææç»ç¹è¿åå®ï¼ç¶åæ¶æ¯é½ç»è¿è¿ä¸ªè·¯ç±ä¸­å¿æ¥è½¬åï¼è¿æ ·è¿æ¥æ°å°±ä¼å°å¾å¤äºã</p>
<p>è¿æä¸ä¸ªæè·¯ï¼åæ­£NettyClient + ä¸ä¸ªNettyServeræå»ºåºä¸ä¸ªChannelï¼çè®ºä¸æåªéè¦ä¸ä¸ªtcpè¿æ¥å°±å¯ä»¥äºåãå¦ä¸å¾æç¤ºï¼</p>
<img src="https://img2024.cnblogs.com/blog/2358057/202602/2358057-20260211194615069-208910434.png" style="zoom: 50%">
<p>ä½æ¯è¿æ ·çè¯ï¼èç¹é´éä¿¡éè¦è½¬åäºï¼ä»£ç é»è¾å°±å¤ªå¤æäºï¼åµä¸è¿æä¸ä¸ªé®é¢ï¼é£å°±æ¯å¦ä½ç¡®å®è¿ä¸ªtcpçè¿æ¥é¡ºåºå¢ï¼è¿ä¸ªå¯ä»¥æç§nodeIdçå­å¸é¡ºåºæ¥åãåæ­£å°±æ¯éº»ç¦å°±å®äºå¿äºããã</p>
<p>ç»¼ä¸æè¿°ï¼è¿æ¯æå¼å§çæ¹æ¡æç®åç´æ¥äºï¼åæ­£è¿å°±æ¯ä¸ä¸ªç®æçæ¡ä¾ï¼ä¸è¦èèå¤ªå¤äºãå¦ææä¸äºå¶ä»åéçæè·¯ï¼æ¬¢è¿è¯»èç»åºã</p>
<p>èç¹ä¹é´çè¿æ¥è®¾è®¡å°±æ¯ä¸é¢çæ ·å­äºã</p>
<p>æ¥ä¸æ¥çRaftNodeçè®¾è®¡ã</p>
<h3 id="223-raftnodeè®¾è®¡">2.2.3 RaftNodeè®¾è®¡</h3>
<p>é£å°±ä»æé å¨å¼å§çå§ï¼</p>
<pre><code class="language-java">public RaftNode(int port) {
    this.port = port;

    // ä»éç½®æä»¶ä¸­æ¾å°èªå·±
    this.nodesConfig = new NodesConfig();
    this.nodeId = nodesConfig.findSelf(port);

    // éè¦æèªèº«ç»ç¹
    this.rpcPeers = nodesConfig.getNodeList().stream()
        // nodeçæ ¼å¼æ¯'ip:port'
        .map(node -&gt; new RpcPeer(node, node.split(":")[0],
                                 Integer.parseInt(node.split(":")[1]), this))
        .toList();

    this.logManager = new LogManager();
    this.storage = new MemoryStorage();

    // æä¸¤ä¸ªæ¶é´ååå§åå¯
    this.electionTimeout = 8000 + ThreadLocalRandom.current().nextInt(4000);
    this.lastHeartbeatTime = System.currentTimeMillis();
    log.info("åå§åéä¸¾è¶æ¶ï¼{}", electionTimeout);

    // å®æ¶å¨
    scheduler = Executors.newScheduledThreadPool(2);
    scheduler.scheduleAtFixedRate(this::tick, 2, 2000, TimeUnit.MILLISECONDS);
}
</code></pre>
<p>å¯ä»¥çå°é½æ¯åä¸äºåå§åçå·¥ä½ï¼ç¶åä¸é¢æ¯å¼å¯äºä¸ä¸ªå®æ¶ä»»å¡tick</p>
<pre><code class="language-java">private void tick() {
    log.info("æ£æ¥æ¯å¦è¶æ¶ï¼{} ç¶æ: {}", nodeId, state);
    try {
        if (state != NodeState.LEADER &amp;&amp; isTimeout()) {
            becomeCandidate();
        } else if (state == NodeState.LEADER) {
            // sendHeartbeats();
        }
    } catch ( Exception e ) {
        log.error("{} èç¹tickå®æ¶ä»»å¡å¼å¸¸", nodeId, e);
    }
}
private void becomeCandidate() {
    log.info("{} éä¸¾è¶æ¶ï¼è½¬ä¸º Candidateï¼å¼å§ä»»æ: {}", nodeId, currentTerm.get() + 1);
    state = NodeState.CANDIDATE;
    currentTerm.getAndIncrement(); // ä»»æ+1
    votedFor = nodeId; // ç»èªå·±æä¸ç¥¨
    resetElectionTimeout();
    // éç¾¤åéæç¥¨è¯·æ±
    requestVotes();
}
 private boolean isTimeout() {
     return System.currentTimeMillis() - lastHeartbeatTime &gt; electionTimeout;
 }
private void resetElectionTimeout() {
    // 8000ms ~ 12000ms éæºè¶æ¶ï¼é¿åå¹³ç¥¨
    this.electionTimeout = 8000 + ThreadLocalRandom.current().nextInt(4000);
    log.info("éç½® {} èç¹éä¸¾æ¶é´ï¼éæºè¶æ¶ï¼{} ms", nodeId, electionTimeout);
    this.lastHeartbeatTime = System.currentTimeMillis();
}
</code></pre>
<p>ä¸»è¦å°±æ¯çbecomeCandidateè¿ä¸ªæ¹æ³æåçåéç¾¤åéæç¥¨è¯·æ±ã</p>
<pre><code class="language-java">private void requestVotes() {
    // 1. åå§åç¥¨æ°ï¼èªå·±çä¸ç¥¨
    AtomicInteger grantedVotes = new AtomicInteger(1);
    long count = rpcPeers.stream().filter(peer -&gt; !peer.isSelf()).count(); // ä¸åå«èªå·±çç»ç¹æ°
    int majority = (int) ((count + 1) / 2 + 1); // æ»èç¹æ°(åå«èªå·±)çåæ°ä»¥ä¸

    // 2.æé æç¥¨æ¶æ¯
    KvRaftProto.VoteRequest voteRequest = KvRaftProto.VoteRequest.newBuilder()
        .setTerm(currentTerm.get())
        .setCandidateId(nodeId)
        .setLastLogIndex(logManager.getLastLogIndex())
        .setLastLogTerm(logManager.getLastLogTerm())
        .build();
    // 3. åéæç¥¨è¯·æ±
    // æå»ºä¸ä¸ªå¯¹è±¡ï¼è¡¨ç¤ºå½åæç¥¨è¯·æ±çç¶æ
    // String voteId = UUID.randomUUID().toString().replaceAll("-", "");
    // è¿éä¸ºä»ä¹å¯ä»¥ç¨termï¼å ä¸º Raft è§å®ï¼ä¸ä¸ªèç¹å¨ä¸ä¸ª term ååªè½æä¸å¼ ç¥¨ã
    // æä»¥ï¼åªè¦ term å¹éï¼è¿ä¸ªååºå°±ä¸å®æ¯éå¯¹ä½ å½ååèµ·çè¿ä¸è½®éä¸¾çã
    GlobalVoteManager.setVoteState(currentTerm.get(), new VoteState(nodeId, currentTerm.get(), majority));

    int countSend = 0;
    for (RpcPeer peer : rpcPeers) {
        if (!peer.isSelf()) { // ä¸æ¯èªèº«ç»ç¹ï¼å°±åéæç¥¨è¯·æ±
            // sendæ¹æ³å°±å¾ç®åäºï¼è¯·è¯»èèªè¡æ¥ç
            boolean send = peer.send(KvRaftProto.RaftKvMessage.newBuilder()
                                     .setType(KvRaftProto.RaftKvMessage.MessageType.VOTE_REQUEST)
                                     .setVoteRequest(voteRequest)
                                     .build());
            if ( send ) countSend++;
        }
    }
    log.info("åéæç¥¨è¯·æ±ï¼{}ï¼å·²åéç»äº {} ä¸ªç»ç¹..", voteRequest, countSend);
}
</code></pre>
<p>è¿æ ·æç¥¨è¯·æ±å°±åéåºå»äºï¼æ­¤æ¶ç»ç¹æ¯ä½ä¸ºå®¢æ·ç«¯åéç»å¶ä»èç¹çï¼æ¥ä¸æ¥çé»è¾å°±æ¯å¶ä»èç¹æ¥æ¶å°voteRequestè¯·æ±ç¶ååé»è¾å¤çï¼æä»¥å°±è¦å¨serveråä¸é¢å»æ¥çå·ä½é»è¾ã</p>
<pre><code class="language-java">// å¨kv-coreçserveråä¸é¢çKvBusinessHandler.java
// 1.å¦ææ¯æç¥¨è¯·æ±
if ( raftKvMessage.getType() == KvRaftProto.RaftKvMessage.MessageType.VOTE_REQUEST) {
    log.info("receive vote request.........");
    KvRaftProto.VoteRequest voteRequest = raftKvMessage.getVoteRequest();
    // å¯ä»¥çå°äº¤ç»äºnodeå»å¤ç
    KvRaftProto.VoteResponse voteResponse = node.tackleVoteRequest(voteRequest);
    ctx.writeAndFlush(KvRaftProto.RaftKvMessage.newBuilder()
                      .setType(KvRaftProto.RaftKvMessage.MessageType.VOTE_RESPONSE)
                      .setVoteResponse(voteResponse)
                      .build());
}

// ååå°äºRaftNodeç±»äº
public KvRaftProto.VoteResponse tackleVoteRequest(KvRaftProto.VoteRequest voteRequest) {
    // æ¯è¾ä»»æ
    if (voteRequest.getTerm() &lt; currentTerm.get()) {
        log.info("{} æç¥¨è¯·æ±ä»»æå¤ªå°ï¼æç»æç¥¨", nodeId);
        return buildVoteResponse(false, currentTerm.get());
    }
    if ( votedFor != null &amp;&amp; !voteRequest.getCandidateId().equals(votedFor) ) {
        log.info("{}å·²æç»å¶ä»äººï¼æç»è¯¥æç¥¨è¯·æ±", nodeId);
        return buildVoteResponse(false, currentTerm.get());
    }
    // åæ¯è¾æ¥å¿æåµ
    if ( voteRequest.getLastLogIndex() &gt;= logManager.getLastLogIndex() &amp;&amp;
        voteRequest.getLastLogTerm() &gt;= logManager.getLastLogTerm() ) {
        log.info("{} æç¥¨è¯·æ±okï¼èµææç¥¨", nodeId);
        currentTerm.set(voteRequest.getTerm()); // æ´æ°èªå·±çä»»æ
        votedFor = voteRequest.getCandidateId(); // æç¥¨ç»è¯¥èç¹
        return buildVoteResponse(true, voteRequest.getTerm());
    }
    log.info("{} æç¥¨è¯·æ±æ¥å¿å¤ªæ§ï¼æç»è¯¥æç¥¨è¯·æ±", nodeId);
    return buildVoteResponse(false, currentTerm.get());
}
</code></pre>
<p>å¶ä»èç¹æ¶å°äºæç¥¨è¯·æ±ï¼ä¼è¿åresponseç»candidateç»ç¹ï¼candidateç»ç¹æ¯ä½ä¸ºClientåéçæç¥¨è¯·æ±ï¼æ¶å°çååºè¯å®æ¯å¨å®¢æ·ç«¯çå¤çå¨handlerï¼æ¥ä¸æ¥çé»è¾å°±è¦å¨rpcåä¸é¢çRpcClientHandlerå»æ¥çäºï¼</p>
<pre><code class="language-java">@Override
protected void channelRead0(ChannelHandlerContext ctx, KvRaftProto.RaftKvMessage msg) {
    // 2.VOTE_RESPONSE æç¥¨è¯·æ±åæ¥çååºãæç¥¨è¯·æ±æ¯ç»ç¹ä½ä¸ºå®¢æ·ç«¯ååºçï¼åºè¯¥å¨å®¢æ·ç«¯çhandlerå¤çååºã
    if (msg.getType() == KvRaftProto.RaftKvMessage.MessageType.VOTE_RESPONSE) {
        log.info("receive vote response.........");
        KvRaftProto.VoteResponse voteResponse = msg.getVoteResponse();
        raftNode.tackleVoteResponse(voteResponse); // ååå°äºRaftNode
    }
}

// RaftNode.java
// æç¥¨ç»æå¤ç,ãæç¥¨è¯·æ±æ¯ç»ç¹ä½ä¸ºå®¢æ·ç«¯ååºçï¼è¦å¨å®¢æ·ç«¯çhandlerå¤çååºã
public synchronized void tackleVoteResponse(KvRaftProto.VoteResponse voteResponse) {
    long term = voteResponse.getTerm();
    // 2. åç°æ´é«ä»»æï¼ç«å³éçº§å¹¶æ´æ°
    // 1. ä»»ææ£æ¥ï¼å¯¹æ¹æ¯æå¤§ï¼æç«å³è®¤è¾
    if (term &gt; currentTerm.get()) {
        stepDown(term);
        return;
    }
    // 2. ç¶ææ£æ¥ï¼å¦ææå·²ç»ä¸æ¯ Candidate äºï¼æ¯å¦å·²ç»è¶æ¶ééææ¶å°å¿è·³ï¼ï¼å¿½ç¥
    if (state != NodeState.CANDIDATE) return;

    // 3. ä»»æå¹éæ£æ¥ï¼ç¡®ä¿è¿æ¯å¯¹âå½åè¿ä¸è½®âéä¸¾çåå¤
    // å¦ææ¶å°çååºä»»ææ¯å½åå°ï¼è¯´ææ¯ä¹åè¿æçéä¸¾åå¤ï¼ç´æ¥ä¸¢å¼
    if (term &lt; currentTerm.get()) {
        return;
    }

    // 4. ä»å¨å±ç®¡çå¨è·åå½åéä¸¾çæç¥¨ç¶æ
    VoteState voteState = GlobalVoteManager.getVoteState(term);
    if (voteState == null) {
        log.error("æªæ¾å°ä»»æ {} çæç¥¨è®°å½ç¶æ", term);
        return;
    }

    // 5. å¦æå¯¹æ¹æäºèµæç¥¨
    if (voteResponse.getVoteGranted()) {
        // å¢å ç¥¨æ°ï¼è¿é AtomicInteger å¨ VoteState åé¨ä¿è¯äºçº¿ç¨å®å¨ï¼
        // ä½ç±äºæ¬æ¹æ³å äº synchronizedï¼å¶å®åéä¿é©ï¼
        int currentVotes = voteState.addVote();
        int majority = voteState.getMajority();
        log.info("èµæç¥¨ï¼å½åç¥¨æ°: {}/{}", currentVotes, nodesConfig.getNodeList().size());

        // 6. æ£æ¥æ¯å¦è¾¾å°å¤æ°æ´¾
        if (currentVotes &gt;= majority) {
            log.info("èç¹ {} è·å¾è¿åéç¥¨ ({})ï¼åå¤æåä¸º Leader", nodeId, currentVotes);
            becomeLeader();
        }
    } else {
        log.info("æç»äºæçæç¥¨è¯·æ±");
    }
}
private synchronized void becomeLeader() {
    if (state != NodeState.CANDIDATE) return;
    if (state == NodeState.LEADER) return;

    this.state = NodeState.LEADER;
    log.info("Node {} èµ¢å¾éä¸¾ï¼å³å°æä¸º Leader, Term: {}", nodeId, currentTerm.get());
    // 1. æ¸çä¸ä¸ä»»æçæ®çç¶æ
    this.votedFor = null;

    // 2. ç«å³åéç¬¬ä¸æ³¢å¿è·³ï¼å®£ç¤ºä¸»æ (é²æ­¢å¶ä»èç¹åè¶æ¶)
    sendHeartbeats();

    // 3. å¯å¨å®æ¶å¿è·³ä»»å¡ (æ¯å¦æ¯ 2 ç§ä¸æ¬¡)
    if (heartbeatTask != null) heartbeatTask.cancel(true);
    heartbeatTask = scheduler.scheduleAtFixedRate(this::sendHeartbeats,
                                                  0, 1000, TimeUnit.MILLISECONDS);
    log.info("&lt;&lt;&lt;&lt;&lt; èç¹ {} æ­£å¼æä¸º Term {} ç Leader &gt;&gt;&gt;&gt;&gt;", nodeId, currentTerm.get());
}
</code></pre>
<h1 id="3å¯å¨æµè¯éä¸»">3.å¯å¨æµè¯éä¸»</h1>
<p>æéç½®å¥½çä¸ä¸ªèç¹å¯å¨ä¸ä¸ççç»æ</p>
<p><img src="https://img2024.cnblogs.com/blog/2358057/202602/2358057-20260211194611564-1443963355.png" alt="" loading="lazy"></p>
<hr>
<p><img src="https://img2024.cnblogs.com/blog/2358057/202602/2358057-20260211194612379-843476723.png" alt="" loading="lazy"></p>
<hr>
<p><img src="https://img2024.cnblogs.com/blog/2358057/202602/2358057-20260211194612841-1185877353.png" alt="" loading="lazy"></p>
<p>ä»ä¸å¾å¯ä»¥çåºï¼ç«¯å£9999æä¸ºäºLeaderç»ç¹ï¼ç¶ååå¶ä»èç¹åéå¿è·³æ°æ®äºã</p>
<p>æ¥ä¸æ¥å°±æ¯å®åä¸ä¸æ¥å¿ååé£äºé»è¾äºã</p>
<h1 id="end-åè">end. åè</h1>
<ol>
<li><a href="http://thinkinjava.cn/2019/01/12/2019/2019-01-12-lu-raft-kv/#%E4%BB%80%E4%B9%88%E6%98%AF-Java-%E7%89%88-Raft-%E5%88%86%E5%B8%83%E5%BC%8F-KV-%E5%AD%98%E5%82%A8" target="_blank" rel="noopener nofollow">http://thinkinjava.cn/2019/01/12/2019/2019-01-12-lu-raft-kv/#ä»ä¹æ¯-Java-ç-Raft-åå¸å¼-KV-å­å¨</a></li>
<li><a href="https://github.com/stateIs0/lu-raft-kv" target="_blank" rel="noopener nofollow">https://github.com/stateIs0/lu-raft-kv</a></li>
</ol>


</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-02-11 19:47">2026-02-11 19:47</span>&nbsp;
<a href="https://www.cnblogs.com/jackjavacpp">å«æ¥æ æâ²</a>&nbsp;
éè¯»(<span id="post_view_count">0</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19605754);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19605754', targetLink: 'https://www.cnblogs.com/jackjavacpp/p/19605754', title: 'ç®æçåå¸å¼kvè®¾è®¡' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ ç¶åDPä¹å­éæä¸¾ ]]></title>
    <link>https://www.cnblogs.com/sPERbEETLE/p/19605725</link>
    <guid>e9d22daa81184e53a363a7bed8f3493a</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/sPERbEETLE/p/19605725" title="åå¸äº 2026-02-11 19:47">
    <span role="heading" aria-level="2">ç¶åDPä¹å­éæä¸¾</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h1 id="ä»ä¹æ¯å­éæä¸¾">ä»ä¹æ¯å­éæä¸¾ï¼</h1>
<p>å°±æ¯å¨ç¶æåç¼©åï¼æä¸¾è¯¥ç¶æçå­ç¶æã</p>
<h2 id="åæ³">åæ³</h2>
<h3 id="1-ä¸ä¸ª--åæ³ç´æ¥æä¸¾æææåµå¹¶å¤æ­ä¸¤ä¸ªéå--å--ä¸­-">1. ä¸ä¸ª <span class="math inline">\(4^n\)</span> åæ³ï¼ç´æ¥æä¸¾æææåµï¼å¹¶å¤æ­ä¸¤ä¸ªéå <span class="math inline">\(S\)</span> å <span class="math inline">\(T\)</span> ä¸­ <span class="math inline">\(T \in S\)</span>ã</h3>
<pre><code class="language-cpp">for (int s = 0; s &lt; (1 &lt;&lt; n); s++) {
	for (int t = 0; t &lt; (1 &lt;&lt; n); t++) {
		if ((s &amp; t) == t) {
			// tæ¯sçå­é
		}
	}
}
</code></pre>
<h3 id="2---åæ³åå©ä½è¿ç®éä½å¤æåº¦">2.  <span class="math inline">\(3^n\)</span> åæ³ï¼åå©ä½è¿ç®éä½å¤æåº¦ã</h3>
<pre><code class="language-cpp">for (int s = 0; s &lt; (1 &lt;&lt; n); s++) {
	for (int t = s; t; t = (t - 1)&amp;s) {
		// tæ¯sçå­é
	}
}
</code></pre>
<h4 id="å¤æåº¦è¯æ">å¤æåº¦è¯æ</h4>
<p>åè®¾éåå¤§å°ä¸º <span class="math inline">\(n\)</span>ã<br>
å¯¹äºä¸ä¸ªç¹å®ç <span class="math inline">\(mask\)</span>ï¼å¦æå®åå« <span class="math inline">\(k\)</span> ä¸ª <span class="math inline">\(1\)</span>ï¼é£ä¹å®æ <span class="math inline">\(2^k\)</span> ä¸ªå­éã<br>
<span class="math inline">\(mask\)</span> ä¸­åå« <span class="math inline">\(k\)</span> ä¸ª <span class="math inline">\(1\)</span> çæåµå±æ <span class="math inline">\(C_n^k\)</span>ï¼å³ç»åæ° $ {n \choose k} $ ï¼ç§ã</p>
<p>å æ­¤æ»çæä½æ¬¡æ°ä¸ºï¼</p>
<p></p><div class="math display">\[\sum_{k=0}^n {n \choose k} 2 ^ k 
\]</div><p></p><p>ç±äºé¡¹å¼å®ç<span class="math inline">\((x + y) ^ n = \sum {n \choose k} x^k y^{n-k}\)</span>å¯å¾ï¼<br>
ä»£å¥ <span class="math inline">\(x = 2, y = 1\)</span> å¾ $$ \sum_{k=0}^n {n \choose k} 2^k 1^{n-k} = (2 + 1) ^ n = 3^n $$</p>
<h1 id="ç®åä¾é¢cows-in-a-skyscraper-g"><a href="https://www.luogu.com.cn/problem/P3052" target="_blank" rel="noopener nofollow">ç®åä¾é¢ï¼Cows in a Skyscraper G</a></h1>
<h2 id="åæ³-1">åæ³</h2>
<p>ä¸¤ç§åæ³ã</p>
<ol>
<li>æç´¢</li>
</ol>
<p>ç¨ <span class="math inline">\(sum\)</span> æ°ç»å­ä¸æ¯ä¸ªçµæ¢¯æè£çå¥¶ççééã<br>
dfs ä¸­ä¼ å¥ä¸¤ä¸ªåæ°ï¼<span class="math inline">\((r, cnt)\)</span><br>
åå«è¡¨ç¤ºï¼å½åå¥¶çåçµæ¢¯æ°éã<br>
ç°å¨å°±ç®åäºï¼å¨æ¯ä¸æ¬¡ dfs ä¸­ï¼æä¸¾æ¯ä¸ä¸ªçµæ¢¯ã</p>
<ul>
<li>å¦æè½è£è¿æ­¤çµæ¢¯ï¼å°±è£è¿å»ï¼å¹¶å¾ä¸ã</li>
<li>æä¸¾å®äºå dfs ä¸æ¬¡ï¼è¡¨ç¤ºå¢å ä¸ä¸ªçµæ¢¯ã</li>
</ul>
<p>æåè®°å½æå°å¼å³å¯ã</p>
<p>æå ä¸ªåªææ¹æ¡ã</p>
<ol>
<li>å¦æå½åççµæ¢¯æ°éå·²ç»å¤§äºäºæå°çæ°éï¼é£ä¹å°±ä¸æä¸¾äºã</li>
<li>å¨ dfs åï¼å°å¥¶ççééä»å¤§å°å°çæåºï¼è¿æ ·å°±åå°äºå¯è¡æ¹æ¡ã</li>
</ol>
<details>
<summary>æ³æçä»£ç åµ~</summary>
<pre><code>int n, w;
lint val[N];
lint sum[N];
int ans = 1e9;
bool vis[N];

void dfs(int r, int cnt) {
	if (cnt &gt; ans) return ;
	if (r == n) {
		ans = min(ans, cnt);
		return ;
	}
	for (int i = 0; i &lt; cnt; i++) if (sum[i] + val[r] &lt;= w) {
		sum[i] += val[r];
		dfs(r + 1, cnt);
		sum[i] -= val[r];
	}
	sum[cnt] = val[r];
	dfs(r + 1, cnt + 1);
	sum[cnt] = 0;
}

int main() {
	n = re, w = re;
	for (int i = 0; i &lt; n; i++) val[i] = re;
	sort(val, val + n, greater&lt;int&gt;());
	dfs(0, 1);
	wr(ans), endl;
}
</code></pre>
</details>
<ol start="2">
<li>DPåæ³</li>
</ol>
<p>è¿ç§åæ³è¿è¦åä¸¤ç§åæ³ã</p>
<ol>
<li>$O(3^n) $ åæ³</li>
</ol>
<p><span class="math inline">\(dp_s\)</span> è¡¨ç¤ºç¶æä¸º <span class="math inline">\(s\)</span> æ¶ï¼éè¦çæå°çµæ¢¯æ¬¡æ°ã</p>
<p>è½¬ç§»å¼è¿æ¯å¾ç®å</p>
<p></p><div class="math display">\[dp_s = min(dp_{s \oplus t}),{t \subseteq s} 
\]</div><p></p><details>
<summary>æ³æåµ~</summary>
<pre><code>int n, w;
lint val[30], W[(1 &lt;&lt; 18) + 10];
lint dp[(1 &lt;&lt; 18) + 10];

signed main() {
	IAKIOI;
	n = re, w = re;
	for (int i = 0; i &lt; n; i++) val[i] = re;
	memset(dp, 0x3f, sizeof dp);
	dp[0]=0;
	for (int s = 1; s &lt; (1 &lt;&lt; n); s++) for (int i = 0; i &lt; n; i++) if ((s &gt;&gt; i) &amp; 1) W[s] += val[i];
	for (int s = 1; s &lt; (1 &lt;&lt; n); s++) for (int t = s; t; t = (t - 1) &amp; s) if (W[t] &lt;= w) dp[s] = min(dp[s], dp[s ^ t] + 1);
	wr(dp[(1 &lt;&lt; n) - 1]), endl;
}
</code></pre>
</details>
<ol start="2">
<li><span class="math inline">\(O(2 ^ n \times n ^ 2)\)</span> åæ³</li>
</ol>
<p>$ dp_{i, s} $ï¼è¡¨ç¤ºå½åå·²ç»å¼å¯äº <span class="math inline">\(i\)</span> æ¶çµæ¢¯, ä¸å½åå·²ä¸æ¥¼å¥¶ççç¶æä¸º <span class="math inline">\(s\)</span> çæåµä¸ï¼æåä¸æ¶çµæ¢¯å½åçè½½ééã</p>
<ul>
<li>å½åçµæ¢¯è¿è½è£ä¸ï¼å³ä¸ç¨æ°å¼çµæ¢¯</li>
</ul>
<p>é£ä¹</p>
<p></p><div class="math display">\[dp_{i, s | (1 &lt;&lt; k)} = min(dp_{i, s} + val_k) 
\]</div><p></p><ul>
<li>å½åçµæ¢¯ä¸è½è£ä¸ï¼å³éè¦æ°å¼çµæ¢¯</li>
</ul>
<p>é£ä¹</p>
<p></p><div class="math display">\[dp_{i + 1, s | (1 &lt;&lt; k)} = min(val_k) 
\]</div><p></p><details>
<summary>æ³æåµ~</summary>
<pre><code>int n, w;
int val[30];
int dp[30][(1 &lt;&lt; 21) + 10];

signed main() {
	IAKIOI;
	n = re, w = re;
	for (int i = 0; i &lt; n; i++) val[i] = re;
	memset(dp, INF, sizeof dp);
	for (int i = 0; i &lt; n; i++) dp[i + 1][1 &lt;&lt; i] = val[i];
	for (int s = 1; s &lt; (1 &lt;&lt; n); s++) for (int i = 1; i &lt;= n; i++) if (dp[i][s] &lt;= w) for (int k = 0; k &lt; n; k++) if (!((s &gt;&gt; k) &amp; 1)) {
		if (dp[i][s] + val[k] &lt;= w) dp[i][s | (1 &lt;&lt; k)] = min(dp[i][s | (1 &lt;&lt; k)], dp[i][s] + val[k]);
		else dp[i + 1][s | (1 &lt;&lt; k)] = min(dp[i + 1][s | (1 &lt;&lt; k)], val[k]);
	}
	for (int i = 1; i &lt;= n; i++) if (dp[i][(1 &lt;&lt; n) - 1] != INF) {
		wr(i), endl;
		return 0;
	}
}
</code></pre>
</details>


</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-02-11 19:47">2026-02-11 19:47</span>&nbsp;
<a href="https://www.cnblogs.com/sPERbEETLE">cqbzcdr</a>&nbsp;
éè¯»(<span id="post_view_count">12</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19605725);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19605725', targetLink: 'https://www.cnblogs.com/sPERbEETLE/p/19605725', title: 'ç¶åDPä¹å­éæä¸¾' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ æ»ç»åGPUçOpenCLå­ç»æ´çæ¯ææåµ ]]></title>
    <link>https://www.cnblogs.com/RainbowC0/p/19595783</link>
    <guid>f9ad2812b8a1fbf0c548e547b828f9f1</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/RainbowC0/p/19595783" title="åå¸äº 2026-02-11 19:39">
    <span role="heading" aria-level="2">æ»ç»åGPUçOpenCLå­ç»æ´çæ¯ææåµ</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<p></p><div class="toc"><div class="toc-container-header">ç®å½</div><ul><li><a href="#nvidia" rel="noopener nofollow">Nvidia</a></li><li><a href="#intel" rel="noopener nofollow">Intel</a></li><li><a href="#amd-rocm" rel="noopener nofollow">AMD ROCm</a></li><li><a href="#amd-palhsail" rel="noopener nofollow">AMD PAL/HSAIL</a></li><li><a href="#qualcommon-adreno" rel="noopener nofollow">Qualcommon Adreno</a></li><li><a href="#clvk" rel="noopener nofollow">CLVK</a></li><li><a href="#åè§" rel="noopener nofollow">åè§</a></li></ul></div><p></p>
<p>å­ç»(Sub-group)èª OpenCL 2.0 æ­£å¼å¼å¥ï¼æ¯å·¥ä½ç»(Work-group)åé¨æ´å°çæ§è¡åä½ï¼éå¸¸ç´æ¥æ å°å° GPU ç SIMD/SIMT æ§è¡ååï¼å¦ Nvidia Warp å AMD Wavefrontï¼ï¼å·ææ´å¥½çæ°æ®å±äº«ä¸åæ­¥è½åã</p>
<p>OpenCL 2.0 éè¿æ©å±<code>cl_khr_subgroups</code>æä¾ä¸äºåºç¡å­ç»æä½æ¯æï¼åæ¬è·åå­ç» IDãç»å ID ç­åºæ¬åè½ï¼ç»åæ­è¨(any/all)ãå¹¿æ­(broadcast)ãå½çº¦(reduce)ãæ«æ(scan)ç­åºæ¬æä½ï¼åæ¶åè®¸ä¸äºå¯éæ©å±æ¯ææ´ä¸°å¯çå­ç»æä½ï¼æ¯å¦æ´ç(shuffle)ãæç¥¨(ballot)ç­ï¼ãå¶ä¸­å­ç»åæ´çç¨äºç´æ¥äº¤æ¢å­ç»åå¯å­å¨å¼èä¸åå©å¨å±ææ¬å°åå­ï¼ç±»æ¯ CUDA æåæ´çï¼ï¼ç»å¸¸ç¨äºä¸äºç®æ³ä¼åï¼æ¯æ¯è¾æç¨çå­ç»å½æ°ï¼ä½æ¯å¤§å¤æ° GPU é½ä¸æ¯æå®æ¹ç<code>cl_khr_subgroup_shuffle</code>æ©å±ãå½ç¶ä¸äºååä¹å¯ä»¥éè¿ååæ©å±ãåèæ±ç¼(Inline Assembly)ãåç½®å½æ°(Intrinsics/Builtins)ç­éå¾æ¯æå­ç»æ´çã</p>
<h2 id="nvidia">Nvidia</h2>
<p>éè¿åç½®å½æ°<code>__nvvm_shfl_&lt;mode&gt;_&lt;type&gt;</code>(sm_70 ä»¥å)ã<code>__nvvm_shfl_sync_&lt;mode&gt;_&lt;type&gt;</code>(sm_70+, ptx60+<sup class="footnote-ref"><a href="#fn1" id="fnref1" rel="noopener nofollow">[1]</a></sup>)æ¯æãCUDA ä¸­ççº¿ç¨ææ´çåè¯­ä¹æ¯éè¿è¿äºåç½®å½æ°å®ç°çã</p>
<table>
<thead>
<tr>
<th>åç½®å½æ°</th>
<th>åè½</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>gentype __nvvm_shfl_&lt;mode&gt;_&lt;type&gt;(gentype val, int offset, int clamp)</code></td>
<td>æç§<code>&lt;mode&gt;</code>å®ä¹è§åå°<code>offset</code>å¤è½¦éç<code>val</code>ä¼ éå°æ¬è½¦éï¼å¯¹<code>clamp</code>åæºè½¦éææ</td>
</tr>
<tr>
<td><code>gentype __nvvm_shfl_sync_&lt;mode&gt;_&lt;type&gt;(uint mask, gentype val, int offset, int clamp)</code></td>
<td>æç§<code>&lt;mode&gt;</code>å®ä¹è§åå°<code>offset</code>å¤è½¦éç<code>val</code>ä¼ éå°æ¬è½¦éï¼å¹¶æç§<code>mask</code>åæ­¥çº¿ç¨æï¼å¯¹<code>clamp</code>åæºè½¦éææ</td>
</tr>
</tbody>
</table>
<p>å¶ä¸­<code>&lt;type&gt;</code>å¯å<code>i32</code>ã<code>f32</code>ï¼å¯¹åº<code>gentype</code>ä¸º<code>int</code>ã<code>float</code>ã</p>
<p>å¶ä¸­<code>&lt;mode&gt;</code>åå¼å¦ä¸ï¼</p>
<table>
<thead>
<tr>
<th><code>&lt;mode&gt;</code></th>
<th>ç®çè½¦é</th>
<th>å¯¹æ  OpenCL å­ç»å½æ°</th>
<th>å¯¹åº OpenCL å­ç»æ©å±</th>
</tr>
</thead>
<tbody>
<tr>
<td>idx</td>
<td>offset</td>
<td>sub_group_shuffle</td>
<td>cl_khr_subgroup_shuffle</td>
</tr>
<tr>
<td>bfly</td>
<td>laneid ^ offset</td>
<td>sub_group_shuffle_xor</td>
<td>cl_khr_subgroup_shuffle</td>
</tr>
<tr>
<td>up</td>
<td>laneid - offset</td>
<td>sub_group_shuffle_up</td>
<td>cl_khr_subgroup_shuffle_relative</td>
</tr>
<tr>
<td>down</td>
<td>laneid + offset</td>
<td>sub_group_shuffle_down</td>
<td>cl_khr_subgroup_shuffle_relative</td>
</tr>
</tbody>
</table>
<p>Nvidia ç OpenCL é©±å¨æ¯æ PTX åèæ±ç¼ï¼å æ­¤å¯ç´æ¥è°ç¨<code>shfl.&lt;mode&gt;.&lt;type&gt;</code>å<code>shfl.sync.&lt;mode&gt;.&lt;type&gt;</code>ç­æ±ç¼æä»¤ã</p>
<h2 id="intel">Intel</h2>
<p>æä¾æ©å±<code>cl_intel_subgroups</code>æ¯æå¤ç§å­ç»æ´çæä½ãç®å Intel æ¯å¯¹ OpenCL æ¯ææ¯è¾å¥½çååï¼è¯¥æ©å±èª OpenCL 1.2 å å¥ï¼å¹¶ä¸ç´æ¥å®ç°äºå¤ç§å­ç»æ´çãæç¥¨å½æ°ã</p>
<table>
<thead>
<tr>
<th>æ©å±å½æ°</th>
<th>åè½</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>gentype intel_sub_group_shuffle(gentype data, uint sub_group_local_id)</code></td>
<td>å°<code>sub_group_local_id</code>å­ç»å·¥ä½é¡¹çæ°æ®å¼ä¼ éç»æ¬å­ç»å·¥ä½é¡¹ã</td>
</tr>
<tr>
<td><code>gentype intel_sub_group_shuffle_down(gentype curr, gentype, gentype next, uint delta)</code></td>
<td><p>å°<code>sub_group_local_id</code>+<code>delta</code>ä½ä¸ºç®çå­ç»ç´¢å¼ã</p><p>è¥å­ç»ç´¢å¼å¤§äºç­äº 0 ä¸å°äº<code>max_sub_group_size</code>åä¼ é<code>curr</code>ã</p><p>è¥å­ç»ç´¢å¼å¤§äºç­äº<code>max_sub_group_size</code>ä¸å°äº<code>max_sub_group_size</code> * 2ï¼åå°ç®çå­ç»ç´¢å¼å<code>max_sub_group_size</code>ï¼ä¼ é<code>next</code>ã</p></td>
</tr>
<tr>
<td><code>gentype intel_sub_group_shuffle_up(gentype curr, gentype, gentype next, uint delta)</code></td>
<td><p>å°<code>sub_group_local_id</code>-<code>delta</code>ä½ä¸ºç®çå­ç»ç´¢å¼ã</p><p>è¥å­ç»ç´¢å¼å¤§äºç­äº 0 ä¸å°äº<code>max_sub_group_size</code>åä¼ é<code>curr</code>ã</p><p>è¥å­ç»ç´¢å¼å¤§äºç­äºè´<code>max_sub_group_size</code>ä¸å°äº 0ï¼åå°ç®çå­ç»ç´¢å¼å <code>max_sub_group_size</code>ï¼ä¼ é<code>next</code>ã</p></td>
</tr>
<tr>
<td><code>gentype intel_sub_group_shuffle_xor(gentype data, uint val)</code></td>
<td>å°<code>sub_group_local_id</code> XOR <code>val</code>å­ç»å·¥ä½é¡¹çæ°æ®å¼ä¼ éç»æ¬å­ç»å·¥ä½é¡¹ã</td>
</tr>
</tbody>
</table>
<h2 id="amd-rocm">AMD ROCm</h2>
<p>æåç¼ä¸º<code>__builtin_amdgcn_</code>çåç½®å½æ°<code>ds_permute</code>ã<code>ds_bpermute</code>ï¼åèå°æ°æ®ä»å½åè½¦éæ¨é(Push)å°ç®æ è½¦éï¼èåèä»ç®æ è½¦éæå(Pull)å°å½åè½¦éï¼ä¸ OpenCL ä¸­ç <code>sub_group_shuffle</code> å®ä¹ç±»ä¼¼ã</p>
<table>
<thead>
<tr>
<th>åç½®å½æ°</th>
<th>åè½</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>int __builtin_amdgcn_ds_permute(int offset, int val)</code></td>
<td>å°æ¬è½¦éçæ°æ®å¼ä¼ è¾å°ç´¢å¼ä¸º<code>offset</code>çè½¦é</td>
</tr>
<tr>
<td><code>int __builtin_amdgcn_ds_bpermute(int offset, int val)</code></td>
<td>å°ç´¢å¼ä¸º<code>offset</code>çè½¦éçæ°æ®å¼ä¼ è¾å°æ¬è½¦é</td>
</tr>
</tbody>
</table>
<p>å¦å¤ï¼AMD ROCm è¿æä¾<code>ds_swizzle</code>(å­èåä½äº¤æ¢)ã<code>dpp_mov</code>(æ°æ®å¹¶è¡ç§»å¨)ç­åé¨å½æ°å®ç°æ´ä¸°å¯çå­ç»æ´çæä½ã</p>
<p>AMD ROCm ç OpenCL é©±å¨åæ ·æ¯æåèæ±ç¼ï¼å¯ä»¥ç´æ¥è°ç¨<code>ds.permute</code>ã<code>ds.bpermute</code>ç­ AMDGCN æä»¤ã</p>
<h2 id="amd-palhsail">AMD PAL/HSAIL</h2>
<p>ROCm ä¸æ¯æ Windows éæ¾ï¼å¶é»è®¤é©±å¨ä¸º AMD PAL/HSAILãAMD PAL/HSAIL æä¾åç½®å½æ°<code>gentype __hsail_activelanepermute_wavewidth_&lt;type&gt;(gentype src, uint lid, gentype ival, bool useival)</code>å®ç°æ´»è·è½¦éäº¤æ¢ï¼ä¸åæ­¥ï¼<sup class="footnote-ref"><a href="#fn2" id="fnref2" rel="noopener nofollow">[2]</a></sup>ãè¯¥å½æ°å°ç®çç´¢å¼<code>lid</code>çè½¦éçæ°æ®å¼äº¤æ¢å°æ¬è½¦éãè¥<code>lid</code>éæ³ï¼å½<code>useival</code>ä¸ºçæ¶ï¼è¿å<code>ival</code>ï¼å¦åæªå®ä¹ã</p>
<p>å¶ä¸­<code>&lt;w&gt;</code>å¯å<code>b1</code>ã<code>b32</code>ã<code>b64</code>ï¼è¡¨ç¤ºè¯¥æä»¤è¿è¡äº¤æ¢çæ°æ®å®½åº¦ï¼å¯¹åº<code>gentype</code>ä¸º<code>uchar</code>ã<code>uint</code>ã<code>ulong</code>ã</p>
<blockquote>
<p>ä½¿ç¨<code>__hsail_activelanepermute_wavewidth_&lt;type&gt;</code>æ¶éè¦å¨ä»£ç ä¸­å£°æè¯¥å½æ°ï¼å¦åç¼è¯æ¶ä¼æ¥éæ¾ä¸å°ç¬¦å·ãåè§<a href="https://github.com/HSAFoundation/builtins" target="_blank" rel="noopener nofollow">HSAFoundation/builtins</a><sup class="footnote-ref"><a href="#fn3" id="fnref3" rel="noopener nofollow">[3]</a></sup>ã</p>
</blockquote>
<p>å¦å¤ï¼<code>sub_group_broadcast</code>æ¯ç¨è¯¥æä»¤ä¸<code>__hsail_wavebarrier()</code>å®ç°çï¼å æ­¤ä¹å¯ç¨å­ç»å¹¿æ­è¿è¡æ´çã</p>
<h2 id="qualcommon-adreno">Qualcommon Adreno</h2>
<p>æä¾æ©å±<code>cl_qcom_subgroup_shuffle</code>æ¯æå­ç»æ´çæä½ï¼åè®¸å¨ç»æ´çãå®½ 4 æ´çãå®½ 8 æ´çã</p>
<p>æ©å±å½æ°ï¼</p>
<pre><code class="language-c">&lt;gentype&gt; qcom_sub_group_shuffle_&lt;op&gt;(
            &lt;gentype&gt; source_value,
            uint offset,
            qcom_sub_group_shuffle_width_modes_t width,
            &lt;gentype&gt; default_value);
</code></pre>
<p>å¶ä¸­<code>&lt;gentype&gt;</code>å¯ä¸º<code>uchar</code>ã<code>char</code>ã<code>ushort</code>ã<code>short</code>ã<code>uint</code>ã<code>int</code>ã<code>ulong</code>ã<code>long</code>ä»¥å<code>float</code>ï¼å¦æå¯ç¨<code>cl_khr_fp16</code>æ©å±ï¼åä¹å¯å<code>half</code>ã</p>
<p>å¶ä¸­<code>&lt;op&gt;</code>å¯ä¸º<code>up</code>ã<code>down</code>ã<code>rotate_up</code>ã<code>rotate_down</code>ã<code>xor</code>ã</p>
<p><code>qcom_sub_group_shuffle_width_modes_t</code>ä¸ºæä¸¾ç±»åï¼åå¼å¦ä¸ï¼</p>
<table>
<thead>
<tr>
<th>å­ç»æ´çå®½åº¦æ¨¡å¼</th>
<th>å«ä¹</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>CLK_SUB_GROUP_SHUFFLE_WIDTH_WAVE_SIZE_QCOM</code></td>
<td>å­ç»åææå·¥ä½é¡¹åä¸æ´ç</td>
</tr>
<tr>
<td><code>CLK_SUB_GROUP_SHUFFLE_WIDTH_W4_QCOM</code></td>
<td>å­ç»åæ¯4ä¸ªå·¥ä½é¡¹ä¹é´æ´ç</td>
</tr>
<tr>
<td><code>CLK_SUB_GROUP_SHUFFLE_WIDTH_W8_QCOM</code></td>
<td>å­ç»åæ¯8ä¸ªå·¥ä½é¡¹ä¹é´æ´ç</td>
</tr>
</tbody>
</table>
<h2 id="clvk">CLVK</h2>
<p><a href="https://github.com/kpet/clvk" target="_blank" rel="noopener nofollow">CLVK</a> æ¯åºäº Vulkan ç OpenCL 3.0 å®ç°ï¼ä½¿ç¨ <a href="https://www.google.com/clspv" target="_blank" rel="noopener nofollow">clspv</a> ç¼è¯å¨å° OpenCL C æºç ç¼è¯ä¸º SPIR-V äºè¿å¶æ ¼å¼ä½ä¸º Vulkan è®¡ç®çè²å¨ä½¿ç¨ãCLVK æ¯æå®æ¹ <code>cl_khr_subgroup_shuffle</code> æ©å±ã</p>
<hr>
<h2 id="åè§">åè§</h2>
<ol>
<li><a href="https://registry.khronos.org/OpenCL/specs/3.0-unified/html/OpenCL_C.html#sub-group-functions" target="_blank" rel="noopener nofollow">https://registry.khronos.org/OpenCL/specs/3.0-unified/html/OpenCL_C.html#sub-group-functions</a></li>
<li><a href="https://reviews.llvm.org/D38090" target="_blank" rel="noopener nofollow">https://reviews.llvm.org/D38090</a></li>
<li><a href="https://registry.khronos.org/OpenCL/extensions/intel/cl_intel_subgroups.html" target="_blank" rel="noopener nofollow">https://registry.khronos.org/OpenCL/extensions/intel/cl_intel_subgroups.html</a></li>
<li><a href="https://reviews.llvm.org/D17614" target="_blank" rel="noopener nofollow">https://reviews.llvm.org/D17614</a></li>
<li><a href="https://github.com/HSAFoundation/builtins" target="_blank" rel="noopener nofollow">https://github.com/HSAFoundation/builtins</a></li>
<li><a href="https://github.com/HSAFoundation/HLC-HSAIL-Development-LLVM/blob/hsail-review-v4/lib/Target/HSAIL/HSAILIntrinsics.td" target="_blank" rel="noopener nofollow">https://github.com/HSAFoundation/HLC-HSAIL-Development-LLVM/blob/hsail-review-v4/lib/Target/HSAIL/HSAILIntrinsics.td</a></li>
<li><a href="https://github.com/willhua/QualcommOpenCLSDKNote/blob/master/docs/extensions/cl_qcom_subgroup_shuffle.txt" target="_blank" rel="noopener nofollow">https://github.com/willhua/QualcommOpenCLSDKNote/blob/master/docs/extensions/cl_qcom_subgroup_shuffle.txt</a></li>
</ol>
<hr>
<p>åæè¿æ¥ <a href="https://www.cnblogs.com/RainbowC0/p/19595783" target="_blank">https://www.cnblogs.com/RainbowC0/p/19595783</a>ï¼æªç»ä½èè®¸å¯ç¦æ­¢è½¬è½½ã</p>
<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p>æ¶æå¯éè¿ç¼è¯åæ°<code>-cl-nv-arch</code>æå®ï¼é»è®¤ä¸è®¾å¤æ¶æä¸è´ï¼ptx60 éè¦éè¿ç¼è¯åæ°<code>--Xclang -target-feature --Xclang +ptx60</code>æå®ã <a href="#fnref1" class="footnote-backref" rel="noopener nofollow">â©ï¸</a></p>
</li>
<li id="fn2" class="footnote-item"><p>é©±å¨ç¨åºä¸­è¿å¯ä»¥çå°<code>__gcn_ds_permute_&lt;type&gt;</code>ã<code>__gcn_ds_bpermute_&lt;type&gt;</code>ã<code>__gcn_dpp_mov_&lt;type&gt;</code>ç­åç½®å½æ°ï¼ä½å®éç¼è¯æ¶ä¼æ¥é<code>LLVM ERROR: cannot select: intrinsic</code>ï¼GPU æ¬èº«æ¯ GCN æ¶æï¼å¯è½éè¦éè¿ç¹å®ç¼è¯åæ°æ¯æ GCN æ©å±ã <a href="#fnref2" class="footnote-backref" rel="noopener nofollow">â©ï¸</a></p>
</li>
<li id="fn3" class="footnote-item"><p>ç®åçé©±å¨ç¨åºåæå­æ®µ<code>__hsail_activelanepermute_wavewidth</code>ï¼è<a href="https://github.com/HSAFoundation/builtins" target="_blank" rel="noopener nofollow">HSAFoundation/builtins</a>åç»åºçæ¯<code>__hsail_activelaneshuffle_wavewidth</code>ï¼åºè¯¥æè¯¯ã <a href="#fnref3" class="footnote-backref" rel="noopener nofollow">â©ï¸</a></p>
</li>
</ol>
</section>


</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-02-11 19:40">2026-02-11 19:39</span>&nbsp;
<a href="https://www.cnblogs.com/RainbowC0">RainbowC0</a>&nbsp;
éè¯»(<span id="post_view_count">9</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19595783);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19595783', targetLink: 'https://www.cnblogs.com/RainbowC0/p/19595783', title: 'æ»ç»åGPUçOpenCLå­ç»æ´çæ¯ææåµ' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ æ¨¡åè¯ä¼°å°åï¼1ï¼ ROC æ²çº¿ä¸ AUC ]]></title>
    <link>https://www.cnblogs.com/Goblinscholar/p/19605705</link>
    <guid>15558a1eb64188dca62eb459485a4e4d</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/Goblinscholar/p/19605705" title="åå¸äº 2026-02-11 19:19">
    <span role="heading" aria-level="2">æ¨¡åè¯ä¼°å°åï¼1ï¼ ROC æ²çº¿ä¸ AUC</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<p>ä¸ç¹åè¨ï¼ä¹åå®æäºå´æ©è¾¾æ·±åº¦å­¦ä¹ çç¸å³åå®¹ï¼æè¿å¿äºæ¯è®¾ï¼æ´æ°å¯è½æ²¡ä¹åé£ä¹é¢ç¹ãè¿ä¸ªæ°å¼çåç±»å³äº<strong>æ¨¡åè¯ä¼°çåç§ææ </strong>çè¯¦è§£ï¼ä¹åç¿»çä¹¦ç±æ»æ¯è¢«ä¸å å¾å®æ¹åçæ¦å¿µåå¯å¯éº»éº»çç¬¦å·æççä¸ä¸å»ï¼å æ­¤ï¼è¿æ¬¡çä¸­å¿ææ³æ¯ä»¥å°½å¯è½<strong>éä¿çè¯­è¨ãç²¾ç®çç¯å¹</strong>æ¥è®²è§£è¿ç±»æ¦å¿µå¹¶è¾ä»¥å®ä¾ã<br>
ä¸å¤åºè¯ï¼ä»¥ä¸ä¸ºæ­£æã</p>
<hr>
<h1 id="1-æ£æµé®é¢ä¸­çä¸¤é¾ææ¯">1. æ£æµé®é¢ä¸­çâä¸¤é¾ææ¯â</h1>
<p>åè®¾æä»¬å¨æºåºè´è´£å®æ£ãä»»å¡å¾ç®åï¼<strong>ææºå¸¦å±é©ç©åçäººæ¦ä¸æ¥ã</strong></p>
<p>ä½ç°å®è¿æ²¡æè¿ä¹ç®åï¼å¦ææä»¬æå®æ£<strong>æ åå®å¾éå¸¸ä¸¥æ ¼</strong>ââä¸ç¹å¯çé½ä¸æ¾è¿ï¼é£ä¹ç¡®å®å¯ä»¥æ¦ä¸å ä¹ææå±é©äººåã<br>
ä½ä»£ä»·æ¯ï¼<strong>æ­£å¸¸æå®¢ä¹ä¼è¢«é¢ç¹æ¦ä¸å¤æ£</strong>ï¼éä¼æå°å¤§åå¤ã</p>
<p>èå¦ææä»¬<strong>ææ åæ¾å®½</strong>ââåªå¨éå¸¸ææ¾çæåµä¸ææ¦äººï¼æå®¢éè¡æçä¼æé«ã<br>
ä½æ¾ç¶ï¼è¿å°±<strong>ææ´å¤§å¯è½æ¼æçæ­£çé£é©</strong>ã</p>
<p>è¿å°±æ¯ä¸ä¸ªç»å¸çä¸¤é¾ï¼<strong>éæ©æéè¿æ¯æ¾è¿</strong>ï¼</p>
<blockquote>
<p><strong>æå¾è¶å¤ï¼éæä¹è¶å¤ã</strong><br>
<strong>æå¾è¶å°ï¼æ¼æå°±è¶å¤ã</strong></p>
</blockquote>
<p><img src="https://img2024.cnblogs.com/blog/3708248/202602/3708248-20260211191745572-2075288255.png" alt="f2bc31dc-fe19-439e-a7a0-4efb06659caf.png" loading="lazy"></p>
<p>ç®æ æ£æµé®é¢æ¬è´¨ä¸ä¹æ¯å¦æ­¤ï¼å¨é«åè°±ç®æ æ£æµãé·è¾¾æ¢æµãå¼å¸¸æ£æµç­ç®æ æ£æµä»»å¡ä¸­ï¼æä»¬é¢å¯¹çä¸æ¯âå¯¹æéâè¿ä¹ç®åï¼èæ¯<strong>å¨ä»»å¡ææ¯ä¸­ï¼å¯¹âéæ¥âåâæ¼æ¥âçæè¡¡éæ©</strong>ï¼</p>
<blockquote>
<p><strong>æçæ¨¡åï¼è½æ£æµåºå¤å°çå®ç®æ ï¼ä½åæ¶ä¼è¯¯æ¥å¤å°èæ¯ï¼æçä»»å¡è¦æ±ææ´åååªè¾¹ï¼å¨åªéäºèè¾ä¸ºåè¡¡ï¼</strong></p>
</blockquote>
<p>æ»ä¹ï¼å¨æ£æµç³»ç»ä¸­ï¼æ²¡æåè´¹çåé¤ï¼æé«æ£æµçï¼å¾å¾è¦ä»åºèè­¦ççä»£ä»·ã<br>
ROC æ²çº¿æè¿°çï¼æ­£æ¯è¿ä¸¤èä¹é´çå³ç³»ã</p>
<h1 id="2-rocreceiver-operating-characteristic">2. ROCï¼Receiver Operating Characteristicï¼</h1>
<p>ROC çè±æå¨ç§°ä¸º <strong>Receiver Operating Characteristic</strong> ï¼ç´è¯ä¸ºåè¯èå·¥ä½ç¹å¾æ²çº¿ï¼å®æ¥æºäº<strong>ç»è®¡å­¦ä¸­çæ£æµçè®º</strong>ï¼èææ©çåºç¨é¢åæ¯<strong>é·è¾¾æ¢æµ</strong>ã</p>
<p>ä¸åäºä¸äºå¸¸è§ææ ï¼<strong>ROC å»ç»çæ¯èè­¦æ¦çåæ£æµæ¦çé´çå½æ°å³ç³»</strong>ã<br>
ç´æ¥æ¥çä¸ä¸ªå®ä¾ï¼<br>
<img src="https://img2024.cnblogs.com/blog/3708248/202602/3708248-20260211191746062-1023289789.png" alt="image.png" loading="lazy"><br>
ç°å¨ï¼åè®¾ä¸å¤©æ <strong>100 ä¸ªæºå¸¦å±é©ç©åçæå®¢</strong>å <strong>1000 ä¸ªæ®éæå®¢</strong>ï¼</p>
<p>1.<strong>çé³æ§çï¼TPR / Pdï¼</strong>ï¼ç³»ç»è½æ­£ç¡®æä½çæ­£å±é©æå®¢çæ¯ä¾ï¼å³âè¯¥æçæäºå¤å°âã<br>
2.<strong>åé³æ§çï¼FPR / Faï¼</strong>ï¼ç³»ç»ææ®éæå®¢è¯¯å¤ä¸ºå±é©æå®¢çæ¯ä¾ï¼å³âä¸è¯¥æçæéäºå¤å°âã</p>
<table>
<thead>
<tr>
<th>æ®éæå®¢æ°é</th>
<th>å±é©æå®¢æ°é</th>
<th>éè¿ / æ­£å¸¸æ°é</th>
<th>æå°æ°é</th>
<th>ææ åè®¡ç®è¿ç¨</th>
</tr>
</thead>
<tbody>
<tr>
<td>â</td>
<td>100</td>
<td>3 æ¼æ</td>
<td>97  æå°</td>
<td><strong>çé³æ§ç Pd = 97 / 100 = 0.97 (97%)</strong></td>
</tr>
<tr>
<td>1000</td>
<td>â</td>
<td>800 æ­£å¸¸éè¿</td>
<td>200 è¯¯æ</td>
<td><strong>åé³æ§ç Fa = 200 / 1000 = 0.2 (20%)</strong></td>
</tr>
</tbody>
</table>
<p>å®éä¸äºèçè®¡ç®è¿æ¯å¯¹åç±»åºç¡ç»è®¡éçåºç¨ã<br>
è¿æ ·ï¼æä»¬å°±å¾å°äº ROC æ²çº¿ä¸­çä¸ä¸ªç¹ï¼<span class="math inline">\((0.2,0.97)\)</span> ï¼æä»¬ç§°ä¹ä¸º<strong>Pd @ Fa æ Pd / Fa</strong> ï¼å®è¯´æäº<strong>å¨ç¹å®èè­¦çä¸è½æå°å¤å°ç®æ </strong>ï¼å±å¼å¦ä¸ï¼<br>
<img src="https://img2024.cnblogs.com/blog/3708248/202602/3708248-20260211191743792-444019702.png" alt="image.png" loading="lazy"><br>
å°è¿éï¼å°±ä¼åç°ï¼ <strong>ROC æ²çº¿ä¸­çä¸ä¸ªç¹å°±æ¯ä¸ç§å³ç­éå¼ä¸çæ¨¡åè¡¨ç°ã</strong><br>
æä»¬ä¸æ­æµè¯ä¸åçéå¼è®¡ç®ï¼æç»å°±ä¼å¾å° ROC æ²çº¿ï¼åä¸¾å ç§æåµå¦ä¸ï¼</p>
<table>
<thead>
<tr>
<th>éå¼ t</th>
<th>å¤å®è§å</th>
<th>å±é©æå®¢æå°æåµ (Pd)</th>
<th>æ®éæå®¢è¯¯ææåµ (Fa)</th>
<th>è¯´æ</th>
</tr>
</thead>
<tbody>
<tr>
<td>0.8</td>
<td>åªææ¦ç â¥ 0.8 å¤ä¸ºå±é©</td>
<td>80 / 100 = 0.80</td>
<td>50 / 1000 = 0.05</td>
<td>ä¸¥æ ¼å¤å®ï¼åªææææ¾çå±é©æå®¢ï¼èè­¦å¾å°</td>
</tr>
<tr>
<td>0.5</td>
<td>æ¦ç â¥ 0.5 å¤ä¸ºå±é©</td>
<td>95 / 100 = 0.95</td>
<td>200 / 1000 = 0.20</td>
<td>ä¸­ç­å¤å®ï¼æå°å¤§é¨åå±é©æå®¢ï¼èè­¦éä¸­</td>
</tr>
<tr>
<td>0.3</td>
<td>æ¦ç â¥ 0.3 å¤ä¸ºå±é©</td>
<td>99 / 100 = 0.99</td>
<td>400 / 1000 = 0.40</td>
<td>å®½æ¾å¤å®ï¼å ä¹æå°å¨é¨å±é©æå®¢ï¼ä½èè­¦ææ¾å¢å </td>
</tr>
<tr>
<td>0.1</td>
<td>æ¦ç â¥ 0.1 å¤ä¸ºå±é©</td>
<td>100 / 100 = 1.00</td>
<td>800 / 1000 = 0.80</td>
<td>æåº¦å®½æ¾ï¼æå°å¨é¨å±é©æå®¢ï¼ä½ç»å¤§é¨åæ®éæå®¢ä¹è¢«è¯¯æ</td>
</tr>
</tbody>
</table>
<p>è§å¯ä¸æ¥ï¼ä½ ä¼åç°ï¼<strong>è¯¯æ¥çè¶é«å¾å¾ä»£è¡¨éå¼è¶ä½ã</strong><br>
èå°äºè¿éï¼ä½ å¯è½ä¼æä¸ä¸ªé®é¢ï¼<strong>é£å¨å®éè¿è¡ä¸­ï¼ææ»ä¸è½ä¸ä¸ªä¸ªéå¼å»è¯å§ï¼è¦å¤å°æ¬¡æè½æ¼åºæ¥å®æ´æ²çº¿ï¼</strong></p>
<p>å®éä¸ï¼æä»¬<strong>å¨çå®è¿è¡ä¸­åªéè¦è¿è¡ä¸æ¬¡æ¨¡åå°±å¯ä»¥å¾å°å®æ´ ROC æ²çº¿ã</strong><br>
<strong>ç¨ä¸å¥è¯æ¦æ¬å¶ç®æ³ï¼å­å¨æ¨¡åå¯¹æ¯ä¸ªæ ·æ¬çè¾åºæ¦çå¹¶æåºï¼ä»é«å°ä½ä¾æ¬¡ç¡®è®¤ä¸ºæ­£ç±»ï¼ææï¼å¹¶è®¡ç® Pd @ Fa ï¼å å¥å¾åã</strong><br>
æ¥çä¸ªä¾å­ï¼</p>
<table>
<thead>
<tr>
<th>æå</th>
<th>æå®¢ ID</th>
<th>æ¯å¦å±é©</th>
<th>æ¨¡åæ¦ç p</th>
<th>æ¨ä¸ªæ</th>
<th>ç´¯è®¡ TP</th>
<th>ç´¯è®¡ FP</th>
<th>Pd = TP / 3</th>
<th>Fa = FP / 7</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>A</td>
<td>â å±é©</td>
<td>0.95</td>
<td>æ</td>
<td>1</td>
<td>0</td>
<td>0.33</td>
<td>0</td>
</tr>
<tr>
<td>2</td>
<td>B</td>
<td>â æ®é</td>
<td>0.90</td>
<td>æ</td>
<td>1</td>
<td>1</td>
<td>0.33</td>
<td>0.14</td>
</tr>
<tr>
<td>3</td>
<td>C</td>
<td>â å±é©</td>
<td>0.85</td>
<td>æ</td>
<td>2</td>
<td>1</td>
<td>0.67</td>
<td>0.14</td>
</tr>
<tr>
<td>4</td>
<td>D</td>
<td>â æ®é</td>
<td>0.70</td>
<td>æ</td>
<td>2</td>
<td>2</td>
<td>0.67</td>
<td>0.29</td>
</tr>
<tr>
<td>5</td>
<td>E</td>
<td>â æ®é</td>
<td>0.60</td>
<td>æ</td>
<td>2</td>
<td>3</td>
<td>0.67</td>
<td>0.43</td>
</tr>
<tr>
<td><strong>6</strong></td>
<td><strong>F</strong></td>
<td><strong>â å±é©</strong></td>
<td><strong>0.50</strong></td>
<td><strong>æ</strong></td>
<td><strong>3</strong></td>
<td><strong>3</strong></td>
<td><strong>1.00</strong></td>
<td><strong>0.43</strong></td>
</tr>
<tr>
<td>7</td>
<td>G</td>
<td>â æ®é</td>
<td>0.45</td>
<td>æ</td>
<td>3</td>
<td>4</td>
<td>1.00</td>
<td>0.57</td>
</tr>
<tr>
<td>8</td>
<td>H</td>
<td>â æ®é</td>
<td>0.30</td>
<td>æ</td>
<td>3</td>
<td>5</td>
<td>1.00</td>
<td>0.71</td>
</tr>
<tr>
<td>9</td>
<td>I</td>
<td>â æ®é</td>
<td>0.20</td>
<td>æ</td>
<td>3</td>
<td>6</td>
<td>1.00</td>
<td>0.86</td>
</tr>
<tr>
<td>10</td>
<td>J</td>
<td>â æ®é</td>
<td>0.10</td>
<td>æ</td>
<td>3</td>
<td>7</td>
<td>1.00</td>
<td>1.00</td>
</tr>
</tbody>
</table>
<p>å¨è¿éï¼<strong>å½ææå®¢Fæææ¶ï¼è®¡ç®å¾å°ç Pd @ Fa è¾ä¼ï¼ä¹å°±æ¯è¯´ï¼å¶å¯¹åºçæ¨¡åæ¦ç p=0.5 å°±æ¯ä¸ä¸ªå¯è½è¾ä¼çå³ç­éå¼éæ©ã</strong></p>
<p>å°è¿é ROC çåå®¹å°±åºæ¬ç»æï¼ä½æ¯ä½ ä¼åç°ï¼<strong>æ²çº¿éæåçä¸åéå¼çæåµäºï¼é£è¿ä¸ªæ¨¡åæ¬èº«å°åºå¥½ä¸å¥½ï¼æå¤å¥½ï¼è½ä¸è½ç»æä¸ä¸ªæç¡®çè¯ä¼°å¢ï¼</strong><br>
è¿å°±æ¯ä¸ ROC æ²çº¿ç¸å³èçåå®¹ï¼AUC ã</p>
<h1 id="3-aucarea-under-curve">3. AUCï¼Area Under Curveï¼</h1>
<p>AUC çå¨ç§°æ¯ Area Under Curveï¼ç´è¯å°±æ¯ROC æ²çº¿ä¸é¢ç§¯ãå®ç¨ä¸ä¸ª<strong>åä¸ææ </strong>æ¥è¡¡éæ¨¡åæ´ä½è½åã<br>
å¨å¾å° ROC æ²çº¿åï¼AUCçè®¡ç®éå¸¸ç®åï¼<br>
<img src="https://img2024.cnblogs.com/blog/3708248/202602/3708248-20260211191744270-1543306405.png" alt="image.png" loading="lazy"><br>
æ¾ç¶ï¼AUCé¢ç§¯è¶å¤§ï¼æ¨¡åè¶è½å¨ä½èè­¦çä¸å®ç°é«æ£æµçï¼æ¨¡åçæ£æµææå°±è¶å¥½ã<br>
å¹¶ä¸ï¼æä»¬ä¸éè¦æåéå®å³ç­éå¼ï¼å°±å¯ä»¥ç¥éæ¨¡åæ´ä½çå¥½åã</p>
<p>æ»ç»ä¸å¥è¯ï¼<strong>ROC åè¯æä»¬å¨ä¸åæ åä¸æ¨¡åè¡¨ç°å¦ä½ï¼è AUC åç»åºä¸ä¸ªæ´ä½è¯åï¼å®ç°ä¸ç¨ç¯çæ¯ä¸ªéå¼ä¹è½ç¥éæ¨¡åå¥½ä¸å¥½ï¼ä»èå¸®å©ç¸å³ä»»å¡çè°ä¼åé¨ç½²ã</strong></p>


</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-02-11 19:20">2026-02-11 19:19</span>&nbsp;
<a href="https://www.cnblogs.com/Goblinscholar">å¥å¸æå­¦è</a>&nbsp;
éè¯»(<span id="post_view_count">13</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19605705);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19605705', targetLink: 'https://www.cnblogs.com/Goblinscholar/p/19605705', title: 'æ¨¡åè¯ä¼°å°åï¼1ï¼ ROC æ²çº¿ä¸ AUC' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ âå£°âä¸´å¶å¢ç½ç«åäº« ]]></title>
    <link>https://www.cnblogs.com/LXP-Never/p/19605364</link>
    <guid>aa1f137fea0ca27d8a7043678b47056e</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/LXP-Never/p/19605364" title="åå¸äº 2026-02-11 17:27">
    <span role="heading" aria-level="2">âå£°âä¸´å¶å¢ç½ç«åäº«</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body blogpost-body-html">
<p>ä½ æ¯å¦ä¹ä¼æè¿æ ·çæåï¼èªå·±ä¸ä¸ªäººå¨å®éçå®¶éåèæ²¡æå·¥ä½çæ°å´ï¼å¾é¾éä¸­æ³¨æå</p>
<p>ä½ æ¯å¦æ³å¿µåå¬å®¤éæ­¤èµ·å½¼ä¼çé®çå£°ï¼æ¯å¦æå¿µå¾ä¹¦é¦éå®éçç¿»ä¹¦å£°ï¼ææ¯åå¡é¦éæ¸©æçå§å£ï¼å½æä»¬å ä¸ºåç§åå æ æ³èº«å¤é£äºçæçç©ºé´æ¶ï¼è¿äºå£°é³æäºæä»¬ææ·±çå¿µæ³ãä¸é¢ä¸ºä½ åäº«ä¸ç³»å"æ³å¿µ"ä¸»é¢çç¯å¢é³ç½ç«ï¼è®©ä½ éæ¶éå°éæ¸©é£äºè®°å¿ä¸­çå£°é³ï¼æ¾åé£ä»½çæçæè§ã</p>
<p>è¿ä¸ªç½ç«è½æä¹ç¨å¢ï¼</p>
<ol>
<li>ç¨äºå¨å®¶éç»ä½ èº«ä¸´å¶å¢çæè§</li>
<li>ç¨äºé³é¢è®¾å¤æµè¯ï¼ååï¼ä¸ç¨æ»¡ç½ç«å»æ¾é³é¢äº</li>
</ol>
<h2 id="1">åå¬å®¤çå£°é³</h2>
<ul>
<li>â¨&nbsp;<a href="https://imisstheoffice.eu/" rel="noopener nofollow">I Miss The Office</a>: å½è¿ç¨åå¬æä¸ºå¸¸æï¼ä½ æ¯å¦æå¿µåå¬å®¤éåäºçé®åå£°ãæå°æºçè¿è½¬å£°ãåå¡æºçå·¥ä½å£°ï¼è¿ä¸ªç½ç«å¸®ä½ éæ¸©é£äºçæçåå¬å®¤èæ¯é³ã</li>
<li>ð§&nbsp;<a href="https://mynoise.net/NoiseMachines/openOfficeNoiseGenerator.php" rel="noopener nofollow">myNoise - Open Office Noise Generator</a>: å¯èªå®ä¹çå¼æ¾å¼åå¬å®¤é³æï¼è°èæ¯ä¸ç§å£°é³çé³éï¼éç°è®°å¿ä¸­é£ä¸ªææ¸©åº¦çåå¬å®¤ã&nbsp;</li>
</ul>
<p><img src="https://img2024.cnblogs.com/blog/1433301/202602/1433301-20260211164437369-1038341926.png" alt="image" width="608" height="505" loading="lazy" style="display: block; margin-left: auto; margin-right: auto"></p>
<p><img src="https://knightyun.github.io/markdown-to-richtext/repository/image/%E2%80%9C%E5%A3%B0%E2%80%9D%E4%B8%B4%E5%85%B6%E5%A2%83%E7%BD%91%E7%AB%99%E5%88%86%E4%BA%AB/%E5%B1%80%E9%83%A8%E6%88%AA%E5%8F%96_20260211_164005.jpeg" alt=""></p>
<h2>å¾ä¹¦é¦çå£°é³</h2>
<ul>
<li>ð&nbsp;<a href="https://www.imissmylibrary.com/" rel="noopener nofollow">I Miss My Library</a>: é£ä¸ªå®éçè§è½ãå¶å°çç¿»ä¹¦å£°ãè¿å¤è½»è½»çèæ­¥å£°ââå½ä½ æ æ³å»å¾ä¹¦é¦æ¶ï¼è®©è¿ä¸ªç½ç«å¸¦ä½ åå°é£ä¸ªä¸æ³¨èå¹³éçç©ºé´ã&nbsp;</li>
</ul>
<p><img src="https://img2024.cnblogs.com/blog/1433301/202602/1433301-20260211165103664-1302666359.jpg" alt="file-20260211163544068" width="782" height="518" loading="lazy" style="display: block; margin-left: auto; margin-right: auto"></p>
<p><img src="https://knightyun.github.io/markdown-to-richtext/repository/image/%EF%80%A2%E5%A3%B0%EF%80%A2%E4%B8%B4%E5%85%B6%E5%A2%83%E7%BD%91%E7%AB%99%E5%88%86%E4%BA%AB/%E5%B1%80%E9%83%A8%E6%88%AA%E5%8F%96_20260211_163402.jpeg" alt=""></p>
<h2>åå¡é¦çå£°é³</h2>
<ul>
<li>â&nbsp;<a href="https://imissmycafe.com/" rel="noopener nofollow">I Miss My Cafe</a>: æå¿µé£ä¸ªå¸¸å»çåå¡é¦åï¼è½»æçèæ¯é³ä¹ãæ¯çç¢°æçå£°é³ãéçäººçäº¤è°å£°â¦â¦è¿äºå£°é³æ¼åæè®°å¿ä¸­ææ¸©æçç»é¢ã</li>
<li>ð¶&nbsp;<a href="https://hipstersound.com/ambience.html" rel="noopener nofollow">Hipster Sound - Cafe Ambience</a>: ç²¾å¿éç°åå¡é¦çæ°å´ï¼è®©ä½ ä»¿ä½ååå¨é£ä¸ªçæçä½ç½®ï¼éæ¸©æ¬ææ¶åã</li>
</ul>
<p><img src="https://img2024.cnblogs.com/blog/1433301/202602/1433301-20260211165307740-1452624381.jpg" alt="cafe-ambience" width="703" height="469" loading="lazy" style="display: block; margin-left: auto; margin-right: auto"></p>
<h2>é¤åçå£°é³</h2>
<ul>
<li>ð½ï¸&nbsp;<a href="https://hipstersound.com/" rel="noopener nofollow">Hipster Sound - Restaurant Ambience</a>: é£äºåæåç¸èçé¤åãç­é¹çæ°å´ãæ¬¢å¿«çè°ç¬å£°ï¼è¿ä¸ªç½ç«å¸®ä½ æ¾åé£äºç¾å¥½çèé¤æ¶åã</li>
</ul>
<h2 id="2">åå¸é¨å¤©</h2>
<ul>
<li>ð§ï¸&nbsp;<a href="https://rainyscope.com/" rel="noopener nofollow">Rainyscope</a>: è¿è®°å¾åå¨çªè¾¹å¬é¨çæè§åï¼æ¸©æçé¨å£°æ²æçªæ·ï¼è®©äººå¿éèæ¸©æãè¿ä¸ªç½ç«å¸¦ä½ éæ¸©é£äºé¨å¤©çç¾å¥½æ¶åã</li>
</ul>
<p><img src="https://img2024.cnblogs.com/blog/1433301/202602/1433301-20260211165336518-1364073062.jpg" alt="rain-window" width="386" height="579" loading="lazy" style="display: block; margin-left: auto; margin-right: auto"></p>
<h2>æµ·è¾¹çå£°é³</h2>
<ul>
<li>ð <a href="https://virtocean.com/" target="_blank" rel="noopener nofollow">Virtocean</a>: æµ·æµªæææ²æ»©çå£°é³ãæµ·é£å¹è¿çå£°é³â¦â¦å½ä½ æ æ³å»æµ·è¾¹æ¶ï¼è®©è¿äºå£°é³å¸¦ä½ åå°é£çèèã</li>
</ul>
<p><img src="https://img2024.cnblogs.com/blog/1433301/202602/1433301-20260211165354416-2008879966.jpg" alt="ocean-waves" width="348" height="619" loading="lazy" style="display: block; margin-left: auto; margin-right: auto"></p>
<h2>åå¸çå£°é³</h2>
<ul>
<li>ð¦&nbsp;<a href="https://mynoise.net/NoiseMachines/urbanRainSoundGenerator.php" rel="noopener nofollow">myNoise - Urban Rain Sound Generator</a>: é¨å¤çåå¸ãè½¦æµçå£°é³ãé¨æ»´æå¨è¡éä¸çå£°é³â¦â¦è¿äºå£°é³ææäºé½å¸ç¬ç¹çéµå¾ã</li>
</ul>
<p>å¸æè¿äºç½ç«è½å¸®ä½ æ¾åé£äºæ³å¿µçå£°é³ï¼å¨çæçé³æä¸­ï¼éæ¸©è®°å¿éé£äºæ¸©æçæ¶åãå ä¸ºæäºå°æ¹ï¼å³ä½¿ä¸å¨èº«è¾¹ï¼ä¹æ°¸è¿å¨å¿éã</p>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-02-11 17:28">2026-02-11 17:27</span>&nbsp;
<a href="https://www.cnblogs.com/LXP-Never">åéæ</a>&nbsp;
éè¯»(<span id="post_view_count">44</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19605364);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19605364', targetLink: 'https://www.cnblogs.com/LXP-Never/p/19605364', title: 'âå£°âä¸´å¶å¢ç½ç«åäº«' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
        </channel>
        </rss>