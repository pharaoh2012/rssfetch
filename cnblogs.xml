<?xml version="1.0" encoding="UTF-8" ?>
    <rss version="2.0">
    <channel>
        <title><![CDATA[ ä¸»é¡µ - åå®¢å­ ]]></title>
        <link><![CDATA[ https://www.cnblogs.com/ ]]></link>
        <lastBuildDate>2026-02-01T12:38:14.341Z</lastBuildDate>
        <description><![CDATA[
        ä¸»é¡µ - åå®¢å­ RSS
    ]]></description>
        <language>zh-cn</language>
        <item>
    <title><![CDATA[ Debian 13åºäºkubeadmåcontainerdé¨ç½²åèç¹kubernetes ]]></title>
    <link>https://www.cnblogs.com/XY-Heruo/p/19560948</link>
    <guid>65d06c3c748c74eed7eabaa60a18b86c</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/XY-Heruo/p/19560948" title="åå¸äº 2026-02-01 16:03">
    <span role="heading" aria-level="2">Debian 13åºäºkubeadmåcontainerdé¨ç½²åèç¹kubernetes</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                    <div id="cnblogs_post_description" style="display: none">
        
        å¨æ¬å°èææºç¯å¢ä¸­ä½¿ç¨ kubeadm+containerd+harbor+cilium æ­å»º Kubernetes éç¾¤
    </div>
<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h2 id="åè¨">åè¨</h2>
<p>å¨æ¬å°èææºç¯å¢ä¸­ä½¿ç¨ kubeadm æ­å»º Kubernetes éç¾¤æ¯å­¦ä¹ åå®éªççæ³éæ©ãèèå°å®éåºç¨åºæ¯ä¸­å¯è½å­å¨çç½ç»éå¶ä»¥åéåæå»ºéæ±ï¼æ¬æè¯¦ç»è®°å½äºå¨å®å¨ç¦»çº¿ç¯å¢ä¸é¨ç½²åèç¹ Kubernetes éç¾¤çå®æ´è¿ç¨ãéè¿éæ Harbor ç§æéåä»åºï¼ææ Kubernetes ç»ä»¶éååä»æ¬å° Harbor å®ä¾æåï¼ç¡®ä¿é¨ç½²è¿ç¨çå¯é æ§åå¯éå¤æ§ã</p>
<p>æ¬æåéç¨äºå¸æå¨åéç½ç»ç¯å¢ä¸­å¿«éæ­å»º Kubernetes å®éªç¯å¢çææ¯äººåï¼æ¶µçäºä»ç³»ç»åå§åå° Cilium ç½ç»æä»¶éç½®çå¨æµç¨ã</p>
<h2 id="ç¯å¢åçæ¬ä¿¡æ¯">ç¯å¢åçæ¬ä¿¡æ¯</h2>
<h3 id="åºç¡ç¯å¢éç½®">åºç¡ç¯å¢éç½®</h3>
<ul>
<li><strong>æä½ç³»ç»</strong>ï¼Debian 13 (ä»£å· "Trixie")</li>
<li><strong>ç¡¬ä»¶è§æ ¼</strong>ï¼4 æ ¸ CPU / 4GB åå­ / 40GB å­å¨ç©ºé´</li>
<li><strong>ç½ç»ææ</strong>ï¼åèç¹é¨ç½²ï¼Control Plane + Worker åä¸ï¼</li>
</ul>
<h3 id="è½¯ä»¶çæ¬æ¸å">è½¯ä»¶çæ¬æ¸å</h3>
<table>
<thead>
<tr>
<th>ç»ä»¶</th>
<th>çæ¬</th>
<th>è¯´æ</th>
</tr>
</thead>
<tbody>
<tr>
<td>Kubernetes</td>
<td>v1.33.7</td>
<td>å®¹å¨ç¼æå¹³å°</td>
</tr>
<tr>
<td>containerd</td>
<td>2.2.1</td>
<td>å®¹å¨è¿è¡æ¶</td>
</tr>
<tr>
<td>runc</td>
<td>1.4.0</td>
<td>OCI è¿è¡æ¶è§èå®ç°</td>
</tr>
<tr>
<td>CNI Plugins</td>
<td>1.9.0</td>
<td>å®¹å¨ç½ç»æ¥å£æä»¶</td>
</tr>
<tr>
<td>Harbor</td>
<td>v2.14.2</td>
<td>ä¼ä¸çº§å®¹å¨éåä»åº</td>
</tr>
<tr>
<td>Cilium</td>
<td>v1.18.6</td>
<td>eBPF é©±å¨çç½ç»åå®å¨è§£å³æ¹æ¡</td>
</tr>
<tr>
<td>Helm</td>
<td>3.19.5</td>
<td>Kubernetes åç®¡çå¨</td>
</tr>
</tbody>
</table>
<h3 id="ç½ç»è§å">ç½ç»è§å</h3>
<table>
<thead>
<tr>
<th>IP å°å</th>
<th>ä¸»æºå</th>
<th>è§è²</th>
</tr>
</thead>
<tbody>
<tr>
<td>192.168.0.22</td>
<td>deb13-k8s-node1</td>
<td>Kubernetes èç¹</td>
</tr>
<tr>
<td>192.168.0.42</td>
<td>deb13-harbor</td>
<td>Harbor éåä»åº</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>æ³¨æ</strong>ï¼æ¬ææ¡£åè®¾ä¸¤å°ä¸»æºä½äºåä¸åç½ç¯å¢ä¸­ï¼ä¸ç½ç»è¿éæ§å·²éªè¯ã</p>
</blockquote>
<h2 id="ç³»ç»åå§å">ç³»ç»åå§å</h2>
<p>å¨å¼å§ Kubernetes ç»ä»¶å®è£ä¹åï¼éè¦å¯¹ç³»ç»è¿è¡å¿è¦çåå§åéç½®ï¼ä»¥æ»¡è¶³ Kubernetes çè¿è¡è¦æ±ã</p>
<h3 id="1-å®è£-ipvs-ç¸å³å·¥å·å">1. å®è£ IPVS ç¸å³å·¥å·å</h3>
<p>IPVSï¼IP Virtual Serverï¼æ¯ Linux åæ ¸çè´è½½åè¡¡å®ç°ï¼Kubernetes å¨ IPVS æ¨¡å¼ä¸è¿è¡ kube-proxy æ¶éè¦ç¸å³å·¥å·æ¯æã</p>
<pre><code class="language-bash"># ä»å¨ Kubernetes èç¹æ§è¡
sudo apt update
sudo apt install -y ipvsadm ipset
</code></pre>
<h3 id="2-éç½®ä¸»æºå">2. éç½®ä¸»æºå</h3>
<p>ä¸ºä¾¿äºç®¡çåè¯å«ï¼å»ºè®®ä¸ºæ¯å°ä¸»æºè®¾ç½®ææä¹çä¸»æºåã</p>
<pre><code class="language-bash"># Harbor æå¡å¨
hostnamectl set-hostname deb13-harbor

# Kubernetes èç¹
hostnamectl set-hostname deb13-k8s-node1
</code></pre>
<h3 id="3-éç½®æ¬å°-dns-è§£æ">3. éç½®æ¬å° DNS è§£æ</h3>
<p>ç¼è¾ <code>/etc/hosts</code> æä»¶ï¼æ·»å ä¸»æºåä¸ IP å°åçæ å°å³ç³»ï¼</p>
<pre><code class="language-bash">cat &gt;&gt; /etc/hosts &lt;&lt; EOF
192.168.0.22 deb13-k8s-node1
192.168.0.42 deb13-harbor
EOF
</code></pre>
<h3 id="4-å è½½å¿è¦çåæ ¸æ¨¡å">4. å è½½å¿è¦çåæ ¸æ¨¡å</h3>
<p>Kubernetes ä¾èµç¹å®çåæ ¸æ¨¡åæ¥æ¯æå®¹å¨ç½ç»åè½ãåå»ºæ¨¡åå è½½éç½®å¹¶ç«å³çæï¼</p>
<pre><code class="language-bash"># åå»ºæ¨¡åå è½½éç½®æä»¶
cat &lt;&lt; EOF &gt; /etc/modules-load.d/containerd.conf
overlay
br_netfilter
EOF

# ç«å³å è½½æ¨¡å
sudo modprobe overlay
sudo modprobe br_netfilter

# éªè¯æ¨¡åå è½½ç¶æ
lsmod | grep -E "(overlay|br_netfilter)"
</code></pre>
<h3 id="5-éç½®ç³»ç»åæ ¸åæ°">5. éç½®ç³»ç»åæ ¸åæ°</h3>
<p>è°æ´åæ ¸åæ°ä»¥ä¼åå®¹å¨è¿è¡ç¯å¢ï¼</p>
<pre><code class="language-bash">cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt; EOF
net.ipv4.ip_forward=1
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
vm.swappiness = 0
EOF

# åºç¨éç½®
sudo sysctl --system
</code></pre>
<blockquote>
<p><strong>éè¦æç¤º</strong>ï¼å¦æç³»ç»å¯ç¨äº swap ååºï¼å¿é¡»å¨ Kubernetes å¯å¨åå°å¶å³é­ï¼å¦å kubelet å°æ æ³æ­£å¸¸å¯å¨ãå¯éè¿ä»¥ä¸å½ä»¤ä¸´æ¶å³é­ï¼</p>
</blockquote>
<pre><code class="language-bash">sudo swapoff -a
# æ°¸ä¹å³é­éæ³¨é /etc/fstab ä¸­ç swap ç¸å³è¡
</code></pre>
<h2 id="harbor-ç§æéåä»åºé¨ç½²">Harbor ç§æéåä»åºé¨ç½²</h2>
<p>Harbor ä½ä¸ºä¼ä¸çº§å®¹å¨éåä»åºï¼ä¸ºç¦»çº¿ç¯å¢ä¸ç Kubernetes é¨ç½²æä¾äºå¯é çéåååè½åã</p>
<h3 id="1-åå¤-harbor-å®è£å">1. åå¤ Harbor å®è£å</h3>
<p>ä» <a href="https://github.com/goharbor/harbor/releases" target="_blank" rel="noopener nofollow">Harbor GitHub Releases</a> é¡µé¢ä¸è½½ç¦»çº¿å®è£åï¼çº¦ 600MBï¼ãå®è£ Harbor åéç¡®ä¿ Docker å Docker Compose å·²æ­£ç¡®å®è£ã</p>
<h3 id="2-çæèªç­¾å-tls-è¯ä¹¦">2. çæèªç­¾å TLS è¯ä¹¦</h3>
<p>ç±äº Harbor å¼ºå¶è¦æ± HTTPS è¿æ¥ï¼æä»¬éè¦ä¸º Harbor æå¡å¨çæèªç­¾åè¯ä¹¦ãåå»ºè¯ä¹¦çæèæ¬ï¼</p>
<pre><code class="language-bash"># åå»ºè¯ä¹¦ç®å½
mkdir -p ~/apps/harbor/certs
cd ~/apps/harbor/certs

# åå»ºè¯ä¹¦çæèæ¬
cat &gt; gen-harbor-crt.sh &lt;&lt; 'EOF'
#!/bin/bash

# --- éç½®åæ° ---
DOMAIN="deb13-harbor"       # Harbor åå
IP="192.168.0.42"           # Harbor æå¡å¨åç½ IP
DAYS=3650                   # æææ 10 å¹´

# 1. çæç§é¥ (æ å¯ç )
openssl genrsa -out harbor.key 2048

# 2. åå»º OpenSSL éç½®æä»¶ä»¥åå« SAN
cat &gt; harbor.conf &lt;&lt; CONF_EOF
[req]
distinguished_name = req_distinguished_name
x509_extensions = v3_req
prompt = no

[req_distinguished_name]
CN = ${DOMAIN}

[v3_req]
keyUsage = critical, digitalSignature, keyEncipherment
extendedKeyUsage = serverAuth
subjectAltName = @alt_names

[alt_names]
DNS.1 = ${DOMAIN}
IP.1 = ${IP}
CONF_EOF

# 3. çæèªç­¾åè¯ä¹¦
openssl req -x509 -nodes -days ${DAYS} -key harbor.key -out harbor.crt -config harbor.conf -extensions v3_req

# 4. éªè¯è¯ä¹¦ï¼æ¥çæ¯å¦æ Subject Alternative Name å­æ®µï¼
echo "--------------------------------------------------"
echo "è¯ä¹¦ä¿¡æ¯éªè¯ï¼"
openssl x509 -in harbor.crt -text -noout | grep -A 1 "Subject Alternative Name"

echo "--------------------------------------------------"
echo "çææåï¼"
echo "æå¡ç«¯ä½¿ç¨: harbor.crt, harbor.key"
echo "å®¢æ·ç«¯ (K8s èç¹) ä½¿ç¨: harbor.crt"
EOF

# æ§è¡è¯ä¹¦çæ
chmod +x gen-harbor-crt.sh
./gen-harbor-crt.sh
</code></pre>
<h3 id="3-éç½®-harbor">3. éç½® Harbor</h3>
<p>ä»æ¨¡æ¿æä»¶å¤å¶å¹¶ä¿®æ¹ Harbor éç½®ï¼</p>
<pre><code class="language-bash"># å¤å¶éç½®æ¨¡æ¿
cp harbor.yml.tmpl harbor.yml

# ä¿®æ¹å³é®éç½®é¡¹
</code></pre>
<p>ä¸»è¦éç½®é¡¹å¦ä¸ï¼</p>
<pre><code class="language-yaml"># Harbor è®¿é®å°å
hostname: 192.168.0.42

# HTTPS éç½®
https:
  port: 443
  certificate: /home/rainux/apps/harbor/certs/harbor.crt
  private_key: /home/rainux/apps/harbor/certs/harbor.key

# ç®¡çåå¯ç ï¼è¯·è®¾ç½®å¼ºå¯ç ï¼
harbor_admin_password: your-harbor-password

# æ°æ®åºå¯ç 
database:
  password: your-db-password

# æ°æ®å­å¨è·¯å¾
data_volume: /home/rainux/apps/harbor/data

# æ¥å¿éç½®
log:
  location: /home/rainux/apps/harbor/logs

# å¯ç¨ææ çæ§
metric:
  enabled: true
  port: 9090
  path: /metrics
</code></pre>
<h3 id="4-å¯å¨-harbor-æå¡">4. å¯å¨ Harbor æå¡</h3>
<pre><code class="language-bash">cd ~/apps/harbor
sudo ./install.sh
</code></pre>
<h3 id="5-åå§å-harbor-é¡¹ç®">5. åå§å Harbor é¡¹ç®</h3>
<p>éè¿ Web çé¢è®¿é® Harborï¼<a href="https://192.168.0.42" target="_blank" rel="noopener nofollow">https://192.168.0.42</a>ï¼ï¼ä½¿ç¨éç½®çç®¡çåå¯ç ç»å½åï¼åå»ºä»¥ä¸ä¸¤ä¸ªå¬å¼é¡¹ç®ï¼</p>
<ul>
<li><code>google_containers</code>ï¼ç¨äºå­å¨ Kubernetes æ ¸å¿ç»ä»¶éå</li>
<li><code>cilium</code>ï¼ç¨äºå­å¨ Cilium ç½ç»æä»¶ç¸å³éå</li>
</ul>
<blockquote>
<p><strong>éç½®æ´æ°è¯´æ</strong>ï¼å¦éä¿®æ¹ Harbor éç½®ï¼å¯æ§è¡ä»¥ä¸å½ä»¤ä½¿éç½®çæï¼</p>
<pre><code class="language-bash">sudo ./prepare
docker-compose down -v
sudo docker-compose up -d
</code></pre>
</blockquote>
<h2 id="containerd-å®¹å¨è¿è¡æ¶éç½®">Containerd å®¹å¨è¿è¡æ¶éç½®</h2>
<p>Containerd ä½ä¸ºè½»éçº§å®¹å¨è¿è¡æ¶ï¼æ¯ Kubernetes æ¨èçè¿è¡æ¶éé¡¹ä¹ä¸ã</p>
<h3 id="1-ä¸è½½å¿è¦ç»ä»¶">1. ä¸è½½å¿è¦ç»ä»¶</h3>
<p>ä»å®æ¹ GitHub ä»åºä¸è½½ä»¥ä¸ç»ä»¶ï¼</p>
<ul>
<li><a href="https://github.com/containerd/containerd/releases" target="_blank" rel="noopener nofollow">containerd</a></li>
<li><a href="https://github.com/opencontainers/runc/releases" target="_blank" rel="noopener nofollow">runc</a></li>
<li><a href="https://github.com/containernetworking/plugins/releases" target="_blank" rel="noopener nofollow">CNI Plugins</a></li>
</ul>
<h3 id="2-å®è£-runc">2. å®è£ runc</h3>
<pre><code class="language-bash"># æ³¨æï¼åæä¸­çæä»¶åå¯è½å­å¨ç¬è¯¯ï¼åºä¸º runc.amd64
chmod +x runc.amd64
sudo mv runc.amd64 /usr/local/bin/runc
</code></pre>
<h3 id="3-å®è£-cni-æä»¶">3. å®è£ CNI æä»¶</h3>
<pre><code class="language-bash">sudo mkdir -p /opt/cni/bin/
sudo tar xf cni-plugins-linux-amd64-v1.9.0.tgz -C /opt/cni/bin/
</code></pre>
<h3 id="4-å®è£-containerd">4. å®è£ containerd</h3>
<pre><code class="language-bash">sudo tar xf containerd-2.2.1-linux-amd64.tar.gz
sudo mv bin/* /usr/local/bin/
</code></pre>
<h3 id="5-éç½®-containerd">5. éç½® containerd</h3>
<p>çæé»è®¤éç½®å¹¶è¿è¡å¿è¦çä¿®æ¹ï¼</p>
<pre><code class="language-bash"># åå»º Harbor è¯ä¹¦ç®å½
sudo mkdir -p /etc/containerd/certs.d/192.168.0.42/

# çæé»è®¤éç½®
sudo containerd config default &gt; /etc/containerd/config.toml

# å¤å¶ Harbor è¯ä¹¦
sudo cp ~/apps/harbor/certs/harbor.crt /etc/containerd/certs.d/192.168.0.42/ca.crt
</code></pre>
<p>å³é®éç½®ä¿®æ¹ï¼</p>
<pre><code class="language-toml"># è®¾ç½® Pod æ²ç®±éåæº
[plugins.'io.containerd.cri.v1.images'.pinned_images]
  sandbox = '192.168.0.42/google_containers/pause:3.10'

# éç½®ç§æéåä»åº
[plugins.'io.containerd.cri.v1.images'.registry]
  config_path = '/etc/containerd/certs.d'

# å¯ç¨ systemd cgroup é©±å¨
[plugins.'io.containerd.cri.v1.runtime'.containerd.runtimes.runc.options]
  SystemdCgroup = true
</code></pre>
<h3 id="6-éç½®-systemd-æå¡">6. éç½® systemd æå¡</h3>
<p>ä» <a href="https://raw.githubusercontent.com/containerd/containerd/main/containerd.service" target="_blank" rel="noopener nofollow">å®æ¹ä»åº</a> è·å service æä»¶ï¼</p>
<pre><code class="language-bash">sudo curl -o /usr/lib/systemd/system/containerd.service https://raw.githubusercontent.com/containerd/containerd/main/containerd.service
</code></pre>
<h3 id="7-å¯å¨-containerd-æå¡">7. å¯å¨ containerd æå¡</h3>
<pre><code class="language-bash">sudo systemctl daemon-reload
sudo systemctl enable --now containerd
</code></pre>
<h2 id="kubernetes-ç»ä»¶é¨ç½²">Kubernetes ç»ä»¶é¨ç½²</h2>
<h3 id="1-å®è£-kubernetes-äºè¿å¶æä»¶">1. å®è£ Kubernetes äºè¿å¶æä»¶</h3>
<p>ä» <a href="https://github.com/kubernetes/kubernetes/releases" target="_blank" rel="noopener nofollow">Kubernetes GitHub Releases</a> ä¸è½½ <code>kubernetes-server-linux-amd64.tar.gz</code>ï¼æåæ ¸å¿ç»ä»¶ï¼</p>
<pre><code class="language-bash"># è§£åå¹¶å®è£æ ¸å¿ç»ä»¶
tar xf kubernetes-server-linux-amd64.tar.gz
sudo cp kubernetes/server/bin/{kubeadm,kubelet,kubectl} /usr/local/bin/

# éªè¯æééååè¡¨
kubeadm config images list --kubernetes-version v1.33.7
</code></pre>
<p>å°ååºçææéåï¼åæ¬ pauseãcorednsãetcd ç­ï¼ä»å®æ¹æºæååéæ°ææ ç­¾å¹¶æ¨éå° Harbor ç <code>google_containers</code> é¡¹ç®ä¸­ã</p>
<h3 id="2-éç½®-kubelet-systemd-æå¡">2. éç½® kubelet systemd æå¡</h3>
<p>åå»ºä¸»æå¡æä»¶ <code>/usr/lib/systemd/system/kubelet.service</code>ï¼</p>
<pre><code class="language-ini">[Unit]
Description=kubelet: The Kubernetes Node Agent
Documentation=https://kubernetes.io/docs/
Wants=network-online.target
After=network-online.target

[Service]
ExecStart=/usr/local/bin/kubelet
Restart=always
StartLimitInterval=0
RestartSec=10

[Install]
WantedBy=multi-user.target
</code></pre>
<h3 id="3-åå»º-kubeadm-éç½®ç®å½">3. åå»º kubeadm éç½®ç®å½</h3>
<pre><code class="language-bash">sudo mkdir -p /usr/lib/systemd/system/kubelet.service.d/
</code></pre>
<h3 id="4-éç½®-kubeadm-drop-in-æä»¶">4. éç½® kubeadm drop-in æä»¶</h3>
<p>åå»º <code>/usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf</code>ï¼</p>
<pre><code class="language-ini"># Note: This dropin only works with kubeadm and kubelet v1.11+
[Service]
Environment="KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf"
Environment="KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml"
# This is a file that "kubeadm init" and "kubeadm join" generates at runtime, populating the KUBELET_KUBEADM_ARGS variable dynamically
EnvironmentFile=-/var/lib/kubelet/kubeadm-flags.env
# This is a file that the user can use for overrides of the kubelet args as a last resort. Preferably, the user should use
# the .NodeRegistration.KubeletExtraArgs object in the configuration files instead. KUBELET_EXTRA_ARGS should be sourced from this file.
EnvironmentFile=-/etc/sysconfig/kubelet
ExecStart=
ExecStart=/usr/local/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_ARGS $KUBELET_EXTRA_ARGS
</code></pre>
<h3 id="5-å¯å¨-kubelet-æå¡">5. å¯å¨ kubelet æå¡</h3>
<pre><code class="language-bash">sudo systemctl daemon-reload
sudo systemctl enable --now kubelet
</code></pre>
<h2 id="éç¾¤åå§å">éç¾¤åå§å</h2>
<h3 id="1-åå»º-kubeadm-éç½®æä»¶">1. åå»º kubeadm éç½®æä»¶</h3>
<p>åå»º <code>kubeadm-config.yaml</code> éç½®æä»¶ï¼</p>
<pre><code class="language-yaml">apiVersion: kubeadm.k8s.io/v1beta4
kind: ClusterConfiguration
kubernetesVersion: v1.33.7
imageRepository: 192.168.0.42/google_containers  # æåæ¬å° Harbor ä»åº
networking:
  podSubnet: "10.10.0.0/16"   # Cilium é»è®¤ Pod ç½æ®µ
  serviceSubnet: "10.96.0.0/12"
---
apiVersion: kubelet.config.k8s.io/v1beta1
kind: KubeletConfiguration
cgroupDriver: systemd
imageGCHighThresholdPercent: 70   # ç£çä½¿ç¨çè¶è¿ 70% æ¶å¼å§æ¸çéå
imageGCLowThresholdPercent: 60    # æ¸çè³ç£çä½¿ç¨ç 60% æ¶åæ­¢
---
apiVersion: kubeproxy.config.k8s.io/v1alpha1
kind: KubeProxyConfiguration
mode: "ipvs"  # è½ç¶åç»­ä¼ä½¿ç¨ Cilium æ¿ä»£ kube-proxyï¼ä½åå§åé¶æ®µä»ééç½®
</code></pre>
<h3 id="2-æ§è¡éç¾¤åå§å">2. æ§è¡éç¾¤åå§å</h3>
<pre><code class="language-bash">sudo kubeadm init --config kubeadm-config.yaml --ignore-preflight-errors=ImagePull
</code></pre>
<h3 id="3-æ¸ç-kube-proxyä½¿ç¨-cilium-æ¿ä»£">3. æ¸ç kube-proxyï¼ä½¿ç¨ Cilium æ¿ä»£ï¼</h3>
<p>ç±äºæä»¬å°ä½¿ç¨ Cilium ä½ä¸ºç½ç»è§£å³æ¹æ¡ï¼å¯ä»¥ç§»é¤ kube-proxyï¼</p>
<pre><code class="language-bash"># å é¤ kube-proxy DaemonSet
kubectl delete ds kube-proxy -n kube-system

# å¨ææèç¹æ¸ç iptables è§åæ®ç
sudo kube-proxy --cleanup
</code></pre>
<h3 id="4-éªè¯åå§åç¶æ">4. éªè¯åå§åç¶æ</h3>
<p>åå§åå®æåï¼éç½® kubectl å¹¶æ£æ¥éç¾¤ç¶æï¼</p>
<pre><code class="language-bash"># éç½® kubectl
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config

# æ£æ¥èç¹ç¶æï¼æ­¤æ¶åºæ¾ç¤º NotReadyï¼å ä¸º CNI å°æªå®è£ï¼
kubectl get nodes
kubectl get namespaces
</code></pre>
<h2 id="cilium-ç½ç»æä»¶é¨ç½²">Cilium ç½ç»æä»¶é¨ç½²</h2>
<p>Cilium åºäº eBPF ææ¯æä¾é«æ§è½çç½ç»ãå®å¨åå¯è§æµæ§åè½ã</p>
<h3 id="1-å®è£-cilium-cli">1. å®è£ cilium-cli</h3>
<p>ä» <a href="https://github.com/cilium/cilium-cli/releases" target="_blank" rel="noopener nofollow">Cilium CLI Releases</a> ä¸è½½å¹¶å®è£å½ä»¤è¡å·¥å·ã</p>
<h3 id="2-åå¤-cilium-éå">2. åå¤ Cilium éå</h3>
<p>å° Cilium æéçéåæ¨éå° Harbor ä»åºï¼</p>
<pre><code class="language-bash">#!/bin/bash

set -euo pipefail

images=(
    cilium/cilium:v1.18.6
    cilium/hubble-relay:v1.18.6
    cilium/hubble-ui-backend:v0.13.3
    cilium/hubble-ui:v0.13.3
    cilium/cilium-envoy:v1.35.9-1767794330-db497dd19e346b39d81d7b5c0dedf6c812bcc5c9
    cilium/certgen:v0.3.1
    cilium/startup-script:1755531540-60ee83e
)

src_registry="quay.io"
target_registry="192.168.0.42"

for image in "${images[@]}"; do
    echo "Processing image: ${image}"
    docker pull "${src_registry}/${image}"
    docker tag "${src_registry}/${image}" "${target_registry}/${image}"
    docker push "${target_registry}/${image}"
done
</code></pre>
<h3 id="3-è·å-helm-chart">3. è·å Helm Chart</h3>
<pre><code class="language-bash">helm repo add cilium https://helm.cilium.io/
helm pull cilium/cilium --version 1.18.6
tar xf cilium-1.18.6.tgz
mv cilium cilium-chart
</code></pre>
<h3 id="4-éç½®-chart-values">4. éç½® Chart Values</h3>
<p>é¦åæ¿æ¢ææéåæºå°åï¼</p>
<pre><code class="language-bash">sed -i 's#quay.io#192.168.0.42#g' ./cilium-chart/values.yaml
</code></pre>
<p>å³é®éç½®é¡¹è°æ´ï¼</p>
<pre><code class="language-yaml"># å¯ç¨ kube-proxy æ¿ä»£æ¨¡å¼
kubeProxyReplacement: true

# æå® Kubernetes API æå¡å¨å°å
k8sServiceHost: "192.168.0.22"
k8sServicePort: 6443

# åèç¹é¨ç½²ï¼operator å¯æ¬æ°è®¾ä¸º 1
operator:
  replicas: 1

# å¯ç¨ Hubble å¯è§æµæ§ç»ä»¶
hubble:
  enabled: true
  relay:
    enabled: true
  ui:
    enabled: true

# éç½® IPAM CIDR èå´
ipam:
  operator:
    clusterPoolIPv4PodCIDRList:
      - "10.10.0.0/16"
</code></pre>
<blockquote>
<p><strong>éå Digest æ³¨æäºé¡¹</strong>ï¼éè¿ docker pull å push çæ¹å¼å¯è½å¯¼è´éå digest åçååãå¦ééåæåå¤±è´¥ï¼å¯å° <code>values.yaml</code> ä¸­ç <code>useDigest</code> è®¾ç½®ä¸º <code>false</code>ã</p>
</blockquote>
<h3 id="5-å®è£-cilium">5. å®è£ Cilium</h3>
<pre><code class="language-bash"># æ§è¡å®è£
cilium install --chart-directory ./cilium-chart

# æ£æ¥å®è£ç¶æ
cilium status

# ç§»é¤ control-plane æ±¡ç¹ä»¥åè®¸ Pod è°åº¦
kubectl taint nodes --all node-role.kubernetes.io/control-plane-
</code></pre>
<h3 id="6-éªè¯éç¾¤ç¶æ">6. éªè¯éç¾¤ç¶æ</h3>
<p>ç­å¾ææ Pod æ­£å¸¸è¿è¡åï¼éªè¯éç¾¤å°±ç»ªç¶æï¼</p>
<pre><code class="language-bash"># æ£æ¥ææå½åç©ºé´ç Pod ç¶æ
kubectl get pods -A

# éªè¯èç¹ç¶æï¼åºæ¾ç¤º Readyï¼
kubectl get nodes

# æ£æ¥ Cilium ç»ä»¶ç¶æ
cilium status --verbose
</code></pre>
<h2 id="æ·»å å·¥ä½èç¹æ©å±é¨ç½²">æ·»å å·¥ä½èç¹ï¼æ©å±é¨ç½²ï¼</h2>
<p>å®æåèç¹éç¾¤é¨ç½²åï¼å¦éæ©å±ä¸ºå¤èç¹éç¾¤ï¼å¯å¨æ°èç¹ä¸æ§è¡ä»¥ä¸æ­¥éª¤ï¼</p>
<p><em>å¨æ°èç¹ä¸éè¦åå®æä¸é¢çç³»ç»åå§åãContainerdéç½®ãkubeç»ä»¶éç½®</em></p>
<h3 id="1-çæèç¹å å¥ä»¤ç">1. çæèç¹å å¥ä»¤ç</h3>
<p>å¨ Control Plane èç¹ä¸çæ 24 å°æ¶ææçå å¥ä»¤çï¼</p>
<pre><code class="language-bash">kubeadm token create --print-join-command
</code></pre>
<p>è¯¥å½ä»¤å°è¾åºç±»ä¼¼ä»¥ä¸æ ¼å¼çå å¥å½ä»¤ï¼</p>
<pre><code class="language-bash">kubeadm join 192.168.0.22:6443 --token &lt;token&gt; --discovery-token-ca-cert-hash sha256:&lt;hash&gt;
</code></pre>
<h3 id="2-å¨æ°èç¹æ§è¡å å¥å½ä»¤">2. å¨æ°èç¹æ§è¡å å¥å½ä»¤</h3>
<p>å¨æ°èç¹ä¸æ§è¡ä¸è¿°å½ä»¤ï¼å¹¶å¿½ç¥éåé¢æ£éè¯¯ï¼</p>
<pre><code class="language-bash">sudo kubeadm join 192.168.0.22:6443 \
  --token &lt;token&gt; \
  --discovery-token-ca-cert-hash sha256:&lt;hash&gt; \
  --ignore-preflight-errors=ImagePull
</code></pre>
<h3 id="3-éªè¯èç¹å å¥ç¶æ">3. éªè¯èç¹å å¥ç¶æ</h3>
<pre><code class="language-bash"># æ£æ¥èç¹åè¡¨
kubectl get nodes

# éªè¯ Cilium ç¶æ
cilium status

# æ¸ç iptables è§åï¼å¦å·²ç¦ç¨ kube-proxyï¼
sudo iptables -F
</code></pre>
<p>Cilium ä¼èªå¨å¨æ°èç¹ä¸é¨ç½²ä»£ç Podï¼ç¡®ä¿ç½ç»è¿éæ§ã</p>
<h2 id="ç§æéåä»åºè®¤è¯éç½®">ç§æéåä»åºè®¤è¯éç½®</h2>
<p>å¯¹äº Harbor ä¸­éå¬å¼é¡¹ç®çéåæåï¼éè¦éç½®ç¸åºçè®¤è¯æºå¶ã</p>
<h3 id="æ¹å¼ä¸pod-çº§å«-imagepullsecretsæ¨è">æ¹å¼ä¸ï¼Pod çº§å« imagePullSecretsï¼æ¨èï¼</h3>
<p>éç¨äºéè¦ç²¾ç»åæ§å¶éåæåæéçåºæ¯ã</p>
<h4 id="1-åå»º-docker-registry-secret">1. åå»º Docker Registry Secret</h4>
<pre><code class="language-bash">kubectl create secret docker-registry harbor-pull-secret \
  --docker-server=192.168.0.42 \
  --docker-username=&lt;your-username&gt; \
  --docker-password=&lt;your-password&gt; \
  --docker-email=&lt;your-email&gt;
</code></pre>
<h4 id="2-å¨-pod-å®ä¹ä¸­å¼ç¨-secret">2. å¨ Pod å®ä¹ä¸­å¼ç¨ Secret</h4>
<pre><code class="language-yaml">apiVersion: v1
kind: Pod
spec:
  containers:
  - name: my-app
    image: 192.168.0.42/private-project/my-image:v1
  imagePullSecrets:
  - name: harbor-pull-secret
</code></pre>
<h3 id="æ¹å¼äºserviceaccount-ç»å®ä¾¿æ·æ¹æ¡">æ¹å¼äºï¼ServiceAccount ç»å®ï¼ä¾¿æ·æ¹æ¡ï¼</h3>
<p>éç¨äºå½åç©ºé´åææ Pod é½éè¦è®¿é®ç§æéåä»åºçåºæ¯ã</p>
<pre><code class="language-bash"># å° Secret ç»å®å° default ServiceAccount
kubectl patch serviceaccount default -p '{"imagePullSecrets": [{"name": "harbor-pull-secret"}]}'
</code></pre>
<p>æ­¤éç½®å°ä½¿è¯¥å½åç©ºé´ä¸æææ°å»ºç Pod èªå¨ç»§æ¿éåæåæéã</p>
<h3 id="æ¹å¼ä¸containerd-å¨å±è®¤è¯å®éªç¯å¢éç¨">æ¹å¼ä¸ï¼Containerd å¨å±è®¤è¯ï¼å®éªç¯å¢éç¨ï¼</h3>
<p>å¨ Containerd å±é¢éç½®å¨å±è®¤è¯ï¼éç¨äºä¸ªäººå®éªç¯å¢ã</p>
<p>ç¼è¾ <code>/etc/containerd/config.toml</code>ï¼</p>
<pre><code class="language-toml">[plugins."io.containerd.grpc.v1.cri".registry.configs."192.168.0.42".auth]
  username = "your-username"
  password = "your-password"
  # æä½¿ç¨ base64 ç¼ç çå­è¯ï¼auth = "base64(username:password)"
</code></pre>
<blockquote>
<p><strong>å®å¨æé</strong>ï¼æ¹å¼ä¸å°å­æ®ææå­å¨å¨éç½®æä»¶ä¸­ï¼ä¸å»ºè®®å¨çäº§ç¯å¢ä¸­ä½¿ç¨ã</p>
</blockquote>
<h2 id="è¡¥å">è¡¥å</h2>
<p>ç¸è¾äºä½¿ç¨äºè¿å¶æ¹å¼é¨ç½²ï¼ç¨kubeadmèµ·ç çå»äºæå¨ç»´æ¤è¯ä¹¦çæä½ï¼åç»­æ·»å èç¹ä¹æ´ç®åäºãæç©ºæ´ä¸ªansibleè®©æ·»å èç¹æ´æ¹ä¾¿ã</p>


</div>
<div id="MySignature" role="contentinfo">
    <p>æ¬ææ¥èªåå®¢å­ï¼ä½èï¼<a href="https://www.cnblogs.com/XY-Heruo/" target="_blank">è±ééä½ç°</a>ï¼è½¬è½½è¯·æ³¨æåæé¾æ¥ï¼<a href="https://www.cnblogs.com/XY-Heruo/p/19560948" target="_blank">https://www.cnblogs.com/XY-Heruo/p/19560948</a></p>
</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-02-01 16:03">2026-02-01 16:03</span>&nbsp;
<a href="https://www.cnblogs.com/XY-Heruo">è±ééä½ç°</a>&nbsp;
éè¯»(<span id="post_view_count">1</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19560948);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19560948', targetLink: 'https://www.cnblogs.com/XY-Heruo/p/19560948', title: 'Debian 13åºäºkubeadmåcontainerdé¨ç½²åèç¹kubernetes' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ å°SignalRç§»æ¤å°Esp32âè®©å°æºè®¾å¤æ ç¼è¿æ¥.NETåè½æå±MCPæå¡ ]]></title>
    <link>https://www.cnblogs.com/GreenShade/p/19560338</link>
    <guid>900c5995d4f485af3ac2a7a0a58fa091</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/GreenShade/p/19560338" title="åå¸äº 2026-02-01 15:33">
    <span role="heading" aria-level="2">å°SignalRç§»æ¤å°Esp32âè®©å°æºè®¾å¤æ ç¼è¿æ¥.NETåè½æå±MCPæå¡</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h2 id="åè¨">åè¨</h2>
<p>è¿æ®µæ¶é´è¿·ä¸äºææEsp32çå°æºèå¤©æºå¨äººï¼ä¹ç¨.NETä¸ºå°æºAIå¼åäºä¸äºMCPè½¬æ¥å¹³å°åMCPæå¡ãå°æºESP32æ¬èº«å°±å·å¤MCPè½åï¼å¯ä»¥è°ç¨æ¬å°MCPå·¥å·åæå¡ç«¯MCPå·¥å·ï¼å¹¶å°ç»æè¿åç»è®¾å¤ï¼è¿ä¸ªåè½ä¸ç´é½æã</p>
<p>å¦æä½ æææEsp32çç¡¬ä»¶ç©å·æç®ï¼å¯ä»¥å³æ³¨æçBç«è´¦å·ï¼ç»¿è«é¿å¹¿ï¼<a href="https://space.bilibili.com/25228512" target="_blank" rel="noopener nofollow">https://space.bilibili.com/25228512</a><br>
å¸¦ä½ ææç©å·ã</p>
<p>å°æºåæ¬è¿å¥æ¶ææä¸ªå±éæ§ï¼<strong>MCPå·¥å·æ§è¡å®ä¹åï¼åªè½åæ­¥è¿åç»ææèéè¿å¼æ­¥é®ä»¶éç¥ï¼è®¾å¤æ æ³è¢«å¨æ¥æ¶æå¡ç«¯çæ¶æ¯</strong>ãæ¯å¦ææ³è®©æå¡ç«¯ä¸»å¨ç»è®¾å¤æ¨éä¸å¼ å¾çãæ­æ¾ä¸æ®µè¯­é³ãæèåéä¸ä¸ªææ¬éç¥ï¼å¨ä¹åçæ¶æä¸æ¯åä¸å°çã</p>
<p>æä»¥æå°±å³å®æ¹é å°æºå®¢æ·ç«¯ï¼éæSignalRå®æ¶éä¿¡æ¡æ¶ãè¿æ¬¡æ¹é çæ ¸å¿ä»·å¼æ¯ï¼<strong>éè¿SignalRæ¶æ¯ééï¼è®©è®¾å¤å¯ä»¥æ¥æ¶åç§ç±»åçæ¶æ¯ï¼å£°é³ãå¾çãææ¬éç¥ï¼ï¼æå¡ç«¯çMCPå·¥å·æ§è¡æååï¼å¯ä»¥æ ¹æ®ç¨æ·IDæ¨éæ°æ®å°å¯¹åºçç¨æ·éé</strong>ã</p>
<p>æ´ä¸ªæ¹é æ¶åSignalR C++å®¢æ·ç«¯çéæãJWT Tokenè®¤è¯ãæ«ç ç»å½ï¼åºäºESP32æ¬å°MCPå·¥å·å®ç°ï¼ãä»¥åæå¡ç«¯æ¶æ¯æ¨éé»è¾ãå®¢æ·ç«¯ä»£ç é½æ¯C++å®ç°çï¼ä¸è¿ç°å¨AIè¾å©ç¼ç¨å¾å¼ºå¤§ï¼å¸®æèçäºå¤§éæ¶é´ã</p>
<p><img src="https://img2024.cnblogs.com/blog/1690009/202602/1690009-20260201121657114-327485878.png" alt="img" loading="lazy"></p>
<h2 id="é®é¢è§£ç­">é®é¢è§£ç­</h2>
<p><strong>Q: ä¸ºä»ä¹éæ©SignalRèä¸æ¯ç´æ¥ç¨WebSocketï¼</strong></p>
<p>A: èµ·åæç¡®å®èèè¿ç´æ¥ç¨WebSocketï¼ä½SignalRæä¾äºå¾å¤å¼ç®±å³ç¨çåè½ï¼</p>
<ul>
<li><strong>Hubæ½è±¡</strong>ï¼æå¡ç«¯å¯ä»¥è½»æ¾å®ç°ç¾¤ç»ç®¡çï¼æç¨æ·IDæ¨éæ¶æ¯ï¼æ¯å¦<code>Clients.Group($"Users:{userId}").SendAsync("Notification", message)</code></li>
<li><strong>æ¶æ¯è·¯ç±</strong>ï¼ä¸éè¦èªå·±åæ¶æ¯ååé»è¾ï¼SignalRçHubæ¹æ³è°ç¨åäºä»¶æ¨éå·²ç»å¾å®åäº</li>
<li><strong>ç±»ååè°ç¨</strong>ï¼ç¸æ¯åå§WebSocketçå­ç¬¦ä¸²æ¶æ¯ï¼SignalRæä¾äºç±»ä¼¼RPCçè°ç¨ä½éªï¼ä»£ç æ´æ¸æ°</li>
</ul>
<p>è½ç¶ESP32æ²¡æç°æçSignalRåºï¼ä½ææ¾å°äºå¾®è½¯å®æ¹çC++ SignalRå®¢æ·ç«¯ï¼åæåï¼ï¼å°å®ä¸ESP32çWebSocketç»ä»¶æ´ååï¼å°±è½ç¨ä¸SignalRçè¿äºç¹æ§äºãè³äºSignalRèªå¸¦çéè¿æºå¶ï¼ææ²¡ç¨ï¼å°æºæèªå·±çå¾ªç¯éè¿é»è¾ï¼æ´å¯æ§ä¸äºã</p>
<p><strong>Q: æ¹é çæ ¸å¿ä»·å¼æ¯ä»ä¹ï¼è§£å³äºä»ä¹é®é¢ï¼</strong></p>
<p>A: æ¹é åï¼ESP32çMCPå·¥å·è°ç¨å®æåï¼åªè½éè¿ä¸¤ç§æ¹å¼éç¥ï¼</p>
<ol>
<li><strong>åæ­¥è¿å</strong>ï¼å·¥å·æ§è¡ç»æç´æ¥è¿åç»è°ç¨æ¹</li>
<li><strong>å¼æ­¥é®ä»¶</strong>ï¼éè¿é®ä»¶åéæ§è¡ç»æ</li>
</ol>
<p>è¿ä¸¤ç§æ¹å¼é½æ æ³æ»¡è¶³å®æ¶æ¨éçéæ±ãæ¯å¦ææ³è®©æå¡ç«¯å¨çå¾å®æåç«å³æ¨éå¾çç»è®¾å¤æ¾ç¤ºï¼æèæ­æ¾ä¸æ®µè¯­é³æç¤ºï¼ä¹åçæ¶æåä¸å°ã</p>
<p>æ¹é åï¼éè¿SignalRå»ºç«äºä¸æ¡<strong>æå¡ç«¯å°è®¾å¤çå®æ¶æ¶æ¯éé</strong>ï¼</p>
<ul>
<li>æå¡ç«¯çMCPå·¥å·æ§è¡æååï¼å¯ä»¥è°ç¨<code>_hubContext.Clients.Group($"Users:{userId}").SendAsync("ShowImage", imageData)</code>å°å¾çæ¨éç»è®¾å¤</li>
<li>è®¾å¤éè¿SignalRçäºä»¶çå¬æ¥æ¶æ¶æ¯ï¼<code>connection-&gt;on("ShowImage", [](const std::vector&lt;signalr::value&gt;&amp; args) { ... })</code></li>
<li>æ¯ææ¨éä»»æç±»åçæ°æ®ï¼ææ¬ãå¾çï¼Base64ï¼ãè¯­é³URLãJSONéç¥ç­</li>
</ul>
<p>è¿ææ¯è¿æ¬¡æ¹é çæ ¸å¿ä»·å¼ï¼<strong>è®©è®¾å¤å·å¤è¢«å¨æ¥æ¶æå¡ç«¯æ¶æ¯çè½å</strong>ï¼èä¸ä»ä»æ¯ä¸»å¨è°ç¨ååæ­¥è¿åã</p>
<p><strong>Q: æ«ç ç»å½æ¯æä¹å®ç°çï¼</strong></p>
<p>A: æ«ç ç»å½åè½æ¯åºäºESP32æ¬å°MCPå·¥å·å®ç°çï¼è¿æ¯å°æºçåºæåè½ï¼æåªæ¯è¿è¡äºæå±ï¼</p>
<ol>
<li>è®¾å¤å¯å¨æ¶æ£æ¥æ¯å¦æJWT Token</li>
<li>å¦ææ²¡æTokenï¼è°ç¨æ¬å°MCPå·¥å·<code>display_qrcode</code>å¨å±å¹ä¸æ¾ç¤ºäºç»´ç </li>
<li>äºç»´ç åå®¹åå«è®¾å¤IDåæå¡ç«¯å°åï¼<code>https://mcp-server.com/device-login?deviceId=xxx</code></li>
<li>ç¨æ·ç¨ææºæ«ç ï¼å®æææã</li>
<li>è®¾å¤è·åTokenåä¿å­å°NVSï¼Non-Volatile Storageï¼ï¼ä¸æ¬¡å¯å¨ç´æ¥ä½¿ç¨</li>
</ol>
<p>è¿æ ·å°±å®ç°äºè®¾å¤çå¿«éè®¤è¯ï¼ç¨æ·ä½éªå¾å¥½ãæ«ç è®¤è¯çæå¡ç«¯æ¯ä½¿ç¨å¼æºçkeycloakåçï¼å¯¹æ¥äºè®¾å¤è®¤è¯ç±»åã</p>
<p><img src="https://img2024.cnblogs.com/blog/1690009/202602/1690009-20260201121907430-924035727.png" alt="img" loading="lazy"></p>
<h2 id="åè¯è§£é">åè¯è§£é</h2>
<h3 id="æ ¸å¿æ¦å¿µ">æ ¸å¿æ¦å¿µ</h3>
<ul>
<li>
<p><strong>SignalR</strong>ï¼å¾®è½¯æä¾çå®æ¶éä¿¡æ¡æ¶ï¼å°è£äºWebSocketãServerâSent Eventsåé¿è½®è¯¢ç­ä¼ è¾æ¹å¼ï¼æ¯æHubæ¨¡åãèªå¨éè¿ä¸æ¶æ¯åºååãéåå®ç°ååãä½å»¶è¿çå®æ¶æ¶æ¯ç³»ç»ãå°å®ç§»æ¤å°åµå¥å¼è®¾å¤æ¶éèèå®¢æ·ç«¯å®ç°çä½ç§¯ãåå­æ¶èä¸çº¿ç¨æ¨¡åã</p>
</li>
<li>
<p><strong>Hubï¼éçº¿å¨ï¼</strong>ï¼SignalRçæ ¸å¿æ½è±¡ï¼ç±»ä¼¼äºMVCä¸­çControllerãæå¡ç«¯éè¿Hubå®ä¹æ¹æ³ä¾å®¢æ·ç«¯è°ç¨ï¼å®¢æ·ç«¯ä¹å¯ä»¥æ³¨åäºä»¶çå¬æå¡ç«¯æ¨éãä¾å¦<code>ChatHub.SendMessage(user, message)</code>å°±æ¯ä¸ä¸ªå¸åçHubæ¹æ³ã</p>
</li>
<li>
<p><strong>MCPï¼Model Context Protocolï¼</strong>ï¼ä¸ç§åºäºJSON-RPC 2.0çåè®®ï¼ç¨äºå®ä¹å®¢æ·ç«¯åæå¡ç«¯ä¹é´çå·¥å·è°ç¨è§èãå¨IoTåºæ¯ä¸­ï¼è®¾å¤å¯ä»¥ä½ä¸ºMCP Serveræ´é²è½åï¼å¦éå¯ãæ¾ç¤ºå¾çï¼ï¼èäºç«¯æå¡ä½ä¸ºMCP Clientè°ç¨è¿äºè½åã</p>
</li>
<li>
<p><strong>JSON-RPC 2.0</strong>ï¼ä¸ç§è½»éçº§çè¿ç¨è¿ç¨è°ç¨åè®®ï¼ä½¿ç¨JSONç¼ç ãMCPåè®®åºäºæ­¤æ åï¼å®ä¹äº<code>initialize</code>ã<code>tools/list</code>ã<code>tools/call</code>ç­æ¹æ³ãæ¯ä¸ªè¯·æ±å¿é¡»åå«<code>jsonrpc: "2.0"</code>ã<code>method</code>ã<code>id</code>å­æ®µã</p>
</li>
</ul>
<h3 id="esp32ç¸å³">ESP32ç¸å³</h3>
<ul>
<li>
<p><strong>FreeRTOS</strong>ï¼ä¸ä¸ªå¼æºãè½»éçº§çå®æ¶æä½ç³»ç»åæ ¸ï¼å¸¸ç¨äºå¾®æ§å¶å¨å¹³å°ï¼å¦ESP32ï¼ãæä¾ä»»å¡è°åº¦ãä¼åçº§ãäºæ¥éãä¿¡å·éãéåãè½¯ä»¶å®æ¶å¨ç­å®æ¶ç¹æ§ï¼ä¾¿äºå¨èµæºåéè®¾å¤ä¸å®ç°å¹¶åä¸ç¡®å®æ§è¡ä¸ºãä½¿ç¨æ¶éæ³¨æå æ å¤§å°ãä¸­æ­å®å¨åä»»å¡ä¼åçº§è®¾è®¡ã</p>
</li>
<li>
<p><strong>ESP32 PSRAM</strong>ï¼ESP32å¯éçå¤é¨ä¼ªéæRAMï¼Pseudo-SRAMï¼ï¼ç¨äºæ©å±è®¾å¤å¯ç¨åå­ï¼å¸¸è§4MB/8MB/16MBï¼ãéåå­æ¾å¤§å¯¹è±¡ãå¾åç¼å­ãç½ç»ç¼å²åå¨æåéæ°æ®ãå¨ESP-IDFä¸­éå¯ç¨å¹¶æ­£ç¡®éç½®ï¼åéæ¶ä¹å¯ä½¿ç¨ä¸åçå åºåï¼å¦<code>heap_caps_malloc(size, MALLOC_CAP_SPIRAM)</code>ï¼æ¥æ§å¶æ¾ç½®ä¸æ§è½ï¼DMAéå¶ã</p>
</li>
<li>
<p><strong>WebSocket</strong>ï¼ä¸ç§åºäºTCPçå¨åå·¥éä¿¡åè®®ï¼éè¿HTTPæ¡æåçº§å»ºç«è¿æ¥ãSignalRé»è®¤ä¼åä½¿ç¨WebSocketä½ä¸ºä¼ è¾å±ï¼å¨ESP32ä¸éè¿<code>esp_websocket_client</code>ç»ä»¶å®ç°ãéè¦æ³¨æçæ¯ESP32çWebSocketå®¢æ·ç«¯ä¸æ¯æèªå¨éè¿ï¼éè¦å¨åºç¨å±å®ç°ã</p>
</li>
</ul>
<h3 id="è®¤è¯ç¸å³">è®¤è¯ç¸å³</h3>
<ul>
<li>
<p><strong>Bearer Token</strong>ï¼ä¸ç§HTTPè®¤è¯æ¹æ¡ï¼å°Tokenæ¾å¨Authorizationå¤´ä¸­ï¼<code>Authorization: Bearer &lt;token&gt;</code>ãå¨SignalRä¸­ï¼éå¸¸å°Tokenä½ä¸ºæ¥è¯¢åæ°ä¼ éï¼<code>/hub?access_token=YOUR_TOKEN</code></p>
</li>
<li>
<p><strong>JWTï¼JSON Web Tokenï¼</strong>ï¼ä¸ç§å¼æ¾æ åï¼RFC 7512ï¼ï¼ç¨äºå¨åæ¹ä¹é´å®å¨å°ä¼ è¾ä¿¡æ¯ãå¨Verdure MCPä¸­ï¼ä½¿ç¨Keycloakç­¾åçJWTè¿è¡ç¨æ·è®¤è¯ï¼Tokenä¸­åå«ç¨æ·IDãè§è²ãè¿ææ¶é´ç­Claimä¿¡æ¯ã</p>
</li>
<li>
<p><strong>API Token</strong>ï¼ä¸ç§ç®åçè®¤è¯æ¹å¼ï¼åç»­è¿æ¥æ¶æºå¸¦æ­¤Tokenéªè¯èº«ä»½ãVerdure MCPåæ¶æ¯æAPI TokenåJWTä¸¤ç§æ¹å¼ã</p>
</li>
</ul>
<p><img src="https://img2024.cnblogs.com/blog/1690009/202602/1690009-20260201152548041-1540521880.png" alt="img" loading="lazy"></p>
<h2 id="æ ¸å¿ææ¯æ¶æ">æ ¸å¿ææ¯æ¶æ</h2>
<p>æ´ä¸ªæ¹é çæ¶æå¯ä»¥ç¨ä¸å¼ å¾è¯´æï¼</p>
<pre><code>ââââââââââââââââââââââââ                          ââââââââââââââââââââââââ
â   .NET MCP Service   â                          â   ESP32 Device       â
â   (Verdure MCP)      âââââââSignalR Hubâââââââââºâ   (å°æºå®¢æ·ç«¯)       â
â                      â                          â                      â
â  ââââââââââââââââââ  â  â  JWT Tokenè®¤è¯         â  ââââââââââââââââââ  â
â  â  DeviceHub.cs  â  ââââââââââââââââââââââââââââ  â  æ«ç ç»å½      â  â
â  â                â  â                          â  â  (æ¬å°MCPå·¥å·) â  â
â  â OnConnected    â  â                          â  ââââââââââââââââââ  â
â  â (éªè¯Token)    â  â                          â          â           â
â  ââââââââââââââââââ  â  â¡ å»ºç«è¿æ¥               â  ââââââââââââââââââ  â
â          â           ââââââââââââââââââââââââââââ  â SignalR Client â  â
â  ââââââââââââââââââ  â                          â  â - connection   â  â
â  â  ç¾¤ç»ç®¡ç      â  â                          â  â - on() events  â  â
â  â Users:{userId} â  â                          â  ââââââââââââââââââ  â
â  ââââââââââââââââââ  â                          â                      â
â          â           â                          â                      â
â  ââââââââââââââââââ  â  â¢ MCPå·¥å·æ§è¡åæ¨é     â  ââââââââââââââââââ  â
â  â  æ¶æ¯æ¨é      â  âââââââââââââââââââââââââââºâ  â æ¶æ¯æ¥æ¶å¤ç   â  â
â  â SendAsync()    â  â  ShowImage(imageData)    â  â - æ¾ç¤ºå¾ç     â  â
â  â                â  â  PlayAudio(audioUrl)     â  â - æ­æ¾è¯­é³     â  â
â  â                â  â  Notification(text)      â  â - æ¾ç¤ºéç¥     â  â
â  ââââââââââââââââââ  â                          â  ââââââââââââââââââ  â
ââââââââââââââââââââââââ                          ââââââââââââââââââââââââ
</code></pre>
<p>å³é®æµç¨ï¼</p>
<ol>
<li><strong>æ«ç ç»å½</strong>ï¼è®¾å¤å¯å¨åï¼å¦ææ²¡æTokenï¼è°ç¨æ¬å°MCPå·¥å·æ¾ç¤ºäºç»´ç ï¼ç¨æ·æ«ç åè·åJWT Token</li>
<li><strong>å»ºç«è¿æ¥</strong>ï¼æºå¸¦JWT Tokenè¿æ¥SignalR Hubï¼æå¡ç«¯éªè¯åå å¥ç¨æ·ç¾¤ç»<code>Users:{userId}</code></li>
<li><strong>æ¶æ¯æ¨é</strong>ï¼æå¡ç«¯MCPå·¥å·æ§è¡å®æåï¼éè¿SignalRå°ç»ææ¨éç»è®¾å¤
<ul>
<li><code>_hubContext.Clients.Group($"Users:{userId}").SendAsync("ShowImage", imageData)</code></li>
<li>è®¾å¤çå¬äºä»¶å¹¶å¤çï¼<code>connection-&gt;on("ShowImage", handler)</code></li>
</ul>
</li>
</ol>
<p>è¿å¥æ¶æçæ ¸å¿ä»·å¼å°±æ¯<strong>è®©æå¡ç«¯å¯ä»¥ä¸»å¨æ¨éæ¶æ¯ç»è®¾å¤</strong>ï¼èä¸ä»ä»æ¯ç­å¾è®¾å¤è½®è¯¢æåæ­¥è¿åã</p>
<h2 id="å¼åç¯å¢åå¤">å¼åç¯å¢åå¤</h2>
<h3 id="esp32å¼åç¯å¢vs-codeæ¹å¼">ESP32å¼åç¯å¢ï¼VS Codeæ¹å¼ï¼</h3>
<p>æç®åçæ¹å¼æ¯ä½¿ç¨VS CodeçESP-IDFæä»¶ï¼</p>
<ol>
<li>
<p><strong>å®è£VS Codeåæä»¶</strong></p>
<ul>
<li>ä¸è½½å®è£ <a href="https://code.visualstudio.com/" target="_blank" rel="noopener nofollow">Visual Studio Code</a></li>
<li>å®è£æ©å±ï¼<code>Espressif IDF</code> (æç´¢ <code>esp-idf</code>)</li>
</ul>
</li>
<li>
<p><strong>éç½®ESP-IDF</strong></p>
<ul>
<li>æ<code>F1</code>æå¼å½ä»¤é¢æ¿ï¼è¾å¥ <code>ESP-IDF: Configure ESP-IDF Extension</code></li>
<li>éæ© <code>Express</code> å¿«ééç½®</li>
<li>éæ©ESP-IDFçæ¬ï¼æ¨èv5.1ææ´é«ï¼</li>
<li>ç­å¾å®è£å®æï¼ä¼èªå¨ä¸è½½å·¥å·é¾ãPythonç¯å¢ç­ï¼</li>
</ul>
</li>
<li>
<p><strong>åå»º/æå¼é¡¹ç®</strong></p>
<ul>
<li><code>F1</code> â <code>ESP-IDF: Show Examples Projects</code></li>
<li>æç´æ¥æå¼ esp-signalr-example é¡¹ç®æä»¶å¤¹</li>
</ul>
</li>
<li>
<p><strong>ç¼è¯åç§å½</strong></p>
<ul>
<li>ç¹å»åºé¨ç¶ææ ç <code>Build</code>ã<code>Flash</code>ã<code>Monitor</code> æé®</li>
<li>ææå¿«æ·é®ï¼<code>Ctrl+E B</code>ï¼ç¼è¯ï¼ã<code>Ctrl+E F</code>ï¼ç§å½ï¼</li>
</ul>
</li>
</ol>
<p>è¿ç§æ¹å¼æ¯å½ä»¤è¡ç®åå¾å¤ï¼éå.NETå¼åèå¿«éä¸æESP32å¼åã</p>
<p><img src="https://img2024.cnblogs.com/blog/1690009/202602/1690009-20260201122055040-2075015821.png" alt="img" loading="lazy"></p>
<h3 id="netå¼åç¯å¢">.NETå¼åç¯å¢</h3>
<p>æå¡ç«¯ä½¿ç¨.NET 10å¼åï¼</p>
<pre><code class="language-bash"># Windows: ä¸è½½å®è£å¨ https://dotnet.microsoft.com/download/dotnet/10.0

# éªè¯å®è£
dotnet --version  # åºè¯¥è¾åº 10.0.x

</code></pre>
<h2 id="æ ¸å¿ä»£ç å®ç°">æ ¸å¿ä»£ç å®ç°</h2>
<p>æ¬ç« èå°ä»£ç åä¸º<strong>ç¤ºä¾ä»£ç </strong>å<strong>å®éæ´åä»£ç </strong>ä¸¤ä¸ªé¨åè¿è¡è®²è§£ï¼</p>
<ul>
<li><strong>ç¤ºä¾ä»£ç </strong>ï¼ç¨äºçè§£æ ¸å¿æ¦å¿µçç®åçæ¬ï¼ä¾¿äºå­¦ä¹ åå¿«éä¸æ</li>
<li><strong>å®éæ´åä»£ç </strong>ï¼çäº§ç¯å¢ä¸­çå®æ´å®ç°ï¼åå«å®åçéè¯¯å¤çãç¶æç®¡çç­</li>
</ul>
<h3 id="å³äºç¤ºä¾ä»åº">å³äºç¤ºä¾ä»åº</h3>
<p>ä¸ºäºå¸®å©å¼åèå¿«éä¸æESP32çSignalRéæï¼æåå»ºäºä¸ä¸ªå®æ´çç¤ºä¾ä»åºï¼</p>
<p><strong>ð ä»åºå°å</strong>ï¼<a href="https://github.com/maker-community/esp-signalr-example" target="_blank" rel="noopener nofollow">https://github.com/maker-community/esp-signalr-example</a></p>
<p><strong>ð¦ ä»åºç»æ</strong>ï¼</p>
<pre><code>esp-signalr-example/
âââ main/                    # ESP32 C++å®¢æ·ç«¯ä»£ç 
â   âââ main.cpp            # ä¸»ç¨åºï¼WiFiè¿æ¥ãSignalRåå§åï¼
â   âââ CMakeLists.txt      # ESP-IDFæå»ºéç½®
âââ signalr-server/         # .NET C# æå¡ç«¯ä»£ç 
â   âââ Program.cs          # ASP.NET Coreæå¡å¨éç½®
â   âââ ChatHub.cs          # SignalR Hubå®ç°
â   âââ signalr-server.csproj
âââ docs/                   # ææ¡£
â   âââ QUICKSTART.md       # 5åéå¿«éå¼å§æå
â   âââ TEST_SERVER_SETUP.md # æµè¯æå¡å¨è¯¦ç»è®¾ç½®
â   âââ TROUBLESHOOTING.md  # å¸¸è§é®é¢ææ¥
âââ README.md               # é¡¹ç®è¯´æ
</code></pre>
<p><strong>â¨ ä¸»è¦ç¹æ§</strong>ï¼</p>
<ol>
<li>
<p><strong>å¼ç®±å³ç¨çæå¡å¨</strong>ï¼</p>
<ul>
<li>åºäºASP.NET CoreåSignalRæå»º</li>
<li>æ¯ææ¶æ¯å¹¿æ­</li>
<li>å®æ´çè¿æ¥ç®¡çåæ¥å¿è¾åº</li>
<li>æä¾RESTful APIç¨äºè®¾å¤æ§å¶</li>
</ul>
</li>
<li>
<p><strong>ç®åçESP32å®¢æ·ç«¯</strong>ï¼</p>
<ul>
<li>ä½¿ç¨Microsoftå®æ¹çC++ SignalRå®¢æ·ç«¯åºç§»æ¤ç</li>
<li>éè¿menuconfigéç½®WiFiåæå¡å¨å°å</li>
<li>æ¼ç¤ºæ¶æ¯åé/æ¥æ¶ãä¼ æå¨æ°æ®ä¸æ¥</li>
<li>æ¸æ°çæ¥å¿è¾åºåéè¯¯å¤ç</li>
</ul>
</li>
</ol>
<p><strong>ð å¿«éå¼å§ç¤ºä¾</strong>ï¼5åéè¿è¡ï¼ï¼</p>
<pre><code class="language-bash"># 1. åéä»åº
git clone https://github.com/maker-community/esp-signalr-example.git
cd esp-signalr-example

# 2. å¯å¨æå¡å¨ï¼éè¦.NET 9.0+ï¼
cd signalr-server
dotnet run --urls "http://+:5000" è¿ä¸ªè¿è¡å¯ä»¥ç¨ipè®¿é®
# æå¡å¨è¿è¡å¨: http://0.0.0.0:5000/chatHub

# 3. éç½®å¹¶ç§å½ESP32
cd ../
idf.py menuconfig
# éç½®WiFi SSIDãå¯ç åæå¡å¨å°å
idf.py build flash monitor
</code></pre>
<p>esp32çéç½®å¦ä¸ï¼</p>
<p><img src="https://img2024.cnblogs.com/blog/1690009/202602/1690009-20260201134357961-636085039.png" alt="img" loading="lazy"></p>
<p><strong>ð è¿è¡ææ</strong>ï¼</p>
<p>æå¡å¨è¾åºï¼<br>
<img src="https://img2024.cnblogs.com/blog/1690009/202602/1690009-20260201135020573-402562452.png" alt="img" loading="lazy"></p>
<pre><code>â Client connected: abc123
  IP Address: 192.168.1.100
  Total Connections: 1

[10:30:25] Received from ESP32-Device: Test message #1 from ESP32
[10:30:35] Sensor Update - Temperature: 25.50
</code></pre>
<p>ESP32ä¸²å£è¾åºï¼<br>
<img src="https://img2024.cnblogs.com/blog/1690009/202602/1690009-20260201134940520-565577362.png" alt="img" loading="lazy"></p>
<pre><code>I (3520) SIGNALR_EXAMPLE: âââ Connected to SignalR Hub! âââ
I (3525) SIGNALR_EXAMPLE: ð Notification: Welcome!
I (14640) S
</code></pre>
<p><strong>ð¯ ç¤ºä¾ä»åºçä»·å¼</strong>ï¼</p>
<ul>
<li><strong>å­¦ä¹ è·¯å¾æ¸æ°</strong>ï¼ä»ç®åçè¿æ¥å°å¤æçæ°æ®ä¼ è¾ï¼å¾ªåºæ¸è¿</li>
<li><strong>å¯ç´æ¥è¿è¡</strong>ï¼ä¸éè¦ä¾èµå¤é¨æå¡ï¼æ¬å°å³å¯æµè¯å®æ´æµç¨</li>
<li><strong>ä»£ç æ³¨éè¯¦ç»</strong>ï¼å³é®é¨åé½æä¸­è±ææ³¨éè¯´æ</li>
<li><strong>æäºæ©å±</strong>ï¼åºäºè¿ä¸ªç¤ºä¾å¯ä»¥å¿«éå¼åèªå·±çåºç¨</li>
</ul>
<p>æ¥ä¸æ¥ç 5.1 èå°åºäºè¿ä¸ªç¤ºä¾ä»åºçä»£ç è¿è¡è®²è§£ã</p>
<h3 id="51-ç¤ºä¾ä»£ç æå­¦ç®åç">5.1 ç¤ºä¾ä»£ç ï¼æå­¦ç®åçï¼</h3>
<blockquote>
<p><strong>è¯´æ</strong>ï¼ä»¥ä¸ä»£ç æ¥èªå¼æºç¤ºä¾ä»åº <a href="https://github.com/maker-community/esp-signalr-example" target="_blank" rel="noopener nofollow">esp-signalr-example</a>ï¼ç»è¿ç²¾ç®çªåºæ ¸å¿æ¦å¿µï¼æ¹ä¾¿çè§£SignalRä¸ESP32éæçåºæ¬åçãå®æ´ä»£ç è¯·åèä»åºæºç ã</p>
</blockquote>
<h4 id="511-æå¡ç«¯signalr-hubåºç¡å®ç°">5.1.1 æå¡ç«¯ï¼SignalR Hubåºç¡å®ç°</h4>
<p>è¿æ¯æå¡ç«¯çæ ¸å¿ä»£ç ï¼å®ç°äºè¿æ¥ç®¡çãæ¶æ¯å¹¿æ­åè®¾å¤ç¶æè·è¸ªï¼</p>
<p><strong>ChatHub.cs - Hubæ ¸å¿å®ç°</strong>ï¼</p>
<pre><code class="language-csharp">using Microsoft.AspNetCore.SignalR;

public class ChatHub : Hub
{
    private readonly ILogger&lt;ChatHub&gt; _logger;
    private static int _connectionCount = 0;
    
    // å­å¨è¿æ¥çè®¾å¤ä¿¡æ¯
    private static readonly Dictionary&lt;string, DeviceInfo&gt; _connectedDevices = new();
    private static readonly object _devicesLock = new();

    public ChatHub(ILogger&lt;ChatHub&gt; logger)
    {
        _logger = logger;
    }

    /// &lt;summary&gt;
    /// å¤çæ¥èªESP32çæ¶æ¯
    /// &lt;/summary&gt;
    public async Task SendMessage(string user, string message)
    {
        _logger.LogInformation("[{Time}] Received from {User}: {Message}", 
            DateTime.Now.ToString("HH:mm:ss"), user, message);
        
        // å¹¿æ­å°ææè¿æ¥çå®¢æ·ç«¯
        await Clients.All.SendAsync("ReceiveMessage", user, message);
    }

    /// &lt;summary&gt;
    /// å¤çä¼ æå¨æ°æ®æ´æ°
    /// &lt;/summary&gt;
    public async Task UpdateSensor(string sensorId, double value)
    {
        _logger.LogInformation("[{Time}] Sensor Update - {SensorId}: {Value:F2}", 
            DateTime.Now.ToString("HH:mm:ss"), sensorId, value);
        
        // å¹¿æ­ä¼ æå¨æ°æ®å°ææå®¢æ·ç«¯
        await Clients.All.SendAsync("UpdateSensorData", sensorId, value);
    }

    /// &lt;summary&gt;
    /// å¤çESP32ç¶ææ´æ°
    /// &lt;/summary&gt;
    public async Task UpdateDeviceStatus(string deviceId, string status, int freeHeap)
    {
        _logger.LogInformation("[{Time}] Device Status - {DeviceId}: {Status}, Free Heap: {FreeHeap} bytes", 
            DateTime.Now.ToString("HH:mm:ss"), deviceId, status, freeHeap);
        
        await Clients.All.SendAsync("DeviceStatusUpdate", deviceId, status, freeHeap);
    }

    /// &lt;summary&gt;
    /// å®¢æ·ç«¯è¿æ¥æ¶è§¦å
    /// &lt;/summary&gt;
    public override async Task OnConnectedAsync()
    {
        Interlocked.Increment(ref _connectionCount);
        
        var connectionId = Context.ConnectionId;
        var httpContext = Context.GetHttpContext();
        var ipAddress = httpContext?.Connection.RemoteIpAddress?.ToString();
        var userAgent = httpContext?.Request.Headers["User-Agent"].ToString();
        
        // ä¿å­è®¾å¤ä¿¡æ¯
        lock (_devicesLock)
        {
            _connectedDevices[connectionId] = new DeviceInfo
            {
                ConnectionId = connectionId,
                IpAddress = ipAddress,
                UserAgent = userAgent,
                ConnectedAt = DateTime.UtcNow
            };
        }
        
        _logger.LogInformation("â Client connected: {ConnectionId}", connectionId);
        _logger.LogInformation("  IP Address: {IpAddress}", ipAddress);
        _logger.LogInformation("  Total Connections: {Count}", _connectionCount);
        
        await base.OnConnectedAsync();
        
        // åéæ¬¢è¿æ¶æ¯ï¼ESP32éè¿æ­¤æ¶æ¯ç¡®è®¤è¿æ¥æåï¼
        await Clients.Caller.SendAsync("Notification", 
            "Welcome to SignalR Test Server!");
    }

    /// &lt;summary&gt;
    /// å®¢æ·ç«¯æ­å¼æ¶è§¦å
    /// &lt;/summary&gt;
    public override async Task OnDisconnectedAsync(Exception? exception)
    {
        Interlocked.Decrement(ref _connectionCount);
        
        var connectionId = Context.ConnectionId;
        
        // ç§»é¤è®¾å¤ä¿¡æ¯
        lock (_devicesLock)
        {
            _connectedDevices.Remove(connectionId);
        }
        
        _logger.LogInformation("â Client disconnected: {ConnectionId}", connectionId);
        if (exception != null)
        {
            _logger.LogWarning("  Disconnection reason: {Message}", exception.Message);
        }
        _logger.LogInformation("  Remaining Connections: {Count}", _connectionCount);
        
        await base.OnDisconnectedAsync(exception);
    }
}

/// &lt;summary&gt;
/// è®¾å¤è¿æ¥ä¿¡æ¯
/// &lt;/summary&gt;
public class DeviceInfo
{
    public string ConnectionId { get; set; } = "";
    public string? IpAddress { get; set; }
    public string? UserAgent { get; set; }
    public DateTime ConnectedAt { get; set; }
}
</code></pre>
<p><strong>Program.cs - SignalRæå¡éç½®</strong>ï¼</p>
<pre><code class="language-csharp">var builder = WebApplication.CreateBuilder(args);

// æ·»å SignalRæå¡
builder.Services.AddSignalR(options =&gt;
{
    options.EnableDetailedErrors = true;  // å¼åç¯å¢å¯ç¨
    options.ClientTimeoutInterval = TimeSpan.FromSeconds(30);  // å®¢æ·ç«¯è¶æ¶
    options.KeepAliveInterval = TimeSpan.FromSeconds(15);  // å¿è·³é´é
});

// æ·»å CORSæ¯æï¼åè®¸ESP32è·¨åè¿æ¥ï¼
builder.Services.AddCors(options =&gt;
{
    options.AddDefaultPolicy(policy =&gt;
    {
        policy.AllowAnyOrigin()
              .AllowAnyHeader()
              .AllowAnyMethod();
    });
});

var app = builder.Build();

app.UseCors();
app.MapHub&lt;ChatHub&gt;("/chatHub");

// çå¬ææç½ç»æ¥å£ï¼éè¦ï¼å±åç½åESP32è½è®¿é®ï¼
app.Urls.Add("http://0.0.0.0:5000");

Console.WriteLine("SignalR Server: http://0.0.0.0:5000/chatHub");
app.Run();
</code></pre>
<p><strong>å³é®ç¹è¯´æ</strong>ï¼</p>
<ol>
<li><strong>è¿æ¥ç¡®è®¤æºå¶</strong>ï¼æå¡å¨å¨ <code>OnConnectedAsync</code> ä¸­åé <code>Notification</code> æ¶æ¯ï¼ESP32æ¶å°æ­¤æ¶æ¯æè®¤ä¸ºè¿æ¥æå</li>
<li><strong>æ¶æ¯å¹¿æ­</strong>ï¼ä½¿ç¨ <code>Clients.All.SendAsync()</code> åææè¿æ¥çå®¢æ·ç«¯å¹¿æ­æ¶æ¯</li>
<li><strong>è¿æ¥è·è¸ª</strong>ï¼ä½¿ç¨éæå­å¸ <code>_connectedDevices</code> è·è¸ªææè¿æ¥çè®¾å¤ä¿¡æ¯</li>
</ol>
<h4 id="512-æå¡ç«¯è®¾å¤æ§å¶apiéè¿signalræ¨éæ¶æ¯">5.1.2 æå¡ç«¯ï¼è®¾å¤æ§å¶APIï¼éè¿SignalRæ¨éæ¶æ¯ï¼</h4>
<p>ç¤ºä¾ä»åºæä¾äºå®æ´çè®¾å¤æ§å¶APIï¼æ¼ç¤ºå¦ä½éè¿SignalRåESP32æ¨éåç§ç±»åçæ¶æ¯ï¼</p>
<p><strong>Program.cs - è®¾å¤æ§å¶APIç«¯ç¹</strong>ï¼</p>
<pre><code class="language-csharp">// ============================================================================
// è®¾å¤æ§å¶ API - ç¨äºåè®¾å¤åé CustomMessage
// ============================================================================

// è·åææè¿æ¥çè®¾å¤
app.MapGet("/api/device/connections", () =&gt;
{
    return Results.Ok(ChatHub.ConnectedDevices);
})
.WithName("GetConnections")
.WithDescription("è·åææè¿æ¥çè®¾å¤åè¡¨");

// åééç¥
app.MapPost("/api/device/notification", async (
    NotificationRequest request, 
    IHubContext&lt;ChatHub&gt; hubContext, 
    ILogger&lt;Program&gt; logger) =&gt;
{
    var message = new
    {
        action = "notification",
        title = request.Title ?? "éç¥",
        content = request.Content ?? "",
        emotion = request.Emotion ?? "bell",
        sound = request.Sound ?? "popup"
    };

    await SendCustomMessage(hubContext, logger, request.ConnectionId, message);
    return Results.Ok(new { success = true, message = "Notification sent" });
})
.WithDescription("åééç¥å°è®¾å¤ (sound: popup/success/vibration/exclamation/low_battery/none)");

// åéå¾ç
app.MapPost("/api/device/image", async (
    ImageRequest request, 
    IHubContext&lt;ChatHub&gt; hubContext, 
    ILogger&lt;Program&gt; logger) =&gt;
{
    var message = new
    {
        action = "image",
        url = request.Url
    };

    await SendCustomMessage(hubContext, logger, request.ConnectionId, message);
    return Results.Ok(new { success = true, message = "Image sent" });
})
.WithDescription("åéå¾çURLå°è®¾å¤æ¾ç¤º (æ¯æJPG/PNG, æå¤§1MB)");

// åéé³é¢
app.MapPost("/api/device/audio", async (
    AudioRequest request, 
    IHubContext&lt;ChatHub&gt; hubContext, 
    ILogger&lt;Program&gt; logger) =&gt;
{
    var message = new
    {
        action = "audio",
        url = request.Url
    };

    await SendCustomMessage(hubContext, logger, request.ConnectionId, message);
    return Results.Ok(new { success = true, message = "Audio sent" });
})
.WithDescription("åéé³é¢URLå°è®¾å¤æ­æ¾ (OGGæ ¼å¼, æå¤§512KB)");

// åéå½ä»¤
app.MapPost("/api/device/command", async (
    CommandRequest request, 
    IHubContext&lt;ChatHub&gt; hubContext, 
    ILogger&lt;Program&gt; logger) =&gt;
{
    var message = new
    {
        action = "command",
        command = request.Command
    };

    await SendCustomMessage(hubContext, logger, request.ConnectionId, message);
    return Results.Ok(new { success = true, message = "Command sent" });
})
.WithDescription("åéå½ä»¤å°è®¾å¤ (command: reboot/wake/listen/stop)");

// æ¾ç¤ºäºç»´ç 
app.MapPost("/api/device/qrcode", async (
    QRCodeRequest request, 
    IHubContext&lt;ChatHub&gt; hubContext, 
    ILogger&lt;Program&gt; logger) =&gt;
{
    var message = new
    {
        action = "qrcode",
        content = request.Content,
        title = request.Title ?? "æ«ç "
    };

    await SendCustomMessage(hubContext, logger, request.ConnectionId, message);
    return Results.Ok(new { success = true, message = "QRCode sent" });
})
.WithDescription("æ¾ç¤ºäºç»´ç å°è®¾å¤å±å¹");

// è¾å©æ¹æ³ï¼åé CustomMessage
async Task SendCustomMessage(
    IHubContext&lt;ChatHub&gt; hubContext, 
    ILogger&lt;Program&gt; logger, 
    string? connectionId, 
    object message)
{
    var json = JsonSerializer.Serialize(message);
    logger.LogInformation("ð¤ Sending CustomMessage to {Target}: {Message}", 
        string.IsNullOrEmpty(connectionId) ? "ALL" : connectionId, json);

    if (string.IsNullOrEmpty(connectionId))
    {
        // åéç»ææè¿æ¥çè®¾å¤
        await hubContext.Clients.All.SendAsync("CustomMessage", json);
    }
    else
    {
        // åéç»æå®è¿æ¥
        await hubContext.Clients.Client(connectionId).SendAsync("CustomMessage", json);
    }
}

// ============================================================================
// è¯·æ±æ¨¡å
// ============================================================================

record NotificationRequest
{
    public string? ConnectionId { get; init; }
    public string? Title { get; init; }
    public string Content { get; init; } = "";
    public string? Emotion { get; init; }
    public string? Sound { get; init; }
}

record ImageRequest
{
    public string? ConnectionId { get; init; }
    public string Url { get; init; } = "";
}

record AudioRequest
{
    public string? ConnectionId { get; init; }
    public string Url { get; init; } = "";
}

record CommandRequest
{
    public string? ConnectionId { get; init; }
    public string Command { get; init; } = "";
}

record QRCodeRequest
{
    public string? ConnectionId { get; init; }
    public string Content { get; init; } = "";
    public string? Title { get; init; }
}
</code></pre>
<p><strong>å³é®ç¹è¯´æ</strong>ï¼</p>
<ol>
<li><strong>IHubContextæ³¨å¥</strong>ï¼ä½¿ç¨ <code>IHubContext&lt;ChatHub&gt;</code> å¨éHubç±»ä¸­åéSignalRæ¶æ¯</li>
<li><strong>æ¶æ¯æ ¼å¼</strong>ï¼ä½¿ç¨JSONæ ¼å¼ç <code>CustomMessage</code> äºä»¶ï¼åå« <code>action</code> å­æ®µæ è¯æ¶æ¯ç±»å</li>
<li><strong>å®åæ¨é</strong>ï¼
<ul>
<li><code>Clients.All.SendAsync()</code> - å¹¿æ­ç»ææè¿æ¥çè®¾å¤</li>
<li><code>Clients.Client(connectionId).SendAsync()</code> - åéç»æå®è®¾å¤</li>
<li><code>Clients.Group(groupName).SendAsync()</code> - åéç»ç¾¤ç»ï¼å¦ <code>Users:{userId}</code>ï¼</li>
</ul>
</li>
<li><strong>RESTful APIè®¾è®¡</strong>ï¼æä¾HTTPç«¯ç¹æ§å¶è®¾å¤ï¼ä¾¿äºå¶ä»æå¡è°ç¨</li>
</ol>
<p>æå¡ç«¯çæ¥å£å¾çå¦ä¸å¯ä»¥ç´æ¥æä½æµè¯ï¼</p>
<p><img src="https://img2024.cnblogs.com/blog/1690009/202602/1690009-20260201134534230-1496642342.png" alt="img" loading="lazy"></p>
<h4 id="513-å®¢æ·ç«¯esp32è¿æ¥signalrå¹¶æ¥æ¶æ¶æ¯">5.1.3 å®¢æ·ç«¯ï¼ESP32ï¼ï¼è¿æ¥SignalRå¹¶æ¥æ¶æ¶æ¯</h4>
<p>è¿æ¯ESP32ç«¯çæ ¸å¿ä»£ç ï¼æ¼ç¤ºå¦ä½è¿æ¥SignalR Hubå¹¶æ¥æ¶åç§ç±»åçæ¶æ¯ï¼</p>
<p><strong>main.cpp - SignalRè¿æ¥ä¸æ¶æ¯å¤ç</strong>ï¼</p>
<pre><code class="language-cpp">#include &lt;stdio.h&gt;
#include &lt;memory&gt;
#include "freertos/FreeRTOS.h"
#include "freertos/task.h"
#include "esp_system.h"
#include "esp_log.h"
#include "nvs_flash.h"

#include "hub_connection_builder.h"
#include "esp32_websocket_client.h"
#include "esp32_http_client.h"

// =============================================================================
// éç½®é¡¹ï¼éè¿menuconfigè®¾ç½®ï¼
// =============================================================================

#define WIFI_SSID      CONFIG_EXAMPLE_WIFI_SSID
#define WIFI_PASSWORD  CONFIG_EXAMPLE_WIFI_PASSWORD
#define SIGNALR_HUB_URL CONFIG_EXAMPLE_SIGNALR_HUB_URL

static const char* TAG = "SIGNALR_EXAMPLE";

// SignalRè¿æ¥å¯¹è±¡
static std::unique_ptr&lt;signalr::hub_connection&gt; g_connection;
static bool g_is_connected = false;

// =============================================================================
// æ¶æ¯å¤çå¨
// =============================================================================

/**
 * å¤çæå¡å¨åéçæ¶æ¯
 */
static void on_receive_message(const std::vector&lt;signalr::value&gt;&amp; args)
{
    ESP_LOGI(TAG, "==============================================");
    ESP_LOGI(TAG, "ð© Message received from server:");
    
    if (args.size() &gt;= 2) {
        std::string user = args[0].as_string();
        std::string message = args[1].as_string();
        
        ESP_LOGI(TAG, "   From: %s", user.c_str());
        ESP_LOGI(TAG, "   Text: %s", message.c_str());
    } else if (args.size() == 1) {
        ESP_LOGI(TAG, "   Message: %s", args[0].as_string().c_str());
    }
    
    ESP_LOGI(TAG, "==============================================");
}

/**
 * å¤çéç¥æ¶æ¯ï¼è¿æ¥ç¡®è®¤ï¼
 */
static void on_notification(const std::vector&lt;signalr::value&gt;&amp; args)
{
    if (args.empty()) return;
    
    std::string notification = args[0].as_string();
    ESP_LOGI(TAG, "ð Notification: %s", notification.c_str());
    
    // éè¿Notificationæ¶æ¯ç¡®è®¤è¿æ¥æå
    if (!g_is_connected) {
        g_is_connected = true;
        ESP_LOGI(TAG, "==============================================");
        ESP_LOGI(TAG, "âââ Connected to SignalR Hub! âââ");
        ESP_LOGI(TAG, "==============================================");
    }
}

/**
 * å¤çä¼ æå¨æ°æ®æ´æ°
 */
static void on_sensor_update(const std::vector&lt;signalr::value&gt;&amp; args)
{
    if (args.size() &lt; 2) return;
    
    std::string sensor_id = args[0].as_string();
    double value = args[1].as_double();
    
    ESP_LOGI(TAG, "ð Sensor Update: %s = %.2f", sensor_id.c_str(), value);
}

/**
 * å¤çè®¾å¤ç¶ææ´æ°
 */
static void on_device_status(const std::vector&lt;signalr::value&gt;&amp; args)
{
    if (args.size() &lt; 3) return;
    
    std::string device_id = args[0].as_string();
    std::string status = args[1].as_string();
    int free_heap = static_cast&lt;int&gt;(args[2].as_double());
    
    ESP_LOGI(TAG, "ð± Device Status: %s - %s (Free Heap: %d bytes)", 
             device_id.c_str(), status.c_str(), free_heap);
}

// =============================================================================
// SignalRè¿æ¥ç®¡ç
// =============================================================================

/**
 * åå§åSignalRè¿æ¥
 */
static void init_signalr(void)
{
    ESP_LOGI(TAG, "Initializing SignalR connection to: %s", SIGNALR_HUB_URL);

    try {
        // åå»ºhub_connectionï¼ä½¿ç¨make_uniqueï¼
        g_connection = std::make_unique&lt;signalr::hub_connection&gt;(
            signalr::hub_connection_builder::create(SIGNALR_HUB_URL)
                .with_websocket_factory([](const signalr::signalr_client_config&amp; config) {
                    return std::make_shared&lt;signalr::esp32_websocket_client&gt;(config);
                })
                .with_http_client_factory([](const signalr::signalr_client_config&amp; config) {
                    return std::make_shared&lt;signalr::esp32_http_client&gt;(config);
                })
                .with_automatic_reconnect()  // å¯ç¨èªå¨éè¿
                .skip_negotiation(true)      // è·³è¿ååï¼ç´æ¥WebSocket
                .build());

        ESP_LOGI(TAG, "â SignalR connection object created");
        
    } catch (const std::exception&amp; e) {
        ESP_LOGE(TAG, "Failed to create SignalR connection: %s", e.what());
    }
}

/**
 * æ³¨åæ¶æ¯å¤çå¨
 */
static void setup_message_handlers(void)
{
    if (!g_connection) {
        ESP_LOGE(TAG, "Connection not initialized");
        return;
    }

    // æ³¨å "ReceiveMessage" äºä»¶
    g_connection-&gt;on("ReceiveMessage", on_receive_message);
    ESP_LOGI(TAG, "â Registered handler: ReceiveMessage");

    // æ³¨å "Notification" äºä»¶ï¼ç¨äºè¿æ¥ç¡®è®¤ï¼
    g_connection-&gt;on("Notification", on_notification);
    ESP_LOGI(TAG, "â Registered handler: Notification");

    // æ³¨å "UpdateSensorData" äºä»¶
    g_connection-&gt;on("UpdateSensorData", on_sensor_update);
    ESP_LOGI(TAG, "â Registered handler: UpdateSensorData");

    // æ³¨å "DeviceStatusUpdate" äºä»¶
    g_connection-&gt;on("DeviceStatusUpdate", on_device_status);
    ESP_LOGI(TAG, "â Registered handler: DeviceStatusUpdate");
}

/**
 * å¯å¨SignalRè¿æ¥
 */
static void start_signalr_connection(void)
{
    if (!g_connection) {
        ESP_LOGE(TAG, "Connection not initialized");
        return;
    }
    
    ESP_LOGI(TAG, "Starting SignalR connection...");

    try {
        // å¯å¨è¿æ¥ï¼å¼æ­¥ï¼
        g_connection-&gt;start([](std::exception_ptr exception) {
            if (exception) {
                ESP_LOGE(TAG, "Connection failed in callback");
            } else {
                ESP_LOGI(TAG, "Connection started successfully");
            }
        });
        
        ESP_LOGI(TAG, "Waiting for Notification message to confirm connection...");

    } catch (const std::exception&amp; e) {
        ESP_LOGE(TAG, "Exception starting connection: %s", e.what());
    }
}

// =============================================================================
// æµè¯ä»»å¡ï¼å®æåéæ¶æ¯
// =============================================================================

static void signalr_test_task(void* param)
{
    int message_count = 1;
    
    while (true) {
        // ç­å¾10ç§
        vTaskDelay(pdMS_TO_TICKS(10000));
        
        // æ£æ¥è¿æ¥ç¶æ
        if (!g_connection || !g_is_connected) {
            ESP_LOGW(TAG, "Not connected, skipping message send");
            continue;
        }
        
        // åéæ¶æ¯å°æå¡å¨
        std::string message = "Test message #" + std::to_string(message_count++) + " from ESP32";
        
        ESP_LOGI(TAG, "ð¤ Sending message...");
        ESP_LOGI(TAG, "   User: ESP32-Device");
        ESP_LOGI(TAG, "   Message: %s", message.c_str());
        
        try {
            std::vector&lt;signalr::value&gt; args;
            args.push_back(signalr::value("ESP32-Device"));
            args.push_back(signalr::value(message));
            
            // è°ç¨æå¡å¨ç SendMessage æ¹æ³
            g_connection-&gt;invoke("SendMessage", args, 
                [](const signalr::value&amp; result, std::exception_ptr exception) {
                    if (exception) {
                        ESP_LOGE(TAG, "â Failed to send message");
                    } else {
                        ESP_LOGI(TAG, "â Message sent successfully!");
                    }
                });
                
        } catch (const std::exception&amp; e) {
            ESP_LOGE(TAG, "Exception sending message: %s", e.what());
        }
    }
}

// =============================================================================
// ä¸»ç¨åº
// =============================================================================

extern "C" void app_main(void)
{
    ESP_LOGI(TAG, "========================================");
    ESP_LOGI(TAG, " ESP32 SignalR Client Test Example");
    ESP_LOGI(TAG, "========================================");
    
    // 1. åå§åWiFiï¼çç¥WiFiè¿æ¥ä»£ç ï¼åèå®æ´ç¤ºä¾ï¼
    // wifi_init_sta();
    
    // 2. åå§åSignalRè¿æ¥å¯¹è±¡
    ESP_LOGI(TAG, "Step 1: Initializing SignalR...");
    init_signalr();
    
    // 3. æ³¨åæ¶æ¯å¤çå¨
    ESP_LOGI(TAG, "Step 2: Setting up message handlers...");
    setup_message_handlers();
    
    // 4. å¯å¨è¿æ¥
    ESP_LOGI(TAG, "Step 3: Starting connection...");
    start_signalr_connection();
    
    // 5. åå»ºæµè¯ä»»å¡ï¼å®æåéæ¶æ¯ï¼
    ESP_LOGI(TAG, "Step 4: Creating test task...");
    xTaskCreate(signalr_test_task, "signalr_test", 8192, NULL, 5, NULL);
    
    ESP_LOGI(TAG, "Setup complete. Check logs for connection status.");
}
</code></pre>
<p><strong>å³é®ç¹è¯´æ</strong>ï¼</p>
<ol>
<li><strong>è¿æ¥åå»º</strong>ï¼ä½¿ç¨ <code>hub_connection_builder</code> æå»ºè¿æ¥ï¼éç½®WebSocketå®¢æ·ç«¯å·¥å</li>
<li><strong>è·³è¿åå</strong>ï¼<code>skip_negotiation(true)</code> ç´æ¥ä½¿ç¨WebSocketï¼æé«è¿æ¥éåº¦</li>
<li><strong>æ¶æ¯å¤çå¨æ³¨å</strong>ï¼ä½¿ç¨ <code>connection-&gt;on("EventName", handler)</code> æ³¨åäºä»¶çå¬å¨</li>
<li><strong>è¿æ¥ç¡®è®¤</strong>ï¼éè¿æ¥æ¶ <code>Notification</code> æ¶æ¯å¤æ­è¿æ¥æåï¼æå¡å¨å¨ <code>OnConnectedAsync</code> ä¸­åéï¼</li>
<li><strong>è°ç¨æå¡å¨æ¹æ³</strong>ï¼ä½¿ç¨ <code>invoke()</code> è°ç¨Hubæ¹æ³ï¼å¦ <code>SendMessage</code></li>
</ol>
<p><strong>å®æ´è¿è¡æµç¨</strong>ï¼</p>
<pre><code>1. WiFiè¿æ¥æå
   â
2. åå»ºSignalRè¿æ¥å¯¹è±¡
   â
3. æ³¨åæ¶æ¯å¤çå¨ï¼ReceiveMessageãNotificationç­ï¼
   â
4. è°ç¨ connection-&gt;start() å¯å¨è¿æ¥
   â
5. ç­å¾æå¡å¨åé Notification æ¶æ¯
   â
6. æ¶å° Notificationï¼æ è®°è¿æ¥æå
   â
7. å®æè°ç¨ invoke("SendMessage") åéæ¶æ¯
   â
8. æ¥æ¶æå¡å¨å¹¿æ­çæ¶æ¯ï¼è§¦åå¯¹åºå¤çå¨
</code></pre>
<p><strong>ç¤ºä¾è¾åº</strong>ï¼</p>
<pre><code>I (3480) SIGNALR_EXAMPLE: â Registered handler: ReceiveMessage
I (3485) SIGNALR_EXAMPLE: â Registered handler: Notification
I (3490) SIGNALR_EXAMPLE: Starting SignalR connection...
I (4520) SIGNALR_EXAMPLE: ==============================================
I (4520) SIGNALR_EXAMPLE: âââ Connected to SignalR Hub! âââ
I (4525) SIGNALR_EXAMPLE: ==============================================
I (4530) SIGNALR_EXAMPLE: ð Notification: Welcome to SignalR!
I (14530) SIGNALR_EXAMPLE: ð¤ Sending message...
I (14640) SIGNALR_EXAMPLE: â Message sent successfully!
I (14650) SIGNALR_EXAMPLE: ð© Message received from server:
I (14655) SIGNALR_EXAMPLE:    From: ESP32-Device
I (14660) SIGNALR_EXAMPLE:    Text: Test message #1 from ESP32
</code></pre>
<h3 id="52-å®éæ´åä»£ç çäº§ç¯å¢å®æ´å®ç°">5.2 å®éæ´åä»£ç ï¼çäº§ç¯å¢å®æ´å®ç°ï¼</h3>
<blockquote>
<p><strong>è¯´æ</strong>ï¼ä»¥ä¸ä»£ç æ¥èªå°æºAIé¡¹ç®çå®éçäº§ä»£ç ï¼åå«äºå®æ´çéè¯¯å¤çãç¶æç®¡çãJWTè®¤è¯åèªå¨éè¿æºå¶ã</p>
</blockquote>
<p>å®éé¡¹ç®ä»£ç åä¸ºä¸ä¸ªä¸»è¦ä»åºï¼</p>
<h4 id="521-å°æºesp32è®¾å¤ä»£ç ">5.2.1 å°æºESP32è®¾å¤ä»£ç </h4>
<p><strong>ä»åºå°å</strong>ï¼</p>
<ul>
<li>ä¸»ä»åºï¼<a href="https://github.com/maker-community/xiaozhi-esp32" target="_blank" rel="noopener nofollow">https://github.com/maker-community/xiaozhi-esp32</a></li>
<li>SignalRéæåæ¯ï¼<code>signalr</code> å <code>signalr-update-audio</code></li>
<li>å®æ´ç¤ºä¾å·¥ç¨ï¼<a href="https://github.com/maker-community/esp-signalr-example" target="_blank" rel="noopener nofollow">esp-signalr-example</a></li>
</ul>
<blockquote>
<p><strong>æ³¨æ</strong>ï¼SignalRåè½ä¸»è¦å¨ <code>signalr</code> å <code>signalr-update-audio</code> ä¸¤ä¸ªåæ¯ä¸­å®ç°ï¼è¿ä¸¤ä¸ªåæ¯é½æ¯SignalRéæç¸å³çå¼ååæ¯ã</p>
</blockquote>
<p><strong>æ ¸å¿æä»¶</strong>ï¼</p>
<ul>
<li><code>main/signalr_client.cc</code> / <code>main/signalr_client.h</code> - <strong>SignalRå®¢æ·ç«¯æ ¸å¿å®ç°</strong></li>
<li><code>main/application.cc</code> / <code>main/application.h</code> - ä¸»åºç¨ç¨åºé»è¾åç¶æç®¡ç</li>
<li><code>main/protocols/websocket_protocol.cc</code> - WebSocketåè®®å®ç°</li>
<li><code>main/protocols/mqtt_protocol.cc</code> - MQTTåè®®å®ç°</li>
<li><code>main/mcp_server.cc</code> - MCPæå¡å¨å®ç°</li>
</ul>
<p><strong>å®éå®ç°ç¹ç¹</strong>ï¼</p>
<p>ä¸ç¤ºä¾ä»£ç ç¸æ¯,çäº§ç¯å¢å®ç°å¢å äºï¼</p>
<ol>
<li>
<p><strong>å®æ´ççå½å¨æç®¡ç</strong></p>
<ul>
<li>è¿æ¥å»ºç«ãæ­å¼éè¿ãèµæºæ¸ç</li>
<li>è®¾å¤ç¶ææºç®¡çï¼ç©ºé²ãè¿æ¥ä¸­ãçå¬ãè¯´è¯ç­ï¼</li>
</ul>
</li>
<li>
<p><strong>åè®®çæ¬æ¯æ</strong></p>
<ul>
<li>æ¯æWebSocketåMQTTä¸¤ç§ä¼ è¾åè®®</li>
<li>åè®®å±æ½è±¡,æäºæ©å±æ°åè®®</li>
</ul>
</li>
<li>
<p><strong>é³é¢æµå¤ç</strong></p>
<ul>
<li>å®æ¶é³é¢æ°æ®çç¼ç ãä¼ è¾åæ¥æ¶</li>
<li><strong>é³é¢ååä¼ è¾</strong>ï¼éè¦ï¼ï¼- è§£å³å¤§æ°æ®ä¼ è¾å¯¼è´è¿æ¥æ­å¼çé®é¢</li>
<li>æ¯æOpusç¼è§£ç </li>
</ul>
</li>
<li>
<p><strong>MCPå·¥å·éæ</strong></p>
<ul>
<li>å®æ´çMCP Serverå®ç°</li>
<li>å·¥å·æ³¨åãè°ç¨åååºæºå¶</li>
<li>æ¯æå¼æ­¥å·¥å·æ§è¡</li>
</ul>
</li>
<li>
<p><strong>SignalRå®¢æ·ç«¯å°è£</strong></p>
<ul>
<li>å®æ´çè¿æ¥çå½å¨æç®¡ç</li>
<li>JWT Tokenè®¤è¯</li>
<li>èªå¨éè¿æºå¶ï¼ææ°éé¿ï¼</li>
<li>è®¾å¤æ³¨ååå¿è·³ä¿æ</li>
<li>èªå®ä¹æ¶æ¯å¤ç</li>
</ul>
</li>
</ol>
<h5 id="signalrå®¢æ·ç«¯æ ¸å¿å®ç°-signalr_clientcc">SignalRå®¢æ·ç«¯æ ¸å¿å®ç° (signalr_client.cc)</h5>
<p>è¿æ¯æ´ä¸ªSignalRéæçæ ¸å¿ä»£ç ï¼å°è£äºææä¸SignalRéä¿¡ç¸å³çé»è¾ã</p>
<p><strong>å®æ´ä»£ç </strong>ï¼<a href="https://github.com/maker-community/xiaozhi-esp32/blob/signalr-update-audio/main/signalr_client.cc" target="_blank" rel="noopener nofollow">signalr_client.cc</a> ï¼850è¡ï¼</p>
<p><strong>å³é®å®ç°è¦ç¹</strong>ï¼</p>
<p><strong>1. åä¾æ¨¡å¼ç®¡ç</strong> - å¨å±å¯ä¸å®ä¾</p>
<pre><code class="language-cpp">SignalRClient&amp; SignalRClient::GetInstance() {
    static SignalRClient instance;
    return instance;
}
</code></pre>
<p><strong>2. JWT Tokenè®¤è¯</strong> - éè¿Query Stringä¼ é</p>
<pre><code class="language-cpp">bool SignalRClient::Initialize(const std::string&amp; hub_url, const std::string&amp; token) {
    // ð Build URL with token as query parameter (ASP.NET Core SignalR standard method)
    std::string final_hub_url = hub_url;
    if (!token.empty()) {
        ESP_LOGI(TAG, "========== SignalR Token Authentication ==========");
        
        // Remove "Bearer " prefix if present
        std::string token_value = token;
        if (token_value.find("Bearer ") == 0) {
            token_value = token_value.substr(7);
        }
        
        // Append token to URL
        final_hub_url += "?access_token=" + token_value;
    }
    
    // Create hub connection builder
    auto builder = signalr::hub_connection_builder::create(final_hub_url);
    
    // Set WebSocket factory (ä½¿ç¨ESP32çWebSocketå®ç°)
    builder.with_websocket_factory([](const signalr::signalr_client_config&amp; config) {
        auto client = std::make_shared&lt;signalr::esp32_websocket_client&gt;(config);
        return client;
    });
    
    // Skip negotiation (direct WebSocket connection)
    builder.skip_negotiation(true);
    
    // Build connection
    connection_ = std::make_unique&lt;signalr::hub_connection&gt;(builder.build());
}
</code></pre>
<p><strong>3. è¶æ¶åå¿è·³éç½®</strong></p>
<pre><code class="language-cpp">signalr::signalr_client_config cfg;
cfg.set_server_timeout(std::chrono::seconds(60));     // server expects 60s idle
cfg.set_keepalive_interval(std::chrono::seconds(15)); // send ping every 15s
cfg.set_handshake_timeout(std::chrono::seconds(5));   // short handshake timeout

// IMPORTANT: Disable library's auto-reconnect! It has race condition bugs
cfg.enable_auto_reconnect(false);
connection_-&gt;set_client_config(cfg);
</code></pre>
<p><strong>4. è¿æ¥ç¡®è®¤åèªå¨æ³¨å</strong></p>
<pre><code class="language-cpp">// Register Notification handler to confirm connection
connection_-&gt;on("Notification", [this](const std::vector&lt;signalr::value&gt;&amp; args) {
    if (args.empty()) return;
    
    std::string message = args[0].as_string();
    ESP_LOGI(TAG, "ð Notification from server: %s", message.c_str());
    
    if (!connection_confirmed_) {
        connection_confirmed_ = true;
        ESP_LOGI(TAG, "âââ SIGNALR CONNECTION CONFIRMED BY SERVER! âââ");
        
        // ð Auto-register device info after connection confirmed
        std::string mac_address = DeviceInfo::GetMacAddress();
        std::string metadata = DeviceInfo::BuildMetadataJson();
        
        RegisterDevice(mac_address, "", metadata, [](bool success, const std::string&amp; result) {
            if (success) {
                ESP_LOGI(TAG, "â Device auto-registration successful");
            }
        });
    }
});
</code></pre>
<p><strong>5. èªå®ä¹æ¶æ¯å¤ç</strong></p>
<pre><code class="language-cpp">connection_-&gt;on("CustomMessage", [this](const std::vector&lt;signalr::value&gt;&amp; args) {
    if (args.empty()) return;
    
    try {
        std::string json_str = args[0].as_string();
        ESP_LOGI(TAG, "ð¨ Received CustomMessage: %s", json_str.c_str());
        
        auto root = cJSON_Parse(json_str.c_str());
        if (root) {
            if (on_custom_message_) {
                on_custom_message_(root);  // è°ç¨ç¨æ·è®¾ç½®çåè°
            }
            cJSON_Delete(root);
        }
    } catch (const std::exception&amp; e) {
        ESP_LOGE(TAG, "Exception handling CustomMessage: %s", e.what());
    }
});
</code></pre>
<p><strong>6. èªå¨éè¿æºå¶</strong> - ä½¿ç¨PSRAMæ çåå°ä»»å¡</p>
<pre><code class="language-cpp">void SignalRClient::StartReconnectTask() {
    ESP_LOGI(TAG, "Starting SignalR reconnect background task (PSRAM stack)...");
    reconnect_task_running_.store(true, std::memory_order_release);
    
    // Allocate task stack from PSRAM (reusable)
    reconnect_task_stack_ = (StackType_t*)heap_caps_malloc(
        RECONNECT_TASK_STACK_SIZE, MALLOC_CAP_SPIRAM);
    
    // Create task with static allocation (stack in PSRAM)
    reconnect_task_handle_ = xTaskCreateStatic(
        ReconnectTaskEntry, "signalr_reconn",
        RECONNECT_TASK_STACK_SIZE / sizeof(StackType_t),
        this, 2, reconnect_task_stack_, reconnect_task_buffer_
    );
}

void SignalRClient::ReconnectTaskLoop() {
    while (reconnect_task_running_.load(std::memory_order_acquire)) {
        vTaskDelay(pdMS_TO_TICKS(1000));
        
        if (!reconnect_requested_.load() || IsConnected()) {
            continue;
        }
        
        // Apply exponential backoff
        ESP_LOGI(TAG, "Attempting connection (backoff=%dms)...", reconnect_backoff_ms_);
        
        if (Connect() &amp;&amp; IsConnected()) {
            reconnect_backoff_ms_ = 1000;  // Reset backoff on success
        } else {
            vTaskDelay(pdMS_TO_TICKS(reconnect_backoff_ms_));
            reconnect_backoff_ms_ = std::min(reconnect_backoff_ms_ * 2, 
                MAX_RECONNECT_BACKOFF_MS);  // Exponential backoff
        }
    }
}
</code></pre>
<p><strong>7. è®¾å¤æ³¨ååå¿è·³</strong></p>
<pre><code class="language-cpp">void SignalRClient::RegisterDevice(
    const std::string&amp; mac_address,
    const std::string&amp; device_token,
    const std::string&amp; metadata,
    std::function&lt;void(bool, const std::string&amp;)&gt; callback) {
    
    if (!IsConnected()) {
        if (callback) callback(false, "Not connected");
        return;
    }
    
    std::vector&lt;signalr::value&gt; args;
    args.push_back(signalr::value(mac_address));
    args.push_back(signalr::value(device_token));
    args.push_back(signalr::value(metadata));
    
    connection_-&gt;invoke("RegisterDevice", args,
        [callback](const signalr::value&amp; result, std::exception_ptr ex) {
            if (ex) {
                if (callback) callback(false, "Registration failed");
            } else {
                if (callback) callback(true, "Registration sent");
            }
        });
}

void SignalRClient::SendHeartbeat(
    std::function&lt;void(bool, const std::string&amp;)&gt; callback) {
    
    if (!IsConnected()) {
        if (callback) callback(false, "Not connected");
        return;
    }
    
    std::vector&lt;signalr::value&gt; args;
    connection_-&gt;invoke("Heartbeat", args,
        [callback](const signalr::value&amp; result, std::exception_ptr ex) {
            if (!ex) {
                ESP_LOGD(TAG, "ð Heartbeat sent");
                if (callback) callback(true, "Success");
            }
        });
}
</code></pre>
<p><strong>SignalRå®¢æ·ç«¯ç±»å®ä¹</strong> (signalr_client.h):</p>
<pre><code class="language-cpp">class SignalRClient {
public:
    static SignalRClient&amp; GetInstance();
    
    // è¿æ¥ç®¡ç
    bool Initialize(const std::string&amp; hub_url, const std::string&amp; token);
    bool Connect();
    void Disconnect();
    void Reset();
    void RequestReconnect();
    
    // ç¶ææ¥è¯¢
    bool IsInitialized() const;
    bool IsConnecting() const;
    bool IsConnected() const;
    std::string GetConnectionState() const;
    
    // åè°è®¾ç½®
    void OnCustomMessage(std::function&lt;void(const cJSON*)&gt; callback);
    void OnDeviceRegistered(std::function&lt;void(const cJSON*)&gt; callback);
    
    // Hubæ¹æ³è°ç¨
    void RegisterDevice(const std::string&amp; mac_address,
                       const std::string&amp; device_token,
                       const std::string&amp; metadata,
                       std::function&lt;void(bool, const std::string&amp;)&gt; callback);
    void SendHeartbeat(std::function&lt;void(bool, const std::string&amp;)&gt; callback);
    void InvokeHubMethod(const std::string&amp; method_name,
                        const std::string&amp; args_json,
                        std::function&lt;void(bool, const std::string&amp;)&gt; callback);

private:
    SignalRClient();
    ~SignalRClient();
    
    std::unique_ptr&lt;signalr::hub_connection&gt; connection_;
    std::string hub_url_;
    std::string token_;
    bool initialized_ = false;
    bool connection_confirmed_ = false;
    std::atomic&lt;bool&gt; reconnect_requested_{false};
    
    // åè°å½æ°
    std::function&lt;void(const cJSON*)&gt; on_custom_message_;
    std::function&lt;void(const cJSON*)&gt; on_device_registered_;
    
    // éè¿ä»»å¡
    TaskHandle_t reconnect_task_handle_ = nullptr;
    int reconnect_backoff_ms_ = 1000;
};
</code></pre>
<p><strong>ä½¿ç¨ç¤ºä¾</strong>ï¼</p>
<pre><code class="language-cpp">// å¨ä¸»åºç¨ä¸­ä½¿ç¨SignalRå®¢æ·ç«¯
void Application::InitializeSignalR() {
    auto&amp; client = SignalRClient::GetInstance();
    
    // è®¾ç½®æ¶æ¯åè°
    client.OnCustomMessage([this](const cJSON* json) {
        ESP_LOGI(TAG, "Received message from server");
        HandleServerMessage(json);
    });
    
    // åå§åå¹¶è¿æ¥
    std::string hub_url = "wss://your-server.com/devicehub";
    std::string token = GetJwtToken();  // ä»NVSè¯»åææ«ç è·å
    
    if (client.Initialize(hub_url, token)) {
        if (client.Connect()) {
            client.RequestReconnect();  // å¯å¨èªå¨éè¿ä»»å¡
        }
    }
}
</code></pre>
<h5 id="applicationå±éæä»£ç ">Applicationå±éæä»£ç </h5>
<p><strong>æ ¸å¿ä»£ç çæ®µ</strong> (application.cc):</p>
<pre><code class="language-cpp">
void Application::HandleSignalRMessage(const std::string&amp; message) {
    ESP_LOGI(TAG, "Handling SignalR message: %s", message.c_str());
    
    auto root = cJSON_Parse(message.c_str());
    if (!root) {
        ESP_LOGE(TAG, "Failed to parse SignalR message JSON");
        return;
    }
    
    auto display = Board::GetInstance().GetDisplay();
    
    // Check message action/type
    auto action = cJSON_GetObjectItem(root, "action");
    if (cJSON_IsString(action)) {
        if (strcmp(action-&gt;valuestring, "notification") == 0) {
            // Handle notification
            // JSON: {"action":"notification", "title":"æ é¢", "content":"åå®¹", "emotion":"bell", "sound":"popup"}
            auto title = cJSON_GetObjectItem(root, "title");
            auto content = cJSON_GetObjectItem(root, "content");
            auto emotion = cJSON_GetObjectItem(root, "emotion");
            auto sound = cJSON_GetObjectItem(root, "sound");
            
            const char* title_str = cJSON_IsString(title) ? title-&gt;valuestring : Lang::Strings::INFO;
            const char* content_str = cJSON_IsString(content) ? content-&gt;valuestring : "";
            const char* emotion_str = cJSON_IsString(emotion) ? emotion-&gt;valuestring : "bell";
            
            // Select sound based on "sound" field
            std::string_view sound_view = Lang::Sounds::OGG_POPUP;
            if (cJSON_IsString(sound)) {
                if (strcmp(sound-&gt;valuestring, "success") == 0) {
                    sound_view = Lang::Sounds::OGG_SUCCESS;
                } else if (strcmp(sound-&gt;valuestring, "vibration") == 0) {
                    sound_view = Lang::Sounds::OGG_VIBRATION;
                } else if (strcmp(sound-&gt;valuestring, "exclamation") == 0) {
                    sound_view = Lang::Sounds::OGG_EXCLAMATION;
                } else if (strcmp(sound-&gt;valuestring, "low_battery") == 0) {
                    sound_view = Lang::Sounds::OGG_LOW_BATTERY;
                } else if (strcmp(sound-&gt;valuestring, "none") == 0) {
                    sound_view = "";
                }
                // default: popup
            }
            
            Alert(title_str, content_str, emotion_str, sound_view);
            
        } else if (strcmp(action-&gt;valuestring, "command") == 0) {
            // Handle command
            // JSON: {"action":"command", "command":"reboot|wake|listen|stop"}
            auto cmd = cJSON_GetObjectItem(root, "command");
            if (cJSON_IsString(cmd)) {
                if (strcmp(cmd-&gt;valuestring, "reboot") == 0) {
                    Reboot();
                } else if (strcmp(cmd-&gt;valuestring, "wake") == 0) {
                    // Trigger wake word detection
                    xEventGroupSetBits(event_group_, MAIN_EVENT_WAKE_WORD_DETECTED);
                } else if (strcmp(cmd-&gt;valuestring, "listen") == 0) {
                    StartListening();
                } else if (strcmp(cmd-&gt;valuestring, "stop") == 0) {
                    StopListening();
                } else {
                    ESP_LOGW(TAG, "Unknown SignalR command: %s", cmd-&gt;valuestring);
                }
            }
            
        } else if (strcmp(action-&gt;valuestring, "display") == 0) {
            // Display custom content
            // JSON: {"action":"display", "content":"ææ¬åå®¹", "role":"system"}
            auto content = cJSON_GetObjectItem(root, "content");
            auto role = cJSON_GetObjectItem(root, "role");
            const char* role_str = cJSON_IsString(role) ? role-&gt;valuestring : "system";
            if (cJSON_IsString(content)) {
                display-&gt;SetChatMessage(role_str, content-&gt;valuestring);
            }
            
        } else if (strcmp(action-&gt;valuestring, "emotion") == 0) {
            // Change emotion/expression
            // JSON: {"action":"emotion", "emotion":"happy"}
            auto emotion = cJSON_GetObjectItem(root, "emotion");
            if (cJSON_IsString(emotion)) {
                display-&gt;SetEmotion(emotion-&gt;valuestring);
            }
            
        } else if (strcmp(action-&gt;valuestring, "image") == 0) {
            // Display image from URL
            // JSON: {"action":"image", "url":"https://example.com/image.jpg"}
            auto url = cJSON_GetObjectItem(root, "url");
            if (cJSON_IsString(url)) {
                HandleSignalRImageMessage(url-&gt;valuestring);
            } else {
                ESP_LOGW(TAG, "Image action requires 'url' field");
            }
            
        } else if (strcmp(action-&gt;valuestring, "audio") == 0) {
            // Play audio from URL (OGG format)
            // JSON: {"action":"audio", "url":"https://example.com/sound.ogg"}
            auto url = cJSON_GetObjectItem(root, "url");
            if (cJSON_IsString(url)) {
                HandleSignalRAudioMessage(url-&gt;valuestring);
            } else {
                ESP_LOGW(TAG, "Audio action requires 'url' field");
            }
            
        } else if (strcmp(action-&gt;valuestring, "qrcode") == 0) {
            // Show QR code
            // JSON: {"action":"qrcode", "data":"https://...", "title":"æ é¢", "subtitle":"å¯æ é¢"}
            auto data = cJSON_GetObjectItem(root, "data");
            auto title = cJSON_GetObjectItem(root, "title");
            auto subtitle = cJSON_GetObjectItem(root, "subtitle");
            if (cJSON_IsString(data)) {
                const char* title_str = cJSON_IsString(title) ? title-&gt;valuestring : nullptr;
                const char* subtitle_str = cJSON_IsString(subtitle) ? subtitle-&gt;valuestring : nullptr;
                display-&gt;ShowQRCode(data-&gt;valuestring, title_str, subtitle_str);
            } else {
                ESP_LOGW(TAG, "QRCode action requires 'data' field");
            }
            
        } else if (strcmp(action-&gt;valuestring, "hide_qrcode") == 0) {
            // Hide QR code
            // JSON: {"action":"hide_qrcode"}
            display-&gt;HideQRCode();
            
        } else {
            // Default: display as system message
            char* display_str = cJSON_Print(root);
            if (display_str) {
                display-&gt;SetChatMessage("system", display_str);
                cJSON_free(display_str);
            }
        }
    } else {
        // No action specified, display raw message
        char* display_str = cJSON_Print(root);
        if (display_str) {
            display-&gt;SetChatMessage("system", display_str);
            cJSON_free(display_str);
        }
    }
    
    cJSON_Delete(root);
}

</code></pre>
<p><strong>å®æ´çApplicationç±»åè½</strong>ï¼</p>
<ul>
<li>â è®¾å¤ç¶æç®¡ç (ç¶ææº)</li>
<li>â ç½ç»äºä»¶å¤ç (è¿æ¥/æ­å¼)</li>
<li>â é³é¢æå¡éæ (ç¼è§£ç ãæµå¤ç)</li>
<li>â å¤éè¯æ£æµ</li>
<li>â åè®®å±æ½è±¡ (WebSocket/MQTT)</li>
<li>â MCPæ¶æ¯è·¯ç±</li>
<li>â éè¯¯å¤çåæ¢å¤</li>
<li>â èµæºç®¡çåæ¸ç</li>
<li>â çº¿ç¨å®å¨çæ¶æ¯è°åº¦</li>
</ul>
<h4 id="522-mcpæå¡å¨ä»£ç -verdure-mcp">5.2.2 MCPæå¡å¨ä»£ç  (verdure-mcp)</h4>
<p><strong>ä»åºå°å</strong>ï¼<a href="https://github.com/maker-community/verdure-mcp" target="_blank" rel="noopener nofollow">verdure-mcp</a></p>
<p><strong>ç®å½ç»æ</strong>ï¼</p>
<pre><code>src/Verdure.Mcp.Server/
âââ Hubs/
â   âââ DeviceHub.cs          # SignalR Hubå®ç°
âââ Tools/
â   âââ MusicTool.cs          # é³ä¹æ­æ¾æ§å¶
â   âââ EmailTool.cs          # é®ä»¶åé
â   âââ WeatherTool.cs        # å¤©æ°æ¥è¯¢
â   âââ SmartHomeTool.cs      # æºè½å®¶å±æ§å¶
âââ Services/
â   âââ DeviceService.cs      # è®¾å¤ç®¡çæå¡
â   âââ McpExecutor.cs        # MCPå·¥å·æ§è¡å¨
â   âââ TokenService.cs       # JWTä»¤çæå¡
âââ Models/
    âââ DeviceConnection.cs   # è®¾å¤è¿æ¥è®°å½
    âââ DeviceInfo.cs         # è®¾å¤ä¿¡æ¯
    âââ McpToolLog.cs         # å·¥å·è°ç¨æ¥å¿
</code></pre>
<p><strong>DeviceHubå®æ´å®ç°</strong> (Hubs/DeviceHub.cs):</p>
<p>çäº§ç¯å¢çDeviceHubå®éå®ç°ç¹ç¹ï¼</p>
<ul>
<li>â æ°æ®åºæä¹å (Entity Framework Core + PostgreSQL)</li>
<li>â è®¾å¤æ³¨ååç¶æè·è¸ª</li>
<li>â ç¨æ·åè®¾å¤åç»ç®¡ç</li>
<li>â å¿è·³æ£æµ</li>
<li>â åéè®¤è¯ (JWT + API Token)</li>
<li>â å®åçå¼å¸¸å¤çåæ¥å¿</li>
</ul>
<pre><code class="language-csharp">using Microsoft.AspNetCore.SignalR;
using Verdure.Mcp.Infrastructure.Database;
using Verdure.Mcp.Infrastructure.Services;

namespace Verdure.Mcp.Server.Hubs;

/// &lt;summary&gt;
/// è®¾å¤è¿æ¥Hub - å¤çESP32ç­IoTè®¾å¤çSignalRè¿æ¥
/// &lt;/summary&gt;
public class DeviceHub : Hub
{
    private readonly McpDbContext _dbContext;
    private readonly ITokenValidationService _tokenValidationService;
    private readonly ILogger&lt;DeviceHub&gt; _logger;

    public DeviceHub(
        McpDbContext dbContext,
        ITokenValidationService tokenValidationService,
        ILogger&lt;DeviceHub&gt; logger)
    {
        _dbContext = dbContext;
        _tokenValidationService = tokenValidationService;
        _logger = logger;
    }

    /// &lt;summary&gt;
    /// è®¾å¤è¿æ¥ - æ¯æJWTåAPI Tokenåéè®¤è¯
    /// &lt;/summary&gt;
    public override async Task OnConnectedAsync()
    {
        try
        {
            var httpContext = Context.GetHttpContext();
            if (httpContext == null)
            {
                _logger.LogWarning("HttpContext is null");
                Context.Abort();
                return;
            }

            // ä»æ¥è¯¢åæ°è·åtoken
            var token = httpContext.Request.Query["access_token"].ToString();
            if (string.IsNullOrEmpty(token))
            {
                _logger.LogWarning("Connection attempt without token");
                Context.Abort();
                return;
            }

            // éªè¯token - æ¯æJWTåAPI Token
            var validationResult = await _tokenValidationService.ValidateTokenAsync(token);
            if (!validationResult.IsValid)
            {
                _logger.LogWarning("Invalid token: {Reason}", validationResult.FailureReason);
                Context.Abort();
                return;
            }

            var userId = validationResult.UserId;
            if (string.IsNullOrEmpty(userId))
            {
                _logger.LogWarning("Token valid but userId is missing");
                Context.Abort();
                return;
            }

            // å°è¿æ¥å å¥ç¨æ·ç» (æ ¼å¼: Users:{userId})
            await Groups.AddToGroupAsync(Context.ConnectionId, $"Users:{userId}");

            _logger.LogInformation(
                "Device connected: ConnectionId={ConnectionId}, UserId={UserId}",
                Context.ConnectionId, userId);

            // åéæ¬¢è¿éç¥
            await Clients.Caller.SendAsync("Notification", 
                $"Welcome! Connected to Verdure MCP Server at {DateTime.UtcNow:yyyy-MM-dd HH:mm:ss}");

            await base.OnConnectedAsync();
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error in OnConnectedAsync");
            Context.Abort();
        }
    }

    /// &lt;summary&gt;
    /// è®¾å¤æ­å¼è¿æ¥
    /// &lt;/summary&gt;
    public override async Task OnDisconnectedAsync(Exception? exception)
    {
        if (exception != null)
        {
            _logger.LogWarning(exception, 
                "Device disconnected with error: ConnectionId={ConnectionId}",
                Context.ConnectionId);
        }
        else
        {
            _logger.LogInformation(
                "Device disconnected normally: ConnectionId={ConnectionId}",
                Context.ConnectionId);
        }

        await base.OnDisconnectedAsync(exception);
    }

    /// &lt;summary&gt;
    /// è®¾å¤æ³¨å - ä¿å­è®¾å¤MACå°åååæ°æ®
    /// &lt;/summary&gt;
    public async Task RegisterDevice(string macAddress, string deviceToken, string metadata)
    {
        try
        {
            var userId = Context.Items["UserId"]?.ToString();
            if (string.IsNullOrEmpty(userId))
            {
                _logger.LogWarning("RegisterDevice called without userId");
                return;
            }

            _logger.LogInformation(
                "Device registration: UserId={UserId}, MAC={MacAddress}, Metadata={Metadata}",
                userId, macAddress, metadata);

            // å°è®¾å¤å å¥è®¾å¤ç» (æ ¼å¼: Device:{macAddress})
            await Groups.AddToGroupAsync(Context.ConnectionId, $"Device:{macAddress}");

            // ä¿å­è®¾å¤ä¿¡æ¯å°æ°æ®åº
            var existingDevice = await _dbContext.Devices
                .FirstOrDefaultAsync(d =&gt; d.MacAddress == macAddress);

            if (existingDevice != null)
            {
                existingDevice.LastSeenAt = DateTime.UtcNow;
                existingDevice.Metadata = metadata;
                existingDevice.IsOnline = true;
            }
            else
            {
                _dbContext.Devices.Add(new Device
                {
                    MacAddress = macAddress,
                    UserId = userId,
                    Metadata = metadata,
                    IsOnline = true,
                    CreatedAt = DateTime.UtcNow,
                    LastSeenAt = DateTime.UtcNow
                });
            }

            await _dbContext.SaveChangesAsync();

            // ç¡®è®¤æ³¨åæå
            await Clients.Caller.SendAsync("Notification", 
                $"Device registered successfully: {macAddress}");
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error in RegisterDevice");
        }
    }

    /// &lt;summary&gt;
    /// å¿è·³ä¿æ
    /// &lt;/summary&gt;
    public async Task Heartbeat()
    {
        _logger.LogDebug("Heartbeat from ConnectionId={ConnectionId}", Context.ConnectionId);
        
        // æ´æ°æåæ´»è·æ¶é´
        // æ³¨æï¼å®éä»£ç ä¸­å¯ä»¥æ ¹æ®ConnectionIdæ¥æ¾è®¾å¤å¹¶æ´æ°LastSeenAt
        await Task.CompletedTask;
    }
}
</code></pre>
<p><strong>å®éçMCPå·¥å·å®ç°</strong> (ä¸ä½¿ç¨åºç±»):</p>
<p>å¨verdure-mcpä¸­ï¼MCPå·¥å·<strong>ä¸ç»§æ¿ä»»ä½åºç±»</strong>ï¼èæ¯ï¼</p>
<ol>
<li>ä½¿ç¨ <code>[McpServerToolType]</code> ç¹æ§æ è®°</li>
<li>éè¿ä¾èµæ³¨å¥è·å <code>IDevicePushService</code> æå¡</li>
<li>ä½¿ç¨ <code>IDevicePushService</code> çæ¹æ³æ¨éæ¶æ¯ç»è®¾å¤</li>
</ol>
<p><strong>DevicePushServiceæ¥å£</strong> (Infrastructure/Services/DevicePushService.cs):</p>
<pre><code class="language-csharp">namespace Verdure.Mcp.Infrastructure.Services;

/// &lt;summary&gt;
/// è®¾å¤æ¨éæå¡æ¥å£
/// &lt;/summary&gt;
public interface IDevicePushService
{
    /// &lt;summary&gt;
    /// åç¨æ·çææè®¾å¤åéæ¶æ¯
    /// &lt;/summary&gt;
    Task SendToUserAsync(string userId, string method, object message, 
        CancellationToken cancellationToken = default);

    /// &lt;summary&gt;
    /// åæå®è®¾å¤åéæ¶æ¯
    /// &lt;/summary&gt;
    Task SendToDeviceAsync(string deviceId, string method, object message, 
        CancellationToken cancellationToken = default);

    /// &lt;summary&gt;
    /// åéèªå®ä¹æ¶æ¯ (xiaozhiåè®®æ ¼å¼)
    /// &lt;/summary&gt;
    Task SendCustomMessageAsync(string userId, object message, 
        CancellationToken cancellationToken = default);

    /// &lt;summary&gt;
    /// åééç¥æ¶æ¯
    /// &lt;/summary&gt;
    Task SendNotificationAsync(string userId, string notificationMessage, 
        CancellationToken cancellationToken = default);
}
</code></pre>
<p><strong>DevicePushServiceå®ç°</strong> (Server/Services/DevicePushServiceImpl.cs):</p>
<pre><code class="language-csharp">using Microsoft.AspNetCore.SignalR;
using Verdure.Mcp.Server.Hubs;
using Verdure.Mcp.Infrastructure.Services;
using System.Text.Json;

namespace Verdure.Mcp.Server.Services;

public class DevicePushServiceImpl : IDevicePushService
{
    private readonly IHubContext&lt;DeviceHub&gt; _hubContext;
    private readonly ILogger&lt;DevicePushServiceImpl&gt; _logger;

    public DevicePushServiceImpl(
        IHubContext&lt;DeviceHub&gt; hubContext,
        ILogger&lt;DevicePushServiceImpl&gt; logger)
    {
        _hubContext = hubContext;
        _logger = logger;
    }

    public async Task SendToUserAsync(string userId, string method, object message, 
        CancellationToken cancellationToken = default)
    {
        var groupName = $"Users:{userId}";
        await _hubContext.Clients.Group(groupName)
            .SendAsync(method, message, cancellationToken);
        
        _logger.LogInformation("Sent {Method} to user {UserId}", method, userId);
    }

    public async Task SendToDeviceAsync(string deviceId, string method, object message, 
        CancellationToken cancellationToken = default)
    {
        var groupName = $"Device:{deviceId}";
        await _hubContext.Clients.Group(groupName)
            .SendAsync(method, message, cancellationToken);
        
        _logger.LogInformation("Sent {Method} to device {DeviceId}", method, deviceId);
    }

    public async Task SendCustomMessageAsync(string userId, object message, 
        CancellationToken cancellationToken = default)
    {
        var groupName = $"Users:{userId}";
        
        // éè¦ï¼ESP32å®¢æ·ç«¯æææ¥æ¶JSONå­ç¬¦ä¸²ï¼èä¸æ¯å¯¹è±¡
        var jsonString = JsonSerializer.Serialize(message);
        
        await _hubContext.Clients.Group(groupName)
            .SendAsync("CustomMessage", jsonString, cancellationToken);
        
        _logger.LogInformation("Sent CustomMessage to user {UserId}: {Message}", 
            userId, jsonString);
    }

    public async Task SendNotificationAsync(string userId, string notificationMessage, 
        CancellationToken cancellationToken = default)
    {
        var groupName = $"Users:{userId}";
        await _hubContext.Clients.Group(groupName)
            .SendAsync("Notification", notificationMessage, cancellationToken);
        
        _logger.LogInformation("Sent notification to user {UserId}: {Message}", 
            userId, notificationMessage);
    }
}
</code></pre>
<p><strong>é³ä¹æ­æ¾å·¥å·å®éå®ç°</strong> (Tools/MusicTool.cs):</p>
<pre><code class="language-csharp">using System;
using System.ComponentModel;
using System.IO;
using System.Linq;
using System.Threading;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Hosting;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Logging;
using Microsoft.Extensions.Options;
using Verdure.Mcp.Server.Settings;
using ModelContextProtocol.Server;
using Verdure.Mcp.Infrastructure.Services;
using Verdure.Mcp.Server.Services;
using Hangfire;

namespace Verdure.Mcp.Server.Tools;

/// &lt;summary&gt;
/// MCP Tool to pick a random audio file from wwwroot and push its URL to device(s).
/// &lt;/summary&gt;
[McpServerToolType]
public class MusicTool
{
    private readonly IHttpContextAccessor _httpContextAccessor;
    private readonly IWebHostEnvironment _env;
    private readonly IDevicePushService _devicePushService;
    private readonly ILogger&lt;MusicTool&gt; _logger;
    private readonly IBackgroundJobClient _backgroundJobClient;
    private readonly ImageStorageSettings _imageStorageSettings;

    public MusicTool(
        IHttpContextAccessor httpContextAccessor,
        IWebHostEnvironment env,
        IDevicePushService devicePushService,
        ILogger&lt;MusicTool&gt; logger,
        IBackgroundJobClient backgroundJobClient,
        IOptions&lt;ImageStorageSettings&gt;? imageSettings = null)
    {
        _httpContextAccessor = httpContextAccessor;
        _env = env;
        _devicePushService = devicePushService;
        _logger = logger;
        _backgroundJobClient = backgroundJobClient;
        _imageStorageSettings = imageSettings?.Value ?? new ImageStorageSettings();
    }

    /// &lt;summary&gt;
    /// Select a random audio file from the `wwwroot/audio` folder and push it to the user
    /// identified by the `X-User-Id` request header.
    /// The pushed message follows the same shape as used in `test-send-message.ps1` (action = "audio", url = "...").
    /// &lt;/summary&gt;
    [McpServerTool(Name = "play_random_music")]
    [Description("Plays a random audio file from wwwroot/audio by pushing an audio message to the user's devices")]
    public async Task&lt;MusicResponse&gt; PlayRandomMusic(CancellationToken cancellationToken = default)
    {
        try
        {
            var httpContext = _httpContextAccessor.HttpContext;
            var effectiveUserId = httpContext?.Request.Headers["X-User-Id"].FirstOrDefault();
            if (string.IsNullOrEmpty(effectiveUserId))
            {
                _logger.LogWarning("No userId provided and X-User-Id header is missing");
                return new MusicResponse { Success = false, Message = "Missing userId or X-User-Id header" };
            }

            var webRoot = _env.WebRootPath ?? _env.ContentRootPath;
            var folder = "audios";
            var audioFolder = Path.Combine(webRoot, folder);

            if (!Directory.Exists(audioFolder))
            {
                _logger.LogWarning("Audio folder does not exist: {AudioFolder}", audioFolder);
                return new MusicResponse { Success = false, Message = $"Audio folder not found: {folder}" };
            }

            // Find audio files (ogg, mp3) and pick a random one
            var files = Directory.GetFiles(audioFolder)
                .Where(f =&gt; f.EndsWith('.' + "ogg") || f.EndsWith('.' + "mp3") || f.EndsWith('.' + "wav"))
                .ToArray();

            if (files.Length == 0)
            {
                _logger.LogWarning("No audio files found in {AudioFolder}", audioFolder);
                return new MusicResponse { Success = false, Message = "No audio files found" };
            }

            var rnd = new Random();
            var chosen = files[rnd.Next(files.Length)];
            var fileName = Path.GetFileName(chosen);

            string url;
            // Prefer configured ImageStorage BaseUrl (keeps image and audio base URL consistent)
            if (!string.IsNullOrWhiteSpace(_imageStorageSettings.BaseUrl))
            {
                var cfgBase = _imageStorageSettings.BaseUrl.TrimEnd('/');
                url = $"{cfgBase}/{folder}/{Uri.EscapeDataString(fileName)}";
            }
            else
            {
                var req = httpContext?.Request;
                var hostBase = req != null ? $"{req.Scheme}://{req.Host.Value}" : string.Empty;
                url = string.IsNullOrEmpty(hostBase)
                    ? $"/{folder}/{Uri.EscapeDataString(fileName)}"
                    : $"{hostBase}/{folder}/{Uri.EscapeDataString(fileName)}";
            }

            var title = Path.GetFileNameWithoutExtension(fileName);

            var message = new
            {
                action = "audio",
                url,
                title
            };

            // Schedule push as a delayed background job so device can play result first.
            try
            {

                var jobDelay = TimeSpan.FromSeconds(5);

                _logger.LogInformation("Scheduling audio push to user {UserId} after {Delay}s: {Url}",
                    effectiveUserId, jobDelay.TotalSeconds, url);

                _backgroundJobClient.Schedule&lt;MusicPushBackgroundJob&gt;(
                    job =&gt; job.ExecuteAsync(effectiveUserId, url, title, CancellationToken.None),
                    jobDelay);

                return new MusicResponse { Success = true, Message = "Audio scheduled", Url = url, FileName = fileName };
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Failed to schedule audio push for user {UserId}", effectiveUserId);
                return new MusicResponse { Success = false, Message = ex.Message };
            }
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to play random music");
            return new MusicResponse { Success = false, Message = ex.Message };
        }
    }
}

public class MusicResponse
{
    public bool Success { get; set; }
    public required string Message { get; set; }
    public string? Url { get; set; }
    public string? FileName { get; set; }
}

</code></pre>
<p><strong>å»¶è¿æ¨éåå°ä»»å¡</strong> (Tools/MusicPushBackgroundJob.cs):</p>
<pre><code class="language-csharp">using Verdure.Mcp.Infrastructure.Services;
using Verdure.Mcp.Server.Services;

namespace Verdure.Mcp.Server.Tools;

/// &lt;summary&gt;
/// Background job to push music/audio messages to user devices after a delay.
/// &lt;/summary&gt;
public class MusicPushBackgroundJob
{
    private readonly IDevicePushService _devicePushService;
    private readonly ILogger&lt;MusicPushBackgroundJob&gt; _logger;

    public MusicPushBackgroundJob(IDevicePushService devicePushService, ILogger&lt;MusicPushBackgroundJob&gt; logger)
    {
        _devicePushService = devicePushService;
        _logger = logger;
    }

    public async Task ExecuteAsync(string userId, string url, string title, CancellationToken cancellationToken)
    {
        _logger.LogInformation("Executing MusicPushBackgroundJob: user={UserId}, url={Url}", userId, url);

        var message = new
        {
            action = "audio",
            url,
            title
        };

        try
        {
            await _devicePushService.SendCustomMessageAsync(userId, message, cancellationToken);
            _logger.LogInformation("Music pushed to user {UserId}", userId);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to push music to user {UserId}", userId);
        }
    }
}

</code></pre>
<h4 id="523-å¾ççæå·¥å·å®ç°ç¤ºä¾">5.2.3 å¾ççæå·¥å·å®ç°ç¤ºä¾</h4>
<p><strong>ä»åºå°å</strong>ï¼<a href="https://github.com/maker-community/verdure-mcp/blob/main/src/Verdure.Mcp.Server/Tools/GenerateImageTool.cs" target="_blank" rel="noopener nofollow">verdure-mcp - GenerateImageTool</a></p>
<p>è¿ä¸ªå·¥å·å±ç¤ºäºå¦ä½çæå¾çå¹¶æ¨éå°è®¾å¤ï¼</p>
<pre><code class="language-csharp">using System.ComponentModel;
using System.Net;
using Hangfire;
using Microsoft.EntityFrameworkCore;
using ModelContextProtocol.Server;
using Verdure.Mcp.Domain.Entities;
using Verdure.Mcp.Domain.Enums;
using Verdure.Mcp.Infrastructure.Data;
using Verdure.Mcp.Infrastructure.Services;
using Verdure.Mcp.Server.Services;

namespace Verdure.Mcp.Server.Tools;

/// &lt;summary&gt;
/// ä½¿ç¨ Azure OpenAI DALL-E çæå¾çç MCP å·¥å·
/// &lt;/summary&gt;
[McpServerToolType]
public class GenerateImageTool
{
    private readonly IImageGenerationService _imageGenerationService;
    private readonly IEmailService _emailService;
    private readonly McpDbContext _dbContext;
    private readonly IBackgroundJobClient _backgroundJobClient;
    private readonly IHttpContextAccessor _httpContextAccessor;
    private readonly IImageStorageService _imageStorageService;
    private readonly IDevicePushService _devicePushService;
    private readonly ILogger&lt;GenerateImageTool&gt; _logger;

    public GenerateImageTool(
        IImageGenerationService imageGenerationService,
        IEmailService emailService,
        McpDbContext dbContext,
        IBackgroundJobClient backgroundJobClient,
        IHttpContextAccessor httpContextAccessor,
        IImageStorageService imageStorageService,
        IDevicePushService devicePushService,
        ILogger&lt;GenerateImageTool&gt; logger)
    {
        _imageGenerationService = imageGenerationService;
        _emailService = emailService;
        _dbContext = dbContext;
        _backgroundJobClient = backgroundJobClient;
        _httpContextAccessor = httpContextAccessor;
        _imageStorageService = imageStorageService;
        _devicePushService = devicePushService;
        _logger = logger;
    }

    /// &lt;summary&gt;
    /// ä½¿ç¨ Azure OpenAI DALL-E æ ¹æ®æç¤ºè¯çæå¾çã
    /// å¦ææä¾é®ç®±å°åï¼ä¼å°çæçå¾çåéå°æå®é®ç®±ã
    /// å¦æè¯·æ±å¤´ä¸­åå«ç¨æ·ä¿¡æ¯ï¼X-User-Email å X-User-Idï¼ï¼ä»»å¡å°å¼æ­¥è¿è¡ã
    /// &lt;/summary&gt;
    /// &lt;param name="prompt"&gt;æè¿°è¦çæå¾ççææ¬æç¤ºè¯&lt;/param&gt;
    /// &lt;param name="size"&gt;å¾çå°ºå¯¸ï¼"1024x1024"ã"1792x1024" æ "1024x1792"ï¼é»è®¤ä¸º "1024x1024"&lt;/param&gt;
    /// &lt;param name="quality"&gt;å¾çè´¨éï¼"standard" æ "hd"ï¼é»è®¤ä¸º "standard"&lt;/param&gt;
    /// &lt;param name="style"&gt;å¾çé£æ ¼ï¼"vivid" æ "natural"ï¼é»è®¤ä¸º "vivid"&lt;/param&gt;
    /// &lt;param name="cancellationToken"&gt;&lt;/param&gt;
    /// &lt;returns&gt;åå«ä»»å¡ä¿¡æ¯åå¾çæ°æ®ç JSON å¯¹è±¡ï¼åæ­¥æ¨¡å¼ä¸ï¼&lt;/returns&gt;
    [McpServerTool(Name = "generate_image")]
    [Description("ä½¿ç¨ DALL-E æ¨¡åï¼æ ¹æ®ææ¬æç¤ºè¯çæå¾çãæ¯æé®ä»¶éç¥åå¼æ­¥å¤çã")]
    public async Task&lt;ImageGenerationResponse&gt; GenerateImage(
        [Description("æè¿°è¦çæå¾ççææ¬æç¤ºè¯")] string prompt,
        [Description("å¾çå°ºå¯¸ï¼'1024x1024'ã'1792x1024' æ '1024x1792'ï¼é»è®¤ä¸º '1024x1024'")] string? size = null,
        [Description("å¾çè´¨éï¼'standard' æ 'hd'ï¼é»è®¤ä¸º 'standard'")] string? quality = null,
        [Description("å¾çé£æ ¼ï¼'vivid' æ 'natural'ï¼é»è®¤ä¸º 'vivid'")] string? style = null,
        CancellationToken cancellationToken = default)
    {
        var httpContext = _httpContextAccessor.HttpContext;
        
        // ä»è¯·æ±å¤´æåé®ç®±å°å (X-User-Email)
        var email = httpContext?.Request.Headers["X-User-Email"].FirstOrDefault();
        
        // ä»è¯·æ±å¤´æåç¨æ· ID (X-User-Id)
        var userId = httpContext?.Request.Headers["X-User-Id"].FirstOrDefault();

        _logger.LogInformation("æ¶å°å¾ççæè¯·æ±ãæç¤ºè¯: {Prompt}, é®ç®±: {Email}, ç¨æ·ID: {UserId}", 
            prompt, email ?? "æ ", userId ?? "æ ");

        // åå»ºä»»å¡è®°å½
        var task = new ImageGenerationTask
        {
            Id = Guid.NewGuid(),
            Prompt = prompt,
            Size = size ?? "1024x1024",
            Quality = quality ?? "standard",
            Style = style ?? "vivid",
            Status = ImageTaskStatus.Pending,
            Email = email,
            UserId = userId,
            CreatedAt = DateTime.UtcNow
        };

        _dbContext.ImageGenerationTasks.Add(task);
        await _dbContext.SaveChangesAsync(cancellationToken);

        // å¦æå­å¨ç¨æ·ä¿¡æ¯ï¼X-User-Email å X-User-Idï¼ï¼ä½¿ç¨ Hangfire å¼æ­¥å¤ç
        if (!string.IsNullOrEmpty(email) &amp;&amp; !string.IsNullOrEmpty(userId))
        {
            _logger.LogInformation("æ£æµå°ç¨æ·ä¿¡æ¯ï¼ä½¿ç¨å¼æ­¥å¤çä»»å¡ {TaskId}", task.Id);
            
            var jobId = _backgroundJobClient.Enqueue&lt;ImageGenerationBackgroundJob&gt;(
                job =&gt; job.ExecuteAsync(task.Id, CancellationToken.None));
            
            task.HangfireJobId = jobId;
            task.Status = ImageTaskStatus.Processing;
            await _dbContext.SaveChangesAsync(cancellationToken);

            return new ImageGenerationResponse
            {
                TaskId = task.Id,
                Status = "å¤çä¸­",
                Message = "å¾ççæä»»å¡å·²å å¥éåãå¦ææ¨æä¾äºé®ç®±å°åï¼ç¨åä¼æ¶å°çæç»æã",
                IsAsync = true
            };
        }
        else
        {
            // åæ­¥å¤ç
            _logger.LogInformation("æªæ£æµå°å®æ´ç¨æ·ä¿¡æ¯ï¼ä½¿ç¨åæ­¥å¤çä»»å¡ {TaskId}", task.Id);
            
            task.Status = ImageTaskStatus.Processing;
            await _dbContext.SaveChangesAsync(cancellationToken);

            try
            {
                var result = await _imageGenerationService.GenerateImageAsync(
                    prompt, size, quality, style, cancellationToken);

                if (result.Success)
                {
                    task.Status = ImageTaskStatus.Completed;
                    task.ImageData = result.ImageBase64;
                    task.CompletedAt = DateTime.UtcNow;
                    task.UpdatedAt = DateTime.UtcNow;

                    // ä¿å­å¾çå°æ¬å°æä»¶ç³»ç»ï¼PNG + JPEGï¼
                    ImageStorageResult? storageResult = null;
                    if (!string.IsNullOrEmpty(result.ImageBase64))
                    {
                        try
                        {
                            storageResult = await _imageStorageService.SaveImageAsync(
                                result.ImageBase64, 
                                task.Id, 
                                cancellationToken);
                            task.ImageUrl = storageResult.PngUrl; // æ°æ®åºä¿å­ PNG URL
                            _logger.LogInformation(
                                "å¾çå·²ä¿å­ - PNG: {PngUrl}, JPEG: {JpegUrl}, åç¼©ç: {CompressionRatio:F1}%",
                                storageResult.PngUrl, storageResult.JpegUrl, storageResult.CompressionRatio);
                        }
                        catch (Exception ex)
                        {
                            _logger.LogError(ex, "ä¿å­å¾çå°æ¬å°å¤±è´¥ï¼ä»»å¡ {TaskId}", task.Id);
                            // å³ä½¿ä¿å­å¤±è´¥ï¼ä»ç¶ç»§ç»­æµç¨
                        }
                    }

                    await _dbContext.SaveChangesAsync(cancellationToken);

                    // å¦ææä¾äºé®ç®±ï¼åéé®ä»¶
                    if (!string.IsNullOrEmpty(email) &amp;&amp; !string.IsNullOrEmpty(result.ImageBase64))
                    {
                        try
                        {
                            var imageBytes = Convert.FromBase64String(result.ImageBase64);
                            var encodedPrompt = WebUtility.HtmlEncode(prompt);
                            var encodedRevisedPrompt = WebUtility.HtmlEncode(result.RevisedPrompt ?? "æ ");
                            await _emailService.SendImageEmailAsync(
                                email,
                                "æ¨çå¾çå·²çæ",
                                $"&lt;h1&gt;æ¨çå¾çå·²æåçæï¼&lt;/h1&gt;&lt;p&gt;æç¤ºè¯ï¼{encodedPrompt}&lt;/p&gt;&lt;p&gt;ä¿®è®¢åçæç¤ºè¯ï¼{encodedRevisedPrompt}&lt;/p&gt;",
                                imageBytes,
                                $"image_{task.Id}.png",
                                cancellationToken);
                            
                            task.EmailSent = true;
                            await _dbContext.SaveChangesAsync(cancellationToken);
                        }
                        catch (Exception ex)
                        {
                            _logger.LogError(ex, "åéé®ä»¶å¤±è´¥ï¼ä»»å¡ {TaskId}", task.Id);
                        }
                    }

                    // å¦ææç¨æ· IDï¼æ¨éå°ç¨æ·è®¾å¤ï¼ä½¿ç¨ JPEG çæ¬ï¼ç¬¦å xiaozhi åè®®ï¼
                    if (!string.IsNullOrEmpty(userId) &amp;&amp; storageResult != null)
                    {
                        try
                        {
                            // 1. ååééç¥æ¶æ¯
                            var notificationMessage = new
                            {
                                action = "notification",
                                title = "å¾ççæå®æ",
                                content = $"æ¨çå¾çå·²çæï¼{prompt.Substring(0, Math.Min(30, prompt.Length))}...",
                                emotion = "happy",
                                sound = "success"
                            };
                            await _devicePushService.SendCustomMessageAsync(userId, notificationMessage, cancellationToken);
                            
                            // 2. ååéå¾çæ¶æ¯ï¼ESP32 ææçæ ¼å¼ - xiaozhi åè®®ï¼
                            var imageMessage = new
                            {
                                action = "image",
                                url = storageResult.JpegUrl,  // ä½¿ç¨ JPEG URLï¼ä½ç§¯å°ï¼
                                // æ©å±ä¿¡æ¯ï¼å¯éï¼ESP32 å¯ä»¥å¿½ç¥ï¼
                                taskId = task.Id.ToString(),
                                pngUrl = storageResult.PngUrl,
                                prompt = prompt,
                                jpegSize = storageResult.JpegSize,
                                timestamp = DateTime.UtcNow
                            };

                            await _devicePushService.SendCustomMessageAsync(userId, imageMessage, cancellationToken);
                            _logger.LogInformation(
                                "å·²æ¨éå¾çå°ç¨æ· {UserId} çè®¾å¤ï¼ä»»å¡ {TaskId}ï¼JPEG URL: {JpegUrl} ({JpegSize} bytes)", 
                                userId, task.Id, storageResult.JpegUrl, storageResult.JpegSize);
                        }
                        catch (Exception ex)
                        {
                            _logger.LogError(ex, "æ¨éæ¶æ¯å°è®¾å¤å¤±è´¥ï¼ç¨æ· {UserId}ï¼ä»»å¡ {TaskId}", userId, task.Id);
                        }
                    }

                    // åæ­¥æ¨¡å¼ï¼è¿å PNG URLï¼å®æ´è´¨éï¼
                    return new ImageGenerationResponse
                    {
                        TaskId = task.Id,
                        Status = "å·²å®æ",
                        Message = "å¾ççææå",
                        ImageUrl = storageResult?.PngUrl ?? result.ImageUrl,
                        RevisedPrompt = result.RevisedPrompt,
                        IsAsync = false
                    };
                }
                else
                {
                    task.Status = ImageTaskStatus.Failed;
                    task.ErrorMessage = result.ErrorMessage;
                    task.UpdatedAt = DateTime.UtcNow;
                    await _dbContext.SaveChangesAsync(cancellationToken);

                    return new ImageGenerationResponse
                    {
                        TaskId = task.Id,
                        Status = "å¤±è´¥",
                        Message = result.ErrorMessage ?? "å¾ççæå¤±è´¥",
                        IsAsync = false
                    };
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "åæ­¥çæå¾çæ¶åºéï¼ä»»å¡ {TaskId}", task.Id);
                
                task.Status = ImageTaskStatus.Failed;
                task.ErrorMessage = ex.Message;
                task.UpdatedAt = DateTime.UtcNow;
                await _dbContext.SaveChangesAsync(cancellationToken);

                return new ImageGenerationResponse
                {
                    TaskId = task.Id,
                    Status = "å¤±è´¥",
                    Message = ex.Message,
                    IsAsync = false
                };
            }
        }
    }

    /// &lt;summary&gt;
    /// è·åå¾ççæä»»å¡çç¶æ
    /// &lt;/summary&gt;
    /// &lt;param name="taskId"&gt;è¦æ¥è¯¢çä»»å¡ ID&lt;/param&gt;
    /// &lt;returns&gt;ä»»å¡ç¶æåç»æï¼å¦æå·²å®æï¼&lt;/returns&gt;
    [McpServerTool(Name = "get_image_task_status")]
    [Description("è·åå¾ççæä»»å¡çç¶æ")]
    public async Task&lt;ImageGenerationResponse&gt; GetImageTaskStatus(
        [Description("è¦æ¥è¯¢çä»»å¡ ID")] string taskId,
        CancellationToken cancellationToken = default)
    {
        if (!Guid.TryParse(taskId, out var id))
        {
            return new ImageGenerationResponse
            {
                Status = "éè¯¯",
                Message = "ä»»å¡ ID æ ¼å¼æ æ"
            };
        }

        var task = await _dbContext.ImageGenerationTasks.FindAsync(new object[] { id }, cancellationToken);
        
        if (task == null)
        {
            return new ImageGenerationResponse
            {
                Status = "éè¯¯",
                Message = "æªæ¾å°ä»»å¡"
            };
        }

        return new ImageGenerationResponse
        {
            TaskId = task.Id,
            Status = task.Status.ToString().ToLowerInvariant(),
            Message = task.ErrorMessage ?? GetStatusMessage(task.Status),
            ImageBase64 = task.ImageData,
            ImageUrl = task.ImageUrl,
            IsAsync = !string.IsNullOrEmpty(task.HangfireJobId)
        };
    }

    private static string GetStatusMessage(ImageTaskStatus status)
    {
        return status switch
        {
            ImageTaskStatus.Pending =&gt; "ä»»å¡ç­å¾ä¸­",
            ImageTaskStatus.Processing =&gt; "ä»»å¡å¤çä¸­",
            ImageTaskStatus.Completed =&gt; "å¾ççææå",
            ImageTaskStatus.Failed =&gt; "å¾ççæå¤±è´¥",
            ImageTaskStatus.Cancelled =&gt; "ä»»å¡å·²åæ¶",
            _ =&gt; "æªç¥ç¶æ"
        };
    }
}

/// &lt;summary&gt;
/// å¾ççæååºæ¨¡å
/// &lt;/summary&gt;
public class ImageGenerationResponse
{
    public Guid? TaskId { get; set; }
    public required string Status { get; set; }
    public string? Message { get; set; }
    public string? ImageBase64 { get; set; }
    public string? ImageUrl { get; set; }
    public string? RevisedPrompt { get; set; }
    public bool IsAsync { get; set; }
}

</code></pre>
<p><strong>å®éé¡¹ç®ç¹ç¹</strong>ï¼</p>
<ol>
<li>
<p><strong>åæ¨¡å¼æ¯æ</strong>ï¼</p>
<ul>
<li>åæ­¥æ¨¡å¼ï¼ç«å³çæå¹¶è¿åç»æ</li>
<li>å¼æ­¥æ¨¡å¼ï¼ä½¿ç¨Hangfireåå°ä»»å¡ï¼å®æåéè¿é®ä»¶éç¥</li>
</ul>
</li>
<li>
<p><strong>å¤æ¸ éæ¨é</strong>ï¼</p>
<ul>
<li>éè¿SignalRæ¨éå°è®¾å¤ï¼CustomMessageï¼</li>
<li>éè¿é®ä»¶åéé¾æ¥</li>
</ul>
</li>
<li>
<p><strong>å¾çå­å¨</strong>ï¼</p>
<ul>
<li>åæ¶ä¿å­PNGåJPEGä¸¤ç§æ ¼å¼</li>
<li>å­å¨å°Azure Blob Storageææ¬å°æä»¶ç³»ç»</li>
</ul>
</li>
<li>
<p><strong>å®æ´çéè¯¯å¤çåæ¥å¿è®°å½</strong></p>
</li>
</ol>
<p><strong>è·åå®æ´ä»£ç </strong>ï¼</p>
<ul>
<li>
<p>ð§ ESP32è®¾å¤ç«¯ (å°æºå®æ´å®ç°):<br>
<a href="https://github.com/maker-community/xiaozhi-esp32" target="_blank" rel="noopener nofollow">https://github.com/maker-community/xiaozhi-esp32</a></p>
<ul>
<li>SignalRéæåæ¯ï¼<code>signalr</code> å <code>signalr-update-audio</code></li>
</ul>
</li>
<li>
<p>ð§ ESP32ç¤ºä¾å·¥ç¨ (åå«å®æ´çSignalRéæç¤ºä¾):<br>
<a href="https://github.com/maker-community/esp-signalr-example" target="_blank" rel="noopener nofollow">https://github.com/maker-community/esp-signalr-example</a></p>
</li>
<li>
<p>ð§ SignalR C++å®¢æ·ç«¯åº:<br>
<a href="https://github.com/maker-community/esp-signalr" target="_blank" rel="noopener nofollow">https://github.com/maker-community/esp-signalr</a><br>
<a href="https://github.com/maker-community/esp-signalr-example" target="_blank" rel="noopener nofollow">https://github.com/maker-community/esp-signalr-example</a></p>
</li>
<li>
<p>ð MCPæå¡å¨ç«¯:<br>
<a href="https://github.com/maker-community/verdure-mcp" target="_blank" rel="noopener nofollow">https://github.com/maker-community/verdure-mcp</a></p>
</li>
</ul>
<h2 id="å®éä½¿ç¨åºæ¯ç¤ºä¾">å®éä½¿ç¨åºæ¯ç¤ºä¾</h2>
<h3 id="åºæ¯1aiçå¾åæ¨éå°è®¾å¤">åºæ¯1ï¼AIçå¾åæ¨éå°è®¾å¤</h3>
<p>ç¨æ·éè¿å°æºå¯¹è¯ï¼"å¸®æçæä¸å¼ ç«åªçå¾ç"</p>
<ol>
<li>å¯¹è¯åéå°.NET MCPæå¡</li>
<li>MCPæå¡è°ç¨APIçæå¾ç</li>
<li>çæå®æåï¼åå°ä»»å¡è°ç¨hubåéæ¶æ¯</li>
<li>æå¡ç«¯éè¿SignalRæ¨éå¾çç»è¯¥ç¨æ·çææè®¾å¤</li>
<li>ESP32è®¾å¤æ¥æ¶å°<code>èªå®ä¹æ¶æ¯</code>äºä»¶ï¼ä¸è½½å¹¶æ¾ç¤ºå¨å±å¹ä¸</li>
</ol>
<h3 id="åºæ¯2æ­æ¾é³ä¹">åºæ¯2ï¼æ­æ¾é³ä¹</h3>
<p>ç¨æ·éè¿è¯­é³è¯´æ³è¦æ­æ¾é³ä¹ï¼mcpè¢«è§¦åï¼éæºéæ©é³ä¹urlæ¨éå°è®¾å¤</p>
<ol>
<li>å¯¹è¯åéå°.NET MCPæå¡</li>
<li>æå¡ç«¯éè¿SignalRæ¨éé³ä¹ç»è¯¥ç¨æ·çææè®¾å¤</li>
<li>ESP32è®¾å¤æ¥æ¶å°<code>èªå®ä¹æ¶æ¯</code>äºä»¶ï¼ä¸è½½å¹¶æ­æ¾è¯­é³</li>
</ol>
<h2 id="åå­ä¼åç»éªåäº«">åå­ä¼åç»éªåäº«</h2>
<blockquote>
<p><strong>è¯´æ</strong>ï¼æ¬ç« èåå®¹å¯¹äºå¨ESP32ä¸è¿è¡SignalRå®¢æ·ç«¯éå¸¸éè¦ï¼è¿äºé½æ¯å®è·µä¸­æ»ç»åºçç»éªã</p>
</blockquote>
<p>å¨ESP32ä¸éæSignalRç¡®å®éå°äºåå­é®é¢ï¼åäº«ä¸äºä¼åç»éªï¼</p>
<h3 id="1-ä½¿ç¨psramå­å¨å¤§å¯¹è±¡">1. ä½¿ç¨PSRAMå­å¨å¤§å¯¹è±¡</h3>
<pre><code class="language-cpp">// ä¸ºå¾çæ°æ®åéPSRAMåå­
void* imageBuffer = heap_caps_malloc(imageSize, MALLOC_CAP_SPIRAM);
if (imageBuffer == NULL) {
    // éçº§å°åé¨RAM
    imageBuffer = malloc(imageSize);
}
</code></pre>
<p>å¨VS Codeçmenuconfigä¸­å¯ç¨PSRAMï¼</p>
<ul>
<li><code>F1</code> â <code>ESP-IDF: SDK Configuration editor</code></li>
<li><code>Component config</code> â <code>ESP32-specific</code> â <code>Support for external, SPI-connected RAM</code></li>
</ul>
<h3 id="2-åå°jsonåºååæ¬¡æ°">2. åå°JSONåºååæ¬¡æ°</h3>
<pre><code class="language-cpp">// éè¯¯åæ³ï¼é¢ç¹åå»º/éæ¯cJSONå¯¹è±¡
for (int i = 0; i &lt; 100; i++) {
    cJSON* root = cJSON_Parse(jsonString);
    // å¤ç...
    cJSON_Delete(root);  // äº§çåå­ç¢ç
}

// æ­£ç¡®åæ³ï¼å¤ç¨å¯¹è±¡
cJSON* root = cJSON_Parse(jsonString);
for (int i = 0; i &lt; 100; i++) {
    // å¤ç...
}
cJSON_Delete(root);
</code></pre>
<h3 id="3-å¢å ä»»å¡æ å¤§å°">3. å¢å ä»»å¡æ å¤§å°</h3>
<p>SignalRçåè°åµå¥è¾æ·±ï¼éè¦å¢å æ ï¼</p>
<p>å¨menuconfigä¸­ï¼<code>Component config</code> â <code>ESP32-specific</code> â <code>Main task stack size</code> â è®¾ç½®ä¸º<code>8192</code></p>
<p>æå¨ä»£ç ä¸­ï¼</p>
<pre><code class="language-cpp">xTaskCreatePinnedToCore(
    signalr_task,
    "signalr",
    8192,  // æ å¤§å°ï¼å­èï¼
    NULL,
    5,     // ä¼åçº§
    NULL,
    1      // CPUæ ¸å¿
);
</code></pre>
<h2 id="æ»ç»ä¸ææ">æ»ç»ä¸ææ</h2>
<p>éè¿è¿æ¬¡SignalRç§»æ¤åéæçå®è·µï¼ææ·±å»ä½ä¼å°ï¼</p>
<ol>
<li>
<p><strong>éå¯¹æ¡æ¶å¾éè¦</strong>ï¼SignalRçç¾¤ç»ç®¡çãæ¶æ¯è·¯ç±ç­ç¹æ§ï¼çå»äºå¤§éåºç¡è®¾æ½ä»£ç ãå¦æä»å¤´æåWebSocketï¼è¿äºåè½å¾è±å å¨æ¶é´ã</p>
</li>
<li>
<p><strong>åå­ç®¡çæ¯åµå¥å¼æ°¸æçä¸»é¢</strong>ï¼ESP32çRAMéå¶è®©æå¯¹æ¯ä¸ä¸ªmallocé½æ ¼å¤å°å¿ãåçä½¿ç¨PSRAMãé¿ååå­ç¢çãåæ¶éæ¾èµæºï¼è¿äºå¨PCä¸ä¸ç¨careçé®é¢ï¼å¨åµå¥å¼ä¸é½æ¯åã</p>
</li>
<li>
<p><strong>AIè¾å©ç¼ç¨çé¦</strong>ï¼è¿æ¬¡é¡¹ç®ä¸­ï¼SignalR C++å®¢æ·ç«¯çç§»æ¤ãæ¶æ¯å¤çç­å¤§éä»£ç é½æ¯åå©AIçæçãè½ç¶çæçä»£ç éè¦è°è¯åä¼åï¼ä½ç¡®å®å¤§å¹æé«äºå¼åæçã</p>
</li>
<li>
<p><strong>æ¶æ¯æ¨éè§£å³å®éé®é¢</strong>ï¼ä¹åMCPå·¥å·åªè½åæ­¥è¿åç»æï¼ç°å¨éè¿SignalRï¼æå¡ç«¯å¯ä»¥ä¸»å¨æ¨éå¾çãè¯­é³ãéç¥ç»è®¾å¤ï¼ç¨æ·ä½éªæåææ¾ã</p>
</li>
<li>
<p><strong>.NETçæçå¼ºå¤§</strong>ï¼SignalRãEF CoreãJWTè®¤è¯â¦â¦å¾®è½¯è¿å¥çæççå¾å®åãä½ä¸º.NETå¼åèï¼è½ç¨çæçææ¯æ å¿«éæ­å»ºçäº§çº§æå¡ã</p>
</li>
</ol>
<p>è¿ä¸ªé¡¹ç®è¿æå¾å¤ä¼åç©ºé´ï¼æ¯å¦ï¼</p>
<ul>
<li>WebSocket Binary Protocolæ¿ä»£JSONåå°å¸¦å®½</li>
<li>å¼å¥Rediså­å¨ç¾¤ç»ä¿¡æ¯ï¼æ¯ææå¡ç«¯æ¨ªåæ©å±</li>
<li>ç»§ç»­å®åä»£ç è´¨éï¼è®©åºè½å¤è¢«æ´å¤çäººå³æ³¨ååä¸ï¼å¸æææ´å¤çäººæ¥å®éä½¿ç¨åä¼åã</li>
</ul>
<p>ä½ä½ä¸ºä¸ä¸ªåæ­¥è½ç¨çæ¹æ¡ï¼å·²ç»è¶³å¤æ¯æå°æºæºå¨äººçåè½æ©å±äºãåç»­æä¼ç»§ç»­å®åè¿å¥æ¶æï¼æ¬¢è¿å¤§å®¶ä¸èµ·æ¢è®¨åè´¡ç®ä»£ç ï¼</p>
<p>å¸æè¿ç¯æç« è½ç»å¤§å®¶å¨.NET IoTå¼åãSignalRå®æ¶éä¿¡æ¹é¢å¸¦æ¥ä¸äºå¯åãå¦ææé®é¢æ¬¢è¿å¨è¯è®ºåºè®¨è®ºï¼è®©æä»¬ä¸èµ·æ¢ç´¢.NETå¨IoTé¢åçæ´å¤å¯è½æ§ï¼</p>
<h2 id="ææesp32å°æºå¨äºº">ææESP32å°æºå¨äºº</h2>
<p>å¦æä½ æææEsp32çç¡¬ä»¶æç®ï¼å¯ä»¥å³æ³¨æçBç«è´¦å·ï¼ç»¿è«é¿å¹¿ï¼<br>
<a href="https://space.bilibili.com/25228512" target="_blank" rel="noopener nofollow">https://space.bilibili.com/25228512</a></p>
<p><img src="https://img2024.cnblogs.com/blog/1690009/202602/1690009-20260201141614219-406532144.png" alt="img" loading="lazy"></p>
<h2 id="é¡¹ç®å°å">é¡¹ç®å°å</h2>
<h3 id="esp32ç¸å³-1">ESP32ç¸å³</h3>
<ul>
<li>
<p><strong>SignalR C++å®¢æ·ç«¯åº</strong>ï¼<br>
<a href="https://github.com/maker-community/esp-signalr" target="_blank" rel="noopener nofollow">https://github.com/maker-community/esp-signalr</a></p>
</li>
<li>
<p><strong>å°æºESP32å®æ´å®ç°</strong> (signalr-update-audioåæ¯):<br>
<a href="https://github.com/maker-community/xiaozhi-esp32" target="_blank" rel="noopener nofollow">https://github.com/maker-community/xiaozhi-esp32</a></p>
</li>
<li>
<p><strong>ESP32 SignalRå®æ´ç¤ºä¾å·¥ç¨</strong> (åå«é³é¢ååãè®¾å¤æ§å¶APIç­):<br>
<a href="https://github.com/maker-community/esp-signalr-example" target="_blank" rel="noopener nofollow">https://github.com/maker-community/esp-signalr-example</a></p>
<ul>
<li><a href="https://github.com/maker-community/esp-signalr-example/tree/main/signalr-server" target="_blank" rel="noopener nofollow">æå¡ç«¯ä»£ç </a></li>
<li><a href="https://github.com/maker-community/esp-signalr-example/tree/main/main" target="_blank" rel="noopener nofollow">å®¢æ·ç«¯ä»£ç </a></li>
</ul>
</li>
</ul>
<h3 id="netæå¡ç«¯">.NETæå¡ç«¯</h3>
<ul>
<li><strong>Verdure MCPæå¡</strong> (åå«å®æ´çHubãToolsãServiceså®ç°):<br>
<a href="https://github.com/maker-community/verdure-mcp" target="_blank" rel="noopener nofollow">https://github.com/maker-community/verdure-mcp</a></li>
<li><strong>å°æºmcpè½¬æ¥å¹³å°</strong>ï¼</li>
<li><a href="https://github.com/maker-community/verdure-mcp-for-xiaozhi" target="_blank" rel="noopener nofollow">https://github.com/maker-community/verdure-mcp-for-xiaozhi</a></li>
</ul>
<h3 id="åèèµæ">åèèµæ</h3>
<ul>
<li><strong>SignalR Client C++ (å¾®è½¯å®æ¹)</strong>:<br>
<a href="https://github.com/aspnet/SignalR-Client-Cpp" target="_blank" rel="noopener nofollow">https://github.com/aspnet/SignalR-Client-Cpp</a></li>
<li><strong>SignalR Client C# nanoframework</strong>:<br>
<a href="https://github.com/nanoframework/nanoFramework.SignalR.Client" target="_blank" rel="noopener nofollow">https://github.com/nanoframework/nanoFramework.SignalR.Client</a></li>
</ul>
<h2 id="åèææ¡£">åèææ¡£</h2>
<ol>
<li><a href="https://docs.microsoft.com/zh-cn/aspnet/core/signalr/" target="_blank" rel="noopener nofollow">ASP.NET Core SignalR å®æ¹ææ¡£</a></li>
<li><a href="https://github.com/dotnet/aspnetcore/blob/main/src/SignalR/docs/specs/HubProtocol.md" target="_blank" rel="noopener nofollow">SignalR Hub åè®®è§è</a></li>
<li><a href="https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/" target="_blank" rel="noopener nofollow">ESP-IDF ç¼ç¨æå</a></li>
<li><a href="https://github.com/espressif/vscode-esp-idf-extension" target="_blank" rel="noopener nofollow">VS Code ESP-IDF æä»¶</a></li>
<li><a href="https://jwt.io/introduction" target="_blank" rel="noopener nofollow">JWT è®¤è¯æä½³å®è·µ</a></li>
<li><a href="https://www.keycloak.org/docs/latest/securing_apps/" target="_blank" rel="noopener nofollow">Keycloak è®¤è¯éææå</a></li>
</ol>
<hr>
<p><em>æ¬æé¦åäºä¸ªäººææ¯åå®¢ï¼è½¬è½½è¯·æ³¨æåºå¤ãå¦æå¯¹.NET IoTå¼åãSignalRå®æ¶éä¿¡æå´è¶£ï¼æ¬¢è¿å³æ³¨æçåå®¢è·åæ´å¤ææ¯åäº«ï¼</em></p>


</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-02-01 15:34">2026-02-01 15:33</span>&nbsp;
<a href="https://www.cnblogs.com/GreenShade">ç»¿è«é¿å¹¿</a>&nbsp;
éè¯»(<span id="post_view_count">0</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19560338);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19560338', targetLink: 'https://www.cnblogs.com/GreenShade/p/19560338', title: 'å°SignalRç§»æ¤å°Esp32âè®©å°æºè®¾å¤æ ç¼è¿æ¥.NETåè½æå±MCPæå¡' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ LLVM Passå¿«éå¥é¨(ä¸)ï¼æå»ºç¼è¯ç¯å¢ ]]></title>
    <link>https://www.cnblogs.com/ClownLMe/p/19560726</link>
    <guid>65616c132f77287edc5dc9311964ff0d</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/ClownLMe/p/19560726" title="åå¸äº 2026-02-01 14:36">
    <span role="heading" aria-level="2">LLVM Passå¿«éå¥é¨(ä¸)ï¼æå»ºç¼è¯ç¯å¢</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h1 id="ç®ä»">ç®ä»</h1>
<p><strong>LLVM</strong> æ¯ä¸ä¸ªç¼è¯æ¡æ¶å·¥å·ï¼æ¯æç¼è¯è¿ç¨æè§£æäºé«åº¦æ ååçç»ä»¶ã</p>
<p><mark><strong>æ¬æç¨æä½¿ç¨çç¯å¢æ¯windows11, vs2022</strong></mark></p>
<h1 id="è®¤è¯llvm">è®¤è¯LLVM</h1>
<p>LLVM ææåçå°æ¹å¨äºå®å®ä¹äºä¸ç§æå¶å®ç¾çä¸­é´è¯­è¨<strong>LLVM IR</strong>ï¼LLVMåä¸ºåç«¯ï¼ä¼åå¨ï¼åç«¯ï¼</p>
<ul>
<li><strong>åç«¯</strong>ï¼è´è´£ææºä»£ç ï¼C/C++ãRustãGoï¼ç¿»è¯æ LLVM IRãæ¯å¦ <code>Clang</code>ã</li>
<li><strong>ä¼åå¨</strong>ï¼è¿æ¯ LLVM ççµé­ãå®åªå¤ç IRï¼ä¸å³å¿æºç æ¯ä»ä¹è¯­è¨ï¼ä¹ä¸å³å¿ç®æ æ¯ä»ä¹æºå¨ãä½ åç <strong>Pass</strong> å°±è¿è¡å¨è¿éã</li>
<li><strong>åç«¯</strong>ï¼è´è´£æä¼ååç IR ç¿»è¯æå·ä½çæºå¨ç ï¼x86ãARMãRISC-Vï¼ãæ¯å¦ <code>LLC</code>ã</li>
</ul>
<p>LLVMçä¸ç«¯æ¶æï¼æä»¬è½å¤å¾æ¹ä¾¿çèªå®ä¹ç¼è¯å¨ï¼<mark><strong>æ¬ç³»ç±»æç¨ä¸»è¦æå­¦ä¼åå¨çpassç¼å</strong></mark></p>
<h1 id="ç¯å¢éç½®">ç¯å¢éç½®</h1>
<h3 id="éè¦åå¤çå·¥å·">éè¦åå¤çå·¥å·</h3>
<ol>
<li><strong>git</strong> : <a href="https://git-scm.com/install/" target="_blank" rel="noopener nofollow">https://git-scm.com/install/</a> æåé¡¹ç®</li>
<li><strong>visual studio</strong> : <a href="https://visualstudio.microsoft.com/zh-hans/" target="_blank" rel="noopener nofollow">https://visualstudio.microsoft.com/zh-hans/</a> éè¦å®è£<code>c/c++æ¡é¢å¼å</code>ç»ä»¶ï¼ç¼è¯ç¯å¢</li>
<li><strong>cmake</strong>ï¼ <a href="https://cmake.org/" target="_blank" rel="noopener nofollow">https://cmake.org/</a> æå»ºé¡¹ç®</li>
<li><strong>ninja</strong> : <a href="https://github.com/ninja-build/ninja" target="_blank" rel="noopener nofollow">https://github.com/ninja-build/ninja</a> å éç¼è¯</li>
</ol>
<h3 id="æållvmå¹¶éç½®">æåLLVMå¹¶éç½®</h3>
<p>è¿éæä¿å­å¨Dç</p>
<pre><code class="language-bash">#åå»ºæä»¶å¤¹
mkdir D:\LLVM 
cd D:\LLVM 
#æåæºç  (åªæåæ ¸å¿ä»åºï¼ä¸éè¦ submoduleï¼ç°å¨ LLVM æ¯ monorepo) 
#è¿ä¸æ­¥æ¯è¾å¤§ï¼ç½ç»ä¸å¥½è¯·ææ¢¯å­ 
git clone --depth=1 https://github.com/llvm/llvm-project.git
#åå»ºæå»ºç®å½
cd llvm-project 
mkdir build 
cd build
</code></pre>
<h3 id="æå»ºå¹¶ç¼è¯">æå»ºå¹¶ç¼è¯</h3>
<p><strong>è¿ééè¦æå¼ååä¸è½½å¥½<code>visual studio</code>çå·¥ä½å°ï¼æè¿éæ¯<code>x64 Native Tools Command Prompt for VS 2022</code></strong><br>
<mark><strong>æ³¨æï¼å¼å§ç¼è¯éè¦é¢ç30-60Gç¡¬çç©ºé´ï¼ç¼è¯éè¦30åéå·¦å³</strong></mark></p>
<pre><code class="language-bash">#å©ç¨cmakeæå»ºé¡¹ç®
cmake -G "Ninja" ^ #ä½¿ç¨ninjaç¼è¯
-DLLVM_ENABLE_PROJECTS="clang" ^ #åªç¼è¯clangèçç©ºé´
-DLLVM_TARGETS_TO_BUILD="X86" ^ #åªç¼è¯x86åç«¯ï¼è¿èçå¤§é¨åç¼è¯æ¶é´ï¼é¤éè¦æarmæèå®å
-DCMAKE_BUILD_TYPE="RelWithDebInfo" ^ #Relaseçæ¬æ æ³è°è¯ï¼debugçæ¬å¤ªå¤§å¤ªæ¢äºï¼è¿ééæ©å¸¦è°è¯ç¬¦å·çrelaseçæ¬
-DLLVM_OPTIMIZED_TABLEGEN=ON ^ 
-DLLVM_ENABLE_ASSERTIONS=ON ^ #å¼å¯ä»£ç æ­è¨ãå½passåéæ¶ï¼ä¼æ¥éèä¸æ¯ç´æ¥å´©æº
../llvm
#ç¼è¯
ninja
</code></pre>
<h3 id="æ·»å ç¯å¢åé">æ·»å ç¯å¢åé</h3>
<p>è¿ä¸æ­¥æ¹ä¾¿ä¹åçä½¿ç¨</p>
<pre><code class="language-bash">#å°ååç¼è¯å¥½çç¯å¢å å¥ç¯å¢åé
D:\LLVM\llvm-project\build\bin
</code></pre>
<h3 id="ç®åéªè¯ç¯å¢">ç®åéªè¯ç¯å¢</h3>
<pre><code class="language-bash">clang --version
opt --version
</code></pre>
<p>ä¸è¬æ¥è¯´ï¼è·çä¸é¢æ­¥éª¤èµ° å¹¶ä¸ ç³»ç»åvsçæ¬ä¸æ ·å°è¿æ¯ä¸ä¼æ¥éçã</p>
<h1 id="éªè¯ç¯å¢">éªè¯ç¯å¢</h1>
<p>ä¸é¢ç¼è¯ä¸ä¸ª<code>test.c</code>æ¥éªè¯ç¯å¢æ¯å¦æ­£å¸¸ã</p>
<pre><code class="language-c">#include &lt;stdio.h&gt;

int add(int a, int b) {
&nbsp; &nbsp; return a + b + 5;
}

int main(){
&nbsp; &nbsp; printf("add(1, 2) = %d\n", add(1, 2));
&nbsp; &nbsp; return 0;
}
</code></pre>
<h3 id="ç¼è¯ä»£ç ">ç¼è¯ä»£ç </h3>
<h5 id="c-ç¼è¯ä¸ºllvm-ir">C ç¼è¯ä¸ºLLVM IR</h5>
<pre><code class="language-bash">clang -S -emit-llvm -O0 test.c -o test.ll
</code></pre>
<p>è§å¯IRï¼</p>
<pre><code class="language-c">......
define dso_local i32 @main() #0 {
entry:
&nbsp; %retval = alloca i32, align 4
&nbsp; store i32 0, ptr %retval, align 4
&nbsp; %call = call i32 @add(i32 noundef 1, i32 noundef 2)
&nbsp; %call1 = call i32 (ptr, ...) @printf(ptr noundef @"??_C@_0BA@OMPDDIF@add?$CI1?0?52?$CJ?5?$DN?5?$CFd?6?$AA@", i32 noundef %call)
&nbsp; ret i32 0
}
......
</code></pre>
<h5 id="llvm-ir-ç¼è¯ä¸ºå¯æ§è¡æä»¶">LLVM IR ç¼è¯ä¸ºå¯æ§è¡æä»¶</h5>
<p>ç¼è¯ä¸ºå¯æ§è¡æä»¶å¹¶æ­£å¸¸è¿è¡</p>
<pre><code class="language-bash">clang test.c -o test.exe
</code></pre>
<p><strong>å¦æâ¤åæ¬¢â¤æ¬ç³»åæç¨ï¼å°±ç¹ä¸ªå³æ³¨å§ï¼åç»­ä¸å®ææ´æ°~</strong></p>


</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-02-01 14:36">2026-02-01 14:36</span>&nbsp;
<a href="https://www.cnblogs.com/ClownLMe">ClownLMe</a>&nbsp;
éè¯»(<span id="post_view_count">0</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19560726);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19560726', targetLink: 'https://www.cnblogs.com/ClownLMe/p/19560726', title: 'LLVM Passå¿«éå¥é¨(ä¸)ï¼æå»ºç¼è¯ç¯å¢' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ ä»0å°1ï¼å¿«éè®­ç»å¹¶ä½¿ç¨YOLOæ¨¡å ]]></title>
    <link>https://www.cnblogs.com/ClownLMe/p/19559180</link>
    <guid>65df351b854a545c186b8f26d64191cd</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/ClownLMe/p/19559180" title="åå¸äº 2026-01-31 21:54">
    <span role="heading" aria-level="2">ä»0å°1ï¼å¿«éè®­ç»å¹¶ä½¿ç¨YOLOæ¨¡å</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h1 id="ç®ä»">ç®ä»</h1>
<p><strong>YOLO</strong>æ¯ç®åè®¡ç®æºè§è§é¢åæåæ²¿ãåºç¨æå¹¿æ³ç<strong>ç®æ æ£æµ</strong>ç®æ³æ¡æ¶ï¼ä»è½å¿«éè¯å«åºåç®æ ï¼å¹¿æ³åºç¨äºæ¸¸æï¼æ äººé©¾é©¶ï¼å·¥ä¸ç­é¢åã</p>
<p>ä»¥è¯å«èº²é¿æè½æ»åçæ¸¸æçç©ä½å¾çä½ä¸ºä¾å­ã</p>
<h1 id="ä¸ç¯å¢éç½®">ä¸ï¼ç¯å¢éç½®</h1>
<pre><code class="language-bash">pip install ultralytics
</code></pre>
<h1 id="äºåå¤æ°æ®é">äºï¼åå¤æ°æ®é</h1>
<p>è¿ä¸ªæ ¼å¼ç®å½å¦ä¸ï¼</p>
<pre><code class="language-bash">my_dataset/
âââ data.yaml # éç½®æä»¶ï¼å®ä¹è·¯å¾åç±»å«ï¼
âââ train/ #è®­ç»æ°æ®é
â   âââ images/ # è®­ç»å¾ç
â   âââ labels/ # æ æ³¨æä»¶ (.txt)
âââ val/ #éªè¯æ°æ®é
    âââ images/ 
    âââ labels/ 
</code></pre>
<h3 id="datayml">data.yml</h3>
<pre><code class="language-yaml">path: D:\D_MyProject\Ai\game_ai\my_dataset #æ°æ®éè·¯å¾
train: train/images #è®­ç»éå¾çè·¯å¾
val: val/images #éªè¯éå¾çè·¯å¾

nc: 3 #æ è®°ä¸ªæ°
names:  #æ¯ä¸ªæ è®°çåç§°
&nbsp; 0: player
&nbsp; 1: enemy
&nbsp; 2: game_over
</code></pre>
<h3 id="ä¸é¢æ¯ç¨aiçæäºæ°æ®éççæèæ¬">ä¸é¢æ¯ç¨AIçæäºæ°æ®éççæèæ¬</h3>
<p><mark>æ°æ®éå¤ªå¤äºï¼è¿éä¸ºäºæ¼ç¤ºï¼æèå­¦ä¹ ï¼å¯ä»¥ç´æ¥ä½¿ç¨ä¸é¢èæ¬</mark></p>
<pre><code class="language-python">import pygame
import random
import sys
import os
import shutil

# =================éç½®åºå=================
# æ°æ®éæ ¹ç®å½åç§°
DATASET_ROOT = "my_dataset"
# ééæ»æ°é
MAX_IMAGES = 1000
# è®­ç»éå æ¯ (0.8 = 80% è®­ç», 20% éªè¯)
TRAIN_RATIO = 0.8

# ================= 1. ç¯å¢æ¸çä¸ç®å½åå»º =================
print(f"ð æ­£å¨åå§åæ°æ®éç®å½: {DATASET_ROOT} ...")

# å¦æç®å½å·²å­å¨ï¼åå é¤ï¼é²æ­¢æ§æ°æ®æ··å¥ï¼ï¼ç¡®ä¿æ°æ®çº¯å
if os.path.exists(DATASET_ROOT):
    shutil.rmtree(DATASET_ROOT)

# åå»º YOLO æ åç®å½ç»æ
for split in ['train', 'val']:
    os.makedirs(os.path.join(DATASET_ROOT, split, 'images'), exist_ok=True)
    os.makedirs(os.path.join(DATASET_ROOT, split, 'labels'), exist_ok=True)

# ================= 2. èªå¨çæ data.yaml =================
yaml_content = f"""
path: {os.path.abspath(DATASET_ROOT)} # ä½¿ç¨ç»å¯¹è·¯å¾ï¼é²æ­¢æ¥é
train: train/images
val: val/images

nc: 3
names:
  0: player
  1: enemy
  2: game_over
"""
with open(os.path.join(DATASET_ROOT, "data.yaml"), "w", encoding='utf-8') as f:
    f.write(yaml_content)
print("â data.yaml éç½®æä»¶å·²çæã")

# ================= 3. æ¸¸æä¸ééé»è¾ =================
pygame.init()
WIDTH, HEIGHT = 800, 600
# ä½¿ç¨ hidden æ¨¡å¼ææ­£å¸¸æ¨¡å¼åå¯ï¼è¿éç¨æ­£å¸¸æ¨¡å¼æ¹ä¾¿ä½ çå°è¿åº¦
screen = pygame.display.set_mode((WIDTH, HEIGHT))
pygame.display.set_caption("Auto Data Generator")
clock = pygame.time.Clock()

font_big = pygame.font.SysFont("monospace", 50)
font_small = pygame.font.SysFont("monospace", 35)

# æ¸¸æç¶æ
player_size, enemy_size = 50, 50
player_x = WIDTH // 2
player_y = HEIGHT - player_size - 10
enemies = []

img_count = 0
GAMEPLAY_LIMIT = int(MAX_IMAGES * 0.9) # 90% æ­£å¸¸æ¸¸æï¼10% Game Over

print(f"ð¸ å¼å§éé {MAX_IMAGES} å¼ å¾ç (èªå¨åå Train/Val)...")

while img_count &lt; MAX_IMAGES:
    # å¤çéåºäºä»¶ï¼é²æ­¢å¡æ­»
    for event in pygame.event.get():
        if event.type == pygame.QUIT:
            pygame.quit()
            sys.exit()

    screen.fill((0, 0, 0))
    labels = [] # å­å¨å½åå¸§çæ ç­¾
    dw, dh = 1.0 / WIDTH, 1.0 / HEIGHT # å½ä¸åç³»æ°

    # --- é»è¾åæ¯ï¼æ­£å¸¸æ¸¸æ vs Game Over ---
    if img_count &lt; GAMEPLAY_LIMIT:
        # A. æ­£å¸¸æ¸¸æç»é¢
        # 1. ç©å®¶ç§»å¨
        if random.random() &lt; 0.2: # å¢å ç§»å¨é¢ç
            player_x += random.choice([-15, 15])
            player_x = max(0, min(WIDTH - player_size, player_x))

        # 2. æäººçæä¸ç§»å¨
        if random.randint(0, 20) == 0: # å¢å æäººå¯åº¦
            enemies.append([random.randint(0, WIDTH - enemy_size), 0])
        
        for enemy in enemies: enemy[1] += 15 # å å¿«ä¸è½éåº¦
        enemies = [e for e in enemies if e[1] &lt; HEIGHT]

        # 3. ç»å¶ç©å®¶ (Class 0)
        pygame.draw.rect(screen, (50, 150, 255), (player_x, player_y, player_size, player_size))
        # è®¡ç® YOLO åæ  (class x_center y_center width height)
        px, py = (player_x + player_size/2) * dw, (player_y + player_size/2) * dh
        labels.append(f"0 {px:.6f} {py:.6f} {player_size*dw:.6f} {player_size*dh:.6f}")

        # 4. ç»å¶æäºº (Class 1)
        for e in enemies:
            pygame.draw.rect(screen, (255, 50, 50), (e[0], e[1], enemy_size, enemy_size))
            ex, ey = (e[0] + enemy_size/2) * dw, (e[1] + enemy_size/2) * dh
            labels.append(f"1 {ex:.6f} {ey:.6f} {enemy_size*dw:.6f} {enemy_size*dh:.6f}")

    else:
        # B. Game Over ç»é¢ (Class 2)
        text_surf = font_big.render("GAME OVER", True, (255, 50, 50))
        
        # éæºæå¨ä½ç½®ï¼é²æ­¢è¿æå
        off_x, off_y = random.randint(-50, 50), random.randint(-50, 50)
        text_x = WIDTH // 2 - text_surf.get_width() // 2 + off_x
        text_y = HEIGHT // 2 - 100 + off_y
        screen.blit(text_surf, (text_x, text_y))

        # å¹²æ°é¡¹
        score_surf = font_small.render(f"Score: {random.randint(0,999)}", True, (255,255,255))
        screen.blit(score_surf, (WIDTH//2 - score_surf.get_width()//2, HEIGHT//2 + 50))

        # è®°å½æ ç­¾
        tw, th = text_surf.get_width(), text_surf.get_height()
        tx, ty = (text_x + tw/2) * dw, (text_y + th/2) * dh
        labels.append(f"2 {tx:.6f} {ty:.6f} {tw*dw:.6f} {th*dh:.6f}")

    # ================= 4. ä¿å­é»è¾ (æ ¸å¿ä¿®æ¹) =================
    pygame.display.flip()
    
    # éæ ·çï¼ä¸æ¯æ¯ä¸å¸§é½ä¿å­ï¼é²æ­¢éå¤åº¦è¿é« (è¿éè®¾ä¸º 30% æ¦çä¿å­)
    if random.random() &lt; 0.3:
        # A. å³å®æ¯å» Train è¿æ¯ Val
        split_folder = "train" if random.random() &lt; TRAIN_RATIO else "val"
        
        # B. çææä»¶å
        filename = f"{img_count:06d}"
        img_save_path = os.path.join(DATASET_ROOT, split_folder, "images", f"{filename}.jpg")
        lbl_save_path = os.path.join(DATASET_ROOT, split_folder, "labels", f"{filename}.txt")

        # C. ä¿å­å¾ç
        pygame.image.save(screen, img_save_path)

        # D. ä¿å­æ ç­¾
        with open(lbl_save_path, "w") as f:
            f.write("\n".join(labels))

        img_count += 1
        
        # æå°è¿åº¦æ¡
        print(f"[{split_folder.upper()}] è¿åº¦: {img_count}/{MAX_IMAGES}", end="\r")

    # å éæ¨¡æï¼ä¸è¦åç´åæ­¥ï¼è¶å¿«è¶å¥½
    clock.tick(0) 

pygame.quit()
print(f"\n\nâ¨ å¨é¨å®æï¼æ°æ®éå·²å°±ç»ªï¼{os.path.abspath(DATASET_ROOT)}")
print("ð¡ ä¸ä¸æ­¥ï¼ç´æ¥è¿è¡ model.train(data='my_dataset/data.yaml')")
</code></pre>
<h1 id="ä¸è®­ç»yoloæ¨¡å">ä¸ï¼è®­ç»YOLOæ¨¡å</h1>
<p>å¯ä»¥çå°ï¼ä½¿ç¨<code>ultralytics</code>æ¡æ¶è®­ç»YOLOçä»£ç éå¸¸ç®åï¼åªéè¦å è¡<br>
<mark><strong>æ³¨æï¼è¿éYOLOä¼èªå¨ä¸è½½æ¨¡åå¹¶è®­ç»ï¼ä¸è½½æ¶å¤±è´¥å¯è½éè¦ææ¢¯å­</strong></mark></p>
<pre><code class="language-python">from ultralytics import YOLO

def train_model():
    #å è½½æ¨¡å
    model = YOLO("yolo11n.pt") 

    #å¼å§è®­ç»
    print("å¼å§è®­ç»...")
    results = model.train(
        data="my_dataset/data.yaml", #æ°æ®ééç½®æä»¶
        epochs=30, #è®­ç»è½®æ°
        imgsz=640, #å¾çè¾å¥å°ºå¯¸
        batch=16, #æ¾å­å¤å¤§å¯ä»¥æ¹å¤§ï¼æ¯å¦ 32 æ 64
        device=0, #å¼ºå¶ä½¿ç¨ç¬¬ä¸å¼ æ¾å¡ (éè¦CUDA)
        workers=0, #Windowsä¸è®¾ä¸º0é²æ­¢å¤è¿ç¨æ¥é
        project="dodge_project",#ä¿å­è·¯å¾
        name="ai_model" #è®­ç»è¿è¡åç§°
    )
    print(f"è®­ç»å®æï¼æä½³æ¨¡åä¿å­å¨: {results.save_dir}/weights/best.pt")

if __name__ == "__main__":
    train_model()
</code></pre>
<h1 id="åä½¿ç¨yoloæ¨¡å">åï¼ä½¿ç¨YOLOæ¨¡å</h1>
<pre><code class="language-python">from ultralytics import YOLO

#éç½®è·¯å¾
MODEL_PATH = "dodge_project/ai_model/weights/best.pt" 
PIC_PATH = "my_dataset/val/images/000045.jpg"

#å è½½æ¨¡å
model = YOLO(MODEL_PATH)
print(f"æ¨¡åå è½½æå")

#è¯å«å¾ç
results = model.predict(PIC_PATH, verbose=False, conf=0.4, imgsz=640)
result = results[0]

#è·åä¿¡æ¯å¹¶æå°
for box in result.boxes:
    # è·ååæ  (x1, y1, x2, y2)ãç±»å« ID åç½®ä¿¡åº¦
    x1, y1, x2, y2 = map(int, box.xyxy[0])
    cls_id = int(box.cls[0])
    conf = float(box.conf[0])
    
    # ç±»å«åç§°æ å°
    names = {0: "Player", 1: "Enemy", 2: "Game Over"}
    label = names.get(cls_id, f"Unknown({cls_id})")
    print(f"æ¾å°ç©ä½: [{label:10}] | ç½®ä¿¡åº¦: {conf:.2f} | åæ : ({x1}, {y1}) -&gt; ({x2}, {y2})")

#å±ç¤ºå¾ç
result.show()
</code></pre>
<p><strong>å¦æâ¤åæ¬¢â¤æ¬ç³»åæç¨ï¼å°±ç¹ä¸ªå³æ³¨å§ï¼åç»­ä¸å®ææ´æ°~</strong></p>


</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-01-31 21:55">2026-01-31 21:54</span>&nbsp;
<a href="https://www.cnblogs.com/ClownLMe">ClownLMe</a>&nbsp;
éè¯»(<span id="post_view_count">101</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19559180);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19559180', targetLink: 'https://www.cnblogs.com/ClownLMe/p/19559180', title: 'ä»0å°1ï¼å¿«éè®­ç»å¹¶ä½¿ç¨YOLOæ¨¡å' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ ãä¿å§çº§æç¨ãææææä½ å®è£OpenClawå¹¶æ¥å¥é£ä¹¦ï¼è®©AIå¨èå¤©è½¯ä»¶éå¸®ä½ å¹²æ´» ]]></title>
    <link>https://www.cnblogs.com/weipo0105/p/19558953</link>
    <guid>bb71077863ac0e0d0386573412360a1d</guid>
    <description>
    <![CDATA[ 
		<h1 class="postTitle">
			<a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/weipo0105/p/19558953" title="åå¸äº 2026-01-31 19:50">
    <span role="heading" aria-level="2">ãä¿å§çº§æç¨ãææææä½ å®è£OpenClawå¹¶æ¥å¥é£ä¹¦ï¼è®©AIå¨èå¤©è½¯ä»¶éå¸®ä½ å¹²æ´»</span>
    

</a>

		</h1>
		<div class="clear"></div>
		<div class="postBody">
			    <div id="cnblogs_post_description" style="display: none">
        <img src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131195003333-854515303.png" alt="ãä¿å§çº§æç¨ãææææä½ å®è£OpenClawå¹¶æ¥å¥é£ä¹¦ï¼è®©AIå¨èå¤©è½¯ä»¶éå¸®ä½ å¹²æ´»" class="desc_img">
        OpenClaw æ¯ä¸æ¬¾è½ç´æ¥æä½ä½ çµèçå¼æºAIå©æï¼ä¸æ­¢äºèå¤©ï¼æ´è½æ¿ä½ æ§è¡ä»»å¡ãæ¬ææä¾ä¸ä»½ä¿å§çº§æç¨ï¼ä»é¶å¼å§ï¼è¯¦ç»æ¼ç¤ºå¦ä½å¨ Windows ç³»ç»ä¸å®æ OpenClaw çå®è£ãåå§éç½®ï¼å¹¶éç¹ä¸æ­¥æ­¥æä½ æ¥å¥é£ä¹¦æºå¨äººï¼æç»å®ç°å¨é£ä¹¦Appä¸­ç´æ¥ææ¥ä½ çAIå©æå¤çå·¥ä½ãè·éå¾ææå¼ï¼è½»æ¾æ¥æä½ çä¸ªäººâè´¾ç»´æ¯âã
    </div>
<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<p>è¿éååä¸ä¸ç®åçç§æ®ï¼</p>
<p><code>OpenClaw</code> çåå­ç»åäºä¸æ¬¡åæ´ï¼ç¬¬ä¸æ¬¡å«å <code>ClawdBot</code>ï¼åæ¥å ä¸ºåå­è· <code>Claude</code> å¤ªè¿ç¸ä¼¼ï¼è¢« <code>CLaude</code> åä¾µæï¼éæ¹å <code>MoltBot</code> ã</p>
<p>ä½æ¯åæ¥å¨æ¹åè¿ç¨ä¸­é­éåååç¤¾äº¤è´¦å·è¢«æ¢æ³¨ï¼çè³åºåååå å¯è´§å¸å²é­èçæåµï¼å¯¼è´åç§°ä¼ æ­åé»ã</p>
<p>æç»å®åä¸ºï¼<strong>OpenClaw</strong>ã</p>
<p>æä»¥ï¼åå­ç»åååé¡ºåºä¸ºï¼ClawdBot -&gt; MoltBot -&gt; OpenClaw</p>
<p>å¤§å®¶ä¸è¦å ä¸ºåå­å°æäºï¼æçæ¯ä¸æ¯èªå·±ä¸éè½¯ä»¶äºï¼ä»ä»¬é½æ¯åä¸ä¸ªã</p>
<h1 id="ä¸ä»ä¹æ¯-openclaw">ä¸ãä»ä¹æ¯ OpenClawï¼</h1>
<p><strong>OpenClaw</strong>ï¼æ¾ç¨å Clawdbotï¼æ¯ä¸æ¬¾ 2026 å¹´çç«çå¼æºä¸ªäºº AI å©æï¼GitHub ææ å·²è¶è¿ 10 ä¸é¢ãä¸ä¼ ç» AI èå¤©æºå¨äººçæ ¹æ¬åºå«å¨äºï¼</p>
<ul>
<li><strong>çæ­£çæ§è¡è½å</strong>ï¼ä¸ä»è½åç­é®é¢ï¼è¿è½å®éæä½ä½ ççµè</li>
<li><strong>24/7 å¨å¤©åå¾å½</strong>ï¼å¨ä½ ç¡è§æ¶ä¹è½ä¸»å¨å®æä»»å¡</li>
<li><strong>å®å¨å¼æºåè´¹</strong>ï¼æ°æ®å®å¨ææ§å¨èªå·±æä¸­</li>
<li><strong>æ¯æå¤ç§éè®¯å¹³å°</strong>ï¼å¨å½å¤ï¼WhatsAppãTelegramãDiscordãSlackãiMessage ç­ï¼å¨å½åï¼é£ä¹¦ï¼ééç­åå¤§ååçå³æ¶èå¤©è½¯ä»¶å·²ç»æ¯ææ¥å¥</li>
</ul>
<p><strong>å®è½åä»ä¹ï¼</strong></p>
<p>å®ä¸åªæ¯åç­é®é¢çèå¤©æºå¨äººï¼èæ¯ççè½å¨ä½ çµèä¸å¨ææä½ãæ¯å¦ä½ åè¯å®âå¸®ææ´çä¸ä¸ä¸ä¸ªæçé®ä»¶âï¼å®å°±é»é»å»å¤çäºï¼ä½ ç¡è§æ¶ï¼å®è¿è½ç»§ç»­å¹²æ´»ï¼éè®¢å¹¿åãé¢çº¦è¡ç¨ãçè³æ¾æ¾ Bugã</p>
<p>å®å®å¨åè´¹ï¼ä½ çæ°æ®é½å¨èªå·±æéãèä¸å¯ä»¥ç¨ééï¼é£ä¹¦ï¼WhatsAppãTelegramç­åç±»å³æ¶éè®¯è½¯ä»¶æ¥ææ¥ä»å¹²æ´»ï¼</p>
<p>ç®åæ¥è¯´ï¼ä¸å¥è¯äº¤ç»å®ï¼ä»æ´çæ¡é¢æä»¶å°æ§å¶å®¶éç¯åï¼å®é½é»é»å¸®ä½ æå®ãæ¯ä½ çµèéçæ­£çè´¾ç»´æ¯ï¼è¶çº§æºè½çAIå©çï¼</p>
<h1 id="äºå®è£nodejs">äºãå®è£nodejs</h1>
<p>åé¢æ§è¡ä¸é®å®è£å½ä»¤ï¼å¯ä»¥èªå¨å®è£nodejsï¼ä½æ¯å¦æä¸ºäºå å¿«éåº¦ï¼é²æ­¢å®è£æå¤ï¼å¯ä»¥åå®è£nodejsï¼</p>
<p>å®æ¹ä¸è½½å°åï¼<a href="https://nodejs.org/zh-cn/download" target="_blank" rel="noopener nofollow">https://nodejs.org/zh-cn/download</a><br>
<img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900414-968176600.png" class="lazyload"></p>
<h1 id="ä¸å¼å§å®è£">ä¸ãå¼å§å®è£</h1>
<h3 id="ä¸è®¾ç½®-powershell-æ§è¡æé">ä¸ï¼è®¾ç½® PowerShell æ§è¡æé</h3>
<p>ä»¥ç®¡çåèº«ä»½è¿è¡ PowerShellï¼</p>
<ol>
<li>æ <code>Win</code> é®ï¼æç´¢ <strong>PowerShell</strong></li>
<li>å³é®ç¹å» <strong>Windows PowerShell</strong></li>
<li>éæ© <strong>ä»¥ç®¡çåèº«ä»½è¿è¡</strong></li>
<li>ç¹å» <strong>æ¯</strong> ç¡®è®¤<br>
<img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900472-1442678342.png" class="lazyload"></li>
</ol>
<p>å¨ç®¡çå PowerShell çªå£ä¸­ï¼ä¾æ¬¡æ§è¡ä»¥ä¸ä¸¤æ¡å½ä»¤ï¼</p>
<pre><code class="language-powershell">Set-ExecutionPolicy RemoteSigned -Scope CurrentUser

Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass
</code></pre>
<p><strong>è¿æ¯ä»ä¹ææï¼</strong></p>
<ul>
<li>ç¬¬ä¸æ¡å½ä»¤ï¼åè®¸å½åç¨æ·è¿è¡æ¬å°åä¸è½½çèæ¬</li>
<li>ç¬¬äºæ¡å½ä»¤ï¼åè®¸å½åç¨æ·è¿è¡æ¬å°åä¸è½½çèæ¬</li>
</ul>
<blockquote>
<p>â ï¸ <strong>å®å¨æç¤º</strong>ï¼è¿äºå½ä»¤åªä¼å½±åæ¨èªå·±çè´¦æ·ï¼ä¸ä¼å½±åç³»ç»å®å¨æå¶ä»ç¨æ·ã</p>
</blockquote>
<p><img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900423-653791165.png" class="lazyload"></p>
<h3 id="äºæ§è¡ä¸é®å®è£å½ä»¤">äºï¼æ§è¡ä¸é®å®è£å½ä»¤</h3>
<p>å¤å¶ä»¥ä¸å½ä»¤ï¼ç²è´´å° PowerShell çªå£ä¸­ï¼æ <strong>Enter</strong> æ§è¡ï¼</p>
<pre><code class="language-powershell">iwr -useb https://openclaw.ai/install.ps1 | iex
</code></pre>
<p><strong>å®è£è¿ç¨ä¼èªå¨å®æï¼</strong></p>
<ul>
<li>æ£æµç³»ç»ç¯å¢</li>
<li>å®è£å¿è¦ä¾èµï¼Node.js ç­ï¼</li>
<li>ä¸è½½ OpenClaw æ ¸å¿æä»¶</li>
<li>éç½®ç¯å¢åé</li>
<li>å¯å¨éç½®åå¯¼</li>
</ul>
<blockquote>
<p>æ³¨æï¼å¦æå½ä»¤æ§è¡åï¼è¿æ¯æ¥éï¼å¯ä»¥èªå·±å°å®ç½ä¸è½½nodeå®è£åï¼èªå·±å®è£nodeç¯å¢ï¼æ³¨æçæ¬æå¥½å¨ node v22.x ä»¥ä¸ï¼nodeå®ç½ä¸è½½å°åï¼<a href="https://nodejs.org/zh-cn/download%EF%BC%8C%E8%8B%A5%E8%BF%98%E6%98%AF%E4%B8%8D%E6%87%82%E6%80%8E%E4%B9%88%E5%AE%89%E8%A3%85%EF%BC%8C%E7%82%B9%E5%A4%B4%E5%83%8F%E8%BF%9B%E6%88%91%E4%B8%BB%E9%A1%B5%E6%89%BE%E5%88%B0%E6%88%91%EF%BC%8C%E6%8B%89%E4%BD%A0%E8%BF%9B%E4%BA%A4%E6%B5%81%E7%BE%A4" target="_blank" rel="noopener nofollow">https://nodejs.org/zh-cn/downloadï¼è¥è¿æ¯ä¸ææä¹å®è£ï¼ç¹å¤´åè¿æä¸»é¡µæ¾å°æï¼æä½ è¿äº¤æµç¾¤</a></p>
</blockquote>
<p><img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900314-66670908.png" class="lazyload"></p>
<p><img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900419-1797596666.png" class="lazyload"></p>
<h1 id="ååå§éç½®åå¯¼">åãåå§éç½®åå¯¼</h1>
<p>å®è£å®æåï¼ä¼èªå¨è¿å¥éç½®åå¯¼ï¼<code>openclaw onboard</code>ï¼ã</p>
<h2 id="ä¸é£é©åç¥">ä¸ï¼é£é©åç¥</h2>
<p>è¿ä¸æ­¥ä¸»è¦æ¯åè¯ä½ ï¼ä½¿ç¨OpenClawå¯è½ä¼æä¸äºé£é©ãè¯·é®ä½ æ¯å¦ç»§ç»­ï¼<br>
æ åå·¦æ¹åé® âï¼éæ© <code>Yes</code>ï¼æ <code>Enter</code> åè½¦ç¡®è®¤<br>
<img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900286-2146999803.png" class="lazyload"></p>
<h2 id="äºéæ©-qiuickstart-æ¨¡å¼">äºï¼éæ© QiuickStart æ¨¡å¼</h2>
<p><img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900421-571170739.png" class="lazyload"></p>
<h2 id="ä¸éç½®-ai-æ¨¡å-api-key">ä¸ï¼éç½® AI æ¨¡å API Key</h2>
<p>OpenClaw éè¦è¿æ¥å°å¤§è¯­è¨æ¨¡åæè½å·¥ä½ãOpenclaw æ¯è¾è´¹tokenï¼å½å¤æ¨¡åææ¬é«ï¼é¨æ§ä¹é«ï¼è¿éæéæ©å½åçæºè°±ç GLM 4.7</p>
<blockquote>
<p>å¦ææ²¡ææºè°±çAPI Keyï¼ç¹å»å®æ¹å°åèªå·±æ³¨åè´¦å·è·åAPI keyï¼<a href="https://www.bigmodel.cn/glm-coding?ic=RBSKXMPNJP" target="_blank" rel="noopener nofollow">https://www.bigmodel.cn/glm-coding?ic=RBSKXMPNJP</a></p>
</blockquote>
<p><img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900327-2131638734.png" class="lazyload"></p>
<p>è¾å¥èªå·±ç API Keyï¼</p>
<p><img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900388-1365487251.png" class="lazyload"></p>
<h2 id="åéæ©-ai-æ¨¡å">åï¼éæ© AI æ¨¡å</h2>
<blockquote>
<p>è¿éæéæ©é»è®¤çGLM 4.7ï¼ä¹æ¯æºæ®å½åçæè°æ¨¡å</p>
</blockquote>
<p><img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900427-1206679887.png" class="lazyload"></p>
<h2 id="äºè¿æ¥å³æ¶éè®¯å¹³å°">äºï¼è¿æ¥å³æ¶éè®¯å¹³å°</h2>
<p>éç½®å® AI æ¨¡ååï¼OpenClaw ä¼è¯¢é®ä½ è¦è¿æ¥åªä¸ªéè®¯å¹³å°ï¼</p>
<p><img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900329-126448555.png" class="lazyload"></p>
<blockquote>
<p>OpenClaw åçæ¯æçå³æ¶éä¿¡å¹³å°ä¸»è¦æ¯æµ·å¤ç WhatsAppãTelegramãDiscordãSlackãiMessage ç­ï¼å½åç¨æ·ä¸ä¹ æ¯ï¼è¿éå½äº§å³æ¶éä¿¡è½¯ä»¶å¤§åä¹è·è¿äºï¼ç°å¨ééï¼é£ä¹¦ç­é½å·²æ¯ææ¥å¥OpenClaw</p>
</blockquote>
<p>åé¢ä¼å¸¦é¢å¤§å®¶æé£ä¹¦æºå¨äººæ¥å¥ OpenClawï¼ä½¿å¤§å®¶å¯ä»¥éè¿é£ä¹¦å³å¯ææ¥OpenClawä¸ºæä»¬å¹²æ´»ï¼ä½æ¯é£ä¹¦éç½®æ¯è¾å¤æï¼è¿éæä»¬åéæ©è·³è¿ï¼åé¢æä»¬å¯ä»¥éè¿ç»§ç»­è¿è¡éç½®ï¼</p>
<p><img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900417-1715423641.png" class="lazyload"></p>
<h2 id="å­éæ©skills">å­ï¼éæ©Skills</h2>
<p>è¿éä¹éæ©ï¼Noï¼æä¸éç½®ï¼åé¢éè¿UIçé¢è¿è¡éç½®ï¼<br>
<img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900413-692235842.png" class="lazyload"></p>
<h2 id="ä¸æ¯å¦å¼å¯hooks">ä¸ï¼æ¯å¦å¼å¯Hooks</h2>
<p>æä½æ­¥éª¤ï¼åæ²<strong>ç©ºæ ¼</strong>ï¼è¡¨ç¤ºéä¸­å½åé¡¹ï¼åæ²åè½¦é®</p>
<p><img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900374-323484497.png" class="lazyload"></p>
<h2 id="å«å¯å¨æå¡å¹¶æå¼uiçé¢">å«ï¼å¯å¨æå¡å¹¶æå¼UIçé¢</h2>
<p>æ­¤æ¶å®ä¼èªå¨åæå¼ä¸ä¸ªå½ä»¤çªå£æ¥å¯å¨æå¡:</p>
<p><img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900333-208255503.png" class="lazyload"></p>
<blockquote>
<p>è¿ä¸ªè¿ç¨æ¯å¨å¯å¨æå¡ï¼å¯è½ä¼éè¦ç­ä¸ç¹æ¶é´</p>
</blockquote>
<p>åæ¶ï¼å¤§çº¦è¿30ç§å·¦å³ï¼æä»¬åå°åæçè®¾ç½®çªå£ï¼éæ© <code>Open the Web UI</code> ï¼æå¼ <code>OpenClaw</code> çUIçé¢ï¼</p>
<p><img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900250-1652139924.png" class="lazyload"></p>
<p>æµè§å¨èªå¨æå¼Web UIçé¢ï¼</p>
<p><img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900345-1845859887.png" class="lazyload"></p>
<h2 id="ä¹æµè¯ä¸ä¸">ä¹ï¼æµè¯ä¸ä¸</h2>
<p><img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900317-1571656437.png" class="lazyload"></p>
<h1 id="äºæ¥å¥é£ä¹¦æºå¨äºº">äºãæ¥å¥é£ä¹¦æºå¨äºº</h1>
<p>æä»¬éè¦åå°é£ä¹¦å¹³å°åå»ºèªå·±çæºå¨äººæ¥æ¥å¥OpenClawï¼</p>
<h2 id="ä¸æ¥å°é£ä¹¦å¼åèåå°">ä¸ï¼æ¥å°é£ä¹¦å¼åèåå°</h2>
<p>é£ä¹¦å¼æ¾å¹³å°å°åï¼<a href="https://open.feishu.cn" target="_blank" rel="noopener nofollow">https://open.feishu.cn</a></p>
<blockquote>
<p>æ²¡æé£ä¹¦è´¦å·çï¼éè¦èªå·±æ³¨åè´¦å·</p>
</blockquote>
<p>ç¹å»å³ä¸è§è¿å¥ <strong>å¼åèåå°</strong>ï¼</p>
<p><img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900343-1879614047.png" class="lazyload"></p>
<h2 id="äºåå»ºåºç¨">äºï¼åå»ºåºç¨</h2>
<p><img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900398-1841476993.png" class="lazyload"></p>
<h2 id="ä¸å¡«ååºç¨ä¿¡æ¯">ä¸ï¼å¡«ååºç¨ä¿¡æ¯</h2>
<p><img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900408-1479853027.png" class="lazyload"></p>
<h2 id="åè·åèªå·±çåºç¨å­è¯">åï¼è·åèªå·±çåºç¨å­è¯</h2>
<p><img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900351-575267531.png" class="lazyload"></p>
<h2 id="äºç»åºç¨æ·»å æºå¨äºº">äºï¼ç»åºç¨æ·»å æºå¨äºº</h2>
<p><img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900381-1004037085.png" class="lazyload"></p>
<p><img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900322-1666669395.png" class="lazyload"></p>
<h2 id="å­ç»åºç¨éç½®æé">å­ï¼ç»åºç¨éç½®æé</h2>
<p><img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900352-209734116.png" class="lazyload"></p>
<p>æå³æ¶éè®¯ç¸å³çæéå¨é¨å¼éï¼</p>
<p><img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900464-1819443892.png" class="lazyload"></p>
<h2 id="ä¸åå»ºçæ¬å¹¶åå¸">ä¸ï¼åå»ºçæ¬å¹¶åå¸</h2>
<p><img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900348-661047761.png" class="lazyload"></p>
<p><img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900337-1730165463.png" class="lazyload"></p>
<p><img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900278-2005507871.png" class="lazyload"></p>
<p><img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900403-1816510157.png" class="lazyload"></p>
<p>æ¥å°é£ä¹¦å®¢æ·ç«¯è¿è¡å®¡æ¹ï¼</p>
<p><img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900691-2136889623.png" class="lazyload"></p>
<p><img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900298-1018251019.png" class="lazyload"></p>
<h2 id="å«å®è£é£ä¹¦æä»¶">å«ï¼å®è£é£ä¹¦æä»¶</h2>
<p>æå¼powershellï¼è¾å¥ä»¥ä¸å½ä»¤ï¼å®è£é£ä¹¦æä»¶ï¼</p>
<pre><code>openclaw plugins install @m1heng-clawd/feishu
</code></pre>
<p>å®è£æååï¼åæå¼ä¸ä¸ªæ°çå½ä»¤çªå£ï¼å¼å§éç½®é£ä¹¦æä»¶ï¼</p>
<p>è¾å¥å½ä»¤ï¼<code>openclaw config</code></p>
<p><img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900279-1640601270.png" class="lazyload"></p>
<p>éæ©æ¸ é:<br>
<img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900318-2100612820.png" class="lazyload"></p>
<p>éæ©éç½®é¾æ¥:<br>
<img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900296-643979225.png" class="lazyload"></p>
<p><img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900376-1505391464.png" class="lazyload"></p>
<p>è¾å¥é£ä¹¦çAppIDï¼AppSecrectï¼</p>
<p><img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900299-381972467.png" class="lazyload"></p>
<p>ååéæ©ä¸­å½çï¼<br>
<img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900409-1003405634.png" class="lazyload"></p>
<p>æ¥åç¾¤ç»èå¤©ï¼<br>
<img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900303-493855197.png" class="lazyload"></p>
<p>éæ©å®æï¼<br>
<img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900423-13996540.png" class="lazyload"></p>
<p>éæ©yesï¼<br>
<img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900357-118289834.png" class="lazyload"></p>
<p>éæ©openï¼<br>
<img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900388-830142302.png" class="lazyload"></p>
<p>éæ©ç»§ç»­ï¼å®æéç½®ï¼<br>
<img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900353-1706791968.png" class="lazyload"></p>
<p>éå¯æå¡ï¼ä½¿éç½®çæï¼<br>
æ§å¶å¯ä»¥çå°é£ä¹¦æä»¶å·²ç»éç½®æå<br>
<img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900419-1691413263.png" class="lazyload"></p>
<h2 id="ä¸åå°é£ä¹¦åå°è®¾ç½®äºä»¶åè°">ä¸ï¼åå°é£ä¹¦åå°è®¾ç½®äºä»¶åè°</h2>
<p><img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900587-1148162029.png" class="lazyload"></p>
<p>éæ© <code>ä½¿ç¨é¿è¿æ¥æ¥æ¶äºä»¶</code> ï¼</p>
<p><img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900371-1606340248.png" class="lazyload"></p>
<p>å¯ä»¥çå°æ·»å äºä»¶æé®ç±åæ¥çç°è²ä¸å¯ç¹å»åä¸ºå¯ç¹å»ï¼<br>
<img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900298-247178040.png" class="lazyload"></p>
<p>æ·»å æ¥æ¶æ¶æ¯äºä»¶ï¼<br>
<img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900359-2126904009.png" class="lazyload"></p>
<p>ç»åºç¨å¼éè·åéè®¯å½åºæ¬ä¿¡æ¯çæéï¼<br>
<img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900383-262492762.png" class="lazyload"></p>
<p>éæ°åå¸çæ¬ï¼<br>
<img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900331-23540788.png" class="lazyload"></p>
<p>è·åé¢çæ­¥éª¤ä¸æ ·ï¼åå¸ä¸ºå¨çº¿åºç¨å³å¯ã</p>
<p>ç°å¨å¯ä»¥å¨ é£ä¹¦ä¸­ä¸ AI å©æå¯¹è¯äºï¼</p>
<h2 id="å«å¨é£ä¹¦ä¸­ä¸openclawå¯¹è¯">å«ï¼å¨é£ä¹¦ä¸­ä¸OpenClawå¯¹è¯</h2>
<p>æ¥å°é£ä¹¦å®¢æ·ç«¯æèææºé£ä¹¦appä¸ï¼</p>
<p><img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900366-463784394.png" class="lazyload"></p>
<p>ä»¥ä¸æ¯openclawæä»¶å¤¹ä¸é¢çææ¡£åçåå®¹ï¼<br>
<img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900341-771268919.png" class="lazyload"></p>
<p>ç°å¨æè·åºæ°´æºå¨äººå¯¹è¯ï¼è®©ä»åè¯ææå®ææ¡£åæ¯ä»ä¹åå®¹ï¼<br>
<img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900316-1547165344.jpg" class="lazyload"></p>
<hr>
<h1 id="å­è®¿é®-web-æ§å¶é¢æ¿">å­ãè®¿é® Web æ§å¶é¢æ¿</h1>
<p>éç½®å®æåï¼PowerShell çªå£åºé¨ä¼æ¾ç¤ºæ§å¶é¢æ¿é¾æ¥ï¼æ ¼å¼ç±»ä¼¼ï¼</p>
<pre><code>Control UI: http://127.0.0.1:18789
</code></pre>
<ol>
<li>å¤å¶å®æ´é¾æ¥</li>
<li>å¨æµè§å¨ä¸­æå¼</li>
<li>å³å¯çå°å¯è§åUIç®¡ççé¢</li>
</ol>
<hr>
<h1 id="ä¸å¸¸ç¨å½ä»¤éæ¥">ä¸ãå¸¸ç¨å½ä»¤éæ¥</h1>
<table>
<thead>
<tr>
<th>å½ä»¤</th>
<th>åè½</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>openclaw onboard</code></td>
<td>éæ°è¿å¥éç½®åå¯¼</td>
</tr>
<tr>
<td><code>openclaw status</code></td>
<td>æ¥çè¿è¡ç¶æ</td>
</tr>
<tr>
<td><code>openclaw health</code></td>
<td>å¥åº·æ£æ¥</td>
</tr>
<tr>
<td><code>openclaw gateway start</code></td>
<td>å¯å¨æå¡</td>
</tr>
<tr>
<td><code>openclaw gateway stop</code></td>
<td>åæ­¢æå¡</td>
</tr>
<tr>
<td><code>openclaw update</code></td>
<td>æ´æ°å°ææ°çæ¬</td>
</tr>
<tr>
<td><code>openclaw doctor</code></td>
<td>è¯æ­é®é¢</td>
</tr>
<tr>
<td><code>openclaw uninstall</code></td>
<td>å¸è½½ OpenClaw</td>
</tr>
</tbody>
</table>
<hr>
<h1 id="å«å¸¸è§é®é¢è§£ç­">å«ãå¸¸è§é®é¢è§£ç­</h1>
<h3 id="q1-å®è£é£ä¹¦æä»¶æç¤ºspawn-npm-enoent">Q1: å®è£é£ä¹¦æä»¶æç¤ºï¼spawn npm ENOENT</h3>
<p><img alt="" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1205021/202601/1205021-20260131194900351-652455840.png" class="lazyload"></p>
<p>é®é¢åå ï¼è¿å¯è½æ¯openclawçä¸ä¸ªbugï¼å¯ä»¥ç­å®æ¹æ´æ°ï¼ä¹å¯ä»¥èªå·±å»å®æ¹ä»åºæissue</p>
<p>è§£å³æ­¥éª¤ï¼</p>
<p>å®ä½é®é¢ä»£ç </p>
<p>æä»¶è·¯å¾ï¼</p>
<pre><code>C:\Users\Administrator\AppData\Roaming\fnm\node-versions\v22.14.0\installation\node_modules\openclaw\dist\process\exec.js
</code></pre>
<p>ä¿®æ¹ä»£ç </p>
<p>æ¾å° <code>runCommandWithTimeout</code> å½æ°ä¸­ç spawn è°ç¨ï¼ä¿®æ¹å¦ä¸ï¼</p>
<p><strong>ä¿®æ¹åï¼</strong></p>
<pre><code class="language-javascript">const stdio = resolveCommandStdio({ hasInput, preferInherit: true });
const child = spawn(argv[0], argv.slice(1), {
    stdio,
    cwd,
    env: resolvedEnv,
    windowsVerbatimArguments,
});
</code></pre>
<p><strong>ä¿®æ¹åï¼</strong></p>
<pre><code class="language-javascript">const stdio = resolveCommandStdio({ hasInput, preferInherit: true });
// On Windows, npm must be spawned with shell: true or use .cmd extension
let command = argv[0];
let useShell = false;
if (process.platform === "win32" &amp;&amp; path.basename(command) === "npm") {
    useShell = true;
}
const child = spawn(command, argv.slice(1), {
    stdio,
    cwd,
    env: resolvedEnv,
    shell: useShell,
});
</code></pre>
<h3 id="q2-æç¤º-openclaw-å½ä»¤æ¾ä¸å°">Q2: æç¤º "openclaw å½ä»¤æ¾ä¸å°"</h3>
<p><strong>è§£å³æ¹æ³ï¼</strong></p>
<ol>
<li>å³é­ææ PowerShell çªå£</li>
<li>éæ°æå¼ PowerShell</li>
<li>å¦æè¿ä¸è¡ï¼æ§è¡ <code>exec bash</code> æéå¯çµè</li>
</ol>
<h3 id="q3-å®è£å¡ä½ä¸å¨">Q3: å®è£å¡ä½ä¸å¨</h3>
<p><strong>è§£å³æ¹æ³ï¼</strong></p>
<ol>
<li>æ <code>Ctrl + C</code> ä¸­æ­å½åæä½</li>
<li>æ§è¡ï¼<code>openclaw doctor</code> æ£æ¥é®é¢</li>
<li>å¦æç¤ºç½ç»é®é¢ï¼æ£æ¥é²ç«å¢è®¾ç½®</li>
</ol>
<h3 id="q4-api-key-éç½®éè¯¯">Q4: API Key éç½®éè¯¯</h3>
<p><strong>è§£å³æ¹æ³ï¼</strong></p>
<ol>
<li>æ§è¡ï¼<code>openclaw onboard</code></li>
<li>éæ©éæ°éç½® API Key</li>
<li>ç¡®ä¿å¯é¥æ ¼å¼æ­£ç¡®</li>
</ol>
<h3 id="q5-ç«¯å£-18789-è¢«å ç¨">Q5: ç«¯å£ 18789 è¢«å ç¨</h3>
<p><strong>è§£å³æ¹æ³ï¼</strong></p>
<pre><code class="language-powershell">openclaw gateway --port 18790
</code></pre>
<p>ä½¿ç¨å¶ä»ç«¯å£å¯å¨æå¡ã</p>
<h1 id="ä¹ææ¬è¯´æ">ä¹ãææ¬è¯´æ</h1>
<p>OpenClaw è½¯ä»¶æ¬èº«å®å¨åè´¹ï¼ä¸»è¦ææ¬æ¥èª AI æ¨¡å API è°ç¨ï¼å¯éæ©å½äº§å¤§æ¨¡åï¼éä½ææ¬ã</p>
<hr>
<h1 id="ç»è¯­">ç»è¯­</h1>
<p>OpenClaw ä»£è¡¨äºä¸ªäºº AI å©ççæªæ¥è¶å¿ââä»"èå¤©å·¥å·"è¿åä¸º"æ§è¡å·¥å·"ãè½ç¶ç®åçéç½®è¿ç¨å¯¹å°ç½ç¨æ·æä¸å®é¨æ§ï¼ä½ä¸æ¦å®æè®¾ç½®ï¼æ¨å°æ¥æä¸ä¸ª 24/7 å¾å½çè¶çº§å©æã</p>


</div>
<div class="clear"></div>

		</div>
		<div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-01-31 19:50">2026-01-31 19:50</span>&nbsp;
<a href="https://www.cnblogs.com/weipo0105">é¿å¡RPA</a>&nbsp;
éè¯»(<span id="post_view_count">316</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19558953);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19558953', targetLink: 'https://www.cnblogs.com/weipo0105/p/19558953', title: 'ãä¿å§çº§æç¨ãææææä½ å®è£OpenClawå¹¶æ¥å¥é£ä¹¦ï¼è®©AIå¨èå¤©è½¯ä»¶éå¸®ä½ å¹²æ´»' })">ä¸¾æ¥</a>
</div>
	 ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ Rediså¿«éå®ç°å¸éè¿æ»¤å¨ï¼ç¼å­å»éçâæºè½é¨å«â ]]></title>
    <link>https://www.cnblogs.com/sun-10387834/p/19522155</link>
    <guid>0247f249e3ffca5b2e8153897549402b</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/sun-10387834/p/19522155" title="åå¸äº 2026-01-31 18:32">
    <span role="heading" aria-level="2">Rediså¿«éå®ç°å¸éè¿æ»¤å¨ï¼ç¼å­å»éçâæºè½é¨å«â</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<p>å¨ç¼å­æ¶æä¸­ï¼æ»æä¸äºâå¤´ç¼é®é¢âï¼ç¨æ·åå¤æäº¤ç¸åè¯·æ±ãæ¥è¯¢ä¸å­å¨çkeyå¯¼è´ç¼å­ç©¿éãæµ·éæ°æ®å»éæçä½ä¸â¦â¦è¿äºåºæ¯ä¸ï¼Rediså¸éè¿æ»¤å¨å°±æ¯å½ä¹æ æ§çâææâãå®åä¸ä¸ªæºè½é¨å«ï¼è½å¿«éå¤æ­âè¿ä¸ªäººæ¯ä¸æ¯æ¥è¿ââè¿ä¸ªkeyæ¯ä¸æ¯ä¸å­å¨âï¼ç¨æå°çç©ºé´ææ¬å®ç°é«æè¿æ»¤ï¼æ§è½è¿è¶ä¼ ç»çæ°æ®åºæ¥è¯¢æå¨éç¼å­æ ¡éªã</p>
<p>ä»å¤©å±ä»¬å°±ä»âæ¯ä»ä¹ãä¸ºä»ä¹å¥½ç¨ãæä¹ç¨Rediså¿«éå®ç°âä¸ä¸ªç»´åº¦ï¼ç¨éä¿çè¯­è¨+å®æä»£ç ï¼æå¸éè¿æ»¤å¨è®²éãå¨ç¨é¿å¼å¤æå¬å¼ï¼å°±ç®æ¯åæ¥è§¦ç¼å­çåå­¦ï¼ä¹è½è·çæ­¥éª¤å¿«éè½å°ã</p>
<h2 id="ä¸åææå¸éè¿æ»¤å¨å°åºæ¯ä¸ªå¥">ä¸ãåææï¼å¸éè¿æ»¤å¨å°åºæ¯ä¸ªå¥ï¼</h2>
<p>å¸éè¿æ»¤å¨ï¼Bloom Filterï¼æ¬è´¨æ¯ä¸ä¸ª<strong>åºäºåå¸å½æ°çæ¦çåæ°æ®ç»æ</strong>ï¼æ ¸å¿ä½ç¨æ¯âå¿«éå¤æ­ä¸ä¸ªåç´ æ¯å¦å­å¨äºéåä¸­âãå®ä¸ååå¸è¡¨é£æ ·å­å¨å®æ´æ°æ®ï¼èæ¯ç¨ä¸ä¸ªäºè¿å¶æ°ç»ï¼bitæ°ç»ï¼+å¤ä¸ªåå¸å½æ°ï¼éè¿æ è®°åç´ çåå¸ä½ç½®æ¥å®ç°è¿æ»¤ã</p>
<p>å±ä»¬ç¨âå°åºé¨å«è®°è®¿å®¢âçåºæ¯ç±»æ¯ï¼ç§ææ ¸å¿é»è¾ï¼</p>
<ul>
<li>
<p>äºè¿å¶æ°ç» = é¨å«çç»è®°æ¬ï¼æ¯ä¸é¡µåªæâæ¯âï¼1ï¼åâå¦âï¼0ï¼ä¸¤ä¸ªç¶æï¼</p>
</li>
<li>
<p>åå¸å½æ° = é¨å«çâè®°å¿è§åâï¼æ¯å¦âè®°ä½è®¿å®¢çå§æ°é¦å­æ¯+èº«é«åºé´+éå­é¢è²âï¼</p>
</li>
<li>
<p>åç´ å­å¨å¤æ­ = é¨å«æ ¹æ®è®°å¿è§åæ ¸å¯¹ç»è®°æ¬ï¼åªè¦æä¸æ¡è§åå¯¹åºâå¦âï¼å°±ç¡®å®è®¿å®¢æ²¡æ¥è¿ï¼å¦æå¨æ¯âæ¯âï¼åå¤§æ¦çæ¥è¿ï¼å­å¨æå°è¯¯å¤ï¼ã</p>
</li>
</ul>
<h3 id="æ ¸å¿ç¹æ§ä¼ç¹ä¸å°ççµ">æ ¸å¿ç¹æ§ï¼ä¼ç¹ä¸âå°ççµâ</h3>
<p>å¸éè¿æ»¤å¨çä¼å¿åå±éæ§é½å¾é²æï¼è½å°åå¿é¡»æ¸æ¸ï¼</p>
<h4 id="-æ ¸å¿ä¼ç¹">â æ ¸å¿ä¼ç¹</h4>
<ul>
<li>
<p>ç©ºé´å ç¨æå°ï¼ä»ç¨bitæ°ç»å­å¨æ è®°ï¼å­å¨100ä¸æ¡æ°æ®ï¼è¯¯å¤ç1%æ¶ï¼ä»éçº¦1.2MBç©ºé´ï¼</p>
</li>
<li>
<p>æ¥è¯¢éåº¦æå¿«ï¼æ¶é´å¤æåº¦æ¯O(k)ï¼kæ¯åå¸å½æ°ä¸ªæ°ï¼ï¼æ è®ºæ°æ®éå¤å¤§ï¼é½è½ç¬é´è¿åç»æï¼</p>
</li>
<li>
<p>æ¯ææµ·éæ°æ®ï¼æ éå­å¨å®æ´æ°æ®ï¼å¯è½»æ¾åºå¯¹åä¸çº§ãäº¿çº§æ°æ®çè¿æ»¤åºæ¯ã</p>
</li>
</ul>
<h4 id="-ä¸å¯å¿½è§çå±éæ§">â ä¸å¯å¿½è§çå±éæ§</h4>
<ul>
<li>
<p>å­å¨è¯¯å¤çï¼åªè½ç¡®å®âåç´ ä¸å®ä¸å­å¨âï¼ä¸è½100%ç¡®å®âåç´ ä¸å®å­å¨âï¼è¯¯å¤çå¯éè¿åæ°è°æ´ï¼ä½æ æ³å®å¨æ¶é¤ï¼</p>
</li>
<li>
<p>ä¸æ¯æå é¤æä½ï¼ä¸æ¦åç´ è¢«æ è®°å°bitæ°ç»ï¼æ æ³ååæ¸é¤ï¼ä¼å½±åå¶ä»åç´ çå¤æ­ï¼ï¼</p>
</li>
<li>
<p>éæåé¢ä¼°æ°æ®éï¼åå¸å½æ°ä¸ªæ°ãbitæ°ç»é¿åº¦éæ ¹æ®é¢ä¼°æ°æ®éè®¡ç®ï¼å¦åä¼å¯¼è´è¯¯å¤çé£åã</p>
</li>
</ul>
<h2 id="äºrediså®ç°å¸éè¿æ»¤å¨çä¸¤ç§æ¹å¼">äºãRediså®ç°å¸éè¿æ»¤å¨çä¸¤ç§æ¹å¼</h2>
<p>Redisæ¬èº«æ²¡æåç½®å¸éè¿æ»¤å¨ï¼ä½æä¾äºä¸¤ç§å¿«éå®ç°çæ¹æ¡ï¼ä¸æ¯åºäºRedisçBitMapï¼ä½å¾ï¼æå¨å®ç°ï¼çµæ´»å¯æ§ï¼äºæ¯ä½¿ç¨Rediså®æ¹æ¨èçRedissonå®¢æ·ç«¯ï¼å°è£å¥½ç°æAPIï¼å¼ç®±å³ç¨ãå±ä»¬åå«è®²å®æï¼æééæ©å³å¯ã</p>
<h3 id="æ¹æ¡ä¸åºäºbitmapæå¨å®ç°çµæ´»å¯æ§">æ¹æ¡ä¸ï¼åºäºBitMapæå¨å®ç°ï¼çµæ´»å¯æ§ï¼</h3>
<p>æ ¸å¿æè·¯ï¼å©ç¨RedisçBitMapæ°æ®ç»æä½ä¸ºå¸éè¿æ»¤å¨çbitæ°ç»ï¼éè¿å¤ä¸ªåå¸å½æ°è®¡ç®åç´ çåå¸å¼ï¼å°å¯¹åºä½ç½®çbitç½®ä¸º1ï¼æ¥è¯¢æ¶ï¼åæ ·è®¡ç®åå¸å¼ï¼æ£æ¥ææä½ç½®æ¯å¦ä¸º1ï¼å¨ä¸º1åå¤§æ¦çå­å¨ï¼å¦åä¸å®ä¸å­å¨ã</p>
<h4 id="1-å³é®åæ°è®¡ç®é¿åè¯¯å¤çè¿é«">1. å³é®åæ°è®¡ç®ï¼é¿åè¯¯å¤çè¿é«ï¼</h4>
<p>æå¨å®ç°åï¼éåç¡®å®ä¸ä¸ªæ ¸å¿åæ°ï¼å¯éè¿å¬å¼æå¨çº¿å·¥å·è®¡ç®ï¼</p>
<ul>
<li>
<p>mï¼bitæ°ç»é¿åº¦ï¼åä½ï¼bitï¼ï¼é¢ä¼°æ°æ®énè¶å¤§ï¼méè¶å¤§ï¼</p>
</li>
<li>
<p>kï¼åå¸å½æ°ä¸ªæ°ï¼kè¿å¤ä¼å¯¼è´bitæ°ç»å¿«éè¢«å æ»¡ï¼è¯¯å¤çä¸åï¼kè¿å°åè¿æ»¤ææå·®ï¼</p>
</li>
<li>
<p>pï¼å¯æ¥åçè¯¯å¤çï¼éå¸¸è®¾ä¸º0.01~0.1ï¼ã</p>
</li>
</ul>
<p>å¸¸ç¨è®¡ç®å¬å¼ï¼æ éæ­»è®°ï¼å¨çº¿å·¥å·ç´æ¥ç®ï¼ï¼</p>
<ul>
<li>
<p>m = - (n * ln p) / (ln 2)Â² ï¼bitæ°ç»é¿åº¦ï¼ï¼</p>
</li>
<li>
<p>k = (m / n) * ln 2 ï¼åå¸å½æ°ä¸ªæ°ï¼ã</p>
</li>
</ul>
<p>ä¸¾ä¸ªä¾å­ï¼é¢ä¼°å­å¨10ä¸æ¡æ°æ®ï¼è¯¯å¤çè®¾ä¸º0.01ï¼è®¡ç®å¾mâ958505 bitï¼çº¦117KBï¼ï¼kâ7ä¸ªåå¸å½æ°ã</p>
<h4 id="2-æå¨å®ç°ä»£ç javaç¤ºä¾">2. æå¨å®ç°ä»£ç ï¼Javaç¤ºä¾ï¼</h4>
<p>æ ¸å¿æ¯å®ç°å¤ä¸ªåå¸å½æ°ï¼æä½RedisçBitMapæä»¤ï¼SETBITç½®1ï¼GETBITæ¥è¯¢ï¼ï¼</p>
<pre><code class="language-java">import org.springframework.data.redis.core.StringRedisTemplate;
import java.nio.charset.StandardCharsets;
import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;

/**
 * åºäºRedis BitMapæå¨å®ç°å¸éè¿æ»¤å¨
 */
public class RedisBloomFilter {
    // Redisé®å
    private final String key;
    // bitæ°ç»é¿åº¦
    private final long bitSize;
    // åå¸å½æ°ä¸ªæ°
    private final int hashCount;
    private final StringRedisTemplate stringRedisTemplate;

    // æé å¨ï¼åå§ååæ°
    public RedisBloomFilter(String key, long n, double p, StringRedisTemplate stringRedisTemplate) {
        this.key = key;
        this.stringRedisTemplate = stringRedisTemplate;
        // è®¡ç®bitæ°ç»é¿åº¦
        this.bitSize = (long) (-n * Math.log(p) / (Math.log(2) * Math.log(2)));
        // è®¡ç®åå¸å½æ°ä¸ªæ°
        this.hashCount = (int) (this.bitSize / n * Math.log(2));
    }

    // æ·»å åç´ å°å¸éè¿æ»¤å¨
    public void add(Object value) {
        byte[] bytes = value.toString().getBytes(StandardCharsets.UTF_8);
        long[] hashes = hash(bytes, hashCount, bitSize);
        for (long hash : hashes) {
            // æå¯¹åºbitä½ç½®ç½®ä¸º1
            stringRedisTemplate.opsForValue().setBit(key, hash, true);
        }
    }

    // å¤æ­åç´ æ¯å¦å­å¨ï¼å­å¨è¿åtrueï¼ä¸å­å¨è¿åfalseï¼trueå¯è½æ¯è¯¯å¤ï¼
    public boolean contains(Object value) {
        byte[] bytes = value.toString().getBytes(StandardCharsets.UTF_8);
        long[] hashes = hash(bytes, hashCount, bitSize);
        for (long hash : hashes) {
            // åªè¦æä¸ä¸ªbitä½ä¸º0ï¼å°±ç¡®å®ä¸å­å¨
            if (!stringRedisTemplate.opsForValue().getBit(key, hash)) {
                return false;
            }
        }
        return true;
    }

    // å¤åå¸å½æ°å®ç°ï¼åºäºMD5æåï¼
    private long[] hash(byte[] bytes, int hashCount, long bitSize) {
        long[] hashes = new long[hashCount];
        try {
            MessageDigest md5 = MessageDigest.getInstance("MD5");
            byte[] digest = md5.digest(bytes);
            // æMD5ç»æï¼16å­èï¼æåæå¤ä¸ªåå¸å¼
            for (int i = 0; i &lt; hashCount; i++) {
                long hash = 0;
                for (int j = i * 2; j &lt; (i + 1) * 2 &amp;&amp; j &lt; digest.length; j++) {
                    hash = hash * 256 + (digest[j] &amp; 0xFF);
                }
                // ç¡®ä¿åå¸å¼å¨bitæ°ç»é¿åº¦èå´å
                hashes[i] = hash % bitSize;
            }
        } catch (NoSuchAlgorithmException e) {
            throw new RuntimeException("åå¸å½æ°åå§åå¤±è´¥", e);
        }
        return hashes;
    }
}
</code></pre>
<h4 id="3-ä½¿ç¨æ¹å¼">3. ä½¿ç¨æ¹å¼</h4>
<pre><code class="language-java">// åå§åå¸éè¿æ»¤å¨ï¼keyä¸º"user:bloom:filter"ï¼é¢ä¼°10ä¸æ¡æ°æ®ï¼è¯¯å¤ç0.01
RedisBloomFilter bloomFilter = new RedisBloomFilter("user:bloom:filter", 100000, 0.01, stringRedisTemplate);

// æ·»å åç´ 
bloomFilter.add("user123");
bloomFilter.add("order456");

// å¤æ­åç´ æ¯å¦å­å¨
boolean exists = bloomFilter.contains("user123"); // å¤§æ¦çè¿åtrue
boolean notExists = bloomFilter.contains("user789"); // ä¸å®è¿åfalse
</code></pre>
<h3 id="æ¹æ¡äºredissonå®¢æ·ç«¯å®ç°å¼ç®±å³ç¨">æ¹æ¡äºï¼Redissonå®¢æ·ç«¯å®ç°ï¼å¼ç®±å³ç¨ï¼</h3>
<p>å¦æè§å¾æå¨å®ç°éº»ç¦ï¼æ¨èç¨RedissonââRediså®æ¹çæçJavaå®¢æ·ç«¯ï¼å·²ç»å°è£å¥½äºå¸éè¿æ»¤å¨ï¼æ¯æèªå¨è®¡ç®åæ°ãåå¸å¼åºæ¯ï¼è¿è§£å³äºæå¨å®ç°çåå¸å½æ°ä¼åé®é¢ï¼çäº§ç¯å¢é¦éã</p>
<h4 id="1-å¼å¥ä¾èµ">1. å¼å¥ä¾èµ</h4>
<pre><code class="language-xml">&lt;dependency&gt;
    &lt;groupId&gt;org.redisson&lt;/groupId&gt;
    &lt;artifactId&gt;redisson-spring-boot-starter&lt;/artifactId&gt;
    &lt;version&gt;3.23.3&lt;/version&gt; // çæ¬ä¸Redisçæ¬éé
&lt;/dependency&gt;
</code></pre>
<h4 id="2-å¿«éå®ç°ä»£ç ">2. å¿«éå®ç°ä»£ç </h4>
<pre><code class="language-java">import org.redisson.api.RBloomFilter;
import org.redisson.api.RedissonClient;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

@Component
public class RedissonBloomFilterDemo {
    @Autowired
    private RedissonClient redissonClient;

    // åå§åå¸éè¿æ»¤å¨
    public RBloomFilter&lt;String&gt; initBloomFilter() {
        // å¸éè¿æ»¤å¨åç§°
        String filterName = "user:bloom:filter:redisson";
        // è·åå¸éè¿æ»¤å¨å®ä¾
        RBloomFilter&lt;String&gt; bloomFilter = redissonClient.getBloomFilter(filterName);
        // åå§åï¼é¢ä¼°10ä¸æ¡æ°æ®ï¼è¯¯å¤ç0.01ï¼Redissonä¼èªå¨è®¡ç®måkï¼
        bloomFilter.tryInit(100000, 0.01);
        return bloomFilter;
    }

    // æµè¯ä½¿ç¨
    public void testBloomFilter() {
        RBloomFilter&lt;String&gt; bloomFilter = initBloomFilter();
        // æ·»å åç´ 
        bloomFilter.add("user123");
        bloomFilter.add("order456");

        // å¤æ­åç´ æ¯å¦å­å¨
        boolean exists = bloomFilter.contains("user123"); // å¤§æ¦çtrue
        boolean notExists = bloomFilter.contains("user789"); // ä¸å®false

        // ç»è®¡å·²æ·»å åç´ æ°éï¼è¿ä¼¼å¼ï¼
        long count = bloomFilter.count();
        System.out.println("å·²æ·»å åç´ æ°éï¼" + count);
    }
}
</code></pre>
<h4 id="3-æ ¸å¿ä¼å¿">3. æ ¸å¿ä¼å¿</h4>
<ul>
<li>
<p>åå¸å¼æ¯æï¼ééå¾®æå¡åºæ¯ï¼å¤å®ä¾å±äº«åä¸ä¸ªå¸éè¿æ»¤å¨ï¼æ éæå¿æ°æ®ä¸è´æ§ï¼</p>
</li>
<li>
<p>åæ°ä¼åï¼åç½®æ´é«æçåå¸å½æ°ï¼MurmurHashï¼ï¼è¯¯å¤çæ§å¶æ´ç²¾åï¼</p>
</li>
<li>
<p>APIä¸°å¯ï¼æ¯æåç´ è®¡æ°ãæ¹éæ·»å ç­åè½ï¼æ¯æå¨å®ç°æ´å®åã</p>
</li>
</ul>
<h2 id="ä¸å®éåºç¨åºæ¯ä¸é¿åæå">ä¸ãå®éåºç¨åºæ¯ä¸é¿åæå</h2>
<h3 id="-å¸ååºç¨åºæ¯">â å¸ååºç¨åºæ¯</h3>
<ol>
<li>
<p>ç¼å­ç©¿éé²æ¤ï¼æ¥è¯¢æ°æ®åºåï¼åç¨å¸éè¿æ»¤å¨å¤æ­keyæ¯å¦å­å¨ï¼ä¸å­å¨åç´æ¥è¿åï¼é¿åå¤§éæ ææ°æ®åºæ¥è¯¢ï¼</p>
</li>
<li>
<p>æµ·éæ°æ®å»éï¼æ¯å¦ç¨æ·ç­¾å°ãæ¥å¿å»éãç¬è«URLå»éï¼æ éå­å¨å¨éæ°æ®ï¼ä»ç¨bitæ°ç»æ è®°ï¼</p>
</li>
<li>
<p>é²æ­¢éå¤æäº¤ï¼æ¥å£è¯·æ±åï¼ç¨å¸éè¿æ»¤å¨å¤æ­è¯·æ±IDæ¯å¦å·²å¤çï¼é¿åéå¤ä¸å¡é»è¾æ§è¡ï¼</p>
</li>
<li>
<p>é»ååè¿æ»¤ï¼æ¯å¦åå¾é®ä»¶è¯å«ãæ¶æIPæ¦æªï¼å¿«éå¤æ­æ¯å¦å¨é»ååä¸­ã</p>
</li>
</ol>
<h3 id="-é¿åæå">â é¿åæå</h3>
<ul>
<li>
<p>ä¸è¦ç¨å¨âç»å¯¹ä¸è½è¯¯å¤âçåºæ¯ï¼æ¯å¦éèäº¤æãç¨æ·ç»å½éªè¯ï¼è¯¯å¤å¯è½å¯¼è´ä¸¥éé®é¢ï¼</p>
</li>
<li>
<p>æåé¢ä¼°æ°æ®éï¼è¥å®éæ°æ®éè¿è¶é¢ä¼°ï¼bitæ°ç»ä¼è¢«å¿«éå æ»¡ï¼è¯¯å¤çä¼æ¥å§ä¸åï¼å¯é¢ç2~3ååä½ï¼</p>
</li>
<li>
<p>å®æéç½®å¸éè¿æ»¤å¨ï¼è¥æ°æ®æè¿æç¹æ§ï¼æ¯å¦æ¯æ¥é»ååæ´æ°ï¼ï¼å¯å®æå é¤æ§çå¸éè¿æ»¤å¨ï¼éå»ºæ°å®ä¾ï¼</p>
</li>
<li>
<p>Rediséç¾¤æ³¨æäºé¡¹ï¼æå¨å®ç°çå¸éè¿æ»¤å¨è¥ç¨å¨Rediséç¾¤ä¸­ï¼éç¡®ä¿keyè½å¨åä¸ä¸ªèç¹ï¼é¿ååå¸åçå¯¼è´bitæ°ç»åæ£ï¼ï¼Redissonå·²èªå¨å¤çè¯¥é®é¢ã</p>
</li>
</ul>
<h2 id="åæ»ç»ä»ä¹æ¶åéåªç§å®ç°æ¹å¼">åãæ»ç»ï¼ä»ä¹æ¶åéåªç§å®ç°æ¹å¼ï¼</h2>
<p>Rediså¸éè¿æ»¤å¨çæ ¸å¿ä»·å¼çæ¯âç¨æå°ç©ºé´æ¢æé«è¿æ»¤æçâï¼è½å°æ¶æåºæ¯éæ©å®ç°æ¹å¼ï¼</p>
<ul>
<li>
<p>å¿«éè½å°ãçäº§ç¯å¢ãåå¸å¼åºæ¯ï¼éRedissonï¼çå¿é«æï¼ééæ§å¼ºï¼</p>
</li>
<li>
<p>å­¦ä¹ ç ç©¶ãèªå®ä¹åå¸å½æ°ãç¹æ®åæ°éæ±ï¼éæå¨å®ç°ï¼çµæ´»å¯æ§ï¼å æ·±å¯¹åçççè§£ã</p>
</li>
</ul>
<p>å¶å®å¸éè¿æ»¤å¨çé»è¾å¹¶ä¸å¤æï¼æ ¸å¿å°±æ¯âåå¸æ è®°+æ¦çå¤æ­âãææ¡å®ä¹åï¼é¢å¯¹ç¼å­ç©¿éãæµ·éå»éç­é®é¢ï¼å°±ä¸ç¨åé âå¨éå­å¨âè¿ç§ç¬¨åæ³ï¼è½å¤§å¹æåç³»ç»æ§è½åç©ºé´å©ç¨çãä¸æ¬¡åéå°ç±»ä¼¼åºæ¯ï¼ç´æ¥æåºRediså¸éè¿æ»¤å¨ï¼è½»æ¾æå®ï¼</p>


</div>
<div id="MySignature" role="contentinfo">
    
<p>â¤ï¸ å¦æä½ åæ¬¢è¿ç¯æç« ï¼è¯·ç¹èµæ¯æï¼ ð åæ¶æ¬¢è¿å³æ³¨æçåå®¢ï¼è·åæ´å¤ç²¾å½©åå®¹ï¼</p>

<p>æ¬ææ¥èªåå®¢å­ï¼ä½èï¼<a href="https://www.cnblogs.com/sun-10387834/" target="_blank">ä½ç¥è®©ææ¥å·¡å±±</a>ï¼è½¬è½½è¯·æ³¨æåæé¾æ¥ï¼<a href="https://www.cnblogs.com/sun-10387834/p/19522155" target="_blank">https://www.cnblogs.com/sun-10387834/p/19522155</a></p>


</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-01-31 18:33">2026-01-31 18:32</span>&nbsp;
<a href="https://www.cnblogs.com/sun-10387834">ä½ç¥è®©ææ¥å·¡å±±</a>&nbsp;
éè¯»(<span id="post_view_count">75</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19522155);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19522155', targetLink: 'https://www.cnblogs.com/sun-10387834/p/19522155', title: 'Rediså¿«éå®ç°å¸éè¿æ»¤å¨ï¼ç¼å­å»éçâæºè½é¨å«â' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ æ¶æå¸å¿å¤ï¼ç°åº¦æ¹æ¡æ±æ» ]]></title>
    <link>https://www.cnblogs.com/toplist/p/19527704</link>
    <guid>7e92593f124e573b1bb1fb05309e071f</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/toplist/p/19527704" title="åå¸äº 2026-01-31 17:35">
    <span role="heading" aria-level="2">æ¶æå¸å¿å¤ï¼ç°åº¦æ¹æ¡æ±æ»</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<p>å¤§å®¶å¥½ï¼ææ¯Javaççå¸ãæ¬æç»åç¬èçç»éªåæèï¼å¯¹ç°åº¦æ¹æ¡åä¸ªæ»ç»ï¼éç¹ä»ç»ABå®éªã</p>
<p>ç°åº¦å¨å¼åæµç¨ä¸­éå¸¸æ®éãååå°æµééªè¯ï¼ç¡®è®¤æ è¯¯ååæ¨å¨ï¼ç°åº¦è¿ç¨ä¸­ä¸æ¦åç°ç³»ç»å¼å¸¸ãæä¸å¡ææ å¼å¸¸ï¼åºç«å»åæ»ã</p>
<h1 id="ç°åº¦åºæ¯">ç°åº¦åºæ¯</h1>
<ul>
<li>ä»£ç ç°åº¦ï¼æ¯æå¸åçç°åº¦ï¼ç°åº¦ååæ°é»è¾ï¼ç°åº¦å¤åæ§é»è¾
<ul>
<li>æ¢å¯ä»¥æä¾v2çæ¬æ°æ¥å£ç»è°ç¨æ¹æå¡ï¼ç±è°ç¨æ¹æ¥åç°åº¦åæ¢</li>
<li>ä¹å¯ä»¥åé¨åç°åº¦ï¼åå°è°ç¨æ¹æ æ</li>
</ul>
</li>
<li>åçç°åº¦ï¼ä¸çº¿è¿ç¨ä¸­ï¼æ°çæ¬æå¡å®ä¾ä¸æ­å¢å ï¼éèèå¼å®¹æ°æ§åè®®</li>
<li>éç½®ç°åº¦ï¼ä¿®æ¹éç½®æ¶ï¼ææå¡å®ä¾ç°åº¦æ¨ééç½®åæ´</li>
</ul>
<h1 id="ç°åº¦æ¨¡å¼">ç°åº¦æ¨¡å¼</h1>
<ul>
<li>æ°å­idå°¾å·ç°åº¦ï¼åidæå2ä½ï¼ç¾åæ¯ï¼ãæå3ä½ï¼ååæ¯ï¼ãæå4ä½ï¼ä¸åæ¯ï¼ç­
<ul>
<li>å®ç°æ¹å¼ï¼idåæ¨¡ï¼ä¾å¦ <code>id % 100 &lt; ç°åº¦ç¾åæ¯</code>ï¼åå½ä¸­ç°åº¦</li>
<li>ç¹ç¹ï¼ç®åï¼éç¨äºç»å¤§é¨åææ¯ä¼ååºæ¯</li>
</ul>
</li>
<li>éæºç°åº¦ï¼åä¸é¨åéæºæµéåç°åº¦
<ul>
<li>å®ç°æ¹å¼ï¼<code>ThreadLocalRandom.current().nextInt(100) &lt; ç°åº¦ç¾åæ¯</code></li>
<li>ä¹æä»¥ä½¿ç¨ThreadLocalRandomãèä¸æ¯Randomï¼æ¯ä¸ºäºé¿åå¤çº¿ç¨ç«äºç¨äºçæéæºæ°çseed</li>
</ul>
</li>
<li>A/Bå®éª
<ul>
<li>å®ç°æ¹å¼ï¼åå±å®éªãå®éªæ°æ®æ¶éãç¦»çº¿ç»è®¡</li>
<li>ç¹ç¹ï¼éç¨äºå°æµééªè¯æ°ä¸å¡åè½çææï¼æ´ä½æ¹æ¡ç¸å¯¹å¤æï¼éè¦ææ¯åºå»º</li>
</ul>
</li>
</ul>
<h1 id="idéå">idéå</h1>
<ul>
<li>ä¸å¡idï¼å¦ç¨æ·idãååidç­</li>
<li>è®¾å¤idï¼æªæ³¨å/æªç»å½ç¨æ·ï¼æ­¤æ¶æ²¡æç¨æ·idï¼åªè½åè®¾å¤çå¯ä¸æ è¯</li>
</ul>
<p>ä¸é¢éç¹ä»ç»ä¸ä¸A/Bå®éªã</p>
<h1 id="abå®éª">A/Bå®éª</h1>
<h2 id="ç®ç">ç®ç</h2>
<ul>
<li>å°æµééªè¯æ°ä¸å¡åè½ï¼æ­£åæ¾èåæ¨è³å¨éï¼å¦åç»§ç»­è¿­ä»£ä¼åãæä¸çº¿ï¼é¿ååè½è¿äºèè¿</li>
<li>ç¨æ°æ®ä½ä¸ºä¾æ®ï¼é¿åæ³å½ç¶ãæèè¢å³ç­</li>
</ul>
<h2 id="åå±å®éª">åå±å®éª</h2>
<p>ä¸»è¦ç®çæ¯ä¸ºäºåæ¶åå¤ä¸ªå®éªï¼èä¸æ¯ç»æ¯ä¸ªå®éªååä¸é¨åæµéãå ä¸ºå½åæ¶è¿è¡çå®éªåå¤æ¶ï¼ç»åæ°éæåå¢å ï¼æ¯ä¸ªå®éªåå°çæµéå°±å¾å°äºã<br>
æè¿å å±ç»æï¼å®éªå±ãå®éªãåç»</p>
<ul>
<li>å®éªå±ä¹é´æ­£äº¤ï¼å¯åæ¶è¿è¡å¤ä¸ªå®éªå±çå®éª</li>
<li>åä¸å®éªå±çå®éªä¹é´äºæ¥ï¼æ¯å¦å½ä¸­äºå®éª1-1ï¼å°±ä¸ä¼å½ä¸­å®éª1-2ãå®éªææ0å°å¤ä¸ªåæ¡¶ï¼æ ¹æ®ä¸å¡idå¯è®¡ç®åºæ¡¶å·ï¼è¿èç¥éå½ä¸­åªä¸ªå®éª</li>
<li>åä¸å®éªåæå¤ä¸ªåç»ï¼åæ¬1ä¸ªå¯¹ç§ç»ï¼å1å°å¤ä¸ªå®éªç»ï¼åªä¼å½ä¸­å¶ä¸­ä¸ä¸ªåç»ãåç»ææ0å°å¤ä¸ªåæ¡¶ï¼æ ¹æ®ä¸å¡idå¯è®¡ç®åºæ¡¶å·ï¼è¿èç¥éå½ä¸­åªä¸ªåç»</li>
</ul>
<p>å®éªå±ãå®éªä¸¾ä¾ï¼</p>
<ul>
<li>å±ç¤ºå®éªå±ï¼æ ¹æ®é¡µé¢è¿è¡ååï¼å¦é¦é¡µãæç´¢é¡µãæ¨èé¡µãè¯¦æé¡µç­ãæ¯ä¸ªé¡µé¢ä½ä¸ºä¸ä¸ªå®éªå±ï¼æ¯ä¸ªå®éªå±éå¯åæ¶åå¤ä¸ªå±ç¤ºå®éª</li>
<li>ç®æ³å®éªå±ï¼æ ¹æ®åºæ¯è¿è¡ååï¼å¦ç¸ä¼¼æ¨èãæ­éè´­æ¨èãä¸ªæ§åæ¨èãæç´¢æåºãå¹¿åæåºç­ãæ¯ä¸ªåºæ¯ä½ä¸ºä¸ä¸ªå®éªå±ï¼æ¯ä¸ªå®éªå±éå¯åæ¶åå¤ä¸ªç®æ³å®éª</li>
</ul>
<p><img src="https://img2024.cnblogs.com/blog/1247698/202601/1247698-20260127012326894-198795136.png" alt="image" loading="lazy"></p>
<h2 id="åå¸ç®æ³ææ£">åå¸ç®æ³ææ£</h2>
<p>è¦åæ¶æ¯æå¤ä¸ªåå±å®éªï¼æ ¸å¿å¨äºéè¿åå¸ç®æ³å°æ¯ä¸å±çæµéææ£ï¼ç¨äºå®ç°âåååæµâåâå±é´æ­£äº¤âï¼ä½¿å¾æµéå¨åä¸ªå®éªçæææ­£è´æµæ¶ï¼æè½å¾å°çå®çå¯¹æ¯ç»æã<br>
ä»¥ä¸æ¯è®¡ç®å®éªå±æ¡¶å·çä»£ç ç¤ºä¾ï¼å®éªæ¡¶å·åçï¼</p>
<pre><code class="language-java">import com.google.common.hash.Hashing;
import java.nio.charset.StandardCharsets;

public class ABTestRouter {

    /**
     * æ ¹æ®ç¨æ·IDåå®éªå±IDï¼å®éªå±IDåå½ççè§è²ï¼ï¼è®¡ç®æ¡¶å· (0-99)
     */
    public static int getBucket(String userId, String layerId) {
        // 1. æ¼æ¥ Key: "layerId:userId"
        String key = layerId + ":" + userId;

        // 2. ä½¿ç¨ MurmurHash3 (32-bit)
        // Guava ç murmur3_32_fixed æ¯çº¿ç¨å®å¨ç
        int hash = Hashing.murmur3_32_fixed()
                .hashString(key, StandardCharsets.UTF_8)
                .asInt();

        // 3. åæ¨¡å¹¶ç¡®ä¿ç»æä¸ºæ­£æ°
        // Math.abs(Integer.MIN_VALUE) ä¼è¿åè´æ°ï¼æä»¥æ¨èä½¿ç¨ä½è¿ç®å»é¤ç¬¦å·ä½
        return (hash &amp; Integer.MAX_VALUE) % 100;
    }

    public static void main(String[] args) {
        String uid = "user_123456";
        
        // ä¸åå±çæµéæ¯æ­£äº¤çï¼ææ£éæ°åéï¼
        System.out.println("å±ç¤ºå±æ¡¶å·: " + getBucket(uid, "layer_ui"));
        System.out.println("ç®æ³å±æ¡¶å·: " + getBucket(uid, "layer_algo"));
    }
}
</code></pre>
<p>ä¹æä»¥ç¨murmurhashï¼èémd5ï¼æ¯å ä¸ºmd5æ¯å å¯ç®æ³ï¼è®¡ç®å¼éæ´å¤§ï¼å¨ABå®éªä¸­ä»éååææ£å³å¯ï¼æ éæå¿æ ¹æ®åå¸ç»æåæ¨åæã<br>
ä¹æä»¥æå®éªå±idä½ä¸ºçï¼æ¯å ä¸ºå¾®å°çè¾å¥å·®å¼é½ä¼å¯¼è´åå¸ç»æç¸å·®å·¨å¤§ï¼å®ç°ææ£çææã</p>
<h2 id="å®éªæ°æ®æ¶é">å®éªæ°æ®æ¶é</h2>
<p>å®éªæ°æ®æ¶éæµç¨å¦ä¸ï¼</p>
<ul>
<li>å¨ABå®éªç®¡çç³»ç»ä¸­éç½®å®éªä¿¡æ¯ï¼å¦å®éªçå¼ãæ¡¶å·ä¸å®éªç»çæ å°å³ç³»ç­ï¼å¯å¨æä¿®æ¹</li>
<li>ä»£ç é»è¾å¼åï¼
<ul>
<li>å¼å¥å®éªsdkï¼sdkå¨å¯å¨ãæéç½®åæ´æ¶æåå®éªä¿¡æ¯ï¼æ¬å°è®¡ç®ä¸å¡idçæ¡¶å·ï¼è¿èå¾å°å½ä¸­çåç»</li>
<li>å¯¹ç§ç»åå½åé»è¾ï¼å®éªç»1åé»è¾1ï¼å®éªç»2åé»è¾2</li>
</ul>
</li>
<li>å¨æ­£å¼å¼å§ABå®éªä¹åï¼ååAAåæ¡¶å®éªï¼æ¨¡æå®éªç»ãå¯¹ç§ç»çç»æï¼å¤æ­æ¯å¦ååï¼é¿ååæ¡¶ä¸ååå¸¦æ¥éè¯¯çå®éªç»æ</li>
<li>å®éªå¼å§ï¼åç«¯åç¹ï¼sdkååºåç«¯åç¹æ¶æ¯
<ul>
<li>æ¶æ¯æ ¼å¼ä¸¾ä¾ï¼<code>ä¸å¡id, å®éªå±id, å®éªid, åç»id, æ¡¶å·, è§¦åæ¶é´</code></li>
</ul>
</li>
<li>å®éªè¿ç¨ï¼å®éªæç»­æ¶é´è³å°ä¸å¨ï¼è¦çå·¥ä½æ¥ãå¨æ«/åæï¼é¿ååæ¶é´å¨æå¸¦æ¥çæ³¢å¨å½±å</li>
<li>ç¦»çº¿ç»è®¡å®éªææï¼
<ul>
<li>åç«¯åç¹æ°æ®å¯¼å¥æåäºä»¶hiveè¡¨</li>
<li>ä¸å¡DBæ°æ®å¯¼å¥è¡ä¸ºäºä»¶hiveè¡¨ï¼å¦æ³¨åãç»å½ãæµè§ãç¹å»ãæ¶èãå è´­ãä¸åãæ¯ä»ç­ï¼åå³äºå®éªå³æ³¨çä¸å¡ææ </li>
<li>ææåäºä»¶ãè¡ä¸ºäºä»¶joinèµ·æ¥ï¼å¯¹æ¯å®éªç»ãå¯¹ç§ç»çä¸å¡ææ å·®å¼</li>
</ul>
</li>
</ul>
<p><img src="https://img2024.cnblogs.com/blog/1247698/202601/1247698-20260131014010302-1779078827.png" alt="image" loading="lazy"></p>
<p>ä»¥ä¸æ¯sqlç¤ºä¾ï¼ä»£è¡¨ä»å®éªæåå24å°æ¶ååä¸ªåç»çè½¬åçå¯¹æ¯ã</p>
<pre><code class="language-sql">SELECT 
    e.group_id,
    COUNT(DISTINCT e.user_id) as exposed_users,
    COUNT(DISTINCT a.user_id) as converted_users,
    COUNT(DISTINCT a.user_id) / COUNT(DISTINCT e.user_id) as conversion_rate
FROM exposure_events e
LEFT JOIN action_events a ON e.user_id = a.user_id 
    AND a.event_time BETWEEN e.event_time AND (e.event_time + INTERVAL 24 HOUR)
WHERE e.experiment_id = 'ui_test_001'
GROUP BY e.group_id;
</code></pre>
<h2 id="å®éªæ¥è¡¨åæ">å®éªæ¥è¡¨åæ</h2>
<p>è¯ä¼°å®éªç»ææ¯å¦æ­£åãæ¯å¦æ¾èãäºè§£ç»è®¡å­¦éçæ ¸å¿æ¦å¿µï¼è½çæå®éªæ¥è¡¨å³å¯ã</p>
<h3 id="på¼">på¼</h3>
<p>ç¨æ¥è¡¡éå®éªç»ææ¯å¦æ¾èï¼på¼çå«ä¹æ¯ï¼åè®¾å®éªç»ä¸å¯¹ç§ç»æ²¡æåºå«ï¼æ­¤æ¶è§å¯å°å®éªæå·®å¼çæ¦çãä¸è¬è¦æ± <code>p &lt; 0.05</code>ï¼ä¹å°±æ¯è¯´å®éªç»ææ¾èçæ¦çå¤§äº95%ï¼<code>1 - 0.05 = 95%</code>ï¼</p>
<h3 id="ç½®ä¿¡åºé´">ç½®ä¿¡åºé´</h3>
<p>å¨æ¾èçåæä¸ï¼ç¨æ¥è¡¡éå®éªç»ææ¯å¦æ­£åï¼ä»£è¡¨ä¸å¡ææ çå¯è½èå´åå¸ã<br>
æ¯å¦ï¼å®éªç»æéä¸å¡ææ æåäº1%ï¼95%ç½®ä¿¡åºé´å¨[0.8%, 1.2%]ï¼åä»£è¡¨æ95%çææ¡å¯ä»¥æä¸å¡ææ æåè³å°0.8%ãè³å¤1.2%ï¼æææ­£åãå¦æç½®ä¿¡åºé´çä¸çæ¯è´æ°ï¼å°±æå¯è½æ¯è´åææäºï¼éè¦è­¦æã</p>
<p>ä»¥ä¸å°±æ¯ç°åº¦æ¹æ¡çæ»ç»äºï¼æ¬¢è¿è®¨è®ºäº¤æµã</p>


</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-01-31 17:35">2026-01-31 17:35</span>&nbsp;
<a href="https://www.cnblogs.com/toplist">Javaççå¸</a>&nbsp;
éè¯»(<span id="post_view_count">80</span>)&nbsp;
è¯è®º(<span id="post_comment_count">2</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19527704);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19527704', targetLink: 'https://www.cnblogs.com/toplist/p/19527704', title: 'æ¶æå¸å¿å¤ï¼ç°åº¦æ¹æ¡æ±æ»' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ ç¡¬æ ¸ç§æ®ï¼ä¸ºä½å°ç±³ä»»å¤©å å°æ Rootï¼æ­ç§æä½ç³»ç»ä»å¯å¨å°âå¤ºæâçåºå±æ¸¸æ ]]></title>
    <link>https://www.cnblogs.com/kaiux/p/19558207</link>
    <guid>1f8458a46456c1b5b1dbb35bcbc43e92</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/kaiux/p/19558207" title="åå¸äº 2026-01-31 15:40">
    <span role="heading" aria-level="2">ç¡¬æ ¸ç§æ®ï¼ä¸ºä½å°ç±³ä»»å¤©å å°æ Rootï¼æ­ç§æä½ç³»ç»ä»å¯å¨å°âå¤ºæâçåºå±æ¸¸æ</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                    <div id="cnblogs_post_description" style="display: none">
        <img src="https://img2024.cnblogs.com/blog/1158182/202601/1158182-20260131154106142-1968484472.png" alt="ç¡¬æ ¸ç§æ®ï¼ä¸ºä½å°ç±³ä»»å¤©å å°æ Rootï¼æ­ç§æä½ç³»ç»ä»å¯å¨å°âå¤ºæâçåºå±æ¸¸æ" class="desc_img">
        å°ç±³éBLãä»»å¤©å åç ´è§£ï¼ååå¨æä»ä¹ï¼æ¬æç¡¬æ ¸æè§£ä»å¼æºå°âå¤ºæâçåºå±é»è¾ãç©¿è¶UEFIæåäº¤æ¥ï¼æ­ç§Ring0ç©çé²çº¿ä¸Rootæ¬è´¨ï¼æ·±åº¦åæSwitchç¡¬ç ´çâçµåæéæ³¨å¥âåçãå¸¦ä½ æ·±å¥å¾®è§ä¸çï¼çæè¿åºè¯çæ·±å¤çä¿¡ä»»é¾æ»é²æã
    </div>
<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<p>æè¿æºåæç­é¹çä¸¤ä»¶äºï¼ä¸æ¯å°ç±³å½»åºæ¶ç´§äº Bootloader è§£éæéï¼äºæ¯ä»»å¤©å åèµ·è¯äºå ä¸ªå Switch ç ´è§£è¯ççåå®¶ã</p>
<p>å¾å¤åå¼å¯è½ä¼è§å¾ï¼âæè±é±ä¹°çç¡¬ä»¶ï¼å­ä»ä¹ä¸è®©æå®å¨æ§å¶ï¼â</p>
<p>ä½å¨ååçé»è¾éï¼<strong>ä¸æ¦ä½ æ¿å°äºæé«æéï¼ä½ å°±æç ´äºæä»¬è¾è¦å»ºç«çâåä¸å´å¢âã</strong></p>
<p>ä¸ºäºçæè¿åºå³äºâæ§å¶æâçæäºï¼æä»¬ä¸éè¦å»åæ¯ç¥çãæä½ç³»ç»å¯¼è®ºãï¼åªéè¦æè§è§ç¼©å°å°çº³ç§çº§å«ï¼ççå½ä½ æä¸çµæºé®çé£ä¸æå¿å¨é­çç¬é´ï¼è®¡ç®æºåé¨å°åºä¸æ¼äºä¸åºææ ·çâæåäº¤æ¥âã</p>
<h2 id="ä¸è®èæ¶ä»£çå°å¾">ä¸ãè®èæ¶ä»£çå°å¾</h2>
<p>å¨ CPU ååéæ¥çé£ä¸å»ï¼å®é¢å¯¹çæ¯ä¸çæ¼é»çå­å¨èåââç¡¬çãè¦æåºå¤§çæä½ç³»ç»è£è¿èå­ï¼åå­ï¼éï¼é¦åå¾æä¸å¼ å°å¾ã</p>
<p><strong>1. MBRï¼ä¸ä¸ä»£çèå°å¾</strong></p>
<p>å¨ä»¥åï¼æä»¬ä½¿ç¨çæ¯ <strong>MBR (Master Boot Record)</strong>ãå®çæ ·å­éå¸¸å¯é¸ï¼åªå æ®ç¡¬çæå¼å¤´ç <strong>512 å­è</strong>ã</p>
<p>åªæä½ ç°å¨çç¡¬çæ 10TBï¼MBR ä¹åªæè¿ç¹å°çãè¿å°±å¯¼è´äºå®åå¤©ä¸è¶³ï¼å ä¸ºè®°å½å°åçç©ºé´å¤ªå°ï¼å®æå¤§åªè½è¯å« <strong>2TB</strong> çç¡¬çï¼èä¸æå¤åªè½å <strong>4 ä¸ªä¸»ååº</strong>ãå®å°±åä¸æ¬åªæä¸é¡µç®å½çèæ§ç¬è®°æ¬ï¼æ¢åä¸ä¸å¤ªå¤ä¸è¥¿ï¼ä¹æå¼ä¸äºéå¾å¤§åå¸çè·¯ã</p>
<p><strong>2. GPTï¼æ°ä¸ççå¨æ¯å¯¼èª</strong></p>
<p>ç°å¨ççµèå ä¹é½æ é <strong>UEFI</strong> å¯å¨ï¼ä¸ä¹æ­éçæ¯ <strong>GPT (GUID Partition Table)</strong> ååºè¡¨ã</p>
<p>å®çä¼å¿æ¾èæè§ï¼å½»åºæç ´äºå®¹éåååºæ°éçéå¶ï¼æ³åå¤å°å°±åå¤å°ãæ´éè¦çæ¯å®å·å¤äº<strong>å®¹ç¾æºå¶</strong>ââMBR åäºï¼æ´åç¡¬ççæ°æ®å¯è½å°±è¯»ä¸åºæ¥äºï¼ä½ GPT èªæå°å¨ç¡¬ççâè½¦å¤´âåâè½¦å°¾âåå­äºä¸ä»½ï¼åäºè¿è½æã</p>
<p>ä¸ºäºç§é¡¾é£äºèæ§çè½¯ä»¶ï¼ç°å¨ç GPT ç¡¬çè¿ä¼å¨å¼å¤´ä¿çä¸ä¸ªâåè£ç MBRâãå®çå¯ä¸ä½ç¨å°±æ¯åè¯èè½¯ä»¶ï¼âè¿åç¡¬çå·²ç»æä¸»äºï¼å«ä¹±å¨ãâ</p>
<p><img src="https://img2024.cnblogs.com/blog/1158182/202601/1158182-20260131153816610-848754645.jpg" alt="mbrvsgpt" loading="lazy"></p>
<h2 id="äºç¬¬ä¸æ£ç«ç¬æ">äºãç¬¬ä¸æ£ç«ç¬æ</h2>
<p>å½ä½ æä¸çµæºé®ï¼çµæµæ¶å¥ä¸»æ¿ï¼CPU åçç¬¬ä¸ä»¶äºæ¯âç¡¬ç¼ç âåæ­»çï¼å¼ºå¶è¯»åä¸æ®µâç»å¯¹æå¨âçä»£ç ã</p>
<p>è¿éä½çç¡¬ä»¶ççµé­ââ<strong>åºä»¶ (Firmware)</strong>ãä¸è¿ï¼æ ¹æ®è®¾å¤ç±»åçä¸åï¼è¿éçç®¡å®¶ä¹åä¸ºä¸¤æ´¾ã</p>
<p><strong>1. PC ççç®¡å®¶ï¼ä» BIOS å° UEFI</strong></p>
<p>å¨æ¼«é¿ç PC åå±å²ä¸­ï¼ç®¡å®¶æ¢äºä¸å±ã</p>
<ul>
<li><strong>èç®¡å®¶å« BIOS</strong>ãå®æ¯ä¸ªå®æ§æ´¾ï¼åªæ 16 ä½æ±ç¼è¯­è¨ï¼åªè½åæ¿å°è¯»åç¡¬çå¤´é¨ç MBRï¼å¹²æ´»æ¢ä¸æçä½ã</li>
<li><strong>æ°ç®¡å®¶å« UEFI</strong>ãå®æ¬è´¨ä¸å·²ç»æ¯ä¸ä¸ª<strong>å¾®åæä½ç³»ç»</strong>äºãå®è½è¯»ææä»¶ç³»ç»ï¼æ¯å¦ FAT32ï¼ï¼è½ç´æ¥è¿è¡åç¼ä¸º <code>.efi</code> çå¯æ§è¡ç¨åºï¼çè³è½èç½ãè¿ä¹æ¯ä¸ºä»ä¹ç°å¨ç BIOS çé¢è½ç¨é¼ æ ãè½æªå¾ï¼çè³åå¾è±éè¡å¨çåå ã</li>
</ul>
<p><img src="https://img2024.cnblogs.com/blog/1158182/202601/1158182-20260131153830288-1861685661.jpg" alt="bios" loading="lazy"></p>
<p><strong>2. åµå¥å¼ççç®¡å®¶ï¼BootROM</strong></p>
<p>å¯¹äº<strong>å°ç±³ææº</strong>æ <strong>Switch</strong> è¿ç§åµå¥å¼è®¾å¤ï¼éå¸¸æ¯ ARM æ¶æï¼ï¼è½ç¶å®ä»¬æ²¡æåçµèé£æ ·å¯ä»¥æ <code>Del</code> é®è¿å¥çå¾å½¢å UEFI çé¢ï¼ä½æ ¸å¿é»è¾æ¯ä¸æ ·çã</p>
<p>å®ä»¬ä¾é çæ¯è¯çåºåæ¶å°±å¨åé¨ç§å½æ­»çä¸å°æ®µä»£ç ââ<strong>BootROM</strong>ãå®æ¯ç¡¬ä»¶èéåæ§è¡çç¬¬ä¸æ®µä»£ç ï¼æ¯ä»»ä½è½¯ä»¶é½æ©ï¼ä¸æ æ³è¢«ä¿®æ¹ãå®çèè´£åä¸èç¥å£ï¼åå§åæåºæ¬çç¡¬ä»¶ï¼ç¶åå»å¯»æ¾å¹¶éªè¯ä¸ä¸æ£æ¥åèã</p>
<h2 id="ä¸çµæ´»çä¸­é´äºº">ä¸ãçµæ´»çä¸­é´äºº</h2>
<p>å½ UEFI æ BootROM èªæ£å®ç¡¬ä»¶ï¼åå¤ææåç§»äº¤ç»æä½ç³»ç»æ¶ï¼å®ä¸ä¼ç´æ¥å¤é Windows æ Linux çåæ ¸ï¼èæ¯åå¤éä¸ä½ä¸­é´äººââ<strong>Bootloader</strong>ï¼å¨ Linux PC ä¸çééå¸¸æ¯ GRUBï¼å¨å®å/ææºä¸çééå¸¸æ¯ U-Boot æååèªç ç Bootloaderï¼ã</p>
<p><strong>ä¸ºä»ä¹è¦ç»ä¸åï¼ä¸è½ç´æ¥å è½½åæ ¸åï¼</strong></p>
<p>åå å¨äºæä½ç³»ç»åæ ¸ï¼Kernelï¼å¤ªâå¨è´µâäºï¼</p>
<ol>
<li>å®å¯è½éè¦ç¹æ®çå¯å¨åæ°ï¼æ¯å¦ä½ éè¦è¿å¥å®å¨æ¨¡å¼ï¼æèå¼å¯è°è¯ï¼ã</li>
<li>å®å¯è½èººå¨åºä»¶è¯»ä¸æçæä»¶ç³»ç»éï¼æ¯å¦ Linux ç Ext4 æ ¼å¼ï¼UEFI åçå¯è½åªè®¤ FATï¼ã</li>
<li>ä½ å¯è½å®è£äºåç³»ç»ï¼éè¦æäººæ¥é®ä½ å°åºè¿åªä¸ä¸ªã</li>
</ol>
<p>æä»¥ï¼Bootloader å°±åæ¯ä¸ä¸ªä¸ä¸çâé¢è·¯äººâãå®è´è´£æåæ ¸æä»¶ï¼<code>vmlinuz</code>ï¼ååå§åæä»¶ç³»ç»ï¼<code>initrd</code>ï¼æ¬è¿å°åå­éï¼ä¸ååå¤å°±ç»ªåï¼æ§è¡ä¸ä¸ªä¿¡ä»°ä¹è·ï¼Jump æä»¤ï¼ï¼å° CPU çæ§å¶æå½»åºç§»äº¤ç»åæ ¸ã</p>
<p><img src="https://img2024.cnblogs.com/blog/1158182/202601/1158182-20260131153843749-1017464152.jpg" alt="bootloader" loading="lazy"></p>
<h2 id="åé¶çº§æ£®ä¸¥">åãé¶çº§æ£®ä¸¥</h2>
<p>åæ ¸ï¼Kernelï¼ä¸æ¦æ¥ç®¡äº CPUï¼åçç¬¬ä¸ä»¶äºå°±æ¯å©ç¨ CPU çç¡¬ä»¶ç¹æ§ï¼å»ºç«èµ·æ£®ä¸¥çç­çº§å¶åº¦ãè¿æ¯ç³»ç»å®å¨çåºç³ã</p>
<p><strong>1. æ¶å¤±ç Ring 1 å Ring 2</strong></p>
<p>Intel x86 æ¶æå¨è®¾è®¡ä¹åï¼å¶å®å®ä¹äº 4 ä¸ªç¹æçº§ï¼<strong>Ring 0</strong>ï¼åæ ¸ï¼æé«æéï¼ã<strong>Ring 1 &amp; 2</strong>ï¼åæ¬ç»é©±å¨ï¼ã<strong>Ring 3</strong>ï¼åºç¨ç¨åºï¼æä½æéï¼ã</p>
<p><strong>ä½å¨ç°ä»£æä½ç³»ç»ï¼Windows/Linuxï¼ä¸­ï¼Ring 1 å Ring 2 å ä¹è¢«åºå¼äºï¼åªå©ä¸äºä¸¤æååç Ring 0 å Ring 3ã</strong></p>
<p>è¿ææ ¸å¿çåå æ¯<strong>ç§»æ¤æ§ï¼Portabilityï¼</strong>ãå½å¹´ç Linux å Windows NT ä¸ºäºè½è·å¨ä¸åç CPU æ¶æä¸ï¼æ¯å¦ MIPSãARMï¼ï¼éå°äºä¸ä¸ªå¤§é¾é¢ï¼å¾å¤é x86 ç RISC æ¶æç¡¬ä»¶è®¾è®¡ä¸éå¸¸ç²¾ç®ï¼<strong>åªæ¯æä¸¤ä¸ªå±çº§</strong>ï¼åæ ¸æ Kernel Mode åç¨æ·æ User Modeï¼ãä¸ºäºä¿è¯ä»£ç éç¨ï¼æä½ç³»ç»è®¾è®¡èç´¢æ§å³å®ï¼âå¥½ï¼é£æä»¬ä¹åªç¨ä¸¤å±ï¼æä¸­é´çç æãâ</p>
<p><strong>2. ç©çå±é¢çé²çº¿</strong></p>
<p>ç°å¨ç CPU åé¨ï¼æä¸ä¸ª <strong>CS å¯å­å¨</strong> æç¡®è®°å½äºå½åçèº«ä»½ï¼</p>
<ul>
<li><strong>0 (ä¸å¸æ¨¡å¼)</strong>ï¼ä½ å¯ä»¥æ§è¡æææä»¤ï¼å¼å³ä¸­æ­ãè¯»åä»»æåå­ãç´æ¥æä½ç¡¬ç IOã</li>
<li><strong>3 (å¹³æ°æ¨¡å¼)</strong>ï¼ä½ åªè½åæ°å­¦è¿ç®ï¼ä¸¥ç¦ç´æ¥è§¦ç¢°ç¡¬ä»¶ã</li>
</ul>
<p>å¦æä½ ç Appï¼è¿è¡å¨ Ring 3ï¼è¯å¾æ§è¡ä¸æ¡âè¯»åç¡¬çâçæ±ç¼æä»¤ï¼CPU ç¡¬ä»¶å¨è§£ç é¶æ®µå°±ä¼åç°ï¼âä½ åªæ 3 çº§æéï¼å´æ³æ§è¡ 0 çº§æä»¤ï¼â äºæ¯ç´æ¥æåºå¼å¸¸ï¼åæ ¸æè·åä¼ç´æ¥æè¿ä¸ª App ææââè¿å°±æ¯ç¨åº<strong>å´©æºï¼Crashï¼</strong>çæ¬è´¨ã</p>
<p><strong>3. å¯ä¸çééï¼Syscall</strong></p>
<p>é£å¹³æ°ï¼Appï¼æ³åäºï¼æ¯å¦è¯»æä»¶ãèç½ï¼æä¹åï¼å¿é¡»å»æ²è¡é¨çé¼ââè¿å«<strong>ç³»ç»è°ç¨ï¼Syscallï¼</strong>ã</p>
<ol>
<li>App æ§è¡ <code>SYSCALL</code> æä»¤ã</li>
<li>CPU ç¬é´åæ¢å° Ring 0ï¼è·³è½¬å°åæ ¸é¢è®¾å¥½çä»£ç ä½ç½®ã</li>
<li><strong>æ¢æ ï¼Stack Switchingï¼</strong>ï¼è¿æ¯å³é®ä¸æ­¥ï¼CPU ä¼èªå¨ææ æéä»âç¨æ·æ âåæ¢å°âåæ ¸æ âãè¿æ¯ä¸ºäºé²æ­¢é»å®¢å¨æ éåé·ï¼ç¡®ä¿åæ ¸å¨ä¸ä¸ªç»å¯¹å¹²åçç¯å¢ä¸å·¥ä½ã</li>
<li>åæ ¸æ¿ä½ åå®äºï¼æç»ææ·åç¨æ·åå­ï¼ç¶åéå Ring 3ã</li>
</ol>
<p><img src="https://img2024.cnblogs.com/blog/1158182/202601/1158182-20260131153901587-891608174.jpg" alt="rings" loading="lazy"></p>
<h2 id="äºçåç¾ç´ç">äºãçåç¾ç´ç</h2>
<p>è¿æ¯å¾å¤ææ¯ç±å¥½èæå®¹æææ··çå°æ¹ï¼<strong>âæææº Root äºï¼æ¯ä¸æ¯å°±æå³çæç App è¿è¡å¨ Ring 0 äºï¼â</strong></p>
<p><strong>ç­æ¡æ¯ï¼NOãå³ä½¿ä½  Root äºï¼ä½ ç App ä¾ç¶è¿è¡å¨ Ring 3ã</strong></p>
<p><strong>1. Root åªæ¯ä¸ä¸ªâéè¡è¯â</strong></p>
<p>æä»¬éè¦åºåä¸¤ä¸ªæ¦å¿µï¼</p>
<ul>
<li><strong>Root (User ID = 0)</strong>ï¼è¿æ¯<strong>è½¯ä»¶å±é¢</strong>çæ¦å¿µãå®åªæ¯ Linux ç³»ç»éçä¸æ¡ç¨æ·è®°å½ãå®çæåå¨äºï¼<strong>åæ ¸è¢«è®¾è®¡ä¸ºâæ æ¡ä»¶å¬ä» Root ç¨æ·çè¯·æ±âã</strong></li>
<li><strong>Ring 0</strong>ï¼è¿æ¯<strong>ç¡¬ä»¶å±é¢</strong>çæ¦å¿µãåªæåæ ¸ä»£ç æ¬èº«è¿è¡å¨è¿éã</li>
</ul>
<p><strong>2. çå¸ä¸å½å­æ</strong></p>
<p>å½ä½ è·åäº Root æéï¼è¿è¡ä¸ä¸ªå½ä»¤ <code>rm -rf /</code>ï¼å åºè·è·¯ï¼æ¶ï¼è¿ç¨æ¯è¿æ ·çï¼</p>
<ol>
<li><strong>Root ç¨æ·</strong> åèµ·å é¤æä»¶çè¯·æ±ã</li>
<li><strong>åæ ¸</strong> æ£æ¥åèµ·èï¼åï¼æ¯ ID ä¸º 0 çå¤§å¥åãè½ç¶å é¤ç³»ç»æä»¶å¾å±é©ï¼ä½æ¢ç¶å¤§å¥è¯´äºï¼æå°±ç§åã</li>
<li><strong>åæ ¸ï¼Ring 0ï¼</strong> é©±å¨ç¡¬çç£å¤´ï¼ç©çæ¦é¤æ°æ®ã</li>
</ol>
<p><strong>æ»ç»ä¸ä¸</strong>ï¼Root ç¨æ·å°±åæ¯æ¿çâå£æ¨âçé¦å·®å¤§è£ï¼ä½ä»æ¬èº«è¿æ¯ä¸ªäººï¼è¿è¡å¨ Ring 3ï¼ï¼è Ring 0 ææ¯é£ä¸ªçæ­£æåå¨æçå½å­æã<strong>Root æ¿å°äºæé«è¡æ¿æï¼ä½æ²¡ææ¿å°æé«ç©çæ§è¡æã</strong></p>
<p><img src="https://img2024.cnblogs.com/blog/1158182/202601/1158182-20260131153913727-1769032851.jpg" alt="rootvsring" loading="lazy"></p>
<h2 id="å­æç ´æ·é">å­ãæç ´æ·é</h2>
<p>çè§£äºä¸é¢çâä¿¡ä»»é¾âåâæéå¢âï¼æä»¬ç»äºå¯ä»¥çæé»å®¢æ¯å¦ä½ä¸æ­¥æ­¥æ»ç ´ç³»ç»çãè¿ä¸ªè¿ç¨ï¼æ¬è´¨ä¸å°±æ¯ä¸åºç²¾å¯çå¤ç§ææ¯ã</p>
<p><strong>1. æå¼å°æ¡ï¼ææºè§£é BL (Bootloader)</strong></p>
<p>æ­£å¸¸çææºå¯å¨é¾æ¡æ¯ä¸¥ä¸åç¼çï¼<strong>BootROM (ç¡¬ä»¶)</strong> â <strong>éªè¯ Bootloader ç­¾å</strong> â <strong>éªè¯ Kernel (ç³»ç»åæ ¸) ç­¾å</strong>ã</p>
<p>æè°ç <strong>BL é</strong>ï¼å°±æ¯ååè®© Bootloader ä¸¥æ ¼æ¥éªä¸ä¸çº§ï¼Kernelï¼æ¯ä¸æ¯å®æ¹ååçãå¦ææ¯å®æ¹çï¼æ¾è¡ï¼å¦æè¢«äººå¨è¿æèï¼æ¯å¦ä¸ºäº Rootï¼ï¼æç»å¯å¨ã</p>
<p>è<strong>è§£é BL</strong>ï¼å°±æ¯ç¨å®æ¹ç»çå·¥å·ï¼æèå©ç¨æ¼æ´ï¼ï¼ç» Bootloader ä¸è¾¾ä¸éæä»¤ï¼âå«æ¥ç­¾åäºï¼ä¸ç®¡æå·è¿å»ä»ä¹çä¸å«ç³çåæ ¸ï¼ä½ é½ç»æè·ãâ</p>
<p><em>æ³¨æä»£ä»·ï¼è§£é BL è½ç¶è®©ä½ è·å¾äºèªç±ï¼ä½ä¹<strong>ç ´åäºå®æ´çä¿¡ä»»é¾</strong>ï¼Android Verified Bootï¼ãæ­¤æ¶ï¼ç³»ç»éç TEEï¼å¯ä¿¡æ§è¡ç¯å¢ï¼ä¼æç¥å°ç¯å¢ä¸å®å¨ï¼ä»èå¯¼è´é¶è¡ App éªéãå¾®ä¿¡/æ¯ä»å®æçº¹æ¯ä»å¤±æç­åæã</em></p>
<p><strong>2. æ¤å¥åè¢ï¼ä»è§£éå°è·å Root çå¨è¿ç¨</strong></p>
<p>å¾å¤å°ç½ä»¥ä¸ºè§£äº BL å°±èªå¨ Root äºï¼å¶å®ä¸æ¯ãè§£éåªæ¯æå¼äºå¤§é¨ï¼æ¿é´ï¼ç³»ç»ï¼è¿æ¯ç©ºçãè¦æ¿å° Rootï¼å¿é¡»è¿è¡ä¸åº<strong>âå¨å®ç§»æ¤â</strong>ã</p>
<p>ä»¥ Android ä¸ææµè¡ç Magisk ä¸ºä¾ï¼å®çæ ¸å¿é­æ³å«å <strong>"Systemless"ï¼ä¸è§¦å¨ System ååºï¼</strong>ï¼æ åæµç¨æ¯ï¼</p>
<ol>
<li><strong>æåå¨å®</strong>ï¼ä»å®æ¹å·æºåéæååº <strong><code>boot.img</code></strong>ã</li>
<li><strong>ææ¯æ¹é </strong>ï¼Magisk ä¼åçæ¯ä¸æ ·ï¼æèªå·±çæ ¸å¿ä»£ç ï¼<code>su</code> æä»¶åå®æ¤è¿ç¨ï¼<strong>æ³¨å¥</strong> å°è¿ä¸ªéåéï¼èå®å¨ä¸å»ä¿®æ¹åæ¬ç System ååºã</li>
<li><strong>ç§»æ¤ææ¯</strong>ï¼å ä¸ºä½ ä¹å<strong>è§£éäº BL</strong>ï¼Bootloader çå°è¿ä¸ªè¢«ç¯¡æ¹è¿çéåï¼è½ç¶ç­¾åä¸å¯¹ï¼ä½å®è¸è¸è©ï¼âåæ­£ä½ è§£éäºï¼ä½ å¼å¿å°±å¥½âï¼ç¶åæå®å·è¿äºç¡¬çã</li>
<li><strong>å¤ºè</strong>ï¼ææºéå¯ï¼åæ ¸å è½½ãMagisk çå®æ¤è¿ç¨éä¹å¯å¨ï¼æ¥ç®¡äºæéç®¡çã</li>
</ol>
<p><img src="https://img2024.cnblogs.com/blog/1158182/202601/1158182-20260131153926524-1349870764.jpg" alt="å·æº" loading="lazy"></p>
<p><strong>3. ç»æç ´è§£ï¼Switch ä¸è¯çç¡¬ç ´</strong></p>
<p>å¦æè¯´ææº Root è¿æ¯è½¯ä»¶å±é¢çåå¼ï¼é£ä¹ Switch çç ´è§£å°±æ¯ç©çå±é¢çæ´åç¾å­¦ãSwitch ç ´è§£çæ ¸å¿å¨åéå¸¸æ´ç´ ï¼<strong>å ä¸ºç©·ï¼ä¸æ³ä¹°æ¸¸æï¼æä»¥å¿é¡»ç»è¿æ¸¸æç­¾åéªè¯ã</strong></p>
<p><strong>(1) ä¸å¤æ¶ä»£çâè½¯ç ´â</strong></p>
<p>ææ©çä¸æ¹ Switchï¼2018 å¹´ååºåï¼ï¼è¯çï¼Tegra X1ï¼éç <strong>BootROM</strong> ä»£ç åæ«äºãé»å®¢ä¸ä»éè¦ç¨ä¸æ ¹åå½¢é<strong>ç­æ¥æææ»è½¨</strong>è¿å¥ RCMï¼æ¢å¤ï¼æ¨¡å¼ï¼è¿éè¦éå<strong>çµèææ³¨å¥å¨éè¿ USB æ¥å£åéä¸æ®µ Payload</strong>ï¼å©ç¨ç¼å²åºæº¢åºæ¼æ´æ¬ºéª CPUãè¿å±äºâèå¤©ç·èµé¥­åâï¼ä»»å¤©å é¤äºåºæ°ç¡¬ä»¶ï¼è½¯ä»¶å±é¢æ ¹æ¬ä¿®è¡¥ä¸äºã</p>
<p><strong>(2) ç°ä»£çâç¡¬ç ´â (Modchip è¯çç ´è§£)</strong></p>
<p>ä»»å¤©å åæ¥ä¿®å¤äºæ¼æ´ãç°å¨çç ´è§£å¿é¡»<strong>ææº</strong>ï¼å¨ä¸»æ¿ä¸æå¶ç²¾ç»å°<strong>çæ¥ä¸é¢ç¬¬ä¸æ¹è¯ç</strong>ãè¿ç©æçåçå« <strong>âçµåæéæ³¨å¥â (Voltage Glitching)</strong>ã</p>
<ul>
<li><strong>ãåçã</strong> Switch å¯å¨æ¶ï¼CPU ä¼è¯»åå®æ¹ Bootloader å¹¶è¿è¡ç­¾åæ ¡éªã</li>
<li><strong>ãæ»å»ã</strong> çå¨ä¸»æ¿ä¸çç ´è§£è¯çåçå»æä¸æ ·ï¼æ­»æ­»ç¯ç CPUãå½ CPU åå¤æ§è¡âæ ¡éªç­¾åâè¿ä¸è¡ä»£ç ç<strong>çº³ç§çº§ç¬é´</strong>ï¼ç ´è§£è¯ççªç¶<strong>æä½ CPU çæ ¸å¿çµå (VCC)</strong>ã</li>
<li><strong>ãç»æã</strong> çµåéª¤éå¯¼è´ CPU å°±åè¢«çµå»äºä¸ä¸ï¼èå­âæµâäºé£ä¹ä¸ç¬é´ãå®åå¥½<strong>è·³è¿äºæ ¡éªæä»¤</strong>ï¼æèå°å¯å­å¨éæ ¡éªå¤±è´¥ç <code>False</code> éè¯¯å°è¯»æäº <code>True</code>ã</li>
</ul>
<p>è¿å°±å¥½æ¯ä¿å®æ¦ä½ä½ è¦æ¥èº«ä»½è¯ï¼ä½ æ²¡å¸¦ãä½å¨ä¿å®å¼ å´é®ä½ âèº«ä»½è¯å¢ï¼âçä¸ç¬é´ï¼ä½ çªç¶å¨ä»è³è¾¹æ²äºä¸è®°é£ãä¿å®èå­ä¸çç©ºç½ï¼ä¸æè¯å°æææï¼âè¡è¡è¡ï¼è¿å»å§ãâ</p>
<p><strong>(3) é¸ å é¹å·¢ï¼Atmosphere (å¤§æ°å±)</strong></p>
<p>æ¢ç¶éè¿âçµå»âä¿å®æ··è¿äºå¤§é¨ï¼æä»¬å°±ä¸å è½½ä»»å¤©å å®æ¹ç³»ç»äºï¼èæ¯å è½½ <strong>Atmosphere</strong>ãå®æ¬è´¨ä¸æ¯ä¸ä¸ª<strong>å®å¶ç Bootloader + ç³»ç»è¡¥ä¸é</strong>ãå®æ¥ç®¡äºå¯å¨æµç¨ï¼å¹¶ä¸å¨åå­ä¸­å®æ¶ä¿®æ¹ä»»å¤©å ç OSï¼æ¬ºéªç³»ç»è¯´ï¼âè¿å¼ ççå¡æ¯éè¿éªè¯çâã</p>
<p><img src="https://img2024.cnblogs.com/blog/1158182/202601/1158182-20260131153938657-967507878.jpg" alt="switch" loading="lazy"></p>
<h2 id="ä¸ç«é¼ æ¸¸æ">ä¸ãç«é¼ æ¸¸æ</h2>
<p>Root æåäºï¼å¹¶ä¸ä»£è¡¨ä½ å¯ä»¥é«ææ å¿§ãäºå®ä¸ï¼è¿ææ¯ä½ å App å¼ååï¼å°¤å¶æ¯é¶è¡ãæ¸¸æï¼ä¹é´âç«é¼ æ¸¸æâçå¼å§ã</p>
<p><strong>1. App æ¯æä¹åç°ä½  Root çï¼</strong></p>
<p>App ä¹æ¯è¿è¡å¨ Ring 3 çå¹³æ°ï¼å®ä¸è½ç´æ¥é® CPU âææ¯ä¸æ¯è¢« Root äºâãä½å®æå¾å¤é´æ¥ææ®µï¼</p>
<ul>
<li><strong>æ¥æ·å£ï¼æä»¶æ«æï¼</strong>ï¼App ä¼å·å·æ«æä½ ç <code>/bin</code> æ <code>/sbin</code> ç®å½ï¼ççææ²¡æ <code>su</code> è¿ä¸ªæä»¶ï¼æèææ²¡æå®è£ <code>Magisk Manager</code> è¿ä¸ª Appã</li>
<li><strong>æçµè¯é®å®¶é¿ï¼Play Integrity APIï¼</strong>ï¼è¿æ¯æç çä¸æãApp ä¼åèµ·ä¸ä¸ªè¯·æ±ï¼éè¿ Google çæå¡å»è¯¢é®ä½ çåºå±ç¡¬ä»¶ãGoogle ä¼æ£æ¥ä½ ç Bootloader ç¶æãå¦æä½ è§£éäºï¼ç¡¬ä»¶å±é¢ç <strong>TEE (å¯ä¿¡æ§è¡ç¯å¢)</strong> å°±ä¼èå®äº¤å¾ï¼âæ¯çï¼æçå¤§é¨è¢«æå¼äºãâ</li>
</ul>
<p><strong>2. Magisk çéèº«æ¯ï¼å½åç©ºé´éç¦» (Namespace Isolation)</strong></p>
<p>æ¢ç¶ App ä¼æ¥æä»¶ï¼é£æä»¬å¨å®æ¥æ¿çæ¶åï¼æè¿ç¦åèèµ·æ¥ä¸å°±å¥½äºï¼è¿å°±æ¯ Magisk Hideï¼ç°å¨è¿åä¸º Zygisk/Shamikoï¼çæ ¸å¿åçã</p>
<p>Linux åæ ¸æä¸ä¸ªå¼ºå¤§çåè½å« <strong>Mount Namespace</strong>ãå®å¯ä»¥è®©æ¯ä¸ªè¿ç¨çå°å®å¨ä¸åçæä»¶ç³»ç»è§å¾ã</p>
<ul>
<li><strong>å¹³æ¶</strong>ï¼ä½ çæä»¶ç³»ç»éç¡®å®æ Root ç¸å³çæä»¶ã</li>
<li><strong>å½ä½ æå¼é¶è¡ App æ¶</strong>ï¼Magisk ä¼ç«å»æ¦æªè¿ä¸ªå¯å¨è¿ç¨ï¼ä¸ºè¿ä¸ªé¶è¡ App åç¬åå»ºä¸ä¸ªâå¹³è¡å®å®âã</li>
<li><strong>å¨é£ä¸ªå®å®é</strong>ï¼Magisk ä¼å©ç¨ <code>unmount</code> æä»¤ï¼æ <code>su</code> æä»¶ãMagisk ç¸å³çæ¨¡åå¨é¨âå¸è½½âæã</li>
<li><strong>ç»æ</strong>ï¼é¶è¡ App çå¼ç¼ï¼çå°çæ¯ä¸ä¸ªå¹²å¹²ååãä»¿ä½ä»æªè¢« Root è¿çå®æ¹ç³»ç»ãå®æ»¡æå°ç¹ç¹å¤´ï¼è®©ä½ éè¿äºã</li>
</ul>
<p><strong>3. éé«ä¸å°ºï¼é­é«ä¸ä¸</strong></p>
<p>ç°å¨ï¼è¿åºæäºå·²ç»è¿åå°äº<strong>ç¡¬ä»¶å±é¢</strong>ã</p>
<p>å <strong>KernelSU</strong> è¿ç§æ°ä¸ä»£ Root æ¹æ¡ï¼ç´æ¥æèªå·±èè¿äºåæ ¸éï¼Ring 0ï¼ï¼è®©è¿è¡å¨ Ring 3 ç App æ ¹æ¬æ ä»æ¥èµ·ãè App åååå¼å§èåææºååï¼è¯å¾éè¿<strong>ç¡¬ä»¶å¯é¥è¯æ (Key Attestation)</strong> è®©ä½ å¨è§£é Bootloader çé£ä¸å»èµ·ï¼å°±æ°¸è¿å¤±å»éè¿âå®å¨éªè¯âçèµæ ¼ã</p>
<p>åªè¦ä½ ä¸ºäºèªç±è§£å¼äºéï¼ä½ å°±æ³¨å®è¦ä¸ç´å¨è¿ä¸ªç«é¼ æ¸¸æééè¿ä¸æ­çâä¼ªè£âçå­ä¸å»ã</p>
<h2 id="å«æ»ç»å¿æºæ¨¡å">å«ãæ»ç»ï¼å¿æºæ¨¡å</h2>
<p>çå®å¨æï¼ä½ åºè¯¥å¨èæµ·éå»ºç«èµ·è¿æ ·ä¸å¼ å¾ï¼</p>
<ol>
<li><strong>å°å¾ (MBR ä¸ GPT)</strong>ï¼å³å®äºå°çæä¹åã</li>
<li><strong>æ¥å (BootROM/UEFI â Bootloader â Kernel)</strong>ï¼æ¯ä¸åºä»ç¡¬ä»¶å°è½¯ä»¶çä¿¡ä»»æ¥åèµã</li>
<li><strong>é«å¢ (Ring 0 vs Ring 3)</strong>ï¼æ¯ä¸ºäºé²æ­¢å¹³æ°ï¼Appï¼çæç¡¬ä»¶ã</li>
<li><strong>Root</strong>ï¼æ¯ Ring 3 ä¸çéççå¸ï¼ä»å¯ä»¥å½ä»¤ Ring 0 åäºï¼ä½ä»èªå·±ä¾ç¶å¨å¢å¤ã</li>
<li><strong>ç ´è§£</strong>ï¼æ è®ºæ¯ Root ææºè¿æ¯ç ´è§£ Switchï¼æ¬è´¨é½æ¯æ³æ¹è®¾æ³<strong>ææ­ä¿¡ä»»é¾çä¼ é</strong>ã</li>
<li><strong>æ»é²</strong>ï¼Root ä¹åï¼æ¯ä¸åºå©ç¨âå¹³è¡å®å®âï¼Namespaceï¼æ¬ºéª App çç«é¼ æ¸¸æã</li>
</ol>


</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.0006944444444444445" data-date-updated="2026-01-31 15:41">2026-01-31 15:40</span>&nbsp;
<a href="https://www.cnblogs.com/kaiux">å¿µé£é¶å£¹</a>&nbsp;
éè¯»(<span id="post_view_count">149</span>)&nbsp;
è¯è®º(<span id="post_comment_count">2</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19558207);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19558207', targetLink: 'https://www.cnblogs.com/kaiux/p/19558207', title: 'ç¡¬æ ¸ç§æ®ï¼ä¸ºä½å°ç±³ä»»å¤©å å°æ Rootï¼æ­ç§æä½ç³»ç»ä»å¯å¨å°âå¤ºæâçåºå±æ¸¸æ' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ AAæ¸¸æèæ¬è§èï¼AA Game Scriptï¼ ]]></title>
    <link>https://www.cnblogs.com/ygluu/p/19550578</link>
    <guid>3dc6a89d73963f4dc5f2c02995f3bc3c</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/ygluu/p/19550578" title="åå¸äº 2026-01-31 15:22">
    <span role="heading" aria-level="2">AAæ¸¸æèæ¬è§èï¼AA Game Scriptï¼</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<font color="#002FA5">
<h2 id="1-ä»ç»">1 ä»ç»</h2>
<p>ä¸­æåï¼AAæ¸¸æèæ¬<br>
è±æåï¼AA Game Script<br>
ç®  ç§°ï¼AAèæ¬ï¼AAGSï¼<br>
ä½  èï¼ygluuï¼ç å®¢ï¼<br>
WeChat: 48092788</p>
<p><strong>AAèæ¬æ¨ä¸ºï¼ä¸ºæ¸¸ææä¾ä¸ç§æ´å ç®åèåçµæ´»çéç¨éç½®æ¹å¼</strong>ã</p>
<p><strong>æ³¨</strong>ï¼<br>
1ãå½åæ ä»»ä½å«ä¹ä»æ¯æ è¯ç¬¦<br>
2ãæ¬äººå¨å¶ä»åæä¸­æå°çæ°æ®åï¼å¨æ¬æä¸­ç»ç§°ä¸ºåéåï¼ä¸¤èç­æ<br>
3ãæ¬æäº¦æ¯æ¬äººè¿å»åå®¢ç¥è¯ç¹çç³»ç»åæ»ç»ï¼ç¸å³åèè§éå½3ï¼<br>
4ãæ¬èæ¬ä¸ºéç¨èæ¬ï¼ä¸å±éäºä»»ä½æ¸¸æç±»å<br>
5ãæä½èè§è¯æéï¼å¦æé·åçº¯å±å·§åï¼è¯·çè¨å¿å ä¹</p>
<p>éå¾ æ¡ä»¶ç³»ç»åçï¼<br>
<img alt="image" loading="lazy" data-src="https://img2024.cnblogs.com/blog/3509144/202509/3509144-20250929195853996-308910414.png" class="lazyload"></p>
<p><strong>ç³»ç»æ¯æ</strong><br>
AAèæ¬çç³»ç»æ¯æå®ç°åçåèéå½6ãä¸ç©çIDãä¸äºçäºä»¶ãä¸äººçæ°æ®ãã<br>
AAèæ¬æä¸¤ç§å¹³å°è§£ææ¹å¼å¯éï¼<br>
1ãç¨å·¥å·å°éç½®è¡¨ææ¥å£è§èé¢åç¿»è¯æluaèæ¬ï¼åèéå½5ãdata-eãçluaé¨åï¼ã<br>
2ãç¨é«çº§è¯­è¨å¨æ¸¸æå¯å¨æ¶è§£ææç¨åºå¯¹è±¡ï¼åèéå½5ãdata-eãçgolangé¨åï¼ã<br>
æ³¨ï¼AAèæ¬è§£å³å¤æ°æ¥å¸¸ç­åéæ±ï¼å°æ°å¤æéæ±å¯ç±Luaèæ¬å®ç°ã</p>
<h2 id="2-on-doæ¨¡å">2 ON-DOæ¨¡å</h2>
<p>å¨æ¸¸æå¼åå½ä¸­ï¼å¤æ°ç­åéç½®éæ±ä¸å¤ä¹ï¼å½ä»ä¹æ¡ä»¶æ»¡è¶³æ¶åä»ä¹äºæï¼èæ¸¸ææä»ç¬æçæ°æ®å½¢æä»èé å°±äºä¸ç§æ¢å®æ¨¡å¼ï¼æä»¥æ¬æå°è¿ç§æ¨¡å¼æ½è±¡ä¸ºON-DOæ¨¡åã<br>
<strong>ON-DOæ¨¡åæ¦å¿µè¯æ±</strong>ï¼</p>
<blockquote style="color: rgba(102, 102, 102, 1); border-left-color: rgba(255, 102, 0, 1)">
ONï¼å¨æç§æ¡ä»¶è¾¾æçæ¶å<br>
DOï¼åä»ä¹äºæ<br>
<br>
Condï¼æ¡ä»¶è¡¨è¾¾å¼ï¼å¦ï¼(A&gt;10)&amp;(B&lt;0)<br>
Actï¼å¨ä½è¡¨è¾¾å¼ï¼å¦ï¼A+11;B-10<br>
</blockquote>
<p>ONè¡¨è¾¾å¼ãCondè¡¨è¾¾å¼ãæ¡ä»¶è¡¨è¾¾å¼ä¸èæ¦å¿µç­åã<br>
DOè¡¨è¾¾å¼ãActè¡¨è¾¾å¼ãå¨ä½è¡¨è¾¾å¼ä¸èæ¦å¿µç­åã</p>
<p><strong>ON-DOæ¨¡åä¸æ­¥éª¤</strong>ï¼<br>
1ãå®ä¹åé<br>
2ãå®åæ¡ä»¶å½æ°åç¼åæ¡ä»¶è¡¨è¾¾å¼<br>
3ãå®åå¨ä½å½æ°åç¼åå¨ä½è¡¨è¾¾å¼</p>
<h2 id="3-æ¡ä»¶è¡¨è¾¾å¼è§è">3 æ¡ä»¶è¡¨è¾¾å¼è§è</h2>
<p><strong>ååè¿ç®</strong>ï¼+ - * /<br>
å¦ï¼ç©å®¶ç­çº§&gt;10 &amp; (ä»æ¥ææª + æ¨æ¥ææª) &gt; 200<br>
<strong>æ¯è¾è¿ç®</strong>ï¼&gt; =&gt; = &lt; &lt;=<br>
æ³¨ï¼<br>
1ãäºä»¶å¤æ­ï¼äºä»¶=è¿å¥å°å¾ï¼è¡¨ç¤ºåä¸äºä»¶ï¼å¤äºä»¶å¯è°ç¨äºä»¶å½æ°ï¼äºä»¶(è¿å¥å°å¾,ææª)<br>
2ãå¤æ­ç­äºåªéè¦ä¸ä¸ªç­äºå·<br>
<strong>é»è¾è¿ç®</strong>ï¼&amp; | and or<br>
<strong>ä¼åçº§</strong>ï¼( )<br>
<strong>åé</strong>: è§éå½åéè¡¨<br>
<strong>å½æ°</strong>: è§éå½å½æ°åº<br>
<strong>å¸¸é</strong>ï¼abc 123 true ...<br>
<strong>æ¶èå¨ä½</strong>(åå·)ï¼-<br>
æ³¨ï¼åå·è¡¨ç¤ºè½å¤æ£åæå®çç©åï¼ç³»ç»èªå¨è¯å«ç©åæä½ï¼ææ°æ®ï¼å¦ï¼ç©å®¶ç­çº§&gt;=10 &amp; å¥åºå·-10 &amp; éå¸-20ï¼ä¹å¯ä»¥ä½¿ç¨æ¶èå½æ°ã</p>
<p><strong>ç¤ºä¾</strong>ï¼</p>
<blockquote style="color: rgba(102, 102, 102, 1); border-left-color: rgba(255, 102, 0, 1)">
ç¤ºä¾1ï¼æ¥æ&gt;=2023-01-01 &amp; æ¶é´&gt;18:00:00 &amp; äºä»¶(è¿å¥å°å¾) &amp; å°å¾(åç§°ï¼è±å±±)<br>
ç¤ºä¾2ï¼ç­çº§&gt;=10 &amp; éå¸-10 &amp; ä¸å±±å¡-20<br>
ç¤ºä¾3ï¼ç­çº§&gt;=20 &amp; (éå¸-30 | ä¸å±±å¡-30)<br>
ç¤ºä¾4ï¼å½åå°å¾=è±å±± &amp; ææ¶ç¬&gt;=100<br>
</blockquote>
<h2 id="4-å¨ä½è¡¨è¾¾å¼è§è">4 å¨ä½è¡¨è¾¾å¼è§è</h2>
<p><strong>ååè¿ç®</strong>ï¼+ - * /<br>
å¦ï¼å¹¸è¿å¼=(åå±æ§(æªç©,å¹¸è¿å¼)+åå±æ§(å°å¾,å¹¸è¿å¼)+åå±æ§(ç©å,å¹¸è¿å¼)+ç©å®¶å¹¸è¿å¼) / 3 * 1.3<br>
<strong>ç´¯è®¡è¿ç®</strong>ï¼+ - * / += -= *= /=<br>
å¦ï¼éå¸+10;éå¸+=10ï¼åè¡¨ç¤ºéå¸ç´¯å 10<br>
<strong>èµå¼(ç½®ä½)</strong>(ç­äºå·æåå·åå¯)ï¼= :<br>
<strong>åéç¬¦</strong>(åå·)ï¼;<br>
<strong>ä¼åçº§</strong>ï¼( )<br>
<strong>å½æ°</strong>ï¼è§éå½å½æ°åºï¼å«è§¦åäºä»¶å½æ°ï¼è§¦å(XXX)</p>
<p><strong>ç¤ºä¾</strong>:</p>
<blockquote style="color: rgba(102, 102, 102, 1); border-left-color: rgba(255, 102, 0, 1)">
ç¤ºä¾1ï¼æ»å»+100;é²å¾¡+20<br>
ç¤ºä¾2: éå¸+20;çµè+20<br>
ç¤ºä¾3ï¼æ¶è(éå¸:100,é¶å¸:200);è·³è½¬(åå¤©é¨,103,304) // å½æ°åæ°è§èç±å½æ°å®ä¹<br>
ç¤ºä¾4ï¼å¥å±(éå¸:100,é¶å¸:200);å¥å±(1001) // å¥å±åéçéç½®ID<br>
ç¤ºä¾5: åå¼=188;è§¦å(åå¼) // è®¾ç½®åå¼åéï¼è§¦ååå¼äºä»¶<br>
ç¤ºä¾6: å°å¾=Map.Name;æªç©=Mon.Name;æªç©ç±»å=çº¢æª;è§¦å(ææª) // è®¾ç½®ææªæ°æ®ï¼è§¦åææªäºä»¶<br>
</blockquote>
<p>æ³¨ï¼<br>
1ãå¨ä½è¡¨è¾¾å¼åå«äºæ°æ®çæä½ãç©åçå¥å±åäºä»¶è§¦åç­ï¼å¦ææç©åå¥å±ç³»ç»ä¼èªå¨åºååªäºæ¯ç©åå¹¶ç»åèåç©ºé´æ¥æ§è¡å¥å±ã<br>
2ãè§¦åäºä»¶æ¯AAèæ¬çæ ¸å¿ï¼ä»ä¼è§¦åå³èæ¡ä»¶çå¤æ­åå¨ä½æ§è¡ã</p>
<h2 id="5-æµç¨æ§å¶è¡¨è¾¾å¼è§èæ´»å¨ç³»ç»è®¾è®¡è§è">5 æµç¨æ§å¶è¡¨è¾¾å¼è§èï¼æ´»å¨ç³»ç»è®¾è®¡è§èï¼</h2>
<p>æµç¨æ§å¶æ¯ON-DOè¡¨è¾¾å¼å¯¹ç»åçææ¬æä»¶ï¼å¦ï¼ctrl.aaï¼é»è®¤éå¯¹æ§è¡ãON-ORåDO-ORè¡¨è¾¾å¼å¯¹æ¯æå³ç³»ï¼ä¸¤å¯¹æå¤å¯¹æ¶è¡¨ç¤ºä»»æä¸å¯¹æ»¡è¶³å³å¯ï¼åå¯¹ä»ç¶è¿æ¯âä¸âå³ç³»ã<br>
ç¤ºä¾ï¼æ´»å¨è¡¨è¾¾å¼</p>
<blockquote style="color: rgba(102, 102, 102, 1); border-left-color: rgba(255, 102, 0, 1)">
Nameï¼æ¯æ¥BOSS
<p>ON: æ¶é´&gt;=18:25<br>
DO:<br>
åå»ºå°å¾(è±å±±, å®å¨å°å¾=1)  // å°å¾è®¾ç½®ä¸ºéææç¶æ<br>
å·æª(å·¨å½, x, y, z)<br>
å¥å£å¾æ (è±å±±); è·é©¬ç¯(å·¨å½åºæ¥æ£ä¹±äºï¼å¿«æ¥å»æå®å§ï¼)<br>
èå¤©(ä¸çé¢é, å·¨å½åºæ¥æ£ä¹±äºï¼å¿«æ¥å»æå®å§ï¼)</p>
<p>ON: æ¶é´&gt;=18:30<br>
DO:<br>
å°å¾åé(è±å±±, å®å¨å°å¾=0)  // 18:30å¼å§ææ<br>
è·é©¬ç¯(å·¨å½åºæ¥æ£ä¹±äºï¼å¿«æ¥å»æå®å§ï¼)<br>
èå¤©(ä¸çé¢é, å·¨å½åºæ¥æ£ä¹±äºï¼å¿«æ¥å»æå®å§ï¼)</p>
<p>// å¦æè¶æ¶å<br>
ON-OR: æ¶é´&gt;=19:00<br>
DO-OR: GOTO(æ¸åº)</p>
<p>// å¦ææ­»äº¡å<br>
ON-OR: æ­»äº¡æªç©=å·¨å½<br>
DO-OR: å¥å±(éå¸:100,è¯æ°´1000);GOTO(æ¸åº)</p>
<p>Labelï¼æ¸åº<br>
// labelä¹åæ æ¡ä»¶çå¯ä»¥ä¸åè¡¨è¾¾å¼, ä¹å¯ä»¥ä¸åON:<br>
ON:<br>
DO: æ¸åº()</p>
</blockquote>
<h2 id="6-éç½®è¡¨è§è">6 éç½®è¡¨è§è</h2>
<p>æ³¨ï¼éç½®è¡¨æ³æçµå­è¡¨æ ¼ä¹ç±»çææ¡£</p>
<h3 id="åºç¡å­æ®µç±»å">åºç¡å­æ®µç±»åï¼</h3>
<p><strong>int</strong> : 64ä½æç¬¦å·æ´å½¢<br>
<strong>bool</strong> : å¸å°å<br>
<strong>string</strong> : å­ç¬¦ä¸²å<br>
<strong>Cond</strong> : æ¡ä»¶è¡¨è¾¾å¼<br>
<strong>Act</strong> : å¨ä½è¡¨è¾¾å¼<br>
<strong>Ctrl</strong>: æµç¨æ§å¶è¡¨è¾¾å¼</p>
<h3 id="å®¹å¨å­æ®µç±»å">å®¹å¨å­æ®µç±»åï¼</h3>
<p><strong>arr</strong> : æ°ç», ç±»åç±ç¬¬ä¸ä¸ªåç´ çåºç¡å­æ®µç±»åå³å®ï¼å¯èªåµå¥ï¼å¦ï¼{{1,3},{3,4}}<br>
<strong>map</strong> : key-valueé®å¼å¯¹åå¸è¡¨ï¼keyç±»åå¯ä¸ºintåstringï¼valueç±»åä½åºæ¬å­æ®µç±»åï¼å¯èªåµå¥ååµå¥arrï¼å¦ï¼{{a=1,b=2},{a=A,b=B},{a=3,b={1,2,3,4}}}</p>
<h3 id="éç¨å­æ®µå">éç¨å­æ®µåï¼</h3>
<p><strong>CfgId</strong> : intï¼éç½®IDï¼å¨å±å¯ä¸ï¼int64å¯è§åå¥½åè¡¨çIDåæ®µèå´ï¼è¡¨åèªå¢ï¼ä¸å¡«åç³»ç»é»è®¤ä½¿ç¨CfgNameå­æ®µçcrc64å¼ï¼ç¢°æåæç¤ºæ¹å<br>
æ³¨ï¼<br>
1ãå¦æéè¦åç»è®¾ç½®çï¼æ¯1ä¸ä¸ä¸ªIDæ®µï¼å¦2ç»IDï¼1000010000ï¼3ç»IDï¼100001000010000,  å³å¯æ ¹æ®åç»ä¿¡æ¯è·åéç½®åå®¹<br>
2ãè¦è§åå·IDæ®µåéæè½ä¿è¯å¨å±å¯ä¸ï¼æèªè¡ä½¿ç¨ieee_crc64ç®æ³è®¡ç®ã<br>
3ãæ¨¡åååè¡¨éç½®æ æ³ç¡®ä¿CfgIDå¨å±å¯ä¸çå¯ä»¥ç¼ºçä¸å¡«ï¼ç³»ç»èªå¨ä½¿ç¨ieee_crc64ç®æ³æ¥è®¡ç®ï¼éç½®çæ¶åä½¿ç¨CfgNameæ¥éç½®å³å¯ã<br>
<strong>CfgName</strong> : stringï¼éç½®åï¼å¨å±å¯ä¸ï¼å¿å¡«ï¼å­ç¬¦ä¸²å<br>
<strong>CfgType</strong> : intï¼éç½®ç±»åï¼å¦ï¼è¯æãè´§å¸ãæ­¦å¨ãæè£ãçº¢æªã<br>
<strong>CfgFlag</strong> ï¼intï¼éç½®æ å¿ï¼å³CfgTypeçç»å<br>
<strong>ShowName</strong> : stringï¼æ¾ç¤ºåç§°ï¼ç¨äºUIå¤å½è¯­è¨ç­ï¼ä¸å¡«åé»è®¤ä½¿ç¨CfgNameï¼å¦æå¤å½è¯­è¨ä½¿ç¨â/âåé<br>
å¦ï¼è´§å¸/money/ë¨¸ëï¼å¯æ ¹æ®è®¾å®çè¯­è¨ç´¢å¼å·è·å<br>
<strong>Prop</strong> : mapï¼è¯¥éç½®å¯¹è±¡å·æçèªèº«å±æ§<br>
å¦å°å¾è¡¨ï¼{å¯ç©¿äºº=false,å¯ç©¿æª=false,é­æ§=20}<br>
æ³¨ï¼å°å¾å±æ§âé­æ§âæ¯ç»åæªç©åç©å®¶æ­»äº¡æ°éç¨å¬å¼è®¡ç®å¾åºçæ°å¼ï¼é­æ§è¶å¤§ç©å®¶è¡ä¸ºä¼ç¼æ¢ãæè½å½ä¸­çä¼éä½ç­ã<br>
<strong>Attr</strong> : mapï¼è¡¨ç¤ºæ¥æèè·å¾çå±æ§å æç­ï¼å¦ç©åè¡¨ï¼{é²å¾¡+100,æ»å»+200}<br>
<strong>Cond</strong> : Condï¼æ¡ä»¶è¡¨ç¤ºå¼<br>
<strong>Act</strong> : Actï¼å¨ä½è¡¨è¾¾å¼ï¼æ¡ä»¶è¾¾æåæ§è¡</p>
<h3 id="éç½®è¡¨æ³¨éè§è">éç½®è¡¨æ³¨éè§èï¼</h3>
<p>è¡¨æ ¼ç¬¬ä¸æ ¼ç¬¬ä¸ä¸ªå­ç¬¦æ¯â/âãâ#âãâ;âä¹ä¸çè¡¨ç¤ºè¯¥è¡ä¸ºæ³¨é<br>
ç¬¬1ä¸ªéæ³¨éçè¡è¡¨ç¤ºå­æ®µå<br>
ç¬¬2ä¸ªéæ³¨éçè¡è¡¨ç¤ºå­æ®µç±»å<br>
ç¬¬3ä¸ªéæ³¨éçè¡è¡¨ç¤ºè¯¥å­æ®µçå½å±ï¼å³æ¯ç±å®¢æ·æå¡ç«¯è°æ¥æ¯éä½¿ç¨çï¼cè¡¨ç¤ºå®¢æ·ç«¯ï¼sè¡¨ç¤ºæå¡ç«¯ï¼csè¡¨ç¤ºå®¢æ·æå¡ç«¯<br>
ä»ç¬¬4ä¸ªéæ³¨éçè¡å¼å§ä¸ºæ°æ®é¨å</p>
<p>éç½®è¡¨ç¤ºä¾ï¼<br>
<img alt="image" loading="lazy" data-src="https://img2024.cnblogs.com/blog/3509144/202601/3509144-20260131151904912-626225154.png" class="lazyload"><br>
æ³¨ï¼å°å¾è¡¨çCondæ¯è¿å¥å°å¾çæ¡ä»¶</p>
<h2 id="7-åéå®ä¹è§è">7 åéå®ä¹è§è</h2>
<p>åéè¡¨ï¼var.xlsx<br>
<img alt="image" loading="lazy" data-src="https://img2024.cnblogs.com/blog/3509144/202601/3509144-20260129194836230-1131129095.png" class="lazyload"></p>
<p><strong>CfgId</strong> : åéIDï¼å¦æä¸å¡«åä½¿ç¨CfgNameè®¡ç®CRC64ï¼ç¢°æåæç¤ºæ¹å<br>
<strong>CfgName</strong> : åéåï¼ç¨äºéç½®æè¿°ï¼å¨å±å¯ä¸<br>
<strong>ShowName</strong> : æ¾ç¤ºåï¼ç¨äºUIç­ï¼ä¸å¡«é»è®¤ç­äºCfgName<br>
å¦ï¼è´§å¸/money/ë¨¸ëï¼å¯æ ¹æ®è®¾å®çè¯­è¨ç´¢å¼å·è·å<br>
<strong>Reset</strong> : intï¼éç½®å¨æï¼ç¨äºå¨ææ§åéå¤ä½ä¸ºåå§åï¼ä¸å¡«å0è¡¨ç¤ºä¸éç½®ï¼1ï¼æ¯æ¥éç½®ï¼2ï¼æ¯å¨éç½®ï¼3ï¼æ¯æéç½®ï¼4ï¼æ¯å¹´éç½®<br>
å¦åéï¼æ¯æ¥ææªãå¨åå¼ãæåå¼ç­<br>
<strong>Valid</strong> : intï¼æææï¼è¿æåç³»ç»ä¸åå­å¨è¿äºåéï¼ä¸å¡«æ0è¡¨ç¤ºæ°¸ä¹ææï¼æç»è¡¨ç°å½¢å¼æ¯å¤±æç§æ¶é´æ³<br>
å¦ï¼â10æ1~10æ10æ¥âè¡¨ç¤ºæ¯å¹´å½åºææï¼10æ10æ¥åç³»ç»ä¸åå­å¨è¿äºåé<br>
<strong>Cond</strong> ï¼æ¡ä»¶è¡¨è¾¾å¼ï¼éç©ºåç³»ç»ä¼ä¾æ®æ¡ä»¶æ§è¡Actå¨ä½è¡¨è¾¾å¼ï¼ç¨äºåéèªèº«çç´¯è®¡è®¡ç®<br>
<strong>Act</strong> : CfgNameçèµå¼å¨ä½è¡¨è¾¾å¼<br>
æ³¨ï¼åéè¡¨çå¨ä½è¡¨è¾¾å¼ä¸è¬åªå¯¹CfgNameçèµå¼æä½ï¼ä¸åºè¯¥åå¶å®æä½<br>
å¦å¨åå¼åéï¼ON:äºä»¶=åå¼ï¼DO:å¨åå¼+=å½ååå¼<br>
å¦å¨åå¼åéï¼ON:äºä»¶=åå¼ï¼DO:æåå¼+=å½ååå¼<br>
å¦æ¯æ¥ææªåéï¼ON:äºä»¶=ææªï¼DO:æ¯æ¥ææª+1<br>
<strong>Init</strong> : åå§å¼ï¼ä¸å¡«é»è®¤0ï¼æ´å½¢å¼ææ<br>
<strong>Min</strong> : æå°å¼ï¼ä¸å¡«é»è®¤0ï¼æ´å½¢å¼ææ<br>
<strong>Max</strong> : æå¤§å¼ï¼ä¸å¡«é»è®¤int64çæå¤§å¼ï¼æ´å½¢å¼ææ</p>
<p><strong>æ³¨</strong>ï¼<br>
åéç±»åæstringãint64ãobjï¼æ éå®ä¹è®¾å®ï¼ä»¥æåä¸æ¬¡èµå¼çç±»åä¸ºåã</p>
<h2 id="8-å»æçº¿ç³»ç»è®¾è®¡è§è">8 å»æçº¿ç³»ç»è®¾è®¡è§è</h2>
<p>äºå®ä¸ä»»å¡ç³»ç»æ¯æ¯è¾å¤æçå»æçº¿ç³»ç»ï¼å»æçº¿æä¸ä¸ªç¹å¾æ¯éçº§åé¶ï¼ä¸å»æçº¿ä¸è¬æå±æ§å æï¼ä¸çº¿éç®ï¼åç©åå¥å±ï¼ä¸æ¬¡æ§ï¼ã</p>
<h3 id="ç­çº§èªå¢">ç­çº§èªå¢</h3>
<p>ç¨âæ¨¡ååâ+âç­çº§âä½ä¸ºç­çº§åéï¼æ¯æ¬¡åçº§åèªå¢ï¼å¦æ¨¡åâèµéçäººâçæ¨¡åç­çº§åéæ¯ï¼èµéçäººç­çº§</p>
<h3 id="ä¸å¯¹on-doæ¨¡å¼">ä¸å¯¹ON-DOæ¨¡å¼ï¼</h3>
<p>å­æ®µï¼Cond<br>
å­æ®µï¼Act<br>
å¦ä¸è¡¨ï¼<br>
<img alt="image" loading="lazy" data-src="https://img2024.cnblogs.com/blog/3509144/202602/3509144-20260201024832189-847974260.png" class="lazyload"></p>
<p>æ³¨ï¼å¨ä½è¡¨è¾¾å¼åå«äºæ°æ®çæä½åç©åçå¥å±ï¼ç³»ç»ä¼èªå¨åºååªäºæ¯ç©åå¹¶ç»åèåç©ºé´æ¥æ§è¡å¥å±ã</p>
<h3 id="ä¸¤å¯¹on-doæ¨¡å¼">ä¸¤å¯¹ON-DOæ¨¡å¼</h3>
<p>å¦æä¸å¯¹ON-DOæ¨¡å¼ä¸è½æ»¡è¶³è¦æ±çåä½¿ç¨æ¬æ¨¡å¼ã<br>
å­æ®µï¼Cond1<br>
å­æ®µï¼Act1<br>
å­æ®µï¼Cond2<br>
å­æ®µï¼Act2<br>
æ¡ä»¶Cond1æ»¡è¶³äºä¸æ¬¡æ§æ§è¡å¨ä½Act1ï¼æ¡ä»¶Cond2æ»¡è¶³äºä¸æ¬¡æ§æ§è¡å¨ä½Act2ï¼ä¸¤èä»¥âæâå³ç³»æ§è¡ï¼æå¤§å¯è½ä¸¤èé½æ»¡è¶³ï¼<br>
ç¬¬1å¯¹å¯ä»¥ç¨äºåºç¡æ°æ®çè®¡ç®ï¼å¦ï¼ON:äºä»¶=ææª &amp; å°å¾=åå¤©é¨ï¼DO: ä»æ¥ææª+1ï¼<br>
ç¬¬2å¯¹åç¨ç¬¬1å¯¹çæ°æ®ä½ä¸ºæ¡ä»¶ï¼å¦ï¼ON:ä»æ¥ææª&gt;20ï¼DO: éå¸+20;è¯æ+20<br>
å¦ä¸è¡¨ï¼<br>
<img alt="image" loading="lazy" data-src="https://img2024.cnblogs.com/blog/3509144/202601/3509144-20260131145846276-1004224871.png" class="lazyload"></p>
<p>æ³¨ï¼å¨ä½è¡¨è¾¾å¼åå«äºæ°æ®çæä½åç©åçå¥å±ï¼ç³»ç»ä¼èªå¨åºååªäºæ¯ç©åå¹¶ç»åèåç©ºé´æ¥æ§è¡å¥å±ã</p>
<h3 id="æµç¨æ§å¶ç±»åæ¨¡å¼æ¯è¾å¤æçéæ±">æµç¨æ§å¶ç±»åæ¨¡å¼ï¼æ¯è¾å¤æçéæ±ï¼</h3>
<p>å¦æä¸¤å¯¹ON-DOæ¨¡å¼ä¸è½æ»¡è¶³è¦æ±çåä½¿ç¨æ¬æ¨¡å¼ã<br>
å­æ®µï¼Ctrl</p>
<p>æ³¨ï¼å¨ä½è¡¨è¾¾å¼åå«äºæ°æ®çæä½åç©åçå¥å±ï¼ç³»ç»ä¼èªå¨åºååªäºæ¯ç©åå¹¶ç»åèåç©ºé´æ¥æ§è¡å¥å±ã</p>
<h3 id="å±æ§å æ">å±æ§å æ</h3>
<p>å­æ®µï¼Attr map<br>
æ³¨ï¼ä»»å¡ç³»ç»æ²¡æattrå­æ®µï¼ç©å®¶å±æ§å æè®¡ç®çæ¶åå¯ä»¥æ ¹æ®æ¨¡åç­çº§è·åå¶å¼ã</p>
<h3 id="äºä»¶è§¦å">äºä»¶è§¦å</h3>
<p>å»æçº¿ï¼æé¿çº¿ï¼åçº§ä¸å®è¦å¨æåä¸ä¸ªActè¡¨è¾¾å¼çæåä¸å¥è°ç¨è§¦åå½æ°æ¥è§¦ååçº§äºä»¶ï¼å¦éåææ¨¡åï¼xxx;xxx;è§¦å(éåæåçº§)</p>
<p>å¯æ ¹æ®éæ±éæ©éæ©ä¸è¿°3ä¸­æ¨¡å¼ä¹ä¸å®ç°éç½®ã</p>
<h2 id="9-å½æ°å®ä¹è§è">9 å½æ°å®ä¹è§è</h2>
<p>å½æ°å(åæ°1,åæ°2,..)<br>
<strong>æ³¨æ</strong>ï¼<br>
1ãææå½æ°é»è®¤è¿åint64ï¼0è¡¨ç¤ºå¤±è´¥ï¼ç­äºå¸å°å¼çfalse<br>
2ãå½æ°åæ°è§èç±åå½æ°å®ä¹</p>
<h2 id="éå½1-åéåº">éå½1 åéåº</h2>
<p>â¢æ¶é´<br>
â¢æ¥æ<br>
â¢æ¶é´æ¥æ<br>
â¢å¹´<br>
â¢æ<br>
â¢æ¥<br>
â¢å¤©<br>
â¢ææ<br>
â¢æ¶<br>
â¢å<br>
â¢ç§<br>
â¢å°å¾ // å½åæå¨å°å¾<br>
â¢X // å½åä½ç½®Xåæ <br>
â¢Y // å½åä½ç½®Yåæ <br>
â¢Z // å½åä½ç½®Zåæ <br>
â¢åå¼ // å½ååå¼åéï¼äº¦å³æåä¸æ¬¡åå¼</p>
<p>å¯èªè¡è¡¥åå®å</p>
<h2 id="éå½2-äºä»¶åº">éå½2 äºä»¶åº</h2>
<p>â¢è·¨å¹´ // æ¶é´ä¿¡æ¯æ¹å<br>
â¢è·¨æ<br>
â¢è·¨å¤©<br>
â¢è·¨å¨<br>
â¢è·¨æ¶<br>
â¢è·¨å<br>
â¢è·¨ç§<br>
â¢ä¸çº¿<br>
â¢ä¸çº¿<br>
â¢æ­çº¿<br>
â¢è¿å¥å°å¾<br>
â¢ç¦»å¼å°å¾<br>
â¢æ­»äº¡ // è¢«å¯¹æææ­»<br>
â¢ææ­» // ååææ­»ä¸ä¸ªå¯¹æ<br>
â¢å¤æ´»<br>
â¢èµ°<br>
â¢è·<br>
â¢è·³<br>
â¢é£<br>
â¢è·¯è¿ // ä»å¯¹æ¹xè·ç¦»èµ°è¿<br>
â¢ç¢°ãå¯¹è¯ // ç¢°å°å¯¹æ¹ãå¯¹è¯<br>
â¢è¸©ãç©¿ // è¸©å°æç©¿è¿å¯¹æ¹</p>
<p>å¯èªè¡è¡¥åå®å</p>
<h2 id="éå½3-å¬å±å½æ°åº">éå½3 å¬å±å½æ°åº</h2>
<p>å¬å±å½æ°åºå¯ä»¥å¨æ¡ä»¶è¡¨è¾¾å¼(Cond)åå¨ä½è¡¨è¾¾å¼(Act)ä¸­ä½¿ç¨<br>
â¢åå±æ§(å¯¹è±¡ç±»å, å±æ§å)  // åå½åæä½çç©åéç½®çPropå­æ®µ<br>
å¦ï¼åå±æ§(å°å¾, å±æ§å)  // åå½åå°å¾å±æ§<br>
å¦ï¼åå±æ§(å¯¹æ¹, å±æ§å)  // åPKå¯¹æ¹çå±æ§<br>
â¢æ¶è(A:100,B:200,...)  // æ¶èç©åï¼è¿å0è¡¨ç¤ºæå</p>
<p>å¯èªè¡è¡¥åå®å</p>
<h2 id="éå½4-æ¡ä»¶å½æ°åº">éå½4 æ¡ä»¶å½æ°åº</h2>
<p>æ¡ä»¶å½æ°åªè½å¨æ¡ä»¶è¡¨è¾¾å¼(Cond)ä¸­ä½¿ç¨<br>
â¢äºä»¶(A,B,...) // å¤æ­å½åäºä»¶æ¯å¦å¨æåçäºä»¶åè¡¨ä¸­</p>
<p>å¯èªè¡è¡¥åå®å</p>
<h2 id="éå½5-å¨ä½å½æ°åº">éå½5 å¨ä½å½æ°åº</h2>
<p>å¨ä½å½æ°åªè½å¨å¨ä½è¡¨è¾¾å¼(Act)ä¸­ä½¿ç¨<br>
â¢è§¦å(A,B,...) // ä¾æ¬¡è§¦åæåäºä»¶ï¼è§¦åæµç¨ï¼äºä»¶=A;è°ç¨çå¬åè°;äºä»¶=0<br>
â¢å¥å±(A:100,B:200,...)ãå¥å±(10003) // è°ç¨IDæå®çå¥å±åè®¾å®å®ç°<br>
â¢å·æª(ä¼å°é­,1,203,235)ãå·æª(80001) // è°ç¨IDæå®çå¸æªè®¾å®å®ç°<br>
â¢è·³è½¬(åå¤©é¨,304,208)ãè·³è½¬(åå¤©é¨,304,208,10)// æå®èå´éæº<br>
â¢å¤æ´»(åå¤©é¨,304,208)ãå¤æ´»() // åå°å¤æ´»<br>
â¢èµ°(304,256) // ç±åç¹å°ç®æ ç¹<br>
â¢è·(304,256)<br>
â¢è·³(304,256)<br>
â¢é£(304,256,503) // ç±åç¹å°ç®æ 3Dç¹<br>
â¢å¬å(Txt) // Txt æ¯æå¯ææ¬<br>
â¢è·é©¬ç¯(Txt)<br>
â¢èå¤©(é¢éï¼Txt)<br>
â¢æ¾ç¤ºå¥å£å¾æ (å¾æ ç¼å·)  // å¨å®¢æ·ç«¯æ¾ç¤ºå¥å£å¾æ ï¼å¾æ ç¼å·ç±å¥å£å¾æ è¡¨æä¾</p>
<p>å¯èªè¡è¡¥åå®å</p>
<h2 id="éå½6-ç¸å³åèé¾æ¥">éå½6 ç¸å³åèé¾æ¥</h2>
<p>ãéç¨æ°æ®å¼æ(data-e)åå¶å¨æ¨¡ååæ¸¸æå¼åä¸­çåºç¨ææ³å¾è§£ãï¼<br>
<a href="https://blog.csdn.net/guestcode/article/details/139897257" target="_blank" rel="noopener nofollow">https://blog.csdn.net/guestcode/article/details/139897257</a></p>
<p>ãä¸ç©çIDãä¸äºçäºä»¶ãä¸äººçæ°æ®ãï¼<br>
<a href="https://www.cnblogs.com/ygluu/p/19117836" target="_blank">https://www.cnblogs.com/ygluu/p/19117836</a></p>
</font>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="1.03125" data-date-updated="2026-02-01 16:07">2026-01-31 15:22</span>&nbsp;
<a href="https://www.cnblogs.com/ygluu">ç å®¢-ygluu</a>&nbsp;
éè¯»(<span id="post_view_count">119</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19550578);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19550578', targetLink: 'https://www.cnblogs.com/ygluu/p/19550578', title: 'AAæ¸¸æèæ¬è§èï¼AA Game Scriptï¼' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ ææç¯å¢åéå·²ç»è§£å¯ï¼ä¸ºå¥@ConfigurationProperties æ³¨å¥è¿æ¯å å¯å¼ï¼ ]]></title>
    <link>https://www.cnblogs.com/javadaydayup/p/19561154</link>
    <guid>453fbf2c0f74d26c1bcf3f83bebaf74f</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/javadaydayup/p/19561154" title="åå¸äº 2026-02-01 17:25">
    <span role="heading" aria-level="2">ææç¯å¢åéå·²ç»è§£å¯ï¼ä¸ºå¥@ConfigurationProperties æ³¨å¥è¿æ¯å å¯å¼ï¼</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                    <div id="cnblogs_post_description" style="display: none">
        <img src="https://img2024.cnblogs.com/blog/1878162/202602/1878162-20260201172521159-1975418198.png" alt="ææç¯å¢åéå·²ç»è§£å¯ï¼ä¸ºå¥@ConfigurationProperties æ³¨å¥è¿æ¯å å¯å¼ï¼" class="desc_img">
        ææç¯å¢åéå·²ç»è§£å¯ï¼ä¸ºå¥@ConfigurationProperties æ³¨å¥è¿æ¯å å¯å¼ï¼æ¬æå°ä»æºç è§åº¦è¿è¡åæï¼
    </div>
<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h2 id="é®é¢èæ¯">é®é¢èæ¯</h2>
<p>å¨å¾®æå¡ç application.properties æä»¶ä¸­æä¸ä¸ª <code>test.container-name</code> éç½®ãåå§éç½®å¦ä¸ï¼</p>
<pre><code class="language-json">test.container-name=Tomcat
</code></pre>
<p>åæ¶æä¸ä¸ª Java ç±» <code>TestConfigProperty</code> ä¸­éè¿ <code>@ConfigurationProperties</code> æ³¨è§£æ³¨å¥è¿ä¸ªéç½®å±æ§å°å®çåé <code>containerName</code> ä¸­ï¼ä»£ç å¦ä¸ï¼</p>
<pre><code class="language-java">@ConfigurationProperties(prefix = "test")  
@Component  
public class TestConfigProperty {  
    private String containerName;  
  
    public String getContainerName() {  
        return containerName;  
    }  
  
    public void setContainerName(String containerName) {  
        this.containerName = containerName;  
    }  
}
</code></pre>
<p>ç°å¨å ä¸º <code>test.container-name</code> éç½®åå«ææä¿¡æ¯ï¼ä¸è½ç´æ¥éç½®åå§çå¼ï¼éè¦éç½®å å¯ä¹åçå¼ï¼å¨å¾®æå¡å¯å¨çæ¶åè§£å¯ãç°å¨æ¯ <code>test.container-name</code> éç½®å¼ç¨äº <code>TEST_CONTAINER_NAME</code> ç¯å¢åéãéç½®å¦ä¸ï¼</p>
<pre><code class="language-json">test.container-name=${TEST_CONTAINER_NAME}
</code></pre>
<p>ç¶åå¨ç¯å¢åéä¸­éç½®äºå å¯ä¹åçå¼ãå¨æ¬æ¡ä¾ä¸­ä¸ºäºç®åï¼è¿éå å¯å°±ç¨ç Base64 ç¼ç ä½ä¸ºç¤ºä¾æ¼ç¤ºãå¦ä¸å¾æç¤ºï¼<br>
<img src="https://raw.githubusercontent.com/javadaydayup/pictures/main/20260131165916.png" alt="image.png" loading="lazy"></p>
<p><img src="https://raw.githubusercontent.com/javadaydayup/pictures/main/20260131170021.png" alt="image.png" loading="lazy"></p>
<p>å¨é¡¹ç®ä¸­ææ¡æ¶æä¾äºå¨å¾®æå¡å¯å¨æ¶å¯¹å å¯åçå­ç¬¦ä¸²è§£å¯çè½åï¼å®ç°çåºæ¬åçæ¯æä¾äºä¸ä¸ª <code>DecryptEnvironmentPostProcessor</code> ç±»æ©å±äº <code>EnvironmentPostProcessor</code>ã</p>
<p>å¨å®ç <code>postProcessEnvironment()</code> æ¹æ³ä¸­ï¼å¤æ­ç¯å¢åééç½®çå¼æ¯å¦æ¯ä»¥ <code>ENC_</code> å¼å¤´ï¼å¦ææ¯åè¿è¡è§£å¯ãè§£å¯ä¹åæ¾å°ä¸ä¸ª <code>MapPropertySource</code> éé¢ï¼ç¶åæ·»å å°ææç <code>PropertySource</code> çåé¢ãç¤ºä¾ä»£ç å¦ä¸ï¼</p>
<pre><code class="language-java">public class DecryptEnvironmentPostProcessor implements EnvironmentPostProcessor, Ordered {  
    private static final String DECRYPTED_SOURCE_NAME = "decryptedSystemEnvironment";  
  
    @Override  
    public void postProcessEnvironment(ConfigurableEnvironment environment, SpringApplication application) {  
        String systemEnvName = StandardEnvironment.SYSTEM_ENVIRONMENT_PROPERTY_SOURCE_NAME;  
        MapPropertySource systemEnvSource = (MapPropertySource) environment.getPropertySources().get(systemEnvName);  
        Map&lt;String, Object&gt; decryptedMap = new HashMap&lt;&gt;();  
        if (systemEnvSource == null) {  
            return;  
        }  
        systemEnvSource.getSource().forEach((key, value) -&gt; {  
            if (value instanceof String strVal) {  
                // è¿éè¿è¡äºè§£å¯
                if (StringUtils.isNotEmpty(strVal) &amp;&amp; strVal.startsWith("ENC_")) {  
                    String plainText = new String(Base64.getDecoder().decode(strVal.substring(4)));  
                    decryptedMap.put(key, plainText);  
                }  
            }  
        });  
  
        if (!decryptedMap.isEmpty()) {  
            MapPropertySource decryptedSource = new MapPropertySource(DECRYPTED_SOURCE_NAME, decryptedMap);  
            // è¿éæ·»å å°ææçPropertySourceçåé¢
            environment.getPropertySources().addBefore(systemEnvName, decryptedSource);  
        }  
    }  
  
    @Override  
    public int getOrder() {  
        return Ordered.LOWEST_PRECEDENCE;  
    }  
}
</code></pre>
<p>æç§ä¸è¿°éç½®ï¼éè¿è°è¯åç°ç±» <code>TestConfigProperty</code> éé¢æ³¨å¥çè¿æ¯å å¯ä¹åçå¼ï¼èå¹¶ä¸æ¯æ³è¦çè§£å¯ä¹åçå¼ãå¦ä¸å¾æç¤ºï¼<br>
<img src="https://raw.githubusercontent.com/javadaydayup/pictures/main/20260131172818.png" alt="image.png" loading="lazy"><br>
æ¥ç <code>Environment</code> ç <code>getPropertySources()</code> æ¹æ³çè¿åå¼ä¸­ï¼è§£å¯ä¹åçç¯å¢åéå±æ§éç½®ç¡®å®æ¯å¨æªè§£å¯çç¯å¢åéå±æ§éç½®ä¹åï¼æç§ç´è§ä¸ççè§£ï¼é£åºè¯¥æ³¨å¥çæ¯è§£å¯ä¹åçå¼æå¯¹ï¼ä½æ¯å®éç»æå´ä¸æ¯è¿æ ·çãå¦ä¸å¾æç¤ºï¼<br>
<img src="https://raw.githubusercontent.com/javadaydayup/pictures/main/20260201105947.png" alt="image.png" loading="lazy"></p>
<h2 id="é®é¢åç">é®é¢åç</h2>
<p>ä¹åçæç« <a href="https://zhuanlan.zhihu.com/p/1920208706978678739" target="_blank" rel="noopener nofollow">è¿å°±æ¯å®½æ¾çééè§åï¼</a>éé¢è®²äºå®½æ¾ééçåçãå¨ Spring çæ¡æ¶ä½ç³»ä¸­æ¯å¨ <code>ConfigurationPropertiesBindingPostProcessor</code> ä¸­ç <code>postProcessBeforeInitialization()</code> ä¸­å®ç°å¯¹æ <code>@ConfigurationProperties</code> æ³¨è§£ä¿®é¥°ç±»çå±æ§è¿è¡ç»å®çã</p>
<p>å¨å®çåé¨å®éä¸æ¯éè¿è°ç¨ <code>ConfigurationPropertiesBinder</code> ç <code>bind()</code> æ¥å®ç°å±æ§ç»å®çãä»£ç å¦ä¸ï¼</p>
<pre><code class="language-java">public class ConfigurationPropertiesBindingPostProcessor
    implements BeanPostProcessor, PriorityOrdered, ApplicationContextAware, InitializingBean {
    @Override
    public Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException {
        if (!hasBoundValueObject(beanName)) {
            bind(ConfigurationPropertiesBean.get(this.applicationContext, bean, beanName));
        }
        return bean;
    }
    
    private void bind(ConfigurationPropertiesBean bean) {
        if (bean == null) {
            return;
        }
        Assert.state(bean.asBindTarget().getBindMethod() != BindMethod.VALUE_OBJECT,
                "Cannot bind @ConfigurationProperties for bean '" + bean.getName()
                        + "'. Ensure that @ConstructorBinding has not been applied to regular bean");
        try {
            // è¿éå®éä¸æ¯è°ç¨äºConfigurationPropertiesBinderçbind()æ¹æ³
            this.binder.bind(bean);
        }
        catch (Exception ex) {
            throw new ConfigurationPropertiesBindException(bean, ex);
        }
    }
}
</code></pre>
<p><img src="https://raw.githubusercontent.com/javadaydayup/pictures/main/20260131201218.png" alt="image.png" loading="lazy"></p>
<p>å¨ <code>ConfigurationPropertiesBinder</code> ç <code>bind()</code> æ¹æ³åè°ç¨äº <code>Binder</code> ç <code>bind()</code> æ¹æ³ãå¦ä¸å¾æç¤ºï¼<br>
<img src="https://raw.githubusercontent.com/javadaydayup/pictures/main/20260131201526.png" alt="image.png" loading="lazy"></p>
<p>å¨è°ç¨  <code>Binder</code> ç <code>bind()</code> æ¹æ³æ¶ï¼ä¼ææ³¨è§£ä¸éç½®çåç¼ä¼ è¿å»ï¼å¨æ¬æ¡ä¾ä¸­å°±æ¯ <code>test</code>ï¼å¹¶åºäºè¿ä¸ªåç¼åå»ºä¸ä¸ª <code>ConfigurationPropertyName</code> å¯¹è±¡ï¼ç¶åæç»è°ç¨å° <code>bindObject()</code> æ¹æ³ãä»£ç å¦ä¸ï¼</p>
<pre><code class="language-java">public class Binder {
    public &lt;T&gt; BindResult&lt;T&gt; bind(String name, Bindable&lt;T&gt; target, BindHandler handler) {
        // è¿éåºäºteståç¼åå»ºäºConfigurationPropertyNameå¯¹è±¡
        return bind(ConfigurationPropertyName.of(name), target, handler);
    }
    
    private &lt;T&gt; T bind(ConfigurationPropertyName name, Bindable&lt;T&gt; target, BindHandler handler, Context context,
        boolean allowRecursiveBinding, boolean create) {
        try {
            Bindable&lt;T&gt; replacementTarget = handler.onStart(name, target, context);
            if (replacementTarget == null) {
                return handleBindResult(name, target, handler, context, null, create);
            }
            target = replacementTarget;
            // è°ç¨bindObject()æ¹æ³
            Object bound = bindObject(name, target, handler, context, allowRecursiveBinding);
            return handleBindResult(name, target, handler, context, bound, create);
        }
        catch (Exception ex) {
            return handleBindError(name, target, handler, context, ex);
        }
    }
}
</code></pre>
<p>å¨  <code>bindObject()</code> ä¸­é¦åè°ç¨ <code>findProperty()</code> æ¹æ³æ¥æ¾å±æ§ï¼å ä¸ºå½ååªæ¯åç¼ <code>test</code>ï¼å æ­¤è¯å®æ¯æ¾ä¸å°å¯¹åºçå±æ§éç½®çã å æ­¤å¾ä¸èµ°ä¼è°ç¨å° <code>bindDataObject()</code>æ¹æ³ãå¯¹äº JavaBean æ¥è¯´ï¼å¨ <code>Binder</code> ç <code>bindDataObject()</code> æ¹æ³æç»ä¼è°ç¨å° <code>JavaBeanBinder</code> ç <code>bind()</code> æ¹æ³ãä»£ç å¦ä¸ï¼</p>
<pre><code class="language-java">public class Binder {
    private &lt;T&gt; Object bindObject(ConfigurationPropertyName name, Bindable&lt;T&gt; target, BindHandler handler,
	    Context context, boolean allowRecursiveBinding) {
	    ConfigurationProperty property = findProperty(name, target, context);
	    if (property == null &amp;&amp; context.depth != 0 &amp;&amp; containsNoDescendantOf(context.getSources(), name)) {
	        return null;
	    }
	    // çç¥ä¸­é´ä»£ç 
	    
	    //è°ç¨bindDataObject()æ¹æ³
	    return bindDataObject(name, target, handler, context, allowRecursiveBinding);
	}

    private Object bindDataObject(ConfigurationPropertyName name, Bindable&lt;?&gt; target, BindHandler handler,
            Context context, boolean allowRecursiveBinding) {
        if (isUnbindableBean(name, target, context)) {
            return null;
        }
        Class&lt;?&gt; type = target.getType().resolve(Object.class);
        BindMethod bindMethod = target.getBindMethod();
        if (!allowRecursiveBinding &amp;&amp; context.isBindingDataObject(type)) {
            return null;
        }
        
        // æ³¨æè¿éçlambdaè¡¨è¾¾å¼ï¼å¨JavaBeanBinderçbind()æ¹æ³æç»åä¼è°ç¨å°è¿ä¸ªlambdaè¡¨è¾¾å¼
        DataObjectPropertyBinder propertyBinder = (propertyName, propertyTarget) -&gt; bind(name.append(propertyName),
                propertyTarget, handler, context, false, false);
                
	    // è¿éä¼è°ç¨å°JavaBeanBinderçbind()æ¹æ³
        return context.withDataObject(type, () -&gt; fromDataObjectBinders(bindMethod,
                (dataObjectBinder) -&gt; dataObjectBinder.bind(name, target, context, propertyBinder)));
    }
}
</code></pre>
<p>å¨ <code>JavaBeanBinder</code> ç <code>bind()</code> æ¹æ³ä¸­ä¼è·åè¿ä¸ªå¯¹è±¡çææç <code>BeanProperty</code>ï¼ç¶åååè°ç¨å <code>Binder</code> ä¸­çlambdaè¡¨è¾¾å¼äºãä»£ç å¦ä¸ï¼</p>
<pre><code class="language-java">class JavaBeanBinder implements DataObjectBinder {
    @Override
    public &lt;T&gt; T bind(ConfigurationPropertyName name, Bindable&lt;T&gt; target, Context context,
            DataObjectPropertyBinder propertyBinder) {
        boolean hasKnownBindableProperties = target.getValue() != null &amp;&amp; hasKnownBindableProperties(name, context);
        Bean&lt;T&gt; bean = Bean.get(target, hasKnownBindableProperties);
        if (bean == null) {
            return null;
        }
        BeanSupplier&lt;T&gt; beanSupplier = bean.getSupplier(target);
        boolean bound = bind(propertyBinder, bean, beanSupplier, context);
        return (bound ? beanSupplier.get() : null);
    }
    
    private &lt;T&gt; boolean bind(DataObjectPropertyBinder propertyBinder, Bean&lt;T&gt; bean, BeanSupplier&lt;T&gt; beanSupplier,
        Context context) {
        boolean bound = false;
        for (BeanProperty beanProperty : bean.getProperties().values()) { // è·åè¿ä¸ªå¯¹è±¡ä¸ææçBeanPropertyå±æ§
            bound |= bind(beanSupplier, propertyBinder, beanProperty);
            context.clearConfigurationProperty();
        }
        return bound;
    }
    
    private &lt;T&gt; boolean bind(BeanSupplier&lt;T&gt; beanSupplier, DataObjectPropertyBinder propertyBinder,
        BeanProperty property) {
        String propertyName = determinePropertyName(property);
        ResolvableType type = property.getType();
        Supplier&lt;Object&gt; value = property.getValue(beanSupplier);
        Annotation[] annotations = property.getAnnotations();
        Object bound = propertyBinder.bindProperty(propertyName, //è¿ä¸ªå°æ¹å®éä¸ååè°ç¨åBinderä¸­çlambdaè¡¨è¾¾å¼äº
                Bindable.of(type).withSuppliedValue(value).withAnnotations(annotations));
        if (bound == null) {
            return false;
        }
        if (property.isSettable()) {
            property.setValue(beanSupplier, bound);
        }
        else if (value == null || !bound.equals(value.get())) {
            throw new IllegalStateException("No setter found for property: " + property.getName());
        }
        return true;
    }
}
</code></pre>
<p><code>BeanProperty</code> å¯¹è±¡ä¼å° JavaBean ä¸­çå±æ§ç»ä¸ä¸º Dash æ ¼å¼ãå¨æ¬æ¡ä¾ä¸­å±æ§åç§°æ¯ <code>containerName</code>ï¼ç»ä¸ä¹åå°±åæäº <code>container-name</code>ãå¦ä¸å¾æç¤ºï¼<br>
<img src="https://raw.githubusercontent.com/javadaydayup/pictures/main/20260131210506.png" alt="image.png" loading="lazy"></p>
<p>å¨ <code>Binder</code> ä¸­ lambda è¡¨è¾¾å¼ä¼å°å±æ§æ¼æ¥å°å·²æç <code>ConfigurationPropertyName</code> åç¼ä¸ï¼å¨æ¬æ¡ä¾ä¸­å°±åæäº <code>test.container-name</code>ãç¶ååéå½è°ç¨ <code>bind()</code> æ¹æ³ï¼ç¶ååè°ç¨ <code>findProperty()</code> æ¹æ³å°è¯ä»ä»å¯¹åºç <code>ConfigurationPropertySource</code> ä¸­è·åå¯¹åºçéç½®ä¸­æ¥æ¾è¿ä¸ªå±æ§ã</p>
<p>Spring æä¾äº <code>SpringIterableConfigurationPropertySource</code> ä½ä¸º <code>ConfigurationPropertySource</code> å®ç°ç±»ï¼ å®å®éæ¯å¯¹ <code>PropertySource</code> çä¸ä¸ªééï¼åé¨æä¸ä¸ª <code>propertySource</code> è¡¨ç¤ºçæ­£çéç½®ãéè¿è°è¯ <code>contex.getSource()</code> æ¹æ³çè¿åå¼ï¼å¯ä»¥çå°å å¯ä¹åç <code>PropertySource</code> ç¡®å®æ¯å¨æ²¡æå å¯çåé¢ãä»£ç å¦ä¸ï¼</p>
<pre><code class="language-java">DataObjectPropertyBinder propertyBinder = (propertyName, propertyTarget) -&gt; bind(name.append(propertyName), //è¿éå°å±æ§åç§°æ¼æ¥å°teståç¼ä¸
		propertyTarget, handler, context, false, false);
                
private &lt;T&gt; ConfigurationProperty findProperty(ConfigurationPropertyName name, Bindable&lt;T&gt; target,
    Context context) {
    if (name.isEmpty() || target.hasBindRestriction(BindRestriction.NO_DIRECT_PROPERTY)) {
        return null;
    }
    for (ConfigurationPropertySource source : context.getSources()) {
        ConfigurationProperty property = source.getConfigurationProperty(name);
        if (property != null) {
            return property;
        }
    }
    return null;
}
</code></pre>
<p><img src="https://raw.githubusercontent.com/javadaydayup/pictures/main/20260131181044.png" alt="image.png" loading="lazy"></p>
<p>å¨ <code>getConfigurationProperty()</code> æ¹æ³ä¸­é¦åè°ç¨ç¶ç±» <code>SpringConfigurationPropertySource</code> ç <code>getConfigurationProperty()</code> æ¹æ³ãå¨è¯¥æ¹æ³ä¸­ä¼è°ç¨ <code>PropertyMapper</code> ç <code>map()</code> æ¹æ³å¯¹ä¼ å¥ç <code>ConfigurationPropertyName</code> ç±»åç <code>name</code> è¿è¡è½¬æ¢ï¼ç¶åæ ¹æ®è½¬æ¢åæ¿å°çåç§°å» <code>PropertySource</code> ä¸­è·åå¯¹åºçå±æ§ã</p>
<pre><code class="language-java">class SpringConfigurationPropertySource implements ConfigurationPropertySource {
    public ConfigurationProperty getConfigurationProperty(ConfigurationPropertyName name) {
        if (name == null) {
            return null;
        }
        for (PropertyMapper mapper : this.mappers) {
            try {
                for (String candidate : mapper.map(name)) { // è¿éåéè¿PropertyMapperè½¬æ¢åç§°
                    Object value = getPropertySource().getProperty(candidate); // æ ¹æ®è½¬æ¢åçåç§°è·åè·åå¯¹åºçå±æ§
                    if (value != null) {
                        Origin origin = PropertySourceOrigin.get(this.propertySource, candidate);
                        return ConfigurationProperty.of(this, name, value, origin);
                    }
                }
            }
            catch (Exception ex) {
                // Ignore
            }
        }
        return null;
    }
}
</code></pre>
<p>å¨åå»º <code>SpringConfigurationPropertySource</code> å¯¹è±¡æ¶ï¼ä¼æ ¹æ® <code>PropertySource</code> æ¯ <code>MapPropertySource</code> è¿æ¯ <code>SystemEnvironmentPropertySource</code> ï¼ä»èè®¾ç½®ä¸åç <code>mappers</code> å±æ§ï¼å¯¹äº <code>SystemEnvironmentPropertySource</code>ï¼å®ä¼å¤ä¸ä¸ª <code>SystemEnvironmentPropertyMapper</code> ãä»£ç å¦ä¸ï¼</p>
<pre><code class="language-java">class SpringConfigurationPropertySource implements ConfigurationPropertySource {
   private static final PropertyMapper[] DEFAULT_MAPPERS = { DefaultPropertyMapper.INSTANCE };

   private static final PropertyMapper[] SYSTEM_ENVIRONMENT_MAPPERS = { SystemEnvironmentPropertyMapper.INSTANCE,
    DefaultPropertyMapper.INSTANCE };
    
   static SpringConfigurationPropertySource from(PropertySource&lt;?&gt; source) {
        Assert.notNull(source, "Source must not be null");
        PropertyMapper[] mappers = getPropertyMappers(source);
        if (isFullEnumerable(source)) {
            return new SpringIterableConfigurationPropertySource((EnumerablePropertySource&lt;?&gt;) source, mappers);
        }
        return new SpringConfigurationPropertySource(source, mappers);
    }
    
    private static PropertyMapper[] getPropertyMappers(PropertySource&lt;?&gt; source) {
        // è¿éå¤æ­äºå¦ææ¯SystemEnvironmentPropertySourceåä¼è¿åSYSTEM_ENVIRONMENT_MAPPERSï¼éé¢åå«äºSystemEnvironmentPropertyMapper
        if (source instanceof SystemEnvironmentPropertySource &amp;&amp; hasSystemEnvironmentName(source)) {
            return SYSTEM_ENVIRONMENT_MAPPERS;
        }
        return DEFAULT_MAPPERS;
    }
}
</code></pre>
<p>å¯¹äº <code>DefaultPropertyMapper</code> å®ç <code>map()</code> æ¹æ³ä¼ç´æ¥è¿å <code>ConfigurationPropertyName</code> çåç§°ï¼å¨æ¬æ¡ä¾ä¸­å°±ä¼ç´æ¥è¿å <code>test.container-name</code>ãä»£ç å¦ä¸ï¼</p>
<pre><code class="language-java">final class DefaultPropertyMapper implements PropertyMapper {
    @Override
    public List&lt;String&gt; map(ConfigurationPropertyName configurationPropertyName) {
        // Use a local copy in case another thread changes things
        LastMapping&lt;ConfigurationPropertyName, List&lt;String&gt;&gt; last = this.lastMappedConfigurationPropertyName;
        if (last != null &amp;&amp; last.isFrom(configurationPropertyName)) {
            return last.getMapping();
        }
        // è¿éç´æ¥è¿åConfigurationPropertyNameçåç§°
        String convertedName = configurationPropertyName.toString();
        List&lt;String&gt; mapping = Collections.singletonList(convertedName);
        this.lastMappedConfigurationPropertyName = new LastMapping&lt;&gt;(configurationPropertyName, mapping);
        return mapping;
    }
}
</code></pre>
<p>å¯¹äº <code>SystemEnvironmentPropertyMapper</code> å®ä¼è¿åä¸¤ä¸ªæ ¼å¼çåç§°ï¼å¨æ¬æ¡ä¾ä¸­å°±ä¼è¿å <code>TEST_CONTAINERNAME</code> å <code>TEST_CONTAINER_NAME</code> ä¸¤ç§æ ¼å¼ãä»£ç å¦ä¸ï¼</p>
<pre><code class="language-java">final class SystemEnvironmentPropertyMapper implements PropertyMapper {

    public static final PropertyMapper INSTANCE = new SystemEnvironmentPropertyMapper();

    @Override
    public List&lt;String&gt; map(ConfigurationPropertyName configurationPropertyName) {
        String name = convertName(configurationPropertyName);
        String legacyName = convertLegacyName(configurationPropertyName);
        if (name.equals(legacyName)) {
            return Collections.singletonList(name);
        }
        // è¿éä¼è¿åä¸¤ä¸ªæ ¼å¼çåç§°
        return Arrays.asList(name, legacyName);
    }

    private String convertName(ConfigurationPropertyName name) {
        return convertName(name, name.getNumberOfElements());
    }

    private String convertName(ConfigurationPropertyName name, int numberOfElements) {
        StringBuilder result = new StringBuilder();
        for (int i = 0; i &lt; numberOfElements; i++) {
            if (!result.isEmpty()) {
                result.append('_');
            }
            result.append(name.getElement(i, Form.UNIFORM).toUpperCase(Locale.ENGLISH));
        }
        return result.toString();
    }

    private String convertLegacyName(ConfigurationPropertyName name) {
        StringBuilder result = new StringBuilder();
        for (int i = 0; i &lt; name.getNumberOfElements(); i++) {
            if (!result.isEmpty()) {
                result.append('_');
            }
            result.append(convertLegacyNameElement(name.getElement(i, Form.ORIGINAL)));
        }
        return result.toString();
    }

    private Object convertLegacyNameElement(String element) {
        return element.replace('-', '_').toUpperCase(Locale.ENGLISH);
    }
}
</code></pre>
<p>å¨æ¬æ¡ä¾ä¸­<code>decryptedSystemEnvironment</code> ç <code>PropertySource</code> ç±»åæ¯ <code>MapPropertySource</code>ï¼å­æ¾çåå®¹æ¯ <code>TEST_CONTAINER_NAME=Tomcat</code>ãå®åªæ <code>DefaultPropertyMapper</code>ï¼</p>
<p>åç§°ä¸º <code>systemEnvironment</code> ç <code>PropertySource</code> ç±»åæ¯ <code>SystemEnvironmentPropertySource</code>ï¼å­æ¾çåå®¹æ¯ <code>TEST_CONTAINER_NAME=ENC_VG9tY2F0</code>ãå®æ<code>DefaultPropertyMapper</code> å <code>SystemEnvironmentPropertyMapper</code>ã</p>
<p><code>decryptedSystemEnvironment</code> å¨é¡ºåºä¸æå¨ <code>systemEnvironment</code> åé¢ãè¿ä¸ªæ¶åå¼å§æ¥æ¾ä¼ å¥åç§°ä¸º <code>test.container-name</code> ç <code>ConfigurationPropertyName</code>ï¼è¿ä¸ªæ¶ååä» <code>decryptedSystemEnvironment</code> å¼å§æ¾ï¼ç»è¿ <code>DefaultPropertyMapper</code> è½¬æ¢ä¹åæ¿å°çå±æ§åç§°æ¯ <code>test.container-name</code>ï¼éç½®éé¢æ²¡æè¿ä¸ªéç½®ï¼ç¶åä» <code>systemEnvironment</code> å¼å§æ¾ï¼ç»è¿ <code>SystemEnvironmentPropertyMapper</code> è½¬æ¢ä¹åæ¿å°çå±æ§åç§°æ¯<code>TEST_CONTAINERNAME</code> å <code>TEST_CONTAINER_NAME</code>ï¼æ ¹æ® <code>TEST_CONTAINER_NAME</code> å°±æ¿å°äº <code>ENC_VG9tY2F0</code> ãè¿å°±è§£éäºä¸ºå¥éç½®ç±»æ³¨å¥çè¿æ¯å å¯ä¹åçå¼äºã</p>
<h2 id="é®é¢è§£å³">é®é¢è§£å³</h2>
<p>ç¥éé®é¢çåçäºä¹åï¼é®é¢å°±å¥½è§£å³äºãä¸ç§æ¹æ³æ¯å¯ä»¥å¨ <code>DecryptEnvironmentPostProcessor</code> ç±»ç <code>postProcessBeforeInitialization()</code> æ¹æ³ä¸­ææ·»å ç <code>MapPropertySource</code> ç±»åæ¹ä¸º <code>SystemEnvironmentPropertySource</code> å°±å¯ä»¥äºãä»£ç å¦ä¸ï¼</p>
<pre><code class="language-java">@Override  
public void postProcessEnvironment(ConfigurableEnvironment environment, SpringApplication application) {  
    String systemEnvName = StandardEnvironment.SYSTEM_ENVIRONMENT_PROPERTY_SOURCE_NAME;  
    MapPropertySource systemEnvSource = (MapPropertySource) environment.getPropertySources().get(systemEnvName);  
    Map&lt;String, Object&gt; decryptedMap = new HashMap&lt;&gt;();  
    if (systemEnvSource == null) {  
        return;  
    }  
    systemEnvSource.getSource().forEach((key, value) -&gt; {  
        if (value instanceof String strVal) {  
            if (StringUtils.isNotEmpty(strVal) &amp;&amp; strVal.startsWith("ENC_")) {  
                String plainText = new String(Base64.getDecoder().decode(strVal.substring(4)));  
                decryptedMap.put(key, plainText);  
            }  
        }  
    });  
  
    if (!decryptedMap.isEmpty()) {  
		// è¿éåæ¥æ·»å çæ¯MapPropertySourceç±»åï¼ç°å¨è°æ´ä¸ºSystemEnvironmentPropertySourceç±»å
        // MapPropertySource decryptedSource = new MapPropertySource(DECRYPTED_SOURCE_NAME, decryptedMap);  
        environment.getPropertySources().addBefore(systemEnvName, new SystemEnvironmentPropertySource(DECRYPTED_SOURCE_NAME, decryptedMap));  
        System.out.println("");  
    }  
}
</code></pre>


</div>
<div id="MySignature" role="contentinfo">
    æ¬¢è¿å¤§å®¶å³æ³¨æçå¬ä¼å·ãjavadaydayupã
</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-02-01 17:26">2026-02-01 17:25</span>&nbsp;
<a href="https://www.cnblogs.com/javadaydayup">javadaydayup</a>&nbsp;
éè¯»(<span id="post_view_count">3</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19561154);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19561154', targetLink: 'https://www.cnblogs.com/javadaydayup/p/19561154', title: 'ææç¯å¢åéå·²ç»è§£å¯ï¼ä¸ºå¥@ConfigurationProperties æ³¨å¥è¿æ¯å å¯å¼ï¼' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
        </channel>
        </rss>