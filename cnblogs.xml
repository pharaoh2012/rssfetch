<?xml version="1.0" encoding="UTF-8" ?>
    <rss version="2.0">
    <channel>
        <title><![CDATA[ ä¸»é¡µ - åå®¢å­ ]]></title>
        <link><![CDATA[ https://www.cnblogs.com/ ]]></link>
        <lastBuildDate>2026-01-12T04:46:15.226Z</lastBuildDate>
        <description><![CDATA[
        ä¸»é¡µ - åå®¢å­ RSS
    ]]></description>
        <language>zh-cn</language>
        <item>
    <title><![CDATA[ åºäº nano-vLLM å­¦ä¹ å¤§æ¨¡åæ¨çå³é®åè½ ]]></title>
    <link>https://www.cnblogs.com/cswuyg/p/19471225</link>
    <guid>bf8764e806e486971452e1672f4b5754</guid>
    <description>
    <![CDATA[ 
	<div class="postTitle">
		<h1><a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/cswuyg/p/19471225" title="åå¸äº 2026-01-12 12:38">
    <span role="heading" aria-level="2">åºäº nano-vLLM å­¦ä¹ å¤§æ¨¡åæ¨çå³é®åè½</span>
    

</a>
</h1>
	</div>
	<div id="cnblogs_post_body" class="blogpost-body blogpost-body-html">
<blockquote>æ³¨ï¼æ¬æå·²äº2025.12.31 åè¡¨äºç¥ä¹åå¬ä¼å·</blockquote>
<h1 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="avn4e-0-0"><span data-offset-key="avn4e-0-0">1. èæ¯</span></h1>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="7ouoo-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="7ouoo-0-0"><span data-offset-key="7ouoo-0-0">å¦æè¦åä¸ä½å®å¨ä¸äºè§£å¤§æ¨¡åæ¨çææ¯çå¼åèä»ç»è¿ä¸ªé¢åï¼æåºè¯¥ä»åªéè®²èµ·ï¼</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="6ps33-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="6ps33-0-0"><span data-offset-key="6ps33-0-0">å¤§æ¨¡åæ¨ççæç®æµç¨å¯ä»¥æ¦æ¬ä¸ºï¼è¾å¥ä¸ä¸²ææ¬ â ææ¬éè¿è¯å¸æ å°è¡¨è½¬æ¢æä¸ä¸²æ°å­åºå· â åºå·åç»è¿ embedding å±çè®¡ç®ï¼åæä¸ç»è½ä»£è¡¨è¯­ä¹çæµ®ç¹æ°åé â è¿ç»åééå¥æ¨çç³»ç»ï¼ç»è¿å±å±çç©éµä¹æ³ãå æ³ååç±»ä¸ç¨å½æ°çè¿ç®ï¼å¾å°æ°çè¾åºåé â å¯¹è¾åºåéåæ¦çç­éï¼éåºæ¦çæé«çé£ä¸ªæ°å¼å¯¹åºçåºå· â æååéè¿è¯å¸æ å°è¡¨ âç¿»è¯â åæå­ï¼å¾å°æç»è¾åºçä¸ä¸ªè¯ã</span></div>
</div>
<div class="Image-captionContainer" data-size="normal">
<div class="Image-resizerContainer css-ym3v7r" data-size="normal">
<div class="css-79elbk">
<div class="ImageDelete-Container css-xi606m">
<div class="ImageDelete-Wrapper css-1gomreu"><img src="https://pic1.zhimg.com/80/v2-52738e1009b99b73843b74399250f825_1440w.png?source=ccfced1a" width="877" height="204" class="Image FocusPlugin--unfocused Image--isBlock css-1phd9a0" loading="lazy" style="display: block; margin-left: auto; margin-right: auto" data-size="normal" data-rawwidth="2052" data-rawheight="478" data-watermark="original" data-original-src="https://picx.zhimg.com/v2-52738e1009b99b73843b74399250f825.jpg?source=ccfced1a" data-watermark-src="https://pic1.zhimg.com/v2-9a8c84bc6a77d0b121efaf2adca21dc7_1440w.jpg?source=ccfced1a">
<div class="ImageEdit-button css-187js3w" style="text-align: center">å¾ 1&nbsp;</div>
<div class="ImageEdit-button css-187js3w"><span data-offset-key="5galm-0-0">è¿æ¯å¯¹å¤§æ¨¡åæ¨çææ´ç´ ççè§£ï¼ä¸è¿°æµç¨çä¼¼ç®åï¼ä½èåçæ¨çè®¡ç®ç¯èå¯¹æ®éå¼åèèè¨ä»æ¯ä¸ä¸ª âé»çâãå¦ææ³æ´è¿ä¸æ­¥æè§£æ¨çå¼æçåºå±å éåçï¼nano-vllm ä¼æ¯ä¸ä¸ªæä½³çå¥é¨åå¥ç¹ã</span></div>
</div>
</div>
</div>
</div>
</div>
<h1 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="5jkt4-0-0"><span data-offset-key="5jkt4-0-0">2. ç®ä»</span></h1>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="34rn0-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="34rn0-0-0"><a class="Link ztext-link" href="https://github.com/GeeeekExplorer/nano-vllm" target="_blank" data-offset-key="34rn0-0-0" data-editable="true" data-draft-title="nano-vLLM" rel="noopener nofollow">nano-vLLM</a><span data-offset-key="34rn0-1-0"> ä»£ç éä»çº¦ 1200 è¡ï¼å´å®ç°äºçäº§çº§æ¨çæ¡æ¶çæ ¸å¿ææ¯ååï¼å·ä½åæ¬ï¼</span></div>
</div>
<ul class="public-DraftStyleDefault-ul" data-offset-key="56lsc-0-0">
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-reset public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="56lsc-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="56lsc-0-0"><span data-offset-key="56lsc-0-0">è¿ç»­æ¹å¤çï¼Continuous Batchingï¼</span></div>
</li>
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="b1vo5-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="b1vo5-0-0"><span data-offset-key="b1vo5-0-0">KV ç¼å­ï¼Prefix KV Cache / Paged KV Cacheï¼</span></div>
</li>
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="fckbm-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="fckbm-0-0"><span data-offset-key="fckbm-0-0">é«æ§è½ç¼è¯ä¸æ§è¡ä¼åï¼Torch CompilationãTritonãCUDA Graphï¼</span></div>
</li>
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="96skh-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="96skh-0-0"><span data-offset-key="96skh-0-0">å¼ éå¹¶è¡ï¼Tensor Parallelismï¼</span></div>
</li>
</ul>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="etuu5-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="etuu5-0-0"><span data-offset-key="etuu5-0-0">è¯¥æ¡æ¶æå·å¥é¨å­¦ä¹ ä»·å¼ï¼æ¬æå°åä»ç» nano-vLLM çåºæ¬ç»ææ¶æï¼åå¯¹é¨åæ ¸å¿ææ¯è¦ç¹å±å¼æ·±å¥è§£æã</span></div>
</div>
<h1 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="dhpij-0-0"><span data-offset-key="dhpij-0-0">3. ç³»ç»æ¶æ</span></h1>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="9fnhn-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="9fnhn-0-0"><span data-offset-key="9fnhn-0-0">nano-vLLM çæ¶æéå¸¸æå±æ¬¡æã</span></div>
</div>
<h2 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="6ai7a-0-0"><span data-offset-key="6ai7a-0-0">3.1. æ´ä½æ¶ææ¦è§</span></h2>
<div class="Image-captionContainer" data-size="normal">
<div class="Image-resizerContainer css-ym3v7r" data-size="normal">
<div class="css-79elbk">
<div class="ImageDelete-Container css-xi606m">
<div class="ImageDelete-Wrapper css-1gomreu"><img src="https://picx.zhimg.com/80/v2-41cd766bd06373d580df6302b2ba3203_1440w.png?source=ccfced1a" width="655" height="403" class="Image FocusPlugin--unfocused Image--isBlock css-1phd9a0" loading="lazy" style="display: block; margin-left: auto; margin-right: auto" data-size="normal" data-rawwidth="1846" data-rawheight="1136" data-watermark="original" data-original-src="https://picx.zhimg.com/v2-41cd766bd06373d580df6302b2ba3203.jpg?source=ccfced1a" data-watermark-src="https://pic1.zhimg.com/v2-30e994f5b2ec017f3337ad91f566eb88_1440w.jpg?source=ccfced1a">
<div class="ImageEdit-button css-187js3w" style="text-align: center">å¾ 2, æ¥èªï¼https://deepwiki.com/GeeeekExplorer/nano-vllm</div>
</div>
</div>
</div>
</div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="3rfae-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="3rfae-0-0"><span data-offset-key="3rfae-0-0">ä¸å±ç»æ</span></div>
</div>
<ul class="public-DraftStyleDefault-ul" data-offset-key="b0vi3-0-0">
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-reset public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="b0vi3-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="b0vi3-0-0"><span data-offset-key="b0vi3-0-0">æ¥å£å±ï¼User Interface Layer</span></div>
</li>
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="510uv-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="510uv-0-0"><span data-offset-key="510uv-0-0">æ¨çå¼æä¸­æ§å±ï¼Inference Engine Layer</span></div>
</li>
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="2ao8p-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="2ao8p-0-0"><span data-offset-key="2ao8p-0-0">æ¾å­ç®¡çåæ¨¡åæ§è¡å±ï¼Memory Management &amp; Model Execution Layer</span></div>
</li>
</ul>
<h2 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="4o3ac-0-0"><span data-offset-key="4o3ac-0-0">3.2. ç±»å±é¢æ¶æ</span></h2>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="7vkaq-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="7vkaq-0-0"><span data-offset-key="7vkaq-0-0">ä»ç±»è®¾è®¡å±é¢è§å¯ nano-vLLM çæ¶æã</span></div>
</div>
<div class="Image-captionContainer" data-size="normal">
<div>
<div class="Image-resizerContainer css-ym3v7r" data-size="normal">
<div class="css-79elbk">
<div>
<div class="ImageDelete-Container css-xi606m">
<div class="ImageDelete-Wrapper css-1gomreu"><img src="https://pic1.zhimg.com/80/v2-8612f2dcf6e20d6dd1fccb4ebb494bd2_1440w.png?source=ccfced1a" width="409" height="433" class="Image FocusPlugin--unfocused Image--isBlock css-1phd9a0" loading="lazy" style="display: block; margin-left: auto; margin-right: auto" data-size="normal" data-rawwidth="841" data-rawheight="891" data-watermark="original" data-original-src="https://pic1.zhimg.com/v2-8612f2dcf6e20d6dd1fccb4ebb494bd2.jpg?source=ccfced1a" data-watermark-src="https://picx.zhimg.com/v2-3a6dff4e142735a4f58fc285f1b2f992_1440w.jpg?source=ccfced1a">
<div class="ImageEdit-button css-187js3w" style="text-align: center">&nbsp;</div>
<div class="ImageDelete-button css-5sjb75" style="text-align: center">&nbsp;å¾ 3</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="ar0pl-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="ar0pl-0-0"><span data-offset-key="ar0pl-0-0">ä¸å¾ä¸­åç§é¢è²ä»£è¡¨ç³»ç»çåä¸ªç»æé¨å</span></div>
</div>
<ul class="public-DraftStyleDefault-ul" data-offset-key="en3rk-0-0">
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-reset public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="en3rk-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="en3rk-0-0"><span data-offset-key="en3rk-0-0">æµèè²ï¼å¥å£åæ¨çå¼æä¸­æ§å±</span></div>
</li>
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="13d2e-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="13d2e-0-0"><span data-offset-key="13d2e-0-0">æµç»¿è²ï¼æ¨¡åæ¨ç</span></div>
</li>
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="5cb7v-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="5cb7v-0-0"><span data-offset-key="5cb7v-0-0">æµçº¢è²ï¼KV Cache ç®¡ç</span></div>
</li>
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="56eii-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="56eii-0-0"><span data-offset-key="56eii-0-0">æµç´«è²ï¼æéå è½½åç©éµè®¡ç®çå°è£</span></div>
</li>
</ul>
<h2 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="7a956-0-0"><span data-offset-key="7a956-0-0">3.3. ç å±é¢åå</span></h2>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="44m2c-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="44m2c-0-0"><span data-offset-key="44m2c-0-0">æºç è§åä¸ä¹è¾ä¸ºç®æ´ãç®å½ç»æå¦ä¸ï¼</span></div>
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="44m2c-0-0">
<div class="cnblogs_Highlighter">
<pre class="brush:bash;gutter:true;">nanovllm/
âââ engine
âââ layers
âââ models
âââ utils</pre>
</div>
</div>
</div>
<ul class="public-DraftStyleDefault-ul" data-offset-key="lkpt-0-0">
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-reset public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="lkpt-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="lkpt-0-0"><span data-offset-key="lkpt-0-0">engineï¼å¼æçå¥å£ãä¸­æ§ï¼åæ¶ KV Cache æ¯è¾ç®åï¼ä»£ç ä¹æ¾å¨è¿ä¸ªç®å½ä¸ã</span></div>
</li>
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="b95lg-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="b95lg-0-0"><span data-offset-key="b95lg-0-0">layersï¼æ¨¡åæ¨ççéç¨ç»ä»¶ï¼åé¨åæ¬ï¼linearãlayernormãrotary_embeddingãattentionãactivation ç­åºç¡åè½çå°è£ï¼å¯ä»¥è¢«ä¸åæ¨¡åä½¿ç¨ã</span></div>
</li>
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="4eca5-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="4eca5-0-0"><span data-offset-key="4eca5-0-0">modelsï¼æ¨¡åçå®ç°ï¼ä¾èµ layers çç»ä»¶å®ç°ä¸åæ¨¡åçæ¨çã</span></div>
</li>
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="upvc-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="upvc-0-0"><span data-offset-key="upvc-0-0">utilsï¼ä¸åå±é½å¯è½ä¼ç¨å°çå·¥å·å½æ°ã</span></div>
</li>
</ul>
<h1 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="4n7nk-0-0"><span data-offset-key="4n7nk-0-0">4. è¿ç»­æ¹å¤ç</span></h1>
<h2 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="6772e-0-0"><span data-offset-key="6772e-0-0">4.1. æ¦å¿µçè§£</span></h2>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="3533u-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="3533u-0-0"><span data-offset-key="3533u-0-0">ï¼1ï¼å®ä¹</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="5ps6c-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="5ps6c-0-0"><span data-offset-key="5ps6c-0-0">è¿ç»­æ¹å¤ç (Continuous Batching)ï¼æ¯ä¸ç§è¿­ä»£çº§ï¼Iteration-levelï¼çè°åº¦ç­ç¥ãå®ä»¥âToken çææ­¥éª¤âä¸ºè°åº¦ç²åº¦ãéè¿å¨æå°å¨æ¯ä¸è½®è¿­ä»£ä¸­æ¿æ¢å·²å®æçä»»å¡ï¼æ¶é¤äºç±äºçæé¿åº¦ä¸ä¸å¯¼è´ç GPU è®¡ç®æ°æ³¡ï¼æå¤§å°æåäºç³»ç»çååéã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="9hoep-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="9hoep-0-0"><span data-offset-key="9hoep-0-0">ï¼2ï¼æ´ç´ çè§£</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="btvpi-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="btvpi-0-0"><span data-offset-key="btvpi-0-0">ä¸ä¸ªè¯·æ±éè¦æ§è¡å¤è½®ï¼ä¸åè¯·æ±éè¦æ§è¡çè½®æ°ä¸åï¼ç³»ç»ä¸è½®æå¤åªè½åæ¶æ§è¡ä¸æ¹ N ä¸ªè¯·æ±ï¼å½ä¸ä¸ªæ¹æ¬¡éçè¯·æ±åå·®ä¸é½çå®ææ¶ï¼æ¯å®æä¸ä¸ªè¯·æ±å°±å°å¶ç¨æ°è¯·æ±æ¿ä»£æã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="f4ss9-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="f4ss9-0-0"><span data-offset-key="f4ss9-0-0">å¯¹æ¯ä¼ ç»æ¹å¤çåè¿ç»­æ¹å¤çï¼</span></div>
</div>
<ul class="public-DraftStyleDefault-ul" data-offset-key="e3hch-0-0">
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-reset public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="e3hch-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="e3hch-0-0"><span data-offset-key="e3hch-0-0">ä¼ ç»æ¹å¤ç (Static Batching)ï¼å¿é¡»ç­å¾ Batch ä¸­çæåºåæé¿çé£ä¸ªè¯·æ±å®æï¼æ´ä¸ª Batch æä¼éæ¾ãå¨æ­¤æé´ï¼çæåºåç­è¯·æ±å®æåæ§½ä½ä¼ç©ºè½¬ã</span></div>
</li>
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="5sueq-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="5sueq-0-0"><span data-offset-key="5sueq-0-0">è¿ç»­æ¹å¤ç (Continuous Batching)ï¼è¯·æ±å®æå³éåºï¼æ°è¯·æ±ç«å³è¡¥ä½ï¼æ§½ä½å§ç»æ»¡è½½ã</span></div>
</li>
</ul>
<h2 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="fl0na-0-0"><span data-offset-key="fl0na-0-0">4.2. æåºç¡çè¿ç»­æ¹å¤ç</span></h2>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="fuvou-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="fuvou-0-0"><span data-offset-key="fuvou-0-0">æç®åçè¿ç»­æ¹å¤çï¼ä¸èè prefill å decode çå·®å¼ï¼ç¤ºä¾ä»£ç ï¼</span></div>
</div>
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="2i7d8-0-0">
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> time
</span><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> threading
</span><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> queue
</span><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> random

</span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> 1. åå§åçº¿ç¨å®å¨çç­å¾éå</span>
waiting_queue =<span style="color: rgba(0, 0, 0, 1)"> queue.Queue()
MAX_BATCH_SIZE </span>= 3

<span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> --- æ¨¡æç¨æ·è¯·æ±çº¿ç¨ (çäº§è) ---</span>
<span style="color: rgba(0, 0, 255, 1)">def</span><span style="color: rgba(0, 0, 0, 1)"> user_request_producer():
    request_id </span>= 1
    <span style="color: rgba(0, 0, 255, 1)">while</span><span style="color: rgba(0, 0, 0, 1)"> True:
        </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> æ¨¡æç¨æ·éæºå°è¾¾ï¼æ¯ 1~2 ç§æ¥ä¸ä¸ªæ°è¯·æ±</span>
        time.sleep(random.uniform(1, 2<span style="color: rgba(0, 0, 0, 1)">))
        
        </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> æ¯ä¸ªè¯·æ±éè¦ç Token é¿åº¦éæºï¼3å°8ä¹é´ï¼</span>
        req = {<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">id</span><span style="color: rgba(128, 0, 0, 1)">"</span>: f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">REQ-{request_id}</span><span style="color: rgba(128, 0, 0, 1)">"</span>, <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">remain</span><span style="color: rgba(128, 0, 0, 1)">"</span>: random.randint(3, 8<span style="color: rgba(0, 0, 0, 1)">)}
        waiting_queue.put(req)
        
        </span><span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">\n[ç¨æ·ç«¯] éå¥æ°è¯·æ±: {req['id']} (é¢è®¡é¿åº¦: {req['remain']})</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
        request_id </span>+= 1
        <span style="color: rgba(0, 0, 255, 1)">if</span> request_id &gt; 5<span style="color: rgba(0, 0, 0, 1)">:
          </span><span style="color: rgba(0, 0, 255, 1)">break</span>

<span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> --- æ ¸å¿æ¨çå¾ªç¯ (æ¶è´¹è/æ§è¡å¨) ---</span>
<span style="color: rgba(0, 0, 255, 1)">def</span><span style="color: rgba(0, 0, 0, 1)"> inference_loop():
    running_batch </span>=<span style="color: rgba(0, 0, 0, 1)"> []
    
    </span><span style="color: rgba(0, 0, 255, 1)">print</span>(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">--- æ¨çå¼æå·²å¯å¨ ---</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
    iteration </span>=<span style="color: rgba(0, 0, 0, 1)"> 0
    </span><span style="color: rgba(0, 0, 255, 1)">while</span><span style="color: rgba(0, 0, 0, 1)"> True:
        </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> A. è¡¥ä½é»è¾ï¼åªè¦ Batch æ²¡æ»¡ä¸éåéæè´§ï¼å°±æè¿æ¥</span>
        <span style="color: rgba(0, 0, 255, 1)">while</span> len(running_batch) &lt;<span style="color: rgba(0, 0, 0, 1)"> MAX_BATCH_SIZE:
            </span><span style="color: rgba(0, 0, 255, 1)">try</span><span style="color: rgba(0, 0, 0, 1)">:
                </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> ä½¿ç¨ block=Falseï¼å¦æéåç©ºäºç´æ¥æ¥éè¿ exceptï¼ä¸é»å¡æ¨çé»è¾</span>
                new_req = waiting_queue.get(block=<span style="color: rgba(0, 0, 0, 1)">False)
                running_batch.append(new_req)
                </span><span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">  &gt;&gt;&gt; [è°åº¦] {new_req['id']} è¿å¥ Batch</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
            </span><span style="color: rgba(0, 0, 255, 1)">except</span><span style="color: rgba(0, 0, 0, 1)"> queue.Empty:
                </span><span style="color: rgba(0, 0, 255, 1)">break</span>

        <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> B. æ¨çé»è¾ï¼å¦æå½å Batch æä»»å¡ï¼å°±æ§è¡ä¸æ¬¡ Step</span>
        <span style="color: rgba(0, 0, 255, 1)">if</span><span style="color: rgba(0, 0, 0, 1)"> running_batch:
            iteration </span>+= 1
            <span style="color: rgba(0, 0, 255, 1)">print</span>(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">=</span><span style="color: rgba(128, 0, 0, 1)">"</span>*20 + f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">{iteration=}</span><span style="color: rgba(128, 0, 0, 1)">"</span> + <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">=</span><span style="color: rgba(128, 0, 0, 1)">"</span>*20<span style="color: rgba(0, 0, 0, 1)">)
            </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> æ¨¡æ GPU æ¨çèæ¶ (Step èæ¶)</span>
            time.sleep(1.2<span style="color: rgba(0, 0, 0, 1)">) 
            
            </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> å½å Batch ç¶æå±ç¤º</span>
            active_ids = [f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">{r['id']}(å©{r['remain']-1})</span><span style="color: rgba(128, 0, 0, 1)">"</span> <span style="color: rgba(0, 0, 255, 1)">for</span> r <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> running_batch]
            </span><span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">[GPUæ¨ç] å¤çä¸­: {active_ids}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
            
            </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> æ¯ä¸ä¸ªè¯·æ±çå©ä½é¿åº¦å 1</span>
            finished_this_step =<span style="color: rgba(0, 0, 0, 1)"> []
            </span><span style="color: rgba(0, 0, 255, 1)">for</span> req <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> running_batch:
                req[</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">remain</span><span style="color: rgba(128, 0, 0, 1)">"</span>] -= 1
                <span style="color: rgba(0, 0, 255, 1)">if</span> req[<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">remain</span><span style="color: rgba(128, 0, 0, 1)">"</span>] &lt;=<span style="color: rgba(0, 0, 0, 1)"> 0:
                    finished_this_step.append(req)
            
            </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> C. åé¤é»è¾ï¼åå®çç«å»è¸¢åºï¼ä¸ä¸è½®å¾ªç¯å¼å¤´å°±ä¼ææ°è¯·æ±è¡¥è¿æ¥</span>
            <span style="color: rgba(0, 0, 255, 1)">for</span> req <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> finished_this_step:
                </span><span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">  &lt;&lt;&lt; [å®æ] {req['id']} çæå®æ¯ï¼éæ¾ä½ç½®</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
                running_batch.remove(req)
        </span><span style="color: rgba(0, 0, 255, 1)">else</span><span style="color: rgba(0, 0, 0, 1)">:
            </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> å¦æ Batch å éåé½ç©ºäºï¼ç¨å¾®æ­ä¼ï¼é¿å CPU ç©ºè½¬</span>
            time.sleep(0.5<span style="color: rgba(0, 0, 0, 1)">)

</span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> --- å¯å¨ç¨åº ---</span>
<span style="color: rgba(0, 0, 255, 1)">if</span> <span style="color: rgba(128, 0, 128, 1)">__name__</span> == <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">__main__</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">:
    </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> å¯å¨ç¨æ·è¯·æ±çº¿ç¨</span>
    t = threading.Thread(target=user_request_producer, daemon=<span style="color: rgba(0, 0, 0, 1)">True)
    t.start()

    </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> ä¸»çº¿ç¨æ§è¡æ¨çå¾ªç¯</span>
    <span style="color: rgba(0, 0, 255, 1)">try</span><span style="color: rgba(0, 0, 0, 1)">:
        inference_loop()
    </span><span style="color: rgba(0, 0, 255, 1)">except</span><span style="color: rgba(0, 0, 0, 1)"> KeyboardInterrupt:
        </span><span style="color: rgba(0, 0, 255, 1)">print</span>(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">\næå¡å·²åæ­¢</span><span style="color: rgba(128, 0, 0, 1)">"</span>)</pre>
</div>
<p><span data-offset-key="2a0tv-0-0">æ ¸å¿é»è¾ï¼</span></p>
</div>
<ul class="public-DraftStyleDefault-ul" data-offset-key="4phrk-0-0">
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-reset public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="4phrk-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="4phrk-0-0"><span data-offset-key="4phrk-0-0">å­å¨ç»æï¼ä»£ç çæ ¸å¿æä¸¤ä¸ªéåï¼waiting_queue è´è´£å­å¨è¯·æ±çº¿ç¨ä¸æ­æ¥æ¶å°çæ°è¯·æ±ï¼running_queue è´è´£å­å¨å·²ç»è¿è¡ä½è¿æ²¡æç»æçè¯·æ±ã</span></div>
</li>
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="ahrhj-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="ahrhj-0-0"><span data-offset-key="ahrhj-0-0">è¿­ä»£å¾ªç¯ï¼çäº§èæç»­å¾ waiting_queue åå¥æ°è¯·æ±ï¼è¿­ä»£å¾ªç¯æç»­ä» waiting_queue è·åæ°è¯·æ±å å¥å° running_queueï¼åæ¶æ¸ç running_queue éå·²ç»å®æçè¯·æ±ã</span></div>
</li>
</ul>
<h2 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="7obml-0-0"><span data-offset-key="7obml-0-0">4.3. prefill ä¼åçè¿ç»­æ¹å¤ç</span></h2>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="4uau9-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="4uau9-0-0"><span data-offset-key="4uau9-0-0">prefill ä¼åçæ¹å¤çï¼éè¦åºå prefll å decodeï¼ä¼åå¤çæ°è¯·æ±ï¼ç¤ºä¾ä»£ç ï¼</span></div>
</div>
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="45mns-0-0">
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> time
</span><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> queue
</span><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> random
</span><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> threading

</span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> æ ¸å¿éå</span>
waiting_queue =<span style="color: rgba(0, 0, 0, 1)"> queue.Queue()  
running_queue </span>=<span style="color: rgba(0, 0, 0, 1)"> []             

MAX_BATCH_SIZE </span>= 4

<span style="color: rgba(0, 0, 255, 1)">def</span><span style="color: rgba(0, 0, 0, 1)"> user_request_producer():
    </span><span style="color: rgba(128, 0, 0, 1)">"""</span><span style="color: rgba(128, 0, 0, 1)">
    ä¿®æ¹ç¹ï¼æ¨¡æçåå¼è¯·æ±å°è¾¾ï¼ä»¥è§¦åå¤è¯·æ± Prefill
    </span><span style="color: rgba(128, 0, 0, 1)">"""</span>
    <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> ç¬¬ä¸æ³¢ï¼çåå¼å°è¾¾ (3ä¸ªè¯·æ±åæ¶è¿å¥éå)</span>
    <span style="color: rgba(0, 0, 255, 1)">print</span>(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">\n[ç¨æ·] --- çåå¼è¯·æ±å°è¾¾ (3ä¸ªè¯·æ±) ---</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
    </span><span style="color: rgba(0, 0, 255, 1)">for</span> i <span style="color: rgba(0, 0, 255, 1)">in</span> range(1, 4<span style="color: rgba(0, 0, 0, 1)">):
        req </span>= {<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">id</span><span style="color: rgba(128, 0, 0, 1)">"</span>: f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">REQ-{i}</span><span style="color: rgba(128, 0, 0, 1)">"</span>, <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">remain</span><span style="color: rgba(128, 0, 0, 1)">"</span>: random.randint(2, 5<span style="color: rgba(0, 0, 0, 1)">)}
        waiting_queue.put(req)
        </span><span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">[ç¨æ·] è¯·æ± {req['id']} è¿å¥ç­å¾éå</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
    
    </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> å»¶è¿ä¸ä¼å¿ï¼åæ¥ç¬¬äºæ³¢åç¹è¯·æ±</span>
    time.sleep(5<span style="color: rgba(0, 0, 0, 1)">)
    </span><span style="color: rgba(0, 0, 255, 1)">print</span>(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">\n[ç¨æ·] --- å»¶è¿è¯·æ±å°è¾¾ (1ä¸ªè¯·æ±) ---</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
    req </span>= {<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">id</span><span style="color: rgba(128, 0, 0, 1)">"</span>: <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">REQ-4</span><span style="color: rgba(128, 0, 0, 1)">"</span>, <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">remain</span><span style="color: rgba(128, 0, 0, 1)">"</span>: 3<span style="color: rgba(0, 0, 0, 1)">}
    waiting_queue.put(req)
    </span><span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">[ç¨æ·] è¯·æ± {req['id']} è¿å¥ç­å¾éå</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)

</span><span style="color: rgba(0, 0, 255, 1)">def</span><span style="color: rgba(0, 0, 0, 1)"> inference_loop():
    </span><span style="color: rgba(0, 0, 255, 1)">print</span>(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">--- è¿ç»­æ¹å¤çå¼æï¼å¤è¯·æ± Prefill æ¨¡å¼ ---</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
    iteration </span>=<span style="color: rgba(0, 0, 0, 1)"> 0
    
    </span><span style="color: rgba(0, 0, 255, 1)">while</span><span style="color: rgba(0, 0, 0, 1)"> True:
        current_batch </span>=<span style="color: rgba(0, 0, 0, 1)"> []
        is_prefill_stage </span>=<span style="color: rgba(0, 0, 0, 1)"> False
        
        </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> 1. è°åº¦ï¼æå»ºå½åæ¹æ¬¡</span>
        <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> åªè¦ waiting_queue éç©ºï¼å°±å°½å¯è½å¡«æ»¡ MAX_BATCH_SIZE</span>
        <span style="color: rgba(0, 0, 255, 1)">if</span> <span style="color: rgba(0, 0, 255, 1)">not</span><span style="color: rgba(0, 0, 0, 1)"> waiting_queue.empty():
            is_prefill_stage </span>=<span style="color: rgba(0, 0, 0, 1)"> True
            </span><span style="color: rgba(0, 0, 255, 1)">while</span> <span style="color: rgba(0, 0, 255, 1)">not</span> waiting_queue.empty() <span style="color: rgba(0, 0, 255, 1)">and</span> len(current_batch) &lt;<span style="color: rgba(0, 0, 0, 1)"> MAX_BATCH_SIZE:
                req </span>=<span style="color: rgba(0, 0, 0, 1)"> waiting_queue.get()
                current_batch.append(req)
        </span><span style="color: rgba(0, 0, 255, 1)">elif</span><span style="color: rgba(0, 0, 0, 1)"> running_queue:
            is_prefill_stage </span>=<span style="color: rgba(0, 0, 0, 1)"> False
            current_batch </span>=<span style="color: rgba(0, 0, 0, 1)"> list(running_queue)
        
        </span><span style="color: rgba(0, 0, 255, 1)">if</span> <span style="color: rgba(0, 0, 255, 1)">not</span><span style="color: rgba(0, 0, 0, 1)"> current_batch:
            time.sleep(</span>0.5<span style="color: rgba(0, 0, 0, 1)">)
            </span><span style="color: rgba(0, 0, 255, 1)">continue</span>

        <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> 2. æ§è¡ï¼æ¨¡ææ¨ç</span>
        iteration += 1
        <span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">\n{'='*15} Iteration {iteration} {'='*15}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
        
        </span><span style="color: rgba(0, 0, 255, 1)">if</span><span style="color: rgba(0, 0, 0, 1)"> is_prefill_stage:
            </span><span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">[PREFILL] æ¹éçæä¸­: {[r['id'] for r in current_batch]}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
            time.sleep(</span>1.5<span style="color: rgba(0, 0, 0, 1)">) 
        </span><span style="color: rgba(0, 0, 255, 1)">else</span><span style="color: rgba(0, 0, 0, 1)">:
            </span><span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">[DECODE ] æ¹éçæä¸­: {[f'{r['id']}(å©{r['remain']})' for r in current_batch]}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
            time.sleep(</span>0.4<span style="color: rgba(0, 0, 0, 1)">) 

        </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> 3. ç»ä¸ç¶ææ´æ°</span>
        <span style="color: rgba(0, 0, 255, 1)">for</span> req <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> current_batch:
            req[</span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">remain</span><span style="color: rgba(128, 0, 0, 1)">'</span>] -= 1

        <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> 4. ç»ä¸å¤æ­çå½å¨æ</span>
        <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> æ³¨æï¼ä¸ºäºé¿åå¨éååè¡¨æ¶å é¤åç´ ï¼æä»¬åæ¶éè¦å é¤çå¯¹è±¡</span>
        to_remove_from_running =<span style="color: rgba(0, 0, 0, 1)"> []
        
        </span><span style="color: rgba(0, 0, 255, 1)">for</span> req <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> current_batch:
            </span><span style="color: rgba(0, 0, 255, 1)">if</span> req[<span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">remain</span><span style="color: rgba(128, 0, 0, 1)">'</span>] &lt;=<span style="color: rgba(0, 0, 0, 1)"> 0:
                </span><span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">  &lt;&lt;&lt; [å®æ] {req['id']} éåºç³»ç»</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
                </span><span style="color: rgba(0, 0, 255, 1)">if</span> req <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> running_queue:
                    to_remove_from_running.append(req)
            </span><span style="color: rgba(0, 0, 255, 1)">else</span><span style="color: rgba(0, 0, 0, 1)">:
                </span><span style="color: rgba(0, 0, 255, 1)">if</span><span style="color: rgba(0, 0, 0, 1)"> is_prefill_stage:
                    running_queue.append(req)
                    </span><span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">  -&gt; {req['id']} Prefill å®æï¼è½¬å¥ running_queue</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
                </span><span style="color: rgba(0, 0, 255, 1)">else</span><span style="color: rgba(0, 0, 0, 1)">:
                    </span><span style="color: rgba(0, 0, 255, 1)">pass</span>
        
        <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> çæ­£çä» running_queue ç§»é¤</span>
        <span style="color: rgba(0, 0, 255, 1)">for</span> req <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> to_remove_from_running:
            running_queue.remove(req)

</span><span style="color: rgba(0, 0, 255, 1)">if</span> <span style="color: rgba(128, 0, 128, 1)">__name__</span> == <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">__main__</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">:
    t </span>= threading.Thread(target=user_request_producer, daemon=<span style="color: rgba(0, 0, 0, 1)">True)
    t.start()
    </span><span style="color: rgba(0, 0, 255, 1)">try</span><span style="color: rgba(0, 0, 0, 1)">:
        inference_loop()
    </span><span style="color: rgba(0, 0, 255, 1)">except</span><span style="color: rgba(0, 0, 0, 1)"> KeyboardInterrupt:
        </span><span style="color: rgba(0, 0, 255, 1)">pass</span></pre>
</div>
<p><span data-offset-key="95l8v-0-0">å å ä¸ prefill ä¼åä¹åçè¿ç»­æ¹å¤çä»£ç ä¹è¾ä¸ºç®åï¼ä¸»è¦æ¯ç»´æ¤ä¸ä¸ªåéï¼waiting_queueãrunning_queueãcurrent_batchã</span></p>
</div>
<h1 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="bfmk2-0-0"><span data-offset-key="bfmk2-0-0">5. KV Cache</span></h1>
<h2 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="4fpfc-0-0"><span data-offset-key="4fpfc-0-0">5.1. æ¦å¿µçè§£</span></h2>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="egp60-0-0">
<h3 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="egp60-0-0"><span data-offset-key="egp60-0-0">5.1.1. KV Cache çç¨é</span></h3>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="dj0l-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="dj0l-0-0"><span data-offset-key="dj0l-0-0">KV Cache æä¸¤å±ç¨éãä¸æ¯ç¨å¨åä¸ä¸ªè¯·æ±ç Decode é¶æ®µï¼å¤ç¨ä¹åå·²ç»è®¡ç®è¿ç KV ç»æä»¥é¿åéå¤è®¡ç®ï¼äºæ¯ç¨å¨ä¸åè¯·æ±ä¹é´ï¼ä½¿å·æç¸ååç¼çè¯·æ±å¯ä»¥å±äº«ä¸é¨å KV æ°æ®ï¼è¿å°±æ¯ Prefix KV Cacheã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="6qu2l-0-0">
<h3 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="6qu2l-0-0"><span data-offset-key="6qu2l-0-0">5.1.2. PagedAttention ææ¯</span></h3>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="cp1e3-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="cp1e3-0-0"><span data-offset-key="cp1e3-0-0">å¨ Cache çå­å¨å±é¢ï¼PagedAttention å®ç°äºæ¾å­çæéç³è¯·ãç±äº KV Cache ç©ºé´ä¸åä¸æ¬¡æ§é¢åéï¼è¯·æ±åºåå¯¹åºçç©çå°åæ¯ç¦»æ£çãPagedAttention çæ ¸å¿å¨äºï¼å®è½å¤ç´æ¥è¯»åè¿äºç©çç¦»æ£çåæ¥å®ææ³¨æåè®¡ç®ï¼è¿èåå®ç°äºä¸å±ä»âé»è¾è¿ç»­å°åâå°âç©çç¦»æ£å°åâçæ å°ã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="a494u-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="a494u-0-0"><span data-offset-key="a494u-0-0">å¯¹äºæ²¡ææ¥è§¦è¿é PagedAttention å®ç°çè¯»èæ¥è¯´ï¼è¿ç§è®¾è®¡ä¼¼ä¹çæå½ç¶ï¼æéç³è¯·ãåé¡µç®¡çãå°åæ å°ãå±é¨æ§åçââè¿äºé½æ¯è®¡ç®æºç§å­¦ä¸­éå¸¸å¸¸è§çæç»´ï¼çè³å¾é¾æ³å°ä¸è¿ä¹åççç±ãé£ä¹ï¼ä¸ºä»ä¹ PagedAttention ä¼è¢«è®¤ä¸ºæ¯ä¸é¡¹éç¨ç¢å¼çåè¿ææ¯å¢ï¼</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="8elsr-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="8elsr-0-0"><span data-offset-key="8elsr-0-0">é¦åï¼å¨ PagedAttention åºç°ä¹åï¼ä¸çæ®éè®¤ä¸º KV Cache å¨æ¾å­ä¸­å¿é¡»ç©çè¿ç»­ï¼å¦åä¼å è®¿å­ä¸è¿ç»­å¯¼è´æ§è½å¤§å¹ä¸éãå¶æ¬¡ï¼å½æ¶çæ³¨æåç®å­ï¼å¦æ åç FlashAttentionï¼å¹¶ä¸æ¯æäºæ¬¡å¯»åæ å°ãPagedAttention è¯æäºå³ä¾¿ç©çå­å¨ä¸è¿ç»­ï¼æ§è½ä¾ç¶å¯ä»¥ä¿ææé«ãå¶ä»£ç å®ç°æå³é®çç¹å¨äºéæäº CUDA åæ ¸ï¼ä½¿å¶åçæ¯æ KV Cache äºæ¬¡å¯»åãä¸ä¸ªåºåç KV Cache ä¸éè¦ç©çè¿ç»­ï¼ä¹æ­£æ¯ä¸ååºåé´è½å¤çµæ´»å¤ç¨ Prefix KV Cache çææ¯åæã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="tdgu-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="tdgu-0-0"><span data-offset-key="tdgu-0-0">æ»çæ¥è¯´ï¼è½ç¶åé¡µèæåå­å¨ CPU é¢åæ¯å¸¸è¯ï¼ä½å¨ GPU ç®å­é¢åå¶åå±ç¸å¯¹ç¼æ¢ãå®ç°ä¸å¥æ¢è½åé¡µç®¡çãåä¸æå¤±ç®åå©ç¨çç Attention Kernel æ¯ PagedAttention çæ ¸å¿æå¨ã</span></div>
</div>
<h2 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="4t417-0-0"><span data-offset-key="4t417-0-0">5.2. Prefix KV Cache çå®ç°</span></h2>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="1qbm4-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="1qbm4-0-0"><span data-offset-key="1qbm4-0-0">Cache çç®¡çè¾ä¸ºç®åï¼åªæ BlockManager ç±»ï¼è´è´£ç»´æ¤æ¾å­æ± åä¸ª block ççç¶æã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="3hqqi-0-0">
<h3 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="3hqqi-0-0"><span data-offset-key="3hqqi-0-0">5.2.1. åè½ç»è</span></h3>
</div>
<ul class="public-DraftStyleDefault-ul" data-offset-key="eo7ib-0-0">
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-reset public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="eo7ib-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="eo7ib-0-0"><span data-offset-key="eo7ib-0-0">ä½¿ç¨ hash æ¥è¯å«æ¯å¦æå¯å¤ç¨åç¼ï¼ä»¥ block ä¸ºåºæ¬åå</span></div>
</li>
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="eu2dc-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="eu2dc-0-0"><span data-offset-key="eu2dc-0-0">é¾å¼ hashï¼æ¯ä¸ª block ç hash è®¡ç®è¾å¥ä¸ºååº block ç hash å¼å ä¸æ¬ block ç token id</span></div>
</li>
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="53r4m-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="53r4m-0-0"><span data-offset-key="53r4m-0-0">æ¯ä¸ä¸ª block æå¯¹åºç meta ä¿¡æ¯å¯¹è±¡ï¼è®°å½ block è¢«å¤ç¨çå¼ç¨è®¡æ°ï¼ç¡®ä¿å¤ç¨æ¶ä¸ä¼è¢«éæ¾</span></div>
</li>
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="5ep1l-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="5ep1l-0-0"><span data-offset-key="5ep1l-0-0">ä¸ºé¿å hash ç¢°æåºç°éè¯¯ï¼block meta ä¿¡æ¯è¿éè¦è®°å½åå§ç token id</span></div>
</li>
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="ep2of-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="ep2of-0-0"><span data-offset-key="ep2of-0-0">å¨è·å KV Cache ç©ºé´æ¶éè¦èèæ¯å¦è·¨ block</span></div>
</li>
</ul>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="1n8ab-0-0">
<h3 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="1n8ab-0-0"><span data-offset-key="1n8ab-0-0">5.2.2. åå­æ± </span></h3>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="92dgk-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="92dgk-0-0"><span data-offset-key="92dgk-0-0">å¨è¿ç¨å¯å¨æ¶ï¼ä¸æ¬¡æ§ç³è¯·åå­æ± çç©ºé´ï¼</span></div>
</div>
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="7mlt7-0-0">
<div class="cnblogs_code">
<pre>kv_cache =<span style="color: rgba(0, 0, 0, 1)"> torch.empty(
    </span>2,                          <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> K å V</span>
    num_layers,                 <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> å±æ°</span>
    num_blocks,                 <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> æ»åæ°</span>
    block_size,                 <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> æ¯å token æ°</span>
    num_kv_heads // tp_size,    <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> KV head æ°ï¼èèå¼ éå¹¶è¡ï¼</span>
    head_dim                    <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> head ç»´åº¦</span>
)</pre>
</div>
<p><span data-offset-key="c1fh4-0-0">ä¸è¿°ç³è¯·æ¾å­ä»£ç ä¸­ç num_blocks æ¯æ ¹æ®å¯ç¨äº KV Cache çæ¾å­ç®åºæ¥çï¼</span></p>
<div class="cnblogs_code">
<pre>block_bytes = 2 * hf_config.num_hidden_layers * self.block_size * num_kv_heads * head_dim *<span style="color: rgba(0, 0, 0, 1)"> hf_config.torch_dtype.itemsize
config.num_kvcache_blocks </span>= int(total * config.gpu_memory_utilization - used - peak + current) // block_bytes</pre>
</div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="2itrb-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="2itrb-0-0"><span data-offset-key="2itrb-0-0">ä¸è¿°ä»£ç ä¸­ç block_bytes å¹¶ä¸æ¯æ block çå¤§å°ï¼èæ¯æè®¡ç® blocks æ°çææé¤æ°ä¹å°äºä¸èµ·ï¼é¤æ°åæ¬ï¼block å¤§å°ãk å vãæ¨¡åå±æ°ã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="9u53j-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="9u53j-0-0"><span data-offset-key="9u53j-0-0"><span data-text="true">total * config.gpu_memory_utilization - used - peak + current<span data-offset-key="9u53j-0-1"> è¿é¨ååæ¯æ ¹æ®æé«çæ¾å­å©ç¨çç®åºæ¥å¯ç¨æ¾å­ï¼åå»å½åæ¨¡åå è½½å®åä½¿ç¨äºçé¨åï¼ååå»æ¨¡åé¢ç­æ¶ä½¿ç¨çæ¿æ´»æ¾å­ï¼<span data-offset-key="9u53j-0-2"><span data-text="true">peak - current<span data-offset-key="9u53j-0-3">ã</span></span></span></span></span></span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="an724-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="an724-0-0"><span data-offset-key="an724-0-0">ç³è¯·å°åå­æ± åï¼æå±å±äº«è§å¾ç»åä¸ªå±ç Attention å¯¹è±¡ï¼ä»£ç çèµ·æ¥æ¯è¾ trickyï¼ä½å¨ python éåæ¯è¾å¸¸è§ï¼</span></div>
</div>
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="aectp-0-0">
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 255, 1)">for</span> module <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> self.model.modules():
    </span><span style="color: rgba(0, 0, 255, 1)">if</span> hasattr(module, <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">k_cache</span><span style="color: rgba(128, 0, 0, 1)">"</span>) <span style="color: rgba(0, 0, 255, 1)">and</span> hasattr(module, <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">v_cache</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">):
        module.k_cache </span>=<span style="color: rgba(0, 0, 0, 1)"> self.kv_cache[0, layer_id]
        module.v_cache </span>= self.kv_cache[1<span style="color: rgba(0, 0, 0, 1)">, layer_id]
        layer_id </span>+= 1</pre>
</div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="8plc7-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="8plc7-0-0"><span data-offset-key="8plc7-0-0">éåæ¨¡åä¸­çææ nn.Module å­æ¨¡åï¼éè¿æ£æ¥æ¯å¦å­å¨ k_cache å v_cache å±æ§æ¥è¯å« Attention å±ãå¯¹äºæ¯ä¸ª Attention å±ï¼å°å¶ k_cache å v_cache å±æ§æ¿æ¢ä¸ºæåå¨å± KV Cache æ¾å­æ± çå¼ éè§å¾ï¼è¿æ ·ææå±å±äº«åä¸åè¿ç»­çæ¾å­ç©ºé´ï¼ä½æ¯å±åªè½è®¿é®èªå·±å¯¹åºçåçã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="5gjke-0-0">
<h3 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="5gjke-0-0"><span data-offset-key="5gjke-0-0">5.2.3. KV Cache åå¥</span></h3>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="dqio4-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="dqio4-0-0"><span data-offset-key="dqio4-0-0">å¨ attention å­å±ç forward åå KV Cache çåå¥ï¼ä½¿ç¨ç store_kvcache_kernel å½æ°æ¯ triton.jit å®ç°çï¼ä»£ç ä¹æ¯è¾ç®æ´ï¼</span></div>
</div>
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="97mjq-0-0">
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 0, 1)">@triton.jit
</span><span style="color: rgba(0, 0, 255, 1)">def</span><span style="color: rgba(0, 0, 0, 1)"> store_kvcache_kernel(
    key_ptr,
    key_stride,
    value_ptr,
    value_stride,
    k_cache_ptr,
    v_cache_ptr,
    slot_mapping_ptr,
    D: tl.constexpr,
):
    idx </span>=<span style="color: rgba(0, 0, 0, 1)"> tl.program_id(0)
    slot </span>= tl.load(slot_mapping_ptr +<span style="color: rgba(0, 0, 0, 1)"> idx)
    </span><span style="color: rgba(0, 0, 255, 1)">if</span> slot == -1: <span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)">
    key_offsets </span>= idx * key_stride +<span style="color: rgba(0, 0, 0, 1)"> tl.arange(0, D)
    value_offsets </span>= idx * value_stride +<span style="color: rgba(0, 0, 0, 1)"> tl.arange(0, D)
    key </span>= tl.load(key_ptr +<span style="color: rgba(0, 0, 0, 1)"> key_offsets)
    value </span>= tl.load(value_ptr +<span style="color: rgba(0, 0, 0, 1)"> value_offsets)
    cache_offsets </span>= slot * D +<span style="color: rgba(0, 0, 0, 1)"> tl.arange(0, D)
    tl.store(k_cache_ptr </span>+<span style="color: rgba(0, 0, 0, 1)"> cache_offsets, key)
    tl.store(v_cache_ptr </span>+<span style="color: rgba(0, 0, 0, 1)"> cache_offsets, value)

</span><span style="color: rgba(0, 0, 255, 1)">def</span><span style="color: rgba(0, 0, 0, 1)"> store_kvcache(key: torch.Tensor, value: torch.Tensor, k_cache: torch.Tensor, v_cache: torch.Tensor, slot_mapping: torch.Tensor):
    N, num_heads, head_dim </span>=<span style="color: rgba(0, 0, 0, 1)"> key.shape
    D </span>= num_heads *<span style="color: rgba(0, 0, 0, 1)"> head_dim
    </span><span style="color: rgba(0, 0, 255, 1)">assert</span> key.stride(-1) == 1 <span style="color: rgba(0, 0, 255, 1)">and</span> value.stride(-1) == 1
    <span style="color: rgba(0, 0, 255, 1)">assert</span> key.stride(1) == head_dim <span style="color: rgba(0, 0, 255, 1)">and</span> value.stride(1) ==<span style="color: rgba(0, 0, 0, 1)"> head_dim
    </span><span style="color: rgba(0, 0, 255, 1)">assert</span> k_cache.stride(1) == D <span style="color: rgba(0, 0, 255, 1)">and</span> v_cache.stride(1) ==<span style="color: rgba(0, 0, 0, 1)"> D
    </span><span style="color: rgba(0, 0, 255, 1)">assert</span> slot_mapping.numel() ==<span style="color: rgba(0, 0, 0, 1)"> N
    store_kvcache_kernel[(N,)](key, key.stride(0), value, value.stride(0), k_cache, v_cache, slot_mapping, D)</span></pre>
</div>
<p><span data-offset-key="eot2n-0-0">ä½¿ç¨ stride å½æ°æ¥ç¡®è®¤æ¾å­æ¯å¦è¿ç»­ï¼å ä¸ºå¨ store_kvcache_kernel çå®ç°éä¼æç§æ¾å­è¿ç»­æ¥è¯»åæå®ä½ç½®çå¼ã</span></p>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="fgn05-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="fgn05-0-0"><span data-offset-key="fgn05-0-0">æ¾å­è¿ç»­åä¸è¿ç»­çä¾å­ï¼</span></div>
</div>
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="bgucp-0-0">
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> torch

key </span>= torch.randn(2, 3, 4<span style="color: rgba(0, 0, 0, 1)">)
</span><span style="color: rgba(0, 0, 255, 1)">print</span><span style="color: rgba(0, 0, 0, 1)">(key.stride())  
key_t </span>= key.transpose(1, 2<span style="color: rgba(0, 0, 0, 1)">)
</span><span style="color: rgba(0, 0, 255, 1)">print</span>(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">è½¬ç½®åï¼éè¿ç»­ï¼:</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">, key_t.stride())  
key_t </span>= key_t.contiguous()  <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> éæ°åéï¼ä½¿å¶è¿ç»­</span>
<span style="color: rgba(0, 0, 255, 1)">print</span>(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">contiguous å:</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">, key_t.stride())

</span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> è¾åºï¼</span><span style="color: rgba(0, 128, 0, 1)">
#</span><span style="color: rgba(0, 128, 0, 1)"> (12, 4, 1)</span><span style="color: rgba(0, 128, 0, 1)">
#</span><span style="color: rgba(0, 128, 0, 1)"> è½¬ç½®åï¼éè¿ç»­ï¼: (12, 1, 4)</span><span style="color: rgba(0, 128, 0, 1)">
#</span><span style="color: rgba(0, 128, 0, 1)"> contiguouså: (12, 3, 1)</span></pre>
</div>
</div>
<h1 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="ci2i3-0-0"><span data-offset-key="ci2i3-0-0">6. cuda graph</span></h1>
<h2 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="2jdp4-0-0"><span data-offset-key="2jdp4-0-0">6.1. æ¦å¿µçè§£</span></h2>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="35eln-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="35eln-0-0"><span data-offset-key="35eln-0-0">CUDA Graph æ¯ä¸ç§å°ä¸ç³»å CUDA æä½å½å¶æå¾çææ¯ï¼å¨éå¤æ§è¡çåºå®æä½åºååºæ¯ä¸å¯ä»¥æ¾èæåæ¨çæ§è½ï¼ä¸»è¦åºäºè¿å æ¹é¢ï¼</span></div>
</div>
<ul class="public-DraftStyleDefault-ul" data-offset-key="c79s9-0-0">
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-reset public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="c79s9-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="c79s9-0-0"><span data-offset-key="c79s9-0-0">åå° CPU ä¸ GPU ä¹é´çé¢ç¹åæ­¥åæä»¤ä¸åå¼éï¼éä½ä¼ ç»ç¬ç«æä½å¸¦æ¥çæ§å¶æµäº¤äºæèï¼</span></div>
</li>
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="e6vfa-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="e6vfa-0-0"><span data-offset-key="e6vfa-0-0">åå°æ§è¡è¿ç¨ä¸­ç CPU å¹²é¢ï¼GPU èªä¸»æ¹éæ§è¡å¾åæä½ï¼æå¤§å GPU å©ç¨çï¼éä½å»¶è¿ãæåååã</span></div>
</li>
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="boou5-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="boou5-0-0"><span data-offset-key="boou5-0-0">è§é¿å¤æ¬¡ç¬ç« CUDA Kernel çå¯å¨åºå®å¼éï¼å¤ä¸ª Kernel æååä»éä¸æ¬¡è°åº¦è§¦åï¼å¤§å¹æåå° Kernel å¯éåºæ¯çæ§è¡æçï¼</span></div>
</li>
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="dopod-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="dopod-0-0"><span data-offset-key="dopod-0-0">å¯éåæ¾å­æ± å®ç°æ¾å­èµæºå¤ç¨ï¼åå° âå°éå¤æ¬¡â æ¾å­ç³è¯· / éæ¾çå¼éï¼åæ¶é©±å¨ä¼åºäºå¾åæ¾å­è®¿é®æ¨¡å¼ä¼åå¸¦å®½å©ç¨çï¼</span></div>
</li>
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="4h8t0-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="4h8t0-0-0"><span data-offset-key="4h8t0-0-0">CUDA é©±å¨å¯è·åæä½åºåçå¨å±è§å¾ï¼åºäºå®æ´çä¾èµå³ç³»è¿è¡å¨å±ä¼åï¼å¦ Kernel é¡ºåºè°æ´ãèµæºåå¹¶ç­ï¼ï¼</span></div>
</li>
</ul>
<h2 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="t84f-0-0"><span data-offset-key="t84f-0-0">6.2. åè½ç»è</span></h2>
<ul class="public-DraftStyleDefault-ul" data-offset-key="5flpk-0-0">
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-reset public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="5flpk-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="5flpk-0-0"><span data-offset-key="5flpk-0-0">å½å¶æ¶ä½¿ç¨çå¼ éåå­å°åï¼å¨éæ¾æ¶å¿é¡»ä¿æä¸åï¼ä¹å°±æ¯åé¢å¤æ¬¡ replay é½ä¼ä½¿ç¨æè·æ¶ç³è¯·çåéç©ºé´</span></div>
</li>
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="4p4jf-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="4p4jf-0-0"><span data-offset-key="4p4jf-0-0">æè·åç graph å¯¹è±¡è®°å½å¨æååééï¼ä¾ä¸æ¬¡æ¨çæ¶éæ©</span></div>
</li>
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="7n2p4-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="7n2p4-0-0"><span data-offset-key="7n2p4-0-0">éæ¾æ¶éæ©æ¯è¯·æ± batch size å¤§çæå° graph batch size</span></div>
</li>
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="4k7ao-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="4k7ao-0-0"><span data-offset-key="4k7ao-0-0">æè·æ¶ä¸åç batch size å±äº«ç¸åçéææ¾å­ç©ºé´ï¼å¹¶è®©å¤ä¸ªæ¹æ¬¡å±äº«æ¾å­æ± ï¼ä½¿å¾è½ç¶æå¤ä¸ª batch sizeï¼ä½åªä¼ä½¿ç¨ Max Batch Size çæ¾å­ç©ºé´</span></div>
</li>
</ul>
<h2 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="ej75t-0-0"><span data-offset-key="ej75t-0-0">6.3. ç¤ºä¾ä»£ç </span></h2>
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="atcuu-0-0">
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> torch
</span><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> torch.nn as nn

</span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> 1. åºç¡éç½®</span>
device = <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">cuda</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">
D </span>= 512                 <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> ç»´åº¦</span>
graph_bs = [1, 8, 32]   <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> é¢å®ä¹çæ¡¶ï¼åæ¡¶å°ºå¯¸ï¼</span>
NUM_LAYERS = 100        <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> ææ·±æ¨¡åï¼å¢å  Kernel æ°éä»¥æ¾å¤§ Graph ä¼å¿</span>
iters = 50              <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> æ§è½æµè¯è¿­ä»£æ¬¡æ°</span>
max_bs =<span style="color: rgba(0, 0, 0, 1)"> max(graph_bs)

</span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> 2. å®ä¹æ·±å±æ¨¡å (äº§ççº¦ 400 ä¸ª Kernel)</span>
<span style="color: rgba(0, 0, 255, 1)">class</span><span style="color: rgba(0, 0, 0, 1)"> UltraDeepModel(nn.Module):
    </span><span style="color: rgba(0, 0, 255, 1)">def</span> <span style="color: rgba(128, 0, 128, 1)">__init__</span><span style="color: rgba(0, 0, 0, 1)">(self):
        super().</span><span style="color: rgba(128, 0, 128, 1)">__init__</span><span style="color: rgba(0, 0, 0, 1)">()
        self.blocks </span>=<span style="color: rgba(0, 0, 0, 1)"> nn.ModuleList()
        </span><span style="color: rgba(0, 0, 255, 1)">for</span> _ <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> range(NUM_LAYERS):
            block </span>=<span style="color: rgba(0, 0, 0, 1)"> nn.ModuleDict({
                </span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">ln</span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(0, 0, 0, 1)">: nn.LayerNorm(D).to(device),
                </span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">linear</span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(0, 0, 0, 1)">: nn.Linear(D, D).to(device),
                </span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">act</span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(0, 0, 0, 1)">: nn.ReLU()
            })
            self.blocks.append(block)

    </span><span style="color: rgba(0, 0, 255, 1)">def</span><span style="color: rgba(0, 0, 0, 1)"> forward(self, x):
        </span><span style="color: rgba(0, 0, 255, 1)">for</span> block <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> self.blocks:
            identity </span>=<span style="color: rgba(0, 0, 0, 1)"> x
            x </span>= block[<span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">ln</span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(0, 0, 0, 1)">](x)
            x </span>= block[<span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">linear</span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(0, 0, 0, 1)">](x)
            x </span>= block[<span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">act</span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(0, 0, 0, 1)">](x)
            x </span>= x +<span style="color: rgba(0, 0, 0, 1)"> identity 
        </span><span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)"> x

model </span>=<span style="color: rgba(0, 0, 0, 1)"> UltraDeepModel().eval()

</span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> 3. éæç¼å²åºåå¤</span>
static_input = torch.empty(max_bs, D, device=<span style="color: rgba(0, 0, 0, 1)">device)
static_output </span>= torch.empty(max_bs, D, device=<span style="color: rgba(0, 0, 0, 1)">device)

graphs </span>=<span style="color: rgba(0, 0, 0, 1)"> {}
graph_pool </span>=<span style="color: rgba(0, 0, 0, 1)"> None

</span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> 4. å½å¶é¶æ®µ (ä»å¤§å°å°ï¼å±äº«åå­æ± )</span>
<span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">--- å¼å§å½å¶åæ¡¶ CUDA Graphs ---</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
</span><span style="color: rgba(0, 0, 255, 1)">for</span> bs <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> reversed(sorted(graph_bs)):
    current_input </span>=<span style="color: rgba(0, 0, 0, 1)"> static_input[:bs]
    </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> Warmup</span>
    <span style="color: rgba(0, 0, 255, 1)">for</span> _ <span style="color: rgba(0, 0, 255, 1)">in</span> range(5<span style="color: rgba(0, 0, 0, 1)">):
        _ </span>=<span style="color: rgba(0, 0, 0, 1)"> model(current_input)
    
    g </span>=<span style="color: rgba(0, 0, 0, 1)"> torch.cuda.CUDAGraph()
    with torch.cuda.graph(g, pool</span>=<span style="color: rgba(0, 0, 0, 1)">graph_pool):
        static_output[:bs] </span>=<span style="color: rgba(0, 0, 0, 1)"> model(current_input)
    
    </span><span style="color: rgba(0, 0, 255, 1)">if</span> graph_pool <span style="color: rgba(0, 0, 255, 1)">is</span><span style="color: rgba(0, 0, 0, 1)"> None:
        graph_pool </span>=<span style="color: rgba(0, 0, 0, 1)"> g.pool()
    graphs[bs] </span>=<span style="color: rgba(0, 0, 0, 1)"> g
    </span><span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">â å·²å½å¶æ¡¶ BS={bs}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)

</span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> 5. è¾å©å½æ°ï¼æ ¹æ®å®é BS å¹éæè¿çæ¡¶</span>
<span style="color: rgba(0, 0, 255, 1)">def</span><span style="color: rgba(0, 0, 0, 1)"> get_bucket_bs(actual_bs):
    </span><span style="color: rgba(0, 0, 255, 1)">for</span> b <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> sorted(graph_bs):
        </span><span style="color: rgba(0, 0, 255, 1)">if</span> actual_bs &lt;=<span style="color: rgba(0, 0, 0, 1)"> b:
            </span><span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)"> b
    </span><span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)"> None

</span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> 6. æ§è½å¯¹æ¯æµè¯ (åå« Padding é»è¾)</span>
<span style="color: rgba(0, 0, 255, 1)">def</span> benchmark(actual_test_bs=7<span style="color: rgba(0, 0, 0, 1)">):
    </span><span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">\n--- æ§è½æµè¯å¼å§: å®éè¯·æ± BS={actual_test_bs} ---</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
    
    </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> çææµè¯æ°æ®</span>
    test_data = torch.randn(actual_test_bs, D, device=<span style="color: rgba(0, 0, 0, 1)">device)
    
    start_event </span>= torch.cuda.Event(enable_timing=<span style="color: rgba(0, 0, 0, 1)">True)
    end_event </span>= torch.cuda.Event(enable_timing=<span style="color: rgba(0, 0, 0, 1)">True)

    </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> --- æ®µè½ A: Standard Eager Mode (ç´æ¥è· 7 ä¸ª) ---</span>
    torch.cuda.nvtx.range_push(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Eager_Mode</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
    start_event.record()
    </span><span style="color: rgba(0, 0, 255, 1)">for</span> _ <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> range(iters):
        _ </span>=<span style="color: rgba(0, 0, 0, 1)"> model(test_data)
    end_event.record()
    torch.cuda.synchronize()
    eager_time </span>=<span style="color: rgba(0, 0, 0, 1)"> start_event.elapsed_time(end_event)
    torch.cuda.nvtx.range_pop()

    </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> --- æ®µè½ B: CUDA Graph Mode (Padding å¯¹é½å° 8) ---</span>
    <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> 1. è·¯ç±é»è¾</span>
    bucket_bs =<span style="color: rgba(0, 0, 0, 1)"> get_bucket_bs(actual_test_bs)
    </span><span style="color: rgba(0, 0, 255, 1)">if</span> bucket_bs <span style="color: rgba(0, 0, 255, 1)">is</span><span style="color: rgba(0, 0, 0, 1)"> None:
        </span><span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">â éè¯¯: å®é BS={actual_test_bs} è¶è¿äºæå¤§åæ¡¶ {max_bs}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
        </span><span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)">

    torch.cuda.nvtx.range_push(f</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Graph_Mode_Bucket_{bucket_bs}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
    
    </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> 2. æ°æ®å¯¹é½ (Padding): å° 7 æ¡æ°æ®æ·å¥ 8 çéæåºå</span>
    <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> static_input çå 7 è¡è¢«è¦çï¼ç¬¬ 8 è¡ä¿æä¸åï¼å³ Padding ä½ï¼</span>
<span style="color: rgba(0, 0, 0, 1)">    static_input[:actual_test_bs].copy_(test_data)
    
    start_event.record()
    </span><span style="color: rgba(0, 0, 255, 1)">for</span> _ <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> range(iters):
        </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> 3. éæ¾åæ¡¶ 8 çå¾</span>
<span style="color: rgba(0, 0, 0, 1)">        graphs[bucket_bs].replay()
    end_event.record()
    torch.cuda.synchronize()
    graph_time </span>=<span style="color: rgba(0, 0, 0, 1)"> start_event.elapsed_time(end_event)
    
    </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> 4. ç»ææªæ­ (Slicing): ä»éæåºæ¿åå 7 æ¡</span>
    final_res =<span style="color: rgba(0, 0, 0, 1)"> static_output[:actual_test_bs]
    torch.cuda.nvtx.range_pop()

    </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> æå°ç»æ</span>
    <span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">å¹éå°çæ¡¶: {bucket_bs} (Padding æµªè´¹ç: {(bucket_bs-actual_test_bs)/bucket_bs*100:.1f}%)</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
    </span><span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">{'Mode':&lt;20} | {'Avg Time (ms)':&lt;15}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
    </span><span style="color: rgba(0, 0, 255, 1)">print</span>(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">-</span><span style="color: rgba(128, 0, 0, 1)">"</span> * 40<span style="color: rgba(0, 0, 0, 1)">)
    </span><span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">{'Eager Mode':&lt;20} | {eager_time/iters:&gt;15.4f}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
    </span><span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">{'Graph Mode':&lt;20} | {graph_time/iters:&gt;15.4f}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
    </span><span style="color: rgba(0, 0, 255, 1)">print</span>(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">-</span><span style="color: rgba(128, 0, 0, 1)">"</span> * 40<span style="color: rgba(0, 0, 0, 1)">)
    </span><span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">ð å éæ¯: {eager_time/graph_time:.2f}x</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
    </span><span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">æç»è¾åºå½¢ç¶: {final_res.shape}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)

</span><span style="color: rgba(0, 0, 255, 1)">if</span> <span style="color: rgba(128, 0, 128, 1)">__name__</span> == <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">__main__</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">:
    </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> æµè¯ä¸åçè¾å¥ BS</span>
    benchmark(actual_test_bs=7)  <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> è§¦åå¯¹é½å° 8</span>
    benchmark(actual_test_bs=1)  <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> ç²¾ç¡®å¹éå° 1</span></pre>
</div>
<p><span data-offset-key="b3jsd-0-0">æ§è¡ï¼nsys profile --trace=cuda,osrt,nvtx python3 cu2.py</span></p>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="e9suj-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="e9suj-0-0"><span data-offset-key="e9suj-0-0">è¾åºï¼</span></div>
</div>
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="bm2d3-0-0">
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 0, 1)">Collecting data...
</span>--- å¼å§å½å¶åæ¡¶ CUDA Graphs ---<span style="color: rgba(0, 0, 0, 1)">
â å·²å½å¶æ¡¶ BS</span>=32<span style="color: rgba(0, 0, 0, 1)">
â å·²å½å¶æ¡¶ BS</span>=8<span style="color: rgba(0, 0, 0, 1)">
â å·²å½å¶æ¡¶ BS</span>=1

--- æ§è½æµè¯å¼å§: å®éè¯·æ± BS=7 ---<span style="color: rgba(0, 0, 0, 1)">
å¹éå°çæ¡¶: </span>8 (Padding æµªè´¹ç: 12.5%<span style="color: rgba(0, 0, 0, 1)">)
Mode                 </span>|<span style="color: rgba(0, 0, 0, 1)"> Avg Time (ms)  
</span>----------------------------------------<span style="color: rgba(0, 0, 0, 1)">
Eager Mode           </span>|          7.9331<span style="color: rgba(0, 0, 0, 1)">
Graph Mode           </span>|          1.0136
----------------------------------------<span style="color: rgba(0, 0, 0, 1)">
ð å éæ¯: </span>7<span style="color: rgba(0, 0, 0, 1)">.83x
æç»è¾åºå½¢ç¶: torch.Size([</span>7, 512<span style="color: rgba(0, 0, 0, 1)">])

</span>--- æ§è½æµè¯å¼å§: å®éè¯·æ± BS=1 ---<span style="color: rgba(0, 0, 0, 1)">
å¹éå°çæ¡¶: </span>1 (Padding æµªè´¹ç: 0.0%<span style="color: rgba(0, 0, 0, 1)">)
Mode                 </span>|<span style="color: rgba(0, 0, 0, 1)"> Avg Time (ms)  
</span>----------------------------------------<span style="color: rgba(0, 0, 0, 1)">
Eager Mode           </span>|          8.1803<span style="color: rgba(0, 0, 0, 1)">
Graph Mode           </span>|          0.8011
----------------------------------------<span style="color: rgba(0, 0, 0, 1)">
ð å éæ¯: </span>10<span style="color: rgba(0, 0, 0, 1)">.21x
æç»è¾åºå½¢ç¶: torch.Size([</span>1, 512])</pre>
</div>
<p><span data-offset-key="f9vmd-0-0">æ¥ç nsysï¼</span></p>
</div>
<div class="Image-captionContainer" data-size="normal">
<div>
<div class="Image-resizerContainer css-ym3v7r" data-size="normal">
<div class="css-79elbk">
<div>
<div class="ImageDelete-Container css-xi606m">
<div class="ImageDelete-Wrapper css-1gomreu" style="text-align: center"><img src="https://picx.zhimg.com/80/v2-fa4eefbebda0472fa1f21d8bd01e4c17_1440w.png?source=ccfced1a" width="753" height="394" class="Image FocusPlugin--unfocused Image--isBlock css-1phd9a0" loading="lazy" data-size="normal" data-rawwidth="1787" data-rawheight="934" data-watermark="original" data-original-src="https://picx.zhimg.com/v2-fa4eefbebda0472fa1f21d8bd01e4c17.jpg?source=ccfced1a" data-watermark-src="https://pica.zhimg.com/v2-e7ab1f5e1056fe2adbf8d61f3be2c7b2_1440w.jpg?source=ccfced1a"></div>
</div>
</div>
</div>
</div>
</div>
<div style="text-align: center">å¾ 4</div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="dmkhc-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="dmkhc-0-0"><span data-offset-key="dmkhc-0-0">å¯ä»¥çå°ï¼å¨ cuda graph çæ¶åï¼SM ä½¿ç¨æ´ååã</span></div>
</div>
<h2 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="dchee-0-0"><span data-offset-key="dchee-0-0">6.4. Q&amp;A</span></h2>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="e35ln-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="e35ln-0-0"><span data-offset-key="e35ln-0-0">ï¼1ï¼ä¸ºä»ä¹æ¨çæ¶ cuda graph çéæ©è¦éç¨åä¸å¯¹é½çåæ¡¶ç­ç¥ï¼å³ï¼æ¹æ¬¡ç¸ç­æç¨å¤§çï¼èä¸æ¯éæ©æ¹æ¬¡æå¤§çï¼</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="2vaba-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="2vaba-0-0"><span data-offset-key="2vaba-0-0">è½ç¶å¨å»ºå¾ï¼Captureï¼é¶æ®µï¼ç³»ç»ä¼æç§æå¤§æ¹æ¬¡ï¼Max Batch Sizeï¼é¢åç³è¯·å¹¶éå®éææ¾å­ç©ºé´ï¼æ­¤æ¶å³ä¾¿éæ©æå¤§æ¹æ¬¡æ§è¡ä¹ä¸ä¼äº§çé¢å¤çæ¾å­å®¹éæµªè´¹ï¼ä½ä¼å¼å¥ä»¥ä¸ä¸¤ä¸ªç»´åº¦çæ§è½æèï¼</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="6v9hj-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="6v9hj-0-0"><span data-offset-key="6v9hj-0-0">æ¾å­å¸¦å®½çæ æå ç¨ï¼å¤§æ¨¡åæ¨çï¼å°¤å¶æ¯ Decoding é¶æ®µï¼å±äºå¸åçè®¿å­å¯éåä»»å¡ï¼å¶ç¶é¢å¨äºæ¨¡åæéä»æ¾å­å°è®¡ç®ååçæ¬è¿éåº¦ãå³ä¾¿å¤§é¨åæ¹æ¬¡ä½ç½®æ¯ Paddingï¼ç©ºæ°æ®ï¼ï¼CUDA Graph ä¾ç¶ä¼ä¸¥æ ¼æ§è¡å½å¶æ¶çåå­å¯»åå®ä¹ï¼æ¬è¿å®æ´æ¹æ¬¡çæ°æ®ãä½¿ç¨è¿å¤§çæ¹æ¬¡ä¼å¯¼è´ GPU æµªè´¹æå¶å®è´µçå¸¦å®½å»æ¬è¿âæ ææ°æ®âï¼ä»èå¢å åæ¬¡æ¨ççèæ¶ï¼æ¨é«æ¨çå»¶è¿ï¼Latencyï¼ã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="bn155-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="bn155-0-0"><span data-offset-key="bn155-0-0">è®¡ç®èµæºçæ æå ç¨ï¼GPU è°åº¦å¨ä¼æ ¹æ®å¾å®ä¹çè§æ¨¡é¢åéç¡¬ä»¶èµæºï¼å¦ SM æ ¸å¿ãå¯å­å¨ãå±äº«æ¾å­ç­ï¼ãè½ç¶ Padding é¨åçè®¡ç®é»è¾æå¿«ï¼ä½è¿äºèµæºå¨æ´ä¸ª CUDA Graph æ§è¡å®æåæ æ³è¢«éæ¾ãè¿ä¼å¯¼è´ GPU ç¡¬ä»¶å¤äºâèåç¹å¿âç¶æï¼é»å¡äºå¶ä»æ½å¨ä»»å¡ï¼å¦å¤æµå¹¶è¡ç­ï¼è·åç¡¬ä»¶èµæºï¼åå¼±äºç³»ç»æ´ä½çå¹¶åååè½åï¼Throughputï¼ã</span></div>
</div>
<h1 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="2lj8v-0-0"><span data-offset-key="2lj8v-0-0">7. Torch Compilation</span></h1>
<h2 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="5nq47-0-0"><span data-offset-key="5nq47-0-0">7.1. æ¦å¿µçè§£</span></h2>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="cm5ot-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="cm5ot-0-0"><span data-offset-key="cm5ot-0-0">torch.compile è½å¤å° PyTorch å¼ éè®¡ç®ç¸å³ç Python é»è¾ï¼è½¬åä¸ºæ´é«æçä¸­é´è¡¨ç¤ºï¼å¨ CUDA è®¾å¤ä¸ï¼éå¸¸æ¯ Triton åæ ¸ä»£ç ï¼ä¹æ¯æåç CUDA åæ ¸ï¼ãç¸è¾äºä¼ ç»çå³æ¶æ§è¡ï¼Eager Modeï¼ï¼è¿ç§æ¹å¼éè¿ä¼åè®¡ç®åæ ¸æ¬èº«å¸¦æ¥æ¾èçè¿è¡æçæåï¼æ­¤å¤ï¼å½è¾å¥å¼ éå½¢ç¶ãæ°æ®ç±»ååºå®æ¶ï¼torch.compile è¿ä¼èªå¨å¯ç¨ CUDA Graph ä¼åï¼è¿ä¸æ­¥æ¾å¤§æ§è½æ¶çã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="c8lai-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="c8lai-0-0"><span data-offset-key="c8lai-0-0">å¨ torch.compile é®ä¸ä¹åï¼PyTorch å¼åèè¥æ³è¿½æ±é«æ§è½ï¼ä»æä¸¤ç§æ ¸å¿éæ©ï¼ä¸æ¯ä½¿ç¨ Eager Mode æ¥åå¶åçæ§è½ä¸éï¼äºæ¯æå¨ç¼å Triton æ CUDA åºå±åæ ¸ä»£ç ï¼è¯¥æ¹å¼å¼åé¨æ§é«ãå¨æé¿ãç»´æ¤ææ¬é«ï¼ãèæäº torch.compile åï¼å¼åèåªéç¼åç®æ´ææç PyTorch Python ä¸å¡é»è¾ï¼æ éå³æ³¨åºå±ç¡¬ä»¶ééä¸åæ ¸å®ç°ï¼å³å¯è·å¾æ¥è¿æå Triton/CUDA çä¼å¼æ§è½ï¼å¤§å¹å¹³è¡¡äºå¼åæçä¸è¿è¡æ§è½ã</span></div>
</div>
<h2 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="6rc4c-0-0"><span data-offset-key="6rc4c-0-0">7.2. ä½¿ç¨æ¹æ³</span></h2>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="c5lru-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="c5lru-0-0"><span data-offset-key="c5lru-0-0">åºç¨ torch.compile éå¸¸ç®åï¼æ ¸å¿æä¸¤ç±»ä½¿ç¨æ¹å¼ï¼</span></div>
</div>
<ul class="public-DraftStyleDefault-ul" data-offset-key="fmk6u-0-0">
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-reset public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="fmk6u-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="fmk6u-0-0"><span data-offset-key="fmk6u-0-0">è£é¥°å¨æ¹å¼ï¼å¨ PyTorch å½æ°ä¸ç´æ¥æ·»å  @torch.compile è£é¥°å¨ï¼å®ä¹æ¶å³å®æç¼è¯å£°æï¼</span></div>
</li>
<li class="Editable-styled public-DraftStyleDefault-unorderedListItem public-DraftStyleDefault-depth0 public-DraftStyleDefault-listLTR" data-block="true" data-editor="2doff" data-offset-key="4elg8-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="4elg8-0-0"><span data-offset-key="4elg8-0-0">æ¾å¼è°ç¨æ¹å¼ï¼éè¿ compiled_obj = torch.compile(target) æ¾å¼ç¼è¯ç®æ å¯¹è±¡ï¼åç»­è°ç¨ compiled_obj å³å¯ä½¿ç¨ä¼ååçé»è¾ï¼</span></div>
</li>
</ul>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="5ho4n-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="5ho4n-0-0"><span data-offset-key="5ho4n-0-0">å¦å¤ï¼å¯ä»¥å¯¹æ¨¡åå®ä¾çç´æ¥ç¼è¯ï¼å¯¹äº PyTorch æ¨¡åï¼nn.Module å­ç±»å®ä¾ï¼ï¼å¯ç´æ¥ä¼ å¥ torch.compile å®ææ´ä½ç¼è¯ï¼æ éåç¬ä¿®é¥° forward æ¹æ³ã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="c8n8n-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="c8n8n-0-0"><span data-offset-key="c8n8n-0-0">ç¤ºä¾ä»£ç ï¼</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="b4tlg-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="b4tlg-0-0"><span data-offset-key="b4tlg-0-0">æ¹å¼ 1ï¼è£é¥°å¨æ¹å¼ï¼éç¨äºå½æ° / æ¨¡åæ¹æ³ï¼</span></div>
</div>
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="fipu7-0-0">
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> torch
</span><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> torch.nn as nn

</span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> å¯¹æ®éPyTorchå½æ°ä½¿ç¨è£é¥°å¨</span>
<span style="color: rgba(0, 0, 0, 1)">@torch.compile
</span><span style="color: rgba(0, 0, 255, 1)">def</span><span style="color: rgba(0, 0, 0, 1)"> my_tensor_func(x, y):
    </span><span style="color: rgba(0, 0, 255, 1)">return</span> torch.matmul(x, y) +<span style="color: rgba(0, 0, 0, 1)"> torch.relu(y)

</span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> å¯¹æ¨¡åçforwardæ¹æ³ä½¿ç¨è£é¥°å¨</span>
<span style="color: rgba(0, 0, 255, 1)">class</span><span style="color: rgba(0, 0, 0, 1)"> MyModel(nn.Module):
    @torch.compile  </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> ä¿®é¥°forwardæ¹æ³ï¼èªå¨ç¼è¯æ¨¡åæ¨çé»è¾</span>
    <span style="color: rgba(0, 0, 255, 1)">def</span><span style="color: rgba(0, 0, 0, 1)"> forward(self, x):
        </span><span style="color: rgba(0, 0, 255, 1)">return</span> nn.Linear(10, 20)(x)</pre>
</div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="3u91i-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="3u91i-0-0"><span data-offset-key="3u91i-0-0">æ¹å¼ 2ï¼æ¾å¼è°ç¨æ¹å¼ï¼éç¨äºå½æ° / æ¨¡åï¼çµæ´»æ§æ´é«ï¼</span></div>
</div>
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="75c4t-0-0">
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> torch
</span><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> torch.nn as nn

</span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> æ¾å¼ç¼è¯æ®éå½æ°</span>
<span style="color: rgba(0, 0, 255, 1)">def</span><span style="color: rgba(0, 0, 0, 1)"> my_tensor_func(x, y):
    </span><span style="color: rgba(0, 0, 255, 1)">return</span> torch.matmul(x, y) +<span style="color: rgba(0, 0, 0, 1)"> torch.relu(y)
compiled_func </span>= torch.compile(my_tensor_func)  <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> çæç¼è¯åçå½æ°</span>
output = compiled_func(torch.randn(32, 10), torch.randn(10, 20))  <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> è°ç¨ç¼è¯åçå½æ°</span>

<span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> æ¾å¼ç¼è¯æ¨¡åï¼ä¸æ¹å¼3æ¬è´¨ä¸è´ï¼æ´å¼ºè°âåç¼è¯åä½¿ç¨âçæ¾å¼æµç¨ï¼</span>
<span style="color: rgba(0, 0, 255, 1)">class</span><span style="color: rgba(0, 0, 0, 1)"> MyModel(nn.Module):
    </span><span style="color: rgba(0, 0, 255, 1)">def</span><span style="color: rgba(0, 0, 0, 1)"> forward(self, x):
        </span><span style="color: rgba(0, 0, 255, 1)">return</span> nn.Linear(10, 20<span style="color: rgba(0, 0, 0, 1)">)(x)
model </span>=<span style="color: rgba(0, 0, 0, 1)"> MyModel()
compiled_model </span>= torch.compile(model)  <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> ç´æ¥ç¼è¯æ´ä¸ªæ¨¡åå®ä¾</span>
output = compiled_model(torch.randn(32, 10))  <span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> è°ç¨ç¼è¯åçæ¨¡å</span></pre>
</div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="ksl4-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="ksl4-0-0"><span data-offset-key="ksl4-0-0">æ¹å¼ 3ï¼ç´æ¥ç¼è¯æ¨¡åå®ä¾ï¼æ·±åº¦å­¦ä¹ ä¸­æå¸¸ç¨ï¼ç®ååæ³ï¼</span></div>
</div>
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="71fom-0-0">
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> torch
</span><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> torch.nn as nn

</span><span style="color: rgba(0, 0, 255, 1)">class</span><span style="color: rgba(0, 0, 0, 1)"> MyModel(nn.Module):
    </span><span style="color: rgba(0, 0, 255, 1)">def</span><span style="color: rgba(0, 0, 0, 1)"> forward(self, x):
        </span><span style="color: rgba(0, 0, 255, 1)">return</span> nn.Linear(10, 20<span style="color: rgba(0, 0, 0, 1)">)(x)

</span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> ç´æ¥ç¼è¯æ¨¡åå®ä¾ï¼ä¸æ­¥å°ä½ï¼æ éè£é¥°å¨ï¼æç®æ´å¸¸ç¨ï¼</span>
model =<span style="color: rgba(0, 0, 0, 1)"> torch.compile(MyModel())
output </span>= model(torch.randn(32, 10))</pre>
</div>
</div>
<h2 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="785ra-0-0"><span data-offset-key="785ra-0-0">7.3. æ§è½å¯¹æ¯</span></h2>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="3uufk-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="3uufk-0-0"><span data-offset-key="3uufk-0-0">ä¸é¢ä»¥ä¸ä¸ªç®åçä¾å­å¯¹æ¯ Eager Mode å Compiled Modeï¼</span></div>
</div>
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="54acu-0-0">
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> torch
</span><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> time

</span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> ç¡®ä¿ä½¿ç¨çæ¯ GPU</span>
device = <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">cuda</span><span style="color: rgba(128, 0, 0, 1)">"</span> <span style="color: rgba(0, 0, 255, 1)">if</span> torch.cuda.is_available() <span style="color: rgba(0, 0, 255, 1)">else</span> <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">cpu</span><span style="color: rgba(128, 0, 0, 1)">"</span>
<span style="color: rgba(0, 0, 255, 1)">if</span> device == <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">cpu</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">:
    </span><span style="color: rgba(0, 0, 255, 1)">print</span>(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">è­¦åï¼CUDA ä¸å¯ç¨ï¼å°ä½¿ç¨ CPU è¿è¡ï¼torch.compile çä¼å¿å¨ GPU ä¸æææ¾ï¼ã</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)

</span><span style="color: rgba(0, 0, 255, 1)">def</span><span style="color: rgba(0, 0, 0, 1)"> complex_operation_eager(x, y):
    z </span>= x *<span style="color: rgba(0, 0, 0, 1)"> y
    z </span>= z +<span style="color: rgba(0, 0, 0, 1)"> x
    z </span>=<span style="color: rgba(0, 0, 0, 1)"> torch.relu(z)
    </span><span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)"> z.sum()

@torch.compile
</span><span style="color: rgba(0, 0, 255, 1)">def</span><span style="color: rgba(0, 0, 0, 1)"> complex_operation_graph(x, y):
    z </span>= x *<span style="color: rgba(0, 0, 0, 1)"> y
    z </span>= z +<span style="color: rgba(0, 0, 0, 1)"> x
    z </span>=<span style="color: rgba(0, 0, 0, 1)"> torch.relu(z)
    </span><span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)"> z.sum()

</span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> 1. åå¤æ°æ®</span>
x = torch.randn(10000, 10000, device=<span style="color: rgba(0, 0, 0, 1)">device)
y </span>= torch.randn(10000, 10000, device=<span style="color: rgba(0, 0, 0, 1)">device)

</span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> 2. ç­èº« (Warm up)</span>
<span style="color: rgba(0, 0, 255, 1)">print</span>(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">æ­£å¨ç¼è¯å¹¶è¿è¡å¤æ¬¡ç­èº«ä»¥ç¨³å® GPU ç¶æ...</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
</span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> å¢å ç­èº«å¾ªç¯</span>
<span style="color: rgba(0, 0, 255, 1)">for</span> i <span style="color: rgba(0, 0, 255, 1)">in</span> range(3<span style="color: rgba(0, 0, 0, 1)">): 
    complex_operation_graph(x, y)
    </span><span style="color: rgba(0, 0, 255, 1)">if</span> i ==<span style="color: rgba(0, 0, 0, 1)"> 0:
        </span><span style="color: rgba(0, 0, 255, 1)">print</span>(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">-&gt; é¦æ¬¡ç¼è¯å®æï¼æ­£å¨è¿è¡åç»­é¢ç­...</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)

torch.cuda.synchronize()
</span><span style="color: rgba(0, 0, 255, 1)">print</span>(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">é¢ç­å®æ¯ï¼å¼å§æ­£å¼æµè¯ã</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)

</span><span style="color: rgba(0, 0, 255, 1)">def</span> benchmark(func, x, y, label, iterations=100<span style="color: rgba(0, 0, 0, 1)">):
    start_event </span>= torch.cuda.Event(enable_timing=<span style="color: rgba(0, 0, 0, 1)">True)
    end_event </span>= torch.cuda.Event(enable_timing=<span style="color: rgba(0, 0, 0, 1)">True)
    
    start_event.record()
    </span><span style="color: rgba(0, 0, 255, 1)">for</span> _ <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> range(iterations):
        func(x, y)
    end_event.record()
    
    torch.cuda.synchronize()
    
    elapsed_time_ms </span>=<span style="color: rgba(0, 0, 0, 1)"> start_event.elapsed_time(end_event)
    avg_time_s </span>= (elapsed_time_ms / 1000) /<span style="color: rgba(0, 0, 0, 1)"> iterations
    </span><span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">{label} å¹³åèæ¶: {avg_time_s:.6f} ç§</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
    </span><span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)"> avg_time_s

</span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> 3. æ§è¡æµè¯å¹¶è®¡ç®å éæ¯</span>
<span style="color: rgba(0, 0, 0, 1)">with torch.no_grad():
    </span><span style="color: rgba(0, 0, 255, 1)">print</span>(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">-</span><span style="color: rgba(128, 0, 0, 1)">"</span> * 30<span style="color: rgba(0, 0, 0, 1)">)
    eager_time </span>= benchmark(complex_operation_eager, x, y, <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Eager Mode   </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
    compile_time </span>= benchmark(complex_operation_graph, x, y, <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Compiled Mode</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
    </span><span style="color: rgba(0, 0, 255, 1)">print</span>(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">-</span><span style="color: rgba(128, 0, 0, 1)">"</span> * 30<span style="color: rgba(0, 0, 0, 1)">)
    
    </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> è®¡ç®å éæ¯é»è¾</span>
    speedup = eager_time /<span style="color: rgba(0, 0, 0, 1)"> compile_time
    improvement </span>= (speedup - 1) * 100
    
    <span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">æ§è½æåç»æ:</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
    </span><span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">å éæ¯ (Speedup): {speedup:.2f}x</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
    </span><span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">è¿è¡éåº¦æåäº: {improvement:.1f}%</span><span style="color: rgba(128, 0, 0, 1)">"</span>)</pre>
</div>
<p><span data-offset-key="2kshu-0-0">è¿è¡è¾åºï¼</span></p>
</div>
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="6b49q-0-0">
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 0, 1)">æ­£å¨ç¼è¯å¹¶è¿è¡å¤æ¬¡ç­èº«ä»¥ç¨³å® GPU ç¶æ...
</span>-&gt;<span style="color: rgba(0, 0, 0, 1)"> é¦æ¬¡ç¼è¯å®æï¼æ­£å¨è¿è¡åç»­é¢ç­...
é¢ç­å®æ¯ï¼å¼å§æ­£å¼æµè¯ã
</span>------------------------------<span style="color: rgba(0, 0, 0, 1)">
Eager Mode    å¹³åèæ¶: </span>0.005690<span style="color: rgba(0, 0, 0, 1)"> ç§
Compiled Mode å¹³åèæ¶: </span>0.001528<span style="color: rgba(0, 0, 0, 1)"> ç§
</span>------------------------------<span style="color: rgba(0, 0, 0, 1)">
æ§è½æåç»æ:
å éæ¯ (Speedup): </span>3<span style="color: rgba(0, 0, 0, 1)">.72x
è¿è¡éåº¦æåäº: </span>272.3%</pre>
</div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="8r98n-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="8r98n-0-0"><span data-offset-key="8r98n-0-0">æ§è½ææ°åçæåã</span></div>
</div>
<h2 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="a8508-0-0"><span data-offset-key="a8508-0-0">7.4. Q&amp;A</span></h2>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="1pjmk-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="1pjmk-0-0"><span data-offset-key="1pjmk-0-0">ï¼1ï¼æ¢ç¶ torch.compile æè¿ä¹å¤§çå¥½å¤ï¼ä¸ºä»ä¹ä¸è½ç»ææçå¼ éæä½å½æ°é½å ä¸ @torch.compileï¼</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="eem3i-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="eem3i-0-0"><span data-offset-key="eem3i-0-0">æå æ¹é¢çåå ï¼é¦åï¼å­å¨ç¼è¯å¼éï¼ä¼å¯¼è´é¦æ¬¡è¿è¡æ¾èåæ¢ï¼ç¶åï¼ç¼è¯å¨çæç Triton åæ ¸ï¼æå¶ä»åç«¯ä»£ç ï¼éå¸¸æ¯éå¯¹ç¹å®å¼ éå½¢ç¶ãæ°æ®ç±»ååè®¾å¤éç½®ä¼åçï¼å¦æè¾å¥å¼ éçè¿äºå±æ§é¢ç¹ååï¼ä¼åå¤è§¦åéæ°ç¼è¯ï¼å³ âç¼è¯ç¼å­å¤±æâï¼ï¼åèæµæ¶æ§è½æ¶çï¼ç¬¬ä¸ï¼torch.compile èªèº«ä¼å¸¦æ¥é¢å¤çæ¾å­å¼éï¼ç¨äºå­å¨ç¼è¯åçä¸­é´è¡¨ç¤ºãåæ ¸ç¼å­ç­ï¼ï¼è¿å¤æ å·®å«ä½¿ç¨å¯è½å¯¼è´æ¾å­ä¸è¶³ï¼OOMï¼ï¼æåï¼å¹¶éææä»£ç é½è½è¢«æåå¾åä¼åï¼å¦æå¼ éæä½ä¸­è°ç¨äºé PyTorch åççç¬¬ä¸æ¹åºï¼æçº¯ Python åçé»è¾ï¼ï¼ä¼å¯¼è´è®¡ç®å¾ä¸­æ­ï¼æ­¤æ¶ç¼è¯å¨æ æ³ç»§ç»­ä¼ååç»­é»è¾ï¼è¿éè¦å°æ§å¶æäº¤åç» Python è§£éå¨ï¼äº§çä¸å¿è¦çä¸ä¸æåæ¢å¼éï¼å¯è½å¯¼è´è´ä¼åã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="7ngdh-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="7ngdh-0-0"><span data-offset-key="7ngdh-0-0">ï¼2ï¼torch.compile æ¯æçæåç CUDA åæ ¸ä»£ç ï¼ä½éå¸¸æ¥è¯´ï¼ç¼è¯å¨èªå¨çæçéç¨åç CUDA ä»£ç ä¼åç²åº¦ä¸å¤ç²¾ç»ï¼è Triton åç½®äºæå¼ºç Autotuningï¼èªå¨è°ä¼ï¼è½åï¼éå¯¹æ·±åº¦å­¦ä¹ å¼ éè®¡ç®åºæ¯åäºæ·±åº¦ééï¼å æ­¤å¨ç»å¤§å¤æ°æ·±åº¦å­¦ä¹ ä»»å¡ä¸­ï¼Triton åæ ¸çæ§è½éå¸¸ä¼äºèªå¨çæçåç CUDA åæ ¸ã</span></div>
</div>
<h1 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="cjuuo-0-0"><span data-offset-key="cjuuo-0-0">8. Torch CompilationãTritionãCUDA Graph ä¸èçåºå«åèç³»</span></h1>
<h2 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="6nkil-0-0"><span data-offset-key="6nkil-0-0">8.1. æ ¸å¿åºå«</span></h2>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="2n3n3-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="2n3n3-0-0"><span data-offset-key="2n3n3-0-0">ï¼1ï¼Torch Compilationï¼PyTorch é«å±ä¸ç«å¼æ§è½ä¼åå¥å£ï¼ç¨æ·ææ½è±¡æ¥å£ï¼</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="apt7h-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="apt7h-0-0"><span data-offset-key="apt7h-0-0">ä½ä¸ºé¢åå¼åèçé¡¶çº§ä¼åå°è£ï¼torch.compile æ éå¼åèå³æ³¨åºå±ç¡¬ä»¶ç»èä¸ä¼åå®ç°ï¼å¶æ ¸å¿å®ä½æ¯å¯¹ PyTorch å¼ éè®¡ç®é»è¾ï¼å½æ° /nn.Module æ¨¡åï¼è¿è¡ç«¯å°ç«¯èªå¨ä¼åï¼å±è½äºåºå±åæ ¸çæä¸æ§è¡ä¼åçå¤ææ§ï¼æ¯ç»å¤§å¤æ° PyTorch å¼åèçé¦éæ§è½ä¼åå·¥å·ã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="9i7c0-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="9i7c0-0-0"><span data-offset-key="9i7c0-0-0">ï¼2ï¼Tritonï¼é«æ§è½ GPU åæ ¸ä¸ç¨ DSL </span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="5ts50-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="5ts50-0-0"><span data-offset-key="5ts50-0-0">Triton æ¢æ¯å¼åèæå¨ç¼åé«æ§è½åæ ¸çé¢åä¸ç¨è¯­è¨ï¼DSLï¼ï¼ä¹æ¯ torch.compile èªå¨åçæä»£ç çæ ¸å¿ç®æ åç«¯ãå¶ä¸­ï¼triton.jit æ¯ Triton æ¡æ¶æä¾çå³æ¶ç¼è¯è£é¥°å¨ï¼å®ä½ä¸ºé«æ§è½è·¨å¹³å° GPU åæ ¸çæå¨å¼åå¥å£ï¼æ½è±¡å±çº§ä½äº torch.compileãé«äºåç CUDA C++ãå®åè®¸å¼åèä»¥ Python é£æ ¼è¯­æ³ç¼å GPU åæ ¸é»è¾ï¼æ éæå¨å¤ççº¿ç¨è°åº¦ãå¯å­å¨åéç­åºå±ç»èï¼æç»ç¼è¯ä¸ºé«æ GPU æºå¨ç ï¼ç¨äºæ»¡è¶³å®å¶åç®å­çé«æ§è½éæ±ã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="7706f-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="7706f-0-0"><span data-offset-key="7706f-0-0">ï¼3ï¼CUDA Graphï¼GPU åºå±éæä»»å¡æµæ§è¡ä¼åææ¯</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="d2kt1-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="d2kt1-0-0"><span data-offset-key="d2kt1-0-0">CUDA Graph æ¯ä¸ç§éæä»»å¡æµè°åº¦ææ¯ï¼æ¨å¨æ¶é¤ä¸»æºç«¯ï¼Hostï¼ä¸è®¾å¤ç«¯ï¼Deviceï¼ä¹é´çäº¤äºå»¶è¿ãå®å¹¶é âåæ ¸çæå·¥å·âï¼ä¹é âç¨æ·æç¼ç¨æ¥å£âï¼èæ¯éå¯¹ CPU-GPU äº¤äºç¶é¢çåºå±æ§è¡ä¼åææ¯ï¼æ½è±¡å±çº§æä½ãå¶æ ¸å¿ä½ç¨æ¯åºåè¿ç»­ç CUDA åæ ¸è°ç¨åºåä¸åå­éç½®ï¼éè¿ âå½å¶ - éæ¾â æ¨¡å¼æ¶é¤éå¤åæ ¸å¯å¨ãCPU-GPU é¢ç¹éä¿¡çå¼éï¼ä»ä¼åæ§è¡æµç¨ï¼ä¸æ¹ååæ ¸æ¬èº«çè®¡ç®æ§è½ã</span></div>
</div>
<h2 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="b3b7c-0-0"><span data-offset-key="b3b7c-0-0">8.2. æ ¸å¿èç³»</span></h2>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="4qtm8-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="4qtm8-0-0"><span data-offset-key="4qtm8-0-0">ï¼1ï¼torch.compile ä¾èµ triton.jit å®ç°é«æ§è½åæ ¸çæ</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="1bgf5-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="1bgf5-0-0"><span data-offset-key="1bgf5-0-0">torch.compile çé»è®¤åºå±ç¼è¯å¨ï¼Inductorï¼å¨ CUDA è®¾å¤ä¸ï¼ä¼èªå¨å° PyTorch è®¡ç®é»è¾è½¬åä¸º Triton åæ ¸ä»£ç ï¼å¹¶éå¼è°ç¨ triton.jit å®æç¼è¯ï¼çæé«æ§è½ GPU åæ ¸ï¼å¼åèæ éæå¨ç¼å Triton ä»£ç ï¼ä¹æ éæç¥ triton.jit çå­å¨ï¼ãæ­¤å¤ï¼torch.compile ä¹æ¯æçæåç CUDA åæ ¸ï¼ä½ä¸º Triton åæ ¸çå¯éè¡¥åæ¹æ¡ã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="3toqg-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="3toqg-0-0"><span data-offset-key="3toqg-0-0">ï¼2ï¼torch.compile éæ CUDA Graph å®ç°æ§è¡å±äºæ¬¡ä¼å</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="ch8uv-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="ch8uv-0-0"><span data-offset-key="ch8uv-0-0">å½è¾å¥å¼ éçå½¢ç¶ãæ°æ®ç±»åç­å±æ§åºå®æ¶ï¼torch.compile ä¼èªå¨å¯ç¨ CUDA Graph ä¼åï¼å°ç¼è¯çæç Triton/CUDA åæ ¸è°ç¨åºåå½å¶ä¸º CUDA å¾ãåç»­éå¤æ§è¡è¯¥é»è¾æ¶ï¼ç´æ¥å¨ GPU ä¸éæ¾è¯¥å¾ï¼è¿ä¸æ­¥æ¾å¤§æ§è½æ¶çï¼å®ç° âåæ ¸è®¡ç®ä¼åâ ä¸ âæ§è¡æµç¨ä¼åâ çååå¢æã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="8idqa-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="8idqa-0-0"><span data-offset-key="8idqa-0-0">ï¼3ï¼triton.jit èªå®ä¹åæ ¸å¯ä¸ CUDA Graph æå¨åå</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="4r30e-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="4r30e-0-0"><span data-offset-key="4r30e-0-0">å¼åèæå¨éè¿ triton.jit ç¼åå¹¶ç¼è¯çèªå®ä¹åæ ¸ï¼å¨æ¹ééå¤æ§è¡ï¼è¾å¥å½¢ç¶åºå®ï¼çåºæ¯ä¸ï¼å¯æå¨éæ CUDA Graph å®æ âå½å¶ - éæ¾â æµç¨ï¼æ¶é¤ CPU å¯¹ GPU çè°åº¦å¼éï¼å®ç°åæ ¸è®¡ç®æ§è½ä¸æ§è¡æççåéæè´ä¼åã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="bju28-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="bju28-0-0"><span data-offset-key="bju28-0-0">ï¼4ï¼ä¸èååæå»ºæè´æ§è½è®¡ç®é¾è·¯</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="1aest-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="1aest-0-0"><span data-offset-key="1aest-0-0">å¸åæè´æ§è½é¾è·¯ï¼æå¨ç¼å triton.jit å®å¶åæ ¸ â åµå¥ PyTorch æ¨¡å / å½æ° â éè¿ torch.compile è¿è¡ä¸å±è®¡ç®å¾ä¼åï¼ç®å­èåãåå­å¤ç¨ç­ï¼ â torch.compile èªå¨å¯ç¨ CUDA Graph ä¼åæ§è¡æµç¨ â å®ç° GPU è®¡ç®æ§è½æå¤§åã</span></div>
</div>
<h1 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="fu2v8-0-0"><span data-offset-key="fu2v8-0-0">9. TP æ¨¡å¼</span></h1>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="7u897-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="7u897-0-0"><span data-offset-key="7u897-0-0">TP æ¨¡å¼å°ç©éµè®¡ç®æè¡ãåæåå°å¤é¢ GPU ä¸æ§è¡ï¼æ¶åä¸¤ä¸ªå³é®ç¹ï¼æéåæ°æä¹å è½½ãå¤æ ¸è®¡ç®ä¹é´å¦ä½ååï¼ä¸é¢åä»ç»ã</span></div>
</div>
<h2 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="9ug66-0-0"><span data-offset-key="9ug66-0-0">9.1. å è½½æéåæ°</span></h2>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="1ed97-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="1ed97-0-0"><span data-offset-key="1ed97-0-0">æéåæ°ä¸ç©éµè®¡ç®å¼ºç¸å³ï¼å æ­¤æéåæ°çå è½½é»è¾éå¸¸ä¸ç©éµè®¡ç®é»è¾ä¸åå°è£å¨åä¸ä¸ªç±»ä¸­ï¼å®ç°åè½çåèæ§ã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="a4too-0-0">
<h3 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="a4too-0-0"><span data-offset-key="a4too-0-0">9.1.1. å³é®ææ¯ç¹</span></h3>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="9sa3o-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="9sa3o-0-0"><span data-offset-key="9sa3o-0-0">ï¼1ï¼åæ°æä»¶ä¸­ï¼æéç©éµä»¥ Key-Value é®å¼å¯¹å½¢å¼å­å¨ï¼è¯»åæ¶åæ ·éç¨ Key-Value æ¹å¼è§£æãå¶ä¸­ key å¯¹åºæéç©éµå¨æ¨¡åä¸­çå½å±ä½ç½®ï¼ä¾å¦ï¼æ¨¡åç¬¬ 0 å± MLP å­å±ç down proj æéå¯¹åºç key ä¸º model.layers.0.mlp.down_proj.weightã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="7ppg-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="7ppg-0-0"><span data-offset-key="7ppg-0-0">ï¼2ï¼åæ°æä»¶ç±è®­ç»æµç¨åå¥ãæ¨çæµç¨è¯»åï¼è®­ç»ä¸æ¨çä¸¤ä¾§å¿é¡»ä¸¥æ ¼å¯¹é½ key çå½åè§åãæ¨¡ååæ°å è½½æ¶ï¼ä¼æ ¹æ®åæ°æä»¶ä¸­ç key åç§°ï¼å¨ nn.Module å¯¹è±¡ä¸­å¹éå¹¶è°ç¨å¯¹åºç weight_loader æ¹æ³å®æå è½½ã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="755gf-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="755gf-0-0"><span data-offset-key="755gf-0-0">ï¼3ï¼æ¨¡åç»æåå«å¤ä¸ªå±çº§ï¼æ¯ä¸å±åé¨ååå«å¤ä¸ªå­æ¨¡åï¼ä¸åå­æ¨¡åå¯¹åºåèªä¸å±çåæ°å è½½æ¹æ³ãPyTorch ç nn.Module éè¿ç¹æ®æ¹æ³ __setattr__ï¼å°æ¨¡åç»æä¸­çåä¸ªå­æ¨¡åæå»ºä¸ºæ å½¢ç»æï¼æ å½¢ç»æä¸­æ¯ä¸ªå¶å­èç¹çè·¯å¾ï¼ä¸åæ°æä»¶ä¸­ç key ä¸ä¸æ å°ï¼éè¿è¯¥è·¯å¾æ¾å°å¶å­èç¹åï¼å³å¯è·åå¯¹åºçåæ°å¯¹è±¡ nn.Parameterï¼èè¯¥åæ°å¯¹è±¡ç»å®äºå¶æå±å­æ¨¡åç weight_loader æ¹æ³ã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="6bnm0-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="6bnm0-0-0"><span data-offset-key="6bnm0-0-0">ï¼4ï¼ç©éµä¹æ³ A * B éµå¾ªãA çè¡ Ã B çåãè®¡ç®è§åï¼å¨æ¨¡åæ¨çä¸­ï¼B ä¸ºæéç©éµï¼å®éè®¿é®æ¶ä»¥åç»´åº¦ä¸ºä¸»ãä¸ºæåè¯»åæçãé¿åç¼å­ï¼Cacheï¼é¢ç¹å¤±æï¼æéç©éµ B éå¸¸ä»¥è½¬ç½®å½¢å¼å­å¨ãTPï¼Tensor Parallelï¼worker å è½½æéæ¶ï¼éééè¯¥è½¬ç½®å­å¨ç¹æ§ ââ å³æéç©éµç¬¬ 0 ç»´å¯¹åºåå§ç©éµçåæ°æ®ï¼ç¬¬ 1 ç»´å¯¹åºåå§ç©éµçè¡æ°æ®ã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="5ju20-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="5ju20-0-0"><span data-offset-key="5ju20-0-0">ä»ä¸è¿°ææ¯ç¹å¯å¾åºæ ¸å¿å¯¹åºå³ç³»ï¼åæ°æä»¶ä¸­çæ¨¡åç»æä»¥ä¸ä¸ªä¸ª key è¡¨ç¤ºï¼è¿äº key æå±çº§å³ç³»å¯æå»ºä¸ºä¸æ£µè·¯å¾æ ï¼ä»£ç ä¸­çæ¨¡åç»æä»¥æåå«å³ç³»çç±»å¯¹è±¡è¡¨ç¤ºï¼è¿äºç±»å¯¹è±¡åæ ·ææä¸æ£µä¸åæ°æä»¶è·¯å¾æ å®å¨å¯¹åºçæ ã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="b27tp-0-0">
<h3 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="b27tp-0-0"><span data-offset-key="b27tp-0-0">9.1.2. å®æä¸¾ä¾ï¼FFN å± up proj æéå è½½ï¼</span></h3>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="3icrf-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="3icrf-0-0"><span data-offset-key="3icrf-0-0">ï¼1ï¼åè®¾ TP size=2ï¼up proj æéç©éµçåå§å½¢ç¶ä¸º [1024, 3072]ï¼ä¸é¢ä»ç»ä¸ä¸ª TP worker å¦ä½å è½½æéã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="f26gi-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="f26gi-0-0"><span data-offset-key="f26gi-0-0">ï¼2ï¼é¦åï¼æé æ¨¡åå¯¹è±¡æ¶ï¼ä¼åå§å ColumnParallelLinear å¯¹è±¡ï¼å¹¶è®¾å®æ ¸å¿åæ°ï¼input_size=1024ï¼output_size=3072/2=1536ï¼æ TP å°ºå¯¸åååï¼ãè¿ä¸¤ä¸ªåæ°æç»ç¨äºåå§å nn.Parameter å¯¹è±¡ï¼å¯¹åºä»£ç ä¸º <span data-offset-key="f26gi-0-1"><span data-text="true">self.weight = nn.Parameter(torch.empty(output_size, input_size))<span data-offset-key="f26gi-0-2">ï¼éæ³¨ææ­¤å¤åå§åçå¼ éä»¥ output_size ä¸ºè¡ç»´åº¦ãinput_size ä¸ºåç»´åº¦ã</span></span></span></span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="6s4r7-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="6s4r7-0-0"><span data-offset-key="6s4r7-0-0">ï¼3ï¼éåï¼å¯å¨æ¨¡åæéå è½½æµç¨ï¼åä»åæ°æä»¶ä¸­è¯»åææ key-value é®å¼å¯¹ï¼åéè¿ key å¨ nn.Module æ å½¢ç»æä¸­æ¥æ¾å¯¹åºç nn.Parameter å¯¹è±¡ï¼å¹éå°åè°ç¨å¶ç»å®ç weight_loader å½æ°ï¼æ§è¡å·ä½çåæ°å è½½æä½ã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="egb30-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="egb30-0-0"><span data-offset-key="egb30-0-0">ï¼4ï¼åæ°å è½½é¶æ®µï¼éå¯¹åå¹¶è¡æ¨¡å¼ï¼éè¦å¯¹æéå¼ éçç¬¬ 0 ç»´åº¦è¿è¡æåï¼åæ ¹æ®å½åè¿ç¨ç tp_rankï¼TP è¿ç¨ç¼å·ï¼ï¼ç¡®å®æ¬è¿ç¨éè¦å è½½çæéåºé´ï¼å®æåçæéçå è½½ã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="49qid-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="49qid-0-0"><span data-offset-key="49qid-0-0">æ³¨ï¼ä»£ç å®ç°ä¸­ï¼ä¼å° gate ç©éµä¸ up ç©éµè¿è¡åå¹¶å è½½å°æ¾å­ä¸­ï¼å æ­¤å®éå è½½æµç¨ä¼å¨æ­¤åºç¡ä¸å¢å å æ­¥é¢å¤æ­¥éª¤ã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="248v7-0-0">
<h3 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="248v7-0-0"><span data-offset-key="248v7-0-0">9.1.3. æé æ å½¢ç»æç¤ºä¾ä»£ç </span></h3>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="elaid-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="elaid-0-0"><span data-offset-key="elaid-0-0">ä¸é¢ demo ä»£ç å±ç¤ºå¤ä¸ªæå±çº§çå¯¹è±¡å¦ä½éè¿ç¹æ®æ¹æ³ __setattr__ æé æ å½¢ç»æ.</span></div>
</div>
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="3hpeh-0-0">
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 255, 1)">class</span><span style="color: rgba(0, 0, 0, 1)"> MiniModule:
    </span><span style="color: rgba(0, 0, 255, 1)">def</span> <span style="color: rgba(128, 0, 128, 1)">__init__</span>(self, name=<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">root</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">):
        self._name </span>=<span style="color: rgba(0, 0, 0, 1)"> name
        self._modules </span>=<span style="color: rgba(0, 0, 0, 1)"> {}
        self._parameters </span>=<span style="color: rgba(0, 0, 0, 1)"> {}

    </span><span style="color: rgba(0, 0, 255, 1)">def</span> <span style="color: rgba(128, 0, 128, 1)">__setattr__</span><span style="color: rgba(0, 0, 0, 1)">(self, name, value):
        </span><span style="color: rgba(0, 0, 255, 1)">if</span><span style="color: rgba(0, 0, 0, 1)"> isinstance(value, MiniModule):
            self._modules[name] </span>=<span style="color: rgba(0, 0, 0, 1)"> value
        </span><span style="color: rgba(0, 0, 255, 1)">elif</span> name.endswith(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">_weight_loader</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">):
            self._parameters[name] </span>=<span style="color: rgba(0, 0, 0, 1)"> value

        super().</span><span style="color: rgba(128, 0, 128, 1)">__setattr__</span><span style="color: rgba(0, 0, 0, 1)">(name, value)

    </span><span style="color: rgba(0, 0, 255, 1)">def</span> get_all_paths(self, prefix=<span style="color: rgba(128, 0, 0, 1)">""</span><span style="color: rgba(0, 0, 0, 1)">):
        </span><span style="color: rgba(128, 0, 0, 1)">"""</span><span style="color: rgba(128, 0, 0, 1)">éå½éåå¹¶æ¶éææåæ°çå®æ´è·¯å¾</span><span style="color: rgba(128, 0, 0, 1)">"""</span><span style="color: rgba(0, 0, 0, 1)">
        paths </span>=<span style="color: rgba(0, 0, 0, 1)"> []

        </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> 1. åæ¶éå½åå±çº§çåæ°è·¯å¾</span>
        <span style="color: rgba(0, 0, 255, 1)">for</span> p_name <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> self._parameters:
            full_path </span>= f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">{prefix}.{p_name}</span><span style="color: rgba(128, 0, 0, 1)">"</span> <span style="color: rgba(0, 0, 255, 1)">if</span> prefix <span style="color: rgba(0, 0, 255, 1)">else</span><span style="color: rgba(0, 0, 0, 1)"> p_name
            paths.append(full_path)

        </span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> 2. éå½è¿å¥å­æ¨¡åï¼ä¼ éæ´æ°åçåç¼</span>
        <span style="color: rgba(0, 0, 255, 1)">for</span> m_name, m_obj <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> self._modules.items():
            new_prefix </span>= f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">{prefix}.{m_name}</span><span style="color: rgba(128, 0, 0, 1)">"</span> <span style="color: rgba(0, 0, 255, 1)">if</span> prefix <span style="color: rgba(0, 0, 255, 1)">else</span><span style="color: rgba(0, 0, 0, 1)"> m_name
            paths.extend(m_obj.get_all_paths(new_prefix))

        </span><span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)"> paths

</span><span style="color: rgba(0, 0, 255, 1)">def</span><span style="color: rgba(0, 0, 0, 1)"> q_weight_loader():
    </span><span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">this is q_weight_loader</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)

</span><span style="color: rgba(0, 0, 255, 1)">def</span><span style="color: rgba(0, 0, 0, 1)"> down_weight_loader():
    </span><span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">this is down_weight_loader</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)

</span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> --- æé æ å½¢ç»æ ---</span>
model = MiniModule(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Qwen3</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
model.layers </span>= MiniModule(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Layers</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
model.layers.attention </span>= MiniModule(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">Attention</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
model.layers.attention.q_weight_loader </span>=<span style="color: rgba(0, 0, 0, 1)"> q_weight_loader
model.layers.mlp </span>= MiniModule(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">MLP</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
model.layers.mlp.down_weight_loader </span>=<span style="color: rgba(0, 0, 0, 1)"> down_weight_loader

</span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> --- æå°ææè·¯å¾ ---</span>
<span style="color: rgba(0, 0, 255, 1)">print</span>(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">éåæ¨¡åçææåæ°è·¯å¾ï¼</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
all_paths </span>=<span style="color: rgba(0, 0, 0, 1)"> model.get_all_paths()
</span><span style="color: rgba(0, 0, 255, 1)">for</span> path <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> all_paths:
    </span><span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">è·¯å¾: {path}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)

</span><span style="color: rgba(0, 128, 0, 1)">#</span><span style="color: rgba(0, 128, 0, 1)"> --- æ¨¡æ nano-vllm çè®¿é®é»è¾ ---</span>
<span style="color: rgba(0, 0, 255, 1)">def</span><span style="color: rgba(0, 0, 0, 1)"> mock_get_parameter(root, path):
    parts </span>= path.split(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">.</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
    curr </span>=<span style="color: rgba(0, 0, 0, 1)"> root
    </span><span style="color: rgba(0, 0, 255, 1)">for</span> part <span style="color: rgba(0, 0, 255, 1)">in</span> parts[:-1<span style="color: rgba(0, 0, 0, 1)">]:
        curr </span>=<span style="color: rgba(0, 0, 0, 1)"> curr._modules[part]
    </span><span style="color: rgba(0, 0, 255, 1)">return</span> curr._parameters[parts[-1<span style="color: rgba(0, 0, 0, 1)">]]

target </span>= <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">layers.attention.q_weight_loader</span><span style="color: rgba(128, 0, 0, 1)">"</span>
<span style="color: rgba(0, 0, 255, 1)">print</span>(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">\næ¨¡ææ¥æ¾è·¯å¾ '{target}':</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
loader </span>=<span style="color: rgba(0, 0, 0, 1)"> mock_get_parameter(model, target)
loader()</span></pre>
</div>
<p><span data-offset-key="a947g-0-0">è¾åºç»æï¼</span></p>
</div>
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="9169c-0-0">
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 0, 1)">éåæ¨¡åçææåæ°è·¯å¾ï¼
è·¯å¾: layers.attention.q_weight_loader
è·¯å¾: layers.mlp.down_weight_loader

æ¨¡ææ¥æ¾è·¯å¾ </span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(128, 0, 0, 1)">layers.attention.q_weight_loader</span><span style="color: rgba(128, 0, 0, 1)">'</span><span style="color: rgba(0, 0, 0, 1)">:
this is q_weight_loader</span></pre>
</div>
<h2><span data-offset-key="1c5sg-0-0">9.2. å¤ GPU ä¹é´çè®¡ç®åå</span></h2>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="2akov-0-0">
<h3 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="2akov-0-0"><span data-offset-key="2akov-0-0">9.2.1. åè½ç»è</span></h3>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="e8sf9-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="e8sf9-0-0"><span data-offset-key="e8sf9-0-0">nano-vllm åªèèåæºåçå¤ GPU ååï¼ååè¿ç¨å¦ä¸ï¼</span></div>
</div>
<div class="Image-captionContainer" data-size="normal">
<div>
<div class="Image-resizerContainer css-ym3v7r" data-size="normal">
<div class="css-79elbk">
<div>
<div class="ImageDelete-Container css-xi606m">
<div class="ImageDelete-Wrapper css-1gomreu" style="text-align: center"><img src="https://pic1.zhimg.com/80/v2-7f054d91f4badab37cab087059b847da_1440w.png?source=ccfced1a" width="500" height="351" class="Image FocusPlugin--unfocused Image--isBlock css-1phd9a0" loading="lazy" data-size="normal" data-rawwidth="888" data-rawheight="624" data-watermark="original" data-original-src="https://picx.zhimg.com/v2-7f054d91f4badab37cab087059b847da.jpg?source=ccfced1a" data-watermark-src="https://pic1.zhimg.com/v2-2ef0dde703c5cd92d206eb126dd9addc_1440w.jpg?source=ccfced1a"></div>
</div>
</div>
</div>
</div>
</div>
<div style="text-align: center">å¾ 5</div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="8ko79-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="8ko79-0-0"><span data-offset-key="8ko79-0-0">ï¼1ï¼è¿ç¨éç¦»ä¸ç¬ç«å è½½ï¼ éç¨å¤è¿ç¨æ¨¡å¼ï¼ä¸ä¸ª GPU å¯¹åºä¸ä¸ªç¬ç«è¿ç¨ãåè¿ç¨å¹¶åè¯»åæéæä»¶ï¼å¹¶æ ¹æ®èªå·±ç tp_rank æç§é¢è®¾çååç­ç¥ï¼å¦ ColumnParallel çè¡ååæ RowParallel çåååï¼ï¼å°å±äºèªå·±çé£é¨åæ°æ®ä» safetensors å è½½å°æ¾å­ä¸­ã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="30dnu-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="30dnu-0-0"><span data-offset-key="30dnu-0-0">ï¼2ï¼æ§å¶é¢ååï¼Control Planeï¼ï¼ Rank 0 è´è´£å¨å±è°åº¦ï¼éè¿å±äº«åå­å°æ¨çè¯·æ±ï¼TokensãSampling Params ç­ï¼åæ­¥ç»å¶ä» Rankã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="e56gm-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="e56gm-0-0"><span data-offset-key="e56gm-0-0">ï¼3ï¼æ°æ®é¢éä¿¡ï¼Data Planeï¼ï¼ å¨ç©éµè®¡ç®çå³é®èç¹ï¼å©ç¨éä¿¡åè¯­ï¼å¦ all-reduce å¤çååæ±åãall-gather å¤çåºåæ¼æ¥ï¼å®æå¼ éå¹¶è¡çç»ææ±æ»ï¼ä½¿åå¸å¨ä¸åæ¾å¡ä¸çè®¡ç®ç»æå¨æ°å­¦ä¸ç­ä»·äºåå¡è®¡ç®ã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="1a163-0-0">
<h3 class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="1a163-0-0"><span data-offset-key="1a163-0-0">9.2.2. ç¤ºä¾ä»£ç </span></h3>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="4et0l-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="4et0l-0-0"><span data-offset-key="4et0l-0-0">ä¸é¢åä¸ä¸ªç®åçæ°æ®éä¿¡ä¾å­ï¼</span></div>
</div>
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="bue3l-0-0">
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 0, 1)">import torch
import torch.distributed as dist
import torch.multiprocessing as mp
import </span><span style="color: rgba(0, 0, 255, 1)">time</span><span style="color: rgba(0, 0, 0, 1)">

def setup(rank, world_size):
    dist.init_process_group(
        </span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">nccl</span><span style="color: rgba(128, 0, 0, 1)">"</span>, <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">tcp://127.0.0.1:2333</span><span style="color: rgba(128, 0, 0, 1)">"</span>, world_size=world_size, rank=<span style="color: rgba(0, 0, 0, 1)">rank
    )
    torch.cuda.set_device(rank)

def cleanup():
    dist.destroy_process_group()

def test_all_reduce(rank, world_size):
    </span><span style="color: rgba(128, 0, 0, 1)">"""
</span>    All-<span style="color: rgba(0, 0, 0, 1)">Reduce å­å½æ°ï¼å°ææ GPU çæ°æ®è¿è¡å½çº¦æä½ï¼æ±åï¼ï¼ç»æåæ­¥å°ææ GPU

    ä½¿ç¨åºæ¯ï¼
    </span>-<span style="color: rgba(0, 0, 0, 1)"> RowParallelLinear çè¾åºèå
    </span>-<span style="color: rgba(0, 0, 0, 1)"> éè¦ææ GPU é½å¾å°ç¸åçèåç»æ
    </span><span style="color: rgba(128, 0, 0, 1)">"""
</span>    print(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">[Rank {rank}] ===== All-Reduce ç¤ºä¾ =====</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)

    </span><span style="color: rgba(0, 0, 255, 1)">if</span> rank == <span style="color: rgba(128, 0, 128, 1)">0</span><span style="color: rgba(0, 0, 0, 1)">:
        data </span>= torch.tensor([<span style="color: rgba(128, 0, 128, 1)">1.0</span>, <span style="color: rgba(128, 0, 128, 1)">2.0</span>], device=f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">cuda:{rank}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
    </span><span style="color: rgba(0, 0, 255, 1)">else</span><span style="color: rgba(0, 0, 0, 1)">:
        data </span>= torch.tensor([<span style="color: rgba(128, 0, 128, 1)">3.0</span>, <span style="color: rgba(128, 0, 128, 1)">4.0</span>], device=f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">cuda:{rank}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)

    print(f</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">[Rank {rank}] All-Reduce before: {data}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)
    dist.all_reduce(data, op</span>=<span style="color: rgba(0, 0, 0, 1)">dist.ReduceOp.SUM)
    print(f</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">[Rank {rank}] All-Reduce after:  {data}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)

def test_all_gather(rank, world_size):
    </span><span style="color: rgba(128, 0, 0, 1)">"""
</span>    All-<span style="color: rgba(0, 0, 0, 1)">Gather å­å½æ°ï¼æ¶éææ GPU çæ°æ®å°æ¯ä¸ª GPU ä¸

    ä½¿ç¨åºæ¯ï¼
    </span>-<span style="color: rgba(0, 0, 0, 1)"> VocabParallelEmbedding çè¾åºæ¶é
    </span>-<span style="color: rgba(0, 0, 0, 1)"> ParallelLMHead ç logits æ¶é
    </span>-<span style="color: rgba(0, 0, 0, 1)"> éè¦æ¯ä¸ª GPU é½è·å¾ææ GPU çå®æ´æ°æ®
    </span><span style="color: rgba(128, 0, 0, 1)">"""
</span>    print(f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">[Rank {rank}] ===== All-Gather ç¤ºä¾ =====</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)

    # Rank </span><span style="color: rgba(128, 0, 128, 1)">0</span> äº§ç [<span style="color: rgba(128, 0, 128, 1)">10</span>, <span style="color: rgba(128, 0, 128, 1)">20</span>], Rank <span style="color: rgba(128, 0, 128, 1)">1</span> äº§ç [<span style="color: rgba(128, 0, 128, 1)">30</span>, <span style="color: rgba(128, 0, 128, 1)">40</span><span style="color: rgba(0, 0, 0, 1)">]
    local_data </span>=<span style="color: rgba(0, 0, 0, 1)"> torch.tensor(
        [</span><span style="color: rgba(128, 0, 128, 1)">10.0</span> + rank * <span style="color: rgba(128, 0, 128, 1)">20</span>, <span style="color: rgba(128, 0, 128, 1)">20.0</span> + rank * <span style="color: rgba(128, 0, 128, 1)">20</span>], device=f<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">cuda:{rank}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">
    )
    print(f</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">[Rank {rank}] All-Gather local data: {local_data}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)

    gathered_list </span>= [torch.zeros_like(local_data) <span style="color: rgba(0, 0, 255, 1)">for</span> _ <span style="color: rgba(0, 0, 255, 1)">in</span><span style="color: rgba(0, 0, 0, 1)"> range(world_size)]
    dist.all_gather(gathered_list, local_data)

    print(f</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">[Rank {rank}] All-Gather result: {gathered_list}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)

    gathered_tensor </span>= torch.<span style="color: rgba(0, 0, 255, 1)">cat</span>(gathered_list, dim=<span style="color: rgba(128, 0, 128, 1)">0</span><span style="color: rgba(0, 0, 0, 1)">)
    print(f</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">[Rank {rank}] All-Gather concatenated: {gathered_tensor}</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">)

def tp_demo(rank, world_size):
    setup(rank, world_size)

    test_all_reduce(rank, world_size)
    </span><span style="color: rgba(0, 0, 255, 1)">time</span>.<span style="color: rgba(0, 0, 255, 1)">sleep</span>(<span style="color: rgba(128, 0, 128, 1)">5</span><span style="color: rgba(0, 0, 0, 1)">)
    test_all_gather(rank, world_size)

    cleanup()

def run_demo():
    world_size </span>= <span style="color: rgba(128, 0, 128, 1)">2</span><span style="color: rgba(0, 0, 0, 1)">
    mp.spawn(tp_demo, args</span>=(world_size,), nprocs=world_size, <span style="color: rgba(0, 0, 255, 1)">join</span>=<span style="color: rgba(0, 0, 0, 1)">True)

</span><span style="color: rgba(0, 0, 255, 1)">if</span> __name__ == <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">__main__</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">:
    </span><span style="color: rgba(0, 0, 255, 1)">if</span> torch.cuda.device_count() &gt;= <span style="color: rgba(128, 0, 128, 1)">2</span><span style="color: rgba(0, 0, 0, 1)">:
        run_demo()
    </span><span style="color: rgba(0, 0, 255, 1)">else</span><span style="color: rgba(0, 0, 0, 1)">:
        print(f</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">éè¦è³å° 2 å¼  GPU æ¥è¿è¡æ­¤ TP ç¤ºä¾</span><span style="color: rgba(128, 0, 0, 1)">"</span>)</pre>
</div>
<h1><span data-offset-key="6gvaf-0-0">10. å¶ä»</span></h1>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="mg9h-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="mg9h-0-0"><span data-offset-key="mg9h-0-0">æ¬æåºäº nano-vllm é¡¹ç®ï¼èç¦è®²è§£å¤§æ¨¡åæ¨çå éé¢åä¸­æåºç¡çè¥å¹²æ ¸å¿ææ¯ç¹ãéè¦è¯´æçæ¯ï¼å¤§æ¨¡åæ¨çå éçææ¯ä½ç³»ååä¸°å¯ï¼æ¬é¡¹ç®å¹¶æªè¦çå¨é¨åå®¹ï¼ä¾å¦ï¼è®¡ç®éä¿¡éå ï¼Overlapï¼ãå¤ token é¢æµï¼MTPï¼MultiâToken Predictionï¼ãå¤æµãå¤è¿ç¨æå¡ï¼MPSï¼Multi-Process Serviceï¼ãæ°æ®å¹¶è¡ï¼DPï¼ãæµæ°´çº¿å¹¶è¡ï¼PPï¼ãä¸ä¸æå¹¶è¡ï¼CPï¼ãä¸å®¶å¹¶è¡ï¼EPï¼ä»¥å PD åç¦»ç­è¿é¶ææ¯æ¹åï¼å¯ä½ä¸ºåç»­æ·±å¥å­¦ä¹ çæå±åå®¹ã</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="dq4gr-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="dq4gr-0-0"><span data-offset-key="dq4gr-0-0">&nbsp;</span></div>
</div>
<div class="Editable-unstyled" data-block="true" data-editor="2doff" data-offset-key="9n200-0-0">
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="9n200-0-0"><span data-offset-key="9n200-0-0">æ³¨1ï¼å¨æ¬æçæ»ç»è¿ç¨ä¸­ï¼é¤äºæ¥çæºä»£ç ï¼ä¹åå© deepwiki ä»¥åå¶ä» AI å·¥å·è¾å©ã&nbsp;<br><br></span></div>
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="9n200-0-0"><span data-offset-key="9n200-0-0">æ¬æ:&nbsp;<a href="https://www.cnblogs.com/cswuyg/p/19471225" target="_blank">https://www.cnblogs.com/cswuyg/p/19471225</a></span></div>
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="9n200-0-0"><span data-offset-key="9n200-0-0">ç¥ä¹:&nbsp;<a href="https://zhuanlan.zhihu.com/p/1989806890381746916" target="_blank" rel="noopener nofollow">https://zhuanlan.zhihu.com/p/1989806890381746916</a></span></div>
<div class="public-DraftStyleDefault-block public-DraftStyleDefault-ltr" data-offset-key="9n200-0-0"><span data-offset-key="9n200-0-0">å¬ä¼å·:&nbsp;<a href="https://mp.weixin.qq.com/s/6mAZ49iP1SCKt5ZdWf6ErQ" target="_blank" rel="noopener nofollow">https://mp.weixin.qq.com/s/6mAZ49iP1SCKt5ZdWf6ErQ</a></span></div>


</div>
</div>
<div class="clear"></div>

	<div class="postDesc">posted on 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-01-12 12:38">2026-01-12 12:38</span>&nbsp;
<a href="https://www.cnblogs.com/cswuyg">-é¶å-</a>&nbsp;
éè¯»(<span id="post_view_count">0</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19471225);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19471225', targetLink: 'https://www.cnblogs.com/cswuyg/p/19471225', title: 'åºäº nano-vLLM å­¦ä¹ å¤§æ¨¡åæ¨çå³é®åè½' })">ä¸¾æ¥</a>
</div>
 ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ ä¸å¨ç­ç¹åé¡¾ï¼1.5-1.11ï¼ ]]></title>
    <link>https://www.cnblogs.com/cmt/p/19469697</link>
    <guid>2dbc8c0d0e7a0f8c99ff013e22978be3</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/cmt/p/19469697" title="åå¸äº 2026-01-12 08:38">
    <span role="heading" aria-level="2">ä¸å¨ç­ç¹åé¡¾ï¼1.5-1.11ï¼</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body blogpost-body-html">
<p>ç­ç¹éç¬ï¼</p>
<p> Â· <a href="https://www.cnblogs.com/knqiufan/archive/2026/01/07/19449849.html" target="_blank">Claude Code å®å¨æåï¼ä½¿ç¨æ¹å¼ãæå·§ä¸æä½³å®è·µ</a> (<a href="https://www.cnblogs.com/knqiufan/" target="_blank">knqiufan</a>) <br>
 Â· <a href="https://www.cnblogs.com/shanyou/archive/2026/01/05/19441004.html" target="_blank">ä» TIOBE 2025 å¹´åº¦è¯­è¨å° 2026 å¹´ C# æºè½ä½çæçå¨é¢å´èµ·</a>
(<a href="https://www.cnblogs.com/shanyou/" target="_blank">å¼ åå</a>)                    <br>
 Â· <a href="https://www.cnblogs.com/thisiswhy/archive/2026/01/08/19458678.html" target="_blank">å¯æï¼çå°ä¸ä¸ªå·è¡çç®æ³ã</a>
(<a href="https://www.cnblogs.com/thisiswhy/" target="_blank">whyææ¯</a>)                    <br>
 Â· <a href="https://www.cnblogs.com/xueweihan/archive/2026/01/06/19445015.html" target="_blank">å« AI åççé¢å¤ªä¸ï¼è£ä¸è¿ä¸ªå¼æºæä»¶ï¼ç§åèµæ·±è®¾è®¡å¸</a>
(<a href="https://www.cnblogs.com/xueweihan/" target="_blank">åå¾®å¯</a>)                    <br>
 Â· <a href="https://www.cnblogs.com/shanyou/archive/2026/01/07/19452660.html" target="_blank">XAML Studio å·²æ­£å¼å¼æº</a>
(<a href="https://www.cnblogs.com/shanyou/" target="_blank">å¼ åå</a>)                    <br>
 Â· <a href="https://www.cnblogs.com/yupi/archive/2026/01/09/19460549.html" target="_blank">å¹²æ Claude Codeï¼è¿ä¸ªå¼æº AI ç¼ç¨å·¥å·æç¯äºï¼</a>
(<a href="https://www.cnblogs.com/yupi/" target="_blank">ç¨åºåé±¼ç®</a>)                    <br>
 Â· <a href="https://www.cnblogs.com/jinjiangongzuoshi/archive/2026/01/05/19440715.html" target="_blank">æè¿å¾ç«ççClaude Skillså°åºæ¯ä¸ªå¥ï¼è§£å³ä»ä¹é®é¢ï¼æä¹ç¨ï¼</a>
(<a href="https://www.cnblogs.com/jinjiangongzuoshi/" target="_blank">çå¸</a>)                    <br>
 Â· <a href="https://www.cnblogs.com/kklldog/archive/2026/01/07/19449864.html" target="_blank">ä¸ºä»ä¹è¯´ IO æä½å¼æ­¥æææä¹</a>
(<a href="https://www.cnblogs.com/kklldog/" target="_blank">Agile.Zhou</a>)                    <br>
 Â· <a href="https://www.cnblogs.com/12lisu/archive/2026/01/08/19456855.html" target="_blank">å¼ºçæ¨è | é¿éå¼æºçè¿10ä¸ªç¥çº§é¡¹ç®</a>
(<a href="https://www.cnblogs.com/12lisu/" target="_blank">èä¸è¯´ææ¯</a>)                    <br>
 Â· <a href="https://www.cnblogs.com/12lisu/archive/2026/01/06/19447172.html" target="_blank">ç¨éªè±ç®æ³å°±ä¸ä¼äº§çéå¤çID?</a>
(<a href="https://www.cnblogs.com/12lisu/" target="_blank">èä¸è¯´ææ¯</a>)                    <br>
 Â· <a href="https://www.cnblogs.com/ymtianyu/archive/2026/01/05/19442584.html" target="_blank">ä»å®è£å°ä¸çº¿ï¼ä¸ä»½ Nginx å®ææåï¼è®©ä½ ç Web åºç¨ç¨³å»ºå®å¨</a>
(<a href="https://www.cnblogs.com/ymtianyu/" target="_blank">ä¸åç¨åºåªå</a>)                    <br>
 Â· <a href="https://www.cnblogs.com/tianqing/archive/2026/01/05/19439916.html" target="_blank">.NET 10 New feature æ°å¢åè½ä»ç»-WebSocketåè½å¢å¼º</a>
(<a href="https://www.cnblogs.com/tianqing/" target="_blank">Eric zhou</a>)                    <br>
            </p>
<p>ç­ç¹æ°é»ï¼</p>
<p>
 Â· <a href="https://news.cnblogs.com/n/812350/" target="_blank">Stack Overflow å½»åºåäºï¼æ¯18å¹´åä¸çº¿é¦æé®é¢æ°éè¿å°</a><br>
 Â· <a href="https://news.cnblogs.com/n/812432/" target="_blank">ç»äºæå®é¤äºï¼ç¼ºå°å®ä½æé®çè½¦å°±æ¯æ´å±é©</a><br>
 Â· <a href="https://news.cnblogs.com/n/812455/" target="_blank">âææäººè¯·æ³¨æç¨èå«çâï¼æå·¥äººæåºè¯¥ææç6ä»¶äº</a><br>
 Â· <a href="https://news.cnblogs.com/n/812551/" target="_blank">æ¯«æ å¾åï¼DeepSeek R1çæ´86é¡µè®ºæï¼è¿ææ¯çæ­£çOpen</a><br>
 Â· <a href="https://news.cnblogs.com/n/812321/" target="_blank">Rediså®£å¸é­æºåï¼ä¸­å½ææ¯äººçâä¸æ¸¸æ¶å»â</a><br>
 Â· <a href="https://news.cnblogs.com/n/812667/" target="_blank">Stack Overflowå·²æ­»ï¼CEOå¸¦éçèµ1.15äº¿åï¼6ä¸ªæåå°åæ</a><br>
 Â· <a href="https://news.cnblogs.com/n/812425/" target="_blank">8å¤©æ´æ¶¨400ä¸ç²ä¸åå¡æ¿ï¼èç¥æ¯ä¿è´¨ææç­çç½çº¢åï¼</a><br>
 Â· <a href="https://news.cnblogs.com/n/812328/" target="_blank">2025ï¼è¿äºäºèç½å·¨å¤´èµ¢éº»äº</a><br>
 Â· <a href="https://news.cnblogs.com/n/812333/" target="_blank">Claude CodeãCursor é½è¿æ¶äºï¼ï¼ç¡è°·é¡¶æµå¤§çç¸åºæ´è®ºï¼AI ç¼ç¨è¦ç»æ»¡ 2000 å°æ¶æç®âä¼ç¨âï¼ä¸å¹´ä¸ç¨ä¸ççº§å¤§ç¥ä¹ä¼æ²¦ä¸ºå®ä¹ çæ°´å¹³</a><br>
 Â· <a href="https://news.cnblogs.com/n/812428/" target="_blank">ä¸­äº§ãèªå¾ä¸ä»¶å¥ãï¼å®ç¬¬ä¸ä¸ªå¡æ¿ï¼</a><br>
 Â· <a href="https://news.cnblogs.com/n/812541/" target="_blank">é©¬æ¯åææ°æ­å®¢é¿å¹ï¼ä¸­å½å¬æäºæçè¯ï¼2026å¹´å°å¨ç®åä¸ç¢¾åä¸ç</a><br>
 Â· <a href="https://news.cnblogs.com/n/812677/" target="_blank">å ä¸ºAIç¼ç¨ï¼Tailwind CSSå·®ç¹æ­»äº</a></p>
</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-01-12 08:38">2026-01-12 08:38</span>&nbsp;
<a href="https://www.cnblogs.com/cmt">åå®¢å­å¢é</a>&nbsp;
éè¯»(<span id="post_view_count">0</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19469697);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19469697', targetLink: 'https://www.cnblogs.com/cmt/p/19469697', title: 'ä¸å¨ç­ç¹åé¡¾ï¼1.5-1.11ï¼' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ ä¸å­é¿æè®²è§£ï¼å¢éè½å° AI è¾å©ç¼ç¨å AI Specs å®æ ]]></title>
    <link>https://www.cnblogs.com/whuanle/p/19469026</link>
    <guid>b2beb3563fc0d2a462c23736619c4d1c</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/whuanle/p/19469026" title="åå¸äº 2026-01-12 08:34">
    <span role="heading" aria-level="2">ä¸å­é¿æè®²è§£ï¼å¢éè½å° AI è¾å©ç¼ç¨å AI Specs å®æ</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                    <div id="cnblogs_post_description" style="display: none">
        
        å»ºè®¾ä½¿ç¨ AI è¾å©ç¼ç¨çå¢éï¼ä½¿ç¨ AI Specs è§èåå¢éåä½æµç¨åç¼ç è§èï¼è®© AI è½å°ãå®ç°ä¸å¡ä»·å¼ã
    </div>
<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h2 id="ai-ç¼ç¨å¢éåä½">AI ç¼ç¨å¢éåä½</h2>
<h3 id="åå²èæ¯">åå²èæ¯</h3>
<p>AI åå±çéåº¦å®å¨å¤ªå¿«äºï¼å¨ GPT-3 æ¨ªç©ºåºä¸çé¶æ®µï¼é£ä¸ªæ¶ååªè½ä½¿ç¨å¯¹è¯æ¡ä¸é®ä¸ç­ï¼å°ç°å¨åç§ RAGãAI WorkflowãAI Agent ç­åç±»ææ¯ï¼ä½¿å¾ AI å¯ä»¥åæ´å¤çäºæï¼å®ç°æ´å å¼ºå¤§çåè½ãå¨ cursorãtrae ç­ AI IDE åºç°åï¼å¾å¤äººä¾¿å½»åºè¿·ä¸äºè¿é¡¹è¶³ä»¥é¢ è¦ä¼ ç»å·¥ä½æ¨¡å¼çææ¯ï¼å°¤å¶å¨ç¼ç¨é¢åï¼è¿åºåé©çæµªæ½®æ¥å¾å°¤ä¸ºè¿ç ââ æåï¼å½æä»¬é¢å¯¹å¤æçä¸å¡åè½ãæ¦æ¶©çè¯­æ³å®ç°ææ¯éççæ¡æ¶è°ç¨æ¶ï¼æ éåèè´¹å¤§éæ¶é´ç¿»éææ¡£ãè°è¯ä»£ç ï¼åªééè¿èªç¶è¯­è¨å AI æè¿°éæ±ï¼å°±è½åå©å®çé®ç­å¼åå¤è·åå¯ç¨çä»£ç çæ®µï¼è¿ä¸ä»å¤§å¤§éä½äºç¼ç¨çé¨æ§ï¼æ´è®©å¼åèä»éå¤çåºç¡ç¼ç å·¥ä½ä¸­å¾å°äºåæ­¥è§£æ¾ï¼ä¹ä¸ºåç»­å¯¹è¯å¼ä»£ç çæãVibe Code ä¹è³ Spec Code ç­æ´åè¿çç¼ç¨èå¼ï¼åä¸äºåæ»¡æ éå¯è½çç§å­ã</p>
<br>
<p>ç®åï¼ä¸»æµç AI è¾å©ç¼ç¨ä¸»è¦æ¯ AI Agentï¼å¨ AI IDE ä¸­è¾å¥è¦åçåè½ï¼AI ä¼èªå¨è¯»åé¡¹ç®æä»¶ï¼ç»è¿æèåç¼åå¯¹åºçä»£ç ï¼å¹¶ä¸ä¼èªå¨ä¿®æ­£ä»£ç éè¯¯ï¼ç¡®ä¿ä»£ç å¯ä»¥ç¼è¯éè¿ãè¿ä¾¿æ¯å¤§è¯­è¨æ¨¡åå¬ççå¯¹è¯å¼ AI ä»£ç çæï¼å¼å¯äºèªç¶è¯­è¨äº¤äºçæä»£ç çæ¶ä»£ï¼å¼åèéè¿å¤è½®å¯¹è¯è®© AI äº§åºä»£ç çæ®µå¹¶æå¨æ´åï¼AI ä»ä½ä¸ºè¾å©å·¥å·ï¼éåæ¼è¿ç Vibe Codeï¼æ°å´ç¼ç¨ï¼èå¼ï¼è®©å¼åèåªéæè¿°é«é¶æå¾å³å¯é©±å¨ AI å®æå¨éä»£ç çç¼åä¸è¿­ä»£ï¼äººç±»è§è²ä»ç¼ç èè½¬åéæ±å¼å¯¼èä¸æµè¯èï¼èç¦å¿«éååä¸åæéªè¯ã</p>
<p><img src="https://www.whuanle.cn/wp-content/uploads/2026/01/post-22312-69639ce1adf62.png" alt="image-20260109185650106" loading="lazy"></p>
<br>
<p>ä½æ¯ï¼AI Agent æ¨¡å¼ä¸ç AI è¾å©ç¼ç¨ï¼ä¹å­å¨ä¸äºå¸¸è§çé®é¢ï¼æä»¥å¨ IT åæµè¡çè¿å¾ï¼</p>
<p><img src="https://www.whuanle.cn/wp-content/uploads/2026/01/post-22312-69639ce1d759f." alt="896b42e496e1d780c1b2ba5685065dc5" loading="lazy"></p>
<blockquote>
<p>æè°¢ç­å¿ç½åãè¿ªè¿¦ãæä¾çå¾çã</p>
</blockquote>
<br>
<p>è½ç¶ä¸å¾ææç¬æåï¼è¿éæä»¬å°é®é¢åä¸ºå¤§è¯­è¨æ¨¡åå AI IDE ä¸¤é¨åï¼ä¸é¢ä»ç»å¸¸è§ç AI è¾å©ç¼ç¨é®é¢ã</p>
<p>å¤§è¯­è¨æ¨¡åï¼</p>
<ul>
<li><strong>ç®æ æ¼ç§»</strong>ï¼å¨å¤æ­¥éª¤ãé¿æµç¨çç¼ç¨ä»»å¡ä¸­ï¼å¦å¤æåè½å¼åãé¡¹ç®éæï¼ï¼AI æ§è¡å°ä¸­åé¶æ®µæåç¦»åå§ç®æ ï¼ä¾å¦åæ¬éæ±æ¯ä¼åæ°æ®åºæ¥è¯¢æ§è½ï¼åç»­å´æ ç«¯éå UI ç»ä»¶ï¼æ¬è´¨æ¯ç¼ºä¹ææçç®æ éå®æºå¶ã</li>
<li><strong>éå¤ç¯é</strong>ï¼å¯¹å·²åºç°è¿çéè¯¯ç¼ºä¹é¿æè®°å¿ï¼ç¸åé®é¢ä¼åå¤åºç°ï¼å¦æªæ­£ç¡®å¤çå¼æ­¥å½æ°ç <code>await</code> å³é®å­ãæä»¶è·¯å¾å¼ç¨éè¯¯ï¼ï¼æ æ³èªå¨æ²æ·åå²è§£å³æ¹æ¡ã</li>
<li><strong>ä¸ä¸æçç¸</strong>ï¼ä¸ºè®© AI ææ¡å®æ´é¡¹ç®ä¿¡æ¯ï¼éå°å¤§éä»£ç ãéæ±ææ¡£ãåå²å¯¹è¯å¡è¿ä¸ä¸æçªå£ï¼å¯¼è´æ¨¡åå¤çæçä¸éãååºå»¶è¿ï¼ä¸æå¿½ç¥å³é®ä¿¡æ¯ã</li>
<li><strong>è¿åº¦ä¸¢å¤±</strong>ï¼ä¾èµå¯¹è¯çªå£å­å¨ä»»å¡ç¶æï¼ä¸æ¦å¯¹è¯éç½®ãå·æ°æä¸­æ­ï¼ä¹åçå¼åè¿åº¦ãä¸­é´å³ç­ãå·²ç§¯ç´¯çé¡¹ç®è®¤ç¥ä¼å¨é¨æ¶å¤±ï¼æ æ³æ ç¼ç»­å·¥ã</li>
<li><strong>å¹»è§çæ</strong>ï¼å¨ç¼ºä¹æç¡®åèä¾æ®æ¶ï¼å¯è½ç¼é ä¸å­å¨ç API æ¹æ³ãè¯­æ³è§åæé¡¹ç®éç½®ï¼çæçä¼¼åçä½å®éæ æ³è¿è¡çä»£ç ï¼å¢å è°è¯ææ¬ã</li>
</ul>
<p><br>AI IDEï¼</p>
<ul>
<li><strong>ä¸ä¸æç®¡çè½åä¸è¶³</strong>ï¼å¤æ° AI IDE æªå»ºç«ç¬ç«çå¤é¨è®°å¿æºå¶ï¼ä»ä¾èµæ¨¡åèªå¸¦çä¸ä¸æçªå£ï¼æ æ³é«æå³èé¡¹ç®æä»¶ãåå²æä½è®°å½ï¼é¾ä»¥æ¯æå¤æä»»å¡çè¿è´¯å¼åã</li>
<li><strong>ä»»å¡è¿½è¸ªä¸å¯è§åç¼ºå¤±</strong>ï¼ç¼ºä¹å¯¹ç¼ç¨ä»»å¡çç»æåæè§£ä¸è¿åº¦å¯è§ååè½ï¼æ æ³å <code>task_plan.md</code> é£æ ·æ¸æ°åç°é¶æ®µååãå®æç¶æãå³ç­ä¾æ®ï¼å¼åèé¾ä»¥ææ§ AI çå·¥ä½è½¨è¿¹ã</li>
<li><strong>éè¯¯è®°å½ä¸å¤ç¨èå¼±</strong>ï¼æªéæéè¯¯è¿½è¸ªä½ç³»ï¼AI éå°çæ¥éãä¿®å¤æ¹æ¡æ æ³èªå¨å½æ¡£ï¼æ¢ä¸ä¾¿äºå¼åèåæº¯é®é¢æ ¹æºï¼ä¹æ æ³è®© AI åç»­å¿«éå¤ç¨å·²éªè¯çè§£å³æ¹æ¡ã</li>
<li><strong>æä»¶ååä¸æä¹åä¸è¶³</strong>ï¼å¯¹ AI çæçä¸­é´äº§ç©ï¼å¦è°ç ç¬è®°ãææ¯éåææ¡£ï¼ç¼ºä¹ç»ä¸çå­å¨ä¸ç®¡çæºå¶ï¼æä»¶åæ£ä¸æä¸¢å¤±ï¼æ æ³å½¢æå¯è¿½æº¯ãå¯å¤ç¨çé¡¹ç®ç¥è¯åºã</li>
<li><strong>äººæºåä½è¡æ¥ä¸ç</strong>ï¼å¼åèé¾ä»¥ç´æ¥å¹²é¢ AI çä»»å¡æ§è¡æµç¨ï¼ä¾å¦æ æ³éè¿ç¼è¾ç»æåè®¡åæä»¶è°æ´å¼åæ¹åï¼ä¹ç¼ºä¹ä¾¿æ·çæ¹å¼å®¡æ¥ AI çå³ç­é»è¾ï¼å¯¼è´äººæºååæçä½ä¸ã</li>
<li><strong>æ§è½ä¸ææ¬å¤±è¡¡</strong>ï¼å¤çå¤§è§æ¨¡é¡¹ç®æ¶ï¼é¢ç¹å è½½å¨éä¸ä¸æä¼å¯¼è´ IDE è¿è¡å¡é¡¿ï¼ä¸éå¤å¤çç¸åéæåå®¹ï¼å¦é¡¹ç®æ¡æ¶å®ä¹ãå·¥å·éç½®ï¼ä¼å¢å  Token æ¶èï¼æåä½¿ç¨ææ¬ã</li>
</ul>
<br>
<p>æä»¥ï¼å¨ç®åçææ¯å±éä¸ï¼è¦ç© AI ç¼ç¨ï¼å¶å®è¿ä¸è½ä¸ºææ¬²ä¸ºï¼åæ¶ä½¿ç¨ AI ç¼ç¨æ¶ä¹ä¼ç¢°å°å¾å¤é»ç¢é®é¢ï¼éä½äºç¼ç¨çä½éªåé¡¹ç®ä»£ç è´¨éã</p>
<h3 id="ai-ç¼ç¨ä¸çå¢éåä½çç¹ä¸æ ¸å¿è¯æ±">AI ç¼ç¨ä¸çå¢éåä½çç¹ä¸æ ¸å¿è¯æ±</h3>
<p>åé¢ä»ç»äº AI ç¼ç¨æ¬èº«å®¹æåºç°çé®é¢åææ¯å±éï¼åå°ä»¥å¢éä¸ºåä½è¿è¡ AI ç¼ç¨åä½æ¶ï¼å½å¢éç¼ºä¹æ åååä½æºå¶æ¶ï¼AI ç¼ç¨æé·å¥ âååµä½æâ çå°å¢ï¼ä¼åºç°æ´å å¤çå¤´ç¼çé®é¢ã</p>
<p>å ä¸ºç¬èå¨å¬å¸å¸¦ä¸ä¸ªé¡¹ç®ç»ï¼å·²ç»æå¾å¤æåä½¿ç¨ AI åä»£ç ï¼å¨ç»è¿ä¸æ®µæ¶é´çè§å¯åæèåï¼åç°äºä¸äºé®é¢ï¼æä»¥ææ³å°åè¿ç¯æç« çï¼ç¸ä¿¡è¿äºé®é¢å¨å¤§å®¶çå¬å¸éé¢ä¹ä¼å­å¨ã</p>
<br>
<p><strong>ä»£ç ç¢çå</strong></p>
<blockquote>
<p>å¾å¤åäºåç°ç¨ AI åä»£ç ï¼å¯ä»¥æ©ç¹ä¸ç­ï¼äºæ¯å¤§å®¶é½ç¨ AI åä»£ç ï¼ä½ åä½ çæåæçï¼å¯¼è´æååèªä½¿ç¨ AI çæä»£ç ï¼é£æ ¼ãé»è¾å·®å¼æ¾èï¼æ¨¡åè¡æ¥å°é¾ï¼åæç»´æ¤ææ¬æ¿å¢ãåæ­£åäºç¨ AI åçä»£ç ï¼ææ¯åæ ¹ä¸æ³ç»´æ¤ã</p>
</blockquote>
<br>
<p><strong>è§èå¤±æ§</strong></p>
<blockquote>
<p>å¤§å®¶åºè¯¥é½ææåï¼å¨ä¸åæç¤ºè¯ãç¼åä¸ååè½æ¶ï¼AI ç¼åçä»£ç é£æ ¼åå¼ï¼æ²¡æç»ä¸çè§èåé£æ ¼ï¼AI çæä»£ç å¯è½åç¦»å¢éä»£ç è§èãå®å¨æ åï¼åä¸è´¨ééæ£ã</p>
</blockquote>
<br>
<p><strong>ç¥è¯å­¤å²</strong></p>
<blockquote>
<p>ä¸ªäººä½¿ç¨ AI ç§¯ç´¯çç»éªæ æ³å±äº«ï¼å¢éæ´ä½æçé¾ä»¥æåãä½ ç¨ cursorï¼æç¨ kiroï¼åååçä»£ç ï¼æ²¡æ³ä¸ºå¢éæ²æ·ç¥è¯ç»éªï¼æç¤ºè¯ãåè½åå²è®°å½ãèæ¯ä¸ä¸æç­å®å¨æ²¡æ³å¨å¢éåå±äº«ï¼æ¯ä¸ªäººé½å¾å¨æ¬å°ä½¿ç¨ AI éè¯»ä»£ç çæä¸ä¸æè®°å¿ã</p>
</blockquote>
<br>
<p><strong>åä½ä½æ</strong></p>
<blockquote>
<p>AI åçä»£ç å®éä¸ä¼åºç°ä¸ä¸ªç®åçåè½åä¸å ä»£ç çæåµï¼ä¹æå¯è½ A åäºå A åè½æ¶çæäº Cï¼B åäºå B åè½æ¶åçæäºä¸ä¸ªç±»ä¼¼ç Cï¼é¡¹ç®åç§ä»£ç éç»¼å¤æãå¯¼è´é¾ä»¥ç»ä¸ä»»å¡åéãè¿è¡ä»£ç è¯å®¡æµç¨ï¼å¯¼è´ä¿¡æ¯ä¼ éæ»åï¼å²çªé¢åã</p>
</blockquote>
<br>
<p>é¤äºä»¥ä¸é®é¢å¨å¢éç¼ç¨ä¸­éè¦è§£å³ï¼å¾å¤å¬å¸é½æä»£ç è´¨éè§èè¦æ±ãå®å¨è¦æ±ãååæµè¯è¦ççè¦æ±ï¼æä»¥åºäºè¿äºé®é¢åå¸¸è§å¬å¸ç¼ç¨è¦æ±ï¼ç¬èè®¤ä¸ºå¢é AI ç¼ç¨çæ ¸å¿è¯æ±åºèç¦ï¼</p>
<ul>
<li>ç»´æä¸è´ä»£ç è´¨é</li>
<li>é²æ­¢å®å¨æ¼æ´</li>
<li>åå°éå¤å·¥ä½é</li>
<li>æ åååä½æµç¨</li>
<li>å å¿«å¼åå¨æ</li>
<li>å®ç°ä» âå¿«éååâ å° âå·¥ç¨åè½å°â çè·¨è¶ã</li>
</ul>
<br>
<p>å¾å¤é¢å¯¼å¯¹ AI ç¼ç¨çæ³æ³å¾é¾è¯ï¼è§å¾å¯ä»¥ âéæ¬å¢æâ ï¼ä¸ä¸ªé¡¹ç®å¹³æ¶éè¦ä¸ä¸ªæåå®ï¼ç¨ AI ä¸å¤©å°±è¡ï¼ä»£ç è¿è½åå¾æ¯å¼åè¿å¥½ï¼è¿æ ·å¯ä»¥å¼é¤å¾å¤å¼åäººåï¼æä»¥å·å¬å¤§å®¶å¨å¬å¸ä½¿ç¨ AI ç¼ç¨ã</p>
<blockquote>
<p>åé¢ä¼æå° AI è¾å©ç¼ç¨å¤§çº¦å¯ä»¥æé«å¤å°éåº¦ï¼ä½ä¸å¯è½æ¯ä¸å¤©åå®ä¸ä¸ªæçä»£ç ã</p>
</blockquote>
<p><br>èå®éä¸ï¼é¤éåå å¼ç²çï¼äº§ååå¾æä¹æ ·åå³äº AI æä¹åï¼åæéåº¦ç¡®å®å¾å¿«ãä½æ¯å°äºä¸­åæï¼AI åçä»£ç é¾ä»¥ç»´æ¤ï¼åèä¼å ä¸ºè¦ AI åä»£ç ï¼è±è´¹å¤§éæ¶é´ç¼åæç¤ºè¯ï¼ä¸ºäºå®ç°ä¸ä¸ªå°éæ±ï¼å¯è½è¦è· AI ä¸ç´å¯¹éªï¼æç»é·å¥æ··ä¹±ã</p>
<p>å¶å®ï¼æ­£å¦ç¬èåé¢æè¯´çï¼å¤§è¯­è¨æ¨¡åå AI IDE å¨ç®åæä¸äºææ¯å±éï¼èä¸å¨å¢éä½¿ç¨ AI ç¼ç¨æ¶ä¼å¸¦æ¥å¾å¤åä½é®é¢ï¼å¦ææ²¡æåºå¯¹è¿äºé®é¢çè§£å³æ¹æ³ï¼é£ä¹ä½¿ç¨ AI ç¼åçä»£ç æç»å¯è½æ¯ä¸çæ··ä¹±ï¼èä¸çæä»£ç äººç±»å¯è½æ æ³éè¯»ï¼é¬¼æç¥é AI åçæ¯å¥ã</p>
<p>å¬å¸è½å° AI ç¼ç¨ï¼ç¡®å®å¯ä»¥æé«å¼åéåº¦ï¼ç¼©ç­å¼åå¨æï¼ä½æ¯ä¸åºè¯¥èè°¬å°è®¤ä¸º âä¸ä¸ªæå·¥ä½éä½¿ç¨ AI ä¸å¤©å°±è¡â ãç¬èè®¤ä¸ºï¼é¤äºæéï¼åºå½æ´å¤èç¦å®ç°åé¢æå°ç AI ç¼ç¨çæ ¸å¿è¯æ±ã</p>
<br>
<p>å¾å¤å¬å¸å¤©å¤©é¼å¹ååæµè¯ãä»£ç è§èãé«æ§è½é«è´¨éä»£ç ï¼ç»å¼åæå®ååæµè¯è¦ççåä»£ç å®¡æ¥ç­ææ ï¼åå¤æè¾å¼åäººåï¼ä½æ¯å¬å¸å­å¨åç§åæ ·çå¼åç®¡çåææ¯é®é¢ï¼ç²ç®å®å¶é«è¦æ±çå¼åææ ï¼å®å¨è§£å³ä¸äºå½åçé®é¢ï¼åä¼ä½¿å¾å¼åèº«å¿ç²å¦ã</p>
<p>ç¬èä¹æä»¥è¦è¯´è¿äºï¼æ¯å ä¸ºä»£ç å®¡æ¥ãä»£ç è§èãååæµè¯ç­ï¼åèµ·æ¥æ²¡æé£ä¹ç®åï¼æå¤å°å¬å¸æè¾è¿äºï¼åè½æç»çæ­£åå°ï¼</p>
<blockquote>
<p>è½ä¸è½åå¥½è¿äºï¼å¶å®è·å¬å¸åºå æå³ç³»ï¼è·è½å°é¾åº¦ä¹æå³ç³»ã</p>
</blockquote>
<p><br>å¶å®ï¼åªæè¶³å¤ç®åï¼è§èæè½çæ­£è½å°ã</p>
<p>æä»¥ï¼ç¬èä¸ç´å¨æèï¼å¦ä½è§£å³ AI ç¼ç¨ä¸çå¢éåä½çç¹ä¸æ»¡è¶³æ ¸å¿è¯æ±ï¼å¹¶ä¸çæ­£è½å°ååæµè¯ãä»£ç å®¡æ¥ç­ææ¯è¦æ±ã</p>
<p>è¿å°±æ¯æ¬æçéç¹ï¼AI Specï¼å°åºè¦æä¹åï¼æ¥ä¸æ¥æ¬æå°ä»¥æ¶æå¸çè§åº¦ï¼å»æèï¼å»ç ç©¶ï¼æä»¬æ¯æ¶æå¸ï¼é£ä¹åºè¯¥æä¹æ AI ç¼ç¨è½å°å°å¢éåä½ä¸­ã</p>
<h2 id="è§èå¼åspec-development">è§èå¼å(Spec development)</h2>
<p>åé¢æå°ï¼AI è¾å©ç¼ç¨éæ¸æä¸ºä¸»æµï¼å¤§é¨åå¼åäººåå·²ç»å¨æ¥å¸¸å·¥ä½ä¸­ä½¿ç¨ AI ç¼åä»£ç ï¼ä½æ¯ä¹ä¼å¼å¥å¾å¤é®é¢ï¼å¯¼è´çæå¾å¤ä¸å¯é¢æµçãè´¨éåå·®ä¸é½çä»£ç ãé£ä¹ä¸ºäºè§£å³è¿äºé®é¢ï¼åºç°äº SDD(Spec-Driven Development) è¿ç§æ¦å¿µï¼å¼ºè°å¨ä½¿ç¨ AI ç¼åä»£ç ä¹åï¼åæ Specificationï¼ä»¥ä¾¿çº¦æ AI çæé«è´¨éçãç¬¦åä¸å¡éæ±åææ¯è¦æ±çä»£ç ã</p>
<p>ç®åç¤¾åºä¸­ä¸»è¦å­å¨ä¸ç±» SDD å·¥å·ï¼OpenSpecãKiroãSpec-Kitã</p>
<p><br>ä¸ºäºå®ç° Spec developmentï¼éæ© SDD å·¥å·æ¶ï¼éè¦èèï¼</p>
<ul>
<li>
<p><strong>å·¥å·ä¸æµç¨éé</strong>ï¼éæ© Kiro è¿ç±»æ¯æè§èå®å¶ãå¤åºæ¯åä½ç AI å·¥å·ï¼é¿åå·¥å·åè½ä¸å¢éæµç¨è±èï¼</p>
</li>
<li>
<p><strong>éè§è§èè½å°</strong>ï¼å°å¢éè§åè½¬åä¸ºå¯æ§è¡çé©å­ãSpec æ¨¡æ¿ï¼åå© AI å¼ºå¶è½å°ï¼èéä»åçå¨ææ¡£å±é¢ï¼</p>
</li>
<li>
<p><strong>æå»ºåä½æå</strong>ï¼é¼å±æåä¸»å¨å±äº« AI ä½¿ç¨ç»éªãåä¸æµç¨ä¼åï¼é¿å âååµä½æâ æç»´ï¼</p>
</li>
<li>
<p><strong>å¹³è¡¡èªå¨åä¸äººå·¥</strong>ï¼AI è´è´£æ ååãéå¤æ§å·¥ä½ï¼å¦æµè¯ãè§èæ£æ¥ï¼ï¼äººç±»èç¦æ ¸å¿æ¶æä¸åæå³ç­ï¼å®ç°äººæºååå¢æã</p>
</li>
</ul>
<br>
<p>å¨æ¬æï¼ç¬èè¦è®²è§£çæ¯ Kiro è½å°çåå®¹ã</p>
<p><br>å¨æç´¢èµæçè¿ç¨ä¸­ï¼ç¬èåç°å ç¯åå¾ä¸éçæç« ï¼è¿éä¾è¯»èåèï¼æ¬æå°±ä¸åç¬è®²è§£è¿äº SDD å·¥å·äºã</p>
<blockquote>
<p>AI è§èé©±å¨å¼åâä¸åå®¢âæ·±åº¦å¯¹æ¯ï¼Spec-KitãKiro ä¸ OpenSpec å®ææå - ææ¯æ ï¼</p>
<p><a href="https://jishuzhan.net/article/1988226029513670657" target="_blank" rel="noopener nofollow">https://jishuzhan.net/article/1988226029513670657</a></p>
<p>Transforming Dev Practices with Kiroâs Spec-Driven Tools | AI Native Dev</p>
<p><a href="https://ainativedev.io/transforming-dev-practices-with-kiros-spec-driven-tools" target="_blank" rel="noopener nofollow">https://ainativedev.io/transforming-dev-practices-with-kiros-spec-driven-tools</a></p>
</blockquote>
<br>
<p>è¿éç®åä»ç»ä¸ä¸ Kiroã</p>
<p>Kiro æ¯äºé©¬éäºç§ææ¨åºç AI IDEï¼ä»¥ âè§èé©±å¨å¼åâ ä¸ºæ ¸å¿ï¼å®ç¾ééå¢éåä½éæ±ã</p>
<blockquote>
<p>å¯¹å½åç¨æ·åå¥½ï¼æ éç¹æ®ç½ç»éç½®ã</p>
</blockquote>
<p><img src="https://www.whuanle.cn/wp-content/uploads/2026/01/post-22312-69639ce20c847.png" alt="img" loading="lazy"></p>
<h3 id="å¢éå¯¹é½ai-ç¼ç¨æ ¸å¿æ¦å¿µè§£æ">å¢éå¯¹é½ï¼AI ç¼ç¨æ ¸å¿æ¦å¿µè§£æ</h3>
<p>å¨æ·±å¥å¢éåä½å®è·µåï¼éåæç¡®æ¯æ AI ç¼ç¨çå³é®ææ¯æ¦å¿µï¼æ è®ºæ¯äº§åè¿æ¯æµè¯ï¼ä¹å¿é¡»äºè§£ LLMãMCPãAgent ç­æ¦å¿µï¼éè¦å¢éå¯¹ä¸äºç¥è¯é½è¿å³ï¼ç¡®ä¿æ´ä¸ªå¢éäº¤æµåä½ä¸å­å¨ç¥è¯éç¢ã</p>
<blockquote>
<p>è¿äºæ¦å¿µçç¥è¯ï¼ç¬èå°±ä¸èµè¿°äºã</p>
</blockquote>
<br>
<p>ä¸»æµå¤§è¯­è¨æ¨¡åç¨äºç¼ç¨çè¯åï¼ä½ä¸ºæ¶æå¸éè¦æ¸æ°äºè§£ä¸åæ¨¡åçç¹é¿åä¼ç¼ºç¹ï¼å¨ç¼ç¨é¢ååªä¸ªæ¨¡åæä¼ç§æéåç¨äºç¼ç¨ã</p>
<blockquote>
<p>ç¬èåç°å ä¸ªç½ç«å¾ä¸éï¼æåç±»æ¨¡åçä»ç»åè¯åï¼å°åï¼</p>
<p><a href="https://apxml.com/zh/leaderboards/coding-llms" target="_blank" rel="noopener nofollow">Best LLMs for Coding | LLM Leaderboards</a></p>
<p><a href="https://llm-stats.com/" target="_blank" rel="noopener nofollow">https://llm-stats.com/</a></p>
<p><a href="https://www.aibase.com/zh" target="_blank" rel="noopener nofollow">https://www.aibase.com/zh</a></p>
</blockquote>
<p><img src="https://www.whuanle.cn/wp-content/uploads/2026/01/post-22312-69639ce239a78.png" alt="image-20260109204244573" loading="lazy"></p>
<br>
<p>ä¸»æµä¼ä¸ä½¿ç¨ AI è¾å©ç¼ç¨æåçæçã</p>
<p>è¦æ¯é¢å¯¼è§å¾ä½ ä¸ä¸ªæåçä»£ç ä¸å¦ AI ä¸å¤©åçï¼é£å°±å°´å°¬äºãä½ä¸ºææ¯äººåï¼å¿é¡»åçè¯ä¼°ä½¿ç¨ AI ç¼ç¨åï¼æ´ä¸ªå¢éå°åºæåäºå¤å°æçï¼ç¼ç éåº¦æé«äºå¤å°ã</p>
<p>æ¯å¦ï¼æ ¹æ®è¿ç¯ç ç©¶æ¥åï¼å®æä»»å¡çç¼ç éåº¦å¤§æ¦æåäº <code>21%</code>ï¼æ¥åå°å <a href="https://metr.org/blog/2025-07-10-early-2025-ai-experienced-os-dev-study/" target="_blank" rel="noopener nofollow">https://metr.org/blog/2025-07-10-early-2025-ai-experienced-os-dev-study/</a></p>
<p>èæ ¹æ®è±åèç½æç´¢æ»ç»çåå®¹æ¥çï¼æåçå¼åéåº¦å¹¶æ²¡æé£ä¹å¤¸å¼ ã</p>
<p><img src="https://www.whuanle.cn/wp-content/uploads/2026/01/post-22312-69639ce35ec28.png" alt="image-20260109205849267" loading="lazy"></p>
<br>
<p>æ»èè¨ä¹ï¼æé  AI è¾å©ç¼ç¨å¢éï¼è¦æ±å¢éäººåå¯¹ AI æè¶³å¤çè®¤è¯ï¼äºè§£åºç¡ç¥è¯ï¼å¹¶ä¸äºåå¨ AI ç¼ç¨ä¸çè®¤ç¥ä¸è´ï¼å¦åå¯è½ä¼é¹åºåç§ç¬è¯ï¼è¢«äººå¼ä¸ºç¬è°ã<strong>ç¥è¯åè®¤ç¥é½å¾éè¦</strong>ï¼å¦åå¢éååéæ£æ¶ã</p>
<h3 id="é¡¹ç®æ¨¡æ¿">é¡¹ç®æ¨¡æ¿</h3>
<p>ä¸ºä»ä¹è¦ä½¿ç¨å¼åæ¡æ¶ï¼è¿ä¸ªäºæä¸ç¨å¤è¯´ï¼C# å¼ååºè¯¥ç¥é ABP æ¡æ¶ï¼Go å¼ååºè¯¥ç¥é ginãbeegoï¼ä½¿ç¨æ¡æ¶åå¤§å¤§ç®åäºå¼åè´æãå¨ä½¿ç¨å¼åæ¡æ¶çæåµä¸ï¼å¶å®å¢éè¿éè¦å®å¶é¡¹ç®æ¨¡æ¿ï¼ä»¥ä¾¿ééå¬å¸ææ¯æ ï¼ä»¥åçº¦æå¬å¸åçä¸äºææ¯è¦æ±ï¼ä¾å¦å®¡è®¡å±æ§ãå¾®æå¡éè®¯æ¹å¼åé´æç­ï¼å¥½çé¡¹ç®æ¨¡æ¿å¯ä»¥ç»ä¸å¼åæ¨¡å¼åä¹ æ¯ã</p>
<br>
<p>ç¬èå¨åä¸ªäººå¼æºé¡¹ç®è¿ç¨ä¸­ï¼ç»å DDD ãæ¸æ´æ¶æãCQRS çä¸äºæ¦å¿µï¼è¾ä»¥ AI ç¼ç¨ï¼å½¢æäºä¸ªäººå¼åä¹ æ¯ï¼æä»¥ä¸ºäºåè¿ç¯æç« æ´çäºä¸ä¸ªæ¨¡æ¿é¡¹ç®ï¼</p>
<p><a href="https://github.com/whuanle/aispec" target="_blank" rel="noopener nofollow">https://github.com/whuanle/aispec</a></p>
<br>
<p>å¦æä»¥æçå¼åä¹ æ¯æ¥å®ï¼æä¼ä½¿ç¨æ¨¡åå + CQRSï¼æ¯ä¸ªä¸å¡é¢åéµå¾ªä¸å±æ¨¡ååæ¶æï¼æ è®ºå¼åè¿æ¯åååæµè¯ï¼é½æ¯è¾ç®åã</p>
<pre><code>src/{domain}/
âââ MoAI.{Domain}.Shared/     # å±äº«å± - DTOãCommandãQuery å®ä¹
âââ MoAI.{Domain}.Core/       # æ ¸å¿å± - Handler å®ç°ãä¸å¡é»è¾
âââ MoAI.{Domain}.Api/        # API å± - Controller/Endpoint æ´é²
</code></pre>
<p>ä¾èµå³ç³»ï¼<code>Api â Core â Shared</code>ï¼å·ä½åèï¼</p>
<p>ä»£ç ç¼åçº¦æåèï¼<a href="https://github.com/whuanle/aispec/blob/master/.kiro/steering/cqrs-conventions.md" target="_blank" rel="noopener nofollow">https://github.com/whuanle/aispec/blob/master/.kiro/steering/cqrs-conventions.md</a></p>
<p><img src="https://www.whuanle.cn/wp-content/uploads/2026/01/post-22312-69639ce3883d6.png" alt="image-20260109211559319" loading="lazy"></p>
<p><img src="https://www.whuanle.cn/wp-content/uploads/2026/01/post-22312-69639ce3ac8c4.png" alt="image-20260109211703315" loading="lazy"></p>
<br>
<p>å·ä½è®¾è®¡æè·¯ååç±»ç»èå°±ä¸è®²è§£ï¼æ¬èå¶å®ç®çæ¯è¯´ï¼æ è®ºä½ ä½¿ç¨ä½ç§å¼åæ¡æ¶ï¼æ¯å¦ä½¿ç¨ DDDï¼è¿æ¯ä¼ ç»ä¸å±ç»æï¼å¢éåºè¯¥è¦æä¸ä¸ªç»ä¸çé¡¹ç®æ¨¡æ¿ä»¥åå¼åä¹ æ¯çº¦æï¼AI ä¼åèé¡¹ç®å·²æä»£ç åçº¦ææä»¶ï¼ç¼åç¬¦åè¦æ±çä»£ç ï¼é¿åä»£ç å¤©é©¬è¡ç©ºã</p>
<p>å³äºæ¨¡æ¿é¡¹ç®å°±ä¸å±å¼è¯´äºï¼è¯»èå¯ä»¥å¨è¿éæ¾å°è¿ä¸ªæ¬èº«ç¨äºå®ææ¼ç¤ºçæ¨¡æ¿é¡¹ç®ï¼<a href="https://github.com/whuanle/aispec" target="_blank" rel="noopener nofollow">https://github.com/whuanle/aispec</a></p>
<h3 id="åå¤å®å¶å¢éè§åä¸é¡¹ç®ç´¢å¼">åå¤å®å¶å¢éè§åä¸é¡¹ç®ç´¢å¼</h3>
<p>å¨ä½¿ç¨ AI ç¼ç¨æ¶ï¼ä¼æä¸äºå¸¸è§é®é¢ï¼</p>
<p>1ï¼å¼åè· AI å®¹æé·å¥ç²ç®å¯¹è¯ï¼AI å§ç»æ²¡æç»åºæ³è¦çä»£ç ï¼å¯¼è´ä»£ç å¯ç¨çåç¡®å®æ§ä½ä¸ã</p>
<p>2ï¼å¼åé¾ä»¥æ¸æ°åç¡®å AI IDEè¡¨è¾¾ç®æ æ¹æ¡åä»£ç </p>
<p>3ï¼åç½®éè¦å¤§éç²¾åå¯¹é¡¹ç®ç RulesãDocs è¿è¡ç¼ååç§¯ç´¯</p>
<p>4ï¼å¥é½è®© AI åï¼ä½æ¯ AI ååºæ¥çæ¹æ¡æ»æ¯ä¸æ»¡æ</p>
<br>
<p>è§£å³è¿äºé®é¢æ¬èº«ä¸é¾ï¼ä½æ¯è¦è½å°å¢éåä½ä¸­ï¼ä½ä¸ºæ¶æå¸å°±è¦æèæ´å¤äºï¼éè¦ä¿è¯ä»£ç è´¨éåå¼åæçï¼é¿ååå¤å¤çè¿äºé®é¢ã</p>
<br>
<h4 id="ä»ä¹æ¯-steering">ä»ä¹æ¯ Steering</h4>
<p>è¿éç steering å¶å®æ¯ Kiro éé¢çæ¦å¿µï¼ç®çæ¯è®© AI ç¼ç¨è¿ç¨ä¸­ï¼å§ç»éµå¾ªå¢éå·²å»ºç«ç patternsãlibrariesãstandardsã</p>
<blockquote>
<p><a href="https://kiro.dev/docs/steering/" target="_blank" rel="noopener nofollow">https://kiro.dev/docs/steering/</a></p>
</blockquote>
<br>
<p>ä¹å°±æ¯è¯´ï¼åºäºå¢éçé¡¹ç®æ¨¡æ¿ï¼æä»¬è¦æå®ä¸äºè·ä¸å¡æ å³çææ¯çº¦æï¼ä¾å¦å®¡è®¡å±æ§æä¹å®ï¼è¿ä¸ªå¼åæ¡æ¶/é¡¹ç®æ¨¡æ¿æä¹ä½¿ç¨ï¼ä¸ååè½çä»£ç æä»¶æä¹å½åç­ï¼é½å¯ä»¥åå° Kiro steering éé¢ãAI å¨åä»£ç æ¶ï¼ä¼ä¸ç´å´ç»è¿äº steering å»åï¼å¦æååºçä»£ç ä¸ç¬¦å steering è¦æ±ï¼å AI ä¼éæ­¥ä¿®æ­£ä»£ç ã</p>
<br>
<p>é£ä¹ï¼å¢éè¦è½å°ä»£ç è§èï¼æ¯ä¸æ¯åç®åäºï¼åé¢æå°ç AI ç¼ç¨çé®é¢åæ ¸å¿è¯æ±ï¼æ¯ä¸æ¯å¯ä»¥è§£å³äºï¼</p>
<p>æ¯çï¼æä»¥ï¼è¦éè§é¡¹ç®æ¨¡æ¿å steeringï¼å¨å¢éå¼åå®ç°éæ±ä¹åï¼å°±åºè¯¥å®å¶å¢éä¹è³å¬å¸ç åé¨é¨ç steeringã</p>
<h4 id="å¸¸è§-steering-æä»¶ç­ç¥">å¸¸è§ Steering æä»¶ç­ç¥</h4>
<p>åé¢ä¼æå° Kiro é»è®¤ä¼æç steering è§åæ¨¡æ¿ï¼ä½æ¯ä»å¢éçè§åº¦èèï¼å¯è½è¿éè¦è¿äº steering ï¼</p>
<p><strong>API æ å</strong> (<code>api-standards.md</code>) - å®ä¹ REST çº¦å®ãéè¯¯ååºæ ¼å¼ãè®¤è¯æµç¨åçæ¬ç­ç¥ãåæ¬ç«¯ç¹å½åæ¨¡å¼ãHTTP ç¶æç ä½¿ç¨åè¯·æ±/ååºç¤ºä¾ã</p>
<p><strong>æµè¯æ¹æ³</strong> (<code>testing-standards.md</code>) - å»ºç«ååæµè¯æ¨¡å¼ãéææµè¯ç­ç¥ãæ¨¡ææ¹æ³åè¦ççææãè®°å½é¦éæµè¯åºãæ­è¨æ ·å¼åæµè¯æä»¶ç»ç»ã</p>
<p><strong>ä»£ç é£æ ¼</strong> (<code>code-conventions.md</code>) - æå®å½åæ¨¡å¼ãæä»¶ç»ç»ãå¯¼å¥æåºåæ¶æå³ç­ãåæ¬é¦éä»£ç ç»æãç»ä»¶æ¨¡å¼åè¦é¿åçåæ¨¡å¼ç¤ºä¾ã</p>
<p><strong>å®å¨æå</strong> (<code>security-policies.md</code>) - è®°å½è®¤è¯è¦æ±ãæ°æ®éªè¯è§åãè¾å¥æ¸çæ ååæ¼æ´é¢é²æªæ½ãåæ¬ç¹å®äºæ¨åºç¨ç¨åºçå®å¨ç¼ç å®è·µã</p>
<p><strong>é¨ç½²æµç¨</strong> (<code>deployment-workflow.md</code>) - æ¦è¿°æå»ºç¨åºãç¯å¢éç½®ãé¨ç½²æ­¥éª¤ååæ»ç­ç¥ãåæ¬ CI/CD ç®¡éè¯¦ç»ä¿¡æ¯åç¯å¢ç¹å®è¦æ±ã</p>
<br>
<p>å½ç¶ï¼è¿äº steering ä¸éè¦é½é¦éï¼å¯ä»¥ååä¸ä¸ªé¡¹ç®æ¨¡æ¿ï¼ç¶åè®© Kiro éè¯»ä»£ç å¹¶çæå³å¯ã</p>
<p>ä¸åå¬å¸å¢éå¯è½æä¸åè¦æ±ï¼åªè¦ççåå°±è¡ï¼å¯ä»¥å¨æ¸ç´¢çè¿ç¨ä¸­ï¼éæ¸ç§¯ç´¯å¢éç»éªï¼éæ¸å®å steeringã</p>
<h3 id="æ ¸å¿æ§è¡ai-é©±å¨çåä½æµç¨è®¾è®¡">æ ¸å¿æ§è¡ï¼AI é©±å¨çåä½æµç¨è®¾è®¡</h3>
<p>å¢éåä½ AI ç¼ç¨ï¼æè¦åçåè½ä¸¢å¨å¯¹è¯æ¡ï¼è®© AI åä»£ç å°±è¡ï¼</p>
<p>Noï¼å¤§éç¹éï¼</p>
<br>
<p>è®©æä»¬åå° Kiro çä»ç»ï¼<code>Agentic AI development from prototype to production</code>ï¼ç¿»è¯è¿æ¥æ¯ä»ååå°äº§åç Agentic AI å¼åã</p>
<p>æ³¨æï¼è¦ç© AI ç¼ç¨ï¼æä»¬æ¯è¦åä»ååå°äº§åæ´ä¸ªå¨æçä¸è¥¿ï¼èä¸ååæ¯ç¨ AI åå®ä»£ç æ©ç¹ä¸ç­ã</p>
<p>æä»¥è¦èèï¼å¢éçè§è²æåªäºï¼å¤§å®¶åºè¯¥æä¹åä¸åä½ï¼<strong>æ´éè¦çæ¯æä¹è®¾è®¡æ°çå¢éç åæµç¨</strong>ã</p>
<br>
<p>ä¸åå¬å¸çå¢éç»æä¸ä¸æ ·ï¼æä»¥ç¬èæç§å¸¸è§å¢éï¼äº§åãUIè®¾è®¡å¸ãååç«¯å¼åãæµè¯ï¼ç»ææ¥è®²è§£åé¢çåå®¹ã</p>
<blockquote>
<p>æè°¢è¿ä½ä½èçæç« ï¼ç»äºæå¾å¤æ³æ³ï¼<a href="https://aicodingtools.blog/zh/kiro/kiro-spec-guide" target="_blank" rel="noopener nofollow">https://aicodingtools.blog/zh/kiro/kiro-spec-guide</a></p>
</blockquote>
<br>
<p>ä½¿ç¨ AI ç¼ç¨åï¼å¢éä¸­åä¸ªè§è²è¦è´è´£çåå®¹ä¼åçååï¼è¦æ±å·¥ä½è¾åºçåå®¹è½å¤è¢« AI è¯å«å¹¶å¼ç¨ï¼å¹¶ä¸å¨å¢éåæµéã</p>
<blockquote>
<p>å¦æäº§åè¾åºçéæ±ææ¡£ï¼AI é½ä¸ä¼åææ»ç»ï¼ä½ ç»å¼åçï¼é»è¾çå±ä¸éï¼AI æä¹åä»£ç ï¼</p>
<p>äº§åçéæ±ææ¡£ï¼å¯ä»¥ç»è¿å¼åæ´çåï¼ä½ä¸ºè®© AI ç¼åä»£ç çæç¤ºè¯åéæ±çº¦æï¼å¤§å¤§åè½»å¼åçè´æã</p>
</blockquote>
<br>
<p>å¼ååæµè¯å°ä¼å¤§å¤§ä¾èµéæ±ææ¡£ï¼æå¶å®å½¢å¼çææ¡£ï¼ï¼å ä¸ºéæ±ææ¡£ä¼ä½ä¸ºå¼åãæµè¯åéªæ¶ä¾æ®ï¼å¨ AI ç¼ç¨é¶æ®µå°±è¦è®© AI ç¥éåä»£ç è¿è¦èèæä¹æµè¯åéªæ¶ï¼ä¸è½ç­è®© AI åå®ä»£ç ï¼åå« AI åååæµè¯ãæ£æ¥éªæ¶è½ä¸è½è¿ã</p>
<p><br>å¦å¤ï¼åæåå¤é¶æ®µï¼ä¹ä¾èµæ¶æå¸æ leader çæ¶æè®¾è®¡ååè½å®ç°è®¾è®¡ï¼èä¸æ¯è¯´ âå®ç°ä¸ä¸ªç­é¾æ¥æå¡ï¼å°é¿é¾æ¥ç¼©ç­ä¸ºç­é¾æ¥âï¼ææ¯è´è´£äººéè¦æèåè®¾è®¡ï¼ä½¿ç¨ä½ç§ç®æ³ç¼©ç­å°åãè¿åå°åï¼æä¹å­å¨å°æ°æ®åºï¼é«å¹¶åç¯å¢ä¸æä¹æé«å¹¶åéååå°å¯¹æ°æ®åºçååã</p>
<br>
<p>æä»¥ï¼è¦æèï¼ä½¿ç¨ AI ç¼ç¨è½å°åï¼</p>
<ul>
<li>
<p>å¢ééè¦åªäºè§è²ï¼</p>
</li>
<li>
<p>æ¯ä¸ªè§è²è¦è´è´£åªäºåå®¹ï¼</p>
</li>
<li>
<p>æ´ä¸ªç åæµç¨åºè¯¥ååªäºé¶æ®µï¼</p>
</li>
</ul>
<br>
<p>æ¯ä¸ªå¬å¸æåµé½æ¯ä¸ä¸æ ·çï¼æä»¥éå¯¹è¿äºé®é¢ï¼ç¬èæ²¡æä»ä¹è¯´æ³åè§ç¹ï¼ä¸è¿åé¢å®æé¨åä¼æå° Kiro Specs æ¯æä¹ååç åæµç¨é¶æ®µã</p>
<br>
<p>ç¬èè®¾æ³ï¼æªæ¥å´ç» AI è¾å©ç¼ç¨å¼åï¼å¢éçè§è²ååä¸åå®¹å¯è½åçéå¤§æ¹åã</p>
<p>ä¸æ¯å¢éå¼åæµç¨åçæ¹åï¼ä¸ååä»¥å¾ä»äº§åååè®¾è®¡ãéæ±ä¼ãå¼åãææµçæ¨¡å¼ï¼èæ¯å´ç» AI ç¼ç¨æ´å é ææ·å¼åæ¨¡å¼æ¥è¿ã</p>
<p>äºæ¯å¢éè§è²è´è´£çåå®¹åçæ¹åï¼æ´å¤å´ç»äº§ççèµæè½å¤è¢« AI å¸æ¶ï¼ç¥è¯å¯ä»¥æ²æ·ï¼åå°ä¿¡æ¯æµéçé¾åº¦ï¼ä»¥åéä½äº§åãè®¾è®¡å¸ãå¼åãæµè¯ä¹é´çç¥è¯åèè´£è¾¹çã</p>
<p>ä¸æ¯å¯è½ä¼åºç°ä»¥ AI ç¼ç¨ä¸ºä¸­å¿çäº§åç åä¸ä½åå¹³å°ï¼æ è®ºæ¯äº§åãè®¾è®¡å¸ãå¼åãæµè¯ï¼é½å¯ä»¥å´ç»è¿ä¸ªå¹³å°è¿è¡ç¬¦åèªå·±è§è²çåä¸ï¼ä¾å¦äº§åç¼åéæ±ææ¡£åéªæ¶ææ¡£æ¶ï¼å¯ä»¥åå© AI å¹³å°æ£æµéæ±æ¯å¦åçãè°æ´è®¾è®¡ãç»åéæ±ï¼è½¬åä¸ºå¼åäººåä¾¿äºéè¯»çææ¡£ãäº§åãè®¾è®¡å¸éè¿éæ±ææ¡£åå© AI å¹³å°å¿«éå®ç°äº§åååè®¾è®¡ãå¼åäººååå¯ä»¥å°éæ±å¯¼å¥ AIï¼åå»ºå¼åä»»å¡ï¼éæ­¥ä¸ AI åä½ç¼åä»£ç ï¼è¿å¯ä»¥åå© AI å¿«éçæååæµè¯ãéææµè¯ç­ï¼æåæ ¹æ®éªæ¶ææ¡£éªè¯æ£æµæç»è¾åºã</p>
<br>
<p>èå³äºå¢éçç åæµç¨ï¼åä¼å¨ <a href="#%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B" rel="noopener nofollow">å·¥ä½æµç¨</a> ä¸èè¯¦ç»è®²è§£ã</p>
<h3 id="æ»ç»">æ»ç»</h3>
<p>ä½ä¸ºæç« çç¬¬äºé¨åï¼ä¸»è¦æ¯æèæä¹å»ºè®¾ä½¿ç¨ AI è¾å©ç¼ç¨çå¢éï¼ä»¥åè¿è¡å¢éåä½ã</p>
<p>ç¬¬ä¸é¨åå°ä¼è®²è§£å®æï¼ä»ååå°äº§åçæ´ä¸ªç¯èï¼æ¯ä¸ªæ­¥éª¤åºè¯¥åä»ä¹ã</p>
<h2 id="å®æ">å®æ</h2>
<p>ä½ä¸ºæç« çç¬¬ä¸é¨ååå®¹ï¼å°ä¼ä»¥ç­é¾æ¥æå¡ä¸ºæ¡ä¾ï¼å»è®²è§£å¦ä½è½å°å®æå¢éåä½å AI ç¼ç¨ï¼å»è®¾è®¡ä¸ä¸ªä»¥ AI è¾å©å¼åä¸ºæ ¸å¿çé¡¹ç®ç åæµç¨ã</p>
<h3 id="æèæ´ä½æ¶æ">æèæ´ä½æ¶æ</h3>
<p>AI æ¶ä»£ï¼è¿éè¦æå»è®¾è®¡é¡¹ç®ï¼</p>
<p>æ¯çï¼å¼åäººåè¦èªè¡å¯¹ææ¯æ¹æ¡è¿è¡è°ç ãä¸æå°è¯ï¼ç¶åè®© AI æ ¹æ®ä½ çæ¹æ¡åè®¾è®¡ååºæ¥ï¼ä¸è¦é½è®© AI å¸®ä½ åè§£å³æ¹æ¡ã</p>
<br>
<p>åªéè¦ä¸ä¸ª ideaï¼AI å°±å¯ä»¥åä»£ç ï¼å¯æ¯ AI ååºæ¥çä¸è¥¿å¯è½è·ä¸ä¸äººåéè¦çä¸è¥¿ç¸å»çè¿ï¼å¹¶ä¸è¿æå¤§éç»èæ»¡è¶³ä¸äºéæ±ï¼å¼åäººåå¯è½ä¼é·å¥è· AI çå¯¹éªä¸­ï¼ä¸æ­è°æ´æç¤ºè¯ï¼ä¸æ­ç­å¾ AI çæï¼æç»çæäº 90% çåå®¹ï¼å©ä¸ç 10%ï¼å¼åäººååªè½å¯¹çé®çä¸ç¹ç¹æ²å®ã</p>
<p><br>è½ç¶æ¯ AI ç¼ç¨ï¼ä½æ¯ç¼ç¨çéç¹æ¯äººçæ³æ³åéæ±ï¼èä¸æ¯ AI çå¤©é©¬è¡ç©ºï¼è½ç¶ AI å®ç°çé¡¹ç®å¯è½æå¾å¤å¾å¥½çåæåæ³æ³ï¼è´¨éå¯è½å¾å¥½ï¼ä½æ¯å¯¹äºä¸ä¸é¢ååå¬å¸ä¸å¡é¡¹ç®æ¥è¯´ï¼éæ±çä¸­å¿æ¯å¬å¸å¯¹åºçä¸å¡ï¼èä¸æ¯ä¸ä¸ª ideaã</p>
<p>èä¸ AI æä¸ä¸æéå¶ï¼æå¹»è§ç­ï¼ä½ åªéè¦ä¸ä¸ªç®åçä¸ä¸ªç»å½åè½ï¼å¯è½ AI æåç¹ç»å½ãOAuth2 ç­ä¸å ä¸è¥¿ç»ä½ å ä¸å»äºï¼ç®æ åç§»ï¼ã</p>
<br>
<p>æä»¥å³ä½¿å¨ AI æ¶ä»£ï¼æä»¬ä¹è¦ææé¡¹ç®è®¾è®¡ååè½å®ç°çç®æ³åé»è¾ï¼è®© AI å¨è¿ä¸ªè¾¹çåå®ç°ä»£ç åæµè¯ã</p>
<blockquote>
<p>å½ç¶ï¼æä»¬å¯ä»¥å©ç¨ AI å»å¸®å©æä»¬éªè¯æ³æ³åææè®¾è®¡ï¼ç¶åå°è¿äºåå®¹çæä¸ºæ¶æè®¾è®¡åææ¯æ¹æ¡ã</p>
</blockquote>
<h4 id="ç­é¾æ¥æå¡çæ¶æ">ç­é¾æ¥æå¡çæ¶æ</h4>
<p>ç±äºæ¬æçéç¹ä¸æ¯æä¹å®ç°ä¸ä¸ªç­é¾æ¥æå¡ï¼æä»¥ç¬èè¿éåªç®åè®²è§£è¿ä¸ªæå¡çä¸äºç®æ³åå®ç°æè·¯ï¼ä»¥ä¾¿åç»­ä½¿ç¨ AI ååºç¬¦åéæ±çä»£ç ã</p>
<br>
<p>æ ¸å¿é®é¢1ï¼ç­é¾æ¥çæåè¿å</p>
<p>æ ¸å¿é®é¢2ï¼ç­é¾æ¥å­å¨åæ¥æ¾</p>
<br>
<p>ç¬èçè®¾è®¡æ¯ï¼ç­é¾æ¥è·é¿é¾æ¥æ ç´æ¥æ å°å³ç³»ï¼ä¹å°±æ¯ä¸è½éè¿ç®æ³è½¬æ¢ç´æ¥å°é¿é¾æ¥çæç­é¾æ¥ã</p>
<p>å¯¹äºæ¯ä¸ªé¿é¾æ¥ï¼åå»ºè®°å½å­å°æ°æ®åºæ¶ä¼ä½¿ç¨ int64 éªè±åä¸»é®ï¼å­å°æ°æ®åºã</p>
<p>ä¾å¦æ°å¢ä¸ä¸ªé¿é¾æ¥ <code>https://whuanle.cn</code>ï¼å½åéªè±id æ¯ 2009194627277520896ï¼ç»è¿æ£æ¥æ°æ®åºæ²¡æéå¤æ°æ®åå­å¨å°æ°æ®åºã</p>
<p>æ¥çï¼å°éªè± id ä½¿ç¨ base62 çæç­é¾æ¥ç¼ç ãä¹æä»¥ä½¿ç¨ base62 åç¼©ç­ç¼ç ï¼æ¯å ä¸º<code>[0-9]</code>ã<code>[a-z]</code>ã<code>[A-Z]</code> ååå¥½æ¯ 62 ä¸ªå­ç¬¦ï¼è½å¤å¨ä¸ä½¿ç¨ç¹æ®ç¬¦å·çæåµä¸ï¼ä½¿ç¨æ°å­åå¤§å°åå­æ¯è¡¨è¾¾å¼ï¼ä¹å°±æ¯ç¸å½äº 62 è¿å¶ãå° 2009194627277520896 ä½¿ç¨ base62 ç¼ç æ¯å¾åºå­ç¬¦ä¸²æ¯ <code>00E3uWKkzx</code>ï¼èå­æ°æ®åªéè¦ä¸ä¸ª int64 å°±è¡ã</p>
<p>æ»¡è¶³è½å¤å°é¿é¾æ¥çæç­é¾æ¥ï¼å­å¨ç©ºé´å°ï¼ä¸å®¹æè¢«äººç¢°æè§åçéæ±ã</p>
<p><img src="https://www.whuanle.cn/wp-content/uploads/2026/01/post-22312-69639ce3d2b7d.png" alt="image-20260108174726106" loading="lazy"></p>
<br>
<p>æäºç­é¾æ¥çæåè¿åç®æ³åï¼æä»¬ç»§ç»­èä¸ä¸æ°æ®æ¥æ¾ã</p>
<p>ç¨æ·è®¿é® <code>/00E3uWKkzx</code> æ¶ï¼è¿åå¾å° 2009194627277520896ï¼ç¶åéè¿è¿ä¸ª id ä»æ°æ®åºæ¥æ¾æ°æ®å¾å°  <code>https://whuanle.cn</code>ï¼ç¶åè®©ç¨æ·è·³è½¬å°è¿ä¸ªå°åå³å¯ã</p>
<p>æ¯æ¬¡é½è¦æ¥æ°æ®åºï¼æ°æ®åºååå¤§ï¼èä¸ä¸ä¸è¢«äººæ»å»ï¼æºå¨äººéæºæ¼æ¥çå­ç¬¦ä¸²ï¼ä¹è¦å°æ°æ®åºæ£æ¥æ°æ®å¨ä¸å¨ï¼æ°æ®åºè¿æ©è¢«æå´©ã</p>
<br>
<p>æä»¥ç¬¬ä¸å±æ¯ä½¿ç¨ redis çå¸éè¿æ»¤å¨ï¼åå¤æ­æ°æ®æ¯å¦å­å¨ã</p>
<p><img src="https://www.whuanle.cn/wp-content/uploads/2026/01/post-22312-69639ce4030ea.png" alt="image-20260108180240039" loading="lazy"></p>
<br>
<p>ç¬¬äºå±ï¼æ°æ®åçï¼å°æ°æ®å­å¨å° redisï¼é¿åé¢ç¹ä»æ°æ®åºæ¥æ¾ãè¿å¯ä»¥åæ¬å°ç¦»çº¿ç¼å­ï¼é¿åé«é¢åº¦ä» redis æ¥æ¾æ°æ®ã</p>
<p>ä¹å°±æ¯æç»æ¯ä¸å±ç¼å­ã</p>
<br>
<p>å¶å®å°±ä¸å¤è¯´äºï¼åé¢æå°çç®æ³å¤çé»è¾ï¼å°ä¼ä½ä¸ºåç»­ AI ç¼ååè½çä¾æ®ã</p>
<h3 id="æ¨¡æ¿é¡¹ç®">æ¨¡æ¿é¡¹ç®</h3>
<p>é¦éæ¯å®è£ç¬èæä¾çé¡¹ç®æ¨¡æ¿ã</p>
<pre><code class="language-bash">dotnet new install Maomi.AiSpec.Templates
</code></pre>
<p><img src="https://www.whuanle.cn/wp-content/uploads/2026/01/post-22312-69639ce430090.png" alt="image-20260109092342372" loading="lazy"></p>
<br>
<p>æ§è¡å½ä»¤ä»æ¨¡æ¿åå»ºæ°çé¡¹ç®ï¼å° <code>MyShortUri</code> æ¿æ¢ä¸ºä½ éè¦çé¡¹ç®åç§°å³å¯ã</p>
<pre><code class="language-bash">dotnet new aispec -n MyShortUri
</code></pre>
<p><img src="https://www.whuanle.cn/wp-content/uploads/2026/01/post-22312-69639ce458366.png" alt="image-20260109092658516" loading="lazy"></p>
<h3 id="åç«¯å¼ååååè§è">åç«¯å¼ååååè§è</h3>
<p>ä½¿ç¨ Kiro æå¼ <code>MyShortUri</code> é¡¹ç®ï¼ å¨ AGENT STEERING èåå¯ä»¥çå°å·²ç»æ¨¡æ¿èªå¸¦åä¸ª steering æä»¶ã</p>
<p><img src="https://www.whuanle.cn/wp-content/uploads/2026/01/post-22312-69639ce47b764.png" alt="image-20260109224727421" loading="lazy"></p>
<br>
<p>Kiro éè¿ <code>.kiro/steering/</code> ç®å½ä¸­ç markdown æä»¶è®¾ç½®é¡¹ç®çº¦æè§å®ï¼Kiro åªè§å®äº product.mdãtech.mdãstructure.md ä¸ä¸ªæä»¶ï¼è¿äºåºç¡æä»¶é»è®¤åå«å¨æ¯æ¬¡äº¤äºä¸­ï¼å½¢æ Kiro é¡¹ç®çè§£çåºçº¿ã</p>
<p>cqrs-conventions.md åæ¯ç¬èçæ¨¡æ¿é¡¹ç®çå¼åè§åï¼çº¦å® AI çæçä»£ç æä»¶å¦ä½å­æ¾ä»¥åä»£ç æ ¼å¼çº¦æï¼AI ä¼çæç¬¦åé¡¹ç®è¦æ±çä»£ç ã</p>
<p>è¯»èä¹å¯ä»¥åå»ºä¸äºå¶å®æä»¶ï¼ä¾å¦ <code>rest-api.md</code> è¦æ±çæç api æ¥å£éè¦ç¬¦å restapi æ ¼å¼ï¼å°å¬å¸ç åè§èç­åå¥å°  <code>.kiro/steering/</code> ç®å½ã</p>
<h4 id="åç«¯ä»£ç è§èçº¦æ">åç«¯ä»£ç è§èçº¦æ</h4>
<p><code>cqrs-conventions.md</code> æ¯ç¬èèªå®ä¹ç steering æä»¶ï¼ç¨æ¥çº¦æ AI çæçä»£ç å¿é¡»åä¸º <code>Command/Query</code>ã<code>Api</code>ã<code>Handler</code> ä¸å±ç CQRS ç»æã</p>
<p>å®ä¹äºå¾å¤çº¦æè§èï¼è¿éå°±ä¸è®²è§£äºï¼èªå·±ç ç©¶ä¸ä¸ã</p>
<p><img src="https://www.whuanle.cn/wp-content/uploads/2026/01/post-22312-69639ce4a8557.png" alt="image-20260109094451145" loading="lazy"></p>
<h4 id="æè¦åä»ä¹æ ·çäº§å">æè¦åä»ä¹æ ·çäº§å</h4>
<p>æåé¡¹ç®æ¨¡æ¿åï¼ç¬¬ä¸æ­¥æ¯ä¿®æ¹ <code>product.md</code>ï¼åè¯ AI è¿æ¯ä¸ä¸ªç­é¾æ¥é¡¹ç®ã</p>
<blockquote>
<p><strong>äº§åæ¦è¿°</strong> (<code>product.md</code>) - å®ä¹äº§åçç®çãç®æ ç¨æ·ãå³é®åè½åä¸å¡ç®æ ã</p>
</blockquote>
<br>
<p>ä¸è¬æ¥è¯´ï¼<strong>äº§åæ¦è¿°</strong> (<code>product.md</code>)  æ¯äº§åç»ççå·¥ä½ä»»å¡ï¼å¼ååªéè¦å°äº§åç»çåçææ¡£æ·è´å°ä»£ç é¡¹ç®å³å¯ï¼ä¸è¿æ¢ç¶ç°å¨æ²¡æäº§åç»çï¼æä»¬å¯ä»¥ä¸å¥è¯æè¿°æ ¸å¿éæ±ï¼è®© Kiro å¸®å©æä»¬çæå·ä½çäº§åè¯´æï¼ç­ AI çæåï¼æ ¹æ®å®éæåµï¼è°æ´å¥½ <code>product.md</code> æä»¶ã</p>
<p><img src="https://www.whuanle.cn/wp-content/uploads/2026/01/post-22312-69639ce63e3a9.png" alt="image-20260109094959587" loading="lazy"></p>
<br>
<p>çæææï¼</p>
<p><img src="https://www.whuanle.cn/wp-content/uploads/2026/01/post-22312-69639ce66b451.png" alt="image-20260109094351449" loading="lazy"></p>
<h4 id="é¡¹ç®ç»æ">é¡¹ç®ç»æ</h4>
<p><strong>é¡¹ç®ç»æ</strong> (<code>structure.md</code>) - æ¦è¿°æä»¶ç»ç»ãå½åçº¦å®ãå¯¼å¥æ¨¡å¼åæ¶æå³ç­ï¼è¿ç¡®ä¿çæçä»£ç æ ç¼èå¥ç°æçä»£ç ç»æéé¢ï¼è¿æ · AI ä¸ä¼ä¹±åå»ºæä»¶ä»¥åéä¾¿æ¾ä¸ªå°æ¹å¡ä»£ç ã</p>
<p><code>structure.md</code> è¦å¸¸å¸¸éçé¡¹ç®çè¿å±èæ´æ°ï¼ä¸è¦ä¸ç´ä¸åï¼æ¯æ¬¡æ°å¢æ¨¡ååï¼é½è¦éæ°çæ <code>structure.md</code> ã</p>
<p>ç°å¨æä»¬ç¹å» Kiro ç <code>Refine</code> ï¼éæ°çæ <code>structure.md</code> ã</p>
<p><img src="https://www.whuanle.cn/wp-content/uploads/2026/01/post-22312-69639ce6eb390.png" alt="image-20260109095652954" loading="lazy"></p>
<h4 id="ææ¯çº¦å®">ææ¯çº¦å®</h4>
<p><strong>ææ¯æ </strong> (<code>tech.md</code>) - è®°å½è¿ä¸ªé¡¹ç®éæ©çæ¡æ¶ãåºãå¼åå·¥å·åææ¯çº¦æï¼å½ Kiro å»ºè®®å®ç°æ¹æ¡æ¶ï¼å®ä¼ä¼åéæ©å·²å»ºç«çææ¯æ èéæ¿ä»£æ¹æ¡ã</p>
<p>çªç¶æ³èµ·æ¥ä¸ä¸ªäºæï¼æåäºå Go è¯­è¨ç¨åºéè¦è§£å³ä¸ä¸ªæå°åè½ï¼ç»æç¨ AI åçä»£ç å¼å¥äº pythonï¼åé¢è¢«æåç°äºï¼æè¦æ±ç¨ Go éåï¼ç¶åæåäºåç¨ AI åéåªå¦åäºä¸å¤©ï¼æ»ç®ç¨ Go ååºæ¥äºã</p>
<p>æä»¥ <code>tech.md</code> å¯ä»¥é¿åè¿ç§æåµï¼ä¸ç¶ AI ä¸ºäºå®ç°ä¸ä¸ªåè½ï¼å°å¤æ¥èµæï¼ç¶åå¼å¥ä¸å ä¾èµï¼ç¨ä¸ç§ææ³ä¸å°çæ¹å¼å»å®ç°åè½ã</p>
<br>
<p>ç°å¨æä»¬ç¹å» Kiro ç <code>Refine</code> ï¼éæ°çæ <code>tech.md</code> ï¼ä¾å¦è¿ä¸ªé¡¹ç®ä½¿ç¨çææ¯æ å¦ä¸ï¼</p>
<pre><code>| Category | Technology |
|----------|------------|
| Framework | ASP.NET Core 9 |
| Language | C# 12 (nullable reference types enabled) |
| ORM | Entity Framework Core 9 (MySQL) |
| CQRS | MediatR |
| Validation | FluentValidation |
| Authentication | JWT Bearer tokens |
| Logging | Serilog |
| API Docs | OpenAPI/Swagger with Scalar UI |
| Caching | Redis (StackExchange.Redis) |
| Module System | Maomi.Core |
| Code Analysis | StyleCop.Analyzers |
</code></pre>
<br>
<p>ä½èè¿å¯ä»¥å ä¸æ¥å£è®¾è®¡çº¦å®ç­æä»¶ï¼è¿éä¸åèµè¿°ã</p>
<h3 id="æ°æ®åºè®¾è®¡">æ°æ®åºè®¾è®¡</h3>
<p>ç°å¨åºç°äºä¸ä¸ªä½¿ç¨ AI åæ°æ®åºè®¾è®¡æ¹æ¡çæ¹åï¼Text2SQLã</p>
<p>Text2SQL æå°èªç¶è¯­è¨è½¬æ¢ä¸º SQL çææ¯ï¼å½ä¸ä¸ªé¡¹ç®ä»é¶å¼å§æ¶ï¼æä»¬å¯ä»¥åå© AI ææãè®¾è®¡é¡¹ç®æ¶æï¼æåæ»ç»è¾åº SQLï¼è¿ä¸æ­¥å¶å®æ¯è¾ç®åã</p>
<p>ä½æ¯åç»­é¡¹ç®è¿­ä»£åï¼éè¦ AI å»äºè§£æ´ä¸ªæ°æ®åºè¡¨ç»æï¼éè¦ AI æ ¹æ®ä¸å¡æåµè®¾è®¡æ°çç´¢å¼ãå­æ®µçº¦æç­ï¼è¿å°±è¦æ± AI éè¦æææ°æ®ä»·å¼ï¼åºå¯¹å¤æçåæä»»å¡ï¼æè½ç»åºåççæ°æ®åºåæ´å»ºè®®ã</p>
<p>å¯ä»¥åå©ä¸ä¸ç AI DB å®¢æ·ç«¯å»åï¼ä¾å¦ Chat2DBãä¹å¯ä»¥å¨ Kiro è£ä¸ MCP å·¥å·è¯»åæ°æ®åºï¼ç±äºä¸æ¯æ¬æéç¹ï¼è¿éåªè®²è§£æè·¯ï¼å°±ä¸åè¯¦ç»è®²è¿°ã</p>
<br>
<p>æ°æ®åºåå»ºè¡¨ï¼ä»¥ä¾¿åç»­å®æè®© AI åä»£ç ã</p>
<pre><code class="language-csharp">CREATE TABLE `short_url` (
  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT 'å¯ä¸IDï¼å¯¹åºç­é¾æ¥ç¼ç ï¼',
  `long_url` varchar(2048) NOT NULL COMMENT 'åå§é¿é¾æ¥',
  `hash` varbinary(32) NOT NULL COMMENT 'ç½ååå¸å¼ï¼æ¹ä¾¿å¯¹æ¯',
  `create_user_id` int(11) NOT NULL DEFAULT 0 COMMENT 'åå»ºäºº',
  `create_time` datetime NOT NULL DEFAULT current_timestamp() COMMENT 'åå»ºæ¶é´',
  `update_user_id` int(11) NOT NULL DEFAULT 0 COMMENT 'æ´æ°äºº',
  `update_time` datetime NOT NULL DEFAULT current_timestamp() ON UPDATE current_timestamp() COMMENT 'æ´æ°æ¶é´',
  `is_deleted` bigint(20) NOT NULL DEFAULT 0 COMMENT 'è½¯å é¤',
  PRIMARY KEY (`id`),
  KEY `short_url_hash_index` (`hash`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç­é¾æ¥'

CREATE TABLE `user` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT 'ç¨æ·ID',
  `user_name` varchar(50) NOT NULL COMMENT 'ç¨æ·å',
  `email` longtext NOT NULL COMMENT 'é®ç®±',
  `password` varchar(255) NOT NULL COMMENT 'å¯ç ',
  `nick_name` varchar(50) NOT NULL COMMENT 'æµç§°',
  `password_salt` varchar(255) NOT NULL COMMENT 'è®¡ç®å¯ç å¼çsalt',
  `is_deleted` bigint(20) NOT NULL COMMENT 'è½¯å é¤',
  `create_user_id` int(11) NOT NULL COMMENT 'åå»ºäºº',
  `create_time` datetime NOT NULL DEFAULT utc_timestamp() COMMENT 'åå»ºæ¶é´',
  `update_user_id` int(11) NOT NULL COMMENT 'æåä¿®æ¹äºº',
  `update_time` datetime NOT NULL DEFAULT utc_timestamp() COMMENT 'æåæ´æ°æ¶é´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `users_user_name_is_deleted_uindex` (`user_name`,`is_deleted`)
) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8mb4 COMMENT='ç¨æ·'

</code></pre>
<p><img src="https://www.whuanle.cn/wp-content/uploads/2026/01/post-22312-69639ce719e9b.png" alt="image-20260109110209561" loading="lazy"></p>
<br>
<p>ä¿®æ¹æ°æ®åºé¾æ¥ï¼å¯å¨ MysqlScaffold è¿åæ°æ®åºçæä»£ç ï¼å° <code>Database</code> ï¼ç®å½çæä»¶æ¾å°å¯¹åºä½ç½®æ¥å£ã</p>
<blockquote>
<p>æ¨çï¼æä¸ªé¡¹ç®æ¨¡æ¿å¤éè¦ï¼å¾å¤æ¶åçä¸å¤§éçæ¶é´ï¼ä¾å¦ç¬èè¿ä¸ªæ¨¡æ¿ï¼åè®¾è®¡æ°æ®åºï¼ç¶åå®å¶æ°æ®åºçæä»£ç çæ­¥éª¤ï¼ä½¿å¾çæçå®ä½ç»æå æ°æ®åºä¸ä¸æç±»è½å¤ç¬¦åä¸å¡éæ±ï¼å¤§å¤§æé«å¼åæçã</p>
</blockquote>
<p><img src="https://www.whuanle.cn/wp-content/uploads/2026/01/post-22312-69639ce862a66.png" alt="6f39e423-8590-4a90-bee3-cd0f34a55caa" loading="lazy"></p>
<h3 id="ui-ååè®¾è®¡">UI ååè®¾è®¡</h3>
<p>UI ååè®¾è®¡å°±æ¯ UI è®¾è®¡å¸æ ¹æ®äº§åååè®¾è®¡é¡µé¢çè¿ç¨ï¼éçä¸ä¸çååè®¾è®¡å·¥å·æ¯æ AI åï¼äº§åç»çè· UI è®¾è®¡å¸æ´å¥½å°åä½ï¼ææ¶åä¸å¥è¯å°±å¯ä»¥çæä¸ä¸ªä¸éççé¢ãäº§åç»çå¯ä»¥åå©è¿äº AI å·¥å·å¿«éå®ç°ååé¡µé¢ã</p>
<p><img src="https://www.whuanle.cn/wp-content/uploads/2026/01/post-22312-69639ce998d33.png" alt="image-20260109103159002" loading="lazy"></p>
<br>
<p>ç±äºå¢¨åç AI éè¦ä»è´¹ä½¿ç¨ï¼å¤ªè´µäºï¼æ¬æ¥æ³æ¼ç¤º AI æ ¹æ®è®¾è®¡ç¨¿çæé¡µé¢ä»£ç çï¼æåæ¾å¼äºï¼ç¨è¿é±ä¹°äºå çå¤çªã</p>
<p>æ¬èææè¯»èçè§£å°±è¡ï¼å°±æ¯è¯´ç®åå¸é¢ä¸æå¾å¤ AI çæè®¾è®¡ç¨¿çäº§åï¼äº§åå¯ä»¥ä¸ç¨åé£ä¹å¤æ¶é´ç»ååäºï¼å¯ä»¥ä¸å¿æèäº§åè®¾è®¡åæµç¨é»è¾ï¼æå¤§ç¨åº¦è¾åºææ¡£ï¼æç»ååè¿äºäºæçç» AIï¼ç¶åè¿å¯ä»¥è¿ä¸æ­¥è½¬æ¢ä¸º UIï¼è®¾è®¡å¸ä¹å¯ä»¥åå© AI å¿«éå®ç°åççé¢ã</p>
<h3 id="åç«¯å¼åå®æ">åç«¯å¼åå®æ</h3>
<p>åºäºé¡¹ç®æ¨¡æ¿å steeringï¼å¶å®ä¸å¥è¯éæ±ï¼å°±å¯ä»¥è®© Kiro ç»æä»¬ç¼åä¸ä¸ªæ¨¡åçåç«¯ä»£ç ã</p>
<p>ä½æ¯ Kiro æåºäº Specsï¼è®©å¢éåä½åå¼åäººåæ©ç¹ä¸ç­çç¥å¨ã</p>
<br>
<p>Specs å¼¥åäºæ¦å¿µäº§åéæ±åææ¯å®æ½ç»èä¹é´çå·®è·ï¼ç¡®ä¿äºä¸è´æ§å¹¶åå°äºå¼åè¿­ä»£ãSpecs æä¾äºä¸ç§ç³»ç»åçæ¹æ³ï¼å°éæ±åæ³æ³è½¬åä¸ºè¯¦ç»çå®æ½è®¡åï¼çæéªæ¶æ åãææ¯å®ç°åä»£ç çæåæµè¯éªæ¶è®¡åã</p>
<br>
<p>æ¥ä¸æ¥ï¼æä»¬å°ä¼ä½¿ç¨ Kiro Specs çææä¸ªåè½çå·¥ä½æµç¨ï¼æåæ ¹æ®æ¹æ¡çæä»£ç å¹¶éè¿æµè¯éªæ¶ä»£ç ã</p>
<h4 id="å®ç°åå»ºç­é¾æ¥çæ¥å£">å®ç°åå»ºç­é¾æ¥çæ¥å£</h4>
<p>è¦åç­é¾æ¥æå¡ï¼ç¬¬ä¸æ­¥æ¯å®ç°ä¸ä¸ªé¿é¾æ¥è½¬ç­é¾æ¥çåè½ï¼Kiro Specs è¦æ±ç¼ç ä¹åéè¦æç§ä¸é¶æ®µå·¥ä½æµç¨è¿è¡ï¼éæ± â è®¾è®¡ â å®æ½ã</p>
<p>å¨ Kiro é¢æ¿ä¸­ï¼ç¹å» <strong>Specs</strong> ä¸ç <code>+</code> æé®ï¼æèä»èå¤©é¢æ¿ä¸­éæ© <strong>Spec</strong>ï¼å¨å¯¹è¯æ¡åè¾å¥è¦åçåè½ã</p>
<pre><code>Create Spec: å®ç°åå»ºç­é¾æ¥çæ¥å£ï¼åå»ºçæ°æ®å­å¨å° ShortUrlEntityï¼ä½¿ç¨éªè±idèµå¼idï¼å°é¿å°åä½¿ç¨ SHA-256 çæ 32 å­èå­å¨å° hash å­æ®µãæå¥æ°æ®æ¶è¦å¤æ­æ°æ®åºæ¯å¦å­å¨å¯¹åºçæ°æ®ã
</code></pre>
<p><img src="https://www.whuanle.cn/wp-content/uploads/2026/01/post-22312-69639ceaa6b59.png" alt="a91e33a4-6ae2-48cc-af68-25cffb5a7898" loading="lazy"></p>
<p><img src="https://www.whuanle.cn/wp-content/uploads/2026/01/post-22312-69639cebdc604.png" alt="382cf906-3618-4d01-abc1-5b3f6bb39e51" loading="lazy"></p>
<br>
<p>æç§å¼å¯¼æä½åï¼æåä¸æ­¥ä¼æ¾ç¤º âä¿çå¯éä»»å¡ï¼æ´å¿«å®æ MVPï¼âãâå¨é¨è®¾ä¸ºå¿éï¼å®æ´æµè¯è¦çï¼âã</p>
<p>å¦æéæ©äº âå¨é¨è®¾ä¸ºå¿éï¼å®æ´æµè¯è¦çï¼âï¼AI å¨ä»»å¡åè¡¨å ä¸åºäºå±æ§çæµè¯è¦æ±åæ§è¡æ­¥éª¤ï¼Kiro ä»æåºçéæ±ä¸­æå <code>å±æ§</code> å¹¶çææµè¯ç¨ä¾ï¼ä»¥ä¾¿ç¡®ä¿ AI çæçä»£ç ç¬¦åå¼åèçæå¾ã</p>
<blockquote>
<p>Kiro ææ¡£éé¢è§£é <code>å±æ§</code>ï¼å¯¹äºä»»ä½ä¸ç»å·æç¹å®åææ¡ä»¶çè¾å¥ï¼æäºé¢æè¡ä¸ºæ¯æç«çãKiro ä»æ ¼å¼åçéæ±ä¸­æåå±æ§ (ä¾å¦ï¼âTHE System SHALL åè®¸ç»è¿è®¤è¯çç¨æ·æ¥çæ´»å¨è½¦è¾åè¡¨â)ï¼ç¡®å®åªäºå±æ§å¯ä»¥è¿è¡é»è¾æµè¯ï¼ç¶åå¨ä½ éæ©è¿è¡å®ä»¬æ¶çææ°ç¾ææ°åä¸ªéæºæµè¯ç¨ä¾ã</p>
</blockquote>
<br>
<p><img src="https://www.whuanle.cn/wp-content/uploads/2026/01/post-22312-69639cec13d1c.png" alt="image-20260109115335208" loading="lazy"></p>
<p><br>ç»æä¸é¡¿æä½åï¼éæ±å·²ç»ä¸åå° <code>.kiro/specs/create-short-url</code>ï¼Kiro ä¼çæä¸ä¸ªå³é®æä»¶ï¼è¿ä¸ä¸ªæä»¶ææä¸ä¸ª specã</p>
<ul>
<li><strong>requirements.md</strong>ï¼ä½¿ç¨ç»æåç EARS è®°å·æ³æè·ç¨æ·æäºåéªæ¶æ å</li>
<li><strong>design.md</strong>ï¼è®°å½ææ¯æ¶æãåºåå¾åå®æ½èèå ç´ </li>
<li><strong>tasks.md</strong>ï¼æä¾è¯¦ç»çå®æ½è®¡åï¼åå«ç¦»æ£çãå¯è·è¸ªçä»»å¡</li>
</ul>
<p><img src="https://www.whuanle.cn/wp-content/uploads/2026/01/post-22312-69639ced335de.png" alt="image-20260109115648904" loading="lazy"></p>
<br>
<p>æä»¬å¯ä»¥åç¼è¾ requirements.mdãdesign.mdï¼ç¡®ä¿ AI çæçå·ä½ä¸å¡è¦æ±åæµè¯è¯´æãææ¯æ åå®ç°æè·¯ç¬¦åæä»¬çè¦æ±ï¼æåæå¼ tasks.md æä»¶ï¼ç¹å»ä»»å¡æè¾¹ç <code>Start task</code> æé®å¼å§å®ç°ä»£ç ã</p>
<p><img src="https://www.whuanle.cn/wp-content/uploads/2026/01/post-22312-69639ced5de13.png" alt="0dce46d5-0884-4a84-ac8d-792c18df1988" loading="lazy"></p>
<br>
<p>ç±äºåå»ºç­é¾æ¥å­å¨ä»£ç æ¶ï¼ä½¿ç¨çç®æ³è·æçè®¾æ³ç¸å·®çè¿ï¼æä»¥è¿éä¹å¯ä»¥éæ°çæä»£ç ï¼ä¸è¿å»ºè®®å¥½å¥½å  requirements.mdãdesign.mdï¼ä¸è¦å¨å¯¹è¯æ¡è°æ´ä»£ç é»è¾ï¼åªææ²æ·çææ¡£ææ¯æéè¦çã</p>
<p><img src="https://www.whuanle.cn/wp-content/uploads/2026/01/post-22312-69639ceeab3a2.png" alt="image-20260109130137218" loading="lazy"></p>
<h3 id="å·¥ä½æµç¨">å·¥ä½æµç¨</h3>
<p>åé¢å©ç¨å âå®ç°åå»ºç­é¾æ¥çæ¥å£â è¿ä¸ªéæ±ï¼ä¸æäº Kiro specsï¼åä½åºè¯¥å¤§æ¦äºè§£æä¹ç©äºï¼ä½æ¯åå°å¢éåä½ä¸ï¼æä»¬è¦å¥½å¥½ææï¼ç åå¢éåºè¯¥æä¹å specsã</p>
<p>æä»¥ï¼å¨è¿ä¸èä¸­ï¼è®²è§£ Kiro specs çä¸äºæ¦å¿µï¼ä»¥ä¾¿åç­ [æ ¸å¿æ§è¡ï¼AI é©±å¨çåä½æµç¨è®¾è®¡](#æ ¸å¿æ§è¡ï¼AI é©±å¨çåä½æµç¨è®¾è®¡) ä¸­æå°çé®é¢ï¼æä¹æå®æ°çå¢éç åæµç¨ã</p>
<h4 id="éæ±é¶æ®µ">éæ±é¶æ®µ</h4>
<p>Kiro specs æåºå¨éæ±é¶æ®µç¨ç»æå EARS è¡¨ç¤ºæ³å®ä¹ç¨æ·æäºåéªæ¶æ åï¼ä¹å°±æ¯ requirements.md åºè¯¥æ°åçåå®¹ãrequirements.md æä»¶ä»¥ç¨æ·æäºçå½¢å¼åæï¼å¶ä¸­åå« EARS è¡¨ç¤ºæ³ä¸­çéªæ¶æ åã</p>
<p>æ ¸å¿å·¥ä½å¦ä¸ï¼</p>
<ul>
<li>å®ä¹ç¨æ·æäº</li>
<li>ç¼åéªæ¶æ å</li>
<li>éç¨ EARS ç¬¦å·è¿è¡éæ±è§è</li>
</ul>
 <br>
<p>ä¸ä¼ ç»éæ±ç¼åæ¹æ³çæ¯è¾ï¼EARS ç¬¦å·è¡¨ç¤ºéæ±æå¾å¤§ä¼å¿ï¼å°¤å¶å¨ä½¿ç¨ AI ç¼ç¨æ¶ã</p>
<table>
<thead>
<tr>
<th><strong>æ¹é¢</strong></th>
<th><strong>ä¼ ç»è¦æ±</strong></th>
<th><strong>EARS ç¬¦å·</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>ææ°</strong></td>
<td>éå¸¸å«ç³ä¸æ¸æåé¿</td>
<td>ç®æ´æäº</td>
</tr>
<tr>
<td><strong>æ åå</strong></td>
<td>ä¸åå¢éä¹é´å­å¨å¾å¤§å·®å¼</td>
<td>ææéæ±çç»ä¸è¯­æ³</td>
</tr>
<tr>
<td><strong>æäºçè§£</strong></td>
<td>å¯¹äºéææ¯å©çç¸å³èæ¥è¯´å¾å°é¾</td>
<td>ææå©çç¸å³èé½è½è½»æ¾çè§£</td>
</tr>
<tr>
<td><strong>å¯è¿½æº¯åæä»ª</strong></td>
<td>ç»´æèµ·æ¥å¾å°é¾</td>
<td>éè¿ç»æåè¯­æ³å¢å¼ºå¯è¿½æº¯æ§</td>
</tr>
</tbody>
</table>
 <br>
<p>åæ³æä»¬å¬å¸ï¼äº§åç»çä½¿ç¨é£ä¹¦ææ¡£åäº§åææ¡£ï¼é»è¾æ··ä¹±ï¼éè¯»èµ·æ¥éå¸¸å¤´ç¼ï¼å¸¸å¸¸å¨ç¼ç å¼åè¿ç¨ä¸­åå¤è°æ´ï¼å¨ææµåéªæ¶ç¯èå­å¨åç§åæ ·çé®é¢ï¼ä¸çº¿åä¸å  bugãç åæµç¨åä¸çº¿åçè½¯ä»¶ï¼å­å¨åç§åæ ·å¤§å¤§å°å°çé®é¢ï¼ç åæªäº§åç»çææ¡£åå¾çï¼äº§åç»çæªç åæ²¡æçè§£éæ±ï¼æµè¯äººåå·ç åä»£ç åå¾çã</p>
<p>èé¢å¯¼ä»¬å¿çå®å¶åç§ âè§èâï¼è¦æ±äº§åç»çåäº§åææ¡£è¦æç§æäºæçæ ¼å¼å»åï¼åäºåç§ç åæµç¨è¦æ±ï¼è¯å¾éè¿æå®ä¸ç³»åæè°çè§èå»å½»åºè§£å³ç åå¢éåçé®é¢ã</p>
 <br>
<p>EARS è¡¨ç¤ºæ³ï¼åäºæ·±å¥äºè§£åï¼åç°è¿ä¸ªççå¾éåå¢éè½å°ï¼æ¢å¯ä»¥è§£å³äº§åç»çå°ç¼ç ãææµåçä¸äºå¸¸è§é®é¢ï¼åè½ä¾¿äº AI çè§£éæ±ãAI å¯ä»¥å¾å®¹æåºäº EARS éæ±è¡¨ç¤ºæ³ï¼çæå¯¹åºçç¼ç éæ±åæµè¯ç¨ä¾ï¼ç¡®ä¿ä»£ç çé»è¾è·éæ±ä¸è´ï¼å¹¶ä¸çæå¯¹åºçéªæ¶ææ¡£ï¼ä½ä¸ºæç»ä»£ç éªæ¶ä¾æ®ã</p>
<p>requirements.md ææ¡£åä¸ºå¤ä¸ªé¨åï¼å¶ä¸­ <strong>Requirements</strong> é¨ååºå½ä½¿ç¨ EARS è¡¨ç¤ºæ³ç¼åï¼æ¯ä¸ª requirement é½éµå¾ªä»¥ä¸æ¨¡å¼ã</p>
<pre><code>å½[æ¡ä»¶/äºä»¶]åçæ¶
ç³»ç»åº[é¢æè¡ä¸º]
</code></pre>
<p><img src="https://www.whuanle.cn/wp-content/uploads/2026/01/post-22312-69639ceed27e6.png" alt="image-20260110103653398" loading="lazy"></p>
 <br>
<h4 id="è®¾è®¡é¶æ®µ">è®¾è®¡é¶æ®µ</h4>
<p>design.md æä»¶æ¯è®°å½ææ¯æ¶æãé¡ºåºå¾åå®ç°æ³¨æäºé¡¹çå°æ¹ï¼éè¿ design.md å¯ä»¥å¨é¢äºè§£ç³»ç»çå·¥ä½æ¹å¼ï¼åæ¬ç»ä»¶åå¶äº¤äºãKiri çè§èä¸ºè®¾è®¡ææ¡£æä¾äºä¸ç§ç»æåçæ¹æ³ï¼ä½¿å¾çè§£ååä½å¤æç³»ç»åå¾æ´å å®¹æã</p>
<p>è®¾è®¡é¶æ®µå¯ä»¥åèåé¢ AI çæç <code>design.md</code>ï¼åæ¬äºä¸å¾ä¸­çåå®¹ã</p>
<p><img src="https://www.whuanle.cn/wp-content/uploads/2026/01/post-22312-69639cef01f19.png" alt="image-20260110104444972" loading="lazy"></p>
<h4 id="å®æ½é¶æ®µ">å®æ½é¶æ®µ</h4>
<p>tasks.md æä»¶æä¾äºä¸ä¸ªè¯¦ç»çå®æ½è®¡åï¼å¶ä¸­åå«ç¦»æ£çãå¯è·è¸ªçä»»å¡åå­ä»»å¡ãæ¯ä¸ªä»»å¡é½ææç¡®çå®ä¹ï¼åæ¬æ¸æ°çæè¿°ãé¢æç»æä»¥åä»»ä½å¿è¦çèµæºæä¾èµå³ç³»ãæ¯ä¸ªæ­¥éª¤é½å¯ä»¥ç¹å»ï¼AI æ§è¡ä»»å¡åä¼å®æ¶å·æ°å° task.md éé¢ã</p>
<p>AI çæç task.md å¦ä¸ï¼åºæ¬ä¹æ¯åä¸æ­¥ï¼åè§£ä»»å¡ãå®ä¹ä»»å¡è¾åºç»æãè®¾ç½®ä»»å¡ä¸ä¸ä¾èµå³ç³»ï¼å½ç¶æåå¯è½è¿æéªæ¶å®æ½çè¯´æ</p>
<p><img src="https://www.whuanle.cn/wp-content/uploads/2026/01/post-22312-69639cef30fb1.png" alt="image-20260109131506945" loading="lazy"></p>
<h4 id="æ§è¡é¶æ®µ">æ§è¡é¶æ®µ</h4>
<p>å¶å®å°±æ¯æä»¬å¨ task.md æå¨ç¹å»åä¸ª task çè¿ç¨ï¼æä»¬åºè¯¥ä¸ç´è·è¸ªä»»å¡è¿åº¦ï¼éæ¶è°æ´æ´æ°è¡¥å specs ä¸ä¸ªææ¡£ï¼å®ååå®¹ï¼è®© AI è¾åºçæææ´å å¥½ã</p>
<h3 id="ä½¿ç¨-hook-èªå¨æå»ºååæµè¯">ä½¿ç¨ Hook èªå¨æå»ºååæµè¯</h3>
<p>å½å¨å·¥ä½ç©ºé´ä¸­åå»ºãä¿å­æå é¤ä¸ç¹å®å¨å±æ¨¡å¼å¹éçæä»¶æ¶ï¼ä¼è§¦åæä»¶é©å­ãè¿äºé©å­éè¦ä¸ä¸ªæ¨¡å¼æ°ç»æ¥æå®è¦çè§çæä»¶ã</p>
 <br>
<p>è¿éç¬èä½¿ç¨ååæµè¯æ¥å Hookï¼è®©è¯»èäºè§£ Kiro ç Hook æä¹ç©ã</p>
<p>ååæµè¯æ¯é¡¹ç®æéè¦çä¸é¨åï¼ç±äºç¬èè¿ä¸ªæ¨¡æ¿é¡¹ç®éç¨æ´æ´æ¶æï¼æä»¥åæµè¯ä¹æ¯ç¸å½ç®åã</p>
<p>ä¸»è¦åä¸ºä¸é¨åèèï¼</p>
<p>å¯¹äºæ ä¸å¡ç¸å³çæ¡æ¶ãå·¥å·ãç®æ³ä»£ç ï¼åç¬è®¾è®¡éªè¯çååæµè¯å³å¯ã</p>
<p>å¯¹äºæ¨¡åç±»ï¼è¦éªè¯ api è¯·æ±æ¶åæ°éå¶ï¼è¦è¯å«å­æ®µé¿åº¦èå´ç­è§åã</p>
<p>å¯¹äº ApiãHandler å¯ä»¥ä¸èµ·æµï¼ç¼åéææµè¯ï¼ç´æ¥ä½¿ç¨ TestWebHost æ¨¡æè¯·æ±ã</p>
 <br>
<p>ç°å¨æä»¬ç¼åå¯¹åºçæç¤ºè¯ï¼è®© Kiro çæ Hookã</p>
<pre><code>ç» Api ç¼åååæµè¯ï¼ä½¿ç¨ EFCoreåå­æ°æ®åºæ¨¡æï¼redis ä½¿ç¨mockæ¿ä»£å¯¹äºæ ä¸å¡ç¸å³çæ¡æ¶ãå·¥å·ãç®æ³ä»£ç ï¼åç¬è®¾è®¡éªè¯çååæµè¯å³å¯ãå¯¹äºæ¨¡åç±»ï¼è¦éªè¯ api è¯·æ±æ¶åæ°éå¶ï¼è¦è¯å«å­æ®µé¿åº¦èå´ç­è§åãå¯¹äº ApiãHandler å¯ä»¥ä¸èµ·æµï¼ç¼åéææµè¯ï¼ç´æ¥ä½¿ç¨ TestWebHost æ¨¡æè¯·æ±ã
</code></pre>
<p><img src="https://www.whuanle.cn/wp-content/uploads/2026/01/post-22312-69639cf060a20.png" alt="image-20260109125656799" loading="lazy"></p>
<p><img src="https://www.whuanle.cn/wp-content/uploads/2026/01/post-22312-69639cf08c52b.png" alt="image-20260109130251045" loading="lazy"></p>
<p><img src="https://www.whuanle.cn/wp-content/uploads/2026/01/post-22312-69639cf0b69fe.png" alt="image-20260109125731788" loading="lazy"></p>
 <br>
<p>ç°å¨ä½¿ç¨ spec å å¥æ°çåè½ï¼</p>
<pre><code>Create Spec: ç¨æ·è®¿é®ç­é¾æ¥åï¼åå°ç­é¾æ¥ä½¿ç¨ base62 è¿åä¸ºéªè±idï¼åä»rediså¸éè¿æ»¤å¨éé¢è¿æ»¤ï¼å¦ææ¥æ¾ä¸å°åç´æ¥404ãç¶åä» key `short_url:{éªè±id}` éé¢æ¾ï¼æ¾ä¸å°å°±æ¥æ°æ®åºç¶åéæ°å¡å° redisï¼è¶æ¶æ¶é´30åéï¼ã
</code></pre>
 <br>
<p>åå»ºå®æåï¼æ§è¡ Task listã</p>
 <br>
<p>å¯ä»¥ç­å¾ Hook èªå¨è§¦åï¼æå¨å¯¹è¯çé¢åè¯ AI æå¨æ§è¡ <code>api-unit-test-gen.kiro.hook</code>ã</p>
<p>æç»çæååæµè¯å¦ä¸ï¼</p>
<p><img src="https://www.whuanle.cn/wp-content/uploads/2026/01/post-22312-69639cf234a04.png" alt="image-20260109134821100" loading="lazy"></p>
<p><img src="https://www.whuanle.cn/wp-content/uploads/2026/01/post-22312-69639cf25f739.png" alt="image-20260109135655490" loading="lazy"></p>
<h3 id="æå">æå</h3>
<p>å¸æå¯ä»¥éè¿æ¬æå¸®å©æ¨å¨å¬å¸åå»ºè®¾ä¸ä¸ª AI è¾å©ç¼ç¨å¢éã</p>

</div>
<div id="MySignature" role="contentinfo">
    ç´èå·¥è¯(https://whuanle.cn)
</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.021527777777777778" data-date-updated="2026-01-12 09:05">2026-01-12 08:34</span>&nbsp;
<a href="https://www.cnblogs.com/whuanle">ç´èå·¥è¯</a>&nbsp;
éè¯»(<span id="post_view_count">304</span>)&nbsp;
è¯è®º(<span id="post_comment_count">1</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19469026);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19469026', targetLink: 'https://www.cnblogs.com/whuanle/p/19469026', title: 'ä¸å­é¿æè®²è§£ï¼å¢éè½å° AI è¾å©ç¼ç¨å AI Specs å®æ' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ Javaä¸­çº¿ç¨å®å¨é®é¢çåå åè§£å³æ¹æ¡ ]]></title>
    <link>https://www.cnblogs.com/xi-yongqi/p/19468853</link>
    <guid>230b6b30fd8832efa55db7fe074252b8</guid>
    <description>
    <![CDATA[ 
		<h1 class="postTitle">
			<a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/xi-yongqi/p/19468853" title="åå¸äº 2026-01-11 23:41">
    <span role="heading" aria-level="2">Javaä¸­çº¿ç¨å®å¨é®é¢çåå åè§£å³æ¹æ¡</span>
    

</a>

		</h1>
		<div class="clear"></div>
		<div class="postBody">
			<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h3 id="çº¿ç¨å®å¨é®é¢çæ ¸å¿åå ">çº¿ç¨å®å¨é®é¢çæ ¸å¿åå </h3>
<ul>
<li>çº¿ç¨å®å¨é®é¢æ¬è´¨æ¯å¤ä¸ªçº¿ç¨å¹¶åè®¿é®å±äº«ä¸å¯åçèµæºæ¶ï¼æä½çåå­æ§ãå¯è§æ§ææåºæ§è¢«ç ´åï¼å¯¼è´ç¨åºæ§è¡ç»æä¸ç¬¦åé¢æã</li>
</ul>
<ol>
<li>æ ¹æ¬åå ï¼å±äº«å¯åèµæº</li>
</ol>
<ul>
<li>å±äº«èµæºï¼å¤ä¸ªçº¿ç¨é½è½è®¿é®å°çèµæºï¼å¦æååéãéæåéãå±äº«åå­åºåï¼ï¼</li>
<li>å¯åèµæºï¼èµæºçç¶æï¼å¼ï¼å¯ä»¥è¢«ä¿®æ¹ï¼å¦intè®¡æ°å¨ãHashMapçåç´ ï¼ï¼</li>
<li>ç»å¸çi++ æä½ãå®å¨åºå±åä¸ºâè¯»å-ä¿®æ¹-åå¥âä¸ä¸ªæ­¥éª¤ãå¦æä¸¤ä¸ªçº¿ç¨åæ¶è¯»å i=1ï¼åèªå 1åååï¼ç»ææ¯2èä¸æ¯3ã</li>
</ul>
<ol start="2">
<li>ç´æ¥åå ï¼ä¸å¤§ç¹æ§è¢«ç ´å</li>
</ol>
<ul>
<li>Javaåå­æ¨¡åï¼JMMï¼å®ä¹çå¤çº¿ç¨å¹¶åä¸å¤§æ ¸å¿ç¹æ§ï¼ä»»ä½ä¸ä¸ªè¢«ç ´åé½ä¼å¼åçº¿ç¨å®å¨é®é¢ï¼
<ul>
<li>åå­æ§ï¼ä¸ä¸ªæä½ï¼å¦count++ï¼åå«âè¯» - æ¹ - åâä¸æ­¥ï¼éåå­æä½ä¼è¢«å¤çº¿ç¨äº¤éæ§è¡ï¼</li>
<li>å¯è§æ§ï¼çº¿ç¨ä¿®æ¹å±äº«åéåï¼ä¸ä¼ç«å³åæ­¥å°ä¸»åå­ï¼å¶ä»çº¿ç¨è¯»åçä»æ¯æ§å¼ï¼</li>
<li>æåºæ§ï¼JVMçæä»¤éæåºä¼åï¼ä¼å¯¼è´å¤çº¿ç¨ä¸æ§è¡é¡ºåºæ··ä¹±ï¼å¦æªå volatileçåéæ£æ¥éåä¾ï¼ã</li>
</ul>
</li>
</ul>
<h3 id="çº¿ç¨å®å¨é®é¢çè§£å³æ¹æ¡">çº¿ç¨å®å¨é®é¢çè§£å³æ¹æ¡</h3>
<ul>
<li>æ ¸å¿æè·¯ï¼è¦ä¹é¿åå±äº«å¯åèµæºï¼ä»æ ¹æºæ¶é¤é®é¢ï¼ï¼è¦ä¹æ§å¶å¹¶åè®¿é®è§åï¼ä¿è¯ä¸å¤§ç¹æ§ï¼ã</li>
</ul>
<h5 id="æ¹æ¡1é¿åå±äº«å¯åèµæºä¼åæ¨è">æ¹æ¡1ï¼é¿åå±äº«å¯åèµæºï¼ä¼åæ¨èï¼</h5>
<ul>
<li>æ å°é­ï¼å±é¨åéï¼ï¼å±é¨åéå­å¨å¨çº¿ç¨ç§ææ ä¸­ï¼æ¯ä¸ªçº¿ç¨æç¬ç«å¯æ¬ï¼å¤©ç¶çº¿ç¨å®å¨ã</li>
</ul>
<pre><code class="language-java">public class StackClosedDemo {
    // æ¯ä¸ªçº¿ç¨è°ç¨è¯¥æ¹æ³æ¶ï¼é½ä¼åå»ºç¬ç«çcountå¯æ¬
    public void calculate() {
        int count = 0;
        count++; // æ çº¿ç¨å®å¨é®é¢
        System.out.println(Thread.currentThread().getName() + ": " + count);
    }

    public static void main(String[] args) {
        StackClosedDemo demo = new StackClosedDemo();
        // 10ä¸ªçº¿ç¨åèªæä½èªå·±çå±é¨åé
        for (int i = 0; i &lt; 10; i++) {
            new Thread(demo::calculate, "Thread-" + i).start();
        }
    }
}
</code></pre>
<ul>
<li>ä¸å¯åå¯¹è±¡:å¯¹è±¡åå»ºåç¶æä¸å¯ä¿®æ¹ï¼å¦StringãIntegerï¼ï¼å³ä½¿å±äº«ä¹æ æ³ä¿®æ¹å¼ã</li>
</ul>
<pre><code class="language-java">// èªå®ä¹ä¸å¯åç±»ï¼finalç±»+finalæååé+æ setterï¼
public final class ImmutableUser {
    private final String name;
    private final int age;

    public ImmutableUser(String name, int age) {
        this.name = name;
        this.age = age;
    }

    // ä»æä¾getterï¼æ setter
    public String getName() { return name; }
    public int getAge() { return age; }
}
</code></pre>
<ul>
<li>ThreadLocalï¼çº¿ç¨æ¬å°å­å¨ï¼:ä¸ºæ¯ä¸ªçº¿ç¨æä¾ç¬ç«çåéå¯æ¬ï¼çº¿ç¨æä½èªèº«å¯æ¬ï¼äºä¸å¹²æ°ã</li>
</ul>
<pre><code class="language-java">public class ThreadLocalDemo {
    // æ¯ä¸ªçº¿ç¨æç¬ç«çIntegerå¯æ¬ï¼åå§å¼ä¸º0
    private static ThreadLocal&lt;Integer&gt; threadLocal = ThreadLocal.withInitial(() -&gt; 0);

    public void increment() {
        threadLocal.set(threadLocal.get() + 1);
        System.out.println(Thread.currentThread().getName() + ": " + threadLocal.get());
    }

    public static void main(String[] args) {
        ThreadLocalDemo demo = new ThreadLocalDemo();
        // 3ä¸ªçº¿ç¨åèªæä½èªå·±çå¯æ¬
        for (int i = 0; i &lt; 3; i++) {
            new Thread(() -&gt; {
                for (int j = 0; j &lt; 2; j++) {
                    demo.increment();
                }
            }, "Thread-" + i).start();
        }
    }
}
// è¾åºï¼é¡ºåºå¯è½ä¸åï¼ï¼
// Thread-0: 1ãThread-0: 2
// Thread-1: 1ãThread-1: 2
// Thread-2: 1ãThread-2: 2
</code></pre>
<h4 id="æ¹æ¡2åæ­¥å éæ§å¶å¹¶åè®¿é®">æ¹æ¡2ï¼åæ­¥/å éï¼æ§å¶å¹¶åè®¿é®ï¼</h4>
<h5 id="äºæ¥åæ­¥é»å¡åæ­¥è¿æ¯æå¸¸è§çæ¹æ¡éè¿å éæ¥ä¿è¯åä¸æ¶å»åªæä¸ä¸ªçº¿ç¨æä½èµæº">äºæ¥åæ­¥ï¼é»å¡åæ­¥ï¼:è¿æ¯æå¸¸è§çæ¹æ¡ï¼éè¿å éæ¥ä¿è¯åä¸æ¶å»åªæä¸ä¸ªçº¿ç¨æä½èµæºã</h5>
<ul>
<li>synchronized å³é®å­ï¼Java åçæ¯æï¼ä½¿ç¨ç®åãå¯ä¿®é¥°æ¹æ³æä»£ç åãå±äºä¸å¯ä¸­æ­çéã</li>
</ul>
<pre><code class="language-java">public class SynchronizedDemo {
    private int count = 0;

    // åæ­¥å®ä¾æ¹æ³ï¼éæ¯thiså¯¹è±¡
    public synchronized void increment() {
        count++;
    }

    public static void main(String[] args) throws InterruptedException {
        SynchronizedDemo demo = new SynchronizedDemo();
        // 1000ä¸ªçº¿ç¨æ§è¡increment
        for (int i = 0; i &lt; 1000; i++) {
            new Thread(demo::increment).start();
        }
        Thread.sleep(1000);
        System.out.println("æç»countï¼" + demo.count); // è¾åº1000
    }
}
</code></pre>
<h5 id="reentrantlockæ¾å¼éæ¯synchronizedçµæ´»å¯ä¸­æ­å¯è¶æ¶å¬å¹³ééæå¨éæ¾éå¿é¡»å¨finallyä¸­">ReentrantLockï¼æ¾å¼éï¼:æ¯synchronizedçµæ´»ï¼å¯ä¸­æ­ãå¯è¶æ¶ãå¬å¹³éï¼ï¼éæå¨éæ¾éï¼å¿é¡»å¨finallyä¸­ï¼ã</h5>
<pre><code class="language-java">import java.util.concurrent.locks.Lock;
import java.util.concurrent.locks.ReentrantLock;

public class ReentrantLockDemo {
    private int count = 0;
    private Lock lock = new ReentrantLock(); // é»è®¤éå¬å¹³é

    public void increment() {
        lock.lock(); // å é
        try {
            count++;
        } finally {
            lock.unlock(); // éæ¾éï¼é¿åæ­»é
        }
    }

    public static void main(String[] args) throws InterruptedException {
        ReentrantLockDemo demo = new ReentrantLockDemo();
        for (int i = 0; i &lt; 1000; i++) {
            new Thread(demo::increment).start();
        }
        Thread.sleep(1000);
        System.out.println("æç»countï¼" + demo.count); // è¾åº1000
    }
}
</code></pre>
<h4 id="æ¹æ¡3volatileå³é®å­ä¿è¯å¯è§æ§æåºæ§">æ¹æ¡3ï¼volatileå³é®å­ï¼ä¿è¯å¯è§æ§/æåºæ§ï¼</h4>
<ul>
<li>ä¿è¯å¯è§æ§ï¼å¼ºå¶å¤±æå·¥ä½åå­ï¼ç´æ¥è¯»åä¸»åå­ã</li>
<li>ä¿è¯æåºæ§ï¼ç¦æ­¢æä»¤éæåºã</li>
<li>æ³¨æï¼å®ä¸ä¿è¯åå­æ§ï¼ä¸è½è§£å³i++é®é¢ï¼ã</li>
</ul>
<pre><code class="language-java">public class VolatileDemo {
    private volatile boolean stop = false; // ä¿è¯å¯è§æ§åæåºæ§

    public void runThread() {
        new Thread(() -&gt; {
            int i = 0;
            while (!stop) { // è½ç«å³æç¥stopçä¿®æ¹
                i++;
            }
            System.out.println("çº¿ç¨åæ­¢ï¼i=" + i);
        }).start();
    }

    public static void main(String[] args) throws InterruptedException {
        VolatileDemo demo = new VolatileDemo();
        demo.runThread();
        Thread.sleep(3000);
        demo.stop = true; // ä¿®æ¹åï¼çº¿ç¨ç«å³åæ­¢
    }
}
</code></pre>

</div>
<div class="clear"></div>

		</div>
		<div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-01-11 23:41">2026-01-11 23:41</span>&nbsp;
<a href="https://www.cnblogs.com/xi-yongqi">æä¼æ¿é£å»</a>&nbsp;
éè¯»(<span id="post_view_count">42</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19468853);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19468853', targetLink: 'https://www.cnblogs.com/xi-yongqi/p/19468853', title: 'Javaä¸­çº¿ç¨å®å¨é®é¢çåå åè§£å³æ¹æ¡' })">ä¸¾æ¥</a>
</div>
	 ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ é£ä¹¦ .NET SDK äºä»¶å¤ççå¹ç­æ§ä¸å»éæºå¶ ]]></title>
    <link>https://www.cnblogs.com/mudtools/p/19469184</link>
    <guid>bd0ebe6ed3f817550068845b03bbc87d</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/mudtools/p/19469184" title="åå¸äº 2026-01-11 23:00">
    <span role="heading" aria-level="2">é£ä¹¦ .NET SDK äºä»¶å¤ççå¹ç­æ§ä¸å»éæºå¶</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<blockquote>
<p>é£ä¹¦äºä»¶å¤çè¿ç¨ä¸­å¦ä½è®©ä½ çåºç¨ä¸å"éå¤å³å¨"ï¼å¦ä½ç¨ä¸å±é²æ¤ç­èµ·å®å¨å¢ï¼ç»ååå­ä¸ Redis åéä¿éï¼è®©ä½ çé£ä¹¦åºç¨ç¨³å¦ç£ç³ââä¸åéå¤å¤çï¼åå«æ··ä¹±ç¶æã</p>
</blockquote>
<hr>
<h2 id="ä¸ºä»ä¹éè¦å»é">ä¸ºä»ä¹éè¦"å»é"ï¼</h2>
<p>æ³è±¡ä¸ä¸è¿æ ·çåºæ¯ï¼</p>
<p>ä½ å¨é£ä¹¦éæ¶å°ä¸æ¡æ¶æ¯ï¼åºç¨æ¶å°éç¥ååå»ºäºå¾åäºé¡¹ãä½å ä¸ºç½ç»ä¸ç¨³å®ï¼é£ä¹¦ä»¥ä¸ºä½ æ²¡æ¶å°ï¼ååäºä¸éåæ ·çéç¥ââç»æå¢ï¼ä½ çåºç¨ååå»ºäºä¸æ¬¡å¾åï¼åä¸ä¸ªä»»å¡åºç°äºä¸¤æ¬¡ã</p>
<p>è¿å°±æ¯æä»¬æè¯´ç"éå¤å¤ç"é®é¢ã</p>
<hr>
<h3 id="ä»ä¹æ¶åä¼åºç°è¿ç§æåµ">ä»ä¹æ¶åä¼åºç°è¿ç§æåµï¼</h3>
<p>å¨é£ä¹¦äºä»¶é©±å¨çä¸çéï¼ä»¥ä¸æåµé½å¯è½å¯¼è´<strong>åä¸äºä»¶è¢«å¤æ¬¡éè¾¾</strong>ï¼</p>
<ul>
<li>ð¡ <strong>ç½ç»æ³¢å¨</strong>ï¼é£ä¹¦æå¡å¨æ²¡æ¶å°ä½ çç¡®è®¤ï¼äºæ¯éå</li>
<li>ð <strong>æå¡éå¯</strong>ï¼åå­æ¸ç©ºï¼ä¹åçäºä»¶åæ¥äº</li>
<li>ð¥ <strong>å¤å®ä¾è¿è¡</strong>ï¼å¤ä¸ªå®ä¾åæ¶æ¶å°åä¸äºä»¶</li>
<li>ð <strong>æ­çº¿éè¿</strong>ï¼WebSocket éè¿åå¯è½éå¤æ¶æ¯</li>
</ul>
<h3 id="çå®æ¡ä¾ä¸åéåçæ··ä¹±">çå®æ¡ä¾ï¼ä¸åéåçæ··ä¹±</h3>
<pre><code>æ¶é´çº¿ï¼
âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ
09:00:00  é£ä¹¦æ¨éï¼æ¶å°ä¸æ¡æ°æ¶æ¯
09:00:01  å®ä¾A æ¥æ¶å¹¶å¤ç â åå»ºå¾å â
09:00:05  é£ä¹¦æ²¡æ¶å°ç¡®è®¤ï¼åæ¬¡æ¨é
09:00:06  å®ä¾B æ¥æ¶å¹¶å¤ç â ååå»ºå¾å â
âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ
</code></pre>
<p><strong>åææå¤ä¸¥éï¼</strong></p>
<table>
<thead>
<tr>
<th>é®é¢</th>
<th>å®éå½±å</th>
</tr>
</thead>
<tbody>
<tr>
<td>ð æ°æ®éå¤</td>
<td>ç¨æ·æ¶å°ä¸¤æ¡ç¸åçå¾å</td>
</tr>
<tr>
<td>ð° èµéæå¤±</td>
<td>è®¢åéå¤æ£æ¬¾ï¼éé±é½éä¸å®</td>
</tr>
<tr>
<td>ð§ éªæ°ç¨æ·</td>
<td>åä¸æ¡éç¥ååæ¬¡</td>
</tr>
<tr>
<td>ð ç¶ææ··ä¹±</td>
<td>æ°æ®åºéè¯´"å·²å¤ç"ï¼å®éåªåäºä¸å</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="ä¸å±é²æ¤åä¿å®ä¸æ ·å±å±æå³">ä¸å±é²æ¤ï¼åä¿å®ä¸æ ·å±å±æå³</h2>
<p>Mud.Feishu SDK è®¾è®¡äºä¸å¥<strong>ä¸å±éè¿å¼é²æ¤æºå¶</strong>ï¼å°±åå°åºçä¸éå²å¨ï¼ä»å¤å°åå±å±æå³ï¼ç¡®ä¿ä¸ä¼æ"åäºº"ï¼éå¤äºä»¶ï¼æ··è¿æ¥ã</p>
<div class="mermaid">graph TB
    subgraph AppLayer["åºç¨å±å»éï¼ä¸å¡é®ï¼"]
        AppHandler["IdempotentFeishuEventHandler&lt;T&gt;"]
        AppDesc["åºäºä¸å¡ä¸»é®ï¼æ¶æ¯IDãè®¢åIDç­ï¼å»é"]
    end

    subgraph DispatchLayer["ååå±å»éï¼EventIdï¼"]
        EventDedup["IFeishuEventDeduplicator / IFeishuEventDistributedDeduplicator"]
        EventDesc["åºäºé£ä¹¦äºä»¶IDå»éï¼24å°æ¶çªå£æ"]
    end

    subgraph ProtocolLayer["åè®®å±å»éï¼SeqID/Nonceï¼"]
        WS_Dedup["WebSocket: IFeishuSeqIDDeduplicator"]
        Webhook_Dedup["Webhook: IFeishuNonceDistributedDeduplicator"]
        ProtoDesc["åºäºæ¶æ¯åºåå·å»éï¼è¿æ»¤éå¤æ¶æ¯"]
    end

    AppHandler --&gt;|å¤çå¨åé¨ä¸å¡é»è¾| EventDedup
    EventDedup --&gt;|äºä»¶è·¯ç±ä¸åå| WS_Dedup
    EventDedup --&gt;|äºä»¶è·¯ç±ä¸åå| Webhook_Dedup

    style AppLayer fill:#e1f5ff
    style DispatchLayer fill:#fff4e1
    style ProtocolLayer fill:#ffe1e1
</div><h3 id="è¿ä¸å±åå«è´è´£ä»ä¹">è¿ä¸å±åå«è´è´£ä»ä¹ï¼</h3>
<p>å¯ä»¥æè¿ä¸å±æ³è±¡æå·¥åæµæ°´çº¿ä¸çä¸ä¸ªè´¨æ£åï¼</p>
<table>
<thead>
<tr>
<th>è´¨æ£å</th>
<th>æ£æ¥ä»ä¹ï¼</th>
<th>å¨åªæ£æ¥ï¼</th>
<th>è¿æ»¤èå´</th>
<th>éåä»ä¹æ¶åç¨ï¼</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>åè®®å±</strong></td>
<td>æ¶æ¯ç¼å·ï¼SeqIDï¼</td>
<td>æ¶æ¯åå°è¾¾æ¶</td>
<td>æ¯æ¡æ¶æ¯</td>
<td>è¿æ»¤ç½ç»éå¤ï¼æå¤å±é²æ¤</td>
</tr>
<tr>
<td><strong>ååå±</strong></td>
<td>äºä»¶IDï¼EventIdï¼</td>
<td>äºä»¶ååå</td>
<td>æ¯ä¸ªäºä»¶</td>
<td>è¿æ»¤é£ä¹¦éåï¼ä¸­é´å±é²æ¤</td>
</tr>
<tr>
<td><strong>åºç¨å±</strong></td>
<td>ä¸å¡é®ï¼TaskIdï¼</td>
<td>ä¸å¡å¤çæ¶</td>
<td>æ¯æ¬¡ä¸å¡æä½</td>
<td>é²æ­¢é»è¾éå¤ï¼æåä¸éé²çº¿</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="ååå±äºä»¶çèº«ä»½è¯æ£æ¥">ååå±ï¼äºä»¶ç"èº«ä»½è¯æ£æ¥"</h2>
<p>è¿æ¯ææ ¸å¿çä¸å±ï¼å°±åé¨å£çä¿å®ï¼æ¯ä¸ªè¿æ¥çäºä»¶é½è¦ååºç¤ºèº«ä»½è¯ï¼EventIdï¼ï¼ä¿å®æ¥è¿è®°å½åæè½æ¾è¡ã</p>
<pre><code class="language-csharp">public interface IFeishuEventDeduplicator
{
    /// &lt;summary&gt;
    /// å°è¯æ è®°äºä»¶ä¸ºå¤çä¸­
    /// &lt;/summary&gt;
    /// &lt;returns&gt;
    /// true: å·²å¤çææ­£å¨å¤çä¸­ï¼è·³è¿ï¼
    /// false: æ°äºä»¶ï¼ç»§ç»­å¤çï¼
    /// &lt;/returns&gt;
    bool TryMarkAsProcessing(string eventId);

    /// &lt;summary&gt;
    /// æ è®°äºä»¶ä¸ºå·²å®æ
    /// &lt;/summary&gt;
    void MarkAsCompleted(string eventId);

    /// &lt;summary&gt;
    /// åæ»å¤çä¸­ç¶æï¼å¼å¸¸æ¶è°ç¨ï¼
    /// &lt;/summary&gt;
    void RollbackProcessing(string eventId);

    /// &lt;summary&gt;
    /// æ£æ¥äºä»¶æ¯å¦å·²å¤ç
    /// &lt;/summary&gt;
    bool IsProcessed(string eventId);
}
</code></pre>
<h3 id="äºä»¶çä¸çä¸ç§ç¶ææµè½¬">äºä»¶çä¸çï¼ä¸ç§ç¶ææµè½¬</h3>
<p>æ¯ä¸ªäºä»¶å¨å»éç³»ç»éé½åè¿å®æ£ä¸æ ·ï¼ç»åä¸ç§ç¶æçååï¼</p>
<div class="mermaid">stateDiagram-v2
    [*] --&gt; Pending: æ¶å°æ°äºä»¶
    Pending --&gt; Processing: TryMarkAsProcessing()
    Processing --&gt; Completed: å¤çæå
    Processing --&gt; Pending: è¶æ¶/å¼å¸¸ï¼Rollbackï¼
    Completed --&gt; Pending: ç¼å­è¿æï¼24å°æ¶åï¼

    note right of Processing
        å¤çä¸­è¶æ¶ï¼é»è®¤5åéï¼
        åè®¸éæ°å¤ç
    end note

    note right of Completed
        24å°æ¶åèªå¨æ¸ç
        æ¯æTTLéç½®
    end note
</div><h3 id="çå®åºæ¯websocket-æ¯æä¹å»éç">çå®åºæ¯ï¼WebSocket æ¯æä¹å»éçï¼</h3>
<p>æ¥çç WebSocket æ¶å°äºä»¶ååäºä»ä¹ï¼<code>FeishuEventMessageHandler.cs#104-147</code>ï¼ï¼</p>
<pre><code class="language-csharp">// 1. å»éæ£æ¥
bool isProcessing = false;

if (_options.EnableDistributedDeduplication &amp;&amp; _distributedDeduplicator != null)
{
    // ä¼åä½¿ç¨åå¸å¼å»éï¼Redisï¼
    isProcessing = await _distributedDeduplicator.TryMarkAsProcessedAsync(
        eventData.EventId, 
        cancellationToken: cancellationToken);
}
else if (_options.EnableEventDeduplication &amp;&amp; _deduplicator != null)
{
    // ä½¿ç¨åå­å»é
    isProcessing = _deduplicator.TryMarkAsProcessing(eventData.EventId);
}

// 2. è·³è¿å·²å¤çäºä»¶
if (isProcessing)
{
    _logger.LogDebug("äºä»¶ {EventId} å·²å¨å¤çä¸­æå·²å¤çï¼è·³è¿", eventData.EventId);
    return;
}

// 3. å¤çäºä»¶
try
{
    await _eventHandlerFactory.HandleEventParallelAsync(
        eventData.EventType, 
        eventData, 
        cancellationToken);

    // 4. å¤çæåï¼æ è®°ä¸ºå·²å®æ
    if (_options.EnableEventDeduplication &amp;&amp; _deduplicator != null)
    {
        _deduplicator.MarkAsCompleted(eventData.EventId);
    }
}
catch (Exception ex)
{
    // 5. å¤çå¤±è´¥ï¼åæ»ç¶æ
    if (_options.EnableEventDeduplication &amp;&amp; _deduplicator != null)
    {
        _deduplicator.RollbackProcessing(eventData.EventId);
    }
    throw;
}
</code></pre>
<h3 id="æ¹æ¡ä¸åå­å»ééåå¼ååå°è§æ¨¡åºç¨">æ¹æ¡ä¸ï¼åå­å»éï¼éåå¼ååå°è§æ¨¡åºç¨ï¼</h3>
<p><strong>å°±åå¨å¤§èéè®°ç¬è®°</strong>ï¼ææ¯ä¸ªäºä»¶IDè®°å¨åå­éï¼æ¶å°æ°äºä»¶æ¶åæ¥æ¥ç¬è®°ï¼å¦ææå°±è·³è¿ã</p>
<p><strong>ç¹ç¹</strong>ï¼</p>
<ul>
<li>ð§  <strong>å¨é èå­è®°</strong>ï¼æææ°æ®å­å¨åå­é</li>
<li>â° <strong>è®°24å°æ¶</strong>ï¼è¶è¿æ¶é´å°±èªå¨å¿æ</li>
<li>ð§¹ <strong>å®æææ«</strong>ï¼æ¯5åéæ¸çä¸æ¬¡è¿æçè®°å½</li>
<li>â±ï¸ <strong>è¶æ¶ä¿æ¤</strong>ï¼å¤çè¶è¿5åéè¿æ²¡å®æï¼å°±åè®¸éè¯</li>
</ul>
<p><strong>æ ¸å¿ä»£ç </strong>ï¼<code>FeishuEventDeduplicator.cs#86-135</code>ï¼ï¼</p>
<pre><code class="language-csharp">public bool TryMarkAsProcessing(string eventId)
{
    lock (_lock)
    {
        // æ£æ¥æ¯å¦å·²å­å¨
        if (_eventCache.TryGetValue(eventId, out var entry))
        {
            // å¦æå·²å¤çï¼è¿å trueï¼è·³è¿ï¼
            if (entry.Status == DeduplicationStatus.Completed)
                return true;

            // å¦æå·²å¨å¤çä¸­ï¼æ£æ¥æ¯å¦è¶æ¶
            if (entry.Status == DeduplicationStatus.Processing)
            {
                if (DateTimeOffset.UtcNow - entry.ProcessedAt &gt; _processingTimeout)
                {
                    // å¤çä¸­è¶æ¶ï¼åè®¸éæ°å¤ç
                    _logger?.LogWarning("äºä»¶ {EventId} å¤çä¸­è¶æ¶ï¼åè®¸éæ°å¤ç", eventId);
                    _eventCache.Remove(eventId);
                    // ç»§ç»­å¤ç
                }
                else
                {
                    // ä»å¨å¤çä¸­ï¼è·³è¿
                    return true;
                }
            }
        }

        // æ è®°ä¸ºå¤çä¸­
        _eventCache[eventId] = new EventCacheEntry
        {
            ProcessedAt = DateTimeOffset.UtcNow,
            EventId = eventId,
            Status = DeduplicationStatus.Processing
        };

        return false; // æªå¤çï¼æ°äºä»¶
    }
}
</code></pre>
<h3 id="æ¹æ¡äºredis-åå¸å¼å»éçäº§ç¯å¢é¦é">æ¹æ¡äºï¼Redis åå¸å¼å»éï¼çäº§ç¯å¢é¦éï¼</h3>
<p><strong>å°±åå±äº«ç¬è®°æ¬</strong>ï¼ç¨ Redis æå»éè®°å½è®°å¨å¤é¨ï¼ææå®ä¾é½è½æ¥å°ãå°±ç®éå¯æå¡ï¼ç¬è®°æ¬è¿å¨ï¼ä¸ä¼å¿è®°ã</p>
<p><strong>ç¹ç¹</strong>ï¼</p>
<ul>
<li>ð <strong>åå¨å±äº«ç¬è®°æ¬ä¸</strong>ï¼ææå®ä¾ä¸èµ·ç</li>
<li>ð <strong>èªå¨ç¿»é¡µ</strong>ï¼å°æèªå¨æ¸çï¼ä¸ç¨ç®¡</li>
<li>ð¤ <strong>å¤§å®¶ä¸èµ·ç¨</strong>ï¼å¤å®ä¾é¨ç½²æ²¡é®é¢</li>
<li>â¡ <strong>åå­æä½</strong>ï¼SETNX + EXPIRE ç¡®ä¿ä¸ä¼åé</li>
</ul>
<p><strong>æ ¸å¿ä»£ç </strong>ï¼<code>RedisFeishuEventDistributedDeduplicator.cs#53-89</code>ï¼ï¼</p>
<pre><code class="language-csharp">public async Task&lt;bool&gt; TryMarkAsProcessedAsync(
    string eventId, 
    TimeSpan? ttl = null, 
    CancellationToken cancellationToken = default)
{
    var actualTtl = ttl ?? _defaultCacheExpiration;
    var redisKey = $"{_keyPrefix}{eventId}";

    // ä½¿ç¨ SETNX + EXPIRE å®ç°åå­æ§å»é
    // ä»å½é®ä¸å­å¨æ¶è®¾ç½®ï¼å¹¶è®¾ç½®è¿ææ¶é´
    var setResult = await _database.StringSetAsync(
        redisKey,
        "1",
        actualTtl,
        When.NotExists);

    if (!setResult)
    {
        _logger?.LogDebug("äºä»¶ {EventId} å·²å¤çè¿ï¼è·³è¿", eventId);
        return true; // å·²å¤ç
    }

    _logger?.LogDebug("äºä»¶ {EventId} æ è®°ä¸ºå·²å¤çï¼TTL: {Ttl}", eventId, actualTtl);
    return false; // æªå¤çï¼æ°äºä»¶
}
</code></pre>
<h3 id="ä¸¤ç§æ¹æ¡æä¹é">ä¸¤ç§æ¹æ¡æä¹éï¼</h3>
<table>
<thead>
<tr>
<th>å¯¹æ¯é¡¹</th>
<th>åå­å»éï¼èªå·±è®°ï¼</th>
<th>Redis å»éï¼å±äº«ç¬è®°æ¬ï¼</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>éåº¦</strong></td>
<td>â¡ åéªçµä¸æ ·å¿«ï¼ç´æ¥è¯»åå­ï¼</td>
<td>ð å¾å¿«ï¼ä½éè¦ç½ç»ï¼</td>
</tr>
<tr>
<td><strong>å¯é æ§</strong></td>
<td>â ï¸ éå¯å°±å¿å</td>
<td>â æ°¸è¿è®°çï¼éå¯ä¹è¿å¨</td>
</tr>
<tr>
<td><strong>å¤å®ä¾</strong></td>
<td>â æ¯ä¸ªäººåè®°åç</td>
<td>â å¤§å®¶ä¸èµ·çåä¸æ¬ç¬è®°</td>
</tr>
<tr>
<td><strong>éº»ç¦ç¨åº¦</strong></td>
<td>ð¢ é¶ä¾èµï¼å¼ç®±å³ç¨</td>
<td>ð¡ éè¦é¨ç½² Redis</td>
</tr>
<tr>
<td><strong>éåè°</strong></td>
<td>ð  å¼åç¯å¢ãåæºè¿è¡</td>
<td>ð¢ çäº§ç¯å¢ãå¤å®ä¾é¨ç½²</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="åè®®å±æ¶æ¯çæéå·æ£æ¥">åè®®å±ï¼æ¶æ¯ç"æéå·æ£æ¥"</h2>
<h3 id="websocket-ç-seqid-æ¯ä»ä¹">WebSocket ç SeqID æ¯ä»ä¹ï¼</h3>
<p>é£ä¹¦ WebSocket ç¨çæ¯ ProtoBuf äºè¿å¶åè®®ï¼æ¯æ¡æ¶æ¯é½å¸¦çä¸ä¸ª<strong>éå¢çåºå·</strong>ï¼å°±åå»é¶è¡åäºæ¿çæéå·ãéè¿è®°ä½å·²ç»å¤çè¿çæéå·ï¼å°±è½å¨æ¶æ¯å±é¢å°±æéå¤çæ¡å¨å¤é¢ã</p>
<h4 id="seqid-å»éæä¹å·¥ä½">SeqID å»éæä¹å·¥ä½ï¼</h4>
<pre><code class="language-csharp">public interface IFeishuSeqIDDeduplicator
{
    /// &lt;summary&gt;
    /// å°è¯æ è®° SeqID ä¸ºå·²å¤ç
    /// &lt;/summary&gt;
    /// &lt;returns&gt;
    /// true: å·²å¤çè¿ï¼è·³è¿ï¼
    /// false: æ°æ¶æ¯ï¼ç»§ç»­å¤çï¼
    /// &lt;/returns&gt;
    bool TryMarkAsProcessed(ulong seqId);

    /// &lt;summary&gt;
    /// æ£æ¥ SeqID æ¯å¦å·²å¤ç
    /// &lt;/summary&gt;
    bool IsProcessed(ulong seqId);

    /// &lt;summary&gt;
    /// å¼æ­¥æ£æ¥ SeqID æ¯å¦å·²å¤ç
    /// &lt;/summary&gt;
    Task&lt;bool&gt; IsProcessedAsync(ulong seqId);

    /// &lt;summary&gt;
    /// æ¸ç©ºç¼å­
    /// &lt;/summary&gt;
    void ClearCache();

    /// &lt;summary&gt;
    /// è·åç¼å­ä¸­ç SeqID æ°é
    /// &lt;/summary&gt;
    int GetCacheCount();

    /// &lt;summary&gt;
    /// è·åå·²å¤ççæå¤§ SeqID
    /// &lt;/summary&gt;
    ulong GetMaxProcessedSeqId();
}
</code></pre>
<h4 id="å®ç°æºå¶">å®ç°æºå¶</h4>
<div class="mermaid">graph LR
    A[æ¶å°ProtoBufæ¶æ¯] --&gt; B{SeqIDæ£æ¥}
    B --&gt;|å·²å¤ç| C[è·³è¿æ¶æ¯]
    B --&gt;|æªå¤ç| D[è®°å½SeqID]
    D --&gt; E[å¤çæ¶æ¯]
    E --&gt; F[åéACKç¡®è®¤]
    D --&gt; G[æ´æ°æå¤§SeqID]
    G --&gt; H[å®æ¶æ¸çè¿æSeqID]
</div><h4 id="æ ¸å¿å®ç°">æ ¸å¿å®ç°</h4>
<p><strong>åå­å®ç°</strong>ï¼<code>FeishuSeqIDDeduplicator.cs</code>ï¼ï¼</p>
<pre><code class="language-csharp">public bool TryMarkAsProcessed(ulong seqId)
{
    lock (_lock)
    {
        // æ£æ¥æ¯å¦å·²å­å¨
        if (_processedSeqIds.Contains(seqId))
        {
            _logger?.LogDebug("SeqID {SeqId} å·²å¤çè¿ï¼è·³è¿", seqId);
            return true; // å·²å¤ç
        }

        // è®°å½æ° SeqID
        _processedSeqIds.Add(seqId);
        _seqIdTimestamps[seqId] = DateTimeOffset.UtcNow;

        // æ´æ°æå¤§ SeqID
        if (seqId &gt; _maxProcessedSeqId)
        {
            _maxProcessedSeqId = seqId;
        }

        return false; // æªå¤çï¼æ°æ¶æ¯
    }
}
</code></pre>
<p><strong>ä½¿ç¨ä½ç½®</strong>ï¼<code>BinaryMessageProcessor.cs#186-194</code>ï¼ï¼</p>
<pre><code class="language-csharp">// SeqID å»éæ£æ¥
if (_seqIdDeduplicator != null &amp;&amp; _seqIdDeduplicator.TryMarkAsProcessed(frame.SeqID))
{
    _logger.LogDebug("SeqID {SeqID} å·²å¤çè¿ï¼è·³è¿", frame.SeqID);
    eventArgs.SkipReason = $"SeqID {frame.SeqID} å·²å¤çè¿";
    BinaryMessageReceived?.Invoke(this, eventArgs);
    
    // ä»ç¶åéACKç¡®è®¤
    await SendAckMessageAsync(frame, true, cancellationToken);
    return;
}
</code></pre>
<h4 id="ç¹æ§æ»ç»">ç¹æ§æ»ç»</h4>
<ul>
<li>â <strong>åºäº HashSet é«ææ¥æ¾</strong>ï¼O(1) æ¥è¯¢å¤æåº¦</li>
<li>â <strong>èªå¨è·è¸ªæå¤§ SeqID</strong>ï¼æ¯æé¡ºåºæ§éªè¯</li>
<li>â <strong>24å°æ¶è¿ææºå¶</strong>ï¼å®ææ¸çåå²æ°æ®</li>
<li>â <strong>åå­åå¥½</strong>ï¼ä»å­å¨ SeqIDï¼ä¸å­å¨å®æ´æ¶æ¯</li>
</ul>
<h3 id="webhook-ç-nonceé²éæ¾æ»å»çç§å¯æ­¦å¨">Webhook ç Nonceï¼é²éæ¾æ»å»çç§å¯æ­¦å¨</h3>
<p>é£ä¹¦ Webhook çè¯·æ±éå¸¦æä¸ä¸ª <code>nonce</code>ï¼éæºæ°ï¼ï¼è¿å°±åä¸æ¬¡æ§å¯ç ââç¨è¿çå¯ç å°±ä¸è½åç¨äºï¼è¿æ ·å°±è½é²æ­¢"éæ¾æ»å»"ï¼åäººæ¿åä¸ä¸ªè¯·æ±éå¤åéï¼ã</p>
<h4 id="é²éæ¾æ»å»æµç¨">é²éæ¾æ»å»æµç¨</h4>
<pre><code>æ»å»èå°è¯éæ¾è¯·æ±ï¼
âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ
åå§è¯·æ±ï¼Nonce="abc123", Timestamp="1234567890"
â æ­£å¸¸å¤çï¼é¦æ¬¡æ¥æ¶ï¼

éæ¾è¯·æ±ï¼Nonce="abc123", Timestamp="1234567890"
â æç»å¤çï¼Nonce å·²è®°å½ï¼
âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ
</code></pre>
<h4 id="redis-å®ç°">Redis å®ç°</h4>
<pre><code class="language-csharp">public class RedisFeishuNonceDistributedDeduplicator : IFeishuNonceDistributedDeduplicator
{
    private readonly IDatabase _database;
    private readonly TimeSpan _defaultTtl = TimeSpan.FromMinutes(5); // 5åéè¿æ

    public async Task&lt;bool&gt; TryMarkAsProcessedAsync(string nonce, CancellationToken cancellationToken = default)
    {
        var redisKey = $"{_keyPrefix}{nonce}";

        // SETNX + EXPIREï¼5åéåéå¤ nonce ä¼è¢«æç»
        var setResult = await _database.StringSetAsync(
            redisKey,
            "1",
            _defaultTtl,
            When.NotExists);

        if (!setResult)
        {
            _logger?.LogWarning("æ£æµå°éå¤ç Nonce: {Nonce}ï¼å¯è½ä¸ºéæ¾æ»å»", nonce);
            return true; // å·²å¤çï¼æç»
        }

        return false; // é¦æ¬¡å¤ç
    }
}
</code></pre>
<hr>
<h2 id="åºç¨å±ç»æ¯ä¸ªä¸å¡æä½åèº«ä»½è¯">åºç¨å±ï¼ç»æ¯ä¸ªä¸å¡æä½å"èº«ä»½è¯"</h2>
<h3 id="ä¸ºä»ä¹è¿éè¦è¿ä¸å±">ä¸ºä»ä¹è¿éè¦è¿ä¸å±ï¼</h3>
<p>å°±ç®åé¢ä¸¤å±é½æ¡ä½äºï¼ä¸å¡é»è¾è¿æ¯æå¯è½éå¤æ§è¡ï¼æ¯å¦ï¼</p>
<ul>
<li>ð åä¸äºä»¶è§¦åäºå¤ä¸ªå¤çå¨ï¼å¹¶è¡å¤çï¼</li>
<li>ð å¤çå¨åé¨å¤æ¬¡è®¿é®åä¸ä¸ªèµæº</li>
<li>ð¡ ç¬¬ä¸æ¹æ¥å£éè¯å¯¼è´éå¤è°ç¨</li>
</ul>
<h3 id="å®éçå¹ç­æ§å®ç°æ¹å¼">å®éçå¹ç­æ§å®ç°æ¹å¼</h3>
<p>å¨å®éç Mud.Feishu SDK ä¸­ï¼ä¸å¡å±å¹ç­æ§ä¸»è¦éè¿ä»¥ä¸ä¸¤ç§æ¹å¼å®ç°ï¼</p>
<p><strong>æ¹å¼1ï¼ä½¿ç¨ <code>DefaultFeishuObjectEventHandler&lt;T&gt;</code>ï¼æ¨èï¼</strong><br>
SDK æä¾äº <code>DefaultFeishuObjectEventHandler&lt;T&gt;</code> åºç±»ï¼ä¸é¨ç¨äºå¤çå¯¹è±¡ç±»åçäºä»¶ãä½ åªéè¦ç»§æ¿è¿ä¸ªåºç±»ï¼å¹¶å¨ä¸å¡é»è¾ä¸­æ£æ¥æ°æ®æ¯å¦å·²å­å¨å³å¯ã</p>
<p><strong>æ¹å¼2ï¼ä½¿ç¨ <code>IdempotentFeishuEventHandler&lt;T&gt;</code></strong><br>
SDK è¿æä¾äºä¸ä¸ª <code>IdempotentFeishuEventHandler&lt;T&gt;</code> åºç±»ï¼æä¾äºåºäºä¸å¡é®çèªå¨å»éè½åãä½ éè¦éå <code>GetBusinessKey()</code> æ¹æ³å <code>HandleEventInternalAsync()</code> æ¹æ³ï¼åºç±»ä¼èªå¨å¤çä¸å¡å»éã</p>
<hr>
<h3 id="ææææä½ ç¨ä¸ä¸ªå®éæ¡ä¾">ææææä½ ç¨ï¼ä¸ä¸ªå®éæ¡ä¾</h3>
<h4 id="æ¡ä¾-1æ¶æ¯å¤çé²æ­¢éå¤åå»ºå¾å">æ¡ä¾ 1ï¼æ¶æ¯å¤çââé²æ­¢éå¤åå»ºå¾å</h4>
<pre><code class="language-csharp">public class MessageEventHandler : DefaultFeishuObjectEventHandler&lt;MessageReceiveResult&gt;
{
    private readonly IMessageService _messageService;

    public MessageEventHandler(
        ILogger&lt;MessageEventHandler&gt; logger,
        IMessageService messageService)
        : base(logger)
    {
        _messageService = messageService;
    }

    protected override async Task ProcessBusinessLogicAsync(
        EventData eventData,
        ObjectEventResult&lt;MessageReceiveResult&gt;? messageData,
        CancellationToken cancellationToken = default)
    {
        if (eventData == null)
            throw new ArgumentNullException(nameof(eventData));

        // æ£æ¥æ¶æ¯æ¯å¦å·²å¤çï¼ä¸å¡å±å¹ç­æ§ï¼
        var messageId = messageData?.Object.MessageId;
        if (string.IsNullOrEmpty(messageId))
        {
            _logger.LogWarning("æ¶æ¯IDä¸ºç©ºï¼è·³è¿å¤ç");
            return;
        }

        var alreadyProcessed = await _messageService.IsMessageProcessedAsync(messageId, cancellationToken);
        if (alreadyProcessed)
        {
            _logger.LogInformation("æ¶æ¯ {MessageId} å·²å¤çï¼è·³è¿", messageId);
            return;
        }

        // å¤çæ¶æ¯
        await _messageService.ProcessMessageAsync(messageData!.Object, cancellationToken);
    }
}
</code></pre>
<h4 id="æ¡ä¾-2é¨é¨å¤çé¿åéå¤åå»º">æ¡ä¾ 2ï¼é¨é¨å¤çââé¿åéå¤åå»º</h4>
<pre><code class="language-csharp">public class DepartmentCreatedEventHandler : DefaultFeishuObjectEventHandler&lt;DepartmentCreatedResult&gt;
{
    private readonly IDepartmentService _departmentService;

    public DepartmentCreatedEventHandler(
        ILogger&lt;DepartmentCreatedEventHandler&gt; logger,
        IDepartmentService departmentService)
        : base(logger)
    {
        _departmentService = departmentService;
    }

    protected override async Task ProcessBusinessLogicAsync(
        EventData eventData,
        ObjectEventResult&lt;DepartmentCreatedResult&gt;? departmentData,
        CancellationToken cancellationToken = default)
    {
        if (eventData == null)
            throw new ArgumentNullException(nameof(eventData));

        if (departmentData?.Object == null)
        {
            _logger.LogWarning("é¨é¨æ°æ®ä¸ºç©ºï¼è·³è¿å¤ç");
            return;
        }

        // æ£æ¥é¨é¨æ¯å¦å·²å­å¨ï¼ä¸å¡å±å¹ç­æ§ï¼
        var departmentId = departmentData.Object.DepartmentId;
        var exists = await _departmentService.ExistsAsync(departmentId, cancellationToken);

        if (exists)
        {
            _logger.LogInformation("é¨é¨ {DepartmentId} å·²å­å¨ï¼è·³è¿åå»º", departmentId);
            return;
        }

        // åå»ºé¨é¨
        await _departmentService.CreateAsync(departmentData.Object, cancellationToken);
    }
}
</code></pre>
<h4 id="æ¡ä¾-3ç¨æ·åå»ºé¿åéå¤æ³¨å">æ¡ä¾ 3ï¼ç¨æ·åå»ºââé¿åéå¤æ³¨å</h4>
<pre><code class="language-csharp">public class UserCreatedEventHandler : DefaultFeishuObjectEventHandler&lt;UserCreatedResult&gt;
{
    private readonly IUserService _userService;

    public UserCreatedEventHandler(
        ILogger&lt;UserCreatedEventHandler&gt; logger,
        IUserService userService)
        : base(logger)
    {
        _userService = userService;
    }

    protected override async Task ProcessBusinessLogicAsync(
        EventData eventData,
        ObjectEventResult&lt;UserCreatedResult&gt;? userData,
        CancellationToken cancellationToken = default)
    {
        if (eventData == null)
            throw new ArgumentNullException(nameof(eventData));

        if (userData?.Object == null)
        {
            _logger.LogWarning("ç¨æ·æ°æ®ä¸ºç©ºï¼è·³è¿å¤ç");
            return;
        }

        // æ£æ¥ç¨æ·æ¯å¦å·²å­å¨ï¼ä¸å¡å±å¹ç­æ§ï¼
        var userId = userData.Object.UserId;
        var exists = await _userService.ExistsAsync(userId, cancellationToken);

        if (exists)
        {
            _logger.LogInformation("ç¨æ· {UserId} å·²å­å¨ï¼è·³è¿åå»º", userId);
            return;
        }

        // åå»ºç¨æ·
        await _userService.CreateAsync(userData.Object, cancellationToken);
    }
}
</code></pre>
<h3 id="æä¹è®¾è®¡ä¸å¡é®æå¥è·¯å">æä¹è®¾è®¡ä¸å¡é®ï¼æå¥è·¯åï¼</h3>
<table>
<thead>
<tr>
<th>ä¸å¡åºæ¯</th>
<th>ä¸å¡é®é¿ä»ä¹æ ·ï¼</th>
<th>ä¸ºä»ä¹è¿ä¹è®¾è®¡ï¼</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ¶å°æ¶æ¯</td>
<td><code>im.message.receive_v1:om_xxxxxxxxxx</code></td>
<td>äºä»¶ç±»å + æ¶æ¯IDï¼ä¸ç¼çåºæ¯åªæ¡æ¶æ¯</td>
</tr>
<tr>
<td>åå»ºé¨é¨</td>
<td><code>contact.department.created_v3:od_xxxxxxxxxx</code></td>
<td>äºä»¶ç±»å + é¨é¨IDï¼é¿ååå¶ä»IDå²çª</td>
</tr>
<tr>
<td>åå»ºç¨æ·</td>
<td><code>contact.user.created_v3:ou_xxxxxxxxxx</code></td>
<td>äºä»¶ç±»å + ç¨æ·IDï¼å¯ä¸æ è¯ç¨æ·</td>
</tr>
<tr>
<td>å é¤é¨é¨</td>
<td><code>contact.department.deleted_v3:od_xxxxxxxxxx</code></td>
<td>äºä»¶ç±»å + é¨é¨IDï¼å¤çå é¤äºä»¶</td>
</tr>
<tr>
<td>æ¶æ¯å·²è¯»</td>
<td><code>im.message.message_read_v1:ou_xxxxxxxxxx:om_xxxxxxxxxx</code></td>
<td>äºä»¶ç±»å + ç¨æ·ID + æ¶æ¯ID</td>
</tr>
</tbody>
</table>
<p><strong>åæ¡é»éæ³å</strong>ï¼</p>
<ol>
<li>ð <strong>å¯ä¸æ§</strong>ï¼ä¸ä¸ªæä½å¯¹åºä¸ä¸ªé®ï¼ä¸è½æä¸¤ä¸ªæä½æè½¦</li>
<li>ð <strong>å¯è¯»æ§</strong>ï¼çæ¥å¿æ¶è½å¿«éç¥éè¿æ¯ä»ä¹</li>
<li>ð§± <strong>ç¨³å®æ§</strong>ï¼å«ç¨æ¶é´æ³è¿ç§ä¼åçå­æ®µåé®</li>
<li>âï¸ <strong>ç®æ´æ§</strong>ï¼å«åå¤ªé¿ï¼çåå­ãå¥½æ¥è¯¢</li>
</ol>
<hr>
<h2 id="éç½®å®æå¼å-vs-çäº§ç¯å¢">éç½®å®æï¼å¼å vs çäº§ç¯å¢</h2>
<h3 id="websocket-æä¹éç½®">WebSocket æä¹éç½®ï¼</h3>
<pre><code class="language-csharp">// ä½¿ç¨å»ºé èæ¨¡å¼éç½® WebSocket
builder.Services.AddFeishuWebSocketServiceBuilder(configuration)
    .ConfigureOptions(options =&gt;
    {
        // äºä»¶å»ééç½®
        options.EnableEventDeduplication = true;           // å¯ç¨äºä»¶å»é
        options.EnableDistributedDeduplication = false;    // åæºåºæ¯ä½¿ç¨åå­å»é
        options.EventDeduplicationCacheExpirationMs = 86400000;  // 24å°æ¶è¿æ
        options.EventDeduplicationCleanupIntervalMs = 300000;    // 5åéæ¸çé´é
    });
</code></pre>
<h4 id="çäº§ç¯å¢å¿å¤éç½®ä¸å®è¦ç">çäº§ç¯å¢å¿å¤éç½®ï¼ä¸å®è¦çï¼ï¼</h4>
<pre><code class="language-csharp">// 1. éç½® Redisï¼å¨ appsettings.json ä¸­ï¼
// {
//   "Feishu": {
//     "Redis": {
//       "ConnectionString": "your-redis-server"
//     }
//   }
// }

// 2. æ³¨å Redis æå¡åå»éæå¡
builder.Services
    .AddFeishuRedis()
    .AddFeishuRedisDeduplicators();

// 3. å¯ç¨åå¸å¼å»é
builder.Services.AddFeishuWebSocketServiceBuilder(configuration)
    .ConfigureOptions(options =&gt;
    {
        options.EnableDistributedDeduplication = true;   // å¯ç¨åå¸å¼å»é
        options.EventDeduplicationCacheExpirationMs = 86400000;  // 24å°æ¶
    });
</code></pre>
<h3 id="webhook-éç½®">Webhook éç½®</h3>
<pre><code class="language-csharp">// æ³¨å Webhook æå¡
builder.Services.AddFeishuWebhookServiceBuilder(configuration)
    .ConfigureOptions(options =&gt;
    {
        options.VerificationToken = "your_verification_token";
        options.EncryptKey = "your_encrypt_key";
        options.EventHandlingTimeoutMs = 30000;          // 30ç§è¶æ¶
        options.MaxConcurrentEvents = 10;                // æå¤§å¹¶åæ°
    });

// æ³¨å Redis å»é
builder.Services
    .AddFeishuRedis()
    .AddFeishuRedisEventDeduplicator();
</code></pre>
<h3 id="ä¸å¼ è¡¨çæå¼åä¸çäº§çåºå«">ä¸å¼ è¡¨çæå¼åä¸çäº§çåºå«</h3>
<table>
<thead>
<tr>
<th>éç½®é¡¹</th>
<th>å¼åç¯å¢</th>
<th>çäº§ç¯å¢</th>
<th>è¯´æ</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>EnableEventDeduplication</code></td>
<td><code>true</code></td>
<td><code>true</code></td>
<td>å§ç»å¯ç¨åå­å»é</td>
</tr>
<tr>
<td><code>EnableDistributedDeduplication</code></td>
<td><code>false</code></td>
<td><code>true</code></td>
<td>çäº§ç¯å¢å¯ç¨Rediså»é</td>
</tr>
<tr>
<td><code>EventDeduplicationCacheExpirationMs</code></td>
<td><code>3600000</code> (1å°æ¶)</td>
<td><code>86400000</code> (24å°æ¶)</td>
<td>çäº§ç¯å¢å»¶é¿çªå£æ</td>
</tr>
<tr>
<td><code>EventDeduplicationCleanupIntervalMs</code></td>
<td><code>60000</code> (1åé)</td>
<td><code>300000</code> (5åé)</td>
<td>çäº§ç¯å¢éä½æ¸çé¢ç</td>
</tr>
</tbody>
</table>
<h3 id="å®æ´éç½®ä»é¶å°ä¸çº¿ä¸æ¬¡æå®">å®æ´éç½®ï¼ä»é¶å°ä¸çº¿ä¸æ¬¡æå®</h3>
<pre><code class="language-csharp">public void ConfigureServices(IServiceCollection services)
{
    // éç½® Redisï¼appsettings.json ä¸­éç½®ï¼
    services
        .AddFeishuRedis()
        .AddFeishuRedisDeduplicators();

    // æ³¨å WebSocket æå¡
    services.AddFeishuWebSocketServiceBuilder(configuration)
        .ConfigureOptions(wsOptions =&gt;
        {
            wsOptions.EnableEventDeduplication = true;
            wsOptions.EnableDistributedDeduplication = true;
            wsOptions.EventDeduplicationCacheExpirationMs = 86400000;
            wsOptions.AutoReconnect = true;
            wsOptions.MaxReconnectAttempts = 5;
            wsOptions.HeartbeatIntervalMs = 30000;
        })
        .AddHandler&lt;MessageEventHandler&gt;()
        .AddHandler&lt;DepartmentCreatedEventHandler&gt;()
        .Build();

    // æ³¨å Webhook æå¡
    services.AddFeishuWebhookServiceBuilder(configuration)
        .ConfigureOptions(webhookOptions =&gt;
        {
            webhookOptions.VerificationToken = "your_token";
            webhookOptions.EncryptKey = "your_key";
            webhookOptions.EventHandlingTimeoutMs = 30000;
            webhookOptions.MaxConcurrentEvents = 20;
        })
        .AddHandler&lt;UserCreatedEventHandler&gt;()
        .Build();
}
</code></pre>
<h3 id="è¿æä¸ªè´´å¿åè½éç½®éè¯¯èªå¨æé">è¿æä¸ªè´´å¿åè½ï¼éç½®éè¯¯èªå¨æé</h3>
<p>SDK ä¼èªå¨æ£æ¥éç½®ï¼å¦æä½ æå»éåè½å¨å³äºï¼å®ä¼ç´æ¥æ¥éæéä½ ï¼</p>
<pre><code class="language-csharp">// FeishuWebSocketOptions.Validate() èªå¨æ§è¡
// SDK ä¼å¨æå¡å¯å¨æ¶æ£æ¥éç½®ï¼å¦æå»éåè½å¨å³é­ä¼æåºè­¦å
</code></pre>
<hr>
<h2 id="è¸©åæåäºä¸ªå¸¸è§é®é¢åè§£å³æ¹æ¡">è¸©åæåï¼äºä¸ªå¸¸è§é®é¢åè§£å³æ¹æ¡</h2>
<h3 id="é®é¢-1æå¡éå¯éå¤äºä»¶åæ¥äº">é®é¢ 1ï¼æå¡éå¯ï¼éå¤äºä»¶åæ¥äº</h3>
<p><strong>ç°åºæ¯è¿æ ·ç</strong>ï¼</p>
<p><strong>ç°è±¡</strong>ï¼</p>
<pre><code>09:00 æå¡æ¥æ¶ EventId="evt_123" â å¤çæå
09:05 æå¡éå¯ï¼åå­ç¼å­æ¸ç©ºï¼
09:06 é£ä¹¦éå EventId="evt_123" â éå¤å¤ç
</code></pre>
<p><strong>ä¸ºä»ä¹ï¼</strong></p>
<ul>
<li>ð§  åå­å»éå°±åç­æè®°å¿ï¼éå¯å°±å¿åäº</li>
<li>ð¡ é£ä¹¦æ²¡æ¶å°ä½ çç¡®è®¤ï¼ä»¥ä¸ºä½ æ²¡æ¶å°ï¼ç»§ç»­å</li>
</ul>
<p><strong>æä¹è§£å³ï¼</strong></p>
<p>â <strong>æ¹æ¡1ï¼å¯ç¨ Redis åå¸å¼å»éï¼æ¨èï¼</strong></p>
<pre><code class="language-csharp">// éç½® Redisï¼appsettings.json ä¸­éç½®è¿æ¥ä¿¡æ¯ï¼
services
    .AddFeishuRedis()
    .AddFeishuRedisDeduplicators();

services.AddFeishuWebSocketServiceBuilder(configuration)
    .ConfigureOptions(options =&gt;
    {
        options.EnableDistributedDeduplication = true; // ä½¿ç¨Redis
        options.EnableEventDeduplication = false;    // ç¦ç¨åå­å»é
    });
</code></pre>
<p>â <strong>æ¹æ¡2ï¼å®ç°å»éç¶ææä¹å</strong></p>
<pre><code class="language-csharp">public class PersistentEventDeduplicator : IFeishuEventDeduplicator
{
    private readonly IDatabase _database;

    public bool TryMarkAsProcessing(string eventId)
    {
        // å°è¯åå¥æ°æ®åº
        var exists = _database.EventExists(eventId);
        if (!exists)
        {
            _database.MarkProcessing(eventId);
            return false;
        }
        return true;
    }
}
</code></pre>
<hr>
<h3 id="é®é¢-2å¤å®ä¾ä¸èµ·è·éå¤å¤çæ¡ä¸ä½">é®é¢ 2ï¼å¤å®ä¾ä¸èµ·è·ï¼éå¤å¤çæ¡ä¸ä½</h3>
<p><strong>ç°åºæ¯è¿æ ·ç</strong>ï¼</p>
<pre><code>å®ä¾A å å®ä¾B åæ¶å¯å¨
é£ä¹¦æ¨é EventId="evt_123"
å®ä¾A æ¶å° â å¤ç â
å®ä¾B æ¶å° â å¤ç â (éå¤ï¼)
</code></pre>
<p><strong>ä¸ºä»ä¹ï¼</strong></p>
<ul>
<li>ð§  æ¯ä¸ªå®ä¾é½æèªå·±ç¬ç«ç"å°æ¬æ¬"</li>
<li>ð« å®ä¾ä¹é´äºç¸çä¸å°å¯¹æ¹çè®°å½</li>
</ul>
<p><strong>æä¹è§£å³ï¼</strong></p>
<p>â <strong>å¿é¡»ä½¿ç¨ Redis åå¸å¼å»é</strong></p>
<pre><code class="language-csharp">// ææå®ä¾è¿æ¥å°åä¸ä¸ª Redisï¼å¨éç½®æä»¶ä¸­éç½®ï¼
services
    .AddFeishuRedis()
    .AddFeishuRedisDeduplicators();

services.AddFeishuWebSocketServiceBuilder(configuration)
    .ConfigureOptions(options =&gt;
    {
        options.EnableDistributedDeduplication = true;
    });
</code></pre>
<p><strong>ä¸å¼ å¾çæåºå«</strong>ï¼</p>
<div class="mermaid">graph TB
    subgraph Wrong["â éè¯¯æ¶æï¼åå­å»éï¼"]
        A1["å®ä¾A&lt;br/&gt;åå­ç¼å­A&lt;br/&gt;evt_123 â"]
        A2["å®ä¾B&lt;br/&gt;åå­ç¼å­B&lt;br/&gt;evt_123 â"]
    end

    subgraph Right["â æ­£ç¡®æ¶æï¼Rediså»éï¼"]
        B1["å®ä¾A"]
        B2["å®ä¾B"]
        Redis["Redis å»é&lt;br/&gt;evt_123 â"]
    end

    B1 --&gt; Redis
    B2 --&gt; Redis

    style Wrong fill:#ffebee
    style Right fill:#e8f5e9
    style Redis fill:#e3f2fd
</div><hr>
<h3 id="é®é¢-3å¤çè¶æ¶éå¤äºä»¶è¶èèå¥">é®é¢ 3ï¼å¤çè¶æ¶ï¼éå¤äºä»¶è¶èèå¥</h3>
<p><strong>ç°åºæ¯è¿æ ·ç</strong>ï¼</p>
<pre><code>09:00 å¼å§å¤ç EventId="evt_123"
09:01 å¤çè¶æ¶ï¼è¶æ¶30ç§ï¼
09:01 åæ» Processing ç¶æ
09:02 é£ä¹¦éå EventId="evt_123"
09:02 éå¤å¤ç â (å®éå·²æåï¼)
</code></pre>
<p><strong>ä¸ºä»ä¹ï¼</strong></p>
<ul>
<li>â±ï¸ è¶æ¶åç³»ç»ä»¥ä¸ºæ²¡å®æï¼æ"å¤çä¸­"æ è®°æ¤åäº</li>
<li>â ä½ä¸å¡å¯è½å·²ç»åå®äºï¼åªæ¯ååºæ¢äºä¸ç¹ç¹</li>
</ul>
<p><strong>æä¹è§£å³ï¼</strong></p>
<p>â <strong>æ¹æ¡1ï¼å¢å æç»ä¸è´æ§æ£æ¥</strong></p>
<pre><code class="language-csharp">public class DepartmentCreatedEventHandler : DefaultFeishuObjectEventHandler&lt;DepartmentCreatedResult&gt;
{
    private readonly IDepartmentService _departmentService;

    protected override async Task ProcessBusinessLogicAsync(
        EventData eventData,
        ObjectEventResult&lt;DepartmentCreatedResult&gt;? departmentData,
        CancellationToken ct)
    {
        if (departmentData?.Object == null)
            return;

        var departmentId = departmentData.Object.DepartmentId;

        // åæ£æ¥é¨é¨æ¯å¦å·²å­å¨ï¼å¹ç­æ§ï¼
        var existingDepartment = await _departmentService.GetAsync(departmentId, ct);
        if (existingDepartment != null)
        {
            _logger.LogInformation("é¨é¨ {DepartmentId} å·²å­å¨ï¼è·³è¿åå»º", departmentId);
            return;
        }

        // åå»ºé¨é¨
        await _departmentService.CreateAsync(departmentData.Object, ct);
    }
}
</code></pre>
<p>â <strong>æ¹æ¡2ï¼å®ç°å¤çç»­ææºå¶</strong></p>
<pre><code class="language-csharp">public class LongRunningTaskHandler : DefaultFeishuEventHandler
{
    private readonly IFeishuEventDeduplicator _deduplicator;

    protected override async Task ProcessBusinessLogicAsync(EventData eventData, CancellationToken ct)
    {
        var eventId = eventData.EventId;

        // å®æç»­æå¤çæ¶é´ï¼æ¯30ç§ï¼
        var renewalTask = Task.Run(async () =&gt;
        {
            while (!ct.IsCancellationRequested)
            {
                await Task.Delay(30000, ct);
                _deduplicator.RenewProcessing(eventId);
            }
        }, ct);

        try
        {
            await ProcessLongRunningTask(eventData, ct);
        }
        finally
        {
            await renewalTask;
        }
    }
}
</code></pre>
<hr>
<h3 id="é®é¢-4redis-å®æºå»éé²æ¤å¨å¤±æ">é®é¢ 4ï¼Redis å®æºï¼å»éé²æ¤å¨å¤±æ</h3>
<p><strong>ç°åºæ¯è¿æ ·ç</strong>ï¼</p>
<pre><code>Redis å®æº
æå¡æ æ³è°ç¨ TryMarkAsProcessedAsync()
è¿å falseï¼åè®¸å¤çï¼
å¤ä¸ªå®ä¾éå¤å¤çåä¸äºä»¶ â
</code></pre>
<p><strong>ä¸ºä»ä¹ï¼</strong></p>
<ul>
<li>ð« Redis æäºï¼ä»£ç ä¸ºäºä¸é»å¡éæ©"åè®¸å¤ç"</li>
<li>â ç»æéå¤äºä»¶å¨æ¶è¿æ¥</li>
</ul>
<p><strong>æä¹è§£å³ï¼</strong></p>
<p>â <strong>æ¹æ¡1ï¼å®ç°éçº§å°åå­å»é</strong></p>
<pre><code class="language-csharp">public class HybridEventDeduplicator : IFeishuEventDeduplicator
{
    private readonly IFeishuEventDistributedDeduplicator _redis;
    private readonly IFeishuEventDeduplicator _memory;

    public bool TryMarkAsProcessing(string eventId)
    {
        try
        {
            // ä¼åä½¿ç¨ Redis
            return _redis.TryMarkAsProcessedAsync(eventId).GetAwaiter().GetResult();
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Rediså»éå¤±è´¥ï¼éçº§å°åå­å»é");
            // éçº§å°åå­å»é
            return _memory.TryMarkAsProcessing(eventId);
        }
    }
}
</code></pre>
<p>â <strong>æ¹æ¡2ï¼éç½®çæ­æºå¶</strong></p>
<pre><code class="language-csharp">public class CircuitBreakerEventDeduplicator : IFeishuEventDeduplicator
{
    private readonly CircuitBreaker _circuitBreaker;
    private int _failureCount;
    private DateTime _lastFailureTime;

    public bool TryMarkAsProcessing(string eventId)
    {
        if (_circuitBreaker.IsOpen())
        {
            _logger.LogWarning("Rediså»éçæ­ï¼æç»å¤ç");
            return true; // æç»å¤çï¼ä¿æ¤ä¸æ¸¸
        }

        try
        {
            var result = _redis.TryMarkAsProcessedAsync(eventId).GetAwaiter().GetResult();
            _circuitBreaker.RecordSuccess();
            return result;
        }
        catch (Exception ex)
        {
            _circuitBreaker.RecordFailure();
            throw;
        }
    }
}
</code></pre>
<hr>
<h3 id="é®é¢-5ç¼å­è¶ç§¯è¶å¤åå­å¿«çäº">é®é¢ 5ï¼ç¼å­è¶ç§¯è¶å¤ï¼åå­å¿«çäº</h3>
<p><strong>ç°åºæ¯è¿æ ·ç</strong>ï¼</p>
<pre><code>æå¡è¿è¡24å°æ¶
å»éç¼å­æ¡ç®ï¼100ä¸+
åå­å ç¨ï¼è¶è¿500MB
GCååå¢å¤§ï¼æ§è½ä¸é
</code></pre>
<p><strong>ä¸ºä»ä¹ï¼</strong></p>
<ul>
<li>ð é«é¢äºä»¶ï¼æ¯å¦æ¥æ¶æ¶æ¯ï¼ä¸å¤©è½äº§çå åä¸æ¡è®°å½</li>
<li>ð æ¸çé´éå¤ªé¿ï¼æ§è®°å½å ç§¯å¦å±±</li>
</ul>
<p><strong>æä¹è§£å³ï¼</strong></p>
<p>â <strong>æ¹æ¡1ï¼ç¼©ç­ç¼å­è¿ææ¶é´</strong></p>
<pre><code class="language-csharp">services.AddFeishuWebSocketServiceBuilder(configuration)
    .ConfigureOptions(options =&gt;
    {
        // æ ¹æ®å®éä¸å¡è°æ´
        options.EventDeduplicationCacheExpirationMs = 3600000;  // ç¼©ç­ä¸º1å°æ¶
        options.EventDeduplicationCleanupIntervalMs = 60000;    // æé«æ¸çé¢çä¸º1åé
    });
</code></pre>
<p>â <strong>æ¹æ¡2ï¼ä½¿ç¨ LRU ç¼å­</strong></p>
<pre><code class="language-csharp">public class LRUEventDeduplicator : IFeishuEventDeduplicator
{
    private readonly LRUCache&lt;string, EventCacheEntry&gt; _cache;
    private const int MaxCacheSize = 10000; // æå¤ä¿ç1ä¸æ¡

    public LRUEventDeduplicator()
    {
        _cache = new LRUCache&lt;string, EventCacheEntry&gt;(MaxCacheSize);
    }

    public bool TryMarkAsProcessing(string eventId)
    {
        if (_cache.TryGetValue(eventId, out var entry))
            return true;

        _cache.Add(eventId, new EventCacheEntry { /* ... */ });
        return false;
    }
}
</code></pre>
<p>â <strong>æ¹æ¡3ï¼ä¸å¡å±ä¼å</strong></p>
<pre><code class="language-csharp">// æäºé«é¢äºä»¶ä¸éè¦å»é
public class SystemEventHandler : DefaultFeishuEventHandler
{
    // ä¸ç»§æ¿ IdempotentFeishuEventHandler
    // ç´æ¥å¤çï¼åå°ä¸å¡å±å»éåå

    protected override Task ProcessBusinessLogicAsync(EventData eventData, CancellationToken ct)
    {
        // ä»è®°å½æ¥å¿ï¼ä¸è¿è¡ä¸å¡æä½
        _logger.LogInformation("ç³»ç»äºä»¶ï¼{EventType}", eventData.EventType);
        return Task.CompletedTask;
    }
}
</code></pre>
<hr>
<h2 id="ç»ç³»ç»åä½æ£çæ§ä¸è°è¯">ç»ç³»ç»åä½æ£ï¼çæ§ä¸è°è¯</h2>
<h3 id="ééä»ä¹æ°æ®æææ">ééä»ä¹æ°æ®æææï¼</h3>
<pre><code class="language-csharp">public class DeduplicatorMetrics
{
    public long TotalProcessed { get; set; }
    public long DuplicateSkipped { get; set; }
    public long ProcessingTimeout { get; set; }
    public long CacheHitCount { get; set; }
    public long CacheMissCount { get; set; }

    public double DuplicateRate =&gt; 
        TotalProcessed &gt; 0 ? (double)DuplicateSkipped / TotalProcessed : 0;

    public double CacheHitRate =&gt;
        (CacheHitCount + CacheMissCount) &gt; 0 
            ? (double)CacheHitCount / (CacheHitCount + CacheMissCount) 
            : 0;
}
</code></pre>
<h3 id="æ´é²ä¸ä¸ªæ¥å£éæ¶æ¥çå¥åº·ç¶æ">æ´é²ä¸ä¸ªæ¥å£ï¼éæ¶æ¥çå¥åº·ç¶æ</h3>
<pre><code class="language-csharp">[ApiController]
[Route("api/[controller]")]
public class DeduplicatorController : ControllerBase
{
    private readonly IFeishuEventDeduplicator _deduplicator;

    [HttpGet("stats")]
    public ActionResult&lt;DeduplicatorStats&gt; GetStats()
    {
        return Ok(new DeduplicatorStats
        {
            CacheCount = _deduplicator.GetCacheCount(),
            MaxProcessedSeqId = _seqIdDeduplicator?.GetMaxProcessedSeqId(),
            DuplicateRate = _metrics.DuplicateRate,
            CacheHitRate = _metrics.CacheHitRate
        });
    }

    [HttpGet("check/{eventId}")]
    public ActionResult&lt;bool&gt; CheckEventId(string eventId)
    {
        var isProcessed = _deduplicator.IsProcessed(eventId);
        return Ok(new { eventId, isProcessed });
    }
}
</code></pre>
<h3 id="æ¥å¿æä¹åæå®¹æææ¥é®é¢">æ¥å¿æä¹åæå®¹æææ¥é®é¢ï¼</h3>
<pre><code class="language-csharp">public class EnhancedEventDeduplicator : IFeishuEventDeduplicator
{
    private readonly ILogger&lt;EnhancedEventDeduplicator&gt; _logger;

    public bool TryMarkAsProcessing(string eventId)
    {
        lock (_lock)
        {
            if (_eventCache.TryGetValue(eventId, out var entry))
            {
                // è¯¦ç»è®°å½å»éå½ä¸­åå 
                _logger.LogInformation(
                    "[Deduplication] EventId={EventId} å·²å¤çï¼" +
                    "Status={Status}, ProcessedAt={ProcessedAt}",
                    eventId,
                    entry.Status,
                    entry.ProcessedAt);

                return true;
            }

            _logger.LogDebug("[Deduplication] EventId={EventId} æ°äºä»¶", eventId);
            // ...
            return false;
        }
    }
}
</code></pre>
<hr>
<h2 id="å¿«éåé¡¾ä¸è¡å¨æ¸å">å¿«éåé¡¾ä¸è¡å¨æ¸å</h2>
<h3 id="ä¸å±é²æ¤ä¸è¡¨è§">ä¸å±é²æ¤ä¸è¡¨è§</h3>
<table>
<thead>
<tr>
<th>å»éå±çº§</th>
<th>å»éä¾æ®</th>
<th>å®ç°æ¹å¼</th>
<th>æ¨èéç½®</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>åè®®å±</strong></td>
<td>SeqID / Nonce</td>
<td><code>IFeishuSeqIDDeduplicator</code> / <code>IFeishuNonceDistributedDeduplicator</code></td>
<td>å§ç»å¯ç¨</td>
</tr>
<tr>
<td><strong>ååå±</strong></td>
<td>EventId</td>
<td><code>IFeishuEventDeduplicator</code> / <code>IFeishuEventDistributedDeduplicator</code></td>
<td>çäº§ç¯å¢å¯ç¨ Redis</td>
</tr>
<tr>
<td><strong>åºç¨å±</strong></td>
<td>æ°æ®å­å¨æ§æ£æ¥</td>
<td><code>DefaultFeishuObjectEventHandler&lt;T&gt;</code> ä¸­çä¸å¡é»è¾</td>
<td>æéå®ç°</td>
</tr>
</tbody>
</table>
<h3 id="è¿æ³äºè§£æ´å¤">è¿æ³äºè§£æ´å¤ï¼</h3>
<ul>
<li>ð <a href="https://open.feishu.cn/document/server-docs/event-subscription-guide/overview" target="_blank" rel="noopener nofollow">é£ä¹¦å®æ¹ææ¡£ï¼äºä»¶è®¢é</a></li>
<li>ð» <a href="https://github.com/mudtools/MudFeishu" target="_blank" rel="noopener nofollow">MudFeishu GitHub ä»åº</a></li>
<li>ð» <a href="https://gitee.com/mudtools/MudFeishu" target="_blank" rel="noopener nofollow">MudFeishu Gitee ä»åº</a></li>
<li>ð <a href="https://redis.io/topics/distlock" target="_blank" rel="noopener nofollow">Redis åå¸å¼éæä½³å®è·µ</a></li>
</ul>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-01-11 23:01">2026-01-11 23:00</span>&nbsp;
<a href="https://www.cnblogs.com/mudtools">ç©æ³¥å·´ç|mudtools.cn</a>&nbsp;
éè¯»(<span id="post_view_count">125</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19469184);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19469184', targetLink: 'https://www.cnblogs.com/mudtools/p/19469184', title: 'é£ä¹¦ .NET SDK äºä»¶å¤ççå¹ç­æ§ä¸å»éæºå¶' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ è¿­ä»£å¨ iterationãiter ä¸ å¤çº¿ç¨ concurrent äº¤åå®è·µï¼è¯¦ç»ï¼ ]]></title>
    <link>https://www.cnblogs.com/io-T-T/p/19469168</link>
    <guid>08d1454274b5d027d19b58b804bc2aeb</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/io-T-T/p/19469168" title="åå¸äº 2026-01-11 22:52">
    <span role="heading" aria-level="2">è¿­ä»£å¨ iterationãiter ä¸ å¤çº¿ç¨ concurrent äº¤åå®è·µï¼è¯¦ç»ï¼</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                    <div id="cnblogs_post_description" style="display: none">
        
        è¿­ä»£å¨ å¤çº¿ç¨ concurrent iter python
    </div>
<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h2 id="è¿­ä»£å¨iterationiter-ä¸-å¤çº¿ç¨-concurrent-äº¤åå®è·µè¯¦ç»">è¿­ä»£å¨<code>iteration</code>ã<code>iter</code> ä¸ å¤çº¿ç¨ <code>concurrent</code> äº¤åå®è·µï¼è¯¦ç»ï¼</h2>
<h3 id="å®è·µåç®ä»è¯´æ">å®è·µåç®ä»è¯´æ</h3>
<p>â	ç±äºå¨å®éè¿ç¨éï¼è¿­ä»£å¨ï¼æçæå¨ï¼ç»å¸¸ä¸å¤çº¿ç¨ä¸å¹¶ä½¿ç¨ãæ¬å®è·µæ¨å¨å¯¹è¿­ä»£å¨ï¼åçæå¨ï¼ãå¤çº¿ç¨åºï¼ä¸»è¦ä¸º<code>concurrent</code>ï¼è¿è¡äº¤åå®è·µè¯´æï¼ç¨æ¥ä½¿è¯»èæ´å çè§£è¿­ä»£å¨åå¤çº¿ç¨å¨å®éçåºç¨ãå æ­¤æ¬ç¯è½»æç¨ï¼éå®è·µï¼å½ç¶ä¹ä¼ç®è¦è¯´æç¸å³ç¥è¯ã</p>
<h3 id="åºç¡ç¥è¯ç¸å³ä»ç»ç®è¦">åºç¡ç¥è¯ç¸å³ä»ç»ï¼ç®è¦ï¼</h3>
<blockquote>
<p>è¯¦ç»ä»ç»å»ºè®®è§ç<a href="https://space.bilibili.com/1318868/?spm_id_from=333.788.upinfo.detail.click" target="_blank" rel="noopener nofollow">Hucciåä»£ç </a>åä¸»æçåºç¡ç¥è¯ï¼è¯¦ç»ææ</p>
<p><a href="https://www.bilibili.com/video/BV1jt421c7yN" target="_blank" rel="noopener nofollow">ãPythonãä»è¿­ä»£å¨å°çæå¨ï¼å°åå­ä¹è½å¤çå¤§æ°æ®</a></p>
<p><a href="https://www.bilibili.com/video/BV1tVsyzUEtX/?" target="_blank" rel="noopener nofollow">å¨Pythonä¸­ç¨å¤çº¿ç¨ä¹åï¼éè¦åææè¿äº</a></p>
</blockquote>
<h3 id="ä½ ä¸ºä»ä¹éè¦å­¦ä¹ è¿­ä»£å¨å¤çº¿ç¨">ä½ ä¸ºä»ä¹éè¦å­¦ä¹ è¿­ä»£å¨ãå¤çº¿ç¨</h3>
<p>å­¦è¿ä¸ªæç¨/å®è·µä¹åï¼ä½ éè¦åççèªå·±ææ²¡æè¿ä¸ªéæ±ï¼å½ç¶ä½ æå´è¶£ä¹å¯ä»¥å­¦ã</p>
<h4 id="è¿­ä»£å¨çæå¨çä¼å£">è¿­ä»£å¨ï¼çæå¨ï¼çä¼å£</h4>
<p><strong>ä¼å¿ï¼</strong></p>
<ul>
<li>ä½¿ç¨æ¶çææ°æ®ï¼ç¼è§£çç¼å­é®é¢ï¼RAMãGRAMï¼ãä¸»è¦ã</li>
<li>ç»ä¸æ åæ¥å£ï¼æ éå³ç³»æ°æ®çæ°æ®ç»æè°ç¨é®é¢ï¼ä½¿ç¨ <code>for _iter in iteration</code> å³å¯è°ç¨</li>
</ul>
<p><strong>å£å¿ï¼</strong></p>
<ul>
<li>åæ¬¡ä½¿ç¨</li>
<li>ä¸æ¯æç´¢å¼</li>
<li>ååéåï¼ååï¼</li>
</ul>
<h4 id="å¤çº¿ç¨çä¼å£pythonéå®">å¤çº¿ç¨çä¼å£ï¼Pythonéå®ï¼</h4>
<p><strong>ä¼å¿</strong>ï¼</p>
<ul>
<li>å¹¶è¡æ§è¡ï¼æé«CPUçä½¿ç¨ç</li>
<li>ååå©ç¨I/Oçä¸­æ­æ¶é´ï¼ä»èæé«ä»£ç çæ§è¡éåº¦</li>
</ul>
<p><strong>å£å¿ï¼</strong></p>
<ul>
<li>è°è¯é¾åº¦å¤§</li>
<li>èçæ¬ï¼å¥½åæ¯3.12ä¹åï¼ï¼åªæä¸ä¸ªGILéï¼å¯¼è´è¿ç¨ä¼åºç°æ¢å ç°è±¡ã</li>
<li>å°æ°æ®éå¸¦æ¥çæåå¯è½è¾å°</li>
</ul>
<h3 id="01-ç¯å¢æ¥æºæ°æ®">01-ç¯å¢æ¥æºæ°æ®</h3>
<p>æç¨çæ¯<code>kaggle</code>çå¼æºæ°æ®ï¼ç±äºå¾å¤é½æ¯<code>csv</code>ç±»åï¼å æ­¤æä¹ä»¥ç®åç<code>csv</code>æ°æ®éå¤çº¿ç¨è¯»åè¿è¡è¯´æï¼ä½ ä»¬ä¹å¯ä»¥ç¨å¶ä»æ°æ®éï¼æå¥½ææ¬è¡é¿åº¦&gt;5k, æè½å±ç°å¤çº¿ç¨ãè¿­ä»£å¨çä¼å¿ï¼æ°éçº§ä½è¿æ¯ç¨åçº¿ç¨ãä¸²è¡å§ï¼å®¹æçè§£å¥½ç»´æ¤ã</p>
<blockquote>
<p><a href="https://www.kaggle.com/datasets/dansbecker/powerlifting-database/data" target="_blank" rel="noopener nofollow">powerlifting-database</a></p>
</blockquote>
<h3 id="02-ä»»å¡ä»ç»åç¼ç æè·¯">02-ä»»å¡ä»ç»åç¼ç æè·¯</h3>
<p>ç©ºæç¼ç è½åï¼ä½æ¯æ²¡æç¼ç æè·¯æ¯å¤§å¿å§ãå æ­¤åæ¦è¿°ä»»å¡åç¼ç æè·¯ã</p>
<h4 id="21-ä»»å¡">2.1 ä»»å¡</h4>
<p>æ¬æ¬¡å®è·µï¼ä»»å¡æä»¥ä¸å ç¹ï¼</p>
<ol>
<li>äºè§£å¹¶æé è¿­ä»£å¨ç±»</li>
<li>ä½¿ç¨è¿­ä»£å¨ç±»å¯¹æ°æ®éï¼<strong>csvæ°æ®</strong>ï¼è¿è¡æ°æ®åå</li>
<li>ä½¿ç¨å¤çº¿ç¨åºï¼<code>concurrent</code>ï¼æ¥æ¨¡æå¤çº¿ç¨å¤çæ°æ®ã</li>
</ol>
<h4 id="22-ç¼ç æè·¯">2.2 ç¼ç æè·¯</h4>
<p>æ³è¦è¾¾æå¤çº¿ç¨ä¸è¿­ä»£å¨çç»åï¼é¦åéè¦æé åéçæ°æ®ï¼å æ­¤éè¦ï¼</p>
<ol>
<li>æå»ºè¿­ä»£å¨ç±»ï¼æ¡æ¶ï¼</li>
</ol>
<p>ç¶åéè¦å°æ°æ®éå¯¼å¥è¿æ¥ï¼å®åè¿­ä»£å¨ç±»ï¼è¿éè¦å¯¹è¾å¥çæ°æ®åä¸ä¸ååï¼æ¹ä¾¿åç»­ä½¿ç¨ï¼</p>
<ol start="2">
<li>æ°æ®å¯¼å¥+åå+å®åè¿­ä»£å¨ç±»</li>
</ol>
<p>æ°æ®æ¥æºè§£å³äºï¼ä¹ååäºï¼æ¥ä¸æ¥æ¯å°æ°æ®ä¸å¤çº¿ç¨èå¨äº</p>
<ol start="3">
<li>å¼å¥å¤çº¿ç¨åºï¼å¤çååçæ°æ®ã</li>
</ol>
<h3 id="03-æå»ºè¿­ä»£å¨ç±»">03 æå»ºè¿­ä»£å¨ç±»</h3>
<h4 id="31è¿­ä»£å¨çæå°æ¡æ¶">3.1è¿­ä»£å¨çæå°æ¡æ¶</h4>
<blockquote>
<p>å¯åè <a href="https://www.cnblogs.com/Ravenna/p/15676404.html" target="_blank">pythonè¿­ä»£å¨ç®åçè§£ __iter__å__next__æ¹æ³</a></p>
</blockquote>
<p>â	æä¸ºä¸ä¸ªæå°è¿­ä»£å¨ç±»éå¸¸éè¦åå«ä»¥ä¸å ä¸ªç±»æ¥å£ï¼</p>
<img alt="image-20260111171210573" style="zoom: 80%" data-src="https://img2024.cnblogs.com/blog/3244923/202601/3244923-20260111225210796-336730096.png" class="lazyload">
<ol>
<li><code>__init__</code>ï¼ç±»åå§åæ¥å£</li>
<li><code>__iter__</code>: è·åè¿­ä»£å¯¹è±¡çæ¥å£</li>
<li><code>__next__</code>ï¼æ°æ®è¿­ä»£æ¥å£ã</li>
</ol>
<h4 id="32--æå»ºè¿­ä»£å¨ç±»">3.2  æå»ºè¿­ä»£å¨ç±»</h4>
<p>ä¸ºäºç§é¡¾æ´å¤çè¯»èï¼æè¿éä½¿ç¨ä¼ ç»æ¥å£å¯¹<code>csv</code>è¿è¡è¯»åï¼æ<code>panda</code>è½åçè¯»èå¯ä»¥ä½¿ç¨<code>pd</code>å¿«æ·è¯»åå¹¶æé ã</p>
<pre><code class="language-python">class read_file_batch:
    def __init__(self,file_path:str, batch_size:int):
        self.file_fp = open(file_path, encoding='utf-8', mode='r+')
        self.batch_size = batch_size
    def __iter__(self):
        return self					#è¿åè¿ä¸ªè¿­ä»£å¨æ¬èº«ï¼æä»¬æ¯ä»¥ç±»ä½ä¸ºè¿­ä»£å¯¹è±¡ï¼å æ­¤è¿åä»èªå·±å§
    def __next__(self):				#æ°æ®åå
        batch_res = []
        for i in range(self.batch_size):	
            line = self.file_fp.readline()	#æåºå±è·åè¡æ°æ®çäº¤äºæ¥å£
            if line:                        #å¦æè¡éç©º
                batch_res.append(line)
            else:                           #è¯»å°æåå°±ç®ç©ºçäº
                self.file_fp.close()
                raise StopIteration

        return batch_res
</code></pre>
<ul>
<li>
<p>è°ç¨å°è¯ï¼</p>
<p>å¯ä»¥è°è¯ä¸ä¸ï¼æåä¸ä¸åæ¹çè¿­ä»£åæ°æ®çè¾å¥è¾åºã</p>
<pre><code class="language-python">if __name__ == '__main__':
    your_file_path:str = r"E:\powerlifting-database\openpowerlifting.csv"
    iteration = read_file_batch(your_file_path, batch_size=1000)
    count = 0
    for lines in iteration:
        print('-'*50+f"count:{count}"+'-'*50)
        count += 1
        print(lines)
</code></pre>
</li>
</ul>
<h3 id="04-å¼å¥å¤çº¿ç¨å¤çæ¹éæ°æ®">04 å¼å¥å¤çº¿ç¨å¤çæ¹éæ°æ®</h3>
<h4 id="41-å¤çº¿ç¨åæ³">4.1 å¤çº¿ç¨åæ³</h4>
<p>å¶å®è®ç®åçï¼åªè¦ææ¥å£å½æ°åå¥½ãæ°æ®å¤çä¸ä¸ï¼å°±è¡äºã</p>
<ol>
<li>
<p>å¯¼å¥åºï¼</p>
<pre><code class="language-python">from concurrent.futures import ThreadPoolExecutor as Excecutor
</code></pre>
</li>
<li>
<p>ä½¿ç¨ä¸ä¸æç®¡çå·¥å·ç®¡ççº¿ç¨ï¼ç¡®ä¿å®å¨åéæ¾ï¼ï¼</p>
<pre><code class="language-python">with Excecutor(max_workers=8) as executor:
</code></pre>
</li>
<li>
<p>ä½¿ç¨mapæ¥å£è¿è¡å¤çº¿ç¨æä»¤æ§è¡ï¼</p>
<pre><code class="language-python">executor.map(
    fn= function, iter_element1, iter_element2, iter_element3
)#functionæ¯ä½ å¯¹åºçå½æ°åï¼ iter_element1-3æ¯å½æ°ä¾èµçè¾å¥æ°æ®
</code></pre>
</li>
<li>
<p>æ±æ»ï¼</p>
<pre><code class="language-python">from concurrent.futures import ThreadPoolExecutor as Excecutor
with Excecutor(max_workers=8) as executor:
	executor.map(
    fn= function, iter_element1, iter_element2, iter_element3
)#functionæ¯ä½ å¯¹åºçå½æ°åï¼ iter_element1-3æ¯å½æ°ä¾èµçè¾å¥æ°æ®
</code></pre>
</li>
</ol>
<h4 id="42-å¼å¥å¤çº¿ç¨å¤çæ°æ®">4.2 å¼å¥å¤çº¿ç¨å¤çæ°æ®</h4>
<ol>
<li>
<p>é¦åï¼æ¨¡æä¸ä¸ªå¤çè¡æ°æ®çå½æ°ç¨æ·å¤çè¡ä¿¡æ¯ï¼</p>
<pre><code class="language-python">def process_dealing(line:str):
    '''
    æ¨¡æå¤çæä¸è¡çæ°æ®
    :param line:å¤çæ¯ä¸è¡
    '''
    print(f'line top 20 info is :{line[:20]}')
    pass
</code></pre>
</li>
<li>
<p>å¨è¿­ä»£å¨çè¿­ä»£è¿ç¨ä¸­å¯¹æ°æ®è¿è¡å¤çã</p>
<pre><code class="language-python">if __name__ == '__main__':
    your_file_path:str = r"E:\powerlifting-database\openpowerlifting.csv"
    iteration = read_file_batch(your_file_path, batch_size=1000)
    count = 0
    with Excecutor(max_workers=8) as executor:

        for lines in iteration:
            print('-'*50+f"count:{count}"+'-'*50)
            count += 1
            print(lines)
            executor.map(process_dealing, lines)
            #ç¬¬ä¸ä¸ªåæ°æ¯å¤ççå½æ°ï¼åé¢æ¯*iteration å°±æ¯ä½ å½æ°ä¾èµçåæ°çå¯è¿­ä»£å¯¹è±¡ï¼è¿éå°±æ¯æ¾å¥list[str]
</code></pre>
</li>
<li>
<p>ç»æäºï¼æ ¹æ®ä½ çéè¦å¯ä»¥å¯¹æ°æ®è¿è¡å¤çäºï¼å¶å®æé¾çæ­¥éª¤å¨äºå¦ä½æé è¿­ä»£å¨ï¼çæå¨ï¼ï¼å¤çº¿ç¨å¶å®ä¿©æ­¥å°±èµ°å®äºã</p>
</li>
</ol>
<h3 id="05-éå¿é¡»ä½¿ç¨è¿­ä»£å¨å¤çº¿ç¨ååå¯¹æ¯">05 ï¼éå¿é¡»ï¼ä½¿ç¨è¿­ä»£å¨ãå¤çº¿ç¨ååå¯¹æ¯</h3>
<pre><code class="language-python">from concurrent.futures import ThreadPoolExecutor as Excecutor
import time
import tracemalloc  #è·è¸ªåå­æ¥å£ï¼åç½®

def process_dealing(line:str):
    '''
    æ¨¡æå¤çæä¸è¡çæ°æ®
    :param line:å¤çæ¯ä¸è¡
    '''
    # print(f'line top 20 info is :{line[:20]}')
    pass

class read_file_batch:
    def __init__(self,file_path:str, batch_size:int):
        self.file_fp = open(file_path, encoding='utf-8', mode='r+')
        self.batch_size = batch_size
    def __iter__(self):
        return self
    def __next__(self):                     #æ°æ®åå,å¯¹è¿­ä»£å¨è¿è¡è¿­ä»£ï¼å®éä¸æ¯è·åä»çnextï¼å æ­¤å¨è¿éååæ°æ®
        batch_res = []
        for i in range(self.batch_size):    #åbatchä¸ª
            line = self.file_fp.readline()
            if line:                        #å¦æè¡éç©º
                batch_res.append(line)
            else:                           #è¯»å°æåå°±ç®ç©ºçäº
                self.file_fp.close()
                raise StopIteration

        return batch_res                    #è¿åè¿­ä»£æ°æ®

def main_concurrent(file_path,batch_size:int):
    start_malloc = tracemalloc.start()
    start_time = time.time()
    your_file_path:str = file_path
    iteration = read_file_batch(your_file_path, batch_size=batch_size)
    count = 0
    with Excecutor(max_workers=8) as executor:

        for lines in iteration:                         #è¿åæ¯batchè¡,æ¯ä¸è¡æ¯ä¸ä¸ªå¤§çstr
            print('-'*50+f"count:{count}"+'-'*50+f"RAM cost:{round(tracemalloc.get_tracemalloc_memory() / 1024**2,4)} M")
            count += 1
            print(lines[:50])                           #èçº¦æ¶é´ï¼åªåå50å­ç¬¦
            executor.map(process_dealing, lines)
            #ç¬¬ä¸ä¸ªåæ°æ¯å¤ççå½æ°ï¼åé¢æ¯*iteration å°±æ¯ä½ å½æ°ä¾èµçåæ°çå¯è¿­ä»£å¯¹è±¡ï¼è¿éå°±æ¯æ¾å¥list[str]
    print(f'spend time:{round(time.time()-start_time,4)}')

def main_not_concurrent(file_path,batch_size:int=1000):

    start_time = time.time()
    start_trace = tracemalloc.start()

    with open(file=file_path,encoding='utf-8',mode='r+') as fp:
        data = fp.readlines()
        for idx,line in enumerate(data):
            if idx % batch_size == 0:
                print('-'*50 +str(idx)+'-'*50+f"RAM cost:{round(tracemalloc.get_tracemalloc_memory() / 1024**2,4)} M")
                print(line[:50])
                process_dealing(line)
    print(f'spend time:{round(time.time()-start_time,4)}')


if __name__ == '__main__':
    file_path = r'E:\openpowerlifting.csv'
    batch_size = 1000
    main_concurrent(file_path,batch_size)
    # main_not_concurrent(file_path,batch_size)
    # å¶å®è½çåºæ¥è¿ç§æ°æ®éè¿æ¯ç´æ¥ç¼å­å¨åå­æ¯è¾å¥½ï¼ä½ä½¿ç¨å¤çº¿ç¨+è¿­ä»£å¨ç¡®å®åå°äºå¾å¤åå­
</code></pre>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-01-11 22:53">2026-01-11 22:52</span>&nbsp;
<a href="https://www.cnblogs.com/io-T-T">io_T_T</a>&nbsp;
éè¯»(<span id="post_view_count">37</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19469168);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19469168', targetLink: 'https://www.cnblogs.com/io-T-T/p/19469168', title: 'è¿­ä»£å¨ iterationãiter ä¸ å¤çº¿ç¨ concurrent äº¤åå®è·µï¼è¯¦ç»ï¼' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ TensorRtSharpï¼å¨ C# ä¸çä¸­éæ¾ GPU æ¨ççæè´æ§è½ ]]></title>
    <link>https://www.cnblogs.com/guojin-blogs/p/19468745</link>
    <guid>828f9f740e0b98b8de74655291c2b8b2</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/guojin-blogs/p/19468745" title="åå¸äº 2026-01-11 18:47">
    <span role="heading" aria-level="2">TensorRtSharpï¼å¨ C# ä¸çä¸­éæ¾ GPU æ¨ççæè´æ§è½</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                    <div id="cnblogs_post_description" style="display: none">
        <img src="https://img2024.cnblogs.com/blog/2933426/202601/2933426-20260111184433092-325501944.png" alt="TensorRtSharpï¼å¨ C# ä¸çä¸­éæ¾ GPU æ¨ççæè´æ§è½" class="desc_img">
        TensorRtSharp 3.0 æ¯ä¸ä¸ªä¸º C# å¼åèæé ç TensorRT å°è£åºï¼éè¿ NuGet ä¸é®å®è£ï¼æä¾å®æ´ç GPU æ¨çå éåè½ãè¯¥åºåºäº TensorRT 10.x å¼åï¼æ¯æ CUDA 11/12ï¼å·å¤ç±»åå®å¨ãèªå¨èµæºç®¡çç­ç¹æ§ï¼æ¾èæå .NET ç¯å¢ä¸çæ·±åº¦å­¦ä¹ æ¨çæ§è½ï¼éåº¦æå 2-10 åï¼æ¾å­éä½ 50%+ï¼ãå®è£ç®åï¼åªéæ·»å ä¸¤ä¸ª NuGet åï¼å¹¶éè¿ç¯å¢åééç½®åçåºè·¯å¾å³å¯ä½¿ç¨ãæ¨èéç½®ä¸º CUDA 11.6 + TensorRT 10.13.0.35ï¼æ¯æ
    </div>
<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h1 id="tensorrtsharpå¨-c-ä¸çä¸­éæ¾-gpu-æ¨ççæè´æ§è½">TensorRtSharpï¼å¨ C# ä¸çä¸­éæ¾ GPU æ¨ççæè´æ§è½</h1>
<h2 id="ç®å½">ç®å½</h2>
<ul>
<li><a href="#%E4%B8%80%E5%89%8D%E8%A8%80" rel="noopener nofollow">ä¸ãåè¨</a></li>
<li><a href="#%E4%BA%8C%E4%BB%80%E4%B9%88%E6%98%AF-tensortrtsharp" rel="noopener nofollow">äºãä»ä¹æ¯ TensorRtSharp</a></li>
<li><a href="#%E4%B8%89%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE" rel="noopener nofollow">ä¸ãå®è£ä¸éç½®</a></li>
<li><a href="#%E5%9B%9B%E6%A0%B8%E5%BF%83%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1" rel="noopener nofollow">åãæ ¸å¿æ¶æè®¾è®¡</a></li>
<li><a href="#%E4%BA%94%E6%A0%B8%E5%BF%83%E7%B1%BB%E4%B8%8E-api" rel="noopener nofollow">äºãæ ¸å¿ç±»ä¸ API</a></li>
<li><a href="#%E5%85%AD%E5%AE%8C%E6%95%B4%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B" rel="noopener nofollow">å­ãå®æ´ä½¿ç¨ç¤ºä¾</a></li>
<li><a href="#%E4%B8%83%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86" rel="noopener nofollow">ä¸ãå¼å¸¸å¤ç</a></li>
<li><a href="#%E5%85%AB%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F" rel="noopener nofollow">å«ãæ¥å¿ç³»ç»</a></li>
<li><a href="#%E4%B9%9D%E4%B8%8E%E5%85%B6%E4%BB%96%E5%BA%93%E7%9A%84%E5%AF%B9%E6%AF%94" rel="noopener nofollow">ä¹ãä¸å¶ä»åºçå¯¹æ¯</a></li>
<li><a href="#%E5%8D%81%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98" rel="noopener nofollow">åãå¸¸è§é®é¢</a></li>
<li><a href="#%E5%8D%81%E4%B8%80%E6%80%BB%E7%BB%93" rel="noopener nofollow">åä¸ãæ»ç»</a></li>
</ul>
<hr>
<h2 id="ä¸åè¨">ä¸ãåè¨</h2>
<h3 id="11-ä¸ºä»ä¹éè¦-tensorrtsharp">1.1 ä¸ºä»ä¹éè¦ TensorRtSharpï¼</h3>
<p>å¨æ·±åº¦å­¦ä¹ æ¨¡åé¨ç½²é¢åï¼NVIDIA TensorRT å­åå¶åè¶çæ¨çæ§è½å·²æä¸º GPU å éçäºå®æ åãæ ¹æ® NVIDIA å®æ¹æ°æ®ï¼ä½¿ç¨ TensorRT è¿è¡æ¨¡åä¼ååæ¨çå éï¼éå¸¸å¯ä»¥è·å¾ï¼</p>
<ul>
<li>ð <strong>æ¨çéåº¦æå 2-10 å</strong>ï¼ç¸æ¯åçæ¡æ¶ï¼</li>
<li>ð¾ <strong>æ¾å­å ç¨éä½ 50% ä»¥ä¸</strong>ï¼éè¿ç²¾åº¦ä¼ååå±èåï¼</li>
<li>â¡ <strong>å»¶è¿éä½è³æ¯«ç§çº§</strong>ï¼æ»¡è¶³å®æ¶åºç¨éæ±ï¼</li>
</ul>
<p>ç¶èï¼TensorRT å®æ¹ä»æä¾ C++ å Python APIï¼è¿è®©å¹¿å¤§ .NET å¼åèé¢ä¸´ä¸ä¸ªä¸¤é¾çéæ©ï¼</p>
<ul>
<li><strong>æ¾å¼çæç C# çæ</strong>ï¼è½¬å C++ æ Python</li>
<li><strong>éè¿å¤æçäºæä½å±</strong>è¿è¡è°ç¨ï¼å¼åæçä½ä¸</li>
</ul>
<p><strong>TensorRtSharp</strong> åºè¿èç ââ è¿æ¯ä¸ä¸ªçº¯ C# ç¼åç TensorRT å®æ´å°è£åºï¼ä¸º .NET å¼åèæä¾äºï¼</p>
<ul>
<li>â <strong>ç±»åå®å¨ç API æ¥å£</strong> - å¼ºç±»åç³»ç»ï¼ç¼è¯æ¶éè¯¯æ£æ¥</li>
<li>â <strong>æäºä½¿ç¨ä¸æ§è½åè¶</strong> - ç´è§ç API è®¾è®¡ï¼é¶æ§è½æå¤±</li>
<li>â <strong>å®æ´ç TensorRT åè½è¦ç</strong> - æ¯ææææ ¸å¿åè½</li>
<li>â <strong>èªå¨èµæºç®¡ç</strong> - åºäº RAII å Dispose æ¨¡å¼ï¼æ éæå¿åå­æ³æ¼</li>
<li>â <strong>å¼ç®±å³ç¨</strong> - NuGet ä¸é®å®è£ï¼æ éå¤æéç½®</li>
<li>â <strong>å®åçææ¡£åç¤ºä¾</strong> - ä¸°å¯çä»£ç ç¤ºä¾åè¯¦ç»çä½¿ç¨è¯´æ</li>
</ul>
<h3 id="12-tensorrtsharp-çæ ¸å¿ä¼å¿">1.2 TensorRtSharp çæ ¸å¿ä¼å¿</h3>
<p><strong>1. åç C# ä½éª</strong></p>
<pre><code class="language-csharp">// ç®æ´ç´è§ç API è®¾è®¡
using Runtime runtime = new Runtime();
using CudaEngine engine = runtime.deserializeCudaEngineByBlob(data, size);
using ExecutionContext context = engine.createExecutionContext();
context.executeV3(stream);
</code></pre>
<p><strong>2. å®æ´åè½è¦ç</strong></p>
<ul>
<li>â æ¨¡åæå»ºï¼ONNX â Engineï¼</li>
<li>â æ¨çæ§è¡ï¼åæ­¥/å¼æ­¥ï¼</li>
<li>â å¨æå½¢ç¶æ¯æ</li>
<li>â å¤ç²¾åº¦æ¨çï¼FP32/FP16/INT8ï¼</li>
<li>â å¤ GPU å¹¶è¡æ¨ç</li>
</ul>
<h3 id="13-tensorrtsharp-30-çéå¤§æ¹è¿">1.3 TensorRtSharp 3.0 çéå¤§æ¹è¿</h3>
<p>å¨åæå¼åç TensorRtSharp 1.0 å 2.0 ä¸­ï¼ä½¿ç¨èéè¦ä¸è½½æºç ç¼è¯æè½ä½¿ç¨ï¼è¿ç¨ç¹çä¸å®¹æåºéã</p>
<p><strong>å¨ææ°ç 3.0 çæ¬ä¸­ï¼æä»¬è¿è¡äºéå¤§æ¹è¿</strong>ï¼</p>
<p>â <strong>ä¸é®å®è£</strong> - ç´æ¥å°ç¼è¯å¥½çåçåºä¸æç®¡ä»£ç æåè³ NuGet åä¸­<br>
â <strong>å¼ç®±å³ç¨</strong> - æ ééç½®å¤æçæå»ºç¯å¢<br>
â <strong>çæ¬ä¸è´</strong> - éä½å ç¯å¢å·®å¼å¯¼è´çæ½å¨éè¯¯</p>
<p>å¼åèä»ééè¿ Visual Studio ç NuGet åç®¡çå¨å®è£å³å¯ç´æ¥ä½¿ç¨ï¼æ¾èæåäºå¼åæçä¸é¨ç½²ä¾¿æ·æ§ï¼</p>
<p>æ¬æå°å¨é¢ä»ç» TensorRtSharp çè®¾è®¡çå¿µãæ ¸å¿åè½åä½¿ç¨æ¹æ³ï¼å©åå¤§å®¶å¿«éä¸æä½¿ç¨ã</p>
<hr>
<h2 id="äºä»ä¹æ¯-tensorrtsharp">äºãä»ä¹æ¯ TensorRtSharp</h2>
<h3 id="21-é¡¹ç®ç®ä»">2.1 é¡¹ç®ç®ä»</h3>
<p><strong>TensorRtSharp 3.0</strong> æ¯ä½èå¯¹ NVIDIA TensorRT å®æ¹åºçå®æ´ C# æ¥å£å°è£ãéè¿ P/Invoke ææ¯ï¼å®å° TensorRT çåç C++ API æ å°ä¸ºç¬¦å .NET è®¾è®¡è§èçæç®¡ä»£ç ï¼è®© C# å¼åèè½å¤æ ç¼ä½¿ç¨ TensorRT çå¨é¨åè½ã</p>
<h3 id="22-æ ¸å¿ç¹æ§">2.2 æ ¸å¿ç¹æ§</h3>
<table>
<thead>
<tr>
<th>ç¹æ§</th>
<th>è¯´æ</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>å®æ´ç API è¦ç</strong></td>
<td>æ¯æ TensorRT æ ¸å¿åè½ï¼åæ¬æ¨¡åæå»ºãæ¨çæ§è¡ãå¨æå½¢ç¶ç­</td>
</tr>
<tr>
<td><strong>ç±»åå®å¨</strong></td>
<td>å¼ºç±»åç³»ç»ï¼ç¼è¯æ¶éè¯¯æ£æ¥ï¼é¿åè¿è¡æ¶ç±»åéè¯¯</td>
</tr>
<tr>
<td><strong>èªå¨èµæºç®¡ç</strong></td>
<td>åºäº RAII å Dispose æ¨¡å¼çèµæºç®¡çï¼é²æ­¢åå­æ³æ¼</td>
</tr>
<tr>
<td><strong>è·¨å¹³å°æ¯æ</strong></td>
<td>æ¯æ WindowsãLinuxï¼å¼å®¹ .NET 5.0-10.0ã.NET Core 3.1ã.NET Framework 4.7.1-4.8.1</td>
</tr>
<tr>
<td><strong>é«æ§è½å¼æ­¥æ§è¡</strong></td>
<td>æ¯æ CUDA Streamãå¤æ§è¡ä¸ä¸æå¹¶è¡æ¨ç</td>
</tr>
<tr>
<td><strong>å¼ç®±å³ç¨</strong></td>
<td>NuGet åå«ææä¾èµï¼æ éå¤æéç½®</td>
</tr>
</tbody>
</table>
<h3 id="23-é¡¹ç®ä¿¡æ¯">2.3 é¡¹ç®ä¿¡æ¯</h3>
<table>
<thead>
<tr>
<th>é¡¹ç®</th>
<th>ä¿¡æ¯</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>çæ¬</strong></td>
<td>ç®åææ° NuGet çæ¬ä¸º 0.0.5ï¼æç»­æ´æ°ä¸­ï¼å»ºè®®ä½¿ç¨ææ°çæ¬ï¼</td>
</tr>
<tr>
<td><strong>GitHub</strong></td>
<td><code>https://github.com/guojin-yan/TensorRT-CSharp-API</code></td>
</tr>
<tr>
<td><strong>æ¥å£ NuGet</strong></td>
<td><code>JYPPX.TensorRT.CSharp.API</code></td>
</tr>
<tr>
<td><strong>Runtime NuGet</strong></td>
<td><code>JYPPX.TensorRT.CSharp.API.runtime.win-x64.cuda12</code> æ <code>JYPPX.TensorRT.CSharp.API.runtime.win-x64.cuda11</code></td>
</tr>
<tr>
<td><strong>ç¼ç¨è¯­è¨</strong></td>
<td>C# 10</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="ä¸å®è£ä¸éç½®">ä¸ãå®è£ä¸éç½®</h2>
<h3 id="31-éè¿-nuget-å®è£">3.1 éè¿ NuGet å®è£</h3>
<p>å®è£ TensorRtSharp éå¸¸ç®åï¼åªéå®è£ä¸¤ä¸ª NuGet åï¼</p>
<pre><code class="language-bash"># å®è£æ¥å£å
dotnet add package JYPPX.TensorRT.CSharp.API

# å®è£è¿è¡æ¶åï¼æ ¹æ®æ¨ç CUDA çæ¬éæ©ï¼
# CUDA 12.x çæ¬
dotnet add package JYPPX.TensorRT.CSharp.API.runtime.win-x64.cuda12

# æ CUDA 11.x çæ¬
dotnet add package JYPPX.TensorRT.CSharp.API.runtime.win-x64.cuda11
</code></pre>
<blockquote>
<p><strong>ð¡ å°è´´å£«</strong>ï¼Runtime åä¸ CUDA çæ¬ç¸å³ï¼è¯·æ ¹æ®æ¨è®¾å¤ä¸å®è£ç CUDA çæ¬éæ©å¯¹åºçåã</p>
</blockquote>
<p><img alt="image-20260109233203782" loading="lazy" data-src="https://img2024.cnblogs.com/blog/2933426/202601/2933426-20260111184155212-1410768222.png" class="lazyload"></p>
<h3 id="32-ç³»ç»è¦æ±">3.2 ç³»ç»è¦æ±</h3>
<table>
<thead>
<tr>
<th>è¦æ±</th>
<th>è¯´æ</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>æä½ç³»ç»</strong></td>
<td>Windows 10+ãLinuxï¼Ubuntu 18.04+ï¼ãmacOS 10.15+</td>
</tr>
<tr>
<td><strong>.NET çæ¬</strong></td>
<td>.NET 5.0-10.0ã.NET Core 3.1ã.NET Framework 4.7.1+</td>
</tr>
<tr>
<td><strong>GPU</strong></td>
<td>NVIDIA GPUï¼æ¯æ CUDA 11.x æ 12.xï¼</td>
</tr>
<tr>
<td><strong>ä¾èµ</strong></td>
<td>NVIDIA TensorRT 10.xãCUDA Runtime</td>
</tr>
</tbody>
</table>
<h3 id="33-éè¦çæ¬è¯´æ">3.3 éè¦çæ¬è¯´æ</h3>
<blockquote>
<p><strong>â ï¸ éè¦æéï¼NVIDIA TensorRT å¿é¡»æ¯ 10.x ç³»åï¼ï¼</strong></p>
</blockquote>
<p>TensorRtSharp 3.0 åºäº TensorRT 10.x å¼åï¼ä¸æ¯æ TensorRT 8.x æ 9.x çæ¬ã</p>
<p>ä¸ºäºé²æ­¢åºç°å¼å®¹æ§é®é¢ï¼å»ºè®®ä½¿ç¨ä¸åä¸»ç¸åçéç½®ï¼</p>
<p><strong>éç½® 1ï¼æ¨èï¼ï¼</strong></p>
<ul>
<li>CUDA 11.6</li>
<li>cuDNN 9.2.0</li>
<li>TensorRT 10.13.0.35</li>
</ul>
<p><strong>éç½® 2ï¼</strong></p>
<ul>
<li>CUDA 12.3</li>
<li>cuDNN 9.2.0</li>
<li>TensorRT 10.11.0.33</li>
</ul>
<h3 id="34-éç½®åçåº">3.4 éç½®åçåº</h3>
<p>TensorRtSharp ä¾èµ TensorRT çåçåºï¼<code>nvinfer.dll</code>ï¼å CUDA çåçåºï¼<code>cudart64_*.dll</code> ç­ï¼ãæä¸¤ç§éç½®æ¹å¼ï¼</p>
<h4 id="æ¹å¼ä¸æ·è´-dll-å°åºç¨ç¨åºç®å½ä¸æ¨è">æ¹å¼ä¸ï¼æ·è´ DLL å°åºç¨ç¨åºç®å½ï¼ä¸æ¨èï¼</h4>
<p>å° TensorRT å CUDA çææ DLL æä»¶æ·è´å°ç¨åºå¯æ§è¡ç®å½ä¸ã</p>
<p><strong>ç¼ºç¹</strong>ï¼</p>
<ul>
<li>ä¼å¯¼è´ç¨åºç®å½æä»¶åºå¤§</li>
<li>ä¸æ¹ä¾¿ç®¡çä¸é¨ç½²</li>
<li><strong>ä¸æ¨èä½¿ç¨æ­¤æ¹å¼</strong></li>
</ul>
<h4 id="æ¹å¼äºè®¾ç½®ç³»ç»-pathæ¨è">æ¹å¼äºï¼è®¾ç½®ç³»ç» PATHï¼æ¨èï¼</h4>
<p>å° TensorRT ç lib ç®å½å CUDA ç bin ç®å½è·¯å¾æ·»å å°ç³»ç» PATH ç¯å¢åéä¸­ã</p>
<p><strong>ä¼ç¹</strong>ï¼</p>
<ul>
<li>æ éå¤å¶å¤§éæä»¶</li>
<li>ä¿æåºç¨ç®å½æ´æ´</li>
<li>ä¾¿äºçæ¬ç®¡çåé¨ç½²ç»´æ¤</li>
</ul>
<p><strong>éç½®æ­¥éª¤</strong>ï¼</p>
<ol>
<li><strong>è®¾ç½® CUDA_PATH ç¯å¢åé</strong></li>
</ol>
<p><img alt="CUDA_PATH éç½®" loading="lazy" data-src="https://img2024.cnblogs.com/blog/2933426/202601/2933426-20260111184155230-1674511893.jpg" class="lazyload"></p>
<ol start="2">
<li><strong>è®¾ç½® PATH ç¯å¢åé</strong></li>
</ol>
<p>å°ä»¥ä¸è·¯å¾æ·»å å° PATHï¼</p>
<ul>
<li>CUDA ç bin ç®å½ï¼å¦ <code>C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v11.6\bin</code>ï¼</li>
<li>TensorRT ç lib ç®å½ï¼å¦ <code>C:\TensorRT-10.13.0.35\lib</code>ï¼</li>
</ul>
<p><img alt="PATH éç½®" loading="lazy" data-src="https://img2024.cnblogs.com/blog/2933426/202601/2933426-20260111184155212-1478801897.jpg" class="lazyload"></p>
<blockquote>
<p><strong>ð¡ å»ºè®®</strong>ï¼ä¼åä½¿ç¨ç¯å¢åéæ¹å¼éç½®ï¼é¿åå æä»¶åä½å¯¼è´é¨ç½²å¤æãåæ¶æ³¨æä¸å CUDA çæ¬é´çå¼å®¹æ§é®é¢ã</p>
</blockquote>
<hr>
<h2 id="åæ ¸å¿æ¶æè®¾è®¡">åãæ ¸å¿æ¶æè®¾è®¡</h2>
<h3 id="41-ä¸å±æ¶æ">4.1 ä¸å±æ¶æ</h3>
<p>TensorRtSharp éç¨æ¸æ°çä¸å±æ¶æè®¾è®¡ï¼</p>
<pre><code>âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ
â           ä¸å¡ API å± (High-Level API)                   â
â  Runtime, Builder, CudaEngine, ExecutionContext         â
âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ
                           â²
                           â
âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ
â         èµæºç®¡çå± (Resource Management)                 â
â  DisposableTrtObject, DisposableObject, IOvPtrHolder    â
âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ
                           â²
                           â
âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ
â         P/Invoke å± (Native Interop)                    â
â  NativeMethodsTensorRt*, NativeMethodsCuda*             â
âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ
</code></pre>
<h3 id="42-èªå¨èµæºç®¡ç">4.2 èªå¨èµæºç®¡ç</h3>
<p>TensorRtSharp å®ç°äºå®åçèµæºç®¡çæºå¶ï¼ææ TensorRT å¯¹è±¡é½ç»§æ¿èª <code>DisposableTrtObject</code>ï¼</p>
<pre><code class="language-csharp">// ææ TensorRT å¯¹è±¡ç»§æ¿èª DisposableTrtObject
public abstract class DisposableTrtObject : DisposableObject
{
    protected IntPtr ptr;                      // åçå¯¹è±¡æé
    public bool IsDisposed { get; protected set; }

    // å®å¨è®¿é®åçæéï¼èªå¨æ£æ¥éæ¾ç¶æï¼
    public IntPtr TrtPtr
    {
        get
        {
            ThrowIfDisposed();
            return ptr;
        }
    }

    // éæ¾éæç®¡èµæº
    protected override void DisposeUnmanaged()
    {
        if (ptr != IntPtr.Zero)
        {
            // è°ç¨åçéæ¾å½æ°
            NativeDestroy(ptr);
            ptr = IntPtr.Zero;
        }
    }
}

// ä½¿ç¨ using è¯­å¥èªå¨éæ¾èµæº
using Runtime runtime = new Runtime();
using CudaEngine engine = runtime.deserializeCudaEngineByBlob(data, size);
// ç¦»å¼ä½ç¨åæ¶èªå¨éæ¾
</code></pre>
<p><strong>è®¾è®¡äº®ç¹</strong>ï¼</p>
<ul>
<li>â éç¨æ å Dispose æ¨¡å¼ï¼ç¡®ä¿èµæºæ­£ç¡®éæ¾</li>
<li>â çº¿ç¨å®å¨çèµæºéæ¾æºå¶ï¼ä½¿ç¨ <code>Interlocked.Exchange</code>ï¼</li>
<li>â èªå¨åå­ååéç¥ï¼<code>GC.AddMemoryPressure</code>ï¼</li>
<li>â æéå®å¨è®¿é®ï¼<code>ThrowIfDisposed</code> æ£æ¥ï¼</li>
</ul>
<hr>
<h2 id="äºæ ¸å¿ç±»ä¸-api">äºãæ ¸å¿ç±»ä¸ API</h2>
<h3 id="51-å½åç©ºé´">5.1 å½åç©ºé´</h3>
<p>å¨ä½¿ç¨ TensorRtSharp ä¹åï¼é¦åå¼å¥å¿è¦çå½åç©ºé´ï¼</p>
<pre><code class="language-csharp">using JYPPX.TensorRtSharp.Cuda;      // CUDA æ¥å£çç¨åºéå½åç©ºé´
using JYPPX.TensorRtSharp.Nvinfer;   // TensorRT æ¥å£çç¨åºéå½åç©ºé´
</code></pre>
<h3 id="52-runtimeæ¨çè¿è¡æ¶">5.2 Runtimeï¼æ¨çè¿è¡æ¶ï¼</h3>
<p>Runtime æ¯ TensorRT æ¨ççå¥å£ç¹ï¼è´è´£ä»åºååçå¼ææä»¶åå»ºæ¨çå¼æã</p>
<pre><code class="language-csharp">// åå»º Runtime å®ä¾
Runtime runtime = new Runtime();
string filePath = "yolov8s-obb.engine";

// ä»å­èæ°ç»ååºååå¼æ
byte[] data = File.ReadAllBytes(filePath);
using CudaEngine cudaEngine = runtime.deserializeCudaEngineByBlob(data, (ulong)data.Length);

// ä»æä»¶æµååºåå
using var reader = new FileStreamReader();
reader.open(filePath);
using CudaEngine cudaEngine = runtime.deserializeCudaEngineByFileStreamReader(reader);

// éç½® DLAï¼æ·±åº¦å­¦ä¹ å éå¨ï¼
runtime.setDLACore(0);  // ä½¿ç¨ DLA æ ¸å¿ 0
int dlaCores = runtime.getNbDLACores();

// è®¾ç½®æå¤§çº¿ç¨æ°
runtime.setMaxThreads(4);
</code></pre>
<p><strong>ä¸»è¦ç¨é</strong>ï¼</p>
<ul>
<li>ååºåå TensorRT å¼ææä»¶</li>
<li>éç½® DLA å éå¨</li>
<li>å è½½æä»¶åº</li>
</ul>
<h3 id="53-builderæ¨¡åæå»ºå¨">5.3 Builderï¼æ¨¡åæå»ºå¨ï¼</h3>
<p>Builder ç¨äºä» ONNX æ¨¡åæå»º TensorRT å¼æã</p>
<pre><code class="language-csharp">using Builder builder = new Builder();

// æ¥è¯¢å¹³å°è½å
bool hasFP16 = builder.platformHasFastFp16();  // æ¯å¦æ¯æ FP16
bool hasINT8 = builder.platformHasFastInt8();  // æ¯å¦æ¯æ INT8
int maxDLABatch = builder.maxDLABatchSize();   // DLA æå¤§æ¹å¤§å°

// åå»ºç½ç»å®ä¹ï¼æ¾å¼æ¹å¤çæ¨¡å¼ï¼
using NetworkDefinition network = builder.createNetworkV2(
    TrtNetworkDefinitionCreationFlag.kEXPLICIT_BATCH);

// åå»ºæå»ºå¨éç½®
using BuilderConfig config = builder.createBuilderConfig();

// åå»ºä¼åéç½®æä»¶ï¼ç¨äºå¨æå½¢ç¶ï¼
using OptimizationProfile profile = builder.createOptimizationProfile();

// æå»ºåºååç½ç»
using HostMemory serialized = builder.buildSerializedNetwork(network, config);

// ä¿å­å¼ææä»¶
using (FileStream fs = new FileStream("model.engine", FileMode.Create, FileAccess.Write))
{
    fs.Write(serialized.getByteData(), 0, (int)serialized.Size);
}
</code></pre>
<p><strong>ä¸»è¦ç¨é</strong>ï¼</p>
<ul>
<li>åå»ºç½ç»å®ä¹åæå»ºéç½®</li>
<li>æ¥è¯¢ç¡¬ä»¶è½åï¼FP16ãINT8ãDLAï¼</li>
<li>æå»º TensorRT å¼æ</li>
<li>æ³¨åèªå®ä¹æä»¶</li>
</ul>
<h3 id="54-cudaengineæ¨çå¼æ">5.4 CudaEngineï¼æ¨çå¼æï¼</h3>
<p>CudaEngine æ¯æ¨ççæ ¸å¿å¯¹è±¡ï¼åå«ä¼ååçæ¨¡åè®¡ç®å¾ã</p>
<pre><code class="language-csharp">// è·åå¼ éä¿¡æ¯
int numTensors = engine.getNbIOTensors();
string inputName = engine.getIOTensorName(0);    // è¾å¥å¼ éåç§°
string outputName = engine.getIOTensorName(1);   // è¾åºå¼ éåç§°

Dims inputShape = engine.getTensorShape(inputName);
TrtDataType inputType = engine.getTensorDataType(inputName);

// åå»ºæ§è¡ä¸ä¸æ
using ExecutionContext context = engine.createExecutionContext();
using ExecutionContext contextStatic = engine.createExecutionContext(
    TrtExecutionContextAllocationStrategy.kSTATIC);

// åºååå¼æ
using HostMemory memory = engine.serialize();

// æ¥è¯¢å¼æå±æ§
int numLayers = engine.getNbLayers();
string name = engine.getName();
long deviceMemory = engine.getDeviceMemorySize();
</code></pre>
<p><strong>ä¸»è¦ç¨é</strong>ï¼</p>
<ul>
<li>æ¥è¯¢æ¨¡åè¾å¥è¾åºä¿¡æ¯</li>
<li>åå»ºæ§è¡ä¸ä¸æ</li>
<li>åºååå¼æ</li>
<li>æ§è½åæ</li>
</ul>
<h3 id="55-executioncontextæ§è¡ä¸ä¸æ">5.5 ExecutionContextï¼æ§è¡ä¸ä¸æï¼</h3>
<p>ExecutionContext ç®¡çåæ¬¡æ¨ççæ§è¡ç¯å¢ï¼æ¯æå¼æ­¥æ¨çåå¨æå½¢ç¶ã</p>
<pre><code class="language-csharp">// ç»å®å¼ éå°å
Cuda1DMemory&lt;float&gt; input = new Cuda1DMemory&lt;float&gt;(3 * 1024 * 1024);
Cuda1DMemory&lt;float&gt; output = new Cuda1DMemory&lt;float&gt;(1 * 20 * 21504);
context.setInputTensorAddress("images", input.get());
context.setOutputTensorAddress("output0", output.get());

// è®¾ç½®å¨æå½¢ç¶
context.setinputShape("images", new Dims(1, 3, 1024, 1024));
Dims shape = context.getTensorShape("images");

// æ§è¡æ¨çï¼å¼æ­¥ï¼ä½¿ç¨ CUDA Streamï¼
using CudaStream stream = new CudaStream();
context.executeV3(stream);
stream.Synchronize();  // ç­å¾å®æ

// è®¾ç½®ä¼åéç½®æä»¶ï¼å¨æå½¢ç¶ï¼
context.setOptimizationProfileAsync(0, stream);

// è°è¯åè½
context.setDebugSync(true);
</code></pre>
<p><strong>ä¸»è¦ç¨é</strong>ï¼</p>
<ul>
<li>ç»å®è¾å¥è¾åºå¼ é</li>
<li>è®¾ç½®å¨æå½¢ç¶</li>
<li>æ§è¡æ¨çï¼å¼æ­¥ï¼</li>
<li>æ§è½åæåè°è¯</li>
</ul>
<h3 id="56-onnxparseronnx-è§£æå¨">5.6 OnnxParserï¼ONNX è§£æå¨ï¼</h3>
<p>OnnxParser å° ONNX æ¨¡åè½¬æ¢ä¸º TensorRT ç½ç»å®ä¹ã</p>
<pre><code class="language-csharp">// è§£æ ONNX æä»¶
using NetworkDefinition network = build.createNetworkV2(TrtNetworkDefinitionCreationFlag.kEXPLICIT_BATCH);
using OnnxParser parser = new OnnxParser(network);
bool success = parser.parseFromFile("yolov8s-obb.onnx", verbosity: 2);

// æ£æ¥ç®å­æ¯æ
bool supportsConv = parser.supportsOperator("Conv");

// å­å¾æ¯æ
long numSubgraphs = parser.getNbSubgraphs();
bool supported = parser.isSubgraphSupported(0);
long[] nodes = parser.getSubgraphNodes(0);

// è®¾ç½®è§£æå¨æ å¿
parser.setFlag(TrtOnnxParserFlag.kNATIVE_INSTANCENORM);
</code></pre>
<p><strong>ä¸»è¦ç¨é</strong>ï¼</p>
<ul>
<li>è§£æ ONNX æ¨¡å</li>
<li>æ£æ¥ç®å­æ¯æ</li>
<li>å¤çå­å¾</li>
</ul>
<h3 id="57-cuda-åå­ç®¡ç">5.7 CUDA åå­ç®¡ç</h3>
<h4 id="1è®¾å¤åå­cuda1dmemory">ï¼1ï¼è®¾å¤åå­ï¼Cuda1DMemory<t>ï¼</t></h4>
<pre><code class="language-csharp">// åå»ºè®¾å¤åå­
using Cuda1DMemory&lt;float&gt; input = new Cuda1DMemory&lt;float&gt;(1000);
ulong numElements = input.SizeElements;
ulong numBytes = input.SizeBytes;
IntPtr ptr = input.DevicePointer;

// åæ­¥æ°æ®ä¼ è¾
float[] hostData = new float[1000];
input.copyFromHost(hostData);   // ä¸»æº â è®¾å¤
input.copyToHost(hostData);      // è®¾å¤ â ä¸»æº

// å¼æ­¥æ°æ®ä¼ è¾
using CudaStream stream = new CudaStream();
input.copyFromHostAsync(hostData, stream);
input.copyToHostAsync(hostData, stream);

// åå­æä½
input.memset(0);                 // å¡«åä¸º 0
input.memsetAsync(0, stream);    // å¼æ­¥å¡«å
</code></pre>
<h4 id="2cuda-æµcudastream">ï¼2ï¼CUDA æµï¼CudaStreamï¼</h4>
<pre><code class="language-csharp">// åå»ºæµï¼å¸¦ä¼åçº§ï¼
using CudaStream stream = new CudaStream();
using CudaStream streamHigh = new CudaStream(0, -1);  // é«ä¼åçº§

// åæ­¥æä½
stream.Synchronize();  // ç­å¾æµå®æ
bool isComplete = stream.Query();  // æ¥è¯¢æ¯å¦å®æ

// äºä»¶ä¾èµ
using CudaEvent cudaEvent = new CudaEvent();
stream.WaitEvent(cudaEvent);  // ç­å¾äºä»¶

// æ·»å åè°
stream.AddCallback((streamPtr, statue, userData) =&gt;
{
    Console.WriteLine("Stream callback executed");
}, IntPtr.Zero, 0);

// CUDA Graph æè·
stream.BeginCapture(CudaStreamCaptureMode.Global);
// ... æ§è¡æä½ ...
CudaGraph_t graph = stream.EndCapture();
</code></pre>
<h4 id="3cuda-è®¾å¤cudadevice">ï¼3ï¼CUDA è®¾å¤ï¼CudaDeviceï¼</h4>
<pre><code class="language-csharp">// è·åç³»ç»ä¸­å¯ç¨ç CUDA å¼å®¹è®¾å¤çæ°é
int nbDevices = CudaDevice.GetDeviceCount();

// è·åæå®è®¾å¤çå±æ§
CudaDeviceProp properties = CudaDevice.GetDeviceProperties(deviceIdx);

// è®¾ç½®æ§è¡è®¾å¤
CudaDevice.SetDevice(device);

// è·åæå³è®¾å¤çè¯·æ±ä¿¡æ¯
int clockRate = CudaDevice.GetAttribute(CudaDeviceAttr.ClockRate, device);
</code></pre>
<hr>
<h2 id="å­å®æ´ä½¿ç¨ç¤ºä¾">å­ãå®æ´ä½¿ç¨ç¤ºä¾</h2>
<h3 id="ç¤ºä¾-1è·ååè®¾ç½®è®¾å¤ä¿¡æ¯">ç¤ºä¾ 1ï¼è·ååè®¾ç½®è®¾å¤ä¿¡æ¯</h3>
<p>ä¸é¢çä»£ç å¯ä»¥è·åå½åè®¾å¤çç¸å³ä¿¡æ¯ï¼åæ¶å¯ä»¥è®¾ç½®æ¨çè®¾å¤ã</p>
<pre><code class="language-csharp">using JYPPX.TensorRtSharp.Cuda;
using JYPPX.TensorRtSharp.Nvinfer;

namespace TestDemo
{
    internal class Program
    {
        static void Main(string[] args)
        {
            // æå®é»è®¤ä½¿ç¨ç GPU è®¾å¤ç´¢å¼
            // å¨å¤ GPU ç¯å¢ä¸ï¼å¯ä»¥éè¿ä¿®æ¹æ­¤åéæ¥éæ©ç¹å®çæ¾å¡
            int device = 0;

            // è®°å½æ¥å¿ï¼æ è®°è®¾å¤ä¿¡æ¯æ¥è¯¢çå¼å§
            Logger.Instance.INFO("=== Device Information ===");

            // è·åå½åç³»ç»ä¸­å¯è§ç NVIDIA GPU æ°é
            int nbDevices = CudaDevice.GetDeviceCount();

            // æ£æ¥ç³»ç»ä¸­æ¯å¦å­å¨å¯ç¨ç GPU è®¾å¤
            if (nbDevices &lt;= 0)
            {
                Logger.Instance.ERROR("Cannot find any available devices (GPUs)!");
                Environment.Exit(0);
            }

            // æå°ææå¯ç¨è®¾å¤çåè¡¨
            Logger.Instance.INFO("Available Devices: ");

            // éåç³»ç»ä¸­çæ¯ä¸ä¸ª GPU
            for (int deviceIdx = 0; deviceIdx &lt; nbDevices; ++deviceIdx)
            {
                // è·åç´¢å¼ä¸º deviceIdx ç GPU çè¯¦ç»å±æ§
                CudaDeviceProp tempProperties = CudaDevice.GetDeviceProperties(deviceIdx);

                // æå°è®¾å¤ IDãè®¾å¤åç§°ä»¥å UUID (å¯ä¸æ è¯ç¬¦)
                Logger.Instance.INFO($"  Device {deviceIdx}: \"{tempProperties.Name}\" UUID: {GetUuidString(tempProperties.Uuid)}");

                // å¦æå½åéåå°çè®¾å¤ ID æ¯æä»¬æ³è¦ä½¿ç¨çç®æ è®¾å¤
                // åå°è¯¥è®¾å¤çå±æ§ä¿å­ä¸æ¥ï¼ä¾åç»­ä½¿ç¨
                if (deviceIdx == device)
                {
                    properties = tempProperties;
                }
            }

            // å®å¨æ£æ¥ï¼ç¡®ä¿è¯·æ±çç®æ è®¾å¤ ID å¨ææèå´å
            if (device &lt; 0 || device &gt;= nbDevices)
            {
                Logger.Instance.ERROR($"Cannot find device ID {device}!");
                Environment.Exit(0);
            }

            // å° CUDA ä¸ä¸æè®¾ç½®å°æå®ç GPU è®¾å¤ä¸
            CudaDevice.SetDevice(device);

            // æå°éå®è®¾å¤çè¯¦ç»ä¿¡æ¯
            Logger.Instance.INFO($"Selected Device: {properties.Name}");
            Logger.Instance.INFO($"Selected Device ID: {device}");
            Logger.Instance.INFO($"Selected Device UUID: {GetUuidString(properties.Uuid)}");
            Logger.Instance.INFO($"Compute Capability: {properties.Major}.{properties.Minor}");
            Logger.Instance.INFO($"SMs: {properties.MultiProcessorCount}");
            Logger.Instance.INFO($"Device Global Memory: {(properties.TotalGlobalMem + 20)} MiB");
            Logger.Instance.INFO($"Shared Memory per SM: {(properties.SharedMemPerMultiprocessor &gt;&gt; 10)} KiB");
            Logger.Instance.INFO($"Memory Bus Width: {properties.MemoryBusWidth} bits (ECC {(properties.ECCEnabled != 0 ? "enabled" : "disabled")})");

            // è·åå¹¶æå° GPU æ ¸å¿æ¶éé¢çåæ¾å­æ¶éé¢ç
            int clockRate = CudaDevice.GetAttribute(CudaDeviceAttr.ClockRate, device);
            int memoryClockRate = CudaDevice.GetAttribute(CudaDeviceAttr.MemoryClockRate, device);

            Logger.Instance.INFO($"Application Compute Clock Rate: {clockRate / 1000000.0F} GHz");
            Logger.Instance.INFO($"Application Memory Clock Rate: {memoryClockRate / 1000000.0F} GHz");
        }

        /// &lt;summary&gt;
        /// è¾å©æ¹æ³ï¼å° CudaUUID ç»æä½è½¬æ¢ä¸ºæ ¼å¼åç GPU UUID å­ç¬¦ä¸²
        /// æ ¼å¼éå¸¸ä¸ºï¼GPU-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
        /// &lt;/summary&gt;
        public static string GetUuidString(CudaUUID uuid)
        {
            int kUUID_SIZE = uuid.Bytes.Length;
            var ss = new System.Text.StringBuilder();

            // å®ä¹ UUID çåæ®µç¹ï¼ç¨äºæå¥è¿å­ç¬¦ "-"
            int[] splits = { 0, 4, 6, 8, 10, kUUID_SIZE };

            // æ·»å åºå®ç "GPU" åç¼
            ss.Append("GPU");

            // éååæ®µå®ä¹ï¼æ ¼å¼åæ¯ä¸é¨åçå­è
            for (int splitIdx = 0; splitIdx &lt; splits.Length - 1; ++splitIdx)
            {
                ss.Append("-");
                for (int byteIdx = splits[splitIdx]; byteIdx &lt; splits[splitIdx + 1]; ++byteIdx)
                {
                    ss.AppendFormat("{0:x2}", uuid.Bytes[byteIdx]);
                }
            }

            return ss.ToString();
        }
    }
}
</code></pre>
<p><strong>ç¨åºè¿è¡ç»æï¼</strong></p>
<p><img alt="è®¾å¤ä¿¡æ¯è¾åº" loading="lazy" data-src="https://img2024.cnblogs.com/blog/2933426/202601/2933426-20260111184155226-526554276.png" class="lazyload"></p>
<blockquote>
<p><strong>ð¡ æ³¨æ</strong>ï¼ä¸åçè®¾å¤è¾åºä¼æä¸åï¼ä»¥å·ä½è®¾å¤è¾åºä¸ºåã</p>
<p>ð<strong>ç¨åºè·¯å¾é¾æ¥</strong>ï¼å®æ´ç¨åºå·²ç»ä¸ä¼ å°GitHubï¼è¯·èªè¡ä¸è½½ï¼é¾æ¥ä¸ºï¼</p>
<pre><code>https://github.com/guojin-yan/TensorRT-CSharp-API/tree/TensorRtSharp3.0/samples/SetCudaDeviceInfo
</code></pre>
</blockquote>
<hr>
<h3 id="ç¤ºä¾-2onnx-è½¬-engine-æ¨¡å">ç¤ºä¾ 2ï¼ONNX è½¬ Engine æ¨¡å</h3>
<p>ä¸é¢æ¯æç§å®æ¹æ¨¡åè½¬æ¢ä»£ç ç¼åçä¸ä¸ªç®åçè½¬æ¢ä»£ç ï¼</p>
<pre><code class="language-csharp">using JYPPX.TensorRtSharp.Cuda;
using JYPPX.TensorRtSharp.Nvinfer;

namespace OnnxToEngine
{
    internal class Program
    {
        static void Main(string[] args)
        {
            // === éç½® TensorRT æ¥å¿åè° ===
            // å®ä¹ä¸ä¸ªå§æï¼ç¨äºå¤ç TensorRT åé¨äº§ççæ¥å¿æ¶æ¯
            LogCallbackFunction _callbackDelegate = (message) =&gt;
            {
                Console.WriteLine(message);
            };

            // å°èªå®ä¹çåè°å½æ°æ³¨åç» TensorRT çå¨å± Logger å®ä¾
            Logger.Instance.SetCallback(_callbackDelegate);

            // è®¾ç½®æ¥å¿çä¸¥éæ§çº§å«éå¼
            // LoggerSeverity.kINFO: æå°ä¿¡æ¯ãè­¦ååéè¯¯
            Logger.Instance.SetThreshold(LoggerSeverity.kINFO);

            // 1. åå»º TensorRT Builder (æå»ºå¨)
            Builder build = new Builder();

            // 2. åå»ºç½ç»å®ä¹ (Network Definition)
            // æ¾å¼æ¹å¤ç æ å¿è¡¨ç¤ºç½ç»å®ä¹ä¸­æ¾å¼åå«æ¹å¤çç»´åº¦
            NetworkDefinition networkDefinition = build.createNetworkV2(TrtNetworkDefinitionCreationFlag.kEXPLICIT_BATCH);

            // 3. åå»ºæå»ºå¨éç½®
            BuilderConfig builderConfig = build.createBuilderConfig();

            // 4. åå»º ONNX è§£æå¨
            OnnxParser onnxParser = new OnnxParser(networkDefinition);

            // æå®å¾è½¬æ¢ç ONNX æ¨¡åæä»¶è·¯å¾
            string modelpath = "yolo11s-obb.onnx";

            // 5. è§£æ ONNX æ¨¡åæä»¶
            // åæ° 2: æ¥å¿çº§å« (1=ERROR, 2=WARNING, 3=INFO, 4=VERBOSE)
            if (onnxParser.parseFromFile(modelpath, 2) == false)
            {
                Console.WriteLine($"parse onnx model failed");
                return;
            }

            // 6. è®¾ç½®æå»ºç²¾åº¦æ å¿
            // kFP16: å¯ç¨åç²¾åº¦ (FP16) æ¨çæ¨¡å¼
            builderConfig.setFlag(TrtBuilderFlag.kFP16);

            // 7. åå»º CUDA æµ
            CudaStream cudaStream = new CudaStream();

            // 8. è®¾ç½®ä¼åéç½®æä»¶çæµ
            builderConfig.setProfileStream(cudaStream);

            // 9. æå»ºå¹¶åºååç½ç»
            // è¿æ¯ä¸ä¸ªèæ¶è¾é¿çè¿ç¨ï¼å ä¸º TensorRT ä¼è¿è¡åæ ¸èªå¨è°ä¼ãå±èåç­ä¼å
            HostMemory hostMemory = build.buildSerializedNetwork(networkDefinition, builderConfig);

            // 10. ä¿å­ Engine å°ç£ç
            string filePath = "yolo11s-obb.engine";
            using (FileStream fs = new FileStream(filePath, FileMode.Create, FileAccess.Write))
            {
                fs.Write(hostMemory.getByteData(), 0, (int)hostMemory.Size);
            }

            Console.WriteLine("Engine saved successfully!");
        }
    }
}
</code></pre>
<p><strong>ç¨åºè¿è¡ç»æï¼</strong></p>
<p><img alt="ONNX è½¬æ¢ç»æ" loading="lazy" data-src="https://img2024.cnblogs.com/blog/2933426/202601/2933426-20260111184155199-25493962.png" class="lazyload"></p>
<blockquote>
<p>ð<strong>ç¨åºè·¯å¾é¾æ¥</strong>ï¼å®æ´ç¨åºå·²ç»ä¸ä¼ å°GitHubï¼è¯·èªè¡ä¸è½½ï¼é¾æ¥ä¸ºï¼</p>
<pre><code>https://github.com/guojin-yan/TensorRT-CSharp-API/tree/TensorRtSharp3.0/samples/OnnxToEngine
</code></pre>
</blockquote>
<hr>
<h3 id="-ä½¿ç¨-trtexec-å·¥å·è½¬æ¢æ¨¡åæ¨è">ð¡ ä½¿ç¨ trtexec å·¥å·è½¬æ¢æ¨¡åï¼æ¨èï¼</h3>
<p>å½å ONNX è½¬ Engine ä»£ç ç±äºæ²¡æè¿è¡ä¼åï¼è½¬æ¢éåº¦ä¼è¾æ¢ã<strong>å»ºè®®ä½¿ç¨ TensorRT SDK èªå¸¦ç <code>trtexec.exe</code> å·¥å·è½¬æ¢æ¨¡å</strong>ã</p>
<h4 id="trtexec-ä½¿ç¨æ¹å¼">trtexec ä½¿ç¨æ¹å¼</h4>
<p><strong>ï¼1ï¼ä½¿ç¨ CMD åæ¢å°å·¥å·ç®å½</strong></p>
<p>è¯¥å·¥å·å­æ¾å¨ä¸è½½ç TensorRT åºä¸­ï¼</p>
<p><img alt="trtexec ä½ç½®" loading="lazy" data-src="https://img2024.cnblogs.com/blog/2933426/202601/2933426-20260111184155192-868591871.png" class="lazyload"></p>
<p>æå¼ CMD å¹¶åæ¢å°è¯¥è·¯å¾ï¼</p>
<p><img alt="CMD åæ¢è·¯å¾" loading="lazy" data-src="https://img2024.cnblogs.com/blog/2933426/202601/2933426-20260111184155220-2043771179.png" class="lazyload"></p>
<p><strong>ï¼2ï¼åºå®å½¢ç¶æ¨¡åè½¬æ¢æä»¤</strong></p>
<p>å¯¹äºå½¢ç¶åºå®çæ¨¡åï¼ç´æ¥è¾å¥å¸¸è§æä»¤è½¬æ¢å³å¯ï¼</p>
<pre><code class="language-bash">trtexec.exe --onnx=yolov8s-obb.onnx --saveEngine=yolov8s-obb.engine --fp16 --workspace=1024
</code></pre>
<p><strong>åæ°è¯´æï¼</strong></p>
<ul>
<li><code>--onnx=yolov8s-obb.onnx</code>ï¼æå®è¾å¥ç ONNX æ¨¡åæä»¶è·¯å¾</li>
<li><code>--saveEngine=yolov8s-obb.engine</code>ï¼æå®è¾åºç Engine æä»¶ä¿å­è·¯å¾</li>
<li><code>--fp16</code>ï¼å¯ç¨ FP16 ç²¾åº¦ï¼å¯éï¼</li>
<li><code>--workspace=1024</code>ï¼æå®æå¤§å·¥ä½ç©ºé´ï¼åä½ MBï¼å¯éï¼</li>
</ul>
<p><img alt="trtexec è½¬æ¢ä¸­" loading="lazy" data-src="https://img2024.cnblogs.com/blog/2933426/202601/2933426-20260111184155240-1040135131.png" class="lazyload"></p>
<p><strong>ï¼3ï¼å¨æå½¢ç¶æ¨¡åè½¬æ¢æä»¤</strong></p>
<p>å¯¹äºè¾å¥å½¢ç¶æ¯å¨æçæåµï¼è½¬æ¢æ¶è¦è®¾ç½®å½¢ç¶åæ°ï¼</p>
<pre><code class="language-bash">trtexec.exe --onnx=yolov8s-obb_b.onnx --saveEngine=yolov8s-obb_b.engine --fp16 --minShapes=images:1x3x1024x1024 --optShapes=images:8x3x1024x1024 --maxShapes=images:24x3x1024x1024
</code></pre>
<p><strong>åæ°è¯´æï¼</strong></p>
<ul>
<li><code>--minShapes=images:1x3x1024x1024</code>ï¼æå°è¾å¥å½¢ç¶</li>
<li><code>--optShapes=images:8x3x1024x1024</code>ï¼æä¼è¾å¥å½¢ç¶ï¼Engine ä¼ä¸ºæ­¤å½¢ç¶ä¼åï¼</li>
<li><code>--maxShapes=images:24x3x1024x1024</code>ï¼æå¤§è¾å¥å½¢ç¶</li>
</ul>
<p><img alt="å¨æå½¢ç¶è½¬æ¢" loading="lazy" data-src="https://img2024.cnblogs.com/blog/2933426/202601/2933426-20260111184155195-1777862369.png" class="lazyload"></p>
<p><strong>å¤è¾å¥æ¨¡åè½¬æ¢æä»¤ï¼</strong></p>
<pre><code class="language-bash">trtexec --onnx=model.onnx --minShapes=input1:1x3x224x224,input2:1x256 --optShapes=input1:4x3x224x224,input2:4x256 --maxShapes=input1:8x3x224x224,input2:8x256
</code></pre>
<hr>
<h3 id="ç¤ºä¾-3yolo-ç®æ æ£æµ">ç¤ºä¾ 3ï¼YOLO ç®æ æ£æµ</h3>
<p>ä¸é¢æ¯ä¸ä¸ªå®æ´ç YOLO ç®æ æ£æµç¤ºä¾ï¼å±ç¤ºä»æ¨¡åæå»ºå°æ¨ççå¨æµç¨ã</p>
<blockquote>
<p><strong>â ï¸ ç±äºä»£ç è¾é¿ï¼æ­¤å¤ä»å±ç¤ºæ ¸å¿æè·¯ãå®æ´ä»£ç è¯·åèé¡¹ç®ç¤ºä¾ã</strong></p>
</blockquote>
<pre><code class="language-csharp">using JYPPX.TensorRtSharp.Cuda;
using JYPPX.TensorRtSharp.Nvinfer;
using OpenCvSharp;
using OpenCvSharp.Dnn;
using System.Diagnostics;
using System.Runtime.InteropServices;

namespace YoloDetInfer
{
    internal class Program
    {
        // ================= éç½®åæ° =================
        // æ¨¡åè¾å¥å°ºå¯¸ (å®½=é«)
        private const int InputSize = 640;


        // å»ºè®®æ ¹æ®å®éæ¨¡åå¨æè·åæä½¿ç¨ Netron æ¥ç
        private const int OutputSize = 8400;

        // æ¨¡åç±»å«æ° (æ ¹æ®æ¨çå·ä½æ°æ®éä¿®æ¹ï¼æ­¤å¤åè®¾ä¸º15ç±»)
        private const int CategoryNum = 80;

        // ç½®ä¿¡åº¦éå¼
        private const float ConfThreshold = 0.25f;

        // NMS IOU éå¼
        private const float NmsThreshold = 0.3f;

        static void Main(string[] args)
        {
            //  ============= éç½® TensorRT æ¥å¿åè° =============
            // å®ä¹ä¸ä¸ªå§æï¼ç¨äºå¤ç TensorRT åé¨äº§ççæ¥å¿æ¶æ¯ã
            // è¿åè®¸æä»¬å° C++ å±é¢çæ¥å¿è¾åºå° C# çæ§å¶å°ã
            LogCallbackFunction _callbackDelegate = (message) =&gt;
            {
                Console.WriteLine(message);
            };

            // å°èªå®ä¹çåè°å½æ°æ³¨åç» TensorRT çå¨å± Logger å®ä¾ã
            Logger.Instance.SetCallback(_callbackDelegate);

            // è®¾ç½®æ¥å¿çä¸¥éæ§çº§å«éå¼ã
            // LoggerSeverity.kINFO: æå°ä¿¡æ¯ãè­¦ååéè¯¯ã
            // å¼åè°è¯é¶æ®µéå¸¸è®¾ä¸º kINFO æ kVERBOSEï¼çäº§ç¯å¢å¯è®¾ä¸º kWARNING æ kERROR ä»¥åå°è¾åºã
            Logger.Instance.SetThreshold(LoggerSeverity.kINFO);

            string enginePath = "yolov8s.engine";
            string imagePath = "bus.jpg";


            // ================= 1. å è½½ TensorRT Engine =================
            // ä½¿ç¨ using è¯­å¥ç¡®ä¿æä»¶æµæ­£ç¡®å³é­
            byte[] engineData;
            using (FileStream fs = new FileStream(enginePath, FileMode.Open, FileAccess.Read))
            using (BinaryReader br = new BinaryReader(fs))
            {
                engineData = br.ReadBytes((int)fs.Length);
            }

            // ååºåå Engine
            // Runtime å¿é¡»å¨ Engine çå½å¨æåä¿æå­æ´»ï¼éå¸¸å»ºè®®è®¾ä¸ºå¨å±æéæï¼æèç¡®ä¿å®æåéæ¾
            Runtime runtime = new Runtime();

            // åå»º CudaEngine (æ­¤å¤ä½¿ç¨ using ç¡®ä¿æ¨çå®æåå¼æè¢«éæ¯)
            using (CudaEngine cudaEngine = runtime.deserializeCudaEngineByBlob(engineData, (ulong)engineData.Length))
            {
                // ================= 2. åå§åæ¨çä¸ä¸æä¸æ¾å­ =================
                // åå»ºæ§è¡ä¸ä¸æ
                using (JYPPX.TensorRtSharp.Nvinfer.ExecutionContext executionContext = cudaEngine.createExecutionContext(TrtExecutionContextAllocationStrategy.kSTATIC))
                using (CudaStream cudaStream = new CudaStream()) // åå»º CUDA æµç¨äºå¼æ­¥æ§è¡
                {
                    // è·åè¾å¥ç»´åº¦ä¿¡æ¯ (ç¨äºæ ¡éª)
                    Dims inputDims = executionContext.getTensorShape("images");
                    Logger.Instance.INFO($"Input Shape: {inputDims.d[0]}x{inputDims.d[1]}x{inputDims.d[2]}x{inputDims.d[3]}");

                    // è®¡ç®æéæ¾å­å¤§å°
                    // è¾å¥: Batch=1, Channel=3, Height=640, Width=640
                    ulong inputSizeInBytes = 1 * 3 * InputSize * InputSize;
                    // è¾åº: Batch=1, Channels=CategoryNum+4(box)+1(angle), Num=8400
                    int outputChannels = CategoryNum + 4; // 4åæ  + Nç±»å«
                    ulong outputSizeInBytes = (ulong)(1 * outputChannels * OutputSize);

                    Stopwatch sw = new Stopwatch();
                    // åé GPU æ¾å­
                    using (Cuda1DMemory&lt;float&gt; inputGpuMemory = new Cuda1DMemory&lt;float&gt;(inputSizeInBytes))
                    using (Cuda1DMemory&lt;float&gt; outputGpuMemory = new Cuda1DMemory&lt;float&gt;(outputSizeInBytes))
                    {
                        // ç»å®æ¾å­å°åå° TensorRT ä¸ä¸æ
                        executionContext.setInputTensorAddress("images", inputGpuMemory.get());
                        executionContext.setOutputTensorAddress("output0", outputGpuMemory.get());
                        // é¢ç­æ¨ç (å¯éï¼ä½æ¨èï¼å°¤å¶æ¯é¦æ¬¡æ¨çæ¶)
                        executionContext.executeV3(cudaStream);
                        cudaStream.Synchronize();
                        // ================= 3. å¾åé¢å¤ç =================
                        Mat img = Cv2.ImRead(imagePath);
                        if (img.Empty())
                        {
                            Logger.Instance.INFO("Image not found!");
                            return;
                        }

                        sw.Start();
                        float[] inputData = PreProcess(img, out float scale, out int xOffset, out int yOffset);
                        sw.Stop();
                        Logger.Instance.INFO($"Pre-processing time: {sw.ElapsedMilliseconds} ms");
                        // ================= 4. æ¨ç =================
                        // åå¤ä¸»æºåå­æ¥æ¶ç»æ
                        float[] outputData = new float[outputChannels * OutputSize];


                        sw.Restart();
                        // å°æ°æ®ä»ä¸»æº æ·è´å°è®¾å¤
                        inputGpuMemory.copyFromHostAsync(inputData, cudaStream);

                        // æ§è¡æ¨ç (enqueueV3 æ¯å¼æ­¥ç)
                        executionContext.executeV3(cudaStream);
                        // ç­å¾æ¨çå®æ
                        cudaStream.Synchronize();

           

                        // å°ç»æä»è®¾å¤ æ·è´åä¸»æº
                        // è¿éçæ·è´æ¯åæ­¥çï¼ä¼ç­å¾ GPU è®¡ç®å®æ
                        outputGpuMemory.copyToHostAsync(outputData, cudaStream);
                        sw.Stop();
                        Logger.Instance.INFO($"Inference time: {sw.ElapsedMilliseconds} ms");
                        // ================= 5. åå¤ç =================

                        sw.Restart();
                        List&lt;DetData&gt; results = PostProcess(outputData, scale, xOffset, yOffset);
                        sw.Stop();
                        Logger.Instance.INFO($"Post-processing time: {sw.ElapsedMilliseconds} ms");

                        // ================= 6. ç»æå¯è§å =================
                        Mat resultImg = DrawDetResult(results, img);
                        Cv2.ImShow("YOLO11-DET Result", resultImg);
                        Cv2.WaitKey(0);
                    }
                }
            }
        }

        /// &lt;summary&gt;
        /// å¾åé¢å¤çï¼Letterbox ç¼©æ¾ãå½ä¸åãHWC è½¬ CHW
        /// &lt;/summary&gt;
        private static float[] PreProcess(Mat img, out float scale, out int xOffset, out int yOffset)
        {
            // è½¬æ¢é¢è²ç©ºé´ BGR -&gt; RGB
            Mat rgbImg = new Mat();
            Cv2.CvtColor(img, rgbImg, ColorConversionCodes.BGR2RGB);

            // è®¡ç® Letterbox ç¼©æ¾æ¯ä¾
            int maxDim = Math.Max(rgbImg.Width, rgbImg.Height);
            scale = (float)maxDim / InputSize;

            // è®¡ç®ç¼©æ¾åçå°ºå¯¸
            int newWidth = (int)(rgbImg.Width / scale);
            int newHeight = (int)(rgbImg.Height / scale);

            // Resize å¾å
            Mat resizedImg = new Mat();
            Cv2.Resize(rgbImg, resizedImg, new Size(newWidth, newHeight));

            // åå»ºé»è²èæ¯ Canvas (InputSize x InputSize)
            Mat paddedImg = Mat.Zeros(InputSize, InputSize, MatType.CV_8UC3);

            // è®¡ç®ç²è´´ä½ç½® (å±ä¸­)
            xOffset = (InputSize - newWidth) / 2;
            yOffset = (InputSize - newHeight) / 2;

            // å°å¾åæ·è´å° Canvas ä¸­å¤®
            Rect roi = new Rect(xOffset, yOffset, newWidth, newHeight);
            resizedImg.CopyTo(new Mat(paddedImg, roi));

            // å½ä¸å (0-255 -&gt; 0-1) å¹¶è½¬ä¸º float ç±»å
            Mat floatImg = new Mat();
            paddedImg.ConvertTo(floatImg, MatType.CV_32FC3, 1.0 / 255.0);

            // HWC è½¬ CHW å¹¶å±å¹³ä¸ºä¸ç»´æ°ç»
            Mat[] channels = Cv2.Split(floatImg);
            float[] chwData = new float[3 * InputSize * InputSize];

            // æ·è´æ°æ®ï¼Réé -&gt; Céé -&gt; Béé (OpenCV Split åºæ¥é¡ºåºæ¯ B, G, Rï¼å¯¹åºç´¢å¼ 0, 1, 2)
            int channelSize = InputSize * InputSize;
            // å° R, G, B ä¾æ¬¡æ·å¥æ°ç»
            Marshal.Copy(channels[0].Data, chwData, 0, channelSize); // R
            Marshal.Copy(channels[1].Data, chwData, channelSize, channelSize); // G
            Marshal.Copy(channels[2].Data, chwData, channelSize * 2, channelSize); // B

            // éæ¾ä¸´æ¶ Mat
            rgbImg.Dispose();
            resizedImg.Dispose();
            paddedImg.Dispose();
            floatImg.Dispose();
            foreach (var c in channels) c.Dispose();

            return chwData;
        }

        /// &lt;summary&gt;
        /// åå¤çï¼è§£æ TensorRT è¾åºãNMS è¿æ»¤
        /// &lt;/summary&gt;
        private static List&lt;DetData&gt; PostProcess(float[] result, float scale, int xOffset, int yOffset)
        {
            List&lt;Rect&gt; boxes = new List&lt;Rect&gt;();
            List&lt;float&gt; confidences = new List&lt;float&gt;();
            List&lt;int&gt; classIds = new List&lt;int&gt;();

            // éåææé¢æµæ¡ (OutputSize)
            // æ°æ®å¸å±: [4(box) + 80(classes)] * OutputSize
            // å±å¹³æ°ç»ä¸­ï¼åä¸å±æ§çæ°æ®æ¯è¿ç»­å­å¨çï¼ä¾å¦ææ cx å¨ä¸èµ·ï¼ææ cy å¨å¨ä¸èµ·...
            int stride = OutputSize; // æ­¥é¿ï¼ä¸åå±æ§å¨æ°ç»ä¸­çåç§»é

            for (int i = 0; i &lt; OutputSize; i++)
            {
                // æ¥æ¾æå¤§ç±»å«æ¦çåå¶ç´¢å¼
                float maxConf = 0;
                int maxClassId = -1;

                // éåç±»å«
                for (int c = 0; c &lt; CategoryNum; c++)
                {
                    // æ°ç»ç´¢å¼ï¼(åæ /è§åº¦åç§»é + ç±»å«åç§») * æ¡ç´¢å¼
                    // æ³¨æï¼åå§ä»£ç ä¸­ result[outputSize * j + i] è¿ç§è®¿é®æ¹å¼åºäº Transposed æ°æ®å¸å±
                    float conf = result[(4 + c) * stride + i];
                    if (conf &gt; maxConf)
                    {
                        maxConf = conf;
                        maxClassId = c;
                    }
                }

                // ç½®ä¿¡åº¦è¿æ»¤
                if (maxConf &gt; ConfThreshold)
                {
                    // æååæ  (cx, cy, w, h)
                    float cx = result[0 * stride + i];
                    float cy = result[1 * stride + i];
                    float w = result[2 * stride + i];
                    float h = result[3 * stride + i];
                    // è¿ååæ å°åå¾å°ºå¯¸
                    int rx = (int)((cx - xOffset - 0.5 * w) * scale);
                    int ry = (int)((cy - yOffset - 0.5 * h) * scale);
                    int rw = (int)(w * scale);
                    int rh = (int)(h * scale);

                    boxes.Add(new Rect(rx, ry, rw, rh));
                    confidences.Add(maxConf);
                    classIds.Add(maxClassId);
                }
            }

            // æ§è¡ NMS (æè½¬æ¡ NMS)
            // OpenCV ç NMSBoxes æ¯æ RotatedRect
            int[] indices;
            CvDnn.NMSBoxes(boxes, confidences, ConfThreshold, NmsThreshold, out indices);

            List&lt;DetData&gt; finalResults = new List&lt;DetData&gt;();
            foreach (int idx in indices)
            {
                finalResults.Add(new DetData
                {
                    index = classIds[idx],
                    score = confidences[idx],
                    box = boxes[idx]
                });
            }

            return finalResults;
        }

        /// &lt;summary&gt;
        /// ç»å¶æ£æµç»æï¼æ°´å¹³ç©å½¢æ¡ï¼
        /// &lt;/summary&gt;
        /// &lt;param name="results"&gt;æ£æµç»æåè¡¨&lt;/param&gt;
        /// &lt;param name="image"&gt;åå§å¾å&lt;/param&gt;
        /// &lt;returns&gt;ç»å¶åçå¾å&lt;/returns&gt;
        public static Mat DrawDetResult(List&lt;DetData&gt; results, Mat image)
        {
            // åéå¾åä»¥åä¿®æ¹åå¾
            Mat mat = image.Clone();

            foreach (var item in results)
            {
                // 1. ç»å¶ç©å½¢æ¡
                // Rect ç»æåå« X, Y, Width, Height
                Cv2.Rectangle(mat, item.box, new Scalar(0, 255, 0), thickness: 2);
                // 2. åå¤æ ç­¾ææ¬ (ç±»å«ID - ç½®ä¿¡åº¦)
                string label = $"{item.index} - {item.score:F2}";
                // 3. è®¡ç®ææ¬çå°ºå¯¸ï¼ç¨äºç»å¶èæ¯
                int baseLine = 1;
                Size textSize = Cv2.GetTextSize(label, HersheyFonts.HersheySimplex, 0.6, 1, out baseLine);
                // 4. ç»å¶æ ç­¾èæ¯ï¼åéæé»è²ç©å½¢ï¼ï¼é²æ­¢æå­ä¸èæ¯æ··æ·
                // ä½ç½®ï¼ç©å½¢å·¦ä¸è§ç¥å¾®ä¸ç§»ï¼æèç´æ¥è´´çå·¦ä¸è§
                Point labelPosition = new Point(item.box.X, item.box.Y - (int)textSize.Height - 5);

                // ç¡®ä¿æ ç­¾ä¸ç»åºå¾åè¾¹ç
                if (labelPosition.Y &lt; 0) labelPosition.Y = item.box.Y + (int)textSize.Height + 5;
                Rect labelBgRect = new Rect(labelPosition.X,
                                            labelPosition.Y - (int)textSize.Height, // OpenCV GetTextSize è¿åçé«åº¦æ¯åºçº¿å°åºé¨çè·ç¦»ï¼éè°æ´
                                            (int)textSize.Width,
                                            (int)textSize.Height + (int)baseLine);
                // å¦æèæ¯æ¡ä¹å¨å¾åèå´åï¼åç»å¶
                // æ³¨æï¼è¿éç®åå¤çï¼ç´æ¥ç»å¨æ¡ä¸æ¹
                Cv2.Rectangle(mat,
                               new Point(item.box.X, item.box.Y - textSize.Height - 5),
                               new Point(item.box.X + textSize.Width, item.box.Y),
                               new Scalar(0, 255, 0),
                               thickness: -1); // -1 è¡¨ç¤ºå¡«å
                // 5. ç»å¶ææ¬ï¼ç½è²æå­ï¼
                Cv2.PutText(mat,
                            label,
                            new Point(item.box.X, item.box.Y - 5),
                            HersheyFonts.HersheySimplex,
                            0.6,
                            new Scalar(0, 0, 0),
                            1);
            }
            return mat;
        }

        public class DetData
        {
            public int index;
            public float score;
            public Rect box;
        }
    }
}


</code></pre>
<p><strong>ç¨åºè¿è¡ç»æï¼</strong></p>
<p><img alt="æ¨çç»æ" loading="lazy" data-src="https://img2024.cnblogs.com/blog/2933426/202601/2933426-20260111184155202-328383312.png" class="lazyload"></p>
<p><img alt="æ£æµç»æ" loading="lazy" data-src="https://img2024.cnblogs.com/blog/2933426/202601/2933426-20260111184155266-1783868853.png" class="lazyload"></p>
<p><strong>æ§è½æµè¯ç»æï¼</strong></p>
<table>
<thead>
<tr>
<th style="text-align: center">Batch Size</th>
<th style="text-align: center">1</th>
<th style="text-align: center">2</th>
<th style="text-align: center">4</th>
<th style="text-align: center">6</th>
<th style="text-align: center">8</th>
<th style="text-align: center">10</th>
<th style="text-align: center">12</th>
<th style="text-align: center">14</th>
<th style="text-align: center">16</th>
<th style="text-align: center">18</th>
<th style="text-align: center">20</th>
<th style="text-align: center">22</th>
<th style="text-align: center">24</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center">åå¤ç (ms)</td>
<td style="text-align: center">9</td>
<td style="text-align: center">13</td>
<td style="text-align: center">27</td>
<td style="text-align: center">38</td>
<td style="text-align: center">56</td>
<td style="text-align: center">59</td>
<td style="text-align: center">63</td>
<td style="text-align: center">83</td>
<td style="text-align: center">96</td>
<td style="text-align: center">105</td>
<td style="text-align: center">118</td>
<td style="text-align: center">130</td>
<td style="text-align: center">144</td>
</tr>
<tr>
<td style="text-align: center">æ¨¡åæ¨ç (ms)</td>
<td style="text-align: center">7</td>
<td style="text-align: center">15</td>
<td style="text-align: center">24</td>
<td style="text-align: center">36</td>
<td style="text-align: center">48</td>
<td style="text-align: center">60</td>
<td style="text-align: center">96</td>
<td style="text-align: center">84</td>
<td style="text-align: center">93</td>
<td style="text-align: center">153</td>
<td style="text-align: center">120</td>
<td style="text-align: center">133</td>
<td style="text-align: center">203</td>
</tr>
<tr>
<td style="text-align: center">åå¤ç (ms)</td>
<td style="text-align: center">25</td>
<td style="text-align: center">26</td>
<td style="text-align: center">26</td>
<td style="text-align: center">26</td>
<td style="text-align: center">28</td>
<td style="text-align: center">27</td>
<td style="text-align: center">27</td>
<td style="text-align: center">28</td>
<td style="text-align: center">28</td>
<td style="text-align: center">28</td>
<td style="text-align: center">27</td>
<td style="text-align: center">31</td>
<td style="text-align: center">29</td>
</tr>
</tbody>
</table>
<blockquote>
<p>ð<strong>ç¨åºè·¯å¾é¾æ¥</strong>ï¼å®æ´ç¨åºå·²ç»ä¸ä¼ å°GitHubï¼è¯·èªè¡ä¸è½½ï¼é¾æ¥ä¸ºï¼</p>
<pre><code>https://github.com/guojin-yan/TensorRT-CSharp-API/tree/TensorRtSharp3.0/samples/YoloDetInfer
</code></pre>
<p>åæ¶ä¹æä¾äº<strong>YoloOBB</strong>æ¨¡åçæ¨çç¨åºï¼è¯·èªè¡ä¸è½½ï¼é¾æ¥ä¸ºï¼</p>
<pre><code>https://github.com/guojin-yan/TensorRT-CSharp-API/tree/TensorRtSharp3.0/samples/YoloObbInfer
</code></pre>
</blockquote>
<hr>
<h3 id="ç¤ºä¾-4å¨æå½¢ç¶æ¨ç">ç¤ºä¾ 4ï¼å¨æå½¢ç¶æ¨ç</h3>
<p>å¯¹äºè¾å¥å°ºå¯¸å¯åçæ¨¡åï¼éè¦æ ¹æ®è¾å¥çæ°æ®éç½®å¨æå½¢ç¶ã</p>
<p><strong>æ ¸å¿ä»£ç ï¼</strong></p>
<pre><code class="language-csharp">using JYPPX.TensorRtSharp.Cuda;
using JYPPX.TensorRtSharp.Nvinfer;
using OpenCvSharp;
using OpenCvSharp.Dnn;
using System.Diagnostics;
using System.Runtime.InteropServices;

namespace YoloObbBatchInfer
{
    internal class Program
    {
        // ================= éç½®åæ° =================
        // æ¨¡åè¾å¥å°ºå¯¸ (å®½=é«)
        private const int InputSize = 1024;
        // å»ºè®®æ ¹æ®å®éæ¨¡åå¨æè·åæä½¿ç¨ Netron æ¥ç
        private const int OutputSize = 21504;
        // æ¨¡åç±»å«æ° (æ ¹æ®æ¨çå·ä½æ°æ®éä¿®æ¹ï¼æ­¤å¤åè®¾ä¸º15ç±»)
        private const int CategoryNum = 15;
        // ç½®ä¿¡åº¦éå¼
        private const float ConfThreshold = 0.25f;

        // NMS IOU éå¼
        private const float NmsThreshold = 0.3f;
        private const int MaxBatchSize = 24;
        static void Main(string[] args)
        {
            //  ============= éç½® TensorRT æ¥å¿åè° =============
            // å®ä¹ä¸ä¸ªå§æï¼ç¨äºå¤ç TensorRT åé¨äº§ççæ¥å¿æ¶æ¯ã
            // è¿åè®¸æä»¬å° C++ å±é¢çæ¥å¿è¾åºå° C# çæ§å¶å°ã
            LogCallbackFunction _callbackDelegate = (message) =&gt;
            {
                Console.WriteLine(message);
            };
            // å°èªå®ä¹çåè°å½æ°æ³¨åç» TensorRT çå¨å± Logger å®ä¾ã
            Logger.Instance.SetCallback(_callbackDelegate);

            // è®¾ç½®æ¥å¿çä¸¥éæ§çº§å«éå¼ã
            // LoggerSeverity.kINFO: æå°ä¿¡æ¯ãè­¦ååéè¯¯ã
            // å¼åè°è¯é¶æ®µéå¸¸è®¾ä¸º kINFO æ kVERBOSEï¼çäº§ç¯å¢å¯è®¾ä¸º kWARNING æ kERROR ä»¥åå°è¾åºã
            Logger.Instance.SetThreshold(LoggerSeverity.kINFO);

            string enginePath = "yolov8s-obb_b.engine";
            string[] imagePaths = { 
                "P0006.png" , "P0016.png", "P0456.png", "P0813.png"};
            // ================= 1. å è½½ TensorRT Engine =================
            // ä½¿ç¨ using è¯­å¥ç¡®ä¿æä»¶æµæ­£ç¡®å³é­
            byte[] engineData;
            using (FileStream fs = new FileStream(enginePath, FileMode.Open, FileAccess.Read))
            using (BinaryReader br = new BinaryReader(fs))
            {
                engineData = br.ReadBytes((int)fs.Length);
            }

            // ååºåå Engine
            // Runtime å¿é¡»å¨ Engine çå½å¨æåä¿æå­æ´»ï¼éå¸¸å»ºè®®è®¾ä¸ºå¨å±æéæï¼æèç¡®ä¿å®æåéæ¾
            Runtime runtime = new Runtime();
            runtime.setMaxThreads(10);
            // åå»º CudaEngine (æ­¤å¤ä½¿ç¨ using ç¡®ä¿æ¨çå®æåå¼æè¢«éæ¯)
            using (CudaEngine cudaEngine = runtime.deserializeCudaEngineByBlob(engineData, (ulong)engineData.Length))
            {
                // ================= 2. åå§åæ¨çä¸ä¸æä¸æ¾å­ =================
                // åå»ºæ§è¡ä¸ä¸æ
                using (JYPPX.TensorRtSharp.Nvinfer.ExecutionContext executionContext = cudaEngine.createExecutionContext(TrtExecutionContextAllocationStrategy.kSTATIC))
                using (CudaStream cudaStream = new CudaStream()) // åå»º CUDA æµç¨äºå¼æ­¥æ§è¡
                {
                    // è·åè¾å¥ç»´åº¦ä¿¡æ¯ (ç¨äºæ ¡éª)
                    Dims inputDims = executionContext.getTensorShape("images");
                    Logger.Instance.INFO($"Input Shape: {inputDims.d[0]}x{inputDims.d[1]}x{inputDims.d[2]}x{inputDims.d[3]}");

                    // è®¡ç®æéæ¾å­å¤§å°
                    // è¾å¥: Batch=1, Channel=3, Height=1024, Width=1024
                    ulong inputSizeInBytes = MaxBatchSize * 3 * InputSize * InputSize;
                    // è¾åº: Batch=1, Channels=CategoryNum+4(box)+1(angle), Num=8400
                    int outputChannels = CategoryNum + 5; // 4åæ  + 1è§åº¦ + Nç±»å«
                    ulong outputSizeInBytes = (ulong)(MaxBatchSize * outputChannels * OutputSize);

                    Stopwatch sw = new Stopwatch();
                    // åé GPU æ¾å­
                    using (Cuda1DMemory&lt;float&gt; inputGpuMemory = new Cuda1DMemory&lt;float&gt;(inputSizeInBytes))
                    using (Cuda1DMemory&lt;float&gt; outputGpuMemory = new Cuda1DMemory&lt;float&gt;(outputSizeInBytes))
                    {
                        // ç»å®æ¾å­å°åå° TensorRT ä¸ä¸æ
                        executionContext.setInputTensorAddress("images", inputGpuMemory.get());
                        executionContext.setOutputTensorAddress("output0", outputGpuMemory.get());

                        // å³é®ä¸æ­¥ï¼ä¿®æ¹æ¬æ¬¡æ¨ççå½¢ç¶
                        executionContext.setinputShape("images", new Dims(imagePaths.Count(), 3, 1024, 1024));
                        // é¢ç­æ¨ç (å¯éï¼ä½æ¨èï¼å°¤å¶æ¯é¦æ¬¡æ¨çæ¶)
                        executionContext.executeV3(cudaStream);
                        cudaStream.Synchronize();

                        // ================= 3. å¾åé¢å¤ç =================
                        List&lt;Mat&gt; images = new List&lt;Mat&gt;();
                        foreach (var path in imagePaths) 
                        {
                            Mat img = Cv2.ImRead(path);
                            if (img.Empty())
                            {
                                Logger.Instance.INFO("Image not found!");
                                return;
                            }
                            images.Add(img);
                        }

                        (float[] inputData1, float[] scales1, int[] xOffsets1, int[] yOffsets1) = PreProcessBatch(images);
                        sw.Start();
                        (float[] inputData, float[] scales, int[] xOffsets, int[] yOffsets) = PreProcessBatch(images);
                        sw.Stop();
                        Logger.Instance.INFO($"Pre-processing time: {sw.ElapsedMilliseconds} ms");
                        // ================= 4. æ¨ç =================

                        // åå¤ä¸»æºåå­æ¥æ¶ç»æ
                        float[] outputData1 = new float[imagePaths.Count() * outputChannels * OutputSize];
                        // å°æ°æ®ä»ä¸»æº æ·è´å°è®¾å¤
                        inputGpuMemory.copyFromHostAsync(inputData, cudaStream);

                        // æ§è¡æ¨ç (enqueueV3 æ¯å¼æ­¥ç)
                        executionContext.executeV3(cudaStream);
                        // ç­å¾æ¨çå®æ
                        cudaStream.Synchronize();
                        // å°ç»æä»è®¾å¤ æ·è´åä¸»æº
                        // è¿éçæ·è´æ¯åæ­¥çï¼ä¼ç­å¾ GPU è®¡ç®å®æ
                        outputGpuMemory.copyToHostAsync(outputData1, cudaStream);

                        sw.Restart();
                        // åå¤ä¸»æºåå­æ¥æ¶ç»æ
                        float[] outputData = new float[imagePaths.Count() * outputChannels * OutputSize];
                        // å°æ°æ®ä»ä¸»æº æ·è´å°è®¾å¤
                        inputGpuMemory.copyFromHostAsync(inputData, cudaStream);

                        // æ§è¡æ¨ç (enqueueV3 æ¯å¼æ­¥ç)
                        executionContext.executeV3(cudaStream);
                        // ç­å¾æ¨çå®æ
                        cudaStream.Synchronize();
                        // å°ç»æä»è®¾å¤ æ·è´åä¸»æº
                        // è¿éçæ·è´æ¯åæ­¥çï¼ä¼ç­å¾ GPU è®¡ç®å®æ
                        outputGpuMemory.copyToHostAsync(outputData, cudaStream);

                        sw.Stop();
                        Logger.Instance.INFO($"Inference time: {sw.ElapsedMilliseconds} ms");
                        // ================= 5. åå¤ç =================
                        List&lt;List&lt;ObbData&gt;&gt; results1 = PostProcessBatch(outputData, scales, xOffsets, yOffsets);
                        sw.Restart();
                        List&lt;List&lt;ObbData&gt;&gt; results = PostProcessBatch(outputData, scales, xOffsets, yOffsets);
                        sw.Stop();
                        Logger.Instance.INFO($"Post-processing time: {sw.ElapsedMilliseconds} ms");

                        // ================= 6. ç»æå¯è§å =================
                        List&lt;Mat&gt; resultMats = new List&lt;Mat&gt;();
                        for(int i = 0; i &lt; results.Count; ++i)
                        {
                            resultMats.Add(DrawObbResult(results[i], images[i]));
                        }
                        Mat putResultImgs = StitchHorizontalWithPadding(resultMats);
                        Cv2.ImWrite("YOLO11-OBB Result.png", putResultImgs);
                        Cv2.ImShow("YOLO11-OBB Result", putResultImgs);
                        Cv2.WaitKey(0);
                    }
                }
            }
        }

        /// &lt;summary&gt;
        /// å¾åé¢å¤çï¼Letterbox ç¼©æ¾ãå½ä¸åãHWC è½¬ CHW
        /// &lt;/summary&gt;
        private static (float[], float[] ,  int[] , int[] ) PreProcessBatch(List&lt;Mat&gt; imgs)
        {
            int dataLen = 3 * InputSize * InputSize;
            float[] chwData = new float[imgs.Count * dataLen];
            float[] scales = new float[imgs.Count];
            int[] xOffsets = new int[imgs.Count];
            int[]  yOffsets = new int[imgs.Count];
            Parallel.For(0, imgs.Count, i =&gt;
            {
                Mat img = imgs[i];
                // è½¬æ¢é¢è²ç©ºé´ BGR -&gt; RGB
                Mat rgbImg = new Mat();
                Cv2.CvtColor(img, rgbImg, ColorConversionCodes.BGR2RGB);

                // è®¡ç® Letterbox ç¼©æ¾æ¯ä¾
                int maxDim = Math.Max(rgbImg.Width, rgbImg.Height);
                scales[i] = (float)maxDim / InputSize;

                // è®¡ç®ç¼©æ¾åçå°ºå¯¸
                int newWidth = (int)(rgbImg.Width / scales[i]);
                int newHeight = (int)(rgbImg.Height / scales[i]);

                // Resize å¾å
                Mat resizedImg = new Mat();
                Cv2.Resize(rgbImg, resizedImg, new Size(newWidth, newHeight));

                // åå»ºé»è²èæ¯ Canvas (InputSize x InputSize)
                Mat paddedImg = Mat.Zeros(InputSize, InputSize, MatType.CV_8UC3);

                // è®¡ç®ç²è´´ä½ç½® (å±ä¸­)
                xOffsets[i] = (InputSize - newWidth) / 2;
                yOffsets[i] = (InputSize - newHeight) / 2;

                // å°å¾åæ·è´å° Canvas ä¸­å¤®
                Rect roi = new Rect(xOffsets[i], yOffsets[i], newWidth, newHeight);
                resizedImg.CopyTo(new Mat(paddedImg, roi));

                // å½ä¸å (0-255 -&gt; 0-1) å¹¶è½¬ä¸º float ç±»å
                Mat floatImg = new Mat();
                paddedImg.ConvertTo(floatImg, MatType.CV_32FC3, 1.0 / 255.0);

                // HWC è½¬ CHW å¹¶å±å¹³ä¸ºä¸ç»´æ°ç»
                Mat[] channels = Cv2.Split(floatImg);


                // æ·è´æ°æ®ï¼Réé -&gt; Céé -&gt; Béé (OpenCV Split åºæ¥é¡ºåºæ¯ B, G, Rï¼å¯¹åºç´¢å¼ 0, 1, 2)
                int channelSize = InputSize * InputSize;
                // å° R, G, B ä¾æ¬¡æ·å¥æ°ç»
                Marshal.Copy(channels[0].Data, chwData, dataLen * i, channelSize); // R
                Marshal.Copy(channels[1].Data, chwData, dataLen * i + channelSize, channelSize); // G
                Marshal.Copy(channels[2].Data, chwData, dataLen * i + channelSize * 2, channelSize); // B

                // éæ¾ä¸´æ¶ Mat
                rgbImg.Dispose();
                resizedImg.Dispose();
                paddedImg.Dispose();
                floatImg.Dispose();
                foreach (var c in channels) c.Dispose();
            });



            return (chwData, scales, xOffsets, yOffsets);
        }

        /// &lt;summary&gt;
        /// åå¤çï¼è§£æ TensorRT è¾åºãNMS è¿æ»¤
        /// &lt;/summary&gt;
        private static List&lt;List&lt;ObbData&gt;&gt; PostProcessBatch(float[] result, float[] scales, int[] xOffsets, int[] yOffsets)
        {
            List&lt;ObbData&gt;[] obbDatas = new List&lt;ObbData&gt;[scales.Length];

            Parallel.For(0, scales.Length, b =&gt;
            {
                List&lt;RotatedRect&gt; boxes = new List&lt;RotatedRect&gt;();
                List&lt;float&gt; confidences = new List&lt;float&gt;();
                List&lt;int&gt; classIds = new List&lt;int&gt;();

                // éåææé¢æµæ¡ (OutputSize)
                // æ°æ®å¸å±: [4(box) + 15(classes) + 1(angle)] * OutputSize
                // å±å¹³æ°ç»ä¸­ï¼åä¸å±æ§çæ°æ®æ¯è¿ç»­å­å¨çï¼ä¾å¦ææ cx å¨ä¸èµ·ï¼ææ cy å¨å¨ä¸èµ·...
                int stride = OutputSize; // æ­¥é¿ï¼ä¸åå±æ§å¨æ°ç»ä¸­çåç§»é

                int resultDataOffset = OutputSize * (CategoryNum + 5) * b;

                for (int i = 0; i &lt; OutputSize; i++)
                {
                    // æ¥æ¾æå¤§ç±»å«æ¦çåå¶ç´¢å¼
                    float maxConf = 0;
                    int maxClassId = -1;

                    // éåç±»å« 
                    for (int c = 0; c &lt; CategoryNum; c++)
                    {
                        // æ°ç»ç´¢å¼ï¼(åæ /è§åº¦åç§»é + ç±»å«åç§») * æ¡ç´¢å¼
                        // æ³¨æï¼åå§ä»£ç ä¸­ result[outputSize * j + i] è¿ç§è®¿é®æ¹å¼åºäº Transposed æ°æ®å¸å±
                        float conf = result[(4 + c) * stride + i + resultDataOffset];
                        if (conf &gt; maxConf)
                        {
                            maxConf = conf;
                            maxClassId = c;
                        }
                    }

                    // ç½®ä¿¡åº¦è¿æ»¤
                    if (maxConf &gt; ConfThreshold)
                    {
                        // æååæ  (cx, cy, w, h)
                        float cx = result[0 * stride + i + resultDataOffset];
                        float cy = result[1 * stride + i + resultDataOffset];
                        float w = result[2 * stride + i + resultDataOffset];
                        float h = result[3 * stride + i + resultDataOffset];

                        // æåè§åº¦ (éå¸¸å¨ç¬¬ 5 ä¸ªä½ç½®ï¼å³ç±»å«ä¹å)
                        float angleRad = result[(CategoryNum + 4) * stride + i + resultDataOffset];

                        // è¿ååæ å°åå¾å°ºå¯¸
                        float rx = (cx - xOffsets[b]) * scales[b];
                        float ry = (cy - yOffsets[b]) * scales[b];
                        float rw = w * scales[b];
                        float rh = h * scales[b];

                        // å°å¼§åº¦è½¬æ¢ä¸ºè§åº¦
                        // Normalize angle to [-Ï/2, Ï/2] range
                        // å°è§åº¦å½ä¸åå°[-Ï/2, Ï/2]èå´
                        if (angleRad &gt;= Math.PI &amp;&amp; angleRad &lt;= 0.75 * Math.PI)
                        {
                            angleRad -= (float)Math.PI;
                        }
                        float angleDeg = angleRad * (float)(180f / Math.PI);  // Convert to degrees/è½¬æ¢ä¸ºè§åº¦å¶

                        boxes.Add(new RotatedRect(new Point2f(rx, ry), new Size2f(rw, rh), angleDeg));
                        confidences.Add(maxConf);
                        classIds.Add(maxClassId);
                    }
                }

                // æ§è¡ NMS (æè½¬æ¡ NMS)
                // OpenCV ç NMSBoxes æ¯æ RotatedRect
                int[] indices;
                CvDnn.NMSBoxes(boxes, confidences, ConfThreshold, NmsThreshold, out indices);

                List&lt;ObbData&gt; finalResults = new List&lt;ObbData&gt;();
                foreach (int idx in indices)
                {
                    finalResults.Add(new ObbData
                    {
                        index = classIds[idx],
                        score = confidences[idx],
                        box = boxes[idx]
                    });
                }
                obbDatas[b] = finalResults;
            });

           

            return obbDatas.Select(x =&gt; x?.ToList() ?? new List&lt;ObbData&gt;()).ToList();
        }

        /// &lt;summary&gt;
        /// ç»å¶æè½¬æ£æµç»æ
        /// &lt;/summary&gt;
        public static Mat DrawObbResult(List&lt;ObbData&gt; results, Mat image)
        {
            // åéå¾åä»¥åä¿®æ¹åå¾
            Mat mat = image.Clone();

            foreach (var item in results)
            {
                // è·åæè½¬ç©å½¢çåä¸ªé¡¶ç¹
                Point2f[] points = item.box.Points();

                // ç»å¶å¤è¾¹å½¢æ¡
                for (int j = 0; j &lt; 4; j++)
                {
                    Cv2.Line(mat, (Point)points[j], (Point)points[(j + 1) % 4],
                            new Scalar(0, 255, 0), 2);
                }

                // ç»å¶æ ç­¾ (ç±»å« - ç½®ä¿¡åº¦)
                string label = $"{item.index} - {item.score:F2}";
                Point2f textPos = points[0]; // å·¦ä¸è§

                Cv2.PutText(mat, label, (Point)textPos, HersheyFonts.HersheySimplex, 0.8,
                            new Scalar(255, 0, 0), 2);
            }

            return mat;
        }

        public class ObbData
        {
            public int index;
            public float score;
            public RotatedRect box;
        }


        /// &lt;summary&gt;
        /// æºè½æ°´å¹³æ¼æ¥ï¼èªå¨å¤çé«åº¦ä¸ä¸è´çå¾ç
        /// &lt;/summary&gt;
        /// &lt;param name="images"&gt;å¾çåè¡¨&lt;/param&gt;
        /// &lt;param name="backgroundColor"&gt;å¡«åèæ¯é¢è²ï¼é»è®¤ä¸ºé»è²&lt;/param&gt;
        /// &lt;returns&gt;æ¼æ¥åç Mat&lt;/returns&gt;
        public static Mat StitchHorizontalWithPadding(List&lt;Mat&gt; images, Scalar? backgroundColor = null)
        {
            if (images == null || images.Count == 0)
                return new Mat();
            // 1. æ¾å°ææå¾çä¸­çæå¤§é«åº¦
            int maxHeight = images.Max(img =&gt; img.Rows);
            // è®¡ç®æ»å®½åº¦
            int totalWidth = images.Sum(img =&gt; img.Cols);
            // 2. åå¤ç»æç»å¸
            Mat result = new Mat(maxHeight, totalWidth, images[0].Type(), backgroundColor ?? Scalar.Black);
            // 3. å°æ¯ä¸å¼ å¾çå¤å¶å°ç»å¸çå¯¹åºä½ç½®
            int currentX = 0; // å½å X è½´åç§»é
            foreach (var img in images)
            {
                if (img.Empty()) continue;
                // è®¡ç®å½åå¾çéè¦åç´åç§»å¤å°ï¼åºé¨å¯¹é½é»è¾ï¼
                // å¦ææ³é¡¶é¨å¯¹é½ï¼yOffset = 0
                // å¦ææ³å±ä¸­ï¼yOffset = (maxHeight - img.Rows) / 2
                int yOffset = maxHeight - img.Rows;
                // å®ä¹ ROI (æå´è¶£åºå)
                Rect roi = new Rect(currentX, yOffset, img.Cols, img.Rows);

                // å°åå¾çæ·è´å°ç»æå¾ç ROI åºå
                img.CopyTo(new Mat(result, roi));
                // ç§»å¨ X è½´æé
                currentX += img.Cols;
            }
            return result;
        }
    }
}


</code></pre>
<p>ä¸å¾ä¸ºä¸è¿°ç¨åºè¿è¡åçè¾åºï¼æ¨¡åè¾å¥å½¢ç¶ä¸º -1x3x1024x1024ï¼å¶ä¸­Batch Sizeä¸ºå¨æè¾å¥ï¼é¡¹ç®ç¤ºä¾ä½¿ç¨äºåå¼ å¾çè¿è¡åæ¶æ¨çï¼å¼å¯å¹¶è¡å¤çåï¼åå¼ å¾åé¢å¤çæ¶é´ä»ç¨21msï¼æ¨çæ¶é´ä¸º25msï¼åå¤çæ¶é´ä¸º26msï¼ç´¯è®¡æ¶é´ä¸º72ms.</p>
<p><img alt="image-20260109225451392" loading="lazy" data-src="https://img2024.cnblogs.com/blog/2933426/202601/2933426-20260111184155252-292402880.png" class="lazyload"></p>
<p>ä¸å¾ä¸ºæ¨çç»æå±ç¤ºï¼</p>
<p><img alt="YOLO11-OBB Result" loading="lazy" data-src="https://img2024.cnblogs.com/blog/2933426/202601/2933426-20260111184156266-602207018.png" class="lazyload"></p>
<p><strong>æ§è½æµè¯ï¼ä¸å Batch Sizeï¼ï¼</strong></p>
<p>ä¸ºäºæ¢ç©¶ä¸åBatch Sizeæ¨çæ¶é´å·®å¼ï¼æ­¤å¤å¯¹ä¸åBatch Sizeè¿è¡äºæµè¯ï¼æµè¯ç»æå¦ä¸ï¼</p>
<table>
<thead>
<tr>
<th style="text-align: center">Batch Size</th>
<th style="text-align: center">1</th>
<th style="text-align: center">2</th>
<th style="text-align: center">4</th>
<th style="text-align: center">6</th>
<th style="text-align: center">8</th>
<th style="text-align: center">10</th>
<th style="text-align: center">12</th>
<th style="text-align: center">14</th>
<th style="text-align: center">16</th>
<th style="text-align: center">18</th>
<th style="text-align: center">20</th>
<th style="text-align: center">22</th>
<th style="text-align: center">24</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center">åå¤ç (ms )</td>
<td style="text-align: center">9</td>
<td style="text-align: center">13</td>
<td style="text-align: center">27</td>
<td style="text-align: center">38</td>
<td style="text-align: center">56</td>
<td style="text-align: center">59</td>
<td style="text-align: center">63</td>
<td style="text-align: center">83</td>
<td style="text-align: center">96</td>
<td style="text-align: center">105</td>
<td style="text-align: center">118</td>
<td style="text-align: center">130</td>
<td style="text-align: center">144</td>
</tr>
<tr>
<td style="text-align: center">æ¨¡åæ¨ç (ms)</td>
<td style="text-align: center">7</td>
<td style="text-align: center">15</td>
<td style="text-align: center">24</td>
<td style="text-align: center">36</td>
<td style="text-align: center">48</td>
<td style="text-align: center">60</td>
<td style="text-align: center">96</td>
<td style="text-align: center">84</td>
<td style="text-align: center">93</td>
<td style="text-align: center">153</td>
<td style="text-align: center">120</td>
<td style="text-align: center">133</td>
<td style="text-align: center">203</td>
</tr>
<tr>
<td style="text-align: center">åå¤ç (ms)</td>
<td style="text-align: center">25</td>
<td style="text-align: center">26</td>
<td style="text-align: center">26</td>
<td style="text-align: center">26</td>
<td style="text-align: center">28</td>
<td style="text-align: center">27</td>
<td style="text-align: center">27</td>
<td style="text-align: center">28</td>
<td style="text-align: center">28</td>
<td style="text-align: center">28</td>
<td style="text-align: center">27</td>
<td style="text-align: center">31</td>
<td style="text-align: center">29</td>
</tr>
</tbody>
</table>
<blockquote>
<p>ð<strong>ç¨åºè·¯å¾é¾æ¥</strong>ï¼å®æ´ç¨åºå·²ç»ä¸ä¼ å°GitHubï¼è¯·èªè¡ä¸è½½ï¼é¾æ¥ä¸ºï¼</p>
<pre><code>https://github.com/guojin-yan/TensorRT-CSharp-API/tree/TensorRtSharp3.0/samples/YoloObbBatchInfer
</code></pre>
</blockquote>
<hr>
<h3 id="ç¤ºä¾-5å¹¶è¡æ¨ç">ç¤ºä¾ 5ï¼å¹¶è¡æ¨ç</h3>
<p>ä½¿ç¨ä¸ä¸ª Runtime åå»ºå¤æ§è¡ä¸ä¸æï¼å®ç°å¤å¹¶è¡æ¨çã</p>
<p><strong>æ ¸å¿ä»£ç ï¼</strong></p>
<pre><code class="language-csharp">using JYPPX.TensorRtSharp.Cuda;
using JYPPX.TensorRtSharp.Nvinfer;
using OpenCvSharp;
using OpenCvSharp.Dnn;
using System.Diagnostics;
using System.Runtime.InteropServices;
using static OpenCvSharp.FileStorage;

namespace YoloDetParallelInfer
{
    internal class Program
    {
        // ================= éç½®åæ° =================
        // æ¨¡åè¾å¥å°ºå¯¸ (å®½=é«)
        private const int InputSize = 640;


        // å»ºè®®æ ¹æ®å®éæ¨¡åå¨æè·åæä½¿ç¨ Netron æ¥ç
        private const int OutputSize = 8400;

        // æ¨¡åç±»å«æ° (æ ¹æ®æ¨çå·ä½æ°æ®éä¿®æ¹ï¼æ­¤å¤åè®¾ä¸º15ç±»)
        private const int CategoryNum = 80;

        // ç½®ä¿¡åº¦éå¼
        private const float ConfThreshold = 0.25f;

        // NMS IOU éå¼
        private const float NmsThreshold = 0.3f;

        static void Main(string[] args)
        {
            //  ============= éç½® TensorRT æ¥å¿åè° =============
            // å®ä¹ä¸ä¸ªå§æï¼ç¨äºå¤ç TensorRT åé¨äº§ççæ¥å¿æ¶æ¯ã
            // è¿åè®¸æä»¬å° C++ å±é¢çæ¥å¿è¾åºå° C# çæ§å¶å°ã
            LogCallbackFunction _callbackDelegate = (message) =&gt;
            {
                Console.WriteLine(message);
            };

            // å°èªå®ä¹çåè°å½æ°æ³¨åç» TensorRT çå¨å± Logger å®ä¾ã
            Logger.Instance.SetCallback(_callbackDelegate);

            // è®¾ç½®æ¥å¿çä¸¥éæ§çº§å«éå¼ã
            // LoggerSeverity.kINFO: æå°ä¿¡æ¯ãè­¦ååéè¯¯ã
            // å¼åè°è¯é¶æ®µéå¸¸è®¾ä¸º kINFO æ kVERBOSEï¼çäº§ç¯å¢å¯è®¾ä¸º kWARNING æ kERROR ä»¥åå°è¾åºã
            Logger.Instance.SetThreshold(LoggerSeverity.kINFO);

            string enginePath = "yolov8s.engine";
            string imagePath = "bus.jpg";

                           Mat img = Cv2.ImRead(imagePath);
                            if (img.Empty())
                            {
                                Logger.Instance.INFO("Image not found!");
                                return;
                            }
            // ================= 1. å è½½ TensorRT Engine =================
            // ä½¿ç¨ using è¯­å¥ç¡®ä¿æä»¶æµæ­£ç¡®å³é­
            byte[] engineData;
            using (FileStream fs = new FileStream(enginePath, FileMode.Open, FileAccess.Read))
            using (BinaryReader br = new BinaryReader(fs))
            {
                engineData = br.ReadBytes((int)fs.Length);
            }

            // ååºåå Engine
            // Runtime å¿é¡»å¨ Engine çå½å¨æåä¿æå­æ´»ï¼éå¸¸å»ºè®®è®¾ä¸ºå¨å±æéæï¼æèç¡®ä¿å®æåéæ¾
            Runtime runtime = new Runtime();
            runtime.setMaxThreads(6);
            // åå»º CudaEngine (æ­¤å¤ä½¿ç¨ using ç¡®ä¿æ¨çå®æåå¼æè¢«éæ¯)
            using (CudaEngine cudaEngine = runtime.deserializeCudaEngineByBlob(engineData, (ulong)engineData.Length))
            {
                // ================= 2. åå§åæ¨çä¸ä¸æä¸æ¾å­ =================
                Stopwatch totalSw = new Stopwatch();
                totalSw.Start();
                Parallel.For(0, 24, b =&gt;
                {           
                    
                    // åå»ºæ§è¡ä¸ä¸æ
                    using (JYPPX.TensorRtSharp.Nvinfer.ExecutionContext executionContext = cudaEngine.createExecutionContext(TrtExecutionContextAllocationStrategy.kSTATIC))
                    using (CudaStream cudaStream = new CudaStream()) // åå»º CUDA æµç¨äºå¼æ­¥æ§è¡
                    {
                        // è·åè¾å¥ç»´åº¦ä¿¡æ¯ (ç¨äºæ ¡éª)
                        Dims inputDims = executionContext.getTensorShape("images");
                        Logger.Instance.INFO($"Input Shape: {inputDims.d[0]}x{inputDims.d[1]}x{inputDims.d[2]}x{inputDims.d[3]}");

                        // è®¡ç®æéæ¾å­å¤§å°
                        // è¾å¥: Batch=1, Channel=3, Height=640, Width=640
                        ulong inputSizeInBytes = 1 * 3 * InputSize * InputSize;
                        // è¾åº: Batch=1, Channels=CategoryNum+4(box)+1(angle), Num=8400
                        int outputChannels = CategoryNum + 4; // 4åæ  + Nç±»å«
                        ulong outputSizeInBytes = (ulong)(1 * outputChannels * OutputSize);

                        Stopwatch sw = new Stopwatch();
                        // åé GPU æ¾å­
                        using (Cuda1DMemory&lt;float&gt; inputGpuMemory = new Cuda1DMemory&lt;float&gt;(inputSizeInBytes))
                        using (Cuda1DMemory&lt;float&gt; outputGpuMemory = new Cuda1DMemory&lt;float&gt;(outputSizeInBytes))
                        {
                            // ç»å®æ¾å­å°åå° TensorRT ä¸ä¸æ
                            executionContext.setInputTensorAddress("images", inputGpuMemory.get());
                            executionContext.setOutputTensorAddress("output0", outputGpuMemory.get());
                            // é¢ç­æ¨ç (å¯éï¼ä½æ¨èï¼å°¤å¶æ¯é¦æ¬¡æ¨çæ¶)
                            executionContext.executeV3(cudaStream);
                            cudaStream.Synchronize();
                            // ================= 3. å¾åé¢å¤ç =================
             

                            sw.Start();
                            float[] inputData = PreProcess(img, out float scale, out int xOffset, out int yOffset);
                            sw.Stop();
                            Logger.Instance.INFO($"Channel {b}: Pre-processing time: {sw.ElapsedMilliseconds} ms");
                            // ================= 4. æ¨ç =================
                            // åå¤ä¸»æºåå­æ¥æ¶ç»æ
                            float[] outputData = new float[outputChannels * OutputSize];


                            sw.Restart();
                            // å°æ°æ®ä»ä¸»æº æ·è´å°è®¾å¤
                            inputGpuMemory.copyFromHostAsync(inputData, cudaStream);

                            // æ§è¡æ¨ç (enqueueV3 æ¯å¼æ­¥ç)
                            executionContext.executeV3(cudaStream);
                            // ç­å¾æ¨çå®æ
                            cudaStream.Synchronize();



                            // å°ç»æä»è®¾å¤ æ·è´åä¸»æº
                            // è¿éçæ·è´æ¯åæ­¥çï¼ä¼ç­å¾ GPU è®¡ç®å®æ
                            outputGpuMemory.copyToHostAsync(outputData, cudaStream);
                            sw.Stop();
                            Logger.Instance.INFO($"Channel {b}: Inference time: {sw.ElapsedMilliseconds} ms");
                            // ================= 5. åå¤ç =================

                            sw.Restart();
                            List&lt;DetData&gt; results = PostProcess(outputData, scale, xOffset, yOffset);
                            sw.Stop();
                            Logger.Instance.INFO($"Channel {b}: Post-processing time: {sw.ElapsedMilliseconds} ms");

                            // ================= 6. ç»æå¯è§å =================
                            //Mat resultImg = DrawDetResult(results, img);
                            //Cv2.ImShow("YOLO11-DET Result", resultImg);
                            //Cv2.WaitKey(0);
                        }
                    }
                });

                totalSw.Stop();
                Logger.Instance.INFO($"Total time for 8 inferences: {totalSw.ElapsedMilliseconds} ms");


            }
        }

        /// &lt;summary&gt;
        /// å¾åé¢å¤çï¼Letterbox ç¼©æ¾ãå½ä¸åãHWC è½¬ CHW
        /// &lt;/summary&gt;
        private static float[] PreProcess(Mat img, out float scale, out int xOffset, out int yOffset)
        {
            // è½¬æ¢é¢è²ç©ºé´ BGR -&gt; RGB
            Mat rgbImg = new Mat();
            Cv2.CvtColor(img, rgbImg, ColorConversionCodes.BGR2RGB);

            // è®¡ç® Letterbox ç¼©æ¾æ¯ä¾
            int maxDim = Math.Max(rgbImg.Width, rgbImg.Height);
            scale = (float)maxDim / InputSize;

            // è®¡ç®ç¼©æ¾åçå°ºå¯¸
            int newWidth = (int)(rgbImg.Width / scale);
            int newHeight = (int)(rgbImg.Height / scale);

            // Resize å¾å
            Mat resizedImg = new Mat();
            Cv2.Resize(rgbImg, resizedImg, new Size(newWidth, newHeight));

            // åå»ºé»è²èæ¯ Canvas (InputSize x InputSize)
            Mat paddedImg = Mat.Zeros(InputSize, InputSize, MatType.CV_8UC3);

            // è®¡ç®ç²è´´ä½ç½® (å±ä¸­)
            xOffset = (InputSize - newWidth) / 2;
            yOffset = (InputSize - newHeight) / 2;

            // å°å¾åæ·è´å° Canvas ä¸­å¤®
            Rect roi = new Rect(xOffset, yOffset, newWidth, newHeight);
            resizedImg.CopyTo(new Mat(paddedImg, roi));

            // å½ä¸å (0-255 -&gt; 0-1) å¹¶è½¬ä¸º float ç±»å
            Mat floatImg = new Mat();
            paddedImg.ConvertTo(floatImg, MatType.CV_32FC3, 1.0 / 255.0);

            // HWC è½¬ CHW å¹¶å±å¹³ä¸ºä¸ç»´æ°ç»
            Mat[] channels = Cv2.Split(floatImg);
            float[] chwData = new float[3 * InputSize * InputSize];

            // æ·è´æ°æ®ï¼Réé -&gt; Céé -&gt; Béé (OpenCV Split åºæ¥é¡ºåºæ¯ B, G, Rï¼å¯¹åºç´¢å¼ 0, 1, 2)
            int channelSize = InputSize * InputSize;
            // å° R, G, B ä¾æ¬¡æ·å¥æ°ç»
            Marshal.Copy(channels[0].Data, chwData, 0, channelSize); // R
            Marshal.Copy(channels[1].Data, chwData, channelSize, channelSize); // G
            Marshal.Copy(channels[2].Data, chwData, channelSize * 2, channelSize); // B

            // éæ¾ä¸´æ¶ Mat
            rgbImg.Dispose();
            resizedImg.Dispose();
            paddedImg.Dispose();
            floatImg.Dispose();
            foreach (var c in channels) c.Dispose();

            return chwData;
        }

        /// &lt;summary&gt;
        /// åå¤çï¼è§£æ TensorRT è¾åºãNMS è¿æ»¤
        /// &lt;/summary&gt;
        private static List&lt;DetData&gt; PostProcess(float[] result, float scale, int xOffset, int yOffset)
        {
            List&lt;Rect&gt; boxes = new List&lt;Rect&gt;();
            List&lt;float&gt; confidences = new List&lt;float&gt;();
            List&lt;int&gt; classIds = new List&lt;int&gt;();

            // éåææé¢æµæ¡ (OutputSize)
            // æ°æ®å¸å±: [4(box) + 80(classes)] * OutputSize
            // å±å¹³æ°ç»ä¸­ï¼åä¸å±æ§çæ°æ®æ¯è¿ç»­å­å¨çï¼ä¾å¦ææ cx å¨ä¸èµ·ï¼ææ cy å¨å¨ä¸èµ·...
            int stride = OutputSize; // æ­¥é¿ï¼ä¸åå±æ§å¨æ°ç»ä¸­çåç§»é

            for (int i = 0; i &lt; OutputSize; i++)
            {
                // æ¥æ¾æå¤§ç±»å«æ¦çåå¶ç´¢å¼
                float maxConf = 0;
                int maxClassId = -1;

                // éåç±»å«
                for (int c = 0; c &lt; CategoryNum; c++)
                {
                    // æ°ç»ç´¢å¼ï¼(åæ /è§åº¦åç§»é + ç±»å«åç§») * æ¡ç´¢å¼
                    // æ³¨æï¼åå§ä»£ç ä¸­ result[outputSize * j + i] è¿ç§è®¿é®æ¹å¼åºäº Transposed æ°æ®å¸å±
                    float conf = result[(4 + c) * stride + i];
                    if (conf &gt; maxConf)
                    {
                        maxConf = conf;
                        maxClassId = c;
                    }
                }

                // ç½®ä¿¡åº¦è¿æ»¤
                if (maxConf &gt; ConfThreshold)
                {
                    // æååæ  (cx, cy, w, h)
                    float cx = result[0 * stride + i];
                    float cy = result[1 * stride + i];
                    float w = result[2 * stride + i];
                    float h = result[3 * stride + i];
                    // è¿ååæ å°åå¾å°ºå¯¸
                    int rx = (int)((cx - xOffset - 0.5 * w) * scale);
                    int ry = (int)((cy - yOffset - 0.5 * h) * scale);
                    int rw = (int)(w * scale);
                    int rh = (int)(h * scale);

                    boxes.Add(new Rect(rx, ry, rw, rh));
                    confidences.Add(maxConf);
                    classIds.Add(maxClassId);
                }
            }

            // æ§è¡ NMS (æè½¬æ¡ NMS)
            // OpenCV ç NMSBoxes æ¯æ RotatedRect
            int[] indices;
            CvDnn.NMSBoxes(boxes, confidences, ConfThreshold, NmsThreshold, out indices);

            List&lt;DetData&gt; finalResults = new List&lt;DetData&gt;();
            foreach (int idx in indices)
            {
                finalResults.Add(new DetData
                {
                    index = classIds[idx],
                    score = confidences[idx],
                    box = boxes[idx]
                });
            }

            return finalResults;
        }

        /// &lt;summary&gt;
        /// ç»å¶æ£æµç»æï¼æ°´å¹³ç©å½¢æ¡ï¼
        /// &lt;/summary&gt;
        /// &lt;param name="results"&gt;æ£æµç»æåè¡¨&lt;/param&gt;
        /// &lt;param name="image"&gt;åå§å¾å&lt;/param&gt;
        /// &lt;returns&gt;ç»å¶åçå¾å&lt;/returns&gt;
        public static Mat DrawDetResult(List&lt;DetData&gt; results, Mat image)
        {
            // åéå¾åä»¥åä¿®æ¹åå¾
            Mat mat = image.Clone();

            foreach (var item in results)
            {
                // 1. ç»å¶ç©å½¢æ¡
                // Rect ç»æåå« X, Y, Width, Height
                Cv2.Rectangle(mat, item.box, new Scalar(0, 255, 0), thickness: 2);
                // 2. åå¤æ ç­¾ææ¬ (ç±»å«ID - ç½®ä¿¡åº¦)
                string label = $"{item.index} - {item.score:F2}";
                // 3. è®¡ç®ææ¬çå°ºå¯¸ï¼ç¨äºç»å¶èæ¯
                int baseLine = 1;
                Size textSize = Cv2.GetTextSize(label, HersheyFonts.HersheySimplex, 0.6, 1, out baseLine);
                // 4. ç»å¶æ ç­¾èæ¯ï¼åéæé»è²ç©å½¢ï¼ï¼é²æ­¢æå­ä¸èæ¯æ··æ·
                // ä½ç½®ï¼ç©å½¢å·¦ä¸è§ç¥å¾®ä¸ç§»ï¼æèç´æ¥è´´çå·¦ä¸è§
                Point labelPosition = new Point(item.box.X, item.box.Y - (int)textSize.Height - 5);

                // ç¡®ä¿æ ç­¾ä¸ç»åºå¾åè¾¹ç
                if (labelPosition.Y &lt; 0) labelPosition.Y = item.box.Y + (int)textSize.Height + 5;
                Rect labelBgRect = new Rect(labelPosition.X,
                                            labelPosition.Y - (int)textSize.Height, // OpenCV GetTextSize è¿åçé«åº¦æ¯åºçº¿å°åºé¨çè·ç¦»ï¼éè°æ´
                                            (int)textSize.Width,
                                            (int)textSize.Height + (int)baseLine);
                // å¦æèæ¯æ¡ä¹å¨å¾åèå´åï¼åç»å¶
                // æ³¨æï¼è¿éç®åå¤çï¼ç´æ¥ç»å¨æ¡ä¸æ¹
                Cv2.Rectangle(mat,
                               new Point(item.box.X, item.box.Y - textSize.Height - 5),
                               new Point(item.box.X + textSize.Width, item.box.Y),
                               new Scalar(0, 255, 0),
                               thickness: -1); // -1 è¡¨ç¤ºå¡«å
                // 5. ç»å¶ææ¬ï¼ç½è²æå­ï¼
                Cv2.PutText(mat,
                            label,
                            new Point(item.box.X, item.box.Y - 5),
                            HersheyFonts.HersheySimplex,
                            0.6,
                            new Scalar(0, 0, 0),
                            1);
            }
            return mat;
        }

        public class DetData
        {
            public int index;
            public float score;
            public Rect box;
        }
    }
}


</code></pre>
<p>ä¸ºäºæ¹ä¾¿ç¼åä»£ç ï¼ä¸è¿°å¹¶è¡å¤çå³ä½¿æ¶é´åæ¬äºæ¨çä¸ä¸æçåå»ºãæ¨çé¢ç­ç­æ­¥éª¤ï¼æä»¥å®éæ¶é´ä¼åé¿ï¼ä¸è¿°ç¨åºè¿è¡åè¾åºå¦ä¸æç¤ºï¼</p>
<p><img alt="image-20260109230808256" loading="lazy" data-src="https://img2024.cnblogs.com/blog/2933426/202601/2933426-20260111184155243-888464286.png" class="lazyload"></p>
<p><strong>å¹¶è¡æµè¯ç»æï¼</strong></p>
<p>åæ¶ä¸ºäºæ¯è¾ä¸åå¹¶è¡æ°ï¼æµè¯äºä»1å°24ä¸åå¹¶è¡æ°çæåµï¼æ¨çæ»æ¶é´å¦ä¸ï¼</p>
<table>
<thead>
<tr>
<th style="text-align: center">å¹¶è¡æ°</th>
<th style="text-align: center">1</th>
<th style="text-align: center">2</th>
<th style="text-align: center">4</th>
<th style="text-align: center">6</th>
<th style="text-align: center">8</th>
<th style="text-align: center">10</th>
<th style="text-align: center">12</th>
<th style="text-align: center">14</th>
<th style="text-align: center">16</th>
<th style="text-align: center">18</th>
<th style="text-align: center">20</th>
<th style="text-align: center">22</th>
<th style="text-align: center">24</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center">æ¨çæ»æ¶é´ (ms)</td>
<td style="text-align: center">80</td>
<td style="text-align: center">85</td>
<td style="text-align: center">95</td>
<td style="text-align: center">115</td>
<td style="text-align: center">130</td>
<td style="text-align: center">155</td>
<td style="text-align: center">180</td>
<td style="text-align: center">210</td>
<td style="text-align: center">230</td>
<td style="text-align: center">255</td>
<td style="text-align: center">270</td>
<td style="text-align: center">285</td>
<td style="text-align: center">310</td>
</tr>
</tbody>
</table>
<blockquote>
<p>ð<strong>ç¨åºè·¯å¾é¾æ¥</strong>ï¼å®æ´ç¨åºå·²ç»ä¸ä¼ å°GitHubï¼è¯·èªè¡ä¸è½½ï¼é¾æ¥ä¸ºï¼</p>
<pre><code>https://github.com/guojin-yan/TensorRT-CSharp-API/tree/TensorRtSharp3.0/samples/YoloObbBatchInfer
</code></pre>
</blockquote>
<hr>
<h2 id="ä¸å¼å¸¸å¤ç">ä¸ãå¼å¸¸å¤ç</h2>
<p>TensorRtSharp æä¾äºå®åçå¼å¸¸å¤çæºå¶ã</p>
<pre><code class="language-csharp">try
{
    Runtime runtime = new Runtime();
    byte[] data = File.ReadAllBytes("model.engine");
    using CudaEngine engine = runtime.deserializeCudaEngineByBlob(data, (ulong)data.Length);
}
catch (TrtException ex)
{
    // TensorRT ç¹å®éè¯¯
    Console.WriteLine($"TensorRT Error: {ex.ErrMsg}");
    Console.WriteLine($"Status: {ex.Status}");
}
catch (CudaException ex)
{
    // CUDA è¿è¡æ¶éè¯¯
    Console.WriteLine($"CUDA Error: {ex.Message}");
    Console.WriteLine($"Status: {ex.Status}");
}
catch (InitException ex)
{
    // åå§åéè¯¯
    Console.WriteLine($"Initialization Failed: {ex.Message}");
    Console.WriteLine($"Status: {ex.Status}");
}
</code></pre>
<p><strong>å¼å¸¸ç±»åè¯´æï¼</strong></p>
<table>
<thead>
<tr>
<th>å¼å¸¸ç±»å</th>
<th>è¯´æ</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>TrtException</code></td>
<td>TensorRT API éè¯¯ï¼20+ éè¯¯ç ï¼</td>
</tr>
<tr>
<td><code>CudaException</code></td>
<td>CUDA è¿è¡æ¶éè¯¯ï¼40+ éè¯¯ç ï¼</td>
</tr>
<tr>
<td><code>InitException</code></td>
<td>åºåå§åéè¯¯</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="å«æ¥å¿ç³»ç»">å«ãæ¥å¿ç³»ç»</h2>
<p>TensorRtSharp æä¾äºåä¾æ¥å¿ç³»ç»ã</p>
<pre><code class="language-csharp">// è·åæ¥å¿å®ä¾
Logger logger = Logger.Instance;

// è®¾ç½®æ¥å¿çº§å«
logger.SetThreshold(LoggerSeverity.kINFO);  // INFOãWARNINGãERROR

// è®¾ç½®èªå®ä¹åè°
logger.SetCallback((message) =&gt;
{
    Console.WriteLine($"[TensorRT] {message}");
});

// è®°å½æ¥å¿
logger.INFO("Engine building started...");
logger.WARNING("FP16 not supported, falling back to FP32");
logger.ERROR("Failed to parse ONNX model");

// éé»æ¨¡å¼
logger.SetThreshold(LoggerSeverity.kINTERNAL_ERROR);  // ä»ä¸¥ééè¯¯
</code></pre>
<hr>
<h2 id="ä¹ä¸å¶ä»åºçå¯¹æ¯">ä¹ãä¸å¶ä»åºçå¯¹æ¯</h2>
<table>
<thead>
<tr>
<th>ç¹æ§</th>
<th>TensorRtSharp</th>
<th>ML.NET</th>
<th>ONNX Runtime</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>ç¼ç¨è¯­è¨</strong></td>
<td>C#</td>
<td>C#</td>
<td>C++/Python</td>
</tr>
<tr>
<td><strong>API ç±»å</strong></td>
<td>æç®¡å°è£</td>
<td>æç®¡åº</td>
<td>åçç»å®</td>
</tr>
<tr>
<td><strong>æ§è½</strong></td>
<td>åçéåº¦</td>
<td>ä¸­ç­</td>
<td>åçéåº¦</td>
</tr>
<tr>
<td><strong>æç¨æ§</strong></td>
<td>é«</td>
<td>é«</td>
<td>ä¸­ç­</td>
</tr>
<tr>
<td><strong>TensorRT æ¯æ</strong></td>
<td>å®æ´</td>
<td>æ </td>
<td>æé</td>
</tr>
<tr>
<td><strong>èªå®ä¹ç®å­</strong></td>
<td>æ¯æ</td>
<td>å°é¾</td>
<td>æ¯æ</td>
</tr>
<tr>
<td><strong>å¨æå½¢ç¶</strong></td>
<td>æ¯æ</td>
<td>æé</td>
<td>æ¯æ</td>
</tr>
<tr>
<td><strong>å¤ GPU</strong></td>
<td>æ¯æ</td>
<td>æé</td>
<td>æ¯æ</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="åå¸¸è§é®é¢">åãå¸¸è§é®é¢</h2>
<h3 id="é®é¢ä¸æ¾ä¸å°-dll-æ¨¡å">é®é¢ä¸ï¼æ¾ä¸å° DLL æ¨¡å</h3>
<p><strong>éè¯¯ä¿¡æ¯ï¼</strong></p>
<pre><code>Unable to load DLL 'TensorRT-C-API' or one of its dependencies: æ¾ä¸å°æå®çæ¨¡åã
</code></pre>
<p><strong>è§£å³æ¹æ¡ï¼</strong></p>
<ol>
<li>æ£æ¥æ¯å¦å®è£äºå¯¹åºçæ¬ç Runtime NuGet å</li>
<li>ç¡®è®¤ç³»ç» PATH ç¯å¢åéä¸­åå« TensorRT ç lib ç®å½å CUDA ç bin ç®å½</li>
<li>ç¡®è®¤ TensorRT çæ¬ä¸º 10.x ç³»å</li>
</ol>
<p><strong>éè¯¯æªå¾ï¼</strong></p>
<p><img alt="éè¯¯1" loading="lazy" data-src="https://img2024.cnblogs.com/blog/2933426/202601/2933426-20260111184155241-2119782141.png" class="lazyload"><br>
<img alt="éè¯¯2" loading="lazy" data-src="https://img2024.cnblogs.com/blog/2933426/202601/2933426-20260111184155226-1230745435.png" class="lazyload"></p>
<hr>
<h3 id="é®é¢äºsehexception-å¼å¸¸">é®é¢äºï¼SEHException å¼å¸¸</h3>
<p><strong>éè¯¯ä¿¡æ¯ï¼</strong></p>
<pre><code>System.Runtime.InteropServices.SEHException: "External component has thrown an exception."
</code></pre>
<p><strong>å¯è½åå ï¼</strong></p>
<ul>
<li>TensorRT çæ¬ä¸å¹éï¼å¿é¡»ä½¿ç¨ 10.xï¼</li>
<li>CUDA çæ¬ä¸å¼å®¹</li>
<li>æ¨¡åæä»¶æå</li>
</ul>
<p><strong>è§£å³æ¹æ¡ï¼</strong></p>
<ol>
<li>ç¡®è®¤ TensorRT çæ¬ä¸º 10.x</li>
<li>æ£æ¥ CUDA çæ¬æ¯å¦å¹é</li>
<li>éæ°çæ Engine æä»¶</li>
</ol>
<p><strong>éè¯¯æªå¾ï¼</strong></p>
<p><img alt="SEHException" loading="lazy" data-src="https://img2024.cnblogs.com/blog/2933426/202601/2933426-20260111184155221-1792773455.png" class="lazyload"></p>
<h3 id="é®é¢ä¸systemexecutionengineexception-å¼å¸¸">é®é¢ä¸ï¼System.ExecutionEngineException å¼å¸¸</h3>
<p><strong>éè¯¯ä¿¡æ¯ï¼</strong></p>
<pre><code>System.ExecutionEngineException 
</code></pre>
<p><strong>å¯è½åå ï¼</strong></p>
<ul>
<li>æ¨¡åæä»¶ä¸è®¾å¤ä¸å¹é</li>
</ul>
<p><strong>è§£å³æ¹æ¡ï¼</strong></p>
<ol>
<li>å¨å½åè®¾å¤ä¸éæ°çææ¨¡åæä»¶</li>
</ol>
<p><strong>éè¯¯æªå¾ï¼</strong></p>
<p><img alt="image-20260110002045090" loading="lazy" data-src="https://img2024.cnblogs.com/blog/2933426/202601/2933426-20260111184155216-891120170.png" class="lazyload"></p>
<p><img alt="image-20260110002045090" loading="lazy" data-src="https://img2024.cnblogs.com/blog/2933426/202601/2933426-20260111184155234-391327787.png" class="lazyload"></p>
<hr>
<h2 id="åä¸æ»ç»">åä¸ãæ»ç»</h2>
<p>TensorRtSharp æ¯ä¸ä¸ªåè½å®æ´ãè®¾è®¡ç²¾è¯ç TensorRT C# å°è£åºï¼å®å¡«è¡¥äº .NET çæå¨é«æ§è½æ·±åº¦å­¦ä¹ æ¨çæ¹é¢çç©ºç½ãéè¿æä¾ç±»åå®å¨ç APIãèªå¨èµæºç®¡çåå®åçå¼å¸¸å¤çï¼TensorRtSharp è®© C# å¼åèè½å¤åååæ¥ GPU çè®¡ç®è½åï¼èæ éé¢å¯¹å¤æçåçä»£ç ã</p>
<h3 id="æ ¸å¿ä¼å¿">æ ¸å¿ä¼å¿</h3>
<p>â <strong>å®æ´ç API è¦ç</strong>ï¼æ¯æ TensorRT æ ¸å¿åè½<br>
â <strong>ç±»åå®å¨</strong>ï¼å¼ºç±»åç³»ç»ï¼ç¼è¯æ¶éè¯¯æ£æ¥<br>
â <strong>èªå¨èµæºç®¡ç</strong>ï¼RAII + Dispose æ¨¡å¼<br>
â <strong>é«æ§è½</strong>ï¼å¼æ­¥æ§è¡ãå¤æµå¹¶è¡<br>
â <strong>æç¨æ§</strong>ï¼ç´è§ç APIãè¯¦ç»æ³¨é<br>
â <strong>è·¨å¹³å°</strong>ï¼æ¯æ Windows/Linux<br>
â <strong>å¼ç®±å³ç¨</strong>ï¼NuGet åå«ææä¾èµ</p>
<h3 id="éç¨åºæ¯">éç¨åºæ¯</h3>
<p>æ è®ºæ¨æ¯æå»ºä»¥ä¸ç±»åçåºç¨ï¼TensorRtSharp é½æ¯æ¨ççæ³éæ©ï¼</p>
<ul>
<li>ð¯ <strong>å®æ¶è§è§åºç¨</strong>ï¼ç®æ æ£æµãå¾ååå²ãå§¿æä¼°è®¡</li>
<li>ð¤ <strong>è¯­é³å¤ç</strong>ï¼è¯­é³è¯å«ãè¯­é³åæ</li>
<li>ð <strong>è¾¹ç¼è®¡ç®</strong>ï¼åµå¥å¼è®¾å¤æ¨ç</li>
</ul>
<h3 id="ç«å³å¼å§">ç«å³å¼å§</h3>
<p><strong>å®è£å½ä»¤ï¼</strong></p>
<pre><code class="language-bash">dotnet add package JYPPX.TensorRT.CSharp.API
dotnet add package JYPPX.TensorRT.CSharp.API.runtime.win-x64.cuda12
</code></pre>
<p><strong>GitHub ä»åºï¼</strong></p>
<pre><code>https://github.com/guojin-yan/TensorRT-CSharp-API
</code></pre>
<p>ç«å³å®è£å¹¶ä½éª C# ä¸çä¸­ç GPU æ¨çæè´æ§è½å§ï¼</p>
<hr>
<h2 id="ææ¯æ¯æ">ææ¯æ¯æ</h2>
<p>å¦æé®é¢æå»ºè®®ï¼æ¬¢è¿éè¿ä»¥ä¸æ¹å¼äº¤æµï¼</p>
<ul>
<li>ð§ <strong>GitHub Issues</strong>ï¼å¨é¡¹ç®ä»åºæ Issue æ Pull Request</li>
<li>ð¬ <strong>QQ äº¤æµç¾¤</strong>ï¼å å¥ <strong>945057948</strong>ï¼åå¤æ´æ¹ä¾¿æ´å¿«å¦</li>
</ul>
<p><img alt="QQç¾¤äºç»´ç " loading="lazy" data-src="https://img2024.cnblogs.com/blog/2933426/202601/2933426-20260111184155210-319682739.png" class="lazyload"></p>
<hr>
<p><em>ä½èï¼Guojin Yan</em><br>
<em>çæ¬ï¼0.0.5</em><br>
<em>æåæ´æ°ï¼2026å¹´1æ</em></p>
<hr>
<p><strong>ãæç« å£°æã</strong></p>
<p>æ¬æä¸»è¦åå®¹åºäºä½èçç ç©¶ä¸å®è·µï¼é¨åè¡¨è¿°åå©AIå·¥å·è¿è¡äºè¾å©ä¼åãç±äºææ¯å±éæ§ï¼æä¸­å¯è½å­å¨éè¯¯æçæ¼ä¹å¤ï¼æ³è¯·åä½è¯»èæ¹è¯ææ­£ãå¦æåå®¹æ æä¸­ä¾µç¯äºæ¨çæçï¼è¯·åæ¶éè¿å¬ä¼å·åå°ä¸æä»¬èç³»ï¼æä»¬å°ç¬¬ä¸æ¶é´æ ¸å®å¹¶å¦¥åå¤çãæè°¢æ¨ççè§£ä¸æ¯æï¼</p>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-01-11 18:47">2026-01-11 18:47</span>&nbsp;
<a href="https://www.cnblogs.com/guojin-blogs">æ¤é¢ç®ç®è¾</a>&nbsp;
éè¯»(<span id="post_view_count">294</span>)&nbsp;
è¯è®º(<span id="post_comment_count">1</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19468745);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19468745', targetLink: 'https://www.cnblogs.com/guojin-blogs/p/19468745', title: 'TensorRtSharpï¼å¨ C# ä¸çä¸­éæ¾ GPU æ¨ççæè´æ§è½' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ TheIsleæé¾å²è¯»åæ¸¸æåºååæä»¶ï¼C#è¯­è¨ï¼ ]]></title>
    <link>https://www.cnblogs.com/TheIsle/p/19468703</link>
    <guid>d661be28b90b3c8898744d3130d677df</guid>
    <description>
    <![CDATA[ 
	<h1 class="postTitle"><a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/TheIsle/p/19468703" title="åå¸äº 2026-01-11 18:04">
    <span role="heading" aria-level="2">TheIsleæé¾å²è¯»åæ¸¸æåºååæä»¶ï¼C#è¯­è¨ï¼</span>
    

</a>
</h1>
	<div id="cnblogs_post_body" class="blogpost-body blogpost-body-html">
<span class="js_darkmode__0" data-pm-slice="0 0 []"><span>å¨C# ä¸­è¯»åæ¸¸æåºåï¼ä¾å¦ï¼å¨åå­ä¸­å®ä½ä¸ä¸ªæ¸¸æè¿ç¨çç¹å®åå­å°åï¼ï¼éå¸¸æ¶åå°ä½¿ç¨Windows APIæ¥è·åæ¸¸æè¿ç¨çåå­ä¿¡æ¯ãè¿å¯ä»¥éè¿<code class="js_darkmode__1"><span>System.Diagnostics</span></code><span class="js_darkmode__2"><span>å½åç©ºé´ä¸­ç<code class="js_darkmode__3"><span>Process</span></code><span class="js_darkmode__4"><span>ç±»åä¸äºP/Invokeï¼å¹³å°è°ç¨ï¼ææ¯æ¥å®ç°ãä»¥ä¸æ¯ä¸äºæ­¥éª¤åç¤ºä¾ä»£ç ï¼å¯ä»¥å¸®å©ä½ å®ç°è¿ä¸åè½ã</span></span></span></span></span></span>
<h3 class="js_darkmode__5" data-pm-slice="0 0 []"><span>æ­¥éª¤ 1:æå¼VSå¼åå·¥å·ï¼æ°å»ºä¸ä¸ªWPFé¡¹ç®ï¼åæ°å»ºä¸ä¸ªWindowsçªä½ã</span></h3>
<span class="js_darkmode__6"><span class="js_darkmode__6"><span class="js_darkmode__7" data-pm-slice="0 0 []">æ­¥éª¤ 2:å¨Windowsçªä½ä¸­æ·»å ææ¬æ¡åæé®æ§ä»¶ï¼ä»£ç å¦ä¸ï¼</span></span></span>
<div class="cnblogs_Highlighter">
<pre class="brush:csharp;gutter:true;">&lt;StackPanel VerticalAlignment="Center"&gt;
    &lt;StackPanel Orientation="Horizontal" HorizontalAlignment="Center"&gt;
        &lt;TextBlock Text="è¿ç¨åç§°ï¼" VerticalAlignment="Center"/&gt;
        &lt;TextBox x:Name="txtName" Width="190" Height="24" Text="TheIsleServer-Win64-Shipping"
                 VerticalContentAlignment="Center"/&gt;
    &lt;/StackPanel&gt;
    &lt;Button Content="OK" Width="80" Height="26" Margin="0,10" Click="Button_Click"/&gt;
    &lt;TextBox IsReadOnly="True" x:Name="txtShow" Height="44" HorizontalAlignment="Center"
             VerticalContentAlignment="Center" Width="210"/&gt;
&lt;/StackPanel&gt;
</pre>
</div>
<p>ããå¶ä¸­ãTheIsleServer-Win64-Shippingãæ¯æé¾å²æ¸¸ææå¡ç«¯è¿ç¨åç§°ï¼å¶å®æ¸¸æå¡«åå¯¹åºæ¸¸æåç§°ã</p>
<p><span class="js_darkmode__12">æ­¥éª¤ 3:<span><span class="js_darkmode__14">åç«¯çé¢åå¥½ä¹åï¼æ¥ä¸æ¥éè¦æ·»å åå°é»è¾ä»£ç ï¼å®ç°è¯»åæ¸¸æåºåçåè½ã</span></span></span></p>
<div class="cnblogs_Highlighter">
<pre class="brush:csharp;gutter:true;">if (GameHelper.GetPidByProcessName(txtName.Text) == 0)
{
    MessageBox.Show("æªæ¾å°æ¸¸æè¿ç¨ï¼");
    return;
}
Process gameProcess = Process.GetProcessesByName(txtName.Text)[0];
string baseAdr = gameProcess.Modules[0].EntryPointAddress.ToString();
string baseAdr1 = gameProcess.Modules[0].BaseAddress.ToString();
txtShow.Text = "EntryPointAddressï¼" + baseAdr + "\nBaseAddressï¼" + baseAdr1;
</pre>
</div>
<p>ãã<span><span class="js_darkmode__17">ä»£ç åå®äºï¼è¿è¡è¿ä¸ªç¨åºï¼ç¹å»çé¢ä¸­çOKæé®ï¼å°±å¯ä»¥è·åæé¾å²æ¸¸æçåºåããEntryPointAddressãæ¯ç¨åºå¥å£ç¹åºåï¼<span class="js_darkmode__18"><span class="js_darkmode__19" data-pm-slice="0 0 []"><span data-pm-slice="1 1 [&quot;para&quot;,null,&quot;node&quot;,{&quot;tagName&quot;:&quot;span&quot;,&quot;attributes&quot;:{&quot;style&quot;:&quot;color: rgb(51, 51, 51); font-family: \&quot;PingFang SC\&quot;, Arial, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none;  widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;&quot;},&quot;namespaceURI&quot;:&quot;http://www.w3.org/1999/xhtml&quot;},&quot;node&quot;,{&quot;tagName&quot;:&quot;span&quot;,&quot;attributes&quot;:{&quot;style&quot;:&quot;color: rgb(51, 51, 51); font-family: \&quot;PingFang SC\&quot;, Arial, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none;  widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;&quot;,&quot;data-pm-slice&quot;:&quot;0 0 []&quot;},&quot;namespaceURI&quot;:&quot;http://www.w3.org/1999/xhtml&quot;}]"><span class="js_darkmode__20">ãBaseAddressãå°±æ¯<span class="js_darkmode__21"><span class="js_darkmode__22" data-pm-slice="0 0 []"><span data-pm-slice="1 1 [&quot;para&quot;,null,&quot;node&quot;,{&quot;tagName&quot;:&quot;span&quot;,&quot;attributes&quot;:{&quot;style&quot;:&quot;color: rgb(51, 51, 51); font-family: \&quot;PingFang SC\&quot;, Arial, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none;  widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;&quot;},&quot;namespaceURI&quot;:&quot;http://www.w3.org/1999/xhtml&quot;},&quot;node&quot;,{&quot;tagName&quot;:&quot;span&quot;,&quot;attributes&quot;:{&quot;style&quot;:&quot;color: rgb(51, 51, 51); font-family: \&quot;PingFang SC\&quot;, Arial, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none;  widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;&quot;,&quot;data-pm-slice&quot;:&quot;0 0 []&quot;},&quot;namespaceURI&quot;:&quot;http://www.w3.org/1999/xhtml&quot;}]"><span class="js_darkmode__23">æé¾å²æ¸¸æåºåãåºå<span class="js_darkmode__24"><span data-pm-slice="1 1 [&quot;para&quot;,{&quot;tagName&quot;:&quot;section&quot;,&quot;attributes&quot;:{},&quot;namespaceURI&quot;:&quot;&quot;},&quot;node&quot;,{&quot;tagName&quot;:&quot;span&quot;,&quot;attributes&quot;:{&quot;style&quot;:&quot;color: rgb(51, 51, 51); font-family: \&quot;PingFang SC\&quot;, Arial, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none;  widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;&quot;},&quot;namespaceURI&quot;:&quot;http://www.w3.org/1999/xhtml&quot;}]">æçæ¯æ¸¸ææ¨¡åï¼å¦.exeæ.dllæä»¶ï¼å¨åå­ä¸­çèµ·å§å°åï¼è¿ä¸ªå°åå¨æ¸¸ææ¯æ¬¡å¯å¨æ¶å¯è½ååï¼ä½ç¸å¯¹äºæ¨¡åæ¬èº«æ¯ç¨³å®çã</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p><img alt="640" loading="lazy" data-src="https://img2024.cnblogs.com/blog/528176/202601/528176-20260111180301816-1233142542.webp" class="lazyload"></p>
<p><span class="js_darkmode__25" data-pm-slice="0 0 []">è¯»åå°æ¸¸æ<span class="js_darkmode__26"><span>åºå<span class="js_darkmode__27"><span>âåï¼å<span class="js_darkmode__28" data-pm-slice="0 0 []"><span>å ä¸åç§»å°åï¼å°±å¯ä»¥è·åå°æ¯å¦è¡éãæ¶é´çå·ä½æ°å¼ï¼<span class="js_darkmode__29" data-pm-slice="0 0 []"><span>åç§»å°åå¯ä»¥æ¯å¤çº§çãéè¿åºå+åç§»çæ¹å¼ï¼å°±å¯ä»¥å¶ä½é¿ç½å¤©ãåèåè¡ç­åè½ç<span class="js_darkmode__30"><span class="js_darkmode__31" data-pm-slice="0 0 []"><span class="js_darkmode__32" data-pm-slice="0 0 []"><span data-pm-slice="1 1 [&quot;para&quot;,{&quot;tagName&quot;:&quot;section&quot;,&quot;attributes&quot;:{},&quot;namespaceURI&quot;:&quot;&quot;},&quot;node&quot;,{&quot;tagName&quot;:&quot;span&quot;,&quot;attributes&quot;:{&quot;style&quot;:&quot;color: rgb(51, 51, 51); font-family: \&quot;PingFang SC\&quot;, Arial, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none;  widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;&quot;},&quot;namespaceURI&quot;:&quot;http://www.w3.org/1999/xhtml&quot;},&quot;node&quot;,{&quot;tagName&quot;:&quot;span&quot;,&quot;attributes&quot;:{&quot;style&quot;:&quot;color: rgb(51, 51, 51); font-family: \&quot;PingFang SC\&quot;, Arial, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none;  widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;&quot;,&quot;data-pm-slice&quot;:&quot;0 0 []&quot;},&quot;namespaceURI&quot;:&quot;http://www.w3.org/1999/xhtml&quot;},&quot;node&quot;,{&quot;tagName&quot;:&quot;span&quot;,&quot;attributes&quot;:{&quot;style&quot;:&quot;color: rgb(51, 51, 51); font-family: \&quot;PingFang SC\&quot;, Arial, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none;  widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;&quot;,&quot;data-pm-slice&quot;:&quot;0 0 []&quot;},&quot;namespaceURI&quot;:&quot;http://www.w3.org/1999/xhtml&quot;}]">æå¡å¨æä»¶ã</span></span></span></span></span></span></span></span></span></span></span></span></span></p>
<h3 data-pm-slice="0 0 []"><span>ä¸ºä»ä¹éè¦åºåå åç§»ï¼</span></h3>
<p><span class="js_darkmode__39"><span>æ¸¸ææ°æ®çåå­å°åå¨æ¯æ¬¡éå¯åå¯è½æ¹åï¼ç±äºåå­éæºåæºå¶ï¼ï¼ç´æ¥ä½¿ç¨ç»å¯¹å°åä¼å¤±æãèåºåå åç§»çæ¹å¼å©ç¨äºæ°æ®å¨åå­ä¸­çç¸å¯¹ä½ç½®å³ç³»ï¼åªè¦åºåååç§»ä¸åï¼å°±è½ç¨³å®è¯»åæ°æ®ãâ</span></span></p>
</div>
<div id="MySignature" role="contentinfo">
    <p>æ¬ææ¥èªåå®¢å­ï¼ä½èï¼<a href="https://www.cnblogs.com/TheIsle/" target="_blank">éå·TheIsle</a>ï¼è½¬è½½è¯·æ³¨æåæé¾æ¥ï¼<a href="https://www.cnblogs.com/TheIsle/p/19468703" target="_blank">https://www.cnblogs.com/TheIsle/p/19468703</a></p>
</div>
<div class="clear"></div>

	<div class="postDesc">posted on 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-01-11 18:05">2026-01-11 18:04</span>&nbsp;
<a href="https://www.cnblogs.com/TheIsle">éå·TheIsle</a>&nbsp;
éè¯»(<span id="post_view_count">58</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19468703);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19468703', targetLink: 'https://www.cnblogs.com/TheIsle/p/19468703', title: 'TheIsleæé¾å²è¯»åæ¸¸æåºååæä»¶ï¼C#è¯­è¨ï¼' })">ä¸¾æ¥</a>
</div>
 ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ å½æä¸æ³åä¸ºãå°å³å®ãæ¶èæ³¨æåæ¶ï¼æåäºä¸ä¸ªå¾å°çå·¥å· ]]></title>
    <link>https://www.cnblogs.com/BigFunny/p/19468424</link>
    <guid>94e39ce024025173d8ebb445c2caf180</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/BigFunny/p/19468424" title="åå¸äº 2026-01-11 15:33">
    <span role="heading" aria-level="2">å½æä¸æ³åä¸ºãå°å³å®ãæ¶èæ³¨æåæ¶ï¼æåäºä¸ä¸ªå¾å°çå·¥å·</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<p><strong>åè¿ç¯æç« çèµ·å ï¼å¶å®å¾ç®åã</strong></p>
<p>æä¸å¤©æåç°ï¼èªå·±ä¸å¤©ä¸­è¢«ææ­æå¤çï¼å¹¶ä¸æ¯å¤æçé®é¢ï¼èæ¯ä¸äºæ¬æ¥ä¸å¼å¾è®¤çæèçå°å³å®ï¼</p>
<ul>
<li>åååªä¸ªä»»å¡ï¼</li>
<li>åé¥­åä»ä¹ï¼</li>
<li>å ä¸ªæ¹æ¡ééä¾¿éä¸ä¸ªï¼ä»åªå¼å§ï¼</li>
</ul>
<p>è¿äºéæ©åç¬çé½å¾è½»ï¼ä½å®ä»¬åå¤åºç°ï¼ä¼ä¸æ­ææ­æ³¨æåã<br>
çæ­£æ¶èäººçï¼å¾å¾ä¸æ¯å¤§é®é¢ï¼èæ¯è¿äºãæ å³ç´§è¦ä½åä¸å¾ä¸æ³ä¸ä¸ãçæ¶å»ã</p>
<hr>
<h2 id="æä¸å¼å§è¯å¾ç¨åç§å·¥å·è§£å³è¿ä¸ªé®é¢">æä¸å¼å§è¯å¾ç¨åç§å·¥å·è§£å³è¿ä¸ªé®é¢</h2>
<p>ä½åæ¥åç°ä¸ä¸ªå¾è®½åºçæåµï¼</p>
<blockquote>
<p>ä¸ºäºä¸çº ç»ï¼æåèè±äºæ´å¤æ¶é´å¨å·¥å·æ¬èº«ä¸ã</p>
</blockquote>
<p>è¦ç»å½ãè¦éç½®ãè¦çè§£åè½ï¼çè³è¿ä¼è¢«æ¨èæ´å¤ãä½ å¯è½éè¦çä¸è¥¿ãã</p>
<p>å·¥å·å¹¶æ²¡æè®©ææ´å¿«å¼å§è¡å¨ï¼åèæäºæ°çæ³¨æåé»æ´ã</p>
<p>é£æ¶åææè¯å°ï¼æçæ­£æ³è¦çå¹¶ä¸æ¯ä¸ä¸ªãæ´èªæãçç³»ç»ï¼èæ¯ä¸ä¸ª <strong>æ´å®éçå·¥å·</strong>ã</p>
<hr>
<h2 id="ä¸ä¸ªå ä¹æè§ä¸å°å­å¨çå°å·¥å·">ä¸ä¸ªå ä¹ãæè§ä¸å°å­å¨ãçå°å·¥å·</h2>
<p>WheelPage å°±æ¯å¨è¿ç§èæ¯ä¸åºç°çã</p>
<p>å®ä¸æ¯ä¸ä¸ªæçç³»ç»ï¼ä¹ä¸è¯å¾å¸®ä½ ãååºæ´æ­£ç¡®çå³å®ãã<br>
å®çç®æ åªæä¸ä¸ªï¼</p>
<blockquote>
<p>å¨ä½ ä¸æ³åçº ç»çæ¶åï¼ç»ä½ ä¸ä¸ªå¿«éãä¸­ç«ãæ éè§£éçç»æã</p>
</blockquote>
<p>ææ©åçæ¯ä¸ä¸ªå³ç­è½¬çã</p>
<p>ä½ æéé¡¹åè¿å»ï¼è½¬ä¸ä¸ï¼å°±æç»æã</p>
<p>åæ¥æåç°ï¼å¾å¤äººå¹¶ä¸æ¯ç¹å«å¨æè½¬çè½¬å°äºåªä¸é¡¹ï¼<br>
èæ¯å¨ç»æåºç°çé£ä¸å»ï¼ç»äºå¯ä»¥ç»§ç»­å¾ä¸èµ°äºã</p>
<p>è¿ä¸ªè½¬çåæ¥è¢«ç¨å¨å¾å¤ææä¹å¤çåºæ¯éï¼</p>
<ul>
<li>å¢ééæç ´åµå±</li>
<li>è¯¾å äºå¨</li>
<li>åä½å¡ä½æ¶ï¼éæºç»èªå·±ä¸ä¸ªèµ·ç¹</li>
<li>çè³åªæ¯å¸®èªå·±ãåå¼å§åç¹ä»ä¹ã</li>
</ul>
<p>å¦æä½ æ³çè¿ä¸ªæåºç¡çåè½ï¼å®å¨è¿éï¼<br>
ð <a href="https://wheelpage.com/zh/" target="_blank" rel="noopener nofollow">è½¬ç</a></p>
<hr>
<h2 id="ä¸ºä»ä¹åæ¥åå äºä¸ä¸ª-æç¡¬å¸">ä¸ºä»ä¹åæ¥åå äºä¸ä¸ª æç¡¬å¸</h2>
<p>å¨ä½¿ç¨è¿ç¨ä¸­ï¼æä¸ªåé¦åå¤åºç°ï¼</p>
<blockquote>
<p>ãå¶å®æå¾å¤æ¶ååªæ¯å¨ä¸¤ä»¶äºä¹é´ç¹è±«ãã</p>
</blockquote>
<p>äºæ¯æå äºä¸ä¸ªæ´æç®çå·¥å·ï¼<strong>æç¡¬å¸</strong>ã</p>
<ul>
<li>æ²¡æéé¡¹éç½®</li>
<li>æ²¡æè¯´ææå­</li>
<li>æå¼å°±è½ç¨</li>
</ul>
<p>ä½ åªéæä¸ä¸ï¼æ­£æåã</p>
<p>æè¶£çæ¯ï¼å¾å¤ç¨æ·åæ¥è·æè¯´ï¼ä»ä»¬å¹¶ä¸æ¯å®å¨æå³å®äº¤ç»ç¡¬å¸ï¼<br>
èæ¯å¨ç¡¬å¸è½ä¸çä¸ç¬é´ï¼çªç¶æè¯å°èªå·±å¿éæ´åååªä¸è¾¹ã</p>
<p>è¿ç§ä½éªæ¬èº«å°±å¾å¾®å¦ã</p>
<p>å¦æä½ ä¹å¥½å¥ï¼å¯ä»¥ç´æ¥è¯ä¸ä¸è¿ä¸ªé¡µé¢ï¼<br>
ð <a href="https://wheelpage.com/zh/coin-flip/" target="_blank" rel="noopener nofollow">æç¡¬å¸</a></p>
<hr>
<h2 id="è®¾è®¡è¿ç¨ä¸­æå»æåçå ä»¶åç´è§çäº">è®¾è®¡è¿ç¨ä¸­ï¼æå»æåçå ä»¶ãåç´è§ãçäº</h2>
<p>å¨å¼å WheelPage çè¿ç¨ä¸­ï¼æææé¿ååä¸ä»¶äºæï¼</p>
<h3 id="1-ä¸åè´¦æ·ç³»ç»">1. ä¸åè´¦æ·ç³»ç»</h3>
<p>å ä¸ºãåªæ¯ç¨ä¸ä¸ãï¼ä¸åºè¯¥æä¸ºæ³¨åççç±ã</p>
<h3 id="2-ä¸å åè½">2. ä¸å åè½</h3>
<p>æ¯å ä¸ä¸ªåè½ï¼æé½ä¼é®èªå·±ï¼</p>
<blockquote>
<p>è¿æ¯å¨å¸®ç¨æ·ï¼<br>
è¿æ¯åªæ¯è®©æè§å¾ãè¿ä¸ªäº§åæ´åä¸ªäº§åäºãï¼</p>
</blockquote>
<h3 id="3-ä¸å¶é å­å¨æ">3. ä¸å¶é å­å¨æ</h3>
<p>ç¨å®å°±èµ°ï¼æ¯æå¸æå®åç°åºæ¥çç¶æã</p>
<p>ææ´æ¿ææ WheelPage çæä¸ä¸ªãå·¥å·æ½å±éçå°ä¸è¥¿ãï¼<br>
èä¸æ¯ä¸ä¸ªéè¦ä½ æç»­å³æ³¨çäº§åã</p>
<hr>
<h2 id="åå¨æå">åå¨æå</h2>
<p>WheelPage å¹¶ä¸æ¯ä¸ºäºè§£å³äººçéå¤§å³ç­èå­å¨çã</p>
<p>å®å­å¨çæä¹ï¼æ°æ°æ¯ä¸ºäºè®©ä½ ä¸ç¨å¨å°äºä¸æ¶èå¤ªå¤æ³¨æåã</p>
<p>ææ¶åï¼ä¸ä¸ªå¤é¨çãéæºçãæ²¡ææç»ªçç»æï¼<br>
åèè½å¸®ä½ æ´å¿«è¡å¨ã</p>
<p>çè³å¨æäºæ¶å»ï¼å®è¿è½è®©ä½ çæ¸èªå·±çæ­£æ³è¦çæ¯ä»ä¹ã</p>
<p>å¦æä½ æç±»ä¼¼çå°æ°ï¼ä¹è®¸è¿ä¸ªå°å·¥å·è½å¸®ä½ èçä¸ç¹æ³¨æåã</p>
<p>å®å°±å¨é£å¿ï¼<br>
ä¸åµä½ ï¼ä¹ä¸å¬ä½ ã</p>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-01-11 15:33">2026-01-11 15:33</span>&nbsp;
<a href="https://www.cnblogs.com/BigFunny">OnlyFunny</a>&nbsp;
éè¯»(<span id="post_view_count">455</span>)&nbsp;
è¯è®º(<span id="post_comment_count">3</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19468424);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19468424', targetLink: 'https://www.cnblogs.com/BigFunny/p/19468424', title: 'å½æä¸æ³åä¸ºãå°å³å®ãæ¶èæ³¨æåæ¶ï¼æåäºä¸ä¸ªå¾å°çå·¥å·' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ å¬è¯´C++å¥½åå·å·å»ç»ä»ä¹"ç»ä¸æ­¦å"å»äº ]]></title>
    <link>https://www.cnblogs.com/lixingqiu/p/19468363</link>
    <guid>78c31845b0aeaaa97ce4545405e410ab</guid>
    <description>
    <![CDATA[ 
	<h1 class="postTitle"><a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/lixingqiu/p/19468363" title="åå¸äº 2026-01-11 15:07">
    <span role="heading" aria-level="2">å¬è¯´C++å¥½åå·å·å»ç»ä»ä¹"ç»ä¸æ­¦å"å»äº</span>
    

</a>
</h1>
	<div id="cnblogs_post_body" class="blogpost-body blogpost-body-html">
<p><img alt="monkey" width="417" height="417" loading="lazy" data-src="https://img2024.cnblogs.com/blog/523461/202601/523461-20260111150642124-1051860930.png" class="lazyload"></p>
<p>&nbsp;</p>
<p>å¿ï¼å¤§å®¶ä¼å¿ä»¥åæ¯ä¸æ¯é½å¬é£ä¸ªèä¼ è¯´äºï¼å­¦C++å°±åèµ°èéï¼é¾äºä¸éå¤©ï¼å­¦Pythonå¢ï¼é£å«ä¸ä¸ªé¡ºæ»ï¼ååæå»ä¸æ ·ãäºæ¯ä¹ï¼å¤å°ææ£æ¢¦æ³çå°ç·å°å¥³ï¼è¿æ²¡çå°C++ççªå£å¼¹åºæ¥ï¼å°±è¢«é£ä¸å æéãåå­ç®¡çåéäºï¼è½¬å¤´æ±äºPythonçå¤§è¿ã</p>
<p>ä½æ¯ï¼æ¶ä»£åäºåæåä»¬ï¼èªä»æäºè¿ä¸ªâC++ç²¾çµåºâï¼C++ä¹å­¦ä¼äºåèäºãä»¥åæä¸ªå¾å½¢çé¢ï¼åæ¯åå»ºç»ç¬åæ¯è®¾ç½®åæ ç³»ï¼é£ä»£ç åå¾æ¯ç»ä¹¦è¿é¿ââå°¤å¶æ¯è¿å¨æ£é¼èå¼åç¯å¢çåå­¦ä»¬ï¼é£ç§éç½®ç¯å¢çé¸ç½ï¼è°è¯è°ç¥éãç°å¨å¢ï¼ä½ çè¿æ®µä»£ç ï¼å è¡æä»¤ï¼å±å¹å°±äº®äºï¼ç®ç´åå¼äºæã</p>
<p>å°±æ¿è¿ãå­æç©ºç72åå¨ç»ãæ¥è¯´å§ï¼è¿ä»£ç åå¾é£å«ä¸ä¸ªéå¿ææ¬²ãé£ä¸ªå«<code>monkey</code>çå°å®¶ä¼ï¼ççæ¯ä¸ä¸ªå°ç²¾çµãä¸ä¸ç§è¿æ¯å¤§å£ç·ï¼ä¸ä¸ç§åæäºåå¤´å¼ºï¼è½¬ç¼åæ··è¿äºæºå¨ç«çéä¼ï¼çè³è¿è½ååºä¸ªä¸­å½ç»æ¥ï¼è¿åªæ¯åä»£ç åï¼è¿ç®ç´æ¯âè¿è¿çâç°åºçï¼ä½ è®©é¿ç«¥æ¨å»æç°å¤ªç¼ï¼è¿èæ´ï¼ä¹å°±C++å ä¸è¿ç²¾çµåºè½éåå¾è¿ä¹æºã</p>
<p>æç»çæ¯ä»ä¹ï¼æ¯é£ä¸ªå¾ªç¯ã<code>monkey.next_shape().wait(...)</code>ãå°±è¿ä¹ä¸å¥ï¼å­æç©ºå°±å¨å±å¹ä¸å¼å§äºä»çå·å§åè¸å¤§èµãä¸éè¦ä½ æä»ä¹å¤æçåºå±æ¸²æï¼ä¹ä¸éè¦ä½ ä¸ºäºä¸ä¸ªçªå£å¥ææè³æ è®ãç°å¨çC++ï¼å°±åè¿å­æç©ºä¸æ ·ï¼å­¦ä¼72åäºãå®æèº«ä¸åï¼ä»é£ä¸ªå·å°å°çâç¡¬æ±âï¼åæäºä¸ä¸ªè½éªä½ ç©ãè½éªä½ é¹ãè¿è½éä¾¿ä½ æé åçâå°å¯ç±âã</p>
<p>æä»¥åï¼å«åæ­»æ±çâC++é¾å¦å¤©ä¹¦âçèé»åäºãå¨è¿ä¸ªç²¾çµåºéï¼C++æé¨æ§é½æäºï¼éºä¸äºä¸å±çº¢å°æ¯¯æ¬¢è¿å¤§å®¶ãè¿ãç´çåå½¢è®°ãæ¼çå¯ä¸æ¯å­æç©ºï¼æ¼çæ¯C++çâåå½¢è®°âââåæ¥ï¼ä½ ç¦»å¤§ç¥ä¹é´ï¼åªå·®ä¸ä¸ªä¼72åçç²¾çµåºï¼</p>
<p><span style="color: rgba(255, 0, 0, 1)"><strong>è¯´äºè¿ä¹å¤ï¼æ­£æå¨æ­¤ï¼</strong></span></p>
<div class="cnblogs_code">
<pre>#include <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">sprites.h</span><span style="color: rgba(128, 0, 0, 1)">"</span>  <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">åå«C++ç²¾çµåº </span>
Sprite monkey;       <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">å»ºç«è§è²å«monkey </span>

<span style="color: rgba(0, 0, 255, 1)">int</span> main(){        <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">ä¸»åè½å </span>
   monkey.bgcolor(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">black</span><span style="color: rgba(128, 0, 0, 1)">"</span>).scale(<span style="color: rgba(128, 0, 128, 1)">0.5</span>);  <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">èæ¯é»ï¼è§è²åå°ä¸å
   </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">æ¬ç¬ï¼å¹¶ä¸ç§»é¤ç´¢å¼ä¸º0çé åï¼é»è®¤å°ç«ç®­)</span>
   monkey.penup().removeshape(<span style="color: rgba(128, 0, 128, 1)">0</span>).color(<span style="color: rgba(128, 0, 128, 1)">200</span>).addy(<span style="color: rgba(128, 0, 128, 1)">200</span><span style="color: rgba(0, 0, 0, 1)">);
   std::</span><span style="color: rgba(0, 0, 255, 1)">string</span> s = <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">C++å­æç©ºç72åå°å¨ç»</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">;
   monkey.write(s,</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">center</span><span style="color: rgba(128, 0, 0, 1)">"</span>,{<span style="color: rgba(128, 0, 0, 1)">""</span>,<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">48</span><span style="color: rgba(128, 0, 0, 1)">"</span>,<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">normal</span><span style="color: rgba(128, 0, 0, 1)">"</span>}).wait(<span style="color: rgba(128, 0, 128, 1)">1</span><span style="color: rgba(0, 0, 0, 1)">);
   monkey.addy(</span>-<span style="color: rgba(128, 0, 128, 1)">200</span><span style="color: rgba(0, 0, 0, 1)">);
   monkey.addshape(</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">res/é¿ç«¥æ¨.png</span><span style="color: rgba(128, 0, 0, 1)">"</span>);   <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">æ·»å é å</span>
   monkey.addshape(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">res/åå¤´å¼º.png</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">);
   monkey.addshape(</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">res/ç°å¤ªç¼.png</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">);
   monkey.addshape(</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">res/æºå¨ç«.png</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">);
   monkey.addshape(</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">res/monkey.png</span><span style="color: rgba(128, 0, 0, 1)">"</span>); <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">å­æç©º</span>
   monkey.addshape(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">res/å¤æäºº.png</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">);
   monkey.addshape(</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">res/ä¸­å½ç».png</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">);
   monkey.addshape(</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">res/qirocketboy.png</span><span style="color: rgba(128, 0, 0, 1)">"</span>);  <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">éªç«ç®­é£åå¤ªç©ºçç·å­©
   </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">å è½½èæ¯é³ä¹</span>
   Mix_Music *music=Mix_LoadMUS(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">res/monkeybgmusic.wav</span><span style="color: rgba(128, 0, 0, 1)">"</span>);  <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">ä¸æ¯æä¸­æå</span>
   Mix_PlayMusic(music,-<span style="color: rgba(128, 0, 128, 1)">1</span>);  <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">-1è¡¨ç¤ºæ éå¾ªç¯æ­æ¾ï¼0è¡¨ç¤ºæ­æ¾1æ¬¡ï¼1åæ¯2æ¬¡ã
   </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> g_screenæ¯è§è²å»ºç«åçå¨å±å±å¹æé  </span>
   <span style="color: rgba(0, 0, 255, 1)">while</span>(g_screen-&gt;exitonclick())  <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">åå»çªå£å³é­æé®åå¾ªç¯éåº</span>
     monkey.next_shape().wait(random(<span style="color: rgba(128, 0, 128, 1)">0.9</span>,<span style="color: rgba(128, 0, 128, 1)">1.5</span>)); <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">å­æç©ºåæ¢é åï¼å¹¶ä¸éæºç­å¾ä¸å®çæ¶é´  </span>
   <span style="color: rgba(0, 0, 255, 1)">return</span> <span style="color: rgba(128, 0, 128, 1)">0</span><span style="color: rgba(0, 0, 0, 1)">;
}</span></pre>
</div>
<p>ååï¼æå¿äºçå®æ²¡æå­¦è¿C++äºï¼ä¸è¿è¿éè¿æè§é¢ï¼</p>
<p>................................................................................................(æ­¤å¤è¿å»5åé)</p>
<p>å®äºï¼æ¾äºåå¤©æ²¡ææ¾å°å¨åªéæå¥è§é¢ï¼åªå¾å§å±çå®å»æé³å·pxcodingæ¾ãå­æç©ºç72åå°å¨ç»ãå§ã</p>
<p>åè§äºï¼æçå°å®è´ä»¬ã</p>
<p>&nbsp;</p>
</div>
<div class="clear"></div>

	<div class="postDesc">posted on 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-01-11 15:07">2026-01-11 15:07</span>&nbsp;
<a href="https://www.cnblogs.com/lixingqiu">æå´ç</a>&nbsp;
éè¯»(<span id="post_view_count">291</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19468363);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19468363', targetLink: 'https://www.cnblogs.com/lixingqiu/p/19468363', title: 'å¬è¯´C++å¥½åå·å·å»ç»ä»ä¹&amp;quot;ç»ä¸æ­¦å&amp;quot;å»äº' })">ä¸¾æ¥</a>
</div>
 ]]>
    </description>
    </item>
        </channel>
        </rss>