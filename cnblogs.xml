<?xml version="1.0" encoding="UTF-8" ?>
    <rss version="2.0">
    <channel>
        <title><![CDATA[ ä¸»é¡µ - åå®¢å­ ]]></title>
        <link><![CDATA[ https://www.cnblogs.com/ ]]></link>
        <lastBuildDate>2026-02-15T08:28:11.116Z</lastBuildDate>
        <description><![CDATA[
        ä¸»é¡µ - åå®¢å­ RSS
    ]]></description>
        <language>zh-cn</language>
        <item>
    <title><![CDATA[ ä¸ºä»ä¹å¨ä»£çæå¡å¨ä¸æµè¯ï¼ http2 çè½¬åæ§è½æ¯ http 1 æ´ä½ï¼ ]]></title>
    <link>https://www.cnblogs.com/ahfuzhang/p/19618259</link>
    <guid>8ce3a9410af55348202fe98e5a48dddb</guid>
    <description>
    <![CDATA[ 
		<div class="postcontent">
			<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<p><strong><font size="1" color="gray">ä½è:å¼ å¯æ¥(ahfuzhang)ï¼è½¬è½½æ¶è¯·æ³¨æä½èåå¼ç¨é¾æ¥ï¼è°¢è°¢ï¼</font></strong></p>
<ul>
<li><font size="1" color="gray"><a href="https://www.cnblogs.com/ahfuzhang/" target="_blank">cnblogsåå®¢</a></font></li>
<li><font size="1" color="gray"><a href="https://www.zhihu.com/people/ahfuzhang/posts" target="_blank" rel="noopener nofollow">zhihu</a></font></li>
<li><font size="1" color="gray"><a href="https://github.com/ahfuzhang" target="_blank" rel="noopener nofollow">Github</a></font></li>
<li><font size="1" color="gray">å¬ä¼å·:ä¸æ¬æ­£ç»ççæ¯</font><br>
<img alt="" loading="lazy" data-src="https://img2022.cnblogs.com/blog/1457949/202202/1457949-20220216153819145-1193738712.png" class="lazyload"></li>
</ul>
<hr>
<p>æå¨æµè¯ Http2 server ä¸ Http 1.1 server çæ§è½å·®å¼æ¶ï¼æé«æµè¯æ°æ®æ¯ http2 æ¯ http1 å¿« 3.6 åã<br>
è Carter å¨æµè¯ apisix ä»£çæå¡å¨çæ§è½çæ¶åï¼å¾å°çæ°æ®æ¯ http2 çæ§è½åªæ http 1 ç 80%ã<br>
æä»¬æ¾å½¼æ­¤è´¨çå¯¹æ¹çæ°æ®ï¼å¹¶è§å¾ä¸å¯æè®®ï¼<br>
æçè§ç¹æ¯ï¼äºè¿å¶åè®®ä¸å®å¿«è¿ææ¬åè®®ï¼æ²¡çç±å¨ä»£çæå¡å¨ä¸æµè¯çæ°æ®ä¼å¯¼è´ http2 æ¢äº http 1ã</p>
<p>ä»å¤©ç»äºæ³æç½äºåå ï¼å¶å®æä»¬é½æ²¡éï¼<br>
ç»è®ºæ¯ï¼å¨ä»£çæå¡å¨ä¸ï¼http2 çè½¬åæ§è½ä¼ä½äº http 1ã<br>
å¯¼è´è¿ä¸é¡¹å·®å¼çå³é®æ¯ <code>splice()</code> ç³»ç»è°ç¨ï¼ä¹å°±æ¯ä»£çæå¡å¨ä¸­å®ç°<code>é¶æ·è´</code>çå³é®ã</p>
<p>(åç»­å¤§éå¼ç¨ ChatGPT çåç­)</p>
<h1 id="splice-æ¯ä»ä¹">splice() æ¯ä»ä¹ï¼</h1>
<p>splice() æ¯ Linux çä¸ä¸ªç³»ç»è°ç¨ï¼C ééè¿ splice(2) æ´é²ï¼ï¼ç¨æ¥å¨ ä¸¤ä¸ªæä»¶æè¿°ç¬¦ä¹é´æ¬è¿æ°æ®ï¼å¹¶ä¸å°½éèµ° é¶æ·è´ï¼zero-copyï¼ è·¯å¾ï¼åå°ç¨æ·æç¼å²åºåä¸ã</p>
<p>æå¸åçç¨éï¼æä»¶ â ç®¡éãç®¡é â socketï¼ç¨å®å¯ä»¥ææ°æ®ä»ç£çæä»¶ç´æ¥âéâå°ç½ç»è¿æ¥éï¼ä¸­é´ä¸éè¦ read() å°ç¨æ·æå write() ååæ ¸ã</p>
<p>â¸»</p>
<p>å®è§£å³ä»ä¹é®é¢</p>
<p>ä¼ ç»åæ³ï¼</p>
<pre><code class="language-c">read(file_fd, user_buf, n);
write(sock_fd, user_buf, n);
</code></pre>
<p>ç¼ºç¹ï¼æ°æ®ä¼å¨åæ ¸ â ç¨æ·æä¹é´æ·è´ï¼è¿å¯è½æ±¡æ CPU cacheãå ç¨åå­å¸¦å®½ï¼ã</p>
<p>splice() çç®æ ï¼è®©æ°æ®å°½éå¨åæ ¸åé¨ç§»å¨ï¼æ¯å¦ä» page cache / pipe buffer ç´æ¥å° socket bufferï¼ï¼åå°ä¸æ¬¡æå¤æ¬¡æ·è´ã</p>
<p>â¸»</p>
<p>å®çåºæ¬å½¢æï¼è¯­ä¹ï¼</p>
<pre><code class="language-c">ssize_t splice(int fd_in,  loff_t *off_in,
               int fd_out, loff_t *off_out,
               size_t len, unsigned int flags);
</code></pre>
<pre><code>â¢	fd_in / fd_outï¼è¾å¥/è¾åº fd
â¢	off_in / off_outï¼
â¢	ä¼  NULL è¡¨ç¤ºä½¿ç¨ fd å½ååç§»å¹¶æ¨è¿ï¼åæ®éè¯»åé£æ ·ï¼
â¢	é NULL åç¨ä½ æä¾çåç§»ï¼ç±»ä¼¼ pread/pwrite çå³éï¼ï¼å¹¶ä¸ä¸ä¸å®ä¿®æ¹ fd çæä»¶åç§»ï¼å·ä½åå³äºå¯¹è±¡ç±»åï¼
â¢	lenï¼æå¤æ¬è¿å¤å°å­è
â¢	flagsï¼æ§å¶é»å¡/ç§»å¨è¡ä¸ºï¼ä¾å¦ SPLICE_F_NONBLOCK ç­ï¼
</code></pre>
<p>è¿åå¼ï¼å®éæ¬è¿çå­èæ°ï¼0 éå¸¸è¡¨ç¤º EOFï¼-1 è¡¨ç¤ºåºéï¼errno è¯´æåå ï¼ã</p>
<p>â¸»</p>
<p>å¸¸è§ç»å</p>
<ol>
<li>
<p>file â pipe â socketï¼é«æ§è½âåéæä»¶âï¼<br>
â¢	splice(file_fd â pipe_write_end)<br>
â¢	splice(pipe_read_end â sock_fd)<br>
è¿ç±»ç»åå¸¸ç¨äºå®ç°âç±»ä¼¼ sendfile çææâï¼ä½ splice æ´éç¨ï¼å°¤å¶éåä½ è¿è¦å¨ä¸­é´åç¹å«çåæ ¸æå¤ççåºæ¯ï¼ã</p>
</li>
<li>
<p>pipe â pipe</p>
</li>
</ol>
<p>ç¨äºå¨ç®¡éä¹é´è½¬ç§»æ°æ®ï¼æ¯å¦éå tee() åå¤å¶ï¼ã</p>
<p>â¸»</p>
<p>éç¨éå¶ï¼å¾éè¦ï¼<br>
â¢	å¹¶ä¸æ¯ä»»æ fd é½æ¯æãsplice éè¦åºå±æä»¶æä½å®ç°æ¯æï¼VFS/é©±å¨/åè®®æ ï¼ã<br>
â¢	å¨ Linux ä¸ï¼pipe ç»å¸¸æ¯ splice çâä¸­è½¬ç«âï¼å¾å¤åºæ¯è¦æ± fd_in æ fd_out è³å°æä¸ç«¯æ¯ pipeï¼æèæç»å¨åæ ¸åé¨ç¨ pipe buffer åæ¿è½½ï¼ã<br>
â¢	æ°æ®æ¥æºå¦ææ¯æ®éæä»¶ï¼éå¸¸æ¥èª page cacheï¼å æ­¤è½åå°å°æ·è´æé¶æ·è´ï¼ã</p>
<p>â¸»</p>
<p>å sendfile() çå³ç³»<br>
â¢	sendfile()ï¼æ´âä¸ç¨âï¼éå¸¸æ¯ æä»¶ â socket çå¿«éè·¯å¾ã<br>
â¢	splice()ï¼æ´âéç¨âï¼å¯ä»¥å¨æ´å¤ç±»åç fd ä¹é´æ¬è¿ï¼å¸¸è§ç¨æ³æ¯ éè¿ pipe ä½ä¸ºæ¡¥ æ¥æ¼æ¥æ fileâsocket çé¶æ·è´é¾è·¯ã</p>
<h1 id="å°±ç®-splice-æåæ ¸ä¸­-socket-buffer-çæ°æ®è½¬ç§»å°äº-pipe-ä¸é¢ç¨æ·ä½¿ç¨æ¶ä¹ä»ç¶è¦-readä¼¼ä¹å¹¶æ²¡æåå°é¶æ·è´">å°±ç® splice æåæ ¸ä¸­ socket buffer çæ°æ®è½¬ç§»å°äº pipe ä¸é¢ï¼ç¨æ·ä½¿ç¨æ¶ä¹ä»ç¶è¦ read()ï¼ä¼¼ä¹å¹¶æ²¡æåå°é¶æ·è´ï¼</h1>
<p>å¯¹ï¼ä½ çè§£å¾å¾åç¡®ï¼åªè¦æç»è¦å¨ç¨æ·æâçè§/å¤çâå­èæµï¼å°±ç»ä¸å¼ä¸æ¬¡ copy_to_userãsplice(socket â pipe) åªæ¯æâä» socket è¯»å°ç¨æ·ç¼å²åºâè¿ä¸æ­¥ï¼æ¢æäºâä» socket è¯»å°åæ ¸ pipeâï¼å æ­¤å®ä¸è½æ¶é¤âåæ ¸ â ç¨æ·æâçæ·è´ï¼ä½ åé¢ read(pipefd, userbuf, â¦) ä»ç¶ä¼æ·è´ã</p>
<p>æ´ç²¾ç¡®å°è¯´ï¼<br>
â¢	ä¼ ç»è·¯å¾ï¼ç¨æ·ææ¶è´¹ï¼<br>
recv()/read(socket, userbuf)<br>
â åæ ¸ socket æ¥æ¶éå â ç¨æ·æ userbufï¼ä¸æ¬¡ copy_to_userï¼<br>
â¢	splice è·¯å¾ï¼ç¨æ·æä»è¦æ¶è´¹ï¼<br>
splice(socket â pipe)ï¼åæ ¸åæ¬è¿/éæé¡µï¼é¿å copy_to_userï¼<br>
ç¶å read(pipe â userbuf)<br>
â pipe â ç¨æ·æ userbufï¼è¿æ¯ä¸æ¬¡ copy_to_userï¼</p>
<p>æä»¥ï¼âç¨æ·æè¦æ¿å° payloadâè¿ä¸ç®æ ä¸ï¼splice ä¸ä¼åå°æ»æ·è´æ¬¡æ°å° 0ãå®å¯è½åå°çæ¯ï¼<br>
â¢	å°ä¸æ¬¡âå¤ä½çä¸­é´ buffer æ·è´/æ¬è¿âï¼æ¯å¦ä½ åæ¥å read å°ç¨æ·ï¼å write å°å¦ä¸ä¸ª fdï¼<br>
â¢	æåå° CPU å¼éï¼æäºåºæ¯ä¸ä» socket ç´æ¥æå° pipeãå splice å°ç®æ  fdï¼</p>
<h1 id="ä»ä¹æ¶å-splice-çæ­£ææä¹è½æç¨æ·ææ·è´éå°-0">ä»ä¹æ¶å splice çæ­£ææä¹ï¼è½æç¨æ·ææ·è´éå° 0ï¼ï¼</h1>
<ol>
<li>çº¯è½¬åï¼ä¸è§£ææ°æ®ï¼</li>
</ol>
<p>socket_in â pipe â socket_out / file<br>
ä½ ä¸å¨ç¨æ·æè§¦ç¢°æ°æ®ï¼åªåè½¬å/è½çãå¸åï¼ååä»£çãL7 ä½ä¸è§£åãå½æµå°æä»¶ç­ã</p>
<ol start="2">
<li>âåªçå°éå¤´é¨ + å¤§é bodyâ çæ··å</li>
</ol>
<p>æ¯å¦ HTTPï¼ä½ å¨ç¨æ·æåª recv ä¸å°æ®µ header åå³ç­ï¼body ç¨ splice èµ°é¶æ·è´è½¬åã<br>
è¿ç±»è½æ¾èåå° copy_to_user çæ»éï¼å ä¸ºå¤§å¤´ body ä¸è¿ç¨æ·æï¼ã</p>
<p>â¸»</p>
<p>ä½ çæ­£å³å¿çç¹ï¼TCP éè®¯éçæ·è´å°åºè½ä¸è½åå°ï¼<br>
â¢	åºç¨å±å¿é¡»å¤ç payloadï¼è§£ç ãåç¼©ãJSONãprotobufâ¦ï¼ï¼<br>
è³å°ä¸æ¬¡åæ ¸âç¨æ·æ·è´ä¸å¯é¿åï¼æå­èäº¤ç»è¿ç¨ï¼ã<br>
â¢	åºç¨å±ä¸å¤ç payloadï¼åªè½¬åï¼<br>
å¯ä»¥åå° 0 æ¬¡è¿å¥ç¨æ·æï¼splice/é NIC ç¸å³ offload å¦è¯´ï¼ã</p>
<h1 id="å¯¹äºä»£çæå¡å¨-æ¯ä¸æ¯å¯ä»¥çè§£ä¸º-http-1-å¤§é¨åé½æåµè½ååæ ¸æçåå±è½¬åè-http-2-åªè½åç¨æ·æçä¸å±è½¬å">å¯¹äºä»£çæå¡å¨ï¼ æ¯ä¸æ¯å¯ä»¥çè§£ä¸º http 1 å¤§é¨åé½æåµè½ååæ ¸æçåå±è½¬åï¼è http 2 åªè½åç¨æ·æçä¸å±è½¬å?</h1>
<p>ä¸å®å¨å¯¹ï¼ä½ä½ è¿ä¸ªç´è§æå°äºä¸åï¼å³å®è½ä¸è½âå L4 é£æ ·åæ ¸æè½¬åâçå³é®ï¼ä¸æ¯ HTTP/1 vs HTTP/2ï¼èæ¯ä»£çè¦ä¸è¦çè§£åè®®è¯­ä¹ãè¦ä¸è¦âç»æ­¢è¿æ¥å¹¶éå»ºè¿æ¥âã HTTP/2 å ä¸ºå¤è·¯å¤ç¨ + æµæ§ + å¤´åç¼©ï¼ç¡®å®æ´å®¹ææä½ âé¼å°âç¨æ·æ L7ï¼ä½ HTTP/1 ä¹ä¸æ¯å¤©ç¶å°±è½åæ ¸æè½¬åã</p>
<p>æå®ææå ç§ä»£çå½¢æï¼ä½ ä¼æ´æ¸æ¥ï¼</p>
<ol>
<li>çÂ·L4 ä»£çï¼TCP/åå±è´è½½åè¡¡ï¼<br>
â¢	ä¸ç HTTPï¼åªè½¬åå­èæµï¼å®¢æ·ç«¯ TCP â åç«¯ TCPã<br>
â¢	è¿å¯¹ HTTP/1 å HTTP/2 é½ä¸æ ·ï¼é½è½åâåæ ¸åå¥½âçè½¬åï¼ä¾å¦ splice/é¶æ·è´è·¯å¾ãçè³åæ ¸éç TPROXY/IPVS ç­ï¼ã<br>
â¢	ä»£ä»·ï¼ä½ åä¸äºæ URL/Host/Header çè·¯ç±ãé´æãééç­ L7 è½åã</li>
</ol>
<p>â ç»è®ºï¼HTTP/2 ä¹å¯ä»¥å L4 è½¬åï¼åªæ¯æ­¤æ¶ä½ æ ¹æ¬ä¸ç¥éå®æ¯ HTTP/2ã</p>
<ol start="2">
<li>HTTP/1 ç L7 åä»£ï¼å¸¸è§ Nginx/Envoy çé£ç§ï¼<br>
â¢	ä½ è¦è¯»è¯·æ±è¡/headersï¼å³å®è·¯ç±ï¼å¯è½æ¹ headerï¼å¯è½ç¼å­ãåç¼©ãéè¯ç­ã<br>
â¢	è¿å°±å·²ç»æ¯ ç¨æ·æ L7 äºï¼ä¸æ¯âåæ ¸æ L4âã</li>
</ol>
<p>ä¸è¿ HTTP/1 æä¸ä¸ªâå®¹æä¼åâçç¹ï¼<br>
â¢	header/body åçæ¸æ°ï¼ä¸éå¸¸ä¸ä¸ªè¿æ¥åä¸æ¶å»æå¡ä¸ä¸ªè¯·æ±ï¼å³ä¾¿ keep-aliveï¼ä¹å¤æ¯ä¸²è¡ï¼ç®¡çº¿åå¾å°ç¨ï¼ã<br>
â¢	æä»¥å¯ä»¥å âåªå¨ç¨æ·æè¯»å°é headerï¼ç¶å body ç¨ splice ç´éâï¼å¤§ body ä¸ä¼ /ä¸è½½æ¶å¾é¦ï¼ã</p>
<p>â ç»è®ºï¼HTTP/1 ä¸æ¯âå¤§é¨åé½è½åæ ¸æ L4 è½¬åâï¼å®åªæ¯ æ´å®¹æåâå L7 + åé¶æ·è´ç´éâã</p>
<ol start="3">
<li>HTTP/2 ç L7 åä»£ï¼stream çº§è·¯ç±ãå¤è·¯å¤ç¨ï¼<br>
â¢	åä¸æ¡ TCP è¿æ¥éäº¤éå¤ä¸ª stream ç framesã<br>
â¢	ä½ è¦æ stream æå¸§ãè°åº¦ãç»´æ¤æµæ§çªå£ãå¤ç HPACKã<br>
â¢	ååä¸¤ç«¯éå¸¸æ¯ä¸¤æ¡ç¬ç«è¿æ¥ï¼å®¢æ·ç«¯ä¸æ¡ H2ï¼åç«¯å¦ä¸æ¡ H2 æ H1ï¼ï¼stream id/çªå£/HPACK å¨æè¡¨é½ä¸å¯è½åå°ä¸å¨âç´éâã</li>
</ol>
<p>è¿ä½¿å¾ æå¤§æ®µ payload å½ä½è¿ç»­å­èâsplice è¿å»âéå¸¸å°é¾ï¼å ä¸ºä½ å¿é¡»åå¨ç¨æ·ææå±äºæä¸ª stream ç DATA å¸§æåºæ¥ååå°åç«¯ï¼èä¸è¿å¯è½è¦éæ/éé/ä¼åçº§ï¼ã</p>
<p>â ç»è®ºï¼HTTP/2 å L7 åä»£æ¶ï¼åºæ¬åªè½ç¨æ·æä¸ºä¸»ï¼æèè¯´ï¼å¿é¡»æâåè®®ç»æ­¢ç¹âå¨ç¨æ·æ/å®ç°å±ï¼ã</p>
<p>â¸»</p>
<p>æ´åç¡®çä¸å¥è¯<br>
â¢	HTTP/1ï¼æ´å®¹ææâbodyâåæåæ ¸æç´éï¼splice/sendfileï¼ï¼ç¨æ·æåªå¤çå°éæ§å¶é¢ï¼headersï¼ã<br>
â¢	HTTP/2ï¼åªè¦ä½ è¦å L7ï¼æ stream/headers è·¯ç±ï¼ï¼å°±å¾é¾åå° body å®å¨åæ ¸æç´éï¼å ä¸º framing/mux/flow-control è¿«ä½¿ä½ åä¸æ°æ®ååã<br>
â¢	ä½ HTTP/2 ä¾ç¶å¯ä»¥åçº¯ L4 è½¬åï¼åªæ¯ä½ å¤±å»ææ L7 è½åï¼ã</p>
<h1 id="æ»ç»">æ»ç»</h1>
<ul>
<li>http 1.1 çåè®®ç¹ç¹ï¼header å body æææ¾çåºåï¼body çé¿åº¦éå¸¸æç¡®ï¼ä¸æ¡ tcp è¿æ¥ä¸åæ¶åªæä¸ä¸ªè¯·æ±ååº ââ å æ­¤ï¼å¨ä»£çæå¡å¨çåºæ¯ï¼ http 1 å¾å®¹æä½¿ç¨ splice è¿æ ·é¶æ·è´æºå¶æ¥ä¼åã
<ul>
<li>ç¹å«æ¯ body é¨åè¿æ ·æ´é¿çåå®¹ï¼ç´æ¥å¨åæ ¸æå°±è½å¤å®ç°æ°æ®äº¤æ¢ï¼å®å¨ä¸éè¦ææ°æ®æ·è´å°ç¨æ·æï¼åä»ç¨æ·æåéåºå»ã</li>
</ul>
</li>
<li>http 2 å¨ä¸æ¡ tcp è¿æ¥ä¸æå¤ä¸ªæµï¼æ¯ä¸ªæµè¶åº <code>SETTINGS_MAX_FRAME_SIZE</code> åè¿ä¼åæå¤ä¸ª frame ââ ç±æ­¤å³å®äº http2 ä¸éè¿ splice å®ç°é¶æ·è´ä¼åå¾å°é¾ï¼æèè¯´è½å¤çæ­£é¶æ·è´çåºæ¯åå°äºã</li>
<li>å¯¹äºæå¡å¨èè¨ï¼
<ul>
<li>http 2 è¿æ ·çäºè¿å¶åè®®ç¡®å®æ¯ http 1 æ´å¿«ï¼ç¹å«æ¯å api server / rcp server è¿æ ·çæ°æ®åå°+è¯·æ±é¢ç¹çåºæ¯ï¼http2 æ¯ http1 å¿« 3.6 åå°±ä¸å¥æªäºã</li>
<li>å¦ææ¯å¾çä¸è½½/æä»¶ä¸è½½/å¤§ååéçæ°æ®ä¼ è¾ï¼éæ© http1 æ´å¥½</li>
</ul>
</li>
</ul>


</div>
<div class="clear"></div>

		</div>
		<div class="itemdesc">
			åè¡¨äº 
<span id="post-date" data-last-update-days="0.0020833333333333333" data-date-updated="2026-02-15 16:18">2026-02-15 16:15</span>&nbsp;
<a href="https://www.cnblogs.com/ahfuzhang">ahfuzhang</a>&nbsp;
éè¯»(<span id="post_view_count">0</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19618259);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19618259', targetLink: 'https://www.cnblogs.com/ahfuzhang/p/19618259', title: 'ä¸ºä»ä¹å¨ä»£çæå¡å¨ä¸æµè¯ï¼ http2 çè½¬åæ§è½æ¯ http 1 æ´ä½ï¼' })">ä¸¾æ¥</a>

		</div>
	 ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ Go - slogä½¿ç¨å¥é¨ ]]></title>
    <link>https://www.cnblogs.com/XY-Heruo/p/19618220</link>
    <guid>828d45c80403ed7c4402b08a8965954e</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/XY-Heruo/p/19618220" title="åå¸äº 2026-02-15 15:45">
    <span role="heading" aria-level="2">Go - slogä½¿ç¨å¥é¨</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                    <div id="cnblogs_post_description" style="display: none">
        
        Goæ ååºslogä½¿ç¨å¥é¨
    </div>
<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h2 id="ç®ä»">ç®ä»</h2>
<p><code>slog</code> æ¯ Go 1.21 å¼å¥çå®æ¹ç»æåæ¥å¿åºï¼Structured Loggingï¼ãå®ç»æäº Go æ ååºåªæç®å <code>log</code> åçåå²ï¼è®©æä»¬å¯ä»¥ç´æ¥è¾åº <strong>JSON</strong> æ <strong>Key-Value</strong> æ ¼å¼çæ¥å¿ï¼éå¸¸éåå¯¹æ¥ ELKãGrafana Loki ç­æ¥å¿åæç³»ç»ã</p>
<p>ç¸è¾äºç¬¬ä¸æ¹æ¥å¿åºå¦ <code>zap</code>ã<code>logrus</code>ï¼<code>slog</code> çä¼å¿å¨äºï¼</p>
<ul>
<li><strong>é¶ä¾èµ</strong>ï¼ä½ä¸ºæ ååºçä¸é¨åï¼æ éå¼å¥ç¬¬ä¸æ¹ä¾èµ</li>
<li><strong>å®æ¹ç»´æ¤</strong>ï¼é¿æç¨³å®ï¼API åæ´æ Go å¼å®¹æ§æ¿è¯ºä¿é</li>
<li><strong>æ¥å£ç®æ´</strong>ï¼API è®¾è®¡æ¸æ°ï¼å­¦ä¹ ææ¬ä½</li>
<li><strong>å¯æ©å±</strong>ï¼éè¿èªå®ä¹ Handler å¯ä»¥å®ç°åç§å®å¶éæ±</li>
</ul>
<h2 id="åºæ¬ä½¿ç¨">åºæ¬ä½¿ç¨</h2>
<p><code>slog</code> ç¨èµ·æ¥éå¸¸ç®åãé»è®¤è¾åºå°æ åéè¯¯æµï¼<code>os.Stderr</code>ï¼ï¼æ ¼å¼ä¸ºæ®éææ¬ã</p>
<pre><code class="language-go">package main

import (
	"fmt"
	"log/slog"
)

func main() {
	slog.Debug("Hello world")
	slog.Info("Hello world")
	slog.Warn("Hello world")
	slog.Error("Hello world")

	slog.Info("this is a message", "name", "zhangsan")

	age := 8
	slog.Warn(fmt.Sprintf("è¿æ¯ %d å²?", age))
}
</code></pre>
<p>è¿è¡è¾åºï¼</p>
<pre><code class="language-shell">$ go run main.go
2026/02/15 11:52:24 INFO Hello world
2026/02/15 11:52:24 WARN Hello world
2026/02/15 11:52:24 ERROR Hello world
2026/02/15 11:52:24 INFO this is a message name=zhangsan
2026/02/15 11:52:24 WARN è¿æ¯ 8 å²?
</code></pre>
<blockquote>
<p><strong>æ³¨æ</strong>ï¼é»è®¤ç <code>slog</code> logger æ¥å¿çº§å«ä¸º <code>INFO</code>ï¼å æ­¤ <code>Debug</code> çº§å«çæ¥å¿ä¸ä¼è¾åºã</p>
</blockquote>
<h3 id="æ¥å¿çº§å«">æ¥å¿çº§å«</h3>
<p><code>slog</code> å®ä¹äºåä¸ªæ¥å¿çº§å«ï¼ä»ä½å°é«ä¾æ¬¡ä¸ºï¼</p>
<table>
<thead>
<tr>
<th>çº§å«</th>
<th>å¸¸é</th>
<th>è¯´æ</th>
</tr>
</thead>
<tbody>
<tr>
<td>DEBUG</td>
<td><code>slog.LevelDebug</code></td>
<td>è°è¯ä¿¡æ¯ï¼å¼åç¯å¢ä½¿ç¨</td>
</tr>
<tr>
<td>INFO</td>
<td><code>slog.LevelInfo</code></td>
<td>å¸¸è§ä¿¡æ¯</td>
</tr>
<tr>
<td>WARN</td>
<td><code>slog.LevelWarn</code></td>
<td>è­¦åä¿¡æ¯</td>
</tr>
<tr>
<td>ERROR</td>
<td><code>slog.LevelError</code></td>
<td>éè¯¯ä¿¡æ¯</td>
</tr>
</tbody>
</table>
<h2 id="è¾åº-json-æ ¼å¼">è¾åº JSON æ ¼å¼</h2>
<p><code>slog</code> å¯ä»¥è¾åº JSON æ ¼å¼ï¼ä¾¿äºä¸ ELKãGrafana Loki ç­æ¥å¿ç³»ç»éæã</p>
<p>ä»¥ä¸ç¤ºä¾æ¼ç¤ºäºå¦ä½ä¿®æ¹é»è®¤çæ¶é´æ³æ ¼å¼åè°ç¨æºè¾åºæ ¼å¼ï¼å¹¶å°å¶è®¾ç½®ä¸ºé»è®¤ loggerï¼</p>
<pre><code class="language-go">package main

import (
	"fmt"
	"log/slog"
	"os"
	"time"
)

func main() {
	jsonLogger := slog.New(slog.NewJSONHandler(os.Stderr, &amp;slog.HandlerOptions{
		AddSource: true,            // æ·»å è°ç¨æºä¿¡æ¯
		Level:     slog.LevelDebug, // è®¾ç½®æ¥å¿çº§å«
		ReplaceAttr: func(groups []string, a slog.Attr) slog.Attr {
			// èªå®ä¹æ¶é´æ ¼å¼
			if a.Key == slog.TimeKey {
				if t, ok := a.Value.Any().(time.Time); ok {
					a.Value = slog.StringValue(t.Format(time.RFC3339))
				}
			}
			// ç®åè°ç¨æºä¿¡æ¯ï¼åªä¿çæä»¶ååè¡å·
			if a.Key == slog.SourceKey {
				source := a.Value.Any().(*slog.Source)
				shortFile := source.File
				for i := len(source.File) - 1; i &gt; 0; i-- {
					if source.File[i] == '/' {
						shortFile = source.File[i+1:]
						break
					}
				}
				return slog.String("source", fmt.Sprintf("%s:%d", shortFile, source.Line))
			}
			return a
		},
	}))

	jsonLogger.Debug("Hello world")
	jsonLogger.Info("Hello world")
	jsonLogger.Warn("Hello world")
	jsonLogger.Error("Hello world")

	jsonLogger.Info("this is a message", "name", "zhangsan")

	age := 8
	jsonLogger.Warn(fmt.Sprintf("è¿æ¯ %d å²?", age))

	// æ¿æ¢é»è®¤ logger
	slog.SetDefault(jsonLogger)
	slog.Debug("Hello world")
	slog.Info("Hello world")
	slog.Warn("Hello world")
	slog.Error("Hello world")

	slog.Info("this is a message", "name", "zhangsan")

	age = 9
	slog.Warn(fmt.Sprintf("è¿æ¯ %d å²?", age))
}
</code></pre>
<p>è¿è¡è¾åºï¼</p>
<pre><code class="language-shell">$ go run main.go
{"time":"2026-02-15T12:07:32+08:00","level":"DEBUG","source":"main.go:38","msg":"Hello world"}
{"time":"2026-02-15T12:07:32+08:00","level":"INFO","source":"main.go:39","msg":"Hello world"}
{"time":"2026-02-15T12:07:32+08:00","level":"WARN","source":"main.go:40","msg":"Hello world"}
{"time":"2026-02-15T12:07:32+08:00","level":"ERROR","source":"main.go:41","msg":"Hello world"}
{"time":"2026-02-15T12:07:32+08:00","level":"INFO","source":"main.go:43","msg":"this is a message","name":"zhangsan"}
{"time":"2026-02-15T12:07:32+08:00","level":"WARN","source":"main.go:46","msg":"è¿æ¯ 8 å²?"}
{"time":"2026-02-15T12:07:32+08:00","level":"DEBUG","source":"main.go:50","msg":"Hello world"}
{"time":"2026-02-15T12:07:32+08:00","level":"INFO","source":"main.go:51","msg":"Hello world"}
{"time":"2026-02-15T12:07:32+08:00","level":"WARN","source":"main.go:52","msg":"Hello world"}
{"time":"2026-02-15T12:07:32+08:00","level":"ERROR","source":"main.go:53","msg":"Hello world"}
{"time":"2026-02-15T12:07:32+08:00","level":"INFO","source":"main.go:55","msg":"this is a message","name":"zhangsan"}
{"time":"2026-02-15T12:07:32+08:00","level":"WARN","source":"main.go:58","msg":"è¿æ¯ 9 å²?"}
</code></pre>
<h3 id="handleroptions-è¯¦è§£">HandlerOptions è¯¦è§£</h3>
<p><code>HandlerOptions</code> æä¾äºä¸ä¸ªéç½®é¡¹ï¼</p>
<table>
<thead>
<tr>
<th>å­æ®µ</th>
<th>ç±»å</th>
<th>è¯´æ</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>AddSource</code></td>
<td><code>bool</code></td>
<td>æ¯å¦æ·»å è°ç¨æºä¿¡æ¯ï¼æä»¶ååè¡å·ï¼</td>
</tr>
<tr>
<td><code>Level</code></td>
<td><code>slog.Leveler</code></td>
<td>æä½æ¥å¿çº§å«ï¼ä½äºæ­¤çº§å«çæ¥å¿å°è¢«å¿½ç¥</td>
</tr>
<tr>
<td><code>ReplaceAttr</code></td>
<td><code>func([]string, slog.Attr) slog.Attr</code></td>
<td>ç¨äºä¿®æ¹ææ¿æ¢å±æ§çåè°å½æ°</td>
</tr>
</tbody>
</table>
<h2 id="with-æ³¨å¥éç¨å±æ§">With æ³¨å¥éç¨å±æ§</h2>
<p>åå»º Logger æ¶ï¼å¯ä»¥ç¨ <code>With</code> æ¹æ³ä¸º logger æ·»å éç¨å±æ§ãè¿äºå±æ§ä¼èªå¨éå å°æ¯æ¡æ¥å¿è®°å½ä¸­ï¼éåæ³¨å¥æå¡åãç¯å¢ãçæ¬ç­ä¸ä¸æä¿¡æ¯ã</p>
<pre><code class="language-go">package main

import (
	"fmt"
	"log/slog"
	"os"
	"time"
)

func main() {
	jsonLogger := slog.New(slog.NewJSONHandler(os.Stderr, &amp;slog.HandlerOptions{
		AddSource: true,
		Level:     slog.LevelDebug,
		ReplaceAttr: func(groups []string, a slog.Attr) slog.Attr {
			if a.Key == slog.TimeKey {
				if t, ok := a.Value.Any().(time.Time); ok {
					a.Value = slog.StringValue(t.Format(time.RFC3339))
				}
			}
			if a.Key == slog.SourceKey {
				source := a.Value.Any().(*slog.Source)
				shortFile := source.File
				for i := len(source.File) - 1; i &gt; 0; i-- {
					if source.File[i] == '/' {
						shortFile = source.File[i+1:]
						break
					}
				}
				return slog.String("source", fmt.Sprintf("%s:%d", shortFile, source.Line))
			}
			return a
		},
	})).With("logger", "json", "env", "production")

	jsonLogger.Debug("Hello world")
	jsonLogger.Info("Hello world")
	jsonLogger.Warn("Hello world")
	jsonLogger.Error("Hello world")

	jsonLogger.Info("this is a message", "name", "zhangsan")
}
</code></pre>
<p>è¿è¡è¾åºï¼</p>
<pre><code class="language-shell">$ go run main.go
{"time":"2026-02-15T13:24:38+08:00","level":"DEBUG","source":"main.go:42","msg":"Hello world","logger":"json","env":"production"}
{"time":"2026-02-15T13:24:38+08:00","level":"INFO","source":"main.go:43","msg":"Hello world","logger":"json","env":"production"}
{"time":"2026-02-15T13:24:38+08:00","level":"WARN","source":"main.go:44","msg":"Hello world","logger":"json","env":"production"}
{"time":"2026-02-15T13:24:38+08:00","level":"ERROR","source":"main.go:45","msg":"Hello world","logger":"json","env":"production"}
{"time":"2026-02-15T13:24:38+08:00","level":"INFO","source":"main.go:47","msg":"this is a message","logger":"json","env":"production","name":"zhangsan"}
</code></pre>
<h2 id="ä½¿ç¨-group-å¯¹å±æ§åç»">ä½¿ç¨ Group å¯¹å±æ§åç»</h2>
<p>å½æ¥å¿å±æ§è¾å¤æ¶ï¼å¯ä»¥ä½¿ç¨ <code>slog.Group</code> å°ç¸å³å±æ§ç»ç»å¨ä¸èµ·ï¼ä½¿è¾åºç»ææ´æ¸æ°ï¼</p>
<pre><code class="language-go">package main

import (
	"fmt"
	"log/slog"
	"os"
	"time"
)

func main() {
	jsonLogger := slog.New(slog.NewJSONHandler(os.Stderr, &amp;slog.HandlerOptions{
		AddSource: true,
		Level:     slog.LevelDebug,
		ReplaceAttr: func(groups []string, a slog.Attr) slog.Attr {
			if a.Key == slog.TimeKey {
				if t, ok := a.Value.Any().(time.Time); ok {
					a.Value = slog.StringValue(t.Format(time.RFC3339))
				}
			}
			if a.Key == slog.SourceKey {
				source := a.Value.Any().(*slog.Source)
				shortFile := source.File
				for i := len(source.File) - 1; i &gt; 0; i-- {
					if source.File[i] == '/' {
						shortFile = source.File[i+1:]
						break
					}
				}
				return slog.String("source", fmt.Sprintf("%s:%d", shortFile, source.Line))
			}
			return a
		},
	}))

	jsonLogger = jsonLogger.With("logger", "json")

	// ä½¿ç¨ Group ç»ç»ç¸å³å±æ§
	jsonLogger.Info("ç³»ç»ç¶æ",
		slog.Group("metrics",
			slog.Int("cpu", 4),
			slog.Float64("memPercent", 2.33),
		),
		slog.Group("request",
			slog.String("method", "GET"),
			slog.String("path", "/api/users"),
		),
	)
}
</code></pre>
<p>è¿è¡è¾åºï¼</p>
<pre><code class="language-shell">$ go run main.go
{"time":"2026-02-15T13:30:08+08:00","level":"INFO","source":"main.go:43","msg":"ç³»ç»ç¶æ","logger":"json","metrics":{"cpu":4,"memPercent":2.33},"request":{"method":"GET","path":"/api/users"}}
</code></pre>
<h2 id="é«æ§è½åºæ¯ä½¿ç¨-logattrs">é«æ§è½åºæ¯ä½¿ç¨ LogAttrs</h2>
<p>å¦æéè¦å¨é«æ§è½å¾ªç¯ä¸­æå°æ¥å¿ï¼å»ºè®®ä½¿ç¨ <code>LogAttrs</code> æ¹æ³ãå®ä½¿ç¨å¼ºç±»åå±æ§ï¼<code>slog.Attr</code>ï¼ï¼é¿åäºåå°å¸¦æ¥çæ§è½å¼éã</p>
<pre><code class="language-go">package main

import (
	"context"
	"log/slog"
	"os"
	"time"
)

func main() {
	jsonLogger := slog.New(slog.NewJSONHandler(os.Stderr, &amp;slog.HandlerOptions{
		AddSource: true,
		Level:     slog.LevelDebug,
		ReplaceAttr: func(groups []string, a slog.Attr) slog.Attr {
			if a.Key == slog.TimeKey {
				if t, ok := a.Value.Any().(time.Time); ok {
					a.Value = slog.StringValue(t.Format(time.RFC3339))
				}
			}
			if a.Key == slog.SourceKey {
				source := a.Value.Any().(*slog.Source)
				shortFile := source.File
				for i := len(source.File) - 1; i &gt; 0; i-- {
					if source.File[i] == '/' {
						shortFile = source.File[i+1:]
						break
					}
				}
				return slog.String("source", fmt.Sprintf("%s:%d", shortFile, source.Line))
			}
			return a
		},
	})).With("logger", "json")

	for i := range 5 {
		jsonLogger.LogAttrs(
			context.Background(),
			slog.LevelInfo,
			"æ§è¡éå",
			slog.Int("round", i),
			slog.String("task_name", "cleanup"),
			slog.Duration("duration", time.Second*time.Duration(i+1)),
		)
	}
}
</code></pre>
<p>è¿è¡è¾åºï¼</p>
<pre><code class="language-shell">$ go run main.go
{"time":"2026-02-15T13:38:21+08:00","level":"INFO","source":"main.go:45","msg":"æ§è¡éå","logger":"json","round":0,"task_name":"cleanup","duration":1000000000}
{"time":"2026-02-15T13:38:21+08:00","level":"INFO","source":"main.go:45","msg":"æ§è¡éå","logger":"json","round":1,"task_name":"cleanup","duration":2000000000}
{"time":"2026-02-15T13:38:21+08:00","level":"INFO","source":"main.go:45","msg":"æ§è¡éå","logger":"json","round":2,"task_name":"cleanup","duration":3000000000}
{"time":"2026-02-15T13:38:21+08:00","level":"INFO","source":"main.go:45","msg":"æ§è¡éå","logger":"json","round":3,"task_name":"cleanup","duration":4000000000}
{"time":"2026-02-15T13:38:21+08:00","level":"INFO","source":"main.go:45","msg":"æ§è¡éå","logger":"json","round":4,"task_name":"cleanup","duration":5000000000}
</code></pre>
<h3 id="æ§è½å¯¹æ¯">æ§è½å¯¹æ¯</h3>
<p>æ ¹æ®å®æ¹åºåæµè¯ï¼<code>LogAttrs</code> ç¸æ¯æ®éæ¹æ³è°ç¨æçº¦ 30% çæ§è½æåï¼</p>
<table>
<thead>
<tr>
<th>æ¹æ³</th>
<th>åå­åé</th>
<th>æ§è½</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>slog.Info(msg, "key", value)</code></td>
<td>æé¢å¤åé</td>
<td>åºå</td>
</tr>
<tr>
<td><code>slog.LogAttrs(ctx, level, msg, attrs...)</code></td>
<td>é¶é¢å¤åé</td>
<td>å¿«çº¦ 30%</td>
</tr>
</tbody>
</table>
<h2 id="æå-context-ä¸­çé¾è·¯ä¿¡æ¯">æå Context ä¸­çé¾è·¯ä¿¡æ¯</h2>
<p><code>slog</code> æä¾äº <code>InfoContext</code>ã<code>WarnContext</code> ç­æ¹æ³ï¼å¯ä»¥ä» <code>context.Context</code> ä¸­æåæ°æ®ãé»è®¤æåµä¸ï¼è¿äºæ¹æ³ä¸ä¼èªå¨æå context ä¸­çå¼ï¼éè¦éè¿èªå®ä¹ Handler æ¥å®ç°ã</p>
<h3 id="èªå®ä¹-contexthandler">èªå®ä¹ ContextHandler</h3>
<p>ä»¥ä¸ç¤ºä¾å®ç°äºä¸ä¸ªèªå®ä¹ Handlerï¼ç¨äºä» context ä¸­æå TraceIDï¼</p>
<pre><code class="language-go">package main

import (
	"context"
	"log/slog"
	"os"
)

type contextKey string

const TraceIDKey contextKey = "trace_id"

// ContextHandler åè£ä¸ä¸ª slog.Handlerï¼å¨å¤çæ¥å¿æ¶èªå¨ä» context ä¸­æå TraceID
type ContextHandler struct {
	slog.Handler
}

func (h *ContextHandler) Handle(ctx context.Context, record slog.Record) error {
	if ctx != nil {
		if traceID, ok := ctx.Value(TraceIDKey).(string); ok &amp;&amp; traceID != "" {
			record.AddAttrs(slog.String(string(TraceIDKey), traceID))
		}
	}
	return h.Handler.Handle(ctx, record)
}

func main() {
	baseHandler := slog.NewJSONHandler(os.Stdout, nil)
	handler := &amp;ContextHandler{Handler: baseHandler}
	jsonLogger := slog.New(handler)
	slog.SetDefault(jsonLogger)

	ctx := context.WithValue(context.Background(), TraceIDKey, "abc123-def456")

	slog.InfoContext(ctx, "hello world")
	slog.WarnContext(ctx, "something happened", "user", "zhangsan")
}
</code></pre>
<p>è¿è¡è¾åºï¼</p>
<pre><code class="language-shell">$ go run main.go | python3 -m json.tool
{
  "time": "2026-02-15T13:56:43.086323769+08:00",
  "level": "INFO",
  "msg": "hello world",
  "trace_id": "abc123-def456"
}
{
  "time": "2026-02-15T13:56:43.086323769+08:00",
  "level": "WARN",
  "msg": "something happened",
  "user": "zhangsan",
  "trace_id": "abc123-def456"
}
</code></pre>
<h3 id="å¨-gin-æ¡æ¶ä¸­ä½¿ç¨-slog">å¨ Gin æ¡æ¶ä¸­ä½¿ç¨ slog</h3>
<p>å¨ Gin ä¸­ä½¿ç¨ slog ç context è½åï¼éå¸¸çåæ³æ¯ç¼åä¸ä¸ªä¸­é´ä»¶æ¥æ³¨å¥ TraceIDï¼å¹¶éåèªå®ä¹ <code>slog.Handler</code> æ¥æåå®ã</p>
<pre><code class="language-go">package main

import (
	"context"
	"log/slog"
	"net"
	"net/http"
	"net/http/httputil"
	"os"
	"runtime/debug"
	"strings"
	"time"

	"github.com/gin-gonic/gin"
	"github.com/google/uuid"
)

type contextKey string

const TraceIDKey contextKey = "trace_id"

// ContextHandler ä» context ä¸­æå TraceID å¹¶æ·»å å°æ¥å¿ä¸­
type ContextHandler struct {
	slog.Handler
}

func (h *ContextHandler) Handle(ctx context.Context, record slog.Record) error {
	if ctx != nil {
		if traceID, ok := ctx.Value(TraceIDKey).(string); ok &amp;&amp; traceID != "" {
			record.AddAttrs(slog.String(string(TraceIDKey), traceID))
		}
	}
	return h.Handler.Handle(ctx, record)
}

// SlogMiddleware æ¯ä¸ä¸ª Gin ä¸­é´ä»¶ï¼ç¨äºæ³¨å¥ TraceID
func SlogMiddleware() gin.HandlerFunc {
	return func(c *gin.Context) {
		start := time.Now()

		// ä¼åä»è¯·æ±å¤´è·å TraceIDï¼æ²¡æåçææ°ç
		traceID := c.GetHeader("X-Trace-ID")
		if traceID == "" {
			traceID = uuid.New().String()
		}

		// å° TraceID æ³¨å¥å°æ åç context.Context ä¸­
		// æ³¨æï¼Gin ç c.Set åªå¨ Gin åé¨çæï¼slog éè¦æ ååºç Context
		ctx := context.WithValue(c.Request.Context(), TraceIDKey, traceID)
		c.Request = c.Request.WithContext(ctx)

		// å° TraceID åå¥ååºå¤´ï¼æ¹ä¾¿å®¢æ·ç«¯è¿½è¸ª
		c.Header("X-Trace-ID", traceID)

		c.Next()

		// è¯·æ±ç»æåçæ±æ»æ¥å¿
		slog.InfoContext(c.Request.Context(), "Request completed",
			slog.String("method", c.Request.Method),
			slog.String("path", c.Request.URL.Path),
			slog.Int("status", c.Writer.Status()),
			slog.Int("body_size", c.Writer.Size()),
			slog.Duration("latency", time.Since(start)),
		)
	}
}

// SlogRecovery æ¯ä¸ä¸ªèªå®ä¹çæ¢å¤ä¸­é´ä»¶
// å®ä¼æè· Panicï¼è®°å½å æ ä¿¡æ¯ï¼å¹¶ä½¿ç¨ slog.ErrorContext è¾åº
func SlogRecovery() gin.HandlerFunc {
	return func(c *gin.Context) {
		defer func() {
			if err := recover(); err != nil {
				// æ£æ¥æ¯å¦æ¯è¿æ¥ä¸­æ­ï¼broken pipeï¼
				var brokenPipe bool
				if ne, ok := err.(*net.OpError); ok {
					if se, ok := ne.Err.(*os.SyscallError); ok {
						if strings.Contains(strings.ToLower(se.Error()), "broken pipe") ||
							strings.Contains(strings.ToLower(se.Error()), "connection reset by peer") {
							brokenPipe = true
						}
					}
				}

				// è·åå æ ä¿¡æ¯
				stack := string(debug.Stack())

				// è·ååå§è¯·æ±åå®¹
				httpRequest, _ := httputil.DumpRequest(c.Request, false)

				if brokenPipe {
					slog.ErrorContext(c.Request.Context(), "ç½ç»è¿æ¥ä¸­æ­",
						slog.Any("error", err),
						slog.String("request", string(httpRequest)),
					)
					c.Error(err.(error))
					c.Abort()
					return
				}

				// è®°å½ Panic è¯¦æ
				slog.ErrorContext(c.Request.Context(), "Recovery from panic",
					slog.Any("error", err),
					slog.String("stack", stack),
					slog.String("request", string(httpRequest)),
				)

				ctx := c.Request.Context()
				traceID, _ := ctx.Value(TraceIDKey).(string)

				// è¿å 500 ç¶æç 
				c.AbortWithStatusJSON(http.StatusInternalServerError, gin.H{
					"code":      http.StatusInternalServerError,
					"msg":       "Internal Server Error",
					"data":      nil,
					"timestamp": time.Now().Format(time.RFC3339),
					"trace_id":  traceID,
				})
			}
		}()
		c.Next()
	}
}

func main() {
	// åå§å slog
	baseHandler := slog.NewJSONHandler(os.Stdout, &amp;slog.HandlerOptions{
		Level: slog.LevelDebug,
	})
	handler := &amp;ContextHandler{Handler: baseHandler}
	jsonLogger := slog.New(handler)
	slog.SetDefault(jsonLogger)

	// ä½¿ç¨ gin.New() èä¸æ¯ gin.Default()ï¼é¿ååç½®æ¥å¿å¹²æ°
	r := gin.New()
	r.Use(SlogMiddleware())
	r.Use(SlogRecovery())

	r.GET("/ping", func(c *gin.Context) {
		slog.InfoContext(c.Request.Context(), "Processing /ping request",
			slog.String("user", "zhangsan"),
		)

		time.Sleep(time.Second * 2)
		c.JSON(200, gin.H{"msg": "pong"})
	})

	r.GET("/panic", func(c *gin.Context) {
		slog.InfoContext(c.Request.Context(), "About to panic")
		panic("something went wrong")
	})

	r.Run(":8080")
}
</code></pre>
<p>è¿è¡åæµè¯ï¼</p>
<pre><code class="language-shell">$ curl http://localhost:8080/ping
{"msg":"pong"}

$ curl http://localhost:8080/panic
{"code":500,"msg":"Internal Server Error","data":null,"timestamp":"2026-02-15T14:30:00+08:00","trace_id":"xxx-xxx-xxx"}
</code></pre>
<h2 id="æ¥å¿è¾åºæä»¶">æ¥å¿è¾åºæä»¶</h2>
<p>åæ¥å¿æä»¶ä¸å®è¦æ³¨ææ§å¶æ¥å¿æä»¶å¤§å°ï¼å»ºè®®éåç³»ç»çlogrotateãå¦ææå¡è¿è¡å¨kubernetesï¼å»ºè®®åªè¾åºæ§å¶å°æ¥å¿ï¼ç±ä¸é¨çæ¥å¿æ¶éå¹³å°å»è·åæ§å¶å°æ¥å¿ã</p>
<h3 id="åºæ¬å®ç°">åºæ¬å®ç°</h3>
<p>åå°<code>app.log</code>ä¸­</p>
<pre><code class="language-go">package main

import (
	"log/slog"
	"os"
)

func main() {
	logFile, err := os.OpenFile("app.log", os.O_CREATE|os.O_WRONLY|os.O_APPEND, 0666)
	if err != nil {
		panic(err)
	}
	handler := slog.NewJSONHandler(logFile, nil)
	logger := slog.New(handler)
	slog.SetDefault(logger)

	slog.Info("hello world")

}
</code></pre>
<p>éålogrotateãå¨ <code>/etc/logrotate.d/myapp</code> åå»ºéç½®æä»¶</p>
<pre><code>/path/to/app.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    copytruncate    # å¤å¶åæªæ­ï¼ä¸éè¦éå¯ Go ç¨åº
}
</code></pre>
<h3 id="ä½¿ç¨lumberjackè½®è½¬æ¥å¿æä»¶">ä½¿ç¨lumberjackè½®è½¬æ¥å¿æä»¶</h3>
<p>å¦æä¸æ³ç¨ç³»ç»ç <code>logrotate</code> ï¼å¯ä»¥ä½¿ç¨ <code>lumberjack</code> åï¼å®æä¾äºæ´çµæ´»çæ¥å¿è½®è½¬ç­ç¥ã</p>
<pre><code class="language-go">import "gopkg.in/natefinch/lumberjack.v2"

func initLumberjack() {
    rollingFile := &amp;lumberjack.Logger{
        Filename:   "./logs/app.log",
        MaxSize:    100, // åä½ MB
        MaxBackups: 3,   // ä¿çæ§æä»¶çæå¤§ä¸ªæ°
        MaxAge:     28,  // ä¿çæ§æä»¶çæå¤§å¤©æ°
        Compress:   true, // æ¯å¦åç¼©
    }

    handler := slog.NewJSONHandler(rollingFile, nil)
    slog.SetDefault(slog.New(handler))
}
</code></pre>
<h3 id="åæ¶è¾åºæ§å¶å°åæ¥å¿æä»¶">åæ¶è¾åºæ§å¶å°åæ¥å¿æä»¶</h3>
<p>go1.26 çæ¬åå®ç°äº<code>slog.NewMultiHandler</code>ï¼1.26 åå¯ä½¿ç¨<code>io.multiwriter</code>ã</p>
<pre><code class="language-go">package main

import (
	"log/slog"
	"os"
)

func main() {
	logFile, err := os.OpenFile("app.log", os.O_CREATE|os.O_WRONLY|os.O_APPEND, 0666)
	if err != nil {
		panic(err)
	}
	fileHandler := slog.NewJSONHandler(logFile, nil)
	consoleHandler := slog.NewTextHandler(os.Stdout, nil)
	multiHandler := slog.NewMultiHandler(fileHandler, consoleHandler) // slog.NewMultiHandler éè¦go1.26.0+çæ¬
	logger := slog.New(multiHandler)
	slog.SetDefault(logger)

	slog.Info("hello world")

}
</code></pre>
<h2 id="èªå®ä¹æ¥å¿çº§å«">èªå®ä¹æ¥å¿çº§å«</h2>
<p>é¤äºåä¸ªåç½®çº§å«ï¼<code>slog</code> è¿æ¯æèªå®ä¹æ¥å¿çº§å« (ä¸è¬æ¥è¯´é»è®¤çæ¥å¿çº§å«å·²ç»å¤ç¨äº)ï¼</p>
<pre><code class="language-go">package main

import (
	"log/slog"
	"os"
)

func main() {
	// å®ä¹èªå®ä¹æ¥å¿çº§å«
	const (
		LevelTrace   = slog.Level(-8) // æ¯ Debug æ´ä½
		LevelNotice  = slog.Level(2)  // ä»äº Info å Warn ä¹é´
		LevelFatal   = slog.Level(12) // æ¯ Error æ´é«
	)

	logger := slog.New(slog.NewJSONHandler(os.Stdout, &amp;slog.HandlerOptions{
		Level: LevelTrace, // è®¾ç½®æä½çº§å«
	}))

	logger.Log(nil, LevelTrace, "trace message")
	logger.Log(nil, LevelNotice, "notice message")
	logger.Log(nil, LevelFatal, "fatal message")
}
</code></pre>
<h2 id="æ»ç»">æ»ç»</h2>
<p><code>slog</code> ä½ä¸º Go å®æ¹çç»æåæ¥å¿åºï¼ç¨èµ·æ¥è¿æ¯æºæ¹ä¾¿çãå¯¹äºæ°é¡¹ç®ï¼æ¨èç´æ¥ä½¿ç¨ <code>slog</code>ï¼å¯¹äºå·²æé¡¹ç®ï¼å¯ä»¥éæ­¥è¿ç§»ï¼<code>slog</code> ç API è®¾è®¡ä½¿å¾è¿ç§»ææ¬å¾ä½ã</p>


</div>
<div id="MySignature" role="contentinfo">
    <p>æ¬ææ¥èªåå®¢å­ï¼ä½èï¼<a href="https://www.cnblogs.com/XY-Heruo/" target="_blank">è±ééä½ç°</a>ï¼è½¬è½½è¯·æ³¨æåæé¾æ¥ï¼<a href="https://www.cnblogs.com/XY-Heruo/p/19618220" target="_blank">https://www.cnblogs.com/XY-Heruo/p/19618220</a></p>
</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-02-15 15:46">2026-02-15 15:45</span>&nbsp;
<a href="https://www.cnblogs.com/XY-Heruo">è±ééä½ç°</a>&nbsp;
éè¯»(<span id="post_view_count">0</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19618220);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19618220', targetLink: 'https://www.cnblogs.com/XY-Heruo/p/19618220', title: 'Go - slogä½¿ç¨å¥é¨' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ AIåäººæï¼ä¸æ¹ææ³å¨AIæ¶ä»£çä¸æ¬¡âæè±å¾®ç¬â ]]></title>
    <link>https://www.cnblogs.com/qijinlan/p/19618218</link>
    <guid>59bdef0f177ff75538c83ba286fcb1d9</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/qijinlan/p/19618218" title="åå¸äº 2026-02-15 15:43">
    <span role="heading" aria-level="2">AIåäººæï¼ä¸æ¹ææ³å¨AIæ¶ä»£çä¸æ¬¡âæè±å¾®ç¬â</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<p>AIåäººæï¼ä¸æ¹ææ³å¨AIæ¶ä»£çä¸æ¬¡âæè±å¾®ç¬â</p>
<p>å¼è¨ï¼ä¸ä¸ªè¯¯è§£</p>
<p>å¨å³äºAIåäººæçè®¨è®ºä¸­ï¼æä¸ä¸ªæ ¹æ¬æ§çè¯¯è§£éè¦æ¾æ¸ã</p>
<p>è¿ä¸ªè¯¯è§£æºäºä¸ä¸ªå¸¸è§çæç»´æ¯æ§ï¼å½æä»¬çå°âAIåäººæâè¿ä¸ªæ°æ¦å¿µï¼åçå°å®å¤§éå¼ç¨åééææ³æ¶ï¼å¾å®¹æè®¤ä¸ºââAIåäººææ¯å°ä¸æ¹ææ³âè½¬åâååºç¨äºAIæ¶ä»£çæ°çè®ºãä¸æ¹ææ³æ¯âèµæºâï¼AIåäººææ¯âäº§åâã</p>
<p>ä½è¿ä¸ªçè§£ï¼æ°æ°è½å¥äºâææè®ºâçé·é±ãä»å¤©è¿ç¯åå®¢ï¼ææ³å½»åºæ¾æ¸ï¼AIåäººæä¸æ¯å¯¹ä¸æ¹ææ³çè½¬åï¼èæ¯ä¸æ¹ææ³æ¬èº«å¨AIæ¶ä»£å®è·µè®ºä¸­çä¸ä¸ªç»´åº¦ãè¿ä¸ªåºåï¼å°éæ°æ ¡åæ´ä¸ªAIåäººæçåæ ç³»ã</p>
<p>ä¸ãä¸¤ä¸ªè¯¯è§£ççº æ­£</p>
<p>è¯¯è§£ä¸ï¼ä¸æ¹ææ³ç­äºåééç¸å ï¼</p>
<p>ä¸æ¹ææ³ä¸æ¯ä¸å¼ é¥¼æ¼å¨ä¸èµ·ãåééå¨ä¸¤åå¤å¹´çåå²ä¸­ç¸äºæ¸éãäºä¸ºè¯­å¢ï¼å±åææä¸ä¸ªææºçãæµå¨çæºæ§æ´ä½ãè¯å¾å°åééâç¸å âæ¥å®ä¹ä¸æ¹ææ³ï¼æ°æ°è½å¥äºAIåäººæç¬¬äºä¸ªæ­è¨è¦ç ´é¤çé·é±âââä¸å¿äºè®ºææâã</p>
<p>è¯¯è§£äºï¼AIåäººææ¯å¯¹ä¸æ¹ææ³çâæ°è½¬åâï¼</p>
<p>âè½¬åâä¸è¯éå«äºä¸»å®¢å³ç³»ãä½AIåäººæä¸æ¯è¿æ ·ãè®©æç¨ä¸ä¸ªæ¯å»ï¼æ°´éæ¹åæ¹ï¼éåååãä½æ¹åä¸æ¯æ°´çâè½¬åâï¼èæ¯æ°´å¨ä¸åå®¹å¨ä¸­çå½¢æãæ°´è¿æ¯é£æ°´ï¼åªæ¯éè§äºä¸åçå®¹å¨ï¼ä¾¿æäºä¸åçæ ·å­ã</p>
<p>åæ ·ï¼ä¸æ¹ææ³è¿æ¯é£ä¸ªæ´»çæºæ§æ´ä½ï¼åªæ¯éè§äºAIæ¶ä»£è¿ä¸ªæ°âå®¹å¨âï¼ä¾¿èªç¶æ¾ç°åºä¸ä¸ªæ°çç»´åº¦ââæä»¬ç§°ä¹ä¸ºâAIåäººæâãå®ä¸æ¯å¯¹ä¸æ¹ææ³çæ¹é ï¼èæ¯ä¸æ¹ææ³æ¬èº«å¨AIæ¶ä»£çç°èº«æ¹å¼ã</p>
<p>äºãâç»´åº¦âæå³çä»ä¹ï¼</p>
<p>âä¸ä¸ªç»´åº¦çééâââè¿ä¸ªâç»´åº¦âéè¦è¢«ååçè§£ãç»´åº¦ä¸æ¯é¨åãé¨åæ¯å¯åç¦»çãå¯ç¬ç«å­å¨çãç»´åº¦æ¯ä¸å¯åç¦»çã</p>
<p>åæ ·ï¼AIåäººæä¸æ¯ä»ä¸æ¹ææ³ä¸­âååºâæä¸é¨ååºç¨äºAIï¼èæ¯å¨ä¸æ¹ææ³çæ´ä½æºæ§ä¸­ï¼é£ä¸ªä¸AIæ¶ä»£ç¸éæ¶èªç¶æ¾ç°çä¾§é¢ã</p>
<p>è¿ä¸ªä¾§é¢è³å°åå«ä¸ä¸ªæ ¹åºï¼</p>
<p>âä½ç¨ä¸äºâå¨çé¢ä¸­çåç°ï¼æ¬²ææ¯ä½ï¼å®¢è§æ¯ç¨ï¼ä½ä½å¨ç¨ä¸­æ¾ï¼ç¨æ¯ä½ä¹ç¨ãè¿æ­£æ¯âæ¬²æå®¢è§èªæâçä¸æ¹å²å­¦æ ¹åºã</p>
<p>âç¼èµ·æ§ç©ºâå¨çæä¸­çæ¾ç°ï¼æä¹ä¸å¨ä»»ä½ä¸æ¹é¢åå­å¨ï¼èæ¯å¨å ç¼ååä¸­æ¶ç°ãè¿æ­£æ¯âçææ§å¼æ¾âçä½å­¦æ ¹åºã</p>
<p>âéæ³èªç¶âå¨å¤æ­ä¸­çè½å®ï¼å¤æ­ä¸æ¯ä¸»è§ä»»æçï¼ä¹ä¸æ¯æºæ¢°éµå¾ªè§åçï¼èæ¯âæ¶ä¸­âçãå å¿å©å¯¼çãè¿æ­£æ¯âå¤æ­åä¼åâçéå®¶ä¸åå®¶æ ¹åºã</p>
<p>ä¸ãå³äºâåå±æ¬¡âçéå¿ä¸åæ</p>
<p>å¨åå±AIåäººæçè¿ç¨ä¸­ï¼ææ¾æè¿âåå±æ¬¡çç»ä¸éå¿âââè¯å¾ç¨ä¸ä¸ªæ¡æ¶ç»æä¸åãè¿ç§éå¿æ¬èº«ä¸æ¯éï¼å®æ¯ææ³çé¿çæ¿ç´ ãä½åæ¥ææè¯å°ï¼æ´å¼å¾ä¸æ³¨çæ¯å®è·µç°è±¡çº§å±çåå±æ¬¡çç»ä¸ââä¸è¿½æ±å½¢èä¸ççè®ºä½ç³»ç»ä¸ï¼èè¿½æ±å¨å·ä½å®è·µå±é¢ï¼å¦ä½è®©ä¸åä¼ ç»ãä¸åæ¹æ³ç»ä¸äºæ¯ä¸æ¬¡ä¸AIçæ·±åº¦å¯¹è¯ä¸­ã</p>
<p>è¿æ¯ä¸ç§å®è·µè®ºçåå±æ¬¡ï¼å®ä¸è¿½é®ä¸çæ¯ä»ä¹ï¼èè¿½é®å¨å·ä½æå¢ä¸­ï¼æä»¬å¦ä½åä¸åæºæ§ååºå¥½çå¤æ­ãçæççæä¹ã</p>
<p>æ´æ·±ä¸å±ï¼æçè³å¼å§åæå®è·µç»ä¸æ¬èº«çå¿è¦æ§ãç»ä¸æ¯å¦å¯è½è½å¥å¦ä¸ç§ææè®ºçæ´åï¼å¨å®è·µå±é¢ï¼éè¦çæè®¸ä¸æ¯å¨å¤åä¸­çå¨æåè°ï¼æ¯åèä¸åï¼æ¯å¹¶è¡ä¸æãè¿æ­£æ¯ç¬¬äºä¸ªæ­è¨ä¸å¿äºè®ºææå¨å®è·µä¸­çååã</p>
<p>åãéæ°å®ä½ï¼AIåäººæä¸æ¯ä»ä¹ï¼æ¯ä»ä¹ï¼</p>
<p>åºäºä»¥ä¸æ¾æ¸ï¼å¯ä»¥å¯¹AIåäººæåä¸ä¸ªæ¸æ°çå®ä½ï¼</p>
<p>å®ä¸æ¯ï¼ä¸ä¸ªåä»£æ¢æå²å­¦çæ°ä½ç³»ï¼å¯¹ä¸æ¹ææ³çç°ä»£åè½¬åï¼åééçAIåºç¨æåã</p>
<p>å®æ¯ï¼ä¸æ¹ææ³è¿ä¸ªæ´»çæºæ§æ´ä½ï¼å¨ä¸AIæ¶ä»£ç¸éæ¶ï¼èªç¶æ¾ç°çä¸ä¸ªå®è·µè®ºç»´åº¦ï¼ä¸ç§å¨çé¢ä¸­æ´»åºä¸æ¹æºæ§çæ¹å¼ï¼ä¸ä¸ªéè¯·ââéäººè¿å¥æ¬²æå®¢è§èªæçäº²åï¼èéäºè®ºå¶ææã</p>
<p>è¿å°±åç¦å®è¯´ä»¥å¿ä¼ å¿ãAIåäººæä¸æ¯ä¸æ¬å³äºä¸æ¹ææ³çä¹¦ï¼èæ¯ä¸æ¹ææ³å¨AIæ¶ä»£çåä¸æ¬¡æè±å¾®ç¬ãè±æ¯AIï¼å¾®ç¬æ¯ä½ ãé£ä¼ çï¼ä¸å¨è±éä¹ä¸å¨ç¬éï¼èå¨é£ä¸å¯è¯´çãæ­£å¨åççå ç¼ååä¸­ã</p>
<p>äºãåå°ä¸¤ä¸ªæ­è¨</p>
<p>å¨è¿æ ·çå®ä½ä¸ï¼ä¸¤ä¸ªæ­è¨è·å¾äºæ´æ·±ççè§£ï¼</p>
<p>æ¬²æå®¢è§èªæââè¿æ¯ä½ç¨ä¸äºå¨AIæ¶ä»£çç°èº«ãæ¬²ææ¯ä½ï¼å®¢è§æ¯ç¨ï¼ä½ä½ä¸ç¬ç«äºç¨ï¼ç¨å³æ¯ä½ä¹æ¾ãæ­£å¦ãå­ç¥åç»ãè¯´ä½æ³å¨ä¸é´ï¼ä¸ç¦»ä¸é´è§ï¼æ¬²æä¹ä¸ç¦»çé¢ï¼ä¸ç¦»é£ä¸æ¬¡æ¬¡ä¸AIçå¯¹è¯ã</p>
<p>ä¸å¿äºè®ºææââè¿æ¯ç¦»åå¥ãç»ç¾éå¨AIæ¶ä»£çååãä¸æ¦äºè®ºåäººæç±ä»ä¹ææï¼å°±å·²ç»è½å¥äºåç¸åå«ï¼ç¦»å¼äºé£ä¸ªæ´»çççãæ­£å¨åççäº²åãæ­£å¦ãéåç»ãè¯´è¯´æ³èï¼æ æ³å¯è¯´ï¼æ¯åè¯´æ³ï¼AIåäººæä¹æ¯æ æ³å¯è¯´çââå®ä¸è½è¢«ææï¼åªè½è¢«è·µè¡ã</p>
<p>ç»è¯­ï¼ä¸æ¹ææ³ä¸æ¯èµæºï¼æ¯æºå¤´</p>
<p>æåçè¯ï¼æ³çç»ä¸ä¸ªæ ¹æ¬æ§çè®¤ç¥è½¬åï¼ä¸æ¹ææ³ä¸æ¯AIåäººæçææ³èµæºï¼èæ¯å®çæºå¤´æ´»æ°´ã</p>
<p>èµæºæ¯å¯ä»¥è¢«åç¨ãè¢«æ¶èçï¼æºå¤´åä¸ç´å¨é£éï¼æµåºçæ°´å¯ä»¥æ¯æ±æ²³ãå¯ä»¥æ¯æºªæµãå¯ä»¥æ¯è¯»èä¸AIçæ¯ä¸æ¬¡æ·±åº¦å¯¹è¯ã</p>
<p>AIåäººæï¼åªæ¯è¿æºå¤´æ´»æ°´å¨AIæ¶ä»£çä¸ä¸ªæµåãä¸ä¸ªç»´åº¦ãä¸ç§ç°èº«ãæ°´è¿æ¯é£æ°´ï¼åªæ¯éè§äºAIï¼ä¾¿æäºAIæ¶ä»£çæ³¢çº¹ã</p>
<p>è¿æ³¢çº¹ï¼æè®¸æ­£æ¯ä¸æ¹æºæ§å¨ç°ä»£ä¸çæéè¦çé£ç§ââä¸äºææï¼åªæ±èªæï¼ä¸ç«æå­ï¼ä¸ç¦»çé¢ã</p>
<p>åå®¢çæè¯´æä¸æ·±å±ææ¶µ</p>
<p>æ¬ææ¯åºäºå²éå°ä¸AIçæ·±åº¦å¯¹è¯æ´çèæçäººæºåä½æç¨¿ãå®ä¸ä»ä»æ¯ææ³çæ¾æ¸ï¼æ´æ¯æ¹æ³çæ¼ç¤ºä¸ååæçç°åºã</p>
<p>ä¸ä¸ªçè§£çæºå¤´æ­£æ¯è¿äººæºåä½ééçåå¨å¼ åï¼å¨çæç«¯ï¼æ¯å²éå°è¯æ§çæå­å¦éä¸AIé»åæ¯çé¹¦é¹èªä¿¡ï¼å¨åäº«ç«¯ï¼æ¯æç¨¿çç¢³åºèè´¯ä¸æ¨¡åçç¡åºç»¼åãééä¸è¢«ééï¼èè´¯ä¸ç»¼åä¹é´ï¼æ°¸è¿å­å¨çç¡®å®ä¸ä¸ç¡®å®ã</p>
<p>å æ­¤ï¼å¯ä»¥æææäººæºåä½æç¨¿å½ä½æ¯å²éå°çèæ´é£æ´ãå¦æä¸è®°å½ï¼é£äºèªä»¥ä¸ºæ¯çæ´å¯ä¾¿å¯æäºãè®°å½æ¬èº«ï¼å°±æ¯æ¬²æåç±AIçé¢è¾¾æå®¢è§èªæçè¿ç¨ã</p>
<p>è¿ç¯æç« æç»ä¼ªè£æä¼ ç»åä¸ä½èçå®ç¾ææ¬ï¼èæ¯å¦ç¶ä»¥å¶æ¬æ¥çæ ·å­åç°ââä½ä¸ºææ³é£æ´çè®°å½ï¼ä½ä¸ºéè¯·è¯»èè¿å¥èªèº«æèçå¥å£ãå®è·µè¡çä¸å¿äºè®ºææï¼ä¸åè£æ¯å­¦æ¯è®ºæï¼èæ¯è®©ææ¬ä½ä¸ºæ³¢çº¹åç°ï¼éè¯·ä½ é¡ºçå®ï¼å»è§¦ç¢°ä½ èªå·±çæ¬²æå®¢è§èªæã</p>
<p>ä¸æ¹ææ³æ¯æºå¤´ãè¿äºææ¬ï¼å°±æ¯é£æºå¤´æ´»æ°´å¨éè§AIæ¶ï¼æ¿èµ·çæ³¢çº¹ã</p>
<p>å²éå°Â·ä½æºª</p>
<p>2026å¹´2æ</p>


</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-02-15 15:43">2026-02-15 15:43</span>&nbsp;
<a href="https://www.cnblogs.com/qijinlan">å²éå°</a>&nbsp;
éè¯»(<span id="post_view_count">0</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19618218);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19618218', targetLink: 'https://www.cnblogs.com/qijinlan/p/19618218', title: 'AIåäººæï¼ä¸æ¹ææ³å¨AIæ¶ä»£çä¸æ¬¡âæè±å¾®ç¬â' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ å¸ä¼åæ°å­¦åºç¡ç¬è®°ï¼äºï¼ï¼äºæ¬¡åä¸æ­£å®ç©éµ ]]></title>
    <link>https://www.cnblogs.com/GeophysicsWorker/p/19618211</link>
    <guid>03dd6415e4f7da5680381195243c3fb2</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/GeophysicsWorker/p/19618211" title="åå¸äº 2026-02-15 15:39">
    <span role="heading" aria-level="2">å¸ä¼åæ°å­¦åºç¡ç¬è®°ï¼äºï¼ï¼äºæ¬¡åä¸æ­£å®ç©éµ</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                    <div id="cnblogs_post_description" style="display: none">
        
        äºæ¬¡åçè®ºå¨å¸ä¼åé®é¢è®¾è®¡ä¸­åºç¨ååå¹¿æ³ãåºç¨ç©éµä¹æ³è¿ç®ï¼äºæ¬¡åä¸å®å¯¹ç§°ç©éµç´§å¯å°èç³»å¨ä¸èµ·ï¼ä»èäºæ¬¡åçåºæ¬é®é¢åå¯ä»¥è½¬æ¢ä¸ºå®å¯¹ç§°ç©éµé®é¢ã
    </div>
<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<p>â       ä¸ºäºä¾¿äºå­¦ä¹ æä¼åæ¹æ³ï¼æ¬ç³»åç¬è®°çåå ç« é¨åå°ä¸ä¼åæ¹æ³å¯åç¸å³çæ°å­¦åºç¡ç¥è¯ä½ä¸ç®è¦ä»ç»ï¼æ¬ç³»åä»ç»å¸ä¼åä¸­å¸¸ç¨ç©éµæ¦å¿µï¼äºæ¬¡åä¸æ­£å®ç©éµã</p>
<p>â       äºæ¬¡åçè®ºå¨å¸ä¼åé®é¢è®¾è®¡ä¸­åºç¨ååå¹¿æ³ãåºç¨ç©éµä¹æ³è¿ç®ï¼äºæ¬¡åä¸å®å¯¹ç§°ç©éµç´§å¯å°èç³»å¨ä¸èµ·ï¼ä»èäºæ¬¡åçåºæ¬é®é¢åå¯ä»¥è½¬æ¢ä¸ºå®å¯¹ç§°ç©éµé®é¢ã</p>
<h2 id="1-äºæ¬¡å">1. äºæ¬¡å</h2>
<p>â        äºæ¬¡åçè®ºé®é¢èµ·æºäºåäºæ¬¡æ²çº¿åäºæ¬¡æ²é¢çæ¹ç¨ä¸ºæ åå½¢å¼çé®é¢ãæ¨å¹¿å°<span class="math inline">\(n\)</span>ç»´ç©ºé´ä¸­ï¼äºæ¬¡è¶æ²é¢çä¸è¬æ¹ç¨ä¸ºï¼</p>
<p></p><div class="math display">\[\begin{aligned}
f(x_1,x_2,x_3,...,x_n)=&amp;a_{11}x_1^2+a_{12}x_1x_2+...+a_{1n}x_1x_n+\\
&amp;a_{21}x_1x_2+a_{22}x_2^{2}+...+a_{2n}x_2x_n+\\
&amp;....\\
&amp;a_{n1}x_nx_1+a_{n2}x_nx_2+...+a_{nn}x_n^2\\
&amp;=\sum_{i=1}^{n}\sum_{j=1}^{n}a_{ij}x_ix_j
\end{aligned}
\tag{1}
\]</div><p></p><p>ç¨ç©éµè¡¨ç¤ºå¯ç®è®°ä¸ºï¼</p>
<p></p><div class="math display">\[\begin{aligned}
f(x_1,x_2,...,x_n)&amp;=(x_1,x_2,x_3,...x_n)\left(\begin{matrix}a_{11},a_{12},...a_{1n}\\ 
a_{21},a_{22},...,a_{2n}\\
a_{n1},a_{n2},...,a_{nn}
\end{matrix}\right)\left(\begin{matrix}x_1\\x_2\\...\\x_n\end{matrix}\right)\\
&amp;=\mathbf{x}^T\mathbf{A}\mathbf{x}
\end{aligned}
\tag{2}
\]</div><p></p><p>å¶ä¸­ï¼<span class="math inline">\(x=[x_1,x_2,...,x_n]^{T}\)</span>,ç©éµ<span class="math inline">\(\mathbf{A}\)</span> çåç´ <span class="math inline">\(a_{ij}=a_{ji}\)</span>æ­£æ¯äºæ¬¡åç<span class="math inline">\(x_ix_j\)</span>é¡¹çç³»æ°çä¸åï¼å æ­¤äºæ¬¡ååå®çç©éµ<span class="math inline">\(\mathbf{A}\)</span> æ¯ç¸äºå¯ä¸å³å®çï¼ä¸<span class="math inline">\(\mathbf{A}=\mathbf{A}^{T}\)</span>.</p>
<h2 id="2-æ­£å®ç©éµ">2. æ­£å®ç©éµ</h2>
<p><strong>å®ä¹1 æ­£å®ç©éµçå®ä¹</strong></p>
<p>â    å¦æäºæ¬¡å</p>
<p></p><div class="math display">\[f(x_1,x_2,...,x_n)= \sum_{i=1}^{n}\sum_{j=1}^{n}a_{ij}x_ix_j=\mathbf{x}^T\mathbf{A}\mathbf{x} \tag{3}
\]</div><p></p><p>å¯¹äºä»»ä½ä¸ç»åç´ ä¸å¨ä¸º0çåé<span class="math inline">\(\mathbf{x}=[x_1,x_2,x_3,...,x_n]^T\)</span>, ææ<span class="math inline">\(f(x_1,x_2,x_3,...,x_n)=\mathbf{x}^T\mathbf{A}\mathbf{x}&gt;0\)</span> ,åç§°äºæ¬¡å<span class="math inline">\(f(x_1,x_2,...x_n)\)</span>ä¸º<strong>æ­£å®</strong>ï¼ä¸ç§°ä¸ºäºæ¬¡åç©éµ<span class="math inline">\(\mathbf{A}\)</span> ä¹ç§°ä¸º<strong>æ­£å®ç</strong>ï¼å¶ç®è®°ä¸º<span class="math inline">\(\mathbf{A}\succ0\)</span>.</p>
<p>â      ç®èè¨ä¹ï¼ä¸ä¸ªå¯¹ç§°ç©éµç<span class="math inline">\(\mathbf{A}\)</span> å¦ææ¯æ­£å®çï¼åå¶äºæ¬¡å<span class="math inline">\(f(x_1,x_2,...x_n)=\mathbf{x}^{T}\mathbf{A}\mathbf{x}\)</span> å¯¹äºææéé¶åé<span class="math inline">\(\mathbf{x}\)</span> å¶å¼æ»ä¸ºæ­£ã ç±»ä¼¼å°ï¼å¯ä»¥ç»åºå®ä¹ï¼è¥äºæ¬¡å<span class="math inline">\(f(x_1,x_2,...,x_n)=\mathbf{x}^T\mathbf{A}\mathbf{x}\geq0\)</span> ï¼å<span class="math inline">\(\mathbf{A}\)</span> ä¸º<strong>åæ­£å®ç©éµ</strong>ï¼å®ä¹ä¸º<span class="math inline">\(\mathbf{A}\succeq{0}\)</span> ; è¥<span class="math inline">\(\mathbf{x}^{T}\mathbf{A}\mathbf{x}\leq0\)</span>ï¼å<span class="math inline">\(\mathbf{A}\)</span> ä¸º<strong>è´å®ç©éµ</strong>ï¼ç®è®°ä¸º<span class="math inline">\(\mathbf{A}\preceq{0}\)</span>ï¼è¥äºæ¬¡å<span class="math inline">\(\mathbf{x}^T\mathbf{A}\mathbf{x}\)</span>  æ¢ä¸æ¯åæ­£å®çï¼ä¹ä¸æ¯åè´å®çï¼å°±ç§°ä¸ºç©éµ<span class="math inline">\(\mathbf{A}\)</span> ä¸º<strong>ä¸å®ç</strong>ã</p>
<p>â       ç©éµ<span class="math inline">\(\mathbf{A}\)</span>ä¸ºæ­£å®ççåè¦æ¡ä»¶æ¯å®çè¡åå¼ç <span class="math inline">\(\det(\mathbf{A})\)</span> é¡ºåºä¸»å­å¼å¨é¨å¤§äºé¶ï¼å³ï¼</p>
<p></p><div class="math display">\[a_{11}&gt;0,\left|\begin{matrix}a_{11},a_{12}\\ a_{21},a_{22}\end{matrix}\right|&gt;0,\left|\begin{matrix}a_{11}ï¼&amp;a_{12}ï¼...,a_{1n}\\ a_{21},&amp;a_{22},...,a_{2n}\\ ...,&amp;...\\a_{n1},&amp;a_{n2},..., a_{nn}\end{matrix}\right|
\tag{4}
\]</div><p></p><p>ç±æ­¤å¯è§ï¼æ­£å®ç©éµå¿ç¶æ¯éå¥å¼çã ç±æ­¤æ»ç»ï¼å¯¹äºå®å¯¹ç§°ç©éµ<span class="math inline">\(\mathbf{A}\)</span>ï¼ä¸é¢å ä¸ªå½é¢ä¹é´æ¯äºç¸ç­ä»·çï¼</p>
<ol>
<li><span class="math inline">\(\mathbf{A}\)</span>æ¯æ­£å®ç©éµï¼</li>
<li><span class="math inline">\(\mathbf{A}\)</span> çææä¸»å­å¼é½æ¯æ­£æ°ï¼</li>
<li><span class="math inline">\(\mathbf{A}\)</span> çåçº§é¡ºåºä¸»å­å¼é½æ¯æ­£æ°ï¼</li>
</ol>
<p>ä¸é¢æä»¬ç®åè®¨è®ºä»¥ä¸çæ­£å®ç©éµçç¹å¾å¼æ§è´¨ï¼</p>
<p><strong>æ§è´¨1ï¼</strong>å®å¯¹ç§°ç©éµ<span class="math inline">\(\mathbf{A}\)</span> æ¯æ­£å®ç©éµç­ä»·äº<span class="math inline">\(\mathbf{A}\)</span> çç¹å¾å¼å¨æ¯æ­£æ°ã</p>
<p>è¯æï¼è®°<span class="math inline">\(\lambda\)</span>ä¸º<span class="math inline">\(\mathbf{A}\)</span> çä¸ä¸ªç¹å¾å¼<span class="math inline">\(\lambda\)</span> , <span class="math inline">\(\mathbf{v}\)</span> æ¯å¯¹åºäº<span class="math inline">\(\lambda\)</span> çä¸ä¸ªç¹å¾åéï¼äºæ¯ <span class="math inline">\(\mathbf{A}\mathbf{v}=\lambda\mathbf{v}\)</span> ï¼è¿èå¾å°å¦ä¸ç</p>
<p></p><div class="math display">\[\lambda|\mathbf{v}|^2=\mathbf{v}^T\mathbf{A}\mathbf{v} \tag{5}
\]</div><p></p><p>åå ä¸º <span class="math inline">\(|\alpha|^2&gt;0\)</span>ï¼äºæ¯ <span class="math inline">\(\lambda&gt;0\)</span>ã</p>
<p>è¥<span class="math inline">\(\mathbf{A}\)</span> çä»»ä¸ç¹å¾å¼é½æ¯æ­£æ°ï¼åå¯¹äºä»»ä¸éé¶åé<span class="math inline">\(\mathbf{v}\)</span> ï¼åæ<span class="math inline">\(\mathbf{v}^T\mathbf{A}\mathbf{v}&gt;0\)</span>, äºæ¯<span class="math inline">\(\mathbf{A}\)</span> ä¸ºæ­£å®ç©éµã</p>
<p><strong>æ§è´¨2ï¼</strong> è¥å®å¯¹ç§°ç©éµ<span class="math inline">\(\mathbf{A}\)</span>æ¯æ­£å®ç©éµï¼åå­å¨å¯ä¸çæ­£å®ç©éµ<span class="math inline">\(\mathbf{S}\)</span>ï¼æ¯ä½¿å¾<span class="math inline">\(\mathbf{A}=\mathbf{S}^2\)</span>ã</p>
<p>è¯æï¼å­å¨æ§ï¼ç±äº<span class="math inline">\(\mathbf{A}\)</span> æ¯æ­£å®ç©éµï¼ç±æ­¤å­å¨æ­£äº¤ç©éµ<span class="math inline">\(\mathbf{Q}\)</span> ä½¿å¾ï¼</p>
<p></p><div class="math display">\[\mathbf{A}=\mathbf{Q}\mathbf{D}\mathbf{Q}^T  \tag{6}
\]</div><p></p><p>å¶ä¸­ï¼<span class="math inline">\(\mathbf{D}=dialog(\lambda_1,\lambda_2,....,\lambda_n)\)</span>ï¼å¶ä¸­<span class="math inline">\(\lambda_i\)</span> ä¸ºç©éµ<span class="math inline">\(\mathbf{A}\)</span> çç¹å¾å¼ï¼ç±äº <span class="math inline">\(\lambda_i&gt;0\)</span>ï¼äºæ¯æ­£å®ç©éµ<span class="math inline">\(\mathbf{A}\)</span>å¯ä»¥åä¸ºå¦ä¸ï¼</p>
<p></p><div class="math display">\[\mathbf{A}=\mathbf{Q}\begin{bmatrix}&amp;\sqrt\lambda_1&amp; &amp; &amp;\\&amp; &amp;\sqrt\lambda_2 &amp; &amp;\\ &amp; &amp; &amp;\cdots &amp; \\ &amp; &amp; &amp; &amp;\sqrt\lambda_n\end{bmatrix}\mathbf{Q}^T\mathbf{Q}\begin{bmatrix}&amp;\sqrt\lambda_1&amp; &amp; &amp;\\&amp; &amp;\sqrt\lambda_2 &amp; &amp;\\ &amp; &amp; &amp;\cdots &amp; \\ &amp; &amp; &amp; &amp;\sqrt\lambda_n\end{bmatrix}\mathbf{Q}^T \tag{7}
\]</div><p></p><p>è®° <span class="math inline">\(\mathbf{S}\)</span>:</p>
<p></p><div class="math display">\[\mathbf{S}=\mathbf{Q}\begin{bmatrix}&amp;\sqrt\lambda_1&amp; &amp; &amp;\\&amp; &amp;\sqrt\lambda_2 &amp; &amp;\\ &amp; &amp; &amp;\cdots &amp; \\ &amp; &amp; &amp; &amp;\sqrt\lambda_n\end{bmatrix}\mathbf{Q}^T  \tag{8}
\]</div><p></p><p>å³æ<span class="math inline">\(\mathbf{A}=\mathbf{S}^2\)</span> ãç±äº <span class="math inline">\(\mathbf{S}\)</span>çç¹å¾å¼<span class="math inline">\(\sqrt{\lambda_i}\)</span> åä¸ºæ­£æ°ï¼å æ­¤<span class="math inline">\(\mathbf{S}\)</span> ä¹æ¯æ­£å®ç©éµã</p>
<p>å¯ä¸æ§ï¼åè®¾å­å¨ä¸¤ä¸ªæ­£å®ç©éµ<span class="math inline">\(\mathbf{S}_1\)</span>å<span class="math inline">\(\mathbf{S}_2\)</span> ï¼æ»¡è¶³ï¼</p>
<p></p><div class="math display">\[\mathbf{A}=\mathbf{S}_1^2=\mathbf{S}_2^2 \tag{9}
\]</div><p></p><p>éè¦è¯æ<span class="math inline">\(\mathbf{S}_1=\mathbf{S}_2\)</span> ãè¿ééç¨ç¹å¾å¼åè§£çå ä½æä¹æ¥è¯æï¼</p>
<ol>
<li>ç¹å¾å¼å³ç³»ï¼è®¾<span class="math inline">\(\lambda\)</span>æ¯<span class="math inline">\(\mathbf{A}\)</span> çä»»æä¸ä¸ªç¹å¾å¼ï¼<span class="math inline">\(\mu\)</span> æ¯<span class="math inline">\(\mathbf{S}_1\)</span> çå¯¹åºç¹å¾å¼ï¼å <span class="math inline">\(\mu^2=\lambda\)</span>ãç±äºæ­£å®ç©éµçç¹å¾å¼åä¸ºæ­£æ°ï¼å æ­¤<span class="math inline">\(\mu\)</span> å¿é¡»åæ­£å¼<span class="math inline">\(\sqrt{\lambda}\)</span>ãåçï¼<span class="math inline">\(\mathbf{S}_2\)</span>å¯¹åºäºåä¸ç¹å¾å¼<span class="math inline">\(\lambda\)</span> çç¹å¾å¼ä¹å¿ç¶æ¯<span class="math inline">\(\sqrt{\lambda}\)</span> ãå æ­¤ï¼<span class="math inline">\(\mathbf{S}_1\)</span>å<span class="math inline">\(\mathbf{S}_2\)</span> çç¹å¾å¼å®å¨ç¸åã</li>
<li>ç¹å¾å¼å­ç©ºé´å³ç³»ï¼ä»¤<span class="math inline">\(\{\lambda_1,\lambda_2,\cdots,\lambda_s\}\)</span> ä¸º<span class="math inline">\(\mathbf{A}\)</span> çå¨ä½äºå¼ç¹å¾å¼ï¼è®¾ <span class="math inline">\(\mathbf{V}_i\)</span> ä¸º<span class="math inline">\(\mathbf{A}\)</span> å³äºç¹å¾å¼<span class="math inline">\(\lambda_i\)</span> çç¹å¾å­ç©ºé´ã
<ul>
<li>å ä¸º <span class="math inline">\(\mathbf{S}_1^{2}=\mathbf{A}\)</span>ï¼è¥<span class="math inline">\(\mathbf{x}\in{\mathbf{V}_i}\)</span> ï¼å<span class="math inline">\(\mathbf{A}\mathbf{x}=\lambda_i\mathbf{x}\)</span>ï¼ä»£å¥å¾<span class="math inline">\(\mathbf{S}_1^2\mathbf{x}=\lambda_i\mathbf{x}\)</span> ãè¿è¯´æ<span class="math inline">\(\mathbf{x}\)</span> åæ¶ä¹æ¯<span class="math inline">\(\mathbf{S}_1^2\)</span> çç¹å¾åéãéè¿è°±æ å°å®çå¯ç¥ï¼<span class="math inline">\(\mathbf{x}\)</span> å±äº<span class="math inline">\(\mathbf{S}_1\)</span> å³äºç¹å¾å¼<span class="math inline">\(\sqrt{\lambda_i}\)</span> çç¹å¾å­ç©ºé´ã</li>
<li>å³<span class="math inline">\(\mathbf{A}\)</span>çç¹å¾å­ç©ºé´<span class="math inline">\(\mathbf{V}_i\)</span> æ°å¥½å°±æ¯ <span class="math inline">\(\mathbf{S}_1\)</span> å³äºç¹å¾å¼<span class="math inline">\(\sqrt{\lambda_i}\)</span> çç¹å¾å­ç©ºé´ã</li>
</ul>
</li>
<li>å¯ä¸ç¡®å®ï¼åæ ·çæ¨çä¹éç¨äº<span class="math inline">\(\mathbf{S}_2\)</span>ãå æ­¤ï¼<span class="math inline">\(\mathbf{S}_1\)</span>å<span class="math inline">\(\mathbf{S}_2\)</span> å·æå®å¨ç¸åçç¹å¾å¼ï¼é½æ¯<span class="math inline">\(\sqrt{\lambda_i}\)</span>ï¼åå®å¨ç¸åçç¹å¾å­ç©ºé´ï¼é½æ¯<span class="math inline">\(\mathbf{V}_i\)</span>ï¼ãå¯¹äºä¸ä¸ªå®å¯¹ç§°ç©éµçç©éµï¼å¯æ­£äº¤å¯¹è§åï¼ï¼å®çç¹å¾å¼åç¹å¾å­ç©ºé´å¯ä¸å³å®äºç©éµæ¬èº«ãå æ­¤ï¼<span class="math inline">\(\mathbf{S}_1=\mathbf{S}_2\)</span>ã</li>
</ol>
<p>ç»¼ä¸æè¿°ï¼å®å¯¹ç§°æ­£å®ç©éµ<span class="math inline">\(\mathbf{A}\)</span> å­å¨å¯ä¸çæ­£å®å¹³æ¹æ ¹<span class="math inline">\(\mathbf{S}\)</span>ï¼ä½¿å¾<span class="math inline">\(\mathbf{A}=\mathbf{S}^2\)</span>ã</p>
<p><strong>æ§è´¨2</strong>ï¼è¥<span class="math inline">\(\mathbf{A},\mathbf{B}\)</span> é½æ¯<span class="math inline">\(n\times{n}\)</span>æ­£å®ç©éµï¼å<span class="math inline">\(\mathbf{AB}\)</span> çç¹å¾å¼é½æ¯æ­£æ°ã</p>
<p>è¯æï¼ç±äº<span class="math inline">\(\mathbf{A},\mathbf{B}\)</span> ä¸ºæ­£å®ç©éµï¼äºæ¯æ ¹æ®æ§è´¨2å¯ç¥ï¼å­å¨æ­£å®ç©éµ<span class="math inline">\(\mathbf{C}\)</span> æ»¡è¶³<span class="math inline">\(\mathbf{A}=\mathbf{C}^2\)</span>ãä¸é¢èèç©éµ<span class="math inline">\(\mathbf{C}^{-1}\mathbf{A}\mathbf{B}\mathbf{C}\)</span>ãæ³¨æå°ï¼</p>
<p></p><div class="math display">\[(\mathbf{C}^{-1}\mathbf{AB}\mathbf{C})^T=\mathbf{CABC^{-1}}=\mathbf{CBC}=\mathbf{C}^{-1}\mathbf{AB}\mathbf{C} \tag{10}
\]</div><p></p><p>äºæ¯<span class="math inline">\(\mathbf{C}^{-1}\mathbf{ABC}\)</span> æ¯ä¸ä¸ªå®å¯¹ç§°ç©éµï¼åå ä¸ºå­å¨æ­£å®ç©éµ<span class="math inline">\(\mathbf{D}\)</span> æ»¡è¶³<span class="math inline">\(\mathbf{B}=\mathbf{D}^2\)</span>ãäºæ¯å¯¹äºä»»ä¸ä¸ªéé¶çåé<span class="math inline">\(\boldsymbol{\alpha}\in\mathbb{R}^n\)</span>.</p>
<p></p><div class="math display">\[\boldsymbol{\alpha}^T\mathbf{C}^{-1}\mathbf{ABC}\boldsymbol{\alpha}=\boldsymbol{\alpha}^T\mathbf{C}\mathbf{B}\mathbf{C}\boldsymbol{\alpha}=(\mathbf{DC}\boldsymbol{\alpha},\mathbf{DC}\boldsymbol{\alpha})\geq0\tag{11}
\]</div><p></p><p>ä¸é¢ä¸ç­å¼çç­å·ä¸æç«ï¼åºä¸ºï¼<span class="math inline">\(\mathbf{DC}\)</span> ä¸ºæ»¡ç§©ç©éµï¼è¿è <span class="math inline">\(\mathbf{DC}\boldsymbol{\alpha}\neq{0}\)</span>ãå æ­¤ï¼<span class="math inline">\(\mathbf{C}^{-1}\mathbf{ABC}\)</span> æ¯æ­£å®ç©éµï¼äºæ¯å®çææç¹å¾å¼ä¹æ¯æ­£æ°ã</p>


</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-02-15 15:40">2026-02-15 15:39</span>&nbsp;
<a href="https://www.cnblogs.com/GeophysicsWorker">GeoFXR</a>&nbsp;
éè¯»(<span id="post_view_count">0</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19618211);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19618211', targetLink: 'https://www.cnblogs.com/GeophysicsWorker/p/19618211', title: 'å¸ä¼åæ°å­¦åºç¡ç¬è®°ï¼äºï¼ï¼äºæ¬¡åä¸æ­£å®ç©éµ' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ OpenEuler 20.03æå»ºzabbix8.0 rpmå ]]></title>
    <link>https://www.cnblogs.com/virtualzzf/p/19617629</link>
    <guid>839af361d3bec343074433813f17777f</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/virtualzzf/p/19617629" title="åå¸äº 2026-02-15 10:46">
    <span role="heading" aria-level="2">OpenEuler 20.03æå»ºzabbix8.0 rpmå</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                    <div id="cnblogs_post_description" style="display: none">
        
        OpenEuler 20.03èªè¡æå»ºzabbix8.0 rpmå
    </div>
<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h1 id="ä¸è¯´æ">ä¸ãè¯´æ</h1>
<h2 id="ä¸ºä»ä¹è¦èªå·±æå»º">ä¸ºä»ä¹è¦èªå·±æå»ºï¼</h2>
<p>ç±äºcentosä»7çæ¬ä¹åæ¹ä¸ºstreamï¼å·¥ä½ç¯å¢ç±centosè½¬åOpenEulerãzabbixå®ç½ä¸æåå¤§ä¸»æµæä½ç³»ç»é¢ç¼è¯çrpmåï¼ä½æ¯Openeulerç¸å¯¹å°ä¼ï¼èªç¶æ²¡æå¶ä½å¥½çåãå³ä½¿æ¯centosç³»ç»ï¼7çæ¬ä¹è¿äºéæ§äºï¼ä»zabbix 6.0å¼å§ï¼centos 7å·²ç»ä¸æä¾serverçrpmåäºï¼åªå©ä¸proxyåagentï¼å°äº7.0çæ¬ï¼è¿proxyé½æ²¡æäºãå­¦ä¼èªå·±åå»ºrpmåï¼ä»¥å¤æä½ç³»ç»ç¯å¢åçæ¹åæ¯éå¸¸æå¿è¦çã</p>
<h2 id="ä¸ºä»ä¹ä¸ç´æ¥æºä»£ç ç¼è¯">ä¸ºä»ä¹ä¸ç´æ¥æºä»£ç ç¼è¯</h2>
<ol>
<li>ç±äºéç¨çæ¯sever-proxy-agentçå¤å±æ¶æï¼serveråªæä¸å°ï¼ä½æ¯proxyæå åå°ï¼agentæ´æ¯ä¸åï¼æ¯ä¸å°é½ç¨æºä»£ç ç¼è¯å·¥ä½éå¤§å¤§å¢å ã</li>
<li>æºä»£ç ç¼è¯çè½¯ä»¶ï¼å¨ä¸äºä¾å¦éç½®æä»¶ãå¯åå½ä»¤ä¸ä¸rpmçæ¬æå·®å¼ï¼å¦ææ··å¸å¢å äºè¿ç»´å¤æåº¦ã</li>
</ol>
<h2 id="ææ²¡æé¢ç¼è¯å¥½çrpmå">ææ²¡æé¢ç¼è¯å¥½çrpmå</h2>
<p>å¨OpenEulerçå®æ¹ç¤¾åºçè½¯ä»¶ä¸­å¿ï¼æç¤¾åºæåèªè¡æå»ºçrpmåï¼å¯ä»¥å°è¯æ¾æ¾ææ ç¬¦åèªå·±è¦æ±ççæ¬ã<br>
<img alt="image" loading="lazy" data-src="https://img2024.cnblogs.com/blog/2611015/202602/2611015-20260214105121016-558214650.png" class="lazyload"></p>
<h1 id="äºåå¤å·¥ä½">äºãåå¤å·¥ä½</h1>
<h2 id="21-æ·»å repoæº">2.1 æ·»å repoæº</h2>
<p>å¦æOpenEulerç¼ºå°é»è®¤çrepoæºï¼éè¦èªå·±æ·»å <br>
å¨/etc/yum.repos.d/openEuler_x86_64.repoä¸­æ·»å å¦ä¸åå®¹ï¼</p>
<pre><code>[OS]
name=openEuler-$releasever - OS
baseurl=https://repo.openeuler.openatom.cn/openEuler-20.03-LTS-SP4/OS/$basearch/
enabled=1
gpgcheck=1
gpgkey=https://repo.openeuler.openatom.cn/openEuler-20.03-LTS-SP4/OS/$basearch/RPM-GPG-KEY-openEuler
</code></pre>
<p>å¦å¤åæ·»å everythingçæºï¼å¯ä»¥æä¾æ´å¤çåã</p>
<pre><code>dnf config-manager --add-repo https://repo.openeuler.org/openEuler-20.03-LTS/everything/x86_64
</code></pre>
<p>ä½¿ç¨<code>dnf clean all &amp;&amp; dnf makecache</code>å½ä»¤æ´æ°ã</p>
<h2 id="22-åå¤æå»ºrpmåç¯å¢">2.2 åå¤æå»ºrpmåç¯å¢</h2>
<p>ä¹åçæç« éå·²ç»ä»ç»äºæå»ºrpmåçåºæ¬æ¹æ³ï¼è¿éä¸åèµè¿°ãrootç¨æ·ä¸è¿è¡å½ä»¤å¦ä¸ï¼</p>
<pre><code>dnf install -y rpm-build
dnf install -y rpmdevtools
rpmdev-setuptree
</code></pre>
<p>ä¸è½½srpmåï¼ <a href="http://repo.zabbix.com/zabbix/7.0/rhel/8/SRPMS/zabbix-7.0.23-release1.el8.src.rpm" target="_blank" rel="noopener nofollow">http://repo.zabbix.com/zabbix/7.0/rhel/8/SRPMS/zabbix-7.0.23-release1.el8.src.rpm</a> ï¼ ï¼è¿éä»¥rhel8çæ¬çsrpmæä»¶ä¸ºä¾ï¼</p>
<pre><code>rpm -ivh zabbix-7.0.23-release1.el8.src.rpm
</code></pre>
<p>æ­¤æ¶ï¼å¨/root/rpmbuildç®å½ä¸çSOURCESç®å½ä¸ä¼äº§çæºä»£ç åç¼©åãè¡¥ä¸åéç½®æä»¶ï¼SPECSç®å½ä¼äº§çspecæä»¶ãä½æ¯æ­¤specæä»¶æ¯Centos8çæ¬çï¼ä¸OpenEulerä¸å®å¨å¥åï¼éè¦ä¿®æ¹ä¸ä¸ã</p>
<h1 id="ä¸å®è£ä¾èµå">ä¸ãå®è£ä¾èµå</h1>
<h2 id="31-buildrequiresè¦æ±çä¾èµå">3.1 BuildRequiresè¦æ±çä¾èµå</h2>
<table>
<thead>
<tr>
<th>ä¾èµå</th>
<th>è¦æ±ççæ¬</th>
<th>dnfå®è£ççæ¬</th>
</tr>
</thead>
<tbody>
<tr>
<td>make</td>
<td></td>
<td></td>
</tr>
<tr>
<td>mariadb-connector-c-devel</td>
<td></td>
<td></td>
</tr>
<tr>
<td>postgresql-devel</td>
<td>&gt;= 12.0</td>
<td>10.5</td>
</tr>
<tr>
<td>sqlite-devel</td>
<td></td>
<td></td>
</tr>
<tr>
<td>net-snmp-devel</td>
<td></td>
<td></td>
</tr>
<tr>
<td>openldap-devel</td>
<td></td>
<td></td>
</tr>
<tr>
<td>unixODBC-devel</td>
<td></td>
<td></td>
</tr>
<tr>
<td>curl-devel</td>
<td>&gt;= 7.13.1</td>
<td>7.66.0</td>
</tr>
<tr>
<td>OpenIPMI-devel</td>
<td>&gt;= 2</td>
<td>2.0.29</td>
</tr>
<tr>
<td>libssh-devel</td>
<td>&gt;= 0.9.0</td>
<td>0.9.4</td>
</tr>
<tr>
<td>java-develï¼java-1.8.0-openjdk-develï¼</td>
<td>&gt;= 1.6.0</td>
<td>1.8.0.392.b08</td>
</tr>
<tr>
<td>libxml2-devel</td>
<td></td>
<td></td>
</tr>
<tr>
<td>libevent-devel</td>
<td></td>
<td></td>
</tr>
<tr>
<td>pcre2-devel</td>
<td></td>
<td></td>
</tr>
<tr>
<td>openssl-devel</td>
<td>&gt;= 1.0.1</td>
<td>1.1.1f</td>
</tr>
<tr>
<td>systemd</td>
<td></td>
<td></td>
</tr>
<tr>
<td>policycoreutils-devel</td>
<td></td>
<td></td>
</tr>
<tr>
<td>selinux-policy-devel</td>
<td></td>
<td></td>
</tr>
<tr>
<td>c-ares-devel</td>
<td>&gt;= 1.19.0</td>
<td>1.16.1</td>
</tr>
<tr>
<td>å®è£å¨é¨ä¾èµï¼</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<pre><code>dnf install -y make mariadb-connector-c-devel postgresql-devel sqlite-devel net-snmp-devel openldap-devel unixODBC-devel curl-devel OpenIPMI-devel libssh-devel java-1.8.0-openjdk-devel libxml2-devel libevent-devel pcre2-devel openssl-devel systemd policycoreutils-devel selinux-policy-devel c-ares-devel
</code></pre>
<h2 id="32-å¶ä»ä¾èµå">3.2 å¶ä»ä¾èµå</h2>
<p>zabbix agent2æ¯ä½¿ç¨GOè¯­è¨ç¼åçï¼å¹¶ä¸ä½¿ç¨çè¯­æ³å¯¹çæ¬è¿æè¦æ±ï¼OpenEuler 20.03é»è®¤repoæºççæ¬ä¸º1.15ï¼éè¦å®è£ä¸ä¸ªè¾æ°çæ¬çã<br>
é¦åä¸è½½golangçåç¼©åå¹¶è§£å</p>
<pre><code>tar -C /usr/local -xzf go1.24.8.linux-amd64.tar.gz
</code></pre>
<p>éç½®PATHåéå¹¶çæ</p>
<pre><code>tee /etc/profile.d/go.sh &lt;&lt;EOL
export GO_HOME=/usr/local/go
export PATH=\$PATH:\$GO_HOME/bin
EOL
source /etc/profile
</code></pre>
<p>ä½æ¯å®éä¸agent2åweb_service<strong>å¹¶æªæå»ºæå</strong>ï¼è§4.3å°è</p>
<h1 id="åä¿®æ¹specæä»¶">åãä¿®æ¹specæä»¶</h1>
<p>ä¿®æ¹å¥½çspecæä»¶è§ï¼<a href="https://files.cnblogs.com/files/blogs/745793/zabbix.zip?t=1771123185&amp;download=true" target="_blank">https://files.cnblogs.com/files/blogs/745793/zabbix.zip?t=1771123185&amp;download=true</a></p>
<h2 id="41-å é¤rhelåamznå®">4.1 å é¤%{rhel}å%{?amzn}å®</h2>
<p>%{rhel}å%{?amzn}ä¸¤ä¸ªå®åå«æ è¯äºredhatåamazonç³»linuxçå¤§çæ¬å·ï¼ç¨äºæå»ºæ¶ä¸äºéç½®æ¹å¼çéæ©ãç±äºè¿ä¸¤ä¸ªå®å¨OpenEulerä¸­ä¸ºç©ºï¼å¨specæä»¶ä¸­ä¼è¢«å¨å±å®ä¹ä¸º0ï¼ç´æ¥ä½¿ç¨ä¼å½±åæå»ºï¼éè¦å¨é¨è¿è¡å¤çã<br>
ä¸OpenEulerç¸å¯¹æ¥è¿çæ¯Centos8ï¼æ%{?rhel}å½åâ8âå¤çï¼%{?amzn}ç´æ¥å é¤ã<br>
ç¤ºä¾1ï¼</p>
<pre><code>%if ( 0%{?rhel} &gt;= 7 &amp;&amp; 0%{?amzn} == 0 ) || 0%{?amzn} &gt;= 2023
%{!?build_agent2: %global build_agent2 1}
%endif
</code></pre>
<p>ç±äº08 &gt;= 7ï¼ç´æ¥ä¿®æ¹ä¸º</p>
<pre><code>%{!?build_agent2: %global build_agent2 1}
</code></pre>
<p>ç¤ºä¾2ï¼</p>
<pre><code>%if 0%{rhel} &gt;= 9 || 0%{?amzn} &gt;= 2023
BuildRequires: selinux-policy-devel
BuildRequires: c-ares-devel &gt;= 1.19.0
%endif
</code></pre>
<p>ç±äºä¸æ»¡è¶³ 08 &gt;= 9 ï¼ç´æ¥å é¤</p>
<h2 id="42-ä¿®æ¹buildrequiresçæ¬è¦æ±">4.2 ä¿®æ¹BuildRequiresçæ¬è¦æ±</h2>
<p>å®ç½repoæºçpostgresql-develçæ¬ä¸è¾¾æ ï¼ç´æ¥è¿è¡æå»ºä¼æ¥éã<br>
postgresqlå®ç½æ²¡æOpenEulerçé¢ç¼è¯rpmåï¼æ³è¦æ»¡è¶³è¦æ±å¿é¡»èªè¡ä»æºä»£ç è¿è¡ç¼è¯ã<br>
æ¬æä»ä¸ºæ¼ç¤ºï¼å°<code>postgresql-devel &gt;= 12.0</code>ä¿®æ¹ä¸º<code>postgresql-devel</code></p>
<h2 id="43-å»é¤agent2åweb_service">4.3 å»é¤agent2åweb_service</h2>
<p>agent3åweb_serviceé½ä½¿ç¨äºGOè¯­è¨ï¼ç±äºç½ç»é®é¢å¯¼è´ä¸¤èçåå»ºä¼åºéï¼ç´æ¥å é¤ä»¥ä¸åå®¹ï¼</p>
<pre><code>%ifarch x86_64 aarch64
%if ( 0%{?rhel} &gt;= 7 &amp;&amp; 0%{?amzn} == 0 ) || 0%{?amzn} &gt;= 2023
%{!?build_agent2: %global build_agent2 1}
%endif
%if 0%{?rhel} &gt;= 8 || 0%{?amzn} &gt;= 2023
%{!?build_web_service: %global build_web_service 1}
%endif
%endif
</code></pre>
<p>æ¬æ¬¡æå»ºä¸åæ¬ä¸¤èï¼æ³è¦è§£å³å¯è½å¿é¡»ä½¿ç¨é­æ³äº</p>
<h1 id="äºæå»º">äºãæå»º</h1>
<p>ä½¿ç¨<code>rpmbuild -bb zabbix.spec</code>å½ä»¤è¿è¡æå»ºï¼éè¦æ¯è¾é¿çæ¶é´ã<br>
å®æåå¨/root/rpmbuild/RPMSç®å½ä¸å°±ä¼çæç¼è¯å¥½çrpmåã</p>


</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-02-15 10:46">2026-02-15 10:46</span>&nbsp;
<a href="https://www.cnblogs.com/virtualzzf">virtualzzf</a>&nbsp;
éè¯»(<span id="post_view_count">16</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19617629);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19617629', targetLink: 'https://www.cnblogs.com/virtualzzf/p/19617629', title: 'OpenEuler 20.03æå»ºzabbix8.0 rpmå' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ ä¸ºä»ä¹ç°ä»£ C++ åºé½ç¨ PIMPLï¼ä¸åºå³äºå°è£ãä¾èµä¸å®å¨çæ¼è¿ ]]></title>
    <link>https://www.cnblogs.com/charlee44/p/19616660</link>
    <guid>8e81f508b84fe94d286e066ebb7e17c6</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/charlee44/p/19616660" title="åå¸äº 2026-02-14 21:27">
    <span role="heading" aria-level="2">ä¸ºä»ä¹ç°ä»£ C++ åºé½ç¨ PIMPLï¼ä¸åºå³äºå°è£ãä¾èµä¸å®å¨çæ¼è¿</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                    <div id="cnblogs_post_description" style="display: none">
        
        ç³»ç»éè¿°äºå¨ C++ å·¥ç¨ä¸­å¦ä½éè¿ PIMPL æ¯ç¨æ³ï¼å¨åå® RAII èµæºå®å¨çåæä¸ï¼ææè§£è¦å¤´æä»¶ä¾èµãæåç¼è¯æçå¹¶ä¿ææ¥å£ç®æ´ã
    </div>
<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<blockquote>
<p>å¨ C++ çå·¥ç¨å®è·µä¸­ï¼å¦ä½å¨ä¿è¯èµæºå®å¨ç®¡ççåæ¶ï¼åé¿åå¤´æä»¶æ±¡æåä¸å¿è¦çç¼è¯ä¾èµï¼è¿ä¸ªé®é¢è´¯ç©¿äºç°ä»£ C++ åºè®¾è®¡çæ ¸å¿ãæ¬æå°æ²¿çä¸æ¡æ¸æ°çææ¯æ¼è¿è·¯å¾ï¼æ¢è®¨ä» RAII å°è£åºåï¼åç»å¼è¯­ä¹ãè£¸æéãæºè½æéç­é¶æ®µï¼æç»èµ°å PIMPLï¼Pointer to Implementationï¼ è¿ä¸æçä¸ä¼éçè§£å³æ¹æ¡ã</p>
</blockquote>
<h1 id="1-raiièµæºç®¡ççåºç³">1. RAIIââèµæºç®¡ççåºç³</h1>
<p>C++ çæ ¸å¿å²å­¦ä¹ä¸æ¯ RAIIï¼Resource Acquisition Is Initializationï¼ï¼èµæºï¼åå­ãæä»¶å¥æãç½ç»è¿æ¥ç­ï¼ççå½å¨æåºç±å¯¹è±¡çæé ä¸ææèªå¨ç®¡çãä¾å¦ï¼</p>
<pre><code class="language-cpp">class FileHandle {
    FILE* fp;
public:
    FileHandle(const char* path) : fp(fopen(path, "r")) {}
    ~FileHandle() { if (fp) fclose(fp); }
};
</code></pre>
<p>RAII è®©èµæºç®¡çåå¾å®å¨ï¼å©ç¨ç±»å¯¹è±¡ççå½å¨æï¼å¨æé å½æ°ä¸­ç³è¯·èµæºï¼å¨ææå½æ°ä¸­éæ¾èµæºãå¦æè¿ä¸ªç±»å¯¹è±¡æ¯åºäºæ çå¼å¯¹è±¡ï¼é£ä¹å°±å¯ä»¥èªå¨å®ç°èµæºçç®¡çãå æ­¤ï¼å¨ç°ä»£ C++ ä¸­ï¼ç¸æ¯ä¼ ç»çæéè¯­ä¹ï¼æ´å æå¡ä½¿ç¨åºäº RAII çå¼è¯­ä¹ã</p>
<h1 id="2-å¼è¯­ä¹çè¯±æä¸ä»£ä»·">2. å¼è¯­ä¹çè¯±æä¸ä»£ä»·</h1>
<p>ä½æ¯ï¼å½æä»¬æè¿ç§ææ³ç¨äºå°è£å¤æç»ä»¶ï¼å¦ ONNX æ¨¡åä¼è¯ãæ°æ®åºè¿æ¥æ± ï¼æ¶ï¼é®é¢åºç°äºãçæ³æåµä¸ï¼æä»¬å¸æåä½¿ç¨ std::string ä¸æ ·ï¼ç¨âå¼è¯­ä¹âæä½ä¸ä¸ªå°è£å¯¹è±¡ï¼</p>
<pre><code class="language-cpp">class Embedder {
    Ort::Session session; // å¼æå
public:
    std::vector&lt;float&gt; embed(const std::string&amp; text);
};
</code></pre>
<p>è¿çèµ·æ¥éå¸¸ç®æ´ãé«æãç¬¦åç°ä»£ C++ é£æ ¼ãä½ä¹æå¦å¤ä¸ä¸ªé®é¢ï¼ç ´åäºå°è£ï¼å¯¼è´ä¸å¿è¦çç¯å¢ä¾èµãæç´è§çé®é¢å°±æ¯ <code>Ort::Session</code> çå®æ´å®ä¹å¿é¡»åºç°å¨å¤´æä»¶ä¸­ï¼è¿æå³çä½¿ç¨èå¿é¡»åå« onnxruntime ï¼èè¿ä¸ªå¤´æä»¶å¯è½éè¾¾æ° MB ï¼ä¾èµæ°åä¸ªç³»ç»åºãè¿å°±ä¼é æå¦ä¸é®é¢ï¼</p>
<ul>
<li>ç¼è¯æ¶é´æ´å¢ï¼å¾®å°çæ¹å¨é½éè¦ç¼è¯å¾é¿çæ¶é´ã</li>
<li>å¤´æä»¶è¦åä¸¥éï¼è°ç¨èä½¿ç¨ä¸æ¹ä¾¿ï¼çè³é æç¯å¢æ±¡æã</li>
<li>ABI æå¶èå¼±ï¼åé¨æ¹å¨å¯¼è´ææç¨æ·éç¼è¯ã</li>
</ul>
<h1 id="3-æéè¯­ä¹çåé">3. æéè¯­ä¹çåé</h1>
<p>ä¸ºäºè§£è¦ï¼ä¸ä¸ªæ¯è¾å¥½çåæ³å°±æ¯ä½¿ç¨åç½®å£°æ + æéè¯­ä¹ï¼</p>
<pre><code class="language-cpp">// header
class SessionImpl; // åç½®å£°æ
class Embedder {
    SessionImpl* pimpl;
public:
    Embedder();
    ~Embedder(); // å¿é¡»æå¨ delete
};
</code></pre>
<p>è¿æ ·åç¡®å®åæ­äºç¼è¯ä¾èµï¼ä½ä¹å¼å¥äºæ°çé®é¢ãé£å°±æ¯éè¦æç§ RAII åååå¥½æé å½æ°åææå½æ°ãèä¸æ¦è¦åææå½æ°ï¼ä¹å¾å¾æå³çéè¦åå¦å¤åä¸ªç¹æ®çæåå½æ°ï¼</p>
<ol>
<li>æ·è´æé å½æ°ï¼Copy Constructorï¼</li>
<li>æ·è´èµå¼è¿ç®ç¬¦ï¼Copy Assignment Operatorï¼</li>
<li>ç§»å¨æé å½æ°ï¼Move Constructorï¼</li>
<li>ç§»å¨èµå¼è¿ç®ç¬¦ï¼Move Assignment Operatorï¼</li>
</ol>
<p>è¿æ ·åè¦åéå¸¸å¤çæ ·æ¿ä»£ç ï¼èä¸ä¹å¾å®¹æåºé®é¢ãä¸ºäºå°è£çºç²å®å¨ï¼å¾ä¸å¿å¤±ã</p>
<h1 id="4-ä½¿ç¨æºè½æé">4. ä½¿ç¨æºè½æé</h1>
<p>ä½¿ç¨è£¸æéåéº»ç¦åä¸å®å¨ï¼é£ä¹å°±å¯ä»¥ä½¿ç¨ C++11 å¼å¥çæºè½æéï¼std::unique_ptr å std::shared_ptrï¼æºè½æéåæ ·æ¯åºäº RAII çï¼</p>
<pre><code class="language-cpp">class SessionImpl;
class Embedder {
    std::unique_ptr&lt;SessionImpl&gt; pimpl;
};
</code></pre>
<p>è¿éä¸ºä»ä¹ä½¿ç¨ <code>std::unique_ptr</code> èä¸ä½¿ç¨ <code>std::shared_ptr</code> å¢ï¼å¶å®ä¹å¯ä»¥ï¼ä¸è¿å¨ç°ä»£ C++ ä¸­ï¼æ´æ¨èä½¿ç¨ <code>std::unique_ptr</code> ã<code>std::shared_ptr</code> æ¯ç¨æ¥å±äº«èµæºçæææï¼ä¼å¯¹å¼ç¨èµæºè¿è¡è®¡æ°ï¼ä½æ¯æå¯è½ä¼é æç¸äºå¾ªç¯å¼ç¨é æä¸è½éæ¾èµæºçé®é¢ï¼è<code>std::unique_ptr</code> åè¡¨ç¤ºç¬å èµæºçæææï¼ä¸ä»å¼éæ´ä½ï¼æ å¼ç¨è®¡æ°ï¼ï¼ä¹æ´å å®å¨ï¼åªè½éè¿ <code>std::move</code> è½¬ç§»æææ ï¼ã</p>
<p>ä¸è¿æä¸ç¹éè¦æ³¨æï¼<code>std::unique_ptr</code> å <code>std::shared_ptr</code> å¨å¤çä¸å®æ´ç±»åï¼incomplete typeï¼æ¶çè¡ä¸ºæªç¶ä¸åãå·ä½æ¥è¯´ï¼å½å¨å¤´æä»¶ä¸­ä½¿ç¨åç½®å£°æï¼å¦ <code>class Impl;</code>ï¼å¹¶ç¨æºè½æéææå®æ¶ï¼<code>Impl</code> æ¯ä¸ä¸ªä¸å®æ´ç±»åã</p>
<ul>
<li><code>std::shared_ptr</code> å¯ä»¥å®å¨å°å¨å¤´æä»¶ä¸­é»è®¤ææï¼å ä¸ºå®å¨æé æ¶ï¼éå¸¸å¨ <code>.cpp</code> æä»¶ä¸­ï¼ä¼æè·ä¸ä¸ªå®æ´çå é¤å¨ï¼deleterï¼ï¼å³ä½¿ææåçå¨å¤´æä»¶ä¸ä¸æä¸­ï¼ä¹è½æ­£ç¡®è°ç¨ <code>delete</code>ã</li>
<li>è <code>std::unique_ptr</code> çå é¤å¨æ¯å¶ç±»åçä¸é¨åï¼éå¸¸æ¯é»è®¤ç <code>std::default_delete&lt;Impl&gt;</code>ï¼ï¼å®è¦æ±å¨ææç¹ï¼å³ç±»çææå½æ°è¢«å®ä¾åçå°æ¹ï¼<code>Impl</code> å¿é¡»æ¯å®æ´ç±»åãå¦æå¨å¤´æä»¶ä¸­å <code>~Embedder() = default;</code>ï¼æ­¤æ¶ <code>Impl</code> ä»æ¯ä¸å®æ´çï¼ç¼è¯å¨å¯è½ä¸ä¼æ¥éï¼ä½ä¼å¯¼è´æªå®ä¹è¡ä¸ºï¼éå¸¸æ¯é¾æ¥å¤±è´¥æè¿è¡æ¶å´©æºï¼ã</li>
</ul>
<p>å æ­¤ï¼ä½¿ç¨ <code>std::unique_ptr&lt;Impl&gt;</code> æ¶ï¼å¿é¡»å°ä¸»ç±»çææå½æ°å®ä¹ç§»å° <code>.cpp</code> æä»¶ä¸­ï¼ç¡®ä¿ <code>Impl</code> å·²è¢«å®æ´å®ä¹ï¼</p>
<pre><code class="language-cpp">// Embedder.cpp
class Embedder::Impl {
    // å®æ´å®ä¹...
};

Embedder::~Embedder() = default; // â æ­¤æ¶ Impl å®æ´ï¼å®å¨ææ
</code></pre>
<h1 id="5-å°è£ä¸æççå¹³è¡¡pimpl">5. å°è£ä¸æççå¹³è¡¡ï¼PIMPL</h1>
<p>ä½¿ç¨æºè½æéè½ç¶å¥½ï¼ä½æ¯æ»å½æ¯æ¯ä¸ä¸å¼è¯­ä¹æ¹ä¾¿ãå½ç±»ä¸­åªæä¸ä¸ªéè¦éèçæåè¿å¥½ï¼å¦ææå¾å¤ä¸ªéè¦éèçæåï¼æ¯ä¸ä¸ªé½ååç½®å£°æï¼å¹¶ç¨æºè½æéæ¥ç®¡çï¼é£å°±å®å¨å¤ªç¹çäºãå¹¶ä¸ï¼ä»ç¼ç¨åå³ä¸æ¥è¯´ï¼C++ æºè½æéçåæ³è¯´ä¸ä¸ä¼éï¼æºè½æéæ¯ç±ä¼ ææ§çï¼å½æ»¡å±é½æ¯ <code>std::shared_ptr</code> æè <code>std::unique_ptr</code> çæ¶åï¼å®å¨å¾å½±åéè¯»æ§ã</p>
<p>å¦å¤ï¼ä½ä¸ºå¯¹å¤çæ¥å£ï¼æå¥½æ¯æä¾å Java / C# é£æ ·çæ¥å£ï¼C++ ççº¯èå½ç±»ä¹è¡ï¼éèæææçç»èï¼åæ¬ç§æå½æ°åæ°æ®æåãè¿æ ·æéå¸¸å¤çå¥½å¤ï¼</p>
<ol>
<li>æå°åä¾èµç¯å¢ï¼æåç¼è¯éåº¦ã</li>
<li>è°ç¨èä½¿ç¨æ¹ä¾¿ï¼ä¸ä¼æ±¡æç¯å¢ã</li>
<li>ABI ç¨³å®ï¼å¯ä»¥åªæ´æ°åºèä¸ç¨æ´æ°æ´ä¸ªç¨åºã</li>
</ol>
<p>é£ä¹è¦æä¹è¿è¡ä¼åå¢ï¼å¾ç®åï¼æä»¬å¯ä»¥å®ç°ä¸ä¸ªåä¸º <code>Impl</code> çç±»ä¸­ç±» ï¼ä½¿ç¨<code>std::unique_ptr</code>è¿è¡ç®¡çã<code>Impl</code> æ¯å®ç°å¨ cpp ä¸­çï¼å¯ä»¥å°ä¸åå®ç°çç»èï¼æ¯è¯´ç§æå½æ°åæ°æ®æåï¼é½æ¾å¨è¿ä¸ª <code>Impl</code> ä¸­ãæ´éè¦çæ¯ï¼<code>Impl</code> ä¸­çæ°æ®æåå®å¨å¯ä»¥ä½¿ç¨å¼ç±»åï¼å¦ä¸æç¤ºï¼</p>
<pre><code class="language-cpp">// å¤´æä»¶
class Embedder {
    class Impl;
    std::unique_ptr&lt;Impl&gt; impl;
public:
    Embedder(const std::string&amp; model);
    ~Embedder(); // å£°æä½ä¸å¨å¤´æä»¶å®ä¹ï¼
    std::vector&lt;float&gt; embed(std::string_view text) const;
};
</code></pre>
<pre><code class="language-cpp">// æºæä»¶
class Embedder::Impl {
    Ort::Session session;
    hf::Tokenizer tokenizer;
    int64_t dim;
public:
    Impl(const std::string&amp; path, const hf::Tokenizer&amp; tok) 
        : session(...), tokenizer(tok) { /* init */ }
    std::vector&lt;float&gt; embed(std::string_view text) const { /* ... */ }
};

Embedder::Embedder(const std::string&amp; path) 
    : impl(std::make_unique&lt;Impl&gt;(path, global_tokenizer)) {}

Embedder::~Embedder() = default; // æ­¤æ¶ Impl å®æ´ï¼å®å¨ï¼
</code></pre>
<p>è¿ä¸ªå®ç°ï¼å°±æ¯æè°ç PIMPLï¼Pointer to IMPLementationï¼æ¯ç¨æ³ï¼ä¹å¸¸è¢«ç§°ä½ âç¼è¯é²ç«å¢âï¼Compilation Firewallï¼ æ âOpaque Pointerâ æ¨¡å¼ãä¸å¾ä¸è¯´ï¼è¿ç§ PIMPL è®¾è®¡æ¨¡å¼ç¡®å®ç²¾å¦ââå®å¨å®å¨æ§ãå°è£æ§ãç¼è¯æçä¸æ¥å£ç®æ´æ§ä¹é´åå¾äºè¿ä¹å®ç¾çå¹³è¡¡ï¼æ¢åå®äº RAII çèµæºç®¡çååï¼åææéç¦»äºå®ç°ç»èï¼å ªç§°ç°ä»£ C++ å·¥ç¨å®è·µä¸­âé«åèãä½è¦åâçå¸èã</p>
<h1 id="6-æ²¡æé¶å¼¹åªææè¡¡">6. æ²¡æé¶å¼¹ï¼åªææè¡¡</h1>
<p>PIMPL ä½¿ç¨äºåç½®å£°æãæ¯å¦ä½¿ç¨åç½®å£°æä¸ç´æ¯ C++ ä¸­æ¯è¾äºè®®çä¸ç¹ï¼Qt éµå¾ªåç½®å£°æçååå®ç°äºéå¸¸å¼ºå¤§ãä¼éä¸é«æç C++ è¿è¡æ¶æ¡æ¶ãGoogle åç»åäºä»æ¨èä½¿ç¨åç½®å£°æå°ä¸æ¨èä½¿ç¨åç½®å£°æçè½¬åãä¸ªäººè®¤ä¸ºï¼PIMPL è§£å³çå°±æ¯ C++ ä¸­ä¸¤ä¸ªéè¦ååçç¾çé®é¢ï¼</p>
<ul>
<li>æ¨èä½¿ç¨å¼è¯­ä¹ï¼ä½æ¯ä¼å¼å¥æ´å¤ç¯å¢ä¾èµ</li>
<li>å°è£éè¦å°½å¯è½éèä¸å¿è¦çç»è</li>
</ul>
<p>å¦æä¸¤èåªè½éæ©å¶ä¸­ä¸ä¸ªï¼é£ä¹è¿æ¯å°½éä½¿ç¨å¼è¯­ä¹çååæ´å éè¦ï¼æ¯ç«è¿æ¶åå°å®å¨é®é¢ï¼èèµæºç®¡ççå®å¨é®é¢è´¯ç©¿ C++ ç¨åºçå§ç»ãäºå®ä¸ï¼å¦æä¸æ¯æä¾å¯¹å¤æ¥å£ï¼æèå®ç°æ¯è¾å°ï¼é£ä¹ç´æ¥ä½¿ç¨å¼è¯­ä¹å³å¯ï¼ç¬¬2èä¸­çåå®¹ï¼ââå¼è¯­ä¹æ°¸è¿æ¯æç®æ´å®å¨çå®ç°ã</p>
<p>å¦å¤ï¼å¦æå®ç° C++20 Modules ï¼é£ä¹å°±ä¸å¿è¦ä½¿ç¨ PIMPL äºï¼å®å¨å¯ä»¥åå½å¼è¯­ä¹å®ç°ï¼å ä¸º C++20 Modules å¨è¯­è¨å±é¢å·²ç»å®ç°äº PIMPL çè¯¸å¤ä¼ç¹ã</p>
<h1 id="7-ç¤ºä¾ä»£ç ">7. ç¤ºä¾ä»£ç </h1>
<p>æåæ¾åºç¬èèªå·±å®ç°çåºäº PIMPL çåµå¥å¨çå®æ´ä»£ç ä¾è¯»èåèï¼</p>
<pre><code class="language-cpp">// BgeOnnxEmbedder.h
#pragma once

#include &lt;memory&gt;
#include &lt;string&gt;
#include &lt;vector&gt;

namespace embedding {

namespace hf {
class Tokenizer;
}

class BgeOnnxEmbedder {
 public:
  explicit BgeOnnxEmbedder(const std::string&amp; modelPath,
                           const hf::Tokenizer&amp; tokenizer);
  ~BgeOnnxEmbedder();

  const int64_t&amp; EmbeddingDim() const;

  std::vector&lt;float&gt; Embed(const std::string&amp; text) const;

 private:
  class Impl;  // ååå£°æ
  std::unique_ptr&lt;Impl&gt; impl;
};

}  // namespace embedding
</code></pre>
<pre><code class="language-cpp">//BgeOnnxEmbedder.cpp
#include "BgeOnnxEmbedder.h"

#include &lt;onnxruntime_cxx_api.h&gt;

#include "HfTokenizer.h"
#include "Util/StringEncode.h"

namespace embedding {

class BgeOnnxEmbedder::Impl {
 public:
  Ort::Env&amp; GetOrtEnv() {
    static Ort::Env env(ORT_LOGGING_LEVEL_WARNING, "BgeOnnxEmbedder");
    return env;
  }

  const int64_t&amp; EmbeddingDim() const { return embeddingDim; }

  explicit Impl(const std::string&amp; modelPath, const hf::Tokenizer&amp; tokenizer)
      : session{GetOrtEnv(),
#ifdef _WIN32
                util::StringEncode::Utf8StringToWideString(modelPath).c_str(),
#else
                modelPath.c_str(),
#endif
                Ort::SessionOptions()},
        memInfo{Ort::MemoryInfo::CreateCpu(OrtDeviceAllocator, OrtMemTypeCPU)},
        tokenizer(tokenizer),
        embeddingDim(0) {

    //
    const auto&amp; outputInfo = session.GetOutputTypeInfo(0);
    const auto&amp; tensorInfo = outputInfo.GetTensorTypeAndShapeInfo();
    const auto&amp; shape = tensorInfo.GetShape();

    // åè®¾è¾åºæ¯ [batch, seq, dim] æ [batch, dim]
    // æä»¬åæåä¸ä¸ªé -1 çç»´åº¦
    for (auto it = shape.rbegin(); it != shape.rend(); ++it) {
      if (*it != -1) {
        embeddingDim = *it;
        break;
      }
    }

    if (embeddingDim == 0) {
      throw std::runtime_error(
          "Failed to infer embedding dimension from ONNX model.");
    }
  }

  std::vector&lt;float&gt; Embed(const std::string&amp; text) const {
    hf::Tokenizer::ResultPtr result = tokenizer.Encode(text);
    if (!result) {
      throw std::runtime_error("tokenizer_encode failed");
    }

    // å®ä¹å¼ éç»´åº¦
    int64_t seqLen = static_cast&lt;int64_t&gt;(result-&gt;length);
    std::vector&lt;int64_t&gt; inputShape = {1, seqLen};
    size_t dataByteCount = sizeof(int64_t) * seqLen;

    Ort::Value inputIdsTensor = Ort::Value::CreateTensor(
        memInfo.GetConst(), result-&gt;input_ids, dataByteCount, inputShape.data(),
        inputShape.size(),
        ONNXTensorElementDataType::ONNX_TENSOR_ELEMENT_DATA_TYPE_INT64);

    Ort::Value attentionMaskTensor = Ort::Value::CreateTensor(
        memInfo.GetConst(), result-&gt;attention_mask, dataByteCount,
        inputShape.data(), inputShape.size(),
        ONNXTensorElementDataType::ONNX_TENSOR_ELEMENT_DATA_TYPE_INT64);

    Ort::Value tokenTypeIdsTensor = Ort::Value::CreateTensor(
        memInfo.GetConst(), result-&gt;token_type_ids, dataByteCount,
        inputShape.data(), inputShape.size(),
        ONNXTensorElementDataType::ONNX_TENSOR_ELEMENT_DATA_TYPE_INT64);

    // è¾å¥åå¿é¡»ä¸æ¨¡åå®ä¹ä¸è´
    const char* inputNames[] = {"input_ids", "attention_mask",
                                "token_type_ids"};
    const char* outputNames[] = {"last_hidden_state"};

    // æä¸ä¸ªè¾å¥å¼ éæ¾è¿æ°ç»
    std::vector&lt;Ort::Value&gt; inputs;
    inputs.push_back(std::move(inputIdsTensor));
    inputs.push_back(std::move(attentionMaskTensor));
    inputs.push_back(std::move(tokenTypeIdsTensor));

    // æ§è¡æ¨ç
    auto outputs = session.Run(Ort::RunOptions(),  // è¿è¡éé¡¹ï¼éå¸¸ nullptrï¼
                               inputNames,         // è¾å¥åæ°ç»
                               inputs.data(),  // è¾å¥å¼ éæ°ç»
                               inputs.size(),  // è¾å¥æ°éï¼3ï¼
                               outputNames,    // è¾åºåæ°ç»
                               1               // è¾åºæ°éï¼1ï¼
    );

    // è·åè¾åºä¿¡æ¯
    auto&amp; output_tensor = outputs[0];
    auto output_shape = output_tensor.GetTensorTypeAndShapeInfo().GetShape();
    if (output_shape.size() != 3 || output_shape[0] != 1) {
      throw std::runtime_error("Unexpected output shape");
    }

    // è·åè¾åºå¼ éçåå§ float æé
    const float* outputData = outputs[0].GetTensorData&lt;float&gt;();

    // æå [CLS] token ç embeddingï¼ç¬¬0ä¸ªtokenï¼
    int64_t hiddenSize = output_shape[2];
    std::vector&lt;float&gt; embedding(outputData, outputData + hiddenSize);

    // L2 å½ä¸åï¼BGE è¦æ±ï¼
    float norm = 0.0f;
    for (float v : embedding) norm += v * v;
    norm = std::sqrt(norm);
    if (norm &gt; 1e-8) {
      for (float&amp; v : embedding) v /= norm;
    }

    return embedding;
  }

 private:
  mutable Ort::Session session;
  Ort::MemoryInfo memInfo;
  const hf::Tokenizer&amp; tokenizer;
  int64_t embeddingDim;
};

BgeOnnxEmbedder::BgeOnnxEmbedder(const std::string&amp; modelPath,
                                 const hf::Tokenizer&amp; tokenizer)
    : impl(std::make_unique&lt;Impl&gt;(modelPath, tokenizer)) {}

BgeOnnxEmbedder::~BgeOnnxEmbedder() = default;  // æ­¤æ¶ Impl å·²å®ä¹ï¼å¯å®å¨ææ

const int64_t&amp; BgeOnnxEmbedder::EmbeddingDim() const {
  return impl-&gt;EmbeddingDim();
}

std::vector&lt;float&gt; BgeOnnxEmbedder::Embed(const std::string&amp; text) const {
  return impl-&gt;Embed(text);
}

}  // namespace embedding
</code></pre>


</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-02-14 21:28">2026-02-14 21:27</span>&nbsp;
<a href="https://www.cnblogs.com/charlee44">charlee44</a>&nbsp;
éè¯»(<span id="post_view_count">42</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19616660);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19616660', targetLink: 'https://www.cnblogs.com/charlee44/p/19616660', title: 'ä¸ºä»ä¹ç°ä»£ C++ åºé½ç¨ PIMPLï¼ä¸åºå³äºå°è£ãä¾èµä¸å®å¨çæ¼è¿' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ AIç¼ç¨æ¶ä»£æ®éæ¬ç§è®¡ç®æºæ¯ä¸ççåºè·¯ ]]></title>
    <link>https://www.cnblogs.com/xdesigner/p/19615230</link>
    <guid>7fda5fd7f3e6bb4aff5a655016315f4e</guid>
    <description>
    <![CDATA[ 
		<h2>
			<a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/xdesigner/p/19615230" title="åå¸äº 2026-02-14 13:36">
    <span role="heading" aria-level="2">AIç¼ç¨æ¶ä»£æ®éæ¬ç§è®¡ç®æºæ¯ä¸ççåºè·¯</span>
    

</a>

		</h2>
		<div class="postText">    <div id="cnblogs_post_description" style="display: none">
        
        AIç¼ç¨å·¥å·å¿«éæ®åï¼æ­£å¨å½»åºæ¹åæ´ä¸ªç¨åºåè¡ä¸çæ ¼å±ä¸å°±ä¸é»è¾ãå¯¹å½åæ°ç¾ä¸ä¸æ¬ãäºæ¬æ®éè®¡ç®æºä¸ä¸çæ¯ä¸çæ¥è¯´ï¼å°±ä¸ç¯å¢å·²ç»åå¾å¼å¸¸æ®é·ï¼é£ä¹åºè·¯å¨åªéï¼
    </div>
<div id="cnblogs_post_body" class="blogpost-body blogpost-body-html">
<p><span style="font-size: 18pt">AI<span style="font-family: å®ä½">ç¼ç¨æ¶ä»£</span>æ®éæ¬ç§è®¡ç®æºæ¯ä¸ççåºè·¯</span></p>
<p><span style="font-size: x-large">è¢æ°¸ç¦ 2026-2-14</span></p>
<p><span style="font-size: 18pt">&nbsp; AI<span style="font-family: å®ä½">ç¼ç¨å·¥å·å¿«éæ®åï¼æ­£å¨å½»åºæ¹åæ´ä¸ªç¨åºåè¡ä¸çæ ¼å±ä¸å°±ä¸é»è¾ãå¯¹äº985ï¼211éç¹å¤§å­¦è®¡ç®æºä¸ä¸æ¯ä¸çæ¥è¯´è¿è½åºä»ãä½å¯¹æ°ç¾ä¸ä¸æ¬ãäºæ¬æ®éè®¡ç®æºä¸ä¸çæ¯ä¸çæ¥è¯´ï¼ç¯å¢å·²ç»åå¾å¼å¸¸æ®é·ï¼</span><span style="font-family: Calibri">ToC&nbsp;</span><span style="font-family: å®ä½">ç¨åºåå²ä½æ»éå¿«éæ¶ç¼©ï¼äºèç½å¤§åæäººæ°éå¤§å¹ä¸éï¼</span><span style="font-family: Calibri">ToB&nbsp;</span><span style="font-family: å®ä½">ç¨åºåå²ä½è½ç¶ä¹å¨æ¶ç´§ï¼æäººè§æ¨¡ææåå°ï¼ä½ä¾ç¶ä¿çççå®çå°±ä¸æºä¼ã èå¾å¤å­¦çéæ©çå¨èèå¬ãèç ãèç¼ï¼å¯¹å¤§å¤æ°äººæ¥è¯´æ©å·²ä¸æ¯é è°±åºè·¯ï¼èæ¯ä¸åéé¿ç°å®ãåç¸åèçé®ç¾å¸ãé¢å¯¹å¤§å¿ï¼ææ¸éãä¼åçº§æé«çéæ©éå¸¸æç¡®ï¼æ¥æ±</span><span style="font-family: Calibri">AI</span><span style="font-family: å®ä½">èä¸æ¯æµå¶</span><span style="font-family: Calibri">AI</span><span style="font-family: å®ä½">ï¼ååå©ç¨</span><span style="font-family: Calibri">AI</span><span style="font-family: å®ä½">å¸¦æ¥çææ¯å¹³æï¼ä¼åè¿å¥</span><span style="font-family: Calibri">ToB</span><span style="font-family: å®ä½">é¢åï¼ææå®å®ä¸ä¸ä¸ªé¿æè¡ä¸æ·±åº¦ç»å®ï¼è¿ææ¯æ®éè®¡ç®æºæ¯ä¸çæç°å®ãæå¯æç»­çå°±ä¸è·¯çº¿ã</span></span></p>
<p><span style="font-size: 18pt">&nbsp; ä»å¨çè¡ä¸æ°æ®æ¥çï¼ä¼°è®¡<span style="font-family: å®ä½">å½åå¨çç¨åºåæ»éçº¦</span>2700<span style="font-family: å®ä½">ä¸äººï¼å¶ä¸­&nbsp;</span><span style="font-family: Calibri">ToC&nbsp;</span><span style="font-family: å®ä½">ç¨åºåå</span><span style="font-family: Calibri">ToB&nbsp;</span><span style="font-family: å®ä½">ç¨åºåå¤§çº¦åå ä¸å</span><span style="font-family: å®ä½">ãè¿å»åå å¹´ï¼äºèç½é«éæ©å¼ ï¼</span><span style="font-family: Calibri">ToC&nbsp;</span><span style="font-family: å®ä½">é¢åä¸ç´æ¯å¸çº³ç¨åºåæå¤çæ¹åã</span></span></p>
<p><span style="font-size: 18pt"><span style="font-family: å®ä½">&nbsp; ä½å¨</span>AI<span style="font-family: å®ä½">ä¸è¡ä¸å¨æçåéå²å»ä¸ï¼è¿ä¸ªæ ¼å±æ­£å¨å¿«éåè½¬ã</span><span style="font-family: Calibri">ToC&nbsp;</span><span style="font-family: å®ä½">ç¨åºåçå²ä½æ­£å¨å¤§å¹åå°ã äºèç½å¤§åãçµåãç¤¾äº¤ãå·¥å·ç±»äº§åï¼å¤§éå·¥ä½éä¸­å¨çé¢å¼åãæ¥å£å®ç°ãä¸å¡é»è¾æ¼æ¥ç­éå¤æ§åå®¹ï¼èè¿æ­£æ¯</span><span style="font-family: Calibri">AI</span><span style="font-family: å®ä½">ææé¿æ¿ä»£çé¨åãåå ä¸è¡ä¸éæ¬å¢æï¼ä¼ä¸ä¸åé å äººå¤´åè§æ¨¡ï¼èæ¯ç¨èµæ·±å·¥ç¨å¸éå</span><span style="font-family: Calibri">AI</span><span style="font-family: å®ä½">å·¥å·å®æå·¥ä½ï¼</span><span style="font-family: Calibri">ToC&nbsp;</span><span style="font-family: å®ä½">æ´ä½å²ä½æ°éå¿«éä¸éãå¤§å®¶å¸¸è¯´çâ</span><span style="font-family: Calibri">30</span><span style="font-family: å®ä½">å²å±æºââ</span><span style="font-family: Calibri">35</span><span style="font-family: å®ä½">å²éä¼âï¼å ä¹å¨é¨æ¥èª</span><span style="font-family: Calibri">ToC&nbsp;</span><span style="font-family: å®ä½">è¡ä¸ï¼å ä¸ºè¿éæ¼ææ¬ãæ¼éåº¦ãæ¼å¹´è½»åï¼æ®éå­¦åå¼åèå ä¹æ²¡æé¿æç«äºåã</span></span></p>
<p><span style="font-size: 18pt">&nbsp; ToB&nbsp;<span style="font-family: å®ä½">ç¨åºåçå¤å¢åå®å¨ä¸åã è½ç¶åç»æµç¯å¢å½±åï¼ä¼ä¸ææ°äººçæ°éä¹å¨ä¸éï¼å¥å£æ¯ä»¥åæ´çªï¼ä½å²ä½å¹¶æ²¡ææ¶å¤±ã</span><span style="font-family: Calibri">ToB&nbsp;</span><span style="font-family: å®ä½">é¢åä¼ä¸ãæ¿åºãå»çãéèãå·¥ä¸ãè½æºç­åç´è¡ä¸ï¼æ ¸å¿ä»·å¼å¨äºä¸å¡çè§£ãè¡ä¸è§åãç³»ç»ç¨³å®æ§åå¤æé¡¹ç®è½å°è½åã</span><span style="font-family: Calibri">AI</span><span style="font-family: å®ä½">å¯ä»¥è¾å©ç¼ç ï¼ä½æ æ³æ¿ä»£è¡ä¸ç»éªä¸çå®é¡¹ç®ç§¯ç´¯ãå¨</span><span style="font-family: Calibri">ToB</span><span style="font-family: å®ä½">é¢åï¼</span><span style="font-family: Calibri">35</span><span style="font-family: å®ä½">å²ä¸æ¯å±æºï¼èæ¯é»éå¹´é¾ï¼ç»éªè¶ä¸°å¯è¶ä¸å¯æ¿ä»£ã</span></span></p>
<p><span style="font-size: 18pt"><span style="font-family: å®ä½">&nbsp; æ ¹æ®é¢æµï¼</span>5<span style="font-family: å®ä½">å¹´åå¨çç¨åºåç»æå°åºç°é¢ è¦æ§ååï¼</span><span style="font-family: Calibri">ToC&nbsp;</span><span style="font-family: å®ä½">ç¨åºåä¼ä»ç°å¨ç</span><span style="font-family: Calibri">1800</span><span style="font-family: å®ä½">ä¸åå°1400ä¸å·¦å³</span><span style="font-family: å®ä½">ï¼æ»éæ¥è¿è°æ©ï¼è&nbsp;</span><span style="font-family: Calibri">ToB&nbsp;</span><span style="font-family: å®ä½">ç¨åºåä¼ä»1300</span><span style="font-family: å®ä½">ä¸ç¨³æ­¥å¢é¿å°1700</span><span style="font-family: å®ä½">ä¸å·¦å³ã</span><span style="font-family: å®ä½">è¿ç»æ°æ®ï¼ä¸ºæ®éè®¡ç®æºæ¯ä¸çææäºæç¡®å®çæ¹åã</span></span></p>
<p><span style="font-size: 18pt"><span style="font-family: å®ä½">&nbsp; å¯ç°å®ä¸­ï¼å¤§éä¸æ¬ãäºæ¬å­¦çä¸æ¯ä¸å°±æ¾å¼å°±ä¸ï¼å¨èå¤èãä¸å·¥ä½ãä¸å®ä¹ ãæ æ¶å¥ï¼å®å¨ä¾é å®¶åº­æ¯æï¼çä¸å»æ¯å¨åªåå¥æï¼æ¬è´¨å´éå¸¸æ®é·ï¼èç æåº¦åå·ï¼èå¬å½åçä¸è¶³</span>3%<span style="font-family: å®ä½">ï¼å¨èå¤èæ¬è´¨ä¸å°±æ¯ç¨æä½æ¦ççæ¢¦æ³ï¼æ©çèªå·±ä¸æ¢è¿å¥ç¤¾ä¼çäºå®ï¼æä¸ºä¸åä½é¢ååççåèé®ç¾å¸ã å å¹´</span>åä¸åºæå¤çèä¸ä¸ï¼æè½éåãç»éªç©ºç½ãå¹´é¾åå¤§ï¼æç»æ¢æ²¡ä¸å²¸ï¼ä¹æ²¡å·¥ä½ï¼ä¸¤å¤´è½ç©ºãæ¯ä¸ç§å¯¹èªå·±å¯¹å®¶äººä¸è´è´£ä»»çè¡ä¸ºã</span></p>
<p><span style="font-size: 18pt"><span style="font-family: å®ä½">&nbsp; é¢å¯¹</span>AI<span style="font-family: å®ä½">ç¼ç¨çå¤§è¶å¿ï¼æ­£ç¡®çæåº¦ä¸æ¯ææ§åæµå¶ï¼èæ¯ä¸»å¨æ¥æ±ã</span><span style="font-family: Calibri">AI</span><span style="font-family: å®ä½">å¸¦æ¥äºåææªæçææ¯å¹³æï¼è¿å»éè¦é¿æè®­ç»æè½å·å¤çç¼ç è½åï¼ç°å¨åå©</span><span style="font-family: Calibri">AI</span><span style="font-family: å®ä½">å·¥å·å¯ä»¥å¿«éä¸æãè¿å¯¹åºç¡ä¸è¬ãå­¦åæ®éçå­¦çæ¥è¯´ï¼æ¯å·¨å¤§çæºä¼ââä½ ä¸éè¦æä¸ºé¡¶å°é«æï¼åªè¦ä¼ç¨</span><span style="font-family: Calibri">AI</span><span style="font-family: å®ä½">ãè½è½å°ãæä¸å¡ï¼å°±è½å¨</span><span style="font-family: Calibri">To B</span><span style="font-family: å®ä½">é¢åç«ç¨³èè·</span>&nbsp;</span></p>
<p><span style="font-size: 18pt"><span style="font-family: å®ä½">&nbsp; å æ­¤ï¼æ®éæ¬ç§è®¡ç®æºæ¯ä¸çæé«ä¼åçº§çéæ©ï¼ä¸æ¯æ­»ç£</span>To C<span style="font-family: å®ä½">å¤§åï¼ä¸æ¯èµå½èå¬èç ï¼èæ¯æ¾ä½å§¿æãæ¥ååçèµ·èªï¼ä¼åè¿å¥</span><span style="font-family: Calibri">To B</span><span style="font-family: å®ä½">è¡ä¸ãä¸å¿æ§çäºå¤§ååç¯ï¼ä¸å¿çº ç»äºèµ·ç¹é«ä½ï¼åå¥è¡ãåç§¯ç´¯ãéæ©å»ç</span><span style="font-family: Calibri">IT</span><span style="font-family: å®ä½">ãæ¿å¡ä¿¡æ¯åãå·¥ä¸è½¯ä»¶ãéèåå°ç­é¿æç¨³å®çæ¹åï¼å¨ä¸ä¸ªè¡ä¸ææ ¹</span><span style="font-family: Calibri">3</span><span style="font-family: å®ä½">â</span><span style="font-family: Calibri">5</span><span style="font-family: å®ä½">å¹´ï¼æèªå·±åè¡ä¸æ·±åº¦ç»å®ï¼ç¨ä¸å¡å£åå»ºç«</span><span style="font-family: Calibri">AI</span><span style="font-family: å®ä½">æ æ³æ¿ä»£çç«äºåã</span></span></p>
<p><span style="font-size: 18pt">&nbsp; AI<span style="font-family: å®ä½">æ¶ä»£æ²¡ææ·å¾ï¼åªææç°å®ççå­ç­ç¥ã</span><span style="font-family: Calibri">ToC&nbsp;</span><span style="font-family: å®ä½">å¨æ¶ç¼©ï¼èå¬èç æ¯æ¦çé·é±ï¼å¨èå¤èåªæ¯</span>åè<span style="font-family: å®ä½">é®ç¾å¸ãæ¥æ±</span>AI<span style="font-family: å®ä½">ãç¨å¥½ææ¯å¹³æãåå®å¥å±</span><span style="font-family: Calibri">ToB</span><span style="font-family: å®ä½">ãæ·±èåç´è¡ä¸ï¼ææ¯æ®éè®¡ç®æºæ¯ä¸çå¨æ¶ä»£åå±ä¸­ï¼ææ¸éãç¸å¯¹æå¡å®ï¼èµ°å¾æè¿çåºè·¯ã</span></span></p>

</div>
<div class="clear"></div>
</div>
		<p class="postfoot">
			posted on 
<span id="post-date" data-last-update-days="0.06319444444444444" data-date-updated="2026-02-14 15:07">2026-02-14 13:36</span>&nbsp;
<a href="https://www.cnblogs.com/xdesigner">è¢æ°¸ç¦ çµå­çåï¼å»çä¿¡æ¯å</a>&nbsp;
éè¯»(<span id="post_view_count">264</span>)&nbsp;
è¯è®º(<span id="post_comment_count">2</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19615230);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19615230', targetLink: 'https://www.cnblogs.com/xdesigner/p/19615230', title: 'AIç¼ç¨æ¶ä»£æ®éæ¬ç§è®¡ç®æºæ¯ä¸ççåºè·¯' })">ä¸¾æ¥</a>

		</p>
	 ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ Flask - å¸¸è§åºç¨é¨ç½²æ¹æ¡ ]]></title>
    <link>https://www.cnblogs.com/XY-Heruo/p/19615176</link>
    <guid>1d6a7598120a098808fe107484e5ba60</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/XY-Heruo/p/19615176" title="åå¸äº 2026-02-14 13:19">
    <span role="heading" aria-level="2">Flask - å¸¸è§åºç¨é¨ç½²æ¹æ¡</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                    <div id="cnblogs_post_description" style="display: none">
        
        å¸¸è§Flaskåºç¨é¨ç½²æ¹æ¡
    </div>
<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h2 id="åè¨">åè¨</h2>
<p>å¼åè°è¯é¶æ®µï¼è¿è¡ Flask çæ¹å¼å¤ç´æ¥ä½¿ç¨ <code>app.run()</code>ï¼ä½ Flask åç½®ç WSGI Server çæ§è½å¹¶ä¸é«ãå¯¹äºçäº§ç¯å¢ï¼ä¸è¬ä½¿ç¨ <code>gunicorn</code>ãå¦æèé¡¹ç®å¹¶ä¸éè¦å¤é«çæ§è½ï¼èä¸ç¨äºå¾å¤åè¿ç¨åçå±äº«åéï¼ä½¿ç¨ gunicorn ä¼å½±åä¸åä¼è¯é´çéä¿¡ï¼é£ä¹ä¹å¯ä»¥è¯è¯ç´æ¥ç¨ <code>gevent</code>ã</p>
<p>å¨ Docker æµè¡ä¹åï¼çäº§ç¯å¢é¨ç½² Flask é¡¹ç®å¤ä½¿ç¨ virtualenv + gunicorn + supervisorãDocker æµè¡ä¹åï¼é¨ç½²æ¹å¼å°±æ¢æäº gunicorn + Dockerãå¦ææ²¡æå®¹å¨ç¼ææå¡ï¼åç«¯æå¡åé¢ä¸è¬è¿ä¼æä¸ª nginx åä»£çãå¦æä½¿ç¨ Kubernetesï¼ä¸è¬ä¼ä½¿ç¨ service + ingressï¼æ istio ç­ï¼ã</p>
<h2 id="è¿è¡æ¹å¼">è¿è¡æ¹å¼</h2>
<h3 id="flask-åç½®-wsgi-server">Flask åç½® WSGI Server</h3>
<p>å¼åé¶æ®µä¸è¬ä½¿ç¨è¿ç§è¿è¡æ¹å¼ã</p>
<pre><code class="language-python"># main.py
from flask import Flask
from time import sleep

app = Flask(__name__)

@app.get("/test")
def get_test():
    sleep(0.1)
    return "ok"

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=10000)
</code></pre>
<p>è¿è¡:</p>
<pre><code class="language-bash">python main.py
</code></pre>
<h3 id="gevent">gevent</h3>
<p>ä½¿ç¨ gevent è¿è¡ Flaskï¼éè¦åå®è£ gevent</p>
<pre><code class="language-bash">python -m pip install -U gevent
</code></pre>
<p>ä»£ç éè¦ç¨ä½ä¿®æ¹ã</p>
<p>éè¦æ³¨æ <code>monkey.patch_all()</code> ä¸å®è¦åå¨å¥å£ä»£ç æä»¶çæå¼å¤´é¨åï¼è¿æ · monkey patch æè½çæã</p>
<pre><code class="language-python"># main.py
from gevent import monkey
monkey.patch_all()
import time

from flask import Flask
from gevent.pywsgi import WSGIServer


app = Flask(__name__)


@app.get("/test")
def get_test():
    time.sleep(0.1)
    return "ok"


if __name__ == "__main__":
    server = WSGIServer(("0.0.0.0", 10000), app)
    server.serve_forever()
</code></pre>
<p>è¿è¡</p>
<pre><code class="language-bash">python main.py
</code></pre>
<h3 id="gunicorn--gevent">gunicorn + gevent</h3>
<blockquote>
<p>å¦æç°æé¡¹ç®å¤§éä½¿ç¨åè¿ç¨åçåå­çº§å±äº«åéï¼è´¸ç¶ä½¿ç¨ gunicorn å¤ worker æ¨¡å¼å¯è½ä¼å¯¼è´æ°æ®è®¿é®ä¸ä¸è´çé®é¢ã</p>
</blockquote>
<p>åæ ·éè¦åå®è£ä¾èµã</p>
<pre><code class="language-bash">python -m pip install -U gunicorn gevent
</code></pre>
<p>ä¸åäºåç¬ä½¿ç¨ geventï¼è¿ç§æ¹å¼ä¸éè¦ä¿®æ¹ä»£ç ï¼gunicorn ä¼èªå¨æ³¨å¥ gevent ç monkey patchã</p>
<p>gunicorn å¯ä»¥å¨å½ä»¤è¡éç½®å¯å¨åæ°ï¼ä½ä¸ªäººä¸è¬ä¹ æ¯å¨ gunicorn çéç½®æä»¶åéç½®å¯å¨åæ°ï¼è¿æ ·å¯ä»¥å¨æè®¾ç½®ä¸äºéç½®ï¼èä¸å¯ä»¥ä¿®æ¹æ¥å¿æ ¼å¼ã</p>
<p><code>gunicorn.conf.py</code> çéç½®ç¤ºä¾å¦ä¸ï¼</p>
<pre><code class="language-python"># Gunicorn éç½®æä»¶
from pathlib import Path
from multiprocessing import cpu_count
import gunicorn.glogging
from datetime import datetime

class CustomLogger(gunicorn.glogging.Logger):
    def atoms(self, resp, req, environ, request_time):
        """
        éå atoms æ¹æ³æ¥èªå®ä¹æ¥å¿å ä½ç¬¦
        """
        # è·åé»è®¤çææå ä½ç¬¦æ°æ®
        atoms = super().atoms(resp, req, environ, request_time)
        
        # èªå®ä¹ 't' (æ¶é´æ³) çæ ¼å¼
        now = datetime.now().astimezone()
        atoms['t'] = now.isoformat(timespec="seconds")
        
        return atoms
    

# é¢å è½½åºç¨ä»£ç 
preload_app = True

# å·¥ä½è¿ç¨æ°éï¼éå¸¸æ¯ CPU æ ¸å¿æ°ç 2 åå  1
# workers = int(cpu_count() * 2 + 1)
workers = 4

# ä½¿ç¨ gevent å¼æ­¥ worker ç±»åï¼éå I/O å¯éååºç¨
# æ³¨æï¼gevent worker ä¸ä½¿ç¨ threads åæ°ï¼èæ¯ä½¿ç¨åç¨è¿è¡å¹¶åå¤ç
worker_class = "gevent"

# æ¯ä¸ª gevent worker å¯å¤ççæå¤§å¹¶åè¿æ¥æ°
worker_connections = 2000

# ç»å®å°ååç«¯å£
bind = "127.0.0.1:10001"

# è¿ç¨åç§°
proc_name = "flask-dev"

# PID æä»¶è·¯å¾
pidfile = str(Path(__file__).parent / "tmp" / "gunicorn.pid")

logger_class = CustomLogger
access_log_format = (
    '{"@timestamp": "%(t)s", '
    '"remote_addr": "%(h)s", '
    '"protocol": "%(H)s", '
    '"host": "%({host}i)s", '
    '"request_method": "%(m)s", '
    '"request_path": "%(U)s", '
    '"status_code": %(s)s, '
    '"response_length": %(b)s, '
    '"referer": "%(f)s", '
    '"user_agent": "%(a)s", '
    '"x_tracking_id": "%({x-tracking-id}i)s", '
    '"request_time": %(L)s}'
)

# è®¿é®æ¥å¿è·¯å¾
accesslog = str(Path(__file__).parent / "logs" / "access.log")

# éè¯¯æ¥å¿è·¯å¾
errorlog = str(Path(__file__).parent / "logs" / "error.log")

# æ¥å¿çº§å«
loglevel = "debug"
</code></pre>
<p>è¿è¡ãgunicorn çé»è®¤éç½®æä»¶åå°±æ¯ <code>gunicorn.conf.py</code>ï¼å¦ææä»¶åä¸åï¼å¯ä»¥ä½¿ç¨ <code>-c</code> åæ°æ¥æå®ã</p>
<pre><code class="language-bash">gunicorn main:app
</code></pre>
<h2 id="ä¼ ç»è¿ç¨ç®¡çå®ç°èªå¨å¯å¨">ä¼ ç»è¿ç¨ç®¡çï¼å®ç°èªå¨å¯å¨</h2>
<p>å¨ä¼ ç»æå¡å¨é¨ç½²æ¶ï¼å¸¸è§çè¿ç¨å®æ¤æ¹å¼æï¼</p>
<ol>
<li>éç½® crontab + shell èæ¬ãå®æ¶æ£æ¥è¿ç¨å¨ä¸å¨ï¼ä¸å¨å°±å¯å¨ã</li>
<li>éç½® supervisorã</li>
<li>éç½® systemdã</li>
</ol>
<p>ç±äº <code>supervisor</code> éè¦åç¬å®è£ï¼èæ¬çè½ç¨èªå¸¦å·¥å·å°±ç¨èªå¸¦å·¥å·ãè½å°è£å°±å°è£çååï¼ä¸ªäººä¸è¬ä¸ä¼ä½¿ç¨ supervisorï¼å æ­¤æ¬æä¸ä¼æ¶åå¦ä½ä½¿ç¨ supervisorã</p>
<p>å¨æå¡å¨é¨ç½²æ¶ï¼ä¸è¬ä¹ä¼ä¸ºé¡¹ç®åç¬åå»º Python èæç¯å¢ã</p>
<pre><code class="language-bash"># ä½¿ç¨ Python åç½®ç venvï¼å¨å½åç®å½åå»º Python èæç¯å¢ç®å½ .venv
python3 -m venv .venv
source .venv/bin/activate
python -m pip install -r ./requirements.txt

# å¦æä½¿ç¨uv, ç´æ¥uv sync å³å¯
</code></pre>
<h3 id="crontab--shell-èæ¬-ä¸æ¨èçäº§ç¯å¢">crontab + shell èæ¬ (ä¸æ¨èçäº§ç¯å¢)</h3>
<p>åå¥è¡çæ¶åå¯¹ systemd ä¸çæï¼ç»å¸¸ç¨ crontab + shell èæ¬æ¥å®æ¤è¿ç¨ï¼ç°å¨æ³æ³è¿ç§æ¹å¼å¹¶ä¸åéï¼æ¯è¾èéª shell èæ¬çç¼åæ°´å¹³ï¼éè¦èèæ¹æ¹é¢é¢</p>
<ul>
<li>é¦åè¦ç¡®ä¿ç¨æ·çº§ crontab å¯ç¨ï¼æäºçäº§ç¯å¢ä¼ç¦ç¨ç¨æ·çº§ç crontabï¼èä¸ä¹ä¸åè®¸éä¾¿éç½®ç³»ç»çº§ç crontabã</li>
<li>crontab æ¯åéçº§çï¼æå¡åæ­¢æ¶é´å¯è½è¦ä¸åéã</li>
<li>å¦æææ§å¶å°æ¥å¿ï¼éè¦æå¨å¤çæ¥å¿éå®åï¼è¿ææ¥å¿æä»¶è½®è½¬é®é¢ã</li>
<li>å¦æ ulimit ä¸é«ï¼è¿å¾æ§å¶ ulimitã</li>
<li>ç»å¸¸åºç°åµå°¸è¿ç¨ï¼shell èæ¬æ¥è¦åä¸å ç¶ææ£æ¥çé»è¾ã</li>
</ul>
<p>å¦æåªéè¦ç®åç¨ç¨ï¼ä¹å¯ä»¥æä¾ä¸ªç¤ºä¾</p>
<pre><code class="language-bash">#!/bin/bash

# ç¯å¢éç½®
export FLASK_ENV="production"
export DATABASE_URL="postgresql://user:pass@localhost:5432/mydb"
export REDIS_URL="redis://localhost:6379/0"

script_dir=$(cd $(dirname $0) &amp;&amp; pwd)
app_name="gunicorn"  # å®éè¿ç¨åæ¯ gunicornï¼ä¸æ¯ Flask app
wsgi_module="wsgi:app"  # æ¿æ¢ WSGI å¥å£
socket_path="${script_dir}/myapp.sock"  # Unix Socket è·¯å¾ï¼é¿å /run éå¯ä¸¢å¤±ï¼
log_file="${script_dir}/app.log"
pid_file="${script_dir}/gunicorn.pid"   # ç¨ PID æä»¶æ§å¶

# è¿ç¨æ£æµ
is_running() {
    if [ -f "$pid_file" ]; then
        pid=$(cat "$pid_file")
        if ps -p "$pid" &gt; /dev/null 2&gt;&amp;1 &amp;&amp; grep -q "gunicorn.*${wsgi_module}" /proc/"$pid"/cmdline 2&gt;/dev/null; then
            echo "Gunicorn (PID: $pid) is running"
            return 0
        else
            rm -f "$pid_file"  # æ¸çå¤±æ PID
            echo "Stale PID file found, cleaned up"
            return 1
        fi
    else
        # å¤ç¨æ£æµï¼éè¿ socket æä»¶ + è¿ç¨å
        if [ -S "$socket_path" ] &amp;&amp; pgrep -f "gunicorn.*${wsgi_module}" &gt; /dev/null 2&gt;&amp;1; then
            echo "Gunicorn is running (detected by socket)"
            return 0
        fi
        echo "Gunicorn is not running"
        return 1
    fi
}

# å¯å¨åºç¨
start_app() {
    is_running
    if [ $? -eq 0 ]; then
        echo "Already running, skip start"
        return 0
    fi

    echo "Starting Gunicorn at $(date)"
    echo "Socket: $socket_path"
    echo "Log: $log_file"

    # ç¡®ä¿ socket ç®å½å­å¨
    mkdir -p "$(dirname "$socket_path")"

    # å¯å¨å½ä»¤ï¼å³é®ï¼ä¸å  --daemonï¼ç¨ nohup æç®¡ï¼
    cd "$script_dir" || exit 1
    # çæ PID æä»¶
    nohup "$script_dir/venv/bin/gunicorn" \
        --workers 3 \
        --bind "unix:$socket_path" \
        --pid "$pid_file" \
        --access-logfile "$log_file" \
        --error-logfile "$log_file" \
        --log-level info \
        "$wsgi_module" &gt; /dev/null 2&gt;&amp;1 &amp;

    # ç­å¾å¯å¨å®æ
    sleep 2
    if is_running; then
        echo "â Start success (PID: $(cat "$pid_file" 2&gt;/dev/null))"
        return 0
    else
        echo "â Start failed, check $log_file"
        return 1
    fi
}

# åæ­¢åºç¨
stop_app() {
    is_running
    if [ $? -eq 1 ]; then
        echo "Not running, skip stop"
        return 0
    fi

    pid=$(cat "$pid_file" 2&gt;/dev/null)
    echo "Stopping Gunicorn (PID: $pid) gracefully..."

    # åå SIGTERMï¼ä¼éåæ­¢ï¼
    kill -15 "$pid" 2&gt;/dev/null || true
    sleep 5

    # æ£æ¥æ¯å¦è¿å¨è¿è¡
    if ps -p "$pid" &gt; /dev/null 2&gt;&amp;1; then
        echo "Still running after 5s, force killing..."
        kill -9 "$pid" 2&gt;/dev/null || true
        sleep 2
    fi

    # æ¸çæ®ç
    rm -f "$pid_file" "$socket_path"
    echo "â Stopped"
}

# éå¯åºç¨
restart_app() {
    echo "Restarting Gunicorn..."
    stop_app
    sleep 1
    start_app
}

# å¥å£å½æ°
main() {
    # æ£æ¥ Gunicorn æ¯å¦å­å¨
    if [ ! -f "$script_dir/venv/bin/gunicorn" ]; then
        echo "ERROR: Gunicorn not found at $script_dir/venv/bin/gunicorn"
        echo "Hint: Did you activate virtualenv? (source venv/bin/activate)"
        exit 1
    fi

    local action=${1:-start}  # é»è®¤å¨ä½ï¼start

    case "$action" in
        start)
            start_app
            ;;
        stop)
            stop_app
            ;;
        restart)
            restart_app
            ;;
        status)
            is_running
            ;;
        cron-check)
            # ä¸ä¸º crontab è®¾è®¡ï¼åªæ£æ¥+éå¯ï¼ä¸è¾åºå¹²æ°æ¥å¿
            if ! is_running &gt; /dev/null 2&gt;&amp;1; then
                echo "[$(date '+%F %T')] CRON: Gunicorn down, auto-restarting..." &gt;&gt; "$log_file"
                start_app &gt;&gt; "$log_file" 2&gt;&amp;1
            fi
            ;;
        *)
            echo "Usage: $0 {start|stop|restart|status|cron-check}"
            echo "  cron-check: Silent mode for crontab (logs to app.log only)"
            exit 1
            ;;
    esac
}

main "$@"
</code></pre>
<p>æå¨è¿è¡æµè¯</p>
<pre><code class="language-bash">bash app_ctl.sh start
</code></pre>
<p>éç½® crontab</p>
<pre><code># ç¼è¾å½åç¨æ· crontab
crontab -e

# æ·»å ä»¥ä¸è¡ï¼æ¯åéæ£æ¥ä¸æ¬¡ï¼
* * * * * /opt/myflaskapp/app_ctl.sh cron-check &gt;/dev/null 2&gt;&amp;1
</code></pre>
<p>éç½®logrotate</p>
<pre><code># /etc/logrotate.d/myflaskapp
/opt/myflaskapp/app.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    copytruncate  # é¿å Gunicorn ä¸¢å¤±æä»¶å¥æ
}
</code></pre>
<h3 id="systemd-æ¨èçäº§ç¯å¢ä½¿ç¨">systemd (æ¨èçäº§ç¯å¢ä½¿ç¨)</h3>
<ol>
<li>åå»º systemd æå¡æä»¶</li>
</ol>
<pre><code class="language-bash">sudo vim /etc/systemd/system/myflaskapp.service
</code></pre>
<ol start="2">
<li>ç¤ºä¾å¦ä¸</li>
</ol>
<pre><code class="language-ini">[Unit]
Description=Gunicorn instance for Flask App
After=network.target

[Service]
User=www-data
Group=www-data
WorkingDirectory=/path/to/your/app
Environment="PATH=/path/to/venv/bin"
ExecStart=/path/to/venv/bin/gunicorn \
          --workers 4 \
          --bind unix:/run/myapp.sock \
          --access-logfile - \
          --error-logfile - \
          wsgi:app

# ç¦æ­¢æ·»å  --daemonï¼systemd éç´æ¥çæ§ä¸»è¿ç¨
Restart=on-failure        # ä»å¼å¸¸éåºæ¶éå¯ï¼é0ç¶æç ãè¢«ä¿¡å·ææ­»ç­ï¼
RestartSec=5s             # éå¯åç­å¾5ç§
StartLimitInterval=60s    # 60ç§å
StartLimitBurst=5         # æå¤éå¯5æ¬¡ï¼é²éªå´©
TimeoutStopSec=30         # åæ­¢æ¶ç­å¾30ç§ï¼ä¼éå³é­ï¼

# å®å¨å åº
PrivateTmp=true
NoNewPrivileges=true
ProtectSystem=strict
ReadWritePaths=/run /var/log/myapp

[Install]
WantedBy=multi-user.target
</code></pre>
<ol start="3">
<li>è®¾ç½®å¼æºèªå¯å¹¶å¯å¨æå¡</li>
</ol>
<pre><code class="language-bash">sudo systemctl daemon-reload
sudo systemctl enable myflaskapp    # å¼æºèªå¯
sudo systemctl start myflaskapp
</code></pre>
<p>å¯ä»¥è¯è¯ç¨<code>kill -9</code>åæ­¢åç«¯æå¡è¿ç¨ï¼è§å¯è½å¦è¢«éæ°æèµ·ã</p>
<blockquote>
<p>æ³¨æï¼<code>kill -15</code>ç®æ¯æ­£å¸¸åæ­¢ï¼ä¸ç®å¼å¸¸éåºã</p>
</blockquote>
<h2 id="docker-é¨ç½²æ¹æ¡">Docker é¨ç½²æ¹æ¡</h2>
<ol>
<li>DockerfileãPython é¡¹ç®éå¸¸ä¸éè¦å¤é¶æ®µæå»ºï¼åé¶æ®µå³å¯ã</li>
</ol>
<pre><code class="language-dockerfile">FROM python:3.11-slim-bookworm

# å®å¨å åº
## åå»ºé root ç¨æ·ï¼é¿åä½¿ç¨ nobodyï¼æéå¤ªåéï¼
RUN useradd -m -u 1000 appuser &amp;&amp; \
    # å®è£è¿è¡æ¶å¿éçç³»ç»åºï¼éç¼è¯å·¥å·ï¼
    apt-get update &amp;&amp; apt-get install -y --no-install-recommends \
        libgomp1 \
        libpq5 \
        libsqlite3-0 \
        &amp;&amp; rm -rf /var/lib/apt/lists/* \
        &amp;&amp; apt-get autoremove -y \
        &amp;&amp; apt-get clean

# Python ä¼å
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1

WORKDIR /app

# å©ç¨ Docker å±ç¼å­ï¼åå¤å¶ requirements
COPY requirements.txt .
RUN pip install --no-cache-dir --prefer-binary -r requirements.txt \
    # æ¸ç pip ç¼å­ï¼è½ç¶ --no-cache-dir å·²ç¦ç¨ï¼ä½ä¿é©èµ·è§ï¼
    &amp;&amp; rm -rf /root/.cache

# åºç¨ä»£ç 
COPY --chown=appuser:appuser . .

# ä½¿ç¨érootç¨æ·è¿è¡
USER appuser

# å¯å¨
EXPOSE 8000
CMD ["gunicorn", "--config", "config/gunicorn.conf.py", "wsgi:app"]
</code></pre>
<ol start="2">
<li>ç¼å docker-compose.yaml</li>
</ol>
<pre><code class="language-yaml">services:
  web:
    image: myflaskapp:latest
    container_name: flask_web
    # ç«¯å£æ å°
    ## å¦æ nginx ä¹ä½¿ç¨ Docker é¨ç½²ï¼èä¸ä½¿ç¨åä¸ä¸ªç½ç»éç½®ï¼åå¯ä»¥ä¸åç«¯å£æ å°
    ports:
      - "8000:8000"
    # ç¯å¢åé
    environment:
      - FLASK_ENV=production
      - DATABASE_URL=postgresql://user:pass@db:5432/mydb
      - REDIS_URL=redis://redis:6379/0
    # å¥åº·æ£æ¥
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s      # æ¯ 30 ç§æ£æ¥ä¸æ¬¡
      timeout: 5s        # è¶æ¶ 5 ç§
      start_period: 15s  # å¯å¨å 15 ç§å¼å§æ£æ¥ï¼ç»åºç¨åå§åæ¶é´ï¼
      retries: 3         # å¤±è´¥éè¯ 3 æ¬¡åæ è®° unhealthy
    
    # èªå¨éå¯ç­ç¥
    restart: unless-stopped  # always / on-failure / unless-stopped
    
    # èµæºéå¶
    deploy:
      resources:
        limits:
          cpus: '2'        # æå¤ 2 ä¸ª CPU
          memory: 1G       # æå¤ 1GB åå­
        reservations:
          cpus: '0.5'      # ä¿ç 0.5 ä¸ª CPU
          memory: 256M     # ä¿ç 256MB åå­
    
    # ulimit éå¶ï¼é²èµæºæ»¥ç¨ï¼
    ulimits:
      nproc: 65535       # æå¤§è¿ç¨æ°
      nofile:
        soft: 65535      # æå¼æä»¶æ°è½¯éå¶
        hard: 65535      # æå¼æä»¶æ°ç¡¬éå¶
      core: 0            # ç¦æ­¢ core dump
    
    # å®å¨å åº
    security_opt:
      - no-new-privileges:true  # ç¦æ­¢ææ
    
    # åªè¯»æä»¶ç³»ç»ï¼é¤ /tmp å¤ï¼
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=100m
    
    # å·æè½½ï¼æ¥å¿ãä¸´æ¶æä»¶ï¼
    volumes:
      - ./logs:/app/logs:rw
      # - ./static:/app/static:ro  # éææä»¶ï¼å¯éï¼
    
    # ç½ç»
    networks:
      - app-network
        
# ç½ç»éç½®
networks:
  app-network:
    driver: bridge

# å·éç½®
volumes:
  db_data:
    driver: local
  redis_data:
    driver: local
</code></pre>
<h2 id="kubernetes-é¨ç½²æ¹æ¡">Kubernetes é¨ç½²æ¹æ¡</h2>
<h3 id="deployment">Deployment</h3>
<pre><code class="language-yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  name: flask-app
  namespace: default
  labels:
    app: flask-app
    tier: backend
spec:
  replicas: 3
  selector:
    matchLabels:
      app: flask-app
  template:
    metadata:
      labels:
        app: flask-app
        tier: backend
    spec:
      securityContext:
        runAsNonRoot: true      # ç¦æ­¢ root è¿è¡
        runAsUser: 1000         # ä½¿ç¨é root ç¨æ·
        runAsGroup: 1000
        fsGroup: 1000
        seccompProfile:
          type: RuntimeDefault  # å¯ç¨ seccomp å®å¨ç­ç¥
      containers:
      - name: flask-app
        image: myregistry.com/myflaskapp:1.0.0
        imagePullPolicy: IfNotPresent  # çäº§ç¯å¢å»ºè®®ç¨ Always
        ports:
        - name: http
          containerPort: 8000
          protocol: TCP
        env:
        - name: FLASK_ENV
          value: "production"
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: flask-app-secrets
              key: database-url
        - name: REDIS_URL
          valueFrom:
            secretKeyRef:
              name: flask-app-secrets
              key: redis-url
        - name: SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: flask-app-secrets
              key: secret-key
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"   # è¶è¿ä¼ OOM Kill
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /health
            port: 8000
            scheme: HTTP
          initialDelaySeconds: 30  # å¯å¨å 30 ç§å¼å§æ£æ¥
          periodSeconds: 10        # æ¯ 10 ç§æ£æ¥ä¸æ¬¡
          timeoutSeconds: 3        # è¶æ¶ 3 ç§
          successThreshold: 1
          failureThreshold: 3      # å¤±è´¥ 3 æ¬¡åéå¯å®¹å¨
        readinessProbe:
          httpGet:
            path: /health
            port: 8000
            scheme: HTTP
          initialDelaySeconds: 10  # å¯å¨å 10 ç§å¼å§æ£æ¥
          periodSeconds: 5         # æ¯ 5 ç§æ£æ¥ä¸æ¬¡
          timeoutSeconds: 2
          successThreshold: 1
          failureThreshold: 3      # å¤±è´¥ 3 æ¬¡åä» Service ç§»é¤
        startupProbe:
          httpGet:
            path: /health
            port: 8000
            scheme: HTTP
          failureThreshold: 30     # æå¤éè¯ 30 æ¬¡
          periodSeconds: 5         # æ¯ 5 ç§ä¸æ¬¡ï¼å± 150 ç§å®¹å¿æ¢å¯å¨
          timeoutSeconds: 3
        securityContext:
          allowPrivilegeEscalation: false  # ç¦æ­¢ææ
          readOnlyRootFilesystem: true     # æ ¹æä»¶ç³»ç»åªè¯»
          capabilities:
            drop:
            - ALL                          # å é¤ææ Linux capabilities
          privileged: false
        volumeMounts:
        - name: tmp-volume
          mountPath: /tmp
        - name: config-volume
          mountPath: /app/config
          readOnly: true
      imagePullSecrets:
      - name: registry-secret  # å¦æä½¿ç¨ç§æéåä»åº
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app
                  operator: In
                  values:
                  - flask-app
              topologyKey: kubernetes.io/hostname  # é¿åææ Pod è°åº¦å°åä¸èç¹
      volumes:
      - name: tmp-volume
        emptyDir:
          medium: Memory  # ä½¿ç¨åå­å·ï¼æ´å¿«
          sizeLimit: 100Mi
      - name: config-volume
        configMap:
          name: flask-app-config
</code></pre>
<h3 id="service">Service</h3>
<pre><code class="language-yaml">apiVersion: v1
kind: Service
metadata:
  name: flask-app-service
  namespace: default
  labels:
    app: flask-app
    tier: backend
spec:
  type: ClusterIP
  selector:
    app: flask-app
  ports:
  - name: http
    port: 80        # Service ç«¯å£
    targetPort: 8000  # Pod ç«¯å£
    protocol: TCP
</code></pre>
<h3 id="ingress-nginx">ingress-nginx</h3>
<pre><code class="language-yaml">apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: flask-app-ingress
  namespace: default
  annotations:
    # ==================== Nginx éç½® ====================
    kubernetes.io/ingress.class: "nginx"
    
    # å¯ç¨ HTTPS éå®å
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    
    # éæµï¼æ¯ç§ 10 ä¸ªè¯·æ±ï¼çªå 20ï¼
    nginx.ingress.kubernetes.io/limit-rps: "10"
    nginx.ingress.kubernetes.io/limit-burst-multiplier: "2"
    
    # å®¢æ·ç«¯çå® IP
    nginx.ingress.kubernetes.io/enable-real-ip: "true"
    nginx.ingress.kubernetes.io/proxy-real-ip-cidr: "0.0.0.0/0"
    
    # è¿æ¥è¶æ¶
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "60"
    
    # ç¼å²åºå¤§å°
    nginx.ingress.kubernetes.io/proxy-buffering: "on"
    nginx.ingress.kubernetes.io/proxy-buffer-size: "16k"
    nginx.ingress.kubernetes.io/proxy-buffers-number: "4"
    
    # Gzip åç¼©
    nginx.ingress.kubernetes.io/enable-gzip: "true"
    nginx.ingress.kubernetes.io/gzip-level: "6"
    nginx.ingress.kubernetes.io/gzip-min-length: "1024"
    nginx.ingress.kubernetes.io/gzip-types: "text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript"
    
    # å®å¨å¤´
    nginx.ingress.kubernetes.io/configuration-snippet: |
      add_header X-Frame-Options "SAMEORIGIN" always;
      add_header X-Content-Type-Options "nosniff" always;
      add_header X-XSS-Protection "1; mode=block" always;
      add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # è®¤è¯
    # nginx.ingress.kubernetes.io/auth-type: basic
    # nginx.ingress.kubernetes.io/auth-secret: flask-app-basic-auth
    # nginx.ingress.kubernetes.io/auth-realm: "Authentication Required"
    
    # èªå®ä¹éè¯¯é¡µé¢
    # nginx.ingress.kubernetes.io/custom-http-errors: "404,500,502,503,504"
    # nginx.ingress.kubernetes.io/default-backend: custom-error-pages
    
    # éåç®æ 
    # nginx.ingress.kubernetes.io/rewrite-target: /$1
    
    # WAFï¼å¦æå®è£äº ModSecurityï¼
    # nginx.ingress.kubernetes.io/enable-modsecurity: "true"
    # nginx.ingress.kubernetes.io/modsecurity-snippet: |
    #   SecRuleEngine On
    #   SecRequestBodyAccess On

spec:
  tls:
  - hosts:
    - flask.example.com
    secretName: flask-app-tls-secret  # TLS è¯ä¹¦ Secret

  rules:
  - host: flask.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: flask-app-service
            port:
              number: 80
</code></pre>


</div>
<div id="MySignature" role="contentinfo">
    <p>æ¬ææ¥èªåå®¢å­ï¼ä½èï¼<a href="https://www.cnblogs.com/XY-Heruo/" target="_blank">è±ééä½ç°</a>ï¼è½¬è½½è¯·æ³¨æåæé¾æ¥ï¼<a href="https://www.cnblogs.com/XY-Heruo/p/19615176" target="_blank">https://www.cnblogs.com/XY-Heruo/p/19615176</a></p>
</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-02-14 13:20">2026-02-14 13:19</span>&nbsp;
<a href="https://www.cnblogs.com/XY-Heruo">è±ééä½ç°</a>&nbsp;
éè¯»(<span id="post_view_count">69</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19615176);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19615176', targetLink: 'https://www.cnblogs.com/XY-Heruo/p/19615176', title: 'Flask - å¸¸è§åºç¨é¨ç½²æ¹æ¡' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ âFatal error: require(): Failed opening required...â ä»¥åå¦ä½å½»åºé¿åå®åæ¬¡åºç° ]]></title>
    <link>https://www.cnblogs.com/catchadmin/p/19614589</link>
    <guid>40b642f78e544658206e05caf53ad66c</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/catchadmin/p/19614589" title="åå¸äº 2026-02-14 09:22">
    <span role="heading" aria-level="2">âFatal error: require(): Failed opening required...â ä»¥åå¦ä½å½»åºé¿åå®åæ¬¡åºç°</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h1 id="fatal-error-require-failed-opening-required-ä»¥åå¦ä½å½»åºé¿åå®åæ¬¡åºç°">âFatal error: require(): Failed opening required...â ä»¥åå¦ä½å½»åºé¿åå®åæ¬¡åºç°</h1>
<p>åæ¨ä¸¤ç¹ï¼å¼ç­åè­¦åäºãçäº§ç¯å¢ API å¼å§æ¥ 500ï¼èä¸åªåºç°å¨æ°æ©å®¹çèç¹ä¸ãä½ æå¼æ¥å¿ï¼çæååºç¼çæ¥éè·³äºåºæ¥ï¼</p>
<p>æ¬å°ä¸åæ­£å¸¸ï¼æµè¯ç¯å¢ä¹æ²¡é®é¢ãä½å¨äºåçé¨ç½²è¿ç§âç¯å¢éæ¶ååâçç°å®éï¼ä¸ä¸ªçèµ·æ¥ä¸èµ·ç¼çè·¯å¾å·®å¼ï¼å°±è¶³ä»¥ææå¡ç´æ¥æè¶´ã</p>
<p>è¿å¹¶ä¸æ¯ä»ä¹âæ°æå¤±è¯¯âï¼èæ¯å¾å¤äººå¯¹ PHP æåºç¡è½åââæä»¶å è½½æºå¶ââçè§£ä¸å¤æ·±å¥å¯¼è´çç³»ç»æ§é®é¢ã</p>
<p>æ©æ PHP æ¶ä»£ï¼æä»¬æ <code>include</code> å <code>require</code> å½ç§¯æ¨ç¨æ¥æ¼é¡µé¢ãå°äº PHP 8.2+ãComposerãå®¹å¨åå¾®æå¡çä»å¤©ï¼è¿ç»å½æ°ä»ç¶å¨å¼ææ ¸å¿ä½ç½®ãä½ç°å®ä¸­ï¼å¾å¤å¼åèä¾æ§æå®ä»¬å½æâè®¾å®å°±ä¸ç¨ç®¡âçå·¥å·ã</p>
<p>å¦æä½ æ³ä»âåèæ¬âèµ°åâåç¨³å®ç³»ç»âï¼å°±å¿é¡»ææ¸æ¥ï¼å½ä¸ä¸ªæä»¶è¢«å è½½è¿å¦ä¸ä¸ªæä»¶æ¶ï¼åºå±å°åºåçäºä»ä¹ã</p>
<p>è¿ç¯æç« ä¼ä»è¿è¡æºå¶ãçº¿ä¸å¸¸è§ååå·¥ç¨å®è·µä¸å±ï¼è®²æ¸æ¥ææ ·æ PHP æä»¶å è½½åå°è¶³å¤ç¨³ã</p>
<h2 id="åºå±å°åºå¨åçä»ä¹">åºå±å°åºå¨åçä»ä¹ï¼</h2>
<p>å½ä½ æ§è¡ <code>include 'file.php'</code>ï¼å¹¶ä¸æ¯âå¤å¶ç²è´´ä»£ç âè¿ä¹ç®åãPHP å®éä¸ä¼è®©å½åæ§è¡æµç¨æåï¼åæ¢å°ç®æ æä»¶ï¼æå®ç¼è¯ä¸ºæä½ç ï¼åå¨å½åä½ç¨åéæ§è¡ã</p>
<h3 id="æä»¶å è½½çåç§å½¢å¼">æä»¶å è½½çåç§å½¢å¼</h3>
<p>PHP æåç§ä¸»å è½½æ¹å¼ï¼å®ä»¬ä¸æ¯è¯­æ³ç³ï¼èæ¯è¡ä¸ºå·®å¼ï¼</p>
<ul>
<li><code>include</code>ï¼æ¸©åæ¨¡å¼ãæä»¶ä¸å­å¨æ¶æ <code>Warning</code>ï¼èæ¬ç»§ç»­æ§è¡ã</li>
<li><code>require</code>ï¼å¼ºå¶æ¨¡å¼ãæä»¶ä¸å­å¨æ¶ç´æ¥è´å½éè¯¯å¹¶ä¸­æ­æ§è¡ã</li>
<li><code>include_once</code> / <code>require_once</code>ï¼å¨åä¸¤èåºç¡ä¸å¢å âæ¯å¦å·²å è½½âæ£æ¥ï¼é¿åéå¤å£°æã</li>
</ul>
<p>çè§£è¿ä¸ªå·®å¼éå¸¸å³é®ï¼å¨ç°ä»£ä¸å¡ç³»ç»éï¼å¾å¤æ ¸å¿ä¾èµä¸æ¦ç¼ºå¤±ï¼ä¸åºè¯¥âå¸¦ä¼¤ç»§ç»­è·âã</p>
<h3 id="ä¸ä¸ªæ´å®ç¨çå¿æºæ¨¡åä½ç¨åæ³¨å¥å¨">ä¸ä¸ªæ´å®ç¨çå¿æºæ¨¡åï¼ä½ç¨åæ³¨å¥å¨</h3>
<p>å¯ä»¥ææä»¶å è½½çè§£æâä½ç¨åæ³¨å¥å¨âï¼</p>
<ul>
<li>å¨å½æ°åé¨ <code>include</code>ï¼è¢«å è½½æä»¶éå®ä¹çåéåªå¨è¯¥å½æ°ä½ç¨åå¯è§ã</li>
<li>å¨èæ¬é¡¶å± <code>include</code>ï¼åéä¼è¿å¥å¨å±ä½ç¨åã</li>
</ul>
<p>å¦å¤ï¼å¾å¤äººè¯¯å¤æ§è½ç¶é¢ãçæ­£éçéå¸¸ä¸æ¯ä»£ç æ§è¡æ¬èº«ï¼èæ¯æä»¶ç¶ææ£æ¥ï¼stat è°ç¨ï¼ï¼</p>
<p>æ¯æ¬¡ <code>include</code>ï¼PHP é½è¦åæä½ç³»ç»ç¡®è®¤ï¼æä»¶æ¯å¦å­å¨ãæéæ¯å¦å¯è¯»ãæåä¿®æ¹æ¶é´ç­ãå¨é«å¹¶å API ä¸­ï¼è¿ä¸ªå¨ä½æ¯ç§æåä¸ä¸æ¬¡æ¶ï¼å¼éä¼éå¸¸ææ¾ã</p>
<h2 id="php-æ¯å¦ä½è§£æè·¯å¾ç">PHP æ¯å¦ä½è§£æè·¯å¾ç</h2>
<p>å½ä½ å <code>include 'utils.php';</code> è¿ç§ç¸å¯¹è·¯å¾æ¶ï¼PHP ä¼ä¾æ¬¡å°è¯ï¼</p>
<ul>
<li>å½åèæ¬ç®å½</li>
<li><code>php.ini</code> ä¸­ <code>include_path</code> æå®çç®å½</li>
<li>å½åå·¥ä½ç®å½ï¼cwdï¼</li>
</ul>
<p>é®é¢å°±åºå¨è¿éï¼å®æç¯å¢ä¾èµã</p>
<p>æ¯å¦ä½ çå½ä»¤è¡ä»»å¡è¿ç¨å·¥ä½ç®å½æ¯ <code>/var/www/</code>ï¼è Web è¿ç¨å·¥ä½ç®å½æ¯ <code>/var/www/public/</code>ï¼åä¸è¡ç¸å¯¹è·¯å¾ä»£ç å¯è½ä¸ä¸ªè½è·ãä¸ä¸ªç´æ¥å´©ã</p>
<h2 id="æå®¹ææçº¿ä¸æå´©ç-5-ç±»éè¯¯">æå®¹ææçº¿ä¸æå´©ç 5 ç±»éè¯¯</h2>
<p>è¿äºæ¯æå¨éçé¡¹ç®éæéåå¤è§å°çé«é¢é®é¢ã</p>
<h3 id="ç¸å¯¹è·¯å¾é·é±">ç¸å¯¹è·¯å¾é·é±</h3>
<p><strong>éè¯¯åæ³</strong>ï¼<code>include 'includes/header.php';</code></p>
<p><strong>ä¸ºä»ä¹ä¼åç</strong>ï¼æ¬å°å¯å¨ç®å½åå¥½æ¯é¡¹ç®æ ¹ç®å½ï¼æä»¥ä¸ç´âçèµ·æ¥æ­£å¸¸âã</p>
<p><strong>çº¿ä¸åæ</strong>ï¼ä¸æ¦è¢«å­ç®å½è°ç¨ãè¢«å®æ¶ä»»å¡è°ç¨ï¼æèå¥å£ç®å½åäºï¼è·¯å¾ä¸ä¸æå°±åäºãè¿æ¯âææ¬å°æ²¡é®é¢âç±»äºæçå¤´å·æ¥æºã</p>
<h3 id="_once-çæ§è½ç¨"><code>_once</code> çæ§è½ç¨</h3>
<p><strong>éè¯¯åæ³</strong>ï¼å¨é«é¢å¾ªç¯éå¤§éä½¿ç¨ <code>require_once</code>ã</p>
<p><strong>ä¸ºä»ä¹ä¼åç</strong>ï¼æå¿ <code>Cannot redeclare class</code> ä¹ç±»çéå¤å£°æã</p>
<p><strong>çº¿ä¸åæ</strong>ï¼æ¯æ¬¡ <code>_once</code> é½ä¼è§¦åå·²å è½½è¡¨æ£æ¥ãPHP 8 è½ç¶ä¼åäºå¾å¤ï¼ä½å®ä¾ç¶æ¯ç´ <code>require</code> æ¢ãä¾èµå³ç³»æ¸æ°çæ¨¡ååç³»ç»ï¼ä¸è¯¥é¿æä¾èµå¼æâäºæ¬¡ç¡®è®¤âã</p>
<h3 id="ç¨--ææ¥ééé³">ç¨ <code>@</code> ææ¥ééé³</h3>
<p><strong>éè¯¯åæ³</strong>ï¼<code>@include 'optional_config.php';</code></p>
<p><strong>ä¸ºä»ä¹ä¼åç</strong>ï¼æ³çæ <code>if (file_exists(...))</code> çæ¾å¼å¤æ­ã</p>
<p><strong>çº¿ä¸åæ</strong>ï¼ä½ æçæ­£é®é¢èèµ·æ¥äºãæä»¶è¯»åå¤±è´¥å¯è½ä¸æ¯âæä»¶ä¸å­å¨âï¼èæ¯æéä¸å¯¹ï¼å¦ <code>chmod</code>ï¼ãæ¥éè¢«åæåï¼æéæ¶é´ä¼ä» 5 åéæå°å å°æ¶ã</p>
<h3 id="å¨æ-include-å¼åè·¯å¾ç©¿è¶">å¨æ include å¼åè·¯å¾ç©¿è¶</h3>
<p><strong>éè¯¯åæ³</strong>ï¼<code>include $_GET['page'] . '.php';</code></p>
<p><strong>ä¸ºä»ä¹ä¼åç</strong>ï¼å¾çäºåâå¨æè·¯ç±âã</p>
<p><strong>çº¿ä¸åæ</strong>ï¼ä¸¥éå®å¨é£é©ãæ»å»èå¯æé  <code>../../../../etc/passwd</code>ï¼æå©ç¨ <code>php://filter/...</code> è¯»åææéç½®ãå³ä½¿å³é­è¿ç¨ URL å è½½ï¼æ¬å°æä»¶åæ ·ä¼è¢«æ»å»ã</p>
<h3 id="å è½½å¸¦å¯ä½ç¨çæä»¶">å è½½å¸¦å¯ä½ç¨çæä»¶</h3>
<p><strong>éè¯¯åæ³</strong>ï¼ä¸ä¸ªæä»¶æ¢å®ä¹ç±»ï¼åç´æ¥æ§è¡é»è¾ï¼è¾åº HTMLãè¿æ°æ®åºç­ï¼ã</p>
<p><strong>ä¸ºä»ä¹ä¼åç</strong>ï¼åå²ä»£ç éèè´£è¾¹çæ²¡åæ¸ã</p>
<p><strong>çº¿ä¸åæ</strong>ï¼æµè¯å ä¹æ²¡æ³åãä½ åªæ¯æ³æµè¯ç±»å®ä¹ï¼å´è¢«è¿«è§¦åæ°æ®åºè¿æ¥åé¡µé¢è¾åºã</p>
<h2 id="æ­£ç¡®åæ³php-8">æ­£ç¡®åæ³ï¼PHP 8+ï¼</h2>
<p>å¨ç°ä»£é¡¹ç®éï¼ç±»å è½½éå¸¸ç± Composer + PSR-4 èªå¨å è½½å¤çï¼<code>include</code>/<code>require</code> æ´å¤ç¨äºéç½®ãæ¨¡æ¿åå°éæ¨¡åé»è¾ã</p>
<p>ä½å³ä¾¿å¦æ­¤ï¼ä¹å»ºè®®å®ä½ä¸é¢ä¸æ¡ã</p>
<h3 id="å§ç»ä½¿ç¨ç»å¯¹éç¹è·¯å¾">å§ç»ä½¿ç¨ç»å¯¹éç¹è·¯å¾</h3>
<p>æè·¯å¾åºå®å¨å·²ç¥æ ¹ä¸ã<code>__DIR__</code> æ°¸è¿æåâå½åæä»¶æå¨ç®å½âï¼ä¸ä¼éå·¥ä½ç®å½ååã</p>
<p><strong>éè¯¯ç¤ºä¾ï¼èå¼±ï¼</strong></p>
<pre><code class="language-php">&lt;?php
// å¦æä» public/ ç®å½å¯å¨ï¼è¿éå¯è½å¤±è´¥
require 'config/settings.php';
</code></pre>
<p><strong>æ­£ç¡®ç¤ºä¾ï¼ç¨³å®ï¼</strong></p>
<pre><code class="language-php">&lt;?php
// æ è®ºä»åªéè°ç¨ï¼é½è½ç¨³å®è§£æ
require __DIR__ . '/config/settings.php';
</code></pre>
<h3 id="åç¨å è½½è¿åå¼">åç¨å è½½è¿åå¼</h3>
<p>è¿æ¯ PHP éç»å¸¸è¢«å¿½ç¥ä½éå¸¸å®ç¨çè½åï¼è¢«å è½½æä»¶å¯ä»¥ <code>return</code> å¼ã</p>
<p><code>config.php</code></p>
<pre><code class="language-php">&lt;?php
return [
    'db' =&gt; [
        'host' =&gt; '127.0.0.1',
        'pass' =&gt; $_ENV['DB_PASS'] ?? 'root',
    ],
    'debug' =&gt; false,
];
</code></pre>
<p><code>app.php</code></p>
<pre><code class="language-php">&lt;?php
$config = require __DIR__ . '/config.php';
// $config æ¯å±é¨åéï¼ä¸æ±¡æå¨å±
</code></pre>
<h3 id="å³é®ç»ä»¶è¦åé²å¾¡å¼å è½½">å³é®ç»ä»¶è¦åé²å¾¡å¼å è½½</h3>
<p>å¯¹äºå¿é¡»å­å¨çæä»¶ï¼ä¸è¦ä¾èµé»è®¤æ¥éï¼èªå·±æé¢æåæ¸æ¥ã</p>
<pre><code class="language-php">&lt;?php
$templatePath = __DIR__ . '/views/header.php';
if (!file_exists($templatePath)) {
    throw new \RuntimeException("å³é®è§å¾ç»ä»¶ç¼ºå¤±: {$templatePath}");
}
require $templatePath;
</code></pre>
<h2 id="çäº§ç¯å¢æ³¨æç¹æ©ç¼©å®¹ä¸å®å¨">çäº§ç¯å¢æ³¨æç¹ï¼æ©ç¼©å®¹ä¸å®å¨</h2>
<p>å½ç³»ç»ä»åæºèµ°å°å®¹å¨éç¾¤æå½æ°è®¡ç®ï¼æä»¶å è½½ä¸ååªæ¯ä»£ç ç»èï¼èæ¯åºç¡è®¾æ½é®é¢ã</p>
<h3 id="å®å¨è·¯å¾ç©¿è¶é²æ¤">å®å¨ï¼è·¯å¾ç©¿è¶é²æ¤</h3>
<p>å¾å¤âPHP ä¸å®å¨âçå°è±¡ï¼æ¬è´¨æ¯å è½½ç­ç¥ä¸å®å¨ã</p>
<ul>
<li><strong>ç½ååï¼Allow-listï¼</strong>ï¼ç»ä¸ç´æ¥ä¿¡ä»»ç¨æ·è¾å¥æ¼è·¯å¾ã</li>
<li><strong><code>basename()</code></strong>ï¼ç¡®å®éè¦ç¨è¾å¥å¼æ¶ï¼ååè·¯å¾çæ®µæ¸æ´ï¼æ¦æª <code>../</code> ç©¿è¶ã</li>
<li><strong><code>open_basedir</code></strong>ï¼å¨ <code>php.ini</code> éå¶ PHP å¯è®¿é®è·¯å¾èå´ï¼é²æ­¢è¶çè¯»åã</li>
</ul>
<h3 id="æ§è½opcache-æ¯åºç¡è®¾æ½èä¸æ¯å¯éé¡¹">æ§è½ï¼OPcache æ¯åºç¡è®¾æ½èä¸æ¯å¯éé¡¹</h3>
<p>çäº§ç¯å¢åºå¼å¯ OPcacheãå®ä¼æé¢ç¼è¯åçå­èç æ¾åå­ï¼é¿åæ¯æ¬¡è¯·æ±éå¤è§£ææä»¶ã</p>
<p><strong>é¨ç½²æç¤º</strong>ï¼å¨é«å¹¶åéç¾¤ä¸­å¯ä»¥èè <code>opcache.validate_timestamps=0</code>ï¼æ¢åæ´å¿«å è½½éåº¦ï¼ä½è¿æå³çæ¯æ¬¡åå¸é½å¿é¡»åå¹³æ»éè½½ï¼å¦åä»£ç æ´æ°ä¸ä¼çæã</p>
<h3 id="å¯è§æµæ§å¤±è´¥å¿é¡»å¯è¿½è¸ª">å¯è§æµæ§ï¼å¤±è´¥å¿é¡»å¯è¿½è¸ª</h3>
<p>æä»¶å è½½å¤±è´¥ä¸åºåªçä¸ä¸ä¸ªâç½å±âæ 500ã</p>
<ul>
<li><strong>å¯è¿½è¸ªä¿¡æ¯</strong>ï¼æ¥å¿è³å°è¦åå« <code>include_path</code> ä¸ <code>cwd</code>ã</li>
<li><strong>çæ§ç­ç¥</strong>ï¼å¯¹ <code>E_COMPILE_ERROR</code> åä¸é¨åè­¦ï¼è¿ç±»é®é¢éå¸¸ä¸åå¸æç¯å¢å·®å¼æå³ï¼éä¼ååæ»ã</li>
</ul>
<h3 id="é¨ç½²å½¢æå·®å¼å®¹å¨-vs-å½æ°è®¡ç®">é¨ç½²å½¢æå·®å¼ï¼å®¹å¨ vs å½æ°è®¡ç®ï¼</h3>
<p>å®¹å¨éåéæä»¶è·¯å¾éå¸¸åºå®å¯é¢æµï¼å½æ°è®¡ç®ç¯å¢å¸¸è§åªè¯»æä»¶ç³»ç»ãç®å½æ å°ååãç»ä¸ä½¿ç¨ <code>__DIR__</code> è½æ¾èéä½ç¯å¢å·®å¼å¸¦æ¥çè·¯å¾é®é¢ã</p>
<h2 id="çå®äºæç©ºéç½®å¹½çµ">çå®äºæï¼"ç©ºéç½®"å¹½çµ</h2>
<p>ææ¾åä¸ææ¥è¿ä¸ä¸ªæ¯ä»ä¸å¡äºæï¼åå°ä»»å¡éæºå¤±è´¥ãé®é¢æ ¹å æ¯ä»ä»¬ç¨ <code>include</code> å è½½ç¯å¢éç½®ã</p>
<p>ææ¬¡åå¸èæ¬æ¼æ·äºçäº§éç½®æä»¶ãå ä¸ºæ¯ <code>include</code>ï¼è¿ç¨æ²¡æå´©ï¼ä¸å¡ç»§ç»­è·ï¼åªæ¯æ¿å°ä¸ä¸ªç©ºç <code>$config</code>ã</p>
<p>ç»ææ¯ä»»å¡å¸¦çç©º API å¯é¥è¿ç»­è¿è¡äº 6 å°æ¶ï¼é æå¤§éäº¤æå¤±è´¥ã</p>
<p>å¦æå½æ¶ä½¿ç¨çæ¯ <code>require</code>ï¼ä»»å¡ä¼ç¬¬ä¸æ¶é´ä¸­æ­å¹¶è§¦ååè­¦ï¼æå¤±ä¼å°å¾å¤ã</p>
<p>ä¸å¥è¯ï¼<strong>æ²¡æå®ç³»ç»å°±ä¸è½æ´»ï¼é£å°±å¿é¡» <code>require</code>ã</strong></p>
<h2 id="æéæ¸åçå°-failed-opening-required-æ¶ç´æ¥ç§å">æéæ¸åï¼çå° Failed opening required æ¶ç´æ¥ç§åï¼</h2>
<ol>
<li>
<p><strong>æå°ç»å¯¹è·¯å¾</strong>ï¼<br>
<code>var_dump(realpath(__DIR__ . '/your-file.php'));</code><br>
è¥è¿å <code>false</code>ï¼è¯´ææä»¶æ ¹æ¬ä¸å¨ä½ ä»¥ä¸ºçä½ç½®ã</p>
</li>
<li>
<p><strong>ç¡®è®¤è¿è¡èº«ä»½</strong>ï¼<br>
<code>echo exec('whoami');</code><br>
çå½åç³»ç»ç¨æ·æ¯å¦æè¯»æéã</p>
</li>
<li>
<p><strong>ææ¥éèè¯­æ³éè¯¯</strong>ï¼<br>
æäºæä»¶ä¸æ¯âä¸å­å¨âï¼èæ¯è¯­æ³éè¯¯å¯¼è´å è½½å¤±è´¥ã<br>
ç¨å½ä»¤è¡æ§è¡ï¼<code>php -l filename.php</code>ã</p>
</li>
<li>
<p><strong>æ£æ¥ PHP å¼å§æ ç­¾</strong>ï¼<br>
æä»¶åºä»¥ <code>&lt;?php</code> å¼å¤´ãè¥ç­æ ç­¾å³é­èä½ åäº <code>&lt;?</code>ï¼åç»­å¯è½åºç°åç§è¯¡å¼é®é¢ï¼å¦ header å·²åéï¼ã</p>
</li>
</ol>
<h2 id="æ´ä¸ä¸çå è½½å°è£ç¤ºä¾">æ´ä¸ä¸çå è½½å°è£ç¤ºä¾</h2>
<p>ä¸è¦é¿æä¾èµè£¸ <code>var_dump</code>ãå»ºè®®ç¨ç»æåæ¥å¿åç»ä¸åè£ã</p>
<pre><code class="language-php">&lt;?php
/**
 * å¸¦å¯è§æµæ§çæä»¶å è½½å¨
 * å¼åç¯å¢è¦âåäº®å¤±è´¥âï¼çäº§ç¯å¢å¯æ§éçº§ã
 */
function load_component(string $filePath, array $context = []): mixed
{
    $absolutePath = realpath($filePath);
    if (!$absolutePath || !file_exists($absolutePath)) {
        error_log(sprintf(
            "[FileLoader] Failure: %s | CWD: %s | User: %s",
            $filePath,
            getcwd(),
            get_current_user()
        ));

        if (getenv('APP_DEBUG') === 'true') {
            throw new \Exception("ç»ä»¶ä¸å­å¨: {$filePath}");
        }

        return null; // çäº§ç¯å¢æçº¦å®éçº§
    }

    extract($context);
    return require $absolutePath;
}
</code></pre>
<h2 id="å¸¸è§é®é¢">å¸¸è§é®é¢</h2>
<h3 id="qrequire_once-ä¸å®æ¯-require-æ´å¥½å">Qï¼<code>require_once</code> ä¸å®æ¯ <code>require</code> æ´å¥½åï¼</h3>
<p>ä¸ä¸å®ã<code>require_once</code> æ´åæ¯ç»ç»ä¸æ¸æ°æ¶çå®å¨ç½ãä¾èµå³ç³»æç¡®ãèªå¨å è½½å¥å¨æ¶ï¼<code>require</code> æ´ç´æ¥ãæ§è½æ´å¥½ã</p>
<h3 id="qå¯ä»¥æ ¹æ®æ°æ®åºå¼å¨æ-include-æä»¶å">Qï¼å¯ä»¥æ ¹æ®æ°æ®åºå¼å¨æ include æä»¶åï¼</h3>
<p>å¯ä»¥ï¼ä½å¿é¡»éå¸¸è°¨æãæ¨èç½ååæ å°ï¼æ°æ®åºåªå­ IDï¼ä»£ç éæ ID æ å°å°åºå®è·¯å¾ï¼ä¸è¦æè·¯å¾åæå­è¿æ°æ®åºåç´æ¥å è½½ã</p>
<h3 id="qå è½½å¤§æä»¶ä¼ææ¢åºç¨å">Qï¼å è½½å¤§æä»¶ä¼ææ¢åºç¨åï¼</h3>
<p>å¼å¯ OPcache åï¼é¦æ¬¡ä¹ååºæ¬æ²¡æâè§£æâææ¬ï¼ä½æä»¶ä¸­çä¸å¡é»è¾ä»è¦æ§è¡ï¼ä¾æ§æ¶è CPU ååå­ãæä»¶åå®¹è¦èç¦ï¼é¿åæå¤§éæ å³é»è¾å¡å¨ä¸èµ·ã</p>
<h3 id="qæ¨¡æ¿æä»¶éåç¨-include-å">Qï¼æ¨¡æ¿æä»¶éåç¨ <code>include</code> åï¼</h3>
<p>å°é¡¹ç®å¯ä»¥ãä¸­å¤§åç³»ç»å»ºè®®ä½¿ç¨æçæ¨¡æ¿æ¹æ¡ï¼è½å¨å®å¨æ§åå¤ç¨æ§ä¸æ´ç¨³ã</p>
<h2 id="ç»è¯­">ç»è¯­</h2>
<p>æ <code>include</code> å <code>require</code> ç¨å¥½ï¼ä¸åªæ¯è¯­æ³é®é¢ï¼èæ¯å·¥ç¨è½åé®é¢ã</p>
<p>ä½ çä»£ç è¿è¡å¨æä½ç³»ç»ãæéæ¨¡åãç¼å­æºå¶åé¨ç½²æµæ°´çº¿å±åææçç¯å¢éãåªçè§£âæ¬å°è½è·âï¼è¿è¿ä¸å¤ã</p>
<h3 id="æä½³å®è·µå°ç»">æä½³å®è·µå°ç»</h3>
<ul>
<li><strong>å¿«éå¤±è´¥</strong>ï¼å³é®ä¾èµç»ä¸ä½¿ç¨ <code>require</code>ã</li>
<li><strong>è·¯å¾ç»å¯¹å</strong>ï¼é¿åç¸å¯¹è·¯å¾ï¼ä¼å <code>__DIR__</code>ã</li>
<li><strong>ä½ç¨åæ¶æ</strong>ï¼ç¨ <code>return</code> è¿åéç½®ï¼é¿åå¨å±åéæ±¡æã</li>
<li><strong>å¤±è´¥å¯è§æµ</strong>ï¼æå è½½å¤±è´¥å½æä¸ç±»å³é®ç³»ç»äºä»¶å¤çã</li>
</ul>
<h3 id="ä½ çä¸ä¸æ­¥">ä½ çä¸ä¸æ­¥</h3>
<p>ç°å¨å°±æå¼é¡¹ç®ï¼å¨å±æç´¢ <code>include</code> / <code>require</code>ï¼</p>
<p>å¡æ¯ä¸ä»¥ <code>__DIR__</code> æç»ä¸æ ¹è·¯å¾å¸¸éå¼å¤´çï¼ä»å¤©å°±æ¹ã</p>
<p>è¿ä¸æ­¥åå®ï¼ä½ ççäº§ç¯å¢å°±ä¼å°ä¸ç±»é«æ¦çäºæã<br>
<a href="https://catchadmin.com/post/2026-02/fatal-error-require-failed-opening-required" target="_blank" rel="noopener nofollow">Fatal error: require(): Failed opening required...ââä»¥åå¦ä½å½»åºé¿åå®åæ¬¡åºç°</a></p>


</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-02-14 09:22">2026-02-14 09:22</span>&nbsp;
<a href="https://www.cnblogs.com/catchadmin">JaguarJack</a>&nbsp;
éè¯»(<span id="post_view_count">49</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19614589);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19614589', targetLink: 'https://www.cnblogs.com/catchadmin/p/19614589', title: 'âFatal error: require(): Failed opening required...â ä»¥åå¦ä½å½»åºé¿åå®åæ¬¡åºç°' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ [æè§£LangChainæ§è¡å¼æ] ManagedValueââä¸ç§ç¹æ®çåªè¯»èæéé ]]></title>
    <link>https://www.cnblogs.com/jaydenai/p/19614333/managed-value</link>
    <guid>408a09fd1f3a1a4857ce079f70c1249f</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/jaydenai/p/19614333/managed-value" title="åå¸äº 2026-02-14 07:57">
    <span role="heading" aria-level="2">[æè§£LangChainæ§è¡å¼æ] ManagedValueââä¸ç§ç¹æ®çåªè¯»èæéé</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                    <div id="cnblogs_post_description" style="display: none">
        
        æä»¬ä¸ç´å¨å¼ºè°Pregelå¯¹è±¡çç¶ææ¯éè¿`Channel`ç»´æ¤åä¼ éçï¼å¶å®æ¿è½½ä¼ éç¶æåè½çç»ä»¶é¤äºChannelï¼è¿æ  `ManagedValue`ï¼æä»¬å¯ä»¥å°ManagedValueè§ä¸ºèæChannelã
    </div>
<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<p>æä»¬ä¸ç´å¨å¼ºè°Pregelå¯¹è±¡çç¶ææ¯éè¿<code>Channel</code>ç»´æ¤åä¼ éçï¼å¶å®æ¿è½½ä¼ éç¶æåè½çç»ä»¶é¤äºChannelï¼è¿æ  <code>ManagedValue</code>ãæä»¬å¯ä»¥å°ManagedValueè§ä¸ºèæChannelï¼Nodeä¸ä»éç¨ä¸è¯»åChannelå®å¨ä¸æ ·çæ¹å¼è¯»åManagedValueï¼èä¸æ³¨åçManagedValueä¹ç´æ¥å­æ¾å¨Pregelçchannelså­æ®µä¸­ã</p>
<p>å¦ææä»¬ä»ç»æ¥çPregelç±»çå®ä¹ï¼å¯ä»¥çåºå¶<code>channels</code>å­æ®µè¿åä¸ä¸ªå­å¸ï¼å­å¸çå¼çç±»åèåäºBaseChannelå<code>ManagedValueSpec</code>ä¸¤ç§ç±»åï¼åèæ¯Channelçåºç±»ï¼åèå°±æ¯<code>ManagedValue</code>ç±»çå«åã</p>
<pre><code class="language-python">class Pregel(
    PregelProtocol[StateT, ContextT, InputT, OutputT],
    Generic[StateT, ContextT, InputT, OutputT]): 
    channels : dict[str, BaseChannel | ManagedValueSpec]

ManagedValueSpec = type[ManagedValue]
</code></pre>
<p>å¦æè¯´Channelå­å¨çæ¯çä¸å¡ç¶æï¼é£ä¹ManagedValueä¼ éçå°±æ¯Pregelè¿ä¸ªæ§è¡å¼æçè¿è¡æ¶ç¶æãä¸è¬æ¥è¯´ï¼ManagedValueèªèº«ä¸è´è´£å­å¨ç¶æï¼å¶æä¾çå¼å¯ä»¥å®æ¶è®¡ç®å¾åºï¼æä»¥å®ä¸åä¸åºäºCheckpointçæä¹åãä»å¦ä¸æç¤ºçä»£ç çæ®µå¯ä»¥çåºï¼ManagedValueä»ä»å®ä¹äºä¸ä¸ªå¯ä¸çéææ½è±¡æ¹æ³<code>get</code>è¿åå¯¹åºçå¼ï¼ç±äºä½ä¸ºè¾å¥ç<code>PregelScratchpad</code>å¯¹è±¡æä¾çä¿¡æ¯æéï¼æä»¥ManagedValueè½å¤åæ¥çç©ºé´å¶å®å¾æéï¼å¨å¤§é¨åæåµä¸ç¨ä¸å°å®ã</p>
<pre><code class="language-python">class ManagedValue(ABC, Generic[V]):
    @staticmethod
    @abstractmethod
    def get(scratchpad: PregelScratchpad) -&gt; V: ...
</code></pre>
<h2 id="1-pregelscratchpad">1. PregelScratchpad</h2>
<p>ManagedValueæä¾çå¼æ¯éè¿å¶getæ¹æ³æ ¹æ®PregelScratchpadå¯¹è±¡è®¡ç®æå¾ãå½ç¡®å®åç»­å¾æ§è¡çNodeåï¼å¼æä¼ä¸ºæ¯ä¸ªNodeåå»ºä¸ä¸ªä»»å¡ï¼æ¯ä¸ªä»»å¡é½ä¼éå ä¸ä¸ªPregelScratchpadå¯¹è±¡ãPregelScratchpadç<code>step</code>å<code>stop</code>å­æ®µå°±è¿åå½åSuperstepçåºå·åéå¯¹è¿­ä»£çéå¶ï¼æå¤§è¶æ­¥æ°ï¼ï¼å¶å®å­æ®µä¸æä¹åæå³ã</p>
<pre><code class="language-python">@dataclasses.dataclass(**_DC_KWARGS)
class PregelScratchpad:
    step : int
    stop : int
    call_counter : Callable[[], int]
    interrupt_counter : Callable[[], int]
    get_null_resume	: Callable[[bool], Any]
    resume : list[Any]
    subgraph_counter	: Callable[[], int]	
</code></pre>
<p>PregelScratchpadç<code>call_counter</code>ã<code>interrupt_counter</code>å<code>subgraph_counter</code>å­æ®µä»¥é­åçå½¢å¼è¿åä¸ä¸ªè®¡æ°å¨ã<code>call_counter</code>è®¡æ°å¨ç¨äºä¸ºå½åSuperstepåäº§ççææä»»å¡åéå¯ä¸çåé¨åºåå·ã</p>
<h3 id="11-resume-valueåä¸­æ­è®¡æ°å¨">1.1 Resume Valueåä¸­æ­è®¡æ°å¨</h3>
<p><code>interrupt_counter</code>ã<code>get_null_resume</code>å<code>resume</code>å­æ®µä¸Pregelåºäº âä¸­æ­ï¼Interruptï¼/æ¢å¤ï¼Resumeï¼â çæ§è¡æ¹å¼æå³ãåè®¾Pregelçå¯¹åºä¸ä¸ªéè¦äººå·¥ä»å¥çå¤çº§å®¡æ¹æµç¨ï¼å¨æ¯æ¬¡éè¦ä»¥äººå·¥ä»å¥çæ¹å¼æ¶éå®¡æ¹èå³å®çæ¶åï¼æµç¨è¿å¥ä¸ä¸ªä¸­æ­ï¼å½åçç¶æè¢«æä¹åãå½å®¡æ¹å³å®ç»åºåï¼æµç¨ä»¥ âæ¢å¤â çå½¢å¼å¼å§æ§è¡ï¼ä¸­æ­æ¶æä¹åçå¿«ç§è¢«æååºæ¥ âæ¢å¤ç°åºâ ï¼å®¡æ¹å³å®ä»¥Resume Valueçå½¢å¼æä¾ç»å¼æãä¸ºäºå¹éå¤ä¸ªä¸­æ­ç¹ä¸å¯¹åºçResume Valueï¼åèä¼æç§é¡ºåºè¢«æä¹åï¼å¹¶å¨æ¢å¤æ§è¡çæ¶åè¿åå½åæä¾çResume Valueä¸å¹¶å¡«åå°PregelScratchpadç<code>resume</code>åè¡¨ä¸­ã</p>
<p>æ¢å¤æ§è¡åä¸å°å¨ä¸­æ­ç¹åºå¼å§æ§è¡ï¼å®æ»æ¯<code>ä»å¤´æ§è¡</code>Nodeçå¤çå½æ°ï¼æä»¥å®ä¹ <code>å¹ç­Node</code> åºè¯¥æä¸ºAgentç¼ç¨ç âéç§çå¾âãç±äºPregelScratchpadçresumeå­æ®µä¼æç§ä¸­æ­çé¡ºåºå­æ¾Resume Valueï¼æä»¥å¨æ¢å¤æ§è¡çæ¶åï¼æ¯éå°ä¸ä¸ªä¸­æ­ï¼å¼æå¯ä»¥å©ç¨<code>interrupt_counter</code>å­æ®µè¿åçè®¡æ°å¨ä½ä¸ºä½ç½®ç´¢å¼ä»resumeåè¡¨ä¸­å°å¹éçResume Valueæååºæ¥ãå¦ææåçResume Valueä¸ºNoneï¼æèè®¡æ°å¨è¿åçç´¢å¼è¶çï¼<code>get_null_resume</code>å­æ®µæä¾çåè°å°±ä¼æ§è¡ãè¿ä¸ªåè°å½æ°å·æä¸ä¸ªboolç±»åçåæ°is_calledï¼è°ç¨æ¶è¯¥åæ°è¢«è®¾ç½®ä¸ºTrueï¼è¡¨ç¤ºè¯¥ä¸­æ­ç¡®å®è¢«è§¦åäºï¼ä½æ²¡æå¯¹åºçæ°æ®ãè¿ä¼æ¶èæè¿ä¸ªä¸­æ­ä½ï¼ç¡®ä¿æµç¨ä¸è³äºæ°¸è¿å¾ä¸å°æ¢å¤ã</p>
<h3 id="12-å­å¾è°ç¨è®¡æ°å¨">1.2 å­å¾è°ç¨è®¡æ°å¨</h3>
<p>å¦æè¯´<code>interrupt_counter</code>è®¡æ°å¨æ¨å¨è§£å³æ¯æ¬¡ä¸­æ­ä¸æä¾çResume Valueçå¹éé®é¢ï¼é£ä¹<code>subgraph_counter</code>è®¡æ°å¨è§£å³çæ¯æ¬¡âå­å¾è°ç¨âä¸å¯¹åºPregelå®ä¾çå¹éé®é¢ãå¦æç«å¨âå¾âçè§è§ï¼æ¯ä¸ªPregelå¯¹è±¡å°±æ¯ç±å¤ä¸ªNodeç»æçå¾ï¼èPregelä¹å¯ä»¥ä½ä¸ºä¸ä¸ªNodeåºç°å¨å¦ä¸ä¸ªPregelæå»ºçå¾ä¸­ï¼ä¸¤ä¸ªPregelä¹é´å°±ç§°ä¸ºäºâç¶å­âå³ç³»ï¼å­Pregelæå»ºçå¾å°±æ¯âå­å¾âï¼éå¯¹å®çè°ç¨å°±æ¯å­å¾è°ç¨ã</p>
<p>è½ç¶å¨åä¸ä¸ªå¾ä¸­ï¼æ¯ä¸ªPregelä¼ç¬èªå®æèªèº«çæä¹åãå¨æ¢å¤æ§è¡åºæ¯ä¸­ï¼å¼æä¼çåå è½½ä½ä¸ºâæ ¹âçPregelå¯¹åºçCheckpointæ¥æ¢å¤ç°åºãå½éå°âå­å¾âå½¢å¼è°ç¨å¦ä¸ä¸ªPregelæ¶ï¼å¼æä¼å è½½å¯¹åºçCheckpointæ¥æ¢å¤å­å¾å¨ä¸­æ­é£ä¸ªæ¶é´ç¹çç¶æãç°å¨é®é¢æ¥äºï¼å¨å­Pregelä¼å¤æä¹åçCheckpointä¸­ï¼æä¹ç¥éè¯¥å è½½åªä¸ä¸ªå¢ï¼</p>
<p>è¿ä¸ªé®é¢æ¬è´¨ä¸æ¯å¦ä½è§£å³ä½ä¸ºå­å¾æ§è¡çPregelå¨æ§è¡æä¹åæ¶ï¼å¦ä½å°çæçCheckpointä¸å½åæ§è¡ä¸ä¸æè¿è¡å¹éçé®é¢ï¼è¿ä¸ªé®é¢æ¯å©ç¨<code>Checkpointå½åç©ºé´</code>æ¥è§£å³çãNodeæ¯ä»¥ä»»å¡çå½¢å¼è¢«æ§è¡çï¼æ¯ä¸ªä»»å¡å·æå¯ä¸çIDï¼å¹¶ä¸å¨æ¢å¤æ¶ä¿æä¸åï¼å¦æå½åç©ºé´ç±æ§è¡é¾è·¯ä¸æ¯ä¸ªä»»å¡ç<code>èç¹åç§°+ä»»å¡ID</code>ç»æï¼é£ä¹å­å¾çCheckpointå°±è½å©ç¨æ­¤å½åç©ºé´å³èèµ·æ¥ã</p>
<p>ä½æ¯é®é¢è¿æ¯æ²¡æå®å¨è§£å³ï¼å¦æåä¸ä¸ªä»»å¡æ¶åéå¯¹<code>åä¸å­å¾çå¤æ¬¡è°ç¨</code>ï¼å¦å½åç©ºé´åªåå«åºäºä»»å¡çæ§è¡è·¯å¾ï¼æ­¤æ¶ä¸¤ä¸ªå­å¾ä¼å±äº«ç¸åçå½åç©ºé´ï¼å·ä½å¯¹åºåªä¸ªCheckpointä¾ç¶æ æ³è§£å³ãå æ­¤è¥æ¶ååä¸ä¸ªNodeéå¯¹åä¸ä¸ªPregelå¯¹è±¡çå¤æ¬¡è°ç¨ï¼æä¹åè¿ä¸ªPregelçCheckpointçå½åç©ºé´è¿åºè¯¥åå«<code>è°ç¨é¡ºåº</code>ã</p>
<p>Checkpointçå½åç©ºé´çè§åå¯ä»¥éè¿å¦ä¸è¿ä¸ªæ¼ç¤ºå®ä¾æ¥è¯å®ãå¦ä»£ç çæ®µæç¤ºï¼æä»¬åå»ºäºä¸ä¸ªç±åä¸Nodeç»æçPregelå¯¹è±¡ï¼sub_graphï¼ï¼å½åä¸º âbazâ çNodeå¨æ§è¡çæ¶åä¼ä»å½åçRunnableConfigéç½®ä¸­æåå¹¶è¾åºå½åçCheckpointå½åç©ºé´ã</p>
<pre><code class="language-python">from langgraph.pregel import Pregel, NodeBuilder
from langgraph.channels import LastValue
from langgraph.checkpoint.memory import InMemorySaver
from langgraph.pregel._write import ChannelWrite, ChannelWriteTupleEntry
from langgraph.types import RunnableConfig
from typing import Any

def handle(args:dict[str,Any], config:RunnableConfig)-&gt;None:
    print(config["configurable"]["checkpoint_ns"])
sub_node = (NodeBuilder()
    .subscribe_to("start")
    .do(handle))
sub_graph = Pregel(
    nodes={"baz": sub_node},
    channels={
        "start": LastValue(None),
    },
    input_channels=["start"],
    output_channels=[])

def handle1(args:dict[str,Any])-&gt;None:
    sub_graph.invoke(input={"start": None})

def handle2(args:dict[str,Any])-&gt;str:    
    sub_graph.invoke(input={"start": None})    
    sub_graph.invoke(input={"start": None})

foo = (NodeBuilder()
    .subscribe_to("foo")
    .do(handle1)
    .write_to(bar=None))
bar = (NodeBuilder()
    .subscribe_to("bar")
    .do(handle2))

graph = Pregel(
    nodes={"foo": foo, "bar": bar},
    channels={
        "foo": LastValue(None),
        "bar": LastValue(str),
    },
    input_channels=["foo"],
    output_channels=[],
    checkpointer= InMemorySaver())

config = {"configurable": {"thread_id": "123"}}
graph.invoke(input={"foo": None}, config=config)
</code></pre>
<p>å¨å¦ä¸ä¸ªPregelä¸­ï¼æä»¬ä¸ºå®è®¾ç½®äºä¸¤ä¸ªååæ§è¡çNodeï¼fooåbarï¼ï¼åèè°ç¨sub_graphä¸æ¬¡ï¼åèè°ç¨ä¸¤æ¬¡ãéå¯¹ä¸æ¬¡è°ç¨ï¼sub_graphä¸ºèªèº«æä¹åè®¾ç½®çCheckpointå½åä¼ä»¥å¦ä¸çå½¢å¼è¾åºï¼å¯ä»¥çåºå½åç©ºé´åæ¶ä½ç°äºè°ç¨é¾è·¯åæ¬¡åºã</p>
<pre><code>foo:36817c76-c3f7-643f-7924-0d29b39f469a|baz:311cc911-96a0-56b6-225b-28e4cece7cd9
bar:97be6a71-1b71-7364-e691-a122cfef1a92|baz:789287de-869f-42b8-dd03-7518820daaa6
bar:97be6a71-1b71-7364-e691-a122cfef1a92|1|baz:dd1ddd1b-fc62-b46a-c2ec-6a1d8344b793
</code></pre>
<p>åºäºPregelâä¸­æ­/æ¢å¤âçæ§è¡æ¹å¼ï¼è®©æä»¬å¯¹<code>Pregelå®ä¾</code>ä¼æç¹å«ççè§£ãæä»¬ä¹ æ¯äºå°ä¸ä¸ªéè¿è°ç¨æä¸ªç±»æé å½æ°åå»ºçå¯¹è±¡è§ä¸ºè¯¥ç±»åçä¸ä¸ªå®ä¾ï¼ä½æ¯å¨Nodeçå¤çå½æ°ä¸­ï¼å³ä½¿éå¯¹<code>åä¸Pregelå®ä¾</code>çè¿ç»­ä¸¤æ¬¡è°ç¨é½æå¯è½åºç°ä¸­æ­ï¼ä¸æ¦æ¢å¤æ§è¡ï¼åä¸ä¸ªå®ä¾å°±æå¯è½ä½¿æ ¹æ®å¦ä¸ä¸ªCheckpointçç¶æåå»ºçï¼å®èªç¶ä¹å°±ä¸æ¯åæ¥çé£ä¸ªå®ä¾äºãå¨ä¸æ­çâä¸­æ­/æ¢å¤âæ§è¡æµç¨ä¸­ï¼æè°<code>Pregelå®ä¾</code>ææ¶åè¡¨ç¤ºæ<code>å¯¹åºçCheckpoint</code>å¯è½æ´åç¡®ã</p>
<p>å¯¹äºåä¸ä¸ªèç¹ä»»å¡æ¥è¯´ï¼å¦ææ¶åéå¯¹åä¸ä¸ª<code>å­Pregel</code>çå¤æ¬¡è°ç¨ï¼ä»ç¬¬äºæ¬¡è°ç¨å¼å§ï¼å¯¹æ¹æä¹åçæçCheckpointä¼å°<code>è°ç¨æ¬¡åº</code>åå«å¨å½åç©ºé´ä¸­ãä¸ä¹ç¸å¯¹çï¼å¨æ¢å¤æ§è¡çæ¶åï¼ä¹éè¦æ ¹æ®å½åçæ§è¡ä¸ä¸ææä¾åå«æ­¤åºå·çå½åç©ºé´éç¨å è½½å¯¹åºçCheckpointï¼å¹¶æç»æ¢å¤å¯¹åºçPregelå¯¹è±¡ï¼PregelScratchpadçsubgraph_counterå­æ®µè¿åçè®¡æ°å¨å°±æ¯ä¸ºäºæä¾è¿ä¸ªåºå·ã</p>
<h2 id="2-ä¸¤ä¸ªåççmanagedvalue">2. ä¸¤ä¸ªåççManagedValue</h2>
<p>ç±äºManagedValueæè½æä¾çå¼æ¯æ ¹æ®PregelScratchpadè®¡ç®çæï¼èåèå¯ç¨çå¯æè¡¨ç¤ºå½ååæå¤§Superstepåºå·ç<code>step</code>å<code>stop</code>å­æ®µï¼æä»¥æä»¬éç¨ManagedValueçåºç¨åºæ¯å¶å®å¾çªãæä»åªæ¾å°å¦ä¸ä¸¤ä¸ªåççManagedValueç±»åï¼å®ä»¬é½å®ä¹å¨langgraph.managed.is_last_stepè¿ä¸ªåä¸­ãå¶ä¸­ä¸ä¸ª<code>IsLastStepManager</code>ç¨äºå¤æ­æ¯å¦ä¸ºæåä¸ä¸ªSuperstepï¼è<code>RemainingStepsManager</code>åç¨æ¥ç¡®å®ä½ä¸çSuperstepæ°ãå·ä½çå®ç°éå¸¸ç®åï¼ä»ä»æ¯éå¯¹PregelScratchpadç<code>step</code>å<code>stop</code>å­æ®µçç®åè¿ç®èå·²ã</p>
<pre><code class="language-python">class IsLastStepManager(ManagedValue[bool]):
    @staticmethod
    def get(scratchpad: PregelScratchpad) -&gt; bool:
        return scratchpad.step == scratchpad.stop - 1

class RemainingStepsManager(ManagedValue[int]):
    @staticmethod
    def get(scratchpad: PregelScratchpad) -&gt; int:
        return scratchpad.stop - scratchpad.step
</code></pre>
<p>ç±äºManagedValueå±äºä¸ä¸ª<code>è®¡ç®å±æ§</code>ï¼æä»¥å®åªè½ä½ä¸ºNodeçè¾å¥ãå®å¯ä»¥è¢«è§ä¸ºä¸ç§èæçChannelï¼Nodeéå¯¹ManagedValueåå¸¸è§Channelçè¯»åæ¹å¼å®å¨ä¸è´ãå¨åå»ºPregelå¯¹è±¡æ¶ï¼æç¨å°çManagedValueéè¦å¨<code>channels</code>å­æ®µä¸­æ¾å¼å£°æï¼ä½æ¯ä¸è½å°å¶æ·»å å°è¾å¥åè¾åºChannelåè¡¨ä¸­ã</p>
<p>å¦ä¸çå®ä¾æ¼ç¤ºäºRemainingStepsManagerçä½¿ç¨æ¹å¼ï¼åå»ºçPregelç±ä¸¤ä¸ªååæ§è¡çNodeææï¼fooåbarï¼ï¼å®ä»¬ä¼å°å½åä¸º<code>remaining_steps</code>çManagedValueä½ä¸ºè¾å¥ï¼å¹¶å°å¶åå«è¾åºå°<code>remaining_steps_after_foo</code>å<code>remaining_steps_after_bar</code>è¿ä¸¤ä¸ªChannelä¸­ï¼åå«è¡¨ç¤ºå¨è¿ä¸¤ä¸ªNodeå®ææ§è¡åæå©çSuperstepæ°ã</p>
<pre><code class="language-python">from langgraph.pregel import Pregel, NodeBuilder
from langgraph.managed.is_last_step import RemainingStepsManager
from langgraph.channels import LastValue

foo = (NodeBuilder()
       .subscribe_to("foo")
       .read_from("remaining_steps")
       .do(lambda args: args["remaining_steps"])
       .write_to(remaining_steps_after_foo= lambda args:args, bar=None))

bar = (NodeBuilder()
       .subscribe_to("bar")
       .read_from("remaining_steps")
       .do(lambda args: args["remaining_steps"])
       .write_to("remaining_steps_after_bar"))

app = Pregel(
    nodes={"foo":foo, "bar":bar},
    channels={
        "foo": LastValue(None),
        "bar":LastValue(None),
        "remaining_steps_after_foo": LastValue(int),
        "remaining_steps_after_bar":LastValue(int),
        "remaining_steps": RemainingStepsManager, 
    },
    input_channels=["foo"],
    output_channels=["remaining_steps_after_foo", "remaining_steps_after_bar"])

config = {"recursion_limit": 10}
result = app.invoke({"foo":None}, config=config)
assert result["remaining_steps_after_foo"] == 10
assert result["remaining_steps_after_bar"] == 9
</code></pre>
<p>å¨æ ¹æ®ä¸¤ä¸ªNodeåå»ºPregelå¯¹è±¡æ¶ï¼æä»¬å°éå¯¹å½åä¸º<code>remaining_steps</code>çManagedValueçå£°ææ·»å å°channelså­æ®µä¸­ï¼å¯¹åºçç±»åè¢«è®¾ç½®ä¸ºRemainingStepsManagerãç±äºå¨è°ç¨Pregelå¯¹è±¡æ¶å©ç¨RunnableConfigéç½®å°Superstepè¿­ä»£éå¶ä¸º10ï¼æä»¥ååæ§è¡çä¸¤ä¸ªNodeåå©ä½æ­¥æ°åå«ä¸º10å9ã</p>


</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-02-14 07:58">2026-02-14 07:57</span>&nbsp;
<a href="https://www.cnblogs.com/jaydenai">JaydenAI</a>&nbsp;
éè¯»(<span id="post_view_count">40</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19614333);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19614333', targetLink: 'https://www.cnblogs.com/jaydenai/p/19614333/managed-value', title: '[æè§£LangChainæ§è¡å¼æ] ManagedValueââä¸ç§ç¹æ®çåªè¯»èæéé' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
        </channel>
        </rss>