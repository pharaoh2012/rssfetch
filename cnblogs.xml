<?xml version="1.0" encoding="UTF-8" ?>
    <rss version="2.0">
    <channel>
        <title><![CDATA[ ä¸»é¡µ - åå®¢å­ ]]></title>
        <link><![CDATA[ https://www.cnblogs.com/ ]]></link>
        <lastBuildDate>2026-01-05T16:22:26.382Z</lastBuildDate>
        <description><![CDATA[
        ä¸»é¡µ - åå®¢å­ RSS
    ]]></description>
        <language>zh-cn</language>
        <item>
    <title><![CDATA[ Flinkæºç éè¯»ï¼çªå£ ]]></title>
    <link>https://www.cnblogs.com/Jackeyzhe/p/19444937</link>
    <guid>24f886def92809f3307de5ab1dcc7547</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/Jackeyzhe/p/19444937" title="åå¸äº 2026-01-05 22:47">
    <span role="heading" aria-level="2">Flinkæºç éè¯»ï¼çªå£</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                    <div id="cnblogs_post_description" style="display: none">
        <img src="https://img2024.cnblogs.com/blog/1828322/202601/1828322-20260105224732284-1871293272.png" alt="Flinkæºç éè¯»ï¼çªå£" class="desc_img">
        åææä»¬æ¢³çäº Watermark ç¸å³çæºç ï¼Watermark çä½ç¨å°±æ¯ç¨æ¥è§¦åçªå£ï¼æ¬ææä»¬å°±ä¸èµ·çä¸ä¸çªå£ç¸å³çæºç ã
    </div>
<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<p>åææä»¬æ¢³çäº Watermark ç¸å³çæºç ï¼Watermark çä½ç¨å°±æ¯ç¨æ¥è§¦åçªå£ï¼æ¬ææä»¬å°±ä¸èµ·çä¸ä¸çªå£ç¸å³çæºç ã</p>
<h3 id="åå¨åé¢">åå¨åé¢</h3>
<p>å¨<a href="https://jackeyzhe.github.io/2025/07/19/Flink%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%9A%E7%AA%97%E5%8F%A3/" target="_blank" rel="noopener nofollow">Flinkå­¦ä¹ ç¬è®°ï¼çªå£</a>ä¸æä¸­ï¼æä»¬ä»ç»äºçªå£çåç±»ä»¥ååºæ¬çç¨æ³ãæç§å¤çæ°æ®æµçç±»åååï¼Flink å¯ä»¥åä¸º Keyed Window å Non-Keyed Windowï¼å®ä»¬çç¨æ³å¦ä¸ï¼</p>
<pre><code class="language-java">stream
       .keyBy(...)               &lt;-  ä» keyed çªå£éè¦
       .window(...)              &lt;-  å¿å¡«é¡¹ï¼"assigner"
      [.trigger(...)]            &lt;-  å¯éé¡¹ï¼"trigger" (çç¥åä½¿ç¨é»è®¤ trigger)
      [.evictor(...)]            &lt;-  å¯éé¡¹ï¼"evictor" (çç¥åä¸ä½¿ç¨ evictor)
      [.allowedLateness(...)]    &lt;-  å¯éé¡¹ï¼"lateness" (çç¥åä¸º 0)
      [.sideOutputLateData(...)] &lt;-  å¯éé¡¹ï¼"output tag" (çç¥åä¸å¯¹è¿å°æ°æ®ä½¿ç¨ side output)
       .reduce/aggregate/apply()      &lt;-  å¿å¡«é¡¹ï¼"function"
      [.getSideOutput(...)]      &lt;-  å¯éé¡¹ï¼"output tag"

stream
       .windowAll(...)           &lt;-  å¿å¡«é¡¹ï¼"assigner"
      [.trigger(...)]            &lt;-  å¯éé¡¹ï¼"trigger" (else default trigger)
      [.evictor(...)]            &lt;-  å¯éé¡¹ï¼"evictor" (else no evictor)
      [.allowedLateness(...)]    &lt;-  å¯éé¡¹ï¼"lateness" (else zero)
      [.sideOutputLateData(...)] &lt;-  å¯éé¡¹ï¼"output tag" (else no side output for late data)
       .reduce/aggregate/apply()      &lt;-  å¿å¡«é¡¹ï¼"function"
      [.getSideOutput(...)]      &lt;-  å¯éé¡¹ï¼"output tag"
</code></pre>
<p>ä¸é¢æä»¬æ ¹æ®ç¨æ³ï¼åå«æ¥çä¸¤ç§çªå£çæºç ã</p>
<h3 id="keyed-window">Keyed Window</h3>
<p><img alt="KeyedWindow" loading="lazy" data-src="https://res.cloudinary.com/dxydgihag/image/upload/v1766394316/Blog/flink/16/KeyedWindow.png" class="lazyload"></p>
<h4 id="windowassigner">WindowAssigner</h4>
<p>å¨ç¤ºä¾ä»£ç ä¸­ï¼æ°æ®æµç±»åæµè½¬è¿ç¨å¦å¾ãæä»¬èç¦äº WindowedStreamï¼å®æ¯å¨è°ç¨ <code>KeyedStream.window</code> æ¹æ³ä¹åçæçãwindow æ¹æ³éè¦ä¼ å¥ä¸ä¸ª WindowAssignerï¼ç¨æ¥ç¡®å®ä¸æ¡æ¶æ¯å±äºåªå ä¸ªçªå£ï¼åä¸ªç±»åççªå£é½æä¸åçå®ç°ã</p>
<p><img alt="windowAssigner" loading="lazy" data-src="https://res.cloudinary.com/dxydgihag/image/upload/v1766472754/Blog/flink/16/windowAssigner.png" class="lazyload"></p>
<p>æä»¬ä»¥ TumblingEventTimeWindows ä¸ºä¾ï¼çä¸ä¸å®å·ä½çåéé»è¾ã</p>
<pre><code class="language-java">public Collection&lt;TimeWindow&gt; assignWindows(
        Object element, long timestamp, WindowAssignerContext context) {
    if (timestamp &gt; Long.MIN_VALUE) {
        if (staggerOffset == null) {
            staggerOffset =
                    windowStagger.getStaggerOffset(context.getCurrentProcessingTime(), size);
        }
        // Long.MIN_VALUE is currently assigned when no timestamp is present
        long start =
                TimeWindow.getWindowStartWithOffset(
                        timestamp, (globalOffset + staggerOffset) % size, size);
        return Collections.singletonList(new TimeWindow(start, start + size));
    } else {
        throw new RuntimeException(
                "Record has Long.MIN_VALUE timestamp (= no timestamp marker). "
                        + "Did you forget to call 'DataStream.assignTimestampsAndWatermarks(...)'?");
    }
}
</code></pre>
<p>è¿éå°±æ¯æ ¹æ®æ¶æ¯ç timestamp æ¥ç¡®å®çªå£çå¼å§åç»ææ¶é´ï¼ç¶åè¿åæ¶æ¯æå±ççªå£ãè¿éè¿æä¸ª windowStagger åéï¼å®æ¯çªå£è§¦åæ¯å¦éå³°çéç½®ï¼å¦æä½ çä»»å¡ææåä¸ä¸ä¸ªå­ä»»å¡ï¼åæ¶è§¦åçªå£è®¡ç®å¸¦æ¥çç¬æ¶æµéå¯è½ä¼å¯¹æå¡å¨æ¬èº«åä¸æ¸¸é æç¨³å®æ§çå½±åï¼è¿æ¶å°±å¯ä»¥éè¿ä¿®æ¹ WindowStagger éç½®å°æµéææ£ã</p>
<p>å°æä»¬èªå·±å®ä¹å¥½ç WindowAssigner ä¼ å¥ window æ¹æ³åï¼ä¼åå»ºä¸ä¸ª WindowOperatorBuilderï¼å®è´è´£åå»ºä¸ä¸ª WindowOperator å¯¹è±¡ï¼WindowOperator æ¥æ§è¡çªå£å·ä½çè®¡ç®é»è¾ã</p>
<pre><code class="language-java">public WindowedStream(KeyedStream&lt;T, K&gt; input, WindowAssigner&lt;? super T, W&gt; windowAssigner) {

    this.input = input;
    this.isEnableAsyncState = input.isEnableAsyncState();

    this.builder =
            new WindowOperatorBuilder&lt;&gt;(
                    windowAssigner,
                    windowAssigner.getDefaultTrigger(),
                    input.getExecutionConfig(),
                    input.getType(),
                    input.getKeySelector(),
                    input.getKeyType());
}
</code></pre>
<h4 id="trigger">Trigger</h4>
<p>æäº WindowOperatorBuilder ä¹åï¼æä»¬å¯ä»¥å¯¹å®è¿è¡ä¸äºè®¾ç½®ï¼å¦ triggerãevictor ç­ï¼trigger ä¸­æä¾äºä¸äºåè°å½æ°ï¼è¿äºåè°å½æ°çè¿åç»æ TriggerResult å³å®äºæ¯å¦è§¦åçªå£è®¡ç®ã</p>
<pre><code class="language-java">public abstract class Trigger&lt;T, W extends Window&gt; implements Serializable {

    private static final long serialVersionUID = -4104633972991191369L;

    public abstract TriggerResult onElement(T element, long timestamp, W window, TriggerContext ctx)
            throws Exception;

    public abstract TriggerResult onProcessingTime(long time, W window, TriggerContext ctx)
            throws Exception;

    public abstract TriggerResult onEventTime(long time, W window, TriggerContext ctx)
            throws Exception;

    public boolean canMerge() {
        return false;
    }

    public void onMerge(W window, OnMergeContext ctx) throws Exception {
        throw new UnsupportedOperationException("This trigger does not support merging.");
    }

    public abstract void clear(W window, TriggerContext ctx) throws Exception;
}
</code></pre>
<p>åè°å½æ°æä¸ä¸ªï¼åå«æ¯ onElementãonProcessingTimeãonEventTimeï¼onElement æ¯å¨å¤çæ¯æ¡æ¶æ¯çæ¶åè§¦åï¼onProcessingTime å onEventTime é½æ¯ä¸å®æ¶å¨éåè§¦åï¼ä¸ä¸ç¯æç« æä»¬æå°è¿ï¼å¨å¤ç Watermark çæ¶åä¼æ³¨åå®æ¶å¨ï¼è§¦åæ¶å°±ä¼åè°è¿ä¸¤ä¸ªæ¹æ³ã</p>
<p>æ­¤å¤ï¼Trigger ç±»ä¸­è¿æä¸ä¸ªæ¹æ³ï¼æä»¬ç®åä»ç»ä¸ä¸ãcanMerge æ¯ç¨æ¥å¤æ­çªå£æ¯å¦å¯ä»¥è¢«åå¹¶ï¼onMerge åæ¯å¨åå¹¶çªå£æ¶çåè°æ¹æ³ãclear æ¹æ³ç¨äºæ¸é¤çªå£çç¶ææ°æ®ã</p>
<pre><code class="language-java">public enum TriggerResult {

    /** No action is taken on the window. */
    CONTINUE(false, false),

    /** {@code FIRE_AND_PURGE} evaluates the window function and emits the window result. */
    FIRE_AND_PURGE(true, true),

    /**
     * On {@code FIRE}, the window is evaluated and results are emitted. The window is not purged,
     * though, all elements are retained.
     */
    FIRE(true, false),

    /**
     * All elements in the window are cleared and the window is discarded, without evaluating the
     * window function or emitting any elements.
     */
    PURGE(false, true);
}
</code></pre>
<p>è¯´å TriggerResultï¼å®æåç§æä¸¾ï¼</p>
<ul>
<li>
<p>CONTINUEï¼ä»ä¹ä¹ä¸å</p>
</li>
<li>
<p>FIRE_AND_PURGEï¼è§¦åçªå£è®¡ç®å¹¶æ¸é¤çªå£ä¸­çåç´ </p>
</li>
<li>
<p>FIREï¼åªè§¦åçªå£è®¡ç®</p>
</li>
<li>
<p>PURGEï¼æ¸é¤çªå£ä¸­çåç´ ï¼ä¸è§¦åè®¡ç®</p>
</li>
</ul>
<h4 id="evictor">Evictor</h4>
<p>Evictor æ¯ç¨æ¥èªå®ä¹å é¤çªå£ä¸­åç´ ççæ¥å£ï¼å¦æè®¾ç½®äº evictorï¼WindowOperatorBuilder å°±ä¼åå»º EvictingWindowOperatorãå¨æ§è¡çªå£è®¡ç®é»è¾ååï¼é½ä¼è°ç¨ evictBefore å evictAfterã</p>
<pre><code class="language-java">private void emitWindowContents(
        W window, Iterable&lt;StreamRecord&lt;IN&gt;&gt; contents, ListState&lt;StreamRecord&lt;IN&gt;&gt; windowState)
        throws Exception {
    ...
    evictorContext.evictBefore(recordsWithTimestamp, Iterables.size(recordsWithTimestamp));

    FluentIterable&lt;IN&gt; projectedContents =
            recordsWithTimestamp.transform(
                    new Function&lt;TimestampedValue&lt;IN&gt;, IN&gt;() {
                        @Override
                        public IN apply(TimestampedValue&lt;IN&gt; input) {
                            return input.getValue();
                        }
                    });

    processContext.window = triggerContext.window;
    userFunction.process(
            triggerContext.key,
            triggerContext.window,
            processContext,
            projectedContents,
            timestampedCollector);
    evictorContext.evictAfter(recordsWithTimestamp, Iterables.size(recordsWithTimestamp));
    ...
}
</code></pre>
<h4 id="allowedlateness--sideoutputlatedata">allowedLateness &amp; sideOutputLateData</h4>
<p>allowedLateness å sideOutputLateData é½æ¯éå¯¹è¿å°æ°æ®çï¼allowedLateness æ¯ç¨æ¥æå®åè®¸çæå¤§è¿å°æ¶é¿ï¼sideOutputLateData åæ¯å°è¿å°æ°æ®è¾åºå°æå® outputTagã</p>
<p>å¤æ­æ¯å¦è¿å°çæ¹æ³å¦ä¸ï¼</p>
<pre><code class="language-java">protected boolean isElementLate(StreamRecord&lt;IN&gt; element) {
    return (windowAssigner.isEventTime())
            &amp;&amp; (element.getTimestamp() + allowedLateness
                    &lt;= internalTimerService.currentWatermark());
}
</code></pre>
<p>å¦ææ¯è¿å°æ°æ®ï¼åè¿è¡å¦ä¸å¤çï¼</p>
<pre><code class="language-java">if (isSkippedElement &amp;&amp; isElementLate(element)) {
    if (lateDataOutputTag != null) {
        sideOutput(element);
    } else {
        this.numLateRecordsDropped.inc();
    }
}
</code></pre>
<h4 id="windowoperator">WindowOperator</h4>
<p>è®¾ç½®å¥½ WindowOperatorBuilder ä¹åï¼æ¥çå°±å¯ä»¥è°ç¨ process/aggregate/reduce ç­æ¹æ³è¿è¡æ°æ®è®¡ç®ã</p>
<p>æä»¬ä»¥ process æ¹æ³ä¸ºä¾ï¼æ¥çä¸å·ä½çå¤çé»è¾ã</p>
<pre><code class="language-java">public &lt;R&gt; SingleOutputStreamOperator&lt;R&gt; process(
        ProcessWindowFunction&lt;T, R, K, W&gt; function, TypeInformation&lt;R&gt; resultType) {
    function = input.getExecutionEnvironment().clean(function);

    final String opName = builder.generateOperatorName();
    final String opDesc = builder.generateOperatorDescription(function, null);

    OneInputStreamOperator&lt;T, R&gt; operator =
            isEnableAsyncState ? builder.asyncProcess(function) : builder.process(function);

    return input.transform(opName, resultType, operator).setDescription(opDesc);
}
</code></pre>
<p>å¨ <code>WindowedStream.process</code> æ¹æ³ä¸­ï¼å°±æ¯è°ç¨ WindowOperatorBuilder ç process æ¹æ³ï¼å¦ææ¯å¼æ­¥åè°ç¨å¼æ­¥æ¹æ³ï¼çæ WindowOperatorï¼åå° WindowOperator å å¥å°æ§è¡å¾ä¸­ã</p>
<p>ä¸é¢æä»¬æ¥ç WindowOperator ä¸­å ä¸ªéè¦çæ¹æ³ã</p>
<h5 id="open">open</h5>
<p>é¦åæ¯ open æ¹æ³ï¼å®ä¸»è¦è´è´£è¿è¡åå§åï¼åæ¬åå»º timerServiceï¼åå»º windowState ç­ã</p>
<pre><code class="language-java">public void open() throws Exception {
    super.open();

    this.numLateRecordsDropped = metrics.counter(LATE_ELEMENTS_DROPPED_METRIC_NAME);
    timestampedCollector = new TimestampedCollector&lt;&gt;(output);

    internalTimerService = getInternalTimerService("window-timers", windowSerializer, this);

    triggerContext = new Context(null, null);
    processContext = new WindowContext(null);

    windowAssignerContext =
            new WindowAssigner.WindowAssignerContext() {
                @Override
                public long getCurrentProcessingTime() {
                    return internalTimerService.currentProcessingTime();
                }
            };

    // create (or restore) the state that hold the actual window contents
    // NOTE - the state may be null in the case of the overriding evicting window operator
    if (windowStateDescriptor != null) {
        windowState =
                (InternalAppendingState&lt;K, W, IN, ACC, ACC&gt;)
                        getOrCreateKeyedState(windowSerializer, windowStateDescriptor);
    }

    // create the typed and helper states for merging windows
    if (windowAssigner instanceof MergingWindowAssigner) {
        ...
    }
}
</code></pre>
<h5 id="processelement">processElement</h5>
<p>processElement æ¯è´è´£å¤çè¿å¥çªå£çæ°æ®ï¼è¿éé¦åè°ç¨ <code>WindowAssigner.assignWindows</code> æ¹æ³ç¡®è®¤åç´ å±äºåªäºçªå£ãç¶åéåçªå£è¿è¡å¤çï¼åæ¬å windowState ä¸­æ·»å åç´ ï¼è°ç¨ trigger ç onElement æ¹æ³è·å TriggerResultãå¦æè§¦åäºçªå£è®¡ç®ï¼è°ç¨ emitWindowContents æ§è¡è®¡ç®é»è¾ãæåæ¯å¤çè¿å°æ°æ®ï¼æä»¬åé¢æå°è¿ã</p>
<pre><code class="language-java">public void processElement(StreamRecord&lt;IN&gt; element) throws Exception {
    final Collection&lt;W&gt; elementWindows =
            windowAssigner.assignWindows(
                    element.getValue(), element.getTimestamp(), windowAssignerContext);

    // if element is handled by none of assigned elementWindows
    boolean isSkippedElement = true;

    final K key = this.&lt;K&gt;getKeyedStateBackend().getCurrentKey();

    if (windowAssigner instanceof MergingWindowAssigner) {
        ...
    } else {
        for (W window : elementWindows) {

            // drop if the window is already late
            if (isWindowLate(window)) {
                continue;
            }
            isSkippedElement = false;

            windowState.setCurrentNamespace(window);
            windowState.add(element.getValue());

            triggerContext.key = key;
            triggerContext.window = window;

            TriggerResult triggerResult = triggerContext.onElement(element);

            if (triggerResult.isFire()) {
                ACC contents = windowState.get();
                if (contents != null) {
                    emitWindowContents(window, contents);
                }
            }

            if (triggerResult.isPurge()) {
                windowState.clear();
            }
            registerCleanupTimer(window);
        }
    }

    // side output input event if
    // element not handled by any window
    // late arriving tag has been set
    // windowAssigner is event time and current timestamp + allowed lateness no less than
    // element timestamp
    if (isSkippedElement &amp;&amp; isElementLate(element)) {
        if (lateDataOutputTag != null) {
            sideOutput(element);
        } else {
            this.numLateRecordsDropped.inc();
        }
    }
}
</code></pre>
<h5 id="oneventtime">onEventTime</h5>
<p>onEventTime æ¹æ³æ¯ eventTime è§¦åçªå£è®¡ç®æ¶è°ç¨çãä¸»è¦é»è¾å°±æ¯è·å TriggerResultï¼ç¶åè§¦åè®¡ç®é»è¾ï¼ä»¥åå¯¹ windowState çå¤çã</p>
<pre><code class="language-java">public void onEventTime(InternalTimer&lt;K, W&gt; timer) throws Exception {
    triggerContext.key = timer.getKey();
    triggerContext.window = timer.getNamespace();

    MergingWindowSet&lt;W&gt; mergingWindows;

    if (windowAssigner instanceof MergingWindowAssigner) {
        mergingWindows = getMergingWindowSet();
        W stateWindow = mergingWindows.getStateWindow(triggerContext.window);
        if (stateWindow == null) {
            // Timer firing for non-existent window, this can only happen if a
            // trigger did not clean up timers. We have already cleared the merging
            // window and therefore the Trigger state, however, so nothing to do.
            return;
        } else {
            windowState.setCurrentNamespace(stateWindow);
        }
    } else {
        windowState.setCurrentNamespace(triggerContext.window);
        mergingWindows = null;
    }

    TriggerResult triggerResult = triggerContext.onEventTime(timer.getTimestamp());

    if (triggerResult.isFire()) {
        ACC contents = windowState.get();
        if (contents != null) {
            emitWindowContents(triggerContext.window, contents);
        }
    }

    if (triggerResult.isPurge()) {
        windowState.clear();
    }

    if (windowAssigner.isEventTime()
            &amp;&amp; isCleanupTime(triggerContext.window, timer.getTimestamp())) {
        clearAllState(triggerContext.window, windowState, mergingWindows);
    }

    if (mergingWindows != null) {
        // need to make sure to update the merging state in state
        mergingWindows.persist();
    }
}
</code></pre>
<h5 id="onprocessingtime">onProcessingTime</h5>
<p>onProcessingTime å onEventTime é»è¾åºæ¬ä¸è´ï¼åªæ¯è§¦åæ¡ä»¶ä¸åï¼è¿éå°±ä¸åèµè¿°äºã</p>
<p>è³æ­¤ï¼Keyed Window ä»è®¾ç½®å°ä½¿ç¨çæºç æä»¬å°±æ¢³çå®æäºï¼ä¸é¢åæ¥çå¦å¤ä¸ç§çªå£ Non-Keyed Windowã</p>
<h3 id="non-keyed-window">Non-Keyed Window</h3>
<p><img alt="AllWindow" loading="lazy" data-src="https://res.cloudinary.com/dxydgihag/image/upload/v1766484574/Blog/flink/16/Non-KeyedWindow.png" class="lazyload"></p>
<p>æä»¬è°ç¨ windowAll å¾å° AllWindowedStreamï¼å¨æé å½æ°ä¸­ï¼ä¼ç»å¯¹ input è°ç¨ keyBy æ¹æ³ï¼ä¼ å¥ NullByteKeySelectorï¼ NullByteKeySelector å¯¹æ¯ä¸ª key é½è¿å0ï¼å æ­¤ææç key é½ä¼è¢«åéå°åä¸ä¸ªèç¹ã</p>
<pre><code class="language-java">public class NullByteKeySelector&lt;T&gt; implements KeySelector&lt;T, Byte&gt; {

    private static final long serialVersionUID = 614256539098549020L;

    @Override
    public Byte getKey(T value) throws Exception {
        return 0;
    }
}
</code></pre>
<p>Non-Keyed Window åç»­çé»è¾é½å Keyed Window æ¯è¾ç±»ä¼¼ã</p>
<h3 id="æ»ç»">æ»ç»</h3>
<p>æ¬ææä»¬æ¢³çäºçªå£ç¸å³çæºç ï¼å ä¸ªéç¹æ¦å¿µåæ¬ WindowAssginerãWindowOperatorãTriggerãEvictorãå¶ä¸­ WindowAssigner æ¯ç¨æ¥ç¡®å®ä¸æ¡æ¶æ¯å±äºåªäºçªå£ï¼WindowOperator åæ¯çªå£è®¡ç®é»è¾çå·ä½æ§è¡å±ãTrigger å Evictor åå«ç¨äºè§¦åçªå£åæ¸ççªå£ä¸­æ°æ®ã</p>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-01-05 22:48">2026-01-05 22:47</span>&nbsp;
<a href="https://www.cnblogs.com/Jackeyzhe">Jackeyzhe</a>&nbsp;
éè¯»(<span id="post_view_count">2</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19444937);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19444937', targetLink: 'https://www.cnblogs.com/Jackeyzhe/p/19444937', title: 'Flinkæºç éè¯»ï¼çªå£' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ .NET ä¼ ç»ä¿¡æ¯ç³»ç»æ ç¼éæé£ä¹¦å®¡æ¹æµ ]]></title>
    <link>https://www.cnblogs.com/mudtools/p/19444914</link>
    <guid>aeb232d53a9737ce9bc0fd0917d96319</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/mudtools/p/19444914" title="åå¸äº 2026-01-05 22:39">
    <span role="heading" aria-level="2">.NET ä¼ ç»ä¿¡æ¯ç³»ç»æ ç¼éæé£ä¹¦å®¡æ¹æµ</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<blockquote>
<p>å¨æ«æ·±å¤ï¼ä½ æ¶å°ç´§æ¥å®¡æ¹éç¥ââå´åç°åªè½å¨ PC ç«¯å¤çï¼åªè½æ¸é»èµ·åºå¼çµèâ¦â¦</p>
</blockquote>
<p>è¿æ ·çåºæ¯ï¼ä½ æ¯å¦ä¹ç»åè¿ï¼</p>
<p><strong>ä¼ ç» .NET ç³»ç»ä¸ç°ä»£ç§»å¨ååä¹é´çé¸¿æ²ï¼æ­£å¨ææåå¬çä¼ä¸çæç</strong>ãå®¡æ¹å¡å¨æ¡é¢ç«¯ãéç¥æ»åãæ°æ®å­¤å²ââè¿äºé®é¢è®©å·¥ä½ä½éªå¤§æææ£ã</p>
<p>æ¨åéæ¥ï¼ææ¬å¤ªé«ï¼é£é©å¤ªå¤§ã</p>
<p><strong>æ¬æå°å¸¦ä½ èµ°ä¸æ¡æ¸è¿å¼æ¹é ä¹è·¯</strong>ï¼ä¿æ .NET ç³»ç»ä½ä¸ºä¸å¡æ ¸å¿ï¼å°é£ä¹¦å®¡æ¹ä½ä¸ºç§»å¨é¨æ·ï¼éè¿ API å®ç°æ ç¼ååãä»åçãè®¾è®¡å°ç¼ç ï¼å®æ´åç°å¦ä½è®©ä¼ ç»ç³»ç»çåæ°çï¼å®ç°ç§»å¨åãå®æ¶åçç°ä»£ååçº§ã</p>
<p>æ è®ºä½ æ¯å¼åèãæ¶æå¸è¿æ¯ææ¯ç®¡çèï¼é½è½æ¶è·ä¸å¥å¯è½å°ãå¯æ©å±çéææ¹æ¡åç´æ¥å¤ç¨çä»£ç å®è·µã</p>
<h2 id="å½ä¼ ç»ä¸å¡éä¸ç°ä»£ååä¸ºä½å¿é¡»ç ´å£">å½ä¼ ç»ä¸å¡éä¸ç°ä»£ååï¼ä¸ºä½å¿é¡»"ç ´å£"ï¼</h2>
<h3 id="æä»¬æ­£å¨è§£å³ä»ä¹">æä»¬æ­£å¨è§£å³ä»ä¹ï¼</h3>
<p><strong>ä¼ ç» .NET ç³»ç»çå±é</strong></p>
<p>è®¸å¤ä¼ä¸æ¥æå¤å¹´ç´¯ç§¯ç .NET ä¸å¡ç³»ç»ï¼è¿äºç³»ç»å¨ä¼ä¸è¿è¥ä¸­æ®æ¼çæ ¸å¿è§è²ãç¶èï¼éçç§»å¨åå¬åç°ä»£ååå·¥å·çæ®åï¼è¿äºä¼ ç»ç³»ç»æ­£é¢ä¸´çä¸¥å³»çææï¼</p>
<table>
<thead>
<tr>
<th>çç¹</th>
<th>å·ä½è¡¨ç°</th>
<th>ä¸å¡å½±å</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>å®¡æ¹æµç¨å°é­</strong></td>
<td>å®¡æ¹åªè½å¨æ¡é¢ç«¯å®æï¼æ æ³éæ¶éå°å¤ç</td>
<td>ç§»å¨åå¬åé»ï¼ååºè¿ç¼</td>
</tr>
<tr>
<td><strong>éç¥æ¹å¼æ»å</strong></td>
<td>ä¾èµé®ä»¶æç«åæ¶æ¯æ¨é</td>
<td>å®¡æ¹äººåæ¶æ§å·®ï¼æµç¨å»¶è¯¯</td>
</tr>
<tr>
<td><strong>æ°æ®å­¤å²ä¸¥é</strong></td>
<td>å®¡æ¹æ°æ®ä¸ä¸å¡æ°æ®åç¦»</td>
<td>æ æ³å½¢æå®æ´çä¸å¡é­ç¯</td>
</tr>
<tr>
<td><strong>ç¨æ·ä½éªéæ§</strong></td>
<td>çé¢é£æ ¼éæ§ï¼äº¤äºä½éªå·®</td>
<td>ç¨æ·æ»¡æåº¦ä½ï¼ä½¿ç¨ææ¿ä¸é</td>
</tr>
</tbody>
</table>
<p><strong>é£ä¹¦å®¡æ¹çèµè½ä»·å¼</strong></p>
<p>é£ä¹¦å®¡æ¹ä½ä¸ºä¼ä¸çº§çå®¡æ¹åä½å¹³å°ï¼ä¸ºæä»¬æä¾äºä¸ä¸ªçæ³ç"æµç¨åä½ä¸­å¿"ï¼</p>
<div class="mermaid">graph LR
    A[é£ä¹¦å®¡æ¹å¹³å°] --&gt; B[ç§»å¨ä¼å]
    A --&gt; C[å³æ¶å¼ºéç¥]
    A --&gt; D[æµç¨å¯è§å]
    A --&gt; E[å®åå®¡è®¡æ¥å¿]

    B --&gt; B1[éæ¶éå°å¤çå®¡æ¹]
    C --&gt; C1[Appæ¨é/ç­ä¿¡æé]
    D --&gt; D1[ææ½å¼æµç¨éç½®]
    E --&gt; E1[å®æ´æä½çè¿¹è¿½æº¯]
</div><p><strong>æä»¬çæ ¸å¿ç®æ </strong></p>
<p>éè¿æ¬æçå®è·µï¼æä»¬å°å»ºç« <strong>".NET ç³»ç»ä¸ºä¸å¡æ ¸å¿ï¼é£ä¹¦å®¡æ¹ä¸ºæµç¨é¨æ·"</strong> çç°ä»£åæ··åæ¶æï¼</p>
<blockquote>
<p><strong>æ¶ææ¿æ¯</strong>ï¼å°é£ä¹¦å®¡æ¹ä½ä¸ºç»ä¸çç§»å¨å®¡æ¹é¨æ·ï¼ä¿æ .NET ç³»ç»ä½ä¸ºä¸å¡é»è¾åæ°æ®å­å¨çæ ¸å¿ï¼éè¿ API å®æ¶åæ­¥ï¼å½¢æä¼å¿äºè¡¥çååä½ç³»ã</p>
</blockquote>
<h3 id="ä½ å°æ¶è·ä»ä¹">ä½ å°æ¶è·ä»ä¹ï¼</h3>
<ul>
<li>â <strong>ä¸å¥ç«¯å°ç«¯çéææ¹æ³è®º</strong>ï¼è¦çä»åçãè®¾è®¡å°é¨ç½²çå¨æµç¨</li>
<li>â <strong>æ¸æ°ç .NET ä¾§æ¶æèå¾</strong>ï¼åå«å³é®çææ¯éåä¸è®¾è®¡å³ç­</li>
<li>â <strong>å¯ç´æ¥å¤ç¨ç C# æ ¸å¿ä»£ç </strong>ä¸å®è·µä¸­æ»ç»ç"é¿åæå"</li>
<li>â <strong>ä¸ä¸ªå®æ´ç"è¯·åå®¡æ¹"å®ææ¡ä¾</strong>ï¼å©ä½ ä»é¶å°ä¸å®æéªè¯</li>
</ul>
<hr>
<h2 id="é£ä¹¦å®¡æ¹å¼æ¾å¹³å°å¦ä½ä¸æä»¬å¯¹è¯">é£ä¹¦å®¡æ¹å¼æ¾å¹³å°å¦ä½ä¸æä»¬"å¯¹è¯"ï¼</h2>
<h3 id="ååéæçå³é®æµç¨">ååéæçå³é®æµç¨</h3>
<p>é£ä¹¦å®¡æ¹ä¸ .NET ç³»ç»çéææ¯ä¸ä¸ª<strong>ååæ°æ®æµ</strong>çè¿ç¨ï¼</p>
<div class="mermaid">sequenceDiagram
    participant User as ç¨æ·
    participant NET as .NETç³»ç»
    participant API as é£ä¹¦API
    participant FS as é£ä¹¦App

    Note over User,FS: æµç¨è¾åºï¼åèµ·å®¡æ¹
    User-&gt;&gt;NET: 1. æäº¤è¯·åç³è¯·
    NET-&gt;&gt;NET: 2. ä¿å­ä¸å¡æ°æ®ï¼ç¶æï¼å®¡æ¹ä¸­ï¼
    NET-&gt;&gt;API: 3. è°ç¨ CreateInstanceAsync
    API--&gt;&gt;NET: 4. è¿å instance_code
    NET-&gt;&gt;NET: 5. å³èä¸å¡IDä¸instance_code

    Note over User,FS: æµç¨è¾å¥ï¼åè°éç¥
    User-&gt;&gt;FS: 6. å¨é£ä¹¦Appä¸­å®¡æ¹
    FS-&gt;&gt;API: 7. å®¡æ¹å®æ
    API-&gt;&gt;NET: 8. Webhookåè°äºä»¶
    NET-&gt;&gt;NET: 9. æ ¹æ®instance_codeæ´æ°ä¸å¡ç¶æ
</div><h4 id="æµç¨è¾åºåèµ·é¶æ®µ">æµç¨è¾åºï¼åèµ·é¶æ®µï¼</h4>
<p>å½ç¨æ·å¨ .NET ç³»ç»åèµ·å®¡æ¹æ¶ï¼ç³»ç»ä¼ï¼</p>
<ol>
<li>ä¿å­ä¸å¡æ°æ®ï¼ç¶ææ è®°ä¸º"å®¡æ¹ä¸­"</li>
<li>è°ç¨é£ä¹¦ API <code>CreateInstanceAsync</code> åå»ºå®¡æ¹å®ä¾</li>
<li>æ¥æ¶è¿åç <code>instance_code</code>ï¼æä¹åå°å³èè¡¨</li>
</ol>
<h4 id="æµç¨è¾å¥åè°é¶æ®µ">æµç¨è¾å¥ï¼åè°é¶æ®µï¼</h4>
<p>å½å®¡æ¹äººå¨é£ä¹¦ App å®æå®¡æ¹åï¼</p>
<ol>
<li>é£ä¹¦æå¡å¨ä¸»å¨åè° .NET ç³»ç»ç Webhook æ¥å£</li>
<li>.NET ç³»ç»è§£æäºä»¶ï¼æå <code>instance_code</code> å <code>status</code></li>
<li>æ ¹æ®å³èè¡¨æ¥è¯¢å¯¹åºçä¸å¡è®°å½</li>
<li>æ´æ°ä¸å¡ç¶æï¼å®æé­ç¯</li>
</ol>
<h3 id="å¿é¡»çè§£çä¸ä¸ªæ ¸å¿æ¦å¿µ">å¿é¡»çè§£çä¸ä¸ªæ ¸å¿æ¦å¿µ</h3>
<h4 id="å®¡æ¹å®ä¹approval_code">å®¡æ¹å®ä¹ï¼approval_codeï¼</h4>
<p><strong>å®¡æ¹å®ä¹</strong>æ¯å®¡æ¹æµç¨ç"èå¾"ï¼å¨é£ä¹¦ç®¡çåå°éç½®ï¼</p>
<pre><code class="language-csharp">// ç¤ºä¾ï¼è¯·åå®¡æ¹çå®¡æ¹å®ä¹
var approvalCode = "7C468A54-8745-2245-9675-08B7C63E7A85";
</code></pre>
<p><strong>å®ä¹åå«</strong>ï¼</p>
<ul>
<li>è¡¨åç»æï¼è¯·åç±»åãå¼å§æ¶é´ãç»ææ¶é´ãè¯·åäºç±ç­ï¼</li>
<li>å®¡æ¹æµç¨ï¼ç´å±ä¸»ç®¡å®¡æ¹ â äººäºå®¡æ¹ï¼</li>
<li>æéè®¾ç½®ï¼è°å¯ä»¥åèµ·ãè°å¯ä»¥å®¡æ¹ï¼</li>
</ul>
<h4 id="å®¡æ¹å®ä¾instance_code">å®¡æ¹å®ä¾ï¼instance_codeï¼</h4>
<p><strong>å®¡æ¹å®ä¾</strong>æ¯ä¾æ®å®¡æ¹å®ä¹åèµ·çä¸æ¬¡å·ä½å®¡æ¹ä»»å¡ï¼</p>
<pre><code class="language-csharp">// åå»ºå®¡æ¹å®ä¾æ¶è¿å
public record CreateInstancesResult
{
    /// &lt;summary&gt;
    /// å®¡æ¹å®ä¾ Code
    /// &lt;/summary&gt;
    [JsonPropertyName("instance_code")]
    public string InstanceCode { get; set; } = string.Empty;
}
</code></pre>
<p><strong>å³é®å±æ§</strong>ï¼</p>
<ul>
<li>å¯ä¸æ è¯ä¸æ¬¡å®¡æ¹æµç¨</li>
<li>åå«è¯¥æ¬¡å®¡æ¹çææè¡¨åæ°æ®</li>
<li>æ¥æç¬ç«çç¶æï¼å®¡æ¹ä¸­ãéè¿ãæç»ãæ¤åç­ï¼</li>
</ul>
<h4 id="èº«ä»½æ å°åç»">èº«ä»½æ å°ï¼åç»ï¼</h4>
<p>å®ç° .NET ç³»ç»ç¨æ·ä¸é£ä¹¦ç¨æ·çå³èï¼</p>
<div class="mermaid">graph LR
    A[.NETç³»ç»ç¨æ·&lt;br/&gt;UserId: 1001] --&gt;|æ å°å³ç³»| B[é£ä¹¦ç¨æ·&lt;br/&gt;OpenId: ou_3cda9c...]
    B --&gt;|éè¿é£ä¹¦Appå®¡æ¹| C[å®¡æ¹å®æ]
    C --&gt;|åè°instance_code| A
</div><p><strong>å®ç°æ¹å¼</strong>ï¼</p>
<ol>
<li>å¨ .NET ç³»ç»çç¨æ·è¡¨ä¸­æ·»å  <code>FeishuOpenId</code> å­æ®µ</li>
<li>ç¨æ·é¦æ¬¡ç»å½æ¶è¿è¡é£ä¹¦åç»å½è®¤è¯ï¼è·åå¹¶å­å¨ <code>open_id</code></li>
<li>åèµ·å®¡æ¹æ¶ï¼ä½¿ç¨ <code>open_id</code> æå®å®¡æ¹åèµ·äºº</li>
</ol>
<hr>
<h2 id="æå»ºç¨³å¥å¯æ©å±ç-net-ä¾§éæå±">æå»ºç¨³å¥ãå¯æ©å±ç .NET ä¾§éæå±</h2>
<h3 id="ææ¯æ æ¨è">ææ¯æ æ¨è</h3>
<table>
<thead>
<tr>
<th>å±æ¬¡</th>
<th>ææ¯éå</th>
<th>è¯´æ</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>åºç¨æ¡æ¶</strong></td>
<td>.NET 6/8/10</td>
<td>é¿ææ¯æçæ¬ï¼æ§è½ä¼å¼</td>
</tr>
<tr>
<td><strong>é£ä¹¦ SDK</strong></td>
<td>Mud.Feishu</td>
<td>é«åº¦å°è£çé£ä¹¦ API å®¢æ·ç«¯</td>
</tr>
<tr>
<td><strong>Webhook å¤ç</strong></td>
<td>Mud.Feishu.Webhook</td>
<td>é£ä¹¦äºä»¶åè°å¤çç»ä»¶</td>
</tr>
<tr>
<td><strong>è®¤è¯ææ</strong></td>
<td>ASP.NET Core Identity / JWT</td>
<td>åé¨ç³»ç»èº«ä»½ç®¡ç</td>
</tr>
<tr>
<td><strong>å¼æ­¥è§£è¦</strong></td>
<td>RabbitMQ / Hangfire</td>
<td>åè°æ¶æ¯éåå¤çï¼æåå¯é æ§</td>
</tr>
<tr>
<td><strong>æ°æ®å­å¨</strong></td>
<td>SQL Server / PostgreSQL</td>
<td>ä¸å¡æ°æ® + å®¡æ¹å³èè¡¨</td>
</tr>
</tbody>
</table>
<h3 id="åå±æ¶æå¾">åå±æ¶æå¾</h3>
<div class="mermaid">graph TB
    subgraph "è¡¨ç¤ºå± (UI)"
        A[Web åç«¯ / ç§»å¨ç«¯]
    end

    subgraph "åºç¨å± (API)"
        B[LeaveController]
        C[FeishuWebhookController]
    end

    subgraph "é¢åå± (ä¸å¡é»è¾)"
        D[ILeaveService]
        E[ApprovalIntegrationService]
        F[IApprovalService]
    end

    subgraph "åºç¡è®¾æ½å±"
        G[Mud.Feishu HTTPå®¢æ·ç«¯]
        H[Mud.Feishu.Webhookå¤çå¨]
        I[æ°æ®ä»å¨&lt;br/&gt;EF Core]
    end

    A --&gt; B
    A --&gt; C
    B --&gt; D
    C --&gt; E
    D --&gt; F
    E --&gt; F
    F --&gt; G
    F --&gt; H
    F --&gt; I
</div><h4 id="å³é®è®¾è®¡é¢åå±æ½è±¡">å³é®è®¾è®¡ï¼é¢åå±æ½è±¡</h4>
<p>å¨é¢åå±å¼å¥ <code>IApprovalService</code> æ¥å£ï¼å°é£ä¹¦éæç»èä¸æ ¸å¿ä¸å¡é»è¾è§£è¦ï¼</p>
<pre><code class="language-csharp">/// &lt;summary&gt;
/// å®¡æ¹æå¡æ½è±¡æ¥å£ - è§£è¦é£ä¹¦å®ç°ç»è
/// &lt;/summary&gt;
public interface IApprovalService
{
    /// &lt;summary&gt;
    /// åèµ·å®¡æ¹
    /// &lt;/summary&gt;
    Task&lt;string&gt; CreateApprovalAsync(ApprovalRequest request);

    /// &lt;summary&gt;
    /// å¤çå®¡æ¹ç»æåè°
    /// &lt;/summary&gt;
    Task HandleApprovalCallbackAsync(ApprovalCallbackEvent callbackEvent);
}

/// &lt;summary&gt;
/// é£ä¹¦å®¡æ¹æå¡å®ç°
/// &lt;/summary&gt;
public class FeishuApprovalService : IApprovalService
{
    private readonly IFeishuTenantV4Approval _approvalApi;
    private readonly IApprovalRecordRepository _repository;

    public FeishuApprovalService(
        IFeishuTenantV4Approval approvalApi,
        IApprovalRecordRepository repository)
    {
        _approvalApi = approvalApi;
        _repository = repository;
    }

    public async Task&lt;string&gt; CreateApprovalAsync(ApprovalRequest request)
    {
        // è°ç¨é£ä¹¦ API
        var result = await _approvalApi.CreateInstanceAsync(...);
        return result.Data?.InstanceCode ?? string.Empty;
    }
}
</code></pre>
<p><strong>ä¼å¿</strong>ï¼</p>
<ul>
<li>ä¸å¡é»è¾ä¸ä¾èµå·ä½é£ä¹¦å®ç°</li>
<li>ä¾¿äºååæµè¯ï¼å¯ Mock æ¥å£ï¼</li>
<li>æªæ¥å¯è½»æ¾åæ¢å°å¶ä»å®¡æ¹å¹³å°</li>
</ul>
<hr>
<h2 id="å®ææææå®æè¯·åå®¡æ¹éæ">å®æï¼æææå®æ"è¯·åå®¡æ¹"éæ</h2>
<h3 id="ç¬¬ä¸æ­¥é£ä¹¦å¹³å°ä¾§éç½®å®¡æ¹æµåºå£">ç¬¬ä¸æ­¥ï¼é£ä¹¦å¹³å°ä¾§éç½®ï¼å®¡æ¹æµåºå£ï¼</h3>
<h4 id="åå»ºä¼ä¸èªå»ºåºç¨">åå»ºä¼ä¸èªå»ºåºç¨</h4>
<p>ç»å½é£ä¹¦å¼æ¾å¹³å°ï¼<a href="https://open.feishu.cn" target="_blank" rel="noopener nofollow">https://open.feishu.cn</a>ï¼ï¼è¿å¥åºç¨ç®¡çï¼</p>
<div class="mermaid">graph LR
    A[åå»ºèªå»ºåºç¨] --&gt; B[è·åApp ID]
    A --&gt; C[è·åApp Secret]
    B --&gt; D[éç½®å°.NETç³»ç»]
    C --&gt; D
</div><p><strong>å³é®éç½®</strong>ï¼</p>
<ul>
<li>è®°å½ <code>App ID</code> å <code>App Secret</code></li>
<li>éç½®åºç¨æéï¼å®¡æ¹ç¸å³æéï¼<code>approval:approval:read</code>, <code>approval:instance:read</code>, <code>approval:instance:create</code>ï¼</li>
</ul>
<h4 id="éç½®å®¡æ¹å®ä¹">éç½®å®¡æ¹å®ä¹</h4>
<p>å¨é£ä¹¦ç®¡çåå°åå»º"è¯·åå®¡æ¹"æ¨¡æ¿ï¼</p>
<div class="mermaid">graph LR
    A[å®¡æ¹å®ä¹éç½®] --&gt; B[è¡¨åè®¾ç½®]
    A --&gt; C[æµç¨è®¾ç½®]
    A --&gt; D[æéè®¾ç½®]

    B --&gt; B1[è¯·åç±»å&lt;br/&gt;å¼å§æ¶é´&lt;br/&gt;ç»ææ¶é´&lt;br/&gt;è¯·åå¤©æ°&lt;br/&gt;è¯·åäºç±]
    C --&gt; C1[ç´å±ä¸»ç®¡å®¡æ¹&lt;br/&gt;â äººäºå®¡æ¹]
    D --&gt; D1[å¨åå¯åèµ·]
</div><p><strong>è®°å½å³é®ä¿¡æ¯</strong>ï¼</p>
<ul>
<li><code>approval_code</code>ï¼å®¡æ¹å®ä¹çå¯ä¸æ è¯</li>
<li>è¡¨åæ§ä»¶ç <code>id</code>ï¼ç¨äºç¨åºå¡«åè¡¨åæ°æ®</li>
</ul>
<h4 id="éç½®äºä»¶è®¢é">éç½®äºä»¶è®¢é</h4>
<p>å¨é£ä¹¦å¼æ¾å¹³å°éç½® Webhookï¼</p>
<table>
<thead>
<tr>
<th>éç½®é¡¹</th>
<th>å¼</th>
</tr>
</thead>
<tbody>
<tr>
<td>è¯·æ±ç½å</td>
<td><code>https://your-domain.com/api/feishu/webhook</code></td>
</tr>
<tr>
<td>éªè¯ Token</td>
<td><code>your_verification_token</code>ï¼èªå®ä¹ï¼</td>
</tr>
<tr>
<td>å å¯ Key</td>
<td><code>your_encrypt_key</code>ï¼èªå®ä¹ï¼</td>
</tr>
<tr>
<td>è®¢éäºä»¶</td>
<td><code>approval_instance</code>ï¼å®¡æ¹å®ä¾ç¶æåæ´ï¼</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="ç¬¬äºæ­¥net-ä¾§åºç¡æ­å»ºéæåºç³">ç¬¬äºæ­¥ï¼.NET ä¾§åºç¡æ­å»ºï¼éæåºç³ï¼</h3>
<h4 id="å°è£é£ä¹¦-api-å®¢æ·ç«¯">å°è£é£ä¹¦ API å®¢æ·ç«¯</h4>
<p>åºäº <code>MudFeishu SDK</code> å°è£å®¡æ¹æå¡ï¼</p>
<pre><code class="language-csharp">/// &lt;summary&gt;
/// é£ä¹¦å®¡æ¹æå¡å°è£
/// &lt;/summary&gt;
public class FeishuApprovalClient
{
    private readonly IFeishuTenantV4Approval _approvalApi;
    private readonly ILogger&lt;FeishuApprovalClient&gt; _logger;

    public FeishuApprovalClient(
        IFeishuTenantV4Approval approvalApi,
        ILogger&lt;FeishuApprovalClient&gt; logger)
    {
        _approvalApi = approvalApi;
        _logger = logger;
    }

    /// &lt;summary&gt;
    /// åå»ºå®¡æ¹å®ä¾
    /// &lt;/summary&gt;
    public async Task&lt;string&gt; CreateInstanceAsync(CreateInstanceRequest request)
    {
        var result = await _approvalApi.CreateInstanceAsync(request);

        if (result == null || result.Code != 0)
        {
            _logger.LogError("åå»ºå®¡æ¹å®ä¾å¤±è´¥: {Msg}", result?.Msg);
            throw new InvalidOperationException($"åå»ºå®¡æ¹å®ä¾å¤±è´¥: {result?.Msg}");
        }

        _logger.LogInformation("åå»ºå®¡æ¹å®ä¾æå: {InstanceCode}", result.Data?.InstanceCode);
        return result.Data?.InstanceCode ?? string.Empty;
    }

    /// &lt;summary&gt;
    /// è·åå®¡æ¹å®ä¾è¯¦æ
    /// &lt;/summary&gt;
    public async Task&lt;GetApprovalInstanceResult?&gt; GetInstanceAsync(string instanceCode)
    {
        var result = await _approvalApi.GetInstanceByIdAsync(instanceCode);

        if (result == null || result.Code != 0)
        {
            _logger.LogError("è·åå®¡æ¹å®ä¾å¤±è´¥: {Msg}", result?.Msg);
            return null;
        }

        return result.Data;
    }
}
</code></pre>
<h4 id="è®¾è®¡æ°æ®å³èè¡¨">è®¾è®¡æ°æ®å³èè¡¨</h4>
<p>å¨ä¸å¡æ°æ®åºä¸­æ·»å å®¡æ¹å³èè¡¨ï¼</p>
<pre><code class="language-sql">-- å®¡æ¹å³èè¡¨
CREATE TABLE ApprovalRecords (
    Id BIGINT PRIMARY KEY IDENTITY(1,1),
    BusinessType NVARCHAR(50) NOT NULL,          -- ä¸å¡ç±»åï¼LeaveRequest, PurchaseRequest...
    BusinessId BIGINT NOT NULL,                   -- ä¸å¡ID
    InstanceCode NVARCHAR(64) NOT NULL,           -- é£ä¹¦å®¡æ¹å®ä¾Code
    ApprovalCode NVARCHAR(64) NOT NULL,            -- å®¡æ¹å®ä¹Code
    Status NVARCHAR(20) NOT NULL,                  -- ç¶æï¼PENDING, APPROVED, REJECTED...
    CallbackData NVARCHAR(MAX),                   -- åè°æ°æ®ï¼JSONï¼
    CreatedTime DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    UpdatedTime DATETIME2 NOT NULL DEFAULT GETUTCDATE(),

    CONSTRAINT UK_ApprovalRecords_Business UNIQUE(BusinessType, BusinessId)
);

CREATE INDEX IX_ApprovalRecords_InstanceCode ON ApprovalRecords(InstanceCode);
CREATE INDEX IX_ApprovalRecords_Status ON ApprovalRecords(Status);
</code></pre>
<p>å¯¹åºçå®ä½ç±»ï¼</p>
<pre><code class="language-csharp">/// &lt;summary&gt;
/// å®¡æ¹å³èè®°å½
/// &lt;/summary&gt;
public class ApprovalRecord
{
    public long Id { get; set; }
    public string BusinessType { get; set; } = string.Empty;  // "LeaveRequest"
    public long BusinessId { get; set; }                       // è¯·åç³è¯·ID
    public string InstanceCode { get; set; } = string.Empty;   // é£ä¹¦å®ä¾Code
    public string ApprovalCode { get; set; } = string.Empty;    // å®¡æ¹å®ä¹Code
    public string Status { get; set; } = string.Empty;         // PENDING/APPROVED/REJECTED
    public string? CallbackData { get; set; }                  // JSONæ ¼å¼
    public DateTime CreatedTime { get; set; }
    public DateTime UpdatedTime { get; set; }
}
</code></pre>
<hr>
<h3 id="ç¬¬ä¸æ­¥æ ¸å¿ä¸å¡æµç¨ç¼ç ååèé">ç¬¬ä¸æ­¥ï¼æ ¸å¿ä¸å¡æµç¨ç¼ç ï¼ååèéï¼</h3>
<h4 id="åºæ¯ç¨æ·æäº¤è¯·åååèµ·å®¡æ¹">åºæ¯ï¼ç¨æ·æäº¤è¯·ååï¼åèµ·å®¡æ¹</h4>
<p><strong>æµç¨å¾</strong>ï¼</p>
<div class="mermaid">sequenceDiagram
    participant User as ç¨æ·
    participant Controller as LeaveController
    participant Service as LeaveService
    participant DB as æ°æ®åº
    participant FeishuAPI as é£ä¹¦API

    User-&gt;&gt;Controller: æäº¤è¯·åç³è¯·
    Controller-&gt;&gt;Service: SubmitLeaveRequest(request)
    Service-&gt;&gt;DB: ä¿å­è¯·åè®°å½ï¼ç¶æï¼å®¡æ¹ä¸­ï¼
    Service-&gt;&gt;Service: æé è¡¨åæ°æ®
    Service-&gt;&gt;FeishuAPI: CreateInstanceAsync(approvalCode, form)
    FeishuAPI--&gt;&gt;Service: instance_code
    Service-&gt;&gt;DB: ä¿å­ApprovalRecordå³è
    Service--&gt;&gt;Controller: æäº¤æå
    Controller--&gt;&gt;User: ç­å¾å®¡æ¹
</div><p><strong>ä»£ç å®ç°</strong>ï¼</p>
<pre><code class="language-csharp">/// &lt;summary&gt;
/// è¯·åæå¡
/// &lt;/summary&gt;
public class LeaveService
{
    private readonly ILeaveRequestRepository _leaveRepo;
    private readonly IApprovalRecordRepository _approvalRepo;
    private readonly FeishuApprovalClient _feishuClient;
    private readonly ILogger&lt;LeaveService&gt; _logger;

    public LeaveService(
        ILeaveRequestRepository leaveRepo,
        IApprovalRecordRepository approvalRepo,
        FeishuApprovalClient feishuClient,
        ILogger&lt;LeaveService&gt; logger)
    {
        _leaveRepo = leaveRepo;
        _approvalRepo = approvalRepo;
        _feishuClient = feishuClient;
        _logger = logger;
    }

    /// &lt;summary&gt;
    /// æäº¤è¯·åç³è¯·å¹¶åèµ·å®¡æ¹
    /// &lt;/summary&gt;
    public async Task&lt;long&gt; SubmitLeaveRequestAsync(SubmitLeaveRequestDto dto)
    {
        // 1. ä¿å­è¯·åä¸å¡æ°æ®
        var leaveRequest = new LeaveRequest
        {
            UserId = dto.UserId,
            LeaveType = dto.LeaveType,
            StartTime = dto.StartTime,
            EndTime = dto.EndTime,
            Days = dto.Days,
            Reason = dto.Reason,
            Status = LeaveStatus.Pending,  // å®¡æ¹ä¸­
            CreatedTime = DateTime.UtcNow
        };

        await _leaveRepo.AddAsync(leaveRequest);
        await _leaveRepo.SaveChangesAsync();

        // 2. æé é£ä¹¦å®¡æ¹è¡¨åæ°æ®
        var form = new List&lt;object&gt;
        {
            new { id = "leave_type", type = "select", value = dto.LeaveType },
            new { id = "start_time", type = "date", value = dto.StartTime.ToString("yyyy-MM-dd") },
            new { id = "end_time", type = "date", value = dto.EndTime.ToString("yyyy-MM-dd") },
            new { id = "days", type = "number", value = dto.Days.ToString() },
            new { id = "reason", type = "textarea", value = dto.Reason }
        };

        // 3. è°ç¨é£ä¹¦APIåå»ºå®¡æ¹å®ä¾
        var request = new CreateInstanceRequest
        {
            ApprovalCode = "7C468A54-8745-2245-9675-08B7C63E7A85",  // è¯·åå®¡æ¹å®ä¹Code
            UserId = dto.FeishuUserId,  // é£ä¹¦ç¨æ·ID
            Form = JsonSerializer.Serialize(form),
            Uuid = Guid.NewGuid().ToString()  // å¹ç­ID
        };

        string instanceCode;
        try
        {
            instanceCode = await _feishuClient.CreateInstanceAsync(request);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "åå»ºé£ä¹¦å®¡æ¹å®ä¾å¤±è´¥");
            // åæ»ä¸å¡æ°æ®
            leaveRequest.Status = LeaveStatus.Failed;
            await _leaveRepo.SaveChangesAsync();
            throw;
        }

        // 4. ä¿å­å®¡æ¹å³èè®°å½
        var approvalRecord = new ApprovalRecord
        {
            BusinessType = "LeaveRequest",
            BusinessId = leaveRequest.Id,
            InstanceCode = instanceCode,
            ApprovalCode = request.ApprovalCode,
            Status = "PENDING",
            CreatedTime = DateTime.UtcNow,
            UpdatedTime = DateTime.UtcNow
        };

        await _approvalRepo.AddAsync(approvalRecord);
        await _approvalRepo.SaveChangesAsync();

        _logger.LogInformation("è¯·åç³è¯·å·²æäº¤å¹¶åå»ºå®¡æ¹: LeaveId={LeaveId}, InstanceCode={InstanceCode}",
            leaveRequest.Id, instanceCode);

        return leaveRequest.Id;
    }
}
</code></pre>
<h4 id="åºæ¯å®¡æ¹å®ç»é£ä¹¦åè°éç¥ç»æ">åºæ¯ï¼å®¡æ¹å®ç»ï¼é£ä¹¦åè°éç¥ç»æ</h4>
<p><strong>åºäº Mud.Feishu.Webhook å®ç°å®å¨çåè°å¤çå¨</strong></p>
<pre><code class="language-csharp">using Mud.Feishu.Abstractions;
using Mud.Feishu.Abstractions.DataModels.Approval;
using Mud.Feishu.Abstractions.EventHandlers;

/// &lt;summary&gt;
/// å®¡æ¹å®ä¾äºä»¶å¤çå¨
/// &lt;/summary&gt;
public class ApprovalInstanceEventHandler : ApprovalInstanceEventHandler
{
    private readonly IApprovalRecordRepository _approvalRepo;
    private readonly ILeaveRequestRepository _leaveRepo;

    public ApprovalInstanceEventHandler(
        ILogger&lt;ApprovalInstanceEventHandler&gt; logger,
        IApprovalRecordRepository approvalRepo,
        ILeaveRequestRepository leaveRepo)
        : base(logger)
    {
        _approvalRepo = approvalRepo;
        _leaveRepo = leaveRepo;
    }

    /// &lt;summary&gt;
    /// å¤çå®¡æ¹å®ä¾äºä»¶ä¸å¡é»è¾
    /// &lt;/summary&gt;
    protected override async Task ProcessBusinessLogicAsync(
        EventData eventData,
        ObjectEventResult&lt;ApprovalInstanceResult&gt;? eventEntity,
        CancellationToken cancellationToken = default)
    {
        if (eventEntity?.Object == null)
        {
            _logger.LogWarning("å®¡æ¹å®ä¾äºä»¶æ°æ®æ æ");
            return;
        }

        var approvalEvent = eventEntity.Object;

        _logger.LogInformation("æ¶å°å®¡æ¹å®ä¾äºä»¶: InstanceCode={InstanceCode}, Status={Status}",
            approvalEvent.InstanceCode, approvalEvent.Status);

        // å¹ç­æ§å¤çï¼æ£æ¥æ¯å¦å·²å¤çè¿è¯¥äºä»¶
        var existingRecord = await _approvalRepo.GetByInstanceCodeAsync(approvalEvent.InstanceCode ?? string.Empty);
        if (existingRecord != null &amp;&amp; existingRecord.Status == approvalEvent.Status)
        {
            _logger.LogInformation("è¯¥äºä»¶å·²å¤çè¿ï¼è·³è¿: EventId={EventId}", eventData.EventId);
            return;
        }

        // æ ¹æ®ä¸å¡ç±»åå¤çå®¡æ¹ç»æ
        await ProcessApprovalResultAsync(eventData, approvalEvent, cancellationToken);
    }

    /// &lt;summary&gt;
    /// å¤çå®¡æ¹ç»æ
    /// &lt;/summary&gt;
    private async Task ProcessApprovalResultAsync(
        EventData eventData,
        ApprovalInstanceResult approvalEvent,
        CancellationToken cancellationToken)
    {
        if (string.IsNullOrEmpty(approvalEvent.InstanceCode))
        {
            _logger.LogWarning("å®¡æ¹å®ä¾Codeä¸ºç©ºï¼è·³è¿å¤ç");
            return;
        }

        // æ¥è¯¢å®¡æ¹å³èè®°å½
        var approvalRecord = await _approvalRepo.GetByInstanceCodeAsync(approvalEvent.InstanceCode);
        if (approvalRecord == null)
        {
            _logger.LogWarning("æªæ¾å°å®¡æ¹å³èè®°å½: InstanceCode={InstanceCode}",
                approvalEvent.InstanceCode);
            return;
        }

        // æ´æ°å®¡æ¹è®°å½ç¶æ
        approvalRecord.Status = approvalEvent.Status ?? string.Empty;
        approvalRecord.CallbackData = JsonSerializer.Serialize(approvalEvent);
        approvalRecord.UpdatedTime = DateTime.UtcNow;
        await _approvalRepo.SaveChangesAsync();

        // æ ¹æ®ä¸å¡ç±»åå¤ç
        switch (approvalRecord.BusinessType)
        {
            case "LeaveRequest":
                await ProcessLeaveApprovalAsync(approvalRecord, approvalEvent.Status ?? string.Empty);
                break;

            // å¯æ©å±å¶ä»ä¸å¡ç±»å
            default:
                _logger.LogWarning("æªç¥çä¸å¡ç±»å: {BusinessType}", approvalRecord.BusinessType);
                break;
        }
    }

    /// &lt;summary&gt;
    /// å¤çè¯·åå®¡æ¹ç»æ
    /// &lt;/summary&gt;
    private async Task ProcessLeaveApprovalAsync(ApprovalRecord approvalRecord, string status)
    {
        var leaveRequest = await _leaveRepo.GetByIdAsync(approvalRecord.BusinessId);
        if (leaveRequest == null)
        {
            _logger.LogWarning("æªæ¾å°è¯·åç³è¯·: BusinessId={BusinessId}", approvalRecord.BusinessId);
            return;
        }

        // æ ¹æ®å®¡æ¹ç¶ææ´æ°è¯·åè®°å½
        leaveRequest.Status = status switch
        {
            "APPROVED" =&gt; LeaveStatus.Approved,
            "REJECTED" =&gt; LeaveStatus.Rejected,
            "CANCELED" =&gt; LeaveStatus.Canceled,
            "DELETED" =&gt; LeaveStatus.Deleted,
            _ =&gt; LeaveStatus.Pending
        };

        leaveRequest.UpdatedTime = DateTime.UtcNow;
        await _leaveRepo.SaveChangesAsync();

        _logger.LogInformation("è¯·åç³è¯·ç¶æå·²æ´æ°: LeaveId={LeaveId}, Status={Status}",
            leaveRequest.Id, leaveRequest.Status);

        // TODO: åééç¥ç»ç³è¯·äºº
        // TODO: åæ­¥å°èå¤ç³»ç»
    }
}
</code></pre>
<p><strong>æ³¨å Webhook æå¡ï¼Program.csï¼</strong>ï¼</p>
<pre><code class="language-csharp">using Mud.Feishu.Webhook;
using Mud.Feishu;
using YourApp.Handlers;

var builder = WebApplication.CreateBuilder(args);

// æ³¨åé£ä¹¦ API æå¡
builder.Services.AddFeishuServices()
    .ConfigureFrom(builder.Configuration)  // ä» "Feishu" éç½®èè¯»å
    .Build();

// æ³¨åé£ä¹¦ Webhook äºä»¶è®¢éæå¡
builder.Services.AddFeishuWebhookServiceBuilder()
    .ConfigureFrom(builder.Configuration)  // ä» "FeishuWebhook" éç½®èè¯»å
    .AddHandler&lt;ApprovalInstanceEventHandler&gt;()  // æ·»å å®¡æ¹äºä»¶å¤çå¨
    .Build();

// æ³¨åä¸å¡æå¡
builder.Services.AddScoped&lt;ILeaveRequestRepository, LeaveRequestRepository&gt;();
builder.Services.AddScoped&lt;IApprovalRecordRepository, ApprovalRecordRepository&gt;();

var app = builder.Build();

app.UseFeishuWebhook();  // æ·»å  Webhook ä¸­é´ä»¶

app.Run();
</code></pre>
<p><strong>è¯´æ</strong>ï¼</p>
<ul>
<li><code>ApprovalInstanceEventHandler</code> ç»§æ¿èª <code>ApprovalInstanceEventHandler</code> åºç±»</li>
<li>åºç±»å·²ç»å®ç°äº <code>HandleAsync</code> æ¹æ³ï¼ä¼èªå¨ååºåå <code>ApprovalInstanceResult</code> ç±»åçäºä»¶æ°æ®</li>
<li>åªééå <code>ProcessBusinessLogicAsync</code> æ¹æ³å®ç°å·ä½çä¸å¡é»è¾å³å¯</li>
<li>SDK ä¼æ ¹æ® <code>SupportedEventType</code> å±æ§èªå¨è·¯ç±å¯¹åºçäºä»¶å°è¿ä¸ªå¤çå¨</li>
<li><code>AddFeishuServices()</code> æ³¨åé£ä¹¦ API å®¢æ·ç«¯æå¡ï¼ä½¿ç¨ <code>Feishu</code> éç½®è</li>
<li><code>AddFeishuWebhookServiceBuilder()</code> æ³¨å Webhook äºä»¶è®¢éæå¡ï¼ä½¿ç¨ <code>FeishuWebhook</code> éç½®è</li>
</ul>
<p><strong>éç½®æä»¶ï¼appsettings.jsonï¼</strong>ï¼</p>
<pre><code class="language-json">{
  // é£ä¹¦ Webhook äºä»¶è®¢ééç½®
  "FeishuWebhook": {
    "VerificationToken": "your_verification_token",
    "EncryptKey": "your_encrypt_key",
    "RoutePrefix": "api/feishu/webhook",
    "AutoRegisterEndpoint": true,
    "EnableRequestLogging": true,
    "EnableExceptionHandling": true,
    "EventHandlingTimeoutMs": 30000,
    "MaxConcurrentEvents": 10
  },

  // é£ä¹¦ API å®¢æ·ç«¯éç½®
  "Feishu": {
    "AppId": "your_app_id",
    "AppSecret": "your_app_secret",
    "BaseUrl": "https://open.feishu.cn",
    "TimeOut": "30",
    "RetryCount": 3,
    "EnableLogging": true
  }
}
</code></pre>
<hr>
<h3 id="ç¬¬åæ­¥åè½å®åä¸èè°æµè¯">ç¬¬åæ­¥ï¼åè½å®åä¸èè°æµè¯</h3>
<h4 id="ç¶æåæ­¥å±ç¤º">ç¶æåæ­¥å±ç¤º</h4>
<p>å¨è¯·ååè¡¨é¡µå±ç¤ºå®¡æ¹ç¶æï¼</p>
<pre><code class="language-csharp">/// &lt;summary&gt;
/// è¯·ååè¡¨ååºDTO
/// &lt;/summary&gt;
public class LeaveRequestDto
{
    public long Id { get; set; }
    public DateTime StartTime { get; set; }
    public DateTime EndTime { get; set; }
    public int Days { get; set; }
    public string Status { get; set; } = string.Empty;      // ä¸å¡ç¶æï¼Approved, Rejected
    public string ApprovalStatus { get; set; } = string.Empty; // é£ä¹¦å®¡æ¹ç¶æï¼APPROVED, REJECTED, PENDING
    public string? FeishuInstanceUrl { get; set; }          // é£ä¹¦å®¡æ¹è¯¦æé¾æ¥
    public DateTime CreatedTime { get; set; }
}

/// &lt;summary&gt;
/// æ¥è¯¢è¯·ååè¡¨
/// &lt;/summary&gt;
public async Task&lt;List&lt;LeaveRequestDto&gt;&gt; GetLeaveListAsync(long userId)
{
    var leaves = await _leaveRepo.GetByUserIdAsync(userId);
    var instanceCodes = leaves.Select(l =&gt; l.InstanceCode).ToList();

    // æ¹éæ¥è¯¢å®¡æ¹è®°å½
    var approvals = await _approvalRepo.GetByInstanceCodesAsync(instanceCodes);

    var result = leaves.Select(leave =&gt;
    {
        var approval = approvals.FirstOrDefault(a =&gt; a.InstanceCode == leave.InstanceCode);

        return new LeaveRequestDto
        {
            Id = leave.Id,
            StartTime = leave.StartTime,
            EndTime = leave.EndTime,
            Days = leave.Days,
            Status = leave.Status.ToString(),
            ApprovalStatus = approval?.Status ?? "UNKNOWN",
            FeishuInstanceUrl = !string.IsNullOrEmpty(approval?.InstanceCode)
                ? $"https://www.feishu.cn/approval/approval/view/{approval.InstanceCode}"
                : null,
            CreatedTime = leave.CreatedTime
        };
    }).ToList();

    return result;
}
</code></pre>
<h4 id="æ·»å å¨é£ä¹¦ä¸­æ¥çé¾æ¥">æ·»å "å¨é£ä¹¦ä¸­æ¥ç"é¾æ¥</h4>
<p>å¨åè¡¨é¡µæ·»å æä½æé®ï¼</p>
<pre><code class="language-html">&lt;!-- åç«¯é¡µé¢ç¤ºä¾ --&gt;
&lt;table class="leave-list"&gt;
    &lt;thead&gt;
        &lt;tr&gt;
            &lt;th&gt;å¼å§æ¶é´&lt;/th&gt;
            &lt;th&gt;ç»ææ¶é´&lt;/th&gt;
            &lt;th&gt;å¤©æ°&lt;/th&gt;
            &lt;th&gt;å®¡æ¹ç¶æ&lt;/th&gt;
            &lt;th&gt;æä½&lt;/th&gt;
        &lt;/tr&gt;
    &lt;/thead&gt;
    &lt;tbody&gt;
        @foreach (var leave in Model.Leaves)
        {
            &lt;tr&gt;
                &lt;td&gt;@leave.StartTime.ToString("yyyy-MM-dd")&lt;/td&gt;
                &lt;td&gt;@leave.EndTime.ToString("yyyy-MM-dd")&lt;/td&gt;
                &lt;td&gt;@leave.Days&lt;/td&gt;
                &lt;td&gt;
                    &lt;span class="status @leave.ApprovalStatus"&gt;
                        @GetStatusText(leave.ApprovalStatus)
                    &lt;/span&gt;
                &lt;/td&gt;
                &lt;td&gt;
                    @if (!string.IsNullOrEmpty(leave.FeishuInstanceUrl))
                    {
                        &lt;a href="@leave.FeishuInstanceUrl" target="_blank" class="btn"&gt;
                            å¨é£ä¹¦ä¸­æ¥ç
                        &lt;/a&gt;
                    }
                &lt;/td&gt;
            &lt;/tr&gt;
        }
    &lt;/tbody&gt;
&lt;/table&gt;
</code></pre>
<h4 id="èè°æµè¯">èè°æµè¯</h4>
<table>
<thead>
<tr>
<th>æµè¯åºæ¯</th>
<th>éªè¯è¦ç¹</th>
<th>æµè¯å·¥å·</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>åèµ·å®¡æ¹</strong></td>
<td>é£ä¹¦æ¯å¦æ¶å°å®¡æ¹éç¥ãè¡¨åæ°æ®æ¯å¦æ­£ç¡®</td>
<td>ç´æ¥å¨ç³»ç»åèµ·</td>
</tr>
<tr>
<td><strong>å®¡æ¹æµç¨</strong></td>
<td>åå®¡æ¹èç¹æ¯å¦æ­£ç¡®æµè½¬</td>
<td>é£ä¹¦ç®¡çåå°</td>
</tr>
<tr>
<td><strong>åè°æ¥æ¶</strong></td>
<td>Webhookæ¯å¦æ­£ç¡®æ¥æ¶äºä»¶ãæ°æ®æ¯å¦å®æ´</td>
<td>é£ä¹¦"æ¨¡æäºä»¶æ¨é"å·¥å·</td>
</tr>
<tr>
<td><strong>ç¶æåæ­¥</strong></td>
<td>ä¸å¡ç¶ææ¯å¦æ­£ç¡®æ´æ°ãéç¥æ¯å¦åé</td>
<td>æ°æ®åºæ¥è¯¢ãæ¥å¿æ¥ç</td>
</tr>
<tr>
<td><strong>å¼å¸¸å¤ç</strong></td>
<td>ç½ç»å¼å¸¸ãç­¾åéªè¯å¤±è´¥ç­è¾¹çæåµ</td>
<td>æ¨¡æå¼å¸¸åºæ¯</td>
</tr>
</tbody>
</table>
<p><strong>é£ä¹¦æ¨¡æäºä»¶æ¨éå·¥å·</strong>ï¼</p>
<p>å¨é£ä¹¦å¼æ¾å¹³å°ç"äºä»¶è®¢é"é¡µé¢ï¼å¯ä»¥ä½¿ç¨"æ¨¡æäºä»¶æ¨é"åè½æµè¯ Webhook æ¥å£ï¼</p>
<div class="mermaid">graph LR
    A[é£ä¹¦ç®¡çåå°] --&gt;|æ¨¡æäºä»¶æ¨é| B[Webhookæ¥å£]
    B --&gt;|æ¥å¿è¾åº| C[æ£æ¥å¤çç»æ]
    C --&gt;|æå| D[éªè¯å®æ]
    C --&gt;|å¤±è´¥| E[æ¥çéè¯¯æ¥å¿]
</div><hr>
<h2 id="çäº§çº§æ³¨æäºé¡¹">çäº§çº§æ³¨æäºé¡¹</h2>
<h3 id="å®å¨ä¸å¯é æ§">å®å¨ä¸å¯é æ§</h3>
<h4 id="æºå¯ç®¡ç">æºå¯ç®¡ç</h4>
<p><strong>åå¿å°ææä¿¡æ¯ç¡¬ç¼ç å¨ä»£ç ä¸­ï¼</strong></p>
<pre><code class="language-csharp">// â éè¯¯ç¤ºä¾
var appSecret = "cli_xxxxxxxxxxxxxxx";  // å±é©ï¼

// â æ­£ç¡®ç¤ºä¾
builder.Configuration.AddAzureKeyVault(
    new Uri($"https://{vaultName}.vault.azure.net/"),
    new DefaultAzureCredential());

var appSecret = builder.Configuration["Feishu:AppSecret"];
</code></pre>
<p><strong>æ¨èæ¹æ¡</strong>ï¼</p>
<ul>
<li>Azure Key Vault / AWS Secrets Manager</li>
<li>HashiCorp Vault</li>
<li>Docker Secretsï¼å®¹å¨åé¨ç½²ï¼</li>
</ul>
<h4 id="å¹ç­æ§å¤ç">å¹ç­æ§å¤ç</h4>
<p>é£ä¹¦å¯è½ä¼éå¤æ¨éåä¸ä¸ªäºä»¶ï¼ç½ç»éè¯ç­ï¼ï¼å¿é¡»ä¿è¯ä¸å¡é»è¾çå¹ç­æ§ï¼</p>
<pre><code class="language-csharp">public async Task HandleAsync(EventData eventData, CancellationToken cancellationToken = default)
{
    // ä½¿ç¨ EventId æ instance_code + status ç»åä½ä¸ºå¹ç­é®
    var idempotencyKey = $"{approvalEvent.InstanceCode}_{approvalEvent.Status}";

    // æ£æ¥æ¯å¦å·²å¤çè¿
    if (await _cache.ExistsAsync(idempotencyKey))
    {
        _logger.LogInformation("äºä»¶å·²å¤çè¿ï¼è·³è¿: Key={IdempotencyKey}", idempotencyKey);
        return;
    }

    // æ è®°ä¸ºå·²å¤çï¼è®¾ç½®è¿ææ¶é´ï¼å¦24å°æ¶ï¼
    await _cache.SetAsync(idempotencyKey, "1", TimeSpan.FromHours(24));

    // æ§è¡ä¸å¡é»è¾
    await ProcessEventAsync(approvalEvent, cancellationToken);
}
</code></pre>
<h4 id="api-å®¹é">API å®¹é</h4>
<p>ä½¿ç¨ Polly ä¸ºé£ä¹¦ API è°ç¨æ·»å éè¯åçæ­æºå¶ï¼</p>
<pre><code class="language-csharp">// æ³¨å HttpClient æ¶æ·»å  Polly ç­ç¥
builder.Services.AddHttpClient("Feishu")
    .AddTransientHttpErrorPolicy(p =&gt;
        p.WaitAndRetryAsync(3, retryAttempt =&gt;
            TimeSpan.FromSeconds(Math.Pow(2, retryAttempt))))
    .AddPolicyHandler(Policy&lt;HttpResponseMessage&gt;
        .Handle&lt;HttpRequestException&gt;()
        .CircuitBreakerAsync(5, TimeSpan.FromSeconds(30)));
</code></pre>
<h3 id="è¾¹çæåµä¸ä¼ééçº§">è¾¹çæåµä¸ä¼ééçº§</h3>
<h4 id="å®¡æ¹äººå¤±æå¤ç">å®¡æ¹äººå¤±æå¤ç</h4>
<pre><code class="language-csharp">// é£ä¹¦å®¡æ¹å®ä¹ä¸­éç½®é»è®¤å®¡æ¹äºº
var request = new CreateInstanceRequest
{
    ApprovalCode = "xxxx",
    // å¦æèªéå®¡æ¹äººä¸ºç©ºï¼ä½¿ç¨é»è®¤å®¡æ¹äºº
    NodeApproverUserIdLists = dto.ApproverUserId.HasValue
        ? new[] { new NodeApprover { NodeId = "node1", ApproverUserIds = new[] { dto.ApproverUserId.Value } } }
        : null  // èµ°é»è®¤å®¡æ¹äººæµç¨
};
</code></pre>
<h4 id="ç½ç»è¶æ¶ä¸å¼æ­¥å¤ç">ç½ç»è¶æ¶ä¸å¼æ­¥å¤ç</h4>
<p>åè°å¤çåºå¿«éååºé£ä¹¦ï¼å»ºè®®å¨ 3 ç§åï¼ï¼å¤æé»è¾ç§»è³åå°ä½ä¸ï¼</p>
<pre><code class="language-csharp">public async Task HandleAsync(EventData eventData, CancellationToken cancellationToken = default)
{
    // 1. å¿«éä¿å­äºä»¶å°éå
    await _eventQueue.EnqueueAsync(eventData);

    // 2. ç«å³è¿åï¼ç±åå°ä½ä¸å¤ç
    // HangfireãRabbitMQ ç­ä¼å¼æ­¥æ¶è´¹éå
    await Task.CompletedTask;
}

// åå°ä½ä¸å¤ç
[Queue("approval-callback")]
public async Task ProcessApprovalEventAsync(EventData eventData)
{
    // å¤æçä¸å¡é»è¾å¤ç
    await _approvalService.ProcessCallbackAsync(eventData);
}
</code></pre>
<h4 id="çæ§ä¸åè­¦">çæ§ä¸åè­¦</h4>
<p>å»ºç«å³é®èç¹ççæ§ï¼</p>
<pre><code class="language-csharp">// çæ§ææ 
public class ApprovalMetrics
{
    private readonly Counter _approvalCreatedCounter;
    private readonly Counter _callbackReceivedCounter;
    private readonly Histogram _processingTimeHistogram;

    public void RecordApprovalCreated(string approvalType)
    {
        _approvalCreatedCounter.WithLabels(approvalType).Inc();
    }

    public void RecordCallbackReceived(string status)
    {
        _callbackReceivedCounter.WithLabels(status).Inc();
    }

    public void RecordProcessingTime(TimeSpan duration)
    {
        _processingTimeHistogram.Observe(duration.TotalSeconds);
    }
}

// åè­¦è§åï¼Prometheus ç¤ºä¾ï¼
# å®¡æ¹åèµ·å¤±è´¥çè¶è¿ 5% è§¦ååè­¦
alert: ApprovalCreationFailureRate
expr: rate(approval_creation_failed_total[5m]) / rate(approval_creation_total[5m]) &gt; 0.05
for: 5m
annotations:
  summary: "å®¡æ¹åå»ºå¤±è´¥çè¿é«"
</code></pre>
<h3 id="æ©å±æ§ä¸ç»´æ¤æ§">æ©å±æ§ä¸ç»´æ¤æ§</h3>
<h4 id="ç­ç¥æ¨¡å¼æ¯æå¤å¹³å°">ç­ç¥æ¨¡å¼æ¯æå¤å¹³å°</h4>
<pre><code class="language-csharp">/// &lt;summary&gt;
/// å®¡æ¹å¹³å°ç­ç¥æ¥å£
/// &lt;/summary&gt;
public interface IApprovalPlatformStrategy
{
    string PlatformName { get; }
    Task&lt;string&gt; CreateInstanceAsync(ApprovalRequest request);
}

/// &lt;summary&gt;
/// é£ä¹¦å®¡æ¹ç­ç¥
/// &lt;/summary&gt;
public class FeishuApprovalStrategy : IApprovalPlatformStrategy
{
    public string PlatformName =&gt; "Feishu";
    // ... å®ç°
}

/// &lt;summary&gt;
/// ééå®¡æ¹ç­ç¥
/// &lt;/summary&gt;
public class DingTalkApprovalStrategy : IApprovalPlatformStrategy
{
    public string PlatformName =&gt; "DingTalk";
    // ... å®ç°
}

/// &lt;summary&gt;
/// å®¡æ¹ç­ç¥å·¥å
/// &lt;/summary&gt;
public class ApprovalStrategyFactory
{
    private readonly IEnumerable&lt;IApprovalPlatformStrategy&gt; _strategies;

    public IApprovalPlatformStrategy GetStrategy(string platformName)
    {
        return _strategies.FirstOrDefault(s =&gt; s.PlatformName == platformName)
            ?? throw new NotSupportedException($"ä¸æ¯æçå®¡æ¹å¹³å°: {platformName}");
    }
}
</code></pre>
<h4 id="å®¡è®¡æ¥å¿">å®¡è®¡æ¥å¿</h4>
<p>è¯¦ç»è®°å½å®¡æ¹æµè½¬æ¢çå³é®æ¥å¿ï¼</p>
<pre><code class="language-csharp">public class ApprovalAuditService
{
    private readonly IApprovalAuditRepository _auditRepo;

    public async Task LogAsync(ApprovalAuditLog log)
    {
        log.Timestamp = DateTime.UtcNow;
        await _auditRepo.AddAsync(log);
        await _auditRepo.SaveChangesAsync();

        // ç»æåæ¥å¿è¾åº
        _logger.LogInformation("å®¡æ¹å®¡è®¡: {AuditType}, InstanceCode={InstanceCode}, BusinessId={BusinessId}",
            log.AuditType, log.InstanceCode, log.BusinessId);
    }
}

// ä½¿ç¨ç¤ºä¾
await _auditService.LogAsync(new ApprovalAuditLog
{
    AuditType = "ApprovalStarted",
    InstanceCode = instanceCode,
    BusinessId = leaveRequest.Id,
    OperatorId = userId,
    Details = new { leaveType, days, reason }
});
</code></pre>
<hr>
<h2 id="æåä¸ç¹åå®¹">æåä¸ç¹åå®¹</h2>
<h3 id="æ ¸å¿ä»·å¼">æ ¸å¿ä»·å¼</h3>
<p>éè¿æ¬æçå®è·µï¼æä»¬æåå®ç°äºï¼</p>
<table>
<thead>
<tr>
<th>ä»·å¼ç¹</th>
<th>å®ç°æ¹å¼</th>
<th>æ¶ç</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>ç§»å¨åå®¡æ¹</strong></td>
<td>é£ä¹¦ App ä½ä¸ºå®¡æ¹é¨æ·</td>
<td>éæ¶éå°å¤çå®¡æ¹</td>
</tr>
<tr>
<td><strong>å³æ¶éç¥</strong></td>
<td>é£ä¹¦å¼ºéç¥æºå¶</td>
<td>å®¡æ¹äººåæ¶ååº</td>
</tr>
<tr>
<td><strong>æ°æ®é­ç¯</strong></td>
<td>.NET ä¸å¡åº + å®¡æ¹å³èè¡¨</td>
<td>å®æ´çä¸å¡æµç¨è¿½è¸ª</td>
</tr>
<tr>
<td><strong>è§£è¦è®¾è®¡</strong></td>
<td>é¢åå±æ½è±¡ + ç­ç¥æ¨¡å¼</td>
<td>ä¾¿äºæ©å±åç»´æ¤</td>
</tr>
</tbody>
</table>
<h3 id="å¨ææ»ç»">å¨ææ»ç»</h3>
<p>æ¬ææä¾äºä¸ä¸ªä»çå¿µãè®¾è®¡å°ç¼ç è½å°çå®æ´é­ç¯ï¼</p>
<div class="mermaid">mindmap
  root((é£ä¹¦å®¡æ¹éæ))
    çå¿µ
      ååéæ
      .NETä¸ºä¸å¡æ ¸å¿
      é£ä¹¦ä¸ºæµç¨é¨æ·
    è®¾è®¡
      åå±æ¶æ
      é¢åæ½è±¡
      å®å¨æºå¶
    å®ç°
      åèµ·å®¡æ¹
      åè°å¤ç
      ç¶æåæ­¥
    æä½³å®è·µ
      æºå¯ç®¡ç
      å¹ç­æ§
      å¼æ­¥å¤ç
      çæ§åè­¦
</div><h3 id="æ©å±">æ©å±</h3>
<h4 id="åºæ¯æ©å±">åºæ¯æ©å±</h4>
<p>å°æ­¤æ¨¡å¼å¿«éå¤ç¨äºå¶ä»ä¸å¡åºæ¯ï¼</p>
<table>
<thead>
<tr>
<th>ä¸å¡åºæ¯</th>
<th>å®¡æ¹æµç¨</th>
<th>å¤æåº¦</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>æ¥éå®¡æ¹</strong></td>
<td>åèµ· â ç´å±ä¸»ç®¡ â è´¢å¡å®¡æ ¸</td>
<td>ä¸­</td>
</tr>
<tr>
<td><strong>éè´­ç³è¯·</strong></td>
<td>åèµ· â é¨é¨ä¸»ç®¡ â éè´­é¨ â æ»ç»ç</td>
<td>é«</td>
</tr>
<tr>
<td><strong>ååå®¡æ¹</strong></td>
<td>æ³å¡å®¡æ ¸ â è´¢å¡å®¡æ ¸ â æ»ç»ç</td>
<td>é«</td>
</tr>
<tr>
<td><strong>å ç­ç³è¯·</strong></td>
<td>ç´å±ä¸»ç®¡å®¡æ¹</td>
<td>ä½</td>
</tr>
</tbody>
</table>
<h4 id="æ·±åº¦éæ">æ·±åº¦éæ</h4>
<p>å©ç¨é£ä¹¦æ´å¤è½åï¼æé æ´ä¸°å¯çååä½éªï¼</p>
<div class="mermaid">graph TB
    A[é£ä¹¦å®¡æ¹] --&gt; B[æ¶æ¯å¡ç]
    A --&gt; C[æºè½æºå¨äºº]
    A --&gt; D[ç¥è¯åº]

    B --&gt; B1[å®¡æ¹è¯¦æå±ç¤º]
    B --&gt; B2[æä½æé®]
    C --&gt; C1[æºè½æé]
    C --&gt; C2[èªå¨è¡¥å¨]
    D --&gt; D1[åå²è®°å½æ¥è¯¢]
    D --&gt; D2[å®¡æ¹è§è]

    E[.NETç³»ç»] --&gt; A
    B --&gt; E
    C --&gt; E
    D --&gt; E
</div><p><strong>åè½æ©å±ç¤ºä¾</strong>ï¼</p>
<ul>
<li>å¨é£ä¹¦ç¾¤èä¸­éè¿æ¶æ¯å¡çç´æ¥æ¥çå®¡æ¹è¯¦æ</li>
<li>éè¿æºå¨äººæºè½åå¤ï¼å¼å¯¼ç¨æ·å¡«åå®¡æ¹è¡¨å</li>
<li>å°å®¡æ¹è®°å½åæ­¥å°é£ä¹¦ç¥è¯åºï¼æ¹ä¾¿æ¥é</li>
</ul>
<h4 id="å¹³å°å">å¹³å°å</h4>
<p>å°å®¡æ¹éæè½åæ½è±¡ä¸ºä¸­å°æå¡ï¼ä¾ä¼ä¸åé¨ææç³»ç»ç»ä¸è°ç¨ï¼</p>
<pre><code class="language-csharp">/// &lt;summary&gt;
/// ç»ä¸å®¡æ¹æå¡ä¸­å°
/// &lt;/summary&gt;
public interface IApprovalCenterService
{
    /// &lt;summary&gt;
    /// ç»ä¸åèµ·å®¡æ¹ï¼æ¯æå¤å¹³å°ï¼
    /// &lt;/summary&gt;
    Task&lt;string&gt; CreateApprovalAsync(UnifiedApprovalRequest request);

    /// &lt;summary&gt;
    /// æ¥è¯¢å®¡æ¹ç¶æ
    /// &lt;/summary&gt;
    Task&lt;ApprovalStatus&gt; GetStatusAsync(string instanceId);

    /// &lt;summary&gt;
    /// å®¡æ¹ç»è®¡æ¥è¡¨
    /// &lt;/summary&gt;
    Task&lt;ApprovalStatistics&gt; GetStatisticsAsync(DateTime from, DateTime to);
}

// å¤ä¸ªç³»ç»ç»ä¸è°ç¨
await _approvalCenter.CreateApprovalAsync(new UnifiedApprovalRequest
{
    BusinessSystem = "HR",
    BusinessType = "LeaveRequest",
    BusinessId = leaveId,
    Platform = "Feishu"  // å¯åæ¢å°å¶ä»å¹³å°
});
</code></pre>
<hr>
<p><strong>ç»è¯­</strong></p>
<p>ä¼ ç» .NET ç³»ç»æ éæ¨åéæ¥ï¼éè¿åççæ¶æè®¾è®¡ä¸é£ä¹¦å®¡æ¹çæ·±åº¦éæï¼åæ ·å¯ä»¥çåæ°çæ´»åãå¸ææ¬æçå®è·µè½å¤ä¸ºä½ çæ°å­åè½¬åä¹è·¯æä¾æä»·å¼çåèã</p>
<p>è®©æä»¬ä¸èµ·åå«ä¿¡æ¯å­¤å²ï¼æ¥æ±ç°ä»£åçåååå¬ä½éªï¼ð</p>
<hr>
<h2 id="ç¸å³èµæº">ç¸å³èµæº</h2>
<h3 id="é¡¹ç®å°å">é¡¹ç®å°å</h3>
<ul>
<li>
<p><strong>Gitee ä»åº</strong>ï¼<a href="https://gitee.com/mudtools/MudFeishu" target="_blank" rel="noopener nofollow">https://gitee.com/mudtools/MudFeishu</a></p>
</li>
<li>
<p><strong>GitHub ä»åº</strong>ï¼<a href="https://github.com/mudtools/MudFeishu" target="_blank" rel="noopener nofollow">https://github.com/mudtools/MudFeishu</a></p>
</li>
<li>
<p><strong>NuGet å</strong>ï¼</p>
<ul>
<li>
<p><a href="https://www.nuget.org/packages/Mud.Feishu.Abstractions/" target="_blank" rel="noopener nofollow">Mud.Feishu.Abstractions</a></p>
</li>
<li>
<p><a href="https://www.nuget.org/packages/Mud.Feishu/" target="_blank" rel="noopener nofollow">Mud.Feishu</a></p>
</li>
<li>
<p><a href="https://www.nuget.org/packages/Mud.Feishu.WebSocket/" target="_blank" rel="noopener nofollow">Mud.Feishu.WebSocket</a></p>
</li>
<li>
<p><a href="https://www.nuget.org/packages/Mud.Feishu.Webhook/" target="_blank" rel="noopener nofollow">Mud.Feishu.Webhook</a></p>
</li>
</ul>
</li>
</ul>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-01-05 22:39">2026-01-05 22:39</span>&nbsp;
<a href="https://www.cnblogs.com/mudtools">ç©æ³¥å·´ç|mudtools.cn</a>&nbsp;
éè¯»(<span id="post_view_count">3</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19444914);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19444914', targetLink: 'https://www.cnblogs.com/mudtools/p/19444914', title: '.NET ä¼ ç»ä¿¡æ¯ç³»ç»æ ç¼éæé£ä¹¦å®¡æ¹æµ' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ ãé¢è¯é¢ãMySQL ä¸å± B+ æ è½å­å¤å°æ°æ®ï¼ ]]></title>
    <link>https://www.cnblogs.com/sun-10387834/p/19388703</link>
    <guid>4e390dbb21be3d93bcaa38c96d99eb3f</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/sun-10387834/p/19388703" title="åå¸äº 2026-01-05 18:57">
    <span role="heading" aria-level="2">ãé¢è¯é¢ãMySQL ä¸å± B+ æ è½å­å¤å°æ°æ®ï¼</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<p>è¿æ¯ä¸ä¸ªç»å¸çé¢è¯é¢ï¼ä½å®éä¼°ç®éè¦èèå¤ä¸ªåéãä¸é¢æå°è¯¦ç»æè§£è®¡ç®è¿ç¨ï¼</p>
<h2 id="æ ¸å¿è®¡ç®æ¨¡å"><strong>æ ¸å¿è®¡ç®æ¨¡å</strong></h2>
<p>MySQL B+æ å­å¨é = æ ¹èç¹æåº Ã ä¸­é´èç¹æåº Ã å¶å­èç¹å®¹é</p>
<hr>
<h2 id="å³é®åè®¾ä»¥innodbé»è®¤éç½®ä¸ºä¾"><strong>å³é®åè®¾ï¼ä»¥InnoDBé»è®¤éç½®ä¸ºä¾ï¼</strong></h2>
<ol>
<li><strong>é¡µå¤§å°</strong>ï¼16KBï¼16384å­èï¼</li>
<li><strong>ä¸»é®ç±»å</strong>ï¼BIGINTï¼8å­èï¼</li>
<li><strong>æéå¤§å°</strong>ï¼6å­èï¼InnoDBé¡µæéï¼</li>
<li><strong>è¡æ°æ®å¤§å°</strong>ï¼1KBï¼1024å­èï¼ - <em>è¿æ¯å³é®åé</em></li>
<li><strong>é¡µç©ºé´å©ç¨ç</strong>ï¼çº¦70%ï¼éæ£é¤é¡µå¤´ãé¡µå°¾ç­åæ°æ®ï¼</li>
</ol>
<hr>
<h2 id="ä¸å±bæ ç»æ"><strong>ä¸å±B+æ ç»æ</strong></h2>
<pre><code>ç¬¬1å±ï¼æ ¹èç¹ï¼1ä¸ªï¼
ç¬¬2å±ï¼ä¸­é´èç¹ï¼fan_outä¸ªï¼
ç¬¬3å±ï¼å¶å­èç¹ï¼fan_outÂ²ä¸ªï¼ â å­å¨å®éæ°æ®
</code></pre>
<hr>
<h2 id="è¯¦ç»è®¡ç®æ­¥éª¤"><strong>è¯¦ç»è®¡ç®æ­¥éª¤</strong></h2>
<h3 id="1-è®¡ç®åä¸ªéå¶å­èç¹è½å­å¨çé®å¼å¯¹æ°éfan_out"><strong>1. è®¡ç®åä¸ªéå¶å­èç¹è½å­å¨çé®å¼å¯¹æ°éï¼fan_outï¼</strong></h3>
<p>æ¯ä¸ªç´¢å¼é¡¹å¤§å° = ä¸»é®(8B) + æé(6B) = 14B<br>
å¯ç¨ç©ºé´ = 16KB Ã 70% = 11.2KB â 11468å­è<br>
åä¸ªèç¹ç´¢å¼é¡¹æ° = 11468 / 14 â <strong>819</strong></p>
<p>å³ï¼<strong>æ¯ä¸ªéå¶å­èç¹å¯æåçº¦819ä¸ªå­èç¹</strong></p>
<h3 id="2-è®¡ç®åä¸ªå¶å­èç¹è½å­å¨çæ°æ®è¡æ°"><strong>2. è®¡ç®åä¸ªå¶å­èç¹è½å­å¨çæ°æ®è¡æ°</strong></h3>
<p>å¯ç¨ç©ºé´ = 16KB Ã 70% = 11.2KB<br>
åè®¾æ¯è¡æ°æ®1KB â æ¯é¡µçº¦å­å¨ <strong>11è¡</strong><br>
åè®¾æ¯è¡æ°æ®200å­è â æ¯é¡µçº¦å­å¨ <strong>57è¡</strong><br>
åè®¾æ¯è¡æ°æ®800å­è â æ¯é¡µçº¦å­å¨ <strong>14è¡</strong></p>
<h3 id="3-ä¸å±bæ æ»å®¹éè®¡ç®"><strong>3. ä¸å±B+æ æ»å®¹éè®¡ç®</strong></h3>
<p><strong>å¬å¼</strong>ï¼æ»è¡æ° = fan_outÂ² Ã æ¯é¡µè¡æ°</p>
<ul>
<li>è¥æ¯é¡µ11è¡ï¼819Â² Ã 11 â <strong>730ä¸è¡</strong></li>
<li>è¥æ¯é¡µ57è¡ï¼819Â² Ã 57 â <strong>3800ä¸è¡</strong></li>
<li>è¥æ¯é¡µ14è¡ï¼819Â² Ã 14 â <strong>940ä¸è¡</strong></li>
</ul>
<hr>
<h2 id="æ´ç²¾ç¡®çä¼°ç®èèçå®innodbç»æ"><strong>æ´ç²¾ç¡®çä¼°ç®ï¼èèçå®InnoDBç»æï¼</strong></h2>
<p>å®éInnoDBå¶å­èç¹å­å¨çæ¯å®æ´æ°æ®è¡ï¼éè¦èèï¼</p>
<ul>
<li>è¡æ ¼å¼å¼éï¼è¡å¤´çº¦23å­èï¼</li>
<li>äºå¡ç³»ç»å¼éï¼MVCCçéèåï¼DB_TRX_ID 6B + DB_ROLL_PTR 7Bï¼</li>
<li>å¯è½çNULLä½å¾ãåé¿å­æ®µåè¡¨ç­</li>
</ul>
<p><strong>ä¿å®ä¼°ç®</strong>ï¼<br>
åè®¾ä¸»é®ä¸ºBIGINTï¼æ¯è¡é¢å¤å¼éçº¦50å­èï¼</p>
<ul>
<li>è¡å¤§å° = æ°æ®(1024B) + è¡å¼é(50B) = 1074B</li>
<li>æ¯é¡µè¡æ° = (16384Ã70%) / 1074 â 10è¡</li>
<li>æ»è¡æ° = 819Â² Ã 10 â <strong>670ä¸è¡</strong></li>
</ul>
<hr>
<h2 id="åºæ¯åæè¡¨"><strong>åºæ¯åæè¡¨</strong></h2>
<table>
<thead>
<tr>
<th>è¡å¤§å°</th>
<th>æ¯é¡µè¡æ°</th>
<th>ä¸å±B+æ å®¹é</th>
<th>åå±B+æ å®¹é</th>
</tr>
</thead>
<tbody>
<tr>
<td>200Bï¼å°è®°å½ï¼</td>
<td>~57è¡</td>
<td>çº¦3800ä¸è¡</td>
<td>çº¦310äº¿è¡</td>
</tr>
<tr>
<td>1KBï¼å¸åè®°å½ï¼</td>
<td>~10è¡</td>
<td>çº¦670ä¸è¡</td>
<td>çº¦55äº¿è¡</td>
</tr>
<tr>
<td>2KBï¼è¾å¤§è®°å½ï¼</td>
<td>~5è¡</td>
<td>çº¦335ä¸è¡</td>
<td>çº¦27äº¿è¡</td>
</tr>
<tr>
<td>8KBï¼å¤§è®°å½ï¼</td>
<td>~1è¡</td>
<td>çº¦67ä¸è¡</td>
<td>çº¦5.5äº¿è¡</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="éè¦è¯´æ"><strong>éè¦è¯´æ</strong></h2>
<ol>
<li>
<p><strong>å®éå®¹éå¯è½æ´å¤§</strong>ï¼</p>
<ul>
<li>è¥ä½¿ç¨INTä¸»é®ï¼4å­èï¼ï¼fan_out â 1365ï¼å®¹éæåè¿3å</li>
<li>è¥è¡è®°å½æ´ç´§åï¼æ¯é¡µå­å¨è¡æ°æ´å¤</li>
</ul>
</li>
<li>
<p><strong>B+æ å±æ°å¢é¿</strong>ï¼</p>
<ul>
<li>å½æ°æ®éè¶è¿ä¸å±å®¹éæ¶ï¼B+æ åä¸ºåå±</li>
<li>åå±B+æ å®¹é = fan_outÂ³ Ã æ¯é¡µè¡æ°</li>
<li>å¯¹äº1KBè¡ï¼åå±B+æ å¯å­å¨çº¦ <strong>55äº¿è¡</strong></li>
</ul>
</li>
<li>
<p><strong>èç°ç´¢å¼ vs äºçº§ç´¢å¼</strong>ï¼</p>
<ul>
<li>ä¸è¿°è®¡ç®éå¯¹<strong>èç°ç´¢å¼</strong>ï¼å¶å­èç¹å­å®æ´æ°æ®ï¼</li>
<li>äºçº§ç´¢å¼å¶å­èç¹å­å¨ä¸»é®å¼ï¼å®¹éä¼æ´å¤§</li>
</ul>
</li>
</ol>
<hr>
<h2 id="ç»è®º"><strong>ç»è®º</strong></h2>
<p>å¨å¸åçéç½®ä¸ï¼BIGINTä¸»é®ã1KBè¡æ°æ®ï¼ï¼</p>
<ul>
<li><strong>ä¸å±B+æ å¤§çº¦è½å­å¨600ä¸ï½1000ä¸è¡æ°æ®</strong></li>
<li><strong>åå±B+æ å¯å­å¨æ°åäº¿è¡æ°æ®</strong></li>
</ul>
<p>è¿ä¹æ¯ä¸ºä»ä¹æä»¬å¸¸è¯´ï¼</p>
<ul>
<li>åè¡¨åä¸çº§å«æ°æ®æ¶ï¼æ¥è¯¢æ§è½ä»è½ä¿æè¯å¥½ï¼ä¸å±B+æ ï¼</li>
<li>æ°æ®éè¿äº¿æ¶ï¼å¯è½éè¦èèååºåè¡¨æä¼åç´¢å¼è®¾è®¡</li>
</ul>

</div>
<div id="MySignature" role="contentinfo">
    
<p>â¤ï¸ å¦æä½ åæ¬¢è¿ç¯æç« ï¼è¯·ç¹èµæ¯æï¼ ð åæ¶æ¬¢è¿å³æ³¨æçåå®¢ï¼è·åæ´å¤ç²¾å½©åå®¹ï¼</p>

<p>æ¬ææ¥èªåå®¢å­ï¼ä½èï¼<a href="https://www.cnblogs.com/sun-10387834/" target="_blank">ä½ç¥è®©ææ¥å·¡å±±</a>ï¼è½¬è½½è¯·æ³¨æåæé¾æ¥ï¼<a href="https://www.cnblogs.com/sun-10387834/p/19388703" target="_blank">https://www.cnblogs.com/sun-10387834/p/19388703</a></p>


</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-01-05 18:57">2026-01-05 18:57</span>&nbsp;
<a href="https://www.cnblogs.com/sun-10387834">ä½ç¥è®©ææ¥å·¡å±±</a>&nbsp;
éè¯»(<span id="post_view_count">4</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19388703);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19388703', targetLink: 'https://www.cnblogs.com/sun-10387834/p/19388703', title: 'ãé¢è¯é¢ãMySQL ä¸å± B+ æ è½å­å¤å°æ°æ®ï¼' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ å´æ©è¾¾æ·±åº¦å­¦ä¹ è¯¾ç¨äºï¼èªç¶è¯­è¨å¤ç  ç¬¬ä¸å¨ï¼å¾ªç¯ç¥ç»ç½ç» ï¼ä¸ï¼åºåæ°æ®ä¸åºåæ¨¡å ]]></title>
    <link>https://www.cnblogs.com/Goblinscholar/p/19437798</link>
    <guid>37bcb3dce106c042851d4404c63e8e35</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/Goblinscholar/p/19437798" title="åå¸äº 2026-01-05 18:52">
    <span role="heading" aria-level="2">å´æ©è¾¾æ·±åº¦å­¦ä¹ è¯¾ç¨äºï¼èªç¶è¯­è¨å¤ç  ç¬¬ä¸å¨ï¼å¾ªç¯ç¥ç»ç½ç» ï¼ä¸ï¼åºåæ°æ®ä¸åºåæ¨¡å</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<p>æ­¤åç±»ç¨äºè®°å½å´æ©è¾¾æ·±åº¦å­¦ä¹ è¯¾ç¨çå­¦ä¹ ç¬è®°ã<br>
è¯¾ç¨ç¸å³ä¿¡æ¯é¾æ¥å¦ä¸ï¼</p>
<ol>
<li>åè¯¾ç¨è§é¢é¾æ¥ï¼<a href="https://www.bilibili.com/video/BV1FT4y1E74V?buvid=XU762317353676D786954061C192FE625463B&amp;from_spmid=playlist.playlist-detail.0.0&amp;is_story_h5=false&amp;mid=zqernykrmpf7XfIorMR%2FnA%3D%3D&amp;plat_id=116&amp;share_from=ugc&amp;share_medium=android&amp;share_plat=android&amp;share_session_id=ce0bc526-db69-428a-962e-c65ed8c267bc&amp;share_source=COPY&amp;share_tag=s_i&amp;spmid=united.player-video-detail.0.0&amp;timestamp=1713085655&amp;unique_k=DfBgvFW&amp;up_id=8654113&amp;vd_source=e035e9878d32f414b4354b839a4c31a4" target="_blank" rel="noopener nofollow">[åè¯­å­å¹]å´æ©è¾¾æ·±åº¦å­¦ä¹ deeplearning.ai</a></li>
<li>githubè¯¾ç¨èµæï¼å«è¯¾ä»¶ä¸ç¬è®°:<a href="https://github.com/robbertliu/deeplearning.ai-andrewNG" target="_blank" rel="noopener nofollow">å´æ©è¾¾æ·±åº¦å­¦ä¹ æå­¦èµæ</a></li>
<li>è¯¾ç¨éå¥ç»ä¹ ï¼ä¸­è±ï¼ä¸ç­æ¡ï¼<a href="https://blog.csdn.net/u013733326/article/details/79827273" target="_blank" rel="noopener nofollow">å´æ©è¾¾æ·±åº¦å­¦ä¹ è¯¾åä¹ é¢ä¸ç­æ¡</a></li>
</ol>
<p>æ¬ç¯ä¸ºç¬¬äºè¯¾çç¬¬ä¸å¨åå®¹ï¼<a href="https://www.bilibili.com/video/BV1FT4y1E74V?spm_id_from=333.788.videopod.episodes&amp;vd_source=e035e9878d32f414b4354b839a4c31a4&amp;p=151" target="_blank" rel="noopener nofollow">1.1</a>çåå®¹ä»¥åä¸äºåºç¡çè¡¥åã</p>
<hr>
<p>æ¬å¨ä¸ºç¬¬äºè¯¾çç¬¬ä¸å¨åå®¹ï¼ä¸ CV ç¸å¯¹åºçï¼è¿ä¸è¯¾ææåå®¹çä¸­å¿åªæä¸ä¸ªï¼<strong>èªç¶è¯­è¨å¤çï¼Natural Language Processingï¼NLPï¼</strong>ã<br>
åºç¨å¨æ·±åº¦å­¦ä¹ éï¼å®æ¯ä¸é¨ç¨æ¥è¿è¡<strong>ææ¬ä¸åºåä¿¡æ¯å»ºæ¨¡</strong>çæ¨¡ååææ¯ï¼æ¬è´¨ä¸æ¯å¨å¨è¿æ¥ç½ç»ä¸ç»è®¡è¯­è¨æ¨¡ååºç¡ä¸çä¸æ¬¡âç»æåç¹åâï¼ä¹æ¯äººå·¥æºè½ä¸­<strong>æè´´è¿äººç±»æç»´è¡¨è¾¾æ¹å¼</strong>çéè¦ç ç©¶æ¹åä¹ä¸ã<br>
<strong>è¿ä¸æ´èè¯¾åæ ·æ¶åå¤§ééè¦åå¤æ¶åçåå®¹ï¼æ¨ªè·¨æºå¨å­¦ä¹ ãæ¦çç»è®¡ãçº¿æ§ä»£æ°ä»¥åè¯­è¨å­¦ç´è§ã</strong><br>
è¯­è¨ä¸åå¾åé£æ ·âç´è§å¯è§âï¼æ´å¤æ¯æ½è±¡ç¬¦å·ä¸ä¸ä¸æå³ç³»çç»åï¼å æ­¤<strong>çè§£é¨æ§åèæ´é«</strong>ã<br>
å æ­¤ï¼æåæ ·ä¼å°½éè¡¥è¶³å¿è¦çèæ¯ç¥è¯ï¼å°½å¯è½ç¨æ¯å»åå®ä¾éä½çè§£é¾åº¦ã<br>
æ¬ç¯çåå®¹å³äº<strong>åºåæ°æ®ååºåæ¨¡å</strong>ï¼æ¯èªç¶è¯­è¨å¤çä¸­åºç¡åå®¹ã</p>
<h1 id="1-åºåæ°æ®">1. åºåæ°æ®</h1>
<p>å¨ NLP ä¸­ï¼ä¸ä¸ªæåºç¡ãä¹ææ ¸å¿çé®é¢æ¯ï¼<strong>è¯­è¨æ°æ®ï¼åæä»¬ä¹åè§è¿çæ°æ®ï¼æä»ä¹æ¬è´¨ä¸åï¼</strong><br>
ç­æ¡å¯ä»¥ç®åæ¦æ¬ä¸ºï¼<strong>å®æ¯æé¡ºåºçã</strong></p>
<p>å¨æºå¨å­¦ä¹ ä¸­ï¼æä»¬æ <strong>âé¡ºåºæ¬èº«æºå¸¦ä¿¡æ¯â</strong> çæ°æ®ç§°ä¸º<strong>åºåæ°æ®</strong>ã<br>
æç´è§çä¾å­å°±æ¯ä¸å¥è¯ï¼åæ ·æ¯è¿å ä¸ªè¯ï¼</p>
<blockquote>
<p>âæ å é¥­â<br>
âé¥­ å æâ</p>
</blockquote>
<p>åå«çè¯å®å¨ä¸æ ·ï¼ä½è¡¨è¾¾çå«ä¹å´å¤©å·®å°å«ï¼è¿è¯´æï¼<strong>å¨è¯­è¨ä¸­ï¼ä¿¡æ¯ä¸ä»å­å¨äºâæåªäºåç´ âï¼è¿å­å¨äºâåç´ åºç°çé¡ºåºâã</strong></p>
<p>è¿ä¸æä»¬ä¹åå¨ CV ä¸­å¸¸è§çæ°æ®ææä¸åã<br>
ä¸å¼ å¾åå¨è¿å¥æ¨¡åä¹åï¼éå¸¸å·²ç»è¢«è¡¨ç¤ºä¸ºä¸ä¸ª<strong>åºå®å°ºå¯¸çäºç»´åç´ ç½æ ¼</strong>ã<br>
æ è®ºæä»¬åçå·¦ä¸è§è¿æ¯å³ä¸è§ï¼<strong>æ´å¹å¾åçææä¿¡æ¯å¨è¾å¥æ¶æ¯åæ¶å­å¨ç</strong>ï¼æ¨¡åé¢å¯¹çæ¯ä¸ä¸ªâå®æ´ç»é¢âã<br>
å¨è¿ç§è®¾å®ä¸ï¼å·ç§¯ç½ç»æ´å³æ³¨çæ¯<strong>ç©ºé´ç»æå³ç³»</strong>ï¼åªäºåç´ å½¼æ­¤ç¸é»ãåªäºå±é¨åºåå¯ä»¥ç»ææ´é«å±çå½¢ç¶ã</p>
<p>èè¯­è¨æ°æ®çå½¢å¼åä¸åï¼ä¸å¥è¯å¹¶ä¸æ¯ä¸ä¸ªå¤©ç¶çâæ´ä½å¯¹è±¡âï¼èæ¯ç±è¯è¯­<strong>æé¡ºåºä¾æ¬¡åºç°</strong>çã<br>
ç®åæ¥è¯´ï¼å¨æåºå»ºæ¨¡çåè®¾ä¸ï¼æ¨¡åå¯¹å½åè¯ççè§£ï¼å¾å¾ä¾èµäº<strong>ä¹åå·²ç»åºç°çææè¯æææçä¸ä¸æ</strong>ã</p>
<p>éè¦è¯´æçæ¯ï¼è¿éçâæé¡ºåºâå¹¶ä¸ä¸å®æå³çæ¨¡åå¿é¡»<strong>åäººä¸æ ·ä¸ä¸ªè¯ä¸ä¸ªè¯å°è¯»</strong>ã<br>
å¨åç»­å°è¦ä»ç»ç <strong>Transformer</strong> æ¨¡åä¸­ï¼æ´å¥è¯çææè¯å¯ä»¥è¢«<strong>åæ¶éå¥æ¨¡åè¿è¡å¤ç</strong>ï¼ä½æ¨¡åä»ç¶éè¦éè¿<strong>æ¾å¼å°å¼å¥ä½ç½®ä¿¡æ¯</strong>ï¼æ¥åºåâåªä¸ªè¯å¨åãåªä¸ªè¯å¨åâã</p>
<p>åæä¸ªæ¯æ¹ï¼<br>
å¾åæ´åæ¯ä¸å¼ <strong>å·²ç»æå¼å¨æ¡é¢ä¸çå°å¾</strong>ï¼ææä¿¡æ¯ä¸ç¼é½å¨ï¼æ¨¡åå¨å¤çæ¶ä¸ä¾èµæ¾å¼çæ¶é´é¡ºåºï¼èæ¯ç´æ¥å»ºæ¨¡æ´ä½çç©ºé´ç»æå³ç³»ã<br>
èè¯­è¨æ´åæ¯ä¸æ®µ<strong>æ­£å¨æ­æ¾çè¯­é³ææå­æµ</strong>ï¼æä»¬ä»åªéå¬ï¼åªéçï¼ç»ææ¯æªç¶ä¸åçã<br>
<img src="https://img2024.cnblogs.com/blog/3708248/202601/3708248-20260104144013115-1425405995.png" alt="image.png" loading="lazy"><br>
å æ­¤ï¼å¨è¯­è¨ä»»å¡ä¸­ï¼âååºç°ä»ä¹ãååºç°ä»ä¹âæ¬èº«å°±ææäºä¿¡æ¯çä¸é¨åï¼èä¸è½è¢«éææä¹±<br>
æ­£å ä¸ºè¿ç§å·®å¼ï¼è®©CV æ¨¡åæ´æé¿å¤ç<strong>ç©ºé´ç»æä¸å±é¨æ¨¡å¼</strong>ï¼è NLP æ¨¡åå¿é¡»éç¹è§£å³<strong>é¡ºåºãä¾èµå³ç³»ä»¥åä¸ä¸æè®°å¿</strong>çé®é¢ã</p>
<p>æä»¬æ»ç»è¯­è¨ãè¯­é³ãæ¶é´ç­åºåæ°æ®çç¹å¾å¦ä¸ï¼</p>
<ol>
<li>æ°æ®æ¯<strong>æé¡ºåºæå</strong>çã</li>
<li>å½åä¿¡æ¯å¾å¾ä¾èµäº<strong>ä¹åå·²ç»åºç°çåå®¹</strong>ã</li>
<li>æ°æ®é¿åº¦éå¸¸<strong>ä¸åºå®</strong>ã</li>
</ol>
<p>è¿äºç¹å¾å³å®äºï¼<strong>å¨å¤çåºåæ°æ®æ¶ï¼æ¨¡åå¿é¡»æ¾å¼å°èèé¡ºåºä¸ä¸ä¸æï¼èä¸è½ä»æè¾å¥å½ä½ä¸ä¸ªæ åºçç¹å¾éåæ¥å¤çã</strong></p>
<h1 id="2-åºåæ¨¡å">2. åºåæ¨¡å</h1>
<p>æä»¬åå«ççï¼å¦æä½¿ç¨æä»¬å·²ç»äºè§£è¿ç<strong>å¨è¿æ¥ç½ç»</strong>å<strong>å·ç§¯ç½ç»</strong>æ¥å¤çåºåæ°æ®ï¼ææä¼æä¹æ ·ã</p>
<h2 id="21-å¨è¿æ¥ç½ç»æ æ³èªç¶å¤çé¡ºåº">2.1 å¨è¿æ¥ç½ç»ï¼æ æ³èªç¶å¤çâé¡ºåºâ</h2>
<p>å¦æè¦åºç¨å¨è¿æ¥ç½ç»ï¼æç´æ¥çæ³æ³æ¯ï¼  æä¸å¥è¯ä¸­çæ¯ä¸ªè¯è¡¨ç¤ºæåéï¼åæè¿äºåé<strong>æ¼æ¥æä¸ä¸ªé¿åé</strong>ï¼éè¿å¨è¿æ¥ç½ç»ã</p>
<p>è¿ç§åæ³å¨å½¢å¼ä¸æ¯å¯è¡çï¼ä½é®é¢ä¹éå¸¸ææ¾ï¼<br>
é¦åï¼å¨è¿æ¥ç½ç»è¦æ±<strong>åºå®é¿åº¦è¾å¥</strong>ï¼èè¯­è¨åºåçé¿åº¦æ¯å¤©ç¶ä¸åºå®çã<br>
ä¸å¥è¯å¯ä»¥åªæå ä¸ªè¯ï¼ä¹å¯ä»¥éå¸¸é¿ãä¸ºäºæ»¡è¶³è¾å¥è¦æ±ï¼æä»¬ä¸å¾ä¸è¿è¡æªæ­æå¡«åï¼è¿æ¬èº«å°±å¼å¥äºé¢å¤çå·¥ç¨å¤æåº¦ã</p>
<p>å¶æ¬¡ï¼æ´å³é®çæ¯ï¼<strong>å¨è¿æ¥ç½ç»å¹¶ä¸å·å¤âé¡ºåºæç¥âè½å</strong>ãå¨å®çæ¥ï¼è¾å¥åªæ¯ä¸ä¸ªé«ç»´åéï¼åä¸ªç»´åº¦ä¹é´æ²¡æâååâè¿ä¸æ¦å¿µã<br>
æ¨¡åæ¬èº«å¹¶ä¸ç¥éï¼âè¿æ¯ç¬¬ä¸ä¸ªè¯ââè¿æ¯ç¬¬ä¸ä¸ªè¯âã<br>
<img src="https://img2024.cnblogs.com/blog/3708248/202601/3708248-20260104144012968-399183777.png" alt="image.png" loading="lazy"></p>
<p>å æ­¤ï¼è¿ç§å¤çæ¹å¼å¤©ç¶å¿½ç¥äºè¯­è¨ä¸­æéè¦çç»æä¿¡æ¯ââé¡ºåºä¸ä¾èµå³ç³»ãä¸è½ç¨æ¥å¤çåºåæ°æ®ã</p>
<h2 id="22-å·ç§¯ç½ç»æé¿å±é¨æ¨¡å¼ä½ç¼ºä¹é¿æä¾èµ">2.2 å·ç§¯ç½ç»ï¼æé¿å±é¨æ¨¡å¼ï¼ä½ç¼ºä¹é¿æä¾èµ</h2>
<p>é£å·ç§¯ç½ç»å¢ï¼  æ¢ç¶ CNN è½å¨å¾åä¸­å»ºæ¨¡å±é¨ç»æï¼æ¯å¦ä¹å¯ä»¥ç¨äºåºåæ°æ®ï¼<br>
ç­æ¡æ¯ï¼<strong>é¨åå¯ä»¥ï¼ä½ä¸å¤èªç¶ã</strong></p>
<p>å¨åºåä¸ä½¿ç¨ä¸ç»´å·ç§¯æ¶ï¼å·ç§¯æ ¸å¯ä»¥ææ<strong>å±é¨è¿ç»­çæ®µ</strong>ï¼ä¾å¦ç¸é»å ä¸ªè¯ææçç­è¯­æåºå®æ­éã ä»è¿ä¸ªè§åº¦çï¼CNN ç¡®å®è½å¤å»ºæ¨¡<strong>å±é¨ä¸ä¸æä¿¡æ¯</strong>ã</p>
<p>å¨è¿éï¼æä»¬éè¦å¼å¥ä¸ä¸ªæ¦å¿µï¼<strong>æåéï¼receptive fieldï¼</strong>ã<br>
æåéæçæ¯å·ç§¯å±ä¸­æä¸ªç¥ç»å<strong>è½å¤âçå°âçè¾å¥åºåèå´</strong>ã<br>
æä¸ªæ¯æ¹ï¼</p>
<ul>
<li>å¨å¾åä¸­ï¼å¦æä¸ä¸ªå·ç§¯ç¥ç»åçæåéæ¯ <span class="math inline">\(3\times3\)</span>ï¼å®åªè½æç¥è¿ä¹ä¸ªåç´ çå±é¨ä¿¡æ¯ï¼</li>
<li>ç±»ä¼¼å°ï¼å¨åºåä¸ï¼ä¸ä¸ªå·ç§¯æ ¸çæåéå°±æ¯å®<strong>ä¸æ¬¡æ§è½çå°çè¿ç»­è¯çæ°é</strong>ã<br>
<img src="https://img2024.cnblogs.com/blog/3708248/202601/3708248-20260104144316440-1063086196.png" alt="image.png" loading="lazy"><br>
è¿å°±æå³çï¼å·ç§¯ç½ç»å¨å¤çåºåæ¶å¤©ç¶æé¿ææ<strong>å±é¨æ¨¡å¼æç­è·ç¦»ä¾èµ</strong>ï¼ä½å¦ææ³è®©æ¨¡åçè§£âå¥é¦çè¯âä¸âå¥å°¾çè¯âä¹é´çå³ç³»ï¼å°±å¿é¡»<strong>å å å¾å¤å±å·ç§¯</strong>æ<strong>äººä¸ºæ©å¤§å·ç§¯æ ¸èå´</strong>ï¼æè½è¦çæ´ä¸ªåºåã<br>
ç®åæ¥è¯´ï¼æåéè¶å¤§ï¼æ¨¡åè¶å®¹æææ<strong>é¿è·ç¦»ä¾èµ</strong>ï¼ä½è¿ä¹å¸¦æ¥äºè®¡ç®åè®­ç»ä¸çé®é¢ã<br>
è¿ä½¿å¾æ¨¡åï¼</li>
<li>å¯¹<strong>ç­è·ç¦»ä¾èµ</strong>ææã</li>
<li>å¯¹<strong>é¿è·ç¦»ä¾èµ</strong>ä¸å¤é«æã</li>
<li>å¹¶ä¸ä»ç¶ç¼ºä¹ä¸ç§æç¡®çâæ¶é´ç¶æâæ¦å¿µã</li>
</ul>
<p>å¯ä»¥è¿æ ·çè§£ï¼<br>
å·ç§¯ç½ç»æ´åæ¯å¨<strong>æ«æå±é¨çæ®µ</strong>ï¼èä¸æ¯å¨<strong>æ²¿çæ¶é´è½´éæ­¥çè§£ä¸å¥è¯çåå±è¿ç¨</strong>ï¼å æ­¤ï¼è½ç¶å·ç§¯å¯¹åºåæ°æ®çå¤çè½åå¼ºäºå¨è¿æ¥ç½ç»ï¼ä½æ¯å®ä»ææå±éã</p>
<h2 id="23-åºåæ¨¡åè¦è§£å³çæ ¸å¿é®é¢">2.3 åºåæ¨¡åè¦è§£å³çæ ¸å¿é®é¢</h2>
<p>éè¿ä»¥ä¸å¯¹æ¯å¯ä»¥çå°ï¼å¨è¿æ¥ç½ç»åå·ç§¯ç½ç»å¹¶ä¸æ¯âä¸è½âå¤çåºåæ°æ®ï¼èæ¯<strong>å¤çæ¹å¼ä¸åºåæ°æ®çæ¬è´¨å­å¨å²çª</strong>ã</p>
<p>åºåæ°æ®çæ ¸å¿ç¹ç¹å¨äºï¼ä¿¡æ¯æ¯<strong>éé¡ºåºéæ­¥å±å¼ç</strong>ãå½åçè§£ä¾èµäº<strong>åå²ä¸ä¸æ</strong>ä¸åºåé¿åº¦<strong>ä¸åºå®</strong>ã<br>
å æ­¤ï¼æä»¬çæ­£éè¦çæ¯è¿æ ·ä¸ç±»æ¨¡åï¼  <strong>å¨å¤çå½åè¾å¥çåæ¶ï¼è½å¤ä¿çå¹¶æ´æ°å¯¹âè¿å»ä¿¡æ¯âçè¡¨ç¤ºã</strong><br>
ä¹å°±æ¯è¯´ï¼åºåæ¨¡åçæ ¸å¿è½åå¹¶ä¸å¨äºâè¾å¥å½¢å¼âï¼  èå¨äºå®æ¯å¦å·å¤ä¸ç§<strong>å¯éæ¶é´æ¼åçåé¨ç¶æ</strong>ï¼ç¨æ¥æ¿è½½ä¸ä¸æä¿¡æ¯ï¼å¹¶åä¸åç»­å³ç­ã<br>
åç»­æä»¬å°çå°ç RNNãLSTMãGRU ä»¥å Transformerï¼  è½ç¶å®ç°æ¹å¼ä¸åï¼ä½é½å´ç»çåä¸ä¸ªç®æ å±å¼ï¼  <strong>è®©æ¨¡åå¨çè§£å½ååå®¹æ¶ï¼ä¸æ¯å­¤ç«å°âçè¿ä¸å»âï¼èæ¯åºäºæ´ä¸ªä¸ä¸ææ¥å¤æ­ã</strong></p>
<p>è¿å°±æ¯åºåæ¨¡åæå·å¤çè½åã</p>
<h1 id="3-åºåæ¨¡åçåºç¨é¢å">3. åºåæ¨¡åçåºç¨é¢å</h1>
<p>åºåæ¨¡åå¨ NLP ä¸­åºç¨å¹¿æ³ï¼ä½éè¦æ³¨æçæ¯ï¼<strong>åºåæ¨¡åä¸ä¸å®è¦æ±è¾å¥åè¾åºé½æ¯åºå</strong>ãå®çæ ¸å¿è½åå¨äºè½å¤<strong>ä¿çä¸ä¸æä¿¡æ¯å¹¶å¤çéæ¶é´å±å¼çæ°æ®</strong>ãåªè¦è¾å¥æè¾åºä¸­å­å¨åºåæ§è´¨ï¼åºåæ¨¡åå°±è½åæ¥ä½ç¨ã<br>
ä»è¾å¥åè¾åºçè§åº¦ï¼å¯ä»¥åä¸ºä»¥ä¸å ç±»æåµï¼</p>
<ol>
<li><strong>åºåâåºåï¼</strong> è¾å¥åè¾åºé½æ¯åºåï¼ä¾å¦æºå¨ç¿»è¯ãæ¨¡åéè¦æ ¹æ®è¾å¥åºåçä¸ä¸æçæå¯¹åºçè¾åºåºåã</li>
<li><strong>åºåâæ éæç±»å«ï¼</strong> è¾å¥æ¯åºåï¼è¾åºæ¯åä¸ªå¼æç±»å«ï¼ä¾å¦ææåæãææ¬åç±»ãæ¨¡åéè¦çè§£æ´æ®µåºåçè¯­ä¹ï¼å¹¶è¾åºæ´ä½å¤æ­ã</li>
<li><strong>æ éæåºå®è¾å¥âåºåï¼</strong> è¾å¥ä¸æ¯åºåï¼ä½æ¨¡åéè¦çæåºåä½ä¸ºè¾åºï¼ä¾å¦ææ¬çææå¯¹è¯ç³»ç»ä¸­æ ¹æ®æç¤ºçæå®æ´åç­ã</li>
</ol>
<p>ç±æ­¤å¯è§ï¼åºåæ¨¡åçæ ¸å¿è½åä¸æ¯âå¿é¡»å¤çåºåè¾å¥æè¾åºâï¼èæ¯<strong>è½å¤å¨å¤çè¿ç¨ä¸­ç»´æ¤ä¸ä¸æä¿¡æ¯</strong>ã<br>
æ¥ççåºåæ¨¡åçä¸äºå¸¸è§åºç¨é¢åï¼</p>
<table>
<thead>
<tr>
<th>ä»»å¡</th>
<th>è¾å¥ç±»å</th>
<th>è¾åºç±»å</th>
<th>è¯´æ</th>
</tr>
</thead>
<tbody>
<tr>
<td>ææ¬åç±»</td>
<td>åºå</td>
<td>ç±»å«</td>
<td>å¦ææåæãæ°é»åç±»ï¼çè§£æ´æ®µææ¬å¹¶è¾åºåä¸æ ç­¾</td>
</tr>
<tr>
<td>å½åå®ä½è¯å« (NER)</td>
<td>åºå</td>
<td>åºå</td>
<td>å¯¹æ¯ä¸ªè¯è¿è¡æ æ³¨ï¼å¦âäººåââå°åâç­</td>
</tr>
<tr>
<td>æºå¨ç¿»è¯</td>
<td>åºå</td>
<td>åºå</td>
<td>å°æºè¯­è¨å¥å­è½¬æ¢ä¸ºç®æ è¯­è¨å¥å­</td>
</tr>
<tr>
<td>ææ¬çæ</td>
<td>åºåææ é</td>
<td>åºå</td>
<td>æ ¹æ®è¾å¥ææ¬ææç¤ºçæå®æ´ææ¬</td>
</tr>
<tr>
<td>è¯­é³è¯å«</td>
<td>åºå</td>
<td>åºå</td>
<td>å°è¯­é³ä¿¡å·è½¬ä¸ºæå­åºå</td>
</tr>
<tr>
<td>é®ç­ç³»ç»</td>
<td>åºå</td>
<td>åºåææ é</td>
<td>æ ¹æ®é®é¢çæç­æ¡ï¼ç­æ¡å¯ä»¥æ¯ç­ææ¬æåä¸ç±»å«</td>
</tr>
<tr>
<td>æ¶é´åºåé¢æµ</td>
<td>åºå</td>
<td>åºåææ é</td>
<td>å¦è¡ä»·é¢æµï¼æ ¹æ®åå²åºåé¢æµæªæ¥æ°å¼</td>
</tr>
</tbody>
</table>
<p>éè¿è¿ä¸ªåç±»ï¼å¯ä»¥æ¸æ°å°çå°ï¼<strong>åºåæ¨¡åçæ ¸å¿æ¯å¤çé¡ºåºåä¸ä¸æï¼ä¸å¿éå¶è¾å¥è¾åºé½ä¸ºåºå</strong>ãåªè¦æåºåä¿¡æ¯å­å¨ï¼å®å°±å¯ä»¥åæ¥ä»·å¼ã</p>
<h1 id="4-æ»ç»">4. æ»ç»</h1>
<table>
<thead>
<tr>
<th>æ¦å¿µ</th>
<th>åç</th>
<th>æ¯å»</th>
</tr>
</thead>
<tbody>
<tr>
<td>åºåæ°æ®</td>
<td>æ°æ®åç´ æé¡ºåºæåï¼å½åçè§£ä¾èµåå²ä¸ä¸æï¼é¿åº¦ä¸åºå®</td>
<td>å¾ååæå¼çå°å¾ï¼ä¸ç¼å¯è§æ´ä½ï¼è¯­è¨åæ­£å¨æ­æ¾çè¯­é³ææå­æµï¼éè¦é¡ºåºæç¥</td>
</tr>
<tr>
<td>å¨è¿æ¥ç½ç»å¤çåºå</td>
<td>åªè½æ¥ååºå®é¿åº¦è¾å¥ï¼æ æ³å¤©ç¶æç¥é¡ºåº</td>
<td>åªæ¯æææè¯æ¼æä¸ä¸ªé¿åéï¼æ¨¡åçä¸å°ååé¡ºåº</td>
</tr>
<tr>
<td>å·ç§¯ç½ç»å¤çåºå</td>
<td>è½ææå±é¨è¿ç»­æ¨¡å¼ï¼ç­è·ç¦»ä¾èµï¼ï¼æåéæéï¼é¿è·ç¦»ä¾èµä¸é«æ</td>
<td>å·ç§¯åæ«æå±é¨çæ®µï¼èä¸æ¯æ²¿æ¶é´è½´çè§£æ´å¥è¯çåå±</td>
</tr>
<tr>
<td>æåé (Receptive Field)</td>
<td>ä¸ä¸ªå·ç§¯ç¥ç»åä¸æ¬¡è½å¤çå°çè¾å¥åºå</td>
<td>å¾åï¼3Ã3åç´ åªè½çå°å±é¨ï¼åºåï¼å·ç§¯æ ¸ä¸æ¬¡çå°å ä¸ªè¿ç»­è¯</td>
</tr>
<tr>
<td>åºåæ¨¡åæ ¸å¿è½å</td>
<td>éè¿å¯éæ¶é´æ¼åçåé¨ç¶æï¼ä¿çå¹¶æ´æ°ä¸ä¸æä¿¡æ¯ï¼çè§£å½åè¾å¥æ¶èèåå²ä¿¡æ¯</td>
<td>æ¨¡ååå¸¦è®°å¿çéè¯»èï¼çè§£æ¯ä¸ªè¯æ¶åèæ´æ®µä¸ä¸æ</td>
</tr>
<tr>
<td>è¾å¥/è¾åºç±»åçµæ´»æ§</td>
<td>åºåæ¨¡åä¸è¦æ±è¾å¥è¾åºé½ä¸ºåºåï¼åªè¦ä¸æ¹ä¸ºåºåå³å¯åæ¥ä½ç¨</td>
<td>è¾å¥æ¯æµï¼è¾åºæ¯å¤æ­æçæï¼æ¨¡åè®°å¿åå²ä¿¡æ¯</td>
</tr>
<tr>
<td>åºåæ¨¡ååºç¨</td>
<td>NLPãè¯­é³ãæ¶é´åºåç­é¢åï¼å¦ææ¬åç±»ãNERãæºå¨ç¿»è¯ãææ¬çæãè¯­é³è¯å«ãé®ç­ãæ¶é´åºåé¢æµ</td>
<td>ä¾èµä¸ä¸æä¿¡æ¯ï¼æ¨¡ååâé¡ºåºæç¥å¨âï¼æ ¹æ®è¿å»ä¿¡æ¯åå½åå³ç­</td>
</tr>
</tbody>
</table>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-01-05 18:53">2026-01-05 18:52</span>&nbsp;
<a href="https://www.cnblogs.com/Goblinscholar">å¥å¸æå­¦è</a>&nbsp;
éè¯»(<span id="post_view_count">4</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19437798);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19437798', targetLink: 'https://www.cnblogs.com/Goblinscholar/p/19437798', title: 'å´æ©è¾¾æ·±åº¦å­¦ä¹ è¯¾ç¨äºï¼èªç¶è¯­è¨å¤ç  ç¬¬ä¸å¨ï¼å¾ªç¯ç¥ç»ç½ç» ï¼ä¸ï¼åºåæ°æ®ä¸åºåæ¨¡å' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ NVIDIA CUDA é«æ§è½è®¡ç®ç¬è®°ï¼ä¸ï¼cudaç¼ç¨ç®ä»åç©éµèµå¼æ¡ä¾ ]]></title>
    <link>https://www.cnblogs.com/GeophysicsWorker/p/19444388</link>
    <guid>44270e6fd5ada7d60af0b2474eb7362c</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/GeophysicsWorker/p/19444388" title="åå¸äº 2026-01-05 18:33">
    <span role="heading" aria-level="2">NVIDIA CUDA é«æ§è½è®¡ç®ç¬è®°ï¼ä¸ï¼cudaç¼ç¨ç®ä»åç©éµèµå¼æ¡ä¾</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                    <div id="cnblogs_post_description" style="display: none">
        
        CUDA ï¼Compute  Unified Device Architectureï¼æ¯NIVIDIA æ¨åºçéç¨å¹¶è¡è®¡ç®å¹³å°ï¼æ¯æCï¼C++ï¼Pythonç­è¯­è¨ï¼å®ç°CPUåGPUååè®¡ç®ãå¶æ¶æéç¨Grid-Blocks-Threadsçº¿ç¨å±æ¬¡ç»æåSIMTå¹¶è¡æ¨¡å¼ï¼å¨ç»åºCUDAçç¼ç¨å®ä¾ä¹åï¼éè¦ç»åºæ¨¡åçåºç¡ç¥è¯åä¸ªç®åçä»ç»ã
    </div>
<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h1 id="nvidia-cuda-é«æ§è½è®¡ç®ç¬è®°ä¸">NVIDIA CUDA é«æ§è½è®¡ç®ç¬è®°ï¼ä¸ï¼</h1>
<p>â       CUDA ï¼Compute  Unified Device Architectureï¼æ¯NIVIDIA æ¨åºçéç¨å¹¶è¡è®¡ç®å¹³å°ï¼æ¯æCï¼C++ï¼Pythonç­è¯­è¨ï¼å®ç°CPUåGPUååè®¡ç®ãå¶æ¶æéç¨Grid-Blocks-Threadsçº¿ç¨å±æ¬¡ç»æåSIMTå¹¶è¡æ¨¡å¼ï¼å¨ç»åºCUDAçç¼ç¨å®ä¾ä¹åï¼éè¦ç»åºæ¨¡åçåºç¡ç¥è¯åä¸ªç®åçä»ç»ã</p>
<h2 id="11cudaç¼ç¨æ¨¡åç®ä»">1.1CUDAç¼ç¨æ¨¡åç®ä»</h2>
<p>â      CUDAç¼ç¨æ¨¡åæ¯ä¸ä¸ªå¼ææ¨¡åï¼éè¦GPUåCPUååå·¥ä½ãå¨CUDAæ¶æä¸­ï¼æä»¬ç¨hostç«¯æä»£CPUåå¶åå­çï¼ç¨deviceæä»£GPUåå¶åå­ãCUDAç¨åºä¸­å³åå«Hostç¨åºï¼ååå«deviceç¨åºï¼å®ä»¬åå«å¨CPUä¸GPUä¸è¿è¡ãåæ¶ï¼hostä¸deviceä¹é´è¿è¡éä¿¡ï¼è¿æ ·å®ä»¬ä¹é´å¯ä»¥è¿è¡æ°æ®æ·è´ãå¸åçCUDAç¨åºçæ§è¡çç¨åºçæµç¨ä¸ºï¼</p>
<ol>
<li>åéhoståå­ï¼å¹¶è¿è¡æ°æ®åå§åï¼</li>
<li>åédeviceåå­ï¼æ¾å­ãå±äº«åå­ï¼ï¼å¹¶ä»hostç«¯å°æ°æ®æ·è´å°deviceç«¯ï¼</li>
<li>è°ç¨CUDAçæ ¸å½æ°å¨deviceå½æ°ä¸å®ææå®çè¿ç®ï¼</li>
<li>å°deviceä¸çè¿ç®ç»ææ·è´å°hostä¸ï¼</li>
<li>éæ¾deviceåhostä¸åéçåå­ã</li>
</ol>
<p>â        ç±äºCUDAç¼ç¨æ¨¡åå®éä¸æ¯å¼æç¼ç¨æ¨¡åï¼æä»¥éè¦åºåhostådeviceä¸çä»£ç ï¼å¨CUDAä¸­æ¯éè¿å½æ°ç±»åéå®è¯åºå«å¼hostådeviceä¸çå½æ°ï¼ä¸»è¦çä¸ä¸ªå½æ°ç±»åéå®è¯å¦ä¸ï¼</p>
<ul>
<li><code>__global__</code>: å¨deviceç«¯ä¸æ§è¡ï¼ä»hostä¸­è°ç¨ï¼ä¸äºç¹å®çGPUä¹å¯ä»¥ä»deviceä¸è°ç¨ï¼ï¼è¿åç±»åå¿é¡»ä¸º <code>void</code> , ä¸æ¯æå¯ååæ°ï¼ä¸è½æä¸ºç±»æåå½æ°ãæ³¨æ<code>__global__</code> å®ä¹çkernelæ¯å¼æ­¥çï¼è¿æå³çhostç«¯ä¸ä¼ç­å¾kernelæ§è¡å®å°±æ§è¡ä¸ä¸æ­¥ï¼</li>
<li><code>__device__</code>: å¨deviceç«¯ä¸æ§è¡ï¼ä½ä»å¯ä»¥ä»deviceä¸­è°ç¨ï¼ä¸å¯ä»¥å <code>__global__</code> åæ¶ç¨ï¼</li>
<li><code>__host__</code>: å¨hostä¸æ§è¡ï¼ä»å¯ä»¥ä»hostä¸­è°ç¨ï¼ä¸è¬çç¥ä¸åï¼ä¸å¯ä»¥å <code>__global__</code>åæ¶ç¨ï¼ä½å¯ä»¥å <code>__device__</code>ï¼æ­¤æ¶å½æ°ä¼å¨deviceåhosté½ç¼è¯ã</li>
</ul>
<p>â         ä¸é¢çæµç¨ä¸­æéè¦çä¸ä¸ªè¿ç¨æ¯è°ç¨CUDAçæ ¸å½æ°æ¥æ§è¡å¹¶è¡è®¡ç®ï¼kernelæ¯CUDAä¸­çä¸ä¸ªéè¦çæ¦å¿µï¼kernelæ¯å¨deviceä¸çº¿ç¨ä¸­å¹¶è¡æ§è¡çå½æ°ï¼å¨è°ç¨æ¶éè¦ç¨ <code>&lt;&lt;&lt;grid,block&gt;&gt;&gt; </code> æ¥æå®kernelè¦æ§è¡ççº¿ç¨æ°éï¼å¨CUDAä¸­ï¼æ¯ä¸ªçº¿ç¨é½è¦æ§è¡æ ¸å½æ°ï¼å¹¶ä¸æ¯ä¸ªçº¿ç¨ä¼åéä¸ä¸ªå¯ä¸ç<span class="math inline">\(thread\space ID\)</span> ,è¿ä¸ª<span class="math inline">\(ID\)</span> å¼å¯ä»¥éè¿æ ¸å½æ°çåç½®åé <code>thread Idx</code> æ¥è·å¾ã</p>
<p>â       è¦æ·±å»çè§£<span class="math inline">\(kernel\)</span>ï¼å¿é¡»è¦å¯¹<span class="math inline">\(kernel\)</span> ççº¿ç¨å±æ¬¡ç»ææä¸ä¸ªæ¸æ°çè®¤è¯ãé¦åï¼<span class="math inline">\(GPU\)</span>ä¸å¾å¤å¹¶å½¢åçè½»éçº§çº¿ç¨ã<span class="math inline">\(kernel\)</span> å¨deviceä¸æ§è¡æ¶å®éä¸æ¯å¯å¨å¾å¤çº¿ç¨ï¼ä¸ä¸ª<span class="math inline">\(kernel\)</span> æå¯å¨çææçº¿ç¨ç§°ä¸º<strong>ç½æ ¼</strong><span class="math inline">\(grid\)</span> ï¼åä¸ä¸ªç½æ ¼ççº¿ç¨å±äº«ç¸åçå¨å±åå­ç©ºé´ï¼gridæ¯çº¿ç¨ç»æçç¬¬ä¸ä¸ªå±æ¬¡ï¼èç½æ ¼åå¯ä»¥åä¸ºå¾å¤<strong>çº¿ç¨å</strong>(block)ï¼ä¸ä¸ªçº¿ç¨åéé¢åå«å¾å¤çº¿ç¨ï¼è¿æ¯ç¬¬äºä¸ªå±æ¬¡ã  ä¸ºäºç¼ç¨æ¹ä¾¿ï¼<span class="math inline">\(grid\)</span> å<span class="math inline">\(block\)</span> é½æ¯å®ä¹ä¸º <code>dim3</code> ç±»åçåéï¼<code>dim3</code> å¯ä»¥çææ¯åå«ä¸ä¸ªæ ç¬¦å·æ´æ°<span class="math inline">\((x,y,z)\)</span> æåçç»æä½åéï¼å¨å®ä¹æ¶ï¼ç¼ºå¤±å¼åå§åä¸º1ãå æ­¤ï¼gridåblockå¯ä»¥çµæ´»å°å®ä¹ä¸º1-dimï¼2-dimä»¥å3-dimçç»æï¼å¯¹äºï¼<span class="math inline">\(knernel\)</span>å¨å®ä¹è°ç¨æ¶ä¹å¿é¡»éè¿æ§è¡éç½® <code>&lt;&lt;&lt;grid,block&gt;&gt;&gt;</code>æ¥æå®kernelæä½¿ç¨ççº¿ç¨æ°åç»æã</p>
<p><img alt="fHaSP2zNs" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1602810/202601/1602810-20260105183140327-2146202864.jpg" class="lazyload"></p>
<p>â    æä»¥ï¼ä¸ºäºæ¹ä¾¿ç¼ç¨ï¼CUDAä¸­ä½¿ç¨äº <code>dim3</code> ç±»åï¼<code>dim3</code> æ¯åºäºunit3å®ä¹çç¢éç±»åï¼ç¸å½äºç±3ä¸ª <code>unsigned int</code>ç±»åç»æçç»æä½ï¼çåå»ºåé <code>threadIdx</code> å <code>blockIdx</code>ãè¿æ ·ï¼å°±å¯ä»¥ä½¿ç¨ä¸ç»´ãäºç»´æä¸ç»´çç´¢å¼æ¥æ è¯çº¿ç¨ï¼ææ ä¸ç»´ãäºç»´æä¸ç»´çº¿ç¨åãä½¿å¾çº¿ç¨ç»ç»å½¢å¼å¯¹åç§åï¼åéãç©éµï¼æèé«ç»´å¼ éï¼ä¸­æ°æ®çåååå¾ç´è§ãèªç¶ã</p>
<ul>
<li>å¯¹äºä¸ç»´çblockï¼çº¿ç¨ç<span class="math inline">\(threadID\)</span>å°±æ¯<span class="math inline">\(threadId.x\)</span>;</li>
<li>å¯¹äºå¤§å°ä¸º<span class="math inline">\((Dx,Dy)\)</span>çäºç»´çº¿ç¨åblockï¼çº¿ç¨ç<span class="math inline">\(threadID\)</span> æ¯ <span class="math inline">\((threadIdx.x+threadIdx.x\times{Dx})\)</span>;</li>
<li>å¯¹äºå¤§å°ä¸º<span class="math inline">\((Dx,Dy,Dz)\)</span>çä¸ç»´çº¿ç¨åblock, çº¿ç¨ç<span class="math inline">\(threadID\)</span>æ¯ï¼<span class="math inline">\(threadIdx.x+threadIdx.y\times{Dx}+threadIdx.z\times{Dx}\times{Dy}\)</span>ï¼;</li>
</ul>
<p>å¦å¤ï¼çº¿ç¨è¿æåç½®åégridDimï¼ç¨äºè·åç½æ ¼ååä¸ªç»´åº¦çå¤§å°ã</p>
<p>â       æ­¤å¤ï¼è¿éç®åä»ç»ä¸ä¸CUDAçåå­æ¨¡åï¼å¦å¾æç¤ºãå¯ä»¥çå°ï¼æ¯ä¸ªçº¿ç¨æèªå·±çç§ææ¬å°åå­ï¼<span class="math inline">\(Local Memory\)</span>ï¼, èæ¯ä¸ªçº¿ç¨åæåå«å±äº«åå­ï¼<span class="math inline">\(Shared \space Memory\)</span>ï¼ãè¿å¯ä»¥è®¿é®ä¸äºåªè¯»åå­åï¼å¸¸ç¨åå­ï¼<span class="math inline">\(Constant \space Memory\)</span>ï¼åçº¹çåå­ ï¼<span class="math inline">\(Texture \space Memory\)</span>ï¼ãåå­ç»ææ¶åå°ç¨åºä¼åï¼è¿éå°±è¿å¤è®¨è®ºã</p>
<p><img alt="fHaRlklWa" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1602810/202601/1602810-20260105183156222-1925356777.png" class="lazyload"></p>
<p>â       è¿æéè¦ä¸ç¹ï¼ä½ éè¦å¯¹<span class="math inline">\(GPU\)</span>çç¡¬ä»¶å®ç°æä¸ä¸ªåºæ¬çè®¤è¯ãä¸é¢è¯´å°äº<span class="math inline">\(kernel\)</span>ççº¿ç¨ç»ç»å±æ¬¡ï¼é£ä¹ä¸ä¸ª<span class="math inline">\(kernel\)</span> å®éä¸ä¼å¯å¨å¾å¤çº¿ç¨ï¼è¿äºçº¿ç¨æ¯é»è¾ä¸æ¯å¹¶è¡çï¼ä½æ¯å¨ç©çå±ä¹æ¯æ æ³å´å¹¶ä¸ä¸å®ãè¿å¶å®åCPUçå¤çº¿ç¨æç±»ä¼¼ä¹å¤ï¼å¤çº¿ç¨å¦ææ²¡æå¤æ ¸æ¯æï¼å¨ç©çå±ä¹æ æ³å®ç°å¹¶è¡çãä½æ¯å¥½å¨<span class="math inline">\(GPU\)</span> å­å¨å¾å¤CUDAæ ¸å¿ï¼ååå©ç¨CUDAæ ¸å¿å¯ä»¥åååæ¥GPUçå¹¶è¡è®¡ç®è½åãGPUç¡¬ä»¶çä¸ä¸ªæ ¸å¿ç»ä»¶æ¯SMï¼åé¢å·²ç»è¯´è¿ï¼SMæ¯Streaming Multiprocessorï¼SMçæ ¸å¿ç»ä»¶åæ¬çCUDAæ ¸å¿ãå±äº«åå­ãå¯å­å¨ç­ï¼SMå¯ä»¥å¹¶åçæ§è¡ä¸ï¼ä¸ä¸ªçº¿ç¨ååªè½å¨ä¸ä¸ªSMä¸è¢«è°åº¦ãSMä¸è¬å¯ä»¥è°åº¦å¤ä¸ªçº¿ç¨åï¼è¿è¦çSMæ¬èº«çè½åãé£ä¹æå¯è½ä¸ä¸ªkernelçåä¸ªçº¿ç¨åè¢«åéå¤ä¸ªSMï¼æä»¥gridåªæ¯é»è¾å±ï¼èSMææ¯æ§è¡çç©çå±ãSMéç¨çæ¯<a href="https://link.zhihu.com/?target=http%3A//docs.nvidia.com/cuda/cuda-c-programming-guide/index.html%23simt-architecture" target="_blank" rel="noopener nofollow">SIMT</a>(Single-Instruction, Multiple-Threadï¼åæä»¤å¤çº¿ç¨)æ¶æï¼åºæ¬çæ§è¡ååæ¯çº¿ç¨æï¼warps)ï¼çº¿ç¨æåå«32ä¸ªçº¿ç¨ï¼è¿äºçº¿ç¨åæ¶æ§è¡ç¸åçæä»¤ï¼ä½æ¯æ¯ä¸ªçº¿ç¨é½åå«èªå·±çæä»¤å°åè®¡æ°å¨åå¯å­å¨ç¶æï¼ä¹æèªå·±ç¬ç«çæ§è¡è·¯å¾ãæä»¥å°½ç®¡çº¿ç¨æä¸­ççº¿ç¨åæ¶ä»åä¸ç¨åºå°åæ§è¡ï¼ä½æ¯å¯è½å·æä¸åçè¡ä¸ºï¼æ¯å¦éå°äºåæ¯ç»æï¼ä¸äºçº¿ç¨å¯è½è¿å¥è¿ä¸ªåæ¯ï¼ä½æ¯å¦å¤ä¸äºæå¯è½ä¸æ§è¡ï¼å®ä»¬åªè½æ­»ç­ï¼å ä¸ºGPUè§å®çº¿ç¨æä¸­ææçº¿ç¨å¨åä¸å¨ææ§è¡ç¸åçæä»¤ï¼çº¿ç¨æååä¼å¯¼è´æ§è½ä¸éãå½çº¿ç¨åè¢«ååå°æä¸ªSMä¸æ¶ï¼å®å°è¿ä¸æ­¥ååä¸ºå¤ä¸ªçº¿ç¨æï¼å ä¸ºè¿ææ¯SMçåºæ¬æ§è¡ååï¼ä½æ¯ä¸ä¸ªSMåæ¶å¹¶åççº¿ç¨ææ°æ¯æéçãè¿æ¯å ä¸ºèµæºéå¶ï¼SMè¦ä¸ºæ¯ä¸ªçº¿ç¨ååéå±äº«åå­ï¼èä¹è¦ä¸ºæ¯ä¸ªçº¿ç¨æä¸­ççº¿ç¨åéç¬ç«çå¯å­å¨ãæä»¥SMçéç½®ä¼å½±åå¶ææ¯æççº¿ç¨ååçº¿ç¨æå¹¶åæ°éãæ»ä¹ï¼å°±æ¯ç½æ ¼åçº¿ç¨ååªæ¯é»è¾ååï¼ä¸ä¸ªkernelçææçº¿ç¨å¶å®å¨ç©çå±æ¯ä¸ä¸å®åæ¶å¹¶åçãæä»¥kernelçgridåblockçéç½®ä¸åï¼æ§è½ä¼åºç°å·®å¼ï¼è¿ç¹æ¯è¦ç¹å«æ³¨æçãè¿æï¼ç±äºSMçåºæ¬æ§è¡ååæ¯åå«32ä¸ªçº¿ç¨ççº¿ç¨æï¼æä»¥blockå¤§å°ä¸è¬è¦è®¾ç½®ä¸º32çåæ°ã</p>
<table>
<thead>
<tr>
<th>åå­ç±»åï¼</th>
<th>åå­ä½ç¨ï¼</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>å¨å±åå­ï¼Global Memoryï¼</strong></td>
<td><strong>å®¹éæå¤§ï¼éå¸¸æ°GBï¼ï¼ææçº¿ç¨å¯è®¿é®ï¼ä½å»¶è¿é«ï¼400-800å¨æï¼</strong></td>
</tr>
<tr>
<td><strong>å±äº«åå­ï¼shared Memoryï¼</strong></td>
<td><strong>çä¸åå­ï¼éåº¦æ¯å¨å±åå­å¿«100åï¼ä½å®¹éæéï¼æ¯SMéå¸¸16-64KBï¼</strong></td>
</tr>
<tr>
<td><strong>å¯å­å¨ï¼Registersï¼</strong></td>
<td><strong>æå¿«çå­å¨ï¼æ¯ä¸ªçº¿ç¨ç§æ</strong></td>
</tr>
<tr>
<td><strong>å¸¸éåå­ï¼Constant Memoryï¼</strong></td>
<td><strong>åªè¯»ç¼å­ï¼éåå¹¿æ­æ°æ®</strong></td>
</tr>
<tr>
<td><strong>çº¹çåå­ï¼Texture Memoryï¼</strong></td>
<td><strong>ä¸ä¸ºå¾å½¢å¤çä¼åçç¹æ®ç¼å­</strong></td>
</tr>
</tbody>
</table>
<p>â     åå­è®¿é®ç¹æ§æ¯è¾ï¼</p>
<table>
<thead>
<tr>
<th>åå­ç±»å</th>
<th>ç©çä½ç½®</th>
<th>ä½ç¨å</th>
<th>å¸¦å®½ãéåº¦</th>
<th>ä½¿ç¨åºæ¯</th>
<th>æ¾å¼æ§å¶å³é®å­</th>
</tr>
</thead>
<tbody>
<tr>
<td>å¯å­å¨</td>
<td>GPUè¯çå¯å­å¨</td>
<td>çº¿ç¨ç§æ</td>
<td>æé«ï¼1å¨æï¼</td>
<td>é«é¢è®¿é®çç§æåéï¼å¦å¾ªç¯è®¡æ°å¨ï¼</td>
<td>èªå¨åéï¼å±é¨åéï¼</td>
</tr>
<tr>
<td>å±äº«åå­</td>
<td>GPUè¯çä¸çSMå¤çå¨</td>
<td>çº¿ç¨åå±äº«</td>
<td>é«ï¼1-32å¨æï¼</td>
<td>çº¿ç¨åä½ï¼å¦è§çº¦è¿ç®ãç©éµååï¼</td>
<td><code>__share__</code></td>
</tr>
<tr>
<td>æ¬å°åå­</td>
<td>å®éå¨å¨å±åå­ä¸­åå­</td>
<td>çº¿ç¨ç§æ</td>
<td>ä¸­ä½ï¼<span class="math inline">\(\approx\)</span>å¨å±åå­ï¼</td>
<td>å¤§æ°ç»æå¯å­å¨ä¸è¶³æ¶çæº¢åºåé</td>
<td>ç¼è¯å¨èªå¨åé</td>
</tr>
<tr>
<td>å¨å±åå­</td>
<td>GPUè®¾å¤æ¾å­</td>
<td>ææçº¿ç¨+ä¸»æº</td>
<td>ä¸­ï¼400~800å¨æï¼</td>
<td>å¤§è§æ¨¡æ°æ®å­å¨ï¼éè¦é¢ç¹è®¿é®æ¶éåå¹¶è®¿é®ä¼å</td>
<td><code>cudaMalloc</code>åé</td>
</tr>
<tr>
<td>å¸¸éåå­</td>
<td>GPUè¯çä¸çç¼å­</td>
<td>ææçº¿ç¨åªè¯»</td>
<td>ä¸­ï¼ç¼å­å éï¼</td>
<td>éè¦å¹¿æ­ç»ææçº¿ç¨çè³å¤</td>
<td><code>__constant__</code></td>
</tr>
<tr>
<td>çº¹çåå­</td>
<td>GPUä¸ç¨ç¼å­</td>
<td>ææçº¿ç¨</td>
<td>ä¸­ ï¼ä¼åè®¿å­ï¼</td>
<td>å¾å½¢å¤çãå·æç©ºé´å±é¨æ§çéå¯¹é½è®¿é®</td>
<td>çº¹çAPIç»å®</td>
</tr>
<tr>
<td>ä¸»æºåå­</td>
<td>CPUåå­</td>
<td>ä¸»æº+è®¾å¤ï¼éè¦æ·è´ï¼</td>
<td>æä½ï¼PCLeç¶é¢ï¼</td>
<td>CPU-GPUæ°æ®ä¼ è¾çä¸­é´å­å¨</td>
<td>mallocãcudaHostAlloc</td>
</tr>
</tbody>
</table>
<p>ä¸é¢æå°è¯¦ç»å°ä»ç»CUDAä¸­åç§åå­ç®¡çå½æ°çåè½ãåæ°åä½¿ç¨æ¹æ³ã</p>
<p><strong>CUDA</strong>æ¯ä¸ç§ç¨äºå¼æå¹¶è¡è®¡ç®çç¼ç¨æ¨¡åï¼ç»å¸¸éè¦å¨ä¸»æºç«¯ï¼hostï¼åè®¾å¤ç«¯ï¼Deviceï¼ä¹é´è¿è¡æ°æ®ä¼ è¾ãè¿æ¯å ä¸ºCUDAæ ¸å½æ°ä¼ å¥çå¿é¡»æ¯æåå¶ä¸­å¤çGPUæ¾å­çä¸ä¸ªå³é®çAPIï¼<code>cudaMalloc</code>,<code>cudaMemcpy</code>å <code>cudaFree</code>ã</p>
<ul>
<li><code>cudaMalloc</code>ï¼</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align: left">å¶æ¥å£APIå½¢å¼ï¼</th>
<th style="text-align: left">cudaError_t  cudaMalloc(void ** <em>devPtr</em>,size_t <em>size</em> )</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left"><strong>å½æ°åè½ï¼</strong></td>
<td style="text-align: left"><strong>å¨è®¾å¤ä¸åéçº¿æ§åå­sizeå­èï¼å¹¶éè¿æéè¿ååéçåå­devPtrãåéçåå­å¯¹åºä»»ä½ç±»åçåéãè®°å¿æ²¡æè¢«æ¸é¤ãå¤±è´¥æ¶è¿å cudaErrorMemoryAllocationã</strong></td>
</tr>
<tr>
<td style="text-align: left"><strong>åæ°ï¼</strong></td>
<td style="text-align: left"><strong><code>devPtr</code> è®¾å¤åå­åéæéï¼<code>size</code> ï¼åéçå­èæ°</strong></td>
</tr>
<tr>
<td style="text-align: left"><strong>è¿åå¼ï¼</strong></td>
<td style="text-align: left"><strong><code>cudaSuccess</code> , <code>cudaErrorMemoryAllocation</code></strong></td>
</tr>
</tbody>
</table>
<p>æ³¨æäºé¡¹ï¼</p>
<p>åéçåå­</p>
<ul>
<li>
<p><code>cudaMemcpy</code> ï¼</p>
<table>
<thead>
<tr>
<th>å¶æ¥å£å½¢å¼ï¼</th>
<th>cudaError_t cudaMemcpy(void * dist, const void * src,size_t count,CudaMemcpyKind kind)</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>å½æ°åè½ï¼</strong></td>
<td><strong>å°æåçåå­åºåçå­èå¤å¶å°æåçå­å¨åºå</strong></td>
</tr>
<tr>
<td><strong>åæ°ï¼</strong></td>
<td><strong>dist-ç®çå­å¨å°åï¼src -æºåå­å°åï¼count-å¤å¶åå­çå­èæ°ï¼ kind-ä¼ è¾ç±»å</strong></td>
</tr>
<tr>
<td><strong>è¿åå¼ï¼</strong></td>
<td><strong>cudaSuccessï¼cudaErrorInvalidValueï¼cudaErrorInvalidDevicePointerï¼cudaErrorInvalidMemcpyDirection</strong></td>
</tr>
</tbody>
</table>
</li>
<li>
<p><code>cudaFree</code>ï¼</p>
<table>
<thead>
<tr>
<th>å¶æ¥å£å½¢å¼ï¼</th>
<th>cudaError_t cudaFree(void * devPtr)</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>å½æ°åè½</strong>ï¼</td>
<td><strong>éæ¾ç± æåçåå­ç©ºé´ï¼è¯¥ç©ºé´å¿é¡»æ¯ä¹åè°ç¨cudaMalloc()æcudaMallocPitch()æ¶è¿åè¿çãå¦åï¼æèå¦æcudaFree()ä¹åå·²è¢«è°ç¨è¿ï¼åè¿åéè¯¯ãå¦æ ä¸º 0ï¼åä¸æ§è¡ä½ãcudaFree() å¨å¤±è´¥æ¶è¿åcudaErrorInvalidDevicePointerã</strong></td>
</tr>
<tr>
<td><strong>åæ°:</strong></td>
<td><strong><code>devPtr</code> -è®¾å¤æéæååå­éæ¾</strong></td>
</tr>
<tr>
<td><strong>è¿åå¼ï¼</strong></td>
<td><strong>cudaSuccessï¼cudaErrorInvalidDevicePointer, cudaErrorInitialization</strong></td>
</tr>
</tbody>
</table>
<p>â</p>
</li>
</ul>
<h2 id="12-cudaçç¬¬ä¸ä¸ªç¨åºç©éµèµå¼matrix-assign">1.2 CUDAçç¬¬ä¸ä¸ªç¨åºâç©éµèµå¼(Matrix Assign)</h2>
<p>â            å¨æ¬èéè¿ä¸ä¸ªç©éµèµå¼ï¼matrix Assignï¼ä¾å­å¼å§çæ­£çCUDAç¨åºå®ç°ï¼æ¬ä¾æ¯å¨SDKä¸­templateç¨åºçåºç¡ä¸ä¿®æ¹å¾å°çã<span class="math inline">\(template\)</span> æ¯ <span class="math inline">\(NVIDIA\)</span> å¬å¸æä¾çCUDAç¨åºæ¨¡æ¿ï¼ä¹å°±æ¯CUDAç¨åºæåºæ¬çæ¡æ¶ãè¦åå»ºä¸ä¸ªCUDAç¨åºï¼å¯ä»¥ææ´ä¸ªtemplateæä»¶å¤å¶ä¸ä»½ãå¨ä¸ä¸ªCUDAç¨åºä¸­ï¼åºæ¬çä¸»æºç«¯ä»£ç ä¸»è¦å®æä»¥ä¸çåè½ï¼</p>
<ul>
<li>å¯å¨CUDAï¼ä½¿ç¨å¤å¡æ¶åºè¯¥æ¶åºè¯¥å ä¸è®¾å¤å·ï¼æä½¿ç¨<span class="math inline">\(cudaSetDevice()\)</span>è®¾å¤GPUè®¾å¤ï¼</li>
<li>ä¸ºè¾å¥æ°æ®åéåå­ç©ºé´ï¼</li>
<li>åå§åè¾å¥æ°æ®ï¼</li>
<li>ä¸ºGPUåéåå­ï¼ç¨äºå­æ¾è¾å¥æ°æ®ï¼</li>
<li>å°åå­ä¸­çè¾å¥æ°æ®æ·è´å°æ¾å­ï¼</li>
<li>ä¸ºGPUåéæ¾å­ï¼ç¨äºå­æ¾è¾åºæ°æ®ï¼</li>
<li>è°ç¨deviceç«¯çkernelè¿è¡è®¡ç®ï¼å°ç»æåå°æ¾å­ä¸­çå¯¹åºåºåï¼</li>
<li>ä¸ºCPUåéåå­ï¼ç¨äºå­æ¾GPUä¼ åæ¥çè¾åºæ°æ®ï¼</li>
<li>å°æ¾å­ä¸­çç»æè¯»åå°åå­ï¼</li>
<li>éæ¾åå­åæ¾å­ç©ºé´ï¼</li>
<li>éåºCUDAï¼</li>
</ul>
<p>æç®åçè®¾å¤ç«¯ä»£ç ä¸»è¦å®æä»¥ä¸åè½ï¼</p>
<ul>
<li>
<p>ä»æ¾å­è¯»åæ°æ®å°GPUçåï¼</p>
</li>
<li>
<p>å¯¹æ°æ®è¿è¡å¤çï¼</p>
</li>
<li>
<p>å°å¤çåçæ°æ®ååæ¾å­ï¼</p>
<p>å¶æ´ä¸ªå·¥ç¨åå«äºä¸ï¼</p>
<p>ï¼1ï¼ä¸»ç¨åºæä»¶CPU-Hostç«¯ç¨åºï¼example1main.cuï¼ï¼</p>
</li>
</ul>
<p>â       ï¼2ï¼GPUè®¾å¤ç«¯å½æ°çå¤çå½æ°å¤´æä»¶ï¼example_matrixassign_kernel.cuhï¼ï¼</p>
<p>â       ï¼3ï¼GPUè®¾å¤ç«¯å½æ°çå¤çå½æ°æä»¶ï¼example_matrixassign_kernel.cuï¼ï¼</p>
<p>File1ï¼ä¸»ç¨åºæä»¶CPU-Hostç«¯ç¨åºï¼example1main.cuï¼ï¼</p>
<pre><code class="language-c">#include&lt;stdio.h&gt; //ç³»ç»å¤´æä»¶
#include&lt;stdlib.h&gt;
#include&lt;string.h&gt;
#include&lt;math.h&gt;

#include"cuda_runtime.h" //cudaé¡¹ç®å¤´æä»¶
#include"device_launch_parameters.h"
#include"example_matrixassign_kernel.cuh"  //æ ¸å½æ°çæ°æ®çå¤´æä»¶


void runTest(int argc, char** argv);

int main(int argc,char** argv){

	runTest(argc,argv);

}

void runTest(int argc, char** argv){

	unsigned int num_blocks = 4;  //å®ä¹ç½æ ¼ä¸­ççº¿ç¨åæ°é
	unsigned int num_threads= 4;  //å®ä¹æ¯ä¸ªçº¿ç¨åä¸­ççº¿ç¨æ°é

	unsigned int mem_size = sizeof(float) * num_blocks * num_threads; //ä¸ºäºæ°æ®åéçå­å¨å¨å¤§å°ï¼è¿éæ¯ä¸ä¸ªäººçº¿ç¨è®¡ç®ä¸ä¸ªflaot

	//å¨hostç«¯åéåå­ï¼h_è¡¨ç¤ºhostç«¯ï¼iè¡¨ç¤ºinputï¼oè¡¨ç¤ºoutput
	float* h_idata = nullptr;
	float* h_odata = nullptr;

	h_idata =(float *)malloc(mem_size);
	h_odata = (float*)malloc(mem_size);

	if(h_idata != nullptr) {
	   memset(h_idata, 0, mem_size);
	}else{
		return;
	}
	if(h_odata!=nullptr){
		memset(h_odata, 0, mem_size);
	}else{
		return;
	}
	
	//å¨deviceç«¯åéæ¾å­ï¼d_è¡¨ç¤ºdeviceç«¯ï¼iè¡¨ç¤ºinputï¼oè¡¨ç¤ºoutput
	float* d_idata = nullptr;
	float* d_odata = nullptr;

	cudaError_t cudaStatus;  //cudaç¶æå¤æ­

	cudaStatus=cudaMalloc((void**)&amp;d_idata, mem_size);
	if(cudaStatus != cudaSuccess){
		printf("d_idata is cudaMalloc failed!\n");
		return;
	}
	cudaStatus=cudaMalloc((void**)&amp;d_odata, mem_size);
	if(cudaStatus!=cudaSuccess){
		printf("d_odata is cudaMalloc failed!\n");
		return;
	}
	
	//åå§ååå­ä¸­çå¼
	for(unsigned int i = 0; i &lt; num_threads * num_blocks;i++){
		h_idata[i] =1.0f;
	}//end for(unsigned int i = 0; i &lt; num_threads * num_blocks;i++)

	//å°åå­ä¸­çè¾å¥æ°æ®è¯»å¥è®¾å¤ç«¯æ¾å­ï¼è¿æ ·å°±å®æäºä¸»æºå¯¹è®¾å¤çæ°æ®åå¥
	cudaStatus=cudaMemcpy(d_idata,h_idata,mem_size,cudaMemcpyHostToDevice);

	//è®¾ç½®è¿è¡åæ°ï¼å³ç½æ ¼çå½¢ç¶åçº¿ç¨åçå½¢ç¶
	dim3 grid(num_blocks,1,1);
	dim3 block(num_threads,1,1);

	// è¿è¡æ ¸å½æ°ï¼è°ç¨GPUè¿è¡è¿ç®
	testMatrixAssignKernel &lt;&lt;&lt;grid, block&gt;&gt;&gt; (d_idata,d_odata);

	//å°ç»æä»æ¾å­åå¥åå­
	cudaStatus = cudaMemcpy(h_odata,d_odata,mem_size,cudaMemcpyDeviceToHost);

	//æå°ç»æ
	printf("èµå¼åçç©éµï¼\n");
	for (unsigned int iblock = 0; iblock &lt; num_blocks; iblock++) {
		for (unsigned int ithread = 0; ithread &lt; num_threads; ithread++) {
			printf("%5.0f", h_idata[iblock * num_threads + ithread]);
		}//end for(unsigned int ithread = 0; ithread &lt; num_threads; ithread++)
		printf("\n");
	}//end for(unsigned int iblock = 0; iblock &lt; num_blocks; iblock++)

	printf("èµå¼åçç©éµï¼\n");
	for(unsigned int iblock = 0; iblock &lt; num_blocks; iblock++){
		for(unsigned int ithread = 0; ithread &lt; num_threads; ithread++){
			printf("%5.0f",h_odata[iblock*num_threads+ithread]);
		}//end for(unsigned int ithread = 0; ithread &lt; num_threads; ithread++)
		printf("\n");
	}//end for(unsigned int iblock = 0; iblock &lt; num_blocks; iblock++)

	//è¾åºå­å¨å¨æé
	free(h_idata);
	free(h_odata);
	cudaFree(d_idata);
	cudaFree(d_odata);
}

</code></pre>
<p>ä»ä»£ç ä¸­çåºï¼CUDAçä¸»æºç«¯ä»£ç ä¸Cè¯­è¨éå¸¸ç¸ä¼¼ãä½ä¹æä¸é¨åCè¯­è¨ä¸­æ²¡æçè¯­å¥ï¼ä¸é¢éä¸è¿è¡åæã</p>
<p>â      ï¼1ï¼<code>cudaMalloc(size)</code>å¨æ¾å­global memoryä¸åéå¤§å°ä¸ºsizeå­èççº¿æ§ç©ºé´ãéè¦æ³¨æçæ¯ï¼ä¸mallocåfreeä¸æ ·ï¼cudaMalloc() ä¹å¿é¡»ä¸cudaFree()æå¯¹ä½¿ç¨ï¼å¦åæ æ³éæ¾æ¾å­ç©ºé´ï¼è¿è¡å æ¬¡ç¨åºä»¥åæ¾å¡ä¸å°±æ²¡ææ¾å­å¯ä¾åéï¼ç¨åºä¹å°±æ æ³æ­£å¸¸è¿è¡äºãå¦å¤ï¼ä¸ºäºæç»æéæè´¹çæåµç°è±¡ï¼æå¥½å¨ç¨åºç»æåå°æéèµç©ºå¹¶æ§æ¯ã</p>
<p>â      ï¼2ï¼ <code>cudaMemcpy()</code>ç¨äºæ·è´å­å¨å¨ä¸­çæ°æ®ï¼å¶ä¸­ç¬¬äºåæ°æ¯æåç®æ çæéï¼ç¬¬äºä¸ªåæ°æ¯æåæºçæéï¼ç¬¬ä¸ä¸ªåæ°æ¯éè¦æ·è´çå­èæ°ï¼ç¬¬åä¸ªåæ°æ¯æ·è´æä½çç±»åãæ·è´æä½ç±»åå±æä¸ç§ï¼</p>
<ul>
<li>cudaMemcpyDeviceToHost å°æ¾å­ä¸­çæ°æ®æ·è´åå­ä¸­ï¼</li>
<li>cudaMemcpyHostToDevice å°åå­ä¸­çæ°æ®æ·è´å°æ¾å­ä¸­ï¼</li>
<li>cudaMemcpyDeviceToDeviceå°global memoryä¸­çæ°æ®æ·è´å°åä¸ä¸ªCUDAä¸ä¸æçglobalçå¦ä¸ä¸ªåºåä¸­ï¼</li>
</ul>
<p>â      ï¼3ï¼<code>&lt;&lt;&lt;&gt;&gt;&gt;</code>è¿ç®ç¬¦å¯¹kernelå½æ°å®æ´çæ§è¡åæ°éç½®å½¢å¼æ¯<code>&lt;&lt;&lt;Dg,Db,Ns,S&gt;&gt;&gt;</code>ï¼å¶ä¸­åä¸ªåæ°çå«ä¹æ¯ï¼</p>
<ul>
<li>åæ°Dgç¨äºå®ä¹æ´ä¸ªgridçç»´åº¦åå°ºå¯¸ï¼ä¸ºdim3ç±»åï¼ä½å®éä¸åªæåä¸¤ç»´å¯ä»¥ä¸ä¸º1ã<code>Dim3 Dg(Dg.x,Dg.y,1)</code>ä¸­æ¯è¡æDg.xä¸ªblockï¼æ¯åæDg.yä¸ªblockçç»´åº¦ï¼ç¬¬ä¸ç»´æä¸º1ã</li>
<li>åæ°Dbä¸ºdim3ç±»åï¼ç¨äºå®ä¹æ¯ä¸ªblockçç»´åº¦ä¸å°ºå¯¸ã<code>Dim3 Db(Db.x,Db.y,Db.z)</code> ä¸­æ¯è¡æ<code>Db.x</code>ä¸ªthreadï¼æ¯å<code>Db.y</code>ä¸ªthreadï¼é«ä¸º<code>Db.z</code>ï¼å¯ä»¥å®ä¹ä¸ç»´å°ºå¯¸ãæ´ä¸ªblockä¸­å±æ<code>Db.x*Db.y*Db.z</code> ä¸ªçº¿ç¨ï¼</li>
<li>åæ°Nsæ¯ä¸ä¸ªå¯éåæ°ï¼ç¨äºè®¾ç½®æ¯ä¸ªblockçå±äº«åå­shared memoryä»¥å¤ï¼æå¤è½å¤å¨æåéçshared memoryå¤§å°ï¼åä½ä¸ºByteã</li>
<li>åæ°<span class="math inline">\(s\)</span>æ¯ä¸ä¸ªcudaStream_tç±»åçå¯éåæ°ï¼åå§å¼ä¸º0ãå¨æ¬æ¡ä¾ä¸­æ²¡æç¨å°Streamçç¸å³åå®¹å æ­¤è¿ä¸ªåæ°ä¸å¡«ï¼é»è®¤ä¸º0å·æµã</li>
</ul>
<p>File2ï¼ä¸»ç¨åºæä»¶CPU-Hostç«¯ç¨åºï¼example1main.cuï¼ï¼</p>
<p>â</p>
<pre><code class="language-c">
#pragma once
#ifndef EXAMPLE_MATRIXASSIGN_KERNEL_H
#define EXAMPLE_MATRIXASSIGN_KERNEL_H

#include&lt;stdio.h&gt;
#include"cuda_runtime.h"

__global__ void testMatrixAssignKernel(float* data_input, float* data_output);


#endif // !_EXAMPLE_MATRIXASSIGN_KERNEL_H_
</code></pre>
<p>File2ï¼ä¸»ç¨åºæä»¶CPU-Hostç«¯ç¨åºï¼example1main.cuï¼ï¼</p>
<pre><code class="language-C">
__global__ void testMatrixAssignKernel(float *data_input,float *data_output){

	//shared memory,externè¡¨ç¤ºå¤§å°ç±hostç«¯çNsåæ°ç¡®å®
	extern __shared__ float sdata[];

	const unsigned int bid = blockIdx.x; //çº¿ç¨æå¨çblockçç´¢å¼å·
	const unsigned int tid_in_block = threadIdx.x; //çº¿ç¨å¨blockä¸­çä½ç½®
	const unsigned int tid_in_grid = blockDim.x * blockIdx.x + threadIdx.x;

	//æè¡ååä»»å¡æ¶ï¼çº¿ç¨å¨æ´ä¸ªgridä¸­çä½ç½®

  // å°æ°æ®ä»global memoryè¯»å¥shared memory
	sdata[tid_in_block] = data_input[tid_in_grid];
	//è¯»å¥æ°æ®åè¿è¡ä¸æ¬¡åæ­¥ï¼ä¿è¯è®¡ç®æ¶æææ°æ®åå·²å°ä½
	__syncthreads();

	// è®¡ç®
	sdata[tid_in_block] = (float)tid_in_grid;
	//  sdata[tid_in_block] *= (float)tid_in_block;
	//  sdata[tid_in_block] *= (float)tid_in_grid;

	  //è¿è¡åæ­¥ï¼ç¡®ä¿è¦åå¥çæ°æ®å·²ç»è¢«æ´æ°
	__syncthreads();

	// å°shared memoryä¸­çæ°æ®åå°global memory
	data_output[tid_in_grid] = sdata[tid_in_block];


}
</code></pre>
<p>ç±ä¸å¯ç¥ï¼æç®åç<code>__gloabal__</code>ç¨åºç±ä»¥ä¸çè¿ç¨ç»æï¼</p>
<ol>
<li>åé<span class="math inline">\(shared \space memory\)</span>ï¼</li>
<li>å°<span class="math inline">\(global\space memory\)</span> ä¸­çæ°æ®è¯»å¥<span class="math inline">\(shared \space memory\)</span>;</li>
<li>å°è¿è¡è®¡ç®ï¼å°ç»æåå°<span class="math inline">\(shared \space memory\)</span>;</li>
<li>å°<span class="math inline">\(shared\)</span>ä¸­çç»æåå°<span class="math inline">\(global \space memory\)</span> ;</li>
</ol>
<p>â         è¿è¡ä¸æ¬¡GPUè®¡ç®ï¼è¦å¨å¤ç§å­å¨å¨è¿è¡å æ¬¡æ°æ®ä¼ è¾ï¼è¦æ¶èç¸å½å¤çæ¶é´ãè¿å¯¼è´äºè¾å¤§çå»¶è¿ï¼è¿å¯¼è´ä½¿<span class="math inline">\(GPU\)</span> ä¸éåå¤çä¸äºå®æ¶æ§è¦æ±å¾é«çåºç¨ãä¸åå­å¨å¨é´çæ°æ®ä¼ è¾éçåä½¿ç¨æ¹æ³æå¾å¤§å·®å¼ï¼å¼åäººåéè¦æ ¹æ®ç¡¬ä»¶çç¹ç¹æ¥è®¾è®¡ç®æ³ï¼ä»¥ä¼åå­å¨å¨è®¿é®ãå¨çæ³æåµä¸ï¼å¨ææçå­å¨å¨ä¼ è¾è¿è¡çåæ¶ï¼GPUçåä¸ªæ ¸å¿ä¹å§ç»å¨è¿è¡è®¡ç®ï¼è¿æ ·å°±è½å¤å¾å¥½çéèåç§è®¿é®å»¶è¿ãCUDA å¹¶ä¸æ¯ä¸ç§å®å¨ç¡¬ä»¶éæçè¯­è¨ï¼ç¨åºåéè¦æ ¹æ®ç¡¬ä»¶ç¹å¾å°ä»»å¡è¿è¡åççåè§£ï¼å¨ç¼ç¨æ¶å¯¹æ°æ®ä¼ è¾åå¯å­å¨è®¿é®è¿è¡ä¼åã</p>
<p>â       <code>__global__</code>åç¼è¡¨ç¤ºè¿ä¸æ®µä»£ç æ¯cuda GPUç«¯åæ ¸å½æ°ãåæ ¸å½æ°è¿è¡å¨è®¾å¤ä¸ï¼å¶è¿åç±»åå¿é¡»ä¸ºvoidã<code>__global__</code>å½æ°ä¸­æ¯æ¯ä¸ä¸ªçº¿ç¨è¦æ§è¡çè¯­å¥ï¼ä½ç±äº<span class="math inline">\(shared\space memory\)</span>ååæ­¥çå­å¨ï¼å¨æå¥½å°<code>__global__</code>å½æ°çè§£ä¸ºå¯¹æ¯ä¸ä¸ªblockçè¡ä¸ºçæè¿°ã</p>
<p>â        å¨è¿ä¸ç«¯åæ ¸å½æ°ä¸­ï¼é¦åå®ä¹äº<span class="math inline">\(shared \space memory\)</span> ä¸­çåéï¼ç¶åæ ¹æ®åå»ºåéå®ä¹æ¯ä¸ä¸ªblockåthreadçç´¢å¼ï¼å¯¹ä»»å¡è¿è¡ååï¼æåï¼æ¯ä¸ä¸ªçº¿ç¨æ§è¡äºç¸åçæ±åè¿ç®ï¼ä½å¤çæ°æ®ä¸åï¼ç±çº¿ç¨çç´¢å¼å³å®çãç¨åºåå¨ç¼å<code>__global__</code>å½æ°ä¹åï¼è¦åå¯¹ä»»å¡è¿è¡ååï¼è®¾è®¡åä¸ªblockçå·¥ä½æµç¨åï¼åå°æç«¹å¨è¸ã</p>
<p>â        ç±äºCUDAéç¨äºä¸¤å±å¹¶è¡ï¼å æ­¤æ¬ä¾å¨ååä»»å¡æ¶ï¼æ¯ä¸ªthreadå¨gridä¸­çç´¢å¼<span class="math inline">\(tid\_in\_grid\)</span> æ¯ç±threadæå¨blockåç¼å·tidè®¡ç®å¾æ¥çãè®¡ç®åºæ¯ä¸ªçº¿ç¨çç´¢å¼åï¼å°±å¯ä»¥æ ¹æ®ç´¢å¼å¤ççº¿ç¨ä¸­ä¸åçæ°æ®ï¼è¯·è¯»èå¥½å¥½ä½ä¼è¿ä¸ç¹ã</p>
<p>â      <code>extern __shared__ float sdata[]</code> å¨shared  memoryä¸­ä¸ºæ°ç»dataå¨æåéäºç©ºé´ã<code>extern</code> å¨è®¾å¤ç«¯åä¸»æºç«¯æä¸åçå«ä¹ï¼<code>__device__</code>å<code>__global__</code> å½æ°ä¸­è¡¨ç¤ºå¨æåéï¼èå¨ä¸»æºç«¯å½æ°ä¸­è¡¨ç¤ºå¤é¨åéãå¦æè¦éæåéä¸å <code>shared memory</code>ï¼é£ä¹å¨<code>__shared__</code>ä¹åå°±ä¸å <code>extern</code>ï¼è¿å¿é¡»å¨[]ä¸­åä¸è¦åéçå­èæ°ãå¨æåéçshared memoryå¤§å°ï¼æ¯&lt;&lt;&lt;&gt;&gt;&gt;çæ§è¡åæ°ä¸­ç¬¬ä¸ä¸ªåæ°è§å®çå¤§å°ãå³äº<code>shared memory</code>å¤§å°ã</p>
<p>â        CUDAå®ä¹äºä¸äºåå»ºåéå¦ä¸ï¼</p>
<ol>
<li>gridDimï¼ ç½æ ¼çç»´åº¦çåéï¼dim3ç±»å</li>
<li>blockIdx:    åçç´¢å¼åéï¼unit3ç±»å</li>
<li>blockDimï¼åçç»´åº¦åéï¼dim3ç±»å</li>
<li>threadIdxï¼ååççº¿ç¨ç´¢å¼åéï¼unit3ç±»å</li>
<li>warpSizeï¼çº¿ç¨ä¸­çwarpå¤§å°ï¼intç±»å</li>
</ol>
<p>å¶è¾åºç»æï¼</p>
<p><img alt="è¾åºç»æ" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1602810/202601/1602810-20260105183218257-98277715.png" class="lazyload"></p>
<p>â</p>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-01-05 18:34">2026-01-05 18:33</span>&nbsp;
<a href="https://www.cnblogs.com/GeophysicsWorker">GeoFXR</a>&nbsp;
éè¯»(<span id="post_view_count">7</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19444388);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19444388', targetLink: 'https://www.cnblogs.com/GeophysicsWorker/p/19444388', title: 'NVIDIA CUDA é«æ§è½è®¡ç®ç¬è®°ï¼ä¸ï¼cudaç¼ç¨ç®ä»åç©éµèµå¼æ¡ä¾' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ Cè¯­è¨ç¨åºèªå¨åè½¬CUDAçæ¹æ³ç ç©¶ ]]></title>
    <link>https://www.cnblogs.com/huanxx/p/19443586</link>
    <guid>a3c103044a81239541da6cd3b1713b92</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/huanxx/p/19443586" title="åå¸äº 2026-01-05 16:18">
    <span role="heading" aria-level="2">Cè¯­è¨ç¨åºèªå¨åè½¬CUDAçæ¹æ³ç ç©¶</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                    <div id="cnblogs_post_description" style="display: none">
        <img src="https://img2024.cnblogs.com/blog/3550672/202601/3550672-20260105161800826-262297873.png" alt="Cè¯­è¨ç¨åºèªå¨åè½¬CUDAçæ¹æ³ç ç©¶" class="desc_img">
        èªå¨å°Cè¯­è¨ç¨åºè½¬åä¸ºè½å¤ç´æ¥ä½¿ç¨nvccç¼è¯çCUDAç¨åº, ç ç©¶æè·¯
    </div>
<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h1 id="c2cuda">C2CUDA</h1>
<p></p><div class="toc"><div class="toc-container-header">ç®å½</div><ul><li><a href="#c2cuda" rel="noopener nofollow">C2CUDA</a><ul><li><a href="#ç®æ åæ" rel="noopener nofollow">ç®æ åæ</a><ul><li><a href="#cudaå éçåç" rel="noopener nofollow">CUDAå éçåç</a></li><li><a href="#cè¯­è¨ä¸­å¯è¢«ææå éçé¨å" rel="noopener nofollow">Cè¯­è¨ä¸­å¯è¢«ææå éçé¨å</a></li></ul></li><li><a href="#å®ä¹å®ç" rel="noopener nofollow">å®ä¹å®ç</a></li></ul></li></ul></div><p></p>
<hr>
<h2 id="ç®æ åæ">ç®æ åæ</h2>
<p>é¦åï¼<mark>ç®æ </mark>æ¯å°Cè¯­è¨è½¬åä¸ºCUDAå éç¨åºçè¿è¡ï¼ä»è¿éæä»¬å¼åºä¸¤ç¹éè¦æ¢ç©¶çåå®¹æ¯ï¼</p>
<ul>
<li>CUDAå éçåçæ¯ä»ä¹ï¼</li>
<li>Cè¯­è¨ä¸­çä»ä¹é¨åå¯ä»¥è¢«CUDAææçå éï¼</li>
</ul>
<hr>
<h3 id="cudaå éçåç">CUDAå éçåç</h3>
<blockquote>
<p>2006å¹´ï¼NVIDIAæ¨åºäº<em>ç»ä¸è®¡ç®è®¾å¤æ¶æ</em>ï¼CUDAï¼ï¼ä½¿ä»»ä½è®¡ç®å·¥ä½è´è½½é½è½ä¸åå¾å½¢APIçéå¶ï¼å©ç¨GPUçååéè½åã</p>
<p><strong>ââCUDAç¼ç¨æå</strong></p>
</blockquote>
<p>ä»ä¸é¢çå¼ç¨å¯ä»¥çåºï¼CUDAè®¾è®¡çç®çæ¯å©ç¨GPUçååéè½åï¼åä½æ¶é´åç³»ç»è½å¤ççä»»å¡æ»éï¼ææ°æ®éï¼ï¼</p>
<p>èCUDA çæ ¸å¿é»è¾æ¯å°å¤§è§æ¨¡å¹¶è¡çè½¯ä»¶é»è¾ï¼Threadï¼æ å°å°å¤§è§æ¨¡å¹¶è¡çç¡¬ä»¶èµæºï¼Coreï¼ä¸</p>
<p>å æ­¤ææ ¸å¿çåçå°±æ¯<mark>å¹¶è¡</mark>ï¼å æ­¤Cè¯­è¨ä¸­çä»ä¹é¨åå¯ä»¥è¢«CUDAææçå éï¼</p>
<hr>
<h3 id="cè¯­è¨ä¸­å¯è¢«ææå éçé¨å">Cè¯­è¨ä¸­å¯è¢«ææå éçé¨å</h3>
<p>ææ ¸å¿çå°±æ¯<mark>å¯ä»¥å¹¶è¡ç</mark>é¨åï¼é£ä¹å¨ä¸ä¸ªä¸²è¡çCè¯­è¨ä»£ç ä¸­æä»ä¹å¯ä»¥å¹¶è¡å¢ï¼</p>
<ul>
<li><mark>æ°æ®å¹¶è¡</mark>ï¼å¨<strong>C è¯­è¨</strong>ä¸­ï¼<mark>å¾ªç¯ï¼Loopï¼</mark>æ¯æ°æ®å¹¶è¡æä¸»è¦ãçè³å ä¹æ¯å¯ä¸çæ¾å¼è¡¨ç°å½¢å¼ã</li>
<li>ä»»å¡å¹¶è¡ï¼ä»£ç ä¸­äºä¸ç¸å³ç<strong>å½æ°è°ç¨</strong>æ<strong>ä»£ç å</strong>ä¹å¯ä»¥å¹¶è¡ï¼ ä»»å¡å¹¶è¡çè§æ¨¡éå¸¸å¾å°ï¼æ¯å¦åæ¶è· 2-4 ä¸ªä¸åçä»»å¡ï¼ï¼ç¸æ¯äºå¾ªç¯å¨è¾ä¸ç¾ä¸æ¬¡çè¿­ä»£ï¼å®å¸¦æ¥çå éææè¿ä¸å¦å¾ªç¯å¹¶è¡ææ¾</li>
<li>æä»¤çº§å¹¶è¡ï¼ è¿ç§å¹¶è¡éå¸¸ç±ç¡¬ä»¶ååç«¯ç¼è¯å¨ï¼å¦ NVCCï¼èªå¨ä¼åï¼éå¸¸ä¸éè¦å³æ³¨å®ã</li>
</ul>
<p>å æ­¤ï¼æ ¸å¿ç®æ å°±æ¯å°Cè¯­è¨ä¸­çå¾ªç¯å©ç¨CUDAå¹¶è¡åè¿è¡å¨ä¸åç¡¬ä»¶ä¸ã</p>
<blockquote>
<p>[!IMPORTANT]</p>
<p>å°å¾ªç¯å¹¶è¡åæå³çä¸åå¾ªç¯å¾ªç¯è¿­ä»£ä¹é´çè¿è¡é¡ºåºæ¯ä¸ä¿è¯çï¼</p>
<p>CUDA æ§è¡çº¿ç¨æ¯å¹¶åçï¼ç¡¬ä»¶è°åº¦æ¯ä¸ç¡®å®çãè¿­ä»£ <span class="math inline">\(100\)</span> å¯è½æ¯è¿­ä»£ <span class="math inline">\(1\)</span> åæ§è¡ï¼ä¹å¯è½åæ¶æ§è¡ãè¿æ¬è´¨ä¸å°±æ¯ä¸ç§<strong>æç«¯çâéæåºâ</strong>ã</p>
</blockquote>
<p>å æ­¤è¦ç¡®ä¿å¹¶è¡åææï¼ä¸è½æ¹åç¨åºçæç»ç»æï¼ï¼å°±å¿é¡»è¯å«ä»ä¹å¾ªç¯å¯ä»¥ç¨å¹¶è¡ãè¿éä»ä¸ä¸ªå®çå¼å¥</p>
<blockquote>
<p>å®ç	<strong>è¿­ä»£éæåº</strong>	ä¸ä¸ªåæ¢éæ<span class="math inline">\(k\)</span>å±å¾ªç¯è¿­ä»£çé¡ºåºï¼æ­¤å¤ä¸åä»»ä½å¶ä»çæ¹åï¼å¦æè¯¥å¾ªç¯ä¸æºå¸¦ä¾èµï¼é£ä¹å®æ¯ææçã</p>
<p>**ââç°ä»£ä½ç³»ç»æçä¼åç¼è¯å¨ ([ç¾] Randy Allen) **</p>
</blockquote>
<p>è¿ä¸ªå®çå¯ä»¥è¯´æ¯æ¬é¡¹ç®ç ç©¶çåºç³ï¼é¡¹ç®çå¥å£ï¼å ä¸ºåªæç¡®å®ä»ä¹æ ·çå¾ªç¯è¿­ä»£è½å¤è¿è¡è¿­ä»£éæåºæä»¬æè½ä½¿ç¨CUDAå¯¹å¶è¿è¡å¹¶è¡åã</p>
<p>ç±æ­¤å®çå¼åºçæ¦å¿µï¼<a href="#xhxdyl" rel="noopener nofollow">å¾ªç¯æºå¸¦ä¾èµ</a>ã<a href="#xhxdyldc" rel="noopener nofollow">å¾ªç¯æºå¸¦ä¾èµçå±</a></p>
<p>å°æ­¤ä¸ºæ­¢, æä»¬å·²ç»ç¥éé¡¹ç®è¦å¦ä½è¿è¡äº, ä½¿ç¨å®ä¹<a href="#xhxdyl" rel="noopener nofollow">å¾ªç¯æºå¸¦ä¾èµ</a>å¤æ­å¾ªç¯åµå¥æ¯å¦æä¾èµä»¥åä¾èµæå¨çå±(å¯¹äºæäºå­å¨å¾ªç¯æºå¸¦çå±, å©ç¨å¾ªç¯åæ¢è½å¤è½¬åä¸ºä¸æºå¸¦ä¾èµçå±), æ ¹æ®å®ç<strong>è¿­ä»£éæåº</strong>å¯¹ä¸å­å¨æºå¸¦ä¾èµçå±å©ç¨CUDAå¹¶è¡å</p>
<hr>
<h2 id="å®ä¹å®ç">å®ä¹å®ç</h2>
<blockquote>
<p>[!NOTE]</p>
<p>å®ççæ¥èªäºç°ä»£ä½ç³»ç»æçä¼åç¼è¯å¨ ([ç¾] Randy Allen)</p>
</blockquote>
<blockquote>
<p><span id="xhxdyl"> </span><strong>å®ä¹	å¾ªç¯æºå¸¦ä¾èµ</strong>	è¯­å¥<span class="math inline">\(S_2\)</span>å¯¹è¯­å¥<span class="math inline">\(S_1\)</span>æä¸ä¸ªå¾ªç¯æºå¸¦ä¾èµ,å½ä¸ä»å½<span class="math inline">\(S_1\)</span>å¨è¿­ä»£iä¸­å¼ç¨åå<span class="math inline">\(M\)</span>,è<span class="math inline">\(S_2\)</span>å¨è¿­ä»£jä¸­å¼ç¨<span class="math inline">\(M\)</span>,ä¸<span class="math inline">\(d(i,j)&gt;0\)</span>(å³<span class="math inline">\(D(i,j)\)</span>åå«ä¸ä¸ªâ&lt;âä½ä¸ºå®çæå·¦éâ=âåé)</p>
</blockquote>
<p>æ­¤å®ä¹å¼åºçæ¦å¿µ:<a href="#ddxl" rel="noopener nofollow">è¿­ä»£åé</a>,<a href="#yljlxl" rel="noopener nofollow">ä¾èµè·ç¦»åé</a>,<a href="#ylfxxl" rel="noopener nofollow">ä¾èµæ¹ååé</a></p>
<blockquote>
<p><span id="xhxdyldc"> </span><strong>å®ä¹	å¾ªç¯æºå¸¦ä¾èµçå±</strong>	æ­¤ä¾èµç<span class="math inline">\(D(i,j)\)</span>çæå·¦éâ=âç´¢å¼</p>
</blockquote>
<blockquote>
<p><span id="ddxl"> </span><strong>å®ä¹	è¿­ä»£åé</strong>	ç»å®<span class="math inline">\(n\)</span>ä¸ªå¾ªç¯çåµå¥,æåå±å¾ªç¯ç<strong>ä¸ä¸ªç¹å®çè¿­ä»£</strong>çè¿­ä»£åé<span class="math inline">\(i\)</span>æ¯ä¸ä¸ªæ´å½¢åé,å®åå«æåµå¥å±é¡ºåºçæ¯å±å¾ªç¯çè¿­ä»£å·.</p>
<p></p><div class="math display">\[i=\{i_1,i_2,\dots,i_n\}
\]</div><p></p><p>å¶ä¸­<span class="math inline">\(i_k,(1\le k \le n)\)</span>è¡¨ç¤ºå¨åµå¥å±kä¸çå¾ªç¯è¿­ä»£å·.</p>
</blockquote>
<p>æ­¤å®ä¹å¼åºçæ¦å¿µ:<a href="#xhddh" rel="noopener nofollow">å¾ªç¯è¿­ä»£å·</a></p>
<blockquote>
<p><span id="yljlxl"> </span><strong>å®ä¹	ä¾èµè·ç¦»åé</strong>	åè®¾ä»å¾ªç¯åµå¥è¿­ä»£ <span class="math inline">\(i\)</span> ä¸­è¯­å¥ <span class="math inline">\(S_1\)</span> å°è¿­ä»£ $ j $ ä¸­è¯­å¥ <span class="math inline">\(S_2\)</span> æä¸ä¾èµï¼åä¾èµè·ç¦»åé $ \mathbf{d}(i, j) $ å®ä¹ä¸ºé¿åº¦ä¸º <span class="math inline">\(n\)</span> çåéï¼ä½¿å¾</p>
<p></p><div class="math display">\[\mathbf{d}(i, j)_k = j_k - i_k
\]</div><p></p></blockquote>
<blockquote>
<p><span id="ylfxxl"> </span><strong>å®ä¹	ä¾èµæ¹ååé</strong>	åè®¾ä» <span class="math inline">\(n\)</span> å±å¾ªç¯åµå¥çè¿­ä»£ <span class="math inline">\(i\)</span> ä¸­è¯­å¥ <span class="math inline">\(S_1\)</span> å°è¿­ä»£ $ j $ ä¸­è¯­å¥ <span class="math inline">\(S_2\)</span> æä¸ä¾èµï¼é£ä¹ä¾èµæ¹ååé $ \mathbf{D}(i, j) $ å®ä¹ä¸ºé¿åº¦ä¸º <span class="math inline">\(n\)</span> çåéï¼ä½¿å¾</p>
<p></p><div class="math display">\[\mathbf{D}(i, j)_k = 
\begin{cases}
&lt; , &amp; \text{å¦æ } \mathbf{d}(i, j)_k &gt; 0 \\
= , &amp; \text{å¦æ } \mathbf{d}(i, j)_k = 0 \\
&gt; , &amp; \text{å¦æ } \mathbf{d}(i, j)_k &lt; 0
\end{cases}
\]</div><p></p></blockquote>
<blockquote>
<p><span id="xhddh"> </span><strong>å®ä¹	å¾ªç¯è¿­ä»£å·</strong>	å¯¹ä»»æä¸ä¸ªå¾ªç¯ï¼å¶ä¸­å¾ªç¯ç´¢å¼ $ I $ ä»¥æ­¥é¿ $ S $ ä» $ L $ æ­¥è¿å° $ U $ï¼ä¸ä¸ªç¹å®è¿­ä»£çï¼æ­£è§åï¼è¿­ä»£å· <span class="math inline">\(i\)</span> ç­äºå¼ $ (I - L + S) / S $ï¼å¶ä¸­ $ I $ æ¯è¯¥è¿­ä»£ä¸­ç´¢å¼åéçå¼ã</p>
</blockquote>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-01-05 16:18">2026-01-05 16:18</span>&nbsp;
<a href="https://www.cnblogs.com/huanxx">å¹»ææ</a>&nbsp;
éè¯»(<span id="post_view_count">20</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19443586);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19443586', targetLink: 'https://www.cnblogs.com/huanxx/p/19443586', title: 'Cè¯­è¨ç¨åºèªå¨åè½¬CUDAçæ¹æ³ç ç©¶' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ æ°çå¾®ä¿¡4.1åä»¥ä¸datæä»¶è½¬å¾ç ]]></title>
    <link>https://www.cnblogs.com/wang_xy/p/19444824</link>
    <guid>4f7eae768b502f568ba1da24ac167535</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/wang_xy/p/19444824" title="åå¸äº 2026-01-05 21:48">
    <span role="heading" aria-level="2">æ°çå¾®ä¿¡4.1åä»¥ä¸datæä»¶è½¬å¾ç</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body blogpost-body-html">
<p>å¾®ä¿¡çµèçç°å¨å·²ç»æ¯æ¥å¸¸å·¥ä½çæ´»å¿ä¸å¯å°çå·¥å·ï¼ææ¶å é¤äºèå¤©è®°å½æè¢«ç³»ç»æ¸çè½¯ä»¶æ¸çäºï¼ä½è¿æ³æ¥çæ¾ç»çå¾®ä¿¡èå¤©å¾çã<br>è¿ä¸ªæ¶åè¾è¾è¦è¦æ¾å°äºæä»¶ï¼å´åç°æ æ³æ¥çï¼å ä¸ºå¾®ä¿¡çµèçä¸ºäºä¿æ¤æä»¬çéç§ï¼æååçå¾çæ ¼å¼æä»¶ç»åäºå å¯å¤çåæäºDATæ ¼å¼ï¼è¿éä¸å¾ä¸ç»å¾®ä¿¡ä¸ä¸ªå¤§å¤§çèµã<br>é£ä¹æä»¬å°±åªè½æ¯ççæä»¶æ²¡æåæ³äºä¹ï¼ç­æ¡å½ç¶æ¯ï¼ææ¹æ³çãä¸é¢ççåºè¯¥å¦ä½å¤çå¾®ä¿¡DATå¾çè½¬æ¢jpgå¾çæ ¼å¼ï¼ægifæpngï¼å§ã<br>ä¸é®æ¹éå°å¾®ä¿¡èå¤©æ¥åå°çå å¯å­å¨DATå¾çæä»¶è½¬åä¸ºæ®éå¾çã<br><span style="color: rgba(255, 0, 255, 1)">éè¿æ¥çè½¬ååçå¾çï¼æ¨å¯ä»¥ï¼</span><br><span style="color: rgba(255, 0, 255, 1)">ï¼1ï¼æ¸çæ ç¨çåå²å¾çï¼èççµèç¡¬çå­å¨ç©ºé´ã</span><br><span style="color: rgba(255, 0, 255, 1)">ï¼2ï¼æ¢å¤å¯»æ¾éè¦ç§çèµæã</span></p>
<p>ä¸è½½å°åï¼</p>
<p>ï¼1ï¼ç¹å»ä¸è½½ï¼<a href="https://weijiesoft.lanzouu.com/iJ7Bq3f44h8h" target="_blank" rel="noopener nofollow">&gt;&gt;&gt;ç¹æä¸è½½&lt;&lt;&lt;</a></p>
<p>ï¼2ï¼æå¤å¶é¾æ¥å°æµè§å¨ä¸è½½ï¼&nbsp;https://weijiesoft.lanzouu.com/iJ7Bq3f44h8h</p>
<p>ä»æ¯æå¾®ä¿¡4.1çæ¬åä»¥ä¸ï¼ä¹æ¯æå¾®ä¿¡3.9.xçèçæ¬å¾®ä¿¡çdatçè½¬æ¢å¾çã</p>
<p>æ¯ææ¹éè½¬æ¢ï¼æ¯æåä¸ªè½¬æ¢ã</p>
<p><img src="https://img2024.cnblogs.com/blog/687256/202601/687256-20260105213100992-1663916089.png" alt="image" loading="lazy"></p>
<p>&nbsp;ï¼1ï¼åä¸ªè½¬æ¢</p>
<p><img src="https://img2024.cnblogs.com/blog/687256/202601/687256-20260105214431641-1449253764.png" alt="image" loading="lazy"></p>
<p>&nbsp;</p>
<p>ï¼2ï¼æ¹éè½¬æ¢</p>
<p><img src="https://img2024.cnblogs.com/blog/687256/202601/687256-20260105213422839-134454665.png" alt="image" loading="lazy"></p>
<p>&nbsp;</p>
</div>
<div id="MySignature" role="contentinfo">
    <div style="display: block" id="MySignature"><br>
<fieldset style="padding: 10px; margin: 10px; background-color: #708090; width: 850px">
<p><span style="color: #fff">çæå£°æ</span></p><p>
</p><hr style="color: #fff">
<p><span style="color: #fff">ä½èï¼</span><span style="color: #fff">Wagwei</span></p>
  <p><span style="color: #fff">èç³»æ¹å¼ï¼</span><span style="color: #fff">
   
   
   <span><a href="tencent://Message/?Uin=453357830&amp;websiteName=local.edu.com:8888=&amp;Menu=yes" class="btn btn-qq"><img border="0" src="http://pub.idqqimg.com/wpa/images/counseling_style_52.png" alt="qq:453357830" title="ä¸æèå¤©"></a></span>



    QQ:453357830
    </span></p>
<p><span style="color: #fff">åºå¤ï¼</span><a style="color: #fff" href="http://www.cnblogs.com/wagxy" target="_blank">åå®¢å­ Wagwei çææ¯åå®¢--http://www.cnblogs.com/wagxy</a> </p>
<p><span style="color: #fff">æ¨çæ¯ææ¯å¯¹åä¸»æå¤§çé¼å±ï¼æè°¢æ¨çè®¤çéè¯»ã</span></p>
<p><span style="color: #fff">æ¬æçæå½ä½èææï¼æ¬¢è¿è½¬è½½ï¼ä½æªç»ä½èåæå¿é¡»ä¿çæ­¤æ®µå£°æï¼ä¸å¨æç« é¡µé¢ææ¾ä½ç½®ç»åºåæè¿æ¥ï¼å¦åä¿çè¿½ç©¶æ³å¾è´£ä»»çæå©ã</span></p>
</fieldset></div>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-01-05 21:49">2026-01-05 21:48</span>&nbsp;
<a href="https://www.cnblogs.com/wang_xy">Wagwei</a>&nbsp;
éè¯»(<span id="post_view_count">0</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19444824);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19444824', targetLink: 'https://www.cnblogs.com/wang_xy/p/19444824', title: 'æ°çå¾®ä¿¡4.1åä»¥ä¸datæä»¶è½¬å¾ç' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ [python] éç½®ç®¡çæ¡æ¶Hydraä½¿ç¨æå ]]></title>
    <link>https://www.cnblogs.com/luohenyueji/p/19444783</link>
    <guid>13adf9e9546482bef5eb8df536c1f1e2</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/luohenyueji/p/19444783" title="åå¸äº 2026-01-05 21:29">
    <span role="heading" aria-level="2">[python] éç½®ç®¡çæ¡æ¶Hydraä½¿ç¨æå</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<p>Hydraæ¯Facebook Researchå¼åçå¼æºPythonéç½®ç®¡çæ¡æ¶ï¼æ¨å¨è§£å³å¤æé¡¹ç®ä¸­éç½®æ··ä¹±ãå¤ç¯å¢ä¸å¤åæ°ç»åç®¡ççé¾é¢ãè¯¥æ¡æ¶éç¨åå±éç½®ä¸å¨æç»åè®¾è®¡ï¼æ¯æä»¥YAMLæä»¶å®ç°ç»æåéç½®ãHydraå°¤å¶éç¨äºç®åæºå¨å­¦ä¹ å®éªãè½¯ä»¶å¼ååå¶ä»å¤æåºç¨çéç½®ç®¡çãå®çåå­æ¥æºäºå¸èç¥è¯ä¸­çä¹å¤´èï¼å¯æå¶è½å¤çµæ´»ç®¡çå¤ç§éç½®ç»åãHydraçæ ¸å¿ç¹æ§åæ¬æ¯æå¤æºåå±éç½®ç»åãå¯éè¿å½ä»¤è¡ç´æ¥è¦çéç½®ãæä¾å¨æå½ä»¤è¡¥å¨åè½ï¼åæ¶æ¯ææ¬å°ä¸è¿ç¨è¿è¡ï¼å¹¶è½éè¿åå½ä»¤æ§è¡æ¹éåæ°ä½ä¸ã</p>
<p><img src="https://gitlab.com/luohenyueji/article_picture_warehouse/-/raw/main/CSDN/%5Bpython%5D%20%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E6%A1%86%E6%9E%B6Hydra%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8C%97/imgs/img1.svg" alt="https://github.com/facebookresearch/hydra/blob/main/website/static/img/Hydra-Readme-logo2.svg" loading="lazy"></p>
<p>Hydraçå®æ¹ä»åºå°åä¸ºï¼<a href="https://github.com/facebookresearch/hydra" target="_blank" rel="noopener nofollow">hydra</a>ï¼è¯¦ç»ææ¡£å¯åéï¼<a href="https://hydra.cc/docs/intro/" target="_blank" rel="noopener nofollow">hydra-doc</a>ãHydraåè½å¨é¢ï¼æ¬æä¸»è¦ä»ç»å¶åºæ¬ä½¿ç¨æ¹æ³ï¼æ´å¤é«çº§åè½è¯·åèå®æ¹ææ¡£ãæªè³æ¬ææ°åæ¶ï¼Hydraçç¨³å®çæ¬ä¸º1.3ï¼è¯¥çæ¬å¼å®¹Python 3.6è³3.11ï¼å¹¶å¨é¢æ¯æLinuxãmacOSåWindowsæä½ç³»ç»ãå®è£å½ä»¤å¦ä¸ï¼</p>
<blockquote>
<p>pip install hydra-core --upgrade</p>
</blockquote>
<p></p><div class="toc"><div class="toc-container-header">ç®å½</div><ul><li><a href="#1-åºç¡æç¨" rel="noopener nofollow">1 åºç¡æç¨</a><ul><li><a href="#11-å¿«éå¥é¨" rel="noopener nofollow">1.1 å¿«éå¥é¨</a></li><li><a href="#12-æ´ååºç¨" rel="noopener nofollow">1.2 æ´ååºç¨</a></li><li><a href="#13-ä¿¡æ¯ç®¡ç" rel="noopener nofollow">1.3 ä¿¡æ¯ç®¡ç</a></li></ul></li><li><a href="#2-ç»æåéç½®" rel="noopener nofollow">2 ç»æåéç½®</a><ul><li><a href="#21-hydraä»£ç éç½®" rel="noopener nofollow">2.1 Hydraä»£ç éç½®</a></li><li><a href="#22-éç½®æ¨¡å¼" rel="noopener nofollow">2.2 éç½®æ¨¡å¼</a></li></ul></li><li><a href="#3-åè" rel="noopener nofollow">3 åè</a></li></ul></div><p></p>
<h1 id="1-åºç¡æç¨">1 åºç¡æç¨</h1>
<h2 id="11-å¿«éå¥é¨">1.1 å¿«éå¥é¨</h2>
<p><strong>ç®åç¤ºä¾</strong></p>
<p>ä»¥ä¸ä»£ç æ¯ä¸ä¸ªç®åçHydraåºç¨ç¤ºä¾ï¼å®ä¼æå°åºéç½®ä¿¡æ¯ï¼å¶ä¸­my_appå½æ°æ¯ç¼åä¸å¡é»è¾çå¥å£ã</p>
<pre><code class="language-python">from omegaconf import DictConfig, OmegaConf
import hydra

@hydra.main(version_base=None)
def my_app(cfg: DictConfig) -&gt; None:
    print(OmegaConf.to_yaml(cfg))

if __name__ == "__main__":
    my_app()
</code></pre>
<p>å¦æä½ ç´æ¥æ§è¡è¿æ®µä»£ç ï¼æ²¡æä»»ä½å½ä»¤è¡åæ°ï¼ï¼ç¨åºä¼è¾åºä¸ä¸ªç©ºçéç½®å¯¹è±¡ï¼</p>
<pre><code>{}
</code></pre>
<p>è¿æ¯å ä¸ºï¼å½è¿è¡<code>my_app.py</code>æ¶ï¼<code>@hydra.main</code>è£é¥°å¨ä¼èªå¨æ¦æªå¯¹ <code>my_app()</code>çè°ç¨ãæ­¤æ¶Hydraä¼åå§åä¸ä¸ªç©ºç<code>DictConfig</code>å¯¹è±¡ï¼ç±»ä¼¼äºPythonå­å¸ï¼ï¼å¹¶å°å¶ä½ä¸ºåæ°<code>cfg</code> ä¼ éç»å½æ°ãç±äºå½åéç½®ä¸ºç©ºï¼<code>OmegaConf.to_yaml(cfg)</code>å°å¶è½¬æ¢ä¸ºYAMLæ ¼å¼åï¼ä»è¾åºä¸ä¸ªç©ºå¯¹è±¡ãOmegaConfæ¯Hydraçåºå±éç½®å¼æï¼HydraåºäºOmegaConfå®ç°ä¸å±çå¤æåºç¨éç½®ä¸è¿è¡ç®¡çï¼ä¸OmegaConfå¯ç¬ç«ä½¿ç¨ã</p>
<p>æ­¤å¤é»è®¤æåµä¸ï¼Hydraä¼åå»ºä»¥ä¸ç®å½ç»æä»¥è¿½è¸ªåç®¡çç¨åºçè¿è¡ç»æï¼</p>
<pre><code>outputs/
âââ yyyy-mm-dd/          # ææ¥æåç»
â   âââ hh-mm-ss/        # ææ¶é´ç²¾ç¡®å°ç§
â       âââ .hydra/      # ä¿å­æ¬æ¬¡è¿è¡çéç½®
â           âââ config.yaml    # å®æ´çéç½®
â           âââ hydra.yaml     # Hydra èªèº«çéç½®
â           âââ overrides.yaml # å½ä»¤è¡è¦ççåæ°
â       âââ my_app.log   # æ¥å¿æä»¶ï¼å¦æéç½®äºæ¥å¿ï¼
â       âââ å¶ä»è¾åºæä»¶     # ä½ çç¨åºçæçæä»¶
</code></pre>
<p>å¯ä»¥éè¿ä»¥ä¸æ¹å¼ä¸ºéç½®æ·»å åå®¹ï¼</p>
<ol>
<li>
<p>éè¿å½ä»¤è¡æ·»å ï¼</p>
<pre><code class="language-bash"># ä¸æ¯æç´æ¥å¨ +key=value è¯­æ³ä¸­ä¼ å¥é ASCII å­ç¬¦
python my_app.py +name="zhangsan" +age=25
</code></pre>
<p>è¾åºï¼</p>
<pre><code class="language-yaml">name: zhangsan
age: 25
</code></pre>
</li>
<li>
<p>åå»ºéç½®æä»¶ï¼<br>
åå»ºä¸ä¸ª<code>config.yaml</code>æä»¶ï¼ç¶åè¿è¡ï¼</p>
<pre><code class="language-bash">python my_app.py --config-path=. --config-name=config
</code></pre>
</li>
<li>
<p>å¨ä»£ç ä¸­è®¾ç½®é»è®¤éç½®ï¼<br>
å¯ä»¥ä¿®æ¹ä»£ç ï¼ä¸º<code>@hydra.main</code>è£é¥°å¨æ·»å éç½®åæ°ï¼</p>
<pre><code class="language-python">from omegaconf import DictConfig, OmegaConf
import hydra

@hydra.main(version_base=None, config_path=".", config_name="config")
def my_app(cfg):
    print(OmegaConf.to_yaml(cfg))

if __name__ == "__main__":
    my_app()
</code></pre>
<p>å¯ä»¥éè¿å½ä»¤è¡è¦çå·²å è½½éç½®ä¸­çå¼ï¼ä½æ¯æ³¨ææ éæ·»å +åç¼ï¼</p>
<pre><code class="language-bash">python my_app.py name="lisi"
</code></pre>
<p>ä½¿ç¨++åç¼å¯å®ç°è¥éç½®ä¸­å·²å­å¨è¯¥åæ°åè¦çï¼è¥ä¸å­å¨åæ°å¢ï¼</p>
<pre><code class="language-bash">python my_app.py ++name="wangwu" ++password=1234
</code></pre>
<p>è¦æ³¨æð¤ï¼Hydraéè¿å½ä»¤è¡ä¿®æ¹éç½®æ¶ï¼ä»ä¼è¦çææ°å¢ç¨åºè¿è¡æ¶åå­ä¸­çéç½®æ°æ®ï¼ä¸ä¼æ¹å¨ç£çä¸çåå§éç½®æä»¶ï¼éå¯ç¨åºåä»ä¼éç½®å è½½æä»¶çåå§éç½®ã</p>
</li>
</ol>
<p><strong>éç½®å¯¹è±¡ä½¿ç¨</strong></p>
<p>éè¿Hydraå è½½éç½®åï¼å¯éè¿å±æ§æå­å¸å¼è®¿é®æä¿®æ¹å·²æçéç½®é¡¹ï¼è®¿é®ä¸å­å¨çéç½®é¡¹æ¶ä¼æåºå¼å¸¸ï¼</p>
<pre><code class="language-python">from omegaconf import DictConfig, OmegaConf
import hydra

@hydra.main(version_base=None, config_path=".", config_name="config")
def my_app(cfg: DictConfig):
    # å±æ§å¼è®¿é®éç½®å¼
    assert cfg.name == "å¼ ä¸"
    # å­å¸å¼è®¿é®éç½®å¼
    assert cfg["age"] == 25
    
    # ä¿®æ¹å·²æéç½®å¼
    cfg.name = "æå"          
    cfg["age"] = 30            
    assert cfg.name == "æå"
    assert cfg["age"] == 30

    # è®¿é®ç¼ºå¤±å¼ä¼æåºå¼å¸¸
    try:
        cfg.birth_year
    except Exception as e:
        print("error !!")
        print(e)

if __name__ == "__main__":
    my_app()
</code></pre>
<p>ä¹æä»¥ä¸åè®¸è®¿é®ä¸å­å¨çéç½®é®ï¼ä»è½æä½å·²æéç½®é®ï¼æ¯å ä¸ºHydraé»è®¤å¯ç¨äºstructæ¨¡å¼ä»¥ä¸¥æ ¼ç»æåéç½®ãå¦éæ°å¢æä¿®æ¹éç½®ï¼å¯åå³é­ä¸¥æ ¼æ¨¡å¼ï¼åè®¸å¨ææ°å¢é®ãä½å¦æåµå¥å±çº§ä¹æªæåå£°æï¼åéè¦ååå»ºç©ºåµå¥ï¼åä¸ºå¶æ·»å å­é¡¹ï¼</p>
<pre><code class="language-python">from omegaconf import DictConfig, OmegaConf
import hydra
import os

@hydra.main(version_base=None, config_path=".", config_name="config")
def my_app(cfg: DictConfig):
    # å³é­structæ¨¡å¼ï¼åè®¸æ°å¢éç½®é®
    OmegaConf.set_struct(cfg, False)

    # åä¸çº§æ°å¢éç½®
    cfg.birth_year = 1995      
    cfg["hobby"] = ["ç¯®ç", "ç¼ç¨"]

    # æ æ³ç´æ¥ç»ä¸å­å¨çåµå¥å±çº§é¾å¼èµå¼
    # cfg.address.city = "åäº¬"          
    # éè¦ååå»ºåµå¥å±çº§ï¼åèµå¼å­é®
    cfg.address = OmegaConf.create({})  # æ¾å¼åå»ºç©ºçåµå¥
    cfg.address.city = "åäº¬"         
    cfg.address["district"] = "æé³åº"

    # éªè¯åå¥ç»æ
    assert cfg.birth_year == 1995  
    assert cfg.address.district == "æé³åº"
    print("éç½®åå¥éªè¯éè¿ï¼")

if __name__ == "__main__":
    my_app()
</code></pre>
<p><strong>å¯¹éç½®æä»¶è¿è¡åç»</strong></p>
<p>è¥å¸æåå«ä½¿ç¨CNNåTransformeræ¨¡åå¯¹æ°æ®éè¿è¡è®­ç»åºåæµè¯ï¼å¯éè¿éç½®ç»ï¼Config Groupï¼å®ç°è¿ä¸éæ±ãéç½®ç»æ¯ä¸ä¸ªå¸¦æåç§°çåç»ï¼åå«ä¸ç»ææçéç½®é¡¹ãè¥éæ©ä¸å­å¨çéç½®é¡¹ï¼ç³»ç»ä¼çæéè¯¯æç¤ºï¼å¹¶ååºææææçéç½®é¡¹ã</p>
<p>åå»ºéç½®ç»æ¶ï¼éåæ°å»ºä¸ä¸ªç®å½ï¼ä¾å¦modelï¼ï¼ç¨äºå­æ¾åæ¨¡åéç½®é¡¹å¯¹åºçæä»¶ãç±äºé¢è®¡ä¼åå»ºå¤ä¸ªéç½®ç»ï¼å»ºè®®æåå°ææéç½®æä»¶ç»ä¸ç§»è³confç®å½ä¸ç®¡çã</p>
<p>ç®å½ç»æå¦ä¸ï¼</p>
<pre><code class="language-shell">ââ conf
â  ââ model
â      ââ cnn.yaml
â      ââ transformer.yaml
âââ my_app.py
</code></pre>
<p>model/cnn.yamlï¼</p>
<pre><code class="language-shell">backbone: resnet50
learning_rate: 0.001
batch_size: 32
epochs: 20
dropout: 0.2
</code></pre>
<p>model/transformer.yamlï¼</p>
<pre><code class="language-shell">backbone: vit_base
learning_rate: 0.0001
batch_size: 16
epochs: 30
attention_heads: 12
</code></pre>
<p>ææéç½®æä»¶å·²ç»ä¸å­æ¾è³confç®å½ï¼ééè¿config_pathåæ°åç¥Hydraè¯¥ç®å½ä½ç½®ï¼å¹¶å¨ä»£ç ä¸­æå®å¾å è½½çéç½®æä»¶åconfig_nameãè¥æªæç¡®æå®å·ä½éç½®æä»¶åï¼Hydraæ æ³èªå¨æ¨æ­å è½½ç®æ ï¼æç»ä¼è¾åºç©ºéç½®:</p>
<pre><code class="language-python">from omegaconf import DictConfig, OmegaConf
import hydra

@hydra.main(version_base=None, config_path="conf", config_name="model/cnn")
def my_app(cfg: DictConfig) -&gt; None:
    print(OmegaConf.to_yaml(cfg))

if __name__ == "__main__":
    my_app()
</code></pre>
<p>ä¹å¯ä»¥éè¿å½ä»¤è¡ä»éç½®ç»ä¸­éæ©ç¹å®éç½®é¡¹ï¼å½ä»¤è¡ä½¿ç¨<code>+åç»å=éç½®é¡¹</code>çæ ¼å¼ï¼ä¾å¦ï¼</p>
<pre><code class="language-python">python my_app.py +model=transformer
</code></pre>
<p>ä¸å¸¸è§ç¨æ³ä¸è´ï¼ä»å¯è¦çæç»éç½®ä¸­çåä¸ªåæ°å¼ï¼</p>
<pre><code class="language-python">python my_app.py +model=transformer model.epochs=40
</code></pre>
<p><strong>å¤æä»¶å¤ç</strong></p>
<p>å¯ä»¥çæä¸ä¸ªéç½®æä»¶ï¼å¨éç½®æä»¶ä¸­ç¨<code>defaults</code>åæ°æ·»å é»è®¤éç½®åè¡¨ãè¯¥åè¡¨ç¨äºæå®Hydraç»åæç»éç½®å¯¹è±¡çè§åï¼æç§çº¦å®ï¼å®éä½ä¸ºéç½®æä»¶çé¦ä¸ªéç½®é¡¹ãå¦ä¸æç¤ºï¼</p>
<pre><code class="language-shell">defaults:
  - model: cnn
</code></pre>
<p>ç¶åè¿ä¸ªéç½®æä»¶å¯ä»¥å½åä¸ºä»»æåå­ï¼å¦confæä»¶å¤¹ä¸çconfig.yamlï¼è¿æ ·è¿è¡ä¼é»è®¤å è½½modelå¯¹åºçæä»¶éç½®ï¼</p>
<pre><code class="language-python">from omegaconf import DictConfig, OmegaConf
import hydra

@hydra.main(version_base=None, config_path="conf", config_name="config")
def my_app(cfg: DictConfig) -&gt; None:
    print(OmegaConf.to_yaml(cfg))

if __name__ == "__main__":
    my_app()
</code></pre>
<p>é»è®¤éç½®åè¡¨æ¯æå å å¤ä¸ªæ·±åº¦å­¦ä¹ ç¸å³éç½®é¡¹ãè¥åä¸éç½®ç»å­å¨ä¸¤ä¸ªéç½®æä»¶ï¼ç³»ç»ä¼å°è¿ä¸¤ä¸ªéç½®æä»¶åå¹¶ä¸ºä¸ä¸ªæ°å­å¸ï¼å½éç½®ä¸­åºç°ç¸åé®åæ¶ï¼åå è½½çéç½®é¡¹ä¼è¦çåå è½½çéç½®é¡¹ãç¤ºä¾é»è®¤éç½®å¦ä¸ï¼</p>
<pre><code class="language-shell">defaults:
  - model: 
    - cnn
    - transformer
</code></pre>
<p>è¥å¨éç½®æä»¶å¤¹confä¸çdatasetç®å½ä¸­ï¼å­å¨å¦ä¸éç½®æä»¶model/cifar10.yamlï¼</p>
<pre><code class="language-shell">name: CIFAR-10
path: ./data/cifar10
num_classes: 10
learning_rate: 0.0001
augmentation: true  # æ¯å¦å¼å¯æ°æ®å¢å¼º
</code></pre>
<p>å½é»è®¤éç½®æä»¶conf/config.yamlä¸­é»è®¤éç½®åè¡¨çåå®¹å¦ä¸ï¼</p>
<pre><code class="language-shell">defaults:
  - model: cnn
  - dataset: cifar10 
</code></pre>
<p>ç±äºmodelådatasetåå±ä¸åçéç½®ç»ï¼Hydraä¼å°è¿ä¸¤ä¸ªéç½®ç»çé»è®¤éç½®è¿è¡ç¬ç«åå¹¶ãæç»çæçå®æ´éç½®ç»æä¸­ï¼ä¼åå«modelådatasetä¸¤ä¸ªä¸çº§éç½®é¡¹ï¼åèªä¿çå¯¹åºéç½®ç»çå®æ´åæ°ï¼</p>
<pre><code class="language-shell">model:
  # æ­¤å¤ä¸ºconf/model/cnn.yamlä¸­çéç½®åå®¹
dataset:
  # æ­¤å¤ä¸ºconf/dataset/cifar10.yamlä¸­çéç½®åå®¹
</code></pre>
<p>å³ä½¿è®¾ç½®äºé»è®¤éç½®ï¼ä»å¯æå¨ç¡®å®åæ°å¹¶è¦çé¨åéç½®åæ°ï¼</p>
<pre><code class="language-shell">python my_app.py model=cnn model.epochs=30
</code></pre>
<p>å¨éç½®é¡¹åæ·»å ~åç¼ï¼å¯ä»é»è®¤éç½®åè¡¨ä¸­ç§»é¤è¯¥é»è®¤é¡¹ï¼</p>
<pre><code class="language-shell">python my_app.py ~model
</code></pre>
<p><strong>ä¸»éç½®çç»åé¡ºåº</strong></p>
<p>ä¸»éç½®æä»¶ä¸­å¯åæ¶åå«éç½®åæ°åé»è®¤éç½®åè¡¨ãå¨æ­¤æåµä¸ï¼è¥éè°æ´é»è®¤éç½®åè¡¨ä¸ä¸»éç½®ä¹é´çè¦çå³ç³»ï¼å¯éè¿æ·»å <code>_self_</code>å³é®å­å®ç°ï¼å°<code>_self_</code>ç½®äºé»è®¤éç½®åè¡¨æ«å°¾ï¼åä¸»éç½®åæ°å°è¦çé»è®¤éç½®åè¡¨ä¸­çå¯¹åºé¡¹ï¼è¥å°å¶ç½®äºåè¡¨å¼å¤´ï¼åé»è®¤éç½®åè¡¨ä¸­çåæ°å°è¦çä¸»éç½®ä¸­çåå®¹ã</p>
<p>éæ³¨æçæ¯ï¼ä»Hydra 1.1çæ¬å¼å§ï¼é»è®¤è¡ä¸ºä¸ºä¸»éç½®è¦çé»è®¤éç½®åè¡¨ä¸­çéç½®ï¼èå¨æ­¤ä¹åççæ¬ä¸­ï¼é»è®¤éç½®åè¡¨ä¼è¦çä¸»éç½®çåæ°ã</p>
<p>ä¾å¦é»è®¤éç½®æä»¶config.yamlåå®¹å¦ä¸ï¼ä¼è¿è¡æ°æ®è¦çï¼ä¹å°±æ¯è¯´éç½®æä»¶édataseté¨åä¼è¦çé»è®¤éç½®ä¸­çååé¨åï¼</p>
<pre><code class="language-shell">defaults:
  - model: cnn
  - dataset: cifar10 
  - _self_

dataset: 
  name: my_dataset
version: 1.0
</code></pre>
<h2 id="12-æ´ååºç¨">1.2 æ´ååºç¨</h2>
<p>éçè½¯ä»¶å¤æåº¦çä¸æ­æåï¼æä»¬ä¼éç¨æ¨¡ååä¸ç»ååçè®¾è®¡æè·¯æ¥ä¿è¯å¶å¯ç»´æ¤æ§ãè¿ç§æè·¯åæ ·éç¨äºéç½®æä»¶çç®¡çãåè®¾æä»¬éè¦ä¸ºç¤ºä¾ç¨åºéç½®å¤ç±»æ·±åº¦å­¦ä¹ æ¨¡åæ¯æï¼ä¸æ¯ä¸ªæ¨¡åå¯¹åºå¤ç§è®­ç»ç­ç¥ãæ­éä¸åçæ°æ®é¢å¤çæµç¨ãä½¿ç¨Hydraæ¶ï¼æ¢ä¸å¿ä¸ºæ¨¡åãç­ç¥ãé¢å¤çæµç¨çåç±»ç»åç¼åç¬ç«ç±»ï¼ä¹æ éä¸ºå¶åç¬ç¼åéç½®æä»¶ãæä»¬å¯ä»¥åé´åºå±è½¯ä»¶å¼åçæ ¸å¿æè·¯ï¼éè¿ç»ååéç½®æ¥è§£å³è¿ä¸é®é¢ã</p>
<p><img src="https://gitlab.com/luohenyueji/article_picture_warehouse/-/raw/main/CSDN/%5Bpython%5D%20%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E6%A1%86%E6%9E%B6Hydra%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8C%97/imgs/img2.svg" alt="https://github.com/facebookresearch/hydra/blob/main/website/static/img/Hydra-plugins2.svg" loading="lazy"></p>
<p><strong>å¤è½®è¿è¡ï¼Multi-runï¼</strong></p>
<p>å¯¹äºä½¿ç¨å¤å¥éç½®è¿è¡åä¸åºç¨ç¨åºçåºæ¯ï¼å¯ä»¥éè¿å½ä»¤è¡æéç½®æä»¶ä¸¤ç§æ¹å¼ä¸ºHydraåºç¨å¯ç¨å¤è½®è¿è¡åè½ãè¯¥åè½èªHydra 1.2çæ¬èµ·å¼å¥ï¼éè¿è®¾ç½®hydra.modeéç½®é¡¹å®ç°ãhydra.modeçåæ³åå¼åæ¬RUNï¼åæ¬¡è¿è¡ï¼åMULTIRUNï¼å¤è½®è¿è¡ï¼ãè¥å¨è¾å¥éç½®ä¸­å°hydra.modeè®¾ä¸ºMULTIRUNï¼åºç¨ç¨åºå°é»è®¤ä»¥å¤è½®è¿è¡æ¨¡å¼å¯å¨ã</p>
<p>ä¾å¦é»è®¤éç½®æä»¶ä¸ºï¼</p>
<pre><code class="language-python">defaults:
  - model: cnn
  - dataset: cifar10 
</code></pre>
<p>å¤è½®è¿è¡å½ä»¤å¦ä¸ï¼</p>
<pre><code class="language-python">python my_app.py hydra.mode=MULTIRUN model=cnn,transformer dataset=cifar10
</code></pre>
<p>åªè¦åæ°å¼ç¨éå·åéï¼å°±ä¼è¢«Hydraè¯å«ä¸ºå¤åå¼åæ°ï¼Hydraä¼æææå¸¦å¤ä¸ªåå¼çåæ°åç¬å¡å°ç§¯ï¼å¨ç»åï¼ï¼Hydraä¼ææ¯ä¸ªåæ°çåå¼ä¸¤ä¸¤éå¯¹ï¼çæä»¥ä¸å¤ä¸ªä»»å¡ï¼ä¾æ¬¡è¿è¡ï¼</p>
<pre><code class="language-shell">python my_app.py hydra.mode=MULTIRUN model=cnn,transformer dataset=cifar10
# æ¬å°å¯å¨2ä¸ªä»»å¡
#0 : model=cnn dataset=cifar10
#1 : model=transformer dataset=cifar10
</code></pre>
<p>è¯¥å½ä»¤å¯ä»¥ç¨å½ä»¤è¡åæ°ç®åï¼</p>
<pre><code class="language-shell">python my_app.py --multirun model=cnn,transformer dataset=cifar10
# æ
python my_app.py -m model=cnn,transformer dataset=cifar10
</code></pre>
<p>æ³¨æHydraä¼å¨ä»»å¡å¯å¨æ¶å»¶è¿ç»åéç½®ãè¥å¨å¯å¨ä»»å¡åæ°éååä¿®æ¹ä»£ç æéç½®æä»¶ï¼æç»ç»åçæçéç½®å¯è½ä¼åå½±åã</p>
<p>ä¹å¯ä»¥å¨è¾å¥éç½®ä¸­éè¿è¦çhydra.sweeper.paramsæ¥å®ä¹åæ°éåè§åå¹¶éè¿modeè®¾ç½®è¿è¡æ¨¡å¼ãæ²¿ç¨ä¸è¿°ç¤ºä¾ï¼ä»¥ä¸éç½®å¯å®ç°å®å¨ç¸åçå¤è½®è¿è¡ææï¼</p>
<pre><code class="language-shell">defaults:
  - model: cnn
  - dataset: cifar10 

hydra:
  mode: MULTIRUN # è®¾ç½®è¿è¡æ¨¡å¼
  sweeper:
    params:
      dataset: cifar10
      model: transformer, cnn
</code></pre>
<p>ç´æ¥è¿è¡ç¨åºä¸ä½¿ç¨ä»»ä½éå åæ°ï¼ç»æå¦ä¸ï¼</p>
<pre><code class="language-shell">$ python my_app.py
# æ¬å°å¯å¨2ä¸ªä»»å¡
#0 : model=transformer dataset=cifar10
#1 : model=cnn dataset=cifar10
</code></pre>
<h2 id="13-ä¿¡æ¯ç®¡ç">1.3 ä¿¡æ¯ç®¡ç</h2>
<p><strong>è¾åºç®å½</strong></p>
<p>Hydraè½å¤è§£å³æ¯æ¬¡è¿è¡ç¨åºæ¶éè¦æå¨æå®æ°è¾åºç®å½çé®é¢ï¼å®ä¼ä¸ºæ¯æ¬¡è¿è¡èªå¨åå»ºä¸ä¸ªä¸å±ç®å½ï¼å¹¶å¨è¯¥è¾åºç®å½ä¸­æ§è¡ä»£ç ãé»è®¤æåµä¸ï¼æ¯æ¬¡è¿è¡åºç¨ç¨åºæ¶ï¼é½ä¼çæä¸ä¸ªå¨æ°çè¾åºç®å½ãå¯ä»¥éè¿è¯»åHydraéç½®æ¥è·åæ¬æ¬¡è¿è¡è¯¥è¾åºç®å½çè·¯å¾ï¼ç¤ºä¾å¦ä¸ï¼</p>
<pre><code class="language-python">from omegaconf import DictConfig, OmegaConf
import hydra
import os

@hydra.main(version_base=None, config_path="conf", config_name="config")
def my_app(_cfg: DictConfig) -&gt; None:
    print(f"å·¥ä½ç®å½ï¼{os.getcwd()}")
    print(f"è¾åºç®å½ï¼{hydra.core.hydra_config.HydraConfig.get().runtime.output_dir}")

if __name__ == "__main__":
    my_app()
</code></pre>
<p>éè¿è®¾ç½®hydra.job.chdir=Trueï¼å¯ä»¥è®©Hydraç<code>@hydra.main</code>è£é¥°å¨å¨æ§è¡ç¨æ·çä¸»å½æ°åï¼è°ç¨os.chdirå°Pythonå·¥ä½ç®å½åæ¢å°è¾åºç®å½ï¼</p>
<pre><code class="language-shell">python my_app.py hydra.job.chdir=True
</code></pre>
<p>å¯ä»¥éè¿è¦çéç½®é¡¹hydra.output_subdirå°è®¾ä¸ºnullï¼åä¼å®å¨ç¦ç¨è¯¥å­ç®å½çåå»ºã</p>
<p><strong>æ¥å¿</strong></p>
<p>ç±äºæ åloggingæ¨¡åéç½®è¾ä¸ºå¤æï¼ä¸ºå®ç°å¸¸è§çæ¥å¿åè½éå¸¸éè¦ç¼åè¾å¤ä»£ç ï¼ä¸éç½®è¿ç¨ä¸å¤ç®ä¾¿ãHydraè½å¤èªå¨å®æPython loggingçéç½®ï¼ä»èææè§£å³è¿ä¸é®é¢ãé»è®¤æåµä¸ï¼Hydraä¼ä»¥INFOçº§å«åæ§å¶å°è¾åºæ¥å¿ï¼åæ¶å¨å½åå·¥ä½ç®å½èªå¨çææ¥å¿æä»¶çå­è®°å½ãä»¥ä¸ä¸ºä½¿ç¨Hydraè¿è¡æ¥å¿è®°å½çç¤ºä¾ï¼</p>
<pre><code class="language-python"># hydra_log_demo.py
import logging
from omegaconf import DictConfig
import hydra
# ä¸ºæ¬æä»¶åå»ºæ¥å¿å¨
log = logging.getLogger(__name__)
@hydra.main(version_base=None)
def my_app(_cfg: DictConfig) -&gt; None:
    log.info("Info çº§å«æ¥å¿æ¶æ¯")
    log.debug("Debug çº§å«æ¥å¿æ¶æ¯")
if __name__ == "__main__":
    my_app()
</code></pre>
<p>å¯éè¿å¨å½ä»¤è¡ä¸­æå®<code>hydra.verbose</code>éç½®é¡¹æ¥å¯ç¨DEBUGçº§å«çæ¥å¿è¾åºãè¯¥éç½®é¡¹æ¯æå¸å°å¼ãå­ç¬¦ä¸²æåè¡¨ç±»åçåå¼ï¼å¼å¯å¨é¨ææå®æ¥å¿å¨çDEBUGçº§å«è¾åºå¦ä¸ï¼</p>
<pre><code>python hydra_log_demo.py hydra.verbose=true
</code></pre>
<p>è¥è¦å°ç¹å®å½æ°å¯¹åºæ¥å¿å¨ççº§å«è®¾ä¸ºDEBUGï¼å¯ä½¿ç¨å¦ä¸å½ä»¤ï¼</p>
<pre><code>python hydra_log_demo.py hydra.verbose="[__main__,my_custom_logger]"
</code></pre>
<p>å¶ææç­åäºä»£ç ï¼</p>
<pre><code class="language-python">import logging
logging.getLogger(NAME).setLevel(logging.DEBUG)
</code></pre>
<p>å¦æä¸å¸æHydraèªå¨éç½®æ¥å¿ç³»ç»ï¼å¯ä»¥å°hydra/job_loggingï¼å¯¹åºç¨åºçæ¥å¿ï¼åhydra/hydra_loggingï¼å¯¹åºHydraæ¡æ¶èªèº«çæ¥å¿ï¼åè®¾ä¸ºnoneï¼</p>
<pre><code class="language-python">python my_app.py hydra/job_logging=None hydra/hydra_logging=None
</code></pre>
<p><strong>è°è¯åè½</strong></p>
<p>Hydraæä¾å¤ç§éç½®éé¡¹ï¼å¯æææåç¨åºçå¯è°è¯æ§ãå¨å½ä»¤è¡ä¸­ä½¿ç¨<code>--cfg</code>æ<code>-c</code>åæ°ï¼å³å¯å¨ä¸è¿è¡ç®æ å½æ°çæåµä¸æå°åºç¨ç¨åºçéç½®ä¿¡æ¯ãè¯¥åæ°ééåä¸ä¸ªéé¡¹æ¥æå®æå°çéç½®èå´ï¼</p>
<ul>
<li>jobï¼æå°ä¸å¡ä»£ç çéç½®</li>
<li>hydraï¼æå°hydraæ¡æ¶èªèº«çéç½®</li>
<li>allï¼æå°å®æ´éç½®åå®¹ï¼å³ä¸å¡éç½®ä¸hydraéç½®çåé</li>
</ul>
<p>ä»æå°ä¸å¡éç½®æä»¤å¦ä¸ï¼</p>
<pre><code class="language-bash">$ python my_app.py --cfg job
</code></pre>
<p>è¥åªå±ç¤ºéç½®ä¸­çæä¸å­éï¼å¯æ­éåæ°<code>--package</code>æç®å<code>-p</code>ä½¿ç¨ï¼</p>
<pre><code class="language-bash">python my_app.py --cfg hydra --package hydra.job
</code></pre>
<p>é»è®¤æåµä¸ï¼éç½®ä¸­çæå¼è¡¨è¾¾å¼ä¸ä¼è¢«è§£æãè¥éæå°è§£æåçæç»éç½®ï¼å¯å¨<code>--cfg</code>åæ°åºç¡ä¸ï¼é¢å¤æ·»å <code>--resolve</code>åæ°ã</p>
<p><strong>ä¿¡æ¯æ¥è¯¢åè½</strong></p>
<p>ä½¿ç¨<code>--info</code>åæ°å¯æ¥è¯¢Hydraæ¡æ¶ååºç¨ç¨åºçåç±»ç¸å³ä¿¡æ¯ï¼</p>
<ul>
<li>--info allï¼é»è®¤æ¨¡å¼ï¼æå°ææå¯ç¨ä¿¡æ¯</li>
<li>--info configï¼æå°éç½®ç»åç¸å³çè¾å©ä¿¡æ¯ï¼åæ¬ï¼éç½®æç´¢è·¯å¾ãé»è®¤éç½®æ ãé»è®¤éç½®åè¡¨åæç»çæçéç½®åå®¹</li>
<li>--info defaultsï¼æå°æç»çé»è®¤éç½®åè¡¨</li>
<li>--info defaults-treeï¼æå°é»è®¤éç½®æ ç»æ</li>
<li>--info pluginsï¼æå°å·²å®è£çæä»¶ä¿¡æ¯</li>
</ul>
<h1 id="2-ç»æåéç½®">2 ç»æåéç½®</h1>
<p>å¨å¤æé¡¹ç®ä¸­ï¼éç½®æä»¶å¸¸é¢ä¸´ç±»åæ¨¡ç³ãéç½®éè¯¯é¾ææ¥ãç¼ºå°éææ ¡éªç­é®é¢ãä¾å¦ï¼å­æ®µç±»åä¸æç¡®æå¼åè¿è¡æ¶å¼å¸¸ãå¤å±çº§éç½®çç»æä¸è´æ§é¾ä»¥ä¿éãåä½æ¶é¾ä»¥éè¿å·¥å·æååç°éç½®å²çªã</p>
<p><img src="https://gitlab.com/luohenyueji/article_picture_warehouse/-/raw/main/CSDN/%5Bpython%5D%20%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E6%A1%86%E6%9E%B6Hydra%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8C%97/imgs/img3.svg" alt="https://github.com/facebookresearch/hydra/blob/main/website/static/img/undraw_product_teardown_hydra_plain.svg" loading="lazy"></p>
<p>ä¸ºæ­¤ï¼HydraåºäºPythonæ°æ®ç±»ï¼dataclassesï¼å®ä¹äºéç½®ç»æä¸ç±»åï¼å¶æ ¸å¿ä»·å¼å¨äºæä¾è¿è¡æ¶ç±»åæ£æ¥ä¸éæç±»åæ£æ¥åéä¿éãå®æ¯æåºç¡ç±»åï¼intãstrãboolãfloatãEnum ç­ï¼ãåµå¥ç»æãå®¹å¨ç±»åï¼ListãDictï¼ä»¥åå¯éå­æ®µï¼ä½ä¹å­å¨é¨åéå¶ï¼ä¾å¦ä»é¨åæ¯æèåç±»åï¼ä¸ä¸æ¯æèªå®ä¹æ¹æ³ã</p>
<p>Hydraä¸­ç»æåéç½®ä¸»è¦æä¸¤ç§ä½¿ç¨æ¨¡å¼ï¼åå®æ´ä¿çå¶æ ¸å¿åè½ï¼</p>
<ol>
<li>ç´æ¥ä½ä¸ºéç½®ä½¿ç¨ï¼æ¿ä»£éç½®æä»¶ï¼ï¼éåå¿«éå¥é¨ï¼</li>
<li>ä½ä¸ºéç½®æ¨¡å¼ï¼schemaï¼ä½¿ç¨ï¼ç¨äºæ ¡éªç°æéç½®æä»¶ï¼éåå¤§åæåä½é¡¹ç®ã</li>
</ol>
<p>æ¬æç¨å°ææ­¤é¡ºåºä¾æ¬¡è¯¦è§£ä¸¤ç§æ¨¡å¼ã</p>
<h2 id="21-hydraä»£ç éç½®">2.1 Hydraä»£ç éç½®</h2>
<p>å¨åç»­çæç¨ä¸­ï¼æä»¬å°ä½¿ç¨ConfigStoreç±»ææ°æ®ç±»ï¼dataclassesï¼æ³¨åä¸ºHydraä¸­çè¾å¥éç½®ãConfigStoreæ¯ä¸ä¸ªå¨åå­ä¸­å­å¨éç½®çåä¾ï¼singletonï¼å¯¹è±¡ï¼ä¸å®äº¤äºçæ ¸å¿APIæ¯ä¸æå°è¦ä»ç»çstoreæ¹æ³ã</p>
<pre><code class="language-python">class ConfigStore(metaclass=Singleton):
    def store(
        self,
        name: str,
        node: Any,
        group: Optional[str] = None,
        package: Optional[str] = "_group_",
        provider: Optional[str] = None,
    ) -&gt; None:
        """
        å°éç½®èç¹å­å¨è³éç½®ä»åºä¸­
        :param name: éç½®åç§°
        :param node: éç½®èç¹ï¼æ¯æ DictConfigãListConfigã
            ç»æåéç½®ï¼Structured configsï¼ï¼çè³æ®éç dict å list ç±»å
        :param group: éç½®åç»ï¼å­åç»åéç¬¦ä¸º '/'ï¼
            ä¾å¦ hydra/launcher
        :param package: éç½®èç¹çç¶çº§å±çº§ç»æã
            å­èç¹åéç¬¦ä¸º '.'ï¼ä¾å¦ foo.bar.baz
        :param provider: æä¾è¯¥éç½®çæ¨¡å/åºç¨åç§°ï¼
            æå©äºè°è¯ææ¥é®é¢ã
        """
    ...
</code></pre>
<p>ConfigStoreå·å¤ä¸YAMLè¾å¥éç½®å®å¨ä¸è´çåè½ï¼é¤æ­¤ä¹å¤è¿æä¾ç±»åæ ¡éªè½åãå®æ¢å¯åç¬ä½¿ç¨ï¼ä¹å¯ä¸YAMLéåä½¿ç¨ã</p>
<p><strong>åºç¡ç¨ä¾</strong></p>
<p>åè®¾æä»¬æä¸ä¸ªç®åçåºç¨ç¨åºï¼ä¸å­å¨ä¸ä¸ªåå«cnnéé¡¹çmodeléç½®åç»ï¼</p>
<pre><code class="language-python">from omegaconf import DictConfig, OmegaConf
import hydra

@hydra.main(version_base=None, config_path="conf", config_name="model/cnn")
def my_app(cfg: DictConfig) -&gt; None:
    print(OmegaConf.to_yaml(cfg))

if __name__ == "__main__":
    my_app()
</code></pre>
<p>ç®å½ç»æï¼</p>
<pre><code>ââ conf
â  ââ model
â      ââ cnn.yaml
âââ my_app.py
</code></pre>
<p>model/cnn.yamlï¼</p>
<pre><code class="language-yaml">backbone: resnet50
learning_rate: 0.001
batch_size: 32
epochs: 20
dropout: 0.2
</code></pre>
<p>å¦æç°å¨æ³è¦æ°å¢ä¸ä¸ªtransformeréé¡¹è¯¥æä¹åï¼æä»¬å¯ä»¥ç´æ¥æ°å¢<code>model/transformer.yaml</code>éç½®åç»æä»¶ï¼ä½è¿å¹¶éå¯ä¸æ¹å¼ï¼ä¹å¯ä»¥éè¿ConfigStoreä¸ºHydraæ°å¢modeléç½®åç»çtransformeréé¡¹ã</p>
<p>è¦å®ç°è¿ä¸ªéæ±ï¼åªéå¨ä¸è¿°ä»£ç æä»¶ä¸­æ·»å å è¡ä»£ç ï¼</p>
<pre><code class="language-python">from dataclasses import dataclass
import hydra
from omegaconf import DictConfig, OmegaConf
from hydra.core.config_store import ConfigStore
@dataclass
class TransformerConfig:
    optimizer: str = "sgd"
    lr: float = 0.0005
    hidden_dim: int = 256

cs = ConfigStore.instance()
# å°åä¸ºtransformerçéç½®ç±»æ³¨åè³modeléç½®åç»
# æ³¨æåºç°å®ä½æä»¶ä¼æ¥é
cs.store(name="transformer", group="model", node=TransformerConfig)

@hydra.main(version_base=None, config_path="conf")
def my_app(cfg: DictConfig) -&gt; None:
    print(OmegaConf.to_yaml(cfg))

if __name__ == "__main__":
    my_app()
</code></pre>
<p>ä¸è¿°ä»£ç ä¸ä¼çæå®éçç©çéç½®æä»¶ï¼å®ä»ç¨äºå¨åå­ä¸­æ³¨åéç½®ç±»ãç°å¨åºç¨ç¨åºå·²ç»è½å¤è¯å«modeléç½®ç»ä¸­çä¸¤ä¸ªéé¡¹ï¼æ¨å¯ä»¥éè¿ä»¥ä¸å½ä»¤è¿è¡ç¨åºæ¥éªè¯ææï¼</p>
<pre><code class="language-bash">python my_app.py +model=cnn
</code></pre>
<p>æ</p>
<pre><code class="language-bash">python my_app.py +model=transformer
</code></pre>
<p>å¨æ·±åº¦å­¦ä¹ å®éªä¸­ç®¡çå¤ä¸ªæ¨¡åéç½®æ¶ï¼æä»¬è¿å¯ä»¥åå©ConfigStoreæ¯æçä¸ç§æ³¨åæ¹å¼çµæ´»æ§å¶éç½®èç¹ï¼å®ç°ä¸åæ¹æ¡é´çå¿«éåæ¢ï¼</p>
<pre><code class="language-python">from dataclasses import dataclass
import hydra
from omegaconf import DictConfig, OmegaConf
from hydra.core.config_store import ConfigStore

@dataclass
class TransformerConfig:
    optimizer: str = "sgd"
    lr: float = 0.0005
    hidden_dim: int = 256

cs = ConfigStore.instance()

# ç´æ¥ä½¿ç¨ç±»ç±»å
cs.store(name="config1", node=TransformerConfig)
# ä½¿ç¨ç±»å®ä¾ï¼è¦çé¨åé»è®¤å¼ï¼
cs.store(name="config2", node=TransformerConfig(optimizer="rmsprop", lr=0.002))
# ä½¿ç¨å­å¸ï¼ä¼å¤±å»è¿è¡æ¶ç±»åå®å¨ä¿éï¼
cs.store(name="config3", node={"optimizer": "adam", "lr": 0.003, "hidden_dim": 256})

# 3. Hydraä¸»å½æ°ï¼å è½½å¹¶æå°éç½®
@hydra.main(version_base=None, config_name="config1")  # é»è®¤å è½½config1
def main(cfg: DictConfig) -&gt; None:
    print("å½åå è½½çéç½®åå®¹ï¼")
    print(cfg)  

if __name__ == "__main__":
    main()
</code></pre>
<p><strong>éç½®ç»</strong></p>
<p>å¨Hydraæ¡æ¶ä¸­ï¼éç½®ç»æ¯ä¸ç§ç¨äºç»ç»äºæ¥ä½ç¸å³éç½®é¡¹çæºå¶ãä»¥æ·±åº¦å­¦ä¹ åºæ¯ä¸ºä¾ï¼è®­ç»CNNä¸Transformerå±äºä¸åçæ¨¡åéç½®ï¼å®ä»¬é½å±äºæ¨¡åéç½®è¿ä¸å¤§ç±»ï¼ä½ä¸æ¬¡è®­ç»åªè½éæ©å¶ä¸­ä¸ç§ï¼è¿å°±æ¯éç½®ç»çå¸ååºç¨ã</p>
<pre><code class="language-python"># å¯¼å¥å¿è¦çåº
from dataclasses import dataclass 
from typing import Any           
import hydra                   
from hydra.core.config_store import ConfigStore 
from omegaconf import OmegaConf  

# 1. å®ä¹CNNæ¨¡åçéç½®
@dataclass  # è£é¥°å¨ï¼å°æ®éç±»è½¬ä¸ºç»æåéç½®ç±»ï¼èªå¨çæåå§åãæ¯è¾ç­æ¹æ³ï¼
class CNNConfig:
    """CNNæ¨¡åçè®­ç»éç½®ï¼åå«è¯¥æ¨¡åç¹æçææåæ°ï¼"""
    model_type: str = "cnn"      
    batch_size: int = 32          
    learning_rate: float = 0.001  

# 2. å®ä¹Transformeræ¨¡åçéç½®
@dataclass
class TransformerConfig:
    """Transformeræ¨¡åçè®­ç»éç½®ï¼åå«è¯¥æ¨¡åç¹æçææåæ°ï¼"""
    model_type: str = "transformer" 
    batch_size: int = 16            
    learning_rate: float = 0.0001  
    num_heads: int = 8         
 
@dataclass
class Config:
    """æ´ä¸ªè®­ç»ç¨åºçä¸»éç½®ç±»"""
    # modelå­æ®µï¼ç¨äºæ¥æ¶éç½®ç»ä¸­éæ©çæ¨¡åéç½®ï¼ææ¶æ æ³¨ä¸ºAnyç±»åï¼
    model: Any

# 1. è·åéç½®å­å¨åºçåä¾å®ä¾ï¼æ´ä¸ªç¨åºåªæä¸ä¸ªConfigStoreï¼
cs = ConfigStore.instance()

# 2. æ³¨åä¸»éç½®ï¼åç§°ä¸º"config"ï¼å¯¹åºåç»­hydra.mainçconfig_nameï¼
cs.store(name="config", node=Config)

# 3. æ³¨åéç½®ç»ï¼ç»åæ¯"model"ï¼åå«ä¸¤ä¸ªéé¡¹ï¼
cs.store(group="model", name="cnn", node=CNNConfig)
cs.store(group="model", name="transformer", node=TransformerConfig)

# hydra.mainè£é¥°å¨ï¼æ è®°ç¨åºå¥å£ï¼æå®éç½®åç§°ä¸º"config"
@hydra.main(version_base=None, config_name="config")
def train_model(cfg: Config) -&gt; None:
    """æ·±åº¦å­¦ä¹ æ¨¡åè®­ç»çä¸»å½æ°"""
    print("===== å½åä½¿ç¨çè®­ç»éç½® =====")
    print(OmegaConf.to_yaml(cfg))

# ç¨åºå¯å¨å¥å£
if __name__ == "__main__":
    train_model()
</code></pre>
<p>ä»£ç è¿è¡ç´æ¥è¾åºä¸ºï¼</p>
<pre><code>model: ???
</code></pre>
<p>??? è¡¨ç¤ºï¼è¯¥å­æ®µæ¬åºæå¼ï¼ä½ç®åå¤äºç¼ºå¤±ç¶æãç±äºæä»¬æªç»æ¨¡åéç½®ç»è®¾ç½®é»è®¤å¼ï¼å æ­¤å¿é¡»éè¿å½ä»¤è¡æ¾å¼æå®è¦ä½¿ç¨çæ¨¡åéç½®ãæ³¨æå½ä»¤ä¸­ç+æ¯å¿éçï¼å ä¸ºæ¨¡åéç½®ç»æ²¡æé»è®¤å¼ï¼+å¨è¿éè¡¨ç¤ºæ·»å å¹¶è¦çè¯¥éç½®å­æ®µï¼</p>
<pre><code class="language-python">python my_app.py +model=cnn
</code></pre>
<p>å¨ä¸é¢å®ç°ä¸­ï¼modelå­æ®µè¢«æ æ³¨ä¸ºAnyç±»åï¼è¿è½ç¶ä¸ä¼é»ç¢ç¨åºè¿è¡ï¼ä½å´æéç½®å¯¹è±¡å½ä½ä¸ä¸ªç¼ºä¹ç±»åä¿¡æ¯çé»ç®±å­å¸ï¼ä½¿å¾IDEæ æ³æä¾æºè½æç¤ºï¼éæç±»åæ£æ¥ä¹å®å¨å¤±æï¼ä»èéä½äºä»£ç çå¯ç»´æ¤æ§åé¿æå¯é æ§ãè¦è§£å³è¿ä¸é®é¢ï¼è§£å³æ¹æ³æ¯å°ä¸åæ¨¡åéç½®ä¹é´çå¬å±å­æ®µè¿è¡æ½è±¡ï¼åå»ºä¸ä¸ªBaseModelConfigåºç¡éç½®ç±»ï¼</p>
<pre><code class="language-python">from dataclasses import dataclass
from typing import Any
import hydra
from omegaconf import MISSING  # æ è®°å­æ®µâæ é»è®¤å¼â
from hydra.core.config_store import ConfigStore 
from omegaconf import OmegaConf  

@dataclass
class BaseModelConfig:
    """æææ·±åº¦å­¦ä¹ æ¨¡åçåºç¡éç½®ï¼æ½ç¦»å¬å±å­æ®µï¼"""
    model_type: str = MISSING       # æ¨¡åç±»åï¼æ é»è®¤å¼ï¼å¿é¡»ç±å­ç±»æå®ï¼
    batch_size: int = 32            # å¬å±å­æ®µï¼é»è®¤æ¹æ¬¡å¤§å°ï¼å­ç±»å¯éåï¼
    learning_rate: float = 0.001    # å¬å±å­æ®µï¼é»è®¤å­¦ä¹ çï¼å­ç±»å¯éåï¼

# 1. å®ä¹CNNæ¨¡åçéç½®
@dataclass  # è£é¥°å¨ï¼å°æ®éç±»è½¬ä¸ºç»æåéç½®ç±»ï¼èªå¨çæåå§åãæ¯è¾ç­æ¹æ³ï¼
class CNNConfig(BaseModelConfig):
    """CNNæ¨¡åçè®­ç»éç½®ï¼åå«è¯¥æ¨¡åç¹æçææåæ°ï¼"""
    model_type: str = "cnn"      
    batch_size: int = 32          
    learning_rate: float = 0.001  

# 2. å®ä¹Transformeræ¨¡åçéç½®
@dataclass
class TransformerConfig(BaseModelConfig):
    """Transformeræ¨¡åçè®­ç»éç½®ï¼åå«è¯¥æ¨¡åç¹æçææåæ°ï¼"""
    model_type: str = "transformer" 
    batch_size: int = 16            
    learning_rate: float = 0.0001   
    num_heads: int = 8         

@dataclass
class Config:
    """æ´ä¸ªè®­ç»ç¨åºçä¸»éç½®ç±»"""
    # ä¸åæ¯Anyï¼èæ¯BaseModelConfig
    model: BaseModelConfig

# 1. è·åéç½®å­å¨åºçåä¾å®ä¾ï¼æ´ä¸ªç¨åºåªæä¸ä¸ªConfigStoreï¼
cs = ConfigStore.instance()

# 2. æ³¨åä¸»éç½®ï¼åç§°ä¸º"config"ï¼å¯¹åºåç»­hydra.mainçconfig_nameï¼
cs.store(name="config", node=Config)

# 3. æ³¨åéç½®ç»ï¼ç»åæ¯"model"ï¼åå«ä¸¤ä¸ªéé¡¹ï¼
cs.store(group="model", name="cnn", node=CNNConfig)
cs.store(group="model", name="transformer", node=TransformerConfig)

# hydra.mainè£é¥°å¨ï¼æ è®°ç¨åºå¥å£ï¼æå®éç½®åç§°ä¸º"config"
@hydra.main(version_base=None, config_name="config")
def train_model(cfg: Config) -&gt; None:
    """æ·±åº¦å­¦ä¹ æ¨¡åè®­ç»çä¸»å½æ°"""
    print("===== å½åä½¿ç¨çè®­ç»éç½® =====")
    print(OmegaConf.to_yaml(cfg))

# ç¨åºå¯å¨å¥å£
if __name__ == "__main__":
    train_model()
</code></pre>
<p>å¯ä»¥å¨ä¸»ç»æåéç½®ä¸­è®¾ç½®é»è®¤å¼ï¼æ¹æ³ä¸å¨config.yamléç½®æä»¶ä¸­å®ä¹ç¸ä¼¼ãä»¥ä¸æ¯ä¸ä¸ªæ·±åº¦å­¦ä¹ æ¨¡åéç½®çç¤ºä¾ï¼æ°å¢äºé»è®¤éç½®åè¡¨ï¼ä½¿å¶é»è®¤å è½½model=cnnãåªéå¨ä»£ç ä¸­æ·»å é»è®¤åè¡¨ï¼å¹¶ç¸åºä¿®æ¹éç½®ç±»å³å¯ï¼</p>
<pre><code class="language-python">from dataclasses import dataclass, field
from typing import Any, List       

# å®ä¹é»è®¤éç½®åè¡¨ï¼ä»éç½®ç»"model"ä¸­å è½½åä¸º"cnn"çéç½®
defaults = [
    {"model": "cnn"}
    # è®¾ä¸º MISSINGï¼åå¯å¼ºå¶ç¨æ·å¨å½ä»¤è¡ä¸­æå®è¯¥åæ°çå¼ã
    # {"model": MISSING}
]

@dataclass
class Config:
    """æ´ä¸ªè®­ç»ç¨åºçä¸»éç½®ç±»"""
    # å@dataclasséå¶ï¼æ­¤å¤ééè¿fieldå®ä¹é»è®¤éç½®åè¡¨ï¼é»è®¤å è½½cnnéç½®ï¼
    defaults: List[Any] = field(default_factory=lambda: defaults)
    # Hydraä¼æ ¹æ®é»è®¤éç½®åè¡¨èªå¨å¡«åè¯¥å­æ®µï¼ç±»åä¸ºBaseModelConfig
    model: BaseModelConfig = MISSING
</code></pre>
<p>ä½ ä¹å¯ä»¥éè¿å½ä»¤è¡è¦çé»è®¤éç½®ï¼æå®ä½¿ç¨Transformeræ¨¡åï¼æ³¨æä¸è¦+å·ï¼å ä¸ºè¿æ¯è¦çæä½ï¼</p>
<pre><code class="language-shell">python my_app.py model=transformer
</code></pre>
<h2 id="22-éç½®æ¨¡å¼">2.2 éç½®æ¨¡å¼</h2>
<p>Hydraçç»æåéç½®æ¬è´¨æ¯ç¨ä»£ç å®ä¹çç»æåè§åæ¥ç®¡çéç½®ãå®é¤äºå¯ä»¥ç¨ä»£ç å®ä¹çç»æåéç½®æ¿ä»£ä¼ ç»çYAMLéç½®æä»¶å¤ï¼è¿è½å°ç»æåéç½®ä½ä¸ºéç½®è§åæ¨¡æ¿ï¼Schemaï¼ï¼ç¨äºæ ¡éªå·²æYAMLéç½®æä»¶æ¯å¦ç¬¦åè§èãSchemaè½å¤å¨ç¨åºå¯å¨æ¶æ ¡éªéç½®çåæ³æ§ï¼æåæ¦æªææéç½®éè¯¯ãè¿å¯¹äºä¿éå¤§åé¡¹ç®çç¨³å®æ§è³å³éè¦ï¼å°¤å¶éåå¤äººåä½çåºæ¯ï¼å¯ä»¥ææé¿åéç½®éåãæ¼åå­æ®µç­é®é¢ã</p>
<p><strong>åä¸éç½®ç»åçSchemaæ ¡éª</strong></p>
<p>ä»¥æ·±åº¦å­¦ä¹ è®­ç»åºæ¯çæ¨¡åéç½®ä¸ºä¾ï¼ä¸æå°æè§£å¦ä½éè¿é¢è®¾çSchemaæ¨¡æ¿ï¼æ ¡éªåä¸éç½®åç»ä¸åéç½®æä»¶çå­æ®µãç±»åç­æ¯å¦ç¬¦åè§èè¦æ±ã</p>
<p>ç»å®å¦ä¸éç½®ç®å½ç»æï¼</p>
<pre><code class="language-shell">conf/
âââ config.yaml          # ä¸»éç½®ï¼åå«è®­ç»ãæ¨¡åãæ°æ®ç­ï¼
âââ model                # æ¨¡åéç½®ç»
    âââ resnet.yaml      # ResNetæ¨¡åéç½®
    âââ transformer.yaml # Transformeræ¨¡åéç½®
</code></pre>
<p>éä¸ºä¸è¿°æ¯ä¸ªéç½®æä»¶æ·»å ç»æåéç½®Schemaï¼æ ¸å¿æ¹å¼æ¯å¨YAMLæä»¶çdefaultsåè¡¨ä¸­å£°æè¦ç»§æ¿çSchemaæ¨¡æ¿ï¼å¹¶å°è¿äºSchemaä»¥base_configãmodel/resnet.yamlãmodel/transformer.yamlä¸ºåæ³¨åè³Hydraéç½®ä»åºãåéç½®æä»¶çdefaultsåè¡¨éç½®å¦ä¸ï¼</p>
<p>config.yamlï¼</p>
<pre><code class="language-shell">defaults:
  - base_config          # ç»§æ¿åºç¡éç½®Schema
  - model: resnet        # é»è®¤ä½¿ç¨ResNetæ¨¡åéç½®
  - _self_               # èªèº«éç½®è¦çé»è®¤å¼

# èªå®ä¹è®­ç»åæ°
train:
  batch_size: 32
  lr: 0.001
debug: true
</code></pre>
<p>model/resnet.yamlï¼</p>
<pre><code class="language-shell">defaults:
  - base_resnet  # ç»§æ¿ResNetåºç¡Schema

# ResNetä¸å±åæ°
layers: 50
pretrained: true
num_classes: 1000
</code></pre>
<p>model/transformer.yamlï¼</p>
<pre><code class="language-shell">defaults:
  - base_transformer  # ç»§æ¿Transformeråºç¡Schema

# Transformerä¸å±åæ°
num_heads: 8
num_layers: 6
hidden_dim: 512
max_seq_len: 512
</code></pre>
<p>éè¿Python dataclasså®ä¹åç§Schemaè§åï¼å¹¶æ³¨åå°Hydraéç½®ä»åºï¼ä½¿YAMLéç½®æä»¶å¯å³èå°å¯¹åºçæ ¡éªè§åï¼</p>
<pre><code class="language-python">from dataclasses import dataclass
from omegaconf import OmegaConf, MISSING
import hydra
from hydra.core.config_store import ConfigStore

# -------------------------- åºç¡Schemaå®ä¹ --------------------------
@dataclass
class BaseModelConfig:
    """æææ¨¡åçåºç¡éç½®Schema"""
    model_type: str = MISSING  # å¿éå­æ®µï¼æ é»è®¤å¼
    device: str = "cuda"       # å¯éå­æ®µï¼é»è®¤å¼cuda
    dropout: float = MISSING   # å¿éå­æ®µï¼æ é»è®¤å¼

@dataclass
class ResNetConfig(BaseModelConfig):
    """ResNetæ¨¡åä¸å±Schemaï¼ç»§æ¿åºç¡æ¨¡åéç½®ï¼"""
    model_type: str = "resnet"  # åºå®å¼ï¼æ è¯æ¨¡åç±»å
    dropout: float = 0.1        # è¦çé»è®¤å¼
    layers: int = MISSING       # ResNetä¸å±å¿éå­æ®µ
    pretrained: bool = MISSING
    num_classes: int = MISSING

@dataclass
class TransformerConfig(BaseModelConfig):
    """Transformeræ¨¡åä¸å±Schemaï¼ç»§æ¿åºç¡æ¨¡åéç½®ï¼"""
    model_type: str = "transformer"  # åºå®å¼
    dropout: float = 0.1             # è¦çé»è®¤å¼
    num_heads: int = MISSING         # Transformerä¸å±å¿éå­æ®µ
    num_layers: int = MISSING
    hidden_dim: int = MISSING
    max_seq_len: int = MISSING

@dataclass
class TrainConfig:
    """è®­ç»éç½®Schema"""
    batch_size: int = MISSING
    lr: float = MISSING
    epochs: int = 10  # é»è®¤è®­ç»10è½®

@dataclass
class Config:
    """æ´ä½éç½®Schema"""
    model: BaseModelConfig = MISSING  # æ¨¡åéç½®ï¼å¿éï¼
    train: TrainConfig = MISSING     # è®­ç»éç½®ï¼å¿éï¼
    debug: bool = False              # è°è¯æ¨¡å¼ï¼å¯éï¼

# -------------------------- æ³¨åSchemaå°éç½®ä»åº --------------------------
cs = ConfigStore.instance()
cs.store(name="base_config", node=Config)  # æ³¨åä¸»éç½®Schema
cs.store(group="model", name="base_resnet", node=ResNetConfig)  # æ³¨åResNet Schema
cs.store(group="model", name="base_transformer", node=TransformerConfig)  # æ³¨åTransformer Schema

# -------------------------- ä¸»å½æ° --------------------------
@hydra.main(version_base=None, config_path="conf", config_name="config")
def train_app(cfg: Config) -&gt; None:
    """æ·±åº¦å­¦ä¹ è®­ç»å¥å£ï¼æå°æç»éç½®"""
    print("æç»è®­ç»éç½®ï¼")
    print(OmegaConf.to_yaml(cfg))

if __name__ == "__main__":
    train_app()
</code></pre>
<p>è¿è¡ä»£ç æ¶ï¼Hydraä¼åå è½½YAMLéç½®æä»¶ï¼åéè¿å³èçSchemaå®æåæ³æ§æ ¡éªï¼è¥éç½®å­å¨éè¯¯ä¼ç«å³æåºå¼å¸¸ï¼</p>
<pre><code class="language-shell"># æ­£å¸¸è¿è¡ï¼ä½¿ç¨é»è®¤ResNetéç½®ï¼
python my_app.py

# æ¨¡æéç½®éè¯¯ï¼layerså­æ®µåºä¸ºintç±»åï¼ä¼ å¥å­ç¬¦ä¸²è§¦åæ ¡éªå¤±è´¥ï¼
python my_app.py model.layers='attention' 
</code></pre>
<p><strong>è·¨éç½®ç»çSchemaæ ¡éª</strong></p>
<p>å¨åæçæ¨¡åè®­ç»åºæ¯ä¸­ï¼Schemaé½å®ä¹å¨ä¸»ç¨åºéãä½å®éå¼åä¸­ï¼å¸¸ä¼éå°ç¬¬ä¸æ¹åºæä¾æ ååçSchemaï¼æä»¬éè¦è·¨éç½®ç»å¼ç¨è¿äºSchemaæ¥æ ¡éªèªå·±çéç½®æä»¶ï¼èéæææSchemaé½åå¨ä¸»ç¨åºä¸­ã</p>
<p>åè®¾å­å¨ä¸ä¸ªå¬å±çoptimizer_libåºï¼è¯¥åºé¢åå®ä¹äºæææ¨¡åçæ åSchemaå¹¶æ³¨åå¨ç¬ç«éç½®ç»ä¸­ï¼æ¬å°conf/optimizeréç½®ç»ä¸çYAMLæä»¶ï¼å¦sgd.yamlãadam.yamlï¼ä»éç¼åYAMLéç½®æä»¶ï¼å¹¶å³èè¿ä¸ªå¤é¨åºçSchemaå®ææ ¡éªï¼æ ééå¤å®ä¹æ¨¡åè§åï¼éç½®ç®å½ç»æå¦ä¸ï¼</p>
<pre><code class="language-shell"># é¡¹ç®æ´ä½ç®å½
âââ my_app.py               # ä¸»ç¨åº
âââ optimizer_lib.py        # ç¬ç«çä¼åå¨Schemaåº
âââ conf/
    âââ config.yaml         # ä¸»éç½®
    âââ optimizer/          # æ¬å°ä¼åå¨éç½®ç»
        âââ sgd.yaml        
        âââ adam.yaml       
</code></pre>
<p>optimizer_lib.pyä»£ç å¦ä¸ï¼</p>
<pre><code class="language-python">from dataclasses import dataclass
from omegaconf import MISSING
from hydra.core.config_store import ConfigStore

# -------------------------- ä¼åå¨åºç¡Schema --------------------------
@dataclass
class BaseOptimizerConfig:
    """ææä¼åå¨çåºç¡Schemaï¼ç¬ç«åºå®ä¹ï¼"""
    opt_type: str = MISSING    # å¿éå­æ®µï¼ä¼åå¨ç±»å
    lr: float = MISSING        # å¿éå­æ®µï¼å­¦ä¹ ç
    weight_decay: float = 0.0  # å¯éå­æ®µï¼æéè¡°åï¼é»è®¤0

# -------------------------- å·ä½ä¼åå¨Schema --------------------------
@dataclass
class SGDConfig(BaseOptimizerConfig):
    """SGDä¼åå¨ä¸å±Schema"""
    opt_type: str = "sgd"      # åºå®æ è¯
    momentum: float = MISSING  # SGDä¸å±å¿éå­æ®µ
    nesterov: bool = False     # å¯éå­æ®µï¼æ¯å¦ä½¿ç¨Nesterovå¨é

@dataclass
class AdamConfig(BaseOptimizerConfig):
    """Adamä¼åå¨ä¸å±Schema"""
    opt_type: str = "adam"     # åºå®æ è¯
    betas: tuple[float, float] = (0.9, 0.999)  # å¯éå­æ®µï¼betaåæ°
    eps: float = MISSING                       # Adamä¸å±å¿éå­æ®µ

# -------------------------- æ³¨åè·¨éç½®ç»çSchema --------------------------
def register_optimizer_configs() -&gt; None:
    cs = ConfigStore.instance()
    # æ³¨åå°ç¬ç«åç»ï¼optimizer_lib/optimizer
    cs.store(
        group="optimizer_lib/optimizer",
        name="sgd",
        node=SGDConfig
    )
    cs.store(
        group="optimizer_lib/optimizer",
        name="adam",
        node=AdamConfig
    )
</code></pre>
<p>ä¸»ç¨åºmy_app.pyä¸­å®ä¹æ´ä½éç½®Schemaï¼å¹¶è°ç¨optimizer_libçæ³¨åå½æ°ï¼å°è·¨éç½®ç»çSchemaçº³å¥Hydraéç½®ä»åºï¼</p>
<pre><code class="language-python">from dataclasses import dataclass
from omegaconf import MISSING, OmegaConf
import hydra
from hydra.core.config_store import ConfigStore
import optimizer_lib  # å¯¼å¥ç¬ç«çä¼åå¨åº

# -------------------------- æ´ä½éç½®Schema --------------------------
@dataclass
class TrainConfig:
    """è®­ç»éç½®Schema"""
    batch_size: int = 32
    epochs: int = 10

@dataclass
class Config:
    """ä¸»éç½®Schema"""
    optimizer: optimizer_lib.BaseOptimizerConfig = MISSING  # å¼ç¨ç¬ç«åºçSchema
    train: TrainConfig = MISSING
    debug: bool = False

# -------------------------- æ³¨åæ¬å°Schemaå¹¶å è½½è·¨ç»Schema --------------------------
cs = ConfigStore.instance()
cs.store(name="base_config", node=Config)  # æ³¨åä¸»éç½®Schema
optimizer_lib.register_optimizer_configs()  # æ³¨åè·¨éç½®ç»çä¼åå¨Schema

# -------------------------- ä¸»å½æ° --------------------------
@hydra.main(version_base=None, config_path="conf", config_name="config")
def train_app(cfg: Config) -&gt; None:
    """è®­ç»å¥å£ï¼æå°æç»éç½®å¹¶è§¦åSchemaæ ¡éª"""
    print("æç»è®­ç»éç½®ï¼å«è·¨ç»ä¼åå¨éç½®ï¼ï¼")
    print(OmegaConf.to_yaml(cfg))

if __name__ == "__main__":
    train_app()
</code></pre>
<p>æ¬å°conf/optimizerä¸çYAMLæä»¶éè¦éè¿ç»å¯¹è·¯å¾å¼ç¨optimizer_libä¸­çSchemaï¼å¹¶éè¿<code>@_here_</code>æå®åè·¯å¾ï¼ç¡®ä¿Schemaçæ ¡éªä½ç¨åä¸å½åéç½®ä¸è´ã</p>
<p>conf/optimizer/sgd.yamlï¼</p>
<pre><code class="language-shell">defaults:
  - /optimizer_lib/optimizer/sgd@_here_  # ç»å¯¹è·¯å¾å¼ç¨è·¨ç»Schemaï¼@_here_ç»ä¸åä½ç¨å

# SGDä¸å±éç½®ï¼éç¬¦åSGDConfigçSchemaè§åï¼
lr: 0.01
momentum: 0.9
weight_decay: 0.0001
</code></pre>
<p>conf/optimizer/adam.yamlï¼</p>
<pre><code class="language-shell">defaults:
  - /optimizer_lib/optimizer/adam@_here_  # ç»å¯¹è·¯å¾å¼ç¨è·¨ç»Schema
  - _self_  # èªèº«éç½®è¦çSchemaé»è®¤å¼ï¼ç»åé¡ºåºï¼Schemaåå è½½ï¼èªèº«éç½®åè¦çï¼

# Adamä¸å±éç½®ï¼éç¬¦åAdamConfigçSchemaè§åï¼
lr: 0.001
betas: (0.9, 0.999)
eps: 1e-08
weight_decay: 0.0005
</code></pre>
<p>ä¸»éç½®conf/config.yamlï¼</p>
<pre><code class="language-shell">defaults:
  - base_config          # ä¸»éç½®Schema
  - optimizer: sgd      # é»è®¤ä½¿ç¨SGDä¼åå¨éç½®
  - _self_

# èªå®ä¹è®­ç»åæ°
train:
  batch_size: 64
  epochs: 20
debug: true
</code></pre>
<p>è¿è¡ä»£ç æ¶ï¼Hydraä¼åå è½½ç¬¬ä¸æ¹åºçSchemaï¼åæ ¡éªæ¬å°YAMLéç½®ï¼</p>
<pre><code class="language-python"># æ­£å¸¸è¿è¡ï¼SGDéç½®ç¬¦åSchemaè§åï¼
python my_app.py

# éç½®éè¯¯ï¼momentumåºä¸ºfloatï¼ä¼ å¥å­ç¬¦ä¸²è§¦åæ ¡éªå¤±è´¥ï¼
python my_app.py optimizer.momentum='high'

# éç½®éè¯¯ï¼Adamå¿éå­æ®µepsç¼ºå¤±ï¼å¯å¨æ¶ç´æ¥æ¥éï¼
python my_app.py optimizer=adam optimizer.eps=none
</code></pre>
<h1 id="3-åè">3 åè</h1>
<ul>
<li><a href="https://github.com/facebookresearch/hydra" target="_blank" rel="noopener nofollow">hydra</a></li>
<li><a href="https://hydra.cc/docs/intro/" target="_blank" rel="noopener nofollow">Hydra-doc</a></li>
</ul>

</div>
<div id="MySignature" role="contentinfo">
    <p>æ¬ææ¥èªåå®¢å­ï¼ä½èï¼<a href="https://www.cnblogs.com/luohenyueji/" target="_blank">è½ççå¯å</a>ï¼è½¬è½½è¯·æ³¨æåæé¾æ¥ï¼<a href="https://www.cnblogs.com/luohenyueji/p/19444783" target="_blank">https://www.cnblogs.com/luohenyueji/p/19444783</a></p>

<div style="text-align:center">
    <img src="https://gitlab.com/luohenyueji/article_picture_warehouse/-/raw/main/wechat/content/%E5%8A%A0%E6%B2%B9%E9%B8%AD.gif">
</div>
</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.0006944444444444445" data-date-updated="2026-01-05 21:30">2026-01-05 21:29</span>&nbsp;
<a href="https://www.cnblogs.com/luohenyueji">è½ççå¯å</a>&nbsp;
éè¯»(<span id="post_view_count">0</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19444783);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19444783', targetLink: 'https://www.cnblogs.com/luohenyueji/p/19444783', title: '[python] éç½®ç®¡çæ¡æ¶Hydraä½¿ç¨æå' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ ä¸æå¥é¨ Spring Security with åç¹ç»å½(jasig) ]]></title>
    <link>https://www.cnblogs.com/dddy/p/19444770</link>
    <guid>16d450d622daf155d448c4204db52336</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/dddy/p/19444770" title="åå¸äº 2026-01-05 21:24">
    <span role="heading" aria-level="2">ä¸æå¥é¨ Spring Security with åç¹ç»å½(jasig)</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<p>2018-6-18</p>
<p>[[åç«¯æ /Java SE/Java]]</p>
<h1 id="spring-security-æ¯ä»ä¹">Spring Security æ¯ä»ä¹?</h1>
<p>äººä»¬ä½¿ç¨Spring Secruityçåå æå¾å¤, åå¤§é¨åé½åç°äºjavaEEçServletè§èæEJBè§èä¸­çå®å¨åè½ç¼ºä¹å¸åä¼ä¸åºç¨åºæ¯æéçæ·±åº¦;<br>
æå°è¿äºè§è, éè¦çæ¯è¦è®¤è¯å°ä»ä»¬å¨WARæEARçº§å«æ æ³ç§»æ¤; å æ­¤å¦æä½ æ´æ¢æå¡å¨ç¯å¢, è¿éæå¸åçå¤§éå·¥ä½å»éæ°éç½®ä½ çåºç¨ç¨åºåå®å¨å°æ°çç®æ ç¯å¢; ä½¿ç¨Spring Security è§£å³äºè¿äºé®é¢, ä¹ä¸ºä½ æä¾è®¸å¤å¶ä»æç¨ç, å¯å®å¶çå®å¨åè½;</p>
<p>æ­£å¦ä½ å¯è½ç¥éçä¸¤ä¸ªåºç¨ç¨åºçä¸¤ä¸ªä¸»è¦åºåæ¯"è®¤è¯"å"ææ"ï¼æèè®¿é®æ§å¶ï¼; è¿ä¸¤ä¸ªä¸»è¦åºåæ¯Spring Security çä¸¤ä¸ªç®æ ; "è®¤è¯", æ¯å»ºç«ä¸ä¸ªä»å£°æçä¸»é¢çè¿ç¨ï¼ä¸ä¸ª"ä¸»ä½"ä¸è¬æ¯æç¨æ·, è®¾å¤æä¸äºå¯ä»¥å¨ä½ çåºç¨ç¨åºä¸­æ§è¡å¨ä½çå¶ä»ç³»ç»ï¼; "ææ"æç¡®å®ä¸ä¸ªä¸»ä½æ¯å¦åè®¸å¨ä½ çåºç¨ç¨åºæ§è¡ä¸ä¸ªå¨ä½çè¿ç¨; ä¸ºäºæµè¾¾éè¦ææçåº, ä¸»ä½çèº«ä»½å·²ç»æè®¤è¯è¿ç¨å»ºç«; è¿ä¸ªæ¦å¿µæ¯éç¨çèä¸åªå¨Spring Securityä¸­;</p>
<blockquote>
<p>åè: <a href="https://springcloud.cc/spring-security-zhcn.html#what-is-acegi-security" target="_blank" rel="noopener nofollow">ä¸­æææ¡£</a><br>
<a href="https://docs.spring.io/spring-security/site/docs/4.2.7.RELEASE/reference/htmlsingle/#what-is-acegi-security" target="_blank" rel="noopener nofollow">è±æææ¡£ 4.2</a></p>
</blockquote>
<h1 id="spring-3x-mvc--security">Spring 3.X MVC + Security</h1>
<p>copy of xxx çä¸äºjaråççæ¬<br>
spring core = 3.0.5<br>
spring security core = 3.0.5<br>
spring web = 3.0.5</p>
<h2 id="for-maven">For maven</h2>
<p>Mavené¡¹ç® å¦ætomcatä¸å è½½maven lib, å³é®é¡¹ç® <code>Web Deployment Assembly</code>å è¿å»</p>
<p>å®æ´éç½®.</p>
<pre><code class="language-xml"> &lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;

&lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
&lt;groupId&gt;myproject&lt;/groupId&gt;
&lt;artifactId&gt;springsecurity&lt;/artifactId&gt;
&lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;
&lt;packaging&gt;war&lt;/packaging&gt;
&lt;name&gt;springsecurity&lt;/name&gt;

&lt;dependencies&gt;
    &lt;!-- https://mvnrepository.com/artifact/org.springframework/spring-web --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework&lt;/groupId&gt;
        &lt;artifactId&gt;spring-web&lt;/artifactId&gt;
        &lt;version&gt;3.0.5.RELEASE&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;!-- https://mvnrepository.com/artifact/org.springframework/spring-webmvc --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework&lt;/groupId&gt;
        &lt;artifactId&gt;spring-webmvc&lt;/artifactId&gt;
        &lt;version&gt;3.0.5.RELEASE&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;!-- spring security --&gt;
   &lt;dependency&gt;
         &lt;groupId&gt;org.springframework.security&lt;/groupId&gt;
         &lt;artifactId&gt;spring-security-core&lt;/artifactId&gt;
         &lt;version&gt;3.0.5.RELEASE&lt;/version&gt;
     &lt;/dependency&gt;
     &lt;dependency&gt;
         &lt;groupId&gt;org.springframework.security&lt;/groupId&gt;
         &lt;artifactId&gt;spring-security-web&lt;/artifactId&gt;
         &lt;version&gt;3.0.5.RELEASE&lt;/version&gt;
     &lt;/dependency&gt;
     &lt;dependency&gt;
         &lt;groupId&gt;org.springframework.security&lt;/groupId&gt;
         &lt;artifactId&gt;spring-security-config&lt;/artifactId&gt;
         &lt;version&gt;3.0.5.RELEASE&lt;/version&gt;
     &lt;/dependency&gt;
     &lt;dependency&gt;
         &lt;groupId&gt;org.springframework.security&lt;/groupId&gt;
         &lt;artifactId&gt;spring-security-taglibs&lt;/artifactId&gt;
         &lt;version&gt;3.0.5.RELEASE&lt;/version&gt;
     &lt;/dependency&gt;
&lt;/dependencies&gt;

&lt;build&gt;
    &lt;plugins&gt;
        &lt;plugin&gt;
            &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;
            &lt;version&gt;3.1&lt;/version&gt;
            &lt;configuration&gt;
                &lt;source&gt;1.7&lt;/source&gt;
                &lt;target&gt;1.7&lt;/target&gt;
            &lt;/configuration&gt;
        &lt;/plugin&gt;
        &lt;plugin&gt;
            &lt;artifactId&gt;maven-war-plugin&lt;/artifactId&gt;
            &lt;version&gt;2.4&lt;/version&gt;
            &lt;configuration&gt;
                &lt;warSourceDirectory&gt;webapp&lt;/warSourceDirectory&gt;
            &lt;/configuration&gt;
        &lt;/plugin&gt;
    &lt;/plugins&gt;
&lt;/build&gt;

&lt;/project&gt;
</code></pre>
<ul>
<li>åä¸ä¸ªæ§å¶å¨</li>
</ul>
<pre><code class="language-java">@Controller
@RequestMapping("/user")
public class UserController {
    
    
    @RequestMapping(value = "/login")
    public ModelAndView login() {
        System.out.println("login");
        ModelAndView model = new ModelAndView();
        model.addObject("title", "login");
        model.addObject("message", "This is hello page!");
        model.setViewName("login");
        
        return model;

    }
    
    
    @RequestMapping(value = { "/", "/welcome" }, method = RequestMethod.GET)
    public ModelAndView welcomePage() {
        System.out.println("welcomePage");
        ModelAndView model = new ModelAndView();
        model.addObject("title", "Spring  Hello World");
        model.addObject("message", "This is welcome page!");
        model.setViewName("hello");
        
        return model;
    }
    @RequestMapping(value = "/admin", method = RequestMethod.GET)
    public ModelAndView adminPage() {
        System.out.println("adminPage");
        ModelAndView model = new ModelAndView();
        model.addObject("title", "Spring  Hello World");
        model.addObject("message", "This is protected page!");
        model.setViewName("admin");
        
        return model;

    }
}

</code></pre>
<blockquote>
<p>ä¸¤ä¸ªå¬å¼é¡µé¢hello ä¸éè¦éå¶, èadmin éè¦éå¶è®¿é®</p>
</blockquote>
<ul>
<li>å¨web.xmlå¢å spring Securityè¿æ»¤å¨</li>
</ul>
<pre><code class="language-xml">&lt;filter&gt;
    &lt;filter-name&gt;springSecurityFilterChain&lt;/filter-name&gt;
    &lt;filter-class&gt;org.springframework.web.filter.DelegatingFilterProxy&lt;/filter-class&gt;
&lt;/filter&gt;
&lt;filter-mapping&gt;
    &lt;filter-name&gt;springSecurityFilterChain&lt;/filter-name&gt;
    &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
&lt;/filter-mapping&gt;
</code></pre>
<ul>
<li>spring Securityéç½®<br>
å¨spring-mvc.xmlå¼å¥å½åç©ºé´(xmlns:security), ä¸è¬èè¨é½æ¯åç¬ä¸ä¸ª<code>applicationContext-security.xml</code>æä»¶, å¨åå§spring iocçæ¶åå¼å¥</li>
</ul>
<pre><code class="language-xml">&lt;listener&gt;
    &lt;listener-class&gt;org.springframework.web.context.ContextLoaderListener&lt;/listener-class&gt;
&lt;/listener&gt;
&lt;context-param&gt;
    &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;
    &lt;param-value&gt;classpath:applicationContext.xml,classpath:applicationContext-security.xml&lt;/param-value&gt;
&lt;/context-param&gt;
</code></pre>
<ul>
<li>spring Securityçç®åéç½®</li>
</ul>
<pre><code class="language-xml">çç¥..å¤´é¨.
&lt;security:http auto-config="true"&gt;
    &lt;security:form-login login-page="/login.jsp" default-target-url="/springsecurity/user/admin.htm" /&gt;
    &lt;!-- è¡¨ç¤ºå¿åç¨æ·å¯ä»¥è®¿é® --&gt;
    &lt;security:intercept-url pattern="/login.jsp" access="IS_AUTHENTICATED_ANONYMOUSLY"/&gt;
    &lt;security:intercept-url pattern="/user/welcome*" access="IS_AUTHENTICATED_ANONYMOUSLY"/&gt;
    &lt;!-- è®¿é®ä¸é¢URLéè¦ ROLE_USER æé --&gt;
    &lt;security:intercept-url pattern="/**" access="ROLE_USER" /&gt;
&lt;/security:http&gt;
&lt;security:authentication-manager&gt;
    &lt;security:authentication-provider&gt;
        &lt;security:user-service&gt;
            &lt;security:user name="user" password="user" authorities="ROLE_USER"/&gt;
            &lt;security:user name="admin" password="admin" authorities="ROLE_USER, ROLE_ADMIN"/&gt;
        &lt;/security:user-service&gt;
    &lt;/security:authentication-provider&gt;
&lt;/security:authentication-manager&gt;

&lt;/beans&gt; 
</code></pre>
<h2 id="æµè¯">æµè¯</h2>
<ul>
<li>è®¿é®ä»»ä½ä¸ä¸ªè½è¢«springSecurityFilterChainæ¦æªçurl å³å¯çå°ç»éé¡µé¢</li>
</ul>
<p><img alt="20180710183503" loading="lazy" data-src="https://img2024.cnblogs.com/blog/3723410/202601/3723410-20260105212310452-360546459.png" class="lazyload"></p>
<blockquote>
<p>ä½¿ç¨ä¸<code>&lt;security:user-service&gt;</code>åç´ éç½®çç¨æ·åè·å¯ç å³å¯ç»é<br>
ç»éå è®¿é®<code>&lt;a href="../j_spring_security_logout" /&gt; Logout&lt;/a&gt;</code>éåº</p>
</blockquote>
<h1 id="è®¤è¯è¿ç¨">è®¤è¯è¿ç¨</h1>
<p>Spring Security, è¿æ¯ä¸ç§åºäº Spring AOP å Servlet è¿æ»¤å¨çå®å¨æ¡æ¶;</p>
<p>Spring Securityçæ ¸å¿ç±»ä¸»è¦åæ¬ä»¥ä¸å ä¸ªï¼<br>
<code>SecurityContextHolder</code>: å­æ¾èº«ä»½ä¿¡æ¯çå®¹å¨<br>
<code>Authentication</code>: èº«ä»½ä¿¡æ¯çæ½è±¡æ¥å£<br>
<code>AuthenticationManager</code> : èº«ä»½è®¤è¯å¨ï¼è®¤è¯çæ ¸å¿æ¥å£<br>
<code>UserDetailsService</code> ï¼ ä¸è¬ç¨äºä»æ°æ®åºä¸­å è½½èº«ä»½ä¿¡æ¯<br>
<code>UserDetails</code> : ç¸æ¯ Authenticationï¼ææ´è¯¦ç»çèº«ä»½ä¿¡æ¯</p>
<ol>
<li>ç¨æ·ä½¿ç¨ç¨æ·ååå¯ç è¿è¡ç»å½;</li>
<li>Spring Security å°è·åå°çç¨æ·ååå¯ç å°è£æä¸ä¸ªå®ç°äº Authentication æ¥å£ç <code>UsernamePasswordAuthenticationToken; </code></li>
<li>å°ä¸è¿°äº§çç token å¯¹è±¡ä¼ éç» <code>AuthenticationManager</code> è¿è¡ç»å½è®¤è¯;</li>
<li><code>AuthenticationManager</code> è®¤è¯æååå°ä¼è¿åä¸ä¸ªå°è£äºç¨æ·æéç­ä¿¡æ¯ç Authentication å¯¹è±¡;</li>
<li>éè¿è°ç¨ <code>SecurityContextHolder.getContext().setAuthentication(...) </code>å° <code>AuthenticationManager</code> è¿åç <code>Authentication</code> å¯¹è±¡èµäºç»å½åç SecurityContext;</li>
</ol>
<h1 id="æåä¸å¤±è´¥çé¢å¤å¤ç">æåä¸å¤±è´¥çé¢å¤å¤ç</h1>
<ul>
<li>
<p>form-login åç´ ç <font style="color: rgba(0, 255, 255, 1)">authentication-success-handler-ref</font> å¯¹åºä¸ä¸ª <code>AuthencticationSuccessHandler</code> å®ç°ç±»çå¼ç¨;</p>
<ul>
<li>å¦ææå®äº authentication-success-handler-ref, ç»å½è®¤è¯æååä¼è°ç¨æå® <code>AuthenticationSuccessHandler</code> ç <code>onAuthenticationSuccess</code> æ¹æ³; æä»¬éè¦å¨è¯¥æ¹æ³ä½åå¯¹è®¤è¯æååä¸ä¸ªå¤ç, ç¶åè¿åå¯¹åºçè®¤è¯æåé¡µé¢; ä½¿ç¨äº ä¹åçé£äº default-target-url ä¹ç±»çå°±é½ä¸èµ·ä½ç¨äº</li>
</ul>
</li>
<li>
<p>åæ ·éè¿ form-login åç´ ç<font style="color: rgba(0, 255, 255, 1)">authentication-failure-url</font> æ¥æå®ç»å½å¤±è´¥åçé¡µé¢(å¯¹åº<code>AuthenticationFailureHandler</code> æ¥å£)</p>
<ul>
<li>éè¦æ³¨æçæ¯ç»å½å¤±è´¥åçé¡µé¢è·ç»å½é¡µé¢ä¸æ ·ä¹æ¯éè¦éç½®æå¨æªç»å½çæåµä¸å¯ä»¥è®¿é®, å¦åç»å½å¤±è´¥åè¯·æ±å¤±è´¥é¡µé¢æ¶åä¼è¢« Spring Security éå®åå°ç»å½é¡µé¢;</li>
</ul>
</li>
</ul>
<pre><code class="language-xml">..æå¤´..
      &lt;!-- ...handler-ref è®¤è¯ æå å¤±è´¥çå¤çå¨ --&gt; 
      &lt;security:form-login login-page="/login.jsp" default-target-url="/springsecurity/user/admin.htm"
        authentication-success-handler-ref="authSuccessHandler"
       authentication-failure-handler-ref ="authFailureHandler" /&gt;
      &lt;!-- è¡¨ç¤ºå¿åç¨æ·å¯ä»¥è®¿é® --&gt;
      &lt;security:intercept-url pattern="/login.jsp" access="IS_AUTHENTICATED_ANONYMOUSLY"/&gt;
      &lt;security:intercept-url pattern="/user/welcome*" access="IS_AUTHENTICATED_ANONYMOUSLY"/&gt;
       &lt;!-- è®¿é®ä¸é¢URLéè¦ ROLE_USER æé --&gt;
      &lt;security:intercept-url pattern="/**" access="ROLE_USER" /&gt;
      &lt;!-- æå®éåºç»éåçéå®åurl--&gt;
      &lt;security:logout logout-success-url="/login.jsp" /&gt;
   &lt;/security:http&gt;
   
    &lt;!-- è®¤è¯æåç å¤çbean --&gt;
   &lt;bean id="authSuccessHandler" class="net.bean.AuthenticationSuccessHandlerImpl" /&gt;
   &lt;!-- è®¤è¯å¤±è´¥ç å¤çbean --&gt;
   &lt;bean id="authFailureHandler" class="net.bean.AuthenticationFailureHandlerImpl" /&gt;
..å»å°¾..
</code></pre>
<blockquote>
<p>åè: <a href="https://www.w3cschool.cn/springsecurity/4lwn1ihz.html" target="_blank" rel="noopener nofollow">https://www.w3cschool.cn/springsecurity/4lwn1ihz.html</a></p>
</blockquote>
<h1 id="éåºç»å½-logout">éåºç»å½ logout</h1>
<ul>
<li>
<p>å¨ http åç´ ä¸å®ä¹<strong>logout</strong> åç´ </p>
<ul>
<li>è¿æ · Spring Security å°èªå¨ä¸ºæä»¬æ·»å ç¨äºå¤çéåºç»å½çè¿æ»¤å¨ <code>LogoutFilter</code> å°<font style="color: rgba(0, 191, 255, 1)">FilterChain</font>;</li>
<li>å½æä»¬æå®äº http åç´ ç auto-config å±æ§ä¸º true æ¶<strong>logout</strong> å®ä¹æ¯ä¼èªå¨éç½®ç, æ­¤æ¶æä»¬é»è®¤éåºç»å½ç URL ä¸º "/j_spring_security_logout", å¯ä»¥éè¿ logout åç´ ç logout-url å±æ§æ¥æ¹åéåºç»å½çé»è®¤å°å;</li>
</ul>
</li>
</ul>
<blockquote>
<p>åè: <a href="https://www.w3cschool.cn/springsecurity/g86w1iig.html" target="_blank" rel="noopener nofollow">https://www.w3cschool.cn/springsecurity/g86w1iig.html</a></p>
</blockquote>
<br>
<br>
<hr>
<br>
<br>
<h1 id="ç»è°è®¤è¯è¿ç¨">ç»è°è®¤è¯è¿ç¨</h1>
<p>å®æ´è¿ç¨å¾</p>
<p><img alt="20180810154038" loading="lazy" data-src="https://img2024.cnblogs.com/blog/3723410/202601/3723410-20260105212335758-1081811822.png" class="lazyload"></p>
<h2 id="1springsecurityfilterchain">1.SpringSecurityFilterChain</h2>
<p>é¦åå®¢æ·ç«¯ä¸ä¸ªè¯·æ±å°è¾¾ Spring Security çå¥å£è¿æ»¤å¨æ¯: SecurityContextPersistenceFilter (é»è®¤å®ç°æ¯: <code>org.springframework.security.web.DefaultSecurityFilterChain</code>)<br>
å®å¶å®æ¯ä¸ä¸ªä»£çç»´æçå¤ä¸ª<code>FilterChain</code>, è¿äºè¿æ»¤å¨, è¿æ»¤é¾é½æ¯è¢«springå®¹å¨ç®¡çç,å¯ä»¥éå¸¸æ¹ä¾¿ç­ææ.</p>
<p>å³äºFilterChain è§:<strong>DelegatingFilterProxy ç®ä»</strong></p>
<h2 id="2usernamepasswordauthenticationfilter">2.UsernamePasswordAuthenticationFilter</h2>
<p>å¦ææªç»é,å¦ <code>UsernamePasswordAuthenticationFilter, CasAuthenticationFilter</code>..è¿æ»¤å¨è´è´£è·åå°çç¨æ·ååå¯ç å°è£æä¸ä¸ªå®ç°äº<font style="color: rgba(0, 191, 255, 1)">Authentication</font>æ¥å£ç UsernamePasswordAuthenticationToken;</p>
<blockquote>
<p>è§<code>org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter</code> æºç , 85è¡</p>
</blockquote>
<pre><code class="language-java">public Authentication attemptAuthentication(HttpServletRequest request,
        HttpServletResponse response) throws AuthenticationException {
    if (postOnly &amp;&amp; !request.getMethod().equals("POST")) {
        throw new AuthenticationServiceException(
                "Authentication method not supported: " + request.getMethod());
    }
    //è·åç¨æ·åå¯ç 
    String username = obtainUsername(request);
    String password = obtainPassword(request);

    if (username == null) {
        username = "";
    }

    if (password == null) {
        password = "";
    }

    username = username.trim();
    //å°è£ UsernamePasswordAuthenticationToken; 
    UsernamePasswordAuthenticationToken authRequest = new UsernamePasswordAuthenticationToken(
            username, password);

    // Allow subclasses to set the "details" property
    setDetails(request, authRequest);
    //ä½¿ç¨ AuthenticationManager è®¤è¯
    return this.getAuthenticationManager().authenticate(authRequest);
}
</code></pre>
<h2 id="3authentication">3.Authentication</h2>
<p>å°ä¸è¿°äº§çç <font style="color: rgba(0, 191, 255, 1)">token</font> å¯¹è±¡ä¼ éç» AuthenticationManager è¿è¡ç»å½è®¤è¯;</p>
<h2 id="4authenticationmanager">4.AuthenticationManager</h2>
<p><code>AuthenticationManager</code>å¹¶ä¸è®¤è¯,èæ¯è°ç¨AuthenticationProviderçåè¡¨è®¤è¯</p>
<blockquote>
<p>è§<code>org.springframework.security.authentication.ProviderManager::doAuthentication</code>æºç </p>
</blockquote>
<h2 id="5authenticationprovider">5.AuthenticationProvider</h2>
<p><code>AuthenticationProvider</code> æ¥å£ç<code>public abstract Authentication authenticate(Authentication paramAuthentication) throws AuthenticationException;</code>æ¹æ³æ¯çæ­£å¨å¤çè®¤è¯é»è¾çå°æ¹</p>
<blockquote>
<p>å®ææä¸ä¸ª<code>UserDetailsService</code>,ç¨äºå è½½ç¨æ·ä¿¡æ¯,<strong>ç®èè¨ä¹,æ¹åè®¤è¯,å®ç° AuthenticationProvider, æ¹åä¿¡æ¯æ¥æº, å®ç°UserDetailsServiceå³å¯</strong></p>
</blockquote>
<blockquote>
<p>è®¤è¯æå: åä¼è¡¥å<font style="color: rgba(0, 191, 255, 1)">Authentication</font>è¯¦ç»çè§è²æéç­ è¿åç»AuthenticationManager</p>
</blockquote>
<blockquote>
<p>è®¤è¯å¤±è´¥: æåº<code>AuthenticationException</code></p>
</blockquote>
<blockquote>
<p>æªç¥: è¿å<code>null</code>,è¿å°äº¤ç»ä¸ä¸ä¸ªProviderè®¤è¯</p>
</blockquote>
<blockquote>
<p>è¿æä¸ç¹ xml éç½®<code>&lt;authentication-provider&gt;</code> ä¼é»è®¤å®ä¾åä¸ä¸ª<code>DaoAuthenticationProvider</code>å å¥å°è®¤è¯æµç¨ä¸­,å®ææ<code>PasswordEncoder</code>å å¯æ¯å¨è¿ä¸æ­¥. xmléç½® å¨<code>authentication-provider</code>çèç¹ä¸ <code>password-encoder</code></p>
</blockquote>
<pre><code class="language-xml">&lt;authentication-provider user-service-ref="userDetailsService" &gt;
    &lt;password-encoder hash="md5"&gt;
        &lt;!-- &lt;salt-source user-property="username"/&gt;  æ ç--&gt;
    &lt;/password-encoder&gt;
&lt;/authentication-provider&gt;
</code></pre>
<blockquote>
<p>è§<code>org.springframework.security.authentication.ProviderManager::doAuthentication</code>æºç </p>
</blockquote>
<ol>
<li>å¨<code>AuthenticationManager</code>ä¸­, åªè¦æä¸ä¸ªProviderè®¤è¯æå, å°±ä¸ä¼åç»§ç»­åæ´å¤éªè¯, å°è¿åç<font style="color: rgba(0, 191, 255, 1)">Authentication</font>å¯¹è±¡èµäºç»å½åçSecurityContext;</li>
</ol>
<ul>
<li>å¦æå¨é¨è®¤è¯å¤±è´¥, æåº<code>AuthenticationException</code>å¼å¸¸, è¿ä¼è¢«<code>ExceptionTransactionFilter</code> Catch å°å¹¶è¿åä¸ä¸ªå¤±è´¥é¡µé¢</li>
</ul>
<blockquote>
<p>è§<code>org.springframework.security.authentication.ProviderManager::doAuthentication</code>æºç </p>
</blockquote>
<h2 id="6exceptiontranslationfilter">6.ExceptionTranslationFilter</h2>
<p>è®¤è¯å¼å¸¸å¤ç</p>
<p><code>org.springframework.security.web.access.ExceptionTranslationFilter</code></p>
<pre><code class="language-java">public void doFilter(ServletRequest req, ServletResponse res, FilterChain chain)
			throws IOException, ServletException {
    HttpServletRequest request = (HttpServletRequest) req;
    HttpServletResponse response = (HttpServletResponse) res;

    try {
        chain.doFilter(request, response);

        logger.debug("Chain processed normally");
    }
    catch (IOException ex) {
        throw ex;
    }
    catch (Exception ex) {
        //catch ææå¼å¸¸
        // Try to extract a SpringSecurityException from the stacktrace
        Throwable[] causeChain = throwableAnalyzer.determineCauseChain(ex);
        // æ¿å°å¼å¸¸ç±»å
        RuntimeException ase = (AuthenticationException) throwableAnalyzer
                .getFirstThrowableOfType(AuthenticationException.class, causeChain);

        if (ase == null) {
            ase = (AccessDeniedException) throwableAnalyzer.getFirstThrowableOfType(
                    AccessDeniedException.class, causeChain);
        }

        if (ase != null) {
            if (response.isCommitted()) {
                throw new ServletException("Unable to handle the Spring Security Exception because the response is already committed.", ex);
            }
            //å¤ç security ç±»åå¼å¸¸/ å³: org.springframework.security.access.AccessDeniedException å org.springframework.security.core.AuthenticationException;
            handleSpringSecurityException(request, response, chain, ase);
        }
        else {
            // Rethrow ServletExceptions and RuntimeExceptions as-is
            if (ex instanceof ServletException) {
                throw (ServletException) ex;
            }
            else if (ex instanceof RuntimeException) {
                throw (RuntimeException) ex;
            }

            // Wrap other Exceptions. This shouldn't actually happen
            // as we've already covered all the possibilities for doFilter
            throw new RuntimeException(ex);
        }
    }
}


private void handleSpringSecurityException(HttpServletRequest request,
        HttpServletResponse response, FilterChain chain, RuntimeException exception)
        throws IOException, ServletException {
    if (exception instanceof AuthenticationException) {
        logger.debug(
                "Authentication exception occurred; redirecting to authentication entry point",
                exception);

        sendStartAuthentication(request, response, chain,
                (AuthenticationException) exception);
    }
    else if (exception instanceof AccessDeniedException) {
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        if (authenticationTrustResolver.isAnonymous(authentication) || authenticationTrustResolver.isRememberMe(authentication)) {
            logger.debug(
                    "Access is denied (user is " + (authenticationTrustResolver.isAnonymous(authentication) ? "anonymous": "not fully authenticated") + "); redirecting to authentication entry point",
                    exception);

            sendStartAuthentication(
                    request,
                    response,
                    chain,
                    new InsufficientAuthenticationException(
                        messages.getMessage(
                            "ExceptionTranslationFilter.insufficientAuthentication",
                            "Full authentication is required to access this resource")));
        }
        else {
            logger.debug(
                    "Access is denied (user is not anonymous); delegating to AccessDeniedHandler",
                    exception);

            accessDeniedHandler.handle(request, response,
                    (AccessDeniedException) exception);
        }
    }
}


</code></pre>
<br>
<br>
<h1 id="tomcat-è¿æ»¤é¾ççæ">Tomcat è¿æ»¤é¾ççæ</h1>
<p>å¨tomcat æºç </p>
<h2 id="orgapachecatalinacorestandardwrappervalve">org.apache.catalina.core.StandardWrapperValve</h2>
<pre><code class="language-java">
 @Override
public final void invoke(Request request, Response response)
    throws IOException, ServletException {
    ....

    MessageBytes requestPathMB = request.getRequestPathMB();
    DispatcherType dispatcherType = DispatcherType.REQUEST;
    if (request.getDispatcherType()==DispatcherType.ASYNC) dispatcherType = DispatcherType.ASYNC;
    request.setAttribute(Globals.DISPATCHER_TYPE_ATTR,dispatcherType);
    request.setAttribute(Globals.DISPATCHER_REQUEST_PATH_ATTR,
            requestPathMB);
    // Create the filter chain for this request// è¿ä¸ªApplicationFilterChain å®ç°äº FilterChain
    ApplicationFilterChain filterChain =
            ApplicationFilterFactory.createFilterChain(request, wrapper, servlet);
</code></pre>
<p>å³é®å¨:</p>
<h2 id="orgapachecatalinacoreapplicationfilterfactorycreatefilterchain">org.apache.catalina.core.ApplicationFilterFactory::createFilterChain</h2>
<pre><code class="language-java">public static ApplicationFilterChain createFilterChain(ServletRequest request,
            Wrapper wrapper, Servlet servlet) {

        // If there is no servlet to execute, return null
        if (servlet == null)
            return null;

        // Create and initialize a filter chain object
        ApplicationFilterChain filterChain = null;
        if (request instanceof Request) {
            Request req = (Request) request;
            if (Globals.IS_SECURITY_ENABLED) {
                // Security: Do not recycle
                filterChain = new ApplicationFilterChain();
            } else {
                filterChain = (ApplicationFilterChain) req.getFilterChain();
                if (filterChain == null) {
                    filterChain = new ApplicationFilterChain();
                    req.setFilterChain(filterChain);
                }
            }
        } else {
            // Request dispatcher in use
            filterChain = new ApplicationFilterChain();
        }

        filterChain.setServlet(servlet);
        filterChain.setServletSupportsAsync(wrapper.isAsyncSupported());

        // Acquire the filter mappings for this Context
        StandardContext context = (StandardContext) wrapper.getParent();
        FilterMap filterMaps[] = context.findFilterMaps();

        // If there are no filter mappings, we are done
        if ((filterMaps == null) || (filterMaps.length == 0))
            return filterChain;

        // Acquire the information we will need to match filter mappings
        DispatcherType dispatcher =
                (DispatcherType) request.getAttribute(Globals.DISPATCHER_TYPE_ATTR);

        String requestPath = null;
        Object attribute = request.getAttribute(Globals.DISPATCHER_REQUEST_PATH_ATTR);
        if (attribute != null){
            requestPath = attribute.toString();
        }

        String servletName = wrapper.getName();

        // Add the relevant path-mapped filters to this filter chain //å³é®æ¯è¿ä¸ªMap , å¶ä¸­å°±æ springSecurityFilterChain
        for (FilterMap filterMap: filterMaps) {
            if (!matchDispatcher(filterMap, dispatcher)) {
                continue;
            }
            if (!matchFiltersURL(filterMap, requestPath))
                continue;
            ApplicationFilterConfig filterConfig = (ApplicationFilterConfig)
                    context.findFilterConfig(filterMap.getFilterName());
            if (filterConfig == null) {
                // FIXME - log configuration problem
                continue;
            }
            filterChain.addFilter(filterConfig);
        }

        // Add filters that match on servlet name second
        for (FilterMap filterMap: filterMaps) {
            if (!matchDispatcher(filterMap, dispatcher)) {
                continue;
            }
            if (!matchFiltersServlet(filterMap, servletName))
                continue;
            ApplicationFilterConfig filterConfig = (ApplicationFilterConfig)
                    context.findFilterConfig(filterMap.getFilterName());
            if (filterConfig == null) {
                // FIXME - log configuration problem
                continue;
            }
            filterChain.addFilter(filterConfig);
        }

        // Return the completed filter chain
        return filterChain;
    }
</code></pre>
<h1 id="delegatingfilterproxy-ç®ä»--ä¸é¢å®ä¹çè¿æ»¤å¨">DelegatingFilterProxy ç®ä» &amp; ä¸é¢å®ä¹çè¿æ»¤å¨</h1>
<p>Spring Securityæ¬è´¨ä¸æ¯ä¸è¿ä¸²çFilter,  ç¶ååä»¥ä¸ä¸ªç¬ç«çFilterçå½¢å¼æå¥å°Filter Chainé</p>
<p>å®éä¸FilterChainProxyä¸é¢å¯ä»¥æå¤æ¡Filter Chain, æ¥éå¯¹ä¸åçURLåéªè¯, èFilter Chainä¸­ææ¥æçFilteråä¼æ ¹æ®å®ä¹çæå¡èªå¨å¢å; æä»¥æ éè¦æ¾ç¤ºåå®ä¹è¿äºFilter, é¤éæ³è¦å®ç°èªå·±çé»è¾;</p>
<p>å¯ä»¥å¾è¿ä¸ªé¾å å¥, ä¾å¦: éªè¯ç è¿æ»¤å¨</p>
<p><img alt="20180810162137" loading="lazy" data-src="https://img2024.cnblogs.com/blog/3723410/202601/3723410-20260105212401368-2017750445.png" class="lazyload"></p>
<p>Spring Security å·²ç»å®ä¹äºä¸äº Filter, ä¸ç®¡å®éåºç¨ä¸­ä½ ç¨å°äºåªäº, å®ä»¬åºå½ä¿æå¦ä¸é¡ºåº;</p>
<ol>
<li>
<p>ChannelProcessingFilter, å¦æä½ è®¿é®ç channel éäº, é£é¦åå°±ä¼å¨ channel ä¹é´è¿è¡è·³è½¬, å¦ http åä¸º https;</p>
</li>
<li>
<p><code>SecurityContextPersistenceFilter</code>, å¨ä¸å¼å§è¿è¡ request çæ¶åå°±å¯ä»¥å¨ SecurityContextHolder ä¸­å»ºç«ä¸ä¸ª SecurityContext, ç¶åå¨è¯·æ±ç»æçæ¶å, ä»»ä½å¯¹ SecurityContext çæ¹åé½å¯ä»¥è¢« copy å° HttpSession;<br>
<strong>è´è´£å° SecurityContextHolder ä¸­çç»éç¨æ·ä¿¡æ¯ (é»è®¤ä¿å­å¨ThreadLocal) å è½½å°,SecurityContext<code>SecurityContextHolder.getContext()</code>!!</strong></p>
</li>
<li>
<p>ConcurrentSessionFilter, å ä¸ºå®éè¦ä½¿ç¨ SecurityContextHolder çåè½, èä¸æ´æ°å¯¹åº session çæåæ´æ°æ¶é´, ä»¥åéè¿ SessionRegistry è·åå½åç SessionInformation ä»¥æ£æ¥å½åç session æ¯å¦å·²ç»è¿æ, è¿æåä¼è°ç¨ LogoutHandler;</p>
</li>
<li>
<p>è®¤è¯å¤çæºå¶, å¦ UsernamePasswordAuthenticationFilter, CasAuthenticationFilter, BasicAuthenticationFilter ç­, ä»¥è³äº SecurityContextHolder å¯ä»¥è¢«æ´æ°ä¸ºåå«ä¸ä¸ªææç Authentication è¯·æ±;</p>
</li>
<li>
<p>SecurityContextHolderAwareRequestFilter, å®å°ä¼æ HttpServletRequest å°è£æä¸ä¸ªç»§æ¿èª HttpServletRequestWrapper ç SecurityContextHolderAwareRequestWrapper, åæ¶ä½¿ç¨ SecurityContext å®ç°äº HttpServletRequest ä¸­ä¸å®å¨ç¸å³çæ¹æ³;</p>
</li>
<li>
<p>JaasApiIntegrationFilter, å¦æ SecurityContextHolder ä¸­æ¥æç Authentication æ¯ä¸ä¸ª JaasAuthenticationToken, é£ä¹è¯¥ Filter å°ä½¿ç¨åå«å¨ JaasAuthenticationToken ä¸­ç Subject ç»§ç»­æ§è¡ FilterChain;</p>
</li>
<li>
<p>RememberMeAuthenticationFilter, å¦æä¹åçè®¤è¯å¤çæºå¶æ²¡ææ´æ° SecurityContextHolder, å¹¶ä¸ç¨æ·è¯·æ±åå«äºä¸ä¸ª Remember-Me å¯¹åºç cookie, é£ä¹ä¸ä¸ªå¯¹åºç Authentication å°ä¼è®¾ç» SecurityContextHolder;</p>
</li>
<li>
<p>AnonymousAuthenticationFilter, å¦æä¹åçè®¤è¯æºå¶é½æ²¡ææ´æ° SecurityContextHolder æ¥æç Authentication, é£ä¹ä¸ä¸ª AnonymousAuthenticationToken å°ä¼è®¾ç» SecurityContextHolder;</p>
</li>
<li>
<p>ExceptionTransactionFilter, ç¨äºå¤çå¨ FilterChain èå´åæåºç AccessDeniedException å AuthenticationException, å¹¶æå®ä»¬è½¬æ¢ä¸ºå¯¹åºç Http éè¯¯ç è¿åæèå¯¹åºçé¡µé¢;</p>
</li>
<li>
<p>FilterSecurityInterceptor, ä¿æ¤ Web URI, å¹¶ä¸å¨è®¿é®è¢«æç»æ¶æåºå¼å¸¸;</p>
</li>
</ol>
<blockquote>
<p><a href="https://www.w3cschool.cn/springsecurity/4j1s1iid.html" target="_blank" rel="noopener nofollow">åè: W3C ç¿»è¯çææ¡£</a></p>
</blockquote>
<h2 id="è¿æ»¤å¨é¾ä½ç½®-ä¸è§">è¿æ»¤å¨é¾ä½ç½® ä¸è§</h2>
<blockquote>
<p>5.0ææ¡£<br>
<a href="https://docs.spring.io/spring-security/site/docs/5.0.13.RELEASE/reference/htmlsingle/" target="_blank" rel="noopener nofollow">Table 6.1. Standard Filter Aliases and Ordering</a></p>
</blockquote>
<table>
<thead>
<tr>
<th>Alias</th>
<th>Filter Class</th>
<th>Namespace Element or Attribute</th>
</tr>
</thead>
<tbody>
<tr>
<td>CHANNEL_FILTER</td>
<td>ChannelProcessingFilter</td>
<td>http/intercept-url@requires-channel</td>
</tr>
<tr>
<td>SECURITY_CONTEXT_FILTER</td>
<td>SecurityContextPersistenceFilter</td>
<td>http</td>
</tr>
<tr>
<td>CONCURRENT_SESSION_FILTER</td>
<td>ConcurrentSessionFilter</td>
<td>session-management/concurrency-control</td>
</tr>
<tr>
<td>HEADERS_FILTER</td>
<td>HeaderWriterFilter</td>
<td>http/headers</td>
</tr>
<tr>
<td>CSRF_FILTER</td>
<td>CsrfFilter</td>
<td>http/csrf</td>
</tr>
<tr>
<td>LOGOUT_FILTER</td>
<td>LogoutFilter</td>
<td>http/logout</td>
</tr>
<tr>
<td>X509_FILTER</td>
<td>X509AuthenticationFilter</td>
<td>http/x509</td>
</tr>
<tr>
<td>PRE_AUTH_FILTER</td>
<td>AbstractPreAuthenticatedProcessingFilter Subclasses</td>
<td>N/A</td>
</tr>
<tr>
<td>CAS_FILTER</td>
<td>CasAuthenticationFilter</td>
<td>N/A</td>
</tr>
<tr>
<td>FORM_LOGIN_FILTER</td>
<td>UsernamePasswordAuthenticationFilter</td>
<td>http/form-login</td>
</tr>
<tr>
<td>BASIC_AUTH_FILTER</td>
<td>BasicAuthenticationFilter</td>
<td>http/http-basic</td>
</tr>
<tr>
<td>SERVLET_API_SUPPORT_FILTER</td>
<td>SecurityContextHolderAwareRequestFilter</td>
<td>http/@servlet-api-provision</td>
</tr>
<tr>
<td>JAAS_API_SUPPORT_FILTER</td>
<td>JaasApiIntegrationFilter</td>
<td>http/@jaas-api-provision</td>
</tr>
<tr>
<td>REMEMBER_ME_FILTER</td>
<td>RememberMeAuthenticationFilter</td>
<td>http/remember-me</td>
</tr>
<tr>
<td>ANONYMOUS_FILTER</td>
<td>AnonymousAuthenticationFilter</td>
<td>http/anonymous</td>
</tr>
<tr>
<td>SESSION_MANAGEMENT_FILTER</td>
<td>SessionManagementFilter</td>
<td>session-management</td>
</tr>
<tr>
<td>EXCEPTION_TRANSLATION_FILTER</td>
<td>ExceptionTranslationFilter</td>
<td>http</td>
</tr>
<tr>
<td>FILTER_SECURITY_INTERCEPTOR</td>
<td>FilterSecurityInterceptor</td>
<td>http</td>
</tr>
<tr>
<td>SWITCH_USER_FILTER</td>
<td>SwitchUserFilter</td>
<td>N/A</td>
</tr>
</tbody>
</table>
<h2 id="è¿æ»¤å¨é¡ºåºä½ç½®ä½ç¨">è¿æ»¤å¨é¡ºåº/ä½ç½®/ä½ç¨</h2>
<blockquote>
<p>5.0ææ¡£<br>
<a href="https://docs.spring.io/spring-security/site/docs/5.0.13.RELEASE/reference/htmlsingle/" target="_blank" rel="noopener nofollow">14.3 Filter Ordering</a></p>
</blockquote>
<p>The order that filters are defined in the chain is very important. Irrespective of which filters you are actually using, the order should be as follows:</p>
<p><code>ChannelProcessingFilter</code>, because it might need to redirect to a different protocol</p>
<p><code>SecurityContextPersistenceFilter</code>, so a SecurityContext can be set up in the SecurityContextHolder at the beginning of a web request, and any changes to the SecurityContext can be copied to the HttpSession when the web request ends (ready for use with the next web request)<br>
so æ²¡æç»è¿<code>SecurityContextPersistenceFilter</code> æ¯ç¨ä¸äº SecurityContextHolderç!!!</p>
<p><code>ConcurrentSessionFilter</code>, because it uses the SecurityContextHolder functionality and needs to update the SessionRegistry to reflect ongoing requests from the principal</p>
<p><em>Authentication</em> processing mechanisms - <code>UsernamePasswordAuthenticationFilter</code>, <code>CasAuthenticationFilter</code>, <code>BasicAuthenticationFilter</code> etc - so that the SecurityContextHolder can be modified to contain a valid Authentication request token</p>
<p>The <code>SecurityContextHolderAwareRequestFilter</code>, if you are using it to install a Spring Security aware HttpServletRequestWrapper into your servlet container</p>
<p>The <code>JaasApiIntegrationFilter</code>, if a JaasAuthenticationToken is in the SecurityContextHolder this will process the FilterChain as the Subject in the JaasAuthenticationToken</p>
<p><code>RememberMeAuthenticationFilter</code>, so that if no earlier authentication processing mechanism updated the SecurityContextHolder, and the request presents a cookie that enables remember-me services to take place, a suitable remembered Authentication object will be put there</p>
<p><code>AnonymousAuthenticationFilter</code>, so that if no earlier authentication processing mechanism updated the SecurityContextHolder, an anonymous Authentication object will be put there<br>
<code>ExceptionTranslationFilter</code>, to catch any Spring Security exceptions so that either an HTTP error response can be returned or an appropriate AuthenticationEntryPoint can be launched</p>
<p><code>FilterSecurityInterceptor</code>, to protect web URIs and raise exceptions when access is denied</p>
<h2 id="securitycontextholder-å·¥ä½æ¨¡å¼securitycontext-ä¿å­çä½ç½®">SecurityContextHolder å·¥ä½æ¨¡å¼(SecurityContext ä¿å­çä½ç½®)</h2>
<pre><code class="language-java">public class SecurityContextHolder {
	// ~ Static fields/initializers
	// =====================================================================================

	public static final String MODE_THREADLOCAL = "MODE_THREADLOCAL";
	public static final String MODE_INHERITABLETHREADLOCAL = "MODE_INHERITABLETHREADLOCAL";
	public static final String MODE_GLOBAL = "MODE_GLOBAL";
	public static final String SYSTEM_PROPERTY = "spring.security.strategy";
	private static String strategyName = System.getProperty(SYSTEM_PROPERTY);
	private static SecurityContextHolderStrategy strategy;
	private static int initializeCount = 0;
    ...



}
</code></pre>
<p>å¯éè¿ <code>spring.security.strategy</code> éç½®</p>
<p><code>MODE_THREADLOCAL</code>: ç¼ºçå·¥ä½æ¨¡å¼, ä¿å­å¨ThreadLocal<br>
<code>MODE_INHERITABLETHREADLOCAL</code>: å­å¨å¨çº¿ç¨ä¸­, ä½å­çº¿ç¨å¯ä»¥è·åå°ç¶çº¿ç¨ä¸­ç<br>
<code>MODE_GLOBAL</code>: å¨å±ç­ç¥, ææçº¿ç¨é½è·å</p>
<h1 id="å®ä¾-ä¸ä¸ªé¡¹ç®ä¾å­">å®ä¾ ä¸ä¸ªé¡¹ç®ä¾å­</h1>
<p>ä¸»è¦éç½®é¨å</p>
<pre><code class="language-xml">&lt;http auto-config="false" access-denied-page="/login.htm" entry-point-ref="authenticationEntryPoint"&gt;
		&lt;intercept-url pattern="/images/*" filters="none"/&gt;
		&lt;intercept-url pattern="/style/*" filters="none"/&gt;
		&lt;intercept-url pattern="/login.htm*" filters="none"/&gt;
		&lt;intercept-url pattern="/login.jsp*" filters="none"/&gt;
		&lt;intercept-url pattern="/logout.jsp" filters="none"/&gt;
		&lt;intercept-url pattern="/index/map.sh*" filters="none"/&gt;
		&lt;intercept-url pattern="/map/map_topic/topicList.sh*" filters="none"/&gt;
		&lt;intercept-url pattern="/map/searchNearby.sh*" filters="none"/&gt;
		&lt;intercept-url pattern="/solr/*" filters="none"/&gt;
		&lt;intercept-url pattern="/mobileRest/*" filters="none"/&gt;
		&lt;intercept-url pattern="/**" access="ROLE_USER"/&gt;
        &lt;!-- éªè¯ç è¿æ»¤å¨, spring å®å¨è¿æ»¤å¨é¾ æé»è®¤çè¿æ»¤å¨èä¸è¿æ¯æé»è®¤é¡ºåºä½ç½®ç(positionè¿ä¸ªå±æ§æå®)--&gt;
		&lt;custom-filter ref="captchaAuthenticaionFilter" position="FORM_LOGIN_FILTER" /&gt;
		&lt;!--æåæ³¨éåè·³è½¬å°çé¡µé¢; --&gt;
		&lt;logout logout-success-url="/login.htm" /&gt;
		&lt;http-basic /&gt;
	&lt;/http&gt;

</code></pre>
<h2 id="1entry-point-ref">1.<strong>entry-point-ref</strong></h2>
<pre><code>è®¤è¯å¥å£ç¹, å¨è¿æ»¤é¾, æ£éªå¤±è´¥çæ¶å, å¼å¯¼å°ç»éé¡µé¢,å¶éç½®.  
</code></pre>
<pre><code class="language-xml">        &lt;beans:bean id="authenticationEntryPoint" class="net.jk.auth.JKLoginUrlAuthenticationEntryPoint"&gt;
            &lt;beans:property name="loginFormUrl" value="/login.jsp" /&gt;
            &lt;beans:property name="ajaxLoginFormUrl" value="ajaxLogin.htm" /&gt;
        &lt;/beans:bean&gt;
</code></pre>
<h2 id="2captchaauthenticaionfilter">2.<strong>captchaAuthenticaionFilter</strong></h2>
<p>è§ä¸: <em>ç»è°è®¤è¯è¿ç¨</em>çç¬¬äºæ­¥<br>
&gt; å¦ææªç»é,å¦ UsernamePasswordAuthenticationFilter, CasAuthenticationFilter..è¿æ»¤å¨è´è´£è·åå°çç¨æ·ååå¯ç å°è£æä¸ä¸ªå®ç°äº<font style="color: rgba(0, 191, 255, 1)">Authentication</font>æ¥å£ç UsernamePasswordAuthenticationToken;</p>
<pre><code class="language-xml">        &lt;beans:bean id="captchaAuthenticaionFilter" class="org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter"&gt;
        &lt;!-- æ³¨å¥è®¤è¯ç®¡ç--&gt;
            &lt;beans:property name="authenticationManager" ref="authenticationManager" /&gt;
            &lt;!-- æåä¸å¤±è´¥çå¤ç--&gt;
            &lt;beans:property name="authenticationFailureHandler" ref="authenticationFailureHandler" /&gt;
            &lt;beans:property name="authenticationSuccessHandler" ref="authenticationSuccessHandler" /&gt;
            &lt;beans:property name="filterProcessesUrl" value="/j_spring_security_check" /&gt;
        &lt;/beans:bean&gt;
</code></pre>
<h2 id="3authenticationmanager">3.<strong>authenticationManager</strong></h2>
<p>è§ä¸: <em>ç»è°è®¤è¯è¿ç¨</em>çç¬¬äºæ­¥<br>
&gt; <code>AuthenticationManager</code>å¹¶ä¸è®¤è¯,èæ¯è°ç¨AuthenticationProviderçåè¡¨è®¤è¯</p>
<pre><code class="language-xml">    &lt;!-- è®¤è¯ç®¡ç å®åºè¯¥ææDetailsService,AuthenticationProvider,å¦ææ²¡æAuthenticationProvider éç½®é»è®¤ä¼å®ä¾DaoAuthenticationProvider --&gt;
        &lt;authentication-manager alias="authenticationManager"&gt;
            &lt;authentication-provider user-service-ref="userDetailsService" /&gt;
        &lt;/authentication-manager&gt;
</code></pre>
<blockquote>
<p><code>AuthenticationProvider</code> æ¥å£ç<code>public abstract Authentication authenticate(Authentication paramAuthentication) throws AuthenticationException;</code>æ¹æ³æ¯çæ­£å¨å¤çè®¤è¯é»è¾ç<br>
å®ææä¸ä¸ª<code>UserDetailsService</code>,ç¨äºå è½½ç¨æ·ä¿¡æ¯,<font style="color: rgba(255, 0, 0, 1)">ç®èè¨ä¹: æ¹åè®¤è¯ å®ç°AuthenticationProvider; æ¹åä¿¡æ¯æ¥æº å®ç°UserDetailsService</font><br>
è®¤è¯æå: åä¼è¡¥å<font style="color: rgba(0, 191, 255, 1)">Authentication</font>è¯¦ç»çè§è²æéç­ è¿åç»AuthenticationManager<br>
è®¤è¯å¤±è´¥: æåº<code>AuthenticationException</code><br>
æªç¥: è¿å<code>null</code>,è¿å°äº¤ç»ä¸ä¸ä¸ªProviderè®¤è¯<br>
<code>&lt;authentication-provider&gt;</code> ä¼é»è®¤å®ä¾åä¸ä¸ª<code>DaoAuthenticationProvider</code></p>
</blockquote>
<h2 id="4userdetailsservice">4.<strong>userDetailsService</strong></h2>
<p>å¨æ³¨è§£ä¸­</p>
<pre><code class="language-java">@Service("userDetailsService")
public class LoadUserDetailsService implements UserDetailsService{
    ...
    //`UserDetailsService`,ç¨äºå è½½ç¨æ·ä¿¡æ¯
	@Override
	public UserDetails loadUserByUsername(String loginid)
			throws UsernameNotFoundException, DataAccessException {
		final List&lt;GrantedAuthority&gt; grantedAuthorities = new ArrayList&lt;GrantedAuthority&gt;();//è¿æ¯è§è²è§å
		if(StringUtils.isBlank(loginid))throw new UsernameIsEmptyException("è¯·è¾å¥ç¨æ·å! ");
		Bs_user user=bs_userDao.findByLoginId(loginid);
		if(user==null)throw new UsernameNotFoundException("UserDetailsService.usernameNotFound");
		grantedAuthorities.add(new GrantedAuthorityImpl(AuthConstants.ROLE_USER));
		List&lt;String&gt; permissionCode=bs_roleService.findPermissionCodeByAccount(loginid);
		if(permissionCode!=null &amp;&amp; !permissionCode.isEmpty()){
			for(String code:permissionCode){
				grantedAuthorities.add(new GrantedAuthorityImpl(code));
			}
		}
	...
        //è¿åè¯¦ç»ä¿¡æ¯, æç»è®¤è¯ä¼å¨é»è®¤ç DaoAuthenticationProvider
		return (UserDetails) authuser;
	}
    	...
</code></pre>
<h1 id="remember-me-è®°ä½ç»é">Remember-Me è®°ä½ç»é</h1>
<p>10.4 Remember-Me Interfaces and Implementations (3.0)</p>
<p>Remember-Me, ä¸æ¯å¨åºæ¬éªè¯èº«ä»½éªè¯çæ¶åä½¿ç¨, å¨<code>AbstractAuthenticationProcessingFilter</code>è¿æ»¤å¨åºç±»<br>
å®æä¸ª<code>RememberMeServices</code>å¼ç¨å¨<strong>éå½çæ¶åè°ç¨</strong> =.=</p>
<blockquote>
<p>Remember-me authentication is not used with basic authentication, given it is often not used with HttpSessions. Remember-me is used with UsernamePasswordAuthenticationFilter, and is implemented via hooks in the AbstractAuthenticationProcessingFilter superclass. The hooks will invoke a concrete RememberMeServices at the appropriate times. The interface looks like this:</p>
</blockquote>
<p>å¨Spring Securityçè¿æ»¤å¨é¾é, <code>RememberMeAuthenticationFilter</code> æ¯æå¨<code>UsernamePasswordAuthenticationFilter</code> ä¹åç. å¨ç¬¬ä¸æ¬¡ç»å½æ¶(å¦æå¾éäºremember me), å¨éªè¯ä¿¡æ¯æ­£ç¡®å,&nbsp;AbstractAuthenticationProcessingFilter(UsernamePasswordAuthenticationFilterçç¶ç±»)æåä¼è°ç¨ä¸ä¸ªå«successfulAuthentication()çæ¹æ³:</p>
<p>æ³¨æå ç¹:</p>
<ol>
<li>å¨ <code>authenticationManager</code> éè¦å å¤ä¸ä¸ªauthentication provider --&nbsp;RememberMeAuthenticationProvider;</li>
<li>è¦ä¸º<code>UsernamePasswordAuthenticationFilter</code>ç rememberMeServiceså±æ§æå®ä¸ä¸ªå®ä¾;<br>
3)&nbsp;<code>RememberMeAuthenticationProvider</code> å<code>TokenBasedRememberMeServices</code>é½è¦ä¸ºå®ä»¬çkeyå±æ§æå®ä¸ä¸ªå¯ä¸çå¼. è¿ä¸ªå¼å¯ä»¥ç¨åºç¨åå ä¸ä¸ªä¸å°äº36ä½é¿åº¦çéæºå­ç¬¦ä¸². è¿ä¸ªkeyæ¯ç¨æ¥è¯å«å½ååºç¨çå¯ä¸å¼.</li>
<li>å¨æäº¤ç»å½è¡¨åçæ¶å, ä¸å®è¦å å¤ä¸ä¸ªåç <code>_spring_security_remember_me</code> çåæ°å(å¯ä»¥æ¹), å¼å¯ä»¥æ¯"true", "yes", "on"æ"1".</li>
</ol>
<h2 id="åç«¯é¡µé¢è¡¨å">åç«¯é¡µé¢è¡¨å</h2>
<pre><code class="language-html"> &lt;input type="checkbox" name="remember-me"  value="true"/&gt; Remember me
 &lt;!-- _spring_security_remember_me è¿å¤çæ¬ --&gt;
 &lt;input type="checkbox" name="_spring_security_remember_me"  value="true"/&gt; Remember me
</code></pre>
<h2 id="éç½®åºäºxml">éç½®(åºäºxml)</h2>
<pre><code class="language-xml">&lt;http auto-config="false" access-denied-page="/login.htm"
		entry-point-ref="authenticationEntryPoint"&gt;
    &lt;intercept-url pattern="/images/*" filters="none"/&gt;
.......
        &lt;!-- æå¥ è¿æ»¤é¾--&gt;
        &lt;custom-filter ref="rememberMeFilter" position="REMEMBER_ME_FILTER" /&gt; --&gt;
        &lt;custom-filter ref="captchaAuthenticaionFilter" position="FORM_LOGIN_FILTER" /&gt;
        
.......
&lt;/http&gt;

 &lt;!-- dv2å®å¶å®æ¯ç»§æ¿UsernamePasswordAuthenticationFilter(æè·ç¨æ·å¯ç  å¡«åAuthentication è§ä¸è®¤è¯æµç¨) --&gt;
&lt;beans:bean id="captchaAuthenticaionFilter" class="net.jk.auth.service.CaptchaAuthenticationFilter"&gt;
    &lt;beans:property name="authenticationManager" ref="authenticationManager" /&gt;
    &lt;beans:property name="authenticationFailureHandler" ref="authenticationFailureHandler" /&gt;
    &lt;beans:property name="authenticationSuccessHandler" ref="authenticationSuccessHandler" /&gt;
     &lt;!-- rememberMeServices (çæcookieçå¥å£)
     RememberMeAuthenticationFilteræ¯æå¨UsernamePasswordAuthenticationFilterä¹åç. å¨ç¬¬ä¸æ¬¡ç»å½æ¶(å¦æå¾éäºremember me), å¨éªè¯ä¿¡æ¯æ­£ç¡®å,&nbsp;AbstractAuthenticationProcessingFilter(UsernamePasswordAuthenticationFilterçç¶ç±»)æåä¼è°ç¨ä¸ä¸ªå«successfulAuthentication()çæ¹æ³ --&gt;
    &lt;beans:property name="rememberMeServices" ref="tokenBasedRememberMeServices" /&gt;

    &lt;beans:property name="filterProcessesUrl" value="/j_spring_security_check" /&gt;
&lt;/beans:bean&gt;

 &lt;!-- éè¦ä¸ä¸ªè¿æ»¤å¨, (è¿åºè¯¥æ¯ è®¤è¯çå¥å£)æå¥å°è¿æ»¤é¾ä¸­ --&gt;
&lt;beans:bean id="rememberMeFilter" class="org.springframework.security.web.authentication.rememberme.RememberMeAuthenticationFilter"&gt;
	&lt;beans:property name="authenticationManager" ref="authenticationManager" /&gt;
	&lt;beans:property name="rememberMeServices" ref="tokenBasedRememberMeServices" /&gt;
&lt;/beans:bean&gt;

&lt;!-- è®¤è¯æä¾å¨(è®¤è¯) --&gt;
&lt;beans:bean id="rememberMeAuthenticationProvider" class="org.springframework.security.authentication.RememberMeAuthenticationProvider"&gt;
	&lt;beans:property name="key" value="1C6D97ACA4924F81926E7B302D14DB6D"/&gt;
&lt;/beans:bean&gt;

 &lt;!-- RememberMeServices (çæcookie) --&gt;
&lt;beans:bean id="tokenBasedRememberMeServices" class="org.springframework.security.web.authentication.rememberme.TokenBasedRememberMeServices"&gt;
	&lt;beans:property name="key" value="1C6D97ACA4924F81926E7B302D14DB6D" /&gt;
	&lt;beans:property name="userDetailsService" ref="userDetailsService" /&gt;
&lt;/beans:bean&gt;
</code></pre>
<p>ç»éå , é»è®¤åºè¯¥ä¼æä¸ä¸ª SPRING_SECURITY_REMEMBER_ME_COOKIE åå­çcookie</p>
<ul>
<li>remember-meå±æ§è¯¦è§£<br>
remember-meå±æ§æ¯spring securityå½åç©ºé´ä¸­å®ç°èªå¨ç»å½çä¸å±éç½®é¡¹,å®æå¦ä¸å±æ§</li>
</ul>
<ol>
<li>key: è¿ä¸ª"key"å±æ§ç¨æ¥è¾¨å«åè¾¨ä¸åé¡¹ç®çcookie</li>
<li>authentication-success-handler-ref æåä¸ä¸ªAuthenticationSuccessHandler</li>
<li>data-source-ref æåä¸ä¸ªDataSourceæ°æ®æº</li>
<li>remember-me-cookie: cookieå­æ¾çåç§°.é»è®¤ä¸ºâremember-meâ.</li>
<li>remember-me-parameter: è§¦åèªå¨ç»å½çè¯·æ±åæ°åç§°.é»è®¤ä¸ºâremember-meâ.</li>
<li>services-alias: å£°æä¸ä¸ªåé¨å®ä¹çRememberMeServicesçbeançå«å,æä¾ç»ç¨åºçå¶ä»beanä½¿ç¨</li>
<li>services-ref: æåä¸ä¸ªRememberMeServices,å¯ä»¥èªå®ä¹å®ç°èªå·±çèªå¨ç»å½é»è¾</li>
<li>token-repository-ref: æåä¸ä¸ªPersistentTokenRepository bean,ç¨æ¥å®ç°æä¹åä»¤ççèªå¨ç»å½</li>
<li>token-validity-seconds: cookieå­å¨çæ¶é´å¨æ,åä½ä¸ºç§</li>
<li>use-secure-cookie: æ¯å¦è®¾ç½®"secure"æ å¿,å·ä½ä½¿ç¨ä¸è¯¦</li>
<li>user-service-ref: æåä¸ä¸ªUserDetailsServiceçbean</li>
</ol>
<p><a href="https://docs.spring.io/spring-security/site/docs/3.0.8.RELEASE/reference/remember-me.html" target="_blank" rel="noopener nofollow">spring-security 3.0.8 è¿å¤çæ¬ææ¡£</a><br>
<a href="https://spring.io/projects/spring-security#learn" target="_blank" rel="noopener nofollow">åèspring-security ææ¡£</a>: Remember-Me Authentication ç« è</p>
<h1 id="å¨ä»£ç ä¸­è®¾ç½®-securitycontextholder-ä¸ºç»éç¶æ">å¨ä»£ç ä¸­è®¾ç½® SecurityContextHolder ä¸ºç»éç¶æ</h1>
<pre><code class="language-java">///load userDetails ...
UsernamePasswordAuthenticationToken authentication = new UsernamePasswordAuthenticationToken(userDetails, null, userDetails.getAuthorities());
authentication.setDetails(new WebAuthenticationDetailsSource().buildDetails(request));
SecurityContextHolder.getContext().setAuthentication(authentication);

</code></pre>
<h2 id="securitycontextholder-çåç">SecurityContextHolder çåç</h2>
<p><code>SecurityContextHolder</code> ç¨äºå­å¨å®å¨ä¸ä¸æ(security context)çä¿¡æ¯ï¼å³ä¸ä¸ªå­å¨èº«ä»½ä¿¡æ¯ï¼è®¤è¯ä¿¡æ¯ç­çå®¹å¨ã<br>
SecurityContextHolde é»è®¤ä½¿ç¨ <code>ThreadLocal</code> ç­ç¥æ¥å­å¨è®¤è¯ä¿¡æ¯ï¼å³ä¸ç§ä¸çº¿ç¨ç»å®çç­ç¥ï¼æ¯ä¸ªçº¿ç¨æ§è¡æ¶é½å¯ä»¥è·åè¯¥çº¿ç¨ä¸­çå®å¨ä¸ä¸æ(security context)ï¼åä¸ªçº¿ç¨ä¸­çå®å¨ä¸ä¸æäºä¸å½±åã</p>
<h1 id="sectrity-éç½®-java-beanå½¢å¼">Sectrity éç½® (Java Beanå½¢å¼)</h1>
<pre><code class="language-java">@Configuration
public class DefaultSecurityConfig extends WebSecurityConfigurerAdapter {
    @Override
    protected void configure(HttpSecurity httpSecurity) throws Exception {
    log.info("å½åä½¿ç¨å®å¨éç½®æ¯: default");
    httpSecurity.headers().frameOptions().disable();//iframe 
    ExpressionInterceptUrlRegistry eiur=httpSecurity
        // ç¦ç¨ CSRF
        .csrf().disable()
        // ææå¼å¸¸
        .exceptionHandling().authenticationEntryPoint(jwtAuthenticationEntryPoint() ).and()
        .addFilterBefore(authenticationTokenFilter, UsernamePasswordAuthenticationFilter.class)
        // ä¸åå»ºä¼è¯
        .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS).and()
        // è¿æ»¤è¯·æ±
        .authorizeRequests()
        .antMatchers(
                HttpMethod.GET,
                "/*.html",
                "/**/*.html",
                "/**/*.css",
                "/**/*.js"
        ).anonymous()


        // æ¯ä»å®åè°
        .antMatchers("/api/aliPay/return").anonymous()
        .antMatchers("/api/aliPay/notify").anonymous()
        //å¾®ä¿¡å¬ä¼å·åè°
        .antMatchers("/api/wechat/core").permitAll()
        
        //ç»éæ¥å£
        .antMatchers("/auth/**").permitAll()
        
        // swagger start
        .antMatchers("/swagger-ui.html").anonymous()
        .antMatchers("/swagger-resources/**").anonymous()
        .antMatchers("/webjars/**").anonymous()
        .antMatchers("/*/api-docs").anonymous()
        .antMatchers("/*/api-docs-ext").anonymous()
        // swagger end

        // æ¥å£éæµæµè¯
        .antMatchers("/test/**").anonymous()
        .antMatchers(HttpMethod.OPTIONS, "/**").anonymous()

        .antMatchers("/druid/**").anonymous()
        //restæ¥å£
        .antMatchers("/api/rest/**").anonymous();

        //é¤æ­¤ä¹å¤ææå°åé½éè¦éªè¯
        httpSecurity.authorizeRequests().anyRequest().authenticated();
    }

    ...
}
</code></pre>
<p><strong>ä¸ä¸ªç®ååå­è®¤è¯</strong></p>
<pre><code class="language-java">@Configuration
@Order(1)
public class WebSecurityConfigurer extends WebSecurityConfigurerAdapter {
    @Bean
    public UserDetailsService userDetailsService()  {
        // ensure the passwords are encoded properly
        User.UserBuilder users = User.withDefaultPasswordEncoder();
        InMemoryUserDetailsManager manager = new InMemoryUserDetailsManager();
        manager.createUser(users.username("yang").password("123..").roles("USER").build());
        //manager.createUser(users.username("admin").password("dfgddd").roles("USER","ADMIN").build());
        return manager;
    }
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http.formLogin()
                .successForwardUrl("/index.html")
                .and()
                .authorizeRequests().anyRequest().authenticated();
    }
}

</code></pre>
<h1 id="éæåç¹ç»éjasig">éæåç¹ç»é(<strong>jasig</strong>)</h1>
<h2 id="æå¡ç«¯">æå¡ç«¯</h2>
<p>å®ä¸è½½é¡µ - <a href="https://www.apereo.org/programs/software/cas" target="_blank" rel="noopener nofollow">https://www.apereo.org/programs/software/cas</a><br>
GitHub - <a href="https://github.com/apereo/cas" target="_blank" rel="noopener nofollow">https://github.com/apereo/cas</a></p>
<p>ä¸è½½å¶åå¸çå,ä¾: cas-server-webapp-4.0.0 - (_v_resouces/cas-server-4.0.0-release.zip)<br>
ä¸è¬èè¨ä»éè¦å¶ç¼è¯å¥½çå³å¯,ä¾:<code>cas-server-webapp-4.0.0.war</code> åæ°æ®æºæ¯æ <code>cas-server-support-jdbc-4.0.0.jar</code><br>
è§£åwaræsupport-jdbcæ¾å°libä¸,è¿æä½¿ç¨çæ°æ®åºé©±å¨,æ¯å¦<code>mysql-connector-java-5.0.8-bin.jar</code></p>
<ul>
<li>æå¡ç«¯éç½®<br>
æ¾å°./WEB-INF/deployerConfigContext.xml æä»¶,ä¿®æ¹</li>
</ul>
<ol>
<li>æ³¨é</li>
</ol>
<pre><code class="language-xml">    &lt;bean id="primaryAuthenticationHandler"
          class="org.jasig.cas.authentication.AcceptUsersAuthenticationHandler"&gt;
        &lt;property name="users"&gt;
            &lt;map&gt;
                &lt;entry key="casuser" value="Mellon"/&gt;
            &lt;/map&gt;
        &lt;/property&gt;
    &lt;/bean&gt;
</code></pre>
<ol start="2">
<li>å¢å </li>
</ol>
<pre><code class="language-xml">&lt;!-- from æ°æ®åº --&gt;
&lt;bean id="dataSource"
        class="org.springframework.jdbc.datasource.DriverManagerDataSource"&gt;
        &lt;property name="driverClassName" value="net.sourceforge.jtds.jdbc.Driver" /&gt;
        &lt;property name="url"
            value="jdbc.url=jdbc:jtds:sqlserver://127.0.0.1:1433/asp-gdagri-auth;useUnicode=true;charset=GB2312" /&gt;
        &lt;property name="username" value="user_dev" /&gt;
        &lt;property name="password" value="user@dev" /&gt;
    &lt;/bean&gt;
    
    &lt;bean id="primaryAuthenticationHandler"
          class="org.jasig.cas.adaptors.jdbc.QueryDatabaseAuthenticationHandler"
          p:dataSource-ref="dataSource"
          p:passwordEncoder-ref="MD5PasswordEncoder"
          p:sql="select password from bs_role where name=?" /&gt;
          
    &lt;bean id="MD5PasswordEncoder" class="org.jasig.cas.authentication.handler.DefaultPasswordEncoder"&gt;
        &lt;constructor-arg index="0"&gt;
            &lt;value&gt;MD5&lt;/value&gt;
        &lt;/constructor-arg&gt;
    &lt;/bean&gt;
</code></pre>
<blockquote>
<p><code>p:sql</code>åºè¯¥æ¯æå®æ¥è¯¢è¯­å¥</p>
</blockquote>
<h3 id="ä¸äºéç½®">ä¸äºéç½®</h3>
<h3 id="ticketexpirationpoliciesxml">ticketExpirationPolicies.xml</h3>
<p>ticket è¿æç­ç¥éç½®</p>
<pre><code class="language-xml">

&lt;!-- TGT éç½®--&gt;
	&lt;bean id="serviceTicketExpirationPolicy" class="org.jasig.cas.ticket.support.MultiTimeUseOrTimeoutExpirationPolicy"&gt;
    
		&lt;!-- This argument is the number of times that a ticket can be used before its considered expired. 
        (ticket å¨è¿æå[ä¸ è¿ææ¶é´ åæ°] å¯ä»¥ä½¿ç¨çæ¬¡æ°)
        --&gt;
		&lt;constructor-arg
			index="0"
			value="999999999" /&gt;
		
		&lt;!-- This argument is the time a ticket can exist before its considered expired.  
        ( è¿ææ¶é´ åä½:æ¯«ç§)
        --&gt;
		&lt;constructor-arg
			index="1"
			value="100000" /&gt;
	&lt;/bean&gt;
	&lt;!--ST éç½® --&gt;
	&lt;bean id="grantingTicketExpirationPolicy" class="org.jasig.cas.ticket.support.TimeoutExpirationPolicy"&gt;
		&lt;!-- This argument is the time a ticket can exist before its considered expired. 
        (ticket å¨ä¸æ´»è·çæ¶åè¿ææ¶é´ æ¯«ç§)
         --&gt;
		&lt;constructor-arg
			index="0"
			value="7200000" /&gt;
	&lt;/bean&gt;

</code></pre>
<p><a href="https://www.cnblogs.com/gao241/p/3367869.html" target="_blank">åè</a></p>
<h4 id="tgc-ticket-granting-cookie">TGC: Ticket Granting Cookie</h4>
<p>CAS ä¼å°çæç TGT æ¾å¨ session ä¸­, è TGC å°±æ¯è¿ä¸ª session çå¯ä¸æ è¯(sessionId), å¯ä»¥è®¤ä¸ºæ¯ TGT çkey, ä¸º TGT å°±æ¯ TGC ç value, TGC ä»¥ cookie çå½¢å¼ä¿å­å¨æµè§å¨ä¸­, æ¯ä¸ªè¯·æ±é½ä¼å°è¯æºå¸¦ TGC; ï¼æ¯ä¸ªæå¡é½ä¼å¨ session å cookie ä¸­ä¿å­å¯¹åºç TGT å TGCï¼</p>
<h4 id="tgt-ticket-granting-ticket">TGT: Ticket Granting Ticket</h4>
<p>TGT æ¯CAS ä¸ºç¨æ·ç­¾åçç»å½ ticket, ä¹æ¯ç¨äºéªè¯ç¨æ·ç»å½æåçå¯ä¸æ¹å¼;  TGT å°è£äº Cookie å¼ä»¥å Cookie å¼å¯¹åºçç¨æ·ä¿¡æ¯, CAS éè¿ Cookie å¼ï¼TGCï¼ä¸º key æ¥è¯¢ç¼å­ä¸­ææ  TGTï¼TGC:TGTï¼key:valueï¼ï¼, å¦ææçè¯å°±è¯´æç¨æ·å·²ç»ç»å½æ;</p>
<h4 id="st-service-ticket">ST: Service Ticket</h4>
<p>ST æ¯å½ç¨æ·è®¿é®æä¸æå¡æ¶æä¾ç ticket; ç¨æ·å¨è®¿é®å¶ä»æå¡æ¶, åç°æ²¡æ cookie æ ST , é£ä¹å°±ä¼302å° CAS æå¡å¨è·å ST; ç¶åä¼æºå¸¦ç ST 302 åæ¥;</p>
<h2 id="å®¢æ·ç«¯-xmlå½¢å¼éç½®">å®¢æ·ç«¯ (XMLå½¢å¼éç½®)</h2>
<ol>
<li>é¦åéè¦åçæ¯å°åºç¨çç»å½è®¤è¯å¥å£æ¹ä¸ºä½¿ç¨<code>CasAuthenticationEntryPoint</code>;</li>
</ol>
<pre><code class="language-xml">  &lt;!-- æå®ç»å½å¥å£ä¸ºcasEntryPoint --&gt;
   &lt;security:http  entry-point-ref="casEntryPoint"&gt;
      ...
   &lt;/security:http&gt;
</code></pre>
<ol start="2">
<li>æä»¥é¦åæä»¬éè¦éç½®ä¸ä¸ª<code>CasAuthenticationEntryPoint</code>å¯¹åºçbean, ç¶åæå®éè¦è¿è¡ç»å½è®¤è¯æ¶ä½¿ç¨è¯¥<code>AuthenticationEntryPoint</code>;</li>
</ol>
<pre><code class="language-xml">&lt;!-- è®¤è¯çå¥å£ --&gt;

   &lt;bean id="casEntryPoint"

      class="org.springframework.security.cas.web.CasAuthenticationEntryPoint"&gt;

      &lt;!-- Cas Serverçç»å½å°å, elimæ¯æçè®¡ç®æºå --&gt;

      &lt;property name="loginUrl" value="https://elim:8443/cas/login" /&gt;

      &lt;!-- serviceç¸å³çå±æ§ --&gt;

      &lt;property name="serviceProperties" ref="serviceProperties" /&gt;
   &lt;/bean&gt;
</code></pre>
<ol start="3">
<li>éç½®CasAuthenticationEntryPointæ¶éè¦æå®ä¸ä¸ª<code>ServiceProperties</code>, è¯¥å¯¹è±¡ä¸»è¦ç¨æ¥æè¿°serviceï¼Casæ¦å¿µï¼ç¸å³çå±æ§, ä¸»è¦æ¯æå®å¨Cas Serverè®¤è¯æååå°è¦è·³è½¬çå°å;</li>
</ol>
<pre><code class="language-xml">&lt;!-- æå®serviceç¸å³ä¿¡æ¯ --&gt;
   &lt;bean id="serviceProperties"class="org.springframework.security.cas.ServiceProperties"&gt;
      &lt;!-- Cas Serverè®¤è¯æååçè·³è½¬å°å, è¿éè¦è·³è½¬å°æä»¬çSpring Securityåºç¨, ä¹åä¼ç±CasAuthenticationFilterå¤ç, é»è®¤å¤çå°åä¸º/j_spring_cas_security_check --&gt;
      //&lt;!&gt;æ¬å°å°åäº, è¿éå¼å§å°±æ¯æ¬å°Spring Security æµç¨äº, åç± cas filter å°è£ UsernamePasswordAuthenticationToken 
      //åå° AuthenticationManager, å° AuthenticationProvider æµç¨..
      &lt;property name="service"
         value="http://elim:8080/app/j_spring_cas_security_check" /&gt;

   &lt;/bean&gt;
</code></pre>
<ol start="4">
<li>ä¹åæä»¬éè¦éç½®ä¸ä¸ª<code>CasAuthenticationFilter</code>, å¹¶å°å¶æ¾ç½®å¨Filteré¾è¡¨ä¸­CAS_FILTERçä½ç½®, ä»¥å¤çCas Serverè®¤è¯æååçé¡µé¢è·³è½¬, ç¨ä»¥å¨Spring Securityä¸­è¿è¡è®¤è¯;</li>
</ol>
<blockquote>
<p>è¯¥Filterä¼å°Cas Serverä¼ éè¿æ¥çticketï¼Casæ¦å¿µï¼å°è£æä¸ä¸ª<code>Authentication</code>ï¼å¯¹åºUsernamePasswordAuthenticationToken, å¶ä¸­ticketä½ä¸ºè¯¥Authenticationçpasswordï¼, ç¶åä¼ éç»<code>AuthenticationManager</code>è¿è¡è®¤è¯;</p>
</blockquote>
<pre><code class="language-xml">  &lt;security:http entry-point-ref="casEntryPoint"&gt;
      ...
        &lt;!-- å®ä¹CasAuthenticationFilter å¹¶å°å¶æ¾ç½®å¨Filteré¾è¡¨ä¸­CAS_FILTERçä½ç½®--&gt;
      &lt;security:custom-filter ref="casFilter" position="CAS_FILTER"/&gt;
      ...
   &lt;/security:http&gt;
   &lt;bean id="casFilter" class="org.springframework.security.cas.web.CasAuthenticationFilter"&gt;
      &lt;property name="authenticationManager" ref="authenticationManager" /&gt;
      &lt;!-- æå®å¤çå°å, ä¸æå®æ¶é»è®¤å°ä¼æ¯"/j_spring_cas_security_check" --&gt;
      &lt;property name="filterProcessesUrl" value="/j_spring_cas_security_check"/&gt;
   &lt;/bean&gt;
</code></pre>
<ol start="5">
<li><code>CasAuthenticationFilter</code>ä¼å°å°è£å¥½çåå«Cas<strong>Serverä¼ éè¿æ¥çticketçAuthentication</strong>å¯¹è±¡ä¼ éç»<strong>AuthenticationManagerè¿è¡è®¤è¯</strong>;</li>
</ol>
<pre><code class="language-xml">&lt;security:authentication-manager alias="authenticationManager"&gt;
&lt;!-- ç»AuthenticationManager æä¾ä¸ä¸ª è®¤è¯ ; åè: ç»è°è®¤è¯è¿ç¨ 5--&gt;
      &lt;security:authentication-provider ref="casAuthenticationProvider"/&gt;

   &lt;/security:authentication-manager&gt;
</code></pre>
<ol start="6">
<li>é»è®¤çAuthenticationManagerå®ç°ç±»ä¸ºProviderManager, èProviderManagerä¸­<strong>çæ­£è¿è¡è®¤è¯çæ¯AuthenticationProvider</strong>;</li>
</ol>
<p>æä»¥æ¥ä¸æ¥æä»¬è¦å¨AuthenticationManagerä¸­éç½®ä¸ä¸ªè½å¤å¤ç<strong>CasAuthenticationFilterä¼ éè¿æ¥çAuthenticationå¯¹è±¡çAuthenticationProviderå®ç°,</strong> <code>CasAuthenticationProvider</code>;</p>
<pre><code class="language-xml">&lt;!&gt; çæ­£è®¤è¯é»è¾bean 
 &lt;bean id="casAuthenticationProvider"

   class="org.springframework.security.cas.authentication.CasAuthenticationProvider"&gt;
      &lt;!-- éè¿usernameæ¥å è½½UserDetails --&gt;
      &lt;property name="authenticationUserDetailsService"&gt;
         &lt;beanclass="org.springframework.security.core.userdetails.UserDetailsByNameServiceWrapper"&gt;
            &lt;!-- çæ­£å è½½UserDetailsçUserDetailsServiceå®ç° --&gt;
            &lt;constructor-arg ref="userDetailsService" /&gt;
         &lt;/bean&gt;
      &lt;/property&gt;

      &lt;property name="serviceProperties" ref="serviceProperties" /&gt;

      &lt;!-- éç½®TicketValidatorå¨ç»å½è®¤è¯æååéªè¯ticket --&gt;
      &lt;property name="ticketValidator"&gt;

         &lt;bean class="org.jasig.cas.client.validation.Cas20ServiceTicketValidator"&gt;
            &lt;!-- Cas Serverè®¿é®å°åçåç¼, å³æ ¹è·¯å¾--&gt;
            &lt;constructor-arg index="0" value="https:// elim:8443/cas" /&gt;
         &lt;/bean&gt;
      &lt;/property&gt;
      &lt;property name="key" value="key4CasAuthenticationProvider" /&gt;

   &lt;/bean&gt;
</code></pre>
<p><strong>CasAuthenticationProvideré¦åä¼å©ç¨TicketValidator</strong>ï¼Casæ¦å¿µï¼å¯¹Authenticationä¸­åå«çticketä¿¡æ¯è¿è¡è®¤è¯;</p>
<p>è®¤è¯éè¿åå°å©ç¨ææç<code>AuthenticationUserDetailsService</code> æ ¹æ®è®¤è¯éè¿ååä¼ çAssertionå¯¹è±¡ä¸­æ¥æçusernameå è½½ç¨æ·å¯¹åºçUserDetails,</p>
<p>å³ä¸»è¦æ¯å è½½ç¨æ·çç¸å³æéä¿¡æ¯GrantedAuthority; ç¶åæé ä¸ä¸ª CasAuthenticationTokenè¿è¡è¿å; ä¹åçé»è¾å°±æ¯æ­£å¸¸çSpring Securityçé»è¾äº;</p>
<p>è®¿é®æµè¯</p>
<blockquote>
<p><a href="http://127.0.0.1/cas-server/login" target="_blank" rel="noopener nofollow">http://127.0.0.1/cas-server/login</a><br>
<a href="https://127.0.0.1:8443/cas-server/login" target="_blank" rel="noopener nofollow">https://127.0.0.1:8443/cas-server/login</a></p>
</blockquote>
<h2 id="å®¢æ·ç«¯-java-beanå½¢å¼éç½®">å®¢æ·ç«¯ (Java Beanå½¢å¼éç½®)</h2>
<pre><code class="language-xml">&lt;!-- security å¯¹CASæ¯æ --&gt;
&lt;dependency&gt;
	&lt;groupId&gt;org.springframework.security&lt;/groupId&gt;
	&lt;artifactId&gt;spring-security-cas&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>
<pre><code class="language-java">    //å¥å£ç¹
   @Bean
	public CasAuthenticationEntryPoint casAuthenticationEntryPoint() {
		CasAuthenticationEntryPoint casAuthenticationEntryPoint = new CasAuthenticationEntryPoint();
		casAuthenticationEntryPoint.setLoginUrl(casProperties.getServerPrefix()+casProperties.getServerLogin());
		casAuthenticationEntryPoint.setServiceProperties(serviceProperties());
		return casAuthenticationEntryPoint;
	}
    // æ¬å°ç¼å­è®¤è¯
    @Bean
  	public CasLocalCacheAuthenticationFilter casLocalCacheAuthenticationFilter()  {
    	CasLocalCacheAuthenticationFilter ccaf;
    	try {
    		ccaf = new CasLocalCacheAuthenticationFilter(casProperties, redisTemplate, casUserDetailsService());
		} catch (Exception e) {
			e.printStackTrace();
			throw new RuntimeException(e.getMessage() );
		}
  		return ccaf;
  	}
    // cas è®¤è¯è¿æ»¤å¨
    @Bean
	public CasAuthenticationFilter casAuthenticationFilter() throws Exception {
		CasAuthenticationFilter casAuthenticationFilter = new CasAuthenticationFilter();
		casAuthenticationFilter.setAuthenticationManager(authenticationManager());
		casAuthenticationFilter.setFilterProcessesUrl(casProperties.getAppLogin());
		casAuthenticationFilter.setAuthenticationSuccessHandler(casAuthenticationSuccessHandler());
		return casAuthenticationFilter;
	}

    ////////////è®¤è¯ç¸å³å¤ç
    @Bean
    @Override
	protected AuthenticationManager authenticationManager() {
		List&lt;AuthenticationProvider&gt; p = new ArrayList&lt;AuthenticationProvider&gt;(1);
		p.add(casAuthenticationProvider());
		ProviderManager authenticationManager = new ProviderManager(p);
		return authenticationManager;
	}
    @Bean
	public CasAuthenticationProvider casAuthenticationProvider() {
		CasAuthenticationProvider casAuthenticationProvider = new CasAuthenticationProvider();
		try {
			casAuthenticationProvider.setAuthenticationUserDetailsService(casUserDetailsService());
		} catch (Exception e) {
			e.printStackTrace();
			throw new RuntimeException(e.getMessage() );
		}
		casAuthenticationProvider.setServiceProperties(serviceProperties());
		casAuthenticationProvider.setTicketValidator(cas20ServiceTicketValidator());
		casAuthenticationProvider.setKey("jk_www_123ProviderKey");
		return casAuthenticationProvider;
	}
	@Bean
	public Cas20ServiceTicketValidator cas20ServiceTicketValidator() {
		return new Cas20ServiceTicketValidator(casProperties.getServerPrefix());
	}
	
	@Bean
	public ServiceProperties serviceProperties() {
		ServiceProperties serviceProperties = new ServiceProperties();
		serviceProperties.setService(casProperties.getAppPrefix()+ casProperties.getAppLogin());
		serviceProperties.setAuthenticateAllArtifacts(true);
		return serviceProperties;
	}
    @Bean
	public CasAuthenticationSuccessHandler casAuthenticationSuccessHandler()  {
    	CasAuthenticationSuccessHandler casAuthenticationSuccessHandler = new CasAuthenticationSuccessHandler(this.casProperties, redisTemplate);
		return casAuthenticationSuccessHandler;
	}
    
    // æ¬å° UserDetailsService
	@Bean	
	@ConditionalOnMissingBean( value={AuthenticationUserDetailsService.class} )
 	public AuthenticationUserDetailsService casUserDetailsService() throws Exception {
 		return new CasUserDetailsServiceImp();
 	}
     //ç»åº
    @Bean
	public CasLogoutFilter casLogoutFilter() {
		return new CasLogoutFilter(casProperties, redisTemplate);
	}
    
    //éç½®
    @Override
    protected void configure(HttpSecurity httpSecurity) throws Exception {
      	log.info("å½åä½¿ç¨å®å¨éç½®æ¯: cas");
    	ExpressionInterceptUrlRegistry eiur=httpSecurity
                // ç¦ç¨ CSRF
                .csrf().disable()
                // ææå¼å¸¸
                .exceptionHandling().authenticationEntryPoint(casAuthenticationEntryPoint() ).and()
                // ä¸åå»ºä¼è¯
                .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS).and()
    	//
		    	httpSecurity
					.formLogin()
					.loginProcessingUrl(casProperties.getAppLogin());
                // é²æ­¢iframe é æè·¨å
                .and().headers().frameOptions().disable();
        httpSecurity
        		.addFilterAt(casLogoutFilter(), LogoutFilter.class)
                .addFilterBefore(casAuthenticationFilter(), UsernamePasswordAuthenticationFilter.class)
                .addFilterBefore(casLocalCacheAuthenticationFilter(), CasAuthenticationFilter.class);
      
    }
</code></pre>
<p>å®ä¹ä¸ä¸ª CasProperties éç½®ç±»,ç¨äºå°propertiesæä»¶æå®çåå®¹æ³¨å¥ä»¥æ¹ä¾¿ä½¿ç¨</p>
<pre><code class="language-java">public class CasProperties {
	private String serverPrefix;
	private String serverLogin;
	private String serverLogout;
	//
	private String appPrefix;
	private String appLogin;
	private String appLogout;

</code></pre>
<h3 id="æ³¨æ1-casauthenticationfilter">æ³¨æ1 CasAuthenticationFilter</h3>
<p>CasAuthenticationFilter è®¤è¯è¿æ»¤å¨</p>
<pre><code class="language-java">@Bean
public CasAuthenticationFilter casAuthenticationFilter() throws Exception {
    CasAuthenticationFilter casAuthenticationFilter = new CasAuthenticationFilter();
    //æ ¹æ® spring securiry æ­¥éª¤ authenticationManager ä¼è°ç¨ Provider list è®¤è¯ è§å
    //æä»¥è¿è¦æCasAuthenticationProvider  æ³¨ç» authenticationManager, æå¥½è¦çç¶çæ¹æ³, èªå·±å.. åä¸ç®¡äº
    List&lt;AuthenticationProvider&gt; p = new ArrayList&lt;AuthenticationProvider&gt;(1);
    p.add(casAuthenticationProvider());
    ProviderManager authenticationManager = new ProviderManager(p);
    casAuthenticationFilter.setAuthenticationManager(authenticationManager);
    casAuthenticationFilter.setFilterProcessesUrl(casProperties.getAppLogin());//cas çåè° ç»éå°å
    return casAuthenticationFilter;
}
</code></pre>
<h3 id="æ³¨æ2-casauthenticationprovider">æ³¨æ2 CasAuthenticationProvider</h3>
<p>è¿ä»æ¯ spring æ¡æ¶åçæ©å±; è¿ä¸ªProvider éè¦å ä¸ªå®ç°?</p>
<p>è¦å¼ jasig client</p>
<pre><code class="language-xml">&lt;!-- https://mvnrepository.com/artifact/org.jasig.cas.client/cas-client-core --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.jasig.cas.client&lt;/groupId&gt;
    &lt;artifactId&gt;cas-client-core&lt;/artifactId&gt;
    &lt;version&gt;xxx&lt;/version&gt;
&lt;/dependency&gt;

</code></pre>
<pre><code class="language-java">
casAuthenticationProvider.setServiceProperties(serviceProperties());//cas æå¡å¨éç½®
casAuthenticationProvider.setTicketValidator(cas20ServiceTicketValidator()); // éªè¯å®ç° , jasig client å·²å®ç°
casAuthenticationProvider.setAuthenticationUserDetailsService(casUserDetailsService());//è¿æ¯ç»éæåä¹å å è½½æ¬åºç¨ç ç¨æ·è¯¦ç»ä¿¡æ¯
casAuthenticationProvider.setKey("casAuthenticationProviderKey"); //key  å¯ä»¥æ è¯å®(Provider)ååå·²è®¤è¯çä»¤ç, é¿åéå¤éªè¯,åèæºç 105
</code></pre>
<pre><code class="language-java">
if (authentication instanceof CasAuthenticationToken) {
			if (this.key.hashCode() == ((CasAuthenticationToken) authentication)
					.getKeyHash()) {
				return authentication;
			}
			else {
				throw new BadCredentialsException(
						messages.getMessage("CasAuthenticationProvider.incorrectKey",
								"The presented CasAuthenticationToken does not contain the expected key"));
			}
		}
</code></pre>
<p><a href="https://apereo.atlassian.net/wiki/spaces/CASC/overview" target="_blank" rel="noopener nofollow">å®æ¹wiki?</a><br>
<a href="https://www.jianshu.com/p/2ba25bd3a5cb?tdsourcetag=s_pctim_aiomsg" target="_blank" rel="noopener nofollow">https://www.jianshu.com/p/2ba25bd3a5cb?tdsourcetag=s_pctim_aiomsg</a><br>
<a href="https://blog.csdn.net/cl_andywin/article/details/53998986" target="_blank" rel="noopener nofollow">https://blog.csdn.net/cl_andywin/article/details/53998986</a></p>
<h1 id="è¸©åæå">è¸©åæå</h1>
<h2 id="anonymous-å-permitall">anonymous å permitAll</h2>
<pre><code class="language-java">.antMatchers("/auth/ttx").anonymous()
.antMatchers("/auth/ttp").permitAll()
</code></pre>
<p><code>anonymous()</code> åè®¸å¿å/ä¸æ£éªæé/ç»è¿Security è¿æ»¤é¾; åXMlç<code>&lt;intercept-url pattern="/auth/ttx*"  access="IS_AUTHENTICATED_ANONYMOUSLY"/&gt;</code></p>
<p><code>permitAll()</code> å®å¨åç»/ä¸ç»è¿Security è¿æ»¤é¾; åXMlç<code>&lt;intercept-url pattern="/auth/ttp*"  filters="none" /&gt;</code></p>
<h2 id="antmatchers-çéç½®è§å">antMatchers çéç½®è§å</h2>
<p>Examples</p>
<p><code>com/t?st.jsp</code> â matches <code>com/test.jsp</code> but also <code>com/tast.jsp</code> or <code>com/txst.jsp</code><br>
<code>com/*.jsp</code> â matches all .jsp files in the com directory</p>
<p><code>com/**/test.jsp</code> â matches all test.jsp files underneath the com path</p>
<p><code>org/springframework/**/*.jsp</code> â matches all .jsp files underneath the org/springframework path</p>
<p><code>org/**/servlet/bla.jsp</code> â matches org/springframework/servlet/bla.jsp but also org/springframework/testing/</p>
<p><code>servlet/bla.jsp and</code> org/servlet/bla.jsp</p>
<p><code>com/{filename:\\w+}.jsp </code>will match com/test.jsp and assign the value test to the filename variable</p>
<p><strong>æå·çè§å, åºè¯¥æå¨æåé¢!</strong></p>
<h2 id="å¤±è´¥æ¶ä¸è°ç¨-authenticationentrypoint-å¥å£çé®é¢">å¤±è´¥æ¶ä¸è°ç¨ authenticationEntryPoint å¥å£çé®é¢</h2>
<pre><code class="language-java">
protected void configure(HttpSecurity httpSecurity) throws Exception {
httpSecurity.headers().frameOptions().disable();//iframe 
ExpressionInterceptUrlRegistry eiur=httpSecurity
        // ç¦ç¨ CSRF
        .csrf().disable()
        // ææå¼å¸¸
        .exceptionHandling().authenticationEntryPoint(jwtAuthenticationEntryPoint() ).and()
        .addFilterBefore(authenticationTokenFilter, UsernamePasswordAuthenticationFilter.class)
</code></pre>
<p>åè§ä¸: <code>ç»è°è®¤è¯è¿ç¨</code></p>
<p>èªå®ä¹ <code>authenticationTokenFilter</code> è®¤è¯å®ç°æ¶</p>
<ol>
<li>
<p><code>ExceptionTransactionFilter</code> åºæ¬å¨è¿æ»¤æåé¢, æ²¡åæ³å¤çFilterChainä¸­Filter çå¼å¸¸, å®ä¸»è¦æ¯å¤çAction æåºçå¼å¸¸, å¦æ¯è®¤è¯ç¸å³å¼å¸¸(å³ <code>AccessDeniedException</code> å <code>AuthenticationException</code>) å®å°±ä¼å¤çç¿»è¯å¹¶ä¼è°å° <code>authenticationEntryPoint</code></p>
</li>
<li>
<p>å¦æè®¤è¯å¤±è´¥: æ²¡æä»»ä½å¤çä¼ç»§ç»­åè°é¾ <code>chain.doFilter(request, response)</code>;<strong>æ³¨æå¨httpSecurity æ«å°¾è¿½å  <code>authenticated()</code> ååº(é¤æ­¤ä¹å¤é½éè¦éªè¯), å¦åä¼ä»¥æªç»éç¶æè®¿é®å°Action!</strong></p>
</li>
</ol>
<pre><code class="language-java"> //é¤æ­¤ä¹å¤ç ææå°åé½éè¦éªè¯(ååº)
httpSecurity.authorizeRequests().anyRequest().authenticated();
</code></pre>
<h2 id="æéé®é¢">æéé®é¢</h2>
<h3 id="è®°ä¸-filtersecurityinterceptor-å¥æªçæéæ¦æª">è®°ä¸ FilterSecurityInterceptor å¥æªçæéæ¦æª!</h3>
<h4 id="é¡¹ç®è°è¯è¿ç¨è®°å½">é¡¹ç®è°è¯è¿ç¨è®°å½</h4>
<p><em>é¡¹ç®æ¥å£è°ç¨, å¨<code>JwtAuthorizationTokenFilter</code> è®¤è¯æå,è¿æ»¤é¾æåä¸ä¸ª<code>org.springframework.security.web.access.intercept.FilterSecurityInterceptor</code> æéæç¥¨å¤±è´¥,<code>AccessDeniedException: Access is denied</code>å¼å¸¸é®é¢è°è¯</em><br>
è¢«å¼å¸¸ç¿»è¯è¿æ»¤å¨<code>org.springframework.security.web.access.ExceptionTranslationFilter</code>, ç¿»è¯ä¸º403;</p>
<p><code>FilterSecurityInterceptor</code> è¯¥è¿æ»¤å¨ç¨äºæ§å¶methodçº§å«çæéæ§å¶.ä¹å°±æ¯å¤ç <code>@PreAuthorize</code> æ³¨è§£çè¿æ»¤å¨</p>
<ul>
<li>org.springframework.security.access.vote.AffirmativeBased</li>
</ul>
<p><em>æç»è°å°<code>org.springframework.security.access.vote.AffirmativeBased::decide</code> æ¹æ³</em></p>
<pre><code class="language-java">public void decide(Authentication authentication, Object object,
			Collection&lt;ConfigAttribute&gt; configAttributes) throws AccessDeniedException {
		int deny = 0;

for (AccessDecisionVoter voter: getDecisionVoters()) {
    //åªæä¸ä¸ª org.springframework.security.web.access.expression.WebExpressionVoter , å®ææç»
    int result = voter.vote(authentication, object, configAttributes);
    switch (result) {
    case AccessDecisionVoter.ACCESS_GRANTED:
        return;

    case AccessDecisionVoter.ACCESS_DENIED:
        deny++;

        break;

    default:
        break;
    }
}
</code></pre>
<p><strong>AffirmativeBased</strong> çé»è¾æ¯è¿æ ·ç:<br>
ï¼1ï¼åªè¦æAccessDecisionVoterçæç¥¨ä¸ºACCESS_GRANTEDååæç¨æ·è¿è¡è®¿é®;<br>
ï¼2ï¼å¦æå¨é¨å¼æä¹è¡¨ç¤ºéè¿;<br>
ï¼3ï¼å¦ææ²¡æä¸ä¸ªäººæèµæç¥¨, ä½æ¯æäººæåå¯¹ç¥¨, åå°æåºAccessDeniedException;</p>
<p><strong>AffirmativeBased</strong> çæç¥¨æ¥å£åè¡¨(<strong>AccessDecisionVoter</strong>)åªæä¸ä¸ª*</p>
<p><code>org.springframework.security.web.access.expression.WebExpressionVoter</code></p>
<ul>
<li>AccessDecisionVoter</li>
</ul>
<p><code>AccessDecisionVoter.vote()</code>æ¹æ³çè¿åç»æä¼æ¯AccessDecisionVoterä¸­å®ä¹çä¸ä¸ªå¸¸éä¹ä¸; ACCESS_GRANTEDè¡¨ç¤ºåæ, ACCESS_DENIEDè¡¨ç¤ºæç», ACCESS_ABSTAINè¡¨ç¤ºå¼æ; å¦æä¸ä¸ªAccessDecisionVoterä¸è½å¤å®å½åAuthenticationæ¯å¦æ¥æè®¿é®å¯¹åºåä¿æ¤å¯¹è±¡çæé, åå¶vote()æ¹æ³çè¿åå¼åºå½ä¸ºå¼æACCESS_ABSTAIN;</p>
<p><em>ææç»å¨ <code>ReflectivePropertyAccessor$OptimalPropertyAccessor.read</code> æ¹æ³, åå°è°ç¨å <code>WebSecurityExpressionRoot[SecurityExpressionRoot.isAnonymous()]</code>æ¹æ³çè¿åå¼</em></p>
<p>isAnonymous é¡¾åæä¹, æ¯å¦å¿å...</p>
<h4 id="è§£å³æ¹å¼">è§£å³æ¹å¼</h4>
<p>HttpSecurity çéç½® <code>.antMatchers("/auth/*").anonymous()</code> (åè®¸å¿åç¨æ·, èç»éç¨æ·ä¸æ¯å¿åç¨æ·?) ..ä½¿ç¨<code>permitAll</code> æ¿ä»£ä¹.</p>
<pre><code class="language-java">//ä¾å¦
.antMatchers("/auth/ttx").anonymous()
.antMatchers("/auth/ttp").permitAll()
</code></pre>
<h3 id="è®°äº-æ¥å£403æ æéçé®é¢">è®°äº æ¥å£403æ æéçé®é¢!</h3>
<h4 id="preauthorize-æ¥å£æéæ³¨è§£">@PreAuthorize æ¥å£æéæ³¨è§£</h4>
<p>ä¸è¬èè¨å¨ controller éè¿<code>@PreAuthorize</code> æ³¨è§£è®¿é®æé,<br>
å®è°ç¨çæ¯å¨ <code>org.springframework.security.access.expression.SecurityExpressionRoot</code>éé¢çæ¹æ³å¤æ­æéç (ELè¡¨è¾¾å¼);</p>
<blockquote>
<p>è®°å¾éå¯ç¨<code>@EnableGlobalMethodSecurity(prePostEnabled = true)</code></p>
</blockquote>
<p>æç»æ¯å¨ <code>org.springframework.security.access.prepost.PreInvocationAuthorizationAdviceVoter::vote</code>æ¹æ³æç¥¨</p>
<pre><code class="language-java">public int vote(Authentication authentication, MethodInvocation method,
        Collection&lt;ConfigAttribute&gt; attributes) {

    // Find prefilter and preauth (or combined) attributes
    // if both null, abstain
    // else call advice with them

    PreInvocationAttribute preAttr = findPreInvocationAttribute(attributes);

    if (preAttr == null) {
        // No expression based metadata, so abstain
        return ACCESS_ABSTAIN;
    }
    //org.springframework.security.access.expression.method.ExpressionBasedPreInvocationAdvice
    boolean allowed = preAdvice.before(authentication, method, preAttr);

    return allowed ? ACCESS_GRANTED: ACCESS_DENIED;
}


//org.springframework.security.access.expression.method.ExpressionBasedPreInvocationAdvice :: before
	public boolean before(Authentication authentication, MethodInvocation mi,
			PreInvocationAttribute attr) {
		PreInvocationExpressionAttribute preAttr = (PreInvocationExpressionAttribute) attr;
		EvaluationContext ctx = expressionHandler.createEvaluationContext(authentication,
				mi);
		Expression preFilter = preAttr.getFilterExpression();
		Expression preAuthorize = preAttr.getAuthorizeExpression();

		if (preFilter != null) {
			Object filterTarget = findFilterTarget(preAttr.getFilterTarget(), ctx, mi);

			expressionHandler.filter(filterTarget, preFilter, ctx);
		}

		if (preAuthorize == null) {
			return true;
		}
        //è¿éæ§è¡ Spring ELè¡¨è¾¾å¼ 
		return ExpressionUtils.evaluateAsBoolean(preAuthorize, ctx);
	}



// org.springframework.expression.spel.standard.SpelExpression::getValue æ¹æ³
public &lt;T&gt; T getValue(EvaluationContext context, @Nullable Class&lt;T&gt; expectedResultType) throws EvaluationException {
		Assert.notNull(context, "EvaluationContext is required");

		if (this.compiledAst != null) {
			try {
				Object result = this.compiledAst.getValue(context.getRootObject().getValue(), context);
				if (expectedResultType != null) {
					return ExpressionUtils.convertTypedValue(context, new TypedValue(result), expectedResultType);
				}
				else {
					return (T) result;
				}
			}
			catch (Throwable ex) {
				// If running in mixed mode, revert to interpreted
				if (this.configuration.getCompilerMode() == SpelCompilerMode.MIXED) {
					this.interpretedCount = 0;
					this.compiledAst = null;
				}
				else {
					// Running in SpelCompilerMode.immediate mode - propagate exception to caller
					throw new SpelEvaluationException(ex, SpelMessage.EXCEPTION_RUNNING_COMPILED_EXPRESSION);
				}
			}
		}

		ExpressionState expressionState = new ExpressionState(context, this.configuration);
		TypedValue typedResultValue = this.ast.getTypedValue(expressionState);
		checkCompile(expressionState);
		return ExpressionUtils.convertTypedValue(context, typedResultValue, expectedResultType);
	}
///ææç» org.springframework.expression.spel.support.ReflectiveMethodExecutor::execute æ¹æ³ åå°è°ç¨
@Override
public TypedValue execute(EvaluationContext context, Object target, Object... arguments) throws AccessException {
    try {
        this.argumentConversionOccurred = ReflectionHelper.convertArguments(
                context.getTypeConverter(), arguments, this.originalMethod, this.varargsPosition);
        if (this.originalMethod.isVarArgs()) {
            arguments = ReflectionHelper.setupArgumentsForVarargsInvocation(
                    this.originalMethod.getParameterTypes(), arguments);
        }
        ReflectionUtils.makeAccessible(this.methodToInvoke);
        
        /**
//this.methodToInvoke = public abstract boolean org.springframework.security.access.expression.SecurityExpressionOperations.hasAnyRole(java.lang.String[]) // è¿æ¯ä¸ªæ½è±¡ç±», å®éè°ç¨ è§ä¸
// target = org.springframework.security.access.expression.method.MethodSecurityExpressionRoot
// arguments = ADMIN ... è§è²ä»£ç æ°ç»
       **/
        Object value = this.methodToInvoke.invoke(target, arguments);
        return new TypedValue(value, new TypeDescriptor(new MethodParameter(this.originalMethod, -1)).narrow(value));
    }
    catch (Exception ex) {
        throw new AccessException("Problem invoking method: " + this.methodToInvoke, ex);
    }
}
//å®éè°ç¨çæ¯ org.springframework.security.access.expression.SecurityExpressionRoot å¯¹è±¡
</code></pre>
<h4 id="è§£å³æ¹å¼-1">è§£å³æ¹å¼</h4>
<p>æ³¨æ <code>org.springframework.security.access.expression.SecurityExpressionRoot</code> æä¸ªå±æ§å®é»è®¤å¸¦<code>private String defaultRolePrefix = "ROLE_";</code>åç¼ æ*!</p>
<p>å®ä¹ä¸ä¸ª <code>GrantedAuthorityDefaults</code> bean å¯ä»¥è§£å³å®</p>
<pre><code class="language-java">@Bean
GrantedAuthorityDefaults grantedAuthorityDefaults() {
    // Remove the ROLE_ prefix
    return new GrantedAuthorityDefaults("");
}
</code></pre>

</div>
<div id="MySignature" role="contentinfo">
    é¢é²èå¹´ç´åï¼ä¿æç»èº«å­¦ä¹ !    ââ <a href="https://www.cnblogs.com/dddy/" target="_blank">daidaidaiyu</a>
</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-01-05 21:25">2026-01-05 21:24</span>&nbsp;
<a href="https://www.cnblogs.com/dddy">daidaidaiyu</a>&nbsp;
éè¯»(<span id="post_view_count">7</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19444770);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19444770', targetLink: 'https://www.cnblogs.com/dddy/p/19444770', title: 'ä¸æå¥é¨ Spring Security with åç¹ç»å½(jasig)' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ C#/.NET/.NET Coreä¼ç§é¡¹ç®åæ¡æ¶2025å¹´12æç®æ¥ ]]></title>
    <link>https://www.cnblogs.com/Can-daydayup/p/19444711</link>
    <guid>5a695af5bc271099fb69805afa85dd49</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/Can-daydayup/p/19444711" title="åå¸äº 2026-01-05 21:01">
    <span role="heading" aria-level="2">C#/.NET/.NET Coreä¼ç§é¡¹ç®åæ¡æ¶2025å¹´12æç®æ¥</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body blogpost-body-html">
<p><img src="https://img2024.cnblogs.com/blog/1336199/202601/1336199-20260105205720027-409669949.png" alt="image" loading="lazy"></p>
<h2 data-tool="mdniceç¼è¾å¨"><span>åè¨</span></h2>
<p data-tool="mdniceç¼è¾å¨"><span>å¬ä¼å·æ¯æå®ææ¨å¹¿ååäº«çC#/.NET/.NET Coreä¼ç§é¡¹ç®åæ¡æ¶ï¼æ¯å¨è³å°ä¼æ¨èä¸¤ä¸ªä¼ç§çé¡¹ç®åæ¡æ¶å½ç¶èåæ¥é¤å¤ï¼ï¼å¬ä¼å·æ¨æä¸­æé¡¹ç®åæ¡æ¶çè¯¦ç»ä»ç»ãåè½ç¹ç¹ãä½¿ç¨æ¹å¼ä»¥åé¨ååè½æªå¾ç­ï¼æä¸å¼æèæå¼GitHubå¾æ¢çåå­¦å¯ä»¥ä¼åæ¥çå¬ä¼å·æ¨æï¼ææ«ä¸å®ä¼éå¸¦é¡¹ç®åæ¡æ¶æºç å°åï¼ãæ³¨æï¼æåä¸åååï¼é½æ¯ååä¼ç§çå¼æºé¡¹ç®åæ¡æ¶ï¼æ¯å¨å®ææ´æ°åäº«<span>ã</span></span></p>
<ul class="list-paddingleft-1">
<li><strong>ð¡ç®æ¥Giteeå¼æºå°åï¼<a href="https://gitee.com/ysgdaydayup/DotNetGuide/blob/main/docs/DotNet/DotNetProjectMonthly.md" target="_blank" rel="noopener nofollow">https://gitee.com/ysgdaydayup/DotNetGuide/blob/main/docs/DotNet/DotNetProjectMonthly.md</a></strong></li>
<li><strong>ðç®æ¥GitHubå¼æºå°åï¼<a href="https://github.com/YSGStudyHards/DotNetGuide/blob/main/docs/DotNet/DotNetProjectMonthly.md" target="_blank" rel="noopener nofollow">https://github.com/YSGStudyHards/DotNetGuide/blob/main/docs/DotNet/DotNetProjectMonthly.md</a></strong></li>
</ul>
<h2 data-tool="mdniceç¼è¾å¨"><span>FlaUI</span></h2>
<ul class="list-paddingleft-1">
<li><strong>é¡¹ç®ç®ä»ï¼</strong><span>&nbsp;FlaUI æ¯ä¸ä¸ª .NET å¼æºåè´¹ï¼<span>MIT licenseï¼ãåè½å¼ºå¤§ ç UI èªå¨ååºï¼ä¸ä¸º Windows æ¡é¢åºç¨ç¨åºï¼å¦ Win32ãWinFormsãWPFãStore Apps ç­åºç¨ï¼çèªå¨åæµè¯èè®¾è®¡ãè¯¥é¡¹ç®åºäº Microsoft çåç UI Automation åºæå»ºï¼å¹¶ä½ä¸ºè¿äºåºçå°è£å¨ï¼æä¾äºä¸°å¯çåè½åçµæ´»ç APIï¼ä»¥ä¾¿å¼åèè½å¤é«æå°ç¼åèªå¨åæµè¯èæ¬ã</span></span></li>
<li><strong>é¡¹ç®æºç å°åï¼</strong>&nbsp;<a href="https://github.com/FlaUI/FlaUI" target="_blank" rel="noopener nofollow">https://github.com/FlaUI/FlaUI</a></li>
<li><strong>é¡¹ç®è¯¦ç»ä»ç»ï¼</strong><span><a class="normal_text_link mp_article_text_link" href="https://mp.weixin.qq.com/s?__biz=MzIxMTUzNzM5Ng==&amp;mid=2247518968&amp;idx=1&amp;sn=5bdf3e28f94e488bdf752f9bb8c8898f&amp;scene=21#wechat_redirect" target="_blank" data-linktype="2" rel="noopener nofollow">https://mp.weixin.qq.com/s/PE4S-fUyeG7U8Z78NYu6Rw</a></span></li>
</ul>
<p><img src="https://img2024.cnblogs.com/blog/1336199/202601/1336199-20260105205745833-718718878.png" alt="image" loading="lazy"></p>
<p><img src="https://img2024.cnblogs.com/blog/1336199/202512/1336199-20251222211450021-574322057.png" alt="image" loading="lazy"></p>
<h2 data-tool="mdniceç¼è¾å¨"><span>RuYiAdmin</span></h2>
<ul class="list-paddingleft-1">
<li><strong>é¡¹ç®ç®ä»ï¼</strong><span>&nbsp;RuYiAdmin ä¸æ¬¾åºäº .NET 9 æå»ºçä¼ä¸çº§ãååç«¯åç¦»ãå¼æºï¼Apache Licenseï¼ Web RBAC å¿«éå¼åæ¡æ¶ï¼å·æçµæ´»çæ¶æè®¾è®¡åå¼ºå¤§çåè½ï¼éç¨äºå¿«éå¼åé«æ§è½çä¼ä¸çº§åºç¨ï¼å·æä½ä»£ç ãè·¨å¹³å°ãåå¸å¼ãå¤çº¿ç¨åé«æ§è½ç­ç¹è²ã</span></li>
<li><strong>é¡¹ç®æºç å°åï¼</strong>&nbsp;<a href="https://gitee.com/pang-mingjun/RuYiAdmin" target="_blank" rel="noopener nofollow">https://gitee.com/pang-mingjun/RuYiAdmin</a></li>
<li><strong>é¡¹ç®è¯¦ç»ä»ç»ï¼</strong><span><a class="normal_text_link mp_article_text_link" href="https://mp.weixin.qq.com/s?__biz=MzIxMTUzNzM5Ng==&amp;mid=2247519045&amp;idx=1&amp;sn=e623f3c2c7adcc07fba70b65d13a38b2&amp;scene=21#wechat_redirect" target="_blank" data-linktype="2" rel="noopener nofollow">https://mp.weixin.qq.com/s/XCcbLiV8Dhb9pfp8wi-Teg</a></span></li>
</ul>
<p><img src="https://img2024.cnblogs.com/blog/1336199/202601/1336199-20260105205853857-1849985119.png" alt="image" loading="lazy"></p>
<p><img src="https://img2024.cnblogs.com/blog/1336199/202601/1336199-20260105205859134-1945950810.png" alt="image" loading="lazy"></p>
<p><img src="https://img2024.cnblogs.com/blog/1336199/202601/1336199-20260105205908099-602806087.png" alt="image" loading="lazy"></p>
<h2 data-tool="mdniceç¼è¾å¨"><span>CxFlatUI</span></h2>
<ul class="list-paddingleft-1">
<li><strong>é¡¹ç®ç®ä»ï¼</strong><span>&nbsp;CxFlatUI æ¯ä¸æ¬¾å¼æºï¼Apache Licenseï¼ãç°ä»£åç WinForm UI æ§ä»¶åºï¼å¼å¾å¤§å®¶åèå­¦ä¹ ä½¿ç¨ã</span></li>
<li><strong>é¡¹ç®æºç å°åï¼</strong>&nbsp;<a href="https://github.com/HuJinguang/CxFlatUI" target="_blank" rel="noopener nofollow">https://github.com/HuJinguang/CxFlatUI</a></li>
<li><strong>é¡¹ç®è¯¦ç»ä»ç»ï¼</strong><span><a class="normal_text_link mp_article_text_link" href="https://mp.weixin.qq.com/s?__biz=MzIxMTUzNzM5Ng==&amp;mid=2247518782&amp;idx=1&amp;sn=062e8d80f2798c045ed84af4402503ef&amp;scene=21#wechat_redirect" target="_blank" data-linktype="2" rel="noopener nofollow">https://mp.weixin.qq.com/s/g1O4ngtrrFpS8yrDWbYz5A</a></span></li>
</ul>
<p><img src="https://img2024.cnblogs.com/blog/1336199/202601/1336199-20260105205930598-1899511103.png" alt="image" loading="lazy"></p>
<p><img src="https://img2024.cnblogs.com/blog/1336199/202601/1336199-20260105205936788-530387827.png" alt="image" loading="lazy"></p>
<h2 data-tool="mdniceç¼è¾å¨"><span>TypedSql</span></h2>
<ul class="list-paddingleft-1">
<li><strong>é¡¹ç®ç®ä»ï¼</strong><span>&nbsp;TypedSQL æ¯ä¸ä¸ªå°åå®éªæ§ç±» SQL æ¥è¯¢å¼æï¼å¶æ§è¡è®¡åä¾èµäº C# ç±»åç³»ç»ãæ¯ä¸ªæ¥è¯¢é½åæç± Where / Select / Stop èç¹æå»ºçå°é­æ³åç±»åï¼å®å¨éè¿éææ¹æ³è¿è¡ï¼å æ­¤ç­è·¯å¾ä¸­æ²¡æèææ´¾é£æè¡¨è¾¾å¼æ è§£éã</span></li>
<li><strong>é¡¹ç®æºç å°åï¼</strong>&nbsp;<a href="https://github.com/hez2010/TypedSql" target="_blank" rel="noopener nofollow">https://github.com/hez2010/TypedSql</a></li>
<li><strong>é¡¹ç®è¯¦ç»ä»ç»ï¼</strong><span><a class="normal_text_link mp_article_text_link" href="https://mp.weixin.qq.com/s?__biz=MzIxMTUzNzM5Ng==&amp;mid=2247518856&amp;idx=1&amp;sn=3a2dfb720ffa6eb3167540f307ea5bc1&amp;scene=21#wechat_redirect" target="_blank" data-linktype="2" rel="noopener nofollow">https://mp.weixin.qq.com/s/WkS6qjDslM2UWDdjpQsjuw</a></span></li>
</ul>
<p><img src="https://img2024.cnblogs.com/blog/1336199/202601/1336199-20260105210006154-1881076622.png" alt="image" loading="lazy"></p>
<h2 data-tool="mdniceç¼è¾å¨"><span>OfficeInterop</span></h2>
<ul class="list-paddingleft-1">
<li><strong>é¡¹ç®ç®ä»ï¼</strong><span>&nbsp;OfficeInterop æ¯ä¸ä¸ªéå¯¹ Microsoft Office åºç¨ç¨åºç .NET å°è£åºï¼å¶æ ¸å¿ç®æ æ¯ç®å Office COM ç»ä»¶çä½¿ç¨ï¼ä½¿å¼åèè½å¤æ´æ¹ä¾¿ãæ´é«æå°å¨ .NET ç¯å¢ä¸­æä½ Office åºç¨ç¨åºï¼å¦ ExcelãWord ç­ã</span></li>
<li><strong>é¡¹ç®æºç å°åï¼</strong>&nbsp;<a href="https://gitee.com/mudtools/OfficeInterop" target="_blank" rel="noopener nofollow">https://gitee.com/mudtools/OfficeInterop</a></li>
<li><strong>é¡¹ç®è¯¦ç»ä»ç»ï¼</strong><span><a class="normal_text_link mp_article_text_link" href="https://mp.weixin.qq.com/s?__biz=MzIxMTUzNzM5Ng==&amp;mid=2247519132&amp;idx=1&amp;sn=30d44be5bd462bdee250a3c7b2b9861e&amp;scene=21#wechat_redirect" target="_blank" data-linktype="2" rel="noopener nofollow">https://mp.weixin.qq.com/s/SOJdHwrP-X1suv0v8PNEcg</a></span></li>
</ul>
<p><img src="https://img2024.cnblogs.com/blog/1336199/202601/1336199-20260105210024912-785737110.png" alt="image" loading="lazy"></p>
<h2 data-tool="mdniceç¼è¾å¨"><span>SuperSocket</span></h2>
<ul class="list-paddingleft-1">
<li><strong>é¡¹ç®ç®ä»ï¼</strong><span>&nbsp;SuperSocket æ¯ä¸ä¸ªé«æ§è½ãå¯æ©å±ç.NET å¥æ¥å­æå¡å¨åºç¨ç¨åºæ¡æ¶ãå®æä¾äºä¸ä¸ªå¼ºå¤§çæ¶æï¼ç¨äºæå»ºèªå®ä¹ç½ç»éä¿¡åºç¨ç¨åºï¼æ¯æå¤ç§åè®®ï¼åæ¬ TCPãUDP å WebSocketã</span></li>
<li><strong>é¡¹ç®æºç å°åï¼</strong>&nbsp;<a href="https://gitee.com/kerryjiang/SuperSocket" target="_blank" rel="noopener nofollow">https://gitee.com/kerryjiang/SuperSocket</a></li>
<li><strong>é¡¹ç®è¯¦ç»ä»ç»ï¼</strong><span><a class="normal_text_link mp_article_text_link" href="https://mp.weixin.qq.com/s?__biz=MzIxMTUzNzM5Ng==&amp;mid=2247518786&amp;idx=1&amp;sn=08b980a157a9b52619988321e264ee92&amp;scene=21#wechat_redirect" target="_blank" data-linktype="2" rel="noopener nofollow">https://mp.weixin.qq.com/s/oNA-dDh80e-WI__9Itf2JA</a></span></li>
</ul>
<p><img src="https://img2024.cnblogs.com/blog/1336199/202601/1336199-20260105210044135-102801096.png" alt="image" loading="lazy"></p>
<p><img src="https://img2024.cnblogs.com/blog/1336199/202601/1336199-20260105210049143-538169729.png" alt="image" loading="lazy"></p>
<h2 data-tool="mdniceç¼è¾å¨"><span>SVGImage</span></h2>
<ul class="list-paddingleft-1">
<li><strong>é¡¹ç®ç®ä»ï¼</strong><span>&nbsp;SVGImage æ¯ä¸ä¸ªä¸º WPFï¼Windows Presentation Foundationï¼åºç¨ç¨åºè®¾è®¡ãå¼æºï¼MIT licenseï¼ãåè´¹ç SVGï¼Scalable Vector Graphicsï¼å¾åæ¥çæ§ä»¶ã</span></li>
<li><strong>é¡¹ç®æºç å°åï¼</strong>&nbsp;<a href="https://github.com/dotnetprojects/SVGImage" target="_blank" rel="noopener nofollow">https://github.com/dotnetprojects/SVGImage</a></li>
<li><strong>é¡¹ç®è¯¦ç»ä»ç»ï¼</strong><span><a class="normal_text_link mp_article_text_link" href="https://mp.weixin.qq.com/s?__biz=MzIxMTUzNzM5Ng==&amp;mid=2247519009&amp;idx=1&amp;sn=ed66ac9347dfd77bb102c8c2df546eab&amp;scene=21#wechat_redirect" target="_blank" data-linktype="2" rel="noopener nofollow">https://mp.weixin.qq.com/s/69x0B6jhYja58Ze0NSi9ew</a></span></li>
</ul>
<p><img src="https://img2024.cnblogs.com/blog/1336199/202601/1336199-20260105210112231-249466901.png" alt="image" loading="lazy"></p>
<p><img src="https://img2024.cnblogs.com/blog/1336199/202601/1336199-20260105210117130-1247635100.png" alt="image" loading="lazy"></p>
</div>
<div id="MySignature" role="contentinfo">
    <blockquote>
<p style="font-family:YouYuan;font-size: 16px;margin: 0 auto 0.01em auto;"><span style="font-size: 17px; ">ä½èåç§°ï¼</span><a href="https://www.cnblogs.com/Can-daydayup/" target="_blank">è¿½éæ¶åè</a></p>
<p style="font-family:YouYuan;font-size: 16px;margin: 0 auto 0.01em auto;"><span style="font-size: 17px; ">ä½èç®ä»ï¼</span>ä¸ä¸ªç­ç±ç¼ç¨ãåäºåäº«ãåæ¬¢å­¦ä¹ ãæ¢ç´¢ãå°è¯æ°äºç©åæ°ææ¯çå¨æ è½¯ä»¶å·¥ç¨å¸ã</p>
<p style="font-family:YouYuan;font-size: 16px;margin: 0 auto 0.01em auto;">
æ¬æçæå½ä½èååå®¢å­å±æï¼æ¬¢è¿è½¬è½½ï¼ä½æªç»ä½èåæå¿é¡»ä¿çæ­¤æ®µå£°æï¼ä¸å¨æç« é¡µé¢ææ¾ä½ç½®ç»åºåæé¾æ¥ï¼å¦åä¿çè¿½ç©¶æ³å¾è´£ä»»çæå©ãå¦æè¯¥ç¯æç« å¯¹æ¨æå¸®å©çè¯ï¼å¯ä»¥ç¹ä¸ä¸å³ä¸è§ç<a onclick="votePost(cb_entryId,'Digg')" href="javascript:void(0)" style="color:red;">ãâ¥æ¨èâ¥ã</a>ï¼å¸æè½å¤æç»­çä¸ºå¤§å®¶å¸¦æ¥å¥½çææ¯æç« ï¼æä¸­å¯è½å­å¨æè¿°ä¸æ­£ç¡®çå°æ¹ï¼æ¬¢è¿ææ­£æè¡¥åï¼ä¸èææ¿ã
</p>
</blockquote>
</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-01-05 21:02">2026-01-05 21:01</span>&nbsp;
<a href="https://www.cnblogs.com/Can-daydayup">è¿½éæ¶åè</a>&nbsp;
éè¯»(<span id="post_view_count">19</span>)&nbsp;
è¯è®º(<span id="post_comment_count">1</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19444711);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19444711', targetLink: 'https://www.cnblogs.com/Can-daydayup/p/19444711', title: 'C#/.NET/.NET Coreä¼ç§é¡¹ç®åæ¡æ¶2025å¹´12æç®æ¥' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
        </channel>
        </rss>