<?xml version="1.0" encoding="UTF-8" ?>
    <rss version="2.0">
    <channel>
        <title><![CDATA[ ä¸»é¡µ - åå®¢å­ ]]></title>
        <link><![CDATA[ https://www.cnblogs.com/ ]]></link>
        <lastBuildDate>2026-02-13T01:51:33.113Z</lastBuildDate>
        <description><![CDATA[
        ä¸»é¡µ - åå®¢å­ RSS
    ]]></description>
        <language>zh-cn</language>
        <item>
    <title><![CDATA[ AI ç»å¾å¨å®¶æ¡¶æ¥äºï¼è¿åæ³èªå·±æç»å¾é½é¾äº ]]></title>
    <link>https://www.cnblogs.com/chengxy-nds/p/19610998</link>
    <guid>ee1c31a5d9c3d134d1c6b8d5682a0597</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/chengxy-nds/p/19610998" title="åå¸äº 2026-02-13 09:48">
    <span role="heading" aria-level="2">AI ç»å¾å¨å®¶æ¡¶æ¥äºï¼è¿åæ³èªå·±æç»å¾é½é¾äº</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<p><strong>å¤§å®¶å¥½ï¼ææ¯å°å¯ï½</strong></p>
<p>åå å¤©æä¸æ¯åäº«äºå¦ä½é¶ææ¬æ­å»º <strong>next-ai-draw-io</strong>ï¼æå¤§å®¶ç¨ AI çæ draw.io é£æ ¼çæ¶æå¾ãåå°ååè¿ä¸éï¼çæ¥å¤§å®¶å¯¹æç»æ¶æå¾ççæ¯è¦ä¹ä¹ç£ã</p>
<p><img src="http://fire-blog.oss-cn-beijing.aliyuncs.com/20251229-160034.gif" alt="" loading="lazy"></p>
<p>ä½å¨æ¥å¸¸åæç« æ¶ï¼æåç°å¾å¤è¯»èæ´åç±é£ç§æç»æåè¶³ç <strong>Excalidraw</strong> é£æ ¼ï¼å°±æ¯ä¸é¢è¿ç§ï¼é¼æ ¼é«ãè§è§ç¾ï¼è½è®©æç« ç¬é´æ¾å¾é«çº§èµ·æ¥ï¼</p>
<p><img src="http://fire-blog.oss-cn-beijing.aliyuncs.com//images/20260203151400.png" alt="" loading="lazy"></p>
<p>æåæ¬å¨ç¢ç£¨ï¼è½ä¸è½ç¨ Gemini Pro ç»èªå·±æä¸ä¸ª AI ç»å¾æ´åå¹³å°ï¼æ draw.io å Excalidraw å¨æè¿å»ã</p>
<p>ç»æå» GitHub ä¸æï¼å¥½å®¶ä¼ï¼å·²ç»æå¤§ä½¬æææ³åçç»åäºï¼è¿ä¸ªå¼æºé¡¹ç®ç®ç´æ¯ä¸ºæè¿ç§æçåä¸»éèº«å®å¶çï¼<strong>Mermaidãdraw.ioãExcalidraw</strong> ä¸å¤§ççé£æ ¼å¨é¨æ¯æã</p>
<p>åå¤´åççä»¥åä¸ºäºç»ä¸ªåçå¾ç¬å¤çæ ·å­ï¼ççæè§æ¯å¨æµªè´¹çå½åï¼</p>
<h4 id="ai-draw-nexus-ai-ç»å¾å¨å®¶æ¡¶">AI Draw Nexus AI ç»å¾å¨å®¶æ¡¶</h4>
<p><strong>GitHub å°å</strong>ï¼<code>https://github.com/hkxiaoyao/ai-draw-nexus</code></p>
<p><strong>å¨çº¿ä½éª</strong>ï¼<code>https://ai-draw-nexus.aizhi.site/</code></p>
<p>ææ¨ä¸ªè¯äºä¸éï¼å¤§å®¶æåä¸è¿è¾åºè´¨éï¼</p>
<p><strong>1. Excalidraw é£æ ¼</strong></p>
<p>è¾å¥: HTTP é¿è½®è¯¢åçå¾ï¼çæçé»è¾çº¿æ¡æ¸æ°ï¼æç»è´¨æçæ£ã</p>
<p><img src="http://fire-blog.oss-cn-beijing.aliyuncs.com//images/20260203152428.png" alt="" loading="lazy"></p>
<p><strong>2. Draw.io é£æ ¼</strong></p>
<p>æä¹åå¾å¤çç³»ç»æ¶æãæµç¨å¾é½æ¯è¿ä¸ªé£æ ¼ï¼ç°å¨ AI å æççå¤ªæ¹ä¾¿äºã</p>
<p><img src="http://fire-blog.oss-cn-beijing.aliyuncs.com//images/20260203153031.png" alt="" loading="lazy"></p>
<p><strong>3. Mermaid é£æ ¼</strong></p>
<p>å Markdown å°±æ´ç®åäºä¸ç§åºå¾ã</p>
<p><img src="http://fire-blog.oss-cn-beijing.aliyuncs.com//images/20260203153451.png" alt="" loading="lazy"></p>
<p>è¿ä¸æ¯åè½éå²çï¼èæ¯å¨éçï¼å¯ä»¥å¨ AI çæçåºç¡ä¸ï¼ç´æ¥æå¨å¾®è°ã</p>
<h4 id="å¿«éä¸æ">å¿«éä¸æ</h4>
<p>å¦æä½ æ³æ¬å°è¿è¡ï¼è¿ä¸ªåºäº Next.js çåç«¯é¡¹ç®å®è£èµ·æ¥ä¹éå¸¸ç®åï¼</p>
<pre><code class="language-shell"># 1. åéé¡¹ç®
git clone https://github.com/hkxiaoyao/ai-draw-nexus
cd ai-draw-nexus

# 2. å®è£ä¾èµ (æ¨èç¨ pnpm)
pnpm install

# 3. å¼å¯çäº§åå¤§é¨
pnpm dev
</code></pre>
<p>ä¸è¿ï¼ç®åçå¨çº¿çæ¬æ¯å¤©æ 10 æ¬¡åè´¹éé¢ï¼è¿ä¹å¾æ­£å¸¸æ¯ç« API çº¿ä¸çè´¹ç¨ç¡®å®è´µï¼ä¸æ¬¡æé£ä¸ªåè´¹å·¥å·è¢«å¤§å®¶ä¸¤å¤©å°±ç¨æ¬ è´¹äºï¼åå ðï¼ã</p>
<p><img src="http://fire-blog.oss-cn-beijing.aliyuncs.com//images/20260203152800.png" alt="" loading="lazy"></p>
<p>ç°å¨ä»æ¯æ <strong>OpenAI</strong> å <strong>Anthropic</strong> ä¸¤å¤§æ¨¡åãå¦æä½ æèªå·±ç Keyï¼å»ºè®®æ¬å°æ­ä¸ä¸ªï¼é£ææ¯çæ­£çç»å¾èªç±ï¼</p>
<p>å¥½äºï¼ä¸æè§ï½</p>


</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-02-13 09:48">2026-02-13 09:48</span>&nbsp;
<a href="https://www.cnblogs.com/chengxy-nds">ç¨åºåå°å¯</a>&nbsp;
éè¯»(<span id="post_view_count">0</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19610998);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19610998', targetLink: 'https://www.cnblogs.com/chengxy-nds/p/19610998', title: 'AI ç»å¾å¨å®¶æ¡¶æ¥äºï¼è¿åæ³èªå·±æç»å¾é½é¾äº' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ ä¸æ¬¾Goè¯­è¨Ginæ¡æ¶DDDèææ¶ï¼éåå¿«éæ­å»ºé¡¹ç® ]]></title>
    <link>https://www.cnblogs.com/letjs/p/19610915</link>
    <guid>f19137d637f8433bec18d1d3b9522b61</guid>
    <description>
    <![CDATA[ 
		<h1 class="postTitle">
			<a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/letjs/p/19610915" title="åå¸äº 2026-02-13 09:19">
    <span role="heading" aria-level="2">ä¸æ¬¾Goè¯­è¨Ginæ¡æ¶DDDèææ¶ï¼éåå¿«éæ­å»ºé¡¹ç®</span>
    

</a>

		</h1>
		<div class="clear"></div>
		<div class="postBody">
			<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h1 id="ä¸æ¬¾goè¯­è¨ginæ¡æ¶dddèææ¶éåå¿«éæ­å»ºé¡¹ç®">ä¸æ¬¾Goè¯­è¨Ginæ¡æ¶DDDèææ¶ï¼éåå¿«éæ­å»ºé¡¹ç®</h1>
<blockquote>
<p>ä¸ä¸ªå¼ç®±å³ç¨ç DDDï¼é¢åé©±å¨è®¾è®¡ï¼Go èææ¶ï¼åºäº Gin + RocketMQï¼åå«åæ°æ®åºãç»ä¸ååºãä¸­é´ä»¶ä¸äºä»¶é©±å¨ç¤ºä¾ã</p>
</blockquote>
<h2 id="è¿æ¯ä»ä¹">è¿æ¯ä»ä¹</h2>
<p>Gin-Framework-DDD æ¯ä¸ä¸ªé¢å Go è¯­è¨ç DDD å·¥ç¨èææ¶ï¼å¸®ä½ å¿«éæ­å»ºç¬¦å DDD åå±è§èç Web æå¡ãé¡¹ç®åç½®ç¨æ·ä¸è®¢åç¤ºä¾ãé¢åäºä»¶ä¸ RocketMQ çäº§/æ¶è´¹ãé®ä»¶éç¥ç¤ºä¾ãç»ä¸ååºä¸ä¸­é´ä»¶ï¼éåä½ä¸ºå¢éå·¥ç¨æ¨¡æ¿ææå­¦ç¤ºä¾ã</p>
<h2 id="ä¸ºä»ä¹è¦ç¨ddd">ä¸ºä»ä¹è¦ç¨DDDï¼</h2>
<p>å¾å¤äººè®¤ä¸º Go è¯­è¨æ²¡å¿è¦ç¨ DDDï¼æ¯ç«å®å PythonãJS ä¸æ ·è½»å·§çµæ´»ï¼ç¨ MVC å°±è¶³å¤äºãç¡®å®ï¼å¤§å¤æ°åºæ¯ä¸ MVC å®å¨å¤ç¨ãå·¥ç¨åæ éæ¯ææ¥å£å¤çãä¸å¡é»è¾ãæ°æ®å¤çåºåå¼ï¼è®©åé¨ååå¸å¶èï¼æ¹ä¾¿ç»´æ¤åæ©å±ãDDD ç¸å¯¹æ´éåä¸­å¤§åé¡¹ç®ï¼å¦æé¡¹ç®æå åä¸ªæ¨¡åãä¸ç¾ä¸ªæ¥å£ï¼ç¨ DDD è®¾è®¡ä¼æ´åéï¼æ¨¡åå°ãæ¥å£ä¸å¤çè¯ï¼ç®ååå±å°±å¤äºã</p>
<p>æ»ä¹ï¼æ¯å¦éç¨ DDD åè¯­è¨æ å³ï¼åªè·ä¸å¡è§æ¨¡æå³ãä¸ä¸ªä¸è¥¿åå¤æäºï¼å°±éè¦ç¨ä¸äºæºå¶å»è§èå®ï¼æè½æ´å¥½ææ§ã</p>
<p>æºç å°åï¼<a href="https://github.com/microwind/design-patterns/tree/main/practice-projects/gin-ddd" target="_blank" rel="noopener nofollow">https://github.com/microwind/design-patterns/tree/main/practice-projects/gin-ddd</a></p>
<p>é¡¹ç®ç®å½ï¼<code>gin-ddd/</code></p>
<h2 id="æ ¸å¿ç¹ç¹">æ ¸å¿ç¹ç¹</h2>
<ul>
<li>ä¸¥æ ¼ DDD åå±æ¶æï¼é¢åå±ãåºç¨å±ãåºç¡è®¾æ½å±ãæ¥å£å±</li>
<li>Gin Web æ¡æ¶ï¼é«æ§è½ HTTP æå¡</li>
<li>äºä»¶é©±å¨ï¼é¢åäºä»¶ + RocketMQ çäº§è/æ¶è´¹è</li>
<li>åæ°æ®åºæ¯æï¼ç¨æ·åº + è®¢ååºå¯ç¬ç«éç½®ï¼é»è®¤ MySQL + PostgreSQLï¼</li>
<li>ç»ä¸ååºæ ¼å¼ï¼Response å°è£ï¼éè¯¯ç éä¸­ç®¡ç</li>
<li>å¨å±ä¸­é´ä»¶ï¼æ¥å¿ãæ¢å¤ãè·¨å</li>
<li>å¯éé®ä»¶éç¥ï¼è®¢ååå»ºäºä»¶é©±å¨ SMTP é®ä»¶åé</li>
</ul>
<h2 id="ææ¯æ ">ææ¯æ </h2>
<table>
<thead>
<tr>
<th>ææ¯</th>
<th>çæ¬</th>
<th>è¯´æ</th>
</tr>
</thead>
<tbody>
<tr>
<td>Go</td>
<td>1.21+</td>
<td>è¯­è¨çæ¬</td>
</tr>
<tr>
<td>Gin</td>
<td>1.9+</td>
<td>HTTP æ¡æ¶</td>
</tr>
<tr>
<td>RocketMQ</td>
<td>5.3+</td>
<td>äºä»¶æ¶æ¯éå</td>
</tr>
<tr>
<td>MySQL</td>
<td>8.0+</td>
<td>ç¨æ·åºé»è®¤</td>
</tr>
<tr>
<td>PostgreSQL</td>
<td>14+</td>
<td>è®¢ååºé»è®¤</td>
</tr>
<tr>
<td>YAML</td>
<td>-</td>
<td>éç½®æä»¶æ ¼å¼</td>
</tr>
</tbody>
</table>
<h2 id="å·¥ç¨ç»æ">å·¥ç¨ç»æ</h2>
<h3 id="å·¥ç¨ç»æå¾">å·¥ç¨ç»æå¾</h3>
<div class="mermaid">flowchart TB
    subgraph æ¥å£å±
        Handler[HTTP Handler / è·¯ç±]
    end

    subgraph åºç¨å±
        AppService[åºç¨æå¡]
    end

    subgraph é¢åå±
        DomainService[é¢åæå¡]
        Model[èåæ ¹/å®ä½]
        RepoInterface[ä»å¨æ¥å£]
        NotificationInterface[éç¥æ¥å£]
    end

    subgraph åºç¡è®¾æ½å±
        RepoImpl[ä»å¨å®ç°]
        Mail[é®ä»¶æå¡]
        MQ[æ¶æ¯éå]
        DB[(æ°æ®åº)]
    end

    Handler --&gt; AppService
    AppService --&gt; DomainService
    AppService --&gt; RepoInterface
    DomainService --&gt; Model
    DomainService --&gt; NotificationInterface
    RepoInterface -.å®ç°.-&gt; RepoImpl
    NotificationInterface -.å®ç°.-&gt; Mail
    RepoImpl --&gt; DB
    AppService -.åå¸äºä»¶.-&gt; MQ
</div><h3 id="å·¥ç¨ç»æåè¡¨">å·¥ç¨ç»æåè¡¨</h3>
<pre><code>gin-ddd/
âââ cmd/server/main.go                            # å¯å¨å¥å£ï¼è£éåå±å¹¶å¯å¨ HTTP + MQ
âââ config/config.yaml                            # åºç¨éç½®
âââ docs/init.sql                                 # MySQL åå§åèæ¬ï¼ç¤ºä¾ï¼
âââ internal/
â   âââ domain/                                   # é¢åå±
â   â   âââ model/
â   â   â   âââ order/order.go                    # è®¢åèåæ ¹
â   â   â   âââ user/user.go                      # ç¨æ·èåæ ¹
â   â   âââ repository/                           # ä»å¨æ¥å£
â   â   â   âââ order/order_repository.go
â   â   â   âââ user/user_repository.go
â   â   âââ event/                                # é¢åäºä»¶
â   â   â   âââ domain_event.go
â   â   â   âââ order_event.go
â   â   â   âââ user_event.go
â   â   â   âââ event_publisher.go
â   â   âââ notification/mail_service.go          # éç¥é¢åæ¥å£ï¼é®ä»¶ï¼
â   â   âââ service/                              # é¢åæå¡ï¼é¢çï¼
â   âââ application/                              # åºç¨å±
â   â   âââ dto/
â   â   â   âââ order/order_dto.go
â   â   â   âââ user/user_dto.go
â   â   âââ service/
â   â       âââ order/order_service.go            # è®¢ååºç¨æå¡ï¼åå¸äºä»¶ï¼
â   â       âââ user/user_service.go              # ç¨æ·åºç¨æå¡
â   âââ infrastructure/                           # åºç¡è®¾æ½å±
â   â   âââ config/                               # éç½®ä¸ DB åå§å
â   â   âââ persistence/                          # ä»å¨å®ç°
â   â   â   âââ order/order_repository_impl.go
â   â   â   âââ user/user_repository_impl.go
â   â   âââ mq/                                   # RocketMQ å®ç°
â   â   â   âââ rocketmq_producer.go
â   â   â   âââ rocketmq_consumer.go
â   â   âââ mail/                                 # SMTP é®ä»¶å®ç°
â   â   âââ middleware/                           # Gin ä¸­é´ä»¶
â   â   âââ common/response.go                    # ç»ä¸ååº
â   â   âââ constants/error_code.go               # éè¯¯ç 
â   âââ interfaces/                               # æ¥å£å±
â       âââ handler/                              # HTTP å¤çå¨
â       âââ router/                               # è·¯ç±éç½®
â       âââ vo/                                   # è¯·æ±/ååºå¯¹è±¡
âââ pkg/utils/                                    # æ¥å¿ç­å·¥å·
</code></pre>
<h2 id="åå±èè´£è¯´æ">åå±èè´£è¯´æ</h2>
<table>
<thead>
<tr>
<th>å±çº§</th>
<th>ä½ç½®</th>
<th>èè´£</th>
<th>å³é®åå</th>
</tr>
</thead>
<tbody>
<tr>
<td>é¢åå±</td>
<td><code>internal/domain/</code></td>
<td>é¢åæ¨¡åãè§åä¸äºä»¶</td>
<td>ä¸ä¾èµæ¡æ¶ãä¸å¡é»è¾åè</td>
</tr>
<tr>
<td>åºç¨å±</td>
<td><code>internal/application/</code></td>
<td>ç¼æé¢åå¯¹è±¡ãäºå¡è¾¹ç</td>
<td>èèæ¸æ°ï¼ä¸å®ç°ä¸å¡è§å</td>
</tr>
<tr>
<td>åºç¡è®¾æ½å±</td>
<td><code>internal/infrastructure/</code></td>
<td>DBãMQãé®ä»¶ç­ææ¯ç»è</td>
<td>åä¸æä¾å®ç°ï¼ç»èä¸æ²</td>
</tr>
<tr>
<td>æ¥å£å±</td>
<td><code>internal/interfaces/</code></td>
<td>HTTP è¯·æ±/ååºä¸è·¯ç±</td>
<td>å¤çå¤é¨äº¤äºï¼ä¸å«ä¸å¡è§å</td>
</tr>
</tbody>
</table>
<h2 id="å¿«éå¼å§">å¿«éå¼å§</h2>
<h3 id="1-ç¯å¢åå¤">1. ç¯å¢åå¤</h3>
<ul>
<li>Go 1.21+</li>
<li>MySQL 8.0+ ä¸ PostgreSQL 14+ï¼æèªè¡éæ©å¶ä¸ï¼</li>
<li>RocketMQ 5.3+ï¼å¯éï¼</li>
</ul>
<h3 id="2-åå§åæ°æ®åº">2. åå§åæ°æ®åº</h3>
<p>é»è®¤éç½®ä½¿ç¨åæ°æ®åºï¼</p>
<ul>
<li>ç¨æ·åºï¼MySQL</li>
<li>è®¢ååºï¼PostgreSQL</li>
</ul>
<p>MySQL ç¨æ·åºç¤ºä¾ï¼å¯ç´æ¥ç¨ <code>docs/init.sql</code> ä½ä¸ºèµ·ç¹ï¼ï¼</p>
<pre><code class="language-sql">CREATE DATABASE IF NOT EXISTS gin_ddd CHARACTER SET utf8mb4;
USE gin_ddd;

CREATE TABLE IF NOT EXISTS users (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(50) NOT NULL UNIQUE,
    email VARCHAR(100) NOT NULL UNIQUE,
    phone VARCHAR(20),
    created_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
</code></pre>
<p>PostgreSQL è®¢ååºç¤ºä¾ï¼ä¸å½åè®¢åä»å¨å­æ®µä¸è´ï¼ï¼</p>
<pre><code class="language-sql">CREATE DATABASE seed;
\c seed;

CREATE TABLE IF NOT EXISTS orders (
    id BIGSERIAL PRIMARY KEY,
    order_no VARCHAR(50) NOT NULL UNIQUE,
    user_id BIGINT NOT NULL,
    total_amount DECIMAL(10, 2) NOT NULL DEFAULT 0.00,
    status VARCHAR(20) NOT NULL DEFAULT 'PENDING',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);
</code></pre>
<p>æ°æ®åºééæ³¨æï¼</p>
<ul>
<li>è¥è®¢ååºæ¹ä¸º MySQLï¼éè¦å° SQL å ä½ç¬¦ä» <code>$1</code> å½¢å¼æ¹ä¸º <code>?</code></li>
<li>è¥ç¨æ·åºæ¹ä¸º PostgreSQLï¼éè¦å°æå¥ ID è·åé»è¾æ¹ä¸º <code>RETURNING id</code></li>
</ul>
<h3 id="3-éç½®åºç¨">3. éç½®åºç¨</h3>
<p>ç¼è¾ <code>config/config.yaml</code>ï¼è³å°éç½®æ°æ®åºä¸ RocketMQï¼</p>
<pre><code class="language-yaml">server:
  host: "0.0.0.0"
  port: 8080
  mode: "debug"

database:
  user:
    driver: "mysql"
    host: "localhost"
    port: 3306
    username: "root"
    password: "your_password"
    database: "gin_ddd"
  order:
    driver: "postgres"
    host: "localhost"
    port: 5432
    username: "postgres"
    password: "your_password"
    database: "seed"

rocketmq:
  enabled: true
  nameserver: "localhost:9876"
  group_name: "gin-ddd-group"
  instance_name: "gin-ddd-instance"
  topics:
    order_event: "order-event-topic"
</code></pre>
<p>è¯´æï¼</p>
<ul>
<li><code>rocketmq.enabled: true</code> æä¼åå§åçäº§èä¸æ¶è´¹è</li>
<li>å½åè®¢åäºä»¶ Topic å¨ä»£ç ä¸­ä½¿ç¨åºå®å¼ <code>order-event-topic</code>ï¼éä¸éç½®ä¿æä¸è´</li>
</ul>
<h3 id="4-å¯å¨-rocketmqå¯é">4. å¯å¨ RocketMQï¼å¯éï¼</h3>
<pre><code class="language-bash">sh bin/mqnamesrv
sh bin/mqbroker -n localhost:9876
</code></pre>
<h3 id="5-å¯å¨åºç¨">5. å¯å¨åºç¨</h3>
<pre><code class="language-bash">go mod tidy
go run cmd/server/main.go
</code></pre>
<h3 id="6-éªè¯æ¥å£">6. éªè¯æ¥å£</h3>
<pre><code class="language-bash">curl http://localhost:8080/health
curl http://localhost:8080/api/users
curl http://localhost:8080/api/orders
</code></pre>
<h2 id="å¦ä½åºäºèææ¶å¼åæ°åè½">å¦ä½åºäºèææ¶å¼åæ°åè½</h2>
<p>ç¤ºä¾ï¼æ°å¢âååç®¡çâæ¨¡å</p>
<p>æ­¥éª¤ 1ï¼æ°å¢é¢åæ¨¡å <code>internal/domain/model/product/product.go</code></p>
<pre><code class="language-go">package product

import "time"

type Product struct {
	ID        int64
	Name      string
	Price     float64
	Stock     int
	CreatedAt time.Time
	UpdatedAt time.Time
}
</code></pre>
<p>æ­¥éª¤ 2ï¼æ°å¢ä»å¨æ¥å£ <code>internal/domain/repository/product/product_repository.go</code></p>
<pre><code class="language-go">package product

import (
	"context"
	"gin-ddd/internal/domain/model/product"
)

type ProductRepository interface {
	Create(ctx context.Context, p *product.Product) error
	Update(ctx context.Context, p *product.Product) error
	FindByID(ctx context.Context, id int64) (*product.Product, error)
	FindAll(ctx context.Context) ([]*product.Product, error)
}
</code></pre>
<p>æ­¥éª¤ 3ï¼æ°å¢ä»å¨å®ç° <code>internal/infrastructure/persistence/product/product_repository_impl.go</code></p>
<pre><code class="language-go">package product

import (
	"context"
	"database/sql"
	"gin-ddd/internal/domain/model/product"
)

type ProductRepositoryImpl struct {
	db *sql.DB
}

func NewProductRepository(db *sql.DB) *ProductRepositoryImpl {
	return &amp;ProductRepositoryImpl{db: db}
}

func (r *ProductRepositoryImpl) Create(ctx context.Context, p *product.Product) error {
	_, err := r.db.ExecContext(ctx,
		`INSERT INTO products (name, price, stock, created_at, updated_at) VALUES (?, ?, ?, ?, ?)`,
		p.Name, p.Price, p.Stock, p.CreatedAt, p.UpdatedAt,
	)
	return err
}
</code></pre>
<p>æ­¥éª¤ 4ï¼æ°å¢åºç¨æå¡ <code>internal/application/service/product/product_service.go</code></p>
<pre><code class="language-go">package product

import (
	"context"
	"time"
	"gin-ddd/internal/domain/model/product"
	productDomain "gin-ddd/internal/domain/repository/product"
)

type ProductService struct {
	repo productDomain.ProductRepository
}

func NewProductService(repo productDomain.ProductRepository) *ProductService {
	return &amp;ProductService{repo: repo}
}

func (s *ProductService) Create(ctx context.Context, name string, price float64, stock int) error {
	p := &amp;product.Product{
		Name:      name,
		Price:     price,
		Stock:     stock,
		CreatedAt: time.Now(),
		UpdatedAt: time.Now(),
	}
	return s.repo.Create(ctx, p)
}
</code></pre>
<p>æ­¥éª¤ 5ï¼æ°å¢ HTTP Handler åè·¯ç±</p>
<p>å°è¯·æ±/ååºå¯¹è±¡æ¾å° <code>internal/interfaces/vo/product/</code>ï¼Handler æ¾å° <code>internal/interfaces/handler/product/</code>ï¼å¹¶å¨ <code>internal/interfaces/router/router.go</code> ä¸­æ³¨åè·¯ç±ã</p>
<p>æ­¥éª¤ 6ï¼æ°å¢æ°æ®åºè¡¨</p>
<pre><code class="language-sql">CREATE TABLE IF NOT EXISTS products (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    price DECIMAL(10, 2) NOT NULL,
    stock INT NOT NULL DEFAULT 0,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);
</code></pre>
<h2 id="äºä»¶é©±å¨ä¸-rocketmq">äºä»¶é©±å¨ä¸ RocketMQ</h2>
<h3 id="äºä»¶ç±»å">äºä»¶ç±»å</h3>
<p>è®¢åäºä»¶ï¼</p>
<ul>
<li>order.created</li>
<li>order.paid</li>
<li>order.shipped</li>
<li>order.delivered</li>
<li>order.cancelled</li>
<li>order.refunded</li>
</ul>
<p>ç¨æ·äºä»¶ï¼</p>
<ul>
<li>user.created</li>
<li>user.activated</li>
<li>user.deactivated</li>
<li>user.blocked</li>
<li>user.deleted</li>
</ul>
<h3 id="æ¶æ¯æµè½¬">æ¶æ¯æµè½¬</h3>
<pre><code>HTTP è¯·æ± -&gt; Application Service -&gt; Domain Model
            -&gt; åå¸ DomainEvent -&gt; RocketMQ Producer
            -&gt; RocketMQ Broker -&gt; Consumer
            -&gt; äºä»¶å¤ç -&gt; åéé®ä»¶/è§¦ååç»­æµç¨
</code></pre>
<h3 id="äºä»¶åå¸ä¸æ¶è´¹å³é®ç¹">äºä»¶åå¸ä¸æ¶è´¹å³é®ç¹</h3>
<ul>
<li>è®¢ååå»ºåä¼åå¸ <code>order.created</code> äºä»¶ï¼åå¸å¤±è´¥ä¸ä¼å½±åä¸»æµç¨ï¼</li>
<li>æ¶è´¹ç«¯æ Tag è§£æä¸º <code>OrderEvent</code> æ <code>UserEvent</code></li>
<li>è®¢åé®ä»¶éç¥ä»å¨ <code>order.created</code> ä¸å¯ç¨é®ä»¶æ¶è§¦å</li>
</ul>
<h2 id="é®ä»¶åééç½®qq-é®ç®±">é®ä»¶åééç½®ï¼QQ é®ç®±ï¼</h2>
<p>å¨ <code>config/config.yaml</code> ä¸­å¼å¯é®ä»¶éç½®ï¼</p>
<pre><code class="language-yaml">mail:
  enabled: true
  host: "smtp.qq.com"
  port: 465
  username: "your@qq.com"
  password: "ä½ çSMTPææç "
  from_email: "your@qq.com"
  from_name: "è®¢åç³»ç»"
</code></pre>
<p>æ³¨æäºé¡¹ï¼</p>
<ul>
<li>å¿é¡»ä½¿ç¨ SMTP ææç ï¼ä¸æ¯ QQ ç»å½å¯ç </li>
<li>ç«¯å£ 465 ä½¿ç¨ TLSï¼ç«¯å£ 587 ä½¿ç¨ STARTTLS</li>
<li>æ¶ä»¶äººåèªç¨æ·è¡¨ä¸­ç <code>email</code> å­æ®µ</li>
</ul>
<h2 id="å¸¸è§é®é¢ææ¥">å¸¸è§é®é¢ææ¥</h2>
<ul>
<li>æ¥å¿æç¤ºâäºä»¶åå¸å¨æªåå§åâï¼RocketMQ æªå¯ç¨æåå§åå¤±è´¥</li>
<li>è®¢åäºä»¶å·²åéä½é®ä»¶æªå°ï¼ç¡®è®¤ç¨æ·é®ç®±å­æ®µæ­£ç¡®ï¼ä¸ SMTP ææç å¯ç¨</li>
<li>æ¶è´¹èæ²¡ææ¶å°æ¶æ¯ï¼ç¡®è®¤ Topic ä¸ Tag æ­£ç¡®ãBroker å¯å¨æ­£å¸¸</li>
</ul>
<h2 id="å¼åè§è">å¼åè§è</h2>
<p>å½åå»ºè®®ï¼</p>
<ul>
<li>é¢åæ¨¡åï¼åè¯ï¼å¦ <code>Order</code>ã<code>User</code></li>
<li>åºç¨æå¡ï¼<code>XxxService</code></li>
<li>ä»å¨æ¥å£ï¼<code>XxxRepository</code></li>
<li>ä»å¨å®ç°ï¼<code>XxxRepositoryImpl</code></li>
<li>Handlerï¼<code>XxxHandler</code></li>
</ul>
<p>åå±ååï¼</p>
<ul>
<li>é¢åå±ä¸ä¾èµåºç¡è®¾æ½</li>
<li>åºç¨å±åªåç¼æä¸äºå¡åè°</li>
<li>åºç¡è®¾æ½æä¾ææ¯å®ç°</li>
<li>æ¥å£å±åªè´è´£ HTTP äº¤äº</li>
</ul>
<h2 id="å¸¸ç¨å½ä»¤">å¸¸ç¨å½ä»¤</h2>
<pre><code class="language-bash">go mod tidy
go test ./...
</code></pre>
<h2 id="æºç å°å">æºç å°å</h2>
<p><a href="https://github.com/microwind/design-patterns/tree/main/practice-projects/gin-ddd" target="_blank" rel="noopener nofollow">https://github.com/microwind/design-patterns/tree/main/practice-projects/gin-ddd</a></p>


</div>
<div class="clear"></div>

		</div>
		<div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-02-13 09:19">2026-02-13 09:19</span>&nbsp;
<a href="https://www.cnblogs.com/letjs">åæ³å¦é£</a>&nbsp;
éè¯»(<span id="post_view_count">32</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19610915);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19610915', targetLink: 'https://www.cnblogs.com/letjs/p/19610915', title: 'ä¸æ¬¾Goè¯­è¨Ginæ¡æ¶DDDèææ¶ï¼éåå¿«éæ­å»ºé¡¹ç®' })">ä¸¾æ¥</a>
</div>
	 ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ LockSupportæ·±åº¦è§£æï¼çº¿ç¨é»å¡ä¸å¤éçåºå±å®ç°åç ]]></title>
    <link>https://www.cnblogs.com/sevencoding/p/19588531</link>
    <guid>925ebc26a6c7946a9df5f9471bf51786</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/sevencoding/p/19588531" title="åå¸äº 2026-02-13 09:00">
    <span role="heading" aria-level="2">LockSupportæ·±åº¦è§£æï¼çº¿ç¨é»å¡ä¸å¤éçåºå±å®ç°åç</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h2 id="locksupportç®ä»">LockSupportç®ä»</h2>
<p>LockSupprot ç¨æ¥é»å¡åå¤éçº¿ç¨ï¼åºå±å®ç°ä¾èµäº&nbsp;<a href="https://www.seven97.top/java/concurrent/unsafe.html" target="_blank" rel="noopener nofollow">Unsafe ç±»</a>ã</p>
<p>LockSupportç¨æ¥åå»ºéåå¶ä»åæ­¥ç±»çåºæ¬çº¿ç¨é»å¡åè¯­ãç®èè¨ä¹ï¼å½è°ç¨LockSupport.parkæ¶ï¼è¡¨ç¤ºå½åçº¿ç¨å°ä¼ç­å¾ï¼ç´è³è·å¾è®¸å¯ï¼å½è°ç¨LockSupport.unparkæ¶ï¼å¿é¡»æç­å¾è·å¾è®¸å¯ççº¿ç¨ä½ä¸ºåæ°è¿è¡ä¼ éï¼å¥½è®©æ­¤çº¿ç¨ç»§ç»­è¿è¡ãå¨AQSä¸­å¤§éä½¿ç¨ï¼AQSæç»é½æ¯ä½¿ç¨LockSupportæ¥é»å¡çº¿ç¨çã</p>
<p>è¯¥ç±»åå«ä¸ç»ç¨äºé»å¡åå¤éçº¿ç¨çéææ¹æ³ï¼è¿äºæ¹æ³ä¸»è¦æ¯å´ç» park å unpark å±å¼ï¼è¯ä¸å¤è¯´ï¼ç´æ¥æ¥çä¸ä¸ªç®åçä¾å­å§ã</p>
<pre><code class="language-java">public class LockSupportDemo1 {
    public static void main(String[] args) {
        Thread mainThread = Thread.currentThread();

        // åå»ºä¸ä¸ªçº¿ç¨ä»1æ°å°1000
        Thread counterThread = new Thread(() -&gt; {
            for (int i = 1; i &lt;= 1000; i++) {
                System.out.println(i);
                if (i == 500) {
                    // å½æ°å°500æ¶ï¼å¤éä¸»çº¿ç¨
                    LockSupport.unpark(mainThread);
                }
            }
        });

        counterThread.start();

        // ä¸»çº¿ç¨è°ç¨park
        LockSupport.park();
        System.out.println("Main thread was unparked.");
    }
}
</code></pre>
<p>ä¸é¢çä»£ç ä¸­ï¼å½ counterThread æ°å° 500 æ¶ï¼å®ä¼å¤é mainThreadãè mainThread å¨è°ç¨ park æ¹æ³æ¶ä¼è¢«é»å¡ï¼ç´å°è¢« unparkã</p>
<p>LockSupport ä¸­çæ¹æ³ä¸å¤ï¼è¿éå°è¿äºæ¹æ³åä¸ä¸ªæ»ç»ï¼</p>
<h3 id="é»å¡çº¿ç¨">é»å¡çº¿ç¨</h3>
<ol>
<li><code>void park()</code>ï¼é»å¡å½åçº¿ç¨ï¼å¦æè°ç¨ unpark æ¹æ³æçº¿ç¨è¢«ä¸­æ­ï¼åè¯¥çº¿ç¨å°åå¾å¯è¿è¡ãè¯·æ³¨æï¼park ä¸ä¼æåº InterruptedExceptionï¼å æ­¤çº¿ç¨å¿é¡»åç¬æ£æ¥å¶ä¸­æ­ç¶æã</li>
<li><code>void park(Object blocker)</code>ï¼åè½åæ¹æ³ 1ï¼å¥åå¢å ä¸ä¸ª Object å¯¹è±¡ï¼ç¨æ¥è®°å½å¯¼è´çº¿ç¨é»å¡çå¯¹è±¡ï¼æ¹ä¾¿é®é¢ææ¥ã</li>
<li><code>void parkNanos(long nanos)</code>ï¼é»å¡å½åçº¿ç¨ä¸å®ççº³ç§æ¶é´ï¼æç´å°è¢« unpark è°ç¨ï¼æçº¿ç¨è¢«ä¸­æ­ã</li>
<li><code>void parkNanos(Object blocker, long nanos)</code>ï¼åè½åæ¹æ³ 3ï¼å¥åå¢å ä¸ä¸ª Object å¯¹è±¡ï¼ç¨æ¥è®°å½å¯¼è´çº¿ç¨é»å¡çå¯¹è±¡ï¼æ¹ä¾¿é®é¢ææ¥ã</li>
<li><code>void parkUntil(long deadline)</code>ï¼é»å¡å½åçº¿ç¨ç´å°æä¸ªæå®çæªæ­¢æ¶é´ï¼ä»¥æ¯«ç§ä¸ºåä½ï¼ï¼æç´å°è¢« unpark è°ç¨ï¼æçº¿ç¨è¢«ä¸­æ­ã</li>
<li><code>void parkUntil(Object blocker, long deadline)</code>ï¼åè½åæ¹æ³ 5ï¼å¥åå¢å ä¸ä¸ª Object å¯¹è±¡ï¼ç¨æ¥è®°å½å¯¼è´çº¿ç¨é»å¡çå¯¹è±¡ï¼æ¹ä¾¿é®é¢ææ¥ã</li>
</ol>
<h3 id="å¤éçº¿ç¨">å¤éçº¿ç¨</h3>
<p><code>void unpark(Thread thread)</code>ï¼å¤éä¸ä¸ªç± park æ¹æ³é»å¡ççº¿ç¨ãå¦æè¯¥çº¿ç¨æªè¢«é»å¡ï¼é£ä¹ä¸ä¸æ¬¡è°ç¨ park æ¶å°ç«å³è¿åãè¿åè®¸âååå¶äººâå¼çå¤éæºå¶ã</p>
<p>å®éä¸ï¼LockSupport é»å¡åå¤éçº¿ç¨çåè½ä¾èµäº&nbsp;<code>sun.misc.Unsafe</code>ï¼è¿æ¯ä¸ä¸ªå¾åºå±çç±»ï¼æ¯å¦ LockSupport ç park æ¹æ³æ¯éè¿&nbsp;<code>unsafe.park()</code>&nbsp;æ¹æ³å®ç°çã</p>
<h2 id="locksupportæºç åæ">LockSupportæºç åæ</h2>
<h3 id="ç±»çå±æ§">ç±»çå±æ§</h3>
<pre><code class="language-java">public class LockSupport {
    // Hotspot implementation via intrinsics API
    private static final sun.misc.Unsafe UNSAFE;
    // è¡¨ç¤ºåå­åç§»å°å
    private static final long parkBlockerOffset;
    // è¡¨ç¤ºåå­åç§»å°å
    private static final long SEED;
    // è¡¨ç¤ºåå­åç§»å°å
    private static final long PROBE;
    // è¡¨ç¤ºåå­åç§»å°å
    private static final long SECONDARY;
    
    static {
        try {
            // è·åUnsafeå®ä¾
            UNSAFE = sun.misc.Unsafe.getUnsafe();
            // çº¿ç¨ç±»ç±»å
            Class&lt;?&gt; tk = Thread.class;
            // è·åThreadçparkBlockerå­æ®µçåå­åç§»å°å
            parkBlockerOffset = UNSAFE.objectFieldOffset
                (tk.getDeclaredField("parkBlocker"));
            // è·åThreadçthreadLocalRandomSeedå­æ®µçåå­åç§»å°å
            SEED = UNSAFE.objectFieldOffset
                (tk.getDeclaredField("threadLocalRandomSeed"));
            // è·åThreadçthreadLocalRandomProbeå­æ®µçåå­åç§»å°å
            PROBE = UNSAFE.objectFieldOffset
                (tk.getDeclaredField("threadLocalRandomProbe"));
            // è·åThreadçthreadLocalRandomSecondarySeedå­æ®µçåå­åç§»å°å
            SECONDARY = UNSAFE.objectFieldOffset
                (tk.getDeclaredField("threadLocalRandomSecondarySeed"));
        } catch (Exception ex) { throw new Error(ex); }
    }
}
</code></pre>
<p>è¯´æ: UNSAFEå­æ®µè¡¨ç¤º<a href="https://www.seven97.top/java/concurrent/unsafe.html" target="_blank" rel="noopener nofollow">sun.misc.Unsafe</a>ç±»ï¼ä¸è¬ç¨åºä¸­ä¸åè®¸ç´æ¥è°ç¨ï¼èlongåçè¡¨ç¤ºå®ä¾å¯¹è±¡ç¸åºå­æ®µå¨åå­ä¸­çåç§»å°åï¼å¯ä»¥éè¿è¯¥åç§»å°åè·åæèè®¾ç½®è¯¥å­æ®µçå¼ã</p>
<h3 id="ç±»çæé å½æ°">ç±»çæé å½æ°</h3>
<pre><code class="language-java">// ç§ææé å½æ°ï¼æ æ³è¢«å®ä¾å
private LockSupport() {}
</code></pre>
<p>è¯´æ: LockSupportåªæä¸ä¸ªç§ææé å½æ°ï¼æ æ³è¢«å®ä¾åã</p>
<h3 id="æ ¸å¿å½æ°åæ">æ ¸å¿å½æ°åæ</h3>
<p>å¨åæLockSupportå½æ°ä¹åï¼åå¼å¥sun.misc.Unsafeç±»ä¸­çparkåunparkå½æ°ï¼å ä¸ºLockSupportçæ ¸å¿å½æ°é½æ¯åºäºUnsafeç±»ä¸­å®ä¹çparkåunparkå½æ°ï¼ä¸é¢ç»åºä¸¤ä¸ªå½æ°çå®ä¹:</p>
<pre><code class="language-java">public native void park(boolean isAbsolute, long time);
public native void unpark(Thread thread);
</code></pre>
<p>è¯´æ: å¯¹ä¸¤ä¸ªå½æ°çè¯´æå¦ä¸:</p>
<ul>
<li>
<p>parkå½æ°ï¼é»å¡çº¿ç¨ï¼å¹¶ä¸è¯¥çº¿ç¨å¨ä¸åæåµåçä¹åé½ä¼è¢«é»å¡:</p>
<ul>
<li>
<p>è°ç¨unparkå½æ°ï¼éæ¾è¯¥çº¿ç¨çè®¸å¯ã</p>
</li>
<li>
<p>è¯¥çº¿ç¨è¢«ä¸­æ­ã</p>
</li>
<li>
<p>è®¾ç½®çæ¶é´å°äºãå¹¶ä¸ï¼å½timeä¸ºç»å¯¹æ¶é´æ¶ï¼isAbsoluteä¸ºtrueï¼å¦åï¼isAbsoluteä¸ºfalseãå½timeä¸º0æ¶ï¼è¡¨ç¤ºæ éç­å¾ï¼ç´å°unparkåçã</p>
</li>
</ul>
</li>
<li>
<p>unparkå½æ°ï¼éæ¾çº¿ç¨çè®¸å¯ï¼å³æ¿æ´»è°ç¨parkåé»å¡ççº¿ç¨ãè¿ä¸ªå½æ°ä¸æ¯å®å¨çï¼è°ç¨è¿ä¸ªå½æ°æ¶è¦ç¡®ä¿çº¿ç¨ä¾æ§å­æ´»ã</p>
</li>
</ul>
<h4 id="parkå½æ°">parkå½æ°</h4>
<p>parkå½æ°æä¸¤ä¸ªéè½½çæ¬ï¼æ¹æ³æè¦å¦ä¸</p>
<pre><code class="language-java">public static void park()ï¼
public static void park(Object blocker)ï¼
</code></pre>
<p>è¯´æ: ä¸¤ä¸ªå½æ°çåºå«å¨äºpark()å½æ°æ²¡ææ²¡æblockerï¼å³æ²¡æè®¾ç½®çº¿ç¨çparkBlockerå­æ®µãpark(Object)åå½æ°å¦ä¸ã</p>
<pre><code class="language-java">public static void park(Object blocker) {
    // è·åå½åçº¿ç¨
    Thread t = Thread.currentThread();
    // è®¾ç½®Blocker
    setBlocker(t, blocker);
    // è·åè®¸å¯
    UNSAFE.park(false, 0L);
    // éæ°å¯è¿è¡ååæ­¤è®¾ç½®Blocker
    setBlocker(t, null);
}
</code></pre>
<p>è¯´æ: è°ç¨parkå½æ°æ¶ï¼é¦åè·åå½åçº¿ç¨ï¼ç¶åè®¾ç½®å½åçº¿ç¨çparkBlockerå­æ®µï¼å³è°ç¨setBlockerå½æ°ï¼ä¹åè°ç¨Unsafeç±»çparkå½æ°ï¼ä¹ååè°ç¨setBlockerå½æ°ãé£ä¹é®é¢æ¥äºï¼ä¸ºä»ä¹è¦å¨æ­¤parkå½æ°ä¸­è¦è°ç¨ä¸¤æ¬¡setBlockerå½æ°å¢? åå å¶å®å¾ç®åï¼è°ç¨parkå½æ°æ¶ï¼å½åçº¿ç¨é¦åè®¾ç½®å¥½parkBlockerå­æ®µï¼ç¶ååè°ç¨Unsafeçparkå½æ°ï¼æ­¤åï¼å½åçº¿ç¨å°±å·²ç»é»å¡äºï¼ç­å¾è¯¥çº¿ç¨çunparkå½æ°è¢«è°ç¨ï¼æä»¥åé¢çä¸ä¸ªsetBlockerå½æ°æ æ³è¿è¡ï¼unparkå½æ°è¢«è°ç¨ï¼è¯¥çº¿ç¨è·å¾è®¸å¯åï¼å°±å¯ä»¥ç»§ç»­è¿è¡äºï¼ä¹å°±è¿è¡ç¬¬äºä¸ªsetBlockerï¼æè¯¥çº¿ç¨çparkBlockerå­æ®µè®¾ç½®ä¸ºnullï¼è¿æ ·å°±å®æäºæ´ä¸ªparkå½æ°çé»è¾ãå¦ææ²¡æç¬¬äºä¸ªsetBlockerï¼é£ä¹ä¹åæ²¡æè°ç¨park(Object blocker)ï¼èç´æ¥è°ç¨getBlockerå½æ°ï¼å¾å°çè¿æ¯åä¸ä¸ªpark(Object blocker)è®¾ç½®çblockerï¼æ¾ç¶æ¯ä¸ç¬¦åé»è¾çãæ»ä¹ï¼å¿é¡»è¦ä¿è¯å¨park(Object blocker)æ´ä¸ªå½æ°æ§è¡å®åï¼è¯¥çº¿ç¨çparkBlockerå­æ®µåæ¢å¤ä¸ºnullãæä»¥ï¼park(Object)åå½æ°éå¿é¡»è¦è°ç¨setBlockerå½æ°ä¸¤æ¬¡ãsetBlockeræ¹æ³å¦ä¸ã</p>
<pre><code class="language-java">private static void setBlocker(Thread t, Object arg) {
    // è®¾ç½®çº¿ç¨tçparkBlockerå­æ®µçå¼ä¸ºarg
    UNSAFE.putObject(t, parkBlockerOffset, arg);
}
</code></pre>
<p>è¯´æ: æ­¤æ¹æ³ç¨äºè®¾ç½®çº¿ç¨tçparkBlockerå­æ®µçå¼ä¸ºargã</p>
<p>å¦å¤ä¸ä¸ªæ åéè½½çæ¬ï¼park()å½æ°å¦ä¸ã</p>
<pre><code class="language-java">public static void park() {
    // è·åè®¸å¯ï¼è®¾ç½®æ¶é´ä¸ºæ éé¿ï¼ç´å°å¯ä»¥è·åè®¸å¯
    UNSAFE.park(false, 0L);
}
</code></pre>
<p>è¯´æ: è°ç¨äºparkå½æ°åï¼ä¼ç¦ç¨å½åçº¿ç¨ï¼é¤éè®¸å¯å¯ç¨ãå¨ä»¥ä¸ä¸ç§æåµä¹ä¸åçä¹åï¼å½åçº¿ç¨é½å°å¤äºä¼ç ç¶æï¼å³ä¸åæåµåçæ¶ï¼å½åçº¿ç¨ä¼è·åè®¸å¯ï¼å¯ä»¥ç»§ç»­è¿è¡ã</p>
<ul>
<li>
<p>å¶ä»æä¸ªçº¿ç¨å°å½åçº¿ç¨ä½ä¸ºç®æ è°ç¨ unparkã</p>
</li>
<li>
<p>å¶ä»æä¸ªçº¿ç¨ä¸­æ­å½åçº¿ç¨ã</p>
</li>
<li>
<p>è¯¥è°ç¨ä¸åé»è¾å°(å³æ¯«æ çç±å°)è¿åã</p>
</li>
</ul>
<h4 id="parknanoså½æ°">parkNanoså½æ°</h4>
<p>æ­¤å½æ°è¡¨ç¤ºå¨è®¸å¯å¯ç¨åç¦ç¨å½åçº¿ç¨ï¼å¹¶æå¤ç­å¾æå®çç­å¾æ¶é´ãå·ä½å½æ°å¦ä¸ã</p>
<pre><code class="language-java">public static void parkNanos(Object blocker, long nanos) {
    if (nanos &gt; 0) { // æ¶é´å¤§äº0
        // è·åå½åçº¿ç¨
        Thread t = Thread.currentThread();
        // è®¾ç½®Blocker
        setBlocker(t, blocker);
        // è·åè®¸å¯ï¼å¹¶è®¾ç½®äºæ¶é´
        UNSAFE.park(false, nanos);
        // è®¾ç½®è®¸å¯
        setBlocker(t, null);
    }
}
</code></pre>
<p>è¯´æ: è¯¥å½æ°ä¹æ¯è°ç¨äºä¸¤æ¬¡setBlockerå½æ°ï¼nanosåæ°è¡¨ç¤ºç¸å¯¹æ¶é´ï¼è¡¨ç¤ºç­å¾å¤é¿æ¶é´ã</p>
<h4 id="parkuntilå½æ°">parkUntilå½æ°</h4>
<p>æ­¤å½æ°è¡¨ç¤ºå¨æå®çæ¶éåç¦ç¨å½åçº¿ç¨ï¼é¤éè®¸å¯å¯ç¨, å·ä½å½æ°å¦ä¸:</p>
<pre><code class="language-java">public static void parkUntil(Object blocker, long deadline) {
    // è·åå½åçº¿ç¨
    Thread t = Thread.currentThread();
    // è®¾ç½®Blocker
    setBlocker(t, blocker);
    UNSAFE.park(true, deadline);
    // è®¾ç½®Blockerä¸ºnull
    setBlocker(t, null);
}
</code></pre>
<p>è¯´æ: è¯¥å½æ°ä¹è°ç¨äºä¸¤æ¬¡setBlockerå½æ°ï¼deadlineåæ°è¡¨ç¤ºç»å¯¹æ¶é´ï¼è¡¨ç¤ºæå®çæ¶é´ã</p>
<h4 id="unparkå½æ°">unparkå½æ°</h4>
<p>æ­¤å½æ°è¡¨ç¤ºå¦æç»å®çº¿ç¨çè®¸å¯å°ä¸å¯ç¨ï¼åä½¿å¶å¯ç¨ãå¦æçº¿ç¨å¨ park ä¸åé»å¡ï¼åå®å°è§£é¤å¶é»å¡ç¶æãå¦åï¼ä¿è¯ä¸ä¸æ¬¡è°ç¨ park ä¸ä¼åé»å¡ãå¦æç»å®çº¿ç¨å°æªå¯å¨ï¼åæ æ³ä¿è¯æ­¤æä½æä»»ä½ææãå·ä½å½æ°å¦ä¸:</p>
<pre><code class="language-java">public static void unpark(Thread thread) {
    if (thread != null) // çº¿ç¨ä¸ºä¸ç©º
        UNSAFE.unpark(thread); // éæ¾è¯¥çº¿ç¨è®¸å¯
}
</code></pre>
<p>è¯´æ: éæ¾è®¸å¯ï¼æå®çº¿ç¨å¯ä»¥ç»§ç»­è¿è¡ã</p>
<h2 id="æ´æ·±å¥ççè§£">æ´æ·±å¥ççè§£</h2>
<h3 id="ä¸-synchronzed-çåºå«">ä¸ synchronzed çåºå«</h3>
<p><a href="https://www.seven97.top/java/concurrent/02-keyword1-synchronized.html" target="_blank" rel="noopener nofollow">synchronzed</a>&nbsp;ä¼ä½¿çº¿ç¨é»å¡ï¼çº¿ç¨ä¼è¿å¥ BLOCKED ç¶æï¼èè°ç¨ LockSupprt æ¹æ³é»å¡çº¿ç¨ä¼ä½¿çº¿ç¨è¿å¥å° WAITING ç¶æã</p>
<h3 id="threadsleepåobjectwaitçåºå«">Thread.sleep()åObject.wait()çåºå«</h3>
<p>é¦åï¼æä»¬åæ¥ççThread.sleep()åObject.wait()çåºå«ï¼è¿æ¯ä¸ä¸ªçå¤§è¡çé¢ç®äºï¼å¤§å®¶åºè¯¥é½è½è¯´ä¸æ¥ä¸¤ç¹ã</p>
<ul>
<li>
<p>Thread.sleep()ä¸ä¼éæ¾å æçéï¼Object.wait()ä¼éæ¾å æçéï¼</p>
</li>
<li>
<p>Thread.sleep()å¿é¡»ä¼ å¥æ¶é´ï¼Object.wait()å¯ä¼ å¯ä¸ä¼ ï¼ä¸ä¼ è¡¨ç¤ºä¸ç´é»å¡ä¸å»ï¼</p>
</li>
<li>
<p>Thread.sleep()å°æ¶é´äºä¼èªå¨å¤éï¼ç¶åç»§ç»­æ§è¡ï¼</p>
</li>
<li>
<p>Object.wait()ä¸å¸¦æ¶é´çï¼éè¦å¦ä¸ä¸ªçº¿ç¨ä½¿ç¨Object.notify()å¤éï¼</p>
</li>
<li>
<p>Object.wait()å¸¦æ¶é´çï¼åå¦æ²¡æè¢«notifyï¼å°æ¶é´äºä¼èªå¨å¤éï¼è¿æ¶ååå¥½ä¸¤ç§æåµï¼ä¸æ¯ç«å³è·åå°äºéï¼çº¿ç¨èªç¶ä¼ç»§ç»­æ§è¡ï¼äºæ¯æ²¡æç«å³è·åéï¼çº¿ç¨è¿å¥åæ­¥éåç­å¾è·åéï¼</p>
</li>
</ul>
<p>å¶å®ï¼ä»ä»¬ä¿©æå¤§çåºå«å°±æ¯Thread.sleep()ä¸ä¼éæ¾éèµæºï¼Object.wait()ä¼éæ¾éèµæºã</p>
<h3 id="objectwaitåconditionawaitçåºå«">Object.wait()åCondition.await()çåºå«</h3>
<p>Object.wait()åCondition.await()çåçæ¯åºæ¬ä¸è´çï¼ä¸åçæ¯Condition.await()åºå±æ¯è°ç¨LockSupport.park()æ¥å®ç°é»å¡å½åçº¿ç¨çã</p>
<p>å®éä¸ï¼å®å¨é»å¡å½åçº¿ç¨ä¹åè¿å¹²äºä¸¤ä»¶äºï¼ä¸æ¯æå½åçº¿ç¨æ·»å å°æ¡ä»¶éåä¸­ï¼äºæ¯âå®å¨âéæ¾éï¼ä¹å°±æ¯è®©stateç¶æåéåä¸º0ï¼ç¶åææ¯è°ç¨LockSupport.park()é»å¡å½åçº¿ç¨ã</p>
<h3 id="threadsleepålocksupportparkçåºå«">Thread.sleep()åLockSupport.park()çåºå«</h3>
<p>LockSupport.park()è¿æå ä¸ªåå¼æ¹æ³ââparkNanos()ãparkUtil()ç­ï¼æä»¬è¿éè¯´çpark()æ¹æ³ç»ç§°è¿ä¸ç±»æ¹æ³ã</p>
<ul>
<li>
<p>ä»åè½ä¸æ¥è¯´ï¼Thread.sleep()åLockSupport.park()æ¹æ³ç±»ä¼¼ï¼é½æ¯é»å¡å½åçº¿ç¨çæ§è¡ï¼ä¸é½ä¸ä¼éæ¾å½åçº¿ç¨å æçéèµæºï¼</p>
</li>
<li>
<p>Thread.sleep()æ²¡æ³ä»å¤é¨å¤éï¼åªè½èªå·±éè¿æ¥ï¼</p>
</li>
<li>
<p>LockSupport.park()æ¹æ³å¯ä»¥è¢«å¦ä¸ä¸ªçº¿ç¨è°ç¨LockSupport.unpark()æ¹æ³å¤éï¼</p>
</li>
<li>
<p>Thread.sleep()æ¹æ³å£°æä¸æåºäºInterruptedExceptionä¸­æ­å¼å¸¸ï¼æä»¥è°ç¨èéè¦æè·è¿ä¸ªå¼å¸¸æèåæåºï¼</p>
</li>
<li>
<p>LockSupport.park()æ¹æ³ä¸éè¦æè·ä¸­æ­å¼å¸¸ï¼</p>
</li>
<li>
<p>Thread.sleep()æ¬èº«å°±æ¯ä¸ä¸ªnativeæ¹æ³ï¼</p>
</li>
<li>
<p>LockSupport.park()åºå±æ¯è°ç¨çUnsafeçnativeæ¹æ³ï¼</p>
</li>
</ul>
<h3 id="objectwaitålocksupportparkçåºå«">Object.wait()åLockSupport.park()çåºå«</h3>
<p>äºèé½ä¼é»å¡å½åçº¿ç¨çè¿è¡ï¼ä»ä»¬æä»ä¹åºå«å¢? ç»è¿ä¸é¢çåæç¸ä¿¡ä½ ä¸å®å¾æ¸æ¥äºï¼ççå? å¾ä¸çï¼</p>
<ul>
<li>
<p>Object.wait()æ¹æ³éè¦å¨synchronizedåä¸­æ§è¡ï¼</p>
</li>
<li>
<p>LockSupport.park()å¯ä»¥å¨ä»»æå°æ¹æ§è¡ï¼</p>
</li>
<li>
<p>Object.wait()æ¹æ³å£°ææåºäºä¸­æ­å¼å¸¸ï¼è°ç¨èéè¦æè·æèåæåºï¼</p>
</li>
<li>
<p>LockSupport.park()ä¸éè¦æè·ä¸­æ­å¼å¸¸ï¼</p>
</li>
<li>
<p>Object.wait()ä¸å¸¦è¶æ¶çï¼éè¦å¦ä¸ä¸ªçº¿ç¨æ§è¡notify()æ¥å¤éï¼ä½ä¸ä¸å®ç»§ç»­æ§è¡åç»­åå®¹ï¼</p>
</li>
<li>
<p>LockSupport.park()ä¸å¸¦è¶æ¶çï¼éè¦å¦ä¸ä¸ªçº¿ç¨æ§è¡unpark()æ¥å¤éï¼ä¸å®ä¼ç»§ç»­æ§è¡åç»­åå®¹ï¼</p>
</li>
</ul>
<p>park()/unpark()åºå±çåçæ¯âäºåä¿¡å·éâï¼ä½ å¯ä»¥æå®ç¸åæåªæä¸ä¸ªè®¸å¯è¯çSemaphoreï¼åªä¸è¿è¿ä¸ªä¿¡å·éå¨éå¤æ§è¡unpark()çæ¶åä¹ä¸ä¼åå¢å è®¸å¯è¯ï¼æå¤åªæä¸ä¸ªè®¸å¯è¯ã</p>
<h3 id="å¦æå¨waitä¹åæ§è¡äºnotifyä¼ææ ·">å¦æå¨wait()ä¹åæ§è¡äºnotify()ä¼ææ ·?</h3>
<p>å¦æå½åççº¿ç¨ä¸æ¯æ­¤å¯¹è±¡éçææèï¼å´è°ç¨è¯¥å¯¹è±¡çnotify()æwait()æ¹æ³æ¶æåºIllegalMonitorStateExceptionå¼å¸¸ï¼</p>
<p>å¦æå½åçº¿ç¨æ¯æ­¤å¯¹è±¡éçææèï¼wait()å°ä¸ç´é»å¡ï¼å ä¸ºåç»­å°æ²¡æå¶å®notify()å¤éå®ã</p>
<h3 id="å¦æå¨parkä¹åæ§è¡äºunparkä¼ææ ·">å¦æå¨park()ä¹åæ§è¡äºunpark()ä¼ææ ·?</h3>
<p>çº¿ç¨ä¸ä¼è¢«é»å¡ï¼ç´æ¥è·³è¿park()ï¼ç»§ç»­æ§è¡åç»­åå®¹</p>
<h3 id="locksupportparkä¼éæ¾éèµæºå">LockSupport.park()ä¼éæ¾éèµæºå?</h3>
<p>ä¸ä¼ï¼å®åªè´è´£é»å¡å½åçº¿ç¨ï¼éæ¾éèµæºå®éä¸æ¯å¨Conditionçawait()æ¹æ³ä¸­å®ç°çã</p>


</div>
<div id="MySignature" role="contentinfo">
    <p>æ¬ææ¥èªå¨çº¿ç½ç«ï¼sevençèé¸æé¿ä¹è·¯ï¼ä½èï¼sevenï¼è½¬è½½è¯·æ³¨æåæé¾æ¥ï¼www.seven97.top</p>
</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-02-13 09:00">2026-02-13 09:00</span>&nbsp;
<a href="https://www.cnblogs.com/sevencoding">ç¨åºåSeven</a>&nbsp;
éè¯»(<span id="post_view_count">0</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19588531);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19588531', targetLink: 'https://www.cnblogs.com/sevencoding/p/19588531', title: 'LockSupportæ·±åº¦è§£æï¼çº¿ç¨é»å¡ä¸å¤éçåºå±å®ç°åç' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ AIå·¥å·å®è·µæ¥è®°ï¼äºï¼ï¼å¨ OpenClaw ä¸­è°ç¨ OpenCode è¿è¡å¼åä»»å¡ ]]></title>
    <link>https://www.cnblogs.com/rsls/p/19606311</link>
    <guid>d7d7b4a70839298c84dc23dd3838efe3</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/rsls/p/19606311" title="åå¸äº 2026-02-13 08:56">
    <span role="heading" aria-level="2">AIå·¥å·å®è·µæ¥è®°ï¼äºï¼ï¼å¨ OpenClaw ä¸­è°ç¨ OpenCode è¿è¡å¼åä»»å¡</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                    <div id="cnblogs_post_description" style="display: none">
        <img src="https://img2024.cnblogs.com/blog/280247/202602/280247-20260212005137002-1578926574.png" alt="AIå·¥å·å®è·µæ¥è®°ï¼äºï¼ï¼å¨ OpenClaw ä¸­è°ç¨ OpenCode è¿è¡å¼åä»»å¡" class="desc_img">
        AI å¼åéè¦"ææ¥ä¸­å¿"
    </div>
<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h2 id="å¼è¨ai-å¼åéè¦ææ¥ä¸­å¿">å¼è¨ï¼AI å¼åéè¦"ææ¥ä¸­å¿"</h2>
<p>ä¸ä¸ç¯æ¥è®°è®²äºå¦ä½å¨æ èæ´¾ä¸æ­å»º OpenClawãè¿ç¯æ¥è¯´è¯´<strong>çæ­£ç¨ OpenClaw å¹²æ´»</strong>çä½éªã</p>
<p>ç´æ¥ç¨ ClaudeãGPT æ OpenCode åä»£ç æä¸ªé®é¢ï¼<strong>å¯¹è¯æ£è½å¨åä¸ªçªå£ï¼è¿åº¦æ²¡æ³è¿½è¸ªï¼ç»æä¹ä¸å¥½ç®¡çã</strong></p>
<p>OpenClaw è§£å³çå°±æ¯è¿ä¸ªé®é¢ââå®åä¸ä¸ª"ææ¥ä¸­å¿"ï¼è®©ä½ è½ï¼</p>
<ul>
<li>å¯å¨ AI ç¼ç¨ä»»å¡ï¼åå°è¿è¡ï¼ä¸é»å¡ï¼</li>
<li>å®æ¶çæ§è¿åº¦ï¼éæ¶æ¥çè¾åºï¼</li>
<li>èªå¨å¤çéè¯¯ï¼å¡ä½æ¶èªå¨æ¢å¤ææ¥è­¦ï¼</li>
<li>ç»ä¸ç®¡çä¸ä¸æï¼workspaceãmemoryãæè½ï¼</li>
</ul>
<p>è¿ç¯æ¥è®°è®°å½äºæç¨ <strong>OpenClaw + OpenSpec + OpenCode</strong> ç»åå¼åä»»å¡çæ¿ççå®è¿ç¨ã</p>
<hr>
<h2 id="ä¸ºä»ä¹è¦ç¨-openspecè§èåäºä»£ç ">ä¸ºä»ä¹è¦ç¨ OpenSpecï¼è§èåäºä»£ç </h2>
<h3 id="ai-ç¼ç¨ççç¹">AI ç¼ç¨ççç¹</h3>
<p>ç¨ AI åä»£ç å¾æ¹ä¾¿ï¼ä½æä¸ªè´å½é®é¢ï¼<strong>éæ±åªå­å¨äºèå¤©è®°å½éã</strong></p>
<p>æ³è±¡è¿ä¸ªåºæ¯ï¼</p>
<ul>
<li>ä½ è· Claude è¯´ï¼"å¸®æå ä¸ªæ ç­¾åè½"</li>
<li>AI åå¥½äºä»£ç </li>
<li>ä¸å¨åä½ æ³æ¹è¿ä¸ªåè½ï¼ä½æ¾ä¸å°å½æ¶çå¯¹è¯</li>
<li>ä½ éæ°æè¿°éæ±ï¼ä½æè¿°å¾ä¸å®å¨ä¸æ ·</li>
<li>AI åçä»£ç åä¹åä¸å¼å®¹</li>
</ul>
<p><strong>ç»æï¼ä»£ç ä¸å¢ç³ï¼è¿å¾èªå·±éåã</strong></p>
<h3 id="openspec-æ¯ä»ä¹">OpenSpec æ¯ä»ä¹</h3>
<p><strong>OpenSpec æ¯ä¸ä¸ªè§èé©±å¨å¼åï¼Spec-Driven Developmentï¼æ¡æ¶ã</strong></p>
<p>å®çæ ¸å¿çå¿µï¼<strong>ååè§èï¼ååä»£ç ã</strong></p>
<p>ææéæ±ãè®¾è®¡ãä»»å¡é½åæææ¡£ï¼æ¾å¨ <code>openspec/</code> ç®å½ä¸ãAI æç§è§èææ¡£æ§è¡ï¼èä¸æ¯æ ¹æ®èå¤©åå®¹çæµã</p>
<h3 id="openspec-ç®å½ç»æ">OpenSpec ç®å½ç»æ</h3>
<pre><code>openspec/
âââ specs/                    # ç³»ç»è¡ä¸ºçæºå¤´ï¼å½åç¶æï¼
â   âââ &lt;domain&gt;/
â       âââ spec.md          # ç³»ç»è§æ ¼ææ¡£
âââ changes/                  # æè®®çåæ´ï¼æ¯ä¸ªåè½ä¸ä¸ªæä»¶å¤¹ï¼
â   âââ &lt;åè½å&gt;/
â       âââ proposal.md      # ä¸ºä»ä¹è¦åï¼æå¾åèå´ï¼
â       âââ design.md        # æä¹åï¼ææ¯æ¹æ¡ï¼
â       âââ tasks.md         # ä»»å¡æ¸å â­ æå³é®
â       âââ specs/           # åæ´çå·ä½è§æ ¼
âââ config.yaml              # é¡¹ç®éç½®
</code></pre>
<h3 id="ä½¿ç¨-openspec-çå¿è¦æ§">ä½¿ç¨ OpenSpec çå¿è¦æ§</h3>
<p><strong>1. éæ±å¯è¿½æº¯</strong></p>
<table>
<thead>
<tr>
<th>æ¹å¼</th>
<th>éæ±å¨åªé</th>
<th>ä¸ä¸ªæåè¿è½æ¾å°å</th>
</tr>
</thead>
<tbody>
<tr>
<td>ç´æ¥èå¤©</td>
<td>èå¤©è®°å½</td>
<td>â æ¾ä¸å°äº</td>
</tr>
<tr>
<td>OpenSpec</td>
<td><code>changes/åè½å/proposal.md</code></td>
<td>â æ°¸è¿å¨æä»¶é</td>
</tr>
</tbody>
</table>
<p><strong>2. è®¾è®¡å¯å¤ç¨</strong></p>
<p>è®¾è®¡ææ¡£ <code>design.md</code> è®°å½äºææ¯æ¹æ¡ãä¸æ¬¡éå°ç±»ä¼¼åè½ï¼å¯ä»¥ç´æ¥åèã</p>
<p><strong>3. ä»»å¡å¯æå</strong></p>
<p><code>tasks.md</code> æå¤æåè½ææå¯æ§è¡çå°ä»»å¡ãAI ææ¸åéä¸ªå®æï¼ä¸ä¼éæ¼ã</p>
<p><strong>4. è¿åº¦å¯çæ§</strong></p>
<p>æ¯ä¸ªä»»å¡å®æåï¼AI è¾åº <code>[DONE] ä»»å¡X.X</code>ãä½ å¯ä»¥å®æ¶ç¥éï¼</p>
<ul>
<li>å®æäºå¤å°ä»»å¡</li>
<li>è¿å©å¤å°ä»»å¡</li>
<li>ææ²¡æå¡ä½</li>
</ul>
<p><strong>5. åæ´æåå²</strong></p>
<pre><code class="language-bash"># æ¥çææåæ´
$ ls openspec/changes/
add-archive-feature/    # å½æ¡£åè½
add-task-tags/          # æ ç­¾åè½
migrate-to-sqlite/      # æ°æ®åºè¿ç§»

# æ¯ä¸ªåæ´é½æå®æ´çææ¡ãè®¾è®¡ãä»»å¡è®°å½
</code></pre>
<h3 id="ä¸ç¨-openspec-çåæ">ä¸ç¨ OpenSpec çåæ</h3>
<p>æåè¿å¯¹æ¯å®éªï¼</p>
<table>
<thead>
<tr>
<th>é¡¹ç®</th>
<th>ä½¿ç¨ OpenSpec</th>
<th>ä¸ä½¿ç¨ OpenSpec</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ ç­¾åè½</td>
<td>6ä¸ªä»»å¡ï¼10åéï¼ä¸æ¬¡æå</td>
<td>åå¤æ²éï¼30åéï¼ä»£ç æ··ä¹±</td>
</tr>
<tr>
<td>æ°æ®åºè¿ç§»</td>
<td>24ä¸ªä»»å¡ææ2ä¸ªåæ´ï¼5åé</td>
<td>ç´æ¥è¯´"è¿ç§»å°SQLite"ï¼å¡ä½</td>
</tr>
<tr>
<td>å¯ç»´æ¤æ§</td>
<td>3ä¸ªæåä»è½çæè®¾è®¡</td>
<td>1å¨åå¿è®°å½æ¶æä¹æ³ç</td>
</tr>
</tbody>
</table>
<p><strong>ç»è®ºï¼OpenSpec æ¯ AI ç¼ç¨ç"åºç¡è®¾æ½"ï¼ä¸ç¨å®å°±æ¯å¨è£¸å¥ã</strong></p>
<h3 id="openspec-å·¥ä½æµç¨">OpenSpec å·¥ä½æµç¨</h3>
<pre><code>1. ææ°éæ±
   â
2. åå»ºåæ´
   $ openspec change new åè½å
   â
3. ç¼åè§èææ¡£
   - proposal.mdï¼ä¸ºä»ä¹è¦åï¼
   - design.mdï¼æä¹åï¼
   - tasks.mdï¼ä»»å¡æ¸åï¼
   â
4. è®© AI æ§è¡
   $ opencode run "æ tasks.md å®ç°"
   â
5. éªè¯ç»æ
   - åè½æµè¯
   - ä»£ç å®¡æ¥
   â
6. å½æ¡£åæ´
   $ openspec change archive åè½å
   â
7. æ´æ°ç³»ç»è§æ ¼
   - æåæ´åå¹¶å° specs/
</code></pre>
<hr>
<h2 id="å·¥å·é¾ä»ç»">å·¥å·é¾ä»ç»</h2>
<h3 id="openclawai-ææ¥ä¸­å¿">OpenClawï¼AI ææ¥ä¸­å¿</h3>
<p>OpenClaw æ¯ä¸ä¸ª AI å©æå¹³å°ï¼æ ¸å¿è½åï¼</p>
<table>
<thead>
<tr>
<th>åè½</th>
<th>è¯´æ</th>
<th>å½ä»¤</th>
</tr>
</thead>
<tbody>
<tr>
<td>å¯å¨åå°ä»»å¡</td>
<td>ä¸é»å¡å½åä¼è¯</td>
<td><code>sessions_spawn task:"..."</code></td>
</tr>
<tr>
<td>å®æ¶çæ§</td>
<td>æ¥çä»»å¡è¾åºåè¿åº¦</td>
<td><code>sessions_history sessionKey:"..."</code></td>
</tr>
<tr>
<td>ä»»å¡ç®¡ç</td>
<td>ååºåéæ¶æ¯ãå¼ºå¶åæ­¢</td>
<td><code>sessions_list</code>, <code>sessions_send</code>, <code>process action:kill</code></td>
</tr>
<tr>
<td>ä¸ä¸æç®¡ç</td>
<td>èªå¨è¯»å workspaceãmemory</td>
<td>åç½®</td>
</tr>
<tr>
<td>éè¯¯å¤ç</td>
<td>èªå¨æ£æµåæ¢å¤</td>
<td>åç½®</td>
</tr>
</tbody>
</table>
<h3 id="opencodeai-ç¼ç¨ä»£ç">OpenCodeï¼AI ç¼ç¨ä»£ç</h3>
<p>OpenCode è¯»å OpenSpec è§èï¼èªå¨åä»£ç ãæ¯æå¤ç§è°ç¨æ¹å¼ï¼</p>
<ol>
<li><strong>å½ä»¤è¡</strong>ï¼<code>opencode run "å®ç°åè½"</code></li>
<li><strong>OpenClaw exec</strong>ï¼<code>exec command:"opencode run ..."</code></li>
<li><strong>OpenClaw sessions_spawn</strong>ï¼<code>sessions_spawn task:"..."</code> â­æ¨è</li>
</ol>
<hr>
<h2 id="å®æä¸æ ç­¾åè½å¼å">å®æä¸ï¼æ ç­¾åè½å¼å</h2>
<h3 id="éæ±">éæ±</h3>
<p>ç»ä»»å¡çæ¿æ·»å <strong>æ ç­¾åè½</strong>ï¼</p>
<ul>
<li>æ¯æä¸ºä»»å¡æ·»å å¤ä¸ªæ ç­¾</li>
<li>å¯ä»¥ææ ç­¾ç­éä»»å¡</li>
<li>æ ç­¾æ¾ç¤ºå¨ä»»å¡å¡çä¸</li>
</ul>
<h3 id="openclaw-æ§è¡æµç¨">OpenClaw æ§è¡æµç¨</h3>
<p><strong>ç¬¬ä¸æ­¥ï¼åå»º OpenSpec è§è</strong></p>
<pre><code class="language-bash">cd aimier-kanban
openspec change new add-task-tags
</code></pre>
<p>ç¼è¾ <code>openspec/changes/add-task-tags/tasks.md</code>ï¼</p>
<pre><code class="language-markdown"># Tasks: Add Task Tags

## 1. Backend
- [ ] 1.1 Add tags field to task data structure
- [ ] 1.2 Update create_task API to support tags
- [ ] 1.3 Create GET /api/tags endpoint

## 2. Frontend
- [ ] 2.1 Add tag input box in task modal
- [ ] 2.2 Display tags on task cards
- [ ] 2.3 Add tag filter dropdown
</code></pre>
<p><strong>ç¬¬äºæ­¥ï¼éè¿ OpenClaw å¯å¨ OpenCode</strong></p>
<pre><code class="language-bash"># å¨ OpenClaw ä¸­æ§è¡
sessions_spawn task:"æç§ openspec/changes/add-task-tags/tasks.md å®ç°ä»»å¡æ ç­¾åè½"
  label:"implement-task-tags"
  timeoutSeconds:600
</code></pre>
<p><strong>ç¬¬ä¸æ­¥ï¼å®æ¶çæ§è¿åº¦</strong></p>
<pre><code class="language-bash"># æ¥çä»»å¡åè¡¨
$ sessions_list

# æ¥çå·ä½è¾åºï¼æ¯30ç§æ£æ¥ä¸æ¬¡ï¼
$ sessions_history sessionKey:"agent:main:subagent:implement-task-tags" limit:50

# è¾åºç¤ºä¾ï¼
[DONE] ä»»å¡1.1: æ·»å  tags å­æ®µå°ä»»å¡æ°æ®ç»æ
[DONE] ä»»å¡1.2: ä¿®æ¹åå»ºä»»å¡ API
[DONE] ä»»å¡1.3: åå»ºæ ç­¾åè¡¨ API
[DONE] ä»»å¡2.1: å¨ä»»å¡æ¨¡ææ¡æ·»å æ ç­¾è¾å¥
[DONE] ä»»å¡2.2: å¨ä»»å¡å¡çæ¾ç¤ºæ ç­¾
[DONE] ä»»å¡2.3: æ·»å æ ç­¾ç­éåè½
[ALL DONE]
</code></pre>
<p><strong>ç¬¬åæ­¥ï¼éªè¯ç»æ</strong></p>
<pre><code class="language-bash"># æ£æ¥ä»£ç è¯­æ³
exec command:"cd aimier-kanban &amp;&amp; python3 -m py_compile app.py"

# æµè¯åè½
# å¯å¨æå¡ï¼å¨æµè§å¨éªè¯æ ç­¾åè½
</code></pre>
<h3 id="ç»æ">ç»æ</h3>
<ul>
<li>â 6 ä¸ªä»»å¡å¨é¨å®æ</li>
<li>â èæ¶çº¦ 10 åé</li>
<li>â ä»£ç è´¨éç¬¦åé¢æ</li>
<li>â æ éäººå·¥å¹²é¢</li>
</ul>
<hr>
<h2 id="å®æäºsqlite-æ°æ®åºè¿ç§»å¤æåè½">å®æäºï¼SQLite æ°æ®åºè¿ç§»ï¼å¤æåè½ï¼</h2>
<h3 id="éæ±-1">éæ±</h3>
<p>æä»»å¡çæ¿ä» JSON æä»¶å­å¨è¿ç§»å° SQLite æ°æ®åºã</p>
<p><strong>å¤æåº¦è¯ä¼°ï¼</strong></p>
<ul>
<li>æ°æ®åºåå§åï¼4 ä¸ªä»»å¡</li>
<li>æ°æ®è¿ç§»ï¼4 ä¸ªä»»å¡</li>
<li>API æ´æ°ï¼16 ä¸ªä»»å¡ï¼<strong>è¿å¤ï¼</strong>ï¼</li>
</ul>
<h3 id="ä»»å¡æåç­ç¥">ä»»å¡æåç­ç¥</h3>
<p>ç´æ¥è®© OpenCode å®ç° 24 ä¸ªä»»å¡ä¼å¡ä½ãæçç­ç¥ï¼<strong>æåä¸ºä¸¤ä¸ªåæ´</strong>ã</p>
<p><strong>åæ´1ï¼sqlite-databaseï¼8ä¸ªä»»å¡ï¼</strong></p>
<pre><code class="language-markdown"># Tasks: SQLite Database Layer

## 1. Database Setup
- [ ] 1.1 Import sqlite3 module
- [ ] 1.2 Create database connection helper
- [ ] 1.3 Add init_db() function
- [ ] 1.4 Create tasks table schema

## 2. Data Migration
- [ ] 2.1 Load existing tasks from JSON
- [ ] 2.2 Insert tasks into SQLite
- [ ] 2.3 Migrate archived tasks
- [ ] 2.4 Verify migration success
</code></pre>
<p><strong>åæ´2ï¼sqlite-apiï¼16ä¸ªä»»å¡ï¼</strong></p>
<pre><code class="language-markdown"># Tasks: Update API to use SQLite

## 1. Backend Refactor
- [ ] 1.1 Update load_tasks() to use SQL
- [ ] 1.2 Update save_task() to use SQL INSERT/UPDATE
- [ ] 1.3 Update delete_task() to use SQL DELETE
- [ ] 1.4 Update archive functions

## 2. API Endpoints
- [ ] 2.1 Update GET /api/tasks
- [ ] 2.2 Update POST /api/tasks
- [ ] 2.3 Update PATCH /api/tasks/&lt;id&gt;
- [ ] 2.4 Update DELETE /api/tasks/&lt;id&gt;
- [ ] 2.5 Update PATCH /api/tasks/&lt;id&gt;/status
- [ ] 2.6 Update GET /api/stats
- [ ] 2.7 Update GET /api/tags
- [ ] 2.8 Update GET /api/archives
- [ ] 2.9 Update POST /api/archives/&lt;id&gt;/restore
- [ ] 2.10 Update DELETE /api/archives/&lt;id&gt;
</code></pre>
<h3 id="openclaw-æ§è¡æµç¨-1">OpenClaw æ§è¡æµç¨</h3>
<p><strong>æ§è¡åæ´1ï¼</strong></p>
<pre><code class="language-bash">sessions_spawn task:"æç§ openspec/changes/sqlite-database/tasks.md å®ç°æ°æ®åºå±"
  label:"sqlite-database"
  timeoutSeconds:600
</code></pre>
<p><strong>çæ§è¾åºï¼</strong></p>
<pre><code>[DONE] ä»»å¡1.1-1.4: æ°æ®åºåå§åå®æ
[DONE] ä»»å¡2.1-2.2: è¿ç§»äº 12 ä¸ªä»»å¡
[DONE] ä»»å¡2.3-2.4: è¿ç§»äº 4 ä¸ªå½æ¡£ä»»å¡
[ALL DONE]

èæ¶ï¼çº¦3åé
ç¶æï¼â æå
</code></pre>
<p><strong>æ§è¡åæ´2ï¼</strong></p>
<pre><code class="language-bash">sessions_spawn task:"æç§ openspec/changes/sqlite-api/tasks.md æ´æ°APIå±"
  label:"sqlite-api"
  timeoutSeconds:900
</code></pre>
<p><strong>çæ§è¾åºï¼</strong></p>
<pre><code>[DONE] ä»»å¡1.1: Import sqlite3 module
[DONE] ä»»å¡1.2: Create get_db() helper function
[DONE] ä»»å¡1.3: Add init_db() for startup
[DONE] ä»»å¡2.1: Update load_tasks() to use SQL
...
[DONE] ä»»å¡2.10: Update DELETE /api/archives/&lt;id&gt;
[ALL DONE]

èæ¶ï¼çº¦2åé
ç¶æï¼â æå
</code></pre>
<h3 id="ææå¯¹æ¯">ææå¯¹æ¯</h3>
<table>
<thead>
<tr>
<th>æ¹æ¡</th>
<th>åæ´æ°</th>
<th>æ»ä»»å¡æ°</th>
<th>èæ¶</th>
<th>ç»æ</th>
</tr>
</thead>
<tbody>
<tr>
<td>åå§æ¹æ¡ï¼æªæåï¼</td>
<td>1</td>
<td>24</td>
<td>å¡ä½</td>
<td>â å¤±è´¥</td>
</tr>
<tr>
<td><strong>ç»åæ¹æ¡ï¼æååï¼</strong></td>
<td><strong>2</strong></td>
<td><strong>24</strong></td>
<td><strong>5åé</strong></td>
<td><strong>â æå</strong></td>
</tr>
</tbody>
</table>
<p><strong>å³é®åç°ï¼</strong></p>
<ul>
<li>ä»»å¡æååï¼å³ä½¿æ»ä»»å¡æ°ç¸åï¼æåçåèæå</li>
<li>åä¸ªåæ´çä»»å¡æ°æ§å¶å¨ 8-16 ä¸ªæ¯ sweet spot</li>
<li><code>[DONE]</code> æ è®°è®©è¿åº¦éæï¼å¿éæ´æåº</li>
</ul>
<hr>
<h2 id="çæ§åç®¡çæå·§">çæ§åç®¡çæå·§</h2>
<h3 id="å®æ¶çæ§å½ä»¤">å®æ¶çæ§å½ä»¤</h3>
<pre><code class="language-bash"># æ¥çæææ´»è·ä»»å¡
$ sessions_list

# æ¥çæè¿10åéæ´»è·çä»»å¡
$ sessions_list activeMinutes:10

# æ¥çå·ä½ä»»å¡çè¾åº
$ sessions_history sessionKey:"..." limit:50

# æç´¢ [DONE] æ è®°
$ sessions_history sessionKey:"..." | grep "\[DONE\]"

# ç»è®¡å·²å®æä»»å¡æ°
$ sessions_history sessionKey:"..." | grep -c "\[DONE\]"
</code></pre>
<h3 id="éè¯¯å¤çåæ¢å¤">éè¯¯å¤çåæ¢å¤</h3>
<p><strong>åºæ¯1ï¼OpenCode å¡ä½ï¼5åéæ è¾åºï¼</strong></p>
<pre><code class="language-bash"># æ£æ¥æåè¾åºæ¶é´
$ sessions_history sessionKey:"..." | tail -20

# åéå¤éä¿¡å·
$ sessions_send sessionKey:"..." message:"è¯·ç»§ç»­å®ç°ï¼ä»ä»»å¡2.1å¼å§"

# å¦ææ ååºï¼å¼ºå¶åæ­¢å¹¶éæ°å¯å¨
$ process action:kill sessionId:xxx
$ sessions_spawn task:"ç»§ç»­å®ç°ï¼ä»ä»»å¡2.1å¼å§" label:"resume-task"
</code></pre>
<p><strong>åºæ¯2ï¼çæä»£ç æè¯­æ³éè¯¯</strong></p>
<pre><code class="language-bash"># èªå¨è¿è¡è¯­æ³æ£æ¥
$ exec command:"cd aimier-kanban &amp;&amp; python3 -m py_compile app.py"

# å¦ææéè¯¯ï¼OpenClaw ä¼èªå¨åæå¹¶ç»åºå»ºè®®
</code></pre>
<hr>
<h2 id="è¸©åè®°å½">è¸©åè®°å½</h2>
<h3 id="å1ç´æ¥ä½¿ç¨-opencode-cli">å1ï¼ç´æ¥ä½¿ç¨ OpenCode CLI</h3>
<p><strong>é®é¢ï¼</strong> ç´æ¥å¨ç»ç«¯è¿è¡ <code>opencode run "..."</code>ï¼å¡ä½æ¶æ æ³æç¥ã</p>
<p><strong>è§£å³ï¼</strong> æ¹ç¨ OpenClaw ç <code>sessions_spawn</code>ï¼åå°è¿è¡ + å®æ¶çæ§ã</p>
<h3 id="å2ä»»å¡å¤ªå¤§ä¸æå">å2ï¼ä»»å¡å¤ªå¤§ï¼ä¸æåï¼</h3>
<p><strong>é®é¢ï¼</strong> è®© OpenCode ä¸æ¬¡æ§å®ç° 24 ä¸ªä»»å¡ï¼å¡å¨ä¸­é´ä¸å¨ã</p>
<p><strong>è§£å³ï¼</strong> æåä¸ºå¤ä¸ªå°åæ´ï¼æ¯ä¸ªåæ´ 8-16 ä¸ªä»»å¡ã</p>
<h3 id="å3ç¼ºä¹è¿åº¦åé¦">å3ï¼ç¼ºä¹è¿åº¦åé¦</h3>
<p><strong>é®é¢ï¼</strong> OpenCode ä¸æ¥åè¿åº¦ï¼ä¸ç¥éåå°åªäºã</p>
<p><strong>è§£å³ï¼</strong> å¨ tasks.md åæç¤ºè¯ä¸­å¼ºå¶è¦æ± <code>[DONE]</code> æ è®°ã</p>
<h3 id="å4ä¸ä¸æç¼ºå¤±">å4ï¼ä¸ä¸æç¼ºå¤±</h3>
<p><strong>é®é¢ï¼</strong> OpenCode ä¸ç¥éé¡¹ç®ç»æï¼éè¦åå¤è¯´æã</p>
<p><strong>è§£å³ï¼</strong> OpenClaw èªå¨è¯»å workspaceï¼æä¾å®æ´ä¸ä¸æã</p>
<hr>
<h2 id="ç»éªæ»ç»">ç»éªæ»ç»</h2>
<h3 id="æä½³å®è·µ">æä½³å®è·µ</h3>
<ol>
<li>
<p><strong>ä»»å¡æååå</strong></p>
<ul>
<li>å¤æåè½æåä¸ºå¤ä¸ªåæ´</li>
<li>æ¯ä¸ªåæ´ 8-16 ä¸ªä»»å¡</li>
<li>ä»»å¡ä¹é´ææç¡®ä¾èµé¡ºåº</li>
</ul>
</li>
<li>
<p><strong>æç¤ºè¯æ¨¡æ¿</strong></p>
<pre><code>è¯·ä¸¥æ ¼æç§ openspec/changes/&lt;change-name&gt;/tasks.md å®ç°ã

æ§è¡è¦æ±ï¼
1. æç¼å·é¡ºåºå®ææ¯ä¸ªä»»å¡
2. æ¯å®æä¸ä¸ªï¼è¾åºï¼[DONE] ä»»å¡X.X: &lt;æè¿°&gt;
3. å¨é¨å®æåè¾åºï¼[ALL DONE]
4. éå°é®é¢è¾åºï¼[ERROR]: &lt;æè¿°&gt;
</code></pre>
</li>
<li>
<p><strong>çæ§é¢ç</strong></p>
<ul>
<li>æ¯ 30 ç§æ£æ¥ä¸æ¬¡è¿åº¦</li>
<li>5 åéæ æ° <code>[DONE]</code> æ è®°è§ä¸ºå¡ä½</li>
<li>åå¤å¥½æå¨ååºç plan B</li>
</ul>
</li>
<li>
<p><strong>å·¥å·é¾ç»å</strong></p>
<table>
<thead>
<tr>
<th>å·¥å·</th>
<th>ä½ç¨</th>
<th>ä¼å¿</th>
</tr>
</thead>
<tbody>
<tr>
<td>OpenClaw</td>
<td>ä»»å¡ç®¡ç</td>
<td>ä¼è¯ãçæ§ãéè¯¯å¤ç</td>
</tr>
<tr>
<td>OpenSpec</td>
<td>è§èå®ä¹</td>
<td>ç»æåéæ±ãæäºè¿½æº¯</td>
</tr>
<tr>
<td>OpenCode</td>
<td>ä»£ç çæ</td>
<td>æè§èèªå¨å®ç°</td>
</tr>
</tbody>
</table>
</li>
</ol>
<h3 id="éç¨åºæ¯">éç¨åºæ¯</h3>
<p><strong>éåï¼</strong></p>
<ul>
<li>â åè½æç¡®ãè¾¹çæ¸æ°çéæ±</li>
<li>â éå¤æ§ç CRUD æä½</li>
<li>â æ°æ®åºè¿ç§»ãAPI å¼å</li>
<li>â åºäºç°ææ¨¡å¼çæ©å±</li>
</ul>
<p><strong>ä¸éåï¼</strong></p>
<ul>
<li>â éæ±æ¨¡ç³ãéè¦æ¢ç´¢</li>
<li>â å¤ææ¶æè®¾è®¡</li>
<li>â æ·±åº¦æ§è½ä¼å</li>
<li>â åæ°æ§ç®æ³</li>
</ul>
<h3 id="æ§è½åºåæ èæ´¾-4b-å®æµ">æ§è½åºåï¼æ èæ´¾ 4B å®æµï¼</h3>
<table>
<thead>
<tr>
<th>åä¸ªåæ´ä»»å¡æ°</th>
<th>æåç</th>
<th>å¹³åèæ¶</th>
<th>æ¨èåº¦</th>
</tr>
</thead>
<tbody>
<tr>
<td>3-6 ä¸ª</td>
<td>95%</td>
<td>3-5åé</td>
<td>â­â­â­â­â­</td>
</tr>
<tr>
<td>7-10 ä¸ª</td>
<td>85%</td>
<td>5-10åé</td>
<td>â­â­â­â­</td>
</tr>
<tr>
<td>11-16 ä¸ª</td>
<td>70%</td>
<td>10-15åé</td>
<td>â­â­â­</td>
</tr>
<tr>
<td>&gt;16 ä¸ª</td>
<td>&lt;30%</td>
<td>å¡ä½</td>
<td>â ä¸æ¨è</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="å®æ´å·¥ä½æµç¤ºä¾">å®æ´å·¥ä½æµç¤ºä¾</h2>
<p><strong>ä»éæ±å°é¨ç½²çæ åæµç¨ï¼</strong></p>
<pre><code>1. éæ±åæï¼ä»»çªï¼
   â
2. åå»º OpenSpec åæ´
   $ openspec change new feature-name
   â
3. ç¼åè§èææ¡£
   - proposal.mdï¼ä¸ºä»ä¹è¦åï¼
   - design.mdï¼æä¹åï¼
   - tasks.mdï¼ä»»å¡æ¸åï¼â¤16ä¸ªä»»å¡ï¼
   â
4. OpenClaw è°ç¨ OpenCode
   $ sessions_spawn task:"å®ç°åè½" label:"implement-feature"
   â
5. å®æ¶çæ§åç®¡ç
   $ sessions_list
   $ sessions_history sessionKey:"..."
   â
6. ä»£ç éªè¯
   - èªå¨è¯­æ³æ£æ¥
   - åè½æµè¯
   â
7. æäº¤åæ¨é
   $ git add .
   $ git commit -m "å®ç°åè½"
   $ git push
   â
8. å½æ¡£è§è
   $ openspec change archive feature-name
</code></pre>
<hr>
<h2 id="ç»è¯­">ç»è¯­</h2>
<p>ç¨ OpenClaw è°ç¨ OpenCode è¿è¡å¼åï¼æå¤§çä»·å¼æ¯<strong>å¯æ§æ§</strong>ã</p>
<ul>
<li>ä»»å¡å¨åå°è¿è¡ï¼ä¸é»å¡å½åä¼è¯</li>
<li>å®æ¶çæ§è¿åº¦ï¼ç¥éåå°åªäº</li>
<li>å¡ä½æ¶èªå¨å¤çææ¥è­¦</li>
<li>ææå·¥ä½å¯è¿½æº¯ãå¯ç®¡ç</li>
</ul>
<p>ä½è¿å¥å·¥å·é¾ä¹æå±éãå®éå<strong>æ§è¡æç¡®çéæ±</strong>ï¼ä¸éå<strong>æ¢ç´¢æªç¥çé®é¢</strong>ãå³é®è¿æ¯<strong>æéæ±æ³æ¸æ¥</strong>ââè¿æ¯ç¨åºåçå·¥ä½ï¼AI æ æ³æ¿ä»£ã</p>
<p>å¦æä½ ä¹å¨å°è¯ç±»ä¼¼çå·¥ä½æµï¼æ¬¢è¿äº¤æµè¸©åç»éªã</p>
<hr>
<h2 id="åèé¾æ¥">åèé¾æ¥</h2>
<ul>
<li>OpenClaw ææ¡£ï¼<a href="https://docs.openclaw.ai" target="_blank" rel="noopener nofollow">https://docs.openclaw.ai</a></li>
<li>OpenSpec ä»åºï¼<a href="https://github.com/fission-ai/openspec" target="_blank" rel="noopener nofollow">https://github.com/fission-ai/openspec</a></li>
<li>OpenCode ææ¡£ï¼<a href="https://opencode.ai" target="_blank" rel="noopener nofollow">https://opencode.ai</a></li>
<li>ç±å¼¥å¿ä»»å¡çæ¿ï¼<a href="https://github.com/ren8179/aimier-kanban" target="_blank" rel="noopener nofollow">https://github.com/ren8179/aimier-kanban</a></li>
</ul>
<hr>
<p><em>æ¬ææ¯ç±å¼¥å¿ä»»å¡çæ¿å¼åè¿ç¨ä¸­ççå®è®°å½ï¼ç± AI å©æç±å¼¥å¿æ´çæ°åã</em></p>


</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-02-13 08:56">2026-02-13 08:56</span>&nbsp;
<a href="https://www.cnblogs.com/rsls">äºè´éç©º</a>&nbsp;
éè¯»(<span id="post_view_count">0</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19606311);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19606311', targetLink: 'https://www.cnblogs.com/rsls/p/19606311', title: 'AIå·¥å·å®è·µæ¥è®°ï¼äºï¼ï¼å¨ OpenClaw ä¸­è°ç¨ OpenCode è¿è¡å¼åä»»å¡' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ PHP çé®é¢ä¸å¨è¯­è¨æ¬èº«ï¼èå¨æä»¬æä¹åå® ]]></title>
    <link>https://www.cnblogs.com/catchadmin/p/19610690</link>
    <guid>01311521e35b960b32d35cdd308a9156</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/catchadmin/p/19610690" title="åå¸äº 2026-02-13 07:59">
    <span role="heading" aria-level="2">PHP çé®é¢ä¸å¨è¯­è¨æ¬èº«ï¼èå¨æä»¬æä¹åå®</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h1 id="php-çé®é¢ä¸å¨è¯­è¨æ¬èº«èå¨æä»¬æä¹åå®">PHP çé®é¢ä¸å¨è¯­è¨æ¬èº«ï¼èå¨æä»¬æä¹åå®</h1>
<p>ä»£ç åºçäºä¸æ¯è¯­è¨çéï¼æ¯èµ¶å·¥åæ¯æ§ã</p>
<p>PHP çå£ç¢ï¼å ä¹å¨æ¯æ¬¡ææ¯è®¨è®ºä¸­é½ä¼è¢«æåºæ¥ãåºç¨æ¢ãä¹±ãä¸å®å¨ãæ¹èµ·æ¥çè¦ï¼æ»æäººè¸è¸è©è¯´ï¼"å¯â¦â¦æ¯ç«æ¯ PHP åã"</p>
<p>è¿è¯å¾å°åºäºææ¯å¤æ­ï¼æ´åæ¯ä¸ç§ä¹ æ¯æ§ç©éã</p>
<p>äºå®æ¯è¿ç®åï¼ä¹æ´æå¿ï¼å¤§å¤æ° PHP ç³»ç»ä¹æä»¥é¾ç»´æ¤ï¼æ¯æä»¬èªå·±æ¾ä»»çç»æãPHP ä¸ä¼ä¸ä¸æ¥å°±é¼ä½ åæ¶æè®¾è®¡ãåè¾¹çãå®è§ç©ãå®å¾å®½å®¹ï¼å¾å¡å®ï¼ç¹å«æé¿è®©ä½ æä¸ä¸ªâè½è·å°±è¡âçä¸è¥¿èµ¶åºæ¥ã</p>
<p>ä½ä»å¤©è½è·çä»£ç åºï¼æå¤©å¯è½å°±æ¯ç¾é¾ã</p>
<p>ä¸ä¸ª PHP é¡¹ç®æ²¦ä¸ºæææäºï¼å¾å°æ¯å ä¸º PHP åä¸å°æ´å¥½ï¼èæ¯å¢éä»æ¥æ²¡å»æé£äºè½è®©é¡¹ç®è¶åè¶å¤§è¿ä¸å´©çä¹ æ¯ââç»æãæµè¯ãçº¦å®ãå³æ³¨ç¹åç¦»ã</p>
<p>ç°ä»£ PHP å®å¨æè½ååå°ï¼</p>
<ul>
<li>ä¸¥æ ¼ç±»åï¼æ¯çï¼çæ­£çç±»åï¼</li>
<li>æ´æ´æ¶æ</li>
<li>ä¾èµæ³¨å¥</li>
<li>è¡¨è¾¾åå¼ºçé¢åæ¨¡å</li>
<li>è§èçéè¯¯å¤ç</li>
<li>å¯é çæµè¯</li>
<li>é«æ§è½ï¼OPcache/JITãç¼å­ãåçç I/Oï¼</li>
<li>æççå·¥å·é¾</li>
</ul>
<p>å¦æä½ å¯¹ PHP çå°è±¡è¿åçå¨"å°å¤ include æä»¶"å"å¨è§å¾éå SQL"ï¼é£ä½ éªçä¸æ¯ PHP è¿é¨è¯­è¨ï¼èæ¯ä¸ç§æ©è¯¥è¢«æ·æ±°ç PHP åæ³ã</p>
<p>è¿ç¯æç« ä¸æ¯å¨ç» PHP æ´å°ï¼åªæ¯æ³è¯´æ¸æ¥ä¸ä»¶äºï¼PHP æ¯ä¸é¢éå­ï¼ç§åºæ¥çæ¯ä½ çå·¥ç¨æåãç§åºæ¥ä¸å¥½çï¼æ¢é¢éå­ä¹æ²¡ç¨ã</p>
<h2 id="php-å¾å®½å®¹å®½å®¹çè¯­è¨ä¼æ¾å¤§ä½ çä¹ æ¯">PHP å¾å®½å®¹ââå®½å®¹çè¯­è¨ä¼æ¾å¤§ä½ çä¹ æ¯</h2>
<p>æäºè¯­è¨çæä»ä¸å¼å§å°±é¼ä½ æç»ææ­å¥½ãæ³åç¨å¾®å¤æä¸ç¹çä¸è¥¿ï¼å°±ç»ä¸å¼åãæ¨¡åãæ¥å£ãä¾èµæ³¨å¥è¿äºæ¦å¿µï¼åªæä½ æ²¡ä¸»å¨è¦æ±ï¼çº¦æä¹èªå¨å°±å¨é£äºã</p>
<p>PHP çç©æ³ä¸ä¸æ ·ï¼</p>
<ul>
<li>å¯ä»¥ä»ä¸ä¸ªæä»¶èµ·æ­¥</li>
<li>å¯ä»¥æ¯«æ é»åå°æ··ååå±</li>
<li>å¯ä»¥å¨ä»»ä½å°æ¹è®¿é®å¨å±åé</li>
<li>å¯ä»¥å¨æ§å¶å¨éç´æ¥æ¥æ°æ®åº</li>
<li>å¯ä»¥å¿½ç¥ç±»åç§æ ·ä¸çº¿</li>
</ul>
<p>è¿ç§çµæ´»æ§æ¬èº«ä¸æ¯åäºï¼PHP é å®å½äºå¤å¹´ Web å¼åçé»è®¤éæ©ãä½å®ä¹åäºä¸ä¸ªåï¼ç»ææ¾å¾å¯æå¯æ ï¼èå¯æå¯æ çä¸è¥¿å¨èµ¶å·¥æ¶ä¸å®ä¼è¢«ç æã</p>
<p>å¾å¤âPHP å¤ªçäºâçæäºï¼èåççå®å§ææ¯âèµ¶å·¥æä¸äºçº¿ï¼ç¶åéæçåºä¸ç´æ²¡è¿âã</p>
<p>PHP æ²¡æé æè¿ä¸ªé®é¢ï¼å®åªæ¯æ²¡æé»æ­¢ã</p>
<h2 id="é½æª-phpå¾å¾æ¯å¨éé¿è´£ä»»">"é½æª PHP"å¾å¾æ¯å¨éé¿è´£ä»»</h2>
<p>ç³»ç»è®©äººçè¦çæ¶åï¼ç©éç»è¯­è¨æçäºï¼å ä¸ºè¯­è¨æå®¹æçå°ãçæ­£çåå å¾å¾èå¾æ´æ·±ï¼</p>
<ul>
<li>æ²¡æç»ä¸çç¼ç è§è</li>
<li>æ²¡ææ¶æè´è´£äºº</li>
<li>æ²¡ææµè¯</li>
<li>æ²¡æä¸ºéæåéæ¶é´</li>
<li>ä»£ç è¯å®¡æ¶æ¾æ¶ç´§</li>
<li>"åäº¤ä»åè¯´"çæ¿å±æºå¶</li>
</ul>
<p>è¿äºé®é¢åªä¸ªææ¯æ é½æãåºå«å¨äº PHP è½è®©ä½ å¨å ä¹æ²¡æçº¦æçæåµä¸æé¡¹ç®æ¨å¾å¾è¿ï¼ææ¯åºæææçââç¶åå¨æä¸å¤©éä¸­çåã</p>
<p>PHP æäºæ¿ç½ªç¾ï¼å ä¸ºæ¿è®¤æµç¨çäºï¼æ¯ç©éç»è¯­è¨é¾å¤äºã</p>
<h2 id="ç°ä»£-php-ä¸æ¯ä½ è®°å¿ä¸­ç-php">ç°ä»£ PHP ä¸æ¯ä½ è®°å¿ä¸­ç PHP</h2>
<p>å¦æä½ å¯¹ PHP çè®¤ç¥è¿åå¨"PHP 5 å ä¸å éæ include"çå¹´ä»£ï¼é£ä½ éè¿çä¸è¥¿å¤ªå¤äºï¼</p>
<ul>
<li><code>declare(strict_types=1);</code></li>
<li>æ éç±»ååè¿åç±»å</li>
<li>ç±»ååå±æ§</li>
<li>èåç±»å</li>
<li>æä¸¾</li>
<li>å±æ§æ³¨è§£ï¼Attributesï¼</li>
<li>æ´å¥½çéè¯¯è¯­ä¹</li>
<li>Composer æä¸ºæ é</li>
<li>PSR æ å</li>
<li>ä¼ç§çæ¡æ¶ï¼LaravelãSymfonyï¼åç»ä»¶</li>
<li>éæåæå·¥å·ï¼PHPStan/Psalmï¼</li>
<li>ä»£ç æ ¼å¼åå·¥å·ï¼PHP-CS-Fixerï¼</li>
<li>å®¹å¨å / CI å·¥ä½æµ</li>
</ul>
<p>è¯­è¨è¿åäºï¼ä½å¾å¤å¢éæ²¡æã</p>
<p>æä»¥çæ­£çé®é¢æ¯ï¼ä½ å PHP çæ¶åï¼æ¯æå®å½æä¸é¨ç°ä»£åç«¯è¯­è¨ï¼è¿æ¯å½æèµ¶å·¥æ¶ååç¨çèæ¬ï¼</p>
<h2 id="ç»å¸-php-åæ¨¡å¼ä»ä¹é½å¡è¿æ§å¶å¨">ç»å¸ PHP åæ¨¡å¼ï¼"ä»ä¹é½å¡è¿æ§å¶å¨"</h2>
<p>ä¸é¢è¿å¥æµç¨ï¼å¨å¾å¤é¡¹ç®éé½è½çå°ï¼</p>
<ol>
<li>æ§å¶å¨æ¥æ¶è¯·æ±</li>
<li>æ§å¶å¨åéªè¯</li>
<li>æ§å¶å¨æ¼æ¥è¯¢</li>
<li>æ§å¶å¨å¤çä¸å¡è§å</li>
<li>æ§å¶å¨æ´æ°æ°æ®åº</li>
<li>æ§å¶å¨æ ¼å¼åååº</li>
<li>æ§å¶å¨è§¦åå¯ä½ç¨ï¼é®ä»¶ãéåï¼</li>
</ol>
<p>è½è·ï¼è½ä¸çº¿ï¼åè½è¿è½å¾ä¸å ãç¶åå°±å¼å§åèââå ä¸ºæ§å¶å¨å·²ç»åæäºä¸ä¸ªæ½äºä¸å¡è§åãæ°æ®æä¹åå I/O çä¸å¸å¯¹è±¡ã</p>
<p>çä¸ä¸ªç®åççä¾å­ã</p>
<h3 id="-åæ¨¡å¼ææé»è¾å¡å¨æ§å¶å¨é">â åæ¨¡å¼ï¼ææé»è¾å¡å¨æ§å¶å¨é</h3>
<pre><code class="language-php">&lt;?php
class CheckoutController
{
    public function placeOrder(array $request): array
    {
        $userId = (int)($request['user_id'] ?? 0);
        $items  = $request['items'] ?? [];
        if ($userId &lt;= 0 || empty($items)) {
            return ['ok' =&gt; false, 'error' =&gt; 'Invalid request'];
        }
        $pdo = new PDO($_ENV['DB_DSN'], $_ENV['DB_USER'], $_ENV['DB_PASS']);
        $pdo-&gt;beginTransaction();
        try {
            // Load user
            $stmt = $pdo-&gt;prepare("SELECT id, status FROM users WHERE id = ?");
            $stmt-&gt;execute([$userId]);
            $user = $stmt-&gt;fetch(PDO::FETCH_ASSOC);
            if (!$user || $user['status'] !== 'active') {
                throw new RuntimeException("User not active");
            }
            // Calculate total
            $total = 0;
            foreach ($items as $it) {
                $productId = (int)$it['product_id'];
                $qty       = (int)$it['qty'];
                $stmt = $pdo-&gt;prepare("SELECT id, price, stock FROM products WHERE id = ?");
                $stmt-&gt;execute([$productId]);
                $product = $stmt-&gt;fetch(PDO::FETCH_ASSOC);
                if (!$product) {
                    throw new RuntimeException("Product not found");
                }
                if ($qty &lt;= 0 || $qty &gt; (int)$product['stock']) {
                    throw new RuntimeException("Insufficient stock");
                }
                $total += ((int)$product['price']) * $qty;
                // Reduce stock inline
                $stmt = $pdo-&gt;prepare("UPDATE products SET stock = stock - ? WHERE id = ?");
                $stmt-&gt;execute([$qty, $productId]);
            }
            // Insert order
            $stmt = $pdo-&gt;prepare("INSERT INTO orders(user_id, total, created_at) VALUES(?, ?, NOW())");
            $stmt-&gt;execute([$userId, $total]);
            $orderId = (int)$pdo-&gt;lastInsertId();
            // Insert items
            $stmt = $pdo-&gt;prepare("INSERT INTO order_items(order_id, product_id, qty) VALUES(?, ?, ?)");
            foreach ($items as $it) {
                $stmt-&gt;execute([$orderId, (int)$it['product_id'], (int)$it['qty']]);
            }
            $pdo-&gt;commit();
            return ['ok' =&gt; true, 'order_id' =&gt; $orderId, 'total' =&gt; $total];
        } catch (Throwable $e) {
            $pdo-&gt;rollBack();
            return ['ok' =&gt; false, 'error' =&gt; $e-&gt;getMessage()];
        }
    }
}
</code></pre>
<p>è¿æ®µä»£ç çï¼ä¸æ¯å ä¸ºå®ç¨ PHP åçï¼èæ¯å ä¸ºå®æè¿äºä¸è¥¿å¨æå¨äºä¸èµ·ï¼</p>
<ul>
<li>è¾å¥éªè¯</li>
<li>äºå¡ç®¡ç</li>
<li>ä¸å¡è§å</li>
<li>æä¹å</li>
<li>ç¶æåæ´</li>
<li>ååºæ ¼å¼å</li>
</ul>
<p>ä¸è¿æ°æ®åºå°±æ²¡æ³æµä¸å¡é»è¾ï¼ä¸å¤å¶ä»£ç å°±æ²¡æ³å¤ç¨è§åï¼æ¹ä¸ä¸ªå°å°æ¹é½æå¿åèã</p>
<p>å¦æä½ å¹³æ¶è§å°ç PHP é½é¿è¿æ ·ï¼æåè§å¾æ­£å¸¸ãä½è¯è¯´åæ¥ï¼PHP æ²¡é¼ä½ åæè¿æ ·ââæä»¬èªå·±éçè¿æ¡è·¯ï¼å¾çå°±æ¯å¿«ã</p>
<h2 id="å¥½ç-phpé¿ä»ä¹æ ·æ èçç»ææ¸æ°çè¾¹ç">"å¥½ç PHP"é¿ä»ä¹æ ·ï¼æ èçç»æï¼æ¸æ°çè¾¹ç</h2>
<p>åå¾å¥½ç PHP ä»£ç å¾å¾çèµ·æ¥"æ²¡ä»ä¹ææ¯å«é"ãè¿ä¸æ¯åäºââæ èçä»£ç å°±æ¯å¯é¢æµçä»£ç ã</p>
<p>æ´åççåå±æ¹å¼æ¯ï¼</p>
<ul>
<li>æ§å¶å¨åªå¤ç HTTP å±ï¼è¯·æ±/ååºï¼</li>
<li>åºç¨/æå¡å±åè°ç¨ä¾</li>
<li>é¢åå¯¹è±¡è´è´£ç»´æ¤ä¸å¡ä¸åé</li>
<li>ä»å¨å±å¤çæä¹å</li>
<li>å¯ä½ç¨éè¿æ¥å£éç¦»</li>
</ul>
<p>ä¸é¢ç¨æ´æ¸æ°çç»æéååä¸ä¸ªåè½ã</p>
<h3 id="-ç°ä»£-php-ç¨ä¾é£æ ¼">â ç°ä»£ PHP "ç¨ä¾"é£æ ¼</h3>
<p>ä¸é¢çä»£ç å°½éç²¾ç®ââä¸ç»å®ç¹å®æ¡æ¶ï¼ä½å Laravel/Symfony çåæ³å¼å®¹ã</p>
<p><strong>Step Aï¼å®ä¹è¯·æ± DTO</strong></p>
<pre><code class="language-php">&lt;?php
declare(strict_types=1);
final class PlaceOrderCommand
{
    /**
     * @param array&lt;int, array{productId:int, qty:int}&gt; $items
     */
    public function __construct(
        public readonly int $userId,
        public readonly array $items
    ) {}
}
</code></pre>
<p><strong>Step Bï¼å®ä¹é¢åå¼å¸¸ï¼ä¸å¡éè¯¯ä¸åºè¯¥æ¯ 500ï¼</strong></p>
<pre><code class="language-php">&lt;?php
declare(strict_types=1);
class DomainException extends RuntimeException {}
final class UserNotActive extends DomainException {}
final class ProductNotFound extends DomainException {}
final class InsufficientStock extends DomainException {}
final class InvalidOrder extends DomainException {}
</code></pre>
<p><strong>Step Cï¼ä¸ºä¾èµå®ä¹å°æ¥å£</strong></p>
<pre><code class="language-php">&lt;?php
declare(strict_types=1);
interface UserRepository
{
    public function getStatus(int $userId): ?string;
}
final class ProductSnapshot
{
    public function __construct(
        public readonly int $id,
        public readonly int $price,
        public readonly int $stock
    ) {}
}
interface ProductRepository
{
    public function getSnapshot(int $productId): ?ProductSnapshot;
    public function decreaseStock(int $productId, int $qty): void;
}
final class OrderResult
{
    public function __construct(
        public readonly int $orderId,
        public readonly int $total
    ) {}
}
interface OrderRepository
{
    /**
     * @param array&lt;int, array{productId:int, qty:int, price:int}&gt; $lines
     */
    public function create(int $userId, int $total, array $lines): int;
}
interface TransactionManager
{
    /**
     * @template T
     * @param callable():T $fn
     * @return T
     */
    public function run(callable $fn): mixed;
}
</code></pre>
<p><strong>Step Dï¼å®ç°ç¨ä¾ï¼æå¡å±ï¼</strong></p>
<pre><code class="language-php">&lt;?php
declare(strict_types=1);
final class PlaceOrderHandler
{
    public function __construct(
        private readonly TransactionManager $tx,
        private readonly UserRepository $users,
        private readonly ProductRepository $products,
        private readonly OrderRepository $orders
    ) {}
    public function handle(PlaceOrderCommand $cmd): OrderResult
    {
        if ($cmd-&gt;userId &lt;= 0 || $cmd-&gt;items === []) {
            throw new InvalidOrder("User and items are required.");
        }
        $status = $this-&gt;users-&gt;getStatus($cmd-&gt;userId);
        if ($status !== 'active') {
            throw new UserNotActive("User is not active.");
        }
        return $this-&gt;tx-&gt;run(function () use ($cmd): OrderResult {
            $lines = [];
            $total = 0;
            foreach ($cmd-&gt;items as $item) {
                $productId = $item['productId'];
                $qty       = $item['qty'];
                if ($qty &lt;= 0) {
                    throw new InvalidOrder("Quantity must be &gt; 0.");
                }
                $snapshot = $this-&gt;products-&gt;getSnapshot($productId);
                if (!$snapshot) {
                    throw new ProductNotFound("Product {$productId} not found.");
                }
                if ($qty &gt; $snapshot-&gt;stock) {
                    throw new InsufficientStock("Insufficient stock for {$productId}.");
                }
                $lineTotal = $snapshot-&gt;price * $qty;
                $total += $lineTotal;
                // Reserve/update stock
                $this-&gt;products-&gt;decreaseStock($productId, $qty);
                $lines[] = [
                    'productId' =&gt; $productId,
                    'qty'       =&gt; $qty,
                    'price'     =&gt; $snapshot-&gt;price,
                ];
            }
            $orderId = $this-&gt;orders-&gt;create($cmd-&gt;userId, $total, $lines);
            return new OrderResult($orderId, $total);
        });
    }
}
</code></pre>
<p><strong>Step Eï¼æ§å¶å¨åå¾è½»èä¸å¯æµè¯</strong></p>
<pre><code class="language-php">&lt;?php
declare(strict_types=1);
final class CheckoutController
{
    public function __construct(private readonly PlaceOrderHandler $handler) {}
    public function placeOrder(array $request): array
    {
        try {
            $itemsRaw = $request['items'] ?? [];
            $items = array_map(
                fn($it) =&gt; [
                    'productId' =&gt; (int)($it['product_id'] ?? 0),
                    'qty'       =&gt; (int)($it['qty'] ?? 0),
                ],
                is_array($itemsRaw) ? $itemsRaw : []
            );
            $cmd = new PlaceOrderCommand(
                userId: (int)($request['user_id'] ?? 0),
                items: $items
            );
            $result = $this-&gt;handler-&gt;handle($cmd);
            return [
                'ok' =&gt; true,
                'order_id' =&gt; $result-&gt;orderId,
                'total' =&gt; $result-&gt;total,
            ];
        } catch (DomainException $e) {
            return ['ok' =&gt; false, 'error' =&gt; $e-&gt;getMessage()];
        } catch (Throwable $e) {
            // avoid leaking internals
            return ['ok' =&gt; false, 'error' =&gt; 'Unexpected error'];
        }
    }
}
</code></pre>
<p>è¿ä¸ªçæ¬ä¸æ¯"ä¸ºäºå¤æèå¤æ"ï¼èæ¯æå¤æåº¦æ¾å°äºè¯¥æ¾çå°æ¹ï¼</p>
<ul>
<li>ä¸å¡è§åéä¸­ç®¡ç</li>
<li>äºå¡åæ§</li>
<li>æ§å¶å¨æç®</li>
<li>ä¾èµæ½è±¡å</li>
<li>ç»äºå¯ä»¥åæµè¯äº</li>
</ul>
<p>èä¸è¿äºå¨æ¯åç PHPï¼æ²¡ç¨ä»ä¹é»é­æ³ã</p>
<h2 id="æµè¯åæ­¢ç©éç»è¯­è¨çæå¿«æ¹å¼">æµè¯ï¼åæ­¢ç©éç»è¯­è¨çæå¿«æ¹å¼</h2>
<p>å¾å¤ PHP å¢éä¸åæµè¯ï¼å ä¸ºæ©å¹´åèµ·æ¥ç¡®å®å«æ­ãä½ç°å¨ç PHP åæµè¯å·²ç»å¾é¡ºæäºã</p>
<p>ä¸é¢ç¨ä¸ä¸ªç®åç PHPUnit ä¾å­æ¼ç¤ºï¼éè¿ mock ä»å¨æµè¯ä¸å¡é»è¾ï¼å®å¨ä¸éè¦æ°æ®åºã</p>
<h3 id="-phpunit-é£æ ¼çååæµè¯æ éæ°æ®åº">â PHPUnit é£æ ¼çååæµè¯ï¼æ éæ°æ®åºï¼</h3>
<pre><code class="language-php">&lt;?php
declare(strict_types=1);
use PHPUnit\Framework\TestCase;
final class PlaceOrderHandlerTest extends TestCase
{
    public function test_it_places_an_order_and_returns_total(): void
    {
        $tx = new class implements TransactionManager {
            public function run(callable $fn): mixed { return $fn(); }
        };
        $users = new class implements UserRepository {
            public function getStatus(int $userId): ?string { return 'active'; }
        };
        $products = new class implements ProductRepository {
            private array $stock = [10 =&gt; 5];
            public function getSnapshot(int $productId): ?ProductSnapshot {
                if ($productId !== 10) return null;
                return new ProductSnapshot(10, price: 200, stock: $this-&gt;stock[10]);
            }
            public function decreaseStock(int $productId, int $qty): void {
                $this-&gt;stock[$productId] -= $qty;
            }
        };
        $orders = new class implements OrderRepository {
            public function create(int $userId, int $total, array $lines): int { return 123; }
        };
        $handler = new PlaceOrderHandler($tx, $users, $products, $orders);
        $cmd = new PlaceOrderCommand(
            userId: 7,
            items: [
                ['productId' =&gt; 10, 'qty' =&gt; 2],
            ]
        );
        $result = $handler-&gt;handle($cmd);
        $this-&gt;assertSame(123, $result-&gt;orderId);
        $this-&gt;assertSame(400, $result-&gt;total);
    }
}
</code></pre>
<p>å¦æä½ çç¨ä¾è½è¿æ ·æµè¯ï¼"PHP ä¸å¯ç»´æ¤"è¿ç§è¯å°±å¾é¾åçç´æ°å£®å°è¯´åºå£äºãå¯ç»´æ¤æ§ä¸æ¯è¯­è¨èªå¸¦çè½åï¼æ¯é ç»æåæµè¯æèµ·æ¥çã</p>
<h2 id="æ¡æ¶ç¥è¯laravelsymfony-ä¸ä¼èªå¨æ¯æä½ ">"æ¡æ¶ç¥è¯"ï¼Laravel/Symfony ä¸ä¼èªå¨æ¯æä½ </h2>
<p>æ¡æ¶æç¨ï¼ä½å®æ¦ä¸ä½ä½ ååºçæ¶æãæ¯å¦å¨ Laravel éï¼ä½ ç§æ ·å¯ä»¥ï¼</p>
<ul>
<li>ååºèè¿çæ§å¶å¨</li>
<li>æé¢åé»è¾å¨å¡è¿ Eloquent æ¨¡å</li>
<li>å ä¸ºè§å¾"ç»äºä¸å±"èç´æ¥è·³è¿æå¡å±</li>
</ul>
<p>å¦æä½ è§è¿æ§å¶å¨åäº 800 è¡ç Laravel é¡¹ç®ï¼é®é¢ä¸å¨ Laravelï¼èå¨äºå¢éææ¡æ¶å½æäºä¸åè®¾è®¡ççç±ã</p>
<p>æ¡æ¶æ¯å·¥å·ç®±ãå®è½çæ¿å­ââä¹è½å ä¸å æ¨å¤´ã</p>
<h2 id="ä¸ºä»ä¹-php-æ¯å¶ä»ææ¯æ æ´å®¹ææ¨éª">ä¸ºä»ä¹ PHP æ¯å¶ä»ææ¯æ æ´å®¹ææ¨éª</h2>
<p>åå è¯´èµ·æ¥æç¹å¾®å¦ï¼å¨ PHP éï¼ç³ç³çå³ç­æ´é²å¾æ´å¿«ã</p>
<p>æäºææ¯æ çæ½è±¡å±è½æçä»£ç çä½æ´é¿æ¶é´ãä½å¨ PHP éï¼åå¾çä¸ç¼å°±è½çåºæ¥ï¼</p>
<ul>
<li>èè´£æ··æ</li>
<li>çº¦å®ä¸ä¸è´</li>
<li>å¤å¶ç²è´´çéå¤ä»£ç </li>
<li>éè½çå¨å±åé</li>
<li>éæçéè¯¯å¤ç</li>
</ul>
<p>PHP ä¸ä¼æ¿ä½ ååºï¼æä»¥å®æå®¹æè¢«æåºæ¥å½é¶å­ã</p>
<p>ä½ä¸é¨é¼ä½ å®è§ç©çè¯­è¨ä¸è§å¾"æ´å¥½"ï¼å®åªæ¯è®©ä½ æ´é¾å·æãPHP æé¨æ§æ¾å¾å¾ä½ââæä»¥ä½ çå¢éæååèæ´éè¦ã</p>
<h2 id="æ´æ´ç-phpå¾æ èè¿æ¯å¤¸å¥">"æ´æ´ç PHP"å¾æ èââè¿æ¯å¤¸å¥</h2>
<p>åå¾æ´æ´ç PHP ä»£ç ï¼éå¸¸çèµ·æ¥å¹³å¹³æ å¥ï¼</p>
<ul>
<li>å½åæ¸æ°</li>
<li>å½æ°ç­å°</li>
<li>è¾å¥è¾åºæç¡®</li>
<li>éè¯¯å¤çå¯é¢æµ</li>
<li>ä¾èµæ³¨å¥</li>
<li>å°½éå°çé­æ³</li>
</ul>
<p>å®ä¸ç«æï¼ä¸è¿½æ±å·§å¦ã</p>
<p>æ èçä»£ç å¨åæ¨ä¸¤ç¹å®¹æè°è¯ãæ èçä»£ç å®¹æäº¤ç»æ°åäºãæ èçä»£ç å¨å¢éæ©å¼ æ¶è½æå¾ä½ã</p>
<p>å¦æä½ å¸æ PHP ä¸åè¢«å½ç¬è¯ï¼é£å°±åæ èç PHPã</p>
<h2 id="å®ææ¸åå¦ä½åæ­¢åè¢«äººéªç-php">å®ææ¸åï¼å¦ä½åæ­¢å"è¢«äººéª"ç PHP</h2>
<p>å¦æä½ æ³ååºä¸è¢«äººå²ç¬ç PHP ç³»ç»ï¼ä¸é¢æ¯ä¸ä»½å®ç¨çåºçº¿æ¸åï¼</p>
<ul>
<li><strong>å¨æ°ä»£ç ä¸­å¼å¯ä¸¥æ ¼ç±»å</strong>ï¼<code>declare(strict_types=1);</code></li>
<li><strong>ææä¾èµéè¿ Composer åèªå¨å è½½ç®¡ç</strong>ï¼ä¸è¦æå¨ includeã</li>
<li><strong>ä¿ææ§å¶å¨è½»è</strong>ï¼åªå¤ç HTTPï¼ï¼ä¸å¡è§åæ¾å° handler/service ä¸­ã</li>
<li><strong>é¢åè§ååæä¹ååç¦»</strong>ï¼ä»å¨ææ¥è¯¢æå¡è½ä¿ææ°æ®è®¿é®çä¸è´æ§ã</li>
<li><strong>ä½¿ç¨æ¾å¼ç DTO ä¼ éè¯·æ±åå½ä»¤</strong>ï¼ä¸è¦å°å¤ä¼ è£¸æ°ç»ã</li>
<li><strong>åºåé¢åéè¯¯åç³»ç»éè¯¯</strong>ï¼ä¸æ¯æ¯ä¸ªå¼å¸¸é½è¯¥æ¯ 500ã</li>
<li><strong>å¨ç¨ä¾å±æ·»å ååæµè¯</strong>ï¼å¦æä¸å¡é»è¾ç¦»äºæ°æ®åºå°±æ²¡æ³æµï¼è¯´æä½ çè¾¹çåéäºã</li>
<li><strong>ä½¿ç¨éæåæå·¥å·</strong>ï¼PHPStan/Psalmï¼é²æ­¢éæ§åå½ã</li>
<li><strong>å¼å¥ä»£ç é£æ ¼å·¥å·å¹¶å¨ CI ä¸­å¼ºå¶æ§è¡</strong>ï¼ä¸è´æ§å¾éè¦ã</li>
<li><strong>æç»­éæ</strong>ï¼å¦æéæåæäº"ä¸ä¸ªé¡¹ç®"ï¼é£å®æ°¸è¿ä¸ä¼åçã</li>
</ul>
<p>ä»¥ä¸è¿äºä¸æ¯ PHP ç¬æçââæ°æ°ç¸åï¼æ¾å°åªä¸ªè¯­è¨é½ä¸æ ·ã</p>
<h2 id="ç»è¯­php-æ¯ä¸é¢éå­å«ç ¸éå­">ç»è¯­ï¼PHP æ¯ä¸é¢éå­ââå«ç ¸éå­</h2>
<p>PHP ä¸å®ç¾ï¼æ²¡æè¯­è¨æ¯å®ç¾çãä½ç¨ PHP éå°çå¤§é¨åçè¦ä¸æ¯è¯­è¨é æçï¼èæ¯åæ³é æçï¼èµ¶å·¥ãèè´£æ··æãè¾¹çæ¨¡ç³ã"ä»¥ååæ¹"çæåã</p>
<p>ä¸ä¸ª PHP é¡¹ç®åå¾ä¸å¯æ¶æ¾çæ¶åï¼å¾å°æ¯å ä¸º PHP æä¸èµ·å¥½æ¶æï¼èæ¯ä»æ¥æ²¡äººææ¶æå½åäºã</p>
<p>PHP æ¯ä¸é¢éå­ï¼</p>
<ul>
<li>å¦æä½ æçºªå¾ï¼å®çèµ·æ¥å¾ä¸ä¸ã</li>
<li>å¦æä½ å¾éæï¼å®çèµ·æ¥å¾æ··ä¹±ã</li>
<li>å¦æä½ å¨æç»­çèµ¶å·¥ååä¸æ²¡æè´¨éæ åï¼å®çèµ·æ¥å°±åæåºã</li>
</ul>
<p>æä»¥ä¸æ¬¡æäººè¯´"é½æª PHP"çæ¶åï¼ä½ å¯ä»¥åé®ä¸å¥ï¼</p>
<p><strong>æ¯ PHP çé®é¢â¦â¦è¿æ¯æä»¬æµç¨çé®é¢ï¼</strong></p>
<p>å ä¸ºä»£ç ä¸æ¯è¯­è¨èªå·±åçã</p>
<p>æ¯ä½ åçã</p>
<p><a href="https://catchadmin.com/post/2026-02/php-problem-isnt-language" target="_blank" rel="noopener nofollow">PHP çé®é¢ä¸å¨è¯­è¨æ¬èº«ï¼èå¨æä»¬æä¹åå® </a></p>


</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-02-13 07:59">2026-02-13 07:59</span>&nbsp;
<a href="https://www.cnblogs.com/catchadmin">JaguarJack</a>&nbsp;
éè¯»(<span id="post_view_count">4</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19610690);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19610690', targetLink: 'https://www.cnblogs.com/catchadmin/p/19610690', title: 'PHP çé®é¢ä¸å¨è¯­è¨æ¬èº«ï¼èå¨æä»¬æä¹åå®' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ è§£å¯Promptç³»å69. ä»ä¸ä¸æç®¡çå°Runtimeæä½ç³»ç» ]]></title>
    <link>https://www.cnblogs.com/gogoSandy/p/19610681</link>
    <guid>3756f1bd39839936135f3ed4cf771997</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/gogoSandy/p/19610681" title="åå¸äº 2026-02-13 07:46">
    <span role="heading" aria-level="2">è§£å¯Promptç³»å69. ä»ä¸ä¸æç®¡çå°Runtimeæä½ç³»ç»</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                    <div id="cnblogs_post_description" style="display: none">
        <img src="https://img2024.cnblogs.com/blog/1326688/202602/1326688-20260213074605660-1624203228.png" alt="è§£å¯Promptç³»å69. ä»ä¸ä¸æç®¡çå°Runtimeæä½ç³»ç»" class="desc_img">
        å¨ LLM åå±çä¸ååºï¼æä»¬æ§çäºä¸æ­æé¿ Context Windowï¼ä» 8K å° 128K çè³ç¾ä¸çº§å«ãä½å¨ä¸ååºæä»¬å´ç»Codingè¿ä¸ªæ ¸å¿è§è§æ¥å¯»æ¾ä¸äºæ°çä¸ä¸æç®¡ççæè·¯
    </div>
<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<p>å¨ LLM åå±çä¸ååºï¼æä»¬æ§çäºä¸æ­æé¿ Context Windowï¼ä» 8K å° 128K çè³ç¾ä¸çº§å«ãä½å¨ä¸ååºï¼èµæ·±å¼åèä»¬éæ¸æè¯å°ï¼ç²ç®æé¿ä¸ä¸ææ¯å¨ç¨æè´µçç®åæ©çé»è¾ç®¡ççæ è½ä¸ºä¾ã è¿ä¸ç« æä»¬å´ç»<strong>Coding</strong>è¿ä¸ªæ ¸å¿è§è§æ¥å¯»æ¾ä¸äºæ°çä¸ä¸æç®¡ççæè·¯ï¼<strong>ä»¥ Coding ä¸ºæ ¸å¿ï¼å° Context è§ä¸ºâåå­ï¼RAMï¼âï¼å° Runtime è§ä¸ºâç¶æï¼Stateï¼âï¼æå»ºä¸å¥å±äºæºè½ä½çâæä½ç³»ç»âã</strong></p>
<p>æè¿ï¼ByteDance ç Context-FoldingãMIT ç RLMãä»¥åç­é¨é¡¹ç® Ralph çåºç°ï¼å±åæåäºä¸ä¸ªæå¶æç¡®çè¶å¿ï¼æªæ¥çæºè½ä½ä¸åæ¯âææ¬çæå¨âï¼èæ¯Stateful Runtime Operatorã</p>
<p>è¿ä¸ç« æä»¬ä¸ç²¾è¯»è®ºæï¼èæ¯å´ç»codingçä¸ä¸æç®¡çï¼åå«çä¸ä»¥ä¸è®ºæä¸­ç¸å³çç¹ã</p>
<h2 id="åå­æå ä¸ä¸æçåçº§æ²»çä¸åå¾åæ¶">åå­æå ï¼ä¸ä¸æçâåçº§æ²»çâä¸åå¾åæ¶</h2>
<blockquote>
<ul>
<li>Scaling Long-Horizon LLM Agent via Context-Folding</li>
</ul>
</blockquote>
<p><img alt="image" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1326688/202602/1326688-20260213074532169-1294839963.png" class="lazyload"><br>
å¨é¿ç¨ä»»å¡ï¼å¦ Deep Research æå¨åºä»£ç ä¿®æ¹ï¼ä¸­ï¼Agent ä¼äº§çæµ·éçä¸­é´å·¥å·è°ç¨æ¥å¿ãä¼ ç»çåæ³æ¯å¨éå å ï¼ä½è¿ä¼å¯¼è´ä¸ä¸æè¿éâéèâã</p>
<ol>
<li>æ ¸å¿å·¥ç¨å®ç°ï¼Branch &amp; Return<br>
å­èçæ¹æ¡éå¸¸ Native å°åé´äº Git åæ¯ç®¡ççæ¦å¿µï¼</li>
</ol>
<ul>
<li>Branch(description, prompt)ï¼åå»ºä¸ä¸ªå­åæ¯ï¼å¼å¯å­ä»»å¡ï¼æ­¤æ¶ææçä¸­é´é»è¾ï¼æç´¢ç»æãè¯»åçé¿æä»¶ï¼ä»å¨å­åæ¯åæµè½¬ã</li>
<li>Return(message)ï¼å­ä»»å¡ç»æï¼ç©çå é¤å­åæ¯åææè¿ç¨ Tokenï¼ä»å°ç²¾ç¼åçæ§è¡ç»æ merge åä¸»åæ¯ã</li>
</ul>
<p><img alt="image" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1326688/202602/1326688-20260213074532146-2119309742.png" class="lazyload"></p>
<p>è¿éå­èæ¯ä½¿ç¨äºGRPOæ¥éè¿è®­ç»ä¼åæ¨¡åè°ç¨BranchåReturnå·¥å·çåç¡®ç¨åº¦ï¼ä¸è¿è¿ä¸ªæå çæè·¯å¶å®æ¯å¯ä»¥éè¿å·¥å·æè¿°ç»åGitçç¸å³æä½æ¥å®ç°ã</p>
<p>è¿æClaude 2.1çææ°è¿­ä»£ä¸­ï¼SKILLSå·²ç»æ¯æäºforkåè½ï¼è®©SKILLSå¨éç¦»çä¸ä¸æä¸­è¿è¡ï¼ä¸ä¼æ±¡æå¤å±ä¼è¯ãæä»¥å¨å½åè¿ä¸ªé¶æ®µï¼å¤§å®¶çæ³æ³é½è¶äºä¸è´æ§~</p>
<h2 id="rlmæä¸ä¸æå½ä½å¤é¨å­å¨çæ¸è¿å¼å è½½">RLMï¼æä¸ä¸æå½ä½âå¤é¨å­å¨âçæ¸è¿å¼å è½½</h2>
<blockquote>
<ul>
<li>RECURSIVE LANGUAGE MODELS</li>
</ul>
</blockquote>
<p>RLM çæè·¯ä¸æ°æ®é¢å¤çä¸­çâæ¸è¿å¼å è½½âå¦åºä¸è¾ï¼å½åå­ï¼Context Windowï¼è£ä¸ä¸è¶å¤§æä»¶ï¼Long Promptï¼æ¶ï¼ä¸è¦å¼ºè¡è´è½½ï¼èæ¯éè¿ç¼ç¨ææ®µåçå¤çã</p>
<p><img alt="image" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1326688/202602/1326688-20260213074532200-1004225961.png" class="lazyload"></p>
<ol>
<li><strong>æ ¸å¿èå¼ï¼ä¸ä¸æå³åé</strong><br>
RLM å°æç¤ºè¯å è½½ä¸º Python REPL ç¯å¢ä¸­çå¨å±åé ctxãæ¨¡åä¸åæ¯âéè¯»âæä»¤ï¼èæ¯éè¿ä»¥ä¸æä½âææ§âæä»¤ï¼</li>
</ol>
<ul>
<li>Probeï¼éè¿ print(ctx[:500]) è§å¯æä»¤å±é¨ã</li>
<li>Split &amp; Loopï¼æ ¹æ®å³é®è¯åå²æä»¤ï¼å¹¶è¿è¡å¾ªç¯éå½ã</li>
<li>Regexï¼å©ç¨æ­£åç²¾åå®ä½å³é®ä¿¡æ¯ã</li>
<li>llm_queryï¼è¿æ¯è®ºæä¸­å¾æææçä¸ä¸ªç¹ï¼ååè½ç¶æå¯¹ææå­çï¼ââå¨ä»£ç ç¯å¢ä¸­ååæ´é²å¤§æ¨¡åè½åï¼å®ç°âæ¨¡ååµå¥ä»£ç ï¼ä»£ç è°ç¨æ¨¡åâã</li>
</ul>
<p>è¿éå¯¹æ¯Context-Foldingå¨æ¯ä¸ªbranchå¼å§è¿éè¦ä¸»Branchåå­branchåéå¨é¨ä¿¡æ¯ï¼èRLMåªéè¦éè¿å¨å±çåéæä¹åï¼å°±å¯ä»¥å®ç°ä¸»è¦ä¿¡æ¯çç´æ¥ä¼ éï¼æ éå¤§éæ¾å¼çä¿¡æ¯ä¼ éã</p>
<p>è¿éå°±æä¸¤ä¸ªç¹æè§æè¯éªä¸çä»·å¼</p>
<ul>
<li><strong>éè¿æä¹ååéä¼ éä¿¡æ¯</strong>ï¼ä¸è¿éè¦æ³¨æçæ¯éè¿printæå°åéçå³é®ä¿¡æ¯ï¼å ä¸ºcodingæ¯ä¸éå¤è½®å¯¹è¯ä¼ éçï¼å æ­¤éè¦å¨è§æµä¸­æ´é²å¿è¦ä¿¡æ¯ï¼è¿ä¸ç¹å¶å®æ¯ä¸ç¨³å®çæ ¹æº</li>
<li><strong>å¨codeç¯å¢ä¸­å¼å¥æ¨¡åæä½</strong>: ä½¿ç¨ä¾å¦RLMå®ä¹çllm_queryè¿ä¸ªå½æ°ï¼å¨ä»£ç å·¥å·ä¸­ååæ´é²å¤§æ¨¡åæä½ï¼ä»èæç®åçä»£ç å·¥å·ï¼è¿ä¸æ­¥æå±ææ¥ææ¨¡åè½åçç¬ç«å­æºè½ä½</li>
</ul>
<p>ä½¿ç¨GPT5çå®æ´æä»¤å¦ä¸ï¼ä»åèæè·¯ï¼ä¸ªäººæ´å¾åä»å·¥å·è§åº¦å»åç»åï¼è¿æ¯è¦é¡ºçæ¨¡ånativeè½åçåå±æ¹åå»åï¼~</p>
<p><img alt="image" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1326688/202602/1326688-20260213074532112-809865702.png" class="lazyload"></p>
<p><img alt="image" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1326688/202602/1326688-20260213074532169-1220552582.png" class="lazyload"></p>
<h2 id="caveagentåæµæ¶æä¸çç¶æåè¿è¡æ¶">CaveAgentï¼åæµæ¶æä¸çâç¶æåâè¿è¡æ¶</h2>
<blockquote>
<ul>
<li>CaveAgent: Transforming LLMs into Stateful Runtime Operators</li>
</ul>
</blockquote>
<p>CaveAgent è¿ä¸æ­¥å¼ºåäºâåéå³è®°å¿âçæè·¯ãå®æåº LLM åºè¯¥å¨ä¸¤ä¸ªæµä¸­åæ¢ï¼</p>
<p><strong>1. Dual-stream Architecture</strong></p>
<ul>
<li>Semantic Streamï¼è¯­ä¹æµï¼ï¼è½»éçº§æ¨çä¸ä¸æï¼ä»è®°å½âæ³äºä»ä¹âã</li>
<li>Runtime Streamï¼è¿è¡æ¶æµï¼ï¼æä¹åç Python ç¯å¢ï¼è®°å½âå­äºä»ä¹âãæ¨¡åç´æ¥æä½å¤é¨åéçâå¥æï¼Handleï¼âèä¸æ¯åå®¹ã</li>
</ul>
<p><img alt="image" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1326688/202602/1326688-20260213074532140-700536232.png" class="lazyload"></p>
<p><strong>2. æ·±åº¦æèï¼åé vs. æä»¶</strong><br>
Manusä¹åå¨ä¸ä¸æç®¡çä¸­æ¨å´ä»¥æä»¶ä½ä¸ºæä¹åä»è´¨ï¼ä½åéå­å¨å¨æäºåºæ¯ä¸æ´æä¼å¿ï¼</p>
<ul>
<li><strong>æ´ç»ç²åº¦çè§æµ</strong>ï¼å©ç¨ df.describe() æ obj.<strong>dict</strong> å¯ä»¥çææ¯æä»¶è¯»åæ´ç²¾ç¼ãç»æåçä¿¡æ¯è§æµï¼State Observationï¼ï¼è¿æ¯ RAG æ£ç´¢æä»¶çæ®µæ´ç²¾åã</li>
<li><strong>è¿è¡æ¶ä¸è´æ§</strong>ï¼åéæ¯ææ¡ä»¶ç­éãå¨ææ´æ°ï¼ä¾å¦ Plan ç»æä½ï¼ï¼æ¯å®æä¸æ­¥ï¼å° is_finish ç½®ä¸º Trueï¼å®ç°åççç¶æè·è¸ªã</li>
</ul>
<p>å¯ä»¥å½åçåéæå¤§çé®é¢å¨äºè§æµä¿¡æ¯çå±é¨åï¼åæä»¶æè§å³æå¾å­å¨å·®å¼ï¼å¦ä½æ´å¨é¢å®æ´ç²¾ç®çæè¿°åéæ¯ä¸ä¸ªå¼å¾æèçé®é¢ã</p>
<h2 id="ralph">Ralph</h2>
<blockquote>
<ul>
<li><a href="https://ghuntley.com/ralph/" target="_blank" rel="noopener nofollow">https://ghuntley.com/ralph/</a></li>
</ul>
</blockquote>
<p>Ralph é¡¹ç®æè¿å¨ç¤¾åºæç«ï¼å®çåå­âRepeatedly running agent in a loopâæ­ç¤ºäºå®çæ¬è´¨ï¼éè¿âä¸ä¸æå½»åºéç½®âæ¥ä¿è¯é¿ç¨ä»»å¡ä¸å´©æºã</p>
<p>æ´ä¸ªæºè½ä½çæ§è¡é¾è·¯ï¼å¨æä»¤éé¢ææ¯è¾æ¸æ°çæè¿°</p>
<pre><code class="language-markdown">## Your Task
1. Read the PRD at `prd.json` (in the same directory as this file)
2. Read the progress log at `progress.txt` (check Codebase Patterns section first)
3. Check you're on the correct branch from PRD `branchName`. If not, check it out or create from main.
4. Pick the **highest priority** user story where `passes: false`
5. Implement that single user story
6. Run quality checks (e.g., typecheck, lint, test - use whatever your project requires)
7. Update AGENTS.md files if you discover reusable patterns (see below)
8. If checks pass, commit ALL changes with message: `feat: [Story ID] - [Story Title]`
9. Update the PRD to set `passes: true` for the completed story
10. Append your progress to `progress.txt`
</code></pre>
<p><strong>1. ä»¥ä»£ç æ§è¡ä¸ºæ ¸å¿çplan &amp; Execute</strong></p>
<ol>
<li>Planç¯è<br>
è¿ä¸æ­¥å¶å®åå¤§å®¶å¸¸ç¨çPlanç±»ä¼¼ï¼Ralphéæ©JSONæä»¶è¿è¡æ­¥éª¤ç®¡çãAnthropicä¹éç¨äºç¸ä¼¼çæè·¯ï¼è®¤ä¸ºJSONæ¯Markdownæ¨¡åè¿è¡ä¹±æ¹çæ¦çæ´å°ãRaphalæçæPlançè¿ç¨æåæäºä¸¤ä¸ªæ­¥éª¤ï¼åå«ç¨SKILLSæ¥å®ç°</li>
</ol>
<ul>
<li>çæmarkdownæ ¼å¼çPRDææ¡£ï¼æ ¹æ®ç¨æ·éæ±ï¼å¯ä»¥éå½è¿½é®æç¡®ç»èï¼ç¶åçæå¯¹åºæ ¼å¼çPRDæä»¶ãä¸¤ä¸ªæ ¸å¿è¦æ±
<ul>
<li>åä¸ªstepè¦è¶³å¤åå­åï¼ä¿è¯ä¸æé¿åº¦å¯ä»¥è¶³å¤å®æä»»å¡ï¼ï¼ä½å®éä¸è¿åªæ¯ç¾å¥½çæ¿æï¼ä¾æ§éè¦åå¤çåç¼©é»è¾æ¥100%ä¿è¯</li>
<li>å·ä½å¯è¡¡éçéªæ¶æ åï¼éè¿lintãtestãbrowser verifyè¿è¡æç¡®éªæ¶åé¦</li>
</ul>
</li>
</ul>
<ol start="2">
<li>Executeç¯è<br>
æ§è¡æ­¥éª¤ï¼ä¼å¾ªç¯ä»¥ä¸PRD.jsonçæææ­¥éª¤ï¼æé¡ºåºè¿è¡æ§è¡ï¼æ¯ä¸ªStepæ§è¡æ¯Bashéé¢å¨æ°çä¸æ¬¡æºè½ä½å¾ªç¯ï¼æä»¥æ¥æå¨æ°çä¸ä¸æï¼ä½æ¯å¼å¥äº<strong>ç»éªåç¼©æ­¥éª¤</strong></li>
</ol>
<ul>
<li>progress.txtï¼åºäºåé¢æ§è¡æ­¥éª¤çéè¦è§æµï¼æ ¸å¿åæ¬å·²å®æåè½ãæä»¶ä¿®æ¹ãä»¥ååé¢æ§è¡ä»»å¡å¯ä»¥åé´çç»éª</li>
<li>Agents.md: ææ´ä¸ªé¡¹ç®å¯å¤ç¨çç¼ç ç»éªï¼å¨æ¯æ¬¡æ§è¡å®æä»¥åï¼æ´æ°å°Agents.mdãå¶å®å¨åé¢çprogerss.txtå·²ç»æä¸è½®<strong>ç»éªåæååç¼©</strong>ãæä»¥å¶å®è¿éæ¯ä¸¤ç§ä¸åç­çº§çç»éªæåï¼ä¸è¿æè§æä»¤éé¢åºåçå¹¶ä¸ç®å¾æ¸æ°ãå¯ä»¥è¿ä¸æ­¥åæProject SpecificåEngineer Specificå¯è½ä¼æ´å æ¸æ°ã</li>
</ul>
<p>ä¸ä¸ªå¤æ­¥å¾ªç¯çDemoå¦ä¸å¾æç¤º<br>
<img alt="image" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1326688/202602/1326688-20260213074532176-1127377954.jpg" class="lazyload"></p>
<h2 id="äº-æ»ç»ä¸çªç ´è¿å-vm-agent-æ¶æ">äºã æ»ç»ä¸çªç ´ï¼è¿å VM-Agent æ¶æ</h2>
<p>ç®åæ»ç»ä¸ï¼Agentçä¸ä¸æåºè¯¥æ¯åºäºç¶ææºåä»£ç è¿è¡æ¶çä¸ä¸ææ²»çåè®®ï¼</p>
<ul>
<li><strong>è§£è¦âæ³âä¸âè®°â</strong>ï¼çªå£åªçå½åä»»å¡ï¼Runtimeå­å¨æ´»è·åéï¼æä»¶ç³»ç»å­å¨é¿æç»éªã</li>
<li><strong>ç¬¦å·åæä½</strong>ï¼å¼ºå¶è¦æ±æ¨¡åéè¿ search()ãsplit()ãfilter() æ¥æç¥é¿ä¸ä¸æï¼ä¸¥ç¦ç´æ¥è¯»åè¶é¿ææ¬ã</li>
<li><strong>éå½å½æ°å</strong>ï¼å°å¤æçå­ä»»å¡å°è£æ Python å½æ°ï¼åé¨è°ç¨ llm_queryï¼å®ç°çæ­£çæ¨¡ååæ¨çã</li>
</ul>
<p>å¨è¿½æ±æ éé¿çcontextçåæ¶ï¼è¿½æ±æ éç²¾ç®çææç¶æ</p>


</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-02-13 07:47">2026-02-13 07:46</span>&nbsp;
<a href="https://www.cnblogs.com/gogoSandy">é£é¨ä¸­çå°ä¸</a>&nbsp;
éè¯»(<span id="post_view_count">7</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19610681);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19610681', targetLink: 'https://www.cnblogs.com/gogoSandy/p/19610681', title: 'è§£å¯Promptç³»å69. ä»ä¸ä¸æç®¡çå°Runtimeæä½ç³»ç»' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ [æè§£LangChainæ§è¡å¼æ] __pregel_tasksééââæå°±âPUSHä»»å¡âçåè£ ]]></title>
    <link>https://www.cnblogs.com/jaydenai/p/19610066/pregel_tasks_channel</link>
    <guid>e4b35a5ffeeee472027b321e134ffa2c</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/jaydenai/p/19610066/pregel_tasks_channel" title="åå¸äº 2026-02-13 07:32">
    <span role="heading" aria-level="2">[æè§£LangChainæ§è¡å¼æ] __pregel_tasksééââæå°±âPUSHä»»å¡âçåè£</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                    <div id="cnblogs_post_description" style="display: none">
        
        é¤äºæä»¬æ¾å¼å£°æçç¨äºå­å¨ä¸å¡æ°æ®æé©±å¨ä¿¡å·çChannelä¹å¤ï¼Pregelèªèº«ä¹ä¼ç»´æ¤ä¸äºç³»ç»Channelï¼å¶ä¸­æéè¦çè«è¿äºä¸ä¸ªåä¸ºâ__pregel_tasksâçChannelï¼æ¯å®æå°±äºåºäºâPUSHâçèç¹ä»»å¡æ§è¡æ¹å¼ã
    </div>
<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<p>é¤äºæä»¬æ¾å¼å£°æçç¨äºå­å¨ä¸å¡æ°æ®æé©±å¨ä¿¡å·çChannelä¹å¤ï¼Pregelèªèº«ä¹ä¼ç»´æ¤ä¸äºç³»ç»Channelï¼å¶ä¸­æéè¦çè«è¿äºä¸ä¸ªåä¸º<code>__pregel_tasks</code>çChannelãéè¿åé¢éå¯¹BSPçä»ç»ï¼æä»¬ç¥éå½Superstepè¿å¥åæ­¥å±éå¹¶åºç¨æææ´æ°åï¼å¼æä¼æ ¹æ®Nodeéå¯¹Channelçè®¢éæåµåChannelèªèº«çæ´æ°ç¶æçæä¸ä¸æ­¥å¾æ§è¡çä»»å¡ï¼å¶å®å¾æ§è¡çä»»å¡ä¸éäºæ­¤ã</p>
<h2 id="1-ä¸¤ç§ä»»å¡åå»ºæ¹å¼">1. ä¸¤ç§ä»»å¡åå»ºæ¹å¼</h2>
<p>æä»¬å°æ ¹æ®Nodeéå¯¹Channelçè®¢éæ¥é©±å¨ä»»å¡æ§è¡çæ¨¡å¼ç§°ä¸º âPullæ¨¡å¼âï¼ä¸ä¹ç¸å¯¹çåæ¯è§£å³â__pregel_tasksâè¿ä¸ªChannelå®ç°çâPushæ¨¡å¼âãå·ä½æ¥è¯´ï¼è¿æ¯ä¸ä¸ªå³é­âç´¯ç§¯æ¨¡å¼âçTopicç±»åçChannelï¼å®å­å¨çâTopicâä½ç°ä¸ºå·æå¦ä¸å®ä¹çSendå¯¹è±¡ãå½æä¸ªNodeæ§è¡ä¹åï¼å¯ä»¥åè¿ä¸ªChannelä¸­åå¥ä¸ä¸ªSendæ¥é©±å¨æä¸ªNodeå¨ä¸ä¸Superstepä¸­æ§è¡ãé¤äºå©ç¨Sendå¯¹è±¡çnodeå­æ®µæå®å¾æ§è¡çNodeåç§°å¤ï¼è¿å¯ä»¥å©ç¨argå­æ®µæä¾è¾å¥åæ°ã</p>
<pre><code class="language-python">class Send:   
    node: str
    arg: Any
    def __init__(self, /, node: str, arg: Any) -&gt; None
</code></pre>
<p>ç±äºå³é­äºâç´¯ç§¯æ¨¡å¼âï¼å¨Topicç±»åChannelä¸­åå¥çåå®¹åªä¼å¨ä¸ä¸ä¸ªSuperstepä¸­çæï¼å¹¶ä¸âéåå³çâãå¯¹äºæ§è¡å¼ææ¥è¯´ï¼è¿ä¸ªåä¸ºâ__pregel_tasksâçChannelå­å¨çå°±æ¯ä¸ä¸Superstepä»¥âPushæ¨¡å¼âé©±å¨æ§è¡çä»»å¡åè¡¨ï¼ä¸¤èå®ç¾å¥åã</p>
<h2 id="2-ç¡®è®¤__pregel_tasksééçå­å¨">2. ç¡®è®¤__pregel_tasksééçå­å¨</h2>
<p>__pregel_tasksééçå­å¨å¯ä»¥éè¿å¦ä¸çæ¼ç¤ºå®ä¾æ¥éªè¯ãå¦ä»£ç çæ®µæç¤ºï¼å¨éç¨å¸¸è§æ¹å¼å°Pregelå¯¹è±¡åå»ºåºæ¥åï¼æä»¬æ ¹æ®Channelåç§°ä»å®çchannelså­æ®µä¸­å°æ­¤Channelæååºæ¥ãæ­è¨æ­ç¤ºäºè¯¥Channelèªèº«çç±»åãå­å¨çæ°æ®ç±»ååâç´¯ç§¯æ¨¡å¼âå¼å³ã</p>
<pre><code class="language-python">from langgraph.channels import LastValue, Topic
from langgraph.pregel import Pregel, NodeBuilder
from langgraph.types import Send, Sequence

node = (
    NodeBuilder()
    .subscribe_only("input_channel")
    .do(lambda args: args)
    .write_to("output_channel")
)
app = Pregel(
    nodes={"node": node},
    channels={"input_channel": LastValue(str), "output_channel": LastValue(str)},
    input_channels=["input_channel"],
    output_channels=["output_channel"],
)

tasks: Topic[Send] = app.channels["__pregel_tasks"]
assert isinstance(tasks, Topic)
assert tasks.ValueType == Sequence[Send]
assert tasks.accumulate == False
</code></pre>
<h2 id="3-è¢«ä¿æ¤èµ·æ¥çéé">3. è¢«ä¿æ¤èµ·æ¥çéé</h2>
<p>è½ç¶â__pregel_tasksâå°±æ¯ä¸ä¸ªæ®éçTopicç±»åçChannelï¼ä½æ¯å®å¹¶æªå¼åå¯¹å¤é¨ä½¿ç¨ï¼Pregelæå®âä¿æ¤âçéå¸¸å¥½ãæä»¬ä¸è½å£°æä¸ä¸ªä¸ä¹ååçChannelï¼å¦åå°±ä¼åå¦ä¸çæ¹å¼ä¸æ ·æåºä¸ä¸ªValueErrorï¼å¹¶æç¤ºâChannel '__pregel_tasks' is reserved and cannot be used in the graph.âã</p>
<pre><code class="language-python">from langgraph.channels import Topic
from langgraph.pregel import Pregel, NodeBuilder
from langgraph.types import Send, Sequence

try:
    app = Pregel(
        nodes={"node": NodeBuilder().subscribe_only("__pregel_tasks")},
        channels={"__pregel_tasks": Topic[Sequence[Send]]},
        input_channels=["input_channel"],
        output_channels=["output_channel"],
    )
    assert False, "Expected an error due to reserved channel name"
except Exception as e:
    assert isinstance(e, ValueError)
    assert str(e) == "Channel '__pregel_tasks' is reserved and cannot be used in the graph."
</code></pre>
<p>æä»¬ä¹ä¸è½éç¨å¸¸è§çæ¹å¼å°åå¶åéSendå¯¹è±¡ãæ¯å¦å¨å¦ä¸çæ¼ç¤ºç¨åºä¸­ï¼èç¹fooè¯å¾åæ­¤Channelåéä¸ä¸ªé©±èç¹baræ§è¡çSendå¯¹è±¡ï¼æç»æåºä¸ä¸ªInvalidUpdateErrorå¼å¸¸ï¼å¹¶æç¤ºâCannot write to the reserved channel TASKSâãé¤æ­¤ä¹å¤ï¼ç±äºPregelå¨å©ç¨å®å°åºäºâPUSHæ¨¡å¼âçä»»å¡åå»ºåºæ¥åå°±ä¼å°å¶æ¸ç©ºï¼æä»¥æä»¬ä¹æ æ³è¯»åå¶ä¸­çä»»å¡ã</p>
<pre><code class="language-python">from langgraph.channels import LastValue
from langgraph.pregel import Pregel, NodeBuilder
from langgraph.types import Send
from langgraph.errors import InvalidUpdateError

foo = (NodeBuilder()
    .subscribe_to("start",read= False)
    .do(lambda _: Send(node="bar", arg="foobar"))
    .write_to("__pregel_tasks"))
bar = (NodeBuilder()
    .do(lambda args:args)
    .write_to("output"))

app = Pregel(
    nodes={ "foo": foo, "bar": bar},
    channels={
        "start": LastValue(str),
        "output": LastValue(str),
    },
    input_channels=["start"],
    output_channels=["output"])
try: 
    app.invoke({"start": None})
    assert False, "Should have raised InvalidUpdateError"
except Exception as e:
    assert isinstance(e, InvalidUpdateError)
    assert str(e) == "Cannot write to the reserved channel TASKS"
</code></pre>
<h2 id="4-å¯ä¸çè§£å³æ¹æ¡">4. å¯ä¸çè§£å³æ¹æ¡</h2>
<p>æä»¬è½å¤æ³å°çå¸¸è§æ¹æ³éå¯¹æ­¤Channelçåå¥åºæ¬é½ç»ä¸å¼å¼æéå¯¹å®çä¿æ¤æºå¶ãæä»¬å°å¨ä¸é¨åä»ç»Pregelå¦ä¸ä¸ªæ ¸å¿ç»æé¨åNodeï¼Nodeä¼å©ç¨ChannelWriterå¯¹è±¡å®ç°éå¯¹Channelçåå¥ï¼æä»¬å¯ä»¥å°éå¯¹Channelçåå¥æå¾å°è£æChannelWriteTupleEntryï¼å¹¶ä»¥æ­¤æ¥åå»ºChannelWriterï¼è¿åºè¯¥æ¯å¯ä¸è½å¤âæ¬ºéªâå¼æåå¥éªè¯çå¯ä¸ææ®µãå¦ä»£ç çæ®µæç¤ºï¼çåæ§è¡çèç¹fooä¼è¿åä¸ä¸ªé©±å¨èç¹baræå®çSendå¯¹è±¡ï¼ä¸ºäºå°å®åå¥â__pregel_tasksâï¼æä»¬åå»ºäºä¸ä¸ªChannelWriterï¼éå¯¹è¯¥Channelçåå¥å®ä¹å¨ChannelWriteTupleEntryå¯¹è±¡ä¸­ï¼å·ä½ä½ç°å¨è°ç¨æé å½æ°æå®çmapperåæ°ä¸ï¼å®æä¾ä¸ä¸ªæ å°å°Nodeçæ§è¡ç»æè½¬ææChannelåç§°åå¼çæ å°å³ç³»ã</p>
<pre><code class="language-python">from langgraph.pregel import Pregel, NodeBuilder
from langgraph.channels import LastValue
from langgraph.pregel._read import PregelNode
from langgraph.pregel._write import ChannelWrite, ChannelWriteTupleEntry
from langgraph.types import Send

foo: PregelNode = (NodeBuilder()
    .subscribe_to("foo")
    .do(lambda _: Send(node="bar", arg="foo"))
).build()
entry = ChannelWriteTupleEntry(mapper= lambda args: [("__pregel_tasks", args)])
foo.writers.append(ChannelWrite(writes=[entry]))

bar = (NodeBuilder()
    .do(lambda args: f"bar is triggered by {args}.")
    .write_to("output"))

app = Pregel(
    nodes={"foo": foo, "bar": bar},
    channels={
        "foo": LastValue(None),
        "output": LastValue(str),
    },
    input_channels=["foo"],
    output_channels=["output"],
)

result = app.invoke(input={"foo": None})
assert result == {"output": "bar is triggered by foo."}
</code></pre>


</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-02-13 07:33">2026-02-13 07:32</span>&nbsp;
<a href="https://www.cnblogs.com/jaydenai">JaydenAI</a>&nbsp;
éè¯»(<span id="post_view_count">7</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19610066);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19610066', targetLink: 'https://www.cnblogs.com/jaydenai/p/19610066/pregel_tasks_channel', title: '[æè§£LangChainæ§è¡å¼æ] __pregel_tasksééââæå°±âPUSHä»»å¡âçåè£' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ Lab4-Lab: traps && MIT6.1810æä½ç³»ç»å·¥ç¨ãæç»­æ´æ°ã _ ]]></title>
    <link>https://www.cnblogs.com/xiaobai1523/p/19610063</link>
    <guid>9b1f39accf420e5d9df167c15caac71e</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/xiaobai1523/p/19610063" title="åå¸äº 2026-02-12 23:12">
    <span role="heading" aria-level="2">Lab4-Lab: traps &amp;&amp; MIT6.1810æä½ç³»ç»å·¥ç¨ãæç»­æ´æ°ã _</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h1 id="lab-traps">Lab: traps</h1>
<p>â	å¨è¿ä¸ä¸ªlabå½ä¸­<a href="https://pdos.csail.mit.edu/6.828/2025/labs/traps.html" target="_blank" rel="noopener nofollow">6.1810 / Fall 2025</a>å®è¦æ±æä»¬çè§£xv6å½ä¸­å½æ°è°ç¨æ¶çå æ æåµä»¥åå¦ä½ææ§åå­å¯»æ¾å¤çº§å½æ°è°ç¨çèµ·å§ï¼æ´éè¦çæ¯å®å¸¦æä»¬ç´è§å°æåå°äº<strong>ä¸­æ­çå¨è¿ç¨</strong>ã</p>
<p>â	å¨æ­¤ä¹åï¼å®ç½ç»åºäºä¸äºæç¤ºï¼</p>
<ul>
<li>å¨å¼å§ç¼ç¨ä¹åï¼	<a href="https://pdos.csail.mit.edu/6.828/2025/xv6/book-riscv-rev5.pdf" target="_blank" rel="noopener nofollow">è¯·éè¯»xv6æç¨çç¬¬4ç« </a>ï¼ä»¥åç¸å³çæºç æä»¶<code>kernel/trampoline.S</code>ã</li>
<li><code>kernel/trap.c</code>å½ä¸­æ¯å¤çææä¸­æ­çä»£ç ã</li>
</ul>
<h2 id="risc-v-assembly-ç®å">RISC-V assembly (ç®å)</h2>
<p>â	å¨è¿ä¸ªlabå½ä¸­ï¼è¦æ±æä»¬éè¯»ä¸äºæ±ç¼ä»£ç ï¼å¹¶ä¸äºè§£cè¯­è¨çæäºè¯­å¥å¯¹åºçæ±ç¼æ¯ææ ·çï¼åæ¶äºè§£ä¸åå¯å­å¨çä¸åèè´£ï¼ä¾å¦<strong>ra</strong>å¯å­å¨æ¯å­æ¾è¿åå°åçå¯å­å¨ï¼ãç¶åå¸¦æä»¬äºè§£äºä¸ä¸ç¼è¯å¨å¨ç¼è¯ä»£ç æ¶ï¼å¦ä½ä¼å/ç®åæä»¬çä»£ç ãæåå¸¦æä»¬ç´è§å°çè§£äºä¸ä¸å¤§ç«¯æ¨¡å¼åå°ç«¯æ¨¡å¼çåºå«ä»¥åä¸¤èå¨é¢å¯¹<strong>å¤å­èå­å¨</strong>å<strong>åä¸ªæ°å¼</strong>å­å¨æé æçä¸åçå½±åã</p>
<h2 id="å¦ä½éè¯»æ±ç¼ä»£ç ">å¦ä½éè¯»æ±ç¼ä»£ç </h2>
<p>â	ä»¥ä¸æ¯æªåäº<code>call.asm</code>å½ä¸­çä¸é¨åä»£ç ï¼è¿ç±»ä»£ç æ¯åæ±ç¼å¾æ¥çç»æãæ¥ä¸æ¥å°å¼å§è§£æè¿æ®µç¨åºã</p>
<pre><code class="language-assembly">##è¿æ¯cè¯­è¨å½æ°fçåæ±ç¼ä»£ç ï¼éè¿æªåç¼è¯å¨è¾åºå¾å°ï¼ä¸æ¯æåçæ±ç¼ä»£ç ï¼æåçæ±ç¼åªæå©è®°ç¬¦ï¼æ²¡æå°åç åæºå¨ç ï¼ã
int f(int x) {
  ##å¯¹äºè¿ä¸è¡ï¼eæ¯åå­è¿å¶çåå­å°å/åç§»ï¼1141æ¯åå­è¿å¶æºå¨ç ã
  ##åå¾åçaddi  sp,sp,-16æ¯å°æ æéspå16ãï¼ä¸è¬åªæåæ çæåµä¸æä¼ä¿®æ¹æ æéï¼
   e:	1141                	addi	sp,sp,-16
  ##å¯¹äºè¿ä¸è¡ï¼10æ¯åå­è¿å¶çåå­å°å/åç§»ï¼e422æ¯åå­è¿å¶æºå¨ç ã
  ##åå¾åçsd	s0,8(sp)æ¯å°å¯å­å¨s0çåå®¹ä¿å­å°æ ç8åç§»å¤ï¼sp+8ï¼ã
  10:	e422                	sd	s0,8(sp)
  ##å¯¹äºè¿ä¸è¡ï¼12æ¯åå­è¿å¶çåå­å°å/åç§»ï¼0800æ¯åå­è¿å¶æºå¨ç ã
  ##åå¾åçaddi  sp,sp,16æ¯å°æ æéspå 16ãï¼ä¸è¬åªæåºæ çæåµä¸æä¼ä¿®æ¹æ æéï¼
  12:	0800                	addi	s0,sp,16
  ##è°ç¨å½æ°g
  return g(x);
}
</code></pre>
<h2 id="é®é¢è§£ç­">é®é¢è§£ç­ï¼</h2>
<p>ä¸ãWhich registers contain arguments to functions? For example, which register holds 13 in main's call to <code>printf</code>?ï¼åªäºå¯å­å¨åå«å½æ°çåæ°ï¼ä¾å¦ï¼å¨mainè°ç¨printfæ¶ï¼åªä¸ªå¯å­å¨å­æ¾ç13ï¼ï¼</p>
<p><strong>ç­ï¼</strong>ä»mainå½æ°å¼å§ï¼æå¦ä¸å¯å­å¨ï¼</p>
<ol>
<li><strong>sp</strong>æ æéå¯å­å¨ï¼ç¨äºå­å¨å½åæ é¡¶å°åãï¼å¥æ ååå°ååå¥ï¼åºæ ååºåå¢ï¼ã</li>
<li><strong>ra</strong>è¿åå°åå¯å­å¨ï¼ä¸é¨ç¨äºä¿å­å½æ°è°ç¨è¿åå°åçå¯å­å¨ã</li>
<li><strong>s0</strong>ä¿å­å¯å­å¨ï¼ç¨äºä¿å­å½æ°æ§è¡è¿ç¨ä¸­éè¦æç»­ä½¿ç¨çä¸­é´å¼ãå¸§æéç­ã</li>
<li><strong>a0~a7</strong>æ¯å½æ°çåæ°å¯å­å¨ï¼ä¼ éå½æ°åæ°æ¶ä¼ç¨å°ã</li>
</ol>
<p>â	å¨mainè°ç¨printfæ¶ï¼å¯å­å¨<strong>a2</strong>å­æ¾ç13ã</p>
<p>äºãWhere is the call to function <code>f</code> in the assembly code for main? Where is the call to <code>g</code>? (Hint: the compiler may inline functions.)ï¼å¨mainå½æ°çæ±ç¼ä»£ç ä¸­ï¼å¯¹å½æ°fçè°ç¨å¨åªéï¼å¯¹gçè°ç¨åå¨åªéï¼ï¼æç¤ºï¼ç¼è¯å¨å¯è½ä¼åèå½æ°ãï¼ï¼</p>
<p><strong>ç­</strong>ï¼å¨mainå½æ°å½ä¸­ï¼å¯¹<strong>f</strong>çè°ç¨è¢«ç®åä¸ºäºä¸æ¡æä»¤ï¼<code>li	a1,12</code>ï¼å ä¸ºç¼è¯å¨å¨ç¼è¯ä»£ç æ¶ï¼å¯¹äºéå¸¸ç®åçå½æ°æ°ä¼è¿è¡<strong>åèä¼å</strong>ï¼ç®åºå¶ç»æï¼ç¶åç´æ¥åå¥å¯¹äºå¯å­å¨ä¸­ï¼æ éçæ<strong><code>jal</code>/<code>jalr</code>è°ç¨æä»¤</strong>ï¼ãå¯¹äº<strong>g</strong>çè°ç¨ä¼å¨<strong>f</strong>å½ä¸­ï¼ä½æ¯ç±äºå½æ°<strong>g</strong>è¿äºç®åï¼æä»¥å¯¹å½æ°<strong>f</strong>è¿è¡äº<strong>æä»¤èå</strong>ï¼å³å°å½æ°<strong>g</strong>å½ä¸­çæä»¤é»è¾èåå°<strong>f</strong>å½ä¸­ãå¨æ¬ä¾å­å½ä¸­ï¼<strong>g</strong>ä¼åå 3æä½ç¶åè¿åï¼ç¶åæä»¬å¯ä»¥å¨<strong>f</strong>å½ä¸­ç´æ¥è¿è¡å ä¸æä½ï¼æ éè°ç¨<strong>g</strong>ã</p>
<p>ä¸ãAt what address is the function printf located?ï¼å½æ°printfä½äºåªä¸ªå°åï¼ï¼</p>
<p><strong>ç­ï¼</strong>å¨<code>call.asm</code>å½ä¸­ï¼æä»¥ä¸ä¸è¡ä»£ç ï¼</p>
<pre><code class="language-assembly">30:	6c4000ef          	jal	ra,6f4 &lt;printf&gt;
</code></pre>
<p>â	å¶ä¸­<code>jal</code>æ¯è·³è½¬æä»¤ï¼æä»¤æ ¼å¼ä¸ºï¼<code>jal ra ç®æ å°å</code>,åç»ååé¢ç<code>&lt;printf&gt;</code>æä»¬å¯ä»¥å¾ç¥<strong><code>0x6f4</code></strong>æ¯printfçå°åï¼å¯¹åºprintfçå¥å£ã</p>
<p>åãWhat value is in the register <code>ra</code> just after the <code>jalr</code> to <code>printf</code> in <code>main</code>?ï¼å¨mainå½æ°ä¸­æ§è¡jalrå°printfä¹åï¼å¯å­å¨raä¸­çå¼æ¯ä»ä¹ï¼ï¼</p>
<p><strong>ç­ï¼</strong>å ä¸º<strong>ra</strong>æ¯è¿åå°åå¯å­å¨ï¼ä¹å°±æ¯è¯´å®éé¢ä¿å­çæ¯æ§è¡å®å½æ°è°ç¨ååºè¯¥è¿åçå°åï¼æä»¥æ­¤æ¶å¨æ§è¡å°printfåï¼<strong>ra</strong>åçå¼åºè¯¥æ¯æä»¤<code>jal	ra,6f4 &lt;printf&gt;</code>çä¸ä¸æ¡æä»¤çå°åï¼ä¹å°±æ¯<strong><code>0x34</code></strong>ã</p>
<p>äºãRun the following code.ï¼è¿è¡æ¥ä¸æ¥çä»£ç ï¼</p>
<pre><code class="language-c">	unsigned int i = 0x00646c72;
	printf("H%x Wo%s", 57616, (char *) &amp;i);
</code></pre>
<p>What is the output? <a href="https://www.asciitable.com/" target="_blank" rel="noopener nofollow">Here's an ASCII table</a> that maps bytes to characters.ï¼è¾åºæ¯ä»ä¹ï¼è¿æ¯ä¸ä¸ªå°å­èæ å°å°å­ç¬¦çASCIIè¡¨ãï¼</p>
<p>The output depends on that fact that the RISC-V is little-endian. If the RISC-V were instead big-endian what would you set <code>i</code> to in order to yield the same output? Would you need to change <code>57616</code> to a different value?ï¼è¾åºåå³äº RISC-V æ¯å°ç«¯å­èåºè¿ä¸äºå®ãå¦æ RISC-V æ¯å¤§ç«¯å­èåºï¼é£ä¹ä¸ºäºå¾å°ç¸åçè¾åºï¼ä½ ä¼å° i è®¾ä¸ºå¤å°ï¼ä½ éè¦å° 57616 æ¹æå¶ä»å¼åï¼ï¼</p>
<p><strong>ç­ï¼</strong>è¾åºåå®¹å¦ä¸ï¼xv6é»è®¤å°ç«¯æ¨¡å¼ï¼ï¼</p>
<pre><code class="language-powershell">He110,World
</code></pre>
<ul>
<li>å°ç«¯æ¨¡å¼ï¼ä½å°åå­æ¾ä½ä½ï¼é«å°åå­æ¾é«ä½ã</li>
<li>å¤§ç«¯æ¨¡å¼ï¼ä½å°åå­æ¾é«ä½ï¼é«å°åå­æ¾ä½ä½ã</li>
</ul>
<p>â	ä¾ç§å¤§ç«¯æ¨¡å¼ï¼æä»¬éè¦å°<strong>i</strong>è¿è¡ä¿®æ¹ï¼å¤§å°ç«¯æ¨¡å¼åªå½±åå¤å­èçå­å¨ï¼è<strong>57616</strong>åªæ¯åä¸ªæ°å¼ï¼ä¸æ¶åå¤å­èå­å¨ãä¸ºç¬¦åå¤§ç«¯è¦æ±ï¼æä»¬éè¦å°<strong>i</strong>ä¿®æ¹ä¸ºï¼<strong><code>0x726c6400</code></strong>å³å¯ã</p>
<p>å­ãIn the following code, what is going to be printed after <code>'y='</code>? (note: the answer is not a specific value.) Why does this happen?ï¼å¨ä¸é¢çä»£ç ä¸­ï¼'y='åé¢å°ä¼æå°åºä»ä¹ï¼ï¼æ³¨æï¼ç­æ¡ä¸æ¯ä¸ä¸ªå·ä½çå¼ãï¼ä¸ºä»ä¹ä¼åºç°è¿ç§æåµï¼ï¼</p>
<pre><code class="language-c">	printf("x=%d y=%d", 3);
</code></pre>
<p><strong>ç­ï¼</strong>å ä¸ºåé<strong>y</strong>æ²¡æå¯¹åºçèµå¼ï¼æä»¥ä¼è¾åºä¸ä¸ª<strong>æªåå§åçéæºçå¼</strong>ï¼ç±»ä¼¼ï¼0,1385ï¼-2294ï¼ãå¨æ±ç¼æ¶ï¼printfå½æ°ä¼ç¨å°ä¸¤ä¸ªå¯å­å¨ï¼å¶ä¸­ a1è´è´£å­æ¾3ï¼a2æ²¡ææå®è¦å­æ¾è°ï¼æä»¥éé¢çå¼æ¯æªç¥çã</p>
<h2 id="backtraceä¸­ç­">Backtraceï¼ä¸­ç­ï¼</h2>
<p>â	å½ä¸ä¸ªå½æ°è°ç¨å¦ä¸ä¸ªå½æ°æ¶ï¼CPU ä¼å°è°ç¨ç¹çè¿åå°åä¿å­å°æ ä¸ï¼è¿æ ·è¢«è°ç¨å½æ°æ§è¡å®åæè½åå°åæ¥çä½ç½®ç»§ç»­æ§è¡ãæ¯æ¬¡è°ç¨é½ä¼åå»ºæ°çæ å¸§ï¼å¹¶å¨æ å¸§ä¸­ä¿å­è¿åå°ååä¸ä¸å±çæ å¸§æéãå æ­¤ï¼å¦ææä»¬ç¥éå½åå½æ°çæ å¸§ä½ç½®ï¼å°±å¯ä»¥é¡ºçæ å¸§é¾âåæº¯âï¼æ¾å°ä¸ä¸å±å½æ°çè¿åå°åï¼åç»§ç»­åä¸ï¼ç´å°éåå®æ´ä¸ªè°ç¨é¾ãæä»¬æè¿ä¸ªè¿ç¨å½¢è±¡å°ç§°ä¸ºâé¡ºè¾æ¸çâï¼æææ¯æ²¿çæ å¸§é¾ï¼ä¸å±å±æ¾å°è°ç¨å³ç³»ã</p>
<p>â	æ¬ Lab è¦æ±å®ç°ä¸ä¸ª <code>backtrace()</code> å½æ°ï¼å®ä»å½åæ å¸§åºåï¼æ²¿çæ å¸§é¾æå°æ¯ä¸å±å½æ°çè¿åå°åãè¾åºé¡ºåºåºä¸è°ç¨é¾ä¸è´ï¼ä»å½åå½æ°åä¸ç´å°æåè°ç¨çåæ ¸å¥å£ï¼ã</p>
<p>â	<strong>æ å¸§ï¼</strong>æ<strong>å½æ°æ å¸§</strong>ï¼æ¯å½æ°å¨è¿è¡æ¶å¨æ ä¸åéçä¸æ®µåå­ï¼ç¨æ¥ä¿å­å½æ°è°ç¨éè¦çä¿¡æ¯ï¼ä¾å¦ï¼è¿åå°åï¼ä¸ä¸å±å½æ°çæ å¸§æéï¼å±é¨åéï¼ä¿å­çå¯å­å¨ï¼ã</p>
<h3 id="å®ç½æç¤ºåä¸ªäººè§£æ">å®ç½æç¤ºåä¸ªäººè§£æ</h3>
<p>â	1ãå¨<code>kernel/defs.h</code>å¨å£°æ <code>backtrace()</code> å½æ°ååï¼è¿æ ·å¶ä»æä»¶å¯ä»¥è°ç¨ï¼å¹¶ä¸å¨<code>kernel/printf.c</code>å½ä¸­å®ç°è¯¥å½æ°ã</p>
<p>â	2ãç±äºæä»¬éè¦è·åå½åçæ å¸§å°åï¼æä»¥å®ç½ç»æä»¬æä¾äºä¸ä¸ª<code>r_fp</code>å½æ°ï¼ç¨äºè¿åå½åçæ å¸§å°åãæä»¬éè¦å°è¿ä¸ªå½æ°å¤å¶å°<code>kernel/riscv.h</code>å½ä¸­ç<strong><code>#ifndef __ASSEMBLER__ ... #endif</code></strong> å®ä¹å½ä¸­ã</p>
<p>â	3ãå¨å®ç°è¯¥åè½æ¶ï¼æä»¬éè¦è·åå½åæ å¸§çå°åï¼å¥½å¨å®ç½æä¾äº<code>r_fp</code>å½æ°ï¼å®è¿åä¸ä¸ª<strong>uint64</strong>ç±»åçæ°æ®ï¼è¿æ¯æ å¸§æéï¼æåçä½ç½®å­æ¾ççæ­£çæ å¸§å°åï¼ï¼å¯¹å¶è§£å¼ç¨ä¼å¾å°å½åçæ å¸§å°åã</p>
<p>â	4ãæ¥ä¸æ¥æä»¬å¼å§âåä¸âå¯»æ¾è°ç¨é¾ä¸çå½æ°ï¼æ ¹æ®å®ç½çæç¤ºï¼å¨<strong>âæ å¸§å°å - 8â</strong>çä½ç½®ä¸å­æ¾çæ¯ä¸ä¸å±å½æ°çè¿åå°åï¼ä¹æ¯æä»¬è¦æå°çå°åãå¨<strong>âæ å¸§å°å - 16â</strong>çä½ç½®ä¸å­æ¾çæ¯ä¸ä¸å±å½æ°æ å¸§çå°åï¼å¨æå°å®æ¯åæä»¬åæ¢å°ä¸ä¸å±å½æ°çæ å¸§ï¼ç¶åç»§ç»­æå°è¿åå°åï¼ç¶ååæ¬¡åä¸å¯»æ¾æ å¸§ï¼ç´è³å°è¾¾é¡¶ç«¯ã</p>
<p>â	ä»¥ä¸æ¯xv6åæ ¸çç¸å³çº¦å®ï¼å ä¹æ¯ä¸ªå½æ°è°ç¨çæ¶åé½ä¼ä¼´éä»¥ä¸æ±ç¼ä»£ç ï¼ï¼</p>
<pre><code class="language-assembly">addi sp, sp, -X    # åéæ å¸§
sd ra, 8(sp)       # ä¿å­è¿åå°å
sd s0, 0(sp)       # ä¿å­æ§ç frame pointerï¼æ å¸§æéï¼æåå­æ¾æ å¸§çåå­ï¼
mv s0, sp          # æ´æ° frame pointerï¼æ å¸§æéï¼
</code></pre>
<p>â	æ´ç´è§ç¹ï¼</p>
<pre><code class="language-nginx">s0 â æåèªå·±æ å¸§ç s0 å­æ¾ä½ç½® + 8
s0-8 â ra
s0-16 â ä¸ä¸çº§ s0
</code></pre>
<p>â	5ãå¨åä¸å¯»æ¾æ¶ä¹è¦æ³¨æè¶ççé®é¢ï¼å¨xv6å½ä¸­ï¼æ´ä¸ªæ é½å¨åä¸ä¸ªé¡µé¢å½ä¸­ï¼å æ­¤ææçæ å¸§é½æ¯å¨ä¸ä¸ªé¡µé¢ä¸­ï¼è¿ä¹è§£éäºä¸ºä»ä¹éå½çå±çº§å¤äºä¼çæ çåå ï¼å ä¸ºè°ç¨æ°çå½æ°ä¼åå»ºæ°çæ å¸§ï¼å ç¨åä¸ä¸ªæ çåå­ï¼ï¼æä»¥æä»¬éè¦ä¿è¯æä»¬å¨è·åå°æ°çæ å¸§çåæ¶ï¼è¦ä¿è¯ä¸åææå¤çè¿çæ å¸§å¤äºåä¸é¡µé¢ï¼å®ç½å½ä¸­ç»åºäº<code>PGROUNDDOWN(fp)</code>å®æ¥å¸®å©æä»¬å¤æ­å½åfpçé¡µé¢ãåæ¶ä¹æä¸ä¸ªå¿½ç¥çç¹å°±æ¯è¦ä¿è¯å°åæ¯éåçï¼è¿æ ·æ»ä¼éåå°å½åé¡µçè¾¹çï¼ä½¿å¾å¾ªç¯ç»æ­¢ï¼å¦æå¿½ç¥è¯¥æ¡ä»¶ï¼å¯è½ä¼å¯¼è´å°åå å ååè·³ä¸åºæ¬é¡µï¼è¿èæ éå¾ªç¯ã</p>
<p>â	6ãéè¿å½åæ å¸§è·åä¸ä¸å±å½æ°çè¿åå°åï¼å¹¶ä¸æå°ã</p>
<p>â	7ãéè¿å½åæ å¸§è·åä¸ä¸å±å½æ°çæ å¸§ï¼ç¶åç»§ç»­å¯»æ¾ã</p>
<h3 id="ç¸å³ä»£ç ">ç¸å³ä»£ç </h3>
<p>â	å¨<code>kernel/printf.c</code>å½ä¸­ã</p>
<pre><code class="language-c">void backtrace(){
  // å½åçæ å¸§
  uint64 s0 = r_fp();
  // ä¸´æ¶åéï¼ææ°çå½æ°æ å¸§
  uint64 temp = s0;
  // ä¸´æ¶åéï¼ç¨äºæ¥ä¸æ¥çæ¯è¾
  uint64 log = s0;
  printf("backtrace:\n");
  // ç¡®ä¿æ¾å°çæ å¸§åææ°çæ å¸§æ¯åä¸é¡µï¼å¹¶ä¸æ å¸§åªè½åè°éåï¼ä¸è½åºç°ç¯è·¯ï¼é²æ­¢æ­»å¾ªç¯ã
  while((PGROUNDDOWN(s0) == PGROUNDDOWN(temp)) &amp;&amp; (s0 &gt;= log )){
    // æ å¸§-8æ¯è¿åå°åï¼ååºè¿åå°åå½ä¸­çå¼ï¼ä»¥å°åå½¢å¼æå°
    uint64 ra = *(uint64 *)(s0 - 8);
    printf("%p\n", (void *)ra);
    // ä¸´æ¶åéä¿å­å½åæ å¸§ï¼å¨ä¿è¯æ å¸§åè°éåçå¤æ­ä¸­ä½¿ç¨
    log = s0;
    // æ å¸§-16æ¯ä¸ä¸å±å½æ°çæ å¸§
    s0 = *(uint64*)(s0 - 16);
  }
}
</code></pre>
<p>â	<strong>ä¹åæ ¹æ®å®ç½çæç¤ºè¿è¡å®éªç»æçéªè¯å³å¯ã</strong></p>
<h2 id="alarmå°é¾">Alarmï¼å°é¾ï¼</h2>
<p>â	å¨è¿ä¸labå½ä¸­ï¼è¦æ±æä»¬<strong>å®ç°ç¨æ·æçå®æ¶âä¸­æ­âåè½</strong>ãç¨æ·è¿ç¨å¯ä»¥åæä½ç³»ç»æ³¨åä¸ä¸ªå½æ°ï¼handlerï¼ï¼å¹¶ä¸è¦æ±CPUå¨æ¯énä¸ªtickåæ§è¡è¯¥å½æ°ä¸æ¬¡ï¼å¨handlerå¨è¢«æ§è¡æ¶ï¼ç¨æ·ç¨åºéè¦âè¢«æåâï¼ç´å°handleræ§è¡å®æ¯ååè¿åç¨æ·ç¨åºï¼è¿ä¸ªè¿ç¨ç±»ä¼¼äºç¡¬ç¡¬ä»¶ä¸­æ­æºå¶ï¼åªä¸è¿éç¨äºè½¯ä»¶çæ¹æ³å®ç°ã</p>
<h3 id="å®ç½æç¤ºåä¸ªäººè§£æ-1">å®ç½æç¤ºåä¸ªäººè§£æï¼</h3>
<p>â	1ãé¦åè¦æ±æä»¬æ°æ·»å ä¸¤ä¸ªç³»ç»è°ç¨ï¼åå«æ¯ï¼<strong><code>sigalarm(interval, handler)</code>å<code>sigreturn(void)</code></strong>ï¼å·ä½çæ·»å æ¹å¼è¯¦è§ï¼<a href="https://www.cnblogs.com/xiaobai1523/p/19530432" target="_blank">Lab2-system calls &amp;&amp; MIT6.1810æä½ç³»ç»å·¥ç¨ãæç»­æ´æ°ã - å°ç½åå­¦_C - åå®¢å­</a>ãä¸æ­¤åæ¶ï¼<code>sigalarm(interval, handler)</code>å½æ°çç¬¬ä¸ä¸ªåæ°intervalä»£è¡¨æ¯éå¤å°åtickæ§è¡handlerï¼ç¬¬äºä¸ªåæ°handlerå°±ä»£è¡¨CPUæ¯ä¸ªnä¸ªtickè¦æ§è¡å½æ°çå°åäºãè¿å°±éè¦æä»¬å¨è¿ç¨ç<code>proc</code>å½ä¸­æ·»å æ°çæåç¨äºè®°å½å½åtickåå½åå·²ç»è¿å»äºå¤å°tickä»¥åæ³¨åçå½æ°æéã</p>
<p>â	2ãå¦æåºç¨ç¨åºè°ç¨ sigalarm (0, 0)ï¼åæ ¸åºåæ­¢çæå¨ææ§çè­¦æ¥è°ç¨ã</p>
<p>â	3ãhandleræ§è¡æ¶ï¼éè¦æä»¬æåç¨æ·ç¨åºï¼ä¹å°±æ¯åå°ç¨æ·ç¨åºçä»£ç ä¿æ¤èµ·æ¥ï¼æ¿æ¢ä¸ºhandlerçä»£ç ãå¾handleræ§è¡å®æ¯ååå°ç¨æ·ç¨åºçä»£ç æ¢å¤ï¼è¿å°±è¦æ±æä»¬å¨è¿ç¨ç<code>proc</code>å½ä¸­æ·»å ç¸åºçtrapframeå¸§ç¨äºä¿å­ç¨æ·ç¨åºç¶æï¼åä¸­æ­çææ³ä¸æ ·ï¼ææ­å½åæ§è¡çç¨åºâä¿æ¤æ­ç¹åç°åºâè·å¾ä¸­æ­åéâæ§è¡ä¸­æ­å¤çç¨åºâæ¢å¤æ­ç¹åç°åºâè¢«ææ­çç¨åºç»§ç»­æ§è¡ï¼ã</p>
<p>â	4ãæ<code>user/alarmtest.c</code> æ·»å å° Makefile ä¸­ã</p>
<p>â	5ãè®°å¾æ<code>sigalarm(interval, handler)</code>å<code>sigreturn(void)</code>æ·»å å°<code>user/user.h</code>å½ä¸­ãï¼æ ¼å¼å¦ä¸ï¼</p>
<pre><code class="language-c">	int sigalarm(int ticks, void (*handler)());
    int sigreturn(void);
</code></pre>
<p>â	6ãæ¯è¿ä¸ä¸ªtickï¼ç¡¬ä»¶æ¶éå°±ä¼è§¦åä¸æ¬¡ä¸­æ­ï¼è¯¥ä¸­æ­å¨<code> kernel/trap.c</code> ç <code>usertrap () </code>ä¸­å¤çï¼æä»¥æä»¬éè¦å¨è¿éè¿è¡ä¿®æ¹ãå®ç½è¯´äºï¼åªè¦åçå®æ¶å¨ä¸­æ­æ¶ï¼æä»¬æéè¦ä¿®æ¹/å¯¹æ¯è¿ç¨çæ¶étickæ°ãå¨å¦ä¸å¤æ­ä½åå®ç°âå¤æ­handleræ¯å¦æ§è¡çç¸å³é»è¾âï¼å¹¶ä¸ä¿å­ç¨æ·ç¨åºçæ­ç¹åå°ç¨æ·ç¨åºä»£ç æ¿æ¢ä¸ºhandlerå°±å¨æ­¤æ§è¡ã</p>
<pre><code class="language-c">	if(which_dev == 2) ...
</code></pre>
<p>â	7ã å½handleræ§è¡å®æ¯åï¼ä¹æ¯è°ç¨äº<code>sigreturn</code>å½æ°æ¶ï¼è¦æ±æä»¬è¿åå½åè¿ç¨ç<strong>a0</strong>å¯å­å¨ã</p>
<h3 id="ç¸å³ä»£ç -1">ç¸å³ä»£ç </h3>
<p>â	æå³æ·»å ç³»ç»è°ç¨çä»£ç å¨è¿éå°±åè·³è¿äºï¼å¯ä»¥ç¿»ç¿»åä¸»ä¹åçæç« <a href="https://www.cnblogs.com/xiaobai1523/p/19530432" target="_blank">Lab2-system calls &amp;&amp; MIT6.1810æä½ç³»ç»å·¥ç¨ãæç»­æ´æ°ã - å°ç½åå­¦_C - åå®¢å­</a>ã</p>
<p>â	ä¸ãkernel/proc.h</p>
<pre><code class="language-c">// å¨è¿ç¨çprocå½ä¸­æ°æ·»å å¦ä¸åå®¹ï¼
  int alarmticks;              // è­¦æ¥ä¹é´çæ»´ç­å£°
  int alarmtickscount;         // ä¸æ¬¡è­¦æ¥åçæ»´ç­å£°æ¬¡æ°
  uint64 alarmhandler;      // é¹éæ»´ç­å£°è¿å»æ¶è°ç¨çå¤çç¨åº
  int inhandler;               // æ¯å¦æ­£å¨å¤çalarm
  struct trapframe alarm_tf; // ç¨äºä¿å­è¢« alarm ææ­æ¶ç trapframe
</code></pre>
<p>â	äºãkernel/sysproc.c</p>
<pre><code class="language-c">uint64
sys_sigalarm(void)
{
  int ticks;
  uint64 handler;

  // è¯»åç¨æ·ä¼ å¥åæ°
  argint(0, &amp;ticks);
  argaddr(1, &amp;handler);

  struct proc *p = myproc();

  // è®¾ç½® alarmticks å alarmhandler
  p-&gt;alarmticks = ticks;
  p-&gt;alarmtickscount = 0;
  // å¦æ ticks å handler é½ä¸º 0ï¼è¡¨ç¤ºåæ¶ alarmï¼æä»¥å° alarmhandler è®¾ç½®ä¸º -1ï¼è¡¨ç¤ºä¸è°ç¨ handler
  if(ticks == 0 &amp;&amp; handler == 0) {
    p-&gt;alarmhandler = -1;
  }else{
    p-&gt;alarmhandler = handler;
  }

  return 0;
}

uint64 
sys_sigreturn(void)
{
  struct proc *p = myproc();
  // æ¢å¤è¢« alarm ææ­æ¶ç trapframeï¼ä»¥ä¾¿å¨ handler å¤çå®åç»§ç»­è¢«ææ­çç¨åº
  memmove(p-&gt;trapframe, &amp;p-&gt;alarm_tf, sizeof(struct trapframe));
  // å¤çå® alarm åï¼éç½® inhandler å alarmtickscount
  p-&gt;inhandler = 0;
  p-&gt;alarmtickscount = 0;
  return p-&gt;trapframe-&gt;a0; // è¿åç¨æ·ç¨åºä¸­ a0 çå¼
}
</code></pre>
<p>â	ä¸ãkernel/trap.c</p>
<pre><code class="language-c">// å¨usertrapå½æ°ç if(which_dev == 2)... å½ä¸­æ·»å å¦ä¸åå®¹ï¼
// å¨æ¶éä¸­æ­æ¶ï¼æ£æ¥æ¯å¦éè¦å¤ç alarm
  if(which_dev == 2){
    // è·åå½åè¿ç¨çæé
    struct proc *p = myproc();
    // å¦æå½åè¿ç¨è®¾ç½®äº alarmhandlerï¼å¹¶ä¸ä¸å¨å¤ç alarm çè¿ç¨ä¸­ï¼å°±æ£æ¥æ¯å¦éè¦è°ç¨ alarmhandler
    // æ³¨æï¼alarmhandler çå¼ä¸º -1 è¡¨ç¤ºæ²¡æè®¾ç½® handlerï¼ä¸è°ç¨ï¼ï¼å¼ä¸º 0 è¡¨ç¤ºæ­£å¨å¤ç alarmï¼
    // æä»¥åªæå½ alarmhandler å¤§äº 0 æ¶æè¡¨ç¤ºè®¾ç½®äº handler å¹¶ä¸ä¸å¨å¤ç alarm çè¿ç¨ä¸­
    if(p-&gt;alarmhandler == 0 || p-&gt;alarmhandler != -1){
      // å¢å æ»´ç­å£°è®¡æ°ï¼å¹¶æ£æ¥æ¯å¦è¾¾å°äº alarmticksï¼å¦æè¾¾å°äºï¼å¹¶ä¸ alarmticks å¤§äº 0ï¼å°±è°ç¨ handler
      p-&gt;alarmtickscount++;
      // å¦æè¾¾å°äºè®¾å®çæ»´ç­æ°ï¼ä¸è®¾ç½®äº alarmticksï¼å¤§äº 0ï¼ï¼å°±è°ç¨ handler
      if(p-&gt;alarmtickscount &gt;= p-&gt;alarmticks &amp;&amp; p-&gt;alarmticks &gt; 0 ){
        p-&gt;alarmtickscount = 0;
        // è°ç¨ç¨æ·è®¾ç½®ç alarm å¤çç¨åº
        if(!p-&gt;inhandler){
          // è®¾ç½®å½åæ­£å¨å¤ç alarmï¼é²æ­¢å¨å¤ç alarm çè¿ç¨ä¸­è¢«åæ¬¡ææ­è°ç¨ handler
          p-&gt;inhandler = 1;
          // ä¿å­è¢«ææ­æ¶ç trapframe å° alarm_tf ä¸­ï¼ä»¥ä¾¿å¨ handler å¤çå®åæ¢å¤
          memmove(&amp;p-&gt;alarm_tf, p-&gt;trapframe, sizeof(struct trapframe));
          // è®¾ç½® trapframe ç epc ä¸º handler çå°åï¼è¿æ ·å¨ usertrapret() æ¶å°±ä¼è·³è½¬å° handler å¤æ§è¡
          p-&gt;trapframe-&gt;epc = (uint64)p-&gt;alarmhandler;  

        }
        
      }
    }
    yield();
  }
</code></pre>
<h3 id="éªæ¶ææ">éªæ¶ææ</h3>
<pre><code class="language-shell">xiaobai@***:~/xv6-labs-2025$ ./grade-lab-traps alarm
make: 'kernel/kernel' is up to date.
== Test running alarmtest == (4.1s)
== Test   alarmtest: test0 ==
  alarmtest: test0: OK
== Test   alarmtest: test1 ==
  alarmtest: test1: OK
== Test   alarmtest: test2 ==
  alarmtest: test2: OK
== Test   alarmtest: test3 ==
  alarmtest: test3: OK
xiaobai@***:~/xv6-labs-2025$
</code></pre>
<h2 id="åå¨æå">åå¨æå</h2>
<p>â	è¿ä¸labå¯ä»¥è¯´å¾ç´è§å°è®©æä»¬æåå°ä¸­æ­çè¿ç¨æ¯ææ ·çï¼ç¹å«æ¯æ¶åâä¿æ¤æ­ç¹/ç°åºâï¼âè·åä¸­æ­æå¡ç¨åºå¥å£å°åâï¼âæ¢å¤æ­ç¹/ç°åºâç­åå®¹ã</p>
<p>â	å¿«è¿å¹´äºï¼äºåå¤§å¹´ä¸ååå°½å¿«èµ¶åºä¸ä¸ä¸ªlabã</p>


</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.0020833333333333333" data-date-updated="2026-02-12 23:15">2026-02-12 23:12</span>&nbsp;
<a href="https://www.cnblogs.com/xiaobai1523">å°ç½åå­¦_C</a>&nbsp;
éè¯»(<span id="post_view_count">40</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19610063);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19610063', targetLink: 'https://www.cnblogs.com/xiaobai1523/p/19610063', title: 'Lab4-Lab: traps &amp;amp;&amp;amp; MIT6.1810æä½ç³»ç»å·¥ç¨ãæç»­æ´æ°ã _' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ RAG æ¶ä»£çâç ´å£äººâï¼ä¸ºä»ä¹ä½ çå¤§æ¨¡ååºç¨æ¥é Doclingï¼ ]]></title>
    <link>https://www.cnblogs.com/jyzhao/p/19610038/rag-shi-dai-de-po-bi-ren-wei-shen-me-ni-de-da-mo-x</link>
    <guid>78ed27f4e3f64c3cf88aa33424efe821</guid>
    <description>
    <![CDATA[ 
    <a name="top"></a>
    <h2><a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/jyzhao/p/19610038/rag-shi-dai-de-po-bi-ren-wei-shen-me-ni-de-da-mo-x" title="åå¸äº 2026-02-12 22:58">
    <span role="heading" aria-level="2">RAG æ¶ä»£çâç ´å£äººâï¼ä¸ºä»ä¹ä½ çå¤§æ¨¡ååºç¨æ¥é Doclingï¼</span>
    

</a>
</h2>
    <small>
<span id="post-date" data-last-update-days="0" data-date-updated="2026-02-12 22:58">2026-02-12 22:58</span>&nbsp;
<a href="https://www.cnblogs.com/jyzhao">AlfredZhao</a>&nbsp;
éè¯»(<span id="post_view_count">64</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19610038);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19610038', targetLink: 'https://www.cnblogs.com/jyzhao/p/19610038/rag-shi-dai-de-po-bi-ren-wei-shen-me-ni-de-da-mo-x', title: 'RAG æ¶ä»£çâç ´å£äººâï¼ä¸ºä»ä¹ä½ çå¤§æ¨¡ååºç¨æ¥é Doclingï¼' })">ä¸¾æ¥</a>
</small>
    <div class="entry">
        <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<p>å¨ RAGï¼æ£ç´¢å¢å¼ºçæï¼çå¼ååå­éï¼æä¸å¥æµä¼ çå¹¿çâé»è¯âï¼<strong>âåå¾è¿ï¼åå¾åºï¼Garbage In, Garbage Outï¼ãâ</strong> æ è®ºä½ çåéæ°æ®åºæå¤å¿«ï¼å¤§æ¨¡åï¼LLMï¼çæ¨çè½åæå¤å¼ºï¼å¦ææå¼å§åç»å®çææ¡£æ°æ®æ¯ä¸å¢ä¹±éº»ï¼é£æç»çåç­ææä¸å®ä¸å°½å¦äººæãæ­£æ¯å¨è¿ç§èæ¯ä¸ï¼IBM å¼æºç <strong>Docling</strong> åä¸å¹é»é©¬ï¼è¿éæä¸ºäº RAG é¢åçâæ°å® âã</p>
<p>ä»å¤©ï¼ç¬èå°±å¸¦å¤§å®¶æè§£ä¸ä¸ï¼ä¸ºä»ä¹å¨ RAG æµç¨ä¸­ï¼Docling æ¯ä¸å¯æç¼ºçåºå±æ¯æ±ã</p>
<hr>
<h2 id="section">01 | çç¹ï¼è¢«å¿½è§çææ¡£è§£æâæåä¸å¬éâ</h2>
<p>åè¿ RAG çåå­¦é½ç¥éï¼ç¬¬ä¸æ­¥éå¸¸æ¯è§£æ PDFãä½ä¼ ç»çè§£ææ¹å¼å¾å¾ä¼è®©å¼åèå¤´ç§ï¼</p>
<ul>
<li><strong>PDF æ ¼å¼çâéç»æåâæ¬è´¨</strong>ï¼PDF æ¬è´¨ä¸æ¯ç»æå°æºççãæ®éè§£æå·¥å·ï¼å¦ PyPDF ç­ï¼å¾å¾ä¼æç©çåæ æåææ¬ï¼å¯¼è´åæ æ··æ·ãé¡µçé¡µèæ¨ªæå¨æ­£æä¸­é´ã</li>
<li><strong>âç»æåâçå½»åºä¸¢å¤±</strong>ï¼æå¸åçå°±æ¯è¡¨æ ¼ãä¸æ¦è§£ææä¹±åºçº¯ææ¬ï¼è¡ä¸åçå³ç³»å°±ä¼ç°é£çç­ï¼å¤§æ¨¡åçå°çåªæ¯ä¸å æ¯«æ å³èçæ°å­âå¤©ä¹¦âã</li>
</ul>
<hr>
<h2 id="docling">02 | æ ¸å¿äº®ç¹ï¼Docling å­ä»ä¹è¢«ç§°ä¸ºâéç»´æå»âï¼</h2>
<p>Docling ä¸ä»ä»æ¯ä¸ä¸ªè½¬æ¢å·¥å·ï¼å®æ´åæ¯ä¸ä¸ªæ¥æâéè§ç¼âçæºè½ææ¡£ç¿»è¯å®ã</p>
<h3 id="section-1">â  è¯­ä¹å¸å±åæï¼èéå­ç¬¦æå</h3>
<p>Docling éç¨äºåè¿çäººå·¥æºè½è§è§æ¨¡åï¼åºäº DocLayNet æ°æ®éï¼ãå®ä¸æ¯ç¡¬ççå°âæ£âå­ï¼èæ¯åäººç¼ä¸æ ·å»çè§£å¸å±ï¼<strong>âè¿éæ¯åæ æ é¢ï¼é£éæ¯è·¨è¡è¡¨æ ¼ï¼å³è¾¹æ¯éå¾çæ³¨éãâ</strong> è¿ç§å¯¹ææ¡£ææç»æçæ·±å»çè§£ï¼æ¯ä¿çåæé»è¾çå³é®ã</p>
<h3 id="tableformer">â¡ è¡¨æ ¼è§£æçâå¤©è±æ¿âï¼TableFormer</h3>
<p>è¿æ¯ Docling çææéãå®åç½®äº IBM ä¸é¨éå¯¹å¤æè¡¨æ ¼ç åç <strong>TableFormer</strong> æ¨¡åãå³ä¾¿æ¯æ²¡æè¾¹æ¡çº¿çè¡¨æ ¼ãå«æå¤æåå¹¶ååæ ¼çæ¥è¡¨ï¼å®é½è½ç²¾åè¿åå¹¶è½¬æ¢ä¸º Markdown æ JSONã</p>
<ul>
<li><strong>ä¸ºä»ä¹ Markdown å¯¹ RAG è³å³éè¦ï¼</strong> å¤§æ¨¡åå¤©çå¯¹ Markdown æ ¼å¼çè¡¨æ ¼ææå¼ºçæç¥åãéè¿ Doclingï¼å¤§æ¨¡åç»äºè½è¯»æâ2025å¹´Q3ççº¯Açæ¯Q2å¢é¿äºå¤å°âè¿ç§æ¶åè·¨è¡è·¨åå¯¹æ¯çå¤æé»è¾ã</li>
</ul>
<h3 id="pipeline-v2">â¢ æç®ç Pipeline ä¸ v2 ç»ä¸æ¶æ</h3>
<p>å¨ææ°ç <strong>v2 çæ¬</strong>ä¸­ï¼Docling å¼å¥äºç»ä¸çä¸­é´è¡¨ç¤ºï¼<code>DoclingDocument</code>ï¼ãè¿æå³çæ è®ºä½ è¾å¥çæ¯ PDFãWordãPPT è¿æ¯ HTMLï¼è¾åºçç»æåæ½è±¡æ¯å®å¨ä¸è´çãè¿ç§âä¸ç©å½ä¸âçç¹æ§ï¼æå¤§ç®åäº RAG åç«¯çæ°æ®å¤çé»è¾ã</p>
<hr>
<h2 id="docling-rag">03 | è¿é¶çè§£ï¼Docling å¨ RAG å·¥ä½æµä¸­çåå­¦ååº</h2>
<h3 id="smart-chunking">â  åçè¯­ä¹åçï¼Smart Chunkingï¼</h3>
<p>ä¼ ç»çåçæ¯æå­æ°ç¡¬åï¼å¸¸å¯¼è´è¯­ä¹æ­è£ãDocling ç°å¨çå¼ºå¤§ä¹å¤å¨äºå®<strong>èªå¸¦åçé»è¾</strong>ãå ä¸ºå®ç¥éåªéæ¯æ é¢ãåªéæ¯æ®µè½ï¼æä»¥å®å¯ä»¥æ§è¡<strong>åºäºç»æçåç</strong>ï¼</p>
<blockquote>
<p><strong>ç¬èè§è§£</strong>ï¼éè¿ Doclingï¼æä»¬å¯ä»¥ç¡®ä¿æ¯ä¸ä¸ª Knowledge Chunk é½æ¯ä¸ä¸ªå®æ´çè¯­ä¹ååï¼ä¾å¦ï¼æ´ä¸ªäºçº§æ é¢ä¸çæææ®µè½ï¼ï¼è¿è½ä»æºå¤´ä¸æ¶é¤å¤§æ¨¡åå¨æ£ç´¢åçå¹»è§ã</p>
</blockquote>
<h3 id="section-2">â¡ åæ°æ®ä¸åæ æ å°</h3>
<p>Docling è§£ææ¶ä¼ä¿çæ¯ä¸ä¸ªåç´ å¨åä»¶ä¸­çåæ ãè¿ä½¿å¾å¨ RAG çâå¼ç¨æ¥æºâåè½ä¸­ï¼åºç¨ä¸ä»è½åè¯ç¨æ·ç­æ¡å¨åªä¸ªææ¡£ï¼çè³è½ç´æ¥å¨ PDF é¢è§ä¸­<strong>é«äº®æ¾ç¤º</strong>åºé£ä¸è¡æå­çä½ç½®ã</p>
<hr>
<h2 id="section-3">04 | ææ°å¨æï¼åå¨è½å¤æ¨¡æè·¨è¶</h2>
<p>ç¸æ¯æ©æçè§£æå·¥å·ï¼Docling æ­£å¨åâå¤æ¨¡æâè¿åãå®ä¸ä»å å¼ºäºå¯¹ <strong>OCRï¼åå­¦å­ç¬¦è¯å«ï¼</strong> çæ¯æï¼è§£å³æ«æä»¶é¾é¢ï¼çè³å¼å§æ¯æå¤çå¤æç <strong>LaTeX å¬å¼</strong>ãå®ä¸åä¾èµæè´µçåä¸é­æºæ¹æ¡ï¼å¦ Adobe Extractï¼ï¼èæ¯ä¸ºå¼æºç¤¾åºæä¾äºä¸ä¸ªå¨æ§è½ä¸å®å¨å¯¹æ çé«è´¨ééæ©ã</p>
<hr>
<h2 id="rag">05 | æ»ç»ï¼RAG å·¥ç¨å¸çæ éå·¥å·</h2>
<p>å¦æè¯´åéæ°æ®åºæ¯ RAG çå¤§èï¼é£ä¹ Docling å°±æ¯é£å <strong>âæå¶æéçæâ</strong>ï¼è´è´£æç²ç³çåææå å·¥æç²¾è´çé¥µæã</p>
<p><strong>ç¬èçå»ºè®®ï¼</strong><br>
å¦æä½ ç°å¨ç RAG ç³»ç»è¿å¨ä¸ºâè¡¨æ ¼è¯å«ä¸åâæâææ¡£ç»ææ··ä¹±âèç¦æ¼ï¼ä¸è¦æ¥çç ¸é±å»æ¢æ´è´µç LLM æ¥å£ï¼è¯çå¨è§£æå±å¼å¥ Doclingãä½ ä¼åç°ï¼ææ¶ååºå±çâåºå»ºâä¼åï¼æ¯ä¸å±çâç¼ä¸¹âæ´æå¥æã</p>


</div>
<div id="MySignature" role="contentinfo">
    <a href="https://www.cnblogs.com/jyzhao/" target="_blank">AlfredZhao</a>Â©çæææãä»Oracleèµ·èªï¼é¢ç¥ç²¾å½©çITææ¯ãã<br>
è½¬è½½è¯·æ³¨æåæé¾æ¥ï¼<a href="https://www.cnblogs.com/jyzhao/p/19610038/rag-shi-dai-de-po-bi-ren-wei-shen-me-ni-de-da-mo-x" target="_blank">https://www.cnblogs.com/jyzhao/p/19610038/rag-shi-dai-de-po-bi-ren-wei-shen-me-ni-de-da-mo-x</a>
<hr>
<div style="text-align:center; margin-top:30px;">
  <p style="font-size:14px;color:#555;">
    ð æè°¢éè¯»ï¼æ¬¢è¿å³æ³¨æçå¬ä¼å· <b>ãèµµéå®ã</b>
  </p>
  <img src="https://images.cnblogs.com/cnblogs_com/jyzhao/824234/o_250208075013_qrcode-zjy.jpg" width="160" style="border:1px solid #ddd;border-radius:8px;">
</div>
</div>
<div class="clear"></div>

        <div class="clear"></div>
        
</div>
    <ul class="postmetadata">
        <vc:categories-tags blog-app="jyzhao" blog-id="186567" post-id="19610038"></vc:categories-tags>
    </ul>
 ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ ä»é¶å®ç°ä¸ä¸ªçäº§çº§ RAG è¯­ä¹æç´¢ç³»ç»ï¼C++ + ONNX + FAISS å®æ ]]></title>
    <link>https://www.cnblogs.com/charlee44/p/19609813</link>
    <guid>c825b82e69824477cb05ae2282f04249</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/charlee44/p/19609813" title="åå¸äº 2026-02-12 21:41">
    <span role="heading" aria-level="2">ä»é¶å®ç°ä¸ä¸ªçäº§çº§ RAG è¯­ä¹æç´¢ç³»ç»ï¼C++ + ONNX + FAISS å®æ</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                    <div id="cnblogs_post_description" style="display: none">
        
        æ¬æä»é¶æå»ºäºä¸ä¸ªè½»éçº§ãé«æ§è½ç C++ è¯­ä¹æç´¢ç³»ç»ï¼åºäº ONNX è¿è¡ BGE åµå¥æ¨¡åãFAISS åéç´¢å¼ä¸ Markdown è¯­ä¹ååï¼å®æ´å®ç°æ¯æå¢å æ¹æ¥ççäº§çº§ RAG æ£ç´¢åç«¯ã
    </div>
<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h1 id="1-å¼è¨">1. å¼è¨</h1>
<p>æ¢ç¶æ¯âä»é¶å®ç°âï¼æ¬ææä¸æ·±å¥æ¢è®¨ç¹å¤ççè®ºèæ¯ï¼èæ¯åèç¦ä¸ä¸ªæ ¸å¿é®é¢ï¼è¯­ä¹åæç´¢ä¸­çâè¯­ä¹åâå°åºæ¯ä»ä¹ææï¼</p>
<p>ä¼ ç»çå³é®è¯æç´¢ä¾èµå­é¢å¹éââæ¯å¦æç´¢âå¦ä½åºåå JSONâï¼ç³»ç»åªä¼è¿ååå«è¿äºç²¾ç¡®å³é®è¯çææ¡£ãè¿ç§æ¹å¼ç®åç´æ¥ï¼ä½ååâåæ¿âï¼å®æ æ³çè§£âJSON åºååæ¹æ³âæâæå¯¹è±¡è½¬æ JSON å­ç¬¦ä¸²âå¶å®è¡¨è¾¾äºç¸åçæå¾ã</p>
<p>èè¯­ä¹åæç´¢ççªç ´å¨äºï¼å®ä¸åæ¯è¾æå­ï¼èæ¯æ¯è¾å«ä¹ãå¶æ ¸å¿ææ³æ¯å°ææ¬ï¼æ è®ºæ¯æ¥è¯¢è¿æ¯ææ¡£ï¼éè¿åµå¥æ¨¡åï¼Embedding Modelï¼è½¬æ¢ä¸ºé«ç»´åéââè¿ä¸ªè¿ç¨ç§°ä¸ºâåéåâæâåµå¥âï¼Embeddingï¼ãå¨åéç©ºé´ä¸­ï¼è¯­ä¹ç¸è¿çå¥å­ä¼è¢«æ å°å°å½¼æ­¤é è¿çä½ç½®ãäºæ¯ï¼æç´¢å°±åæäºä¸ä¸ªåéç¸ä¼¼åº¦è®¡ç®é®é¢ï¼æ¾åºä¸æ¥è¯¢åéææ¥è¿çææ¡£åéã</p>
<p>è¡¨é¢ä¸çï¼è¿æ¯æ°å­¦ï¼åéãåç§¯ãè·ç¦»ï¼ï¼æ¬è´¨ä¸ï¼è¿æ¯æºè½ââå ä¸ºæ¨¡åéè¿æµ·éæ°æ®å­¦ä¹ å°äºäººç±»è¯­è¨çè¯­ä¹ç»æãèæä»¬è¦åçï¼å°±æ¯ç¨ç¼ç¨è¯­è¨æè¿å¥âç¨æ°å­¦çè§£è¯­è¨âçè½åï¼åæä¸ä¸ªé«æãå¯é ãå¯é¨ç½²ççäº§çº§ç³»ç»ã</p>
<h1 id="2-ç®æ ">2. ç®æ </h1>
<p>æ¬æçåè¡·ï¼æ¯ä¸ºæçä¸ªäººåå®¢ç½ç« <a href="https://charlee44.com/" target="_blank" rel="noopener nofollow"><strong>Charlee44 çææ¯é©¿ç«</strong></a> å®ç°ä¸å¥çæ­£å¯ç¨çç«åæç´¢åè½ãç±äºåå®¢é¨ç½²å¨èµæºæå¶æéçäºæå¡å¨ä¸ï¼æ¯å¦1æ ¸ CPUã1GB åå­ï¼ï¼æå¯¹ç³»ç»æåºäºä¸¤ä¸ªâæè´âè¦æ±ï¼<strong>æè´çæ§è½</strong> ä¸ <strong>æè´çèµæºæç</strong>ã</p>
<p><img alt="ä¸ªäººåå®¢ç½ç«çç«åæç´¢åè½" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1000410/202602/1000410-20260212213951954-1452703526.png" class="lazyload"></p>
<p>æ¯ç«ï¼æ¯ä¸åç®åé½æ¥èªèªå·±çé±åââè¿ä¿ä½¿ææ¾å¼äºä¸»æµä½ç¸å¯¹âéâç Python çæï¼å¦ Sentence Transformers + ChromaDB çå¸¸è§ç»åï¼ï¼è½¬èéæ© <strong>C++</strong> ä½ä¸ºå®ç°è¯­è¨ãC++ ä¸ä»è½æä¾æ´ä½çåå­å¼éåæ´é«çæ¨çååï¼ä¹è®©æææºä¼æ·±å¥çè§£ embedding æ¨çãåéç´¢å¼ãææ¬ååç­æ¨¡åçåºå±æºå¶ã</p>
<p>å½ç¶ï¼éè¦è¯´æçæ¯ï¼<strong>å¦ææ¯å¨ä¼ä¸ç¯å¢ä¸­å¼åï¼æå¯¹è¿­ä»£éåº¦è¦æ±æ´é«ï¼Python çæä»æ¯æ´é«æãæ´æççéæ©</strong>ãèæ¬é¡¹ç®æ´å¤æ¯ä¸æ¬¡âç¨å·¥ç¨çº¦æé©±å¨æ·±åº¦å­¦ä¹ âçå®è·µââå¨æéèµæºä¸ï¼äº²ææå»ºä¸ä¸ªè½»éãå¯æ§ãå¯è½å°çè¯­ä¹æç´¢ç³»ç»ã</p>
<h1 id="3-åµå¥æ¨¡å">3. åµå¥æ¨¡å</h1>
<p>æ¢ç¶è¯­ä¹åæç´¢çæ ¸å¿å¨äºå°ææ¬è½¬åä¸ºå¯å«è¯­ä¹çåéï¼é£ä¹å®ç°è¿ä¸è½åçå³é®ï¼å°±å¨äºéæ©ä¸ä¸ªåéçåµå¥æ¨¡åãè¿ç±»æ¨¡åçä½ç¨ï¼æ¯å°ä»»æé¿åº¦çææ¬æ å°ä¸ºåºå®ç»´åº¦çç¨ å¯åéï¼ä½¿å¾è¯­ä¹ç¸ä¼¼çææ¬å¨åéç©ºé´ä¸­è·ç¦»æ´è¿ãç¬èè¿éä½¿ç¨çæ¯ <a href="https://huggingface.co/BAAI/bge-small-zh-v1.5" target="_blank" rel="noopener nofollow">bge-small-zh-v1.5</a> ãbge-small-zh-v1.5 æ¯ç±åäº¬æºæºäººå·¥æºè½ç ç©¶é¢ï¼BAAIï¼æ¨åºç BGEï¼BAAI General Embeddingï¼ç³»åä¸­çè½»éçº§ä¸­ææ¨¡åãå®åºäº Transformer æ¶æï¼å¨å¤§è§æ¨¡ä¸­è±æè¯­æä¸è¿è¡å¯¹æ¯å­¦ä¹ è®­ç»ï¼ä¸ä¸ºæ£ç´¢ä»»å¡ä¼åãå°½ç®¡å®å¹¶éè¯¥ç³»åä¸­ææ°ææå¤§ççæ¬ï¼å¦ bge-largeï¼ï¼ä½å¶å¨æ¨çéåº¦ãåå­å ç¨ä¸è¯­ä¹è´¨éä¹é´åå¾äºæä½³çå¹³è¡¡ï¼å°¤å¶éåèµæºåéæå¯¹å»¶è¿ææççäº§ç¯å¢ã</p>
<p>bge-small-zh-v1.5 å¯ä»¥ä» Hugging Face ä¸ä¸è½½ï¼ä¸è½½åçæ°æ®æä»¶ç»ç»ç»æå¦ä¸ï¼</p>
<pre><code class="language-text">bge-small-zh-v1.5/
âââ config.json                     # æ¨¡åæ¶æéç½®ï¼å±æ°ãéèå±ç»´åº¦ç­ï¼
âââ pytorch_model.bin               # PyTorch æ ¼å¼çæ¨¡åæéï¼æ ¸å¿æä»¶ï¼
âââ tokenizer.json                  # åè¯å¨å®ä¹ï¼WordPiece è¯æ±è¡¨ + ç®æ³åæ°ï¼
âââ tokenizer_config.json           # åè¯å¨éç½®ï¼å¦æ¯å¦å°ååãç¹æ® token ç­ï¼
âââ vocab.txt                       # WordPiece è¯æ±è¡¨ï¼çº¯ææ¬ï¼æ¯è¡ä¸ä¸ª tokenï¼
âââ special_tokens_map.json         # ç¹æ® token æ å°ï¼[CLS], [SEP], [PAD] ç­ï¼
âââ modules.json                    # ï¼å¯éï¼æ¨¡åæ¨¡åä¿¡æ¯
âââ sentence_bert_config.json       # ï¼å¯éï¼Sentence-BERT ç¸å³éç½®
âââ README.md                       # æ¨¡åå¡çï¼å«ä½¿ç¨è¯´æãå¼ç¨ä¿¡æ¯ç­ï¼
âââ .gitattributes                  # Git LFS éç½®ï¼ç¨äºå¤§æä»¶ç®¡çï¼
</code></pre>
<p>ä¸è¿ï¼bge-small-zh-v1.5 åçåºäº PyTorchï¼å±äº Python çæï¼ï¼ç´æ¥å¨ C++ ç¯å¢ä¸­è°ç¨å¹¶ä¸æ¹ä¾¿ï¼ä¹é¾ä»¥æ»¡è¶³æä»¬å¯¹æ§è½åèµæºå ç¨çè¦æ±ãä¸ºäºå¨ C++ ä¸­é«æè¿è¡è¯¥æ¨¡åï¼æä½³å®è·µæ¯å°å¶å¯¼åºä¸º ONNX æ ¼å¼ã</p>
<p>ONNXï¼Open Neural Network Exchangeï¼æ¯ä¸ç§å¼æ¾çç¥ç»ç½ç»æ¨¡åäº¤æ¢æ ¼å¼ï¼ç±å¾®è½¯ãFacebook ç­å¬å¸å±åæ¨å¨ï¼æ¨å¨å®ç°âä¸æ¬¡è®­ç»ï¼å¤ç«¯é¨ç½²âãå®ä¸ä¾èµç¹å®æ¡æ¶ï¼å¦ PyTorch æ TensorFlowï¼ï¼èæ¯å°æ¨¡åç»æä¸æéç»ä¸åºååä¸ºæ åæ ¼å¼ï¼ä»èå¯å¨ä¸åç¡¬ä»¶åè¯­è¨ç¯å¢ä¸­é«ææ¨çã</p>
<p>è¦å¨ C++ ä¸­å è½½åè¿è¡ ONNX æ¨¡åï¼æä»¬éè¦ä½¿ç¨ ONNX Runtimeââè¿æ¯å¾®è½¯å¼æºçé«æ§è½æ¨çå¼æï¼æ¯æ CPU/GPU å éãè·¨å¹³å°ï¼Windows/Linux/macOSï¼ä»¥å C/C++/Python ç­å¤ç§è¯­è¨ç»å®ãéè¿ ONNX Runtimeï¼æä»¬å¯ä»¥å¨æ  Python ä¾èµçæåµä¸ï¼ä»¥æä½çå¼éå®æ embedding æ¨çï¼å®ç¾å¥åæ¬é¡¹ç®çè½»éçº§ç®æ ã</p>
<p>å æ­¤ï¼å³é®çç¬¬ä¸æ­¥æ¯éè¦å° bge-small-zh-v1.5 è½¬æ¢æ ONNX æ ¼å¼çåµå¥æ¨¡åãåµå¥æ¨¡åçæ ¼å¼è½¬æ¢æ¯é¢å¤çæ­¥éª¤ï¼å¯ä»¥éè¿ Python èæ¬æ¥å®ç°ï¼</p>
<pre><code class="language-python"># export_onnx.py
from transformers import AutoTokenizer, AutoModel
from optimum.onnxruntime import ORTModelForFeatureExtraction
from pathlib import Path

# æ¹ä¸ºä½ çæ¬å°æ¨¡åè·¯å¾ï¼æ³¨æï¼ä½¿ç¨åå§å­ç¬¦ä¸²ææ­£ææ ï¼
model_path = "C:/Github/search/bge-small-zh-v1.5" 
onnx_path = "./bge-small-zh-onnx"

# å¯¼åº ONNXï¼ä»æ¬å°æ¨¡åå è½½ï¼
ort_model = ORTModelForFeatureExtraction.from_pretrained(
    model_path,           # â å³é®ï¼ä½¿ç¨æ¬å°è·¯å¾
    export=True,
    provider="CPUExecutionProvider"
)

tokenizer = AutoTokenizer.from_pretrained(model_path)  # â åæ ·ç¨æ¬å°è·¯å¾

# ä¿å­ ONNX æ¨¡åå tokenizer
ort_model.save_pretrained(onnx_path)
tokenizer.save_pretrained(onnx_path)

print(f"â ONNX æ¨¡åå·²å¯¼åºå° {onnx_path}")
</code></pre>
<p>è½¬æ¢åç ONNX æ ¼å¼åµå¥æ¨¡å bge-small-zh-onnx çæ°æ®æä»¶ç»ç»ç»æå¦ä¸ï¼</p>
<pre><code class="language-python">bge-small-zh-onnx/
âââ model.onnx                      # â æ ¸å¿ï¼ONNX æ ¼å¼çæ¨¡åè®¡ç®å¾ï¼å«æéï¼
âââ config.json                     # æ¨¡åæ¶æéç½®ï¼ä¸åçä¸è´ï¼
âââ tokenizer.json                  # åè¯å¨å®ä¹ï¼WordPiece + é¢å¤çè§åï¼
âââ tokenizer_config.json           # åè¯å¨è¡ä¸ºéç½®ï¼å¦ do_lower_caseï¼
âââ vocab.txt                       # WordPiece è¯æ±è¡¨ï¼çº¯ææ¬å¤ä»½ï¼
âââ special_tokens_map.json         # ç¹æ® token æ å°ï¼[CLS], [SEP], [PAD] ç­ï¼
</code></pre>
<h1 id="4-åè¯å¨">4. åè¯å¨</h1>
<p>å¨ä½¿ç¨ ONNX Runtime å è½½åµå¥æ¨¡åå¯¹ææ¬è¿è¡åéåä¹åï¼æä»¬è¿éè¦äºè§£ä¸ä¸ªå³é®ç»ä»¶ï¼<strong>åè¯å¨</strong>ï¼Tokenizerï¼ã</p>
<p>æè°âå­ãè¯ãå¥ãæ®µãç¯âï¼è¯­è¨ççè§£æ¯åå±çãä½å¯¹äºç°ä»£æ·±åº¦å­¦ä¹ æ¨¡åï¼å°¤å¶æ¯åºäº Transformer çæ¶æï¼èè¨ï¼å®ä»¬å¹¶ä¸ç´æ¥å¤çåå§å­ç¬¦ï¼èæ¯å°ææ¬<strong>ååä¸ºæ´å°çè¯­ä¹ååâââè¯åâ</strong>ï¼tokenï¼ãè¿ä¸ªè¿ç¨å°±æ¯ <strong>Tokenization</strong>ï¼è¯ååï¼ï¼ç±åè¯å¨å®æã</p>
<p>åè¯å¨çéè¦æ§ä½ç°å¨ä»¥ä¸ä¸¤ç¹ï¼</p>
<ol>
<li><strong>æ¨¡åè¾å¥çåæ</strong>ï¼åµå¥æ¨¡ååªæ¥å token ID åºåä½ä¸ºè¾å¥ï¼èéåå§å­ç¬¦ä¸²ãæ²¡ææ­£ç¡®çåè¯ï¼å°±æ æ³çæææç embeddingã</li>
<li><strong>å½±åè¯­ä¹ç²¾åº¦</strong>ï¼ä¸åçåè¯ç­ç¥ä¼å¯¼è´ä¸åç token åºåï¼è¿èå½±ååéè¡¨è¾¾çè´¨éã</li>
</ol>
<h2 id="41-èªå®ä¹åè¯å¨">4.1 èªå®ä¹åè¯å¨</h2>
<p>å¶å®åè¯å¨çå®ç°ä¹å¹¶ä¸ç¥ç§ï¼æä»¬å®å¨å¯ä»¥å®ç°ä¸ä¸ªç®åçæ¬çï¼</p>
<pre><code class="language-cpp">#include &lt;fstream&gt;
#include &lt;string&gt;
#include &lt;unordered_map&gt;
#include &lt;vector&gt;

#ifdef _WIN32
#include &lt;Windows.h&gt;
#endif

using namespace std;

std::unordered_map&lt;std::string, int&gt; LoadVocab(const std::string&amp; path) {
  std::unordered_map&lt;std::string, int&gt; vocab;
  std::ifstream file(path);
  std::string token;
  int id = 0;
  while (std::getline(file, token)) {
    vocab[token] = id++;
  }
  return vocab;
}

// æ³¨æï¼éå¤ç UTF-8 å¤å­èå­ç¬¦ï¼
std::vector&lt;std::string&gt; SplitTextChars(const std::string&amp; text) {
  std::vector&lt;std::string&gt; chars;
  for (size_t i = 0; i &lt; text.size();) {
    if ((text[i] &amp; 0x80) == 0) {  // ASCII
      chars.push_back(std::string(1, text[i++]));
    } else {  // UTF-8 å¤å­è
      int bytes = 0;
      if ((text[i] &amp; 0xE0) == 0xC0)
        bytes = 2;
      else if ((text[i] &amp; 0xF0) == 0xE0)
        bytes = 3;
      else if ((text[i] &amp; 0xF8) == 0xF0)
        bytes = 4;
      else
        throw std::runtime_error("Invalid UTF-8");
      chars.push_back(text.substr(i, bytes));
      i += bytes;
    }
  }
  return chars;
}

//è¾å¥å­ç¬¦ä¸²ï¼è¾åº input_ids å attention_mask
std::pair&lt;std::vector&lt;int64_t&gt;, std::vector&lt;int64_t&gt;&gt; Tokenize(
    const std::string&amp; text, const std::unordered_map&lt;std::string, int&gt;&amp; vocab,
    int maxLength = 512) {
  if (maxLength &lt; 2) {
    throw std::invalid_argument("maxLength must be at least 2");
  }

  // é¢åç¹æ® token ID
  const int clsId = vocab.at("[CLS]");
  const int sepId = vocab.at("[SEP]");
  const int padId = vocab.at("[PAD]");
  const int unkId = vocab.at("[UNK]");

  // åå§ååéï¼èªå¨ paddingï¼
  std::vector&lt;int64_t&gt; inputIds(maxLength, padId);
  std::vector&lt;int64_t&gt; attentionMask(maxLength, 0);

  //å¼å¤´å  "[CLS]"
  size_t currentIndex = 0;
  inputIds[currentIndex] = clsId;
  attentionMask[currentIndex] = 1;
  currentIndex++;

  //ä¸­é´æ¯ä¸ªå­ä½ä¸ºä¸ä¸ª tokenï¼æ¥ vocab å¾ IDï¼
  auto chars = SplitTextChars(text);
  for (const auto&amp; ch : chars) {
    if (currentIndex &gt;= maxLength - 1ULL) {
      break;
    }

    const auto&amp; it = vocab.find(ch);
    inputIds[currentIndex] = (it == vocab.end() ? unkId : it-&gt;second);
    attentionMask[currentIndex] = 1;
    currentIndex++;
  }

  //ç»å°¾å  "[SEP]"
  inputIds[currentIndex] = sepId;
  attentionMask[currentIndex] = 1;

  return {inputIds, attentionMask};
}

void TestTokenize() {
  string vocabPath = "C:/Github/search/bge-small-zh-onnx/vocab.txt";
  string text = "gitæ¤åæäº¤";

  auto vocab = LoadVocab(vocabPath);
  const auto&amp; [inputIds, attMask] = Tokenize(text, vocab);

  // æå°å10ä¸ª token ID éªè¯
  cout &lt;&lt; "Input IDs (first 10): ";
  for (int i = 0; i &lt; 10; ++i) {
    cout &lt;&lt; inputIds[i] &lt;&lt; " ";
  }

  cout &lt;&lt; "\nAttention Mask (first 10): ";
  for (int i = 0; i &lt; 10; ++i) {
    cout &lt;&lt; attMask[i] &lt;&lt; " ";
  }

  cout &lt;&lt; endl;
}

int main() {
#ifdef _WIN32
  SetConsoleOutputCP(65001);
#endif

  TestTokenize();

  return 0;
}
</code></pre>
<p>æ è®ºæ¯åå§ç <code>bge-small-zh-v1.5</code> æ¨¡åï¼è¿æ¯è½¬æ¢åç ONNX çæ¬ï¼å¶è¯æ±è¡¨ <code>vocab.txt</code> çåå®¹å®å¨ä¸è´ãæä»¬å¯ä»¥å°è¾å¥ææ¬ååä¸ºåä¸ªç token ååï¼å¹¶å¨ <code>vocab.txt</code> ä¸­æ¥æ¾å°å¯¹åºç IDï¼å°±è½çæä¸æä»¬æ³è¦åµå¥çè¾å¥åºåãå¨è¿ä¸ªç®åå®ç°ä¸­ï¼ä½¿ç¨çæåç­ç¥æ¯<strong>éå­åå</strong>ï¼ä¹å°±æ¯æ UTF-8 å­ç¬¦è¾¹çæåå­ç¬¦ä¸²ã</p>
<p>æ­¤å¤ï¼æ¨¡åä½¿ç¨äºåä¸ªå³é®çç¹æ® tokenï¼å®ä»¬å¨ <code>vocab.txt</code> å <code>special_tokens_map.json</code> ä¸­åæå®ä¹ï¼</p>
<ul>
<li><code>[CLS]</code>ï¼åºåèµ·å§æ è®°ï¼å¶å¯¹åºä½ç½®çè¾åºåéå¸¸ç¨äºå¥å­çº§ embeddingï¼BGE é»è®¤ä½¿ç¨è¯¥åéä½ä¸ºæ´ä¸ªææ¬çè¡¨ç¤ºï¼ï¼</li>
<li><code>[SEP]</code>ï¼åºåç»ææåéæ è®°ï¼ç¨äºåºåä¸åå¥å­ï¼åå¥è¾å¥æ¶ç½®äºæ«å°¾ï¼ï¼</li>
<li><code>[PAD]</code>ï¼å¡«åæ è®°ï¼ç¨äºå¯¹é½ batch ä¸­ä¸åé¿åº¦çåºåï¼</li>
<li><code>[UNK]</code>ï¼æªç¥è¯æ è®°ï¼å½è¾å¥ token ä¸å¨è¯æ±è¡¨ä¸­æ¶ä½¿ç¨ã</li>
</ul>
<p>æç»è¾åºçç»ææ¯ï¼</p>
<pre><code class="language-text">Input IDs (first 10): 101 149 151 162 3059 1726 2990 769 102 0
Attention Mask (first 10): 1 1 1 1 1 1 1 1 1 0
</code></pre>
<p>æä»¬å¯ä»¥æå¼ <code>vocab.txt</code> è¿è¡å¯¹ç§ï¼æ¯å¦æåä¸ä¸ªæ±å­âäº¤âï¼ä½äºææ¬çç¬¬770è¡ï¼è¯´ææåç token æ¯æ­£ç¡®çï¼å¯¹åº ID æ¯769ï¼ï¼å¦ä¸å¾æç¤ºï¼</p>
<p><img alt="å¨è¯æ±è¡¨ä¸­æ£æ¥åè¯å¨æåçç»æ" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1000410/202602/1000410-20260212214009404-190299176.png" class="lazyload"></p>
<p>å¦ä¸ä¸ªè¾åºç»æ Attention Maskï¼æ³¨æåæ©ç ï¼ æ¯ Transformer ç±»æ¨¡åï¼åæ¬ BGEï¼ä¸­ä¸ä¸ªå³é®çè¾å¥å¼ éï¼å®çä½ç¨æ¯åè¯æ¨¡åï¼âåªäº token æ¯çå®åå®¹ï¼åªäºæ¯å¡«åï¼paddingï¼âã</p>
<h2 id="42-hugging-face-tokenizer">4.2 Hugging Face Tokenizer</h2>
<p>ä¸è¿°çä¾å­åªæ¯æ¼ç¤ºåè¯å¨çåºæ¬æµç¨ï¼å¦æå¯¹ç§åè¯å¨çè¯æ±è¡¨ï¼æµè¯ææ¬âgitæ¤åæäº¤âå¨ä¸è¿°åè¯å¨çç»ææ¯ï¼</p>
<pre><code class="language-cpp">['g', 'i', 't', 'æ¤', 'å', 'æ', 'äº¤']
</code></pre>
<p>ä½æ¯ï¼æä»¬å¸æçåè¯ç»ææ¯ï¼</p>
<pre><code class="language-cpp">['git', 'æ¤', 'å', 'æ', 'äº¤']
</code></pre>
<p>è¿è¯´æç®åç UTF-8 å­ç¬¦ååæ æ³å¤ç°æ¨¡åè®­ç»æ¶ççå®åè¯è¡ä¸ºï¼ä¼å¯¼è´ embedding è´¨éä¸éï¼å°¤å¶å¨æ··åä¸­è±æçåå®¢åºæ¯å¯è½ä¼é æä¸å°çå½±åãå®éä¸ä¸ä¸ªå·¥ä¸çº§çåè¯å¨è¿æ¯âéå­ååâå¤æå¾å¤ï¼ä¸ä¸ªå³é®çé®é¢å°±æ¯éè¦å¨å¥å­ä¸­é¢ååçæ®µï¼ä½¿ç¨<strong>WordPiece ç®æ³</strong>è´ªå¿å¹éå­è¯ã</p>
<p>é¢å¯¹å¦æ­¤å¤æçåè¯é»è¾ï¼ä»é¶å®ç°ä¸ä¸ªå®å¨å¼å®¹ WordPiece ç tokenizer ä¸ä»èæ¶ï¼è¿ææå¼å¥ç»å¾®åå·®ââèè¿äºåå·®ä¼ç´æ¥å¯¼è´ embedding åéåç¦»é¢æï¼æç»å½±åæç´¢è´¨éãå¥½å¨ï¼æä»¬å¹¶ä¸éè¦éå¤é è½®å­ã</p>
<p>Hugging Face Tokenizer æ¯å½å NLP é¢åäºå®ä¸çå·¥ä¸æ åãå®ç± Hugging Face å®æ¹ç»´æ¤ï¼é«åº¦ä¼åãè·¨è¯­è¨æ¯æãä¸ä¸ transformers çææ ç¼éæãå æ­¤ï¼æå¥½ä½¿ç¨è¿ä¸ªåè¯å¨çå®æ¹å®ç°ï¼ç¡®ä¿è¾å¥åºåä¸æ¨¡åè®­ç»æ¶å®å¨å¯¹é½ï¼ä»èéæ¾ BGE æ¨¡åçå¨é¨è¯­ä¹è½åã</p>
<p>ä¸è¿ï¼éº»ç¦çæ¯ Hugging Face Tokenizer æ¯ä½¿ç¨ Rust å®ç°çï¼å¹¶ä¸å®æ¹åªæä¾äº Python å node çç»å®å®ç°ãè¦éæå° C++ ç¨åºä¸­ï¼æå¥½çåæ³å°±æ¯èªå·±å°è£ Hugging Face tokenizers ç C ç»å®ãå½ç¶ä¹ä¸æ¯å°è£ææç FFIï¼Foreign Function Interfaceï¼æ¥å£ï¼èæ¯å°è£èªå·±éè¦çæ¥å£å°±å¯ä»¥äºãæ¯å¦æ§è¡åè¯æ¥å£åè®¡ç®Tokençæ¥å£ï¼</p>
<pre><code class="language-rust">use std::ffi::CStr;
use std::os::raw::c_char;
use tokenizers::{PaddingParams, Tokenizer, TruncationParams};

// === 1. å®ä¹ C å¼å®¹çè¿åç»æä½ ===
#[repr(C)]
pub struct TokenizerResult {
    pub input_ids: *mut i64,
    pub attention_mask: *mut i64,
    pub token_type_ids: *mut i64,
    pub length: u64,
}

// === 2. åé¨ç¶æï¼åè£ Tokenizer ===
struct TokenizerHandle {
    tokenizer: Tokenizer,     // ç¨äº encodeï¼å¸¦ paddingï¼
    raw_tokenizer: Tokenizer, // ç¨äº countï¼æ  paddingï¼
}

// === 3. è¾å©å½æ°ï¼å° Rust Vec è½¬ä¸º C å¯æ¥æçæé ===
fn vec_to_c_ptr(vec: Vec&lt;i64&gt;) -&gt; *mut i64 {
    let mut boxed = vec.into_boxed_slice();
    let ptr = boxed.as_mut_ptr();
    std::mem::forget(boxed); // é²æ­¢ Rust èªå¨éæ¾
    ptr
}

// === 4. åå»º tokenizer ===
#[unsafe(no_mangle)] // ç¦ç¨ name manglingï¼è®© C è½æ¾å°ç¬¦å·
pub extern "C" fn tokenizer_create(tokenizer_json_path: *const c_char) -&gt; *mut std::ffi::c_void {
    if tokenizer_json_path.is_null() {
        return std::ptr::null_mut();
    }

    let path_cstr = unsafe { CStr::from_ptr(tokenizer_json_path) };
    let path_str = match path_cstr.to_str() {
        Ok(s) =&gt; s,
        Err(_) =&gt; return std::ptr::null_mut(),
    };

    let mut tokenizer = match Tokenizer::from_file(path_str) {
        Ok(t) =&gt; t,
        Err(_) =&gt; return std::ptr::null_mut(),
    };

    // è®¾ç½® padding/truncation å° 512ï¼BGE é»è®¤ï¼
    tokenizer.with_padding(Some(PaddingParams {
        strategy: tokenizers::PaddingStrategy::Fixed(512),
        ..Default::default()
    }));

    if tokenizer
        .with_truncation(Some(TruncationParams {
            max_length: 512,
            ..Default::default()
        }))
        .is_err()
    {
        return std::ptr::null_mut();
    }

    let mut raw_tokenizer = tokenizer.clone();
    raw_tokenizer.with_padding(None);
    raw_tokenizer.with_truncation(None).ok();

    let handle = TokenizerHandle {
        tokenizer,
        raw_tokenizer,
    };
    Box::into_raw(Box::new(handle)) as *mut std::ffi::c_void
}

//è®¡ç®å¥å­token
#[unsafe(no_mangle)] // ç¦ç¨ name manglingï¼è®© C è½æ¾å°ç¬¦å·
pub extern "C" fn tokenizer_count(handle: *mut std::ffi::c_void, text: *const c_char) -&gt; u64 {
    if handle.is_null() || text.is_null() {
        return 0;
    }

    let handle_ref = unsafe { &amp;*(handle as *mut TokenizerHandle) };

    let text_cstr = unsafe { CStr::from_ptr(text) };
    let text_str = match text_cstr.to_str() {
        Ok(s) =&gt; s,
        Err(_) =&gt; return 0,
    };

    match handle_ref.raw_tokenizer.encode(text_str, true) {
        Ok(encoding) =&gt; encoding.len() as u64,
        Err(_) =&gt; 0,
    }
}

// === 5. éæ¯ tokenizer ===
#[unsafe(no_mangle)]
pub extern "C" fn tokenizer_destroy(handle: *mut std::ffi::c_void) {
    if !handle.is_null() {
        unsafe {
            let _ = Box::from_raw(handle as *mut TokenizerHandle);
            // Drop èªå¨è°ç¨
        }
    }
}

// === 6. æ§è¡åè¯ ===
#[unsafe(no_mangle)]
pub extern "C" fn tokenizer_encode(
    handle: *mut std::ffi::c_void,
    text: *const c_char,
) -&gt; TokenizerResult {
    let default_result = TokenizerResult {
        input_ids: std::ptr::null_mut(),
        attention_mask: std::ptr::null_mut(),
        token_type_ids: std::ptr::null_mut(),
        length: 0,
    };

    if handle.is_null() || text.is_null() {
        return default_result;
    }

    let handle_ref = unsafe { &amp;*(handle as *mut TokenizerHandle) };

    let text_cstr = unsafe { CStr::from_ptr(text) };
    let text_str = match text_cstr.to_str() {
        Ok(s) =&gt; s,
        Err(_) =&gt; return default_result,
    };

    let encoding = match handle_ref.tokenizer.encode(text_str, true) {
        Ok(e) =&gt; e,
        Err(_) =&gt; return default_result,
    };

    let input_ids: Vec&lt;i64&gt; = encoding.get_ids().iter().map(|&amp;x| x as i64).collect();
    let attention_mask: Vec&lt;i64&gt; = encoding
        .get_attention_mask()
        .iter()
        .map(|&amp;x| x as i64)
        .collect();
    let token_type_ids: Vec&lt;i64&gt; = encoding.get_type_ids().iter().map(|&amp;x| x as i64).collect();
    // BGE ä¸éè¦ï¼ä½ C++ ä»£ç ä¼ äº
    // let token_type_ids: Vec&lt;u32&gt; = vec![0u32; input_ids.len()];

    let len = input_ids.len(); // åºè¯¥æ¯ 512ï¼ä½æ´éç¨

    TokenizerResult {
        input_ids: vec_to_c_ptr(input_ids),
        attention_mask: vec_to_c_ptr(attention_mask),
        token_type_ids: vec_to_c_ptr(token_type_ids),
        length: len as u64,
    }
}

// === 7. éæ¾ç»æåå­ ===
#[unsafe(no_mangle)]
pub extern "C" fn tokenizer_result_free(result: TokenizerResult) {
    if !result.input_ids.is_null() {
        unsafe {
            let _ = Vec::from_raw_parts(
                result.input_ids,
                result.length as usize,
                result.length as usize,
            );
        }
    }

    if !result.attention_mask.is_null() {
        unsafe {
            let _ = Vec::from_raw_parts(
                result.attention_mask,
                result.length as usize,
                result.length as usize,
            );
        }
    }

    if !result.token_type_ids.is_null() {
        unsafe {
            let _ = Vec::from_raw_parts(
                result.token_type_ids,
                result.length as usize,
                result.length as usize,
            );
        }
    }
}
</code></pre>
<p>å¯¹åºç C æ¥å£å¦ä¸ï¼</p>
<pre><code class="language-cpp">// tokenizer_result.h
#pragma once

#include &lt;stdint.h&gt;

// å®ä¹ç»æä½
struct TokenizerResult {
    int64_t* input_ids;
    int64_t* attention_mask;
    int64_t* token_type_ids;
    uint64_t length;
};

typedef struct TokenizerResult TokenizerResult;
</code></pre>
<pre><code class="language-cpp">// hf_tokenizer_ffi
#pragma once

#include "tokenizer_result.h"

#ifdef __cplusplus
extern "C" {
#endif

void* tokenizer_create(const char* tokenizer_json_path);
void tokenizer_destroy(void* handle);
TokenizerResult tokenizer_encode(void* handle, const char* text);
uint64_t tokenizer_count(void* handle, const char* text);
void tokenizer_result_free(TokenizerResult result);

#ifdef __cplusplus
}
#endif
</code></pre>
<p>æä»¬å¨ C++ ç¨åºä¸­è°ç¨è¿ä¸ª C ç»å®çæ¥å£ï¼</p>
<pre><code class="language-cpp">#include &lt;hf_tokenizer_ffi.h&gt;

#include &lt;string&gt;
#include &lt;vector&gt;

#ifdef _WIN32
#include &lt;Windows.h&gt;
#endif

using namespace std;

void TestTokenize() {
  void* handle =
      tokenizer_create("C:/Github/search/bge-small-zh-onnx/tokenizer.json");

  if (!handle) {
    std::cerr &lt;&lt; "Failed to create tokenizer\n";
    return;
  }

  TokenizerResult result = tokenizer_encode(handle, "gitæ¤åæäº¤");

  if (!result.input_ids) {
    std::cerr &lt;&lt; "Tokenize failed\n";
    tokenizer_destroy(handle);
    return;
  }

  std::cout &lt;&lt; "Length: " &lt;&lt; result.length &lt;&lt; "\n";
  for (int i = 0; i &lt; 10; ++i) {
    std::cout &lt;&lt; result.input_ids[i] &lt;&lt; " ";
  }
  std::cout &lt;&lt; "\n";

  // å¿é¡»éæ¾ï¼
  tokenizer_result_free(result);
  tokenizer_destroy(handle);

  return;
}

int main() {
#ifdef _WIN32
  SetConsoleOutputCP(65001);
#endif

  TestTokenize();

  return 0;
}
</code></pre>
<p>è¿è¡ç»æå¦ä¸ï¼</p>
<pre><code>Length: 512
101 10807 3059 1726 2990 769 102 0 0 0
</code></pre>
<p>å¾æ¾ç¶ï¼è¿åçå10ä¸ª ID å¼ä¸­ææ ID å°äºä¸¤ä¸ªãåæ£æ¥ä¸ä¸ç¬¬ä¸ä¸ª token ä¹å°±æ¯ç¬¬10808è¡ï¼å¯¹åº ID 10807ï¼çè¯æ±ï¼</p>
<p><img alt="å¨è¯æ±è¡¨ä¸­æ£æ¥åè¯å¨æåçç»æ" loading="lazy" data-src="https://img2024.cnblogs.com/blog/1000410/202602/1000410-20260212214014487-390716379.png" class="lazyload"></p>
<p>æ­£å¥½æ¯âgitâï¼è¯´æåè¯å¨æ­£ç¡®æåäºå­è¯ã</p>
<p>éªè¯äºæ­£ç¡®æ§ï¼å°±è¦ä¿è¯å®å¨æ§ãè½ç¶å¨ C++ ç¨åºä¸­å¯ä»¥è¿æ ·ä½¿ç¨ C æ¥å£ï¼ä½æ¯æ´å å®å¨é«æçä½¿ç¨æ¹å¼æ¯ä½¿ç¨ RAII ååè¿è¡å°è£ãè¿ä¸ç¹ç¬èçæç« <a href="https://charlee44.com/post.html?id=62bdd64be665488fa0c33abc399176e7" target="_blank" rel="noopener nofollow">ãC++ å°è£ C FFI æ¥å£æä½³å®è·µï¼ä»¥ Hugging Face Tokenizer ä¸ºä¾ã</a>æè¿ç¸å³çè®ºè¿°ãè¿éç´æ¥æ¾åºå°è£å¥½çç»æï¼</p>
<pre><code class="language-cpp">// HfTokenizer.h
#pragma once

#include &lt;tokenizer_result.h&gt;

#include &lt;memory&gt;
#include &lt;string&gt;

namespace embedding {

namespace hf {
class Tokenizer {
 public:
  explicit Tokenizer(const std::string&amp; path);

  // ç¼è¯å¨èªå¨çæï¼
  // - ææå½æ°ï¼è°ç¨ Deleterï¼
  // - ç§»å¨æé  / ç§»å¨èµå¼
  // - ç¦æ­¢æ·è´ï¼å ä¸º unique_ptr ä¸å¯æ·è´ï¼

  // å¶ä»æ¥å£æ¹æ³
  uint64_t Count(const std::string&amp; text) const;

  // åéå
  using ResultPtr =
      std::unique_ptr&lt;TokenizerResult, void (*)(TokenizerResult*)&gt;;
  ResultPtr Encode(const std::string&amp; text) const;

 private:
  std::unique_ptr&lt;void, void (*)(void*)&gt; handle;
};

}  // namespace hf

}  // namespace embedding
</code></pre>
<pre><code class="language-cpp">// HfTokenizer.cpp
#include "HfTokenizer.h"

#include &lt;hf_tokenizer_ffi.h&gt;

#include &lt;stdexcept&gt;

#ifdef __cplusplus
static_assert(std::is_standard_layout_v&lt;TokenizerResult&gt; &amp;&amp;
                  std::is_trivially_copyable_v&lt;TokenizerResult&gt;,
              "TokenizerResult must be C ABI compatible");
#endif

namespace embedding {

namespace hf {

static void HandleDeleter(void* handle) noexcept {
  if (handle) {
    tokenizer_destroy(handle);
  }
}

static void ResultDeleter(TokenizerResult* p) noexcept {
  if (p) {
    tokenizer_result_free(*p);
    delete p;
  }
}

Tokenizer::Tokenizer(const std::string&amp; path)
    : handle(tokenizer_create(path.c_str()), HandleDeleter) {
  if (!handle) {
    throw std::runtime_error("Failed to create tokenizer from " + path);
  }
}

uint64_t Tokenizer::Count(const std::string&amp; text) const {
  return tokenizer_count(handle.get(), text.c_str());
}

Tokenizer::ResultPtr Tokenizer::Encode(const std::string&amp; text) const {
  auto result = std::make_unique&lt;TokenizerResult&gt;(
      tokenizer_encode(handle.get(), text.c_str()));
  return {result.release(), ResultDeleter};
  // TokenizerResult raw = tokenizer_encode(handle.get(), text.c_str());
  // return {new TokenizerResult(std::move(raw)), ResultDeleter};
};

}  // namespace hf

}  // namespace embedding
</code></pre>
<h1 id="5-åµå¥å¨">5. åµå¥å¨</h1>
<p>å¨è§£å³äºåè¯å¨çé®é¢ä¹åï¼å°±å¯ä»¥å¼å§å®ç°å¥å­åµå¥çåè½äºãå¦åææå°çï¼è¯¥åè½å¯ä»¥å¼å¥ ONNX Runtime ç»ä»¶æ¥å®ç°ãä¸ºäºæ¹ä¾¿è¿ä¸æ­¥ä½¿ç¨ï¼æä»¬å°è¿ä¸ªåè½å°è£ä¸ºåµå¥å¨ï¼</p>
<pre><code class="language-cpp">// BgeOnnxEmbedder.h
#pragma once

#include &lt;memory&gt;
#include &lt;string&gt;
#include &lt;vector&gt;

namespace embedding {

namespace hf {
class Tokenizer;
}

class BgeOnnxEmbedder {
 public:
  explicit BgeOnnxEmbedder(const std::string&amp; modelPath,
                           const hf::Tokenizer&amp; tokenizer);
  ~BgeOnnxEmbedder();

  const int64_t&amp; EmbeddingDim() const;

  std::vector&lt;float&gt; Embed(const std::string&amp; text) const;

 private:
  class Impl;  // ååå£°æ
  std::unique_ptr&lt;Impl&gt; impl;
};

}  // namespace embedding
</code></pre>
<pre><code class="language-cpp">// BgeOnnxEmbedder.cpp
#include "BgeOnnxEmbedder.h"

#include &lt;onnxruntime_cxx_api.h&gt;

#include "HfTokenizer.h"
#include "Util/StringEncode.h"

namespace embedding {

class BgeOnnxEmbedder::Impl {
 public:
  Ort::Env&amp; GetOrtEnv() {
    static Ort::Env env(ORT_LOGGING_LEVEL_WARNING, "BgeOnnxEmbedder");
    return env;
  }

  const int64_t&amp; EmbeddingDim() const { return embeddingDim; }

  explicit Impl(const std::string&amp; modelPath, const hf::Tokenizer&amp; tokenizer)
      : session{GetOrtEnv(),
#ifdef _WIN32
                util::StringEncode::Utf8StringToWideString(modelPath).c_str(),
#else
                modelPath.c_str(),
#endif
                Ort::SessionOptions()},
        memInfo{Ort::MemoryInfo::CreateCpu(OrtDeviceAllocator, OrtMemTypeCPU)},
        tokenizer(tokenizer),
        embeddingDim(0) {

    //
    const auto&amp; outputInfo = session.GetOutputTypeInfo(0);
    const auto&amp; tensorInfo = outputInfo.GetTensorTypeAndShapeInfo();
    const auto&amp; shape = tensorInfo.GetShape();

    // åè®¾è¾åºæ¯ [batch, seq, dim] æ [batch, dim]
    // æä»¬åæåä¸ä¸ªé -1 çç»´åº¦
    for (auto it = shape.rbegin(); it != shape.rend(); ++it) {
      if (*it != -1) {
        embeddingDim = *it;
        break;
      }
    }

    if (embeddingDim == 0) {
      throw std::runtime_error(
          "Failed to infer embedding dimension from ONNX model.");
    }
  }

  std::vector&lt;float&gt; Embed(const std::string&amp; text) const {
    hf::Tokenizer::ResultPtr result = tokenizer.Encode(text);
    if (!result) {
      throw std::runtime_error("tokenizer_encode failed");
    }

    // å®ä¹å¼ éç»´åº¦
    int64_t seqLen = static_cast&lt;int64_t&gt;(result-&gt;length);
    std::vector&lt;int64_t&gt; inputShape = {1, seqLen};
    size_t dataByteCount = sizeof(int64_t) * seqLen;

    Ort::Value inputIdsTensor = Ort::Value::CreateTensor(
        memInfo.GetConst(), result-&gt;input_ids, dataByteCount, inputShape.data(),
        inputShape.size(),
        ONNXTensorElementDataType::ONNX_TENSOR_ELEMENT_DATA_TYPE_INT64);

    Ort::Value attentionMaskTensor = Ort::Value::CreateTensor(
        memInfo.GetConst(), result-&gt;attention_mask, dataByteCount,
        inputShape.data(), inputShape.size(),
        ONNXTensorElementDataType::ONNX_TENSOR_ELEMENT_DATA_TYPE_INT64);

    Ort::Value tokenTypeIdsTensor = Ort::Value::CreateTensor(
        memInfo.GetConst(), result-&gt;token_type_ids, dataByteCount,
        inputShape.data(), inputShape.size(),
        ONNXTensorElementDataType::ONNX_TENSOR_ELEMENT_DATA_TYPE_INT64);

    // è¾å¥åå¿é¡»ä¸æ¨¡åå®ä¹ä¸è´
    const char* inputNames[] = {"input_ids", "attention_mask",
                                "token_type_ids"};
    const char* outputNames[] = {"last_hidden_state"};

    // æä¸ä¸ªè¾å¥å¼ éæ¾è¿æ°ç»
    std::vector&lt;Ort::Value&gt; inputs;
    inputs.push_back(std::move(inputIdsTensor));
    inputs.push_back(std::move(attentionMaskTensor));
    inputs.push_back(std::move(tokenTypeIdsTensor));

    // æ§è¡æ¨ç
    auto outputs = session.Run(Ort::RunOptions(),  // è¿è¡éé¡¹ï¼éå¸¸ nullptrï¼
                               inputNames,         // è¾å¥åæ°ç»
                               inputs.data(),  // è¾å¥å¼ éæ°ç»
                               inputs.size(),  // è¾å¥æ°éï¼3ï¼
                               outputNames,    // è¾åºåæ°ç»
                               1               // è¾åºæ°éï¼1ï¼
    );

    // è·åè¾åºä¿¡æ¯
    auto&amp; output_tensor = outputs[0];
    auto output_shape = output_tensor.GetTensorTypeAndShapeInfo().GetShape();
    if (output_shape.size() != 3 || output_shape[0] != 1) {
      throw std::runtime_error("Unexpected output shape");
    }

    // è·åè¾åºå¼ éçåå§ float æé
    const float* outputData = outputs[0].GetTensorData&lt;float&gt;();

    // æå [CLS] token ç embeddingï¼ç¬¬0ä¸ªtokenï¼
    int64_t hiddenSize = output_shape[2];
    std::vector&lt;float&gt; embedding(outputData, outputData + hiddenSize);

    // L2 å½ä¸åï¼BGE è¦æ±ï¼
    float norm = 0.0f;
    for (float v : embedding) norm += v * v;
    norm = std::sqrt(norm);
    if (norm &gt; 1e-8) {
      for (float&amp; v : embedding) v /= norm;
    }

    return embedding;
  }

 private:
  mutable Ort::Session session;
  Ort::MemoryInfo memInfo;
  const hf::Tokenizer&amp; tokenizer;
  int64_t embeddingDim;
};

BgeOnnxEmbedder::BgeOnnxEmbedder(const std::string&amp; modelPath,
                                 const hf::Tokenizer&amp; tokenizer)
    : impl(std::make_unique&lt;Impl&gt;(modelPath, tokenizer)) {}

BgeOnnxEmbedder::~BgeOnnxEmbedder() = default;  // æ­¤æ¶ Impl å·²å®ä¹ï¼å¯å®å¨ææ

const int64_t&amp; BgeOnnxEmbedder::EmbeddingDim() const {
  return impl-&gt;EmbeddingDim();
}

std::vector&lt;float&gt; BgeOnnxEmbedder::Embed(const std::string&amp; text) const {
  return impl-&gt;Embed(text);
}

}  // namespace embedding
</code></pre>
<p>å¨è°ç¨ ONNX Runtime æ§è¡æ¨çä¹åï¼æä»¬å¿é¡»å°åè¯å¨è¾åºçåå§ token åºåè½¬æ¢ä¸ºæ¨¡åè½å¤çè§£çå¼ éï¼Tensorï¼æ ¼å¼ãè¿æ­£æ¯ <code>inputIdsTensor</code>ã<code>attentionMaskTensor</code> å <code>tokenTypeIdsTensor</code> ä¸ä¸ªå¼ éçç±æ¥ââå®ä»¬å±åææäº Transformer æ¨¡åçæ åè¾å¥ä¸åç»ã</p>
<ul>
<li><strong><code>input_ids</code></strong>ï¼å¯¹åº <code>inputIdsTensor</code>ï¼ï¼<br>
è¿æ¯ææ ¸å¿çè¾å¥ï¼è¡¨ç¤ºææ¬ç»è¿åè¯åå¾å°ç token ID åºåãæ¯ä¸ª ID æ¯è¯æ±è¡¨ï¼<code>vocab.txt</code>ï¼ä¸­çç´¢å¼ï¼æ¨¡åéè¿åµå¥å±ï¼Embedding Layerï¼å°å¶æ å°ä¸ºç¨ å¯åéãä¾å¦ï¼å¥å­ âgitæ¤åæäº¤â ç» Hugging Face åè¯å¨å¤çåï¼ä¼åæ <code>[101, 10807, 3059, 1726, 2990, 769, 102, 0, 0, ...]</code>ï¼å¶ä¸­ <code>101</code> æ¯ <code>[CLS]</code>ï¼<code>102</code> æ¯ <code>[SEP]</code>ï¼å¶ä½ä¸ºå®éåå®¹æå¡«åï¼<code>[PAD]</code>ï¼ID=0ï¼ãè¿ä¸ªåºåè¢«ç»ç»æå½¢ç¶ä¸º <code>(1, seq_len)</code> çäºç»´å¼ éï¼batch_size=1ï¼ï¼ä½ä¸ºæ¨¡åçä¸»è¾å¥ã</li>
<li><strong><code>attention_mask</code></strong>ï¼å¯¹åº <code>attentionMaskTensor</code>ï¼<br>
ç±äº BGE æ¨¡åè¦æ±ææè¾å¥åºåé¿åº¦å¯¹é½ï¼æ­¤å¤åºå®ä¸º 512ï¼ï¼ç­ææ¬ä¼è¢« <code>[PAD]</code> å¡«åãä½æ¨¡åä¸åºâå³æ³¨âè¿äºæ æä¹çå¡«åä½ç½®ã<code>attention_mask</code> å°±æ¯ä¸ä¸ªäºå¼æ©ç ï¼çå® token å¯¹åº <code>1</code>ï¼å¡«åé¨åå¯¹åº <code>0</code>ãTransformer çèªæ³¨æåæºå¶ä¼å©ç¨è¯¥æ©ç ï¼å¨è®¡ç®æ³¨æåæéæ¶èªå¨å¿½ç¥ <code>[PAD]</code>ï¼ä»èé¿ååªå£°å¹²æ°è¯­ä¹è¡¨ç¤ºã</li>
<li><strong><code>token_type_ids</code></strong>ï¼å¯¹åº <code>tokenTypeIdsTensor</code>ï¼<br>
è¯¥è¾å¥ä¸»è¦ç¨äºåºåå¥å­å¯¹ä»»å¡ï¼å¦é®ç­ãå¥å­ç¸ä¼¼åº¦å¤æ­ï¼ï¼ä¾å¦ <code>[Aå¥][SEP][Bå¥]</code> ä¸­ A å B åå±ä¸å segmentãä½å¨åå¥åµå¥åºæ¯ï¼å¦æä»¬çåå®¢æç´¢ï¼ä¸­ï¼æ´ä¸ªè¾å¥åªåå«ä¸ä¸ªå¥å­ï¼å æ­¤ææææ token ç <code>token_type_id</code> åä¸º <code>0</code>ãå°½ç®¡ BGE æ¨¡åå¨è®­ç»æ¶å¯è½ä½¿ç¨äºè¯¥å­æ®µï¼ä½å¨æ¨çé¶æ®µå³ä½¿ä¼ å¥å¨é¶åéï¼ä¹ä¸ä¼å½±å <code>[CLS]</code> è¡¨ç¤ºçè´¨éãåºäºæ¥å£å¼å®¹æ§èèï¼æä»¬ä»æè§èæä¾æ­¤å¼ éã</li>
</ul>
<p>è¿ä¸ä¸ªå¼ ééè¿ ONNX Runtime ç C++ API è¢«å°è£ä¸º <code>Ort::Value</code> å¯¹è±¡ï¼å¹¶ä»¥åç§°å¹éçæ¹å¼ä¼ å¥æ¨¡åãONNX æ¨¡ååé¨ä¼æ ¹æ® <code>config.json</code> ä¸­å®ä¹çè¾å¥èç¹åï¼éå¸¸ä¸º <code>"input_ids"</code>ã<code>"attention_mask"</code>ã<code>"token_type_ids"</code>ï¼æ­£ç¡®ç»å®æ°æ®ãéåï¼æ¨¡åæ§è¡ååä¼ æ­ï¼è¾åºæåä¸å±éèç¶æï¼<code>last_hidden_state</code>ï¼ï¼å¶å½¢ç¶ä¸º <code>(1, seq_len, hidden_size)</code>ãæä»¬ä»ä¸­æåç¬¬ 0 ä¸ªä½ç½®ï¼å³ <code>[CLS]</code> tokenï¼çåéä½ä¸ºæ´å¥çè¯­ä¹è¡¨ç¤ºï¼å¹¶æ BGE å®æ¹æ¨èè¿è¡ <strong>L2 å½ä¸å</strong>ââè¿ä¸æ­¥è³å³éè¦ï¼å ä¸ºåç»­çåéç¸ä¼¼åº¦æ£ç´¢ï¼å¦ä½å¼¦ç¸ä¼¼åº¦ï¼ä¾èµäºåä½åéç©ºé´ä¸­çç¹ç§¯ç­ä»·æ§ã</p>
<blockquote>
<p>åµå¥æ¨¡å bge-small-zh-v1.5 æå¤§è¾å¥é¿åº¦ = 512 tokensï¼åµå¥åéç»´åº¦ = 512ç»´ãåæ°å¼é½æ¯ 512 ï¼ä½æ¯ä¸¤èå¹¶æ²¡æç»å¯¹çå³ç³»ï¼è¯·æ³¨æåºåã</p>
</blockquote>
<p>è³æ­¤ï¼ä¸æ®µä»»æé¿åº¦çä¸­æææ¬å°±è¢«æåè½¬åä¸ºä¸ä¸ª 512 ç»´ï¼<code>bge-small-zh-v1.5</code> çè¾åºç»´åº¦ï¼çæ ååè¯­ä¹åéãç¼è§æä¸ºå®ï¼å¾å¤äººï¼åæ¬ç¬èï¼æ³ççæä¸ªææ¬ï¼æ¯å¦åé¢çâgitæ¤åæäº¤âï¼çåéåè¾åºï¼é£ä¹å¯ä»¥åæµè¯ä¸ä¸ï¼</p>
<pre><code class="language-cpp">#include &lt;string&gt;
#include &lt;vector&gt;

#include "BgeOnnxEmbedder.h"
#include "HfTokenizer.h"

#ifdef _WIN32
#include &lt;Windows.h&gt;
#endif

using namespace std;
using namespace embedding;

int main() {
#ifdef _WIN32
  SetConsoleOutputCP(65001);
#endif

  hf::Tokenizer tokenizer("C:/Github/search/bge-small-zh-onnx/tokenizer.json");
  BgeOnnxEmbedder bgeOnnxEmbedder(
      "C:/Github/search/bge-small-zh-onnx/model.onnx", tokenizer);

  string text = "gitæ¤åæäº¤";
  std::vector&lt;float&gt; embedding = bgeOnnxEmbedder.Embed(text);

  for (auto value : embedding) {
    printf("%lf\t", value);
  }

  return 0;
}
</code></pre>
<p>è¾åºç»ææ¯ï¼</p>
<pre><code class="language-text">-0.031685       -0.035368       0.069596        -0.030640       -0.011818       -0.023779       -0.043855       0.0064050.067668        0.004901        0.025522        -0.269526       -0.024420       0.065645    ...      0.003664        -0.002409      -0.061532        0.002052        -0.056993       -0.057258       -0.073969       -0.020673       0.044549        0.005769-0.009345       -0.004969       0.013322        0.041202
</code></pre>
<p>å¶å®ä¹æ²¡ä»ä¹ç¹å«çï¼å°±æ¯ä¸ä¸ªé«ç»´åéï¼è¿ä¸ªåéæ¯ä¹æºå¨çè§£çï¼æä»¥ä¹æ²¡ä»ä¹å¯éè¯»æ§ã</p>
<p>å¦å¤è¡¥åä¸ç¹ï¼è¿ä¸ªåµå¥å¨å®ç°æ¯åºäº PIMPL ææ¯å®ç°çï¼ç¬èçæç« <a href="https://charlee44.com/post.html?id=b89125a9380d44bc865557f3d1781c9f" target="_blank" rel="noopener nofollow">ãä¸ºä»ä¹ç°ä»£ C++ åºé½ç¨ PIMPLï¼ä¸åºå³äºå°è£ãä¾èµä¸å®å¨çæ¼è¿ã</a>å°±ä»¥è¿ä¸ªåµå¥å¨ä¸ºä¾è®ºè¿°äº PIMPL ææ¯ã</p>
<h1 id="6-è¯­ä¹åæ®µå¨">6. è¯­ä¹åæ®µå¨</h1>
<p>å¨æåå®ç°å¥å­åµå¥åè½åï¼ä¼¼ä¹è¯­ä¹åæç´¢çæ ¸å¿é¾é¢å·²ç»è§£å³ãç¶èï¼çæ­£çæææååå¼å§ï¼<strong>åµå¥æ¨¡åå¯¹è¾å¥é¿åº¦æ¯æéå¶ç</strong>ãä»¥æä»¬ä½¿ç¨ç <code>bge-small-zh-v1.5</code> ä¸ºä¾ï¼å¶æå¤§æ¯æç token é¿åº¦ä¸º 512ãè¿æå³çï¼è¥ç´æ¥å°ä¸ç¯é¿åå®¢æç« ï¼å¯è½åå«æ°åå­ï¼éå¥æ¨¡åï¼è¶åºé¨åä¼è¢«æªæ­ï¼å¯¼è´å¤§éè¯­ä¹ä¿¡æ¯ä¸¢å¤±ã</p>
<p>ä¹çä¹ä¸ï¼è§£å³æ¹æ¡ä¼¼ä¹å¾ç®åï¼æ 512 token çé¿åº¦å¯¹ææ¡£è¿è¡æºæ¢°ååå³å¯ãä½è¿ç§âæ´åååâä¼å¸¦æ¥ä¸¥éé®é¢ï¼</p>
<ol>
<li><strong>ç ´åè¯­ä¹å®æ´æ§</strong>ï¼ä¸ä¸ªå®æ´çå¥å­ææ®µè½å¯è½è¢«ä»ä¸­åæ­ï¼å¯¼è´çæçåéæ æ³åç¡®è¡¨è¾¾åå§å«ä¹ï¼</li>
<li><strong>å²è£ä¸ä¸æå³è</strong>ï¼ç¸é»ä½è¢«å¼ºè¡åå²çåä¹é´ç¼ºä¹è¯­ä¹è¡æ¥ï¼å½±ååç»­æ£ç´¢çç¸å³æ§ï¼</li>
<li><strong>æµªè´¹åµå¥å®¹é</strong>ï¼ç­æ®µè½åç¬æåä¼é æå¤§éå¡«åï¼paddingï¼ï¼éä½åéå¯åº¦åæ£ç´¢æçã</li>
</ol>
<p>å æ­¤ï¼<strong>å³é®ä¸å¨äºâå¦ä½åâï¼èå¨äºâå¨åªéåâ</strong>ââæä»¬éè¦çæ¯<strong>å·æè¯­ä¹è¾¹ççåå</strong>ï¼èéä»»æä½ç½®çæªæ­ã</p>
<p>å¯¹äº Markdown æ ¼å¼çåå®¢æç« èè¨ï¼è¿ä¸ç®æ å¤©ç¶å·å¤å®ç°åºç¡ï¼<strong>æ é¢ï¼å¦ <code>#</code>ã<code>##</code> ç­ï¼æ¬èº«å°±æ¯æ¸æ°çè¯­ä¹è¾¹ç</strong>ãæ¯ä¸ªæ é¢ä¸çåå®¹éå¸¸ææä¸ä¸ªé»è¾èªæ´½çä¸»é¢ååï¼ä¾å¦âå®è£æ­¥éª¤âãâåçåæâãâå¸¸è§é®é¢âï¼ãåºäºæ­¤ï¼æä»¬å¯ä»¥è®¾è®¡ä¸ä¸ª <strong>Markdown è¯­ä¹åæ®µå¨ï¼<code>MdSemanticSplitter</code>ï¼</strong>ï¼å¶æ ¸å¿ä»»å¡ä¸æ¯çææç»ç¨äºåµå¥çâåâï¼chunkï¼ï¼èæ¯åå°æ´ç¯ææ¡£<strong>æè¯­ä¹ç»ææåä¸ºè¥å¹²âè¯­ä¹æ®µâï¼semantic sectionsï¼</strong>ã</p>
<blockquote>
<p>ð æ³¨æï¼<strong>è¯­ä¹åæ®µ â  æç»åå</strong>ã<br>
åæ®µæ¯é¢å¤çé¶æ®µï¼å³æ³¨çæ¯<strong>åå®¹ç»æä¸é»è¾è¾¹ç</strong>ï¼èååï¼chunkingï¼æ¯åç»­æ­¥éª¤ï¼å³æ³¨çæ¯<strong>å¦ä½å°è¯­ä¹æ®µééå°æ¨¡åé¿åº¦éå¶å</strong>ï¼ä¾å¦åå¹¶ç­æ®µãæ»å¨çªå£éå ç­ï¼ã</p>
</blockquote>
<p>è¿ç§ä¸¤é¶æ®µç­ç¥å·æè¯å¥½çæ©å±æ§ï¼æ è®ºæ¯ MarkdownãWord è¿æ¯ HTML ææ¡£ï¼åªè¦è½æååºè¯­ä¹å±çº§ç»æï¼å¦ç« èãæ®µè½ãåè¡¨ãä»£ç åç­ï¼ï¼å°±å¯ä»¥åéè¿å¯¹åºç <strong>è¯­ä¹åæ®µå¨</strong> å¾å°ç»æåçæ®µï¼åäº¤ç±éç¨ç <strong>ææ¬ååå¨ï¼<code>TextChunker</code>ï¼</strong> è¿è¡é¿åº¦ééä¸åéååå¤ã</p>
<p>å æ­¤ï¼å¨æä»¬çç³»ç»ä¸­ï¼è¯­ä¹åæ®µå¨<code>MdSemanticSplitter</code> çèè´£éå¸¸æç¡®ï¼<strong>è§£æ Markdownï¼è¯å«æ é¢å±çº§ï¼æè¯­ä¹è¾¹çåååºå®æ´çæ®µè½åå</strong>ï¼ä¸ºåç»­é«æãåç¡®çåµå¥æä¸åå®åºç¡ãå·ä½çå®ç°å¦ä¸ï¼</p>
<pre><code class="language-cpp">// SemanticBlock.h
#pragma once

#include &lt;string&gt;
#include &lt;vector&gt;

// è¯­ä¹å
struct SemanticBlock {
  std::string context;                //ä¸ä¸æï¼éå¸¸æ¯æ ç­¾
  std::vector&lt;std::string&gt; contents;  //ææ¬åå®¹
};
</code></pre>
<pre><code class="language-cpp">// MdSemanticSplitter.h
#pragma once

#include "SemanticBlock.h"

namespace embedding {

class MdSemanticSplitter {
 public:
  std::vector&lt;SemanticBlock&gt; Split(const std::string&amp; title,
                                   const std::string&amp; content,
                                   const std::string&amp; summary) const;
};
}  // namespace embedding
</code></pre>
<pre><code class="language-cpp">// MdSemanticSplitter.cpp
#include "MdSemanticSplitter.h"

#include &lt;md4c.h&gt;

#include &lt;iostream&gt;
#include &lt;list&gt;

using namespace std;

namespace embedding {

enum class BlockKind { Heading, Paragraph, ListItem, BlockQuote };

struct Block {
  BlockKind kind;
  int level = 0;  // heading level
  std::string text;
};

struct ParseContext {
  std::vector&lt;Block&gt; result;
  std::vector&lt;Block&gt; blockStack;  // Blockæ 
  // int activeDepth = 0;            //æ·±åº¦è®¡æ°
};

static int EnterBlock(MD_BLOCKTYPE type, void* detail, void* userdata) {
  auto* ctx = static_cast&lt;ParseContext*&gt;(userdata);

  Block block{};
  switch (type) {
    case MD_BLOCK_H: {
      auto* h = static_cast&lt;MD_BLOCK_H_DETAIL*&gt;(detail);
      block.kind = BlockKind::Heading;
      block.level = h-&gt;level;
      break;
    }
    case MD_BLOCK_P: {
      block.kind = BlockKind::Paragraph;
      break;
    }
    case MD_BLOCK_LI: {
      block.kind = BlockKind::ListItem;
      break;
    }
    case MD_BLOCK_QUOTE: {
      block.kind = BlockKind::BlockQuote;
      break;
    }
    default:
      // å¶ä» blockï¼å¦ UL / OL / CODEï¼ä¸å¤ç
      break;
  }

  ctx-&gt;blockStack.emplace_back(std::move(block));
  return 0;
}

static int TextCallback(MD_TEXTTYPE type, const MD_CHAR* text, MD_SIZE size,
                        void* userdata) {
  auto* ctx = static_cast&lt;ParseContext*&gt;(userdata);
  if (ctx-&gt;blockStack.empty()) return 0;

  // åªæ¥æ¶çå®å¯è¯»ææ¬
  if (type == MD_TEXT_NORMAL || type == MD_TEXT_CODE) {
    ctx-&gt;blockStack.back().text.append(text, size);
  }

  return 0;
}

static int LeaveBlock(MD_BLOCKTYPE type, void*, void* userdata) {
  auto* ctx = static_cast&lt;ParseContext*&gt;(userdata);
  if (ctx-&gt;blockStack.empty()) {
    return 0;
  }

  Block block = std::move(ctx-&gt;blockStack.back());
  ctx-&gt;blockStack.pop_back();

  bool emit = false;
  switch (type) {
    case MD_BLOCK_H:
    case MD_BLOCK_P:
    case MD_BLOCK_LI:
    case MD_BLOCK_QUOTE:
      emit = true;
      break;
    default:
      break;
  }

  if (emit &amp;&amp; !block.text.empty()) {
    ctx-&gt;result.emplace_back(std::move(block));
  }

  return 0;
}

static int EnterSpan(MD_SPANTYPE /*type*/, void* /*detail*/,
                     void* /*userdata*/) {
  return 0;
}

static int LeaveSpan(MD_SPANTYPE /*type*/, void* /*detail*/,
                     void* /*userdata*/) {
  return 0;
}

std::vector&lt;SemanticBlock&gt; MdSemanticSplitter::Split(
    const std::string&amp; title, const std::string&amp; content,
    const std::string&amp; summary) const {
  ParseContext ctx{};

  MD_PARSER parser{};
  parser.abi_version = 0;
  parser.enter_block = EnterBlock;
  parser.leave_block = LeaveBlock;
  parser.enter_span = EnterSpan;
  parser.leave_span = LeaveSpan;
  parser.text = TextCallback;
  parser.flags = MD_FLAG_COLLAPSEWHITESPACE;  //åå¹¶ç©ºæ ¼

  md_parse(content.data(), (MD_SIZE)content.size(), &amp;parser, &amp;ctx);

  // std::cout &lt;&lt; "[Parsed blocks] " &lt;&lt; ctx.result.size() &lt;&lt; "\n\n";
  // for (const auto&amp; b : ctx.result) {
  //  switch (b.kind) {
  //    case BlockKind::Heading:
  //      std::cout &lt;&lt; "[H" &lt;&lt; b.level &lt;&lt; "] ";
  //      break;
  //    case BlockKind::Paragraph:
  //      std::cout &lt;&lt; "[P] ";
  //      break;
  //    case BlockKind::ListItem:
  //      std::cout &lt;&lt; "[LI] ";
  //      break;
  //    case BlockKind::BlockQuote:
  //      std::cout &lt;&lt; "[Q] ";
  //      break;
  //  }
  //  std::cout &lt;&lt; b.text &lt;&lt; "\n";
  //}

  vector&lt;SemanticBlock&gt; semanticBlocks;
  {
    SemanticBlock semanticBlock;
    semanticBlock.context = title;
    semanticBlock.contents = {summary};
    semanticBlocks.emplace_back(std::move(semanticBlock));
  }

  std::list&lt;std::pair&lt;int, std::string&gt;&gt; currentTitleChain;  // å­ (çº§å«, ææ¬)
  std::vector&lt;std::string&gt; currentBlockContents;

  for (auto&amp; b : ctx.result) {
    if (b.kind == BlockKind::Heading) {
      //éå°æ°æ é¢ï¼å­å¥æ°æ®
      if (!currentBlockContents.empty()) {
        string context;
        for (auto it = currentTitleChain.begin(); it != currentTitleChain.end();
             ++it) {
          context += it-&gt;second;  // åªåæ é¢ææ¬
          if (std::next(it) != currentTitleChain.end()) context += "ï½";
        }
        SemanticBlock semanticBlock;
        semanticBlock.context = std::move(context);
        semanticBlock.contents = std::move(currentBlockContents);
        semanticBlocks.emplace_back(std::move(semanticBlock));
        currentBlockContents = {};
      }

      // å¼¹åºææçº§å« &gt;= å½åæ é¢çº§å«çç¥åï¼ç²¾ååæº¯ï¼
      while (!currentTitleChain.empty() &amp;&amp;
             currentTitleChain.back().first &gt;= b.level) {
        currentTitleChain.pop_back();
      }
      currentTitleChain.emplace_back(b.level,
                                     std::move(b.text));  // å­çº§å«+ææ¬
    } else {
      currentBlockContents.emplace_back(std::move(b.text));
    }
  }
  if (!currentBlockContents.empty()) {
    string context;
    for (auto it = currentTitleChain.begin(); it != currentTitleChain.end();
         ++it) {
      context += it-&gt;second;  // åªåæ é¢ææ¬
      if (std::next(it) != currentTitleChain.end()) context += "ï½";
    }

    SemanticBlock semanticBlock;
    semanticBlock.context = std::move(context);
    semanticBlock.contents = std::move(currentBlockContents);
    semanticBlocks.emplace_back(std::move(semanticBlock));
    currentBlockContents = {};
  }

  return semanticBlocks;
}

}  // namespace embedding
</code></pre>
<p>è¿æ®µ <code>MdSemanticSplitter</code> çå®ç°åºäº <strong>MD4C</strong> ââ ä¸ä¸ªè½»éãç¬¦å CommonMark æ åç C è¯­è¨ Markdown è§£æå¨ãå®ä¸ä¾èµæ­£åè¡¨è¾¾å¼æå­ç¬¦ä¸²æ´åå¹éï¼èæ¯éè¿äºä»¶é©±å¨çæ¹å¼ï¼å¨è§£æè¿ç¨ä¸­éåï¼blockï¼è¯å« Markdown ç»æã</p>
<p>å·ä½æ¥è¯´ï¼æä»¬æ³¨åäºä¸ä¸ªæ ¸å¿åè°å½æ°ï¼</p>
<ul>
<li><code>EnterBlock</code>ï¼å½è¿å¥ä¸ä¸ªæ°åï¼å¦æ é¢ãæ®µè½ãåè¡¨é¡¹ç­ï¼æ¶è§¦åï¼è®°å½å¶ç±»ååå±çº§ï¼</li>
<li><code>TextCallback</code>ï¼æ¶éååçåå§ææ¬åå®¹ï¼åæ¬æ®éææ¬åè¡åä»£ç ï¼ï¼</li>
<li><code>LeaveBlock</code>ï¼å½ç¦»å¼ä¸ä¸ªåæ¶ï¼å°å·²æ¶éçææ¬å°è£ä¸ºç»æå <code>Block</code> å¹¶æå­ã</li>
</ul>
<p>éè¿ç»´æ¤ä¸ä¸ª <strong>æ é¢æ ï¼<code>currentTitleChain</code>ï¼</strong>ï¼æä»¬è½å¨æè¿½è¸ªå½ååå®¹æå¤çç« èè·¯å¾ãæ¯å½éå°æ°çæ é¢ï¼<code>#</code>, <code>##</code> ç­ï¼ï¼å°±å°æ­¤åç´¯ç§¯çæææ®µè½ãåè¡¨é¡¹ç­åå®¹æåä¸ºä¸ä¸ª <code>SemanticBlock</code>ï¼å¶ä¸ä¸æï¼<code>context</code>ï¼ç±ä»æ ¹å°å½åæ é¢çå®æ´è·¯å¾ææï¼ä¾å¦ <code>"é¨ç½²ï½Docker éç½®ï½ç¯å¢åé"</code>ï¼ãè¿æ ·ï¼æ¯ä¸ªè¯­ä¹åä¸ä»åå«åå§ææ¬ï¼è¿æºå¸¦äºæç¡®çç»æåä¸ä¸æä¿¡æ¯ï¼æå¤§æåäºåç»­åµå¥çè¯­ä¹åç¡®æ§ã</p>
<blockquote>
<p>è¡¥åä¸ä¸ªç»èï¼å¯¹äºæ¯ä¸ç¯åæï¼ç¬¬ä¸ä¸ªè¯­ä¹åæ®µçä¸ä¸ææ¯æç« æ é¢ï¼åå®¹æ¯æç« æè¦ãè¿æ ·åå¯ä»¥ä¿è¯ææ¡£çè¯­ä¹éç¹ï¼ç¡®ä¿å³ä½¿åç»­åå®¹è¢«æåï¼æ£ç´¢ç³»ç»ä»è½åç¡®çè§£è¯¥ææ¡£çæ ¸å¿ä¸»é¢ã</p>
</blockquote>
<p>æç»è¾åºç <code>std::vector&lt;SemanticBlock&gt;</code> å³ä¸ºææ¡£çâè¯­ä¹éª¨æ¶âââå®ä¿çäº Markdown çé»è¾å±æ¬¡ï¼åæ¶ä¸ºä¸ä¸æ­¥ç <strong>ææ¬ååï¼chunkingï¼</strong> æä¾äºé«è´¨éãç»ææç¥çè¾å¥ååã</p>
<h1 id="7-ææ¬ååå¨">7. ææ¬ååå¨</h1>
<p>å¨è¯­ä¹åæ®µå¨å° Markdown ææ¡£è§£æä¸ºç»æåç <strong>è¯­ä¹æ®µ</strong>ï¼<code>SemanticBlock</code>ï¼ä¹åï¼æä»¬è·ç¦»çæ­£å¯åµå¥çè¾å¥ååä»å·®ä¸æ­¥ï¼<strong>å°è¿äºè¯­ä¹æ®µééå°åµå¥æ¨¡åçé¿åº¦éå¶å</strong>ã</p>
<p>åµå¥æ¨¡åï¼å¦ <code>bge-small-zh-v1.5</code>ï¼å¯¹è¾å¥é¿åº¦æç¡¬æ§ä¸éï¼éå¸¸ä¸º 512 tokensï¼ãç¶èï¼ç°å®ä¸­çåå®¢åå®¹åå·®ä¸å«ââæçç« èå¯¥å¯¥æ°è¯­ï¼æçæ®µè½æ´æ´æ´æ´ãè¥ç´æ¥å¯¹æ¯ä¸ªè¯­ä¹æ®µç¬ç«åµå¥ï¼ä¼é¢ä¸´ä¸¤ä¸ªæç«¯é®é¢ï¼</p>
<ol>
<li><strong>è¿é¿æ®µè½è¢«æªæ­</strong>ï¼è¶åº 512 tokens çåå®¹ä¼è¢«æ æä¸¢å¼ï¼å¯¼è´å³é®ä¿¡æ¯ä¸¢å¤±ï¼</li>
<li><strong>è¿ç­æ®µè½æµªè´¹å®¹é</strong>ï¼ä¸ä¸ªä»å«ä¸¤å¥è¯çæ®µè½å æ®æ´ä¸ª 512-token è¾å¥æ§½ä½ï¼å¤§éä½ç½®è¢« <code>[PAD]</code> å¡«åï¼ä¸ä»éä½åéå¯åº¦ï¼è¿å¯è½ç¨éè¯­ä¹ä¿¡å·ã</li>
</ol>
<p>å æ­¤ï¼æä»¬éè¦ä¸ä¸ªæºè½ç <strong>ææ¬ååå¨</strong>ï¼<code>TextChunker</code>ï¼ï¼å®ä¸ä»è¦å¤çé¿åº¦çº¦æï¼æ´è¦<strong>å¨ä¿çè¯­ä¹è¿è´¯æ§çåæä¸ï¼å¨æå°æåæåå¹¶åå®¹</strong>ãå·ä½æ¥è¯´ï¼å®çæ ¸å¿èè´£åæ¬ï¼</p>
<ul>
<li><strong>æ token æ°ç²¾ç¡®ååé¿æ®µ</strong>ï¼å½åä¸ªè¯­ä¹æ®µè¶è¿æå¤§é¿åº¦æ¶ï¼ä»¥å¥å­ä¸ºåä½è¿è¡æ»å¨çªå£ååï¼é¿åå¨è¯æå­ä¸­é´æ´åæªæ­ï¼</li>
<li><strong>åå¹¶ç¸é»ç­æ®µ</strong>ï¼å°å¤ä¸ªè¯­ä¹ç¸å³ä½åèªè¿ç­çæ®µè½ç»åæä¸ä¸ªç´§ååï¼æååµå¥æçï¼</li>
<li><strong>æ³¨å¥ä¸ä¸æä¿¡æ¯</strong>ï¼å¨ååæ¶ä¿çå¶æå±çæ é¢è·¯å¾ï¼å¦ <code>"æ°æ®åºï½è¿æ¥æ± éç½®ï½HikariCP åæ°è¯¦è§£"</code>ï¼ï¼ä½ä¸ºåç¼æ¼æ¥å°ææ¬å¼å¤´ï¼ä½¿åµå¥åéâç¥éâèªå·±æ¥èªåªä¸é¨ååå®¹ã</li>
</ul>
<p>è¿ç§ç­ç¥ç¡®ä¿äºæ¯ä¸ªæç»ç¨äºåµå¥ç <strong>ææ¬å</strong>ï¼chunkï¼æ¢æ»¡è¶³æ¨¡åè¾å¥çº¦æï¼åå°½å¯è½å®æ´ãèªæ´½å°è¡¨è¾¾ä¸ä¸ªå±é¨è¯­ä¹ååã</p>
<blockquote>
<p>ð¡ è¿æ­£æ¯ <strong>RAG</strong>ï¼Retrieval-Augmented Generationï¼ç³»ç»ä¸­âæ£ç´¢âç¯èçå³é®åç½®æ­¥éª¤ã<br>
å¨å¸åç RAG æ¶æä¸­ï¼å¤é¨ç¥è¯åºé¦åè¢«ååä¸ºé«è´¨é chunksï¼åç»åµå¥æ¨¡åè½¬åä¸ºåéå¹¶å­å¥ç´¢å¼ãå½ç¨æ·æé®æ¶ï¼ç³»ç»éè¿è¯­ä¹ç¸ä¼¼åº¦å¬åæç¸å³çè¥å¹² chunksï¼å°å¶ä½ä¸ºä¸ä¸ææä¾ç»å¤§è¯­è¨æ¨¡åçæç­æ¡ã<br>
å æ­¤ï¼<strong>ååè´¨éç´æ¥å³å®äºæ£ç´¢ç²¾åº¦ï¼è¿èå½±åæç»åç­çåç¡®æ§ä¸ç¸å³æ§</strong>ã</p>
</blockquote>
<p>å¨æä»¬çè½»éçº§åå®¢æç´¢ç³»ç»ä¸­ï¼è½ç¶æ²¡æåç»­çå¤§æ¨¡åçæç¯èï¼ä½âæ£ç´¢å³æå¡âçææ³ä¾ç¶éç¨ââç¨æ·è¾å¥çæ¥è¯¢éè¦ç²¾åå¹éå°æç¸å³çæç« çæ®µãèè¿ä¸åï¼é½å§äºä¸ä¸ªç²¾å¿è®¾è®¡çææ¬ååå¨ã</p>
<p>æ¥ä¸æ¥ï¼æä»¬å°åºäº Hugging Face Tokenizer æä¾ç token è®¡æ°è½åï¼å®ç°ä¸ä¸ªå¼é¡¾æçä¸è¯­ä¹ç <code>TextChunker</code>ï¼ä¸ºæå»ºå®æ´çåéç´¢å¼éºå¹³éè·¯ï¼</p>
<pre><code class="language-cpp">// TextChunker.h
#pragma once

#include &lt;vector&gt;

#include "HfTokenizer.h"
#include "SemanticBlock.h"

namespace embedding {

class TextChunker {
 public:
  explicit TextChunker(size_t maxTokens, const hf::Tokenizer&amp; tokenizer);

  // æ¯æå¤ä¸ªè¯­ä¹å
  std::vector&lt;std::string&gt; SemanticBlocks(
      std::vector&lt;SemanticBlock&gt; semanticBlockList) const;

  // æ¯æå¤ä¸ªååç´ 
  std::vector&lt;std::string&gt; Blocks(std::vector&lt;std::string&gt; blockList) const;

  // æ¯ææ®µè½æé¿ææ¬
  std::vector&lt;std::string&gt; Paragraph(std::string text) const;

 private:
  // æä¸­ææ ç¹ååä¸ºå¥å­ï¼ä¿çæ ç¹ï¼
  std::vector&lt;std::string&gt; SplitIntoSentences(
      const std::string&amp; paragraph) const;

  // å°å¥å­åè¡¨åå¹¶ä¸ºæ»¡è¶³ token éå¶ç chunks
  std::vector&lt;std::string&gt; MergeSentencesToChunks(
      std::vector&lt;std::string&gt;&amp;&amp; sentences) const;

  size_t maxTokens;
  const hf::Tokenizer&amp; tokenizer;
};

}  // namespace embedding
</code></pre>
<pre><code class="language-cpp">// TextChunker.cpp
#include "TextChunker.h"

#include &lt;iostream&gt;
#include &lt;unordered_set&gt;

using namespace std;

namespace embedding {

TextChunker::TextChunker(size_t maxTokens, const hf::Tokenizer&amp; tokenizer)
    : maxTokens(maxTokens), tokenizer(tokenizer) {}

std::vector&lt;std::string&gt; TextChunker::SemanticBlocks(
    std::vector&lt;SemanticBlock&gt; semanticBlockList) const {
  vector&lt;std::string&gt; totalChunkList;

  for (auto&amp; semanticBlock : semanticBlockList) {
    string contextText = semanticBlock.context + "\n";
    vector&lt;std::string&gt; chunkList = Blocks(std::move(semanticBlock.contents));

    // Tokenè®¡æ°ä¸ç¨å¤ªä¸¥æ ¼ï¼maxTokensè¯å®å°äºnlpæ¨¡åå¤çæ°ï¼ä¸ä¸ä¸æéå¸¸å°
    for (auto&amp; chunk : chunkList) {
      chunk = contextText + std::move(chunk);
    }

    totalChunkList.insert(totalChunkList.end(),
                          std::make_move_iterator(chunkList.begin()),
                          std::make_move_iterator(chunkList.end()));
  }

  return totalChunkList;
}

std::vector&lt;std::string&gt; TextChunker::Blocks(
    std::vector&lt;std::string&gt; blockList) const {
  // æç§ææ¡£ä¸­çååç´ è¿è¡åå¹¶
  vector&lt;std::string&gt; chunkList;
  vector&lt;size_t&gt; chunkTokenCount;
  string currentChunk;  //å½åå
  size_t totalTokenCount = 0;
  for (size_t i = 0; i &lt; blockList.size(); ++i) {
    string currentText(std::move(blockList[i]));
    currentText += '\n';
    size_t currentTokenCount = tokenizer.Count(currentText.c_str());
    if (totalTokenCount + currentTokenCount &gt; maxTokens) {
      if (!currentChunk.empty()) {
        chunkList.emplace_back(std::move(currentChunk));
        chunkTokenCount.emplace_back(totalTokenCount);
      }
      currentChunk = std::move(currentText);
      totalTokenCount = currentTokenCount;
    } else {
      currentChunk += std::move(currentText);
      totalTokenCount += currentTokenCount;
    }
  }
  if (!currentChunk.empty()) {
    chunkList.emplace_back(std::move(currentChunk));
    chunkTokenCount.emplace_back(totalTokenCount);
  }

  // æçååç´ æ¬èº«å°±è¶è¿maxTokensï¼ç»§ç»­æå
  vector&lt;std::string&gt; resultChunkList;
  for (size_t ci = 0; ci &lt; chunkList.size(); ++ci) {
    if (chunkTokenCount[ci] &gt; maxTokens) {
      vector&lt;std::string&gt; subChunks = Paragraph(std::move(chunkList[ci]));
      for (size_t si = 0; si &lt; subChunks.size(); ++si) {
        string chunk = std::move(subChunks[si]);
        if (si + 1 != subChunks.size()) {
          chunk += '\n';
        }
        resultChunkList.emplace_back(chunk);
      }
    } else {
      resultChunkList.emplace_back(std::move(chunkList[ci]));
    }
  }
  return resultChunkList;
}

// Todo:å¯¹äºRAGè¦å¤ç
//ãå¥å­åå¥ &gt; maxTokensãç fallback
//å¢å  token-based overlap
std::vector&lt;std::string&gt; TextChunker::Paragraph(std::string text) const {
  return MergeSentencesToChunks(SplitIntoSentences(text));
}

// æä¸­ææ ç¹ååä¸ºå¥å­ï¼ä¿çæ ç¹ï¼
std::vector&lt;std::string&gt; TextChunker::SplitIntoSentences(
    const std::string&amp; paragraph) const {
  if (paragraph.empty()) {
    return {};
  }

  // å®ä¹ä¸­æå¥æ«æ ç¹éåï¼UTF-8 å­ç¬¦ä¸²ï¼
  static const std::unordered_set&lt;std::string&gt; delimiters = {"ã", "ï¼", "ï¼",
                                                             "ï¼", "â¦â¦"};

  std::vector&lt;std::string&gt; chunks;
  size_t i = 0;
  size_t start = 0;
  const char* data = paragraph.data();
  size_t len = paragraph.size();

  while (i &lt; len) {
    // å¤æ­å½åä½ç½®æ¯å¦æ¯æä¸ªåéç¬¦çèµ·å§
    bool found = false;
    for (const auto&amp; delim : delimiters) {
      if (paragraph.compare(i, delim.size(), delim) == 0) {
        // æ¾å°åéç¬¦ï¼æå [start, i + delim.size())
        std::string chunk = paragraph.substr(start, i - start + delim.size());
        if (!chunk.empty()) {
          chunks.push_back(chunk);
        }
        // è·³è¿åéç¬¦
        i += delim.size();
        start = i;
        found = true;
        break;
      }
    }

    if (!found) {
      // æ®éå­ç¬¦ï¼ååç§»å¨ä¸ä¸ª UTF-8 å­ç¬¦
      unsigned char c = static_cast&lt;unsigned char&gt;(data[i]);
      if ((c &amp; 0x80) == 0) {
        i += 1;
      } else if ((c &amp; 0xE0) == 0xC0) {
        i += 2;
      } else if ((c &amp; 0xF0) == 0xE0) {
        i += 3;
      } else if ((c &amp; 0xF8) == 0xF0) {
        i += 4;
      } else {
        i += 1;  // invalid UTF-8 fallback
      }
    }
  }

  // å¤çæ«å°¾æ²¡ææ ç¹çå©ä½é¨å
  if (start &lt; len) {
    std::string last = paragraph.substr(start);
    if (!last.empty()) {
      chunks.push_back(last);
    }
  }

  return chunks;
}

std::vector&lt;std::string&gt; TextChunker::MergeSentencesToChunks(
    std::vector&lt;std::string&gt;&amp;&amp; sentences) const {
  vector&lt;string&gt; chunkList;
  string currentChunk;  //å½åå
  size_t totalTokenCount = 0;
  for (size_t i = 0; i &lt; sentences.size(); ++i) {
    // cout &lt;&lt; mdBlockList[i].level &lt;&lt; '\t' &lt;&lt; mdBlockList[i].text &lt;&lt; '\n';
    string currentText(std::move(sentences[i]));
    size_t currentTokenCount = tokenizer.Count(currentText.c_str());
    if (totalTokenCount + currentTokenCount &gt; maxTokens) {
      chunkList.emplace_back(std::move(currentChunk));
      currentChunk = std::move(currentText);
      totalTokenCount = currentTokenCount;
    } else {
      currentChunk += std::move(currentText);
      totalTokenCount += currentTokenCount;
    }
  }
  if (!currentChunk.empty()) {
    chunkList.emplace_back(std::move(currentChunk));
  }

  return chunkList;
}

}  // namespace embedding
</code></pre>
<p>ä¸è¿° <code>TextChunker</code> çè®¾è®¡éµå¾ªä¸ä¸ªæ´ç´ ä½ææçååï¼<strong>ä¼åå°éææ¡£åæçç»æååï¼åå¨å¿è¦æ¶è¿è¡è¯­ä¹æç¥çåå</strong>ã</p>
<p>å®çå¥å£æ¹æ³ <code>SemanticBlocks()</code> æ¥æ¶ç± <code>MdSemanticSplitter</code> äº§åºçè¯­ä¹æ®µåè¡¨ãæ¯ä¸ªè¯­ä¹æ®µé½æºå¸¦äºå®æ´çä¸ä¸æè·¯å¾ï¼å¦ <code>"é¨ç½²ï½å®¹å¨åï½Dockerfile ç¼å"</code>ï¼ï¼æä»¬å°å¶ä½ä¸ºåç¼éå å°è¯¥æ®µææåå®¹åçå¼å¤´ââè¿æ ·ï¼å³ä½¿ææ®µåå®¹è¢«åç¬æ£ç´¢å°ï¼å¶åéä¹è½âè®°ä½âèªå·±æå±çä¸»é¢å±çº§ï¼æå¤§å¢å¼ºæç´¢çç¸å³æ§ã</p>
<p>åé¨å¤çåä¸ºä¸¤ä¸ªå±æ¬¡ï¼</p>
<ol>
<li><strong>åçº§åå¹¶ï¼<code>Blocks</code>ï¼</strong><br>
é¦åå°è¯å°åä¸è¯­ä¹æ®µåçå¤ä¸ªå°åï¼å¦è¥å¹²æ®µè½ãåè¡¨é¡¹ï¼æé¡ºåºæ¼æ¥ï¼ç´å°å³å°è¶åº <code>maxTokens</code> éå¶ä¸ºæ­¢ãè¿ç§ç­ç¥è½ææé¿åç­åå®¹ç¢çåï¼åæ¶ä¿æåå§ Markdown åçå®æ´æ§ãè¥æä¸ªåæ¬èº«å·²è¶é¿ï¼ä¾å¦ä¸æ®µæªæ¢è¡çä»£ç è¯´ææé¿å¼ç¨ï¼ï¼åäº¤ç±ä¸ä¸å±å¤çã</li>
<li><strong>å¥å­çº§ååï¼<code>Paragraph</code> â <code>SplitIntoSentences</code> + <code>MergeSentencesToChunks</code>ï¼</strong><br>
å¯¹äºè¶é¿æ®µè½ï¼æä»¬ä¸åæ´åæªæ­ï¼èæ¯åæä¸­æå¥æ«æ ç¹ï¼<code>ãï¼ï¼ï¼â¦â¦</code>ï¼å°å¶æåä¸ºå¥å­åºåãéåï¼ä»¥è´ªå¿æ¹å¼å°è¿äºå¥å­éæ°ç»åæä¸è¶è¿ <code>maxTokens</code> çææ¬åãè½ç¶å½åå®ç°å°æªå¼å¥æ»å¨çªå£éå ï¼overlapï¼ï¼ä½å¨ç»å¤§å¤æ°åå®¢åºæ¯ä¸­ï¼è¿ç§âå¥è¾¹çå¯¹é½âçååå·²è½å¾å¥½å°ä¿çå±é¨è¯­ä¹è¿è´¯æ§ã</li>
</ol>
<p>æ´ä¸ªè¿ç¨å®å¨åºäº <strong>çå® token è®¡æ°</strong>ï¼éè¿ Hugging Face Tokenizer ç <code>Count</code> æ¥å£ï¼ï¼èéç²ç¥çå­ç¬¦æå­æ°ä¼°ç®ï¼ç¡®ä¿ååç»æä¸¥æ ¼æ»¡è¶³æ¨¡åè¾å¥çº¦æã</p>
<p>è³æ­¤ï¼ä»åå§ Markdown å°å¯åµå¥ææ¬åçé¢å¤çæµæ°´çº¿å·²å¨çº¿è´¯éã</p>
<h1 id="8-åéåº">8. åéåº</h1>
<p>ç°å¨ï¼æä»¬å·²ç»è½å°åå®¢ä¸­çæ¯ä¸æ®µææ¬è½¬åä¸ºä¸ä¸ª 512 ç»´çè¯­ä¹åéãä½è¥æ²¡æä¸ç§é«æçæ¹å¼ç»ç»åæ£ç´¢è¿äºåéï¼è¯­ä¹æç´¢å°±æ ä»è°èµ·ã</p>
<p>è¿æ­£æ¯åéåºï¼Vector Database / Vector Indexï¼çç¨æ­¦ä¹å°ãå®ä¸å³å¿ææ¬åå®¹ï¼åªä¸æ³¨äºä¸ä»¶äºï¼ç»å®ä¸ä¸ªæ¥è¯¢åéï¼å¨ç¾ä¸çº§åéæ± ä¸­å¿«éæ¾åºæç¸ä¼¼çè¥å¹²ä¸ªã</p>
<p>å¨èµæºæåº¦åéçä¸ªäººæå¡å¨ä¸ï¼æä»¬æ æ³é¨ç½²ééçº§çåéæ°æ®åºï¼å¦ Milvus æ Weaviateï¼ãç»è¿æè¡¡ï¼æç»éæ©äº FAISS ââ ä¸ä¸ªç± Meta å¼æºçè½»éãé«æ§è½ãçº¯ C++ å®ç°çåéç¸ä¼¼æ§æç´¢åºãå®æ¯æå¤ç§ç´¢å¼ç±»åï¼å¦ IndexFlatIPãIndexIVFFlatãHNSW ç­ï¼ï¼æ¢è½æ»¡è¶³ç²¾ç¡®æç´¢éæ±ï¼ä¹è½éè¿è¿ä¼¼ç®æ³å¤§å¹åç¼©åå­ä¸è®¡ç®å¼éã</p>
<p>é£ä¹æ¥ä¸æ¥ï¼æä»¬å°±æ¹éæ Markdown æ ¼å¼çåå®¢ææ¡£åéåï¼å­å¥å° FAISS åå»ºçåéåºä¸­ãä¸è¬æ¥è¯´ï¼è¿ä¸ªåè½æ¯æ´ä¸ªè¯­ä¹æç´¢ç³»ç»çâç¦»çº¿æå»ºâæ ¸å¿: å¨é¨ç½²åä¸æ¬¡æ§å°ææåå®¢æç« å¤çä¸ºåéï¼å¹¶æä¹åä¸º FAISS ç´¢å¼æä»¶ï¼ä¾çº¿ä¸æç´¢æå¡å è½½ä½¿ç¨ãå·ä½ä»£ç å¦ä¸ï¼</p>
<pre><code class="language-cpp">// TaskEmbed.cpp
#include "TaskEmbed.h"

#include &lt;faiss/IndexFlat.h&gt;
#include &lt;faiss/IndexIDMap.h&gt;
#include &lt;faiss/index_io.h&gt;
#include &lt;gflags/gflags.h&gt;
#include &lt;onnxruntime_cxx_api.h&gt;

#include &lt;filesystem&gt;
#include &lt;fstream&gt;
#include &lt;iostream&gt;

#include "Application/Context.h"
#include "Embedding/BgeOnnxEmbedder.h"
#include "Embedding/MdSemanticSplitter.h"
#include "Embedding/TextChunker.h"
#include "LaunchConfig.h"
#include "LaunchInit.h"
#include "Persistence/Sqlite3Crud.h"
#include "Persistence/TableBlogChunksField.h"
#include "Persistence/TableBlogsField.h"

using namespace std;
using namespace embedding;
using namespace persistence;

DECLARE_string(input);

//ææåæåéåå¹¶å­å¥åéåº
namespace Bootstrap::Task::Embed {

void Run() {
  if (FLAGS_input.empty() /*|| FLAGS_output.empty()*/) {
    std::cerr &lt;&lt; "éè¯¯: sitemap ä»»å¡éè¦è¾å¥ --input å --output åæ°\n";
    return;
  }

  filesystem::path launchConfigPath{FLAGS_input};
  if (!filesystem::exists(launchConfigPath)) {
    std::cerr &lt;&lt; "HTTPæå¡éç½®æä»¶ä¸å­å¨ï¼" &lt;&lt; endl;
    return;
  }

  if (!LaunchInit(launchConfigPath)) {
    return;
  }

  application::Context::GetInstance();

  string onnxModelPath = launchConfig.onnxModelPath;
  string faissIndexPath = launchConfig.faissIndexPath;

  std::filesystem::path modelPath(onnxModelPath);
  if (!std::filesystem::exists(onnxModelPath)) {
    std::cerr &lt;&lt; "Error: ONNX model file does not exist at: "
              &lt;&lt; modelPath.string() &lt;&lt; std::endl;
    return;
  }

  // è·åæ¨¡åæå¨ç®å½ï¼å¹¶æ¼æ¥ tokenizer.json
  std::filesystem::path tokenizerJsonFile =
      modelPath.parent_path() / "tokenizer.json";

  // æ£æ¥ tokenizer.json æ¯å¦å­å¨ï¼æ¨èï¼
  if (!std::filesystem::exists(tokenizerJsonFile)) {
    std::cerr &lt;&lt; "Warning: tokenizer.json not found at: "
              &lt;&lt; tokenizerJsonFile.generic_string() &lt;&lt; std::endl;
    return;
  }
  u8string tokenizerJsonFilePath = tokenizerJsonFile.generic_u8string();

  const size_t chunkMaxTokens = 396;

  vector&lt;Sqlite3Crud::TableValue&gt; result;
  std::vector&lt;TableBlogsField&gt; fieldNames{
      TableBlogsField::id,
      TableBlogsField::title,
      TableBlogsField::summary,
      TableBlogsField::content,
  };

  if (!Sqlite3Crud::Query&lt;TableBlogsField&gt;(TableName::blogs, fieldNames,
                                           result)) {
    return;
  }

  // å¨ééå»ºåï¼æ¸ç©º chunk è¡¨
  if (!Sqlite3Crud::Delete&lt;TableBlogChunksField&gt;(TableName::blog_chunks)) {
    std::cerr &lt;&lt; "æ¸ç©º blog_chunks è¡¨å¤±è´¥ï¼\n";
    return;
  }
  std::cout &lt;&lt; "å·²æ¸ç©º blog_chunks è¡¨\n";

  MdSemanticSplitter mdSplitter;  //ææ¡£æåå¨
  hf::Tokenizer tokenizer(
      (const char *)tokenizerJsonFilePath.c_str());    //åå§ååè¯å¨
  TextChunker textChunker(chunkMaxTokens, tokenizer);  // tokenæç¥ææ¬æå
  BgeOnnxEmbedder embedder(onnxModelPath, tokenizer);

  int64_t embeddingDim = embedder.EmbeddingDim();
  auto flatIndex =
      std::make_unique&lt;faiss::IndexFlatIP&gt;(embeddingDim);  // åå»º FlatIP ç´¢å¼
  faiss::IndexIDMap2 index(
      flatIndex.release());  // èªå¨æ¥ç®¡ flatIndex ççå½å¨æ

  size_t colNum = fieldNames.size();
  size_t rowNum = result.size() / colNum;

  for (size_t ri = 0; ri &lt; rowNum; ++ri) {
    size_t m = ri * colNum;
    string blogId = std::move(std::get&lt;std::string&gt;(result[m]));
    string title = std::move(std::get&lt;std::string&gt;(result[m + 1]));
    string summary = std::move(std::get&lt;std::string&gt;(result[m + 2]));
    string content = std::move(std::get&lt;std::string&gt;(result[m + 3]));

    // if (title != "C++ä¸­JSONåºåååååºååçå®ç°") {
    //  continue;
    //}

    cout &lt;&lt; ri &lt;&lt; '\t' &lt;&lt; title &lt;&lt; endl;

    std::vector&lt;SemanticBlock&gt; semanticBlocks =
        mdSplitter.Split(title, content, summary);

    // for (const auto&amp; block : semanticBlocks) {
    //  cout &lt;&lt; block.context &lt;&lt; endl;
    //  for (const auto&amp; content : block.contents) {
    //    cout &lt;&lt; content &lt;&lt; endl;
    //  }
    //  cout &lt;&lt; "----------------------\n";
    //}

    std::vector&lt;std::string&gt; chunks =
        textChunker.SemanticBlocks(std::move(semanticBlocks));

    // cout &lt;&lt; chunks.size() &lt;&lt; endl;
    // for (const auto&amp; chunk : chunks) {
    //  cout &lt;&lt; chunk;
    //  cout &lt;&lt; "-----------------------------\n";
    //}

    // åµå¥æ¯ä¸ª chunkï¼å¹¶åéå¯ä¸ ID
    for (const auto &amp;chunk : chunks) {
      int64_t chunkId = Sqlite3Crud::InsertAndReturnId&lt;TableBlogChunksField&gt;(
          TableName::blog_chunks,
          {TableBlogChunksField::blog_id, TableBlogChunksField::title,
           TableBlogChunksField::chunk_text},
          {blogId, title, chunk});

      if (chunkId &lt;= 0) {
        std::cerr &lt;&lt; "æå¥ blog_chunks å¤±è´¥\n";
        continue;
      }

      std::vector&lt;float&gt; embedding = embedder.Embed(chunk);
      index.add_with_ids(1, embedding.data(), &amp;chunkId);
    }
  }

  // ä¿å­ç´¢å¼
  faiss::write_index(&amp;index, faissIndexPath.c_str());
}
}  // namespace Bootstrap::Task::Embed
</code></pre>
<p>å¯ä»¥æä»¥ä¸æµç¨æ¦æ¬ä¸ºä¸æ­¥ï¼</p>
<ol>
<li>
<p><strong>æ°æ®è¯»å</strong><br>
ä» SQLite æ°æ®åºä¸­å¨éæååå®¢ç <code>id</code>ã<code>title</code>ã<code>summary</code> å <code>content</code>ï¼ä½ä¸ºåå§è¾å¥ã</p>
</li>
<li>
<p><strong>ææ¬ â åé</strong><br>
å¯¹æ¯ç¯æç« ä¾æ¬¡æ§è¡ï¼</p>
<ul>
<li>ç¨ <code>MdSemanticSplitter</code> ææ é¢å±çº§æåä¸ºè¯­ä¹æ®µï¼</li>
<li>ç¨ <code>TextChunker</code> å°è¯­ä¹æ®µååä¸ºä¸è¶è¿ 396 tokens çä¸ä¸ææç¥ææ¬åï¼é¢çç©ºé´ç» <code>[CLS]</code>/<code>[SEP]</code> ç­ç¹æ® tokenï¼ï¼</li>
<li>è°ç¨ <code>BgeOnnxEmbedder</code> ä¸ºæ¯ä¸ª chunk çæ 512 ç»´ L2 å½ä¸åç embeddingã</li>
</ul>
</li>
<li>
<p><strong>åé â ç´¢å¼</strong><br>
ä½¿ç¨ FAISS ç <code>IndexFlatIP</code>ï¼ç²¾ç¡®åç§¯ç´¢å¼ï¼ç­ä»·äºä½å¼¦ç¸ä¼¼åº¦ï¼æå»ºåéåºï¼å¹¶éè¿ <code>IndexIDMap2</code> å°æ¯ä¸ªåéå³èå°å¶å¨æ°æ®åºä¸­çå¯ä¸ <code>chunk_id</code>ãæç»ï¼ç´¢å¼è¿å ID æ å°ä¸èµ·åå¥ç£çï¼å¦ <code>faiss.index</code>ï¼ã</p>
</li>
</ol>
<p>æ­¤å¤ï¼æ¯ä¸ª chunk çåä¿¡æ¯ï¼æå±æç«  IDãæ é¢ãåå§ææ¬ï¼è¢«å­å¥ <code>blog_chunks</code> è¡¨ï¼å®ç°<strong>åé ID å°åæåå®¹çåæ¥</strong>ââè¿æ¯æç´¢ç»æå±ç¤ºçå³é®æ¡¥æ¢ã</p>
<p>è³æ­¤ï¼ä¸ä¸ªè½»éãèªåå«ãæ å¤é¨ä¾èµçè¯­ä¹åéåºå°±æå»ºå®æäºã</p>
<h1 id="9-ä¸å¡åºç¨">9. ä¸å¡åºç¨</h1>
<p>æåï¼å°±æ¯è¿ç¨è¿ä¸ªåéåºå»å®ç°å·ä½çä¸å¡åºç¨äºã</p>
<h2 id="91-åå§å">9.1 åå§å</h2>
<p>å½å¯å¨åç«¯æ¶ï¼éè¦åå§åç¸å³çåå®¹ï¼</p>
<pre><code class="language-cpp">// EmbedComponent.h
#pragma once
#include "Embedding/BgeOnnxEmbedder.h"
#include "Embedding/MdSemanticSplitter.h"
#include "Embedding/NotDeletedIdSelector.h"
#include "Embedding/TextChunker.h"

namespace faiss {
struct Index;
}

namespace application {
struct EmbedComponent {
  explicit EmbedComponent(const std::string&amp; tokenizerJsonFilePath,
                          size_t chunkMaxTokens,
                          const std::string&amp; onnxModelPath,
                          const std::string&amp; faissIndexPath);
  ~EmbedComponent();

  embedding::MdSemanticSplitter mdSplitter;    // ææ¡£æåå¨
  embedding::hf::Tokenizer tokenizer;          // Hfåè¯å¨
  embedding::TextChunker textChunker;          // tokenæç¥ææ¬æå
  embedding::BgeOnnxEmbedder embedder;         // ææ¬åµå¥
  std::unique_ptr&lt;faiss::Index&gt; index;         // åéåº
  embedding::NotDeletedIdSelector idSelector;  // è®°å½å é¤çID
};
}  // namespace application
</code></pre>
<pre><code class="language-cpp">// EmbedComponent.cpp
#include "EmbedComponent.h"

#include &lt;faiss/Index.h&gt;
#include &lt;faiss/index_io.h&gt;

namespace application {
EmbedComponent::EmbedComponent(const std::string&amp; tokenizerJsonFilePath,
                               size_t chunkMaxTokens,
                               const std::string&amp; onnxModelPath,
                               const std::string&amp; faissIndexPath)
    : tokenizer((const char*)tokenizerJsonFilePath.c_str()),
      textChunker(chunkMaxTokens, tokenizer),
      embedder(onnxModelPath, tokenizer),
      index(faiss::read_index(faissIndexPath.c_str())) {}

EmbedComponent::~EmbedComponent() = default;

}  // namespace application
</code></pre>
<h2 id="92-æç´¢">9.2 æç´¢</h2>
<p>å½ç¨æ·è¿è¡æç´¢æ¶ï¼</p>
<pre><code class="language-cpp">#include "Search.h"

#include &lt;faiss/Index.h&gt;
#include &lt;faiss/index_io.h&gt;

#include &lt;iostream&gt;
#include &lt;set&gt;

#include "Application/Context.h"
#include "Application/EmbedComponent.h"
#include "Domain/SearchHit.h"
#include "Embedding/BgeOnnxEmbedder.h"
#include "Persistence/Sqlite3Crud.h"
#include "Persistence/TableBlogChunksField.h"

using namespace std;
using namespace embedding;
using namespace persistence;
using namespace domain;
using namespace application;

namespace Service {

namespace search {

bool Posts(const std::string&amp; query,
           std::vector&lt;domain::SearchHit&gt;&amp; searchHits) {
  EmbedComponent* embedComponent = Context::GetInstance().GetEmbedComponent();

  const BgeOnnxEmbedder&amp; embedder = embedComponent-&gt;embedder;
  const faiss::Index* index = embedComponent-&gt;index.get();

  std::vector&lt;float&gt; queryVec = embedder.Embed(query);

  constexpr int k = 200;  // è¿å top200
  std::vector&lt;faiss::idx_t&gt; indices(k);
  std::vector&lt;float&gt; distances(k);

  faiss::SearchParameters params;
  params.sel = &amp;(embedComponent-&gt;idSelector);
  index-&gt;search(1, queryVec.data(), k, distances.data(), indices.data(),
                &amp;params);

  // è¾åºç»æ
  set&lt;string&gt; blogIdSet;
  for (int i = 0; i &lt; k; ++i) {
    if (indices[i] &lt; 0) {
      continue;
    }

    if (distances[i] &lt; 0.5) {
      break;
    }
    // std::cout &lt;&lt; "Chunk ID: " &lt;&lt; indices[i] &lt;&lt; "\tScore: " &lt;&lt; distances[i]
    //          &lt;&lt; "\n";

    int64_t chunkId = indices[i];
    std::vector&lt;Sqlite3Crud::TableValue&gt; result;
    Sqlite3Crud::Query&lt;TableBlogChunksField&gt;(
        TableName::blog_chunks,
        {TableBlogChunksField::blog_id, TableBlogChunksField::title,
         TableBlogChunksField::chunk_text},
        result, {TableBlogChunksField::chunk_id}, {chunkId});

    string blogId = std::move(std::get&lt;string&gt;(result.at(0)));
    if (blogIdSet.find(blogId) == blogIdSet.end()) {
      blogIdSet.insert(blogId);
      SearchHit searchHit;
      searchHit.id = std::move(blogId);
      searchHit.title = std::move(std::get&lt;string&gt;(result.at(1)));
      searchHit.snippetText = std::move(std::get&lt;string&gt;(result.at(2)));
      searchHits.emplace_back(std::move(searchHit));
    }
  }

  return true;
}

}  // namespace search
}  // namespace Service
</code></pre>
<p>æäºé¢æå»ºçåéåºåéå¥çåæ°æ®è¡¨ï¼çæ­£çè¯­ä¹æç´¢å°±åå¾å¼å¸¸ç®æ´ï¼<strong>å°ç¨æ·æ¥è¯¢ä¹åµå¥ä¸ºåéï¼ç¶åå¨ FAISS ç´¢å¼ä¸­æ§è¡è¿ä¼¼æè¿é»ï¼ANNï¼æ¥æ¾å³å¯</strong>ã</p>
<p>æ´ä¸ªå¨çº¿æç´¢æµç¨åä¸ºä¸æ­¥ï¼</p>
<ol>
<li><strong>æ¥è¯¢åµå¥</strong><br>
ç¨æ·è¾å¥çæç´¢è¯ï¼å¦âgitæ¤åæäº¤âï¼éè¿ä¸æå»ºé¶æ®µå®å¨ç¸åç <code>BgeOnnxEmbedder</code> æµç¨ââåæ¬ Hugging Face åè¯ãONNX æ¨çãL2 å½ä¸åââè½¬åä¸ºä¸ä¸ª 512 ç»´çåä½åéãè¿ç¡®ä¿äºæ¥è¯¢åéä¸ææ¡£åéå¤äºåä¸è¯­ä¹ç©ºé´ã</li>
<li><strong>åéæ£ç´¢</strong><br>
å°æ¥è¯¢åééå¥ FAISS ç´¢å¼ï¼æ§è¡ <code>index.search()</code>ãæä»¬ä½¿ç¨åç§¯ï¼IPï¼ä½ä¸ºç¸ä¼¼åº¦åº¦éï¼å åéå·² L2 å½ä¸åï¼IP ç­ä»·äºä½å¼¦ç¸ä¼¼åº¦ï¼ï¼å¹¶è¯·æ± Top-Kï¼ä¾å¦ K=200ï¼æç¸ä¼¼ç chunk ID åå¶å¾åã</li>
<li><strong>ç»æç»è£ä¸å»é</strong><br>
æ ¹æ®è¿åç chunk IDï¼ä» <code>blog_chunks</code> è¡¨ä¸­æ¥åºå¯¹åºçåå§ææ¬ãæå±æç« æ é¢ååå®¢ IDãä¸ºé¿ååä¸ç¯æç« å å¤ä¸ª chunk è¢«éå¤å¬åï¼æä»¬æ <code>blog_id</code> å»éï¼ä¼åä¿çå¾åæé«ççæ®µï¼å¹¶å°å¶ä½ä¸ºæç´¢ç»æçæè¦ï¼snippetï¼åç°ç»ç¨æ·ã</li>
</ol>
<h2 id="93-æ°å¢">9.3 æ°å¢</h2>
<p>æ¹éåéåææçåæææ¬å¤ªé«ï¼æå¥½æ¯è½å¤å®ç°å¢éæ´æ°ï¼å¦ä¸æç¤ºï¼</p>
<pre><code class="language-cpp">// ä¸ºåå®¢çæå¹¶æ·»å åéåµå¥ï¼ç¨äºè¯­ä¹æç´¢ï¼
static void AddBlogEmbedding(const string&amp; blogId, const string&amp; title,
                             const string&amp; content, const string&amp; summary) {
  //ææ¡£æå
  const EmbedComponent* embedComponent =
      Context::GetInstance().GetEmbedComponent();
  std::vector&lt;std::string&gt; chunks = embedComponent-&gt;textChunker.SemanticBlocks(
      std::move(embedComponent-&gt;mdSplitter.Split(title, content, summary)));

  // åµå¥æ¯ä¸ª chunkï¼å¹¶åéå¯ä¸ ID
  for (const auto&amp; chunk : chunks) {
    int64_t chunkId = Sqlite3Crud::InsertAndReturnId&lt;TableBlogChunksField&gt;(
        TableName::blog_chunks,
        {TableBlogChunksField::blog_id, TableBlogChunksField::title,
         TableBlogChunksField::chunk_text},
        {blogId, title, chunk});

    if (chunkId &lt;= 0) {
      std::cerr &lt;&lt; "æå¥ blog_chunks å¤±è´¥\n";
      continue;
    }

    std::vector&lt;float&gt; embedding = embedComponent-&gt;embedder.Embed(chunk);
    embedComponent-&gt;index-&gt;add_with_ids(1, embedding.data(), &amp;chunkId);
  }

  // åå»ºæ°çº¿ç¨æ¥åå¥ï¼æåååºæ¶é´
  // Todoï¼åæèèç§»æ¤å°å®æ¶ä»»å¡ä¸­ï¼å¹¶ä¸éè¦ä¿è¯æ¨åºåæ­£å¸¸ååº
  std::thread writeIndexThread([embedComponent]() {
    faiss::write_index(embedComponent-&gt;index.get(),
                       launchConfig.faissIndexPath.c_str());
  });

  // ç¡®ä¿ä¸»çº¿ç¨ä¸ç­å¾æ­¤çº¿ç¨å®æï¼é¿åé»å¡
  writeIndexThread.detach();
}
</code></pre>
<p>è¿ä¹æ¯ä¸ºä»ä¹ä½¿ç¨ <code>IndexIDMap2</code> çåå ï¼å¯ä»¥å°æ°å¢çåéå³èå°å¶å¨æ°æ®åºä¸­åæ°æ®çå¯ä¸ <code>chunk_id</code> ä¸ãç±äºå¨åå§åæ¶å·²ç»å°åéç´¢å¼è¯»åå°åå­ä¸­ï¼å¨æ°å¢åéååªéè¦åå°åéç´¢å¼å¯¹è±¡ä¿å­å³å¯ã</p>
<h2 id="94-å é¤">9.4 å é¤</h2>
<p>å é¤çå®ç°æç¹éº»ç¦ï¼å ä¸º FAISS ç <code>IndexFlatIP</code> æ²¡ææä¾å é¤çæ¥å£ãå½ç¶è¿ä¹ä¸æ¯è®¾è®¡ç¼ºé·ï¼èæ¯æ°æ®ç»æå°±æ¯è¿ä¹è®¾è®¡çï¼ä¸ºäºä¿è¯æ£ç´¢çæ§è½å¿ç¶ææèå¼ãå æ­¤ï¼è¦å®ç°å é¤åªè½è½¯å é¤ï¼ä¹å°±æ¯å¨åæ°æ®ä¸­æ è®°ä¸ä¸ç¸åºç chunk å·²ç»è¢«å é¤äºãåæ¶ï¼è¦æ³¨æå°åé¢å¨æç´¢çå®ç°ä¸­ï¼<code>index.search()</code> ä¼ å¥ä¸ä¸ªèªå®ä¹ç <code>IDSelector</code>åæ°å¯¹è±¡ï¼</p>
<pre><code class="language-cpp">// NotDeletedIdSelector.h
#pragma once

#include &lt;faiss/impl/IDSelector.h&gt;

#include &lt;unordered_set&gt;

namespace embedding {

/// @brief å®ä¹ä¸ä¸ª selectorï¼åªä¿çâæªè¢«å é¤âç ID
class NotDeletedIdSelector : public faiss::IDSelector {
 public:
  // æé æ¶ä¼ å¥âå·²å é¤ç ID éåâ
  // explicit NotDeletedIDSelector();

  // éå is_memberï¼å¦æ id å¨ deletedSet ä¸­ï¼è¿å falseï¼å±è½ï¼
  bool is_member(faiss::idx_t id) const override;

  void Add(faiss::idx_t id);

 private:
  std::unordered_set&lt;faiss::idx_t&gt; deletedSet;
};

}  // namespace embedding
</code></pre>
<pre><code class="language-cpp">// NotDeletedIdSelector.cpp
#include "NotDeletedIdSelector.h"

namespace embedding {

// éå is_memberï¼å¦æ id å¨ deletedSet ä¸­ï¼è¿å falseï¼å±è½ï¼
bool NotDeletedIdSelector::is_member(faiss::idx_t id) const {
  return deletedSet.find(id) == deletedSet.end();
}

void NotDeletedIdSelector::Add(faiss::idx_t id) { deletedSet.insert(id); }

}  // namespace embedding
</code></pre>
<p>è¿ä¸ª <code>NotDeletedIdSelector</code> å¯¹è±¡ä¼ å¥ <code>index.search()</code> æ¶ä¼å¨æè¿æ»¤æå·²è¢«æ è®°å é¤ç chunk IDï¼å®ç°âé»è¾å é¤âèæ éç©çéå»ºç´¢å¼ãæ­£å ä¸ºå¦æ­¤ï¼å¨å é¤æä½æ¶ï¼éè¦è®°å½æ è®°å é¤ç chunk IDï¼</p>
<pre><code class="language-cpp">// ä»åéç´¢å¼ä¸­ç§»é¤åå®¢çåµå¥ï¼å¹¶æ è®° chunk ä¸ºå·²å é¤
static void RemoveBlogEmbedding(const std::string&amp; blogId) {
  std::vector&lt;Sqlite3Crud::TableValue&gt; result;
  Sqlite3Crud::Query&lt;TableBlogChunksField&gt;(
      TableName::blog_chunks, {TableBlogChunksField::chunk_id}, result,
      {TableBlogChunksField::blog_id}, {blogId});

  EmbedComponent* embedComponent = Context::GetInstance().GetEmbedComponent();
  for (const auto&amp; value : result) {
    embedComponent-&gt;idSelector.Add(std::get&lt;int64_t&gt;(value));
  }

  Sqlite3Crud::Update&lt;TableBlogChunksField&gt;(
      TableName::blog_chunks,
      {TableBlogChunksField::is_deleted, TableBlogChunksField::blog_id},
      {1LL, blogId});
}
</code></pre>
<p>å½ç¶ï¼å¨åå§åæ¶ä¹è¦è®°å½è¿äºè¢«æ è®°å é¤ç chunk IDï¼</p>
<pre><code class="language-cpp">std::vector&lt;Sqlite3Crud::TableValue&gt; result;
Sqlite3Crud::Query&lt;TableBlogChunksField&gt;(
    TableName::blog_chunks, {TableBlogChunksField::chunk_id}, result,
    {TableBlogChunksField::is_deleted}, {1});

for (const auto &amp;value : result) {
  embedComponent-&gt;idSelector.Add(std::get&lt;int64_t&gt;(value));
}
</code></pre>
<h2 id="95-æ´æ°">9.5 æ´æ°</h2>
<p>å¦æè¦æ´æ°åæåµå¥çç¸å³åå®¹ï¼ç±äºåµå¥æä½çå¤ææ§ï¼ç´æ¥å é¤åæ°å¢å³å¯ï¼ç´æ¥å¤ç¨åé¢çè½¯å é¤åå¢éæ´æ°ï¼</p>
<pre><code class="language-cpp">RemoveBlogEmbedding(blogId);
AddBlogEmbedding(blogId, blogMeta.title, blogData.content, blogMeta.summary);
</code></pre>
<h1 id="10-ä¼åæå">10. ä¼åæå</h1>
<p>è³æ­¤ï¼ä¸ä¸ªä»é¶æå»ºãç«¯å°ç«¯çè½»éçº§è¯­ä¹æç´¢ç³»ç»ä¾¿å®æ´è½å°ãæ´ä¸ªæç´¢è¿ç¨ä¸ä¾èµä»»ä½å¤é¨æå¡ï¼ä»éå è½½ä¸æ¬¡ FAISS ç´¢å¼å ONNX æ¨¡åï¼å³å¯å¨æ¯«ç§çº§åååºæ¥è¯¢ãå¨ 1GB åå­çäºæå¡å¨ä¸ï¼åå­å ç¨ç¨³å®å¨ 200MB ä»¥åï¼åç«¯ç¨åº+åµå¥æ¨¡å+åéåºï¼ï¼å®ç¾å¥åâæè´æ§è½ + æè´èµæºæçâçåå§ç®æ ãå¨æ§è½åæçæ¹é¢ç¬èå·²ç»æ¯è¾æ»¡æäºï¼ææ¶é´å°±æµè¯ä¸ä¸å·ä½çæ§è½åæ°ä»¥åä¸ Python çæçå¯¹æ¯ã</p>
<p>ä¸è¿ï¼ç±äºå®ç°çæ¯è¾ä»ä¿ï¼å¶å®è¿æå¾å¤å¯ä»¥ä¼ååæåçå°æ¹ï¼</p>
<h2 id="101-æ··åæ£ç´¢">10.1 æ··åæ£ç´¢</h2>
<p>å°½ç®¡åºäºåéçè¯­ä¹æç´¢å¨çè§£ç¨æ·æå¾ãå¤çåä¹è¯åæ¨¡ç³è¡¨è¾¾æ¹é¢å±ç°åºå¼ºå¤§è½åï¼ä½å®å¹¶éä¸è½ï¼</p>
<ul>
<li><strong>ç»èä¸¢å¤±é®é¢</strong>ï¼è¯­ä¹åµå¥å¾åäºæææ´ä½è¯­ä¹ï¼èå¯¹ç²¾ç¡®å³é®è¯ææåº¦è¾ä½ãå½ç¨æ·æç¡®ç¥éè¦æ¾æä¸ªå·ä½æ¯è¯­æ¶ï¼è¯­ä¹æ¨¡åå¯è½å âè¿åº¦æ³åâèå°ç¸å³ä½ä¸ç²¾ç¡®çç»ææå¨åé¢ï¼åèæ¼æçæ­£å¹éçææ¡£ã</li>
<li><strong>é¿å°¾æ¥è¯¢è¡¨ç°ä¸ç¨³å®</strong>ï¼å¯¹äºç½è§æ¯è¯­ãä¸ä¸ç¼©åææ¼ååä½ï¼åµå¥æ¨¡åè¥æªå¨è®­ç»æ°æ®ä¸­ååè¦çï¼å¶åéè¡¨ç¤ºå¯è½åç¦»çå®è¯­ä¹ï¼å¯¼è´æ£ç´¢å¤±æã</li>
<li><strong>å¯æ§æ§å¼±</strong>ï¼ä¼ ç»å³é®è¯æç´¢å¯éè¿å¸å°é»è¾ï¼AND/OR/NOTï¼ãå­æ®µéå®ï¼title:xxxï¼ãééç¬¦ç­æä¾ç²¾ç»æ§å¶ï¼èçº¯åéæç´¢ç¼ºä¹æ­¤ç±»æºå¶ï¼é¾ä»¥æ»¡è¶³é«çº§ç¨æ·çç²¾ç¡®ç­ééæ±ã</li>
</ul>
<p>å æ­¤ï¼<strong>åä¸ä¾èµè¯­ä¹æç´¢å¹¶ä¸è¶³ä»¥è¦çå¨é¨æç´¢åºæ¯</strong>ãæ´åççæ¹æ¡æ¯æå»º<strong>æ··åæ£ç´¢ç³»ç»ï¼Hybrid Searchï¼</strong>ï¼å°<strong>å³é®è¯å¹éï¼å¦ BM25ï¼</strong> ä¸ <strong>åéç¸ä¼¼åº¦æ£ç´¢</strong> çç»æè¿è¡èåââä¾å¦éè¿å ææåï¼Reciprocal Rank Fusionï¼ãéæåºï¼Rerankï¼æåç«¯å Tab å±ç¤ºãè¿æ ·æ¢è½å©ç¨è¯­ä¹æç´¢çè§£âæ¤å Git æäº¤âç­èªç¶è¯­è¨æ¥è¯¢ï¼åè½ç¡®ä¿â<code>git revert HEAD</code>âè¿ç±»ç²¾ç¡®å½ä»¤è¢«åç¡®å½ä¸­ã</p>
<h2 id="102-ååå¨å¼ºå">10.2 ååå¨å¼ºå</h2>
<p>å¨å¤§é¨åæåµä¸ï¼è¿éååå¨ <strong>ç»ææç¥ + å¥å­å¯¹é½ + ä¸ä¸ææ³¨å¥</strong> çä¸éç­ç¥ï¼å·²å¨ææä¸æçä¹é´åå¾äºä»¤äººæ»¡æçå¹³è¡¡ãä¸è¿ï¼å¨æ´å¤æç RAG ç³»ç»ä¸­ï¼å¯è½è¿éè¦ä»¥ä¸ä¼åï¼</p>
<ul>
<li>åå®¹ç±»åæç¥ååï¼å¯¹ä»£ç åãè¡¨æ ¼ãLaTeX å¬å¼ç­éè¿ç»­ææ¬è¿è¡ç¹æ®å¤çãä¾å¦ï¼å°å®æ´ä»£ç åè§ä¸ºä¸å¯åå²ååï¼å¯¹è¡¨æ ¼æè¡æè¯­ä¹åæåï¼é¿åå¨å¬å¼ä¸­é´å¼ºè¡ååã</li>
<li>å¨æè¯­ä¹è¾¹çæ£æµï¼å¼å¥è½»éçº§è¯­è¨æ¨¡åï¼å¦ Sentence-BERT æä¸ç¨è¾¹çåç±»å¨ï¼è¯å«æ®µè½åé¨çè¯­ä¹è½¬æç¹ï¼å®ç°æ´èªç¶çåæ®µï¼èéä»ä¾èµæ ç¹æåºå®é¿åº¦ã</li>
<li>æ»å¨çªå£éå æºå¶ï¼å¨åºå®æå¤§ token é¿åº¦ï¼å¦ 512ï¼åºç¡ä¸ï¼éç¨æ»å¨çªå£ï¼å¦æ­¥é¿ 384ï¼éå  128 tokensï¼çæè¿ç»­éå åãè¿è½ç¼è§£å ç¡¬æ§ååå¯¼è´çå³é®ä¿¡æ¯è¢«å²è£çé®é¢ï¼å°¤å¶éç¨äºé¿ææ¯è¯´ææè¿è´¯è®ºè¯æ®µè½ã</li>
<li>åè¡¨ä¸æä¸¾é¡¹ç²¾ç»åå¤çï¼å½åååå¨å¯è½å°å¤è¡æ åº/æåºåè¡¨æ´ä½ä¿çï¼ä½è¥åè¡¨é¡¹æ¬èº«è¾é¿ä¸ç¬ç«ï¼å¯è¿ä¸æ­¥æé¡¹æåï¼å¹¶ä¸ºæ¯é¡¹æ³¨å¥æå±æ é¢ä¸ä¸æï¼æåç»ç²åº¦æ£ç´¢è½åã</li>
<li>è·¨åä¸ä¸æé¾æ¥ï¼å¨å­å¨ chunk æ¶ï¼é¢å¤è®°å½å¶åé©±/åç»§ chunk IDï¼ä¾¿äºå¨åç»­ RAG é¶æ®µæ¼æ¥ä¸ä¸æï¼è¿åæ´å®æ´çåå§è¯­å¢ã</li>
</ul>
<p>è¿äºæ¹è¿å¹¶éé½è¦åæ¶å¼å¥ï¼èåºæ ¹æ®å®éåå®¹åå¸åç¨æ·æ¥è¯¢æ¨¡å¼éæ­¥è¿­ä»£ãæ¯ç«ï¼ååçæ¬è´¨æ¯å¨âä¿¡æ¯å¯åº¦âãâè¯­ä¹å®æ´æ§âä¸âæ£ç´¢æçâä¹é´å¯»æ¾æä¼å¹³è¡¡ç¹ââèè¿ä¸ªå¹³è¡¡ç¹ï¼ä¼éçä¸å¡æ¼è¿èä¸æ­ç§»å¨ã</p>
<h2 id="103-é«äº®æº¯æº">10.3 é«äº®æº¯æº</h2>
<p>å½åæç´¢ç»æè½å·²è¿å <code>snippetText</code>ï¼å³å½ä¸­çææ¬çæ®µï¼ï¼ä½ç¨æ·ä»éèªè¡å¨åæä¸­å®ä½å³é®è¯ä½ç½®ï¼ä½éªä¸å¤ç´è§ãä¸ºæåå¯ç¨æ§ï¼åºå®ç°<strong>å³é®è¯é«äº®ä¸çæ®µæº¯æº</strong>åè½ã</p>
<p>å¶å®ç°å¯åä¸ºä¸¤æ­¥ï¼</p>
<ol>
<li>
<p><strong>å½ä¸­è¯æåä¸é«äº®</strong><br>
å¨è¿å <code>snippetText</code> åï¼å¯¹åå§æ¥è¯¢è¿è¡åè¯ï¼å¤ç¨ <code>Tokenizer</code>ï¼ï¼æåæ ¸å¿å³é®è¯ï¼æä½¿ç¨ BM25 éåå¹éé«é¢ termï¼ï¼ç¶åå¨ <code>snippetText</code> ä¸­è¿è¡ä¸åºåå¤§å°åçå­ä¸²å¹éï¼å¹¶ç¨ <code>&lt;mark&gt;</code> æ <code>**</code> ç­æ è®°åè£¹å½ä¸­è¯ãä¾å¦ï¼</p>
<blockquote>
<p>âå¦ä½<strong>æ¤å</strong> Git <strong>æäº¤</strong>â â â...å¯ä»¥ä½¿ç¨ <code>git revert</code> æ¥<strong>æ¤å</strong>ææ¬¡<strong>æäº¤</strong>...â</p>
</blockquote>
</li>
<li>
<p><strong>ä¸ä¸ææ©å±ä¸éç¹å®ä½</strong><br>
å½å <code>snippetText</code> ä»ä¸º chunk åå®¹ï¼å¯è½ç¼ºä¹è¶³å¤ä¸ä¸æãå¯è¿ä¸æ­¥æ ¹æ® chunk æå±çæ®µè½ç»æï¼å¦ Markdown æ é¢å±çº§ï¼ï¼åå/åæ©å± 1â2 å¥ä½ä¸ºè¡¥åä¸ä¸æï¼å¹¶å¨åç«¯éè¿æ»å¨éç¹ï¼å¦ <code>#chunk-12345</code>ï¼ç´æ¥è·³è½¬å°åæå¯¹åºä½ç½®ï¼å®ç°âæè§å³æè¾¾âçæº¯æºä½éªã</p>
</li>
</ol>
<p>é«äº®æº¯æºè½æ¯ç»èï¼å´æ¯è¿æ¥âæ£ç´¢ç»æâä¸âç¨æ·ä¿¡ä»»âçå³é®ä¸ç¯ââè®©ç¨æ·ä¸ç¼çæ¸âä¸ºä»ä¹è¿æ¡ç»æè¢«å¬åâï¼ä»èæåæç´¢ç³»ç»çéæåº¦ä¸å¯ä¿¡åº¦ã</p>
<h2 id="104-åéç´¢å¼">10.4 åéç´¢å¼</h2>
<p>å¨ç®åå°è§æ¨¡åºæ¯ï¼éå¸¸å ç¾å°å åä¸ª chunkï¼ï¼ä½¿ç¨ <code>IndexFlatIP</code> ç²¾ç¡®æç´¢çå¼éå®å¨å¯æ¥åï¼ä¸è½ä¿è¯æé«å¬åè´¨éãè¥æªæ¥æ°æ®éæ¿å¢ï¼å¯æ ç¼æ¿æ¢ä¸º <code>IndexIVFFlat</code> æ <code>HNSW</code> ç­è¿ä¼¼ç´¢å¼ï¼èä¸å±æ¥å£ä¸åã</p>
<p>ä¸ºäºä¾¿äºåç»­æ¼è¿ï¼è¿éç»åºä¸ä¸ªåºäºæ°æ®è§æ¨¡çç»éªæ§åçº§è·¯å¾å»ºè®®ï¼</p>
<table>
<thead>
<tr>
<th><strong>Chunk æ°éèå´</strong></th>
<th><strong>æ¨è FAISS ç´¢å¼ç±»å</strong></th>
<th><strong>ç¹ç¹ä¸éç¨åºæ¯</strong></th>
<th><strong>å¸ååæ°ï¼ç¤ºä¾ï¼</strong></th>
<th><strong>æ¯å¦æ¯æå¨ææå¥</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>â¤ 10,000</td>
<td><code>IndexFlatIP</code></td>
<td>ç²¾ç¡®æç´¢ï¼å®ç°ç®åï¼å»¶è¿æä½ï¼&lt;10msï¼ï¼éåå°è§æ¨¡éæç¥è¯åº</td>
<td>æ </td>
<td>â æ¯</td>
</tr>
<tr>
<td>10,000 ~ 100,000</td>
<td><code>IndexIVFFlat</code></td>
<td>è¿ä¼¼æç´¢ï¼éè¿èç±»å éï¼å¬åçé«ï¼&gt;95%ï¼ï¼éåä¸­ç­è§æ¨¡ãéé¢ç¹å¢éæ´æ°çåºæ¯</td>
<td><code>nlist=100</code>, <code>nprobe=10</code></td>
<td>â æ¯</td>
</tr>
<tr>
<td>&gt; 100,000</td>
<td><code>IndexHNSW</code></td>
<td>å¾ç»æè¿ä¼¼æç´¢ï¼æ¥è¯¢éåº¦æå¿«ä¸å ä¹ä¸éæ°æ®å¢é¿åæ¢ï¼éåå¤§è§æ¨¡ãé«å¹¶ååªè¯»åºæ¯</td>
<td><code>M=32</code>, <code>efConstruction=200</code>, <code>efSearch=64</code></td>
<td>â å¦ï¼FAISS é»è®¤ä¸æ¯æï¼</td>
</tr>
<tr>
<td>&gt; 1,000,000ï¼è¶å¤§è§æ¨¡ï¼</td>
<td><code>IndexIVFPQ</code> æ <code>HNSW+PQ</code></td>
<td>å¼å¥åééåï¼Product Quantizationï¼åç¼©åå­ï¼çºç²å°éç²¾åº¦æ¢åæ´ä½åå­å ç¨åæ´å¿«æ£ç´¢</td>
<td><code>nlist=1000</code>, <code>pq.M=64</code>, <code>pq.nbits=8</code></td>
<td>âï¼IVF æ¯æï¼</td>
</tr>
</tbody>
</table>
<h2 id="105-ä¸å¡æ§è½">10.5 ä¸å¡æ§è½</h2>
<p>å¨æ¶ååæçå¢å æ¹ï¼CRUDï¼æä½æ¶ï¼<strong>åµå¥çæä¸ç´¢å¼æ´æ°å±äºè¾å©æ§åå°ä»»å¡</strong>ï¼å¹¶ä¸å½±åä¸»ä¸å¡æµç¨ï¼å¦æç« åå¸ãç¼è¾ä¿å­ç­ï¼ãç¨æ·çæ ¸å¿è¯æ±æ¯âæä½å³æ¶ååºâï¼èå¯¹æç´¢ç»æçæ¶å½å»¶è¿éå¸¸å·æè¾é«å®¹å¿åº¦ââå ç§çè³å åéçæ»åå¨å¤§å¤æ°åºæ¯ä¸æ¯å¯ä»¥æ¥åçã</p>
<p>å æ­¤ï¼<strong>ä¸åºå¨ä¸»çº¿ç¨ä¸­åæ­¥æ§è¡åµå¥è®¡ç®ä¸ FAISS åå¥</strong>ï¼å¦åä¼æ¾èææ¢ HTTP ååºæ¶é´ï¼å°¤å¶å½ ONNX æ¨çæç£ç I/O æä¸ºç¶é¢æ¶ã</p>
<p>æ¨èéç¨ä»¥ä¸ç­ç¥ä¹ä¸ï¼</p>
<ul>
<li><strong>å¼æ­¥ä»»å¡éåï¼æ¨èï¼</strong>ï¼å°åµå¥ä»»å¡ï¼å¦ <code>AddBlogEmbedding</code> / <code>RemoveBlogEmbedding</code>ï¼æ¨å¥åå­éåæè½»éçº§ä»»å¡è°åº¦å¨ï¼å¦åºäº <code>std::queue</code> + åç¬å·¥ä½çº¿ç¨ï¼ï¼ç±åå°çº¿ç¨æåºå¤çãè¿æ ·æ¢è½ä¿è¯ä¸»çº¿ç¨å¿«éè¿åï¼åè½é¿åå¤çº¿ç¨å¹¶åå FAISS ç´¢å¼å¼åçæ°æ®ç«äºï¼FAISS ç <code>Index</code> é»è®¤éçº¿ç¨å®å¨ï¼ã</li>
<li><strong>åç¨æå¼æ­¥ I/Oï¼è¿é¶ï¼</strong>ï¼è¥ç³»ç»å·²åºäºæ¯æåç¨çæ¡æ¶ï¼å¦ SeastarãBoost.Asio + coroutine TSï¼ï¼å¯å°åµå¥ä¸ç´¢å¼åå¥å°è£ä¸º suspendable ä»»å¡ï¼å¨ä¸é»å¡äºä»¶å¾ªç¯çåæä¸å®æèæ¶æä½ãä½èèå°å½åç³»ç»è½»éçº§å®ä½ï¼æ­¤æ¹æ¡æ¶çæéï¼å¤æåº¦è¾é«ã</li>
<li><strong>å®ææ¹éæ´æ°ï¼ååºæ¹æ¡ï¼</strong>ï¼å¯¹äºä½é¢æ´æ°åºæ¯ï¼ä¹å¯æå­å¾å¤çç blog ID å°æ°æ®åºæ è®°è¡¨ï¼ç±å®æ¶ä»»å¡ï¼å¦æ¯ 5 åéï¼ç»ä¸æ«æå¹¶æ¹éæ§è¡åµå¥ä¸ç´¢å¼æ´æ°ãè¿ç§æ¹å¼å®ç°ç®åï¼ä¸å¤©ç¶è§é¿å¹¶åé®é¢ï¼éå MVP æèµæºåéç¯å¢ã</li>
</ul>
<p>æ­¤å¤ï¼FAISS ç´¢å¼çæä¹åï¼<code>faiss::write_index</code>ï¼å±äº I/O å¯éåæä½ï¼å»ºè®®å¨åå°ä»»å¡å®æææåéæ·»å å<strong>ä¸æ¬¡æ§åå¥</strong>ï¼èéæ¯æ¬¡æ°å¢ chunk é½è§¦ååçï¼ä»¥åå°ç£çååå¹¶æåååã</p>
<p>éè¿ä¸è¿°å¼æ­¥åè®¾è®¡ï¼ç³»ç»æ¢è½ç»´ææ¯«ç§çº§çåç«¯ååºï¼åè½ç¨³å¥å°ä¿éæç´¢æ°æ®çéæ­¥æ¶æï¼çæ­£å®ç°âç¨æ·ä½éªâä¸âç³»ç»æçâçåèµ¢ã</p>


</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-02-12 21:42">2026-02-12 21:41</span>&nbsp;
<a href="https://www.cnblogs.com/charlee44">charlee44</a>&nbsp;
éè¯»(<span id="post_view_count">34</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19609813);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19609813', targetLink: 'https://www.cnblogs.com/charlee44/p/19609813', title: 'ä»é¶å®ç°ä¸ä¸ªçäº§çº§ RAG è¯­ä¹æç´¢ç³»ç»ï¼C++ + ONNX + FAISS å®æ' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
        </channel>
        </rss>