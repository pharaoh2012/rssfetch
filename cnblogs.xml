<?xml version="1.0" encoding="UTF-8" ?>
    <rss version="2.0">
    <channel>
        <title><![CDATA[ ä¸»é¡µ - åå®¢å­ ]]></title>
        <link><![CDATA[ https://www.cnblogs.com/ ]]></link>
        <lastBuildDate>2026-01-11T20:18:56.814Z</lastBuildDate>
        <description><![CDATA[
        ä¸»é¡µ - åå®¢å­ RSS
    ]]></description>
        <language>zh-cn</language>
        <item>
    <title><![CDATA[ Javaä¸­çº¿ç¨å®å¨é®é¢çåå åè§£å³æ¹æ¡ ]]></title>
    <link>https://www.cnblogs.com/xi-yongqi/p/19468853</link>
    <guid>230b6b30fd8832efa55db7fe074252b8</guid>
    <description>
    <![CDATA[ 
		<h1 class="postTitle">
			<a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/xi-yongqi/p/19468853" title="åå¸äº 2026-01-11 23:41">
    <span role="heading" aria-level="2">Javaä¸­çº¿ç¨å®å¨é®é¢çåå åè§£å³æ¹æ¡</span>
    

</a>

		</h1>
		<div class="clear"></div>
		<div class="postBody">
			<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h3 id="çº¿ç¨å®å¨é®é¢çæ ¸å¿åå ">çº¿ç¨å®å¨é®é¢çæ ¸å¿åå </h3>
<ul>
<li>çº¿ç¨å®å¨é®é¢æ¬è´¨æ¯å¤ä¸ªçº¿ç¨å¹¶åè®¿é®å±äº«ä¸å¯åçèµæºæ¶ï¼æä½çåå­æ§ãå¯è§æ§ææåºæ§è¢«ç ´åï¼å¯¼è´ç¨åºæ§è¡ç»æä¸ç¬¦åé¢æã</li>
</ul>
<ol>
<li>æ ¹æ¬åå ï¼å±äº«å¯åèµæº</li>
</ol>
<ul>
<li>å±äº«èµæºï¼å¤ä¸ªçº¿ç¨é½è½è®¿é®å°çèµæºï¼å¦æååéãéæåéãå±äº«åå­åºåï¼ï¼</li>
<li>å¯åèµæºï¼èµæºçç¶æï¼å¼ï¼å¯ä»¥è¢«ä¿®æ¹ï¼å¦intè®¡æ°å¨ãHashMapçåç´ ï¼ï¼</li>
<li>ç»å¸çi++ æä½ãå®å¨åºå±åä¸ºâè¯»å-ä¿®æ¹-åå¥âä¸ä¸ªæ­¥éª¤ãå¦æä¸¤ä¸ªçº¿ç¨åæ¶è¯»å i=1ï¼åèªå 1åååï¼ç»ææ¯2èä¸æ¯3ã</li>
</ul>
<ol start="2">
<li>ç´æ¥åå ï¼ä¸å¤§ç¹æ§è¢«ç ´å</li>
</ol>
<ul>
<li>Javaåå­æ¨¡åï¼JMMï¼å®ä¹çå¤çº¿ç¨å¹¶åä¸å¤§æ ¸å¿ç¹æ§ï¼ä»»ä½ä¸ä¸ªè¢«ç ´åé½ä¼å¼åçº¿ç¨å®å¨é®é¢ï¼
<ul>
<li>åå­æ§ï¼ä¸ä¸ªæä½ï¼å¦count++ï¼åå«âè¯» - æ¹ - åâä¸æ­¥ï¼éåå­æä½ä¼è¢«å¤çº¿ç¨äº¤éæ§è¡ï¼</li>
<li>å¯è§æ§ï¼çº¿ç¨ä¿®æ¹å±äº«åéåï¼ä¸ä¼ç«å³åæ­¥å°ä¸»åå­ï¼å¶ä»çº¿ç¨è¯»åçä»æ¯æ§å¼ï¼</li>
<li>æåºæ§ï¼JVMçæä»¤éæåºä¼åï¼ä¼å¯¼è´å¤çº¿ç¨ä¸æ§è¡é¡ºåºæ··ä¹±ï¼å¦æªå volatileçåéæ£æ¥éåä¾ï¼ã</li>
</ul>
</li>
</ul>
<h3 id="çº¿ç¨å®å¨é®é¢çè§£å³æ¹æ¡">çº¿ç¨å®å¨é®é¢çè§£å³æ¹æ¡</h3>
<ul>
<li>æ ¸å¿æè·¯ï¼è¦ä¹é¿åå±äº«å¯åèµæºï¼ä»æ ¹æºæ¶é¤é®é¢ï¼ï¼è¦ä¹æ§å¶å¹¶åè®¿é®è§åï¼ä¿è¯ä¸å¤§ç¹æ§ï¼ã</li>
</ul>
<h5 id="æ¹æ¡1é¿åå±äº«å¯åèµæºä¼åæ¨è">æ¹æ¡1ï¼é¿åå±äº«å¯åèµæºï¼ä¼åæ¨èï¼</h5>
<ul>
<li>æ å°é­ï¼å±é¨åéï¼ï¼å±é¨åéå­å¨å¨çº¿ç¨ç§ææ ä¸­ï¼æ¯ä¸ªçº¿ç¨æç¬ç«å¯æ¬ï¼å¤©ç¶çº¿ç¨å®å¨ã</li>
</ul>
<pre><code class="language-java">public class StackClosedDemo {
    // æ¯ä¸ªçº¿ç¨è°ç¨è¯¥æ¹æ³æ¶ï¼é½ä¼åå»ºç¬ç«çcountå¯æ¬
    public void calculate() {
        int count = 0;
        count++; // æ çº¿ç¨å®å¨é®é¢
        System.out.println(Thread.currentThread().getName() + ": " + count);
    }

    public static void main(String[] args) {
        StackClosedDemo demo = new StackClosedDemo();
        // 10ä¸ªçº¿ç¨åèªæä½èªå·±çå±é¨åé
        for (int i = 0; i &lt; 10; i++) {
            new Thread(demo::calculate, "Thread-" + i).start();
        }
    }
}
</code></pre>
<ul>
<li>ä¸å¯åå¯¹è±¡:å¯¹è±¡åå»ºåç¶æä¸å¯ä¿®æ¹ï¼å¦StringãIntegerï¼ï¼å³ä½¿å±äº«ä¹æ æ³ä¿®æ¹å¼ã</li>
</ul>
<pre><code class="language-java">// èªå®ä¹ä¸å¯åç±»ï¼finalç±»+finalæååé+æ setterï¼
public final class ImmutableUser {
    private final String name;
    private final int age;

    public ImmutableUser(String name, int age) {
        this.name = name;
        this.age = age;
    }

    // ä»æä¾getterï¼æ setter
    public String getName() { return name; }
    public int getAge() { return age; }
}
</code></pre>
<ul>
<li>ThreadLocalï¼çº¿ç¨æ¬å°å­å¨ï¼:ä¸ºæ¯ä¸ªçº¿ç¨æä¾ç¬ç«çåéå¯æ¬ï¼çº¿ç¨æä½èªèº«å¯æ¬ï¼äºä¸å¹²æ°ã</li>
</ul>
<pre><code class="language-java">public class ThreadLocalDemo {
    // æ¯ä¸ªçº¿ç¨æç¬ç«çIntegerå¯æ¬ï¼åå§å¼ä¸º0
    private static ThreadLocal&lt;Integer&gt; threadLocal = ThreadLocal.withInitial(() -&gt; 0);

    public void increment() {
        threadLocal.set(threadLocal.get() + 1);
        System.out.println(Thread.currentThread().getName() + ": " + threadLocal.get());
    }

    public static void main(String[] args) {
        ThreadLocalDemo demo = new ThreadLocalDemo();
        // 3ä¸ªçº¿ç¨åèªæä½èªå·±çå¯æ¬
        for (int i = 0; i &lt; 3; i++) {
            new Thread(() -&gt; {
                for (int j = 0; j &lt; 2; j++) {
                    demo.increment();
                }
            }, "Thread-" + i).start();
        }
    }
}
// è¾åºï¼é¡ºåºå¯è½ä¸åï¼ï¼
// Thread-0: 1ãThread-0: 2
// Thread-1: 1ãThread-1: 2
// Thread-2: 1ãThread-2: 2
</code></pre>
<h4 id="æ¹æ¡2åæ­¥å éæ§å¶å¹¶åè®¿é®">æ¹æ¡2ï¼åæ­¥/å éï¼æ§å¶å¹¶åè®¿é®ï¼</h4>
<h5 id="äºæ¥åæ­¥é»å¡åæ­¥è¿æ¯æå¸¸è§çæ¹æ¡éè¿å éæ¥ä¿è¯åä¸æ¶å»åªæä¸ä¸ªçº¿ç¨æä½èµæº">äºæ¥åæ­¥ï¼é»å¡åæ­¥ï¼:è¿æ¯æå¸¸è§çæ¹æ¡ï¼éè¿å éæ¥ä¿è¯åä¸æ¶å»åªæä¸ä¸ªçº¿ç¨æä½èµæºã</h5>
<ul>
<li>synchronized å³é®å­ï¼Java åçæ¯æï¼ä½¿ç¨ç®åãå¯ä¿®é¥°æ¹æ³æä»£ç åãå±äºä¸å¯ä¸­æ­çéã</li>
</ul>
<pre><code class="language-java">public class SynchronizedDemo {
    private int count = 0;

    // åæ­¥å®ä¾æ¹æ³ï¼éæ¯thiså¯¹è±¡
    public synchronized void increment() {
        count++;
    }

    public static void main(String[] args) throws InterruptedException {
        SynchronizedDemo demo = new SynchronizedDemo();
        // 1000ä¸ªçº¿ç¨æ§è¡increment
        for (int i = 0; i &lt; 1000; i++) {
            new Thread(demo::increment).start();
        }
        Thread.sleep(1000);
        System.out.println("æç»countï¼" + demo.count); // è¾åº1000
    }
}
</code></pre>
<h5 id="reentrantlockæ¾å¼éæ¯synchronizedçµæ´»å¯ä¸­æ­å¯è¶æ¶å¬å¹³ééæå¨éæ¾éå¿é¡»å¨finallyä¸­">ReentrantLockï¼æ¾å¼éï¼:æ¯synchronizedçµæ´»ï¼å¯ä¸­æ­ãå¯è¶æ¶ãå¬å¹³éï¼ï¼éæå¨éæ¾éï¼å¿é¡»å¨finallyä¸­ï¼ã</h5>
<pre><code class="language-java">import java.util.concurrent.locks.Lock;
import java.util.concurrent.locks.ReentrantLock;

public class ReentrantLockDemo {
    private int count = 0;
    private Lock lock = new ReentrantLock(); // é»è®¤éå¬å¹³é

    public void increment() {
        lock.lock(); // å é
        try {
            count++;
        } finally {
            lock.unlock(); // éæ¾éï¼é¿åæ­»é
        }
    }

    public static void main(String[] args) throws InterruptedException {
        ReentrantLockDemo demo = new ReentrantLockDemo();
        for (int i = 0; i &lt; 1000; i++) {
            new Thread(demo::increment).start();
        }
        Thread.sleep(1000);
        System.out.println("æç»countï¼" + demo.count); // è¾åº1000
    }
}
</code></pre>
<h4 id="æ¹æ¡3volatileå³é®å­ä¿è¯å¯è§æ§æåºæ§">æ¹æ¡3ï¼volatileå³é®å­ï¼ä¿è¯å¯è§æ§/æåºæ§ï¼</h4>
<ul>
<li>ä¿è¯å¯è§æ§ï¼å¼ºå¶å¤±æå·¥ä½åå­ï¼ç´æ¥è¯»åä¸»åå­ã</li>
<li>ä¿è¯æåºæ§ï¼ç¦æ­¢æä»¤éæåºã</li>
<li>æ³¨æï¼å®ä¸ä¿è¯åå­æ§ï¼ä¸è½è§£å³i++é®é¢ï¼ã</li>
</ul>
<pre><code class="language-java">public class VolatileDemo {
    private volatile boolean stop = false; // ä¿è¯å¯è§æ§åæåºæ§

    public void runThread() {
        new Thread(() -&gt; {
            int i = 0;
            while (!stop) { // è½ç«å³æç¥stopçä¿®æ¹
                i++;
            }
            System.out.println("çº¿ç¨åæ­¢ï¼i=" + i);
        }).start();
    }

    public static void main(String[] args) throws InterruptedException {
        VolatileDemo demo = new VolatileDemo();
        demo.runThread();
        Thread.sleep(3000);
        demo.stop = true; // ä¿®æ¹åï¼çº¿ç¨ç«å³åæ­¢
    }
}
</code></pre>

</div>
<div class="clear"></div>

		</div>
		<div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-01-11 23:41">2026-01-11 23:41</span>&nbsp;
<a href="https://www.cnblogs.com/xi-yongqi">æä¼æ¿é£å»</a>&nbsp;
éè¯»(<span id="post_view_count">0</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19468853);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19468853', targetLink: 'https://www.cnblogs.com/xi-yongqi/p/19468853', title: 'Javaä¸­çº¿ç¨å®å¨é®é¢çåå åè§£å³æ¹æ¡' })">ä¸¾æ¥</a>
</div>
	 ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ é£ä¹¦ .NET SDK äºä»¶å¤ççå¹ç­æ§ä¸å»éæºå¶ ]]></title>
    <link>https://www.cnblogs.com/mudtools/p/19469184</link>
    <guid>bd0ebe6ed3f817550068845b03bbc87d</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/mudtools/p/19469184" title="åå¸äº 2026-01-11 23:00">
    <span role="heading" aria-level="2">é£ä¹¦ .NET SDK äºä»¶å¤ççå¹ç­æ§ä¸å»éæºå¶</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<blockquote>
<p>é£ä¹¦äºä»¶å¤çè¿ç¨ä¸­å¦ä½è®©ä½ çåºç¨ä¸å"éå¤å³å¨"ï¼å¦ä½ç¨ä¸å±é²æ¤ç­èµ·å®å¨å¢ï¼ç»ååå­ä¸ Redis åéä¿éï¼è®©ä½ çé£ä¹¦åºç¨ç¨³å¦ç£ç³ââä¸åéå¤å¤çï¼åå«æ··ä¹±ç¶æã</p>
</blockquote>
<hr>
<h2 id="ä¸ºä»ä¹éè¦å»é">ä¸ºä»ä¹éè¦"å»é"ï¼</h2>
<p>æ³è±¡ä¸ä¸è¿æ ·çåºæ¯ï¼</p>
<p>ä½ å¨é£ä¹¦éæ¶å°ä¸æ¡æ¶æ¯ï¼åºç¨æ¶å°éç¥ååå»ºäºå¾åäºé¡¹ãä½å ä¸ºç½ç»ä¸ç¨³å®ï¼é£ä¹¦ä»¥ä¸ºä½ æ²¡æ¶å°ï¼ååäºä¸éåæ ·çéç¥ââç»æå¢ï¼ä½ çåºç¨ååå»ºäºä¸æ¬¡å¾åï¼åä¸ä¸ªä»»å¡åºç°äºä¸¤æ¬¡ã</p>
<p>è¿å°±æ¯æä»¬æè¯´ç"éå¤å¤ç"é®é¢ã</p>
<hr>
<h3 id="ä»ä¹æ¶åä¼åºç°è¿ç§æåµ">ä»ä¹æ¶åä¼åºç°è¿ç§æåµï¼</h3>
<p>å¨é£ä¹¦äºä»¶é©±å¨çä¸çéï¼ä»¥ä¸æåµé½å¯è½å¯¼è´<strong>åä¸äºä»¶è¢«å¤æ¬¡éè¾¾</strong>ï¼</p>
<ul>
<li>ð¡ <strong>ç½ç»æ³¢å¨</strong>ï¼é£ä¹¦æå¡å¨æ²¡æ¶å°ä½ çç¡®è®¤ï¼äºæ¯éå</li>
<li>ð <strong>æå¡éå¯</strong>ï¼åå­æ¸ç©ºï¼ä¹åçäºä»¶åæ¥äº</li>
<li>ð¥ <strong>å¤å®ä¾è¿è¡</strong>ï¼å¤ä¸ªå®ä¾åæ¶æ¶å°åä¸äºä»¶</li>
<li>ð <strong>æ­çº¿éè¿</strong>ï¼WebSocket éè¿åå¯è½éå¤æ¶æ¯</li>
</ul>
<h3 id="çå®æ¡ä¾ä¸åéåçæ··ä¹±">çå®æ¡ä¾ï¼ä¸åéåçæ··ä¹±</h3>
<pre><code>æ¶é´çº¿ï¼
âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ
09:00:00  é£ä¹¦æ¨éï¼æ¶å°ä¸æ¡æ°æ¶æ¯
09:00:01  å®ä¾A æ¥æ¶å¹¶å¤ç â åå»ºå¾å â
09:00:05  é£ä¹¦æ²¡æ¶å°ç¡®è®¤ï¼åæ¬¡æ¨é
09:00:06  å®ä¾B æ¥æ¶å¹¶å¤ç â ååå»ºå¾å â
âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ
</code></pre>
<p><strong>åææå¤ä¸¥éï¼</strong></p>
<table>
<thead>
<tr>
<th>é®é¢</th>
<th>å®éå½±å</th>
</tr>
</thead>
<tbody>
<tr>
<td>ð æ°æ®éå¤</td>
<td>ç¨æ·æ¶å°ä¸¤æ¡ç¸åçå¾å</td>
</tr>
<tr>
<td>ð° èµéæå¤±</td>
<td>è®¢åéå¤æ£æ¬¾ï¼éé±é½éä¸å®</td>
</tr>
<tr>
<td>ð§ éªæ°ç¨æ·</td>
<td>åä¸æ¡éç¥ååæ¬¡</td>
</tr>
<tr>
<td>ð ç¶ææ··ä¹±</td>
<td>æ°æ®åºéè¯´"å·²å¤ç"ï¼å®éåªåäºä¸å</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="ä¸å±é²æ¤åä¿å®ä¸æ ·å±å±æå³">ä¸å±é²æ¤ï¼åä¿å®ä¸æ ·å±å±æå³</h2>
<p>Mud.Feishu SDK è®¾è®¡äºä¸å¥<strong>ä¸å±éè¿å¼é²æ¤æºå¶</strong>ï¼å°±åå°åºçä¸éå²å¨ï¼ä»å¤å°åå±å±æå³ï¼ç¡®ä¿ä¸ä¼æ"åäºº"ï¼éå¤äºä»¶ï¼æ··è¿æ¥ã</p>
<div class="mermaid">graph TB
    subgraph AppLayer["åºç¨å±å»éï¼ä¸å¡é®ï¼"]
        AppHandler["IdempotentFeishuEventHandler&lt;T&gt;"]
        AppDesc["åºäºä¸å¡ä¸»é®ï¼æ¶æ¯IDãè®¢åIDç­ï¼å»é"]
    end

    subgraph DispatchLayer["ååå±å»éï¼EventIdï¼"]
        EventDedup["IFeishuEventDeduplicator / IFeishuEventDistributedDeduplicator"]
        EventDesc["åºäºé£ä¹¦äºä»¶IDå»éï¼24å°æ¶çªå£æ"]
    end

    subgraph ProtocolLayer["åè®®å±å»éï¼SeqID/Nonceï¼"]
        WS_Dedup["WebSocket: IFeishuSeqIDDeduplicator"]
        Webhook_Dedup["Webhook: IFeishuNonceDistributedDeduplicator"]
        ProtoDesc["åºäºæ¶æ¯åºåå·å»éï¼è¿æ»¤éå¤æ¶æ¯"]
    end

    AppHandler --&gt;|å¤çå¨åé¨ä¸å¡é»è¾| EventDedup
    EventDedup --&gt;|äºä»¶è·¯ç±ä¸åå| WS_Dedup
    EventDedup --&gt;|äºä»¶è·¯ç±ä¸åå| Webhook_Dedup

    style AppLayer fill:#e1f5ff
    style DispatchLayer fill:#fff4e1
    style ProtocolLayer fill:#ffe1e1
</div><h3 id="è¿ä¸å±åå«è´è´£ä»ä¹">è¿ä¸å±åå«è´è´£ä»ä¹ï¼</h3>
<p>å¯ä»¥æè¿ä¸å±æ³è±¡æå·¥åæµæ°´çº¿ä¸çä¸ä¸ªè´¨æ£åï¼</p>
<table>
<thead>
<tr>
<th>è´¨æ£å</th>
<th>æ£æ¥ä»ä¹ï¼</th>
<th>å¨åªæ£æ¥ï¼</th>
<th>è¿æ»¤èå´</th>
<th>éåä»ä¹æ¶åç¨ï¼</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>åè®®å±</strong></td>
<td>æ¶æ¯ç¼å·ï¼SeqIDï¼</td>
<td>æ¶æ¯åå°è¾¾æ¶</td>
<td>æ¯æ¡æ¶æ¯</td>
<td>è¿æ»¤ç½ç»éå¤ï¼æå¤å±é²æ¤</td>
</tr>
<tr>
<td><strong>ååå±</strong></td>
<td>äºä»¶IDï¼EventIdï¼</td>
<td>äºä»¶ååå</td>
<td>æ¯ä¸ªäºä»¶</td>
<td>è¿æ»¤é£ä¹¦éåï¼ä¸­é´å±é²æ¤</td>
</tr>
<tr>
<td><strong>åºç¨å±</strong></td>
<td>ä¸å¡é®ï¼TaskIdï¼</td>
<td>ä¸å¡å¤çæ¶</td>
<td>æ¯æ¬¡ä¸å¡æä½</td>
<td>é²æ­¢é»è¾éå¤ï¼æåä¸éé²çº¿</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="ååå±äºä»¶çèº«ä»½è¯æ£æ¥">ååå±ï¼äºä»¶ç"èº«ä»½è¯æ£æ¥"</h2>
<p>è¿æ¯ææ ¸å¿çä¸å±ï¼å°±åé¨å£çä¿å®ï¼æ¯ä¸ªè¿æ¥çäºä»¶é½è¦ååºç¤ºèº«ä»½è¯ï¼EventIdï¼ï¼ä¿å®æ¥è¿è®°å½åæè½æ¾è¡ã</p>
<pre><code class="language-csharp">public interface IFeishuEventDeduplicator
{
    /// &lt;summary&gt;
    /// å°è¯æ è®°äºä»¶ä¸ºå¤çä¸­
    /// &lt;/summary&gt;
    /// &lt;returns&gt;
    /// true: å·²å¤çææ­£å¨å¤çä¸­ï¼è·³è¿ï¼
    /// false: æ°äºä»¶ï¼ç»§ç»­å¤çï¼
    /// &lt;/returns&gt;
    bool TryMarkAsProcessing(string eventId);

    /// &lt;summary&gt;
    /// æ è®°äºä»¶ä¸ºå·²å®æ
    /// &lt;/summary&gt;
    void MarkAsCompleted(string eventId);

    /// &lt;summary&gt;
    /// åæ»å¤çä¸­ç¶æï¼å¼å¸¸æ¶è°ç¨ï¼
    /// &lt;/summary&gt;
    void RollbackProcessing(string eventId);

    /// &lt;summary&gt;
    /// æ£æ¥äºä»¶æ¯å¦å·²å¤ç
    /// &lt;/summary&gt;
    bool IsProcessed(string eventId);
}
</code></pre>
<h3 id="äºä»¶çä¸çä¸ç§ç¶ææµè½¬">äºä»¶çä¸çï¼ä¸ç§ç¶ææµè½¬</h3>
<p>æ¯ä¸ªäºä»¶å¨å»éç³»ç»éé½åè¿å®æ£ä¸æ ·ï¼ç»åä¸ç§ç¶æçååï¼</p>
<div class="mermaid">stateDiagram-v2
    [*] --&gt; Pending: æ¶å°æ°äºä»¶
    Pending --&gt; Processing: TryMarkAsProcessing()
    Processing --&gt; Completed: å¤çæå
    Processing --&gt; Pending: è¶æ¶/å¼å¸¸ï¼Rollbackï¼
    Completed --&gt; Pending: ç¼å­è¿æï¼24å°æ¶åï¼

    note right of Processing
        å¤çä¸­è¶æ¶ï¼é»è®¤5åéï¼
        åè®¸éæ°å¤ç
    end note

    note right of Completed
        24å°æ¶åèªå¨æ¸ç
        æ¯æTTLéç½®
    end note
</div><h3 id="çå®åºæ¯websocket-æ¯æä¹å»éç">çå®åºæ¯ï¼WebSocket æ¯æä¹å»éçï¼</h3>
<p>æ¥çç WebSocket æ¶å°äºä»¶ååäºä»ä¹ï¼<code>FeishuEventMessageHandler.cs#104-147</code>ï¼ï¼</p>
<pre><code class="language-csharp">// 1. å»éæ£æ¥
bool isProcessing = false;

if (_options.EnableDistributedDeduplication &amp;&amp; _distributedDeduplicator != null)
{
    // ä¼åä½¿ç¨åå¸å¼å»éï¼Redisï¼
    isProcessing = await _distributedDeduplicator.TryMarkAsProcessedAsync(
        eventData.EventId, 
        cancellationToken: cancellationToken);
}
else if (_options.EnableEventDeduplication &amp;&amp; _deduplicator != null)
{
    // ä½¿ç¨åå­å»é
    isProcessing = _deduplicator.TryMarkAsProcessing(eventData.EventId);
}

// 2. è·³è¿å·²å¤çäºä»¶
if (isProcessing)
{
    _logger.LogDebug("äºä»¶ {EventId} å·²å¨å¤çä¸­æå·²å¤çï¼è·³è¿", eventData.EventId);
    return;
}

// 3. å¤çäºä»¶
try
{
    await _eventHandlerFactory.HandleEventParallelAsync(
        eventData.EventType, 
        eventData, 
        cancellationToken);

    // 4. å¤çæåï¼æ è®°ä¸ºå·²å®æ
    if (_options.EnableEventDeduplication &amp;&amp; _deduplicator != null)
    {
        _deduplicator.MarkAsCompleted(eventData.EventId);
    }
}
catch (Exception ex)
{
    // 5. å¤çå¤±è´¥ï¼åæ»ç¶æ
    if (_options.EnableEventDeduplication &amp;&amp; _deduplicator != null)
    {
        _deduplicator.RollbackProcessing(eventData.EventId);
    }
    throw;
}
</code></pre>
<h3 id="æ¹æ¡ä¸åå­å»ééåå¼ååå°è§æ¨¡åºç¨">æ¹æ¡ä¸ï¼åå­å»éï¼éåå¼ååå°è§æ¨¡åºç¨ï¼</h3>
<p><strong>å°±åå¨å¤§èéè®°ç¬è®°</strong>ï¼ææ¯ä¸ªäºä»¶IDè®°å¨åå­éï¼æ¶å°æ°äºä»¶æ¶åæ¥æ¥ç¬è®°ï¼å¦ææå°±è·³è¿ã</p>
<p><strong>ç¹ç¹</strong>ï¼</p>
<ul>
<li>ð§  <strong>å¨é èå­è®°</strong>ï¼æææ°æ®å­å¨åå­é</li>
<li>â° <strong>è®°24å°æ¶</strong>ï¼è¶è¿æ¶é´å°±èªå¨å¿æ</li>
<li>ð§¹ <strong>å®æææ«</strong>ï¼æ¯5åéæ¸çä¸æ¬¡è¿æçè®°å½</li>
<li>â±ï¸ <strong>è¶æ¶ä¿æ¤</strong>ï¼å¤çè¶è¿5åéè¿æ²¡å®æï¼å°±åè®¸éè¯</li>
</ul>
<p><strong>æ ¸å¿ä»£ç </strong>ï¼<code>FeishuEventDeduplicator.cs#86-135</code>ï¼ï¼</p>
<pre><code class="language-csharp">public bool TryMarkAsProcessing(string eventId)
{
    lock (_lock)
    {
        // æ£æ¥æ¯å¦å·²å­å¨
        if (_eventCache.TryGetValue(eventId, out var entry))
        {
            // å¦æå·²å¤çï¼è¿å trueï¼è·³è¿ï¼
            if (entry.Status == DeduplicationStatus.Completed)
                return true;

            // å¦æå·²å¨å¤çä¸­ï¼æ£æ¥æ¯å¦è¶æ¶
            if (entry.Status == DeduplicationStatus.Processing)
            {
                if (DateTimeOffset.UtcNow - entry.ProcessedAt &gt; _processingTimeout)
                {
                    // å¤çä¸­è¶æ¶ï¼åè®¸éæ°å¤ç
                    _logger?.LogWarning("äºä»¶ {EventId} å¤çä¸­è¶æ¶ï¼åè®¸éæ°å¤ç", eventId);
                    _eventCache.Remove(eventId);
                    // ç»§ç»­å¤ç
                }
                else
                {
                    // ä»å¨å¤çä¸­ï¼è·³è¿
                    return true;
                }
            }
        }

        // æ è®°ä¸ºå¤çä¸­
        _eventCache[eventId] = new EventCacheEntry
        {
            ProcessedAt = DateTimeOffset.UtcNow,
            EventId = eventId,
            Status = DeduplicationStatus.Processing
        };

        return false; // æªå¤çï¼æ°äºä»¶
    }
}
</code></pre>
<h3 id="æ¹æ¡äºredis-åå¸å¼å»éçäº§ç¯å¢é¦é">æ¹æ¡äºï¼Redis åå¸å¼å»éï¼çäº§ç¯å¢é¦éï¼</h3>
<p><strong>å°±åå±äº«ç¬è®°æ¬</strong>ï¼ç¨ Redis æå»éè®°å½è®°å¨å¤é¨ï¼ææå®ä¾é½è½æ¥å°ãå°±ç®éå¯æå¡ï¼ç¬è®°æ¬è¿å¨ï¼ä¸ä¼å¿è®°ã</p>
<p><strong>ç¹ç¹</strong>ï¼</p>
<ul>
<li>ð <strong>åå¨å±äº«ç¬è®°æ¬ä¸</strong>ï¼ææå®ä¾ä¸èµ·ç</li>
<li>ð <strong>èªå¨ç¿»é¡µ</strong>ï¼å°æèªå¨æ¸çï¼ä¸ç¨ç®¡</li>
<li>ð¤ <strong>å¤§å®¶ä¸èµ·ç¨</strong>ï¼å¤å®ä¾é¨ç½²æ²¡é®é¢</li>
<li>â¡ <strong>åå­æä½</strong>ï¼SETNX + EXPIRE ç¡®ä¿ä¸ä¼åé</li>
</ul>
<p><strong>æ ¸å¿ä»£ç </strong>ï¼<code>RedisFeishuEventDistributedDeduplicator.cs#53-89</code>ï¼ï¼</p>
<pre><code class="language-csharp">public async Task&lt;bool&gt; TryMarkAsProcessedAsync(
    string eventId, 
    TimeSpan? ttl = null, 
    CancellationToken cancellationToken = default)
{
    var actualTtl = ttl ?? _defaultCacheExpiration;
    var redisKey = $"{_keyPrefix}{eventId}";

    // ä½¿ç¨ SETNX + EXPIRE å®ç°åå­æ§å»é
    // ä»å½é®ä¸å­å¨æ¶è®¾ç½®ï¼å¹¶è®¾ç½®è¿ææ¶é´
    var setResult = await _database.StringSetAsync(
        redisKey,
        "1",
        actualTtl,
        When.NotExists);

    if (!setResult)
    {
        _logger?.LogDebug("äºä»¶ {EventId} å·²å¤çè¿ï¼è·³è¿", eventId);
        return true; // å·²å¤ç
    }

    _logger?.LogDebug("äºä»¶ {EventId} æ è®°ä¸ºå·²å¤çï¼TTL: {Ttl}", eventId, actualTtl);
    return false; // æªå¤çï¼æ°äºä»¶
}
</code></pre>
<h3 id="ä¸¤ç§æ¹æ¡æä¹é">ä¸¤ç§æ¹æ¡æä¹éï¼</h3>
<table>
<thead>
<tr>
<th>å¯¹æ¯é¡¹</th>
<th>åå­å»éï¼èªå·±è®°ï¼</th>
<th>Redis å»éï¼å±äº«ç¬è®°æ¬ï¼</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>éåº¦</strong></td>
<td>â¡ åéªçµä¸æ ·å¿«ï¼ç´æ¥è¯»åå­ï¼</td>
<td>ð å¾å¿«ï¼ä½éè¦ç½ç»ï¼</td>
</tr>
<tr>
<td><strong>å¯é æ§</strong></td>
<td>â ï¸ éå¯å°±å¿å</td>
<td>â æ°¸è¿è®°çï¼éå¯ä¹è¿å¨</td>
</tr>
<tr>
<td><strong>å¤å®ä¾</strong></td>
<td>â æ¯ä¸ªäººåè®°åç</td>
<td>â å¤§å®¶ä¸èµ·çåä¸æ¬ç¬è®°</td>
</tr>
<tr>
<td><strong>éº»ç¦ç¨åº¦</strong></td>
<td>ð¢ é¶ä¾èµï¼å¼ç®±å³ç¨</td>
<td>ð¡ éè¦é¨ç½² Redis</td>
</tr>
<tr>
<td><strong>éåè°</strong></td>
<td>ð  å¼åç¯å¢ãåæºè¿è¡</td>
<td>ð¢ çäº§ç¯å¢ãå¤å®ä¾é¨ç½²</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="åè®®å±æ¶æ¯çæéå·æ£æ¥">åè®®å±ï¼æ¶æ¯ç"æéå·æ£æ¥"</h2>
<h3 id="websocket-ç-seqid-æ¯ä»ä¹">WebSocket ç SeqID æ¯ä»ä¹ï¼</h3>
<p>é£ä¹¦ WebSocket ç¨çæ¯ ProtoBuf äºè¿å¶åè®®ï¼æ¯æ¡æ¶æ¯é½å¸¦çä¸ä¸ª<strong>éå¢çåºå·</strong>ï¼å°±åå»é¶è¡åäºæ¿çæéå·ãéè¿è®°ä½å·²ç»å¤çè¿çæéå·ï¼å°±è½å¨æ¶æ¯å±é¢å°±æéå¤çæ¡å¨å¤é¢ã</p>
<h4 id="seqid-å»éæä¹å·¥ä½">SeqID å»éæä¹å·¥ä½ï¼</h4>
<pre><code class="language-csharp">public interface IFeishuSeqIDDeduplicator
{
    /// &lt;summary&gt;
    /// å°è¯æ è®° SeqID ä¸ºå·²å¤ç
    /// &lt;/summary&gt;
    /// &lt;returns&gt;
    /// true: å·²å¤çè¿ï¼è·³è¿ï¼
    /// false: æ°æ¶æ¯ï¼ç»§ç»­å¤çï¼
    /// &lt;/returns&gt;
    bool TryMarkAsProcessed(ulong seqId);

    /// &lt;summary&gt;
    /// æ£æ¥ SeqID æ¯å¦å·²å¤ç
    /// &lt;/summary&gt;
    bool IsProcessed(ulong seqId);

    /// &lt;summary&gt;
    /// å¼æ­¥æ£æ¥ SeqID æ¯å¦å·²å¤ç
    /// &lt;/summary&gt;
    Task&lt;bool&gt; IsProcessedAsync(ulong seqId);

    /// &lt;summary&gt;
    /// æ¸ç©ºç¼å­
    /// &lt;/summary&gt;
    void ClearCache();

    /// &lt;summary&gt;
    /// è·åç¼å­ä¸­ç SeqID æ°é
    /// &lt;/summary&gt;
    int GetCacheCount();

    /// &lt;summary&gt;
    /// è·åå·²å¤ççæå¤§ SeqID
    /// &lt;/summary&gt;
    ulong GetMaxProcessedSeqId();
}
</code></pre>
<h4 id="å®ç°æºå¶">å®ç°æºå¶</h4>
<div class="mermaid">graph LR
    A[æ¶å°ProtoBufæ¶æ¯] --&gt; B{SeqIDæ£æ¥}
    B --&gt;|å·²å¤ç| C[è·³è¿æ¶æ¯]
    B --&gt;|æªå¤ç| D[è®°å½SeqID]
    D --&gt; E[å¤çæ¶æ¯]
    E --&gt; F[åéACKç¡®è®¤]
    D --&gt; G[æ´æ°æå¤§SeqID]
    G --&gt; H[å®æ¶æ¸çè¿æSeqID]
</div><h4 id="æ ¸å¿å®ç°">æ ¸å¿å®ç°</h4>
<p><strong>åå­å®ç°</strong>ï¼<code>FeishuSeqIDDeduplicator.cs</code>ï¼ï¼</p>
<pre><code class="language-csharp">public bool TryMarkAsProcessed(ulong seqId)
{
    lock (_lock)
    {
        // æ£æ¥æ¯å¦å·²å­å¨
        if (_processedSeqIds.Contains(seqId))
        {
            _logger?.LogDebug("SeqID {SeqId} å·²å¤çè¿ï¼è·³è¿", seqId);
            return true; // å·²å¤ç
        }

        // è®°å½æ° SeqID
        _processedSeqIds.Add(seqId);
        _seqIdTimestamps[seqId] = DateTimeOffset.UtcNow;

        // æ´æ°æå¤§ SeqID
        if (seqId &gt; _maxProcessedSeqId)
        {
            _maxProcessedSeqId = seqId;
        }

        return false; // æªå¤çï¼æ°æ¶æ¯
    }
}
</code></pre>
<p><strong>ä½¿ç¨ä½ç½®</strong>ï¼<code>BinaryMessageProcessor.cs#186-194</code>ï¼ï¼</p>
<pre><code class="language-csharp">// SeqID å»éæ£æ¥
if (_seqIdDeduplicator != null &amp;&amp; _seqIdDeduplicator.TryMarkAsProcessed(frame.SeqID))
{
    _logger.LogDebug("SeqID {SeqID} å·²å¤çè¿ï¼è·³è¿", frame.SeqID);
    eventArgs.SkipReason = $"SeqID {frame.SeqID} å·²å¤çè¿";
    BinaryMessageReceived?.Invoke(this, eventArgs);
    
    // ä»ç¶åéACKç¡®è®¤
    await SendAckMessageAsync(frame, true, cancellationToken);
    return;
}
</code></pre>
<h4 id="ç¹æ§æ»ç»">ç¹æ§æ»ç»</h4>
<ul>
<li>â <strong>åºäº HashSet é«ææ¥æ¾</strong>ï¼O(1) æ¥è¯¢å¤æåº¦</li>
<li>â <strong>èªå¨è·è¸ªæå¤§ SeqID</strong>ï¼æ¯æé¡ºåºæ§éªè¯</li>
<li>â <strong>24å°æ¶è¿ææºå¶</strong>ï¼å®ææ¸çåå²æ°æ®</li>
<li>â <strong>åå­åå¥½</strong>ï¼ä»å­å¨ SeqIDï¼ä¸å­å¨å®æ´æ¶æ¯</li>
</ul>
<h3 id="webhook-ç-nonceé²éæ¾æ»å»çç§å¯æ­¦å¨">Webhook ç Nonceï¼é²éæ¾æ»å»çç§å¯æ­¦å¨</h3>
<p>é£ä¹¦ Webhook çè¯·æ±éå¸¦æä¸ä¸ª <code>nonce</code>ï¼éæºæ°ï¼ï¼è¿å°±åä¸æ¬¡æ§å¯ç ââç¨è¿çå¯ç å°±ä¸è½åç¨äºï¼è¿æ ·å°±è½é²æ­¢"éæ¾æ»å»"ï¼åäººæ¿åä¸ä¸ªè¯·æ±éå¤åéï¼ã</p>
<h4 id="é²éæ¾æ»å»æµç¨">é²éæ¾æ»å»æµç¨</h4>
<pre><code>æ»å»èå°è¯éæ¾è¯·æ±ï¼
âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ
åå§è¯·æ±ï¼Nonce="abc123", Timestamp="1234567890"
â æ­£å¸¸å¤çï¼é¦æ¬¡æ¥æ¶ï¼

éæ¾è¯·æ±ï¼Nonce="abc123", Timestamp="1234567890"
â æç»å¤çï¼Nonce å·²è®°å½ï¼
âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ
</code></pre>
<h4 id="redis-å®ç°">Redis å®ç°</h4>
<pre><code class="language-csharp">public class RedisFeishuNonceDistributedDeduplicator : IFeishuNonceDistributedDeduplicator
{
    private readonly IDatabase _database;
    private readonly TimeSpan _defaultTtl = TimeSpan.FromMinutes(5); // 5åéè¿æ

    public async Task&lt;bool&gt; TryMarkAsProcessedAsync(string nonce, CancellationToken cancellationToken = default)
    {
        var redisKey = $"{_keyPrefix}{nonce}";

        // SETNX + EXPIREï¼5åéåéå¤ nonce ä¼è¢«æç»
        var setResult = await _database.StringSetAsync(
            redisKey,
            "1",
            _defaultTtl,
            When.NotExists);

        if (!setResult)
        {
            _logger?.LogWarning("æ£æµå°éå¤ç Nonce: {Nonce}ï¼å¯è½ä¸ºéæ¾æ»å»", nonce);
            return true; // å·²å¤çï¼æç»
        }

        return false; // é¦æ¬¡å¤ç
    }
}
</code></pre>
<hr>
<h2 id="åºç¨å±ç»æ¯ä¸ªä¸å¡æä½åèº«ä»½è¯">åºç¨å±ï¼ç»æ¯ä¸ªä¸å¡æä½å"èº«ä»½è¯"</h2>
<h3 id="ä¸ºä»ä¹è¿éè¦è¿ä¸å±">ä¸ºä»ä¹è¿éè¦è¿ä¸å±ï¼</h3>
<p>å°±ç®åé¢ä¸¤å±é½æ¡ä½äºï¼ä¸å¡é»è¾è¿æ¯æå¯è½éå¤æ§è¡ï¼æ¯å¦ï¼</p>
<ul>
<li>ð åä¸äºä»¶è§¦åäºå¤ä¸ªå¤çå¨ï¼å¹¶è¡å¤çï¼</li>
<li>ð å¤çå¨åé¨å¤æ¬¡è®¿é®åä¸ä¸ªèµæº</li>
<li>ð¡ ç¬¬ä¸æ¹æ¥å£éè¯å¯¼è´éå¤è°ç¨</li>
</ul>
<h3 id="å®éçå¹ç­æ§å®ç°æ¹å¼">å®éçå¹ç­æ§å®ç°æ¹å¼</h3>
<p>å¨å®éç Mud.Feishu SDK ä¸­ï¼ä¸å¡å±å¹ç­æ§ä¸»è¦éè¿ä»¥ä¸ä¸¤ç§æ¹å¼å®ç°ï¼</p>
<p><strong>æ¹å¼1ï¼ä½¿ç¨ <code>DefaultFeishuObjectEventHandler&lt;T&gt;</code>ï¼æ¨èï¼</strong><br>
SDK æä¾äº <code>DefaultFeishuObjectEventHandler&lt;T&gt;</code> åºç±»ï¼ä¸é¨ç¨äºå¤çå¯¹è±¡ç±»åçäºä»¶ãä½ åªéè¦ç»§æ¿è¿ä¸ªåºç±»ï¼å¹¶å¨ä¸å¡é»è¾ä¸­æ£æ¥æ°æ®æ¯å¦å·²å­å¨å³å¯ã</p>
<p><strong>æ¹å¼2ï¼ä½¿ç¨ <code>IdempotentFeishuEventHandler&lt;T&gt;</code></strong><br>
SDK è¿æä¾äºä¸ä¸ª <code>IdempotentFeishuEventHandler&lt;T&gt;</code> åºç±»ï¼æä¾äºåºäºä¸å¡é®çèªå¨å»éè½åãä½ éè¦éå <code>GetBusinessKey()</code> æ¹æ³å <code>HandleEventInternalAsync()</code> æ¹æ³ï¼åºç±»ä¼èªå¨å¤çä¸å¡å»éã</p>
<hr>
<h3 id="ææææä½ ç¨ä¸ä¸ªå®éæ¡ä¾">ææææä½ ç¨ï¼ä¸ä¸ªå®éæ¡ä¾</h3>
<h4 id="æ¡ä¾-1æ¶æ¯å¤çé²æ­¢éå¤åå»ºå¾å">æ¡ä¾ 1ï¼æ¶æ¯å¤çââé²æ­¢éå¤åå»ºå¾å</h4>
<pre><code class="language-csharp">public class MessageEventHandler : DefaultFeishuObjectEventHandler&lt;MessageReceiveResult&gt;
{
    private readonly IMessageService _messageService;

    public MessageEventHandler(
        ILogger&lt;MessageEventHandler&gt; logger,
        IMessageService messageService)
        : base(logger)
    {
        _messageService = messageService;
    }

    protected override async Task ProcessBusinessLogicAsync(
        EventData eventData,
        ObjectEventResult&lt;MessageReceiveResult&gt;? messageData,
        CancellationToken cancellationToken = default)
    {
        if (eventData == null)
            throw new ArgumentNullException(nameof(eventData));

        // æ£æ¥æ¶æ¯æ¯å¦å·²å¤çï¼ä¸å¡å±å¹ç­æ§ï¼
        var messageId = messageData?.Object.MessageId;
        if (string.IsNullOrEmpty(messageId))
        {
            _logger.LogWarning("æ¶æ¯IDä¸ºç©ºï¼è·³è¿å¤ç");
            return;
        }

        var alreadyProcessed = await _messageService.IsMessageProcessedAsync(messageId, cancellationToken);
        if (alreadyProcessed)
        {
            _logger.LogInformation("æ¶æ¯ {MessageId} å·²å¤çï¼è·³è¿", messageId);
            return;
        }

        // å¤çæ¶æ¯
        await _messageService.ProcessMessageAsync(messageData!.Object, cancellationToken);
    }
}
</code></pre>
<h4 id="æ¡ä¾-2é¨é¨å¤çé¿åéå¤åå»º">æ¡ä¾ 2ï¼é¨é¨å¤çââé¿åéå¤åå»º</h4>
<pre><code class="language-csharp">public class DepartmentCreatedEventHandler : DefaultFeishuObjectEventHandler&lt;DepartmentCreatedResult&gt;
{
    private readonly IDepartmentService _departmentService;

    public DepartmentCreatedEventHandler(
        ILogger&lt;DepartmentCreatedEventHandler&gt; logger,
        IDepartmentService departmentService)
        : base(logger)
    {
        _departmentService = departmentService;
    }

    protected override async Task ProcessBusinessLogicAsync(
        EventData eventData,
        ObjectEventResult&lt;DepartmentCreatedResult&gt;? departmentData,
        CancellationToken cancellationToken = default)
    {
        if (eventData == null)
            throw new ArgumentNullException(nameof(eventData));

        if (departmentData?.Object == null)
        {
            _logger.LogWarning("é¨é¨æ°æ®ä¸ºç©ºï¼è·³è¿å¤ç");
            return;
        }

        // æ£æ¥é¨é¨æ¯å¦å·²å­å¨ï¼ä¸å¡å±å¹ç­æ§ï¼
        var departmentId = departmentData.Object.DepartmentId;
        var exists = await _departmentService.ExistsAsync(departmentId, cancellationToken);

        if (exists)
        {
            _logger.LogInformation("é¨é¨ {DepartmentId} å·²å­å¨ï¼è·³è¿åå»º", departmentId);
            return;
        }

        // åå»ºé¨é¨
        await _departmentService.CreateAsync(departmentData.Object, cancellationToken);
    }
}
</code></pre>
<h4 id="æ¡ä¾-3ç¨æ·åå»ºé¿åéå¤æ³¨å">æ¡ä¾ 3ï¼ç¨æ·åå»ºââé¿åéå¤æ³¨å</h4>
<pre><code class="language-csharp">public class UserCreatedEventHandler : DefaultFeishuObjectEventHandler&lt;UserCreatedResult&gt;
{
    private readonly IUserService _userService;

    public UserCreatedEventHandler(
        ILogger&lt;UserCreatedEventHandler&gt; logger,
        IUserService userService)
        : base(logger)
    {
        _userService = userService;
    }

    protected override async Task ProcessBusinessLogicAsync(
        EventData eventData,
        ObjectEventResult&lt;UserCreatedResult&gt;? userData,
        CancellationToken cancellationToken = default)
    {
        if (eventData == null)
            throw new ArgumentNullException(nameof(eventData));

        if (userData?.Object == null)
        {
            _logger.LogWarning("ç¨æ·æ°æ®ä¸ºç©ºï¼è·³è¿å¤ç");
            return;
        }

        // æ£æ¥ç¨æ·æ¯å¦å·²å­å¨ï¼ä¸å¡å±å¹ç­æ§ï¼
        var userId = userData.Object.UserId;
        var exists = await _userService.ExistsAsync(userId, cancellationToken);

        if (exists)
        {
            _logger.LogInformation("ç¨æ· {UserId} å·²å­å¨ï¼è·³è¿åå»º", userId);
            return;
        }

        // åå»ºç¨æ·
        await _userService.CreateAsync(userData.Object, cancellationToken);
    }
}
</code></pre>
<h3 id="æä¹è®¾è®¡ä¸å¡é®æå¥è·¯å">æä¹è®¾è®¡ä¸å¡é®ï¼æå¥è·¯åï¼</h3>
<table>
<thead>
<tr>
<th>ä¸å¡åºæ¯</th>
<th>ä¸å¡é®é¿ä»ä¹æ ·ï¼</th>
<th>ä¸ºä»ä¹è¿ä¹è®¾è®¡ï¼</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ¶å°æ¶æ¯</td>
<td><code>im.message.receive_v1:om_xxxxxxxxxx</code></td>
<td>äºä»¶ç±»å + æ¶æ¯IDï¼ä¸ç¼çåºæ¯åªæ¡æ¶æ¯</td>
</tr>
<tr>
<td>åå»ºé¨é¨</td>
<td><code>contact.department.created_v3:od_xxxxxxxxxx</code></td>
<td>äºä»¶ç±»å + é¨é¨IDï¼é¿ååå¶ä»IDå²çª</td>
</tr>
<tr>
<td>åå»ºç¨æ·</td>
<td><code>contact.user.created_v3:ou_xxxxxxxxxx</code></td>
<td>äºä»¶ç±»å + ç¨æ·IDï¼å¯ä¸æ è¯ç¨æ·</td>
</tr>
<tr>
<td>å é¤é¨é¨</td>
<td><code>contact.department.deleted_v3:od_xxxxxxxxxx</code></td>
<td>äºä»¶ç±»å + é¨é¨IDï¼å¤çå é¤äºä»¶</td>
</tr>
<tr>
<td>æ¶æ¯å·²è¯»</td>
<td><code>im.message.message_read_v1:ou_xxxxxxxxxx:om_xxxxxxxxxx</code></td>
<td>äºä»¶ç±»å + ç¨æ·ID + æ¶æ¯ID</td>
</tr>
</tbody>
</table>
<p><strong>åæ¡é»éæ³å</strong>ï¼</p>
<ol>
<li>ð <strong>å¯ä¸æ§</strong>ï¼ä¸ä¸ªæä½å¯¹åºä¸ä¸ªé®ï¼ä¸è½æä¸¤ä¸ªæä½æè½¦</li>
<li>ð <strong>å¯è¯»æ§</strong>ï¼çæ¥å¿æ¶è½å¿«éç¥éè¿æ¯ä»ä¹</li>
<li>ð§± <strong>ç¨³å®æ§</strong>ï¼å«ç¨æ¶é´æ³è¿ç§ä¼åçå­æ®µåé®</li>
<li>âï¸ <strong>ç®æ´æ§</strong>ï¼å«åå¤ªé¿ï¼çåå­ãå¥½æ¥è¯¢</li>
</ol>
<hr>
<h2 id="éç½®å®æå¼å-vs-çäº§ç¯å¢">éç½®å®æï¼å¼å vs çäº§ç¯å¢</h2>
<h3 id="websocket-æä¹éç½®">WebSocket æä¹éç½®ï¼</h3>
<pre><code class="language-csharp">// ä½¿ç¨å»ºé èæ¨¡å¼éç½® WebSocket
builder.Services.AddFeishuWebSocketServiceBuilder(configuration)
    .ConfigureOptions(options =&gt;
    {
        // äºä»¶å»ééç½®
        options.EnableEventDeduplication = true;           // å¯ç¨äºä»¶å»é
        options.EnableDistributedDeduplication = false;    // åæºåºæ¯ä½¿ç¨åå­å»é
        options.EventDeduplicationCacheExpirationMs = 86400000;  // 24å°æ¶è¿æ
        options.EventDeduplicationCleanupIntervalMs = 300000;    // 5åéæ¸çé´é
    });
</code></pre>
<h4 id="çäº§ç¯å¢å¿å¤éç½®ä¸å®è¦ç">çäº§ç¯å¢å¿å¤éç½®ï¼ä¸å®è¦çï¼ï¼</h4>
<pre><code class="language-csharp">// 1. éç½® Redisï¼å¨ appsettings.json ä¸­ï¼
// {
//   "Feishu": {
//     "Redis": {
//       "ConnectionString": "your-redis-server"
//     }
//   }
// }

// 2. æ³¨å Redis æå¡åå»éæå¡
builder.Services
    .AddFeishuRedis()
    .AddFeishuRedisDeduplicators();

// 3. å¯ç¨åå¸å¼å»é
builder.Services.AddFeishuWebSocketServiceBuilder(configuration)
    .ConfigureOptions(options =&gt;
    {
        options.EnableDistributedDeduplication = true;   // å¯ç¨åå¸å¼å»é
        options.EventDeduplicationCacheExpirationMs = 86400000;  // 24å°æ¶
    });
</code></pre>
<h3 id="webhook-éç½®">Webhook éç½®</h3>
<pre><code class="language-csharp">// æ³¨å Webhook æå¡
builder.Services.AddFeishuWebhookServiceBuilder(configuration)
    .ConfigureOptions(options =&gt;
    {
        options.VerificationToken = "your_verification_token";
        options.EncryptKey = "your_encrypt_key";
        options.EventHandlingTimeoutMs = 30000;          // 30ç§è¶æ¶
        options.MaxConcurrentEvents = 10;                // æå¤§å¹¶åæ°
    });

// æ³¨å Redis å»é
builder.Services
    .AddFeishuRedis()
    .AddFeishuRedisEventDeduplicator();
</code></pre>
<h3 id="ä¸å¼ è¡¨çæå¼åä¸çäº§çåºå«">ä¸å¼ è¡¨çæå¼åä¸çäº§çåºå«</h3>
<table>
<thead>
<tr>
<th>éç½®é¡¹</th>
<th>å¼åç¯å¢</th>
<th>çäº§ç¯å¢</th>
<th>è¯´æ</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>EnableEventDeduplication</code></td>
<td><code>true</code></td>
<td><code>true</code></td>
<td>å§ç»å¯ç¨åå­å»é</td>
</tr>
<tr>
<td><code>EnableDistributedDeduplication</code></td>
<td><code>false</code></td>
<td><code>true</code></td>
<td>çäº§ç¯å¢å¯ç¨Rediså»é</td>
</tr>
<tr>
<td><code>EventDeduplicationCacheExpirationMs</code></td>
<td><code>3600000</code> (1å°æ¶)</td>
<td><code>86400000</code> (24å°æ¶)</td>
<td>çäº§ç¯å¢å»¶é¿çªå£æ</td>
</tr>
<tr>
<td><code>EventDeduplicationCleanupIntervalMs</code></td>
<td><code>60000</code> (1åé)</td>
<td><code>300000</code> (5åé)</td>
<td>çäº§ç¯å¢éä½æ¸çé¢ç</td>
</tr>
</tbody>
</table>
<h3 id="å®æ´éç½®ä»é¶å°ä¸çº¿ä¸æ¬¡æå®">å®æ´éç½®ï¼ä»é¶å°ä¸çº¿ä¸æ¬¡æå®</h3>
<pre><code class="language-csharp">public void ConfigureServices(IServiceCollection services)
{
    // éç½® Redisï¼appsettings.json ä¸­éç½®ï¼
    services
        .AddFeishuRedis()
        .AddFeishuRedisDeduplicators();

    // æ³¨å WebSocket æå¡
    services.AddFeishuWebSocketServiceBuilder(configuration)
        .ConfigureOptions(wsOptions =&gt;
        {
            wsOptions.EnableEventDeduplication = true;
            wsOptions.EnableDistributedDeduplication = true;
            wsOptions.EventDeduplicationCacheExpirationMs = 86400000;
            wsOptions.AutoReconnect = true;
            wsOptions.MaxReconnectAttempts = 5;
            wsOptions.HeartbeatIntervalMs = 30000;
        })
        .AddHandler&lt;MessageEventHandler&gt;()
        .AddHandler&lt;DepartmentCreatedEventHandler&gt;()
        .Build();

    // æ³¨å Webhook æå¡
    services.AddFeishuWebhookServiceBuilder(configuration)
        .ConfigureOptions(webhookOptions =&gt;
        {
            webhookOptions.VerificationToken = "your_token";
            webhookOptions.EncryptKey = "your_key";
            webhookOptions.EventHandlingTimeoutMs = 30000;
            webhookOptions.MaxConcurrentEvents = 20;
        })
        .AddHandler&lt;UserCreatedEventHandler&gt;()
        .Build();
}
</code></pre>
<h3 id="è¿æä¸ªè´´å¿åè½éç½®éè¯¯èªå¨æé">è¿æä¸ªè´´å¿åè½ï¼éç½®éè¯¯èªå¨æé</h3>
<p>SDK ä¼èªå¨æ£æ¥éç½®ï¼å¦æä½ æå»éåè½å¨å³äºï¼å®ä¼ç´æ¥æ¥éæéä½ ï¼</p>
<pre><code class="language-csharp">// FeishuWebSocketOptions.Validate() èªå¨æ§è¡
// SDK ä¼å¨æå¡å¯å¨æ¶æ£æ¥éç½®ï¼å¦æå»éåè½å¨å³é­ä¼æåºè­¦å
</code></pre>
<hr>
<h2 id="è¸©åæåäºä¸ªå¸¸è§é®é¢åè§£å³æ¹æ¡">è¸©åæåï¼äºä¸ªå¸¸è§é®é¢åè§£å³æ¹æ¡</h2>
<h3 id="é®é¢-1æå¡éå¯éå¤äºä»¶åæ¥äº">é®é¢ 1ï¼æå¡éå¯ï¼éå¤äºä»¶åæ¥äº</h3>
<p><strong>ç°åºæ¯è¿æ ·ç</strong>ï¼</p>
<p><strong>ç°è±¡</strong>ï¼</p>
<pre><code>09:00 æå¡æ¥æ¶ EventId="evt_123" â å¤çæå
09:05 æå¡éå¯ï¼åå­ç¼å­æ¸ç©ºï¼
09:06 é£ä¹¦éå EventId="evt_123" â éå¤å¤ç
</code></pre>
<p><strong>ä¸ºä»ä¹ï¼</strong></p>
<ul>
<li>ð§  åå­å»éå°±åç­æè®°å¿ï¼éå¯å°±å¿åäº</li>
<li>ð¡ é£ä¹¦æ²¡æ¶å°ä½ çç¡®è®¤ï¼ä»¥ä¸ºä½ æ²¡æ¶å°ï¼ç»§ç»­å</li>
</ul>
<p><strong>æä¹è§£å³ï¼</strong></p>
<p>â <strong>æ¹æ¡1ï¼å¯ç¨ Redis åå¸å¼å»éï¼æ¨èï¼</strong></p>
<pre><code class="language-csharp">// éç½® Redisï¼appsettings.json ä¸­éç½®è¿æ¥ä¿¡æ¯ï¼
services
    .AddFeishuRedis()
    .AddFeishuRedisDeduplicators();

services.AddFeishuWebSocketServiceBuilder(configuration)
    .ConfigureOptions(options =&gt;
    {
        options.EnableDistributedDeduplication = true; // ä½¿ç¨Redis
        options.EnableEventDeduplication = false;    // ç¦ç¨åå­å»é
    });
</code></pre>
<p>â <strong>æ¹æ¡2ï¼å®ç°å»éç¶ææä¹å</strong></p>
<pre><code class="language-csharp">public class PersistentEventDeduplicator : IFeishuEventDeduplicator
{
    private readonly IDatabase _database;

    public bool TryMarkAsProcessing(string eventId)
    {
        // å°è¯åå¥æ°æ®åº
        var exists = _database.EventExists(eventId);
        if (!exists)
        {
            _database.MarkProcessing(eventId);
            return false;
        }
        return true;
    }
}
</code></pre>
<hr>
<h3 id="é®é¢-2å¤å®ä¾ä¸èµ·è·éå¤å¤çæ¡ä¸ä½">é®é¢ 2ï¼å¤å®ä¾ä¸èµ·è·ï¼éå¤å¤çæ¡ä¸ä½</h3>
<p><strong>ç°åºæ¯è¿æ ·ç</strong>ï¼</p>
<pre><code>å®ä¾A å å®ä¾B åæ¶å¯å¨
é£ä¹¦æ¨é EventId="evt_123"
å®ä¾A æ¶å° â å¤ç â
å®ä¾B æ¶å° â å¤ç â (éå¤ï¼)
</code></pre>
<p><strong>ä¸ºä»ä¹ï¼</strong></p>
<ul>
<li>ð§  æ¯ä¸ªå®ä¾é½æèªå·±ç¬ç«ç"å°æ¬æ¬"</li>
<li>ð« å®ä¾ä¹é´äºç¸çä¸å°å¯¹æ¹çè®°å½</li>
</ul>
<p><strong>æä¹è§£å³ï¼</strong></p>
<p>â <strong>å¿é¡»ä½¿ç¨ Redis åå¸å¼å»é</strong></p>
<pre><code class="language-csharp">// ææå®ä¾è¿æ¥å°åä¸ä¸ª Redisï¼å¨éç½®æä»¶ä¸­éç½®ï¼
services
    .AddFeishuRedis()
    .AddFeishuRedisDeduplicators();

services.AddFeishuWebSocketServiceBuilder(configuration)
    .ConfigureOptions(options =&gt;
    {
        options.EnableDistributedDeduplication = true;
    });
</code></pre>
<p><strong>ä¸å¼ å¾çæåºå«</strong>ï¼</p>
<div class="mermaid">graph TB
    subgraph Wrong["â éè¯¯æ¶æï¼åå­å»éï¼"]
        A1["å®ä¾A&lt;br/&gt;åå­ç¼å­A&lt;br/&gt;evt_123 â"]
        A2["å®ä¾B&lt;br/&gt;åå­ç¼å­B&lt;br/&gt;evt_123 â"]
    end

    subgraph Right["â æ­£ç¡®æ¶æï¼Rediså»éï¼"]
        B1["å®ä¾A"]
        B2["å®ä¾B"]
        Redis["Redis å»é&lt;br/&gt;evt_123 â"]
    end

    B1 --&gt; Redis
    B2 --&gt; Redis

    style Wrong fill:#ffebee
    style Right fill:#e8f5e9
    style Redis fill:#e3f2fd
</div><hr>
<h3 id="é®é¢-3å¤çè¶æ¶éå¤äºä»¶è¶èèå¥">é®é¢ 3ï¼å¤çè¶æ¶ï¼éå¤äºä»¶è¶èèå¥</h3>
<p><strong>ç°åºæ¯è¿æ ·ç</strong>ï¼</p>
<pre><code>09:00 å¼å§å¤ç EventId="evt_123"
09:01 å¤çè¶æ¶ï¼è¶æ¶30ç§ï¼
09:01 åæ» Processing ç¶æ
09:02 é£ä¹¦éå EventId="evt_123"
09:02 éå¤å¤ç â (å®éå·²æåï¼)
</code></pre>
<p><strong>ä¸ºä»ä¹ï¼</strong></p>
<ul>
<li>â±ï¸ è¶æ¶åç³»ç»ä»¥ä¸ºæ²¡å®æï¼æ"å¤çä¸­"æ è®°æ¤åäº</li>
<li>â ä½ä¸å¡å¯è½å·²ç»åå®äºï¼åªæ¯ååºæ¢äºä¸ç¹ç¹</li>
</ul>
<p><strong>æä¹è§£å³ï¼</strong></p>
<p>â <strong>æ¹æ¡1ï¼å¢å æç»ä¸è´æ§æ£æ¥</strong></p>
<pre><code class="language-csharp">public class DepartmentCreatedEventHandler : DefaultFeishuObjectEventHandler&lt;DepartmentCreatedResult&gt;
{
    private readonly IDepartmentService _departmentService;

    protected override async Task ProcessBusinessLogicAsync(
        EventData eventData,
        ObjectEventResult&lt;DepartmentCreatedResult&gt;? departmentData,
        CancellationToken ct)
    {
        if (departmentData?.Object == null)
            return;

        var departmentId = departmentData.Object.DepartmentId;

        // åæ£æ¥é¨é¨æ¯å¦å·²å­å¨ï¼å¹ç­æ§ï¼
        var existingDepartment = await _departmentService.GetAsync(departmentId, ct);
        if (existingDepartment != null)
        {
            _logger.LogInformation("é¨é¨ {DepartmentId} å·²å­å¨ï¼è·³è¿åå»º", departmentId);
            return;
        }

        // åå»ºé¨é¨
        await _departmentService.CreateAsync(departmentData.Object, ct);
    }
}
</code></pre>
<p>â <strong>æ¹æ¡2ï¼å®ç°å¤çç»­ææºå¶</strong></p>
<pre><code class="language-csharp">public class LongRunningTaskHandler : DefaultFeishuEventHandler
{
    private readonly IFeishuEventDeduplicator _deduplicator;

    protected override async Task ProcessBusinessLogicAsync(EventData eventData, CancellationToken ct)
    {
        var eventId = eventData.EventId;

        // å®æç»­æå¤çæ¶é´ï¼æ¯30ç§ï¼
        var renewalTask = Task.Run(async () =&gt;
        {
            while (!ct.IsCancellationRequested)
            {
                await Task.Delay(30000, ct);
                _deduplicator.RenewProcessing(eventId);
            }
        }, ct);

        try
        {
            await ProcessLongRunningTask(eventData, ct);
        }
        finally
        {
            await renewalTask;
        }
    }
}
</code></pre>
<hr>
<h3 id="é®é¢-4redis-å®æºå»éé²æ¤å¨å¤±æ">é®é¢ 4ï¼Redis å®æºï¼å»éé²æ¤å¨å¤±æ</h3>
<p><strong>ç°åºæ¯è¿æ ·ç</strong>ï¼</p>
<pre><code>Redis å®æº
æå¡æ æ³è°ç¨ TryMarkAsProcessedAsync()
è¿å falseï¼åè®¸å¤çï¼
å¤ä¸ªå®ä¾éå¤å¤çåä¸äºä»¶ â
</code></pre>
<p><strong>ä¸ºä»ä¹ï¼</strong></p>
<ul>
<li>ð« Redis æäºï¼ä»£ç ä¸ºäºä¸é»å¡éæ©"åè®¸å¤ç"</li>
<li>â ç»æéå¤äºä»¶å¨æ¶è¿æ¥</li>
</ul>
<p><strong>æä¹è§£å³ï¼</strong></p>
<p>â <strong>æ¹æ¡1ï¼å®ç°éçº§å°åå­å»é</strong></p>
<pre><code class="language-csharp">public class HybridEventDeduplicator : IFeishuEventDeduplicator
{
    private readonly IFeishuEventDistributedDeduplicator _redis;
    private readonly IFeishuEventDeduplicator _memory;

    public bool TryMarkAsProcessing(string eventId)
    {
        try
        {
            // ä¼åä½¿ç¨ Redis
            return _redis.TryMarkAsProcessedAsync(eventId).GetAwaiter().GetResult();
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Rediså»éå¤±è´¥ï¼éçº§å°åå­å»é");
            // éçº§å°åå­å»é
            return _memory.TryMarkAsProcessing(eventId);
        }
    }
}
</code></pre>
<p>â <strong>æ¹æ¡2ï¼éç½®çæ­æºå¶</strong></p>
<pre><code class="language-csharp">public class CircuitBreakerEventDeduplicator : IFeishuEventDeduplicator
{
    private readonly CircuitBreaker _circuitBreaker;
    private int _failureCount;
    private DateTime _lastFailureTime;

    public bool TryMarkAsProcessing(string eventId)
    {
        if (_circuitBreaker.IsOpen())
        {
            _logger.LogWarning("Rediså»éçæ­ï¼æç»å¤ç");
            return true; // æç»å¤çï¼ä¿æ¤ä¸æ¸¸
        }

        try
        {
            var result = _redis.TryMarkAsProcessedAsync(eventId).GetAwaiter().GetResult();
            _circuitBreaker.RecordSuccess();
            return result;
        }
        catch (Exception ex)
        {
            _circuitBreaker.RecordFailure();
            throw;
        }
    }
}
</code></pre>
<hr>
<h3 id="é®é¢-5ç¼å­è¶ç§¯è¶å¤åå­å¿«çäº">é®é¢ 5ï¼ç¼å­è¶ç§¯è¶å¤ï¼åå­å¿«çäº</h3>
<p><strong>ç°åºæ¯è¿æ ·ç</strong>ï¼</p>
<pre><code>æå¡è¿è¡24å°æ¶
å»éç¼å­æ¡ç®ï¼100ä¸+
åå­å ç¨ï¼è¶è¿500MB
GCååå¢å¤§ï¼æ§è½ä¸é
</code></pre>
<p><strong>ä¸ºä»ä¹ï¼</strong></p>
<ul>
<li>ð é«é¢äºä»¶ï¼æ¯å¦æ¥æ¶æ¶æ¯ï¼ä¸å¤©è½äº§çå åä¸æ¡è®°å½</li>
<li>ð æ¸çé´éå¤ªé¿ï¼æ§è®°å½å ç§¯å¦å±±</li>
</ul>
<p><strong>æä¹è§£å³ï¼</strong></p>
<p>â <strong>æ¹æ¡1ï¼ç¼©ç­ç¼å­è¿ææ¶é´</strong></p>
<pre><code class="language-csharp">services.AddFeishuWebSocketServiceBuilder(configuration)
    .ConfigureOptions(options =&gt;
    {
        // æ ¹æ®å®éä¸å¡è°æ´
        options.EventDeduplicationCacheExpirationMs = 3600000;  // ç¼©ç­ä¸º1å°æ¶
        options.EventDeduplicationCleanupIntervalMs = 60000;    // æé«æ¸çé¢çä¸º1åé
    });
</code></pre>
<p>â <strong>æ¹æ¡2ï¼ä½¿ç¨ LRU ç¼å­</strong></p>
<pre><code class="language-csharp">public class LRUEventDeduplicator : IFeishuEventDeduplicator
{
    private readonly LRUCache&lt;string, EventCacheEntry&gt; _cache;
    private const int MaxCacheSize = 10000; // æå¤ä¿ç1ä¸æ¡

    public LRUEventDeduplicator()
    {
        _cache = new LRUCache&lt;string, EventCacheEntry&gt;(MaxCacheSize);
    }

    public bool TryMarkAsProcessing(string eventId)
    {
        if (_cache.TryGetValue(eventId, out var entry))
            return true;

        _cache.Add(eventId, new EventCacheEntry { /* ... */ });
        return false;
    }
}
</code></pre>
<p>â <strong>æ¹æ¡3ï¼ä¸å¡å±ä¼å</strong></p>
<pre><code class="language-csharp">// æäºé«é¢äºä»¶ä¸éè¦å»é
public class SystemEventHandler : DefaultFeishuEventHandler
{
    // ä¸ç»§æ¿ IdempotentFeishuEventHandler
    // ç´æ¥å¤çï¼åå°ä¸å¡å±å»éåå

    protected override Task ProcessBusinessLogicAsync(EventData eventData, CancellationToken ct)
    {
        // ä»è®°å½æ¥å¿ï¼ä¸è¿è¡ä¸å¡æä½
        _logger.LogInformation("ç³»ç»äºä»¶ï¼{EventType}", eventData.EventType);
        return Task.CompletedTask;
    }
}
</code></pre>
<hr>
<h2 id="ç»ç³»ç»åä½æ£çæ§ä¸è°è¯">ç»ç³»ç»åä½æ£ï¼çæ§ä¸è°è¯</h2>
<h3 id="ééä»ä¹æ°æ®æææ">ééä»ä¹æ°æ®æææï¼</h3>
<pre><code class="language-csharp">public class DeduplicatorMetrics
{
    public long TotalProcessed { get; set; }
    public long DuplicateSkipped { get; set; }
    public long ProcessingTimeout { get; set; }
    public long CacheHitCount { get; set; }
    public long CacheMissCount { get; set; }

    public double DuplicateRate =&gt; 
        TotalProcessed &gt; 0 ? (double)DuplicateSkipped / TotalProcessed : 0;

    public double CacheHitRate =&gt;
        (CacheHitCount + CacheMissCount) &gt; 0 
            ? (double)CacheHitCount / (CacheHitCount + CacheMissCount) 
            : 0;
}
</code></pre>
<h3 id="æ´é²ä¸ä¸ªæ¥å£éæ¶æ¥çå¥åº·ç¶æ">æ´é²ä¸ä¸ªæ¥å£ï¼éæ¶æ¥çå¥åº·ç¶æ</h3>
<pre><code class="language-csharp">[ApiController]
[Route("api/[controller]")]
public class DeduplicatorController : ControllerBase
{
    private readonly IFeishuEventDeduplicator _deduplicator;

    [HttpGet("stats")]
    public ActionResult&lt;DeduplicatorStats&gt; GetStats()
    {
        return Ok(new DeduplicatorStats
        {
            CacheCount = _deduplicator.GetCacheCount(),
            MaxProcessedSeqId = _seqIdDeduplicator?.GetMaxProcessedSeqId(),
            DuplicateRate = _metrics.DuplicateRate,
            CacheHitRate = _metrics.CacheHitRate
        });
    }

    [HttpGet("check/{eventId}")]
    public ActionResult&lt;bool&gt; CheckEventId(string eventId)
    {
        var isProcessed = _deduplicator.IsProcessed(eventId);
        return Ok(new { eventId, isProcessed });
    }
}
</code></pre>
<h3 id="æ¥å¿æä¹åæå®¹æææ¥é®é¢">æ¥å¿æä¹åæå®¹æææ¥é®é¢ï¼</h3>
<pre><code class="language-csharp">public class EnhancedEventDeduplicator : IFeishuEventDeduplicator
{
    private readonly ILogger&lt;EnhancedEventDeduplicator&gt; _logger;

    public bool TryMarkAsProcessing(string eventId)
    {
        lock (_lock)
        {
            if (_eventCache.TryGetValue(eventId, out var entry))
            {
                // è¯¦ç»è®°å½å»éå½ä¸­åå 
                _logger.LogInformation(
                    "[Deduplication] EventId={EventId} å·²å¤çï¼" +
                    "Status={Status}, ProcessedAt={ProcessedAt}",
                    eventId,
                    entry.Status,
                    entry.ProcessedAt);

                return true;
            }

            _logger.LogDebug("[Deduplication] EventId={EventId} æ°äºä»¶", eventId);
            // ...
            return false;
        }
    }
}
</code></pre>
<hr>
<h2 id="å¿«éåé¡¾ä¸è¡å¨æ¸å">å¿«éåé¡¾ä¸è¡å¨æ¸å</h2>
<h3 id="ä¸å±é²æ¤ä¸è¡¨è§">ä¸å±é²æ¤ä¸è¡¨è§</h3>
<table>
<thead>
<tr>
<th>å»éå±çº§</th>
<th>å»éä¾æ®</th>
<th>å®ç°æ¹å¼</th>
<th>æ¨èéç½®</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>åè®®å±</strong></td>
<td>SeqID / Nonce</td>
<td><code>IFeishuSeqIDDeduplicator</code> / <code>IFeishuNonceDistributedDeduplicator</code></td>
<td>å§ç»å¯ç¨</td>
</tr>
<tr>
<td><strong>ååå±</strong></td>
<td>EventId</td>
<td><code>IFeishuEventDeduplicator</code> / <code>IFeishuEventDistributedDeduplicator</code></td>
<td>çäº§ç¯å¢å¯ç¨ Redis</td>
</tr>
<tr>
<td><strong>åºç¨å±</strong></td>
<td>æ°æ®å­å¨æ§æ£æ¥</td>
<td><code>DefaultFeishuObjectEventHandler&lt;T&gt;</code> ä¸­çä¸å¡é»è¾</td>
<td>æéå®ç°</td>
</tr>
</tbody>
</table>
<h3 id="è¿æ³äºè§£æ´å¤">è¿æ³äºè§£æ´å¤ï¼</h3>
<ul>
<li>ð <a href="https://open.feishu.cn/document/server-docs/event-subscription-guide/overview" target="_blank" rel="noopener nofollow">é£ä¹¦å®æ¹ææ¡£ï¼äºä»¶è®¢é</a></li>
<li>ð» <a href="https://github.com/mudtools/MudFeishu" target="_blank" rel="noopener nofollow">MudFeishu GitHub ä»åº</a></li>
<li>ð» <a href="https://gitee.com/mudtools/MudFeishu" target="_blank" rel="noopener nofollow">MudFeishu Gitee ä»åº</a></li>
<li>ð <a href="https://redis.io/topics/distlock" target="_blank" rel="noopener nofollow">Redis åå¸å¼éæä½³å®è·µ</a></li>
</ul>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-01-11 23:01">2026-01-11 23:00</span>&nbsp;
<a href="https://www.cnblogs.com/mudtools">ç©æ³¥å·´ç|mudtools.cn</a>&nbsp;
éè¯»(<span id="post_view_count">0</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19469184);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19469184', targetLink: 'https://www.cnblogs.com/mudtools/p/19469184', title: 'é£ä¹¦ .NET SDK äºä»¶å¤ççå¹ç­æ§ä¸å»éæºå¶' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ è¿­ä»£å¨ iterationãiter ä¸ å¤çº¿ç¨ concurrent äº¤åå®è·µï¼è¯¦ç»ï¼ ]]></title>
    <link>https://www.cnblogs.com/io-T-T/p/19469168</link>
    <guid>08d1454274b5d027d19b58b804bc2aeb</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/io-T-T/p/19469168" title="åå¸äº 2026-01-11 22:52">
    <span role="heading" aria-level="2">è¿­ä»£å¨ iterationãiter ä¸ å¤çº¿ç¨ concurrent äº¤åå®è·µï¼è¯¦ç»ï¼</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                    <div id="cnblogs_post_description" style="display: none">
        
        è¿­ä»£å¨ å¤çº¿ç¨ concurrent iter python
    </div>
<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h2 id="è¿­ä»£å¨iterationiter-ä¸-å¤çº¿ç¨-concurrent-äº¤åå®è·µè¯¦ç»">è¿­ä»£å¨<code>iteration</code>ã<code>iter</code> ä¸ å¤çº¿ç¨ <code>concurrent</code> äº¤åå®è·µï¼è¯¦ç»ï¼</h2>
<h3 id="å®è·µåç®ä»è¯´æ">å®è·µåç®ä»è¯´æ</h3>
<p>â	ç±äºå¨å®éè¿ç¨éï¼è¿­ä»£å¨ï¼æçæå¨ï¼ç»å¸¸ä¸å¤çº¿ç¨ä¸å¹¶ä½¿ç¨ãæ¬å®è·µæ¨å¨å¯¹è¿­ä»£å¨ï¼åçæå¨ï¼ãå¤çº¿ç¨åºï¼ä¸»è¦ä¸º<code>concurrent</code>ï¼è¿è¡äº¤åå®è·µè¯´æï¼ç¨æ¥ä½¿è¯»èæ´å çè§£è¿­ä»£å¨åå¤çº¿ç¨å¨å®éçåºç¨ãå æ­¤æ¬ç¯è½»æç¨ï¼éå®è·µï¼å½ç¶ä¹ä¼ç®è¦è¯´æç¸å³ç¥è¯ã</p>
<h3 id="åºç¡ç¥è¯ç¸å³ä»ç»ç®è¦">åºç¡ç¥è¯ç¸å³ä»ç»ï¼ç®è¦ï¼</h3>
<blockquote>
<p>è¯¦ç»ä»ç»å»ºè®®è§ç<a href="https://space.bilibili.com/1318868/?spm_id_from=333.788.upinfo.detail.click" target="_blank" rel="noopener nofollow">Hucciåä»£ç </a>åä¸»æçåºç¡ç¥è¯ï¼è¯¦ç»ææ</p>
<p><a href="https://www.bilibili.com/video/BV1jt421c7yN" target="_blank" rel="noopener nofollow">ãPythonãä»è¿­ä»£å¨å°çæå¨ï¼å°åå­ä¹è½å¤çå¤§æ°æ®</a></p>
<p><a href="https://www.bilibili.com/video/BV1tVsyzUEtX/?" target="_blank" rel="noopener nofollow">å¨Pythonä¸­ç¨å¤çº¿ç¨ä¹åï¼éè¦åææè¿äº</a></p>
</blockquote>
<h3 id="ä½ ä¸ºä»ä¹éè¦å­¦ä¹ è¿­ä»£å¨å¤çº¿ç¨">ä½ ä¸ºä»ä¹éè¦å­¦ä¹ è¿­ä»£å¨ãå¤çº¿ç¨</h3>
<p>å­¦è¿ä¸ªæç¨/å®è·µä¹åï¼ä½ éè¦åççèªå·±ææ²¡æè¿ä¸ªéæ±ï¼å½ç¶ä½ æå´è¶£ä¹å¯ä»¥å­¦ã</p>
<h4 id="è¿­ä»£å¨çæå¨çä¼å£">è¿­ä»£å¨ï¼çæå¨ï¼çä¼å£</h4>
<p><strong>ä¼å¿ï¼</strong></p>
<ul>
<li>ä½¿ç¨æ¶çææ°æ®ï¼ç¼è§£çç¼å­é®é¢ï¼RAMãGRAMï¼ãä¸»è¦ã</li>
<li>ç»ä¸æ åæ¥å£ï¼æ éå³ç³»æ°æ®çæ°æ®ç»æè°ç¨é®é¢ï¼ä½¿ç¨ <code>for _iter in iteration</code> å³å¯è°ç¨</li>
</ul>
<p><strong>å£å¿ï¼</strong></p>
<ul>
<li>åæ¬¡ä½¿ç¨</li>
<li>ä¸æ¯æç´¢å¼</li>
<li>ååéåï¼ååï¼</li>
</ul>
<h4 id="å¤çº¿ç¨çä¼å£pythonéå®">å¤çº¿ç¨çä¼å£ï¼Pythonéå®ï¼</h4>
<p><strong>ä¼å¿</strong>ï¼</p>
<ul>
<li>å¹¶è¡æ§è¡ï¼æé«CPUçä½¿ç¨ç</li>
<li>ååå©ç¨I/Oçä¸­æ­æ¶é´ï¼ä»èæé«ä»£ç çæ§è¡éåº¦</li>
</ul>
<p><strong>å£å¿ï¼</strong></p>
<ul>
<li>è°è¯é¾åº¦å¤§</li>
<li>èçæ¬ï¼å¥½åæ¯3.12ä¹åï¼ï¼åªæä¸ä¸ªGILéï¼å¯¼è´è¿ç¨ä¼åºç°æ¢å ç°è±¡ã</li>
<li>å°æ°æ®éå¸¦æ¥çæåå¯è½è¾å°</li>
</ul>
<h3 id="01-ç¯å¢æ¥æºæ°æ®">01-ç¯å¢æ¥æºæ°æ®</h3>
<p>æç¨çæ¯<code>kaggle</code>çå¼æºæ°æ®ï¼ç±äºå¾å¤é½æ¯<code>csv</code>ç±»åï¼å æ­¤æä¹ä»¥ç®åç<code>csv</code>æ°æ®éå¤çº¿ç¨è¯»åè¿è¡è¯´æï¼ä½ ä»¬ä¹å¯ä»¥ç¨å¶ä»æ°æ®éï¼æå¥½ææ¬è¡é¿åº¦&gt;5k, æè½å±ç°å¤çº¿ç¨ãè¿­ä»£å¨çä¼å¿ï¼æ°éçº§ä½è¿æ¯ç¨åçº¿ç¨ãä¸²è¡å§ï¼å®¹æçè§£å¥½ç»´æ¤ã</p>
<blockquote>
<p><a href="https://www.kaggle.com/datasets/dansbecker/powerlifting-database/data" target="_blank" rel="noopener nofollow">powerlifting-database</a></p>
</blockquote>
<h3 id="02-ä»»å¡ä»ç»åç¼ç æè·¯">02-ä»»å¡ä»ç»åç¼ç æè·¯</h3>
<p>ç©ºæç¼ç è½åï¼ä½æ¯æ²¡æç¼ç æè·¯æ¯å¤§å¿å§ãå æ­¤åæ¦è¿°ä»»å¡åç¼ç æè·¯ã</p>
<h4 id="21-ä»»å¡">2.1 ä»»å¡</h4>
<p>æ¬æ¬¡å®è·µï¼ä»»å¡æä»¥ä¸å ç¹ï¼</p>
<ol>
<li>äºè§£å¹¶æé è¿­ä»£å¨ç±»</li>
<li>ä½¿ç¨è¿­ä»£å¨ç±»å¯¹æ°æ®éï¼<strong>csvæ°æ®</strong>ï¼è¿è¡æ°æ®åå</li>
<li>ä½¿ç¨å¤çº¿ç¨åºï¼<code>concurrent</code>ï¼æ¥æ¨¡æå¤çº¿ç¨å¤çæ°æ®ã</li>
</ol>
<h4 id="22-ç¼ç æè·¯">2.2 ç¼ç æè·¯</h4>
<p>æ³è¦è¾¾æå¤çº¿ç¨ä¸è¿­ä»£å¨çç»åï¼é¦åéè¦æé åéçæ°æ®ï¼å æ­¤éè¦ï¼</p>
<ol>
<li>æå»ºè¿­ä»£å¨ç±»ï¼æ¡æ¶ï¼</li>
</ol>
<p>ç¶åéè¦å°æ°æ®éå¯¼å¥è¿æ¥ï¼å®åè¿­ä»£å¨ç±»ï¼è¿éè¦å¯¹è¾å¥çæ°æ®åä¸ä¸ååï¼æ¹ä¾¿åç»­ä½¿ç¨ï¼</p>
<ol start="2">
<li>æ°æ®å¯¼å¥+åå+å®åè¿­ä»£å¨ç±»</li>
</ol>
<p>æ°æ®æ¥æºè§£å³äºï¼ä¹ååäºï¼æ¥ä¸æ¥æ¯å°æ°æ®ä¸å¤çº¿ç¨èå¨äº</p>
<ol start="3">
<li>å¼å¥å¤çº¿ç¨åºï¼å¤çååçæ°æ®ã</li>
</ol>
<h3 id="03-æå»ºè¿­ä»£å¨ç±»">03 æå»ºè¿­ä»£å¨ç±»</h3>
<h4 id="31è¿­ä»£å¨çæå°æ¡æ¶">3.1è¿­ä»£å¨çæå°æ¡æ¶</h4>
<blockquote>
<p>å¯åè <a href="https://www.cnblogs.com/Ravenna/p/15676404.html" target="_blank">pythonè¿­ä»£å¨ç®åçè§£ __iter__å__next__æ¹æ³</a></p>
</blockquote>
<p>â	æä¸ºä¸ä¸ªæå°è¿­ä»£å¨ç±»éå¸¸éè¦åå«ä»¥ä¸å ä¸ªç±»æ¥å£ï¼</p>
<img alt="image-20260111171210573" style="zoom: 80%" data-src="https://img2024.cnblogs.com/blog/3244923/202601/3244923-20260111225210796-336730096.png" class="lazyload">
<ol>
<li><code>__init__</code>ï¼ç±»åå§åæ¥å£</li>
<li><code>__iter__</code>: è·åè¿­ä»£å¯¹è±¡çæ¥å£</li>
<li><code>__next__</code>ï¼æ°æ®è¿­ä»£æ¥å£ã</li>
</ol>
<h4 id="32--æå»ºè¿­ä»£å¨ç±»">3.2  æå»ºè¿­ä»£å¨ç±»</h4>
<p>ä¸ºäºç§é¡¾æ´å¤çè¯»èï¼æè¿éä½¿ç¨ä¼ ç»æ¥å£å¯¹<code>csv</code>è¿è¡è¯»åï¼æ<code>panda</code>è½åçè¯»èå¯ä»¥ä½¿ç¨<code>pd</code>å¿«æ·è¯»åå¹¶æé ã</p>
<pre><code class="language-python">class read_file_batch:
    def __init__(self,file_path:str, batch_size:int):
        self.file_fp = open(file_path, encoding='utf-8', mode='r+')
        self.batch_size = batch_size
    def __iter__(self):
        return self					#è¿åè¿ä¸ªè¿­ä»£å¨æ¬èº«ï¼æä»¬æ¯ä»¥ç±»ä½ä¸ºè¿­ä»£å¯¹è±¡ï¼å æ­¤è¿åä»èªå·±å§
    def __next__(self):				#æ°æ®åå
        batch_res = []
        for i in range(self.batch_size):	
            line = self.file_fp.readline()	#æåºå±è·åè¡æ°æ®çäº¤äºæ¥å£
            if line:                        #å¦æè¡éç©º
                batch_res.append(line)
            else:                           #è¯»å°æåå°±ç®ç©ºçäº
                self.file_fp.close()
                raise StopIteration

        return batch_res
</code></pre>
<ul>
<li>
<p>è°ç¨å°è¯ï¼</p>
<p>å¯ä»¥è°è¯ä¸ä¸ï¼æåä¸ä¸åæ¹çè¿­ä»£åæ°æ®çè¾å¥è¾åºã</p>
<pre><code class="language-python">if __name__ == '__main__':
    your_file_path:str = r"E:\powerlifting-database\openpowerlifting.csv"
    iteration = read_file_batch(your_file_path, batch_size=1000)
    count = 0
    for lines in iteration:
        print('-'*50+f"count:{count}"+'-'*50)
        count += 1
        print(lines)
</code></pre>
</li>
</ul>
<h3 id="04-å¼å¥å¤çº¿ç¨å¤çæ¹éæ°æ®">04 å¼å¥å¤çº¿ç¨å¤çæ¹éæ°æ®</h3>
<h4 id="41-å¤çº¿ç¨åæ³">4.1 å¤çº¿ç¨åæ³</h4>
<p>å¶å®è®ç®åçï¼åªè¦ææ¥å£å½æ°åå¥½ãæ°æ®å¤çä¸ä¸ï¼å°±è¡äºã</p>
<ol>
<li>
<p>å¯¼å¥åºï¼</p>
<pre><code class="language-python">from concurrent.futures import ThreadPoolExecutor as Excecutor
</code></pre>
</li>
<li>
<p>ä½¿ç¨ä¸ä¸æç®¡çå·¥å·ç®¡ççº¿ç¨ï¼ç¡®ä¿å®å¨åéæ¾ï¼ï¼</p>
<pre><code class="language-python">with Excecutor(max_workers=8) as executor:
</code></pre>
</li>
<li>
<p>ä½¿ç¨mapæ¥å£è¿è¡å¤çº¿ç¨æä»¤æ§è¡ï¼</p>
<pre><code class="language-python">executor.map(
    fn= function, iter_element1, iter_element2, iter_element3
)#functionæ¯ä½ å¯¹åºçå½æ°åï¼ iter_element1-3æ¯å½æ°ä¾èµçè¾å¥æ°æ®
</code></pre>
</li>
<li>
<p>æ±æ»ï¼</p>
<pre><code class="language-python">from concurrent.futures import ThreadPoolExecutor as Excecutor
with Excecutor(max_workers=8) as executor:
	executor.map(
    fn= function, iter_element1, iter_element2, iter_element3
)#functionæ¯ä½ å¯¹åºçå½æ°åï¼ iter_element1-3æ¯å½æ°ä¾èµçè¾å¥æ°æ®
</code></pre>
</li>
</ol>
<h4 id="42-å¼å¥å¤çº¿ç¨å¤çæ°æ®">4.2 å¼å¥å¤çº¿ç¨å¤çæ°æ®</h4>
<ol>
<li>
<p>é¦åï¼æ¨¡æä¸ä¸ªå¤çè¡æ°æ®çå½æ°ç¨æ·å¤çè¡ä¿¡æ¯ï¼</p>
<pre><code class="language-python">def process_dealing(line:str):
    '''
    æ¨¡æå¤çæä¸è¡çæ°æ®
    :param line:å¤çæ¯ä¸è¡
    '''
    print(f'line top 20 info is :{line[:20]}')
    pass
</code></pre>
</li>
<li>
<p>å¨è¿­ä»£å¨çè¿­ä»£è¿ç¨ä¸­å¯¹æ°æ®è¿è¡å¤çã</p>
<pre><code class="language-python">if __name__ == '__main__':
    your_file_path:str = r"E:\powerlifting-database\openpowerlifting.csv"
    iteration = read_file_batch(your_file_path, batch_size=1000)
    count = 0
    with Excecutor(max_workers=8) as executor:

        for lines in iteration:
            print('-'*50+f"count:{count}"+'-'*50)
            count += 1
            print(lines)
            executor.map(process_dealing, lines)
            #ç¬¬ä¸ä¸ªåæ°æ¯å¤ççå½æ°ï¼åé¢æ¯*iteration å°±æ¯ä½ å½æ°ä¾èµçåæ°çå¯è¿­ä»£å¯¹è±¡ï¼è¿éå°±æ¯æ¾å¥list[str]
</code></pre>
</li>
<li>
<p>ç»æäºï¼æ ¹æ®ä½ çéè¦å¯ä»¥å¯¹æ°æ®è¿è¡å¤çäºï¼å¶å®æé¾çæ­¥éª¤å¨äºå¦ä½æé è¿­ä»£å¨ï¼çæå¨ï¼ï¼å¤çº¿ç¨å¶å®ä¿©æ­¥å°±èµ°å®äºã</p>
</li>
</ol>
<h3 id="05-éå¿é¡»ä½¿ç¨è¿­ä»£å¨å¤çº¿ç¨ååå¯¹æ¯">05 ï¼éå¿é¡»ï¼ä½¿ç¨è¿­ä»£å¨ãå¤çº¿ç¨ååå¯¹æ¯</h3>
<pre><code class="language-python">from concurrent.futures import ThreadPoolExecutor as Excecutor
import time
import tracemalloc  #è·è¸ªåå­æ¥å£ï¼åç½®

def process_dealing(line:str):
    '''
    æ¨¡æå¤çæä¸è¡çæ°æ®
    :param line:å¤çæ¯ä¸è¡
    '''
    # print(f'line top 20 info is :{line[:20]}')
    pass

class read_file_batch:
    def __init__(self,file_path:str, batch_size:int):
        self.file_fp = open(file_path, encoding='utf-8', mode='r+')
        self.batch_size = batch_size
    def __iter__(self):
        return self
    def __next__(self):                     #æ°æ®åå,å¯¹è¿­ä»£å¨è¿è¡è¿­ä»£ï¼å®éä¸æ¯è·åä»çnextï¼å æ­¤å¨è¿éååæ°æ®
        batch_res = []
        for i in range(self.batch_size):    #åbatchä¸ª
            line = self.file_fp.readline()
            if line:                        #å¦æè¡éç©º
                batch_res.append(line)
            else:                           #è¯»å°æåå°±ç®ç©ºçäº
                self.file_fp.close()
                raise StopIteration

        return batch_res                    #è¿åè¿­ä»£æ°æ®

def main_concurrent(file_path,batch_size:int):
    start_malloc = tracemalloc.start()
    start_time = time.time()
    your_file_path:str = file_path
    iteration = read_file_batch(your_file_path, batch_size=batch_size)
    count = 0
    with Excecutor(max_workers=8) as executor:

        for lines in iteration:                         #è¿åæ¯batchè¡,æ¯ä¸è¡æ¯ä¸ä¸ªå¤§çstr
            print('-'*50+f"count:{count}"+'-'*50+f"RAM cost:{round(tracemalloc.get_tracemalloc_memory() / 1024**2,4)} M")
            count += 1
            print(lines[:50])                           #èçº¦æ¶é´ï¼åªåå50å­ç¬¦
            executor.map(process_dealing, lines)
            #ç¬¬ä¸ä¸ªåæ°æ¯å¤ççå½æ°ï¼åé¢æ¯*iteration å°±æ¯ä½ å½æ°ä¾èµçåæ°çå¯è¿­ä»£å¯¹è±¡ï¼è¿éå°±æ¯æ¾å¥list[str]
    print(f'spend time:{round(time.time()-start_time,4)}')

def main_not_concurrent(file_path,batch_size:int=1000):

    start_time = time.time()
    start_trace = tracemalloc.start()

    with open(file=file_path,encoding='utf-8',mode='r+') as fp:
        data = fp.readlines()
        for idx,line in enumerate(data):
            if idx % batch_size == 0:
                print('-'*50 +str(idx)+'-'*50+f"RAM cost:{round(tracemalloc.get_tracemalloc_memory() / 1024**2,4)} M")
                print(line[:50])
                process_dealing(line)
    print(f'spend time:{round(time.time()-start_time,4)}')


if __name__ == '__main__':
    file_path = r'E:\openpowerlifting.csv'
    batch_size = 1000
    main_concurrent(file_path,batch_size)
    # main_not_concurrent(file_path,batch_size)
    # å¶å®è½çåºæ¥è¿ç§æ°æ®éè¿æ¯ç´æ¥ç¼å­å¨åå­æ¯è¾å¥½ï¼ä½ä½¿ç¨å¤çº¿ç¨+è¿­ä»£å¨ç¡®å®åå°äºå¾å¤åå­
</code></pre>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-01-11 22:53">2026-01-11 22:52</span>&nbsp;
<a href="https://www.cnblogs.com/io-T-T">io_T_T</a>&nbsp;
éè¯»(<span id="post_view_count">3</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19469168);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19469168', targetLink: 'https://www.cnblogs.com/io-T-T/p/19469168', title: 'è¿­ä»£å¨ iterationãiter ä¸ å¤çº¿ç¨ concurrent äº¤åå®è·µï¼è¯¦ç»ï¼' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ TensorRtSharpï¼å¨ C# ä¸çä¸­éæ¾ GPU æ¨ççæè´æ§è½ ]]></title>
    <link>https://www.cnblogs.com/guojin-blogs/p/19468745</link>
    <guid>828f9f740e0b98b8de74655291c2b8b2</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/guojin-blogs/p/19468745" title="åå¸äº 2026-01-11 18:47">
    <span role="heading" aria-level="2">TensorRtSharpï¼å¨ C# ä¸çä¸­éæ¾ GPU æ¨ççæè´æ§è½</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                    <div id="cnblogs_post_description" style="display: none">
        <img src="https://img2024.cnblogs.com/blog/2933426/202601/2933426-20260111184433092-325501944.png" alt="TensorRtSharpï¼å¨ C# ä¸çä¸­éæ¾ GPU æ¨ççæè´æ§è½" class="desc_img">
        TensorRtSharp 3.0 æ¯ä¸ä¸ªä¸º C# å¼åèæé ç TensorRT å°è£åºï¼éè¿ NuGet ä¸é®å®è£ï¼æä¾å®æ´ç GPU æ¨çå éåè½ãè¯¥åºåºäº TensorRT 10.x å¼åï¼æ¯æ CUDA 11/12ï¼å·å¤ç±»åå®å¨ãèªå¨èµæºç®¡çç­ç¹æ§ï¼æ¾èæå .NET ç¯å¢ä¸çæ·±åº¦å­¦ä¹ æ¨çæ§è½ï¼éåº¦æå 2-10 åï¼æ¾å­éä½ 50%+ï¼ãå®è£ç®åï¼åªéæ·»å ä¸¤ä¸ª NuGet åï¼å¹¶éè¿ç¯å¢åééç½®åçåºè·¯å¾å³å¯ä½¿ç¨ãæ¨èéç½®ä¸º CUDA 11.6 + TensorRT 10.13.0.35ï¼æ¯æ
    </div>
<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h1 id="tensorrtsharpå¨-c-ä¸çä¸­éæ¾-gpu-æ¨ççæè´æ§è½">TensorRtSharpï¼å¨ C# ä¸çä¸­éæ¾ GPU æ¨ççæè´æ§è½</h1>
<h2 id="ç®å½">ç®å½</h2>
<ul>
<li><a href="#%E4%B8%80%E5%89%8D%E8%A8%80" rel="noopener nofollow">ä¸ãåè¨</a></li>
<li><a href="#%E4%BA%8C%E4%BB%80%E4%B9%88%E6%98%AF-tensortrtsharp" rel="noopener nofollow">äºãä»ä¹æ¯ TensorRtSharp</a></li>
<li><a href="#%E4%B8%89%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE" rel="noopener nofollow">ä¸ãå®è£ä¸éç½®</a></li>
<li><a href="#%E5%9B%9B%E6%A0%B8%E5%BF%83%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1" rel="noopener nofollow">åãæ ¸å¿æ¶æè®¾è®¡</a></li>
<li><a href="#%E4%BA%94%E6%A0%B8%E5%BF%83%E7%B1%BB%E4%B8%8E-api" rel="noopener nofollow">äºãæ ¸å¿ç±»ä¸ API</a></li>
<li><a href="#%E5%85%AD%E5%AE%8C%E6%95%B4%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B" rel="noopener nofollow">å­ãå®æ´ä½¿ç¨ç¤ºä¾</a></li>
<li><a href="#%E4%B8%83%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86" rel="noopener nofollow">ä¸ãå¼å¸¸å¤ç</a></li>
<li><a href="#%E5%85%AB%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F" rel="noopener nofollow">å«ãæ¥å¿ç³»ç»</a></li>
<li><a href="#%E4%B9%9D%E4%B8%8E%E5%85%B6%E4%BB%96%E5%BA%93%E7%9A%84%E5%AF%B9%E6%AF%94" rel="noopener nofollow">ä¹ãä¸å¶ä»åºçå¯¹æ¯</a></li>
<li><a href="#%E5%8D%81%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98" rel="noopener nofollow">åãå¸¸è§é®é¢</a></li>
<li><a href="#%E5%8D%81%E4%B8%80%E6%80%BB%E7%BB%93" rel="noopener nofollow">åä¸ãæ»ç»</a></li>
</ul>
<hr>
<h2 id="ä¸åè¨">ä¸ãåè¨</h2>
<h3 id="11-ä¸ºä»ä¹éè¦-tensorrtsharp">1.1 ä¸ºä»ä¹éè¦ TensorRtSharpï¼</h3>
<p>å¨æ·±åº¦å­¦ä¹ æ¨¡åé¨ç½²é¢åï¼NVIDIA TensorRT å­åå¶åè¶çæ¨çæ§è½å·²æä¸º GPU å éçäºå®æ åãæ ¹æ® NVIDIA å®æ¹æ°æ®ï¼ä½¿ç¨ TensorRT è¿è¡æ¨¡åä¼ååæ¨çå éï¼éå¸¸å¯ä»¥è·å¾ï¼</p>
<ul>
<li>ð <strong>æ¨çéåº¦æå 2-10 å</strong>ï¼ç¸æ¯åçæ¡æ¶ï¼</li>
<li>ð¾ <strong>æ¾å­å ç¨éä½ 50% ä»¥ä¸</strong>ï¼éè¿ç²¾åº¦ä¼ååå±èåï¼</li>
<li>â¡ <strong>å»¶è¿éä½è³æ¯«ç§çº§</strong>ï¼æ»¡è¶³å®æ¶åºç¨éæ±ï¼</li>
</ul>
<p>ç¶èï¼TensorRT å®æ¹ä»æä¾ C++ å Python APIï¼è¿è®©å¹¿å¤§ .NET å¼åèé¢ä¸´ä¸ä¸ªä¸¤é¾çéæ©ï¼</p>
<ul>
<li><strong>æ¾å¼çæç C# çæ</strong>ï¼è½¬å C++ æ Python</li>
<li><strong>éè¿å¤æçäºæä½å±</strong>è¿è¡è°ç¨ï¼å¼åæçä½ä¸</li>
</ul>
<p><strong>TensorRtSharp</strong> åºè¿èç ââ è¿æ¯ä¸ä¸ªçº¯ C# ç¼åç TensorRT å®æ´å°è£åºï¼ä¸º .NET å¼åèæä¾äºï¼</p>
<ul>
<li>â <strong>ç±»åå®å¨ç API æ¥å£</strong> - å¼ºç±»åç³»ç»ï¼ç¼è¯æ¶éè¯¯æ£æ¥</li>
<li>â <strong>æäºä½¿ç¨ä¸æ§è½åè¶</strong> - ç´è§ç API è®¾è®¡ï¼é¶æ§è½æå¤±</li>
<li>â <strong>å®æ´ç TensorRT åè½è¦ç</strong> - æ¯ææææ ¸å¿åè½</li>
<li>â <strong>èªå¨èµæºç®¡ç</strong> - åºäº RAII å Dispose æ¨¡å¼ï¼æ éæå¿åå­æ³æ¼</li>
<li>â <strong>å¼ç®±å³ç¨</strong> - NuGet ä¸é®å®è£ï¼æ éå¤æéç½®</li>
<li>â <strong>å®åçææ¡£åç¤ºä¾</strong> - ä¸°å¯çä»£ç ç¤ºä¾åè¯¦ç»çä½¿ç¨è¯´æ</li>
</ul>
<h3 id="12-tensorrtsharp-çæ ¸å¿ä¼å¿">1.2 TensorRtSharp çæ ¸å¿ä¼å¿</h3>
<p><strong>1. åç C# ä½éª</strong></p>
<pre><code class="language-csharp">// ç®æ´ç´è§ç API è®¾è®¡
using Runtime runtime = new Runtime();
using CudaEngine engine = runtime.deserializeCudaEngineByBlob(data, size);
using ExecutionContext context = engine.createExecutionContext();
context.executeV3(stream);
</code></pre>
<p><strong>2. å®æ´åè½è¦ç</strong></p>
<ul>
<li>â æ¨¡åæå»ºï¼ONNX â Engineï¼</li>
<li>â æ¨çæ§è¡ï¼åæ­¥/å¼æ­¥ï¼</li>
<li>â å¨æå½¢ç¶æ¯æ</li>
<li>â å¤ç²¾åº¦æ¨çï¼FP32/FP16/INT8ï¼</li>
<li>â å¤ GPU å¹¶è¡æ¨ç</li>
</ul>
<h3 id="13-tensorrtsharp-30-çéå¤§æ¹è¿">1.3 TensorRtSharp 3.0 çéå¤§æ¹è¿</h3>
<p>å¨åæå¼åç TensorRtSharp 1.0 å 2.0 ä¸­ï¼ä½¿ç¨èéè¦ä¸è½½æºç ç¼è¯æè½ä½¿ç¨ï¼è¿ç¨ç¹çä¸å®¹æåºéã</p>
<p><strong>å¨ææ°ç 3.0 çæ¬ä¸­ï¼æä»¬è¿è¡äºéå¤§æ¹è¿</strong>ï¼</p>
<p>â <strong>ä¸é®å®è£</strong> - ç´æ¥å°ç¼è¯å¥½çåçåºä¸æç®¡ä»£ç æåè³ NuGet åä¸­<br>
â <strong>å¼ç®±å³ç¨</strong> - æ ééç½®å¤æçæå»ºç¯å¢<br>
â <strong>çæ¬ä¸è´</strong> - éä½å ç¯å¢å·®å¼å¯¼è´çæ½å¨éè¯¯</p>
<p>å¼åèä»ééè¿ Visual Studio ç NuGet åç®¡çå¨å®è£å³å¯ç´æ¥ä½¿ç¨ï¼æ¾èæåäºå¼åæçä¸é¨ç½²ä¾¿æ·æ§ï¼</p>
<p>æ¬æå°å¨é¢ä»ç» TensorRtSharp çè®¾è®¡çå¿µãæ ¸å¿åè½åä½¿ç¨æ¹æ³ï¼å©åå¤§å®¶å¿«éä¸æä½¿ç¨ã</p>
<hr>
<h2 id="äºä»ä¹æ¯-tensorrtsharp">äºãä»ä¹æ¯ TensorRtSharp</h2>
<h3 id="21-é¡¹ç®ç®ä»">2.1 é¡¹ç®ç®ä»</h3>
<p><strong>TensorRtSharp 3.0</strong> æ¯ä½èå¯¹ NVIDIA TensorRT å®æ¹åºçå®æ´ C# æ¥å£å°è£ãéè¿ P/Invoke ææ¯ï¼å®å° TensorRT çåç C++ API æ å°ä¸ºç¬¦å .NET è®¾è®¡è§èçæç®¡ä»£ç ï¼è®© C# å¼åèè½å¤æ ç¼ä½¿ç¨ TensorRT çå¨é¨åè½ã</p>
<h3 id="22-æ ¸å¿ç¹æ§">2.2 æ ¸å¿ç¹æ§</h3>
<table>
<thead>
<tr>
<th>ç¹æ§</th>
<th>è¯´æ</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>å®æ´ç API è¦ç</strong></td>
<td>æ¯æ TensorRT æ ¸å¿åè½ï¼åæ¬æ¨¡åæå»ºãæ¨çæ§è¡ãå¨æå½¢ç¶ç­</td>
</tr>
<tr>
<td><strong>ç±»åå®å¨</strong></td>
<td>å¼ºç±»åç³»ç»ï¼ç¼è¯æ¶éè¯¯æ£æ¥ï¼é¿åè¿è¡æ¶ç±»åéè¯¯</td>
</tr>
<tr>
<td><strong>èªå¨èµæºç®¡ç</strong></td>
<td>åºäº RAII å Dispose æ¨¡å¼çèµæºç®¡çï¼é²æ­¢åå­æ³æ¼</td>
</tr>
<tr>
<td><strong>è·¨å¹³å°æ¯æ</strong></td>
<td>æ¯æ WindowsãLinuxï¼å¼å®¹ .NET 5.0-10.0ã.NET Core 3.1ã.NET Framework 4.7.1-4.8.1</td>
</tr>
<tr>
<td><strong>é«æ§è½å¼æ­¥æ§è¡</strong></td>
<td>æ¯æ CUDA Streamãå¤æ§è¡ä¸ä¸æå¹¶è¡æ¨ç</td>
</tr>
<tr>
<td><strong>å¼ç®±å³ç¨</strong></td>
<td>NuGet åå«ææä¾èµï¼æ éå¤æéç½®</td>
</tr>
</tbody>
</table>
<h3 id="23-é¡¹ç®ä¿¡æ¯">2.3 é¡¹ç®ä¿¡æ¯</h3>
<table>
<thead>
<tr>
<th>é¡¹ç®</th>
<th>ä¿¡æ¯</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>çæ¬</strong></td>
<td>ç®åææ° NuGet çæ¬ä¸º 0.0.5ï¼æç»­æ´æ°ä¸­ï¼å»ºè®®ä½¿ç¨ææ°çæ¬ï¼</td>
</tr>
<tr>
<td><strong>GitHub</strong></td>
<td><code>https://github.com/guojin-yan/TensorRT-CSharp-API</code></td>
</tr>
<tr>
<td><strong>æ¥å£ NuGet</strong></td>
<td><code>JYPPX.TensorRT.CSharp.API</code></td>
</tr>
<tr>
<td><strong>Runtime NuGet</strong></td>
<td><code>JYPPX.TensorRT.CSharp.API.runtime.win-x64.cuda12</code> æ <code>JYPPX.TensorRT.CSharp.API.runtime.win-x64.cuda11</code></td>
</tr>
<tr>
<td><strong>ç¼ç¨è¯­è¨</strong></td>
<td>C# 10</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="ä¸å®è£ä¸éç½®">ä¸ãå®è£ä¸éç½®</h2>
<h3 id="31-éè¿-nuget-å®è£">3.1 éè¿ NuGet å®è£</h3>
<p>å®è£ TensorRtSharp éå¸¸ç®åï¼åªéå®è£ä¸¤ä¸ª NuGet åï¼</p>
<pre><code class="language-bash"># å®è£æ¥å£å
dotnet add package JYPPX.TensorRT.CSharp.API

# å®è£è¿è¡æ¶åï¼æ ¹æ®æ¨ç CUDA çæ¬éæ©ï¼
# CUDA 12.x çæ¬
dotnet add package JYPPX.TensorRT.CSharp.API.runtime.win-x64.cuda12

# æ CUDA 11.x çæ¬
dotnet add package JYPPX.TensorRT.CSharp.API.runtime.win-x64.cuda11
</code></pre>
<blockquote>
<p><strong>ð¡ å°è´´å£«</strong>ï¼Runtime åä¸ CUDA çæ¬ç¸å³ï¼è¯·æ ¹æ®æ¨è®¾å¤ä¸å®è£ç CUDA çæ¬éæ©å¯¹åºçåã</p>
</blockquote>
<p><img alt="image-20260109233203782" loading="lazy" data-src="https://img2024.cnblogs.com/blog/2933426/202601/2933426-20260111184155212-1410768222.png" class="lazyload"></p>
<h3 id="32-ç³»ç»è¦æ±">3.2 ç³»ç»è¦æ±</h3>
<table>
<thead>
<tr>
<th>è¦æ±</th>
<th>è¯´æ</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>æä½ç³»ç»</strong></td>
<td>Windows 10+ãLinuxï¼Ubuntu 18.04+ï¼ãmacOS 10.15+</td>
</tr>
<tr>
<td><strong>.NET çæ¬</strong></td>
<td>.NET 5.0-10.0ã.NET Core 3.1ã.NET Framework 4.7.1+</td>
</tr>
<tr>
<td><strong>GPU</strong></td>
<td>NVIDIA GPUï¼æ¯æ CUDA 11.x æ 12.xï¼</td>
</tr>
<tr>
<td><strong>ä¾èµ</strong></td>
<td>NVIDIA TensorRT 10.xãCUDA Runtime</td>
</tr>
</tbody>
</table>
<h3 id="33-éè¦çæ¬è¯´æ">3.3 éè¦çæ¬è¯´æ</h3>
<blockquote>
<p><strong>â ï¸ éè¦æéï¼NVIDIA TensorRT å¿é¡»æ¯ 10.x ç³»åï¼ï¼</strong></p>
</blockquote>
<p>TensorRtSharp 3.0 åºäº TensorRT 10.x å¼åï¼ä¸æ¯æ TensorRT 8.x æ 9.x çæ¬ã</p>
<p>ä¸ºäºé²æ­¢åºç°å¼å®¹æ§é®é¢ï¼å»ºè®®ä½¿ç¨ä¸åä¸»ç¸åçéç½®ï¼</p>
<p><strong>éç½® 1ï¼æ¨èï¼ï¼</strong></p>
<ul>
<li>CUDA 11.6</li>
<li>cuDNN 9.2.0</li>
<li>TensorRT 10.13.0.35</li>
</ul>
<p><strong>éç½® 2ï¼</strong></p>
<ul>
<li>CUDA 12.3</li>
<li>cuDNN 9.2.0</li>
<li>TensorRT 10.11.0.33</li>
</ul>
<h3 id="34-éç½®åçåº">3.4 éç½®åçåº</h3>
<p>TensorRtSharp ä¾èµ TensorRT çåçåºï¼<code>nvinfer.dll</code>ï¼å CUDA çåçåºï¼<code>cudart64_*.dll</code> ç­ï¼ãæä¸¤ç§éç½®æ¹å¼ï¼</p>
<h4 id="æ¹å¼ä¸æ·è´-dll-å°åºç¨ç¨åºç®å½ä¸æ¨è">æ¹å¼ä¸ï¼æ·è´ DLL å°åºç¨ç¨åºç®å½ï¼ä¸æ¨èï¼</h4>
<p>å° TensorRT å CUDA çææ DLL æä»¶æ·è´å°ç¨åºå¯æ§è¡ç®å½ä¸ã</p>
<p><strong>ç¼ºç¹</strong>ï¼</p>
<ul>
<li>ä¼å¯¼è´ç¨åºç®å½æä»¶åºå¤§</li>
<li>ä¸æ¹ä¾¿ç®¡çä¸é¨ç½²</li>
<li><strong>ä¸æ¨èä½¿ç¨æ­¤æ¹å¼</strong></li>
</ul>
<h4 id="æ¹å¼äºè®¾ç½®ç³»ç»-pathæ¨è">æ¹å¼äºï¼è®¾ç½®ç³»ç» PATHï¼æ¨èï¼</h4>
<p>å° TensorRT ç lib ç®å½å CUDA ç bin ç®å½è·¯å¾æ·»å å°ç³»ç» PATH ç¯å¢åéä¸­ã</p>
<p><strong>ä¼ç¹</strong>ï¼</p>
<ul>
<li>æ éå¤å¶å¤§éæä»¶</li>
<li>ä¿æåºç¨ç®å½æ´æ´</li>
<li>ä¾¿äºçæ¬ç®¡çåé¨ç½²ç»´æ¤</li>
</ul>
<p><strong>éç½®æ­¥éª¤</strong>ï¼</p>
<ol>
<li><strong>è®¾ç½® CUDA_PATH ç¯å¢åé</strong></li>
</ol>
<p><img alt="CUDA_PATH éç½®" loading="lazy" data-src="https://img2024.cnblogs.com/blog/2933426/202601/2933426-20260111184155230-1674511893.jpg" class="lazyload"></p>
<ol start="2">
<li><strong>è®¾ç½® PATH ç¯å¢åé</strong></li>
</ol>
<p>å°ä»¥ä¸è·¯å¾æ·»å å° PATHï¼</p>
<ul>
<li>CUDA ç bin ç®å½ï¼å¦ <code>C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v11.6\bin</code>ï¼</li>
<li>TensorRT ç lib ç®å½ï¼å¦ <code>C:\TensorRT-10.13.0.35\lib</code>ï¼</li>
</ul>
<p><img alt="PATH éç½®" loading="lazy" data-src="https://img2024.cnblogs.com/blog/2933426/202601/2933426-20260111184155212-1478801897.jpg" class="lazyload"></p>
<blockquote>
<p><strong>ð¡ å»ºè®®</strong>ï¼ä¼åä½¿ç¨ç¯å¢åéæ¹å¼éç½®ï¼é¿åå æä»¶åä½å¯¼è´é¨ç½²å¤æãåæ¶æ³¨æä¸å CUDA çæ¬é´çå¼å®¹æ§é®é¢ã</p>
</blockquote>
<hr>
<h2 id="åæ ¸å¿æ¶æè®¾è®¡">åãæ ¸å¿æ¶æè®¾è®¡</h2>
<h3 id="41-ä¸å±æ¶æ">4.1 ä¸å±æ¶æ</h3>
<p>TensorRtSharp éç¨æ¸æ°çä¸å±æ¶æè®¾è®¡ï¼</p>
<pre><code>âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ
â           ä¸å¡ API å± (High-Level API)                   â
â  Runtime, Builder, CudaEngine, ExecutionContext         â
âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ
                           â²
                           â
âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ
â         èµæºç®¡çå± (Resource Management)                 â
â  DisposableTrtObject, DisposableObject, IOvPtrHolder    â
âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ
                           â²
                           â
âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ
â         P/Invoke å± (Native Interop)                    â
â  NativeMethodsTensorRt*, NativeMethodsCuda*             â
âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ
</code></pre>
<h3 id="42-èªå¨èµæºç®¡ç">4.2 èªå¨èµæºç®¡ç</h3>
<p>TensorRtSharp å®ç°äºå®åçèµæºç®¡çæºå¶ï¼ææ TensorRT å¯¹è±¡é½ç»§æ¿èª <code>DisposableTrtObject</code>ï¼</p>
<pre><code class="language-csharp">// ææ TensorRT å¯¹è±¡ç»§æ¿èª DisposableTrtObject
public abstract class DisposableTrtObject : DisposableObject
{
    protected IntPtr ptr;                      // åçå¯¹è±¡æé
    public bool IsDisposed { get; protected set; }

    // å®å¨è®¿é®åçæéï¼èªå¨æ£æ¥éæ¾ç¶æï¼
    public IntPtr TrtPtr
    {
        get
        {
            ThrowIfDisposed();
            return ptr;
        }
    }

    // éæ¾éæç®¡èµæº
    protected override void DisposeUnmanaged()
    {
        if (ptr != IntPtr.Zero)
        {
            // è°ç¨åçéæ¾å½æ°
            NativeDestroy(ptr);
            ptr = IntPtr.Zero;
        }
    }
}

// ä½¿ç¨ using è¯­å¥èªå¨éæ¾èµæº
using Runtime runtime = new Runtime();
using CudaEngine engine = runtime.deserializeCudaEngineByBlob(data, size);
// ç¦»å¼ä½ç¨åæ¶èªå¨éæ¾
</code></pre>
<p><strong>è®¾è®¡äº®ç¹</strong>ï¼</p>
<ul>
<li>â éç¨æ å Dispose æ¨¡å¼ï¼ç¡®ä¿èµæºæ­£ç¡®éæ¾</li>
<li>â çº¿ç¨å®å¨çèµæºéæ¾æºå¶ï¼ä½¿ç¨ <code>Interlocked.Exchange</code>ï¼</li>
<li>â èªå¨åå­ååéç¥ï¼<code>GC.AddMemoryPressure</code>ï¼</li>
<li>â æéå®å¨è®¿é®ï¼<code>ThrowIfDisposed</code> æ£æ¥ï¼</li>
</ul>
<hr>
<h2 id="äºæ ¸å¿ç±»ä¸-api">äºãæ ¸å¿ç±»ä¸ API</h2>
<h3 id="51-å½åç©ºé´">5.1 å½åç©ºé´</h3>
<p>å¨ä½¿ç¨ TensorRtSharp ä¹åï¼é¦åå¼å¥å¿è¦çå½åç©ºé´ï¼</p>
<pre><code class="language-csharp">using JYPPX.TensorRtSharp.Cuda;      // CUDA æ¥å£çç¨åºéå½åç©ºé´
using JYPPX.TensorRtSharp.Nvinfer;   // TensorRT æ¥å£çç¨åºéå½åç©ºé´
</code></pre>
<h3 id="52-runtimeæ¨çè¿è¡æ¶">5.2 Runtimeï¼æ¨çè¿è¡æ¶ï¼</h3>
<p>Runtime æ¯ TensorRT æ¨ççå¥å£ç¹ï¼è´è´£ä»åºååçå¼ææä»¶åå»ºæ¨çå¼æã</p>
<pre><code class="language-csharp">// åå»º Runtime å®ä¾
Runtime runtime = new Runtime();
string filePath = "yolov8s-obb.engine";

// ä»å­èæ°ç»ååºååå¼æ
byte[] data = File.ReadAllBytes(filePath);
using CudaEngine cudaEngine = runtime.deserializeCudaEngineByBlob(data, (ulong)data.Length);

// ä»æä»¶æµååºåå
using var reader = new FileStreamReader();
reader.open(filePath);
using CudaEngine cudaEngine = runtime.deserializeCudaEngineByFileStreamReader(reader);

// éç½® DLAï¼æ·±åº¦å­¦ä¹ å éå¨ï¼
runtime.setDLACore(0);  // ä½¿ç¨ DLA æ ¸å¿ 0
int dlaCores = runtime.getNbDLACores();

// è®¾ç½®æå¤§çº¿ç¨æ°
runtime.setMaxThreads(4);
</code></pre>
<p><strong>ä¸»è¦ç¨é</strong>ï¼</p>
<ul>
<li>ååºåå TensorRT å¼ææä»¶</li>
<li>éç½® DLA å éå¨</li>
<li>å è½½æä»¶åº</li>
</ul>
<h3 id="53-builderæ¨¡åæå»ºå¨">5.3 Builderï¼æ¨¡åæå»ºå¨ï¼</h3>
<p>Builder ç¨äºä» ONNX æ¨¡åæå»º TensorRT å¼æã</p>
<pre><code class="language-csharp">using Builder builder = new Builder();

// æ¥è¯¢å¹³å°è½å
bool hasFP16 = builder.platformHasFastFp16();  // æ¯å¦æ¯æ FP16
bool hasINT8 = builder.platformHasFastInt8();  // æ¯å¦æ¯æ INT8
int maxDLABatch = builder.maxDLABatchSize();   // DLA æå¤§æ¹å¤§å°

// åå»ºç½ç»å®ä¹ï¼æ¾å¼æ¹å¤çæ¨¡å¼ï¼
using NetworkDefinition network = builder.createNetworkV2(
    TrtNetworkDefinitionCreationFlag.kEXPLICIT_BATCH);

// åå»ºæå»ºå¨éç½®
using BuilderConfig config = builder.createBuilderConfig();

// åå»ºä¼åéç½®æä»¶ï¼ç¨äºå¨æå½¢ç¶ï¼
using OptimizationProfile profile = builder.createOptimizationProfile();

// æå»ºåºååç½ç»
using HostMemory serialized = builder.buildSerializedNetwork(network, config);

// ä¿å­å¼ææä»¶
using (FileStream fs = new FileStream("model.engine", FileMode.Create, FileAccess.Write))
{
    fs.Write(serialized.getByteData(), 0, (int)serialized.Size);
}
</code></pre>
<p><strong>ä¸»è¦ç¨é</strong>ï¼</p>
<ul>
<li>åå»ºç½ç»å®ä¹åæå»ºéç½®</li>
<li>æ¥è¯¢ç¡¬ä»¶è½åï¼FP16ãINT8ãDLAï¼</li>
<li>æå»º TensorRT å¼æ</li>
<li>æ³¨åèªå®ä¹æä»¶</li>
</ul>
<h3 id="54-cudaengineæ¨çå¼æ">5.4 CudaEngineï¼æ¨çå¼æï¼</h3>
<p>CudaEngine æ¯æ¨ççæ ¸å¿å¯¹è±¡ï¼åå«ä¼ååçæ¨¡åè®¡ç®å¾ã</p>
<pre><code class="language-csharp">// è·åå¼ éä¿¡æ¯
int numTensors = engine.getNbIOTensors();
string inputName = engine.getIOTensorName(0);    // è¾å¥å¼ éåç§°
string outputName = engine.getIOTensorName(1);   // è¾åºå¼ éåç§°

Dims inputShape = engine.getTensorShape(inputName);
TrtDataType inputType = engine.getTensorDataType(inputName);

// åå»ºæ§è¡ä¸ä¸æ
using ExecutionContext context = engine.createExecutionContext();
using ExecutionContext contextStatic = engine.createExecutionContext(
    TrtExecutionContextAllocationStrategy.kSTATIC);

// åºååå¼æ
using HostMemory memory = engine.serialize();

// æ¥è¯¢å¼æå±æ§
int numLayers = engine.getNbLayers();
string name = engine.getName();
long deviceMemory = engine.getDeviceMemorySize();
</code></pre>
<p><strong>ä¸»è¦ç¨é</strong>ï¼</p>
<ul>
<li>æ¥è¯¢æ¨¡åè¾å¥è¾åºä¿¡æ¯</li>
<li>åå»ºæ§è¡ä¸ä¸æ</li>
<li>åºååå¼æ</li>
<li>æ§è½åæ</li>
</ul>
<h3 id="55-executioncontextæ§è¡ä¸ä¸æ">5.5 ExecutionContextï¼æ§è¡ä¸ä¸æï¼</h3>
<p>ExecutionContext ç®¡çåæ¬¡æ¨ççæ§è¡ç¯å¢ï¼æ¯æå¼æ­¥æ¨çåå¨æå½¢ç¶ã</p>
<pre><code class="language-csharp">// ç»å®å¼ éå°å
Cuda1DMemory&lt;float&gt; input = new Cuda1DMemory&lt;float&gt;(3 * 1024 * 1024);
Cuda1DMemory&lt;float&gt; output = new Cuda1DMemory&lt;float&gt;(1 * 20 * 21504);
context.setInputTensorAddress("images", input.get());
context.setOutputTensorAddress("output0", output.get());

// è®¾ç½®å¨æå½¢ç¶
context.setinputShape("images", new Dims(1, 3, 1024, 1024));
Dims shape = context.getTensorShape("images");

// æ§è¡æ¨çï¼å¼æ­¥ï¼ä½¿ç¨ CUDA Streamï¼
using CudaStream stream = new CudaStream();
context.executeV3(stream);
stream.Synchronize();  // ç­å¾å®æ

// è®¾ç½®ä¼åéç½®æä»¶ï¼å¨æå½¢ç¶ï¼
context.setOptimizationProfileAsync(0, stream);

// è°è¯åè½
context.setDebugSync(true);
</code></pre>
<p><strong>ä¸»è¦ç¨é</strong>ï¼</p>
<ul>
<li>ç»å®è¾å¥è¾åºå¼ é</li>
<li>è®¾ç½®å¨æå½¢ç¶</li>
<li>æ§è¡æ¨çï¼å¼æ­¥ï¼</li>
<li>æ§è½åæåè°è¯</li>
</ul>
<h3 id="56-onnxparseronnx-è§£æå¨">5.6 OnnxParserï¼ONNX è§£æå¨ï¼</h3>
<p>OnnxParser å° ONNX æ¨¡åè½¬æ¢ä¸º TensorRT ç½ç»å®ä¹ã</p>
<pre><code class="language-csharp">// è§£æ ONNX æä»¶
using NetworkDefinition network = build.createNetworkV2(TrtNetworkDefinitionCreationFlag.kEXPLICIT_BATCH);
using OnnxParser parser = new OnnxParser(network);
bool success = parser.parseFromFile("yolov8s-obb.onnx", verbosity: 2);

// æ£æ¥ç®å­æ¯æ
bool supportsConv = parser.supportsOperator("Conv");

// å­å¾æ¯æ
long numSubgraphs = parser.getNbSubgraphs();
bool supported = parser.isSubgraphSupported(0);
long[] nodes = parser.getSubgraphNodes(0);

// è®¾ç½®è§£æå¨æ å¿
parser.setFlag(TrtOnnxParserFlag.kNATIVE_INSTANCENORM);
</code></pre>
<p><strong>ä¸»è¦ç¨é</strong>ï¼</p>
<ul>
<li>è§£æ ONNX æ¨¡å</li>
<li>æ£æ¥ç®å­æ¯æ</li>
<li>å¤çå­å¾</li>
</ul>
<h3 id="57-cuda-åå­ç®¡ç">5.7 CUDA åå­ç®¡ç</h3>
<h4 id="1è®¾å¤åå­cuda1dmemory">ï¼1ï¼è®¾å¤åå­ï¼Cuda1DMemory<t>ï¼</t></h4>
<pre><code class="language-csharp">// åå»ºè®¾å¤åå­
using Cuda1DMemory&lt;float&gt; input = new Cuda1DMemory&lt;float&gt;(1000);
ulong numElements = input.SizeElements;
ulong numBytes = input.SizeBytes;
IntPtr ptr = input.DevicePointer;

// åæ­¥æ°æ®ä¼ è¾
float[] hostData = new float[1000];
input.copyFromHost(hostData);   // ä¸»æº â è®¾å¤
input.copyToHost(hostData);      // è®¾å¤ â ä¸»æº

// å¼æ­¥æ°æ®ä¼ è¾
using CudaStream stream = new CudaStream();
input.copyFromHostAsync(hostData, stream);
input.copyToHostAsync(hostData, stream);

// åå­æä½
input.memset(0);                 // å¡«åä¸º 0
input.memsetAsync(0, stream);    // å¼æ­¥å¡«å
</code></pre>
<h4 id="2cuda-æµcudastream">ï¼2ï¼CUDA æµï¼CudaStreamï¼</h4>
<pre><code class="language-csharp">// åå»ºæµï¼å¸¦ä¼åçº§ï¼
using CudaStream stream = new CudaStream();
using CudaStream streamHigh = new CudaStream(0, -1);  // é«ä¼åçº§

// åæ­¥æä½
stream.Synchronize();  // ç­å¾æµå®æ
bool isComplete = stream.Query();  // æ¥è¯¢æ¯å¦å®æ

// äºä»¶ä¾èµ
using CudaEvent cudaEvent = new CudaEvent();
stream.WaitEvent(cudaEvent);  // ç­å¾äºä»¶

// æ·»å åè°
stream.AddCallback((streamPtr, statue, userData) =&gt;
{
    Console.WriteLine("Stream callback executed");
}, IntPtr.Zero, 0);

// CUDA Graph æè·
stream.BeginCapture(CudaStreamCaptureMode.Global);
// ... æ§è¡æä½ ...
CudaGraph_t graph = stream.EndCapture();
</code></pre>
<h4 id="3cuda-è®¾å¤cudadevice">ï¼3ï¼CUDA è®¾å¤ï¼CudaDeviceï¼</h4>
<pre><code class="language-csharp">// è·åç³»ç»ä¸­å¯ç¨ç CUDA å¼å®¹è®¾å¤çæ°é
int nbDevices = CudaDevice.GetDeviceCount();

// è·åæå®è®¾å¤çå±æ§
CudaDeviceProp properties = CudaDevice.GetDeviceProperties(deviceIdx);

// è®¾ç½®æ§è¡è®¾å¤
CudaDevice.SetDevice(device);

// è·åæå³è®¾å¤çè¯·æ±ä¿¡æ¯
int clockRate = CudaDevice.GetAttribute(CudaDeviceAttr.ClockRate, device);
</code></pre>
<hr>
<h2 id="å­å®æ´ä½¿ç¨ç¤ºä¾">å­ãå®æ´ä½¿ç¨ç¤ºä¾</h2>
<h3 id="ç¤ºä¾-1è·ååè®¾ç½®è®¾å¤ä¿¡æ¯">ç¤ºä¾ 1ï¼è·ååè®¾ç½®è®¾å¤ä¿¡æ¯</h3>
<p>ä¸é¢çä»£ç å¯ä»¥è·åå½åè®¾å¤çç¸å³ä¿¡æ¯ï¼åæ¶å¯ä»¥è®¾ç½®æ¨çè®¾å¤ã</p>
<pre><code class="language-csharp">using JYPPX.TensorRtSharp.Cuda;
using JYPPX.TensorRtSharp.Nvinfer;

namespace TestDemo
{
    internal class Program
    {
        static void Main(string[] args)
        {
            // æå®é»è®¤ä½¿ç¨ç GPU è®¾å¤ç´¢å¼
            // å¨å¤ GPU ç¯å¢ä¸ï¼å¯ä»¥éè¿ä¿®æ¹æ­¤åéæ¥éæ©ç¹å®çæ¾å¡
            int device = 0;

            // è®°å½æ¥å¿ï¼æ è®°è®¾å¤ä¿¡æ¯æ¥è¯¢çå¼å§
            Logger.Instance.INFO("=== Device Information ===");

            // è·åå½åç³»ç»ä¸­å¯è§ç NVIDIA GPU æ°é
            int nbDevices = CudaDevice.GetDeviceCount();

            // æ£æ¥ç³»ç»ä¸­æ¯å¦å­å¨å¯ç¨ç GPU è®¾å¤
            if (nbDevices &lt;= 0)
            {
                Logger.Instance.ERROR("Cannot find any available devices (GPUs)!");
                Environment.Exit(0);
            }

            // æå°ææå¯ç¨è®¾å¤çåè¡¨
            Logger.Instance.INFO("Available Devices: ");

            // éåç³»ç»ä¸­çæ¯ä¸ä¸ª GPU
            for (int deviceIdx = 0; deviceIdx &lt; nbDevices; ++deviceIdx)
            {
                // è·åç´¢å¼ä¸º deviceIdx ç GPU çè¯¦ç»å±æ§
                CudaDeviceProp tempProperties = CudaDevice.GetDeviceProperties(deviceIdx);

                // æå°è®¾å¤ IDãè®¾å¤åç§°ä»¥å UUID (å¯ä¸æ è¯ç¬¦)
                Logger.Instance.INFO($"  Device {deviceIdx}: \"{tempProperties.Name}\" UUID: {GetUuidString(tempProperties.Uuid)}");

                // å¦æå½åéåå°çè®¾å¤ ID æ¯æä»¬æ³è¦ä½¿ç¨çç®æ è®¾å¤
                // åå°è¯¥è®¾å¤çå±æ§ä¿å­ä¸æ¥ï¼ä¾åç»­ä½¿ç¨
                if (deviceIdx == device)
                {
                    properties = tempProperties;
                }
            }

            // å®å¨æ£æ¥ï¼ç¡®ä¿è¯·æ±çç®æ è®¾å¤ ID å¨ææèå´å
            if (device &lt; 0 || device &gt;= nbDevices)
            {
                Logger.Instance.ERROR($"Cannot find device ID {device}!");
                Environment.Exit(0);
            }

            // å° CUDA ä¸ä¸æè®¾ç½®å°æå®ç GPU è®¾å¤ä¸
            CudaDevice.SetDevice(device);

            // æå°éå®è®¾å¤çè¯¦ç»ä¿¡æ¯
            Logger.Instance.INFO($"Selected Device: {properties.Name}");
            Logger.Instance.INFO($"Selected Device ID: {device}");
            Logger.Instance.INFO($"Selected Device UUID: {GetUuidString(properties.Uuid)}");
            Logger.Instance.INFO($"Compute Capability: {properties.Major}.{properties.Minor}");
            Logger.Instance.INFO($"SMs: {properties.MultiProcessorCount}");
            Logger.Instance.INFO($"Device Global Memory: {(properties.TotalGlobalMem + 20)} MiB");
            Logger.Instance.INFO($"Shared Memory per SM: {(properties.SharedMemPerMultiprocessor &gt;&gt; 10)} KiB");
            Logger.Instance.INFO($"Memory Bus Width: {properties.MemoryBusWidth} bits (ECC {(properties.ECCEnabled != 0 ? "enabled" : "disabled")})");

            // è·åå¹¶æå° GPU æ ¸å¿æ¶éé¢çåæ¾å­æ¶éé¢ç
            int clockRate = CudaDevice.GetAttribute(CudaDeviceAttr.ClockRate, device);
            int memoryClockRate = CudaDevice.GetAttribute(CudaDeviceAttr.MemoryClockRate, device);

            Logger.Instance.INFO($"Application Compute Clock Rate: {clockRate / 1000000.0F} GHz");
            Logger.Instance.INFO($"Application Memory Clock Rate: {memoryClockRate / 1000000.0F} GHz");
        }

        /// &lt;summary&gt;
        /// è¾å©æ¹æ³ï¼å° CudaUUID ç»æä½è½¬æ¢ä¸ºæ ¼å¼åç GPU UUID å­ç¬¦ä¸²
        /// æ ¼å¼éå¸¸ä¸ºï¼GPU-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
        /// &lt;/summary&gt;
        public static string GetUuidString(CudaUUID uuid)
        {
            int kUUID_SIZE = uuid.Bytes.Length;
            var ss = new System.Text.StringBuilder();

            // å®ä¹ UUID çåæ®µç¹ï¼ç¨äºæå¥è¿å­ç¬¦ "-"
            int[] splits = { 0, 4, 6, 8, 10, kUUID_SIZE };

            // æ·»å åºå®ç "GPU" åç¼
            ss.Append("GPU");

            // éååæ®µå®ä¹ï¼æ ¼å¼åæ¯ä¸é¨åçå­è
            for (int splitIdx = 0; splitIdx &lt; splits.Length - 1; ++splitIdx)
            {
                ss.Append("-");
                for (int byteIdx = splits[splitIdx]; byteIdx &lt; splits[splitIdx + 1]; ++byteIdx)
                {
                    ss.AppendFormat("{0:x2}", uuid.Bytes[byteIdx]);
                }
            }

            return ss.ToString();
        }
    }
}
</code></pre>
<p><strong>ç¨åºè¿è¡ç»æï¼</strong></p>
<p><img alt="è®¾å¤ä¿¡æ¯è¾åº" loading="lazy" data-src="https://img2024.cnblogs.com/blog/2933426/202601/2933426-20260111184155226-526554276.png" class="lazyload"></p>
<blockquote>
<p><strong>ð¡ æ³¨æ</strong>ï¼ä¸åçè®¾å¤è¾åºä¼æä¸åï¼ä»¥å·ä½è®¾å¤è¾åºä¸ºåã</p>
<p>ð<strong>ç¨åºè·¯å¾é¾æ¥</strong>ï¼å®æ´ç¨åºå·²ç»ä¸ä¼ å°GitHubï¼è¯·èªè¡ä¸è½½ï¼é¾æ¥ä¸ºï¼</p>
<pre><code>https://github.com/guojin-yan/TensorRT-CSharp-API/tree/TensorRtSharp3.0/samples/SetCudaDeviceInfo
</code></pre>
</blockquote>
<hr>
<h3 id="ç¤ºä¾-2onnx-è½¬-engine-æ¨¡å">ç¤ºä¾ 2ï¼ONNX è½¬ Engine æ¨¡å</h3>
<p>ä¸é¢æ¯æç§å®æ¹æ¨¡åè½¬æ¢ä»£ç ç¼åçä¸ä¸ªç®åçè½¬æ¢ä»£ç ï¼</p>
<pre><code class="language-csharp">using JYPPX.TensorRtSharp.Cuda;
using JYPPX.TensorRtSharp.Nvinfer;

namespace OnnxToEngine
{
    internal class Program
    {
        static void Main(string[] args)
        {
            // === éç½® TensorRT æ¥å¿åè° ===
            // å®ä¹ä¸ä¸ªå§æï¼ç¨äºå¤ç TensorRT åé¨äº§ççæ¥å¿æ¶æ¯
            LogCallbackFunction _callbackDelegate = (message) =&gt;
            {
                Console.WriteLine(message);
            };

            // å°èªå®ä¹çåè°å½æ°æ³¨åç» TensorRT çå¨å± Logger å®ä¾
            Logger.Instance.SetCallback(_callbackDelegate);

            // è®¾ç½®æ¥å¿çä¸¥éæ§çº§å«éå¼
            // LoggerSeverity.kINFO: æå°ä¿¡æ¯ãè­¦ååéè¯¯
            Logger.Instance.SetThreshold(LoggerSeverity.kINFO);

            // 1. åå»º TensorRT Builder (æå»ºå¨)
            Builder build = new Builder();

            // 2. åå»ºç½ç»å®ä¹ (Network Definition)
            // æ¾å¼æ¹å¤ç æ å¿è¡¨ç¤ºç½ç»å®ä¹ä¸­æ¾å¼åå«æ¹å¤çç»´åº¦
            NetworkDefinition networkDefinition = build.createNetworkV2(TrtNetworkDefinitionCreationFlag.kEXPLICIT_BATCH);

            // 3. åå»ºæå»ºå¨éç½®
            BuilderConfig builderConfig = build.createBuilderConfig();

            // 4. åå»º ONNX è§£æå¨
            OnnxParser onnxParser = new OnnxParser(networkDefinition);

            // æå®å¾è½¬æ¢ç ONNX æ¨¡åæä»¶è·¯å¾
            string modelpath = "yolo11s-obb.onnx";

            // 5. è§£æ ONNX æ¨¡åæä»¶
            // åæ° 2: æ¥å¿çº§å« (1=ERROR, 2=WARNING, 3=INFO, 4=VERBOSE)
            if (onnxParser.parseFromFile(modelpath, 2) == false)
            {
                Console.WriteLine($"parse onnx model failed");
                return;
            }

            // 6. è®¾ç½®æå»ºç²¾åº¦æ å¿
            // kFP16: å¯ç¨åç²¾åº¦ (FP16) æ¨çæ¨¡å¼
            builderConfig.setFlag(TrtBuilderFlag.kFP16);

            // 7. åå»º CUDA æµ
            CudaStream cudaStream = new CudaStream();

            // 8. è®¾ç½®ä¼åéç½®æä»¶çæµ
            builderConfig.setProfileStream(cudaStream);

            // 9. æå»ºå¹¶åºååç½ç»
            // è¿æ¯ä¸ä¸ªèæ¶è¾é¿çè¿ç¨ï¼å ä¸º TensorRT ä¼è¿è¡åæ ¸èªå¨è°ä¼ãå±èåç­ä¼å
            HostMemory hostMemory = build.buildSerializedNetwork(networkDefinition, builderConfig);

            // 10. ä¿å­ Engine å°ç£ç
            string filePath = "yolo11s-obb.engine";
            using (FileStream fs = new FileStream(filePath, FileMode.Create, FileAccess.Write))
            {
                fs.Write(hostMemory.getByteData(), 0, (int)hostMemory.Size);
            }

            Console.WriteLine("Engine saved successfully!");
        }
    }
}
</code></pre>
<p><strong>ç¨åºè¿è¡ç»æï¼</strong></p>
<p><img alt="ONNX è½¬æ¢ç»æ" loading="lazy" data-src="https://img2024.cnblogs.com/blog/2933426/202601/2933426-20260111184155199-25493962.png" class="lazyload"></p>
<blockquote>
<p>ð<strong>ç¨åºè·¯å¾é¾æ¥</strong>ï¼å®æ´ç¨åºå·²ç»ä¸ä¼ å°GitHubï¼è¯·èªè¡ä¸è½½ï¼é¾æ¥ä¸ºï¼</p>
<pre><code>https://github.com/guojin-yan/TensorRT-CSharp-API/tree/TensorRtSharp3.0/samples/OnnxToEngine
</code></pre>
</blockquote>
<hr>
<h3 id="-ä½¿ç¨-trtexec-å·¥å·è½¬æ¢æ¨¡åæ¨è">ð¡ ä½¿ç¨ trtexec å·¥å·è½¬æ¢æ¨¡åï¼æ¨èï¼</h3>
<p>å½å ONNX è½¬ Engine ä»£ç ç±äºæ²¡æè¿è¡ä¼åï¼è½¬æ¢éåº¦ä¼è¾æ¢ã<strong>å»ºè®®ä½¿ç¨ TensorRT SDK èªå¸¦ç <code>trtexec.exe</code> å·¥å·è½¬æ¢æ¨¡å</strong>ã</p>
<h4 id="trtexec-ä½¿ç¨æ¹å¼">trtexec ä½¿ç¨æ¹å¼</h4>
<p><strong>ï¼1ï¼ä½¿ç¨ CMD åæ¢å°å·¥å·ç®å½</strong></p>
<p>è¯¥å·¥å·å­æ¾å¨ä¸è½½ç TensorRT åºä¸­ï¼</p>
<p><img alt="trtexec ä½ç½®" loading="lazy" data-src="https://img2024.cnblogs.com/blog/2933426/202601/2933426-20260111184155192-868591871.png" class="lazyload"></p>
<p>æå¼ CMD å¹¶åæ¢å°è¯¥è·¯å¾ï¼</p>
<p><img alt="CMD åæ¢è·¯å¾" loading="lazy" data-src="https://img2024.cnblogs.com/blog/2933426/202601/2933426-20260111184155220-2043771179.png" class="lazyload"></p>
<p><strong>ï¼2ï¼åºå®å½¢ç¶æ¨¡åè½¬æ¢æä»¤</strong></p>
<p>å¯¹äºå½¢ç¶åºå®çæ¨¡åï¼ç´æ¥è¾å¥å¸¸è§æä»¤è½¬æ¢å³å¯ï¼</p>
<pre><code class="language-bash">trtexec.exe --onnx=yolov8s-obb.onnx --saveEngine=yolov8s-obb.engine --fp16 --workspace=1024
</code></pre>
<p><strong>åæ°è¯´æï¼</strong></p>
<ul>
<li><code>--onnx=yolov8s-obb.onnx</code>ï¼æå®è¾å¥ç ONNX æ¨¡åæä»¶è·¯å¾</li>
<li><code>--saveEngine=yolov8s-obb.engine</code>ï¼æå®è¾åºç Engine æä»¶ä¿å­è·¯å¾</li>
<li><code>--fp16</code>ï¼å¯ç¨ FP16 ç²¾åº¦ï¼å¯éï¼</li>
<li><code>--workspace=1024</code>ï¼æå®æå¤§å·¥ä½ç©ºé´ï¼åä½ MBï¼å¯éï¼</li>
</ul>
<p><img alt="trtexec è½¬æ¢ä¸­" loading="lazy" data-src="https://img2024.cnblogs.com/blog/2933426/202601/2933426-20260111184155240-1040135131.png" class="lazyload"></p>
<p><strong>ï¼3ï¼å¨æå½¢ç¶æ¨¡åè½¬æ¢æä»¤</strong></p>
<p>å¯¹äºè¾å¥å½¢ç¶æ¯å¨æçæåµï¼è½¬æ¢æ¶è¦è®¾ç½®å½¢ç¶åæ°ï¼</p>
<pre><code class="language-bash">trtexec.exe --onnx=yolov8s-obb_b.onnx --saveEngine=yolov8s-obb_b.engine --fp16 --minShapes=images:1x3x1024x1024 --optShapes=images:8x3x1024x1024 --maxShapes=images:24x3x1024x1024
</code></pre>
<p><strong>åæ°è¯´æï¼</strong></p>
<ul>
<li><code>--minShapes=images:1x3x1024x1024</code>ï¼æå°è¾å¥å½¢ç¶</li>
<li><code>--optShapes=images:8x3x1024x1024</code>ï¼æä¼è¾å¥å½¢ç¶ï¼Engine ä¼ä¸ºæ­¤å½¢ç¶ä¼åï¼</li>
<li><code>--maxShapes=images:24x3x1024x1024</code>ï¼æå¤§è¾å¥å½¢ç¶</li>
</ul>
<p><img alt="å¨æå½¢ç¶è½¬æ¢" loading="lazy" data-src="https://img2024.cnblogs.com/blog/2933426/202601/2933426-20260111184155195-1777862369.png" class="lazyload"></p>
<p><strong>å¤è¾å¥æ¨¡åè½¬æ¢æä»¤ï¼</strong></p>
<pre><code class="language-bash">trtexec --onnx=model.onnx --minShapes=input1:1x3x224x224,input2:1x256 --optShapes=input1:4x3x224x224,input2:4x256 --maxShapes=input1:8x3x224x224,input2:8x256
</code></pre>
<hr>
<h3 id="ç¤ºä¾-3yolo-ç®æ æ£æµ">ç¤ºä¾ 3ï¼YOLO ç®æ æ£æµ</h3>
<p>ä¸é¢æ¯ä¸ä¸ªå®æ´ç YOLO ç®æ æ£æµç¤ºä¾ï¼å±ç¤ºä»æ¨¡åæå»ºå°æ¨ççå¨æµç¨ã</p>
<blockquote>
<p><strong>â ï¸ ç±äºä»£ç è¾é¿ï¼æ­¤å¤ä»å±ç¤ºæ ¸å¿æè·¯ãå®æ´ä»£ç è¯·åèé¡¹ç®ç¤ºä¾ã</strong></p>
</blockquote>
<pre><code class="language-csharp">using JYPPX.TensorRtSharp.Cuda;
using JYPPX.TensorRtSharp.Nvinfer;
using OpenCvSharp;
using OpenCvSharp.Dnn;
using System.Diagnostics;
using System.Runtime.InteropServices;

namespace YoloDetInfer
{
    internal class Program
    {
        // ================= éç½®åæ° =================
        // æ¨¡åè¾å¥å°ºå¯¸ (å®½=é«)
        private const int InputSize = 640;


        // å»ºè®®æ ¹æ®å®éæ¨¡åå¨æè·åæä½¿ç¨ Netron æ¥ç
        private const int OutputSize = 8400;

        // æ¨¡åç±»å«æ° (æ ¹æ®æ¨çå·ä½æ°æ®éä¿®æ¹ï¼æ­¤å¤åè®¾ä¸º15ç±»)
        private const int CategoryNum = 80;

        // ç½®ä¿¡åº¦éå¼
        private const float ConfThreshold = 0.25f;

        // NMS IOU éå¼
        private const float NmsThreshold = 0.3f;

        static void Main(string[] args)
        {
            //  ============= éç½® TensorRT æ¥å¿åè° =============
            // å®ä¹ä¸ä¸ªå§æï¼ç¨äºå¤ç TensorRT åé¨äº§ççæ¥å¿æ¶æ¯ã
            // è¿åè®¸æä»¬å° C++ å±é¢çæ¥å¿è¾åºå° C# çæ§å¶å°ã
            LogCallbackFunction _callbackDelegate = (message) =&gt;
            {
                Console.WriteLine(message);
            };

            // å°èªå®ä¹çåè°å½æ°æ³¨åç» TensorRT çå¨å± Logger å®ä¾ã
            Logger.Instance.SetCallback(_callbackDelegate);

            // è®¾ç½®æ¥å¿çä¸¥éæ§çº§å«éå¼ã
            // LoggerSeverity.kINFO: æå°ä¿¡æ¯ãè­¦ååéè¯¯ã
            // å¼åè°è¯é¶æ®µéå¸¸è®¾ä¸º kINFO æ kVERBOSEï¼çäº§ç¯å¢å¯è®¾ä¸º kWARNING æ kERROR ä»¥åå°è¾åºã
            Logger.Instance.SetThreshold(LoggerSeverity.kINFO);

            string enginePath = "yolov8s.engine";
            string imagePath = "bus.jpg";


            // ================= 1. å è½½ TensorRT Engine =================
            // ä½¿ç¨ using è¯­å¥ç¡®ä¿æä»¶æµæ­£ç¡®å³é­
            byte[] engineData;
            using (FileStream fs = new FileStream(enginePath, FileMode.Open, FileAccess.Read))
            using (BinaryReader br = new BinaryReader(fs))
            {
                engineData = br.ReadBytes((int)fs.Length);
            }

            // ååºåå Engine
            // Runtime å¿é¡»å¨ Engine çå½å¨æåä¿æå­æ´»ï¼éå¸¸å»ºè®®è®¾ä¸ºå¨å±æéæï¼æèç¡®ä¿å®æåéæ¾
            Runtime runtime = new Runtime();

            // åå»º CudaEngine (æ­¤å¤ä½¿ç¨ using ç¡®ä¿æ¨çå®æåå¼æè¢«éæ¯)
            using (CudaEngine cudaEngine = runtime.deserializeCudaEngineByBlob(engineData, (ulong)engineData.Length))
            {
                // ================= 2. åå§åæ¨çä¸ä¸æä¸æ¾å­ =================
                // åå»ºæ§è¡ä¸ä¸æ
                using (JYPPX.TensorRtSharp.Nvinfer.ExecutionContext executionContext = cudaEngine.createExecutionContext(TrtExecutionContextAllocationStrategy.kSTATIC))
                using (CudaStream cudaStream = new CudaStream()) // åå»º CUDA æµç¨äºå¼æ­¥æ§è¡
                {
                    // è·åè¾å¥ç»´åº¦ä¿¡æ¯ (ç¨äºæ ¡éª)
                    Dims inputDims = executionContext.getTensorShape("images");
                    Logger.Instance.INFO($"Input Shape: {inputDims.d[0]}x{inputDims.d[1]}x{inputDims.d[2]}x{inputDims.d[3]}");

                    // è®¡ç®æéæ¾å­å¤§å°
                    // è¾å¥: Batch=1, Channel=3, Height=640, Width=640
                    ulong inputSizeInBytes = 1 * 3 * InputSize * InputSize;
                    // è¾åº: Batch=1, Channels=CategoryNum+4(box)+1(angle), Num=8400
                    int outputChannels = CategoryNum + 4; // 4åæ  + Nç±»å«
                    ulong outputSizeInBytes = (ulong)(1 * outputChannels * OutputSize);

                    Stopwatch sw = new Stopwatch();
                    // åé GPU æ¾å­
                    using (Cuda1DMemory&lt;float&gt; inputGpuMemory = new Cuda1DMemory&lt;float&gt;(inputSizeInBytes))
                    using (Cuda1DMemory&lt;float&gt; outputGpuMemory = new Cuda1DMemory&lt;float&gt;(outputSizeInBytes))
                    {
                        // ç»å®æ¾å­å°åå° TensorRT ä¸ä¸æ
                        executionContext.setInputTensorAddress("images", inputGpuMemory.get());
                        executionContext.setOutputTensorAddress("output0", outputGpuMemory.get());
                        // é¢ç­æ¨ç (å¯éï¼ä½æ¨èï¼å°¤å¶æ¯é¦æ¬¡æ¨çæ¶)
                        executionContext.executeV3(cudaStream);
                        cudaStream.Synchronize();
                        // ================= 3. å¾åé¢å¤ç =================
                        Mat img = Cv2.ImRead(imagePath);
                        if (img.Empty())
                        {
                            Logger.Instance.INFO("Image not found!");
                            return;
                        }

                        sw.Start();
                        float[] inputData = PreProcess(img, out float scale, out int xOffset, out int yOffset);
                        sw.Stop();
                        Logger.Instance.INFO($"Pre-processing time: {sw.ElapsedMilliseconds} ms");
                        // ================= 4. æ¨ç =================
                        // åå¤ä¸»æºåå­æ¥æ¶ç»æ
                        float[] outputData = new float[outputChannels * OutputSize];


                        sw.Restart();
                        // å°æ°æ®ä»ä¸»æº æ·è´å°è®¾å¤
                        inputGpuMemory.copyFromHostAsync(inputData, cudaStream);

                        // æ§è¡æ¨ç (enqueueV3 æ¯å¼æ­¥ç)
                        executionContext.executeV3(cudaStream);
                        // ç­å¾æ¨çå®æ
                        cudaStream.Synchronize();

           

                        // å°ç»æä»è®¾å¤ æ·è´åä¸»æº
                        // è¿éçæ·è´æ¯åæ­¥çï¼ä¼ç­å¾ GPU è®¡ç®å®æ
                        outputGpuMemory.copyToHostAsync(outputData, cudaStream);
                        sw.Stop();
                        Logger.Instance.INFO($"Inference time: {sw.ElapsedMilliseconds} ms");
                        // ================= 5. åå¤ç =================

                        sw.Restart();
                        List&lt;DetData&gt; results = PostProcess(outputData, scale, xOffset, yOffset);
                        sw.Stop();
                        Logger.Instance.INFO($"Post-processing time: {sw.ElapsedMilliseconds} ms");

                        // ================= 6. ç»æå¯è§å =================
                        Mat resultImg = DrawDetResult(results, img);
                        Cv2.ImShow("YOLO11-DET Result", resultImg);
                        Cv2.WaitKey(0);
                    }
                }
            }
        }

        /// &lt;summary&gt;
        /// å¾åé¢å¤çï¼Letterbox ç¼©æ¾ãå½ä¸åãHWC è½¬ CHW
        /// &lt;/summary&gt;
        private static float[] PreProcess(Mat img, out float scale, out int xOffset, out int yOffset)
        {
            // è½¬æ¢é¢è²ç©ºé´ BGR -&gt; RGB
            Mat rgbImg = new Mat();
            Cv2.CvtColor(img, rgbImg, ColorConversionCodes.BGR2RGB);

            // è®¡ç® Letterbox ç¼©æ¾æ¯ä¾
            int maxDim = Math.Max(rgbImg.Width, rgbImg.Height);
            scale = (float)maxDim / InputSize;

            // è®¡ç®ç¼©æ¾åçå°ºå¯¸
            int newWidth = (int)(rgbImg.Width / scale);
            int newHeight = (int)(rgbImg.Height / scale);

            // Resize å¾å
            Mat resizedImg = new Mat();
            Cv2.Resize(rgbImg, resizedImg, new Size(newWidth, newHeight));

            // åå»ºé»è²èæ¯ Canvas (InputSize x InputSize)
            Mat paddedImg = Mat.Zeros(InputSize, InputSize, MatType.CV_8UC3);

            // è®¡ç®ç²è´´ä½ç½® (å±ä¸­)
            xOffset = (InputSize - newWidth) / 2;
            yOffset = (InputSize - newHeight) / 2;

            // å°å¾åæ·è´å° Canvas ä¸­å¤®
            Rect roi = new Rect(xOffset, yOffset, newWidth, newHeight);
            resizedImg.CopyTo(new Mat(paddedImg, roi));

            // å½ä¸å (0-255 -&gt; 0-1) å¹¶è½¬ä¸º float ç±»å
            Mat floatImg = new Mat();
            paddedImg.ConvertTo(floatImg, MatType.CV_32FC3, 1.0 / 255.0);

            // HWC è½¬ CHW å¹¶å±å¹³ä¸ºä¸ç»´æ°ç»
            Mat[] channels = Cv2.Split(floatImg);
            float[] chwData = new float[3 * InputSize * InputSize];

            // æ·è´æ°æ®ï¼Réé -&gt; Céé -&gt; Béé (OpenCV Split åºæ¥é¡ºåºæ¯ B, G, Rï¼å¯¹åºç´¢å¼ 0, 1, 2)
            int channelSize = InputSize * InputSize;
            // å° R, G, B ä¾æ¬¡æ·å¥æ°ç»
            Marshal.Copy(channels[0].Data, chwData, 0, channelSize); // R
            Marshal.Copy(channels[1].Data, chwData, channelSize, channelSize); // G
            Marshal.Copy(channels[2].Data, chwData, channelSize * 2, channelSize); // B

            // éæ¾ä¸´æ¶ Mat
            rgbImg.Dispose();
            resizedImg.Dispose();
            paddedImg.Dispose();
            floatImg.Dispose();
            foreach (var c in channels) c.Dispose();

            return chwData;
        }

        /// &lt;summary&gt;
        /// åå¤çï¼è§£æ TensorRT è¾åºãNMS è¿æ»¤
        /// &lt;/summary&gt;
        private static List&lt;DetData&gt; PostProcess(float[] result, float scale, int xOffset, int yOffset)
        {
            List&lt;Rect&gt; boxes = new List&lt;Rect&gt;();
            List&lt;float&gt; confidences = new List&lt;float&gt;();
            List&lt;int&gt; classIds = new List&lt;int&gt;();

            // éåææé¢æµæ¡ (OutputSize)
            // æ°æ®å¸å±: [4(box) + 80(classes)] * OutputSize
            // å±å¹³æ°ç»ä¸­ï¼åä¸å±æ§çæ°æ®æ¯è¿ç»­å­å¨çï¼ä¾å¦ææ cx å¨ä¸èµ·ï¼ææ cy å¨å¨ä¸èµ·...
            int stride = OutputSize; // æ­¥é¿ï¼ä¸åå±æ§å¨æ°ç»ä¸­çåç§»é

            for (int i = 0; i &lt; OutputSize; i++)
            {
                // æ¥æ¾æå¤§ç±»å«æ¦çåå¶ç´¢å¼
                float maxConf = 0;
                int maxClassId = -1;

                // éåç±»å«
                for (int c = 0; c &lt; CategoryNum; c++)
                {
                    // æ°ç»ç´¢å¼ï¼(åæ /è§åº¦åç§»é + ç±»å«åç§») * æ¡ç´¢å¼
                    // æ³¨æï¼åå§ä»£ç ä¸­ result[outputSize * j + i] è¿ç§è®¿é®æ¹å¼åºäº Transposed æ°æ®å¸å±
                    float conf = result[(4 + c) * stride + i];
                    if (conf &gt; maxConf)
                    {
                        maxConf = conf;
                        maxClassId = c;
                    }
                }

                // ç½®ä¿¡åº¦è¿æ»¤
                if (maxConf &gt; ConfThreshold)
                {
                    // æååæ  (cx, cy, w, h)
                    float cx = result[0 * stride + i];
                    float cy = result[1 * stride + i];
                    float w = result[2 * stride + i];
                    float h = result[3 * stride + i];
                    // è¿ååæ å°åå¾å°ºå¯¸
                    int rx = (int)((cx - xOffset - 0.5 * w) * scale);
                    int ry = (int)((cy - yOffset - 0.5 * h) * scale);
                    int rw = (int)(w * scale);
                    int rh = (int)(h * scale);

                    boxes.Add(new Rect(rx, ry, rw, rh));
                    confidences.Add(maxConf);
                    classIds.Add(maxClassId);
                }
            }

            // æ§è¡ NMS (æè½¬æ¡ NMS)
            // OpenCV ç NMSBoxes æ¯æ RotatedRect
            int[] indices;
            CvDnn.NMSBoxes(boxes, confidences, ConfThreshold, NmsThreshold, out indices);

            List&lt;DetData&gt; finalResults = new List&lt;DetData&gt;();
            foreach (int idx in indices)
            {
                finalResults.Add(new DetData
                {
                    index = classIds[idx],
                    score = confidences[idx],
                    box = boxes[idx]
                });
            }

            return finalResults;
        }

        /// &lt;summary&gt;
        /// ç»å¶æ£æµç»æï¼æ°´å¹³ç©å½¢æ¡ï¼
        /// &lt;/summary&gt;
        /// &lt;param name="results"&gt;æ£æµç»æåè¡¨&lt;/param&gt;
        /// &lt;param name="image"&gt;åå§å¾å&lt;/param&gt;
        /// &lt;returns&gt;ç»å¶åçå¾å&lt;/returns&gt;
        public static Mat DrawDetResult(List&lt;DetData&gt; results, Mat image)
        {
            // åéå¾åä»¥åä¿®æ¹åå¾
            Mat mat = image.Clone();

            foreach (var item in results)
            {
                // 1. ç»å¶ç©å½¢æ¡
                // Rect ç»æåå« X, Y, Width, Height
                Cv2.Rectangle(mat, item.box, new Scalar(0, 255, 0), thickness: 2);
                // 2. åå¤æ ç­¾ææ¬ (ç±»å«ID - ç½®ä¿¡åº¦)
                string label = $"{item.index} - {item.score:F2}";
                // 3. è®¡ç®ææ¬çå°ºå¯¸ï¼ç¨äºç»å¶èæ¯
                int baseLine = 1;
                Size textSize = Cv2.GetTextSize(label, HersheyFonts.HersheySimplex, 0.6, 1, out baseLine);
                // 4. ç»å¶æ ç­¾èæ¯ï¼åéæé»è²ç©å½¢ï¼ï¼é²æ­¢æå­ä¸èæ¯æ··æ·
                // ä½ç½®ï¼ç©å½¢å·¦ä¸è§ç¥å¾®ä¸ç§»ï¼æèç´æ¥è´´çå·¦ä¸è§
                Point labelPosition = new Point(item.box.X, item.box.Y - (int)textSize.Height - 5);

                // ç¡®ä¿æ ç­¾ä¸ç»åºå¾åè¾¹ç
                if (labelPosition.Y &lt; 0) labelPosition.Y = item.box.Y + (int)textSize.Height + 5;
                Rect labelBgRect = new Rect(labelPosition.X,
                                            labelPosition.Y - (int)textSize.Height, // OpenCV GetTextSize è¿åçé«åº¦æ¯åºçº¿å°åºé¨çè·ç¦»ï¼éè°æ´
                                            (int)textSize.Width,
                                            (int)textSize.Height + (int)baseLine);
                // å¦æèæ¯æ¡ä¹å¨å¾åèå´åï¼åç»å¶
                // æ³¨æï¼è¿éç®åå¤çï¼ç´æ¥ç»å¨æ¡ä¸æ¹
                Cv2.Rectangle(mat,
                               new Point(item.box.X, item.box.Y - textSize.Height - 5),
                               new Point(item.box.X + textSize.Width, item.box.Y),
                               new Scalar(0, 255, 0),
                               thickness: -1); // -1 è¡¨ç¤ºå¡«å
                // 5. ç»å¶ææ¬ï¼ç½è²æå­ï¼
                Cv2.PutText(mat,
                            label,
                            new Point(item.box.X, item.box.Y - 5),
                            HersheyFonts.HersheySimplex,
                            0.6,
                            new Scalar(0, 0, 0),
                            1);
            }
            return mat;
        }

        public class DetData
        {
            public int index;
            public float score;
            public Rect box;
        }
    }
}


</code></pre>
<p><strong>ç¨åºè¿è¡ç»æï¼</strong></p>
<p><img alt="æ¨çç»æ" loading="lazy" data-src="https://img2024.cnblogs.com/blog/2933426/202601/2933426-20260111184155202-328383312.png" class="lazyload"></p>
<p><img alt="æ£æµç»æ" loading="lazy" data-src="https://img2024.cnblogs.com/blog/2933426/202601/2933426-20260111184155266-1783868853.png" class="lazyload"></p>
<p><strong>æ§è½æµè¯ç»æï¼</strong></p>
<table>
<thead>
<tr>
<th style="text-align: center">Batch Size</th>
<th style="text-align: center">1</th>
<th style="text-align: center">2</th>
<th style="text-align: center">4</th>
<th style="text-align: center">6</th>
<th style="text-align: center">8</th>
<th style="text-align: center">10</th>
<th style="text-align: center">12</th>
<th style="text-align: center">14</th>
<th style="text-align: center">16</th>
<th style="text-align: center">18</th>
<th style="text-align: center">20</th>
<th style="text-align: center">22</th>
<th style="text-align: center">24</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center">åå¤ç (ms)</td>
<td style="text-align: center">9</td>
<td style="text-align: center">13</td>
<td style="text-align: center">27</td>
<td style="text-align: center">38</td>
<td style="text-align: center">56</td>
<td style="text-align: center">59</td>
<td style="text-align: center">63</td>
<td style="text-align: center">83</td>
<td style="text-align: center">96</td>
<td style="text-align: center">105</td>
<td style="text-align: center">118</td>
<td style="text-align: center">130</td>
<td style="text-align: center">144</td>
</tr>
<tr>
<td style="text-align: center">æ¨¡åæ¨ç (ms)</td>
<td style="text-align: center">7</td>
<td style="text-align: center">15</td>
<td style="text-align: center">24</td>
<td style="text-align: center">36</td>
<td style="text-align: center">48</td>
<td style="text-align: center">60</td>
<td style="text-align: center">96</td>
<td style="text-align: center">84</td>
<td style="text-align: center">93</td>
<td style="text-align: center">153</td>
<td style="text-align: center">120</td>
<td style="text-align: center">133</td>
<td style="text-align: center">203</td>
</tr>
<tr>
<td style="text-align: center">åå¤ç (ms)</td>
<td style="text-align: center">25</td>
<td style="text-align: center">26</td>
<td style="text-align: center">26</td>
<td style="text-align: center">26</td>
<td style="text-align: center">28</td>
<td style="text-align: center">27</td>
<td style="text-align: center">27</td>
<td style="text-align: center">28</td>
<td style="text-align: center">28</td>
<td style="text-align: center">28</td>
<td style="text-align: center">27</td>
<td style="text-align: center">31</td>
<td style="text-align: center">29</td>
</tr>
</tbody>
</table>
<blockquote>
<p>ð<strong>ç¨åºè·¯å¾é¾æ¥</strong>ï¼å®æ´ç¨åºå·²ç»ä¸ä¼ å°GitHubï¼è¯·èªè¡ä¸è½½ï¼é¾æ¥ä¸ºï¼</p>
<pre><code>https://github.com/guojin-yan/TensorRT-CSharp-API/tree/TensorRtSharp3.0/samples/YoloDetInfer
</code></pre>
<p>åæ¶ä¹æä¾äº<strong>YoloOBB</strong>æ¨¡åçæ¨çç¨åºï¼è¯·èªè¡ä¸è½½ï¼é¾æ¥ä¸ºï¼</p>
<pre><code>https://github.com/guojin-yan/TensorRT-CSharp-API/tree/TensorRtSharp3.0/samples/YoloObbInfer
</code></pre>
</blockquote>
<hr>
<h3 id="ç¤ºä¾-4å¨æå½¢ç¶æ¨ç">ç¤ºä¾ 4ï¼å¨æå½¢ç¶æ¨ç</h3>
<p>å¯¹äºè¾å¥å°ºå¯¸å¯åçæ¨¡åï¼éè¦æ ¹æ®è¾å¥çæ°æ®éç½®å¨æå½¢ç¶ã</p>
<p><strong>æ ¸å¿ä»£ç ï¼</strong></p>
<pre><code class="language-csharp">using JYPPX.TensorRtSharp.Cuda;
using JYPPX.TensorRtSharp.Nvinfer;
using OpenCvSharp;
using OpenCvSharp.Dnn;
using System.Diagnostics;
using System.Runtime.InteropServices;

namespace YoloObbBatchInfer
{
    internal class Program
    {
        // ================= éç½®åæ° =================
        // æ¨¡åè¾å¥å°ºå¯¸ (å®½=é«)
        private const int InputSize = 1024;
        // å»ºè®®æ ¹æ®å®éæ¨¡åå¨æè·åæä½¿ç¨ Netron æ¥ç
        private const int OutputSize = 21504;
        // æ¨¡åç±»å«æ° (æ ¹æ®æ¨çå·ä½æ°æ®éä¿®æ¹ï¼æ­¤å¤åè®¾ä¸º15ç±»)
        private const int CategoryNum = 15;
        // ç½®ä¿¡åº¦éå¼
        private const float ConfThreshold = 0.25f;

        // NMS IOU éå¼
        private const float NmsThreshold = 0.3f;
        private const int MaxBatchSize = 24;
        static void Main(string[] args)
        {
            //  ============= éç½® TensorRT æ¥å¿åè° =============
            // å®ä¹ä¸ä¸ªå§æï¼ç¨äºå¤ç TensorRT åé¨äº§ççæ¥å¿æ¶æ¯ã
            // è¿åè®¸æä»¬å° C++ å±é¢çæ¥å¿è¾åºå° C# çæ§å¶å°ã
            LogCallbackFunction _callbackDelegate = (message) =&gt;
            {
                Console.WriteLine(message);
            };
            // å°èªå®ä¹çåè°å½æ°æ³¨åç» TensorRT çå¨å± Logger å®ä¾ã
            Logger.Instance.SetCallback(_callbackDelegate);

            // è®¾ç½®æ¥å¿çä¸¥éæ§çº§å«éå¼ã
            // LoggerSeverity.kINFO: æå°ä¿¡æ¯ãè­¦ååéè¯¯ã
            // å¼åè°è¯é¶æ®µéå¸¸è®¾ä¸º kINFO æ kVERBOSEï¼çäº§ç¯å¢å¯è®¾ä¸º kWARNING æ kERROR ä»¥åå°è¾åºã
            Logger.Instance.SetThreshold(LoggerSeverity.kINFO);

            string enginePath = "yolov8s-obb_b.engine";
            string[] imagePaths = { 
                "P0006.png" , "P0016.png", "P0456.png", "P0813.png"};
            // ================= 1. å è½½ TensorRT Engine =================
            // ä½¿ç¨ using è¯­å¥ç¡®ä¿æä»¶æµæ­£ç¡®å³é­
            byte[] engineData;
            using (FileStream fs = new FileStream(enginePath, FileMode.Open, FileAccess.Read))
            using (BinaryReader br = new BinaryReader(fs))
            {
                engineData = br.ReadBytes((int)fs.Length);
            }

            // ååºåå Engine
            // Runtime å¿é¡»å¨ Engine çå½å¨æåä¿æå­æ´»ï¼éå¸¸å»ºè®®è®¾ä¸ºå¨å±æéæï¼æèç¡®ä¿å®æåéæ¾
            Runtime runtime = new Runtime();
            runtime.setMaxThreads(10);
            // åå»º CudaEngine (æ­¤å¤ä½¿ç¨ using ç¡®ä¿æ¨çå®æåå¼æè¢«éæ¯)
            using (CudaEngine cudaEngine = runtime.deserializeCudaEngineByBlob(engineData, (ulong)engineData.Length))
            {
                // ================= 2. åå§åæ¨çä¸ä¸æä¸æ¾å­ =================
                // åå»ºæ§è¡ä¸ä¸æ
                using (JYPPX.TensorRtSharp.Nvinfer.ExecutionContext executionContext = cudaEngine.createExecutionContext(TrtExecutionContextAllocationStrategy.kSTATIC))
                using (CudaStream cudaStream = new CudaStream()) // åå»º CUDA æµç¨äºå¼æ­¥æ§è¡
                {
                    // è·åè¾å¥ç»´åº¦ä¿¡æ¯ (ç¨äºæ ¡éª)
                    Dims inputDims = executionContext.getTensorShape("images");
                    Logger.Instance.INFO($"Input Shape: {inputDims.d[0]}x{inputDims.d[1]}x{inputDims.d[2]}x{inputDims.d[3]}");

                    // è®¡ç®æéæ¾å­å¤§å°
                    // è¾å¥: Batch=1, Channel=3, Height=1024, Width=1024
                    ulong inputSizeInBytes = MaxBatchSize * 3 * InputSize * InputSize;
                    // è¾åº: Batch=1, Channels=CategoryNum+4(box)+1(angle), Num=8400
                    int outputChannels = CategoryNum + 5; // 4åæ  + 1è§åº¦ + Nç±»å«
                    ulong outputSizeInBytes = (ulong)(MaxBatchSize * outputChannels * OutputSize);

                    Stopwatch sw = new Stopwatch();
                    // åé GPU æ¾å­
                    using (Cuda1DMemory&lt;float&gt; inputGpuMemory = new Cuda1DMemory&lt;float&gt;(inputSizeInBytes))
                    using (Cuda1DMemory&lt;float&gt; outputGpuMemory = new Cuda1DMemory&lt;float&gt;(outputSizeInBytes))
                    {
                        // ç»å®æ¾å­å°åå° TensorRT ä¸ä¸æ
                        executionContext.setInputTensorAddress("images", inputGpuMemory.get());
                        executionContext.setOutputTensorAddress("output0", outputGpuMemory.get());

                        // å³é®ä¸æ­¥ï¼ä¿®æ¹æ¬æ¬¡æ¨ççå½¢ç¶
                        executionContext.setinputShape("images", new Dims(imagePaths.Count(), 3, 1024, 1024));
                        // é¢ç­æ¨ç (å¯éï¼ä½æ¨èï¼å°¤å¶æ¯é¦æ¬¡æ¨çæ¶)
                        executionContext.executeV3(cudaStream);
                        cudaStream.Synchronize();

                        // ================= 3. å¾åé¢å¤ç =================
                        List&lt;Mat&gt; images = new List&lt;Mat&gt;();
                        foreach (var path in imagePaths) 
                        {
                            Mat img = Cv2.ImRead(path);
                            if (img.Empty())
                            {
                                Logger.Instance.INFO("Image not found!");
                                return;
                            }
                            images.Add(img);
                        }

                        (float[] inputData1, float[] scales1, int[] xOffsets1, int[] yOffsets1) = PreProcessBatch(images);
                        sw.Start();
                        (float[] inputData, float[] scales, int[] xOffsets, int[] yOffsets) = PreProcessBatch(images);
                        sw.Stop();
                        Logger.Instance.INFO($"Pre-processing time: {sw.ElapsedMilliseconds} ms");
                        // ================= 4. æ¨ç =================

                        // åå¤ä¸»æºåå­æ¥æ¶ç»æ
                        float[] outputData1 = new float[imagePaths.Count() * outputChannels * OutputSize];
                        // å°æ°æ®ä»ä¸»æº æ·è´å°è®¾å¤
                        inputGpuMemory.copyFromHostAsync(inputData, cudaStream);

                        // æ§è¡æ¨ç (enqueueV3 æ¯å¼æ­¥ç)
                        executionContext.executeV3(cudaStream);
                        // ç­å¾æ¨çå®æ
                        cudaStream.Synchronize();
                        // å°ç»æä»è®¾å¤ æ·è´åä¸»æº
                        // è¿éçæ·è´æ¯åæ­¥çï¼ä¼ç­å¾ GPU è®¡ç®å®æ
                        outputGpuMemory.copyToHostAsync(outputData1, cudaStream);

                        sw.Restart();
                        // åå¤ä¸»æºåå­æ¥æ¶ç»æ
                        float[] outputData = new float[imagePaths.Count() * outputChannels * OutputSize];
                        // å°æ°æ®ä»ä¸»æº æ·è´å°è®¾å¤
                        inputGpuMemory.copyFromHostAsync(inputData, cudaStream);

                        // æ§è¡æ¨ç (enqueueV3 æ¯å¼æ­¥ç)
                        executionContext.executeV3(cudaStream);
                        // ç­å¾æ¨çå®æ
                        cudaStream.Synchronize();
                        // å°ç»æä»è®¾å¤ æ·è´åä¸»æº
                        // è¿éçæ·è´æ¯åæ­¥çï¼ä¼ç­å¾ GPU è®¡ç®å®æ
                        outputGpuMemory.copyToHostAsync(outputData, cudaStream);

                        sw.Stop();
                        Logger.Instance.INFO($"Inference time: {sw.ElapsedMilliseconds} ms");
                        // ================= 5. åå¤ç =================
                        List&lt;List&lt;ObbData&gt;&gt; results1 = PostProcessBatch(outputData, scales, xOffsets, yOffsets);
                        sw.Restart();
                        List&lt;List&lt;ObbData&gt;&gt; results = PostProcessBatch(outputData, scales, xOffsets, yOffsets);
                        sw.Stop();
                        Logger.Instance.INFO($"Post-processing time: {sw.ElapsedMilliseconds} ms");

                        // ================= 6. ç»æå¯è§å =================
                        List&lt;Mat&gt; resultMats = new List&lt;Mat&gt;();
                        for(int i = 0; i &lt; results.Count; ++i)
                        {
                            resultMats.Add(DrawObbResult(results[i], images[i]));
                        }
                        Mat putResultImgs = StitchHorizontalWithPadding(resultMats);
                        Cv2.ImWrite("YOLO11-OBB Result.png", putResultImgs);
                        Cv2.ImShow("YOLO11-OBB Result", putResultImgs);
                        Cv2.WaitKey(0);
                    }
                }
            }
        }

        /// &lt;summary&gt;
        /// å¾åé¢å¤çï¼Letterbox ç¼©æ¾ãå½ä¸åãHWC è½¬ CHW
        /// &lt;/summary&gt;
        private static (float[], float[] ,  int[] , int[] ) PreProcessBatch(List&lt;Mat&gt; imgs)
        {
            int dataLen = 3 * InputSize * InputSize;
            float[] chwData = new float[imgs.Count * dataLen];
            float[] scales = new float[imgs.Count];
            int[] xOffsets = new int[imgs.Count];
            int[]  yOffsets = new int[imgs.Count];
            Parallel.For(0, imgs.Count, i =&gt;
            {
                Mat img = imgs[i];
                // è½¬æ¢é¢è²ç©ºé´ BGR -&gt; RGB
                Mat rgbImg = new Mat();
                Cv2.CvtColor(img, rgbImg, ColorConversionCodes.BGR2RGB);

                // è®¡ç® Letterbox ç¼©æ¾æ¯ä¾
                int maxDim = Math.Max(rgbImg.Width, rgbImg.Height);
                scales[i] = (float)maxDim / InputSize;

                // è®¡ç®ç¼©æ¾åçå°ºå¯¸
                int newWidth = (int)(rgbImg.Width / scales[i]);
                int newHeight = (int)(rgbImg.Height / scales[i]);

                // Resize å¾å
                Mat resizedImg = new Mat();
                Cv2.Resize(rgbImg, resizedImg, new Size(newWidth, newHeight));

                // åå»ºé»è²èæ¯ Canvas (InputSize x InputSize)
                Mat paddedImg = Mat.Zeros(InputSize, InputSize, MatType.CV_8UC3);

                // è®¡ç®ç²è´´ä½ç½® (å±ä¸­)
                xOffsets[i] = (InputSize - newWidth) / 2;
                yOffsets[i] = (InputSize - newHeight) / 2;

                // å°å¾åæ·è´å° Canvas ä¸­å¤®
                Rect roi = new Rect(xOffsets[i], yOffsets[i], newWidth, newHeight);
                resizedImg.CopyTo(new Mat(paddedImg, roi));

                // å½ä¸å (0-255 -&gt; 0-1) å¹¶è½¬ä¸º float ç±»å
                Mat floatImg = new Mat();
                paddedImg.ConvertTo(floatImg, MatType.CV_32FC3, 1.0 / 255.0);

                // HWC è½¬ CHW å¹¶å±å¹³ä¸ºä¸ç»´æ°ç»
                Mat[] channels = Cv2.Split(floatImg);


                // æ·è´æ°æ®ï¼Réé -&gt; Céé -&gt; Béé (OpenCV Split åºæ¥é¡ºåºæ¯ B, G, Rï¼å¯¹åºç´¢å¼ 0, 1, 2)
                int channelSize = InputSize * InputSize;
                // å° R, G, B ä¾æ¬¡æ·å¥æ°ç»
                Marshal.Copy(channels[0].Data, chwData, dataLen * i, channelSize); // R
                Marshal.Copy(channels[1].Data, chwData, dataLen * i + channelSize, channelSize); // G
                Marshal.Copy(channels[2].Data, chwData, dataLen * i + channelSize * 2, channelSize); // B

                // éæ¾ä¸´æ¶ Mat
                rgbImg.Dispose();
                resizedImg.Dispose();
                paddedImg.Dispose();
                floatImg.Dispose();
                foreach (var c in channels) c.Dispose();
            });



            return (chwData, scales, xOffsets, yOffsets);
        }

        /// &lt;summary&gt;
        /// åå¤çï¼è§£æ TensorRT è¾åºãNMS è¿æ»¤
        /// &lt;/summary&gt;
        private static List&lt;List&lt;ObbData&gt;&gt; PostProcessBatch(float[] result, float[] scales, int[] xOffsets, int[] yOffsets)
        {
            List&lt;ObbData&gt;[] obbDatas = new List&lt;ObbData&gt;[scales.Length];

            Parallel.For(0, scales.Length, b =&gt;
            {
                List&lt;RotatedRect&gt; boxes = new List&lt;RotatedRect&gt;();
                List&lt;float&gt; confidences = new List&lt;float&gt;();
                List&lt;int&gt; classIds = new List&lt;int&gt;();

                // éåææé¢æµæ¡ (OutputSize)
                // æ°æ®å¸å±: [4(box) + 15(classes) + 1(angle)] * OutputSize
                // å±å¹³æ°ç»ä¸­ï¼åä¸å±æ§çæ°æ®æ¯è¿ç»­å­å¨çï¼ä¾å¦ææ cx å¨ä¸èµ·ï¼ææ cy å¨å¨ä¸èµ·...
                int stride = OutputSize; // æ­¥é¿ï¼ä¸åå±æ§å¨æ°ç»ä¸­çåç§»é

                int resultDataOffset = OutputSize * (CategoryNum + 5) * b;

                for (int i = 0; i &lt; OutputSize; i++)
                {
                    // æ¥æ¾æå¤§ç±»å«æ¦çåå¶ç´¢å¼
                    float maxConf = 0;
                    int maxClassId = -1;

                    // éåç±»å« 
                    for (int c = 0; c &lt; CategoryNum; c++)
                    {
                        // æ°ç»ç´¢å¼ï¼(åæ /è§åº¦åç§»é + ç±»å«åç§») * æ¡ç´¢å¼
                        // æ³¨æï¼åå§ä»£ç ä¸­ result[outputSize * j + i] è¿ç§è®¿é®æ¹å¼åºäº Transposed æ°æ®å¸å±
                        float conf = result[(4 + c) * stride + i + resultDataOffset];
                        if (conf &gt; maxConf)
                        {
                            maxConf = conf;
                            maxClassId = c;
                        }
                    }

                    // ç½®ä¿¡åº¦è¿æ»¤
                    if (maxConf &gt; ConfThreshold)
                    {
                        // æååæ  (cx, cy, w, h)
                        float cx = result[0 * stride + i + resultDataOffset];
                        float cy = result[1 * stride + i + resultDataOffset];
                        float w = result[2 * stride + i + resultDataOffset];
                        float h = result[3 * stride + i + resultDataOffset];

                        // æåè§åº¦ (éå¸¸å¨ç¬¬ 5 ä¸ªä½ç½®ï¼å³ç±»å«ä¹å)
                        float angleRad = result[(CategoryNum + 4) * stride + i + resultDataOffset];

                        // è¿ååæ å°åå¾å°ºå¯¸
                        float rx = (cx - xOffsets[b]) * scales[b];
                        float ry = (cy - yOffsets[b]) * scales[b];
                        float rw = w * scales[b];
                        float rh = h * scales[b];

                        // å°å¼§åº¦è½¬æ¢ä¸ºè§åº¦
                        // Normalize angle to [-Ï/2, Ï/2] range
                        // å°è§åº¦å½ä¸åå°[-Ï/2, Ï/2]èå´
                        if (angleRad &gt;= Math.PI &amp;&amp; angleRad &lt;= 0.75 * Math.PI)
                        {
                            angleRad -= (float)Math.PI;
                        }
                        float angleDeg = angleRad * (float)(180f / Math.PI);  // Convert to degrees/è½¬æ¢ä¸ºè§åº¦å¶

                        boxes.Add(new RotatedRect(new Point2f(rx, ry), new Size2f(rw, rh), angleDeg));
                        confidences.Add(maxConf);
                        classIds.Add(maxClassId);
                    }
                }

                // æ§è¡ NMS (æè½¬æ¡ NMS)
                // OpenCV ç NMSBoxes æ¯æ RotatedRect
                int[] indices;
                CvDnn.NMSBoxes(boxes, confidences, ConfThreshold, NmsThreshold, out indices);

                List&lt;ObbData&gt; finalResults = new List&lt;ObbData&gt;();
                foreach (int idx in indices)
                {
                    finalResults.Add(new ObbData
                    {
                        index = classIds[idx],
                        score = confidences[idx],
                        box = boxes[idx]
                    });
                }
                obbDatas[b] = finalResults;
            });

           

            return obbDatas.Select(x =&gt; x?.ToList() ?? new List&lt;ObbData&gt;()).ToList();
        }

        /// &lt;summary&gt;
        /// ç»å¶æè½¬æ£æµç»æ
        /// &lt;/summary&gt;
        public static Mat DrawObbResult(List&lt;ObbData&gt; results, Mat image)
        {
            // åéå¾åä»¥åä¿®æ¹åå¾
            Mat mat = image.Clone();

            foreach (var item in results)
            {
                // è·åæè½¬ç©å½¢çåä¸ªé¡¶ç¹
                Point2f[] points = item.box.Points();

                // ç»å¶å¤è¾¹å½¢æ¡
                for (int j = 0; j &lt; 4; j++)
                {
                    Cv2.Line(mat, (Point)points[j], (Point)points[(j + 1) % 4],
                            new Scalar(0, 255, 0), 2);
                }

                // ç»å¶æ ç­¾ (ç±»å« - ç½®ä¿¡åº¦)
                string label = $"{item.index} - {item.score:F2}";
                Point2f textPos = points[0]; // å·¦ä¸è§

                Cv2.PutText(mat, label, (Point)textPos, HersheyFonts.HersheySimplex, 0.8,
                            new Scalar(255, 0, 0), 2);
            }

            return mat;
        }

        public class ObbData
        {
            public int index;
            public float score;
            public RotatedRect box;
        }


        /// &lt;summary&gt;
        /// æºè½æ°´å¹³æ¼æ¥ï¼èªå¨å¤çé«åº¦ä¸ä¸è´çå¾ç
        /// &lt;/summary&gt;
        /// &lt;param name="images"&gt;å¾çåè¡¨&lt;/param&gt;
        /// &lt;param name="backgroundColor"&gt;å¡«åèæ¯é¢è²ï¼é»è®¤ä¸ºé»è²&lt;/param&gt;
        /// &lt;returns&gt;æ¼æ¥åç Mat&lt;/returns&gt;
        public static Mat StitchHorizontalWithPadding(List&lt;Mat&gt; images, Scalar? backgroundColor = null)
        {
            if (images == null || images.Count == 0)
                return new Mat();
            // 1. æ¾å°ææå¾çä¸­çæå¤§é«åº¦
            int maxHeight = images.Max(img =&gt; img.Rows);
            // è®¡ç®æ»å®½åº¦
            int totalWidth = images.Sum(img =&gt; img.Cols);
            // 2. åå¤ç»æç»å¸
            Mat result = new Mat(maxHeight, totalWidth, images[0].Type(), backgroundColor ?? Scalar.Black);
            // 3. å°æ¯ä¸å¼ å¾çå¤å¶å°ç»å¸çå¯¹åºä½ç½®
            int currentX = 0; // å½å X è½´åç§»é
            foreach (var img in images)
            {
                if (img.Empty()) continue;
                // è®¡ç®å½åå¾çéè¦åç´åç§»å¤å°ï¼åºé¨å¯¹é½é»è¾ï¼
                // å¦ææ³é¡¶é¨å¯¹é½ï¼yOffset = 0
                // å¦ææ³å±ä¸­ï¼yOffset = (maxHeight - img.Rows) / 2
                int yOffset = maxHeight - img.Rows;
                // å®ä¹ ROI (æå´è¶£åºå)
                Rect roi = new Rect(currentX, yOffset, img.Cols, img.Rows);

                // å°åå¾çæ·è´å°ç»æå¾ç ROI åºå
                img.CopyTo(new Mat(result, roi));
                // ç§»å¨ X è½´æé
                currentX += img.Cols;
            }
            return result;
        }
    }
}


</code></pre>
<p>ä¸å¾ä¸ºä¸è¿°ç¨åºè¿è¡åçè¾åºï¼æ¨¡åè¾å¥å½¢ç¶ä¸º -1x3x1024x1024ï¼å¶ä¸­Batch Sizeä¸ºå¨æè¾å¥ï¼é¡¹ç®ç¤ºä¾ä½¿ç¨äºåå¼ å¾çè¿è¡åæ¶æ¨çï¼å¼å¯å¹¶è¡å¤çåï¼åå¼ å¾åé¢å¤çæ¶é´ä»ç¨21msï¼æ¨çæ¶é´ä¸º25msï¼åå¤çæ¶é´ä¸º26msï¼ç´¯è®¡æ¶é´ä¸º72ms.</p>
<p><img alt="image-20260109225451392" loading="lazy" data-src="https://img2024.cnblogs.com/blog/2933426/202601/2933426-20260111184155252-292402880.png" class="lazyload"></p>
<p>ä¸å¾ä¸ºæ¨çç»æå±ç¤ºï¼</p>
<p><img alt="YOLO11-OBB Result" loading="lazy" data-src="https://img2024.cnblogs.com/blog/2933426/202601/2933426-20260111184156266-602207018.png" class="lazyload"></p>
<p><strong>æ§è½æµè¯ï¼ä¸å Batch Sizeï¼ï¼</strong></p>
<p>ä¸ºäºæ¢ç©¶ä¸åBatch Sizeæ¨çæ¶é´å·®å¼ï¼æ­¤å¤å¯¹ä¸åBatch Sizeè¿è¡äºæµè¯ï¼æµè¯ç»æå¦ä¸ï¼</p>
<table>
<thead>
<tr>
<th style="text-align: center">Batch Size</th>
<th style="text-align: center">1</th>
<th style="text-align: center">2</th>
<th style="text-align: center">4</th>
<th style="text-align: center">6</th>
<th style="text-align: center">8</th>
<th style="text-align: center">10</th>
<th style="text-align: center">12</th>
<th style="text-align: center">14</th>
<th style="text-align: center">16</th>
<th style="text-align: center">18</th>
<th style="text-align: center">20</th>
<th style="text-align: center">22</th>
<th style="text-align: center">24</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center">åå¤ç (ms )</td>
<td style="text-align: center">9</td>
<td style="text-align: center">13</td>
<td style="text-align: center">27</td>
<td style="text-align: center">38</td>
<td style="text-align: center">56</td>
<td style="text-align: center">59</td>
<td style="text-align: center">63</td>
<td style="text-align: center">83</td>
<td style="text-align: center">96</td>
<td style="text-align: center">105</td>
<td style="text-align: center">118</td>
<td style="text-align: center">130</td>
<td style="text-align: center">144</td>
</tr>
<tr>
<td style="text-align: center">æ¨¡åæ¨ç (ms)</td>
<td style="text-align: center">7</td>
<td style="text-align: center">15</td>
<td style="text-align: center">24</td>
<td style="text-align: center">36</td>
<td style="text-align: center">48</td>
<td style="text-align: center">60</td>
<td style="text-align: center">96</td>
<td style="text-align: center">84</td>
<td style="text-align: center">93</td>
<td style="text-align: center">153</td>
<td style="text-align: center">120</td>
<td style="text-align: center">133</td>
<td style="text-align: center">203</td>
</tr>
<tr>
<td style="text-align: center">åå¤ç (ms)</td>
<td style="text-align: center">25</td>
<td style="text-align: center">26</td>
<td style="text-align: center">26</td>
<td style="text-align: center">26</td>
<td style="text-align: center">28</td>
<td style="text-align: center">27</td>
<td style="text-align: center">27</td>
<td style="text-align: center">28</td>
<td style="text-align: center">28</td>
<td style="text-align: center">28</td>
<td style="text-align: center">27</td>
<td style="text-align: center">31</td>
<td style="text-align: center">29</td>
</tr>
</tbody>
</table>
<blockquote>
<p>ð<strong>ç¨åºè·¯å¾é¾æ¥</strong>ï¼å®æ´ç¨åºå·²ç»ä¸ä¼ å°GitHubï¼è¯·èªè¡ä¸è½½ï¼é¾æ¥ä¸ºï¼</p>
<pre><code>https://github.com/guojin-yan/TensorRT-CSharp-API/tree/TensorRtSharp3.0/samples/YoloObbBatchInfer
</code></pre>
</blockquote>
<hr>
<h3 id="ç¤ºä¾-5å¹¶è¡æ¨ç">ç¤ºä¾ 5ï¼å¹¶è¡æ¨ç</h3>
<p>ä½¿ç¨ä¸ä¸ª Runtime åå»ºå¤æ§è¡ä¸ä¸æï¼å®ç°å¤å¹¶è¡æ¨çã</p>
<p><strong>æ ¸å¿ä»£ç ï¼</strong></p>
<pre><code class="language-csharp">using JYPPX.TensorRtSharp.Cuda;
using JYPPX.TensorRtSharp.Nvinfer;
using OpenCvSharp;
using OpenCvSharp.Dnn;
using System.Diagnostics;
using System.Runtime.InteropServices;
using static OpenCvSharp.FileStorage;

namespace YoloDetParallelInfer
{
    internal class Program
    {
        // ================= éç½®åæ° =================
        // æ¨¡åè¾å¥å°ºå¯¸ (å®½=é«)
        private const int InputSize = 640;


        // å»ºè®®æ ¹æ®å®éæ¨¡åå¨æè·åæä½¿ç¨ Netron æ¥ç
        private const int OutputSize = 8400;

        // æ¨¡åç±»å«æ° (æ ¹æ®æ¨çå·ä½æ°æ®éä¿®æ¹ï¼æ­¤å¤åè®¾ä¸º15ç±»)
        private const int CategoryNum = 80;

        // ç½®ä¿¡åº¦éå¼
        private const float ConfThreshold = 0.25f;

        // NMS IOU éå¼
        private const float NmsThreshold = 0.3f;

        static void Main(string[] args)
        {
            //  ============= éç½® TensorRT æ¥å¿åè° =============
            // å®ä¹ä¸ä¸ªå§æï¼ç¨äºå¤ç TensorRT åé¨äº§ççæ¥å¿æ¶æ¯ã
            // è¿åè®¸æä»¬å° C++ å±é¢çæ¥å¿è¾åºå° C# çæ§å¶å°ã
            LogCallbackFunction _callbackDelegate = (message) =&gt;
            {
                Console.WriteLine(message);
            };

            // å°èªå®ä¹çåè°å½æ°æ³¨åç» TensorRT çå¨å± Logger å®ä¾ã
            Logger.Instance.SetCallback(_callbackDelegate);

            // è®¾ç½®æ¥å¿çä¸¥éæ§çº§å«éå¼ã
            // LoggerSeverity.kINFO: æå°ä¿¡æ¯ãè­¦ååéè¯¯ã
            // å¼åè°è¯é¶æ®µéå¸¸è®¾ä¸º kINFO æ kVERBOSEï¼çäº§ç¯å¢å¯è®¾ä¸º kWARNING æ kERROR ä»¥åå°è¾åºã
            Logger.Instance.SetThreshold(LoggerSeverity.kINFO);

            string enginePath = "yolov8s.engine";
            string imagePath = "bus.jpg";

                           Mat img = Cv2.ImRead(imagePath);
                            if (img.Empty())
                            {
                                Logger.Instance.INFO("Image not found!");
                                return;
                            }
            // ================= 1. å è½½ TensorRT Engine =================
            // ä½¿ç¨ using è¯­å¥ç¡®ä¿æä»¶æµæ­£ç¡®å³é­
            byte[] engineData;
            using (FileStream fs = new FileStream(enginePath, FileMode.Open, FileAccess.Read))
            using (BinaryReader br = new BinaryReader(fs))
            {
                engineData = br.ReadBytes((int)fs.Length);
            }

            // ååºåå Engine
            // Runtime å¿é¡»å¨ Engine çå½å¨æåä¿æå­æ´»ï¼éå¸¸å»ºè®®è®¾ä¸ºå¨å±æéæï¼æèç¡®ä¿å®æåéæ¾
            Runtime runtime = new Runtime();
            runtime.setMaxThreads(6);
            // åå»º CudaEngine (æ­¤å¤ä½¿ç¨ using ç¡®ä¿æ¨çå®æåå¼æè¢«éæ¯)
            using (CudaEngine cudaEngine = runtime.deserializeCudaEngineByBlob(engineData, (ulong)engineData.Length))
            {
                // ================= 2. åå§åæ¨çä¸ä¸æä¸æ¾å­ =================
                Stopwatch totalSw = new Stopwatch();
                totalSw.Start();
                Parallel.For(0, 24, b =&gt;
                {           
                    
                    // åå»ºæ§è¡ä¸ä¸æ
                    using (JYPPX.TensorRtSharp.Nvinfer.ExecutionContext executionContext = cudaEngine.createExecutionContext(TrtExecutionContextAllocationStrategy.kSTATIC))
                    using (CudaStream cudaStream = new CudaStream()) // åå»º CUDA æµç¨äºå¼æ­¥æ§è¡
                    {
                        // è·åè¾å¥ç»´åº¦ä¿¡æ¯ (ç¨äºæ ¡éª)
                        Dims inputDims = executionContext.getTensorShape("images");
                        Logger.Instance.INFO($"Input Shape: {inputDims.d[0]}x{inputDims.d[1]}x{inputDims.d[2]}x{inputDims.d[3]}");

                        // è®¡ç®æéæ¾å­å¤§å°
                        // è¾å¥: Batch=1, Channel=3, Height=640, Width=640
                        ulong inputSizeInBytes = 1 * 3 * InputSize * InputSize;
                        // è¾åº: Batch=1, Channels=CategoryNum+4(box)+1(angle), Num=8400
                        int outputChannels = CategoryNum + 4; // 4åæ  + Nç±»å«
                        ulong outputSizeInBytes = (ulong)(1 * outputChannels * OutputSize);

                        Stopwatch sw = new Stopwatch();
                        // åé GPU æ¾å­
                        using (Cuda1DMemory&lt;float&gt; inputGpuMemory = new Cuda1DMemory&lt;float&gt;(inputSizeInBytes))
                        using (Cuda1DMemory&lt;float&gt; outputGpuMemory = new Cuda1DMemory&lt;float&gt;(outputSizeInBytes))
                        {
                            // ç»å®æ¾å­å°åå° TensorRT ä¸ä¸æ
                            executionContext.setInputTensorAddress("images", inputGpuMemory.get());
                            executionContext.setOutputTensorAddress("output0", outputGpuMemory.get());
                            // é¢ç­æ¨ç (å¯éï¼ä½æ¨èï¼å°¤å¶æ¯é¦æ¬¡æ¨çæ¶)
                            executionContext.executeV3(cudaStream);
                            cudaStream.Synchronize();
                            // ================= 3. å¾åé¢å¤ç =================
             

                            sw.Start();
                            float[] inputData = PreProcess(img, out float scale, out int xOffset, out int yOffset);
                            sw.Stop();
                            Logger.Instance.INFO($"Channel {b}: Pre-processing time: {sw.ElapsedMilliseconds} ms");
                            // ================= 4. æ¨ç =================
                            // åå¤ä¸»æºåå­æ¥æ¶ç»æ
                            float[] outputData = new float[outputChannels * OutputSize];


                            sw.Restart();
                            // å°æ°æ®ä»ä¸»æº æ·è´å°è®¾å¤
                            inputGpuMemory.copyFromHostAsync(inputData, cudaStream);

                            // æ§è¡æ¨ç (enqueueV3 æ¯å¼æ­¥ç)
                            executionContext.executeV3(cudaStream);
                            // ç­å¾æ¨çå®æ
                            cudaStream.Synchronize();



                            // å°ç»æä»è®¾å¤ æ·è´åä¸»æº
                            // è¿éçæ·è´æ¯åæ­¥çï¼ä¼ç­å¾ GPU è®¡ç®å®æ
                            outputGpuMemory.copyToHostAsync(outputData, cudaStream);
                            sw.Stop();
                            Logger.Instance.INFO($"Channel {b}: Inference time: {sw.ElapsedMilliseconds} ms");
                            // ================= 5. åå¤ç =================

                            sw.Restart();
                            List&lt;DetData&gt; results = PostProcess(outputData, scale, xOffset, yOffset);
                            sw.Stop();
                            Logger.Instance.INFO($"Channel {b}: Post-processing time: {sw.ElapsedMilliseconds} ms");

                            // ================= 6. ç»æå¯è§å =================
                            //Mat resultImg = DrawDetResult(results, img);
                            //Cv2.ImShow("YOLO11-DET Result", resultImg);
                            //Cv2.WaitKey(0);
                        }
                    }
                });

                totalSw.Stop();
                Logger.Instance.INFO($"Total time for 8 inferences: {totalSw.ElapsedMilliseconds} ms");


            }
        }

        /// &lt;summary&gt;
        /// å¾åé¢å¤çï¼Letterbox ç¼©æ¾ãå½ä¸åãHWC è½¬ CHW
        /// &lt;/summary&gt;
        private static float[] PreProcess(Mat img, out float scale, out int xOffset, out int yOffset)
        {
            // è½¬æ¢é¢è²ç©ºé´ BGR -&gt; RGB
            Mat rgbImg = new Mat();
            Cv2.CvtColor(img, rgbImg, ColorConversionCodes.BGR2RGB);

            // è®¡ç® Letterbox ç¼©æ¾æ¯ä¾
            int maxDim = Math.Max(rgbImg.Width, rgbImg.Height);
            scale = (float)maxDim / InputSize;

            // è®¡ç®ç¼©æ¾åçå°ºå¯¸
            int newWidth = (int)(rgbImg.Width / scale);
            int newHeight = (int)(rgbImg.Height / scale);

            // Resize å¾å
            Mat resizedImg = new Mat();
            Cv2.Resize(rgbImg, resizedImg, new Size(newWidth, newHeight));

            // åå»ºé»è²èæ¯ Canvas (InputSize x InputSize)
            Mat paddedImg = Mat.Zeros(InputSize, InputSize, MatType.CV_8UC3);

            // è®¡ç®ç²è´´ä½ç½® (å±ä¸­)
            xOffset = (InputSize - newWidth) / 2;
            yOffset = (InputSize - newHeight) / 2;

            // å°å¾åæ·è´å° Canvas ä¸­å¤®
            Rect roi = new Rect(xOffset, yOffset, newWidth, newHeight);
            resizedImg.CopyTo(new Mat(paddedImg, roi));

            // å½ä¸å (0-255 -&gt; 0-1) å¹¶è½¬ä¸º float ç±»å
            Mat floatImg = new Mat();
            paddedImg.ConvertTo(floatImg, MatType.CV_32FC3, 1.0 / 255.0);

            // HWC è½¬ CHW å¹¶å±å¹³ä¸ºä¸ç»´æ°ç»
            Mat[] channels = Cv2.Split(floatImg);
            float[] chwData = new float[3 * InputSize * InputSize];

            // æ·è´æ°æ®ï¼Réé -&gt; Céé -&gt; Béé (OpenCV Split åºæ¥é¡ºåºæ¯ B, G, Rï¼å¯¹åºç´¢å¼ 0, 1, 2)
            int channelSize = InputSize * InputSize;
            // å° R, G, B ä¾æ¬¡æ·å¥æ°ç»
            Marshal.Copy(channels[0].Data, chwData, 0, channelSize); // R
            Marshal.Copy(channels[1].Data, chwData, channelSize, channelSize); // G
            Marshal.Copy(channels[2].Data, chwData, channelSize * 2, channelSize); // B

            // éæ¾ä¸´æ¶ Mat
            rgbImg.Dispose();
            resizedImg.Dispose();
            paddedImg.Dispose();
            floatImg.Dispose();
            foreach (var c in channels) c.Dispose();

            return chwData;
        }

        /// &lt;summary&gt;
        /// åå¤çï¼è§£æ TensorRT è¾åºãNMS è¿æ»¤
        /// &lt;/summary&gt;
        private static List&lt;DetData&gt; PostProcess(float[] result, float scale, int xOffset, int yOffset)
        {
            List&lt;Rect&gt; boxes = new List&lt;Rect&gt;();
            List&lt;float&gt; confidences = new List&lt;float&gt;();
            List&lt;int&gt; classIds = new List&lt;int&gt;();

            // éåææé¢æµæ¡ (OutputSize)
            // æ°æ®å¸å±: [4(box) + 80(classes)] * OutputSize
            // å±å¹³æ°ç»ä¸­ï¼åä¸å±æ§çæ°æ®æ¯è¿ç»­å­å¨çï¼ä¾å¦ææ cx å¨ä¸èµ·ï¼ææ cy å¨å¨ä¸èµ·...
            int stride = OutputSize; // æ­¥é¿ï¼ä¸åå±æ§å¨æ°ç»ä¸­çåç§»é

            for (int i = 0; i &lt; OutputSize; i++)
            {
                // æ¥æ¾æå¤§ç±»å«æ¦çåå¶ç´¢å¼
                float maxConf = 0;
                int maxClassId = -1;

                // éåç±»å«
                for (int c = 0; c &lt; CategoryNum; c++)
                {
                    // æ°ç»ç´¢å¼ï¼(åæ /è§åº¦åç§»é + ç±»å«åç§») * æ¡ç´¢å¼
                    // æ³¨æï¼åå§ä»£ç ä¸­ result[outputSize * j + i] è¿ç§è®¿é®æ¹å¼åºäº Transposed æ°æ®å¸å±
                    float conf = result[(4 + c) * stride + i];
                    if (conf &gt; maxConf)
                    {
                        maxConf = conf;
                        maxClassId = c;
                    }
                }

                // ç½®ä¿¡åº¦è¿æ»¤
                if (maxConf &gt; ConfThreshold)
                {
                    // æååæ  (cx, cy, w, h)
                    float cx = result[0 * stride + i];
                    float cy = result[1 * stride + i];
                    float w = result[2 * stride + i];
                    float h = result[3 * stride + i];
                    // è¿ååæ å°åå¾å°ºå¯¸
                    int rx = (int)((cx - xOffset - 0.5 * w) * scale);
                    int ry = (int)((cy - yOffset - 0.5 * h) * scale);
                    int rw = (int)(w * scale);
                    int rh = (int)(h * scale);

                    boxes.Add(new Rect(rx, ry, rw, rh));
                    confidences.Add(maxConf);
                    classIds.Add(maxClassId);
                }
            }

            // æ§è¡ NMS (æè½¬æ¡ NMS)
            // OpenCV ç NMSBoxes æ¯æ RotatedRect
            int[] indices;
            CvDnn.NMSBoxes(boxes, confidences, ConfThreshold, NmsThreshold, out indices);

            List&lt;DetData&gt; finalResults = new List&lt;DetData&gt;();
            foreach (int idx in indices)
            {
                finalResults.Add(new DetData
                {
                    index = classIds[idx],
                    score = confidences[idx],
                    box = boxes[idx]
                });
            }

            return finalResults;
        }

        /// &lt;summary&gt;
        /// ç»å¶æ£æµç»æï¼æ°´å¹³ç©å½¢æ¡ï¼
        /// &lt;/summary&gt;
        /// &lt;param name="results"&gt;æ£æµç»æåè¡¨&lt;/param&gt;
        /// &lt;param name="image"&gt;åå§å¾å&lt;/param&gt;
        /// &lt;returns&gt;ç»å¶åçå¾å&lt;/returns&gt;
        public static Mat DrawDetResult(List&lt;DetData&gt; results, Mat image)
        {
            // åéå¾åä»¥åä¿®æ¹åå¾
            Mat mat = image.Clone();

            foreach (var item in results)
            {
                // 1. ç»å¶ç©å½¢æ¡
                // Rect ç»æåå« X, Y, Width, Height
                Cv2.Rectangle(mat, item.box, new Scalar(0, 255, 0), thickness: 2);
                // 2. åå¤æ ç­¾ææ¬ (ç±»å«ID - ç½®ä¿¡åº¦)
                string label = $"{item.index} - {item.score:F2}";
                // 3. è®¡ç®ææ¬çå°ºå¯¸ï¼ç¨äºç»å¶èæ¯
                int baseLine = 1;
                Size textSize = Cv2.GetTextSize(label, HersheyFonts.HersheySimplex, 0.6, 1, out baseLine);
                // 4. ç»å¶æ ç­¾èæ¯ï¼åéæé»è²ç©å½¢ï¼ï¼é²æ­¢æå­ä¸èæ¯æ··æ·
                // ä½ç½®ï¼ç©å½¢å·¦ä¸è§ç¥å¾®ä¸ç§»ï¼æèç´æ¥è´´çå·¦ä¸è§
                Point labelPosition = new Point(item.box.X, item.box.Y - (int)textSize.Height - 5);

                // ç¡®ä¿æ ç­¾ä¸ç»åºå¾åè¾¹ç
                if (labelPosition.Y &lt; 0) labelPosition.Y = item.box.Y + (int)textSize.Height + 5;
                Rect labelBgRect = new Rect(labelPosition.X,
                                            labelPosition.Y - (int)textSize.Height, // OpenCV GetTextSize è¿åçé«åº¦æ¯åºçº¿å°åºé¨çè·ç¦»ï¼éè°æ´
                                            (int)textSize.Width,
                                            (int)textSize.Height + (int)baseLine);
                // å¦æèæ¯æ¡ä¹å¨å¾åèå´åï¼åç»å¶
                // æ³¨æï¼è¿éç®åå¤çï¼ç´æ¥ç»å¨æ¡ä¸æ¹
                Cv2.Rectangle(mat,
                               new Point(item.box.X, item.box.Y - textSize.Height - 5),
                               new Point(item.box.X + textSize.Width, item.box.Y),
                               new Scalar(0, 255, 0),
                               thickness: -1); // -1 è¡¨ç¤ºå¡«å
                // 5. ç»å¶ææ¬ï¼ç½è²æå­ï¼
                Cv2.PutText(mat,
                            label,
                            new Point(item.box.X, item.box.Y - 5),
                            HersheyFonts.HersheySimplex,
                            0.6,
                            new Scalar(0, 0, 0),
                            1);
            }
            return mat;
        }

        public class DetData
        {
            public int index;
            public float score;
            public Rect box;
        }
    }
}


</code></pre>
<p>ä¸ºäºæ¹ä¾¿ç¼åä»£ç ï¼ä¸è¿°å¹¶è¡å¤çå³ä½¿æ¶é´åæ¬äºæ¨çä¸ä¸æçåå»ºãæ¨çé¢ç­ç­æ­¥éª¤ï¼æä»¥å®éæ¶é´ä¼åé¿ï¼ä¸è¿°ç¨åºè¿è¡åè¾åºå¦ä¸æç¤ºï¼</p>
<p><img alt="image-20260109230808256" loading="lazy" data-src="https://img2024.cnblogs.com/blog/2933426/202601/2933426-20260111184155243-888464286.png" class="lazyload"></p>
<p><strong>å¹¶è¡æµè¯ç»æï¼</strong></p>
<p>åæ¶ä¸ºäºæ¯è¾ä¸åå¹¶è¡æ°ï¼æµè¯äºä»1å°24ä¸åå¹¶è¡æ°çæåµï¼æ¨çæ»æ¶é´å¦ä¸ï¼</p>
<table>
<thead>
<tr>
<th style="text-align: center">å¹¶è¡æ°</th>
<th style="text-align: center">1</th>
<th style="text-align: center">2</th>
<th style="text-align: center">4</th>
<th style="text-align: center">6</th>
<th style="text-align: center">8</th>
<th style="text-align: center">10</th>
<th style="text-align: center">12</th>
<th style="text-align: center">14</th>
<th style="text-align: center">16</th>
<th style="text-align: center">18</th>
<th style="text-align: center">20</th>
<th style="text-align: center">22</th>
<th style="text-align: center">24</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center">æ¨çæ»æ¶é´ (ms)</td>
<td style="text-align: center">80</td>
<td style="text-align: center">85</td>
<td style="text-align: center">95</td>
<td style="text-align: center">115</td>
<td style="text-align: center">130</td>
<td style="text-align: center">155</td>
<td style="text-align: center">180</td>
<td style="text-align: center">210</td>
<td style="text-align: center">230</td>
<td style="text-align: center">255</td>
<td style="text-align: center">270</td>
<td style="text-align: center">285</td>
<td style="text-align: center">310</td>
</tr>
</tbody>
</table>
<blockquote>
<p>ð<strong>ç¨åºè·¯å¾é¾æ¥</strong>ï¼å®æ´ç¨åºå·²ç»ä¸ä¼ å°GitHubï¼è¯·èªè¡ä¸è½½ï¼é¾æ¥ä¸ºï¼</p>
<pre><code>https://github.com/guojin-yan/TensorRT-CSharp-API/tree/TensorRtSharp3.0/samples/YoloObbBatchInfer
</code></pre>
</blockquote>
<hr>
<h2 id="ä¸å¼å¸¸å¤ç">ä¸ãå¼å¸¸å¤ç</h2>
<p>TensorRtSharp æä¾äºå®åçå¼å¸¸å¤çæºå¶ã</p>
<pre><code class="language-csharp">try
{
    Runtime runtime = new Runtime();
    byte[] data = File.ReadAllBytes("model.engine");
    using CudaEngine engine = runtime.deserializeCudaEngineByBlob(data, (ulong)data.Length);
}
catch (TrtException ex)
{
    // TensorRT ç¹å®éè¯¯
    Console.WriteLine($"TensorRT Error: {ex.ErrMsg}");
    Console.WriteLine($"Status: {ex.Status}");
}
catch (CudaException ex)
{
    // CUDA è¿è¡æ¶éè¯¯
    Console.WriteLine($"CUDA Error: {ex.Message}");
    Console.WriteLine($"Status: {ex.Status}");
}
catch (InitException ex)
{
    // åå§åéè¯¯
    Console.WriteLine($"Initialization Failed: {ex.Message}");
    Console.WriteLine($"Status: {ex.Status}");
}
</code></pre>
<p><strong>å¼å¸¸ç±»åè¯´æï¼</strong></p>
<table>
<thead>
<tr>
<th>å¼å¸¸ç±»å</th>
<th>è¯´æ</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>TrtException</code></td>
<td>TensorRT API éè¯¯ï¼20+ éè¯¯ç ï¼</td>
</tr>
<tr>
<td><code>CudaException</code></td>
<td>CUDA è¿è¡æ¶éè¯¯ï¼40+ éè¯¯ç ï¼</td>
</tr>
<tr>
<td><code>InitException</code></td>
<td>åºåå§åéè¯¯</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="å«æ¥å¿ç³»ç»">å«ãæ¥å¿ç³»ç»</h2>
<p>TensorRtSharp æä¾äºåä¾æ¥å¿ç³»ç»ã</p>
<pre><code class="language-csharp">// è·åæ¥å¿å®ä¾
Logger logger = Logger.Instance;

// è®¾ç½®æ¥å¿çº§å«
logger.SetThreshold(LoggerSeverity.kINFO);  // INFOãWARNINGãERROR

// è®¾ç½®èªå®ä¹åè°
logger.SetCallback((message) =&gt;
{
    Console.WriteLine($"[TensorRT] {message}");
});

// è®°å½æ¥å¿
logger.INFO("Engine building started...");
logger.WARNING("FP16 not supported, falling back to FP32");
logger.ERROR("Failed to parse ONNX model");

// éé»æ¨¡å¼
logger.SetThreshold(LoggerSeverity.kINTERNAL_ERROR);  // ä»ä¸¥ééè¯¯
</code></pre>
<hr>
<h2 id="ä¹ä¸å¶ä»åºçå¯¹æ¯">ä¹ãä¸å¶ä»åºçå¯¹æ¯</h2>
<table>
<thead>
<tr>
<th>ç¹æ§</th>
<th>TensorRtSharp</th>
<th>ML.NET</th>
<th>ONNX Runtime</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>ç¼ç¨è¯­è¨</strong></td>
<td>C#</td>
<td>C#</td>
<td>C++/Python</td>
</tr>
<tr>
<td><strong>API ç±»å</strong></td>
<td>æç®¡å°è£</td>
<td>æç®¡åº</td>
<td>åçç»å®</td>
</tr>
<tr>
<td><strong>æ§è½</strong></td>
<td>åçéåº¦</td>
<td>ä¸­ç­</td>
<td>åçéåº¦</td>
</tr>
<tr>
<td><strong>æç¨æ§</strong></td>
<td>é«</td>
<td>é«</td>
<td>ä¸­ç­</td>
</tr>
<tr>
<td><strong>TensorRT æ¯æ</strong></td>
<td>å®æ´</td>
<td>æ </td>
<td>æé</td>
</tr>
<tr>
<td><strong>èªå®ä¹ç®å­</strong></td>
<td>æ¯æ</td>
<td>å°é¾</td>
<td>æ¯æ</td>
</tr>
<tr>
<td><strong>å¨æå½¢ç¶</strong></td>
<td>æ¯æ</td>
<td>æé</td>
<td>æ¯æ</td>
</tr>
<tr>
<td><strong>å¤ GPU</strong></td>
<td>æ¯æ</td>
<td>æé</td>
<td>æ¯æ</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="åå¸¸è§é®é¢">åãå¸¸è§é®é¢</h2>
<h3 id="é®é¢ä¸æ¾ä¸å°-dll-æ¨¡å">é®é¢ä¸ï¼æ¾ä¸å° DLL æ¨¡å</h3>
<p><strong>éè¯¯ä¿¡æ¯ï¼</strong></p>
<pre><code>Unable to load DLL 'TensorRT-C-API' or one of its dependencies: æ¾ä¸å°æå®çæ¨¡åã
</code></pre>
<p><strong>è§£å³æ¹æ¡ï¼</strong></p>
<ol>
<li>æ£æ¥æ¯å¦å®è£äºå¯¹åºçæ¬ç Runtime NuGet å</li>
<li>ç¡®è®¤ç³»ç» PATH ç¯å¢åéä¸­åå« TensorRT ç lib ç®å½å CUDA ç bin ç®å½</li>
<li>ç¡®è®¤ TensorRT çæ¬ä¸º 10.x ç³»å</li>
</ol>
<p><strong>éè¯¯æªå¾ï¼</strong></p>
<p><img alt="éè¯¯1" loading="lazy" data-src="https://img2024.cnblogs.com/blog/2933426/202601/2933426-20260111184155241-2119782141.png" class="lazyload"><br>
<img alt="éè¯¯2" loading="lazy" data-src="https://img2024.cnblogs.com/blog/2933426/202601/2933426-20260111184155226-1230745435.png" class="lazyload"></p>
<hr>
<h3 id="é®é¢äºsehexception-å¼å¸¸">é®é¢äºï¼SEHException å¼å¸¸</h3>
<p><strong>éè¯¯ä¿¡æ¯ï¼</strong></p>
<pre><code>System.Runtime.InteropServices.SEHException: "External component has thrown an exception."
</code></pre>
<p><strong>å¯è½åå ï¼</strong></p>
<ul>
<li>TensorRT çæ¬ä¸å¹éï¼å¿é¡»ä½¿ç¨ 10.xï¼</li>
<li>CUDA çæ¬ä¸å¼å®¹</li>
<li>æ¨¡åæä»¶æå</li>
</ul>
<p><strong>è§£å³æ¹æ¡ï¼</strong></p>
<ol>
<li>ç¡®è®¤ TensorRT çæ¬ä¸º 10.x</li>
<li>æ£æ¥ CUDA çæ¬æ¯å¦å¹é</li>
<li>éæ°çæ Engine æä»¶</li>
</ol>
<p><strong>éè¯¯æªå¾ï¼</strong></p>
<p><img alt="SEHException" loading="lazy" data-src="https://img2024.cnblogs.com/blog/2933426/202601/2933426-20260111184155221-1792773455.png" class="lazyload"></p>
<h3 id="é®é¢ä¸systemexecutionengineexception-å¼å¸¸">é®é¢ä¸ï¼System.ExecutionEngineException å¼å¸¸</h3>
<p><strong>éè¯¯ä¿¡æ¯ï¼</strong></p>
<pre><code>System.ExecutionEngineException 
</code></pre>
<p><strong>å¯è½åå ï¼</strong></p>
<ul>
<li>æ¨¡åæä»¶ä¸è®¾å¤ä¸å¹é</li>
</ul>
<p><strong>è§£å³æ¹æ¡ï¼</strong></p>
<ol>
<li>å¨å½åè®¾å¤ä¸éæ°çææ¨¡åæä»¶</li>
</ol>
<p><strong>éè¯¯æªå¾ï¼</strong></p>
<p><img alt="image-20260110002045090" loading="lazy" data-src="https://img2024.cnblogs.com/blog/2933426/202601/2933426-20260111184155216-891120170.png" class="lazyload"></p>
<p><img alt="image-20260110002045090" loading="lazy" data-src="https://img2024.cnblogs.com/blog/2933426/202601/2933426-20260111184155234-391327787.png" class="lazyload"></p>
<hr>
<h2 id="åä¸æ»ç»">åä¸ãæ»ç»</h2>
<p>TensorRtSharp æ¯ä¸ä¸ªåè½å®æ´ãè®¾è®¡ç²¾è¯ç TensorRT C# å°è£åºï¼å®å¡«è¡¥äº .NET çæå¨é«æ§è½æ·±åº¦å­¦ä¹ æ¨çæ¹é¢çç©ºç½ãéè¿æä¾ç±»åå®å¨ç APIãèªå¨èµæºç®¡çåå®åçå¼å¸¸å¤çï¼TensorRtSharp è®© C# å¼åèè½å¤åååæ¥ GPU çè®¡ç®è½åï¼èæ éé¢å¯¹å¤æçåçä»£ç ã</p>
<h3 id="æ ¸å¿ä¼å¿">æ ¸å¿ä¼å¿</h3>
<p>â <strong>å®æ´ç API è¦ç</strong>ï¼æ¯æ TensorRT æ ¸å¿åè½<br>
â <strong>ç±»åå®å¨</strong>ï¼å¼ºç±»åç³»ç»ï¼ç¼è¯æ¶éè¯¯æ£æ¥<br>
â <strong>èªå¨èµæºç®¡ç</strong>ï¼RAII + Dispose æ¨¡å¼<br>
â <strong>é«æ§è½</strong>ï¼å¼æ­¥æ§è¡ãå¤æµå¹¶è¡<br>
â <strong>æç¨æ§</strong>ï¼ç´è§ç APIãè¯¦ç»æ³¨é<br>
â <strong>è·¨å¹³å°</strong>ï¼æ¯æ Windows/Linux<br>
â <strong>å¼ç®±å³ç¨</strong>ï¼NuGet åå«ææä¾èµ</p>
<h3 id="éç¨åºæ¯">éç¨åºæ¯</h3>
<p>æ è®ºæ¨æ¯æå»ºä»¥ä¸ç±»åçåºç¨ï¼TensorRtSharp é½æ¯æ¨ççæ³éæ©ï¼</p>
<ul>
<li>ð¯ <strong>å®æ¶è§è§åºç¨</strong>ï¼ç®æ æ£æµãå¾ååå²ãå§¿æä¼°è®¡</li>
<li>ð¤ <strong>è¯­é³å¤ç</strong>ï¼è¯­é³è¯å«ãè¯­é³åæ</li>
<li>ð <strong>è¾¹ç¼è®¡ç®</strong>ï¼åµå¥å¼è®¾å¤æ¨ç</li>
</ul>
<h3 id="ç«å³å¼å§">ç«å³å¼å§</h3>
<p><strong>å®è£å½ä»¤ï¼</strong></p>
<pre><code class="language-bash">dotnet add package JYPPX.TensorRT.CSharp.API
dotnet add package JYPPX.TensorRT.CSharp.API.runtime.win-x64.cuda12
</code></pre>
<p><strong>GitHub ä»åºï¼</strong></p>
<pre><code>https://github.com/guojin-yan/TensorRT-CSharp-API
</code></pre>
<p>ç«å³å®è£å¹¶ä½éª C# ä¸çä¸­ç GPU æ¨çæè´æ§è½å§ï¼</p>
<hr>
<h2 id="ææ¯æ¯æ">ææ¯æ¯æ</h2>
<p>å¦æé®é¢æå»ºè®®ï¼æ¬¢è¿éè¿ä»¥ä¸æ¹å¼äº¤æµï¼</p>
<ul>
<li>ð§ <strong>GitHub Issues</strong>ï¼å¨é¡¹ç®ä»åºæ Issue æ Pull Request</li>
<li>ð¬ <strong>QQ äº¤æµç¾¤</strong>ï¼å å¥ <strong>945057948</strong>ï¼åå¤æ´æ¹ä¾¿æ´å¿«å¦</li>
</ul>
<p><img alt="QQç¾¤äºç»´ç " loading="lazy" data-src="https://img2024.cnblogs.com/blog/2933426/202601/2933426-20260111184155210-319682739.png" class="lazyload"></p>
<hr>
<p><em>ä½èï¼Guojin Yan</em><br>
<em>çæ¬ï¼0.0.5</em><br>
<em>æåæ´æ°ï¼2026å¹´1æ</em></p>
<hr>
<p><strong>ãæç« å£°æã</strong></p>
<p>æ¬æä¸»è¦åå®¹åºäºä½èçç ç©¶ä¸å®è·µï¼é¨åè¡¨è¿°åå©AIå·¥å·è¿è¡äºè¾å©ä¼åãç±äºææ¯å±éæ§ï¼æä¸­å¯è½å­å¨éè¯¯æçæ¼ä¹å¤ï¼æ³è¯·åä½è¯»èæ¹è¯ææ­£ãå¦æåå®¹æ æä¸­ä¾µç¯äºæ¨çæçï¼è¯·åæ¶éè¿å¬ä¼å·åå°ä¸æä»¬èç³»ï¼æä»¬å°ç¬¬ä¸æ¶é´æ ¸å®å¹¶å¦¥åå¤çãæè°¢æ¨ççè§£ä¸æ¯æï¼</p>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-01-11 18:47">2026-01-11 18:47</span>&nbsp;
<a href="https://www.cnblogs.com/guojin-blogs">æ¤é¢ç®ç®è¾</a>&nbsp;
éè¯»(<span id="post_view_count">104</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19468745);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19468745', targetLink: 'https://www.cnblogs.com/guojin-blogs/p/19468745', title: 'TensorRtSharpï¼å¨ C# ä¸çä¸­éæ¾ GPU æ¨ççæè´æ§è½' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ å½æä¸æ³åä¸ºãå°å³å®ãæ¶èæ³¨æåæ¶ï¼æåäºä¸ä¸ªå¾å°çå·¥å· ]]></title>
    <link>https://www.cnblogs.com/BigFunny/p/19468424</link>
    <guid>94e39ce024025173d8ebb445c2caf180</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/BigFunny/p/19468424" title="åå¸äº 2026-01-11 15:33">
    <span role="heading" aria-level="2">å½æä¸æ³åä¸ºãå°å³å®ãæ¶èæ³¨æåæ¶ï¼æåäºä¸ä¸ªå¾å°çå·¥å·</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<p><strong>åè¿ç¯æç« çèµ·å ï¼å¶å®å¾ç®åã</strong></p>
<p>æä¸å¤©æåç°ï¼èªå·±ä¸å¤©ä¸­è¢«ææ­æå¤çï¼å¹¶ä¸æ¯å¤æçé®é¢ï¼èæ¯ä¸äºæ¬æ¥ä¸å¼å¾è®¤çæèçå°å³å®ï¼</p>
<ul>
<li>åååªä¸ªä»»å¡ï¼</li>
<li>åé¥­åä»ä¹ï¼</li>
<li>å ä¸ªæ¹æ¡ééä¾¿éä¸ä¸ªï¼ä»åªå¼å§ï¼</li>
</ul>
<p>è¿äºéæ©åç¬çé½å¾è½»ï¼ä½å®ä»¬åå¤åºç°ï¼ä¼ä¸æ­ææ­æ³¨æåã<br>
çæ­£æ¶èäººçï¼å¾å¾ä¸æ¯å¤§é®é¢ï¼èæ¯è¿äºãæ å³ç´§è¦ä½åä¸å¾ä¸æ³ä¸ä¸ãçæ¶å»ã</p>
<hr>
<h2 id="æä¸å¼å§è¯å¾ç¨åç§å·¥å·è§£å³è¿ä¸ªé®é¢">æä¸å¼å§è¯å¾ç¨åç§å·¥å·è§£å³è¿ä¸ªé®é¢</h2>
<p>ä½åæ¥åç°ä¸ä¸ªå¾è®½åºçæåµï¼</p>
<blockquote>
<p>ä¸ºäºä¸çº ç»ï¼æåèè±äºæ´å¤æ¶é´å¨å·¥å·æ¬èº«ä¸ã</p>
</blockquote>
<p>è¦ç»å½ãè¦éç½®ãè¦çè§£åè½ï¼çè³è¿ä¼è¢«æ¨èæ´å¤ãä½ å¯è½éè¦çä¸è¥¿ãã</p>
<p>å·¥å·å¹¶æ²¡æè®©ææ´å¿«å¼å§è¡å¨ï¼åèæäºæ°çæ³¨æåé»æ´ã</p>
<p>é£æ¶åææè¯å°ï¼æçæ­£æ³è¦çå¹¶ä¸æ¯ä¸ä¸ªãæ´èªæãçç³»ç»ï¼èæ¯ä¸ä¸ª <strong>æ´å®éçå·¥å·</strong>ã</p>
<hr>
<h2 id="ä¸ä¸ªå ä¹æè§ä¸å°å­å¨çå°å·¥å·">ä¸ä¸ªå ä¹ãæè§ä¸å°å­å¨ãçå°å·¥å·</h2>
<p>WheelPage å°±æ¯å¨è¿ç§èæ¯ä¸åºç°çã</p>
<p>å®ä¸æ¯ä¸ä¸ªæçç³»ç»ï¼ä¹ä¸è¯å¾å¸®ä½ ãååºæ´æ­£ç¡®çå³å®ãã<br>
å®çç®æ åªæä¸ä¸ªï¼</p>
<blockquote>
<p>å¨ä½ ä¸æ³åçº ç»çæ¶åï¼ç»ä½ ä¸ä¸ªå¿«éãä¸­ç«ãæ éè§£éçç»æã</p>
</blockquote>
<p>ææ©åçæ¯ä¸ä¸ªå³ç­è½¬çã</p>
<p>ä½ æéé¡¹åè¿å»ï¼è½¬ä¸ä¸ï¼å°±æç»æã</p>
<p>åæ¥æåç°ï¼å¾å¤äººå¹¶ä¸æ¯ç¹å«å¨æè½¬çè½¬å°äºåªä¸é¡¹ï¼<br>
èæ¯å¨ç»æåºç°çé£ä¸å»ï¼ç»äºå¯ä»¥ç»§ç»­å¾ä¸èµ°äºã</p>
<p>è¿ä¸ªè½¬çåæ¥è¢«ç¨å¨å¾å¤ææä¹å¤çåºæ¯éï¼</p>
<ul>
<li>å¢ééæç ´åµå±</li>
<li>è¯¾å äºå¨</li>
<li>åä½å¡ä½æ¶ï¼éæºç»èªå·±ä¸ä¸ªèµ·ç¹</li>
<li>çè³åªæ¯å¸®èªå·±ãåå¼å§åç¹ä»ä¹ã</li>
</ul>
<p>å¦æä½ æ³çè¿ä¸ªæåºç¡çåè½ï¼å®å¨è¿éï¼<br>
ð <a href="https://wheelpage.com/zh/" target="_blank" rel="noopener nofollow">è½¬ç</a></p>
<hr>
<h2 id="ä¸ºä»ä¹åæ¥åå äºä¸ä¸ª-æç¡¬å¸">ä¸ºä»ä¹åæ¥åå äºä¸ä¸ª æç¡¬å¸</h2>
<p>å¨ä½¿ç¨è¿ç¨ä¸­ï¼æä¸ªåé¦åå¤åºç°ï¼</p>
<blockquote>
<p>ãå¶å®æå¾å¤æ¶ååªæ¯å¨ä¸¤ä»¶äºä¹é´ç¹è±«ãã</p>
</blockquote>
<p>äºæ¯æå äºä¸ä¸ªæ´æç®çå·¥å·ï¼<strong>æç¡¬å¸</strong>ã</p>
<ul>
<li>æ²¡æéé¡¹éç½®</li>
<li>æ²¡æè¯´ææå­</li>
<li>æå¼å°±è½ç¨</li>
</ul>
<p>ä½ åªéæä¸ä¸ï¼æ­£æåã</p>
<p>æè¶£çæ¯ï¼å¾å¤ç¨æ·åæ¥è·æè¯´ï¼ä»ä»¬å¹¶ä¸æ¯å®å¨æå³å®äº¤ç»ç¡¬å¸ï¼<br>
èæ¯å¨ç¡¬å¸è½ä¸çä¸ç¬é´ï¼çªç¶æè¯å°èªå·±å¿éæ´åååªä¸è¾¹ã</p>
<p>è¿ç§ä½éªæ¬èº«å°±å¾å¾®å¦ã</p>
<p>å¦æä½ ä¹å¥½å¥ï¼å¯ä»¥ç´æ¥è¯ä¸ä¸è¿ä¸ªé¡µé¢ï¼<br>
ð <a href="https://wheelpage.com/zh/coin-flip/" target="_blank" rel="noopener nofollow">æç¡¬å¸</a></p>
<hr>
<h2 id="è®¾è®¡è¿ç¨ä¸­æå»æåçå ä»¶åç´è§çäº">è®¾è®¡è¿ç¨ä¸­ï¼æå»æåçå ä»¶ãåç´è§ãçäº</h2>
<p>å¨å¼å WheelPage çè¿ç¨ä¸­ï¼æææé¿ååä¸ä»¶äºæï¼</p>
<h3 id="1-ä¸åè´¦æ·ç³»ç»">1. ä¸åè´¦æ·ç³»ç»</h3>
<p>å ä¸ºãåªæ¯ç¨ä¸ä¸ãï¼ä¸åºè¯¥æä¸ºæ³¨åççç±ã</p>
<h3 id="2-ä¸å åè½">2. ä¸å åè½</h3>
<p>æ¯å ä¸ä¸ªåè½ï¼æé½ä¼é®èªå·±ï¼</p>
<blockquote>
<p>è¿æ¯å¨å¸®ç¨æ·ï¼<br>
è¿æ¯åªæ¯è®©æè§å¾ãè¿ä¸ªäº§åæ´åä¸ªäº§åäºãï¼</p>
</blockquote>
<h3 id="3-ä¸å¶é å­å¨æ">3. ä¸å¶é å­å¨æ</h3>
<p>ç¨å®å°±èµ°ï¼æ¯æå¸æå®åç°åºæ¥çç¶æã</p>
<p>ææ´æ¿ææ WheelPage çæä¸ä¸ªãå·¥å·æ½å±éçå°ä¸è¥¿ãï¼<br>
èä¸æ¯ä¸ä¸ªéè¦ä½ æç»­å³æ³¨çäº§åã</p>
<hr>
<h2 id="åå¨æå">åå¨æå</h2>
<p>WheelPage å¹¶ä¸æ¯ä¸ºäºè§£å³äººçéå¤§å³ç­èå­å¨çã</p>
<p>å®å­å¨çæä¹ï¼æ°æ°æ¯ä¸ºäºè®©ä½ ä¸ç¨å¨å°äºä¸æ¶èå¤ªå¤æ³¨æåã</p>
<p>ææ¶åï¼ä¸ä¸ªå¤é¨çãéæºçãæ²¡ææç»ªçç»æï¼<br>
åèè½å¸®ä½ æ´å¿«è¡å¨ã</p>
<p>çè³å¨æäºæ¶å»ï¼å®è¿è½è®©ä½ çæ¸èªå·±çæ­£æ³è¦çæ¯ä»ä¹ã</p>
<p>å¦æä½ æç±»ä¼¼çå°æ°ï¼ä¹è®¸è¿ä¸ªå°å·¥å·è½å¸®ä½ èçä¸ç¹æ³¨æåã</p>
<p>å®å°±å¨é£å¿ï¼<br>
ä¸åµä½ ï¼ä¹ä¸å¬ä½ ã</p>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-01-11 15:33">2026-01-11 15:33</span>&nbsp;
<a href="https://www.cnblogs.com/BigFunny">OnlyFunny</a>&nbsp;
éè¯»(<span id="post_view_count">165</span>)&nbsp;
è¯è®º(<span id="post_comment_count">1</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19468424);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19468424', targetLink: 'https://www.cnblogs.com/BigFunny/p/19468424', title: 'å½æä¸æ³åä¸ºãå°å³å®ãæ¶èæ³¨æåæ¶ï¼æåäºä¸ä¸ªå¾å°çå·¥å·' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ å¬è¯´C++å¥½åå·å·å»ç»ä»ä¹"ç»ä¸æ­¦å"å»äº ]]></title>
    <link>https://www.cnblogs.com/lixingqiu/p/19468363</link>
    <guid>78c31845b0aeaaa97ce4545405e410ab</guid>
    <description>
    <![CDATA[ 
	<h1 class="postTitle"><a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/lixingqiu/p/19468363" title="åå¸äº 2026-01-11 15:07">
    <span role="heading" aria-level="2">å¬è¯´C++å¥½åå·å·å»ç»ä»ä¹"ç»ä¸æ­¦å"å»äº</span>
    

</a>
</h1>
	<div id="cnblogs_post_body" class="blogpost-body blogpost-body-html">
<p><img alt="monkey" width="417" height="417" loading="lazy" data-src="https://img2024.cnblogs.com/blog/523461/202601/523461-20260111150642124-1051860930.png" class="lazyload"></p>
<p>&nbsp;</p>
<p>å¿ï¼å¤§å®¶ä¼å¿ä»¥åæ¯ä¸æ¯é½å¬é£ä¸ªèä¼ è¯´äºï¼å­¦C++å°±åèµ°èéï¼é¾äºä¸éå¤©ï¼å­¦Pythonå¢ï¼é£å«ä¸ä¸ªé¡ºæ»ï¼ååæå»ä¸æ ·ãäºæ¯ä¹ï¼å¤å°ææ£æ¢¦æ³çå°ç·å°å¥³ï¼è¿æ²¡çå°C++ççªå£å¼¹åºæ¥ï¼å°±è¢«é£ä¸å æéãåå­ç®¡çåéäºï¼è½¬å¤´æ±äºPythonçå¤§è¿ã</p>
<p>ä½æ¯ï¼æ¶ä»£åäºåæåä»¬ï¼èªä»æäºè¿ä¸ªâC++ç²¾çµåºâï¼C++ä¹å­¦ä¼äºåèäºãä»¥åæä¸ªå¾å½¢çé¢ï¼åæ¯åå»ºç»ç¬åæ¯è®¾ç½®åæ ç³»ï¼é£ä»£ç åå¾æ¯ç»ä¹¦è¿é¿ââå°¤å¶æ¯è¿å¨æ£é¼èå¼åç¯å¢çåå­¦ä»¬ï¼é£ç§éç½®ç¯å¢çé¸ç½ï¼è°è¯è°ç¥éãç°å¨å¢ï¼ä½ çè¿æ®µä»£ç ï¼å è¡æä»¤ï¼å±å¹å°±äº®äºï¼ç®ç´åå¼äºæã</p>
<p>å°±æ¿è¿ãå­æç©ºç72åå¨ç»ãæ¥è¯´å§ï¼è¿ä»£ç åå¾é£å«ä¸ä¸ªéå¿ææ¬²ãé£ä¸ªå«<code>monkey</code>çå°å®¶ä¼ï¼ççæ¯ä¸ä¸ªå°ç²¾çµãä¸ä¸ç§è¿æ¯å¤§å£ç·ï¼ä¸ä¸ç§åæäºåå¤´å¼ºï¼è½¬ç¼åæ··è¿äºæºå¨ç«çéä¼ï¼çè³è¿è½ååºä¸ªä¸­å½ç»æ¥ï¼è¿åªæ¯åä»£ç åï¼è¿ç®ç´æ¯âè¿è¿çâç°åºçï¼ä½ è®©é¿ç«¥æ¨å»æç°å¤ªç¼ï¼è¿èæ´ï¼ä¹å°±C++å ä¸è¿ç²¾çµåºè½éåå¾è¿ä¹æºã</p>
<p>æç»çæ¯ä»ä¹ï¼æ¯é£ä¸ªå¾ªç¯ã<code>monkey.next_shape().wait(...)</code>ãå°±è¿ä¹ä¸å¥ï¼å­æç©ºå°±å¨å±å¹ä¸å¼å§äºä»çå·å§åè¸å¤§èµãä¸éè¦ä½ æä»ä¹å¤æçåºå±æ¸²æï¼ä¹ä¸éè¦ä½ ä¸ºäºä¸ä¸ªçªå£å¥ææè³æ è®ãç°å¨çC++ï¼å°±åè¿å­æç©ºä¸æ ·ï¼å­¦ä¼72åäºãå®æèº«ä¸åï¼ä»é£ä¸ªå·å°å°çâç¡¬æ±âï¼åæäºä¸ä¸ªè½éªä½ ç©ãè½éªä½ é¹ãè¿è½éä¾¿ä½ æé åçâå°å¯ç±âã</p>
<p>æä»¥åï¼å«åæ­»æ±çâC++é¾å¦å¤©ä¹¦âçèé»åäºãå¨è¿ä¸ªç²¾çµåºéï¼C++æé¨æ§é½æäºï¼éºä¸äºä¸å±çº¢å°æ¯¯æ¬¢è¿å¤§å®¶ãè¿ãç´çåå½¢è®°ãæ¼çå¯ä¸æ¯å­æç©ºï¼æ¼çæ¯C++çâåå½¢è®°âââåæ¥ï¼ä½ ç¦»å¤§ç¥ä¹é´ï¼åªå·®ä¸ä¸ªä¼72åçç²¾çµåºï¼</p>
<p><span style="color: rgba(255, 0, 0, 1)"><strong>è¯´äºè¿ä¹å¤ï¼æ­£æå¨æ­¤ï¼</strong></span></p>
<div class="cnblogs_code">
<pre>#include <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">sprites.h</span><span style="color: rgba(128, 0, 0, 1)">"</span>  <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">åå«C++ç²¾çµåº </span>
Sprite monkey;       <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">å»ºç«è§è²å«monkey </span>

<span style="color: rgba(0, 0, 255, 1)">int</span> main(){        <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">ä¸»åè½å </span>
   monkey.bgcolor(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">black</span><span style="color: rgba(128, 0, 0, 1)">"</span>).scale(<span style="color: rgba(128, 0, 128, 1)">0.5</span>);  <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">èæ¯é»ï¼è§è²åå°ä¸å
   </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">æ¬ç¬ï¼å¹¶ä¸ç§»é¤ç´¢å¼ä¸º0çé åï¼é»è®¤å°ç«ç®­)</span>
   monkey.penup().removeshape(<span style="color: rgba(128, 0, 128, 1)">0</span>).color(<span style="color: rgba(128, 0, 128, 1)">200</span>).addy(<span style="color: rgba(128, 0, 128, 1)">200</span><span style="color: rgba(0, 0, 0, 1)">);
   std::</span><span style="color: rgba(0, 0, 255, 1)">string</span> s = <span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">C++å­æç©ºç72åå°å¨ç»</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">;
   monkey.write(s,</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">center</span><span style="color: rgba(128, 0, 0, 1)">"</span>,{<span style="color: rgba(128, 0, 0, 1)">""</span>,<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">48</span><span style="color: rgba(128, 0, 0, 1)">"</span>,<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">normal</span><span style="color: rgba(128, 0, 0, 1)">"</span>}).wait(<span style="color: rgba(128, 0, 128, 1)">1</span><span style="color: rgba(0, 0, 0, 1)">);
   monkey.addy(</span>-<span style="color: rgba(128, 0, 128, 1)">200</span><span style="color: rgba(0, 0, 0, 1)">);
   monkey.addshape(</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">res/é¿ç«¥æ¨.png</span><span style="color: rgba(128, 0, 0, 1)">"</span>);   <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">æ·»å é å</span>
   monkey.addshape(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">res/åå¤´å¼º.png</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">);
   monkey.addshape(</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">res/ç°å¤ªç¼.png</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">);
   monkey.addshape(</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">res/æºå¨ç«.png</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">);
   monkey.addshape(</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">res/monkey.png</span><span style="color: rgba(128, 0, 0, 1)">"</span>); <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">å­æç©º</span>
   monkey.addshape(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">res/å¤æäºº.png</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">);
   monkey.addshape(</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">res/ä¸­å½ç».png</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(0, 0, 0, 1)">);
   monkey.addshape(</span><span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">res/qirocketboy.png</span><span style="color: rgba(128, 0, 0, 1)">"</span>);  <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">éªç«ç®­é£åå¤ªç©ºçç·å­©
   </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">å è½½èæ¯é³ä¹</span>
   Mix_Music *music=Mix_LoadMUS(<span style="color: rgba(128, 0, 0, 1)">"</span><span style="color: rgba(128, 0, 0, 1)">res/monkeybgmusic.wav</span><span style="color: rgba(128, 0, 0, 1)">"</span>);  <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">ä¸æ¯æä¸­æå</span>
   Mix_PlayMusic(music,-<span style="color: rgba(128, 0, 128, 1)">1</span>);  <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">-1è¡¨ç¤ºæ éå¾ªç¯æ­æ¾ï¼0è¡¨ç¤ºæ­æ¾1æ¬¡ï¼1åæ¯2æ¬¡ã
   </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> g_screenæ¯è§è²å»ºç«åçå¨å±å±å¹æé  </span>
   <span style="color: rgba(0, 0, 255, 1)">while</span>(g_screen-&gt;exitonclick())  <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">åå»çªå£å³é­æé®åå¾ªç¯éåº</span>
     monkey.next_shape().wait(random(<span style="color: rgba(128, 0, 128, 1)">0.9</span>,<span style="color: rgba(128, 0, 128, 1)">1.5</span>)); <span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)">å­æç©ºåæ¢é åï¼å¹¶ä¸éæºç­å¾ä¸å®çæ¶é´  </span>
   <span style="color: rgba(0, 0, 255, 1)">return</span> <span style="color: rgba(128, 0, 128, 1)">0</span><span style="color: rgba(0, 0, 0, 1)">;
}</span></pre>
</div>
<p>ååï¼æå¿äºçå®æ²¡æå­¦è¿C++äºï¼ä¸è¿è¿éè¿æè§é¢ï¼</p>
<p>................................................................................................(æ­¤å¤è¿å»5åé)</p>
<p>å®äºï¼æ¾äºåå¤©æ²¡ææ¾å°å¨åªéæå¥è§é¢ï¼åªå¾å§å±çå®å»æé³å·pxcodingæ¾ãå­æç©ºç72åå°å¨ç»ãå§ã</p>
<p>åè§äºï¼æçå°å®è´ä»¬ã</p>
<p>&nbsp;</p>
</div>
<div class="clear"></div>

	<div class="postDesc">posted on 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-01-11 15:07">2026-01-11 15:07</span>&nbsp;
<a href="https://www.cnblogs.com/lixingqiu">æå´ç</a>&nbsp;
éè¯»(<span id="post_view_count">113</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19468363);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19468363', targetLink: 'https://www.cnblogs.com/lixingqiu/p/19468363', title: 'å¬è¯´C++å¥½åå·å·å»ç»ä»ä¹&amp;quot;ç»ä¸æ­¦å&amp;quot;å»äº' })">ä¸¾æ¥</a>
</div>
 ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ åç³»ç»æ¾å¡å²çªä¿®å¤è®°å½ ]]></title>
    <link>https://www.cnblogs.com/chenyouyuan/p/19465907</link>
    <guid>9e37057a19d42a0d8dbe48d30542b0c6</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/chenyouyuan/p/19465907" title="åå¸äº 2026-01-10 17:11">
    <span role="heading" aria-level="2">åç³»ç»æ¾å¡å²çªä¿®å¤è®°å½</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                    <div id="cnblogs_post_description" style="display: none">
        
        å³äºä¿®å¤ubuntuçæ ¸æ¾ç¬æ¾ï¼nvidiaæ¾å¡é©±å¨å²çªå¯¼è´çé»å±é®é¢
    </div>
<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<h1 id="å³äºåç³»ç»ubuntuwinå®è£æ¾å¡é©±å¨é»å±è®°å½">å³äºåç³»ç»ï¼ubuntu+winï¼å®è£æ¾å¡é©±å¨é»å±è®°å½</h1>
<blockquote>
<p>çµèéç½®ï¼æºæ¢°é©å½èé¾17ks amdæ ¸æ¾ + 4060laptopç¬æ¾</p>
</blockquote>
<blockquote>
<p>ç³»ç»ï¼ win11 +  ubuntu22.04</p>
</blockquote>
<blockquote>
<p>æç¤ºï¼åçä¸ä¸ä½ æ¯ä¸æ¯åæç±»ä¼¼çæ ¸æ¾+ç¬æ¾çéç½®,å¦æä¸æ¯å¯ä»¥ååèå¶ä»æç« ï¼ä»¥åæµªè´¹æ¶é´</p>
</blockquote>
<p></p><div class="toc"><div class="toc-container-header">ç®å½</div><ul><li><a href="#å³äºåç³»ç»ubuntuwinå®è£æ¾å¡é©±å¨é»å±è®°å½" rel="noopener nofollow">å³äºåç³»ç»ï¼ubuntu+winï¼å®è£æ¾å¡é©±å¨é»å±è®°å½</a><ul><li><a href="#ä¸å¦æç´æ¥å¯å¨é»å±ä½æ¯ä½ å¯ä»¥ä½¿ç¨ctrl--alt--f-1-or-f-2--f8è¿å¥ç»ç«¯" rel="noopener nofollow">ä¸ãå¦æç´æ¥å¯å¨é»å±ï¼ä½æ¯ä½ å¯ä»¥ä½¿ç¨ctrl + alt + f 1 or f 2 ... f8è¿å¥ç»ç«¯</a><ul><li><a href="#step1" rel="noopener nofollow">step1ï¼</a></li><li><a href="#step2" rel="noopener nofollow">step2:</a><ul><li><a href="#step21" rel="noopener nofollow">step2.1:</a></li><li><a href="#step22" rel="noopener nofollow">step2.2:</a></li><li><a href="#step23" rel="noopener nofollow">step2.3:</a></li><li><a href="#step24" rel="noopener nofollow">step2.4:</a><ul><li><a href="#1å¦æä½ ä»ç¶æ¯é»å±" rel="noopener nofollow">1.å¦æä½ ä»ç¶æ¯é»å±</a></li><li><a href="#2å¦æä½ è¿å¥äºæ¡é¢" rel="noopener nofollow">2.å¦æä½ è¿å¥äºæ¡é¢</a></li></ul></li></ul></li><li><a href="#step3" rel="noopener nofollow">step3:</a></li></ul></li><li><a href="#äºå¦æä¸æ æ³å®ç°" rel="noopener nofollow">äºãå¦æä¸æ æ³å®ç°</a></li><li><a href="#åèé¾æ¥" rel="noopener nofollow">åèé¾æ¥</a></li></ul></li></ul></div><p></p>
<p>â	æè¿ç±äºå­¦ä¹ isaaclabï¼å®è£åç³»ç»ï¼wslä¸æ¯ææ¾å¡ç´æ¥é©±å¨ï¼å®æ¹ä¹æ²¡æéå¯¹wslä½ä¼åï¼ï¼å»nvidiaçå®ç½ä¸è½½.runçé©±å¨åå®è£<br>
å®è£è¿ç¨ä¸­è¦æåæå®ç¦ç¨nouveauï¼å¦ä¸ï¼å¦åç¼è¯ä¼æ¥éï¼ç»ä¹åéæ°å¯å¨ä¹è½æ­£å¸¸è¿å¥æ¡é¢ï¼ç»§ç»­å®æç¼è¯ã</p>
<pre><code class="language-text">  One or more modprobe configuration files to disable Nouveau have been written.  You will need to reboot your     
  system and possibly rebuild the initramfs before these changes can take effect.  Note if you later wish to       
  reenable Nouveau, you will need to delete these files:
  /usr/lib/modprobe.d/nvidia-installer-disable-nouveau.conf,
  /etc/modprobe.d/nvidia-installer-disable-nouveau.conf
</code></pre>
<p>â	å®è£ä¹åä½¿ç¨nvidia-smiä¹è½æ¾ç¤ºæ¾å¡ä¿¡æ¯ï¼æä¹åæ­£å¸¸å¯å¨isacclabä¹æ²¡æé®é¢ï¼ä»¥ä¸ºä¸äºå¤§åäºãç»ææå®ç¬¬äºå¤©æå¼çµèå¤©å¡äºï¼ç´æ¥å¡å¨é»å±å¤æ æ³æ­£å¸¸è¿å¥æ¡é¢ã</p>
<p>äºæ¯å¼å¯äºæ¼«é¿çä¸æ´ä¸ªæä¸+ä¸æ´ä¸ªä¸åçdebug ï¼ps: ä½ ç¥éæè¿ä¸¤å¤©æ¯æä¹è¿çåï¼ï¼ååºé©±å¨</p>
<p>ä¸é¢æåå ä¸ªæ­¥éª¤æ¥è®²è§£å¦ä½è§£å³è¿ä¸ªé®é¢</p>
<h2 id="ä¸å¦æç´æ¥å¯å¨é»å±ä½æ¯ä½ å¯ä»¥ä½¿ç¨ctrl--alt--f-1-or-f-2--f8è¿å¥ç»ç«¯">ä¸ãå¦æç´æ¥å¯å¨é»å±ï¼ä½æ¯ä½ å¯ä»¥ä½¿ç¨ctrl + alt + f 1 or f 2 ... f8è¿å¥ç»ç«¯</h2>
<p>è¿å°±è¯´æä½ çç³»ç»å¶å®å·²ç»å¯å¨äº</p>
<h3 id="step1">step1ï¼</h3>
<p>æ£æ¥ä½ çæ¾ç¤ºç®¡çç³»ç»æ¯å¦å¯å¨</p>
<pre><code>sudo systemctl status gdm3
sudo systemctl status lightdm
</code></pre>
<p>å¦ææ¾ç¤ºdeadå°±è¯´ææ²¡æå¯å¨ï¼è¿ä¸ªç¨åå¨è¯´ï¼ä¹æä¸ç§æ¯runingä»ç¶æ²¡ææ¡é¢ç</p>
<h3 id="step2">step2:</h3>
<p>æ£æ¥nvidiaé©±å¨æ¯å¦å è½½</p>
<pre><code>nvidia-smi
</code></pre>
<p>æ­£å¸¸æ¾ç¤ºæ¾å¡ä¿¡æ¯å°±è¯´æå è½½æåï¼å è½½æåå°±å¯ä»¥è¿å¥step3ï¼ä¸è¡å°±åè¿å¥step2.1</p>
<h4 id="step21">step2.1:</h4>
<p>å¸è½½é©±å¨</p>
<p>åä¸¤ç§</p>
<ol>
<li>
<p>ä½¿ç¨.runè¿è¡å®è£ç</p>
<pre><code>sudo ./æ¾å¡é©±å¨ååç§° --uninstall
# æ¯å¦ sudo ./NVIDIA-Linux-x86_64-430.26.run --uninstall
</code></pre>
</li>
<li>
<p>ä½¿ç¨aptè¿è¡å®è£ç</p>
<pre><code>sudo spt autoremove nvidia-driver-XXX  
#xxx ç± tapèªè¡è¡¥å¨
</code></pre>
</li>
</ol>
<p>æ£æ¥ç®å½ï¼</p>
<p>/usr/lib/modprobe.d/nvidia-installer-disable-nouveau.conf,<br>
/etc/modprobe.d/nvidia-installer-disable-nouveau.conf</p>
<p>è¿ä¸¤ä¸ªæä»¶æ¯å¦å­å¨ï¼å¦ææå°±å é¤å®</p>
<h4 id="step22">step2.2:</h4>
<p>å¥½ï¼æ­¤æ¶ä½ å¯ä»¥åéå¯ä¸ä¸çµèï¼åè¿å¥å¼å¯¼é¡µé¢</p>
<p>éæ©ubuntu advanceï¼æèç±»ä¼¼ï¼</p>
<p>ç¶åéæ©securityå®å¨æ¨¡å¼è¿å¥</p>
<p>ä¹åéè¿æ¹åé®éæ©root</p>
<p>è¾å¥å¯ç </p>
<p>ï¼è¿ä¼æ¯ä¸ä¸ªå½ä»¤è¡çé¢ï¼</p>
<p>ç¶å</p>
<pre><code class="language-bash">sudo vim /etc/default/grub
</code></pre>
<p>ï¼ps:æiå¼å§ç¼è¾ï¼æescï¼å¹¶ä¸æä½shift + : åè¾å¥wqä¿å­å¹¶éåºï¼</p>
<p>æ¾å°è¿ä¸è¡</p>
<pre><code>GRUB_CMDLINE_LINUX_DEFAULT="quiet splash"
</code></pre>
<p>quiet splashè¡¨ç¤ºä¸æ¾ç¤ºå¯å¨çé£ç§å·å±çè°è¯ä¿¡æ¯</p>
<p>å¨åé¢å ä¸ä¸ªç©ºæ ¼ è¾å¥nomodeset</p>
<p>åæè¿æ ·</p>
<pre><code>GRUB_CMDLINE_LINUX_DEFAULT="quiet splash nomodeset"
</code></pre>
<p>ç¶å</p>
<pre><code class="language-bash">sudo update-grub # æ´æ°ä¸ä¸ç³»ç»å¯å¨éé¡¹
</code></pre>
<p>ä¹åéå¯</p>
<pre><code class="language-bash">sudo reboot
</code></pre>
<h4 id="step23">step2.3:</h4>
<p>åºè¯¥å°±è½è¿å¥æ¡é¢å¯è§åäºï¼å¦æä¸è½ï¼</p>
<p>ä½ å¯ä»¥å°è¯ä¸ä¸</p>
<pre><code class="language-bash">sudo systemctl status gdm3
</code></pre>
<p>å¦ææ¯dead</p>
<p>ä½ å¯ä»¥æå¨å¯å¨å®</p>
<p>å¯å¨ä¹åä½ éè¦å</p>
<pre><code class="language-bash">sudo dpkg-reconfigure gdm3
#éè¿æ¹åé®éæ©gdm3ä¸ºé»è®¤çæ¾ç¤ºç®¡çå¨
</code></pre>
<p>ç¶å</p>
<pre><code class="language-bash">sudo systemctl enable gdm3
sudo systemctl stop lightdm#å¦æä½ å¨ä¹åè£äºè¿lightdmç©æçè¯ï¼æè§å¾è¿ä¸ªå¾å¥æªï¼å¯å¨å®å°±è¿ä¸å»æ¡é¢ï¼ä¹åç¨æ·è®¤è¯ä¹éè¿äºï¼å ä¸ºç¨gdm3æåäºå°±æ²¡æè¯¦ç»ç ç©¶è¿ä¸ªäº
sudo systemctl disable lightdm 
</code></pre>
<p>ç¶åreboot</p>
<h4 id="step24">step2.4:</h4>
<p>å¦æè¿æ¯è¿ä¸å»ãããããã</p>
<p>ä¹æ²¡å³ç³»ï¼æä»¬ç»§ç»­</p>
<h5 id="1å¦æä½ ä»ç¶æ¯é»å±">1.å¦æä½ ä»ç¶æ¯é»å±</h5>
<p>ctrl + alt + f3</p>
<p>æå¼ä¸ä¸ªç»ç«¯</p>
<h5 id="2å¦æä½ è¿å¥äºæ¡é¢">2.å¦æä½ è¿å¥äºæ¡é¢</h5>
<p>ctrl + alt + t</p>
<pre><code class="language-bash">sudo apt update
ubuntu-drivers devices
# éæ©ä¸å¸¦-openç»å°¾ççæ¬
# å¦
== /sys/devices/pci0000:00/0000:00:01.1/0000:01:00.0 ==
modalias : pci:v000010DEd000028A0sv00001D05sd0000128Abc03sc00i00
vendor   : NVIDIA Corporation
driver   : nvidia-driver-570 - distro non-free
driver   : nvidia-driver-580-open - distro non-free recommended
driver   : nvidia-driver-580 - distro non-free
driver   : nvidia-driver-570-server - distro non-free
driver   : nvidia-driver-535 - distro non-free
driver   : nvidia-driver-580-server-open - distro non-free
driver   : nvidia-driver-535-server - distro non-free
driver   : nvidia-driver-545-open - distro non-free
driver   : nvidia-driver-580-server - distro non-free
driver   : nvidia-driver-535-open - distro non-free
driver   : nvidia-driver-545 - distro non-free
driver   : nvidia-driver-535-server-open - distro non-free
driver   : nvidia-driver-570-open - distro non-free
driver   : nvidia-driver-570-server-open - distro non-free
driver   : xserver-xorg-video-nouveau - distro free builtin

# éæ©nvidia-driver-580

# è¾å¥
sudo apt install nvidia-driver-580
# å®è£å®æä¹ååºè¯¥è¾å¥
nvidia-smi # å¯ä»¥çå°æ¾å¡ä¿¡æ¯
</code></pre>
<h3 id="step3">step3:</h3>
<p>æ£æ¥ä½ ç³»ç»çæ¾å¡æ¯å¦åªæä¸å¼ </p>
<pre><code class="language-bash">lspci | grep VGA
</code></pre>
<p>å¦æä½ åºç°äºä¸¤è¡ä¿¡æ¯</p>
<p>ç±»ä¼¼</p>
<pre><code>01:00.0 VGA compatible controller: NVIDIA Corporation AD107M [GeForce RTX 4060 Max-Q / Mobile] (rev a1)
07:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Phoenix1 (rev c2)
</code></pre>
<p>07:00.0 å°±æ¯busid 7:0:0</p>
<p>åæå¼ä¸ä¸ªç»ç«¯</p>
<pre><code>sudo -i #è¿å¥è¶çº§ç®¡çå
vim /etc/X11/xorg.conf
</code></pre>
<p>æä¸é¢çéç½®æ¾è¿å»ï¼ä½ è¦ä¿®æ¹çæ¯VendorNameåBusIDï¼æ¹æä½ çæ ¸æ¾çä¿¡æ¯ï¼è¿ä¸æ­¥çè¯¦ç»ä¿¡æ¯å¯ä»¥ç±lspci | grep VGAæ¿å°ï¼ã</p>
<p>VendorNameä¸éè¦åå¨ï¼å¯ä»¥ç´¢å¼å°å¯ä¸å¼å°±è¡ã</p>
<pre><code>Section "Module"
        Load "modesetting"
EndSection
 
Section "Device"
        Identifier      "Device1"
        Driver          "modesetting"
        VendorName      "Intel Corporation"
        BusID           "PCI:0:2:0"
EndSection
</code></pre>
<p>å¶ä½ç»èåçï¼<br>
<a href="https://blog.csdn.net/m0_63252914/article/details/134400519?sharetype=blog&amp;shareId=134400519&amp;sharerefer=APP&amp;sharesource=mobkbk&amp;sharefrom=link" target="_blank" rel="noopener nofollow">https://blog.csdn.net/m0_63252914/article/details/134400519?sharetype=blog&amp;shareId=134400519&amp;sharerefer=APP&amp;sharesource=mobkbk&amp;sharefrom=link</a></p>
<p>ï¼ps:è¿ç¯æç« çä½èç¨çæ¯nanoï¼æç¨çæ¯vimï¼é½æ¯ææ¬ç¼è¾å¨ï¼èªå·±è§å¾åªä¸ªå¥½ç¨å°±ç¨åªä¸ªå§ï¼</p>
<p>å¥½ï¼ä¹åæ³¨æè¦æåæ¥step2.2æ¹è¿çé£å¥è¯æ¹åå»ï¼</p>
<pre><code class="language-text">GRUB_CMDLINE_LINUX_DEFAULT="quiet splash"
</code></pre>
<p>è®°å¾wqéåº</p>
<pre><code>sudo update-grub # æ´æ°ä¸ä¸ç³»ç»å¯å¨éé¡¹
</code></pre>
<p>ä¹å¯ä»¥åæ£æ¥ä¸ä¸step2.3</p>
<p>ä¹åéå¯åºè¯¥å°±æ²¡é®é¢å¦ï¼</p>
<h2 id="äºå¦æä¸æ æ³å®ç°">äºãå¦æä¸æ æ³å®ç°</h2>
<p>è¿å¥ step2.2 ââãstep2.1ââãstep2.3åç»§ç»­å¾åèµ°</p>
<h2 id="åèé¾æ¥">åèé¾æ¥</h2>
<p><a href="https://blog.csdn.net/m0_63252914/article/details/134400519?sharetype=blog&amp;shareId=134400519&amp;sharerefer=APP&amp;sharesource=mobkbk&amp;sharefrom=link" target="_blank" rel="noopener nofollow">https://blog.csdn.net/m0_63252914/article/details/134400519?sharetype=blog&amp;shareId=134400519&amp;sharerefer=APP&amp;sharesource=mobkbk&amp;sharefrom=link</a></p>
<p><a href="https://blog.csdn.net/gaoenyang760525/article/details/131219814" target="_blank" rel="noopener nofollow">https://blog.csdn.net/gaoenyang760525/article/details/131219814</a></p>
<p><a href="https://blog.csdn.net/xiaxl/article/details/146975458" target="_blank" rel="noopener nofollow">https://blog.csdn.net/xiaxl/article/details/146975458</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/671285335" target="_blank" rel="noopener nofollow">https://zhuanlan.zhihu.com/p/671285335</a></p>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-01-10 17:12">2026-01-10 17:11</span>&nbsp;
<a href="https://www.cnblogs.com/chenyouyuan">ChenYY~</a>&nbsp;
éè¯»(<span id="post_view_count">138</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19465907);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19465907', targetLink: 'https://www.cnblogs.com/chenyouyuan/p/19465907', title: 'åç³»ç»æ¾å¡å²çªä¿®å¤è®°å½' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ 20260109 - TRU åè®®æ»å»äºä»¶åæï¼ä¹°å¾å¤å¤åè´¹éäºåï¼ ]]></title>
    <link>https://www.cnblogs.com/ACaiGarden/p/19465686</link>
    <guid>afd1c7a7e911614fa140a6ca7b72f063</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/ACaiGarden/p/19465686" title="åå¸äº 2026-01-10 15:42">
    <span role="heading" aria-level="2">20260109 - TRU åè®®æ»å»äºä»¶åæï¼ä¹°å¾å¤å¤åè´¹éäºåï¼</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<p>20260109ï¼ETH é¾ä¸ç TRU åè®®é­åäºé»å®¢æ»å»ï¼æå¤±çº¦ 2600 ä¸ç¾åãæ¼æ´åå æ¯è®¡ç®è´­ä¹° TRU ä»£å¸æéè¦ç ETH æ°éçè®¡ç®å¬å¼è®¾è®¡å­å¨ç¼ºé·ï¼è´­ä¹°å¤§é TRU ä»£å¸æ¶ä¼å ä¸ºç²¾åº¦ä¸¢å¤±èå¾å° 0 å¼ï¼ä½¿å¾æ»å»èå¯ä»¥ä»¥ 0 ETH è´­ä¹°å¤§éç TRU ä»£å¸ï¼æåæå®å®æè·å©ã</p>
<ul>
<li>TXï¼<a href="https://app.blocksec.com/explorer/tx/eth/0xcd4755645595094a8ab984d0db7e3b4aabde72a5c87c4f176a030629c47fb014" target="_blank" rel="noopener nofollow">https://app.blocksec.com/explorer/tx/eth/0xcd4755645595094a8ab984d0db7e3b4aabde72a5c87c4f176a030629c47fb014</a></li>
</ul>
<h1 id="trace-åæ">Trace åæ</h1>
<p><img src="https://img2024.cnblogs.com/blog/1483609/202601/1483609-20260110154123776-1794652238.png" alt="image" loading="lazy"></p>
<ol>
<li>é»å®¢è°ç¨ buyTRU() å½æ°ä»¥é¶ææ¬è´­å¥å¤§éç TRU ä»£å¸</li>
<li>ç¶åè°ç¨ sellTRU() å½æ°ååºææ TRU ä»£å¸å®æè·å©</li>
</ol>
<p>éåæ»å»èå©ç¨æ¼æ´ä»¥é¶ææä½ææ¬çä»·æ ¼è´­ä¹° TRU ä»£å¸ååºå®çæµç¨éå¤å¤æ¬¡ã</p>
<h1 id="ä»£ç åæ">ä»£ç åæ</h1>
<p>TRU åçº¦æ¯ä¸ä¸ªä»£çåçº¦ï¼0x764C64b2A09b09Acb100B80d8c505Aa6a0302EF2</p>
<p>å¶å·ä½çé»è¾é»è¾åçº¦ä¸ºï¼0x18ceDF1071EC25331130C82D7AF71D393Ccd4446</p>
<p>ç±äºé»è¾åçº¦å¹¶æ²¡æå¼æºï¼æä»¥æ¥ä¸æ¥ä¼éç¨ dedaub åç¼è¯ + äººå·¥æ ¡æ­£çæ¹å¼åæé¡¹ç®çä¸å¡é»è¾ã</p>
<ul>
<li>é»è¾åçº¦çåç¼è¯å°åï¼<a href="https://app.dedaub.com/ethereum/address/0xc186e6f0163e21be057e95aa135edd52508d14d3/decompiled" target="_blank" rel="noopener nofollow">https://app.dedaub.com/ethereum/address/0xc186e6f0163e21be057e95aa135edd52508d14d3/decompiled</a></li>
</ul>
<p>å¨ buyTRU() å½æ°ä¸­ï¼ä¼æ ¹æ®è¾å¥ç TRUAmount åæ°å¼è®¡ç®æéè¦ç ETH æ°éï¼å¹¶æ£æ¥ msg.value çå¼æ¯å¦ä¸ºç¸ç­ãéè¿æ£æ¥åï¼ä¼ç»ç¨æ· mint TRUAmount æ°éç TRU ä»£å¸ã</p>
<p><img src="https://img2024.cnblogs.com/blog/1483609/202601/1483609-20260110154138455-1713236541.png" alt="image" loading="lazy"></p>
<p>å¶é®é¢å°±åºå¨è®¡ç® ETH æ°éç TRUtoETH() å½æ°ä¸ï¼å¶åç¼è¯çåå®¹å¦ä¸ï¼æ ¹æ®è¾å¥ç TRUAmount å¼è¿è¡ä¸ç³»åçè®¡ç®ã</p>
<p><img src="https://img2024.cnblogs.com/blog/1483609/202601/1483609-20260110154148291-397462858.png" alt="image" loading="lazy"></p>
<p>éè¿ solidity éåè¿ä¸ªå½æ°ï¼å¾å°ä»¥ä¸çåå®¹ãå¶ä¸­ _setParameters çå¼ä¸º 75ï¼ä»£è¡¨ 75% çä¸ä¸ªæ¯ä¾ã</p>
<pre><code class="language-solidity">function TRUtoETH(uint256 TRUAmount) private view returns (uint256) {
    uint256 totalSupply = TRU.totalSupply();
    
    // numerator: (100 - 75) * totalSupplyÂ² = 25 * totalSupplyÂ²
    uint256 numerator = (100 - _setParameters) * totalSupply * totalSupply;
    
    // denominator: 100 * TRUAmount * _reserve * (TRUAmount + 2 * totalSupply)
    uint256 denominator = 100 * TRUAmount * _reserve * (TRUAmount + 2 * totalSupply);
    
    return numerator / denominator;
}

</code></pre>
<p>ç±ä¸é¢çä»£ç åæå¯å¾ï¼å½ _setParametersï¼totalSupply å _reserve ä¸ºåºå®å¼æ¶ï¼ä¼ å¥çåæ° TRUAmount è¶å¤§ï¼åæ¯å°±è¶å¤§ï¼è¿åå¼å°±ä¼ç¸åºçåå°ãèå½åæ¯å¤§äºåå­æ¶ï¼ç±äº solidity ç²¾åº¦ä¸¢å¤±çç¹æ§ï¼è¿åå¼å°ä¼ä¸º 0ãä¹å°±æ¯è¯´ï¼</p>
<blockquote>
<p>å½ TRUAmount çå¼éå¸¸å¤§ï¼å½åçè®¡ç®å¬å¼å¨è®¡ç®æéè¦æä¾ç ETH æ°éæ¶ï¼ä¼ç±äº solidity çç²¾åº¦ä¸¢å¤±è¿å 0 å¼ã</p>
</blockquote>
<p>è¿æ ·ï¼æ»å»èå°±å®æäºæ»å»çç¬¬ä¸ä¸ªæ­¥éª¤ï¼ä»¥é¶ææä½ææ¬çä»·æ ¼è´­ä¹° TRU ä»£å¸ã</p>
<p>éåå°±æ¯æ­£å¸¸ä½¿ç¨ sellTRU() å½æ°ååºææ TRU ä»£å¸å®æäºè·å©ã</p>
<p><img src="https://img2024.cnblogs.com/blog/1483609/202601/1483609-20260110154205268-1163820900.png" alt="image" loading="lazy"></p>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-01-10 15:43">2026-01-10 15:42</span>&nbsp;
<a href="https://www.cnblogs.com/ACaiGarden">ACai_sec</a>&nbsp;
éè¯»(<span id="post_view_count">100</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19465686);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19465686', targetLink: 'https://www.cnblogs.com/ACaiGarden/p/19465686', title: '20260109 - TRU åè®®æ»å»äºä»¶åæï¼ä¹°å¾å¤å¤åè´¹éäºåï¼' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ ãAzure Redisãå®¢æ·ç«¯åºç¨ä½¿ç¨ Azure Redis Cluster æ¥é java.security.cert.CertificateException: No subject alternative names matching IP address xxx.xxx.xxx.xxx found ]]></title>
    <link>https://www.cnblogs.com/lulight/p/19464831</link>
    <guid>47d1e19212755811556534f3362930d6</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/lulight/p/19464831" title="åå¸äº 2026-01-10 12:02">
    <span role="heading" aria-level="2">ãAzure Redisãå®¢æ·ç«¯åºç¨ä½¿ç¨ Azure Redis Cluster æ¥é java.security.cert.CertificateException: No subject alternative names matching IP address xxx.xxx.xxx.xxx found</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body blogpost-body-html">
<h1>é®é¢æè¿°</h1>
<p>ä½¿ç¨Azure Cache for Redisçéç¾¤æ¨¡å¼ãåºç¨å®¢æ·ç«¯ä¸ºJavaä»£ç ï¼ä½¿ç¨Lettuce ä½ä¸ºRedis å®¢æ·ç«¯SDKãå¯å¨é¡¹ç®æ¥éï¼<span style="color: rgba(255, 0, 0, 1)"><strong><span style="font-style: italic; background-color: initial">Caused by: java.security.cert.CertificateException: No subject alternative names matching IP address 159.27.xxx.xxx foundã</span></strong></span></p>
<h2><span style="color: rgba(0, 0, 0, 1)"><strong><span style="background-color: initial">è¿è¡æ¶çéè¯¯æªå¾</span></strong></span></h2>
<p><img alt="image" width="666" height="435" loading="lazy" data-src="https://img2024.cnblogs.com/blog/2127802/202601/2127802-20260110103559787-1742382700.png" class="lazyload"></p>
<h2>ç¤ºä¾ä»£ç </h2>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 255, 1)">package</span><span style="color: rgba(0, 0, 0, 1)"> com.lbazureredis;

</span><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> io.lettuce.core.RedisURI;
</span><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> io.lettuce.core.cluster.RedisClusterClient;
</span><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> io.lettuce.core.cluster.api.StatefulRedisClusterConnection;
</span><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> io.lettuce.core.cluster.api.sync.RedisAdvancedClusterCommands;

</span><span style="color: rgba(0, 0, 255, 1)">public</span> <span style="color: rgba(0, 0, 255, 1)">class</span><span style="color: rgba(0, 0, 0, 1)"> Main {
    </span><span style="color: rgba(0, 0, 255, 1)">public</span> <span style="color: rgba(0, 0, 255, 1)">static</span> <span style="color: rgba(0, 0, 255, 1)">void</span><span style="color: rgba(0, 0, 0, 1)"> main(String[] args) {
        
        System.out.println(</span>"Hello world! This is Redis Cluster example."<span style="color: rgba(0, 0, 0, 1)">);
        
        RedisURI redisUri </span>= RedisURI.Builder.redis("&lt;yourredisname&gt;.redis.cache.chinacloudapi.cn", 6380<span style="color: rgba(0, 0, 0, 1)">)
                .withPassword(</span>"&lt;your redis access key&gt;").withSsl(<span style="color: rgba(0, 0, 255, 1)">true</span><span style="color: rgba(0, 0, 0, 1)">).build();
        RedisClusterClient clusterClient </span>=<span style="color: rgba(0, 0, 0, 1)"> RedisClusterClient.create(redisUri);
        StatefulRedisClusterConnection</span>&lt;String, String&gt; connection =<span style="color: rgba(0, 0, 0, 1)"> clusterClient.connect();
        RedisAdvancedClusterCommands</span>&lt;String, String&gt; syncCommands =<span style="color: rgba(0, 0, 0, 1)"> connection
                .sync();

        String pingResponse </span>=<span style="color: rgba(0, 0, 0, 1)"> syncCommands.ping();
        System.out.println(</span>"Ping response: " +<span style="color: rgba(0, 0, 0, 1)"> pingResponse);

        syncCommands.set(</span>"mykey", "Hello, Redis Cluster!"<span style="color: rgba(0, 0, 0, 1)">);
        String value </span>= syncCommands.get("mykey"<span style="color: rgba(0, 0, 0, 1)">);
        System.out.println(</span>"Retrieved value: " +<span style="color: rgba(0, 0, 0, 1)"> value);
        
        connection.close();
        clusterClient.shutdown();

    }
}</span></pre>
</div>
<h2>é¡¹ç®POM.xml</h2>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 255, 1)">&lt;?</span><span style="color: rgba(255, 0, 255, 1)">xml version="1.0" encoding="UTF-8"</span><span style="color: rgba(0, 0, 255, 1)">?&gt;</span>
<span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">project </span><span style="color: rgba(255, 0, 0, 1)">xmlns</span><span style="color: rgba(0, 0, 255, 1)">="http://maven.apache.org/POM/4.0.0"</span><span style="color: rgba(255, 0, 0, 1)">
         xmlns:xsi</span><span style="color: rgba(0, 0, 255, 1)">="http://www.w3.org/2001/XMLSchema-instance"</span><span style="color: rgba(255, 0, 0, 1)">
         xsi:schemaLocation</span><span style="color: rgba(0, 0, 255, 1)">="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
    <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">modelVersion</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>4.0.0<span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">modelVersion</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>

    <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">groupId</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>com.lbazureredis<span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">groupId</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
    <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">artifactId</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>test<span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">artifactId</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
    <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">version</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>1.0-SNAPSHOT<span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">version</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>

    <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">properties</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
        <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">maven.compiler.source</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>17<span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">maven.compiler.source</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
        <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">maven.compiler.target</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>17<span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">maven.compiler.target</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
    <span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">properties</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>

    <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">dependencies</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
        <span style="color: rgba(0, 128, 0, 1)">&lt;!--</span><span style="color: rgba(0, 128, 0, 1)"> Lettuce Redis Client </span><span style="color: rgba(0, 128, 0, 1)">--&gt;</span>
        <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">dependency</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
            <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">groupId</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>io.lettuce<span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">groupId</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
            <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">artifactId</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>lettuce-core<span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">artifactId</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
            <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">version</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>6.3.1.RELEASE<span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">version</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
        <span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">dependency</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
        <span style="color: rgba(0, 128, 0, 1)">&lt;!--</span><span style="color: rgba(0, 128, 0, 1)"> SLF4J for logging </span><span style="color: rgba(0, 128, 0, 1)">--&gt;</span>
        <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">dependency</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
            <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">groupId</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>org.slf4j<span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">groupId</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
            <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">artifactId</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>slf4j-simple<span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">artifactId</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
            <span style="color: rgba(0, 0, 255, 1)">&lt;</span><span style="color: rgba(128, 0, 0, 1)">version</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>2.0.9<span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">version</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
        <span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">dependency</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>
    <span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">dependencies</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span>

<span style="color: rgba(0, 0, 255, 1)">&lt;/</span><span style="color: rgba(128, 0, 0, 1)">project</span><span style="color: rgba(0, 0, 255, 1)">&gt;</span></pre>
</div>
<p><span style="font-size: 18px; color: rgba(255, 0, 0, 1)"><strong>éå¯¹ä»¥ä¸é®é¢ï¼å¦ä½è§£å³å¢ï¼</strong></span></p>
<p>&nbsp;</p>
<h1>é®é¢è§£ç­</h1>
<p>æ ¹æ®éè¯¯ä¿¡æ¯æç´¢åï¼å¾å°Azureå®æ¹æä½³å®è·µææ¡£ä¸­çè§£ç­ï¼<a href="https://github.com/Azure/AzureCacheForRedis/blob/main/Lettuce%20Best%20Practices.md" target="_blank" rel="noopener nofollow">https://github.com/Azure/AzureCacheForRedis/blob/main/Lettuce%20Best%20Practices.md</a></p>
<blockquote>
<p>The reason this is required is because SSL certification validates the address of the Redis Nodes with the SAN (Subject Alternative Names) in the SSL certificate. <strong>Redis protocol requires that these node addresses should be IP addresses.</strong> However, the SANs in<strong> the Azure Redis SSL certificates contains only the Hostname</strong> since Public IP addresses can change and as a result not completely secure.</p>
<p>å¨Redis Protocoléªè¯ä¸­ï¼å¿é¡»éªè¯è¯ä¹¦ä¸­åå«IPå°åï¼ä½ç±äºAzure Redisé¨ç½²å¨äºç¯å¢ä¸­ï¼IPå°åæ¯ä¸åºå®çãæä»¥é»è®¤æåµä¸ï¼Redis SSLè¯ä¹¦ä¸­åå«çæ¯ååãä¸ºäºè§£å³è¿ä¸ªé®é¢ï¼éè¦å»ºç«ä¸ä¸ªHostä¸IPå°åçæ å°å³ç³»ï¼ä½¿å¾Lettuceå®¢æ·ç«¯å¨éªè¯Redisè¯ä¹¦æ¶éè¿ååéªè¯èéIPå°åï¼ç¨äºè§£å³<strong>No subject alternative names matching IP address 159.27.xxx.xxx found </strong>é®é¢</p>
</blockquote>
<p>åèææ¡£ä¸­çæ¹æ³ï¼èªå®ä¹<strong><code>MappingSocketAddressResolver</code></strong></p>
<div class="cnblogs_code">
<pre>        Function&lt;HostAndPort, HostAndPort&gt; <span style="background-color: rgba(255, 204, 0, 1)">mappingFunction</span> = <span style="color: rgba(0, 0, 255, 1)">new</span> Function&lt;HostAndPort, HostAndPort&gt;<span style="color: rgba(0, 0, 0, 1)">() {
            @Override
            </span><span style="color: rgba(0, 0, 255, 1)">public</span><span style="color: rgba(0, 0, 0, 1)"> HostAndPort apply(HostAndPort hostAndPort) {
                String cacheIP </span>= ""<span style="color: rgba(0, 0, 0, 1)">;
                </span><span style="color: rgba(0, 0, 255, 1)">try</span><span style="color: rgba(0, 0, 0, 1)"> {
                    InetAddress[] addresses </span>=<span style="color: rgba(0, 0, 0, 1)"> DnsResolvers.JVM_DEFAULT.resolve(host);
                    cacheIP </span>= addresses[0<span style="color: rgba(0, 0, 0, 1)">].getHostAddress();
                } </span><span style="color: rgba(0, 0, 255, 1)">catch</span><span style="color: rgba(0, 0, 0, 1)"> (UnknownHostException e) {
                    e.printStackTrace();
                }
                HostAndPort finalAddress </span>=<span style="color: rgba(0, 0, 0, 1)"> hostAndPort;

                </span><span style="color: rgba(0, 0, 255, 1)">if</span><span style="color: rgba(0, 0, 0, 1)"> (hostAndPort.hostText.equals(cacheIP))
                    finalAddress </span>=<span style="color: rgba(0, 0, 0, 1)"> HostAndPort.of(host, hostAndPort.getPort());
                </span><span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)"> finalAddress;
            }
        };

        <span style="background-color: rgba(255, 204, 0, 1)">MappingSocketAddressResolver</span> resolver </span>=<span style="color: rgba(0, 0, 0, 1)"> MappingSocketAddressResolver.create(DnsResolvers.JVM_DEFAULT,
                mappingFunction);
        <span style="background-color: rgba(255, 204, 0, 1)">ClientResources</span> res </span>=<span style="color: rgba(0, 0, 0, 1)"> DefaultClientResources.builder()
                .socketAddressResolver(resolver).build();
        RedisURI redisURI </span>= RedisURI.Builder.redis(host).withSsl(<span style="color: rgba(0, 0, 255, 1)">true</span><span style="color: rgba(0, 0, 0, 1)">)
                .withPassword(password)
                .withClientName(</span>"LettuceClient"<span style="color: rgba(0, 0, 0, 1)">)
                .withPort(</span>6380<span style="color: rgba(0, 0, 0, 1)">)
                .build();
        RedisClusterClient redisClient </span>= RedisClusterClient.create(<span style="background-color: rgba(255, 204, 0, 1)">res</span>, redisURI);</pre>
</div>
<h2>ä»£ç è§£è¯»</h2>
<blockquote>
<h3>mappingFunction</h3>
<ul>
<li>å®æ¯ä¸ä¸ªèªå®ä¹çå°åæ å°é»è¾ï¼ç¨äºå¤ç Lettuce å¨è¿æ¥ Redis éç¾¤æ¶çä¸»æºåä¸ IP å°åé®é¢ã</li>
<li>å®éè¿ DnsResolvers.JVM_DEFAULT å¯¹æå®çååè¿è¡ DNS è§£æï¼è·åå¯¹åºç IP å°åãå¦æå½å HostAndPort ç hostText ä¸è§£æåºç IP ç¸åï¼åå°å¶æ¿æ¢ä¸ºåå§åå hostï¼ä¿æç«¯å£ä¸åã</li>
<li>è¿ä¸é»è¾çæ ¸å¿ç®çæ¯è§£å³ SSL è¯ä¹¦æ ¡éªé®é¢ï¼å ä¸ºè¯ä¹¦éå¸¸ç»å®ååèé IPï¼ç¡®ä¿è¿æ¥æ¶ä½¿ç¨ååè¿è¡éªè¯ï¼é¿åå  IP å¯¼è´çæ¡æå¤±è´¥ã</li>
</ul>
<h3>MappingSocketAddressResolver</h3>
<ul>
<li>å®æ¯ Lettuce æä¾çä¸ä¸ªå·¥å·ç±»ï¼ç¨äºå¨è¿æ¥ Redis æ¶æå¥èªå®ä¹çå°åè§£æé»è¾ã</li>
<li>å®ç»åé»è®¤ç DNS è§£æå¨å mappingFunctionï¼å¨æ¯æ¬¡è§£æ Socket å°åæ¶æ§è¡æ å°æä½ã</li>
<li>éè¿è¿ç§æ¹å¼ï¼å®¢æ·ç«¯å¯ä»¥å¨ DNS è§£æåå¯¹ç»æè¿è¡äºæ¬¡å¤çï¼ä¾å¦å° IP å°åéæ°æ å°ä¸ºååã</li>
<li>è¿å¯¹äºäºæå¡åºæ¯ï¼å¦ Azure Redisï¼éå¸¸éè¦ï¼å ä¸ºè¿äºæå¡ç SSL è¯ä¹¦éå¸¸åªå¯¹ååææï¼èä¸æ¯ IP å°åã</li>
</ul>
<h3>DefaultClientResources</h3>
<ul>
<li><span style="background-color: initial; font-size: 14px">ä½ä¸º Lettuce çæ ¸å¿èµæºç®¡çå¨ï¼ç¨äºéç½®å®¢æ·ç«¯çåºå±è¡ä¸ºï¼åæ¬çº¿ç¨æ± ãDNS è§£æå¨ãäºä»¶å¾ªç¯ç­ãå¨è¿éï¼å®çä½ç¨æ¯å°èªå®ä¹ç MappingSocketAddressResolver æ³¨å¥å°å®¢æ·ç«¯èµæºä¸­ï¼ä½¿ææè¿æ¥è¯·æ±é½éµå¾ªèªå®ä¹çå°åè§£æé»è¾ã</span></li>
<li><span style="background-color: initial; font-size: 14px">éè¿è¿ç§æ¹å¼ï¼æ´ä¸ª Lettuce å®¢æ·ç«¯å¨è¿æ¥ Redis éç¾¤æ¶é½ä¼ä½¿ç¨ååèé IPï¼ç¡®ä¿ SSL æ ¡éªéè¿ï¼åæ¶ä¿æè¿æ¥çç¨³å®æ§åå®å¨æ§ã</span></li>
</ul>
</blockquote>
<p>&nbsp;</p>
<h2>æ§è¡ç»æ</h2>
<p>åæ¬¡è¿è¡ï¼æåè¿æ¥å°Azure Redis Cluster åæ§è¡Ping, Set, Getæä»¤ï¼</p>
<p><img alt="image" width="999" height="541" loading="lazy" data-src="https://img2024.cnblogs.com/blog/2127802/202601/2127802-20260110110538990-1787264431.png" class="lazyload"></p>
<h2>ä¿®æ¹åå®æ´çJavaç¤ºä¾ä»£ç å¦ä¸ï¼</h2>
<div class="cnblogs_code">
<pre><span style="color: rgba(0, 0, 255, 1)">package</span><span style="color: rgba(0, 0, 0, 1)"> com.lbazureredis;

</span><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> java.net.InetAddress;
</span><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> java.net.UnknownHostException;
</span><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> java.time.Duration;
</span><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> java.util.function.Function;

</span><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> io.lettuce.core.RedisURI;
</span><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> io.lettuce.core.SocketOptions;
</span><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> io.lettuce.core.api.StatefulRedisConnection;
</span><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> io.lettuce.core.cluster.ClusterClientOptions;
</span><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> io.lettuce.core.cluster.ClusterTopologyRefreshOptions;
</span><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> io.lettuce.core.cluster.RedisClusterClient;
</span><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> io.lettuce.core.cluster.api.StatefulRedisClusterConnection;
</span><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> io.lettuce.core.cluster.api.async.RedisAdvancedClusterAsyncCommands;
</span><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> io.lettuce.core.cluster.api.sync.RedisAdvancedClusterCommands;
</span><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> io.lettuce.core.internal.HostAndPort;
</span><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> io.lettuce.core.resource.ClientResources;
</span><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> io.lettuce.core.resource.DefaultClientResources;
</span><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> io.lettuce.core.resource.DnsResolvers;
</span><span style="color: rgba(0, 0, 255, 1)">import</span><span style="color: rgba(0, 0, 0, 1)"> io.lettuce.core.resource.MappingSocketAddressResolver;

</span><span style="color: rgba(0, 0, 255, 1)">public</span> <span style="color: rgba(0, 0, 255, 1)">class</span><span style="color: rgba(0, 0, 0, 1)"> Main {

    </span><span style="color: rgba(0, 0, 255, 1)">public</span> <span style="color: rgba(0, 0, 255, 1)">static</span> <span style="color: rgba(0, 0, 255, 1)">void</span><span style="color: rgba(0, 0, 0, 1)"> main(String[] args) {

        System.out.println(</span>"Hello world! This is Redis Cluster example."<span style="color: rgba(0, 0, 0, 1)">);

        String host </span>= "&lt;yourredisname&gt;.redis.cache.chinacloudapi.cn"<span style="color: rgba(0, 0, 0, 1)">;
        String password </span>= "&lt;your redis access key&gt;"<span style="color: rgba(0, 0, 0, 1)">;

        Function</span>&lt;HostAndPort, HostAndPort&gt; <span style="background-color: rgba(255, 204, 0, 1)">mappingFunction</span> = <span style="color: rgba(0, 0, 255, 1)">new</span> Function&lt;HostAndPort, HostAndPort&gt;<span style="color: rgba(0, 0, 0, 1)">() {
            @Override
            </span><span style="color: rgba(0, 0, 255, 1)">public</span><span style="color: rgba(0, 0, 0, 1)"> HostAndPort apply(HostAndPort hostAndPort) {
                String cacheIP </span>= ""<span style="color: rgba(0, 0, 0, 1)">;
                </span><span style="color: rgba(0, 0, 255, 1)">try</span><span style="color: rgba(0, 0, 0, 1)"> {
                    InetAddress[] addresses </span>=<span style="color: rgba(0, 0, 0, 1)"> DnsResolvers.JVM_DEFAULT.resolve(host);
                    cacheIP </span>= addresses[0<span style="color: rgba(0, 0, 0, 1)">].getHostAddress();
                } </span><span style="color: rgba(0, 0, 255, 1)">catch</span><span style="color: rgba(0, 0, 0, 1)"> (UnknownHostException e) {
                    e.printStackTrace();
                }
                HostAndPort finalAddress </span>=<span style="color: rgba(0, 0, 0, 1)"> hostAndPort;

                </span><span style="color: rgba(0, 0, 255, 1)">if</span><span style="color: rgba(0, 0, 0, 1)"> (hostAndPort.hostText.equals(cacheIP))
                    finalAddress </span>=<span style="color: rgba(0, 0, 0, 1)"> HostAndPort.of(host, hostAndPort.getPort());
                </span><span style="color: rgba(0, 0, 255, 1)">return</span><span style="color: rgba(0, 0, 0, 1)"> finalAddress;
            }
        };

        MappingSocketAddressResolver resolver </span>=<span style="color: rgba(0, 0, 0, 1)"> MappingSocketAddressResolver.create(DnsResolvers.JVM_DEFAULT,
                <span style="background-color: rgba(255, 204, 0, 1)">mappingFunction</span>);
        ClientResources res </span>=<span style="color: rgba(0, 0, 0, 1)"> DefaultClientResources.builder()
                .socketAddressResolver(resolver).build();
        RedisURI redisURI </span>= RedisURI.Builder.redis(host).withSsl(<span style="color: rgba(0, 0, 255, 1)">true</span><span style="color: rgba(0, 0, 0, 1)">)
                .withPassword(password)
                .withClientName(</span>"LettuceClient"<span style="color: rgba(0, 0, 0, 1)">)
                .withPort(</span>6380<span style="color: rgba(0, 0, 0, 1)">)
                .build();
        RedisClusterClient redisClient </span>=<span style="color: rgba(0, 0, 0, 1)"> RedisClusterClient.create(<span style="background-color: rgba(255, 204, 0, 1)">res</span>, redisURI);
        </span><span style="color: rgba(0, 128, 0, 1)">//</span><span style="color: rgba(0, 128, 0, 1)"> Cluster specific settings for optimal reliability.</span>
        ClusterTopologyRefreshOptions refreshOptions =<span style="color: rgba(0, 0, 0, 1)"> ClusterTopologyRefreshOptions.builder()
                .enablePeriodicRefresh(Duration.ofSeconds(</span>5<span style="color: rgba(0, 0, 0, 1)">))
                .dynamicRefreshSources(</span><span style="color: rgba(0, 0, 255, 1)">false</span><span style="color: rgba(0, 0, 0, 1)">)
                .adaptiveRefreshTriggersTimeout(Duration.ofSeconds(</span>5<span style="color: rgba(0, 0, 0, 1)">))
                .enableAllAdaptiveRefreshTriggers().build();
        redisClient.setOptions(ClusterClientOptions.builder()
                .socketOptions(SocketOptions.builder()
                        .keepAlive(</span><span style="color: rgba(0, 0, 255, 1)">true</span><span style="color: rgba(0, 0, 0, 1)">)
                        .build())
                .topologyRefreshOptions(refreshOptions).build());
                
        StatefulRedisClusterConnection</span>&lt;String, String&gt; connection =<span style="color: rgba(0, 0, 0, 1)"> redisClient.connect();
        RedisAdvancedClusterCommands</span>&lt;String, String&gt; syncCommands =<span style="color: rgba(0, 0, 0, 1)"> connection.sync();
        RedisAdvancedClusterAsyncCommands</span>&lt;String, String&gt; asyncCommands =<span style="color: rgba(0, 0, 0, 1)"> connection.async();

        String pingResponse </span>=<span style="color: rgba(0, 0, 0, 1)"> syncCommands.ping();
        System.out.println(</span>"Ping response: " +<span style="color: rgba(0, 0, 0, 1)"> pingResponse);

        syncCommands.set(</span>"mykey", "Hello, Redis Cluster!"<span style="color: rgba(0, 0, 0, 1)">);
        String value </span>= syncCommands.get("mykey"<span style="color: rgba(0, 0, 0, 1)">);
        System.out.println(</span>"Retrieved value: " +<span style="color: rgba(0, 0, 0, 1)"> value);

        connection.close();

        redisClient.shutdown();

    }
}</span></pre>
</div>
<h2>ä»£ç æµç¨å¾</h2>
<p>åºäºAIæ¨¡åè§£è¯»ä»¥ä¸ä»£ç åï¼åæåºæ¥çä»£ç æµç¨å¾</p>
<p><img alt="image" width="666" height="256" loading="lazy" style="border: 2px solid rgba(0, 0, 139, 1)" data-src="https://img2024.cnblogs.com/blog/2127802/202601/2127802-20260110115138422-1780247927.png" class="lazyload"></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h1>åèèµæ</h1>
<div class="markdown-heading" dir="auto">
<p class="heading-element" dir="auto">Best Practices for using Azure Cache for Redis with Lettuce ï¼<a href="https://github.com/Azure/AzureCacheForRedis/blob/main/Lettuce%20Best%20Practices.md" target="_blank" rel="noopener nofollow">https://github.com/Azure/AzureCacheForRedis/blob/main/Lettuce%20Best%20Practices.md</a></p>
<div>&nbsp;</div>
<a id="user-content-best-practices-for-using-azure-cache-for-redis-with-lettuce" class="anchor" href="https://github.com/Azure/AzureCacheForRedis/blob/main/Lettuce%20Best%20Practices.md#best-practices-for-using-azure-cache-for-redis-with-lettuce" rel="noopener nofollow"></a></div>
</div>
<div id="MySignature" role="contentinfo">
    <div style="background: #1c5f55;height: 36px;width: 618px;padding: 14px 5px 0px 3px;">
  <p style="
    font-weight: bold;
    color: white;
">å½å¨å¤æçç¯å¢ä¸­é¢ä¸´é®é¢ï¼æ ¼ç©ä¹ééï¼æµèéä¹å¾æ¸ï¼å®ä»¥å¨ä¹å¾çã äºä¸­ï¼æ°æ¯å¦æ­¤!</p>
</div>
</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0.002777777777777778" data-date-updated="2026-01-10 12:06">2026-01-10 12:02</span>&nbsp;
<a href="https://www.cnblogs.com/lulight">è·¯è¾¹ä¸¤çç¯</a>&nbsp;
éè¯»(<span id="post_view_count">52</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19464831);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19464831', targetLink: 'https://www.cnblogs.com/lulight/p/19464831', title: 'ãAzure Redisãå®¢æ·ç«¯åºç¨ä½¿ç¨ Azure Redis Cluster æ¥é java.security.cert.CertificateException: No subject alternative names matching IP address xxx.xxx.xxx.xxx found' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
<item>
    <title><![CDATA[ æ£æ£ç³å¾ï¼å½æ¡å½¢å¾éä¸æç®ç¾å­¦ ]]></title>
    <link>https://www.cnblogs.com/wang_yb/p/19464212</link>
    <guid>30168694afd0020dbba5fe6a1f19a937</guid>
    <description>
    <![CDATA[ 
            <h1 class="postTitle">
                <a id="cb_post_title_url" class="postTitle2 vertical-middle" href="https://www.cnblogs.com/wang_yb/p/19464212" title="åå¸äº 2026-01-10 08:42">
    <span role="heading" aria-level="2">æ£æ£ç³å¾ï¼å½æ¡å½¢å¾éä¸æç®ç¾å­¦</span>
    

</a>

            </h1>
            <div class="clear"></div>
            <div class="postBody">
                <div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
<p><strong>æ£æ£ç³å¾</strong>ï¼Lollipop Chartï¼å¯ä»¥çä½æ¯æ¡å½¢å¾çä¸ç§âè½»ççâåä½ï¼å®ç¨ä¸æ ¹ä»åºåçº¿å»¶ä¼¸åºæ¥çâæ£âï¼å¹¶å¨æ«ç«¯ä»¥ä¸ä¸ªâç³âï¼åç¹ï¼æ¥è¡¨ç¤ºæ°å¼ï¼åä»£äºä¼ ç»çç©å½¢æ¡ã</p>
<p>è¿ç§å¾è¡¨ä¼ è¾¾çä¿¡æ¯ä¸æ¡å½¢å¾æ¯ä¸æ ·çï¼ä½å®æ´æ³¨éçªåºæ°æ®ç¹çä½ç½®ï¼æ´ä½çèµ·æ¥æ´å æ¸æ°ãç°ä»£ã</p>
<p>ä»å¤©ï¼æä»¬ä¸èµ·æ¢ç´¢æ£æ£ç³å¾çä¼å¿ï¼å¹¶éè¿ä»£ç å®ç°ï¼äº²ææé ä¸ä¸ªå±äºèªå·±çæ£æ£ç³å¾ï¼</p>
<h1 id="è®¾è®¡åç">è®¾è®¡åç</h1>
<p>è®¾è®¡æ£æ£ç³å¾çåè¡·æä¸¤ä¸ªæ¹é¢ï¼</p>
<p>é¦åï¼éè¿åå°å¾å½¢ä¸­çâå¢¨æ°´âä½¿ç¨éï¼å¨é¢å¯¹å¤§éç±»å«ææ°å¼æ®éè¾é«çæåµä¸ï¼é¿åäºæ¡å½¢å¾è¿äºå¯éå¯è½å¸¦æ¥ç<strong>è§è§åè¿«æ</strong>å<strong>æä¹±æ ç« </strong>çæè§ï¼</p>
<p>å¶æ¬¡ï¼è¿æ ·çè®¾è®¡è½å¤æ´å¥½å°å¼å¯¼è§å¯èçæ³¨æåéä¸­å¨åä¸ªæ°æ®ç¹çå·ä½ä½ç½®åå¶ä¹é´çå·®å¼ä¸ï¼éå¸¸éåç¨æ¥è¿è¡æåæèå¯¹æ¯åæã</p>
<p><strong>æ£æ£ç³å¾</strong>ä¸<strong>æ¡å½¢å¾</strong>å¨åè½ä¸æ¯ç­ä»·çï¼ä¹å¹¶ä¸æ»æ¯ä¼äºæ¡å½¢å¾ã</p>
<p>å½å¤çå¤§éç±»å«ãæ¡æ±éå¸¸é«ä¸ç¸äºä¹é´è·ç¦»è¾è¿çæ°æ®æ¶ï¼æ£æ£ç³å¾ä¼æ¾å¾æ´å æäºéè¯»çè§£ï¼</p>
<p>ç¶èï¼å¨éè¦å¼ºè°ç»å¯¹æ°éææ¯å¸æè·å¾æä¸ºç´è§é¿åº¦æ¯è¾çæåµä¸ï¼æ¡å½¢å¾ä¾ç¶æ¯æ´å¥½çéæ©ã</p>
<h1 id="å®ç°åç">å®ç°åç</h1>
<p><strong>æ£æ£ç³å¾</strong>å¨<code>matplotlib</code>åºä¸­æ²¡æç´æ¥å¯¹åºçç±»ã</p>
<p>ä¸è¿ï¼å®çå®ç°åçéå¸¸ç®åï¼éè¿ç»åä½¿ç¨ <code>matplotlib</code> ä¸­çä¸¤ä¸ªåºæ¬ç»å¾åè½å°±å¯ä»¥å®ç°ï¼</p>
<ol>
<li><strong>ç»å¶çº¿æ¡</strong> (<code>plt.vlines</code>)ï¼è¿æ¯æææ£æ£ç³âæ£å­âé¨åçå³é®ã</li>
</ol>
<p><code>plt.vlines</code> å½æ°ç¨äºå¨å¾è¡¨ä¸ç»å¶åç´çº¿æ®µãéè¿æå®æ¯ä¸ªæ°æ®ç¹ç x åæ ãçº¿æ¡çèµ·å§ç¹ï¼éå¸¸æ¯ 0ï¼åç»æç¹ï¼å³å¯¹åºæ°æ®ç y å¼ï¼ï¼å°±å¯ä»¥ç»åºä» x è½´å»¶ä¼¸å°æ°æ®å¼ççº¿æ¡ã</p>
<ol start="2">
<li><strong>ç»å¶åç¹</strong> (<code>plt.scatter</code>)ï¼è¿æ¯æææ£æ£ç³âç³âé¨åçå³é®ã</li>
</ol>
<p><code>plt.scatter</code> å½æ°ç¨äºç»å¶æ£ç¹å¾ãéè¿å°æ¯ä¸ªæ°æ®ç¹ç x åæ å y åæ ï¼å³æ°æ®å¼ï¼ä½ä¸ºåæ°ä¼ å¥ï¼å°±å¯ä»¥å¨æ¯æ¡çº¿çé¡¶ç«¯ç»å¶ä¸ä¸ªåç¹ã</p>
<p>æ»çæ¥è¯´ï¼<strong>å®ç°åç</strong>å°±æ¯ï¼ç¨çº¿æ¡è¡¨ç¤ºæ°å¼çå¤§å°ï¼ç¨åç¹å¼ºè°æ°å¼çç»ç¹ä½ç½®ï¼ä¸¤èç»åå°±å½¢æäºè§è§ä¸ç±»ä¼¼æ£æ£ç³çå¾è¡¨ã</p>
<p>è¿ç§ç»åæ¹å¼ä½¿å¾å¾è¡¨æ¯å®å¿çæ¡å½¢å¾æ´ç®æ´ï¼åæ¶åè½æ¸æ°å°ä¼ è¾¾æ°æ®ä¿¡æ¯ã</p>
<p>ä¸ä¸èçç¤ºä¾ä¸­ï¼å°ä¼æ¼ç¤ºå¦ä½ä½¿ç¨<code>matplotlib</code>æ¥ç»å¶<strong>æ£æ£ç³å¾</strong>ã</p>
<h1 id="åºç¨ç¤ºä¾">åºç¨ç¤ºä¾</h1>
<p>æ¥ä¸æ¥ï¼è®©æä»¬éè¿å®éçå¯¹æ¯ç¤ºä¾ï¼ç´è§å°æåæ£æ£ç³å¾ä¸ä¼ ç»æ¡å½¢å¾çä¸åè¡¨ç°ã</p>
<h2 id="éåæ£æ£ç³å¾çåºæ¯">éåæ£æ£ç³å¾çåºæ¯</h2>
<pre><code class="language-python"># åå»ºæ´å¤ç±»å«çæµè¯æ°æ®
# æ¨¡æä¸åæä»½ä¸­æ¯å¤©çæä¸ªææ ï¼ä¾å¦ï¼æ¯æ¥å¹³åæ­¥æ°ï¼åä½ï¼åæ­¥ï¼
days = [f"Day {i}" for i in range(1, 21)]  # çæ 20 å¤©çæ°æ®
np.random.seed(42)  # è®¾ç½®éæºç§å­ï¼ç¡®ä¿æ¯æ¬¡è¿è¡ç»æä¸è´
# çæ 1 å° 5 ä¹é´çéæºæ°å¼ä½ä¸ºç¤ºä¾æ°æ®
values = np.round(np.random.uniform(1.0, 5.0, size=len(days)), 1)

# --- åå»ºå­å¾ ---
fig, (ax1, ax2) = plt.subplots(2, 1, figsize=(12, 10))  # è°æ´ä¸ºåç´å¸å±ï¼æ¹ä¾¿æ¯è¾

# --- ç»å¶æ¡å½¢å¾ (ä¸å¾) ---
bars = ax1.bar(days, values, color="skyblue", edgecolor="navy", linewidth=0.7)
ax1.set_title("æ¡å½¢å¾ (Bar Chart) - æ¯æ¥æ­¥æ°", fontsize=14)
ax1.set_ylabel("æ°å¼ (åæ­¥)")
# ax1.set_xlabel('æ¥æ') # xè½´æ ç­¾å·²å¨ä¸æ¹å¾ä¸­
ax1.grid(axis="y", linestyle="--", alpha=0.7)
# å¨æ¡å½¢å¾ä¸æ·»å æ°å¼æ ç­¾
for bar, val in zip(bars, values):
    height = bar.get_height()
    ax1.text(
        bar.get_x() + bar.get_width() / 2.0,
        height + 0.05,
        f"{val}",
        ha="center",
        va="bottom",
        fontsize=8,
    )  # æ ç­¾æè½¬90åº¦èçç©ºé´

# --- ç»å¶æ£æ£ç³å¾ (ä¸å¾) ---
# 1. ç»å¶çº¿æ¡
ax2.vlines(x=range(len(days)), ymin=0, ymax=values, color="navy", linewidth=2)
# 2. å¨çº¿æ¡é¡¶é¨ç»å¶åç¹
ax2.scatter(x=range(len(days)), y=values, color="red", s=50, zorder=3)
# 3. æ·»å æ°å¼æ ç­¾
for i, val in enumerate(values):
    ax2.text(i, val + 0.1, f"{val}", ha="center", va="bottom", fontsize=8)

ax2.set_title("æ£æ£ç³å¾ (Lollipop Chart) - æ¯æ¥æ­¥æ°", fontsize=14)
ax2.set_ylabel("æ°å¼ (åæ­¥)")
ax2.set_xlabel("æ¥æ")
ax2.set_xticks(range(len(days)))
ax2.set_xticklabels(days, rotation=45, ha="right")  # æè½¬xè½´æ ç­¾ä»¥ä¾¿éè¯»
ax2.grid(axis="y", linestyle="--", alpha=0.7)
ax2.set_ylim(0, max(values) * 1.1)

# --- æ¾ç¤ºå¾å½¢ ---
plt.tight_layout()  # è°æ´å­å¾é´è·
plt.show()
</code></pre>

<p><img src="https://img2024.cnblogs.com/blog/83005/202601/83005-20260110084120492-216729079.png" alt="" loading="lazy"></p>
<p>è¿ä¸ªç¤ºä¾ä½¿ç¨äº20ä¸ªæ°æ®ç±»å«ï¼Day 1 å° Day 20ï¼ã</p>
<p>ä½ å¯ä»¥çå°ï¼å¨æ¡å½¢å¾ä¸­ï¼è®¸å¤èè²çæ¡å½¢ç´§å¯å°æåå¨ä¸èµ·ï¼è§è§ä¸æ¾å¾æäºæ¥æ¤ã</p>
<p>èå¨æ£æ£ç³å¾ä¸­ï¼çº¿æ¡ååç¹ä½¿å¾æ°æ®ç¹ä¹é´çå³ç³»æ´å æ¸æ°ï¼æ´ä½è§è§æææ´è½»çï¼æ´å®¹ææ¯è¾åä¸ªæ°å¼çå¤§å°åè¯å«æ¨¡å¼ã</p>
<h2 id="éåä¼ ç»æ¡å½¢å¾çåºæ¯">éåä¼ ç»æ¡å½¢å¾çåºæ¯</h2>
<pre><code class="language-python"># åå»ºæ´éåæ¡å½¢å¾çæµè¯æ°æ®
# æ¨¡ææå¬å¸è¿ç»­12ä¸ªæçéå®é¢ï¼åä½ï¼ä¸åï¼
months = [
    "1æ",
    "2æ",
    "3æ",
    "4æ",
    "5æ",
    "6æ",
    "7æ",
    "8æ",
    "9æ",
    "10æ",
    "11æ",
    "12æ",
]
# çææä¸å®è¶å¿åæ³¢å¨çéå®é¢æ°æ®ï¼ä¾å¦æå­£èæ§é«å³°
sales = [120, 110, 135, 140, 155, 170, 185, 180, 160, 150, 145, 165]

# --- åå»ºå­å¾ ---
fig, (ax1, ax2) = plt.subplots(1, 2, figsize=(16, 6))

# --- ç»å¶æ¡å½¢å¾ (å·¦å¾) ---
bars = ax1.bar(months, sales, color="lightsteelblue", edgecolor="black", linewidth=0.7)
ax1.set_title("æ¡å½¢å¾ (Bar Chart - æä»½éå®é¢)", fontsize=14)
ax1.set_ylabel("éå®é¢ (ä¸å)")
ax1.set_xlabel("æä»½")
ax1.grid(axis="y", linestyle="--", alpha=0.7)
# å¨æ¡å½¢å¾ä¸æ·»å æ°å¼æ ç­¾
for bar, s in zip(bars, sales):
    height = bar.get_height()
    ax1.text(
        bar.get_x() + bar.get_width() / 2.0,
        height + 2,
        f"{s}",
        ha="center",
        va="bottom",
        fontsize=9,
    )

# --- ç»å¶æ£æ£ç³å¾ (å³å¾) ---
ax2.vlines(x=range(len(months)), ymin=0, ymax=sales, color="gray", linewidth=2)
ax2.scatter(x=range(len(months)), y=sales, color="coral", s=50, zorder=3)
for i, s in enumerate(sales):
    ax2.text(i, s + 3, f"{s}", ha="center", va="bottom", fontsize=9)

ax2.set_title("æ£æ£ç³å¾ (Lollipop Chart - æä»½éå®é¢)", fontsize=14)
ax2.set_ylabel("éå®é¢ (ä¸å)")
ax2.set_xlabel("æä»½")
ax2.set_xticks(range(len(months)))
ax2.set_xticklabels(months, rotation=45)  # æè½¬xè½´æ ç­¾ä»¥é²éå 
ax2.grid(axis="y", linestyle="--", alpha=0.7)
ax2.set_ylim(0, max(sales) * 1.1)

# --- æ¾ç¤ºå¾å½¢ ---
plt.tight_layout()
plt.show()
</code></pre>

<p><img src="https://img2024.cnblogs.com/blog/83005/202601/83005-20260110084120515-917001944.png" alt="" loading="lazy"></p>
<p>å¨è¿ä¸ªç¤ºä¾ä¸­ï¼æ°æ®ä»£è¡¨çæ¯è¿ç»­çæä»½ï¼æ°å¼æ¬èº«ä»£è¡¨çæ¯éå®é¢ï¼è¿æ¯ä¸ä¸ªâéâçæ¦å¿µã</p>
<p>æ¡å½¢å¾çå®å¿åè½è®©äººç«å»æåå°åªä¸ªæä»½çéå®é¢æ´é«ï¼æ´ä½çåå¸åå¯¹æ¯å³ç³»ä¸ç®äºç¶ã</p>
<p>èæ£æ£ç³å¾è½ç¶ä¹å±ç¤ºäºæ°æ®ï¼ä½çº¿æ¡ååç¹çç»åå¨è§è§ä¸ä¸å¦å®å¿æ¡å½¢é£æ ·è½ç´æ¥ä¼ è¾¾âéâçæè§ï¼å°¤å¶æ¯å¨æ°å¼å·®å¼ä¸æ¯ç¹å«å·¨å¤§æ¶ï¼å¯¹æ¯ææä¼ç¨éäºæ¡å½¢å¾ã</p>
<h1 id="æ»ç»">æ»ç»</h1>
<p><strong>æ£æ£ç³å¾</strong>å°±åæ°æ®å¯è§åä¸çä¸­ç"å°å³æ¯å¤"å²å­¦ä½ç°ã</p>
<p>å®ä¸æ¯è¦åä»£ä¼ ç»æ¡å½¢å¾ï¼èæ¯ä¸ºæ°æ®å¯è§åå·¥å·ç®±å¢å äºä¸ä¸ªæä»·å¼çéé¡¹ã</p>
<p>å°±åä¸åçç»ç¬éåä¸åçç»ç»é£æ ¼ï¼ä¸åçå¾è¡¨ç±»åä¹éåä¸åçæ°æ®æäºã</p>
<p><strong>æ£æ£ç³å¾</strong>ççæ­£ä¼å¿å¨äºå®æ¹åäºæ°æ®ç<strong>"è®²è¿°æ¹å¼"</strong>ã</p>
<p>å®ä¸è¯´ï¼"è¿æ¯ææä¿¡æ¯ï¼ä½ èªå·±æ¾éç¹"ï¼èæ¯è¯´ï¼"çè¿éï¼è¿äºæ¯å³é®ç¹"ã</p>
<p>è¿ç§ç¦ç¹å¯¼åçç¹æ§ï¼ä½¿å¾æ£æ£ç³å¾å¨ç°ä»£å¿«èå¥çæ°æ®æ²éä¸­è¶æ¥è¶åæ¬¢è¿ã</p>
<p>è®¾è®¡å¯è§åæ¶ï¼æä»¬ä¸å¦¨é®é®èªå·±ï¼ææ³è¦è§ä¼é¦åçå°ä»ä¹ï¼å¦ææ¯ç²¾ç¡®çæ°å¼ç¹åæ¸æ°çæåï¼é£ä¹æ£æ£ç³å¾å¯è½æ¯ä½ ççæ³éæ©ã</p>

</div>
<div class="clear"></div>

            </div>
            <div class="postDesc">posted @ 
<span id="post-date" data-last-update-days="0" data-date-updated="2026-01-10 08:42">2026-01-10 08:42</span>&nbsp;
<a href="https://www.cnblogs.com/wang_yb">wang_yb</a>&nbsp;
éè¯»(<span id="post_view_count">255</span>)&nbsp;
è¯è®º(<span id="post_comment_count">0</span>)&nbsp;
&nbsp;
<a href="javascript:void(0)" onclick="AddToWz(19464212);return false;">æ¶è</a>&nbsp;
<a href="javascript:void(0)" onclick="reportManager.report({ currentUserId: '', targetType: 'blogPost', targetId: '19464212', targetLink: 'https://www.cnblogs.com/wang_yb/p/19464212', title: 'æ£æ£ç³å¾ï¼å½æ¡å½¢å¾éä¸æç®ç¾å­¦' })">ä¸¾æ¥</a>
</div>
         ]]>
    </description>
    </item>
        </channel>
        </rss>